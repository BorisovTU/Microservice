/*
 $Name: ws_chksnils_lib.mac
 $Module: Ядро ГКБО 
 $Description: Сервис валидации СНИЛС в RsConnect
 */
 /*
  Сервис валидации СНИЛС в RsConnect
 */
import "ws_ssusage_snils.mac";

import oralib, "globals.mac", ptinter;

/*
E_PERSCL
E_PERSON
*/

private macro CreateSnilsQuery(firstName, lastName, patronymic, gender, birthdate, SNILS)
    var q = CreateSSASRequestSNILSJava();
    q.firstName = firstName;
    q.lastName = lastName;
    q.patronymic = patronymic;
    q.birthdate = birthdate;
    q.gender = gender;
    q.SNILS = SNILS;
    return q;
end;

macro PT_CheckSnilsConfWin(QuestionText, QuestionBtns, DefaultBtn)
    var text = TArray();
    text[0] = QuestionText;
    return ConfWin(text, QuestionBtns, DefaultBtn);
end;

macro PT_CheckSnilsSendRequest(
    Action, SenderID, RS_Connect_Url, 
    firstName, lastName, patronymic, gender, birthdate, SNILS, MessageID:@string,
    ReturnCode:@string, ReturnText:@string, StatusName:@string
    )
    var hr = false;
    var header = CreateHeaderSSASRequestJava();
    
    var HeaderMessageID = SubStr(CreateGUID(), 2, 36);    
    header.messageID = HeaderMessageID;
    header.senderID = SenderID;
    header.senderPointID = {OperDprt};
    
    var query;
    var result;
    if (Action == PTCHECKSNILSACTION_QUERY_CHECK_SNILS)
        query = CreateSnilsQuery(StrUpr(firstName), StrUpr(lastName), StrUpr(patronymic), gender, birthdate, SNILS);
        result = callCheckSnils(header, query, RS_Connect_Url);
        
        hr = result.SSASResponse.result;
        StatusName = result.statusName;
        MessageID = HeaderMessageID;
    elif (Action == PTCHECKSNILSACTION_QUERY_RESULT)
        query = CreateSnilsQuery(StrUpr(firstName), StrUpr(lastName), StrUpr(patronymic), gender, birthdate, SNILS);
        result = callGetSnils(header, "", MessageID, RS_Connect_Url);
        
        hr = result.SSASResponse.result;
        StatusName = result.statusName;
    end;
    
    println(result.statusCode);
    println(result.objectError);
        
    println(result.SSExtError.returnCode);
    println(result.SSExtError.returnText);
    
    if (strlen(result.objectError) != 0)
        StatusName = "Ошибка данных";
        ReturnCode = 0;
        ReturnText = result.objectError;
    else
        if(strlen(result) != 0)
            ReturnCode = result.statusCode;
            ReturnText = result.objectError;
        else
            ReturnCode = result.SSExtError.returnCode;
            ReturnText = result.SSExtError.returnText;
        end;
    end;
    
    return hr;
end;
