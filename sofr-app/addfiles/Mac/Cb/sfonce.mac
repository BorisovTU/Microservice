/*
$Name:        sfonce.mac
$Module:      ПЗО
$Description: Макрос разовых комиссий 
*/

import sfpay, sfground, sfcomcat, "SPSERV.MAC";
import dlcontrfunc;
import "dl_car.mac", "SfSubcontr.mac", "DateFormatter.mac", "AccountCategory.mac";

private const SFDOC_DEF_ONCE = 52;

/*record sfcontrRec( "sfcontr.dbt") key 0*/;
file sfcomissFile( "sfcomiss.dbt"  ) key 0;

record sfsingdfRec( "sfdef.dbt" );

private macro SfSingAccrue( SfSingPD, sfsingdfRec, sfcomiss, sicredit )  
  
  var PayerAccount:string, ReceiverAccount:string;
  var SumPayer = $0, SumNDS = $0;
  var Ground = string( "За разовые услуги." );
  var err = 0;
  var carryDate = sfsingdfRec.DateFee;
  var payFIID = sfsingdfRec.FIID_paySum;

  PayerAccount = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALC_SFSI_KIND, PlusCalc_CatCode, carryDate, payFIID );
  ReceiverAccount = sicredit.Account;
  
  if( ConvSum( SumPayer, sfsingdfRec.sum, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
    err = CountComissAsIncome( carryDate, payFIID, PayerAccount, sicredit.FIID, ReceiverAccount, SumPayer, Ground );
  else
    err = 1;
  end;
  
  if( (err == 0) AND (sfsingdfRec.sumNDS > 0) )
    Ground = string("НДС за разовые услуги.");
    PayerAccount = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALCNDS_SFSI_KIND, PlusCalcNDS_CatCode, carryDate, payFIID );
    ReceiverAccount 
      = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, NDSACRUAL_SFSI_KIND, MinusNDSAccrual_CatCode, carryDate, payFIID );
    if( ConvSum( SumNDS, sfsingdfRec.sumNDS, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
      err = CountComissAsIncome( carryDate, payFIID, PayerAccount, payFIID, ReceiverAccount, SumNDS, Ground );
    else
      err = 1;
    end;
  end;

  if( err == 0 )
    sfsingdfRec.IsIncluded = "X";
    SfDefSetFlagIsInc( sfsingdfRec.FeeType, sfsingdfRec.ID, 0, 0 );
  end;

  return err;
end;

Private macro ДоговорЕДП(dlcontrid, sfcontrid)
   var cmd, DataSet;
   var sql = "";

   sql =  " SELECT 1 \n" +
          "  FROM dsfcontr_dbt s, dobjatcor_dbt a \n" +
          " WHERE     s.t_servkindsub = 8 \n" +
          "       AND a.t_objecttype = 659 \n" +
          "       AND a.t_groupid = 102 \n" +
          "       AND a.t_attrid = 1 \n" +
          "       AND a.t_object = LPAD (s.t_id, 10, '0') \n" ;

   if ((ValType(dlcontrid) != V_UNDEF) and (dlcontrid > 0))
      sql = sql + "       AND s.t_id IN (SELECT t_sfcontrid \n" +
             "                        FROM ddlcontrmp_dbt \n" +
             "                       WHERE t_dlcontrid = ?) \n";
      cmd = DL_RSDCommand(sql); 
      cmd.AddParam(dlcontrid);

   else
      sql = sql +  "       AND s.t_id = ?  \n";
      cmd = DL_RSDCommand(sql); 
      cmd.AddParam(sfcontrid);
   end;

   DataSet = cmd.Execute();
   if(DataSet.moveNext())
      return true;
   else
      return false
   end;
end;

Private Macro GetCurContrId(Operdogid, kind, subkind, BirgId)
var sql, cmd, rs, DogId = 0;

  sql = " select sf.* from dsfcontr_dbt sf, dsfcontr_dbt sf2, ddlcontrmp_dbt mp, ddlcontrmp_dbt mp2 where sf2.t_id = ? and MP2.T_SFCONTRID = sf2.t_id and mp2.t_dlcontrid = mp.t_dlcontrid and sf.t_servkind = ? " + 
      " and sf.t_servkindsub = ? and mp.t_sfcontrid = sf.t_id and mp.t_marketid = ? ";

  cmd = RSDCommand(sql);
  cmd.AddParam("dogid", RSDBP_IN, Operdogid);
  cmd.AddParam("kind", RSDBP_IN, kind);
  cmd.AddParam("subkind", RSDBP_IN, subkind);
  cmd.AddParam("BirgId", RSDBP_IN, BirgId);

  rs = RSDRecordSet(cmd);

  if (rs.MoveNext())
     DogId = rs.value("t_id");
  else
     DogId = 0;
  end;
  return DogId;


end;

Private Macro  GetClientAccount(dogid, CatID, fiid) 
  var sql, cmd, rs, Birgacc = "";
  var AccBuf = TRecHandler("account");
  AccBuf.Clear();

  sql = " select mc.* from dsfcontr_dbt sf, dmcaccdoc_dbt mc where sf.t_id = ? and MC.T_CATID = ? and mc.t_iscommon = 'X' and mc.t_clientcontrid = sf.t_id and mc.t_currency = ?";

  cmd = RSDCommand(sql);
  cmd.AddParam("dogid", RSDBP_IN, dogid);
  cmd.AddParam("BirgId", RSDBP_IN, CatID);
  cmd.AddParam("fiid", RSDBP_IN, fiid);

  rs = RSDRecordSet(cmd);

  if (rs.MoveNext())
     Birgacc = rs.value("t_account");
  else

  end;
  return Birgacc;

End;

private macro SfSingAccrueOf( SfSingPD, sfsingdfRec, sfcomiss,sidebet,sicredit )  
  
  var PayerAccount:string, ReceiverAccount:string, Account47423:string;
  var SumPayer = $0, SumNDS = $0, TempSum = $0, RestAcc = $0, AccPayer = "";
  var Ground = string( "За разовые услуги." );
  var err = 0, errtxt = "";
  var carryDate = sfsingdfRec.DateFee;
  var payFIID = sfsingdfRec.FIID_paySum;
  var AccPayerBuf = TRecHandler("account"), FD, curSfContrId = 0;

  record ClientAccVUCred( account );
  record ClientAccVUDeb( account );

  PayerAccount = sidebet.Account/*SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALC_SFSI_KIND, PlusCalc_CatCode, carryDate, payFIID )*/;
  ReceiverAccount = sicredit.Account;
  
//  SfSingPD.SetParametr( MC_TYPE_PARAMETR_PARTY, sidebet.partyid );
  ReceiverAccount = MC_FindAndOpenAccount(
				"+КВ, ц/б"/*CatCode*/,
				SfSingPD,
				carryDate,
				0/*IsMass*/,
				MC_OPENACC_CREATE);

  Ground = "Обработка заявления клиента на предъявление ценных бумаг к выкупу (на оферту) за " + sfsingdfRec.basequant + " заявл.";

  if( ConvSum( SumPayer, sfsingdfRec.sum, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
      If(not ДоговорЕДП(0, sfsingdfRec.sfcontrid))
         curSfContrId = GetCurContrId(sfsingdfRec.sfcontrid, 1, 8, 2); //фондовый рынок ММВБ
         If(curSfContrId != 0)
            FD = DL_SubContrFD(curSfContrId);
            ClearRecord(ClientAccVUCred);
            ClearRecord(ClientAccVUDeb);
            if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, carryDate, payFIID ))
               errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
               msgbox(errtxt);
            end;
            if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, carryDate, payFIID ))
               errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
               msgbox(errtxt);
            end;
            AccPayer= GetClientAccount(curSfContrId, 70, payFIID); 
            Account47423 = GetClientAccount(curSfContrId, 818, payFIID); 
         RestAcc = RestAC(AccPayer, 0, carryDate, NULL, 1 );
         If(RestAcc>0)
            If(RestAcc > SumPayer)
               TempSum = SumPayer;
               SumPayer = 0;
                  err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                  err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
            else
               TempSum = RestAcc;
               SumPayer = SumPayer - RestAcc;
                  err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                  err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
               end;
               //ВУ
               if ( not ЮзерПроводкаПоКатегориямУчета(
                     FD, 
                     ClientAccVUDeb, 
                     ClientAccVUCred, 
                     carryDate,
                     ClientAccVUCred.Chapter, 
                     ClientAccVUCred.code_currency,
                     TempSum,
                     "",
                     Ground,
                     null, null,
                     ClientAccVUCred.code_currency, ClientAccVUCred.code_currency,
                     false ) 
                  )
                     errtxt = "Ошибка при проводке по врутреннему учету " + geterrmsg();
                     msgbox(errtxt);
               end;
            end;
         end;
         If(SumPayer>0)
            curSfContrId = GetCurContrId(sfsingdfRec.sfcontrid, 21, 8, 2); //валютный рынок
            If(curSfContrId != 0)
               FD = DL_SubContrFD(curSfContrId);
               ClearRecord(ClientAccVUCred);
               ClearRecord(ClientAccVUDeb);
               if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               AccPayer= GetClientAccount(curSfContrId, 70, payFIID); 
               Account47423 = GetClientAccount(curSfContrId, 818, payFIID); 
            RestAcc = RestAC(AccPayer, payfiid, carryDate, NULL, 1 );
            If(RestAcc>0)
               If(RestAcc > SumPayer)
                  TempSum = SumPayer;
                  SumPayer = 0;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
               else
                  TempSum = RestAcc;
                  SumPayer = SumPayer - RestAcc;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
                  end;
                  //ВУ
                  if ( not ЮзерПроводкаПоКатегориямУчета(
                        FD, 
                        ClientAccVUDeb, 
                        ClientAccVUCred, 
                        carryDate,
                        ClientAccVUCred.Chapter, 
                        ClientAccVUCred.code_currency,
                        TempSum,
                        "",
                        Ground,
                        null, null,
                        ClientAccVUCred.code_currency, ClientAccVUCred.code_currency,
                        false ) 
                     )
                        errtxt = "Ошибка при проводке по врутреннему учету " + geterrmsg();
                        msgbox(errtxt);
                  end;
               end;
            end;
         end;
         If(SumPayer>0)
            curSfContrId = GetCurContrId(sfsingdfRec.sfcontrid, 1, 9, -1); //внебиржевой рынок
            If(curSfContrId != 0)
               FD = DL_SubContrFD(curSfContrId);
               ClearRecord(ClientAccVUCred);
               ClearRecord(ClientAccVUDeb);
               if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               AccPayer= GetClientAccount(curSfContrId, 70, payFIID); 
               Account47423 = GetClientAccount(curSfContrId, 818, payFIID); 
            RestAcc = RestAC(AccPayer, payfiid, carryDate, NULL, 1 );
            If(RestAcc>0)
               If(RestAcc > SumPayer)
                  TempSum = SumPayer;
                  SumPayer = 0;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
               else
                  TempSum = RestAcc;
                  SumPayer = SumPayer - RestAcc;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
                  end;
               end;
                  //ВУ
                  if ( not ЮзерПроводкаПоКатегориямУчета(
                        FD, 
                        ClientAccVUDeb, 
                        ClientAccVUCred, 
                        carryDate,
                        ClientAccVUCred.Chapter, 
                        ClientAccVUCred.code_currency,
                        TempSum,
                        "",
                        Ground,
                        null, null,
                        ClientAccVUCred.code_currency, ClientAccVUCred.code_currency,
                        false ) 
                     )
                        errtxt = "Ошибка при проводке по врутреннему учету " + geterrmsg();
                        msgbox(errtxt);
               end;
            end;
         end;
         If(SumPayer>0)
            curSfContrId = GetCurContrId(sfsingdfRec.sfcontrid, 15, 8, 2); //срочный рынок
            If(curSfContrId != 0)
               FD = DL_SubContrFD(curSfContrId);
               AccPayer= GetClientAccount(curSfContrId, 70, payFIID); 
               Account47423 = GetClientAccount(curSfContrId, 818, payFIID); 
            RestAcc = RestAC(AccPayer, PayFiid, carryDate, NULL, 1 );
            If(RestAcc>0)
               If(RestAcc > SumPayer)
                  TempSum = SumPayer;
                  SumPayer = 0;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
               else
                  TempSum = RestAcc;
                  SumPayer = SumPayer - RestAcc;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
                  end;
               end;
            end;
         end;
         If(SumPayer>0)
            curSfContrId = GetCurContrId(sfsingdfRec.sfcontrid, 1, 8, SPB_ID()); //фондовый рынок СПБ
            If(curSfContrId != 0)
               FD = DL_SubContrFD(curSfContrId);
               ClearRecord(ClientAccVUCred);
               ClearRecord(ClientAccVUDeb);
               if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               AccPayer= GetClientAccount(curSfContrId, 70, payFIID); 
               Account47423 = GetClientAccount(curSfContrId, 818, payFIID); 
            RestAcc = RestAC(AccPayer, PayFiid, carryDate, NULL, 1 );
            If(RestAcc>0)
               If(RestAcc > SumPayer)
                  TempSum = SumPayer;
                  SumPayer = 0;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
               else
                  TempSum = RestAcc;
                  SumPayer = SumPayer - RestAcc;
                     err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, TempSum, Ground );
                     err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, TempSum, Ground );
                  end;
               end;
                  //ВУ
                  if ( not ЮзерПроводкаПоКатегориямУчета(
                        FD, 
                        ClientAccVUDeb, 
                        ClientAccVUCred, 
                        carryDate,
                        ClientAccVUCred.Chapter, 
                        ClientAccVUCred.code_currency,
                        TempSum,
                        "",
                        Ground,
                        null, null,
                        ClientAccVUCred.code_currency, ClientAccVUCred.code_currency,
                        false ) 
                     )
                        errtxt = "Ошибка при проводке по врутреннему учету " + geterrmsg();
                        msgbox(errtxt);
               end;
            end;
         end;
         If(SumPayer>0)
            curSfContrId = GetCurContrId(sfsingdfRec.sfcontrid, 1, 8, 2); //фондовый рынок ММВБ
            If(curSfContrId != 0)
               FD = DL_SubContrFD(curSfContrId);
               ClearRecord(ClientAccVUCred);
               ClearRecord(ClientAccVUDeb);
               if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, carryDate, payFIID ))
                  errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
                  msgbox(errtxt);
               end;
               AccPayer= GetClientAccount(curSfContrId, 70, payFIID); 
               Account47423 = GetClientAccount(curSfContrId, 818, payFIID); 
               err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, SumPayer, Ground );
               err = CountComissAsIncome( carryDate, payFIID, AccPayer, sicredit.FIID, Account47423, SumPayer, Ground );
               //ВУ
               if ( not ЮзерПроводкаПоКатегориямУчета(
                     FD, 
                     ClientAccVUDeb, 
                     ClientAccVUCred, 
                     carryDate,
                     ClientAccVUCred.Chapter, 
                     ClientAccVUCred.code_currency,
                     SumPayer,
                     "",
                     Ground,
                     null, null,
                     ClientAccVUCred.code_currency, ClientAccVUCred.code_currency,
                     false ) 
                  )
                     errtxt = "Ошибка при проводке по врутреннему учету " + geterrmsg();
                     msgbox(errtxt);
               end;
            end;
         end;
      else
         Account47423 = GetClientAccount(sfsingdfRec.sfcontrid, 818, payFIID); 
         FD = DL_SubContrFD(sfsingdfRec.sfcontrid);
         ClearRecord(ClientAccVUCred);
         ClearRecord(ClientAccVUDeb);
         if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, carryDate, payFIID ))
            errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
            msgbox(errtxt);
         end;
         if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, carryDate, payFIID ))
            errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
            msgbox(errtxt);
         end;
         err = CountComissAsIncome( carryDate, payFIID, Account47423, sicredit.FIID, ReceiverAccount, SumPayer, Ground );
         err = CountComissAsIncome( carryDate, payFIID, PayerAccount, sicredit.FIID, Account47423, SumPayer, Ground );
         //ВУ
         if ( not ЮзерПроводкаПоКатегориямУчета(
               FD, 
               ClientAccVUDeb, 
               ClientAccVUCred, 
               carryDate,
               ClientAccVUCred.Chapter, 
               ClientAccVUCred.code_currency,
               SumPayer,
               "",
               Ground,
               null, null,
               ClientAccVUCred.code_currency, ClientAccVUCred.code_currency,
               false ) 
            )
               errtxt = "Ошибка при проводке по врутреннему учету " + geterrmsg();
               msgbox(errtxt);
         end;
      end;
  else
     err = 1;
  end;
/*  
  if( (err == 0) AND (sfsingdfRec.sumNDS > 0) )
    Ground = string("НДС за разовые услуги.");
    PayerAccount = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALCNDS_SFSI_KIND, PlusCalcNDS_CatCode, carryDate, payFIID );
    ReceiverAccount 
      = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, NDSACRUAL_SFSI_KIND, MinusNDSAccrual_CatCode, carryDate, payFIID );
    if( ConvSum( SumNDS, sfsingdfRec.sumNDS, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
      err = CountComissAsIncome( carryDate, payFIID, PayerAccount, payFIID, ReceiverAccount, SumNDS, Ground );
    else
      err = 1;
    end;
  end;
*/
  if( err == 0 )
    sfsingdfRec.IsIncluded = "X";
    SfDefSetFlagIsInc( sfsingdfRec.FeeType, sfsingdfRec.ID, 0, 0 );
  end;

  return err;
end;


//09.12.18 teg аналог функци но делает 2 проводки
private macro SfSingAccrueMMVB( SfSingPD, sfsingdfRec, sfcomiss,sidebet,sicredit )  
  
  var PayerAccount:string, ReceiverAccount:string;
  var SumPayer = $0, SumNDS = $0;
  var Ground = string( "Уплата комиссии бирже." );
  var err = 0;
  var carryDate = sfsingdfRec.DateFee;
  var payFIID = sfsingdfRec.FIID_paySum;
  //TEG 10.12.18

  //первая проводка 47422-30424
  PayerAccount    = sidebet.Account; //SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALC_SFSI_KIND, PlusCalc_CatCode, carryDate, payFIID );
  ReceiverAccount = sicredit.Account;
  
  if( ConvSum( SumPayer, sfsingdfRec.sum, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
    err = CountComissAsIncome( carryDate, payFIID, PayerAccount, sicredit.FIID, ReceiverAccount, SumPayer, Ground );
  else
    err = 1;
  end;
  //вторая проводка 70606-47422
  PayerAccount = MC_FindAndOpenAccount(
				"-КВ, ц/б1"/*CatCode*/,
				SfSingPD,
				carryDate,
				0/*IsMass*/,
				MC_OPENACC_CREATE);
				//AccBuf, FIID, null, PairAcc, null, _FIRole, null, McAccDocBuf, null, ActivateDate );
  //SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALC_SFSI_KIND, "-КВ, ц/б1", carryDate, payFIID );
  ReceiverAccount = sidebet.Account;
  
  if( ConvSum( SumPayer, sfsingdfRec.sum, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
    err = CountComissAsIncome( carryDate, payFIID, PayerAccount, sicredit.FIID, ReceiverAccount, SumPayer, Ground );
  else
    err = 1;
  end;

  if( (err == 0) AND (sfsingdfRec.sumNDS > 0) )
    Ground = string("НДС за разовые услуги.");
    PayerAccount = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, CALCNDS_SFSI_KIND, PlusCalcNDS_CatCode, carryDate, payFIID );
    ReceiverAccount 
      = SfSingPD.GetDefComSfSiAccount( sfsingdfRec.ID, NDSACRUAL_SFSI_KIND, MinusNDSAccrual_CatCode, carryDate, payFIID );
    if( ConvSum( SumNDS, sfsingdfRec.sumNDS, carryDate, sfsingdfRec.FIID_Sum, payFIID, sfcomiss.Ratetype ) == 0 )
      err = CountComissAsIncome( carryDate, payFIID, PayerAccount, payFIID, ReceiverAccount, SumNDS, Ground );
    else
      err = 1;
    end;
  end;

  if( err == 0 )
    sfsingdfRec.IsIncluded = "X";
    SfDefSetFlagIsInc( sfsingdfRec.FeeType, sfsingdfRec.ID, 0, 0 );
  end;

  return err;
end;

/* Проведение комиссии КлиентКлирИспПИ
+РасчетыКомисс1 (47423) -  +Биржа (47404)
ДС клиента, ц/б (30601) -  +РасчетыКомисс1 (47423)
ДС, Расч. С клиентом, ВУ (2) - ДС Клиента, ВУ (1)

без конвертации, потому что комиссия в рублях
*/
private macro ClientClearingExecDv(SfSingFD, sfDefRec):bool
   var PayerAccount:string, ReceiverAccount:string;
   var subContr:SfSubContr, FD:DL_SubContrFD;
   var ground:string = "";
   var categID = 818;

   record internalAccountDebet( account );
   record internalAccountCredit( account );

   subContr = SfSubContr(sfDefRec.sfcontrid);
   ground = "Комиссия за клиринг при исполнении фьючерсных контрактов "
          + DateFormatter.Get(sfDefRec.DateFee, "dd.mm.yyyy") + " в рамках ДБО №" + subContr.ContrNum()
          + " от " + DateFormatter.Get(subContr.ContrDate(), "dd.mm.yyyy") + ". Клиент - "
          + subContr.ClientName() + ". ЕКК - " + subContr.Ekk();

   //+РасчетыКомисс1 (47423) -  +Биржа (47404)
   PayerAccount = GetClientAccount(sfDefRec.sfcontrid, categID, sfDefRec.FIID_paySum);
   ReceiverAccount = SfSingFD.FindAccount("+Биржа", sfDefRec.DateFee, sfDefRec.FIID_paySum);

   if (PayerAccount == "")
      var mcCateg = AccountCategory();
      mcCateg.InitByID(categID);
      MsgBox("Для субдоговора " + subContr.ContrNum() + " не найден счёт по категории \"" + mcCateg.GetCode() + "\"");
      return false;
   end;

   CountComissAsIncome( sfDefRec.DateFee, sfDefRec.FIID_paySum, PayerAccount, sfDefRec.FIID_paySum, ReceiverAccount, sfDefRec.sum, ground );

   //ДС клиента, ц/б (30601) -  +РасчетыКомисс1 (47423)
   ReceiverAccount = PayerAccount;
   PayerAccount = GetClientAccount(sfDefRec.sfcontrid, 70, sfDefRec.FIID_paySum);
   CountComissAsIncome( sfDefRec.DateFee, sfDefRec.FIID_paySum, PayerAccount, sfDefRec.FIID_paySum, ReceiverAccount, sfDefRec.sum, ground );


   //внутренний учёт ДС, Расч. С клиентом, ВУ (2) - ДС Клиента, ВУ (1)
   FD = DL_SubContrFD(sfDefRec.sfcontrid);
   if(not FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, internalAccountDebet, sfDefRec.DateFee, sfDefRec.FIID_paySum ))
      MsgBox("Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " + GetErrMsg());
      return false;
   end;

   if (not FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, internalAccountCredit, sfDefRec.DateFee, sfDefRec.FIID_paySum ))
      MsgBox("Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " + GetErrMsg());
      return false;
   end;

   if ( not ЮзерПроводкаПоКатегориямУчета(FD, 
                                          internalAccountDebet, 
                                          internalAccountCredit, 
                                          sfDefRec.DateFee,
                                          internalAccountCredit.Chapter, 
                                          internalAccountCredit.code_currency,
                                          sfDefRec.sum,
                                          "",
                                          Ground,
                                          null, null,
                                          internalAccountCredit.code_currency, internalAccountCredit.code_currency,
                                          false ) 
      )
      msgbox("Ошибка при проводке по врутреннему учету " + GetErrMsg());
      return false;
   end;

   sfDefRec.IsIncluded = "X";
   SfDefSetFlagIsInc( sfDefRec.FeeType, sfDefRec.ID, 0, 0 );
   return true;
end;

/* Проведение комиссии МскБиржКлирИспПИ
+Биржа (47404) - Клиринговый счет (30424)
без конвертации, потому что комиссия в рублях
*/
private macro MoexClearingExecDv(SfSingFD, sfDefRec)
   var PayerAccount:string, ReceiverAccount:string;
   var ground:string = "";

   ground = "Комиссия за клиринг при исполнении фьючерсных контрактов " + DateFormatter.Get(sfDefRec.DateFee, "dd.mm.yyyy");

   PayerAccount    = SfSingFD.FindAndOpenAccount("+Биржа", sfDefRec.DateFee, sfDefRec.FIID_paySum);
   ReceiverAccount = SfSingFD.FindAndOpenAccount("Клиринговый счет", sfDefRec.DateFee, sfDefRec.FIID_paySum);
   CountComissAsIncome( sfDefRec.DateFee, sfDefRec.FIID_paySum, PayerAccount, sfDefRec.FIID_paySum, ReceiverAccount, sfDefRec.sum, ground );

   sfDefRec.IsIncluded = "X";
   SfDefSetFlagIsInc( sfDefRec.FeeType, sfDefRec.ID, 0, 0 );
end;

private macro SfSingPay( documentNum, SfSingPD, sfsingdfRec, sfcomissFile, sidebet, sicredit )
  
  var stat = 0;

  file sfcontr( "sfcontr.dbt") key 0;
  var sfcontr_found = false;

  if( sfsingdfRec.SfContrID > 0 )
    sfcontr.ID = sfsingdfRec.SfContrID;
    if( getEQ(sfcontr) )
      sfcontr_found = true;
    end;
  end;

  var payDate = sfsingdfRec.DateFee;
  if( sfsingdfRec.CalcComissSumAlg == 3 ) /*SFCOMISS_CALCCOMISSSUMALG_BEFOREPAY*/
    payDate = sfsingdfRec.DateFee - 1;
  end;

  var payMethod = SF_PAY_METHOD_PAYM;
  var ground = "";
  if( sfcontr_found )
    ground = BuildGroundWithVO( sfsingdfRec, sfcomissFile, sfcontr, sidebet.rec.PartyID, sicredit.rec.PartyID, payDate );   
    payMethod = sfcontr.payMethod;
  else
    ground = BuildGroundWithVO ( sfsingdfRec, sfcomissFile, null,  sidebet.rec.PartyID, sicredit.rec.PartyID, payDate  );   
  end;

  var bilfDocArray = TArray;


  stat = SfFormDocs( documentNum, sidebet, sicredit, sfcomissFile,
                      payDate, ground,
                      sfsingdfRec.sum, sfsingdfRec.sumNDS, sfsingdfRec.FIID_Sum,
                      SFDOC_DEF_ONCE, sfsingdfRec.ID, OBJTYPE_SFSINGDF, sfsingdfRec, payMethod,
                      SfSingPD, sfsingdfRec.IsIncluded, false, sfsingdfRec.FacturaID, @bilfDocArray, null, null, null, null, null, null, sfcontr.PreAcptID);
                       
  if(stat == 0)                   
     sfsingdfRec.Status = SFDEFCOM_STATUS_FOR_PAY;
     if( not Opr_ChangeSfDefComStatus(sfsingdfRec.ID, sfsingdfRec.Status, 0, 0, sfsingdfRec.FeeType) )
       MsgBox("Не удалось изменить статус УРК.");
     end;

     if( (sfsingdfRec.FacturaID > 0) AND (bilfDocArray.Size > 0) )       
       if(not CreateBilBookEntry(sfsingdfRec.FacturaID, payDate, bilfDocArray) )  
         MsgBox("Не удалось связать оплату комиссии с СФ");
       end;
     end;
  end;

end;

macro ExecuteStep( outBuff, primIn )
   var stat = 0;
   var DocumentNum = "";
   setbuff( sfsingdfRec, primIn  );

   sfcomissFile.FeeType = sfsingdfRec.FeeType;
   sfcomissFile.Number  = sfsingdfRec.CommNumber;

   if( not getEQ( sfcomissFile ) )
      MsgBox("Не найдена комиссия");
      return 1;
   end;

   var SfAccrueRegVal = SfComAccrueGetRegValue();
      
   var sidebet = TRecHandler("sfsi.dbt");
   var sicredit = TRecHandler("sfsi.dbt");
   sidebet.Clear;
   sicredit.Clear;
   if(SfGetSI_Uni( 664, sfsingdfRec, sidebet, sicredit ))  /*ObjectType = OBJTYPE_SFSINGDF = 664*/
      MsgBox("Ошибка при взятии платежных инструкций");
      return 1;
   end;
   
   var SfSingPD = SfSingDfPrimDoc( SFDOC_DEF_ONCE, sfsingdfRec );

   if((sicredit.rec.Account == "") and (StrUpr(SfSingPD.sfcomiss.rec.code) != "КЛИЕНТКЛИРИСППИ") and (StrUpr(SfSingPD.sfcomiss.rec.code) != "МСКБИРЖКЛИРИСППИ") )
      MsgBox("Не найдена подходящая СПИ для заполнения платежа");
      return 1;
   end;

   var result:bool = true;
   if (StrUpr(SfSingPD.sfcomiss.rec.code) == "КЛИЕНТКЛИРИСППИ")
      result = ClientClearingExecDv(SfSingPD, sfsingdfRec);
   elif (StrUpr(SfSingPD.sfcomiss.rec.code) == "МСКБИРЖКЛИРИСППИ")
      MoexClearingExecDv(SfSingPD, sfsingdfRec);
   elif( sfcomissFile.receiverID == {HeadBankID} ) /*if( SfIsOurFilial(sicredit.rec.PartyID) == true )*/
      If(StrUPR(SfSingPD.sfcomiss.rec.code) == "БРОКЕРОФЕРТА")
          SfSingAccrueOf( SfSingPD, sfsingdfRec, sfcomissFile,sidebet.rec, sicredit.rec );
      else
         if( (SfAccrueRegVal == 0) OR ((SfAccrueRegVal == 2) AND (sfsingdfRec.sumNds > 0)) )
           SfSingAccrue( SfSingPD, sfsingdfRec, sfcomissFile, sicredit.rec );
         end;
      end;
   elif ( (sfcomissFile.receiverID != {HeadBankID})  and  ( StrUPR(SfSingPD.sfcomiss.rec.code) == "МСКБИРЖСБОР" ) )
       SFSingAccrueMMVB( SfSingPD, sfsingdfRec, sfcomissFile,sidebet.rec, sicredit.rec );
   end;

   if (not result)
      return 1;
   end;

   if( sfcomissFile.InstantPayment == "X" )
     SfSingPay( DocumentNum, SfSingPD, sfsingdfRec, sfcomissFile, sidebet, sicredit );
   end; 

   If( (StrUPR(SfSingPD.sfcomiss.rec.code) == "БРОКЕРОФЕРТА" ) or (StrUpr(SfSingPD.sfcomiss.rec.code) == "КЛИЕНТКЛИРИСППИ") or (StrUpr(SfSingPD.sfcomiss.rec.code) == "МСКБИРЖКЛИРИСППИ"))
     sfsingdfRec.Status = SFDEFCOM_STATUS_PAYED;
     if( not Opr_ChangeSfDefComStatus(sfsingdfRec.ID, sfsingdfRec.Status, 0, 0, sfsingdfRec.FeeType) )
       MsgBox("Не удалось изменить статус УРК.");
     end;
   end;

   return stat;
end;