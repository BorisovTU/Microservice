import BankInter;

var InputFileName = "";

macro   GetFileName(path)
        var pos;
        while (pos=StrBrk(path,"\\"))
        path = SubStr(path,pos+1);
    end;
        return path;
end;

macro   LZ( num, len )
        var str1, len1;

        str1 = trim( string( num ) );
        len1 = strlen( str1 );
        if ( len1 >= len )
        return  str1;
        else
        return  mkstr("0", len-len1 ) + str1; /* слева */
    end;
end;

macro   Количество_строк( Файл )
        var Количество = 0;
        while (next(Файл))
        Количество = Количество + 1;
    end;
        return Количество;
end;

macro   ReverseDateString(date_val)
        var day,month,year;
        DateSplit(date_val,day,month,year);
        return LZ(year,4) + LZ(month,2) + LZ(day,2);
end;

macro   Проверить_дату( dbf_file )

        var Дата_в_файле = date(0,0,0);
        while ( next (dbf_file ))
            if ( Дата_в_файле == date(0,0,0) )
                    Дата_в_файле = dbf_file.date;
            end;

            if (Дата_в_файле != dbf_file.date)
                    MsgBox("В файле содержаться записи за различные даты");
                    exit(1);
            end;
        end;
        return Дата_в_файле;
end;

macro   Был_обработан(Дата_импорта,расширение)
    FILE    арх_файл()  txt;

    var err, ArhDir;
    GetRegistryValue( "CB\\MICEX\\ARHDIR", V_STRING, ArhDir, err );
    if ( err  ==  7 )
        MsgBox( "Не определен ключ CB\\MICEX\\ARHDIR в настройках банка" );
        Exit( 1 );
    end;

    var имя = ARHDIR + "\\" + ReverseDateString(Дата_импорта) + расширение;
    if ( open(арх_файл,имя))
        return true;
    end;

    return false;
end;

macro   А_ты_уверен(InputFileName)
        var уверен;
        GetTrue(уверен,"Подтвердите что вы хотите импортировать файл: "+InputFileName);
        return уверен;
end;
