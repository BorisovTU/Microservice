/*
 $Name: mpcchg20.mac
 $Module: Ядро ГКБО 
 $Description: Операция "Начисление по ПД". Шаг "Расчет суммы"
 */
/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v.6.0.020
                 Copyright (c) R-Style Software Lab

  Имя файла        : mpcchg20.mac

  Библиотека       : RSACCOUNT

  Описание         : Операция "Начисление по ПД". Шаг "Расчет суммы"

  Программист      : Kirakozov Michael (KMB)

  Создан           : 12.02.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter, InsCarryDoc,  globals, mpclb;

record contract_buf (prccontract);
record cntopr_buf (prccntopr);

var prccontract = TBfile("prccontract.dbt"),
    cntsched = TBfile("prccntsched.dbt"),
    prccntopr = TBfile("prccntopr.dbt"),
    ChargeSum = $0,
    ContractID = 0;


PRIVATE MACRO GetNewNextDateCharge(ContractID, PeriodDate,NewDate:@date):bool
   var   cmd,rs,
         stat = true;

   cmd = RSDCommand ("select  min(T_DATE) as MINDATE from DPRCCNTSCHED_DBT " + 
          "where T_SCHEDULEKIND = 2 and T_CONTRACTID = ? and T_DATEREAL IS NULL " +
          "and T_DATE <> ?");
   cmd.addParam( "", RSDBP_IN, ContractID );
   cmd.addParam( "", RSDBP_IN, PeriodDate );
   cmd.execute();
   
   rs = TRsbDataSet(cmd);
   
   if (rs.movenext())
      NewDate = rs.mindate;
   else 
      stat = false;
   end;

   if (ValType(NewDate) == V_UNDEF)
      stat = false;
   end;

   return stat;
END;


// Поиск периода доначисления, в который входит период от BeginDate до EndDate 
PRIVATE MACRO FindWiderAddChargePeriod(ContractID, PeriodBeginDate, PeriodEndDate):bool
   var   cmd,rs,
         stat = false;

   cmd = RSDCommand ("select T_CNTSCHEDID from DPRCCNTSCHED_DBT " +
         "where T_PERIODBEGINDATE <= ? and T_PERIODENDDATE >= ? " +
         "and T_SCHEDULEKIND = 2 and T_SPECIALTYPE = 1 and T_CONTRACTID = ?");

   cmd.addParam( "", RSDBP_IN, PeriodBeginDate );
   cmd.addParam( "", RSDBP_IN, PeriodEndDate );
   cmd.addParam( "", RSDBP_IN, ContractID );
   cmd.execute();

   rs = TRsbDataSet(cmd);
   if (rs.movenext())
      stat = true;
   end;

   return stat;

END;  

// Проверка, существует ли период доначисления до даты EndDate
PRIVATE MACRO FindAddChargePeriodBefore(ContractID, EndDate)
   var   cmd,rs,
         stat = false;

   cmd = RSDCommand ("select T_CNTSCHEDID from DPRCCNTSCHED_DBT " +
         "where T_PERIODENDDATE <= ? and T_SCHEDULEKIND = 2 " +
         "and T_SPECIALTYPE = 1 and T_CONTRACTID = ?");

   cmd.addParam( "", RSDBP_IN, EndDate );
   cmd.addParam( "", RSDBP_IN, ContractID );
   cmd.execute();

   rs = TRsbDataSet(cmd);
   if (rs.movenext())
      stat = true;
   end;

   return stat;

END;

// Получение суммы, начисленной за период расчета
PRIVATE MACRO GetChargeSumForPeriod(date1, beg_date, end_date, ID): money
   var cmd,rs,Sum = $0;

   cmd = RSDCommand ("select T_SUMCALC, T_DATEREAL, T_ROUNDSUMDELTA from DPRCCNTSCHED_DBT " +
         "where T_DATE = ? and T_PERIODBEGINDATE = ? and T_PERIODENDDATE = ? " +
         "and T_SCHEDULEKIND = 1 and T_CONTRACTID = ?");
   cmd.addParam( "", RSDBP_IN, date1 );
   cmd.addParam( "", RSDBP_IN, beg_date );
   cmd.addParam( "", RSDBP_IN, end_date );
   cmd.addParam( "", RSDBP_IN, ID );
   cmd.execute();

   rs = TRsbDataSet(cmd);
   if (rs.movenext())
      if ((rs.datereal != date(0,0,0)) and (ValType(rs.datereal) != V_UNDEF) and (ValType(rs.sumcalc) != V_UNDEF))
         Sum = rs.sumcalc;
      end;
   end;

   return money(Sum);
END;// end macro


// Расчет суммы за период 
PRIVATE MACRO DoCalculateSum(RoundSumDelta:@money):money
   var cmd,rs,cmd2,CalcSum = $0,PrevRoundSumDelta = $0;

   PrevRoundSumDelta = GetPrevRoundSumDelta(ContractID, 2, cntsched.rec.periodbegindate); 

   if (prccntopr.rec.isReCalc == "")
      CalcSum = GetChargeSumForPeriod(cntsched.rec.date, cntsched.rec.periodbegindate, cntsched.rec.periodenddate, ContractID );
   end;
      
   if ((prccntopr.rec.isReCalc == "X") or (CalcSum == $0) )
      GenerateRatesTable(ContractID, cntsched.rec.periodbegindate, cntsched.rec.periodenddate);
      CalcSum = CalcPercentForPeriod(ContractID, cntsched.rec.periodbegindate,cntsched.rec.periodenddate);
   end;

   if (ValType(CalcSum) == V_UNDEF)
       CalcSum = $0;
   end;

   CalcSum = round(CalcSum + PrevRoundSumDelta, 5);
   RoundSumDelta = CalcSum - round(CalcSum, 2);

   CalcSum = round(CalcSum, 2);

   return CalcSum;   
END;// end macro


// Расчет суммы за предыдущий период 
/*
PRIVATE MACRO DoCalculateSumPrevPeriod(RecDate, BeginDate, EndDate, RoundSumDelta:@money):money
   var CalcSum = $0;

   CalcSum = GetChargeSumForPeriod(RecDate, BeginDate, EndDate, ContractID);
   
   if (CalcSum == $0)
      GenerateRatesTable(ContractID, BeginDate, EndDate);
      CalcSum = CalcPercentForPeriod(ContractID,BeginDate,EndDate);
   end;

   if (ValType(CalcSum) == V_UNDEF)
       CalcSum = 0;
   end;

   return money(CalcSum);
   
END;
*/

MACRO ExecuteStep(Buffer, Document)
   
   var   calcsum = $0,
         calcsum_prev = $0,
         cmd,rs,
         Sum,
         RoundSumDelta = $0,
         RoundSumDelta_Prev = $0,
         NewDateCharge,
         CntSchedID = 0,
         Msg = "";

   SetBuff( cntopr_buf, Document );   

   ClearRecord( contract_buf );

   prccntopr.KeyNum = 0;  
   prccntopr.rec.DocID = cntopr_buf.DocID;
   prccntopr.GetEQ;

   ContractID = prccntopr.rec.contractid;   

   prccontract.KeyNum = 0;  
   prccontract.rec.contractid = ContractID;
   if (not prccontract.GetEQ)
      //msgbox ("Не найден договор с ID = " + ContractID);
      PrcSendMessage(ContractID, "Не найден договор с ID = " + ContractID);
      return 1;
   end;

   if ((prccntopr.rec.DocKind == 1050) and (prccntopr.rec.NewCntSchedID > 0))
      // 1.0
      cntsched.KeyNum = 0;  
      cntsched.rec.CntSchedID = prccntopr.rec.NewCntSchedID;
      if (not cntsched.GetEQ)
         msgbox ("Не найден период начисления" );         
         return 1;
      end;
      CntSchedID = prccntopr.rec.NewCntSchedID;
   else
      CntSchedID = GetCntSchedID(ContractID, 2, prccntopr.rec.OperDate);
      if (CntSchedID != 0)
         cntsched.KeyNum = 0;   
         cntsched.rec.CntSchedID = CntSchedID;
         if (not cntsched.GetEQ)
            //msgbox ("Не найден период начисления" );
            PrcSendMessage(ContractID, "Не найден период начисления");
            return 1;
         end;
      else
         //msgbox ("Не найден период начисления" );
         PrcSendMessage(ContractID, "Не найден период начисления");
         return 1;
      end;
      
      if (cntsched.rec.PayState == PRC_PAYSTATUS_SUSPENDED)
        PrcSendMessage(ContractID, "Начисление процентов запрещено. В выбранном периоде начисление процентов приостановлено");
        InsertOprStatus(10201, 2);
        return 1;
      end;
   end;

   // 3.0
   if (FindWiderAddChargePeriod(ContractID,cntsched.rec.PeriodBeginDate, cntsched.rec.PeriodEndDate))
      //msgbox ("Начисление процентов запрещено. По выбранному периоду уже проведена операция доначисления процентов" );
      PrcSendMessage(ContractID, "Начисление процентов запрещено. По выбранному периоду уже проведена операция доначисления процентов");
      return 0;
   end;

   if ((cntsched.rec.DateReal != date (0,0,0)) and (prccntopr.rec.isReCalc == ""))
      // 4.0
      calcsum = cntsched.rec.sumcalc;
      RoundSumDelta = cntsched.rec.roundsumdelta;
   else
      // 5.0
      calcsum = DoCalculateSum(@RoundSumDelta);    
   end;

    // 7.0
    ChargeSum = round(calcsum,2);


  // 6.0 
/*
   if (prccntopr.rec.isPrevPeriod == "X")
      if (FindAddChargePeriodBefore(ContractID, cntsched.rec.PeriodBeginDate-1) == false)
         cmd = RSDCommand ("select T_SUMCALC, T_DATEREAL, T_DATE, T_PERIODBEGINDATE, " +
               "T_PERIODENDDATE from DPRCCNTSCHED_DBT " +
               "where T_SCHEDULEKIND = 2 and T_CONTRACTID = ? and T_DATE = (SELECT " +
               "MAX(T_DATE) from DPRCCNTSCHED_DBT where T_SCHEDULEKIND = 2 and " + 
               "T_CONTRACTID = ? and T_DATE < ?)");
         cmd.addParam( "", RSDBP_IN, ContractID );
         cmd.addParam( "", RSDBP_IN, ContractID );
         cmd.addParam( "", RSDBP_IN, cntsched.rec.date );
         cmd.execute();
         rs = TRsbDataSet(cmd);
        // 6.1.3
         if (rs.movenext()) 
            calcsum_prev = DoCalculateSumPrevPeriod(rs.date, date(rs.periodbegindate), date(rs.periodenddate), @RoundSumDelta_Prev);
         end;
      end;

      // 6.2
      ChargeSum = round((calcsum_prev + calcsum),2) - round(calcsum_prev,2);
   else
      // 6.2
      ChargeSum = round(calcsum, 2);
   end;
*/   


   // 8.0
   if (PrcSetCntSchedSumByID(CntSchedID, ChargeSum, prccntopr.rec.BankDate, RoundSumDelta) != 0)
      return 1;
   end;

   if (prccntopr.rec.isCreateDoc == false)
      if (GetNewNextDateCharge(ContractID, cntsched.rec.date, @NewDateCharge) == true)
         Msg = "Рассчитанная сумма начисленных процентов за период " + cntsched.rec.PeriodBeginDate + 
         "-" + cntsched.rec.PeriodBeginDate + " - " + ChargeSum + 
         ". Дата следующей операции - " + NewDateCharge + ".";
         
      else      
         Msg = "Рассчитанная сумма начисленных процентов за период " + cntsched.rec.PeriodBeginDate + 
         "-" + cntsched.rec.PeriodBeginDate + " - " + ChargeSum + ". ";
      end;
      // msgbox(Msg);
      PrcSendMessage(ContractID, Msg);
   end;

   return 0;   
END;



MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)       /* Вид шага операции */ 

  exit(1); 

END;

