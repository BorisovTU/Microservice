/*
$Name: web_scroll_lib.mac
$Module: Web-общее
$Description: Функции для построения скроллингов в Web-интерфейсе
*/


/*
   Добавить данные в секцию SELECT SQL-запроса
*/
macro WebScroll_AddSelect( full_select : @string, add_select : string ) : string

  full_select = full_select + ", " + add_select;

  return full_select;

end;

/*
   Добавить данные в секцию FROM SQL-запроса
*/
macro WebScroll_AddFrom( full_from : @string, add_from : string ) : string

  full_from = full_from + ", " + add_from;

  return full_from;

end;

/*
   Добавить данные в секцию WHERE SQL-запроса
*/
macro WebScroll_AddWhere( full_where : @string, add_where : string ) : string

  full_where = full_where + " AND " + add_where;

  return full_where;

end;

/*
   Сформировать SQL-запрос для построения скроллинга с постраничностью
*/
macro WebScroll_CreatePageSQLString( PageSize : integer, PageNum : integer, MainQuery : string, QuerySelect : string, QueryFrom : string, QueryWhere : string )

  var FullQuery : string, query_select : string, query_from : string, query_where : string;

  query_select = "SELECT t.*";

  if( (QuerySelect != null) and (QuerySelect != "") )

    query_select = query_select + " " + QuerySelect;

  end;

  query_from = " FROM ( SELECT rownum RN, tt.* FROM ( ";
  
  query_from = query_from + MainQuery;

  if( PageSize > 0 )
    query_from = query_from + " ) tt WHERE ROWNUM <= " + string(PageSize*(PageNum + 1)) + " ) t ";

    query_where = "WHERE t.RN >= " + string(PageSize*(PageNum) + 1);
  else
    query_from = query_from + " ) tt ) t ";

    query_where = "WHERE 1 = 1";
  end;

  if( (QueryFrom != null) and (QueryFrom != "") )

    query_from = query_from + " " + QueryFrom;

  end;

  if( (QueryWhere != null) and (QueryWhere != "") )

    query_where = query_where + " " + QueryWhere;

  end;

  FullQuery = query_select + " " + query_from + " " + query_where + " ORDER BY t.RN";

  return FullQuery;

end;
