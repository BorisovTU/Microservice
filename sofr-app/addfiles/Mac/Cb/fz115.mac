/*
 *    RS-Bank 5.1
 *
 *    Контроль противодействия легализации доходов, полученных
 *    преступным путем
 *
 *
 */

Import BankInter, FMInter, OprInter, PaymInter, PTInter, CTInter, FIInter, Календарь, "fm_out_util", "globals.mac";

/*
 *    Настройки
 */

/* Порядковый номер филиала кредитной организации, не имеющего БИК */
const F = "0";

/* Код терр. учреждения по ОКАТО */
private var KTU : string;

/* Коды нашего банка */
private var BANK_INN : string;
private var REGN     : string;
private var NUMBF_S  : string;

/* Пользовательский тип для отбора необычных операций */
const UserTypeNO = "Л" ; /* для проводок */
const AttrTypeNO = 1;    /* для платежей */

/* Эталонный файл выгрузки */
const DIR_ORIG = "..\\mac\\cb\\fz115.dbf";

private record OpContr("opcontr.dbt" );

/* макрос выгрузки */
var OutFileName;
var OutFileType;

/*
 * Определить тип транспортного файла,
 * в который необходимо выгрузить данную операцию
 */
macro DefineFileType( Repeat )
  
  if( Repeat )
    
    return 1; /* передача скорректированного файла */

  elif( (OpContr.Terror != 0) and (OpContr.Action == _FM_ACTION_ADD_NEW) )
  
    return 5; /* передача сведений о терроризме */

  end;

  return 0;

end;


/*
 * Сформировать название файла выгрузки
 * Возвращаемое значение: название файла
 */
macro CreateOutFileName( Date_Seance, Seance, Repeat )
  
  var day, mon, fname, ext;
  var OutFileName;

  OutFileType = DefineFileType( Repeat );

  DateSplit( Date_Seance, day , mon );

  /* имя файла */
  fname = SubStr( {MFO_Bank}, 5, 5 ) + string(OutFileType);
  if( day < 10 ) 
     fname = fname + "0" ;
  end;
  fname = fname + String(day);
  
  /* расширение */
  ext = "";
  if( Seance < 10 ) 
     ext =  "0";
  end;
  ext = ext + Seance + "1" ;

  /* формируем файл */
  OutFileName = MergeFile( FM_GetOutDir(), fname, ext );
  
  return OutFileName;

end;

/* Подкорректировать незаполненные поля в транспортном файле */
private macro CorrectTransportFile(TranspFile)

  var i = 0;

  while( i < FldNumber(TranspFile) )

    if( (ValType(TranspFile(i)) == V_STRING) and ((Trim(TranspFile(i)) == "") or (Trim(TranspFile(i) ) == ",")) )
         
      TranspFile(i) = "0";
      
    elif( (ValType(TranspFile(i)) == V_DATE ) and (TranspFile(i) == Date(0,0,0)) )
         
      TranspFile(i) = Date(1, 1, 2099) ;
      
    end;

    i = i + 1;

  end;

end;


/* Макрофункция вызывается в начале выгрузки
 *
 *   Возвращаемые значения:
 *      0 - продолжить выгрузку
 *  not 0 - остановить выгрузку
 *
 */
macro OutStart()
  
  var stat;

  /* определим код территориального учреждения по ОКАТО */
  GetRegistryValue( "ФИНМОНИТОРИНГ\\KTU", V_STRING, KTU, stat );
  if( KTU == "" )
    msgbox( "Не определен код территории учреждения по ОКАТО" );
    return 1;
  end;

  BANK_INN = GetCodeParty( {OurBank}, PTCK_INN );
  
  ПолучитьНомерРегистрацииБанка( @REGN, @NUMBF_S );

  return 0;

end;


/* Макрофункция вызывается по завершении выгрузки
 *
 *   Возвращаемое значение не анализируется
 *
 */
macro OutFinish()
end;



/*
 *  2. Выгрузка в транспортный файл 
 *
 *   Параметры:
 *      Date_Seance : date     - дата выгрузки
 *      Seance      : integer  - номер сеанса выгрузки
 *      First       : bool     - флаг выгрузки первой записи
 *      Repeat      : bool     - признак выгрузки в случае ошбики структурного контроля первичного файла
 *
 *   Перед вызовом макрофункции заполняются структуры:
 *      OpContr       - запись об операции, подлежащей контролю
 *
 *   Возвращаемые значения:
 *      
 *      0    - запись успешно обработана
 *    < 0     - операция должна быть выгружена другим сеансом
 *    > 0    - прерывание выполнения
 *
 */
macro OutToDBF( Date_Seance, Seance, First, Repeat )

   record OpContrParty( "opcntrpt.dbt" );
   var VOmain;
   var VO, Priz6001;
   
   var PRIM  : string;
   var DESCR : string;

   var BankID;

   file SampleFile("fz115.dbf") dbf;
   file TranspFile("fz115.dbf") dbf write;

   file FI( "fininstr.dbt" );

   if( not Open(SampleFile, DIR_ORIG) )
     MsgBox( "Невозможно открыть эталонный файл " + DIR_ORIG + ", заданный в настройках подсистемы" );
     return 1;
   end;

   
   if( First ) /* если выгрузка первой записи - создаем файл */
     
     OutFileName = CreateOutFileName( Date_Seance, Seance, Repeat );

     if( not clone(SampleFile, OutFileName) )
       MsgBox( "Невозможно создать файл выгрузки " + OutFileName );
       return 1;
     end;

   else

     if( OutFileType != DefineFileType(Repeat) )
       return -1;
     end;

   end;

   if( not open(TranspFile, OutFileName) )
     MsgBox( "Невозможно открыть файл выгрузки " + OutFileName );
     return 1;
   end;

   
   ПолучитьКодыОперации( OpContr, VO, Priz6001 );

   ПолучитьКодыОперации( OpContr, VOmain, null, true );

   ClearRecord( TranspFile );

   /* Служебная информация */
   TranspFile.VERSION    = "2";
   TranspFile.ACTION     = OpContr.Action;
   TranspFile.NUMB_P     = OpContr.Numb_P;
   TranspFile.DATE_P     = OpContr.Date_P;
   TranspFile.DATE_S     = OpContr.DateReveal;
   TranspFile.TEL        = GetPhoneNumber(OpContr.Executer);
   TranspFile.REFER_R2   = "0";

   /* Информация о кредитной организации */
   TranspFile.REGN       = REGN;
   TranspFile.ND_KO      = BANK_INN;
   TranspFile.KTU_S      = KTU;
   TranspFile.BIK_S      = {MFO_Bank};
   TranspFile.NUMBF_S    = NUMBF_S;
   
   TranspFile.BRANCH     = OpContr.Branch;
   TranspFile.KTU_SS     = OpContr.KTU_SS;
   TranspFile.BIK_SS     = OpContr.BIK_SS;
   TranspFile.NUMBF_SS   = OpContr.NUMBF_SS;

   /* Информация об операции */
   TranspFile.TERROR = OpContr.Terror;
   TranspFile.VO     = GetVO( VOmain, VO );
   TranspFile.DOP_V  = GetDOP_V( TranspFile.VO, VO );
   TranspFile.DATA   = OpContr.Date_Carry;
   TranspFile.SUME   = Double(OpContr.SumRub);
   TranspFile.SUM    = Double(OpContr.SumCur);

   FI.FIID = OpContr.Code_Currency;
   if( not GetEQ(FI) )
     MsgBox( "Не найден финансовый инструмент FIID = " + FI.FIID );
     return 1;
   end;
   
   TranspFile.CURREN = FI.ISO_Number;

   if( OpContr.Metal )

     if( OpContr.Metal == -1 )
       TranspFile.METAL = "000";
     else

       FI.FIID = OpContr.Metal;
       if( not GetEQ(FI) )
         MsgBox( "Не найден финансовый инструмент FIID = " + FI.FIID );
         return 1;
       end;
       TranspFile.METAL = FI.FI_Code;

     end;

   end;

   PRIM = OpContr.Ground;

   TranspFile.PRIM_1 = SubString( @PRIM, 254 );
   TranspFile.PRIM_2 = SubString( @PRIM, 254 );

   TranspFile.DATE_PAY_D = OpContr.PaymDocDate;

   GetPaymDocNumber( OpContr.PaymDocNumber, @TranspFile.NUM_PAY_D, @TranspFile.REFER_R2 );

   TranspFile.PRIZ6001 = GetPRIZ6001( PRIZ6001, VO );
   TranspFile.B_PAYER  = OpContr.PayerBankSign;
   TranspFile.B_RECIP  = OpContr.ReceiverBankSign;
   TranspFile.PART     = OpContr.OprByOrderSign;

   DESCR = readNoteForObject( OBJTYPE_OPCONTR, MakeOpContrID(OpContr.OperationID), NOTEKIND_DESCR );

   TranspFile.DESCR_1 = SubString( @DESCR, 254 );
   TranspFile.DESCR_2 = SubString( @DESCR, 254 );

   TranspFile.SUM_CON = 0;

   if( OpContr.ConvOprCurrency != ALLFININSTR )
     
     FI.FIID = OpContr.ConvOprCurrency;
     if( not GetEQ(FI) )
       MsgBox( "Не найден финансовый инструмент FIID = " + FI.FIID );
       return 1;
     end;
   
     TranspFile.CURREN_CON = FI.ISO_Number;
     TranspFile.SUM_CON    = OpContr.ConvOprSum;

   end;

   TranspFile.PRIZ_SD = OpContr.MoneySign;
   
   /* Заполняем информацию об участниках */
   
   /* Плательщик */
   ПолучитьУчастникаОперации( OpContrParty, OpContr, _FM_PARTY_PAYER );

   
   ЗаполнитьОсновнуюИнформацию(
                                 OpContrParty
                                ,VO
                                ,@TranspFile.TU0      
                                ,@TranspFile.PRU0     
                                ,@TranspFile.NAMEU0   
                                ,@TranspFile.KODCR0   
                                ,@TranspFile.KODCN0   
                                ,@TranspFile.AMR_S0   
                                ,@TranspFile.AMR_R0   
                                ,@TranspFile.AMR_G0   
                                ,@TranspFile.AMR_U0   
                                ,@TranspFile.AMR_D0   
                                ,@TranspFile.AMR_K0   
                                ,@TranspFile.AMR_O0   
                                ,@TranspFile.ADRESS_S0
                                ,@TranspFile.ADRESS_R0
                                ,@TranspFile.ADRESS_G0
                                ,@TranspFile.ADRESS_U0
                                ,@TranspFile.ADRESS_D0
                                ,@TranspFile.ADRESS_K0
                                ,@TranspFile.ADRESS_O0
                                ,@TranspFile.KD0      
                                ,@TranspFile.SD0      
                                ,@TranspFile.RG0      
                                ,@TranspFile.ND0      
                                ,@TranspFile.VD01     
                                ,@TranspFile.VD02     
                                ,@TranspFile.VD03     
                                ,@TranspFile.VD04     
                                ,@TranspFile.VD05     
                                ,@TranspFile.VD06     
                                ,@TranspFile.VD07     
                                ,@TranspFile.MC_01    
                                ,@TranspFile.MC_02    
                                ,@TranspFile.MC_03    
                                ,@TranspFile.GR0      
                                ,@TranspFile.BP_0      
                              );
   
   
   ЗаполнитьИнформациюОБанках( OpContrParty
                              ,@TranspFile.VP_0       
                              ,@TranspFile.ACC_B0    
                              ,@TranspFile.ACC_COR_B0
                              ,@TranspFile.NAME_IS_B0
                              ,@TranspFile.BIK_IS_B0 
                              ,@TranspFile.CARD_B0   
                              ,@TranspFile.NAME_B0   
                              ,@TranspFile.KODCN_B0  
                              ,@TranspFile.BIK_B0    
                              ,@TranspFile.NAME_R0  
                              ,@TranspFile.KODCN_R0  
                              ,@TranspFile.BIK_R0    
                             );
   
   /* Представитель плательщика */
   ПолучитьУчастникаОперации( OpContrParty, OpContr, _FM_PARTY_PAYER_REPRESENT );


   ЗаполнитьОсновнуюИнформацию(
                                 OpContrParty
                                ,VO
                                ,@TranspFile.TU1      
                                ,@TranspFile.PRU1     
                                ,@TranspFile.NAMEU1   
                                ,@TranspFile.KODCR1   
                                ,@TranspFile.KODCN1   
                                ,@TranspFile.AMR_S1   
                                ,@TranspFile.AMR_R1   
                                ,@TranspFile.AMR_G1   
                                ,@TranspFile.AMR_U1   
                                ,@TranspFile.AMR_D1   
                                ,@TranspFile.AMR_K1   
                                ,@TranspFile.AMR_O1   
                                ,@TranspFile.ADRESS_S1
                                ,@TranspFile.ADRESS_R1
                                ,@TranspFile.ADRESS_G1
                                ,@TranspFile.ADRESS_U1
                                ,@TranspFile.ADRESS_D1
                                ,@TranspFile.ADRESS_K1
                                ,@TranspFile.ADRESS_O1
                                ,@TranspFile.KD1
                                ,@TranspFile.SD1      
                                ,@TranspFile.RG1      
                                ,@TranspFile.ND1      
                                ,@TranspFile.VD11     
                                ,@TranspFile.VD12     
                                ,@TranspFile.VD13     
                                ,@TranspFile.VD14     
                                ,@TranspFile.VD15     
                                ,@TranspFile.VD16     
                                ,@TranspFile.VD17     
                                ,@TranspFile.MC_11    
                                ,@TranspFile.MC_12    
                                ,@TranspFile.MC_13    
                                ,@TranspFile.GR1      
                                ,@TranspFile.BP_1      
                              );

   /* Представитель получателя */
   ПолучитьУчастникаОперации( OpContrParty, OpContr, _FM_PARTY_RECEIVER_REPRESENT );

   ЗаполнитьОсновнуюИнформацию(
                                 OpContrParty
                                ,VO
                                ,@TranspFile.TU2      
                                ,@TranspFile.PRU2     
                                ,@TranspFile.NAMEU2   
                                ,@TranspFile.KODCR2   
                                ,@TranspFile.KODCN2   
                                ,@TranspFile.AMR_S2   
                                ,@TranspFile.AMR_R2   
                                ,@TranspFile.AMR_G2   
                                ,@TranspFile.AMR_U2   
                                ,@TranspFile.AMR_D2   
                                ,@TranspFile.AMR_K2   
                                ,@TranspFile.AMR_O2   
                                ,@TranspFile.ADRESS_S2
                                ,@TranspFile.ADRESS_R2
                                ,@TranspFile.ADRESS_G2
                                ,@TranspFile.ADRESS_U2
                                ,@TranspFile.ADRESS_D2
                                ,@TranspFile.ADRESS_K2
                                ,@TranspFile.ADRESS_O2
                                ,@TranspFile.KD2      
                                ,@TranspFile.SD2      
                                ,@TranspFile.RG2      
                                ,@TranspFile.ND2      
                                ,@TranspFile.VD21     
                                ,@TranspFile.VD22     
                                ,@TranspFile.VD23     
                                ,@TranspFile.VD24     
                                ,@TranspFile.VD25     
                                ,@TranspFile.VD26     
                                ,@TranspFile.VD27     
                                ,@TranspFile.MC_21    
                                ,@TranspFile.MC_22    
                                ,@TranspFile.MC_23    
                                ,@TranspFile.GR2      
                                ,@TranspFile.BP_2      
                              );
 
   /* Получатель */
   ПолучитьУчастникаОперации( OpContrParty, OpContr, _FM_PARTY_RECEIVER );

   ЗаполнитьОсновнуюИнформацию(
                                 OpContrParty
                                ,VO
                                ,@TranspFile.TU3      
                                ,@TranspFile.PRU3     
                                ,@TranspFile.NAMEU3   
                                ,@TranspFile.KODCR3   
                                ,@TranspFile.KODCN3   
                                ,@TranspFile.AMR_S3   
                                ,@TranspFile.AMR_R3   
                                ,@TranspFile.AMR_G3   
                                ,@TranspFile.AMR_U3   
                                ,@TranspFile.AMR_D3   
                                ,@TranspFile.AMR_K3   
                                ,@TranspFile.AMR_O3   
                                ,@TranspFile.ADRESS_S3
                                ,@TranspFile.ADRESS_R3
                                ,@TranspFile.ADRESS_G3
                                ,@TranspFile.ADRESS_U3
                                ,@TranspFile.ADRESS_D3
                                ,@TranspFile.ADRESS_K3
                                ,@TranspFile.ADRESS_O3
                                ,@TranspFile.KD3      
                                ,@TranspFile.SD3      
                                ,@TranspFile.RG3      
                                ,@TranspFile.ND3      
                                ,@TranspFile.VD31     
                                ,@TranspFile.VD32     
                                ,@TranspFile.VD33     
                                ,@TranspFile.VD34     
                                ,@TranspFile.VD35     
                                ,@TranspFile.VD36     
                                ,@TranspFile.VD37     
                                ,@TranspFile.MC_31    
                                ,@TranspFile.MC_32    
                                ,@TranspFile.MC_33    
                                ,@TranspFile.GR3      
                                ,@TranspFile.BP_3      
                              );

   ЗаполнитьИнформациюОБанках( OpContrParty
                              ,@TranspFile.VP_3       
                              ,@TranspFile.ACC_B3    
                              ,@TranspFile.ACC_COR_B3
                              ,@TranspFile.NAME_IS_B3
                              ,@TranspFile.BIK_IS_B3 
                              ,@TranspFile.CARD_B3   
                              ,@TranspFile.NAME_B3   
                              ,@TranspFile.KODCN_B3  
                              ,@TranspFile.BIK_B3    
                              ,@TranspFile.NAME_R3  
                              ,@TranspFile.KODCN_R3  
                              ,@TranspFile.BIK_R3    
                             );
   
   /* Лицо, по поручению и от имени которого совершается операция */
   ПолучитьУчастникаОперации( OpContrParty, OpContr, _FM_PARTY_ORDER );

   ЗаполнитьОсновнуюИнформацию(
                                 OpContrParty
                                ,VO
                                ,@TranspFile.TU4      
                                ,@TranspFile.PRU4     
                                ,@TranspFile.NAMEU4   
                                ,@TranspFile.KODCR4   
                                ,@TranspFile.KODCN4   
                                ,@TranspFile.AMR_S4   
                                ,@TranspFile.AMR_R4   
                                ,@TranspFile.AMR_G4   
                                ,@TranspFile.AMR_U4   
                                ,@TranspFile.AMR_D4   
                                ,@TranspFile.AMR_K4   
                                ,@TranspFile.AMR_O4   
                                ,@TranspFile.ADRESS_S4
                                ,@TranspFile.ADRESS_R4
                                ,@TranspFile.ADRESS_G4
                                ,@TranspFile.ADRESS_U4
                                ,@TranspFile.ADRESS_D4
                                ,@TranspFile.ADRESS_K4
                                ,@TranspFile.ADRESS_O4
                                ,@TranspFile.KD4      
                                ,@TranspFile.SD4      
                                ,@TranspFile.RG4      
                                ,@TranspFile.ND4      
                                ,@TranspFile.VD41     
                                ,@TranspFile.VD42     
                                ,@TranspFile.VD43     
                                ,@TranspFile.VD44     
                                ,@TranspFile.VD45     
                                ,@TranspFile.VD46     
                                ,@TranspFile.VD47     
                                ,@TranspFile.MC_41    
                                ,@TranspFile.MC_42    
                                ,@TranspFile.MC_43    
                                ,@TranspFile.GR4      
                                ,@TranspFile.BP_4      
                              );
   
   
   /* Подкорректируем некоторые поля */
   CorrectTransportFile(TranspFile);

   if ( not Insert( TranspFile ) )
      MsgBox( "Ошибка вставки записи в транспортный файл" );
      return 1;
   end;
   
   return 0; /* Запись успешно выгружена */
end;

