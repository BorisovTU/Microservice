import globals, dbf2ora, cb_sql, BankInter, rsd;

var countAccounts = 0;
var countPhases = 0;
var prevAccount, prevChapter, prevCurrency;

private macro PrintTableHeader()
[⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒ¬ƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø];
[≥ ã®Ê•¢Æ© ·Á•‚       ≥É´†¢†≥Ç†´Ó‚†≥çÆ¨•‡ ‰†ßÎ≥ Ñ†‚† ‰†ßÎ  ≥Ñ†‚† Æ‚™‡Î‚®Ô≥çÆ¨•‡ ‰†ßÎ ≠†≥];
[≥                    ≥     ≥      ≥          ≥            ≥             ≥§†‚„ Æ‚™‡Î‚®Ô≥];
end;

private macro PrintTableDelimiter()
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
end;

private macro PrintTableFooter()
[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒ¡ƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
end;

private macro PrintTableLine(Account, Chapter, Currency, Phase, PhaseDate, OpenDate, PhaseOpenDate)
  if(OpenDate != null)
    if(PhaseOpenDate >= 0)
[≥####################≥  ## ≥  ### ≥  #####   ≥ ########## ≥ ##########  ≥ ##########  ≥]
(Account, Chapter, Currency, Phase, PhaseDate, OpenDate, PhaseOpenDate);
    else
[≥####################≥  ## ≥  ### ≥  #####   ≥ ########## ≥ ##########  ≥ Æ‚·„‚·‚¢„•‚ ≥]
(Account, Chapter, Currency, Phase, PhaseDate, OpenDate);
    end;
  else
[≥                    ≥     ≥      ≥  #####   ≥ ########## ≥             ≥             ≥]
(Phase, PhaseDate);
  end;

  countPhases = countPhases + 1;
end;

private macro PrintTableProtocol(Account, Chapter, Currency, Phase, PhaseDate, OpenDate, PhaseOpenDate)
  if(not countPhases)
    PrintTableHeader();
  end;
  if(   (prevAccount  != Account )
     or (prevChapter  != Chapter )
     or (prevCurrency != Currency)
    )
    PrintTableDelimiter();
    prevAccount  = Account ;
    prevChapter  = Chapter ;
    prevCurrency = Currency;

    countAccounts = countAccounts + 1;
    
    PrintTableLine(Account, Chapter, Currency, Phase, PhaseDate, OpenDate, PhaseOpenDate);
  else
    PrintTableLine(Account, Chapter, Currency, Phase, PhaseDate);
  end;
end;

macro PrintProtocol()
  var sqlString : string;
  var rs, cmd;
  rs = SQL_ExecuteAndGetRs("SELECT t_name FROM dperson_dbt WHERE t_oper = " + {oper});
  rs.MoveNext;
[           ëØ®·Æ™ ≠•™Æ‡‡•™‚≠ÎÂ ‰†ß §´Ô ´/·Á•‚Æ¢];
[ ];
[Ñ†‚†: ########## ########](date(), time());
[èÆ´ÏßÆ¢†‚•´Ï: ##### ####################################]({oper}, rs.value(0));
[ ];

  sqlString = "  SELECT t1.t_Account,                                        " + 
              "         t1.t_Chapter,                                        " + 
              "         t1.t_Currency,                                       " + 
              "         t1.t_Phase,                                          " + 
              "         t1.t_PhaseDate,                                      " + 
              "         t2.t_Open_Date,                                      " +
              "         NVL((SELECT t3.t_Phase                               " +
              "                FROM dopdphase_dbt t3                         " +
              "               WHERE     t3.t_Account = t2.t_Account          " +
              "                     AND t3.t_Chapter = t2.t_Chapter          " +
              "                     AND t3.t_Currency = t2.t_Code_Currency   " +
              "                     AND t3.t_PhaseDate = t2.t_Open_Date), -1 " +
              "            ) t_Phase_Open_Date                               " +
              "    FROM dopdphase_dbt t1, daccount_dbt t2                    " + 
              "   WHERE     t1.t_Account = t2.t_Account                      " + 
              "         AND t1.t_Chapter = t2.t_Chapter                      " + 
              "         AND t1.t_Currency = t2.t_Code_Currency               " + 
              "         AND t1.t_PhaseDate < t2.t_Open_Date                  " + 
              "ORDER BY t1.t_Account, t1.t_Chapter, t1.t_Currency, t1.t_Phase" ; 
  cmd = RsdCommand(sqlString);
  cmd.NullConversion = true;
  rs = RsdRecordset(cmd);
  while(rs.moveNext())
    PrintTableProtocol(rs.value(0), rs.value(1), rs.value(2), rs.value(3), date(rs.value(4)), date(rs.value(5)), int(rs.value(6)));
  end;

  if(countPhases)
    PrintTableFooter();
  end;

[ ];
[é°≠†‡„¶•≠Æ ##### ≠•™Æ‡‡•™‚≠ÎÂ ‰†ß ØÆ ##### ´®Ê•¢Î¨ ·Á•‚†¨.](countPhases, countAccounts);

end;

PrintProtocol();
