import mfo_lib;

record Panel(PBIKSWIF, "bank.lbr") dialog;

var stat;
var showReport = false;
var RecreateTableDBF = false;

macro RunCompare(dlg_rec)
  var ErrText;
  var Query;

  /* 
   * Таблица протокола bik_swif.log, 
   * таблица файла bik_swif.dbf создаются апргейдом 2ой категории 
   */
  ClearCompareTempTable();
  
  /* Таблица bik_swif.dbf создается апгрейдером 2ой категории, поэтому RecreateTableDBF = false*/
  if(not dbf2ora(dlg_rec.FileName, "bik_swif_dbf", "Загрузка файла bik_swif.dbf в БД", ErrText, RecreateTableDBF))
    msgbox(ErrText);
    return 1;
  end;

  if(not CheckBikSwifCorrectStruct())
    msgbox("Ошибка: файл " + dlg_rec.FileName + " имеет не поддерживаемую структуру");
    return 1;
  end;

  if(RecreateTableDBF)
    SQL_Execute("ALTER PACKAGE rsb_convmfo COMPILE");
  end;

  SQL_Execute("BEGIN dbms_stats.gather_table_stats(ownname=>sys_context('USERENV', 'SESSION_USER'), tabname=>'DOBJCODE_DBT'); END;", "Сбор статистики...");

  CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bs.t_kod_rus /*t_kod_rus*/
 ,bs.t_kod_swift /*t_kod_swift*/
 ,bs.t_name_srus /*t_name_srus*/
 ,ptcd1.t_partyid /*t_partyid*/
 ,'Значение кода SWIFT BIC ' || bs.t_kod_swift || ' у субъекта экономики отсутствует' /*t_text*/
 ,1 /*t_texttype*/
  FROM bik_swif_dbf bs, dpartcode_dbt ptcd1
 WHERE ptcd1.t_code = bs.t_kod_rus
   AND ptcd1.t_codekind = 3
   AND NOT EXISTS
       (
         SELECT 1 
           FROM dpartcode_dbt ptcd2
          WHERE ptcd2.t_codekind = 6
            AND ptcd2.t_partyid = ptcd1.t_partyid
       );
];
  Query = StopCaptureOutput;
  SQL_Execute(Query);
  
  CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bs.t_kod_rus /*t_kod_rus*/
 ,bs.t_kod_swift /*t_kod_swift*/
 ,bs.t_name_srus /*t_name_srus*/
 ,ptcd1.t_partyid /*t_partyid*/
 ,'Значение кода SWIFT BIC ' || bs.t_kod_swift || ' субъекта экономики - банка не равно значению в Справочнике' /*t_text*/
 ,2 /*t_texttype*/
  FROM bik_swif_dbf bs, dpartcode_dbt ptcd1
 WHERE ptcd1.t_code = bs.t_kod_rus
   AND ptcd1.t_codekind = 3
   AND EXISTS
       (
         SELECT 1 
           FROM dpartcode_dbt ptcd2
          WHERE ptcd2.t_codekind = 6
            AND ptcd2.t_code != bs.t_kod_swift
            AND ptcd2.t_partyid = ptcd1.t_partyid
       );
];
  Query = StopCaptureOutput;
  SQL_Execute(Query);
  
  if(dlg_rec.Param1 == "X")
    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bs.t_kod_rus /*t_kod_rus*/
 ,bs.t_kod_swift /*t_kod_swift*/
 ,bs.t_name_srus /*t_name_srus*/
 ,0 /*t_partyid*/
 ,'Субъект экономики - банк с таким кодом БИК не зарегистрирован в системе' /*t_text*/
 ,3 /*t_texttype*/
  FROM bik_swif_dbf bs
 WHERE NOT EXISTS
       (
         SELECT 1 
           FROM dpartcode_dbt ptcd
          WHERE ptcd.t_codekind = 3
            AND ptcd.t_code = bs.t_kod_rus
       );
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);

    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bs.t_kod_rus /*t_kod_rus*/
 ,bs.t_kod_swift /*t_kod_swift*/
 ,bs.t_name_srus /*t_name_srus*/
 ,0 /*t_partyid*/
 ,'Субъект экономики - банк с таким кодом СВИФТ БИК не зарегистрирован в системе' /*t_text*/
 ,4 /*t_texttype*/
  FROM bik_swif_dbf bs
 WHERE NOT EXISTS
       (
         SELECT 1 
           FROM dpartcode_dbt ptcd
          WHERE ptcd.t_codekind = 6
            AND ptcd.t_code = bs.t_kod_swift
       );
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);
  end;
  
  if(dlg_rec.Param2 == "X")
    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  CHR(1) /*t_kod_rus*/
 ,CHR(1) /*t_kod_swift*/
 ,CHR(1) /*t_name_srus*/
 ,ptcd1.t_partyid /*t_partyid*/
 ,'Субъект экономики имеет код БИК ' || ptcd1.t_code || ', отсутствующий в Справочнике' /*t_text*/
 ,5 /*t_texttype*/
  FROM dpartcode_dbt ptcd1, dpartcode_dbt ptcd2
 WHERE ptcd1.t_codekind = 3
   AND ptcd2.t_codekind = 6
   AND ptcd1.t_partyid = ptcd2.t_partyid
   AND NOT EXISTS
       (
         SELECT 1 
           FROM bik_swif_dbf bs
          WHERE bs.t_kod_rus = ptcd1.t_code
       );
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);

    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  CHR(1) /*t_kod_rus*/
 ,CHR(1) /*t_kod_swift*/
 ,CHR(1) /*t_name_srus*/
 ,ptcd.t_partyid /*t_partyid*/
 ,'Субъект экономики имеет код SWIFT BIC ' || ptcd.t_code || ', отсутствующий в Справочнике' /*t_text*/
 ,6 /*t_texttype*/
  FROM dpartcode_dbt ptcd
 WHERE ptcd.t_codekind = 6
   AND NOT EXISTS
       (
         SELECT 1 
           FROM bik_swif_dbf bs
          WHERE bs.t_kod_swift = ptcd.t_code
       );
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);
  end;
  
  if(dlg_rec.Param3 == "X")
    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bs.t_kod_rus /*t_kod_rus*/
 ,bs.t_kod_swift /*t_kod_swift*/
 ,bs.t_name_srus /*t_name_srus*/
 ,ptcd.t_partyid /*t_partyid*/
 ,'Наименование "' || ptnm.t_name || '" субъекта экономики - банка не равно значению в Справочнике' /*t_text*/
 ,7 /*t_texttype*/
  FROM bik_swif_dbf bs, dpartcode_dbt ptcd, dpartyname_dbt ptnm
 WHERE ptcd.t_code = bs.t_kod_rus
   AND ptcd.t_codekind = 3
   AND ptnm.t_partyid = ptcd.t_partyid
   AND ptnm.t_nametypeid = 2
   AND UPPER(ptnm.t_name) != UPPER(bs.t_name_srus);
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);
  end;
  
  if(dlg_rec.Param4 == "X")
    CaptureOutput;
[
INSERT INTO dobjcode_dbt 
(
  t_objecttype
 ,t_codekind
 ,t_objectid
 ,t_code
 ,t_state
 ,t_bankdate
 ,t_sysdate
 ,t_systime
 ,t_userid
 ,t_branch
 ,t_numsession
 ,t_unique
 ,t_bankclosedate
)
SELECT 
  3 /*t_objecttype*/
 ,6 /*t_codekind*/
 ,bsl.t_partyid /*t_objectid*/
 ,TRIM(bsl.t_kod_swift) /*t_code*/
 ,0 /*t_state*/
 ,TO_DATE('##########', 'DD.MM.YYYY') /*t_bankdate*/
 ,TRUNC(SYSDATE) /*t_sysdate*/
 ,TO_DATE('01.01.0001:' || TO_CHAR(SYSDATE, 'HH24:MI:SS'), 'DD.MM.YYYY:HH24:MI:SS') /*t_systime*/
 ,##### /*t_userid*/
 ,0 /*t_branch*/
 ,0 /*t_numsession*/
 ,'X' /*t_unique*/
 ,TO_DATE('01.01.0001', 'DD.MM.YYYY') /*t_bankclosedate*/
  FROM bik_swif_log bsl
 WHERE bsl.t_texttype = 1;
](string({BranchCurDate}), {oper});
    Query = StopCaptureOutput;
    SQL_Execute(Query);
  
    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bsl.t_kod_rus /*t_kod_rus*/
 ,bsl.t_kod_swift /*t_kod_swift*/
 ,bsl.t_name_srus /*t_name_srus*/
 ,bsl.t_partyid /*t_partyid*/
 ,'Для субъекта экономики введено новое значение кода SWIFT BIC' /*t_text*/
 ,8 /*t_texttype*/
  FROM bik_swif_log bsl
 WHERE bsl.t_texttype = 1;
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);
  
    CaptureOutput;
[
UPDATE dobjcode_dbt obc
   SET obc.t_code = 
       (
        SELECT bsl.t_kod_swift
          FROM bik_swif_log bsl
         WHERE bsl.t_partyid = obc.t_objectid
           AND bsl.t_texttype = 2
       )
 WHERE obc.t_objecttype = 3
   AND obc.t_codekind = 6
   AND obc.t_state = 0
   AND obc.t_bankclosedate = TO_DATE('01.01.0001', 'DD.MM.YYYY')
   AND obc.t_objectid IN
       (
        SELECT bsl.t_partyid
          FROM bik_swif_log bsl
         WHERE bsl.t_texttype = 2
       );
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);

    CaptureOutput;
[
INSERT INTO bik_swif_log 
(
  t_kod_rus
 ,t_kod_swift
 ,t_name_srus
 ,t_partyid
 ,t_text
 ,t_texttype
)
SELECT 
  bsl.t_kod_rus /*t_kod_rus*/
 ,bsl.t_kod_swift /*t_kod_swift*/
 ,bsl.t_name_srus /*t_name_srus*/
 ,bsl.t_partyid /*t_partyid*/
 ,'У субъекта экономики заменено значение кода SWIFT BIC' /*t_text*/
 ,9 /*t_texttype*/
  FROM bik_swif_log bsl
 WHERE bsl.t_texttype = 2;
];
    Query = StopCaptureOutput;
    SQL_Execute(Query);
  end;

  PrintBikSwifProtocol(dlg_rec);

  showReport = true;
end;

macro InitPan(dlg_rec)
  var ImportFileDir;

  ClearRecord(dlg_rec);

  GetRegistryValue("CB\\BNKSIMPORT\\IMPORTFILEDIR", V_STRING, ImportFileDir, stat, false, {oper});

  if(substr(ImportFileDir, strlen(ImportFileDir)) != "\\" )
    ImportFileDir = ImportFileDir + "\\";
  end;

  dlg_rec.FileName = ImportFileDir + "bik_swif.dbf";
  dlg_rec.Param1 = "X";
  dlg_rec.Param2 = "";
  dlg_rec.Param3 = "";
  dlg_rec.Param4 = "";
end;

macro EventPan(dlg, cmd, id, key)
  var FName : string;
  var FExt : string;
  var PathToFile : string;
  var SelectPath : string;

  if(cmd == DLG_INIT)
    InitPan(dlg);
    UpdateFields(dlg);

  elif((CMD == DLG_KEY) and (key == 32/*K_SPACE*/))
    if(trim(fldname(dlg, id)) == "Param1")
      if(dlg.Param1 == "")
        dlg.Param1 = "X";
      else
        dlg.Param1 = "";
      end;
    elif(trim(fldname(dlg, id)) == "Param2")
      if(dlg.Param2 == "")
        dlg.Param2 = "X";
      else
        dlg.Param2 = "";
      end;
    elif(trim(fldname(dlg, id)) == "Param3")
      if(dlg.Param3 == "")
        dlg.Param3 = "X";
      else
        dlg.Param3 = "";
      end;
    elif(trim(fldname(dlg, id)) == "Param4")
      if(dlg.Param4 == "")
        dlg.Param4 = "X";
      else
        dlg.Param4 = "";
      end;
    end;
    UpdateFields(dlg);

  elif((CMD == DLG_KEY) and (key == 316/*K_F2*/))

    RunCompare(dlg);
    return CM_CANCEL;

  elif((CMD == DLG_KEY) and (key == 317/*K_F3*/))
    if(trim(fldname(dlg, id)) == "FileName")

      PathToFile = SplitFile(dlg.FileName, FName, FExt);
      SelectPath = MergeFile(PathToFile, "*", "dbf");

      stat = SelectFile(FName, SelectPath, "Выбор файла для сверки");
      if(stat)
        dlg.FileName = FName;
      end;

    end;
    UpdateFields(dlg);

  else
    return CM_DEFAULT;
  end;
end;

RunDialog(Panel, "EventPan");

if(not showReport)
  exit(1); 
end;
