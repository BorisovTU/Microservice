/*
$Name: ptchkrfridn.mac
$Module: Ядро ГКБО
$Description: Субъекты экономики для обновления анкеты
*/

import BankInter, PTInter, rsd, globals, likepy;
import rsd, oralib, cb_sql;

private macro _PrintUndefinedPartyKind(PartyKind)
  var query = "SELECT rfr.t_PartyID, pt.t_Name, rfr.t_ExpireDate " +
              "  FROM dptchkrfridn_tmp rfr JOIN dparty_dbt pt ON (rfr.t_PartyID = pt.t_PartyID) " +
              " WHERE rfr.t_ResultCode = 4 " +
              "   AND rfr.t_PartyKind = " + string(PartyKind) + " " +
              "   AND rfr.t_ExpireDate = TO_DATE('01.01.0001', 'DD.MM.YYYY') " +
              " ORDER BY rfr.t_PartyKind, rfr.t_PartyID";
  var cmd = RsdCommand(query);
  cmd.NullConversion = true;
  var rs = RsdRecordset(cmd);
  while(rs.MoveNext())
[########## #######################################################################] (rs.value(0):l, rs.value(1));
  end;
end;

private macro _PrintUndefined
(
  SelectClient,
  SelectProxy,
  SelectBeneficiary,
  SelectBeneOwner
)
[
Не определена дата оформления анкеты];
[==================================================================================];
  if(SelectClient)
[клиенты:];
    _PrintUndefinedPartyKind(1);
[----------------------------------------------------------------------------------];
  end;
  if(SelectProxy)
[представители клиентов:];
    _PrintUndefinedPartyKind(64);
[----------------------------------------------------------------------------------];
  end;
  if(SelectBeneficiary)
[выгодоприобретатели:];
    _PrintUndefinedPartyKind(43);
[----------------------------------------------------------------------------------];
  end;
  if(SelectBeneOwner)
[бенефициарные владельцы:];
    _PrintUndefinedPartyKind(68);
[----------------------------------------------------------------------------------];
  end;
end;

private macro _PrintDeadlinePartyKind(PartyKind)
  var query = "SELECT rfr.t_PartyID, pt.t_Name, rfr.t_ExpireDate " +
              "  FROM dptchkrfridn_tmp rfr JOIN dparty_dbt pt ON (rfr.t_PartyID = pt.t_PartyID) " +
              " WHERE rfr.t_ResultCode = 3 " +
              "   AND rfr.t_PartyKind = " + string(PartyKind) + " " +
              " ORDER BY rfr.t_PartyKind, rfr.t_PartyID";
  var cmd = RsdCommand(query);
  cmd.NullConversion = true;
  var rs = RsdRecordset(cmd);
  while(rs.MoveNext())
[########## ############################################################ ##########] (rs.value(0):l, rs.value(1), date(rs.value(2)):f);
  end;
end;

private macro _PrintDeadline
(
  SelectClient,
  SelectProxy,
  SelectBeneficiary,
  SelectBeneOwner
)
[
Срок обновления анкеты истекает];
[==================================================================================];
  if(SelectClient)
[клиенты:];
    _PrintDeadlinePartyKind(1);
[----------------------------------------------------------------------------------];
  end;
  if(SelectProxy)
[представители клиентов:];
    _PrintDeadlinePartyKind(64);
[----------------------------------------------------------------------------------];
  end;
  if(SelectBeneficiary)
[выгодоприобретатели:];
    _PrintDeadlinePartyKind(43);
[----------------------------------------------------------------------------------];
  end;
  if(SelectBeneOwner)
[бенефициарные владельцы:];
    _PrintDeadlinePartyKind(68);
[----------------------------------------------------------------------------------];
  end;
end;

private macro _PrintExpiredPartyKind(PartyKind)
  var query = "SELECT rfr.t_PartyID, pt.t_Name, rfr.t_ExpireDate " +
              "  FROM dptchkrfridn_tmp rfr JOIN dparty_dbt pt ON (rfr.t_PartyID = pt.t_PartyID) " +
              " WHERE rfr.t_ResultCode = 4 " +
              "   AND rfr.t_PartyKind = " + string(PartyKind) + " " +
              "   AND rfr.t_ExpireDate <> TO_DATE('01.01.0001', 'DD.MM.YYYY') " +
              " ORDER BY rfr.t_PartyKind, rfr.t_PartyID";
  var cmd = RsdCommand(query);
  cmd.NullConversion = true;
  var rs = RsdRecordset(cmd);
  while(rs.MoveNext())
[########## ############################################################ ##########] (rs.value(0):l, rs.value(1), date(rs.value(2)):f);
  end;
end;

private macro _PrintExpired
(
  SelectClient,
  SelectProxy,
  SelectBeneficiary,
  SelectBeneOwner
)
[
Срок обновления анкеты истек];
[==================================================================================];
  if(SelectClient)
[клиенты:];
    _PrintExpiredPartyKind(1);
[----------------------------------------------------------------------------------];
  end;
  if(SelectProxy)
[представители клиентов:];
    _PrintExpiredPartyKind(64);
[----------------------------------------------------------------------------------];
  end;
  if(SelectBeneficiary)
[выгодоприобретатели:];
    _PrintExpiredPartyKind(43);
[----------------------------------------------------------------------------------];
  end;
  if(SelectBeneOwner)
[бенефициарные владельцы:];
    _PrintExpiredPartyKind(68);
[----------------------------------------------------------------------------------];
  end;
end;

private macro _PrintReportDepartment(Dprt)
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT t_Name ";
  query = query + "  FROM dparty_dbt ";
  query = query + " WHERE t_PartyID = (SELECT t_PartyID ";
  query = query + "                      FROM ddp_dep_dbt ";
  query = query + "                     WHERE t_Code = ?) ";

  params = makeArray
    (
      SQLParam("", Dprt)
    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
[Филиал: ##### #                                                                   ] (Dprt:l, rs.value(0));
  end;                         
end;

macro PrintReport
(
  ReportFileName, 
  OnDate,
  Dprt,
  NeedChildService,
  IdentifyUndefined,
  IdentifyDeadline,
  AlertDays,
  IdentifyExpired,
  SelectClient,
  SelectProxy,
  SelectBeneficiary,
  SelectBeneOwner
)
  setoutput(ReportFileName);
[Субъекты экономики для обновления анкеты                                          ];
[                                                                                  ];
[Дата:         ########## г.                                                       ] (date:f);                
[Время:        ########                                                            ] (time:f);
[Пользователь: ##### #                                                             ] ({oper}, {Name_Oper});   
[                                                                                  ];
_PrintReportDepartment(Dprt);
[Подчиненные филиалы: #                                                            ] (IfThenElse(NeedChildService, "да", "нет"));
[По состоянию на дату: ########## г.                                               ] (OnDate:f);
  if(IdentifyExpired)
[Срок обновления истекает в течение ##### дней                                     ] (AlertDays:l);
  end;

  if(IdentifyUndefined)
    _PrintUndefined(SelectClient, SelectProxy, SelectBeneficiary, SelectBeneOwner);
  end;
  if(IdentifyDeadline)
    _PrintDeadline(SelectClient, SelectProxy, SelectBeneficiary, SelectBeneOwner);
  end;
  if(IdentifyExpired)
    _PrintExpired(SelectClient, SelectProxy, SelectBeneficiary, SelectBeneOwner);
  end;

  setoutput();
end;