/************************************************************************/
/*         Автоматизированная банковская система RS-Bank v6.0           */
/*                 Copyright (c) R-Style Software Lab 2005              */
/*  Имя файла        : cbsfinv50.mac                                    */
/*  Описание         : Завершение обработки ТО                          */
/*  Программист      : SolAN                                            */
/*  Создан           : 09-06-2008                                       */
/************************************************************************/


import OprInter, InsCarryDoc, SFInter, RsbDataSet,  BankInter, "globals.mac";

macro ExistsLinks( InvoiceID )
  var sQuery;
  var DataSet;

  sQuery = "select * from dsfinvlnk_dbt "
         + "where t_InvoiceID = " + string(InvoiceID);

  DataSet = TRsbDataSet(sQuery);
  if( DataSet.MoveNext() )
    return true;
  end;

  return false;
end;

private macro CreateSf()
  var Regval = false;
  var error = 0;

  GetRegistryValue( "CB\\BILLFACT\\ФОРМИРОВАТЬ СФ АВТОМАТИЧЕСКИ", V_BOOL, RegVal, error );
    
  if( error != 0)
    RegVal = false;
  end;

  return RegVal;
end;


macro ExecuteStep( d, sfinv )
  record sfinv_buf("sfinv.dbt");
  var crsf = false;

  setbuff( sfinv_buf, sfinv );

  if( sfinv_buf.InvoiceStatus == SFINV_STATUS_PAYED )
    /* Если статус ТО "оплачено", то завершаем операцию */
    if( not InsertOprStatus(SFINV_OPRPAYSTATUS, SFINV_STATUS_PAYED) ) 
      msgbox( "Ошибка при установке статуса операции" );
      return 1;
    end;

    if( not InsertOprStatus(SFINV_OPRCORRECTPAYMSTATUS, SFINV_CORRECTPAYM_NOTDEFINED) ) 
      msgbox( "Ошибка при установке статуса операции." );
      return 1;
    end;  
  else
    if( GetTrue( true, "Проставить документу статус \"Оплачено\"?" ) == true )
      if( not SfInvSetState( sfinv_buf.InvoiceID, SFINV_STATUS_PAYED, true ) ) 
        msgbox( "Ошибка при установке статуса ТО" );
        return 1;
      end;

      if ((sfinv_buf.InvMethod == SFINV_INVMETHOD_ACCOUNT) or (sfinv_buf.InvMethod == SFINV_INVMETHOD_NOPAYDOC))
        crsf = CreateSf();
        if((crsf == true) and (sfinv_buf.FacturaID > 0))  
          if(not CreateBilBookEntry(sfinv_buf.FacturaID, {curdate}, SFDOC_INV, sfinv_buf.InvoiceID, sfinv_buf.PayFIID, sfinv_buf.TotalAmount)) //???
            return 1;
          end;
        end;
     end;

      if( not InsertOprStatus(SFINV_OPRPAYSTATUS, SFINV_STATUS_PAYED) ) 
        msgbox( "Ошибка при установке статуса операции" );
        return 1;
      end;

      if( not InsertOprStatus(SFINV_OPRCORRECTPAYMSTATUS, SFINV_CORRECTPAYM_NOTDEFINED) ) 
        msgbox( "Ошибка при установке статуса операции." );
        return 1;
      end;
    else
      return 1;
    end;
  end;

  return 0;
end;