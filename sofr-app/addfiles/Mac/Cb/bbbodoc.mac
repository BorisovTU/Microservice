/*
$Name:             bbbodoc.mac
$Module:           Ядро Banking
$Description:      Макродействия банковских ордеров
*/

import  pmbuff, PaymInter, BankInter, globals, FIInter, "pmchoper.mac", "pm_chksave.mac", "pm_common.mac", "likepy.mac", 
"pm_tools.mac", "pmedit.mac";

class (TPanelFields)TBankOrderPanelFields()
  
  InitTPanelFields();
  Number = BO_P_FLD_Number;
  BaseAmount = BO_P_FLD_BaseAmount;
  FIID = BO_P_FLD_FICode;
  BaseFIID = BO_P_FLD_BaseFICode;
  PayFIID = BO_P_FLD_PayFICode;
  Priority = BO_P_FLD_Priority;
  NumberPack = BO_P_FLD_NumberPack;
  rmDate = BO_P_FLD_Date;
  ValueDate = BO_P_FLD_ValueDate;
  PayerAccount = BO_P_FLD_PayerAccount;
  ReceiverAccount = BO_P_FLD_ReceiverAccount;
  PayerName = BO_P_FLD_PayerName;
  Ground = BO_P_FLD_Ground; 

end;

macro BB_BankOrderNewDoc()
   return 0;
end;

/*
                      Пользовательская функция
     Режимы функции
        UFN_PANEL_INPUT = 1 - панель ввода
        UFN_PANEL_EDIT  = 2 - панель редактирования
        UFN_SCROL       = 3 - вызов из скроллинга
     (константы доступны при подключенном BankInter)
*/
macro BB_BankOrderUserFunc( режим )
   return 0;
end;

private macro bo_IsCurAddPI( isCur:bool, rec:TRechandler ):bool
  return isCur or ( rec.rec.FIID != NATCUR );
end;

// Проверка наличия в счете разноски хоть одного валютного счета.
private macro IsCurAddPIPayment( PaymentObj:RsbPayment ):bool
  return ( reduce( PaymentObj.PIList( PRT_Debet  ).AsTArray(), @bo_IsCurAddPI, false )
        or reduce( PaymentObj.PIList( PRT_Credit ).AsTArray(), @bo_IsCurAddPI, false ) );
end;


private macro bo_SumPmAmount( sum:money, rec:TRecHandler ):money
  return sum + rec.rec.PmAmount;
end;

// Проверка корректности суммы разноски
private macro CheckAddPISum()

  macro ShowMenu( DebetCredit:integer ):integer
    return ConfWin( IfThenElse( DebetCredit == PRT_Debet, 
                                makeArray( "Ошибка в распределении суммы по дебету. Сохранить?"  ),
                                makeArray( "Ошибка в распределении суммы по кредиту. Сохранить?" ) ),
                    makeArray( " Да", " Нет" )
                  );
  end;

  var Payment:RsbBankOrder = RsbBankOrder( r_pmpaym.PaymentID );

  // Сторона разноски
  var DebetCredit:integer;
  if( Payment.PIList( PRT_Debet ).Size )
    DebetCredit = PRT_Debet;
  elif( Payment.PIList( PRT_Credit ).Size )
    DebetCredit = PRT_Credit;
  else
    return 0;
  end;
  
  // Подсчёт суммы разноски
  var stat:integer = 0;
  var sum :money   = reduce( Payment.PIList( DebetCredit ).AsTArray( stat ), @bo_SumPmAmount, $0 );
  if( stat )
    DisplayError();
  end;

  // Предупреждение
  if( sum != IfThenElse( DebetCredit == PRT_Debet, r_pmpaym.PayAmount, r_pmpaym.Amount ) )
    if( ShowMenu( DebetCredit ) == 1 )
      return BO_P_FLD_BaseAmount + 1;
    end;
  end;

  return 0;

end;

macro BB_BankOrderCheckDoc( mode )
  
  var PaymentObj:RsbPayment = RsbPayment(r_pmpaym.PaymentID);
  var fld:TBankOrderPanelFields = TBankOrderPanelFields();
  var retval:integer = 0;
  var Status:integer = -1, IndexStatus:integer = -1, PaymStatus:integer = -1;
  var errors:TArray = TArray();

  if ( (mode == OBJ_UPDATE) and (r_pmpaym.PrimDocOrigin == PD_OR_SF) ) /*Если оплата комиссии, менять нельзя*/
    msgbox("Документ является платой за обслуживание.\nКорректировка реквизитов запрещена.");
    return 1;
  end;

  if( (mode == OBJ_INSERT) or (mode == OBJ_UPDATE) or (mode == OBJ_INSNOTOPR) )

    if(not PM_GetOprStatus( PaymentObj.DocKind, PaymentObj.DocumentID, OPR_PAYM_STATE, @PaymStatus ))
      return 1;
    end;

    retval = BBBO_ScrolMacroCommonChecks( fld, r_pmpaym, r_debet, r_credit, r_pmrmprop );
    if(retval != NOTERROR)
      return retval;
    end;

    retval = CheckAddPISum();
    if( retval != 0 )
      return retval;
    end;

    if(r_pmpaym.Purpose == PM_PURP_CBANKORDER)
      
      if( (r_pmpaym.BaseFIID == NATCUR) and
          (r_pmpaym.FIID == NATCUR) and
          (r_pmpaym.PayFIID == NATCUR) and
          (not IsCurAddPIPayment(PaymentObj)) )
        msgbox("Валютный банковский ордер должен содержать хотя бы один счет в валюте");
        return 1;
      end;

    elif(r_pmpaym.Purpose == PM_PURP_BANKORDER)

      if( (r_pmpaym.BaseFIID != NATCUR) or
          (r_pmpaym.FIID != NATCUR) or
          (r_pmpaym.PayFIID != NATCUR) or
          IsCurAddPIPayment(PaymentObj) )
        msgbox("Рублевый банковский ордер должен содержать все счета в рублях");
        return 1;
      end;

    end;

    if((r_pmpaym.Purpose == PM_PURP_CBANKORDER) or (r_pmpaym.Purpose == PM_PURP_BANKORDER))
      
      if( not StrIsNumber(r_pmrmprop.Number) )
        MsgBox("Номер документа нечисловой");
        return 1;
      else
         if( int(r_pmrmprop.Number) == 0 )
            MsgBox("Номер документа не может быть нулевым");
            return 1;
         end;
      end; 
    end;
  
    // проверка корректности курсов платежа
    if( CheckCorrectRateTypeOnDate( r_pmpaym, errors ) and errors.Size )
      msgbox( joinErrName( errors, "|" ) );
      return 1;
    end;

  elif(mode == OBJ_AFTEREDIT) // Проверка важности изменений влияющей на необходимость смены опера документа
                               // (изменения в буферах не сохраняются)
    return IsImportantChangeBankOrder(r_pmpaym, r_pmpaym_old);
  end;
  
  if( mode == OBJ_DELETE )

    if(not isDLMRuning())
      var Ban = IfThenElse( mode == OBJ_DELETE, "Удаление запрещено.", "Корректировка реквизитов запрещена." );
      if( r_pmpaym.PrimDocOrigin == PD_OR_SF ) 
        msgbox("Документ является платой за обслуживание.|", Ban );
        return 1;
      elif( r_pmpaym.PrimDocOrigin == PD_OR_LOANS ) 
        if(not Index( "Ц", StrFor(GetIdentProgram())))
          msgbox("Документ порождён п/с \"Кредитование\".|", Ban );
          return 1;
        end;
      elif( r_pmpaym.PrimDocOrigin == PD_OR_RETAIL ) 
        if(not Index( "ВБD", StrFor(GetIdentProgram())))
          msgbox("Документ порождён п/с \"Обслуж.физ.лиц\".|", Ban );
          return 1;
        end;
      elif( (r_pmpaym.PrimDocOrigin == PD_OR_INCOUNTING) and 
          (( mode == OBJ_DELETE) or (not ПроверкаИдентичности(r_pmpaym, r_pmpaym_old, "CreationDate", "CreationTime"))) ) 
        msgbox("Документ порожден п/с \"Incounting\".|", Ban );
        return 1;
      end;
    end;

  elif( mode == OBJ_UPDATE )
    
    return StandartCheckUpdate(TCheckUpdateParam(r_pmpaym, r_debet, r_credit, r_pmrmprop), 
        TCheckUpdateParam(r_pmpaym_old, r_debet_old, r_credit_old, r_pmrmprop_old));
  end;

  return 0;

end;
