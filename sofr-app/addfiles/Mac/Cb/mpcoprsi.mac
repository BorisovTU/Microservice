/*-------------------------------------------------------------------------
          Ä¢‚Æ¨†‚®ß®‡Æ¢†≠≠†Ô °†≠™Æ¢·™†Ô ·®·‚•¨† RS-Bank v6.0.020
                 Copyright (c) R-Style Software Lab

  à¨Ô ‰†©´†        : mpcoprsi.mac

  Å®°´®Æ‚•™†       : 

  éØ®·†≠®•         : 

  è‡Æ£‡†¨¨®·‚      : Ñ„‡Ô£®≠ Ö.Ä. (DEA)

  ëÆß§†≠           : 19.05.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter,  globals, FIInter, è‡ÆÊ•≠‚Î;
    
var   
      ContractID,
      ContractBoffice,
      ContractNumber,
      ContractAccount,
      goper, 
      gCalcDateBegin, 
      gCalcDateEnd, 
      gPartyIDFil, 
      gDepName,
      gDepID,
      gTypeOfAccounts, 
      gFininstrFIID,
      gFininstrName, 
      gFininstrCode,
      gAccountMask, 
      gPartyIDClient, 
      gClientName,
      gbackoffice, 
      gNumberMin, 
      gNumberMax, 
      gGrCalc, 
      gGrCalcName,
      gGrCalcNumber,
      gCalcID, 
      gCalcName,
      gCalcNumber,
      gRateID, 
      gRateName,
      gRateNumber,
      gUserType, 
      gBeginDateMin, 
      gBeginDateMax,
      flagFirstRow;

RECORD contract( prccontract );

/* ------------------------------- */

private macro PrintHead()
   [           ###############################################]({Name_Bank});
   [           ###############################################]({OperDprt}:l);
   [      ];
   [                      í†°´®Ê† •¶•§≠•¢≠Æ£Æ ‡†·Á•‚† Ø‡ÆÊ•≠‚Æ¢ ];
   [   ];
   [  Ñ†‚† ≠†Á†´† ‡†·Á•‚†:    ##########](Date(gCalcDateBegin):c);
   [  Ñ†‚† Æ™Æ≠Á†≠®Ô ‡†·Á•‚†: ##########](Date(gCalcDateEnd):c);
   [  è‡ÆÊ•≠‚≠Î© §Æ£Æ¢Æ‡:     #### ####](ContractBoffice,ContractNumber);
   [  ã®Ê•¢Æ© ·Á•‚:           ####################](ContractAccount);
   [   ];
   [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
   [≥ ç†Á†´Ï≠†Ô §†‚† ≥ äÆ≠•Á≠†Ô §†‚† ≥ ó®·´Æ §≠•© ≥    é·‚†‚Æ™      ≥ ë‚†¢™† ¢ £Æ§ ≥ ë„¨¨† Ø‡ÆÊ•≠‚Æ¢ ≥];
end;

private macro PrintBottom(Days,TotalSum)
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   [≥ à‚Æ£ ØÆ ‡†·Á•‚„                                                                                ≥];
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   [≥################≥###############≥############≥                                 #################≥]
   (Date(gCalcDateBegin):c, Date(gCalcDateEnd):c, Days, TotalSum); 
   [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
   [   ];
   [  éØ•‡†Ê®Æ≠®·‚:     #### #########]({oper}, {Name_Oper});
end;

private macro PrintLine(rs, Sum)
   if (flagFirstRow)
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   else
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];   
   end;
   [≥################≥###############≥############≥#################≥##############≥#################≥]
   (Date(rs.STARTDATE):c, Date(rs.ENDDATE):c, rs.DAYSNUM, money(rs.Rest), rs.Rate, Sum); 
end;   

private macro PrintSubItog(TotalSumR,i,BegDate,EndDate)
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   [≥ è‡Æ¨•¶„‚ÆÁ≠Î© ®‚Æ£ ØÆ £‡†‰®™„ ‡†·Á•‚†                                                          ≥];
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   [≥################≥###############≥############≥                                 #################≥]
   (Date(BegDate):c, Date(EndDate):c, i, TotalSumR); 
   
end;


private macro CalcOnePeriod(RS,Days:@integer, Itog:@money)

   var DDate, BegDate, EndDate,
       cmd,cmd2,rs2,
       sum,
       i = 0,
       DaySum = $0,
       TotalSum = $0,
       TotalSumR = $0,
       ISum = $0,
       stat = 0;

   stat = 0;
   DDate = RS.Date;
   BegDate = date(RS.PeriodBeginDate);
   EndDate = date(RS.PeriodEndDate);

   if (EndDate > gCalcDateEnd)
      EndDate = gCalcDateEnd;
   end;
   
   //≠®Á•£Æ ≠• ≠†Ë´®
   if (DDate == date (0,0,0))
      stat = 1;
   end;

   if (stat == 0)

      Prc_CalcPrcValues(ContractID, BegDate, EndDate, @Sum, 1);

      cmd2 = RSDCommand( "select T_STARTDATE,T_ENDDATE,T_DAYSNUM,T_REST,T_RATE,T_SUM from DPRCCALCPRCVAL_TMP" );
      cmd2.execute();

      rs2 = TRsbDataSet(cmd2);
      
      while( rs2.movenext() )
         ISum = rs2.Sum;
         
         TotalSum = TotalSum + ISum;
         DaySum = TotalSum - TotalSumR;
         DaySum = round(DaySum,2);
         TotalSumR = TotalSumR + DaySum;
         PrintLine(rs2,DaySum);
         flagFirstRow = false;
         i = i + 1;
      end;
      
      PrintSubItog(TotalSumR,i,BegDate,EndDate);
      flagFirstRow = true;
      Itog = TotalSumR;
      Days = i;
   end;

END;  

private macro PumpDepName()
   var cmd, RS;
   if (gPartyIDFil == -1)
      gDepName = "èÆ ¢·•¨ ‰®´®†´†¨";     
   else
      cmd = RSDCommand( " select t_shortname from dparty_dbt where t_PartyID =  ? " ) ; 
      cmd.addParam( "", RSDBP_IN, gPartyIDFil);
      cmd.execute();
      RS = TRsbDataSet(cmd);
      if (RS.movenext() )
         gDepName = Rs.shortname;
      end;
   end;
end;

private macro PumpDepID()
   var cmd, RS;
   if (gPartyIDFil >= 0)           
      cmd = RSDCommand( "select t_code from ddp_dep_dbt where t_PartyID =  ? " ) ; 
      cmd.addParam( "", RSDBP_IN, gPartyIDFil);
      cmd.execute();
      
      RS = TRsbDataSet(cmd);
      if (RS.movenext() )
         gDepID = Rs.code;
      else
         gDepID = 0;
      end;
      
   else
      gDepID = 0;
   end;
end;

private macro PumpClientName()
   var cmd, RS;
   gClientName = "";

   cmd = RSDCommand( " select t_shortname from dparty_dbt where t_PartyID =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gPartyIDClient);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gClientName = Rs.shortname;
   end;
end;

private macro PumpNames()
   var fininstr,  cmd, RS;
   PumpDepName();
   PumpClientName();
   fininstr = TRecHandler("fininstr.dbt");
   if (èÆ´„Á®‚Ïî®≠à≠( gFininstrFIID, fininstr ) == 0)
    gFininstrName = fininstr.rec.Name; 
    gFininstrCode = fininstr.rec.FI_Code;
   end;
/*   if (strlen (gTypeOfAccounts) < 2)  
  gTypeOfAccounts = "Ç·• ¢®§Î";
   end;*/
   cmd = RSDCommand( " select t_number, t_shortname from dprcgrcalc_dbt where t_groupcalcid =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gGrCalc);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gGrCalcName = Rs.shortname;
      gGrCalcNumber = Rs.number;
   else
      gGrCalcName = "";
      gGrCalcNumber = 0;
   end;

   cmd = RSDCommand( " select t_number, t_shortname from dprccalc_dbt where t_calcid =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gCalcID);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gCalcName = Rs.shortname;
      gCalcNumber = Rs.number;
   else
      gCalcName = "";
      gCalcNumber = 0 ;
   end;

   cmd = RSDCommand( " select t_number, t_shortname from dprcrate_dbt where t_rateid =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gRateID);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gRateName = Rs.shortname;
      gRateNumber = Rs.number;
   else
      gRateName = "";
      gRateNumber = 0;

   end;
   
end;

private macro PrintMainHead()

   [   è‡Æ‚Æ™Æ´ ¢ÎØÆ´≠•≠®Ô Ø‡ÆÊ•§„‡Î •¶•§≠•¢≠Æ£Æ ‡†·Á•‚† Ø‡ÆÊ•≠‚Æ¢ ];
   [ Ñ†‚† ÆØ•‡†Ê®®:    ##########](Date({curdate}):c);
   [ éØ•‡†Ê®Æ≠®·‚:    #### #########]({oper}, {Name_Oper});
   [ Ñ†‚† ≠†Á†´† ‡†·Á•‚†:    ##########   Ñ†‚† Æ™Æ≠Á†≠®Ô ‡†·Á•‚†: ##########](Date(gCalcDateBegin):c, Date(gCalcDateEnd):c);
   [ î®´®†´:           ###################################### ](gDepName);   
 
   [ Ç®§ ·Á•‚Æ¢:       ##################](gTypeOfAccounts);
   [ äÆ§ ¢†´Ó‚Î:       #### ############################ ](gFininstrCode, gFininstrName);
   [ å†·™† ´®Ê•¢ÎÂ ·Á•‚Æ¢: ####################### ](gAccountMask);
   [ ä´®•≠‚:           ###################################### ](gClientName);
   [ ÅÌ™-Æ‰®·:         ############] (gbackoffice);
   [ çÆ¨•‡ §Æ£Æ¢Æ‡†:      c   ######  ØÆ ######  ](gNumberMin, gNumberMax);
   [ É‡„ØØ† „·´Æ¢®© ‡†·Á•‚†:  ######  ###################### ] (gGrCalcNumber, gGrCalcName);
   [ ì·´Æ¢®• ‡†·Á•‚†:         ######  ###################### ] (gCalcNumber, gCalcName);
   [ è‡ÆÊ•≠‚≠†Ô ·‚†¢™†:       ######  ###################### ] (gRateNumber, gRateName);
   [ èÆ´ÏßÆ¢†‚•´Ï·™®© ‚®Ø:    #######################](gUserType);
   if (gBeginDateMin == NULL)
  [ Ñ†‚† ≠†Á†´† §Æ£Æ¢Æ‡†:    Æ‚ 00.00.0000  §Æ: ##########](Date(gBeginDateMax):c);
   else
       [ Ñ†‚† ≠†Á†´† §Æ£Æ¢Æ‡†:    Æ‚ ##########   §Æ: ##########](Date(gBeginDateMin):c, Date(gBeginDateMax):c);
   end;
   [---------------------------------------------------------------------------------------------------------];
end;                         

private macro CalcDailyAndShowRep(ContrID) 

   var  RS, cmd, cmd2, cmd3, cmd4, cmd5, 
        iSum = $0,
        iDays = 0,
        TotalSum = $0,
        TotalDays = 0,
        RateID = 0,
   FactSum = $0,
   Summa = $0;

   cmd = RSDCommand( "select t_backoffice, t_number, t_account, t_rateid from  dprccontract_dbt where t_contractid = ? ") ;
   cmd.addParam( "", RSDBP_IN, ContrID );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext())
   
    ContractID = ContrID;
    ContractBoffice = RS.BackOffice;
    ContractNumber = RS.Number; 
    ContractAccount = RS.Account;
      RateID = RS.RateID;

    flagFirstRow = false;  
    PrintHead();
  
    cmd = RSDCommand( "select T_DATE, T_PERIODBEGINDATE, T_PERIODENDDATE from DPRCCNTSCHED_DBT " +
                      "where T_CONTRACTID = ? and T_SCHEDULEKIND = 1 and T_PERIODENDDATE >= ? " +
                      "and T_PERIODBEGINDATE <= ? " +
                      "order by T_DATE" );
    cmd.addParam( "", RSDBP_IN, ContractID );
    cmd.addParam( "", RSDBP_IN, gCalcDateBegin );
    cmd.addParam( "", RSDBP_IN, gCalcDateEnd );
    cmd.execute();
  
    RS = TRsbDataSet(cmd);
    while( RS.movenext() )                       
          CalcOnePeriod(RS, @iDays, @iSum);
          TotalSum = TotalSum + iSum;
          TotalDays = TotalDays + iDays;
    end;
    PrintBottom(TotalDays,TotalSum);
   end;
end;

private macro ShowReportForFilial() 
   var count = 0, RS, cmd;
   cmd = RSDCommand ("select t_contractid from dprcsrvacc_tmp where t_contractid is not NULL and t_contractid > 0 and t_department =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gDepID);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   while( RS.movenext())
      CalcDailyAndShowRep(RS.contractid);
      count = count + 1;
   end;
   if (count == 0)
      [ ç•‚ Ø‡ÆÊ•≠‚ÎÂ §Æ£Æ¢Æ‡Æ¢, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â „·´Æ¢®Ô¨ ß†Ø„·™† ];
      [ ];
   end;
end;



/*****************************************************************************
                    é°È®• ‰-® §´Ô Ø•Á†‚® Æ‚Á•‚† ·•‡¢. ÆØ•‡†Ê®® 
******************************************************************************/

macro MpcDailyCalcOperReportSilent(oper, CalcDateBegin, CalcDateEnd, PartyIDFil, TypeOfAccounts, FininstrFIID, AccountMask, PartyIDClient, backoffice, NumberMin, NumberMax, GrCalc, CalcID, RateID, UserType, BeginDateMin, BeginDateMax)

   var  Data, RS, cmd,
        §Æ´¶≠Æ·‚Ïà·Ø,
        iSum = $0,
        iDays = 0,
        TotalSum = $0,
        TotalDays = 0;

    goper = oper; 
    gCalcDateBegin = CalcDateBegin; 
    gCalcDateEnd = CalcDateEnd; 
  gPartyIDFil = PartyIDFil; 
  gTypeOfAccounts = TypeOfAccounts; 
  gFininstrFIID = FininstrFIID; 
  gAccountMask = AccountMask; 
  gPartyIDClient = PartyIDClient; 
  gbackoffice = backoffice; 
  gNumberMin = NumberMin; 
  gNumberMax = NumberMax; 
  gGrCalc = GrCalc; 
  gCalcID = CalcID; 
  gRateID = RateID; 
  gUserType = UserType; 
  gBeginDateMin = BeginDateMin; 
  gBeginDateMax = BeginDateMax;
  PumpNames();
    PrintMainHead();

       if (gPartyIDFil > 0)
          PumpDepID();
          ShowReportForFilial();
       else
          cmd = RSDCommand ("select distinct t_department from dprcsrvacc_tmp where t_department is not NULL and t_department > 0 ");
          cmd.execute();
          RS = TRsbDataSet(cmd);
          while( RS.movenext())
             gPartyIDFil = RS.department;
             PumpDepID();
             PumpDepName();
             [ ];
             [ î®´®†´:           ###################################### ](gDepName);         
             [ ];
             ShowReportForFilial();
          end;
       end;

end;
END;

