/*
$Name:        ws_bankproduct.mac
$Module:      Главная книга
$Description: Макрос банковских продуктов для ЕО
*/

import RSD, cb_sql;
import "globals.mac";
import  "ws_validation.mac";
import "ws_partycommon.mac";
import BankInter, PTInter, FMInter;
import CTInter;
import Календарь;

class TWsClntPrdElem
  var Role            : integer;
  var RoleName        : string;
  var ProductKindID   : integer;
  var ProductKindName : string;
  var ProductID       : integer;
  var ProductName     : string;
  var IsClientObj;
  var IsGeneral;
  var ClientLevel     : integer;
  var RecID           : integer;
  var ParentRecID     : integer;
  var Name            : string;
  var Number          : string;
  var BeginDate       : date;
  var EndDate         : date;
  var ObjectType      : integer;
  var ObjectID        : string;
  var IsDraft         : bool;
  var IsClosed        : bool;
  var Childs;
end;

class TWsClientProduct
  var ProductKindName     : string;
  var ProductName         : string;
  var ProductDocKindName  : string;
  var DocNumber           : string;
  var DocDate             : date;
  var BeginDate           : date;
  var EndDate             : date;
  var DprtName            : string;
  var DprtPartyName       : string;
  var ClientProductID     : integer;
  var PartyID             : integer;
  var ObjectType          : integer;
  var ObjectID            : string;
  var IsDraft             : bool;
  var IsClosed            : bool;
  var ProductOwnerName    : string;
end;

class TWsClntProdObj
  var ObjName             : string;
  var KindObjName         : string;
  var ObjectNumber        : string;
  var BeginDate           : date;
  var EndDate             : date;
  var ClntProdObjID       : integer;
  var ClientProductID     : integer;
  var ObjectType          : integer;
  var ObjectID            : string;
  var IsDraft             : bool;
end;

class TWsSearchClientRequest
  var PartyID;
  var LastName = "";
  var FirstName = "";
  var Patronymic = "";
  var BirthDate;
  var DeathDate;
  var INN = "";
  var PaprKind;
  var PIDSeries = "";
  var PIDNumber = "";
  var PIDIssuer = "";
  var PIDIssuedDate;
  var Objects;
  var ObjectNumber = "";
  var PartyIDs;
  var HasStoppedFMOpr = false;
  var Cat115FZAttrName = "";
  var FotoSignUse = false;
  var Country;
  var Adress;
  var BankruptStatus;
  var BankruptStatusMessage;
  var IsAttentionOperations = false;
end;

class TWsProd
  var ProductID;
  var ProductName;
  var OpenDate;
  var CloseDate;
  var ProductKindName;
  var ProductDocKindName;
end;

class TWebYurClientSearchIdentData
  var PartyID;
  var SearchName;
  var FullName;
  var ShortName;
  var Objects;
  var ObjectNumber;
  var CodeKind;
  var CodeValue;
  var INN;
  var HasStoppedFMOpr;
  var ClientProxy;
  var FirstPerson;
  var Officer;
  var PartyIDs;
  var RegDocCodeKind;
  var RegDocCodeValue;
end;

class TWebClientProxy
  var IdentPersn;
  var Paper;
end;

class TWebClientPaper
  var PaprKind;
  var PIDSeries;
  var PIDNumber;
  var PIDSeries_Number;
end;

class TWebIdentPersn
  var PersonID;
  var LegalForm;
  var LastName;
  var FirstName;
  var Patronymic;
end;

class TWebClientOfficer
  var IdentPersn;
  var Post;
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro _IsProductOwnerDead(ClientProductID)
  var rs, cmd, query;
  var retVal = false;

  query = "SELECT 1 " +
          "  FROM dpersn_dbt " +
          " WHERE t_Death <> TO_DATE ('01.01.0001', 'DD.MM.YYYY') " +
          "   AND t_PersonID IN (SELECT t_PartyID " +
          "                        FROM dprdclntrole_dbt " +
          "                       WHERE t_ClientProductID = ? AND t_Role = 1)";

  cmd = RsdCommand(query);
  cmd.addParam("", RSDBP_IN, ClientProductID);

  rs = RsdRecordset( cmd );
  if(rs.moveNext())
    retVal = true;
  end;

  return retVal;
end;

macro GetClientProductsTree( ClientID,
                             BankDate,
                             Branch,
                             ProductKindID )

  var i = 0;

  var p1, p2, p3, p4, p5;

  var sRole            = 0;
  var sProductKindID   = 0;
  var sProductID       = 0;
  var sClientProductID = 0;

  var Arr = TArray;

  var query_ProductKind_1 = "";
  var query_ProductKind_2 = "";
  
  var Type_ProductKindID = ValType(ProductKindID);
  
  if(Type_ProductKindID != V_UNDEF)
  
    if((Type_ProductKindID == V_INTEGER) AND (ProductKindID != 0))
    
      query_ProductKind_1 = " AND PP.T_PRODUCTKINDID = " + ProductKindID;
      query_ProductKind_2 = " AND pco.T_PRODUCTKINDID = " + ProductKindID;
    
    end;
    
    if(Type_ProductKindID == V_GENOBJ)
    
      i = 0;

      var str = "";

      while(i < ProductKindID.size)

        if( i != ProductKindID.size - 1)

          str = str + ProductKindID[i] + ", ";

        else

          str = str + ProductKindID[i];

        end;

        i = i + 1;

      end;

      if(ProductKindID.size != 0)

        query_ProductKind_1 = " AND PP.T_PRODUCTKINDID IN ( " + str + " ) ";
        query_ProductKind_2 = " AND pco.T_PRODUCTKINDID IN ( " + str + " ) ";

      end;

    end;
  
  end;

  var query = "   SELECT * " +
              "     FROM (SELECT pcr.t_role role, " +
              "                  (SELECT LL.T_NAME " +
              "                     FROM dllvalues_dbt ll " +
              "                    WHERE PCR.T_ROLE = LL.T_ELEMENT AND ll.t_list = 1034) " +
              "                     rolename, " +
              "                  PP.T_PRODUCTKINDID PRODUCTKINDID, " +
              "                  (SELECT pk.T_NAME " +
              "                     FROM DPRDKIND_DBT pk, dprdproduct_dbt pp " +
              "                    WHERE     pk.T_PRODUCTKINDID = PP.T_PRODUCTKINDID " +
              "                          AND PC.T_PRODUCTID = PP.T_PRODUCTID) " +
              "                     Productkindname, " +
              "                  PP.T_PRODUCTID PRODUCTID, " +
              "                  PP.T_NAME PRODUCTNAME, " +
              "                  '' IsClientObj, " +
              "                  '' IsGeneral, " +
              "                  PC.T_CLIENTPRODUCTID CLIENTPRODUCTID, " +
              "                  PC.T_CLIENTPRODUCTID CLNTPRODOBJID, " +
              "                  PC.T_PARENTCLIENTPRODUCTID ParentRecID, " +
              "                  (SELECT LL.T_NAME " +
              "                     FROM DPRDPRODUCT_DBT prdp, dllvalues_dbt ll " +
              "                    WHERE     PRDP.T_PRODUCTID = PP.T_PRODUCTID " +
              "                          AND ll.t_list = 1050 " +
              "                          AND LL.T_ELEMENT = PRDP.T_PRODUCTDOCKINDID) " +
              "                     name, " +
              "                  PC.T_DOCNUMBER doNUMBER, " +
              "                  PC.T_BEGINDATE, " +
              "                  PC.T_ENDDATE, " +
              "                  PC.T_OBJECTTYPE, " +
              "                  PC.T_OBJECTID, " +
              "                  PC.T_ISDRAFT ISDRAFT," +
              "                  PC.T_ISCLOSED ISCLOSED" +
              "             FROM DPRDCLNTROLE_DBT pcr, dprdproduct_dbt pp, DPRDCLIENT_DBT pc " +
              "            WHERE     pcr.T_PARTYID = ? " +
              "                  AND pcr.T_CLIENTPRODUCTID > 0 " +
              "                  AND pp.t_ProductID = pc.t_ProductID " +
              "                  AND pc.T_ClientProductID = PCR.T_CLIENTPRODUCTID " +
                                 query_ProductKind_1 +
              "           UNION ALL " +
              "           SELECT pcr.t_role role, " +
              "                  (SELECT LL.T_NAME " +
              "                     FROM dllvalues_dbt ll " +
              "                    WHERE PCR.T_ROLE = LL.T_ELEMENT AND ll.t_list = 1034) " +
              "                     rolename, " +
              "                  pco.T_PRODUCTKINDID PRODUCTKINDID, " +
              "                  (SELECT pk.T_NAME " +
              "                     FROM DPRDKIND_DBT pk " +
              "                    WHERE pk.T_PRODUCTKINDID = pco.T_PRODUCTKINDID) " +
              "                     Productkindname, " +
              "                  (SELECT PC.T_PRODUCTID " +
              "                     FROM DPRDCLIENT_DBT pc " +
              "                    WHERE PC.T_CLIENTPRODUCTID = PCO.T_CLIENTPRODUCTID) " +
              "                     PRODUCTID, " +
              "                  (SELECT PP.T_NAME " +
              "                     FROM DPRDCLIENT_DBT pc, dprdproduct_dbt pp " +
              "                    WHERE     PC.T_CLIENTPRODUCTID = PCO.T_CLIENTPRODUCTID " +
              "                          AND PC.T_PRODUCTID = PP.T_PRODUCTID) " +
              "                     PRODUCTNAME, " +
              "                  'X' IsClientObj, " +
              "                  PCO.T_ISGENERAL IsGeneral, " +
              "                  PCO.T_CLIENTPRODUCTID CLIENTPRODUCTID, " +
              "                  PCO.T_CLNTPRODOBJID CLNTPRODOBJID, " +
              "                  PCO.T_PARENTID ParentRecID, " +
              "                  (SELECT PKO.T_NAME " +
              "                     FROM DPRDKIND_OBJ_DBT pko " +
              "                    WHERE     PKO.T_PRODUCTKINDID = PCO.T_PRODUCTKINDID " +
              "                          AND PKO.T_OBJECTPRODUCTKINDID = " +
              "                                 PCO.T_OBJECTPRODUCTKINDID) " +
              "                     name, " +
              "                  PCO.T_OBJECTNUMBER doNUMBER, " +
              "                  PCO.T_BEGINDATE, " +
              "                  PCO.T_ENDDATE, " +
              "                  PCO.T_OBJECTTYPE, " +
              "                  PCO.T_OBJECTID, " +
              "                  PCO.T_ISDRAFT," +
              "                  NULL ISCLOSED" +
              "             FROM DPRDCLNTROLE_DBT pcr, DPRDCLIENTOBJ_DBT pco " +
              "            WHERE     pcr.T_PARTYID = ? " +
              "                  AND pcr.T_CLIENTPRODUCTID > 0 " +
              "                  AND pco.T_ClientProductID = PCR.T_CLIENTPRODUCTID " +
                                 query_ProductKind_2 +
              "                  AND pcr.T_CLNTPRODOBJID = 0 " +
              "                  AND pco.T_ISGENERAL = 'X' ) t " +
              " ORDER BY t.ROLE ASC, " +
              "          t.PRODUCTKINDID ASC, " +
              "          t.PRODUCTID ASC, " +
              "          t.CLIENTPRODUCTID ASC, " +
              "          t.ISCLIENTOBJ DESC ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, ClientID );
  cmd.addParam( "", RSDBP_IN, ClientID );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );
  var admitRole, isOwnerDead;

  i = 0;

  while(ds.movenext)

    /* Продукты, в которых идентифицированный клиент выступает в качестве наследника, 
     * должны отображаться в его дереве продуктов только начиная с того момента, как 
     * будет зафиксирована дата смерти владельца такого продукта (обуславливается 
     * необходимостью соблюдения тайны завещания).
     * При этом после смерти владельца эти продукты должны исчезать (не показываться) 
     * из деревьев всех клиентов, кроме наследников, так как после смерти владельца 
     * по вкладу/счету возможна только выдача наследства и разовые выплаты на достойные 
     * похороны, а доверенности при этом фактически прекращает свое действие.
     */
    admitRole = true;
    if(ds.role != 1)
      isOwnerDead = _IsProductOwnerDead(ds.clientproductid);
      if(isOwnerDead and (ds.role != 3))
        admitRole = false;
      elif((not isOwnerDead) and (ds.role == 3))
        admitRole = false;
      end;
    end;    
    
    if(admitRole)
      if( ((i == 0) OR (sRole != ds.role)) AND (ds.isgeneral != "X") )
      
        p1 = TWsClntPrdElem();
      
        // 1
        p1.Role            = ds.role;
        p1.RoleName        = ds.rolename;
        p1.Childs          = TArray;
      
        // встретилась новая роль
        sProductKindID   = 0;
        sProductID       = 0;
        sClientProductID = 0;
      
        Arr[Arr.size] = p1;
      
      end;
      
      if( ((i == 0) OR (sProductKindID != ds.productkindid)) AND (ds.isgeneral != "X") )
      
        p2 = TWsClntPrdElem();
      
        // 2
        p2.ProductKindID   = ds.productkindid;
        p2.ProductKindName = ds.Productkindname;
        p2.Childs          = TArray;
      
        p1.Childs[p1.Childs.size] = p2;
      
      end;
      
      if( ((i == 0) OR (sProductID != ds.productid)) AND (ds.isgeneral != "X") )
      
        p3 = TWsClntPrdElem();
      
        // 3
        p3.ProductID       = ds.productid;
        p3.ProductName     = ds.productname;
        p3.Childs          = TArray;
      
        p2.Childs[p2.Childs.size] = p3;
      
      end;
      
      if( ((i == 0) OR (sClientProductID != ds.clientproductid )) AND (ds.isgeneral != "X") )
      
        p4 = TWsClntPrdElem();
      
        // 4
        p4.IsClientObj     = ds.isclientobj;
        p4.ClientLevel     = 1;
      
        if(ds.isclientobj == "X")
          p4.RecID         = ds.clientproductid;
        else
          p4.RecID         = -ds.clientproductid;
        end;
      
        if(ds.isclientobj == "X")
      
          if(ds.parentrecid == 0)
            p4.ParentRecID = -ds.clientproductid;
          else
            p4.ParentRecID = ds.parentrecid;
          end;
      
        else
          p4.ParentRecID   = -ds.parentrecid;
          p4.IsDraft       = ds.IsDraft;
          p4.IsClosed      = false;
          if (ds.IsClosed == "X") p4.IsClosed = true; end;
        end;
      
        p4.Name            = ds.name;
        p4.Number          = ds.donumber;
        p4.BeginDate       = ds.begindate;
        p4.EndDate         = ds.enddate;
        p4.ObjectType      = ds.objecttype;
        p4.ObjectID        = ds.objectid;
        p4.Childs          = TArray;
      
        p3.Childs[p3.Childs.size] = p4;
      
      end;
      
      if( ( sClientProductID == ds.clientproductid ) AND ( ds.isgeneral == "X" ) )
      
        p5 = TWsClntPrdElem();
      
        // 5
        p5.IsClientObj     = ds.isclientobj;
        p5.IsGeneral       = ds.isgeneral;
        p5.ClientLevel     = 2;
      
        if(ds.isclientobj == "X")
          p5.RecID         = ds.clntprodobjid;
        else
          p5.RecID         = -ds.clntprodobjid;
        end;
      
        if(ds.isclientobj == "X")
      
          if(ds.parentrecid == 0)
            p5.ParentRecID = -ds.clientproductid;
          else
            p5.ParentRecID = ds.parentrecid;
          end;
      
        else
          p5.ParentRecID   = -ds.parentrecid;
          p5.IsDraft       = ds.IsDraft;
          p5.IsClosed      = false;
          if (ds.IsClosed == "X") p5.IsClosed = true; end;
        end;
      
        p5.Name            = ds.name;
        p5.Number          = ds.donumber;
        p5.BeginDate       = ds.begindate;
        p5.EndDate         = ds.enddate;
        p5.ObjectType      = ds.objecttype;
        p5.ObjectID        = ds.objectid;
      
        p4.Childs[p4.Childs.size] = p5;
      
      end;
      
      i = i + 1;
      
      sRole            = ds.role;
      sProductKindID   = ds.productkindid;
      sProductID       = ds.productid;
      sClientProductID = ds.clientproductid;

    end;
  end;

  return Arr;

end;

macro GetClientProduct(ClientProductID)

  var p;

  var query = " SELECT pc.T_CLIENTPRODUCTID ClientProductID, "
              "        PC.T_DOCNUMBER DocNumber, "
              "        PC.T_DOCDATE DocDate, "
              "        PC.T_BEGINDATE BeginDate, "
              "        PC.T_ENDDATE EndDate, "
              "        PC.T_PARTYID PartyID, "
              "        PC.T_OBJECTTYPE ObjectType, "
              "        PC.T_OBJECTID ObjectID, "
              "        PC.T_ISDRAFT IsDraft, "
              "        PC.T_ISCLOSED IsClosed, "
              "        PP.T_NAME ProductName, "
              "        PK.T_NAME ProductKindName, "
              "        LL.T_NAME ProductDocKindName, "
              "        DP.T_NAME DprtName, "
              "        PT.T_NAME DprtPartyName, "
              "        PO.T_NAME OwnerPartyName "
              "   FROM dprdclient_dbt pc, dprdproduct_dbt pp, dprdkind_dbt pk, dllvalues_dbt ll, ddp_dep_dbt dp, dparty_dbt pt, dprdclntrole_dbt pr, dparty_dbt po, dprdclntroleuse_dbt pu "
              "  WHERE     PC.T_CLIENTPRODUCTID = ? "
              "        AND PC.T_PRODUCTID = PP.T_PRODUCTID "
              "        AND PP.T_PRODUCTKINDID = PK.T_PRODUCTKINDID "
              "        and LL.T_LIST = 1050 "
              "        and LL.T_ELEMENT = PP.T_PRODUCTDOCKINDID "
              "        and PC.T_BRANCH = DP.T_CODE "
              "        and DP.T_PARTYID = PT.T_PARTYID "
              "        and PR.T_CLIENTPRODUCTID = PC.T_CLIENTPRODUCTID "
              "        and PU.T_OWNER in (1,2) "
              "        and PR.T_ROLE = PU.T_ROLE "
              "        and PO.T_PARTYID = PR.T_PARTYID "
              "   order by decode(pu.t_use,0,1,0), PU.T_OWNER desc, PU.T_ROLE";
              /* роль владельца берем из dprdclntroleuse_dbt. При этом запись с t_use=0 смотрим в последнюю очередь, 
                 для записей с t_use!=0 впервую очередь смотрим T_OWNER=2, затем T_OWNER=1, а в рамках этой сортировки сортируем впорядке возрастания T_ROLE
                 Если такого исправления будет недостаточно (будет выбираться информация не о том клиенте-владельце), то передать в функцию t_use и 
                 добавить условие: "and PU.T_USE in (0,?)", заменив вопрос переданным значением t_use.
              */

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, ClientProductID );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  if(ds.movenext)

    p = TWsClientProduct();

    p.ProductKindName     = ds.ProductKindName;
    p.ProductName         = ds.ProductName;
    p.ProductDocKindName  = ds.ProductDocKindName;
    p.DocNumber           = ds.DocNumber;
    p.DocDate             = ds.DocDate;
    p.BeginDate           = ds.BeginDate;
    p.EndDate             = ds.EndDate;
    p.DprtName            = ds.DprtName;
    p.DprtPartyName       = ds.DprtPartyName;
    p.ClientProductID     = ds.ClientProductID;
    p.PartyID             = ds.PartyID;
    p.ObjectType          = ds.ObjectType;
    p.ObjectID            = ds.ObjectID;
    p.IsDraft             = ds.IsDraft;
    p.IsClosed            = false;
    if (ds.IsClosed == "X") p.IsClosed = true; end;
    p.ProductOwnerName    = ds.OwnerPartyName
  end;

  return p;

end;

macro GetClntProdObj(ClntProdObjID)

  var p;

  var query = "  SELECT PCO.T_CLNTPRODOBJID ClntProdObjID, "
              "        PCO.T_OBJECTNUMBER ObjectNumber, "
              "        PCO.T_BEGINDATE BeginDate, "
              "        PCO.T_ENDDATE EndDate, "
              "        PCO.T_CLIENTPRODUCTID ClientProductID, "
              "        PCO.T_OBJECTTYPE ObjectType, "
              "        PCO.T_OBJECTID ObjectID, "
              "        PKO.T_NAME KindObjName, "
              "        OB.T_NAME ObjName, "
     "        PCO.T_ISDRAFT IsDraft "
              "   FROM dprdclientobj_dbt pco, dprdkind_obj_dbt pko, dobjects_dbt ob "
              "  WHERE     PCO.T_CLNTPRODOBJID = ? "
              "        AND PCO.T_OBJECTPRODUCTKINDID = PKO.T_OBJECTPRODUCTKINDID "
              "        AND PCO.T_PRODUCTKINDID = PKO.T_PRODUCTKINDID "
              "        AND PCO.T_OBJECTTYPE = OB.T_OBJECTTYPE ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, ClntProdObjID );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  if(ds.movenext)

    p = TWsClntProdObj();

    p.ObjName         = ds.ObjName;
    p.KindObjName     = ds.KindObjName;
    p.ObjectNumber    = ds.ObjectNumber;
    p.BeginDate       = ds.BeginDate;
    p.EndDate         = ds.EndDate;
    p.ClntProdObjID   = ds.ClntProdObjID;
    p.ClientProductID = ds.ClientProductID;
    p.ObjectType      = ds.ObjectType;
    p.ObjectID        = ds.ObjectID;
 p.IsDraft         = ds.IsDraft;

  end;

  return p;

end;

macro GetObjectsList(ObjectTypes)

  PT_PrintDebug( "ws_bankproduct.mac.log", "*** GetObjectsList ***");

  var Rec = TRecHandler("objects");
  var Arr = TArray;

  if((ObjectTypes != null) AND (ObjectTypes.size != 0))

    var i = 0;

    var str = "";

    while(i < ObjectTypes.size)

      if( i != ObjectTypes.size - 1)

        str = str + ObjectTypes[i] + ", ";

      else

        str = str + ObjectTypes[i];

      end;

      i = i + 1;

    end;

    PT_PrintDebug( "ws_bankproduct.mac.log", "str - " + str);

  end;

  var query = " select * from dobjects_dbt ";

  if(ObjectTypes != null)

    if(ObjectTypes.size != 0)

      query = query + " where t_objecttype in ( " + str + " ) ";

    end;

  end;

  PT_PrintDebug( "ws_bankproduct.mac.log", "query - " + query);

  var cmd = RSDCommand(query);

  cmd.NullConversion = true;

  cmd.Execute();

  var rs = RsdRecordset( cmd );

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objects");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

private macro ClientHasFMOperation(ClientID)
  var RetValue = false;
  var rs, cmd;
  var StrQuery;

  StrQuery = "SELECT count(1) cnt FROM dopcontr_dbt op, dopcntrpt_dbt opt, dobjatcor_dbt oac, dobjattr_dbt attr " +
             " WHERE opt.t_ClientID = ? " +
             "   AND op.t_OperationID = opt.t_OperationID " +
             "   AND op.t_Type = 1 " +                                   // FM_IMP_OPER_TYPE_LEGAL
             "   AND op.t_Terror = 1 " +                                 // OPCONTR_TERROR_OPR_STOPED
             "   AND (op.t_Status IN (6, 1, 2, 3, 4 ) " +                // $(<Приостановлена>), $(<На контроль> ), $(<Проконтролирована>), $(<Завизирована>), $(<Отложена>),
             "          OR  (op.t_Status = 5 AND op.t_Date >= ?)) "+     //  $(<Выгружена>)
             "   AND oac.t_Object = LPAD(op.t_OperationID, 10, '0')  " +
             "   AND oac.t_ObjectType = 700 " +                          // OBJTYPE_OPCONTR
             "   AND oac.t_GroupID = 1 " +
             "   AND attr.t_ObjectType = oac.t_ObjectType " +
             "   AND attr.t_AttrID = oac.t_AttrID " +
             "   AND attr.t_Name = '7001' ";

  var AnswerDate = {curdate};

  AnswerDate = GetDateAfterWorkDays(AnswerDate, -5);

  cmd = RsdCommand( StrQuery );
  cmd.addParam( "", RSDBP_IN, ClientID );
  cmd.addParam( "", RSDBP_IN, AnswerDate );

  rs = RsdRecordset( cmd );
  if( rs.moveNext() )
    var count = rs.value("cnt");
    if(count > 0)
      RetValue = true;
    end;
  end;

  return RetValue;
end;


private macro GetPartyMainAttr_PartyType(PartyID : integer) : integer
  var AttrID : integer = 0;

  record party(party);
  party.PartyID = PartyID;

  var Error : integer = 0;
  GetMainObjAttr(Error, OBJTYPE_PARTY, party, PARTY_ATTR_GROUP_PTTYPE, AttrID);
  if(Error)
    AttrID = 0;
  end;

  return AttrID;
end;


private macro GetCat115FZAttrName(ClientID)
	
	return PtCertainCategoryWarning(ClientID);

end;

private macro _FormFisclogInfo(event, partyid, Arr, FSearchData, YSearchData)

  var Party = null;
  
  if((partyid != null) AND (partyid > 0))
    Party = RsbParty(partyid);
  end;

  var info = "";
  
  info = info + "Дата: " + date + "\n";
  info = info + "Время: " + time + "\n";
  info = info + "Филиал: " + {OperDprt} + "\n";
  
  //*** A1 ***
  
  if(Party != null)
  
    info = info + "\n";
    
    if(event == 1)
      info = info + "Клиент идентифицирован \n";
    end;
    
    if(event == 4)
      info = info + "Клиент идентифицирован пользователем выбором из списка \n\n";
    end;
    
    info = info + "ID: " + string(partyid:11:o) + "\n";
    info = info + "Код: " + Party.Code.GetCode(1) + "\n";
    
    var str1 = "";
    
    if(Party.LegalForm == 1)
      str1 = "Наименование: ";
    else
      str1 = "ФИО: ";
    end;
    
    info = info + str1 + Party.FullName + "\n";
  
  end;
  
  //*** A2 ***
  
  if(event == 2)
    info = info + "\n";

    info = info + "По заданным параметрам идентификации не найдено ни одного клиента \n";
  end;
  
  //*** A3 ***
  
  if((event == 3) AND (Arr != null))
    
    info = info + "\n";
    
    if(Arr.size <= 50)
    
      info = info + "По заданным параметрам идентификации найдено несколько клиентов \n";
      info = info + "ID: \n";
      
      var i = 0;
      
      while(i < Arr.size)
        
        info = info + string(Arr[i]:11:o) + "\n";
        
        i = i + 1;
      
      end;
      
    else
      
      info = info + "По заданным параметрам идентификации найдено клиентов более 50 \n";
      
    end;
    
  end;
  
  info = info + "\nПараметры идентификации (поиска) субъекта \n";
  
  //*** B1 ***
  
  if(YSearchData != null)
  
    info = info + "\n";
    
    info = info + "Тип:	Юридическое лицо\n";
    
    if((YSearchData.CodeValue != null) AND (YSearchData.CodeValue != ""))
      info = info + "Код: " + YSearchData.CodeKind.name + " " + YSearchData.CodeValue + "\n";
    end;
    
    if((YSearchData.SearchName != null) AND (YSearchData.SearchName != ""))
      info = info + "Наименование: " + YSearchData.SearchName + "\n";
    end;
    
    if((YSearchData.ObjectNumber != null) AND (YSearchData.ObjectNumber != ""))
      info = info + "Объект: " + YSearchData.Objects.name + " " + YSearchData.ObjectNumber + "\n";
    end;
    
    if(((YSearchData.ClientProxy.IdentPersn.LastName != null) AND (YSearchData.ClientProxy.IdentPersn.LastName != "")) OR
        ((YSearchData.ClientProxy.IdentPersn.FirstName != null) AND (YSearchData.ClientProxy.IdentPersn.FirstName != "")) OR
        ((YSearchData.ClientProxy.IdentPersn.Patronymic != null) AND (YSearchData.ClientProxy.IdentPersn.Patronymic != "")))
      info = info + "ФИО представителя: " + YSearchData.ClientProxy.IdentPersn.LastName + " " +
                                            YSearchData.ClientProxy.IdentPersn.FirstName + " " +
                                            YSearchData.ClientProxy.IdentPersn.Patronymic + "\n";
    end;                                      
                                          
    if((YSearchData.ClientProxy.Paper.PIDSeries_Number != null) AND (YSearchData.ClientProxy.Paper.PIDSeries_Number != ""))                                      
      info = info + "ДУЛ представителя: " + YSearchData.ClientProxy.Paper.PaprKind.name + " " +
                                            YSearchData.ClientProxy.Paper.PIDSeries_Number + "\n";
    end;   
  
  end;
  
  //*** B2 ***
  
  if(FSearchData != null)
  
    info = info + "\n";
    
    info = info + "Тип:	Физическое лицо\n";
    
    if(((FSearchData.LastName != null) AND (FSearchData.LastName != "")) OR
      ((FSearchData.FirstName != null) AND (FSearchData.FirstName != "")) OR
      ((FSearchData.Patronymic != null) AND (FSearchData.Patronymic != "")))
      info = info + "ФИО: " + FSearchData.LastName + " "
                            + FSearchData.FirstName + " "
                            + FSearchData.Patronymic + "\n";
    end; 
    
    if(FSearchData.BirthDate != date(0,0,0))
      info = info + "Дата рождения: " + FSearchData.BirthDate + "\n";
    end;
  
    if((FSearchData.PIDSeries_Number != null) AND (FSearchData.PIDSeries_Number != ""))
      info = info + "ДУЛ: " + FSearchData.PaprKind.name + " " +
                              FSearchData.PIDSeries_Number + "\n";
    end;
    
    if((FSearchData.INN != null) AND (FSearchData.INN != ""))
      info = info + "ИНН:	" + FSearchData.INN + "\n";
    end;
  
    if((FSearchData.ObjectNumber != null) AND (FSearchData.ObjectNumber != ""))
      info = info + "Объект: " + FSearchData.Objects.name + " " + FSearchData.ObjectNumber + "\n";
    end;

  end;
  
  return info;

end;

private macro GetIdentificationOPerLog()

  var res;
  var err;

  GetRegistryValue( "CB\\PARTY\\WEB\\IDENTIFICATIONOPERLOG", V_BOOL, res, err ,null, {oper});

  if(err != 0)
    RunError("Ошибка при чтении настройки реестра!");
  end;
  
  return res;

end;

macro SearchClient(PartyId, Request)

    var err, res;

    var p = TWsSearchClientRequest();

    p.PartyID     = PartyId;

    var query_p = " SELECT PE.T_NAME1 LastName, " +
                  "        PE.T_NAME2 FirstName, " +
                  "        PE.T_NAME3 Patronymic, " +
                  "        PE.T_BORN BirthDate, " +
                  "        PE.T_DEATH DeathDate " +
                  "   FROM dpersn_dbt pe " +
                  "  WHERE PE.T_PERSONID = ? ";

    var cmd_p = RSDCommand( query_p );

    cmd_p.addParam( "", RSDBP_IN, p.PartyID );

    cmd_p.NullConversion = true;

    cmd_p.Execute();

    var ds_p = TRsbDataSet( cmd_p );

    if(ds_p.movenext)

      p.LastName    = ds_p.LastName;
      p.FirstName   = ds_p.FirstName;
      p.Patronymic  = ds_p.Patronymic;
      p.BirthDate   = ds_p.BirthDate;
      p.DeathDate   = ds_p.DeathDate;

    end;

    var query_inn = " SELECT PC.T_CODE INN "
                    "   FROM dpartcode_dbt pc "
                    "  WHERE PC.T_CODEKIND = 16 AND PC.T_PARTYID = ? ";

    var cmd_inn = RSDCommand( query_inn );

    cmd_inn.addParam( "", RSDBP_IN, p.PartyID );

    cmd_inn.NullConversion = true;

    cmd_inn.Execute();

    var ds_inn = TRsbDataSet( cmd_inn );

    if(ds_inn.movenext)

      p.INN         = ds_inn.INN;

    end;

    var query_idc = " SELECT pk.t_paperkind paperkind, " +
                    "        pk.t_name name_, " +
                    "        pk.t_definition definition, " +
                    "        pk.t_codedocum codedocum, " +
                    "        IDC.T_PAPERSERIES PIDSeries, " +
                    "        IDC.T_PAPERNUMBER PIDNumber, " +
                    "        IDC.T_PAPERISSUER PIDIssuer, " +
                    "        IDC.T_PAPERISSUEDDATE PIDIssuedDate " +
                    "   FROM dpersnidc_dbt idc, dpaprkind_dbt pk " +
                    "  WHERE PK.T_PAPERKIND = IDC.T_PAPERKIND AND IDC.T_PERSONID = ? ";

    var cmd_idc = RSDCommand( query_idc );

    cmd_idc.addParam( "", RSDBP_IN, p.PartyID );

    cmd_idc.NullConversion = true;

    cmd_idc.Execute();

    var ds_idc = TRsbDataSet( cmd_idc );

    if(ds_idc.movenext)

      var PaprKind = TRecHandler("paprkind");

      PaprKind.rec.paperkind    = ds_idc.paperkind;
      PaprKind.rec.name         = ds_idc.name_;
      PaprKind.rec.definition   = ds_idc.definition;
      PaprKind.rec.codedocum    = ds_idc.codedocum;

      p.PaprKind = PaprKind.rec;

      p.PIDSeries       = ds_idc.PIDSeries;
      p.PIDNumber       = ds_idc.PIDNumber;
      p.PIDIssuer       = ds_idc.PIDIssuer;
      p.PIDIssuedDate   = ds_idc.PIDIssuedDate;

    end;

    if((Request != null) AND (Request.Objects != null) AND (Request.ObjectNumber != ""))

    var query_prdc = " SELECT o.*, PRDC.T_DOCNUMBER ObjectNumber " +
                     "   FROM dobjects_dbt o, dprdclient_dbt prdc " +
                     "  WHERE O.T_OBJECTTYPE = PRDC.T_OBJECTTYPE ";

    if((Request != null) AND (Request.Objects != null))

      query_prdc = query_prdc + " AND PRDC.T_OBJECTTYPE = ? " +
                                " AND PRDC.T_DOCNUMBER = ? ";

    end;

    query_prdc = query_prdc +  "        AND PRDC.T_PARTYID = ? " +
                               " UNION ALL " +
                               " SELECT o.*, PRDCO.T_OBJECTNUMBER ObjectNumber " +
                               "   FROM dobjects_dbt o, dprdclient_dbt prdc, dprdclientobj_dbt prdco " +
                               "  WHERE     PRDCO.T_CLIENTPRODUCTID = PRDC.T_CLIENTPRODUCTID " +
                               "        AND PRDCO.T_OBJECTTYPE = O.T_OBJECTTYPE " +
                               "        AND PRDCO.T_ISGENERAL = 'X' " +
                               "        AND PRDC.T_PARTYID = ? ";

    if((Request != null) AND (Request.Objects != null))

      query_prdc = query_prdc + " AND PRDCO.T_OBJECTTYPE = ? " +
                                " AND PRDCO.T_OBJECTNUMBER = ? ";

    end;

    var cmd_prdc = RSDCommand( query_prdc );

    if((Request != null) AND (Request.Objects != null))

      cmd_prdc.addParam( "", RSDBP_IN, Request.Objects.objecttype);
      cmd_prdc.addParam( "", RSDBP_IN, Request.ObjectNumber);

    end;

    cmd_prdc.addParam( "", RSDBP_IN, p.PartyID );
    cmd_prdc.addParam( "", RSDBP_IN, p.PartyID );

    if((Request != null) AND (Request.Objects != null))

      cmd_prdc.addParam( "", RSDBP_IN, Request.Objects.objecttype);
      cmd_prdc.addParam( "", RSDBP_IN, Request.ObjectNumber);

    end;

    cmd_prdc.NullConversion = true;

    cmd_prdc.Execute();

    var ds_prdc = TRsbDataSet( cmd_prdc );

    if(ds_prdc.movenext)

      var Objects = TRecHandler("objects");

      Objects.rec.objecttype        = ds_prdc.objecttype;
      Objects.rec.name              = ds_prdc.name;
      Objects.rec.code              = ds_prdc.code;
      Objects.rec.usernumber        = ds_prdc.usernumber;
      Objects.rec.parentobjecttype  = ds_prdc.parentobjecttype;
      Objects.rec.servicemacro      = ds_prdc.servicemacro;
      Objects.rec.module            = ds_prdc.module;

      p.Objects = Objects.rec;

      p.ObjectNumber = ds_prdc.ObjectNumber;

    end;

    end;
    
    // Установка HasStoppedFMOpr
    p.HasStoppedFMOpr = ClientHasFMOperation(PartyId);
    
    p.Cat115FZAttrName = GetCat115FZAttrName(PartyId);

    GetRegistryValue( "CB\\PARTY\\WEB\\FOTOSIGNUSE", V_BOOL, res, err ,null, {oper});

    if(err == 0)
      p.FotoSignUse = res;
    else
      RunError("Ошибка при чтении настройки реестра!");
    end;

    PartyBankruptWarning(PartyId, false, true, p.BankruptStatus, p.BankruptStatusMessage);
    

    p.IsAttentionOperations = FM_GetReqInfoFocusOnOperations(p.PartyID);

    return p;

end;

private macro SetCMDByRequest(Request, onlyCountMatches)

  Request.LastName   = Trim(Request.LastName);
  Request.FirstName  = Trim(Request.FirstName);
  Request.Patronymic = Trim(Request.Patronymic);
  
  Request.PIDSeries = Trim(Request.PIDSeries);
  Request.PIDNumber = Trim(Request.PIDNumber);

  var query;

  query = "";

  if(onlyCountMatches)
    query = " SELECT COUNT(1) CountMatches ";
  else
    query = " SELECT PE.T_PERSONID PartyID ";
  end;

  query = query + " FROM dpersn_dbt pe WHERE 1 = 1 ";

  if((Request.LastName != null) AND (Request.LastName != ""))
    query = query + " AND TRIM(UPPER(PE.T_NAME1)) = UPPER( ? ) ";
  end;

  if((Request.FirstName != null) AND (Request.FirstName != ""))
    query = query + " AND TRIM(UPPER(PE.T_NAME2)) = UPPER( ? ) ";
  end;

  if((Request.Patronymic != null) AND (Request.Patronymic != ""))
    query = query + " AND TRIM(UPPER(PE.T_NAME3)) = UPPER( ? ) ";
  end;

  if((Request.BirthDate != null) AND (Request.BirthDate != date( 0, 0, 0 )))
    query = query + " AND PE.T_BORN = ? ";
  end;

  if((Request.INN != null) AND (Request.INN != ""))
    query = query + " AND PE.T_PERSONID IN (SELECT PC.T_PARTYID " +
                    "                         FROM dpartcode_dbt pc " +
                    "                        WHERE PC.T_CODEKIND = 16 AND PC.T_CODE = ?) ";
  end;

  if(((Request.PIDSeries != null) AND (Request.PIDSeries != "")) OR ((Request.PIDNumber != null) AND (Request.PIDNumber != "")))
    query = query + " AND PE.T_PERSONID IN " +
                    "     (SELECT IDC.T_PERSONID " +
                    "        FROM dpersnidc_dbt idc ";

    if(Request.PaprKind != null)
      query = query + " , dpaprkind_dbt pk ";
    end;

    query = query + "       WHERE 1 = 1 ";

    if(Request.PaprKind != null)
      query = query + "           AND PK.T_PAPERKIND = IDC.T_PAPERKIND " +
                    "             AND IDC.T_PAPERKIND = ? ";
    end;

    if((Request.PIDSeries != null) AND (Request.PIDSeries != ""))
      query = query + "           AND IDC.T_PAPERSERIES = ? "
    end;

    if((Request.PIDNumber != null) AND (Request.PIDNumber != ""))
      query = query + "           AND IDC.T_PAPERNUMBER = ? ";
    end;

    query = query + "     ) ";
  end;
  
  if((Request.ObjectNumber != null) AND (Request.ObjectNumber != "") AND (Request.Objects != null) AND (Request.Objects.objecttype != null))
    query = query + " AND (   PE.T_PERSONID IN " +
                    "        (SELECT PRDCR.T_PARTYID " +
                    "           FROM dprdclient_dbt PRDC, " +
                    "                dprdclntrole_dbt PRDCR " +
                    "          WHERE      PRDC.T_CLIENTPRODUCTID = PRDCR.T_CLIENTPRODUCTID " +
                    "                and PRDC.T_DOCNUMBER = ? " +
                    "                AND PRDC.T_OBJECTTYPE = ?) " +
                    "  OR PE.T_PERSONID IN " +
                    "        (SELECT PRDCR.T_PARTYID " +
                    "           FROM  " +
                    "                dprdclntrole_dbt PRDCR, " +
                    "                dprdclientobj_dbt PRDCO " +
                    "          WHERE     PRDCO.T_CLIENTPRODUCTID = PRDCR.T_CLIENTPRODUCTID " +
                    "                AND PRDCO.T_OBJECTNUMBER = ? " +
                    "                AND PRDCO.T_OBJECTTYPE = ? " +
                    "                AND PRDCO.T_ISGENERAL = 'X')) ";
  else
    query = query + " AND PE.T_DEATH = to_date('01.01.0001', 'dd.mm.yyyy') ";
  end;

  PT_PrintDebug( "ws_bankproduct.mac.log", query);

  var cmd = RSDCommand(query);

  if((Request.LastName != null) AND (Request.LastName != ""))
    cmd.addParam( "", RSDBP_IN, Request.LastName );
    PT_PrintDebug( "ws_bankproduct.mac.log", "LastName - " + Request.LastName);
  end;

  if((Request.FirstName != null) AND (Request.FirstName != ""))
    cmd.addParam( "", RSDBP_IN, Request.FirstName );
    PT_PrintDebug( "ws_bankproduct.mac.log", "FirstName - " + Request.FirstName);
  end;

  if((Request.Patronymic != null) AND (Request.Patronymic != ""))
    cmd.addParam( "", RSDBP_IN, Request.Patronymic );
    PT_PrintDebug( "ws_bankproduct.mac.log", "Patronymic - " + Request.Patronymic);
  end;

  if((Request.BirthDate != null) AND (Request.BirthDate != date( 0, 0, 0 )))
    cmd.addParam( "", RSDBP_IN, Request.BirthDate );
    PT_PrintDebug( "ws_bankproduct.mac.log", "BirthDate - " + Request.BirthDate);
  end;

  if((Request.INN != null) AND (Request.INN != ""))
    cmd.addParam( "", RSDBP_IN, Request.INN );
    PT_PrintDebug( "ws_bankproduct.mac.log", "INN - " + Request.INN);
  end;

  if( ((Request.PIDSeries != null) AND (Request.PIDSeries != "")) OR ((Request.PIDNumber != null) AND (Request.PIDNumber != "")) )

    if(Request.PaprKind != null)
      cmd.addParam( "", RSDBP_IN, Request.PaprKind.paperkind );
      PT_PrintDebug( "ws_bankproduct.mac.log", "PaprKind.paperkind - " + Request.PaprKind.paperkind);
    end;

    if((Request.PIDSeries != null) AND (Request.PIDSeries != ""))
      cmd.addParam( "", RSDBP_IN, Request.PIDSeries );
      PT_PrintDebug( "ws_bankproduct.mac.log", "PIDSeries - " + Request.PIDSeries);
    end;

    if((Request.PIDNumber != null) AND (Request.PIDNumber != ""))
      cmd.addParam( "", RSDBP_IN, Request.PIDNumber );
      PT_PrintDebug( "ws_bankproduct.mac.log", "PIDNumber - " + Request.PIDNumber);
    end;

  end;

  if((Request.ObjectNumber != null) AND (Request.ObjectNumber != ""))

    cmd.addParam( "", RSDBP_IN, Request.ObjectNumber);
    PT_PrintDebug( "ws_bankproduct.mac.log", "ObjectNumber - " + Request.ObjectNumber);

    if(Request.Objects != null)
      cmd.addParam( "", RSDBP_IN, Request.Objects.objecttype);
      PT_PrintDebug( "ws_bankproduct.mac.log", "Objects.objecttype - " + Request.Objects.objecttype);
    end;

    cmd.addParam( "", RSDBP_IN, Request.ObjectNumber);
    PT_PrintDebug( "ws_bankproduct.mac.log", "ObjectNumber - " + Request.ObjectNumber);

    if(Request.Objects != null)
      cmd.addParam( "", RSDBP_IN, Request.Objects.objecttype);
      PT_PrintDebug( "ws_bankproduct.mac.log", "Objects.objecttype - " + Request.Objects.objecttype);
    end;

  end;
  
  return cmd;

end;

// оставлено для RetailSearchClientWidget.xaml.cs. Возвращает только COUNT
macro CB_GetIdentClientMatches(Request)

  var cmd = SetCMDByRequest(Request, true);

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );
  
  var i:integer;
  i = 0;

  if(ds.movenext)

    i = ds.CountMatches;

  end;

  return i;
  
end;

macro CB_GetIdentClientMatchesIDs(Request)
  var Arr = TArray();
  
  var cmd = SetCMDByRequest(Request, false);

  cmd.NullConversion = true;
  cmd.Execute();
  var ds = TRsbDataSet( cmd );
  
  while(ds.movenext)
    Arr[Arr.size] = ds.PartyID;
  end;
  
  return Arr;
end;

macro CB_IsAttentionOperations(partyid:integer):bool
 
  var ret = false;
  ret = FM_GetReqInfoFocusOnOperations(PartyID);
  
  return ret;
end;

macro IdentClient(Request, MultySelectEnabled)

  var p;
  
  var info = "";
  
  var res = true;
  
  var Arr = TArray;
  
  var IdentificationOPerLog = GetIdentificationOPerLog();
  
  var cmd = SetCMDByRequest(Request, false);

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );
  
  while(ds.movenext)
  
    Arr[Arr.size] = ds.PartyID;
  
  end;
  
  if(Arr.size > 1)
  
    if(MultySelectEnabled == false)
    
      p = TWsSearchClientRequest();

      p.PartyID = -2; 
      p.PartyIDs = Arr;
    
    else
    
      p = TWsSearchClientRequest();
      
      p.PartyID = -3;
      p.PartyIDs = Arr;
    
    end;
    
    if(IdentificationOPerLog == true)
      
      info = _FormFisclogInfo(3, -1, Arr, Request);
      
      res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
        
    end;      
    
  end;
  
  if(Arr.size == 0)

    p = TWsSearchClientRequest();

    p.PartyID = -1;
    p.PartyIDs = Arr;
  
    if(IdentificationOPerLog == true)
      
      info = _FormFisclogInfo(2, -1, null, Request);
      
      res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
        
    end;
  
  end;

  if(Arr.size == 1)

    p = SearchClient(ds.PartyID, Request);
    p.PartyIDs = Arr;
  
    if(IdentificationOPerLog == true)
      
      info = _FormFisclogInfo(1, ds.PartyID, null, Request);
      
      res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
        
    end;
  
  end;  

  return p;

end;

macro BP_GetProductById(ProductId)

  var p;

  var query = " SELECT P.T_PRODUCTID, "
              "        P.T_NAME productname, "
              "        P.T_OPENDATE, "
              "        P.T_CLOSEDATE, "
              "        PK.T_NAME productkindname, "
              "        T.T_NAME productdockindname "
              "   FROM dprdproduct_dbt p, DPRDKIND_DBT pk, dllvalues_dbt t "
              "  WHERE     P.T_PRODUCTID = ? "
              "        AND P.T_PRODUCTKINDID = PK.T_PRODUCTKINDID(+) "
              "        AND t.t_list = 1050 "
              "        AND t.t_element = p.T_PRODUCTDOCKINDID(+) ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, ProductId );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  if(ds.movenext)

    p = TWsProd();

    p.ProductID          = ds.ProductID;
    p.ProductName        = ds.ProductName;
    p.OpenDate           = ds.OpenDate;
    p.CloseDate          = ds.CloseDate;
    p.ProductKindName    = ds.ProductKindName;
    p.ProductDocKindName = ds.ProductDocKindName;

  end;

  return p;

end;

macro CB_GetPaprKind(PaperKind)

  var cmd, rs;

  var Rec = TRecHandler("paprkind");

  var query = "select * from dpaprkind_dbt where t_paperkind = " + string(PaperKind);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

  end;

  return Rec.rec;

end;

macro SearchYurClient(PartyId, Request)

    var p = TWebYurClientSearchIdentData();
    
    var IdentificationOPerLog = GetIdentificationOPerLog();
    
    p.INN = "";

    if((Request != null) AND (Request.CodeKind != null))
      
    p.CodeKind = Request.CodeKind;
  
    end; 

    p.CodeValue = "";
    var Objects = TRecHandler("objects");
    Objects.rec.name = "";
    p.Objects = Objects.rec;
    p.ObjectNumber = "";
    p.ClientProxy = TWebClientProxy();
    p.ClientProxy.IdentPersn = TWebIdentPersn();
    p.Officer     = TWebClientOfficer();
    p.Officer.IdentPersn = TWebIdentPersn();
    p.FirstPerson = TWebClientOfficer();
    p.FirstPerson.IdentPersn = TWebIdentPersn();

    p.PartyID = PartyId;

    var query_p = " SELECT pt.T_NAME FullName, " +
                  "        pt.T_SHORTNAME ShortName " +
                  "   FROM DPARTY_DBT pt " +
                  "  WHERE pt.T_PARTYID = ? ";

    var cmd_p = RSDCommand( query_p );

    cmd_p.addParam( "", RSDBP_IN, p.PartyID );

    cmd_p.NullConversion = true;

    cmd_p.Execute();

    var ds_p = TRsbDataSet( cmd_p );

    if(ds_p.movenext)

      p.FullName    = ds_p.FullName;
      p.ShortName   = ds_p.ShortName;

    end;

    var query_code = " SELECT PC.T_CODE CodeValue "
                     "   FROM dpartcode_dbt pc "
                     "  WHERE PC.T_PARTYID = ? ";
                    
    if((Request != null) AND (Request.CodeKind != null))

      query_code = query_code + " AND PC.T_CODEKIND = ? ";

    end;                    

    var cmd_code = RSDCommand( query_code );

    cmd_code.addParam( "", RSDBP_IN, p.PartyID );
    
    if((Request != null) AND (Request.CodeKind != null))

      cmd_code.addParam( "", RSDBP_IN, Request.CodeKind.CodeKind);

    end;      

    cmd_code.NullConversion = true;

    cmd_code.Execute();

    var ds_code = TRsbDataSet( cmd_code );

    if(ds_code.movenext)

      p.CodeValue         = ds_code.CodeValue;

    end;

    var query_inn = " SELECT PC.T_CODE INN "
                    "   FROM dpartcode_dbt pc "
                    "  WHERE PC.T_CODEKIND = 16 AND PC.T_PARTYID = ? ";

    var cmd_inn = RSDCommand( query_inn );

    cmd_inn.addParam( "", RSDBP_IN, p.PartyID );

    cmd_inn.NullConversion = true;

    cmd_inn.Execute();

    var ds_inn = TRsbDataSet( cmd_inn );

    if(ds_inn.movenext)

      p.INN         = ds_inn.INN;

    end;

    var query_prdc = " SELECT o.*, PRDC.T_DOCNUMBER ObjectNumber " +
                     "   FROM dobjects_dbt o, dprdclient_dbt prdc " +
                     "  WHERE O.T_OBJECTTYPE = PRDC.T_OBJECTTYPE ";

    if((Request != null) AND (Request.Objects != null))

      query_prdc = query_prdc + " AND PRDC.T_OBJECTTYPE = ? " +
                                " AND PRDC.T_DOCNUMBER = ? ";

    end;

    query_prdc = query_prdc +  "        AND PRDC.T_PARTYID = ? " +
                               " UNION ALL " +
                               " SELECT o.*, PRDCO.T_OBJECTNUMBER ObjectNumber " +
                               "   FROM dobjects_dbt o, dprdclient_dbt prdc, dprdclientobj_dbt prdco " +
                               "  WHERE     PRDCO.T_CLIENTPRODUCTID = PRDC.T_CLIENTPRODUCTID " +
                               "        AND PRDCO.T_OBJECTTYPE = O.T_OBJECTTYPE " +
                               "        AND PRDCO.T_ISGENERAL = 'X' " +
                               "        AND PRDC.T_PARTYID = ? ";

    if((Request != null) AND (Request.Objects != null))

      query_prdc = query_prdc + " AND PRDCO.T_OBJECTTYPE = ? " +
                                " AND PRDCO.T_OBJECTNUMBER = ? ";

    end;

    var cmd_prdc = RSDCommand( query_prdc );

    if((Request != null) AND (Request.Objects != null))

      cmd_prdc.addParam( "", RSDBP_IN, Request.Objects.objecttype);
      cmd_prdc.addParam( "", RSDBP_IN, Request.ObjectNumber);

    end;

    cmd_prdc.addParam( "", RSDBP_IN, p.PartyID );
    cmd_prdc.addParam( "", RSDBP_IN, p.PartyID );

    if((Request != null) AND (Request.Objects != null))

      cmd_prdc.addParam( "", RSDBP_IN, Request.Objects.objecttype);
      cmd_prdc.addParam( "", RSDBP_IN, Request.ObjectNumber);

    end;

    cmd_prdc.NullConversion = true;

    cmd_prdc.Execute();

    var ds_prdc = TRsbDataSet( cmd_prdc );

    if(ds_prdc.movenext)

      Objects = TRecHandler("objects");

      Objects.rec.objecttype        = ds_prdc.objecttype;
      Objects.rec.name              = ds_prdc.name;
      Objects.rec.code              = ds_prdc.code;
      Objects.rec.usernumber        = ds_prdc.usernumber;
      Objects.rec.parentobjecttype  = ds_prdc.parentobjecttype;
      Objects.rec.servicemacro      = ds_prdc.servicemacro;
      Objects.rec.module            = ds_prdc.module;

      p.Objects = Objects.rec;

      p.ObjectNumber = ds_prdc.ObjectNumber;

    end;    
    
    var query_4143 = " SELECT  pe.T_PERSONID, pt.T_LEGALFORM, pe.T_NAME1, pe.T_NAME2, pe.T_NAME3 "
                     "   FROM dptproxy_dbt prx, dofficer_dbt off, dpersn_dbt pe, dpersnidc_dbt idc, dparty_dbt pt "
                     "  WHERE prx.T_PARTYID = ? AND pe.T_PERSONID = prx.T_PROXYID AND idc.T_PERSONID = prx.T_PROXYID AND pt.T_PARTYID = prx.T_PROXYID "
                     " UNION ALL "
                     " SELECT  pe.T_PERSONID, pt.T_LEGALFORM, pe.T_NAME1, pe.T_NAME2, pe.T_NAME3 "
                     "   FROM dptproxy_dbt prx, dofficer_dbt off, dpersn_dbt pe, dpersnidc_dbt idc, dparty_dbt pt "
                     "  WHERE prx.T_PARTYID = ? AND off.T_PARTYID = prx.T_PROXYID AND off.T_PERSONID = pe.T_PERSONID AND idc.T_PERSONID = prx.T_PROXYID AND pt.T_PARTYID = prx.T_PROXYID ";

    var cmd_4143 = RSDCommand( query_4143 );

    cmd_4143.addParam( "", RSDBP_IN, p.PartyID );
    cmd_4143.addParam( "", RSDBP_IN, p.PartyID );

    cmd_4143.NullConversion = true;

    cmd_4143.Execute();

    var ds_4143 = TRsbDataSet( cmd_4143 );

    if(ds_4143.movenext)

      var ClientProxy = TWebClientProxy();
      
      var IdentPersn_4143 = TWebIdentPersn();
      
      IdentPersn_4143.PersonID      = ds_4143.PERSONID;
      IdentPersn_4143.LegalForm     = ds_4143.LEGALFORM;
      IdentPersn_4143.LastName      = ds_4143.NAME1;
      IdentPersn_4143.FirstName     = ds_4143.NAME2;
      IdentPersn_4143.Patronymic    = ds_4143.NAME3;

      p.ClientProxy            = ClientProxy;
      p.ClientProxy.IdentPersn = IdentPersn_4143;
      
    end;

    var query_42 = " SELECT  off.T_POST, pe.T_PERSONID, pe.T_NAME1, pe.T_NAME2, pe.T_NAME3 "
                   "   FROM dptproxy_dbt prx, dofficer_dbt off, dpersn_dbt pe, dpersnidc_dbt idc "
                   "  WHERE off.T_PARTYID =  ? AND off.T_PERSONID = pe.T_PERSONID AND idc.T_PERSONID = prx.T_PROXYID ";

    var cmd_42 = RSDCommand( query_42 );

    cmd_42.addParam( "", RSDBP_IN, p.PartyID );

    cmd_42.NullConversion = true;

    cmd_42.Execute();

    var ds_42 = TRsbDataSet( cmd_42 );

    if(ds_42.movenext)

      var Officer = TWebClientOfficer();

      Officer.Post = ds_42.post;
      
      var IdentPersn_42 = TWebIdentPersn();
      
      IdentPersn_42.PersonID      = ds_42.PERSONID;
      IdentPersn_42.LastName      = ds_42.NAME1;
      IdentPersn_42.FirstName     = ds_42.NAME2;
      IdentPersn_42.Patronymic    = ds_42.NAME3;

      p.Officer            = Officer;
      p.Officer.IdentPersn = IdentPersn_42;
      
    end;

    var query_fp = " SELECT  off.T_POST, pe.T_PERSONID, pe.T_NAME1, pe.T_NAME2, pe.T_NAME3 "
                   "   FROM dofficer_dbt off, dpersn_dbt pe "
                   "  WHERE off.T_PARTYID =  ? AND off.T_PERSONID = pe.T_PERSONID "
                   "        AND off.T_ISFIRSTPERSON = 'X' AND off.T_DATEFROM >= TO_DATE('" + string({curdate}) + "', 'DD-MM-YYYY') "
                   "        AND (off.T_DATETO = TO_DATE ('01010001', 'DDMMYYYY') OR off.T_DATETO <= TO_DATE('" + string({curdate}) + "', 'DD-MM-YYYY')) ";

    var cmd_fp = RSDCommand( query_fp );

    cmd_fp.addParam( "", RSDBP_IN, p.PartyID );

    cmd_fp.NullConversion = true;

    cmd_fp.Execute();

    var ds_fp = TRsbDataSet( cmd_fp );

    if(ds_fp.movenext)

      var FirstPerson = TWebClientOfficer();

      FirstPerson.Post = ds_fp.paperkind;
      
      var IdentPersn = TWebIdentPersn();
      
      IdentPersn.PersonID      = ds_fp.PERSONID;
      IdentPersn.LastName      = ds_fp.NAME1;
      IdentPersn.FirstName     = ds_fp.NAME2;
      IdentPersn.Patronymic    = ds_fp.NAME3;

      p.FirstPerson            = FirstPerson;
      p.FirstPerson.IdentPersn = IdentPersn;
      
    end;

    // Установка HasStoppedFMOpr
    p.HasStoppedFMOpr = ClientHasFMOperation(PartyId);


    var query_rd = " SELECT rd.t_codekind "
                   "   FROM dobjrgdoc_dbt rd "
                   "  WHERE rd.t_ObjectType = 3 AND rd.t_objectid = ? AND rd.t_ismain = 'X' ";

    var cmd_rd = RSDCommand( query_rd );

    cmd_rd.addParam( "", RSDBP_IN, p.PartyID );

    cmd_rd.NullConversion = true;

    cmd_rd.Execute();

    var ds_rd = TRsbDataSet( cmd_rd );

    if(ds_rd.movenext)
      
      var Rec = TRecHandler("objkcode");
      
      var query_kc = " select * from dobjkcode_dbt where t_objecttype = 3 and t_codekind = " + string(ds_rd.codekind) + " ";

      var cmd_kc = RsdCommand(query_kc);
      var rs_kc = RsdRecordset(cmd_kc);
      
      if(rs_kc.movenext)
        
        _CopyRecordsetToRecHandler(rs_kc, Rec);

        var pp = TRecHandler("objkcode");
        copy(pp, Rec);
        
        p.RegDocCodeKind = pp.rec;
        
      end;

      p.RegDocCodeValue = ПолучитьКодСубъекта( p.PartyID, ds_rd.codekind );
      
    end;

    return p;

end;

private macro SetYurCMDByRequest(Request)

  var query;

  query = " SELECT pt.t_partyid PartyID "
          "   FROM dparty_dbt pt "
          "  WHERE t_legalform = 1  ";

  if((Request.SearchName != null) AND (Request.SearchName != ""))
    query = query + " AND (utl_match.jaro_winkler_similarity (UPPER(RSI_RSBPARTY.RemoveOPF(pt.t_name)), UPPER(RSI_RSBPARTY.RemoveOPF(?))) >= ? OR utl_match.jaro_winkler_similarity (UPPER(RSI_RSBPARTY.RemoveOPF(pt.t_shortname)), UPPER(RSI_RSBPARTY.RemoveOPF(?))) >= ?) ";
  end;

  if((Request.CodeValue != null) AND (Request.CodeValue != "") AND (Request.CodeKind != null) AND (Request.CodeKind.CodeKind != null))
    query = query + " AND pt.t_partyid IN (SELECT PC.T_PARTYID " +
                    "                         FROM dpartcode_dbt pc " +
                    "                        WHERE PC.T_CODEKIND = ? AND PC.T_CODE = ?) ";
  end;

  if((Request.ObjectNumber != null) AND (Request.ObjectNumber != "") AND (Request.Objects != null) AND (Request.Objects.objecttype != null))
    query = query + " AND (   pt.t_partyid IN " +
                    "         (SELECT PRDC.T_PARTYID " +
                    "            FROM dobjects_dbt o, dprdclient_dbt prdc " +
                    "           WHERE     PRDC.T_DOCNUMBER = ? " +
                    "                 AND O.T_OBJECTTYPE = PRDC.T_OBJECTTYPE " +
                    "                 AND PRDC.T_OBJECTTYPE = ?) " +
                    "   OR pt.t_partyid IN " +
                    "         (SELECT PRDC.T_PARTYID " +
                    "            FROM dobjects_dbt o, " +
                    "                 dprdclient_dbt prdc, " +
                    "                 dprdclientobj_dbt prdco " +
                    "           WHERE     PRDCO.T_CLIENTPRODUCTID = " +
                    "                        PRDC.T_CLIENTPRODUCTID " +
                    "                 AND PRDCO.T_OBJECTNUMBER = ? " +
                    "                 AND PRDCO.T_OBJECTTYPE = O.T_OBJECTTYPE " +
                    "                 AND PRDCO.T_OBJECTTYPE = ? " +
                    "                 AND PRDCO.T_ISGENERAL = 'X')) ";

  end;

  query = query + " AND (( 1 = 1 ";

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.LastName != ""))
    query = query + " AND pt.t_partyid IN (SELECT prx.T_PARTYID " +
                    "                         FROM dptproxy_dbt prx, dpersn_dbt pe " +
                    "                        WHERE prx.T_PROXYID = PE.T_PERSONID AND UPPER(PE.T_NAME1) = UPPER( ? )) ";
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.FirstName != ""))
    query = query + " AND pt.t_partyid IN (SELECT prx.T_PARTYID " +
                    "                         FROM dptproxy_dbt prx, dpersn_dbt pe " +
                    "                        WHERE prx.T_PROXYID = PE.T_PERSONID AND UPPER(PE.T_NAME2) = UPPER( ? )) ";
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.Patronymic != ""))
    query = query + " AND pt.t_partyid IN (SELECT prx.T_PARTYID " +
                    "                         FROM dptproxy_dbt prx, dpersn_dbt pe " +
                    "                        WHERE prx.T_PROXYID = PE.T_PERSONID AND UPPER(PE.T_NAME3) = UPPER( ? )) ";
  end;

  if((((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDSeries != "")) OR
      ((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))))
    query = query + " AND pt.t_partyid IN " +
                    "     (SELECT prx.T_PARTYID " +
                    "        FROM dptproxy_dbt prx, dpersnidc_dbt idc "
                    "       WHERE idc.t_personid = prx.T_PROXYID ";

    if((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PaprKind != null) AND (Request.ClientProxy.Paper.PaprKind.paperkind != null))
      query = query + "           AND IDC.T_PAPERKIND = ? ";
    end;

    if((Request.ClientProxy.Paper.PIDSeries != null) AND (Request.ClientProxy.Paper.PIDSeries != ""))
      query = query + "           AND IDC.T_PAPERSERIES = ? "
    end;

    if((Request.ClientProxy.Paper.PIDNumber != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))
      query = query + "           AND IDC.T_PAPERNUMBER = ? ";
    end;

    query = query + "     ) ";
  end;
  
  query = query + " ) OR ( 1 = 1 ";

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.LastName != ""))
    query = query + " AND pt.t_partyid IN (SELECT off.T_PARTYID " +
                    "                         FROM dofficer_dbt off, dpersn_dbt pe " +
                    "                        WHERE off.T_PARTYID = pt.T_PARTYID AND off.T_PERSONID = PE.T_PERSONID AND UPPER(PE.T_NAME1) = UPPER( ? )) ";
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.FirstName != ""))
    query = query + " AND pt.t_partyid IN (SELECT off.T_PARTYID " +
                    "                         FROM dofficer_dbt off, dpersn_dbt pe " +
                    "                        WHERE off.T_PARTYID = pt.T_PARTYID AND off.T_PERSONID = PE.T_PERSONID AND UPPER(PE.T_NAME2) = UPPER( ? )) ";
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.Patronymic != ""))
    query = query + " AND pt.t_partyid IN (SELECT off.T_PARTYID " +
                    "                         FROM dofficer_dbt off, dpersn_dbt pe " +
                    "                        WHERE off.T_PARTYID = pt.T_PARTYID AND off.T_PERSONID = PE.T_PERSONID AND UPPER(PE.T_NAME3) = UPPER( ? )) ";
  end;

  if((((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDSeries != "")) OR
      ((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))))
    query = query + " AND pt.t_partyid IN " +
                    "     (SELECT off.T_PARTYID " +
                    "        FROM dofficer_dbt off, dpersnidc_dbt idc "
                    "       WHERE idc.t_personid = off.T_PARTYID ";

    if((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PaprKind != null) AND (Request.ClientProxy.Paper.PaprKind.paperkind != null))
      query = query + "           AND IDC.T_PAPERKIND = ? ";
    end;

    if((Request.ClientProxy.Paper.PIDSeries != null) AND (Request.ClientProxy.Paper.PIDSeries != ""))
      query = query + "           AND IDC.T_PAPERSERIES = ? "
    end;

    if((Request.ClientProxy.Paper.PIDNumber != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))
      query = query + "           AND IDC.T_PAPERNUMBER = ? ";
    end;

    query = query + "     ) ";
  end;
  
  query = query + " ) OR ( 1 = 1 ";

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.LastName != ""))
    query = query + " AND pt.t_partyid IN (SELECT prx.T_PARTYID " +
                    "                         FROM dptproxy_dbt prx, dofficer_dbt off, dpersn_dbt pe " +
                    "                        WHERE prx.T_PROXYID = off.T_PARTYID AND off.T_PARTYID = pt.T_PARTYID AND off.T_PERSONID = PE.T_PERSONID AND UPPER(PE.T_NAME1) = UPPER( ? )) ";
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.FirstName != ""))
    query = query + " AND pt.t_partyid IN (SELECT prx.T_PARTYID " +
                    "                         FROM dptproxy_dbt prx, dofficer_dbt off, dpersn_dbt pe " +
                    "                        WHERE prx.T_PROXYID = off.T_PARTYID AND off.T_PARTYID = pt.T_PARTYID AND off.T_PERSONID = PE.T_PERSONID AND UPPER(PE.T_NAME2) = UPPER( ? )) ";
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.Patronymic != ""))
    query = query + " AND pt.t_partyid IN (SELECT prx.T_PARTYID " +
                    "                         FROM dptproxy_dbt prx, dofficer_dbt off, dpersn_dbt pe " +
                    "                        WHERE prx.T_PROXYID = off.T_PARTYID AND off.T_PARTYID = pt.T_PARTYID AND off.T_PERSONID = PE.T_PERSONID AND UPPER(PE.T_NAME3) = UPPER( ? )) ";
  end;

  if((((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDSeries != "")) OR
      ((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))))
    query = query + " AND pt.t_partyid IN " +
                    "     (SELECT prx.T_PARTYID " +
                    "        FROM dptproxy_dbt prx, dofficer_dbt off, dpersnidc_dbt idc "
                    "       WHERE prx.T_PROXYID = off.T_PARTYID AND idc.t_personid = off.T_PARTYID ";

    if((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PaprKind != null) AND (Request.ClientProxy.Paper.PaprKind.paperkind != null))
      query = query + "           AND IDC.T_PAPERKIND = ? ";
    end;

    if((Request.ClientProxy.Paper.PIDSeries != null) AND (Request.ClientProxy.Paper.PIDSeries != ""))
      query = query + "           AND IDC.T_PAPERSERIES = ? "
    end;

    if((Request.ClientProxy.Paper.PIDNumber != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))
      query = query + "           AND IDC.T_PAPERNUMBER = ? ";
    end;

    query = query + "     ) ";
  end;

  query = query + " )) ";

  var cmd = RSDCommand(query);

  if((Request.SearchName != null) AND (Request.SearchName != ""))
    cmd.addParam( "", RSDBP_IN, Request.SearchName );
    cmd.addParam( "", RSDBP_IN, 80 );
    cmd.addParam( "", RSDBP_IN, Request.SearchName );
    cmd.addParam( "", RSDBP_IN, 80 );
  end;

  if((Request.CodeValue != null) AND (Request.CodeValue != "") AND (Request.CodeKind != null) AND (Request.CodeKind.CodeKind != null))
    cmd.addParam( "", RSDBP_IN, Request.CodeKind.CodeKind );
    cmd.addParam( "", RSDBP_IN, Request.CodeValue );
  end;

  if((Request.ObjectNumber != null) AND (Request.ObjectNumber != "") AND (Request.Objects != null) AND (Request.Objects.objecttype != null))
    cmd.addParam( "", RSDBP_IN, Request.ObjectNumber );
    cmd.addParam( "", RSDBP_IN, Request.Objects.objecttype );
    cmd.addParam( "", RSDBP_IN, Request.ObjectNumber );
    cmd.addParam( "", RSDBP_IN, Request.Objects.objecttype );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.LastName != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.LastName );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.FirstName != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.FirstName );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.Patronymic != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.Patronymic );
  end;

  if((((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDSeries != "")) OR
      ((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PaprKind.paperkind );
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PIDSeries );
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PIDNumber );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.LastName != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.LastName );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.FirstName != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.FirstName );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.Patronymic != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.Patronymic );
  end;

  if((((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDSeries != "")) OR
      ((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PaprKind.paperkind );
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PIDSeries );
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PIDNumber );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.LastName != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.LastName );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.FirstName != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.FirstName );
  end;

  if((Request.ClientProxy != null) AND (Request.ClientProxy.IdentPersn != null) AND (Request.ClientProxy.IdentPersn.Patronymic != ""))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.IdentPersn.Patronymic );
  end;

  if((((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDSeries != "")) OR
      ((Request.ClientProxy != null) AND (Request.ClientProxy.Paper != null) AND (Request.ClientProxy.Paper.PIDNumber != ""))))
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PaprKind.paperkind );
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PIDSeries );
    cmd.addParam( "", RSDBP_IN, Request.ClientProxy.Paper.PIDNumber );
  end;

  return cmd;

end;

macro GetYurClientIdentMatches(SearchData)

  var cmd = SetYurCMDByRequest(SearchData);

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  var i = 0;

  while(ds.movenext)

    i = i + 1;

  end;

  return i;

end;

macro CB_YurClientIdent(SearchData, AllowedListSelect)

  var p;

  var info = "";
  
  var res = true;

  var Arr = TArray;

  var IdentificationOPerLog = GetIdentificationOPerLog();

  var result;

  var cmd = SetYurCMDByRequest(SearchData);

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  while(ds.movenext)

    Arr[Arr.size] = ds.PartyID;

  end;

  if(Arr.size > 1)

    if(AllowedListSelect == false)

      p = TWebYurClientSearchIdentData();

      p.PartyID = -2;
      p.PartyIDs = Arr;

    else

      p = TWebYurClientSearchIdentData();

      p.PartyID = -3;
      p.PartyIDs = Arr;

    end;

    if(IdentificationOPerLog == true)
      
      info = _FormFisclogInfo(3, -1, Arr, null, SearchData);
      
      res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
        
    end; 

  end;

  if(Arr.size == 0)

    p = TWebYurClientSearchIdentData();

    p.PartyID = -1;
    p.PartyIDs = Arr;

    if(IdentificationOPerLog == true)
      
      info = _FormFisclogInfo(2, -1, Arr, null, SearchData);
      
      res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
        
    end;    

  end;

  if(Arr.size == 1)

    p = SearchYurClient(ds.PartyID, SearchData);
    p.PartyIDs = Arr;

    if(IdentificationOPerLog == true)
      
      info = _FormFisclogInfo(1, ds.PartyID, null, null, SearchData);
      
      res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
        
    end;

  end;

  return p;

end;

macro FormFisclogInfoF(PartyId, Request)

  var res = true;
    
  var IdentificationOPerLog = GetIdentificationOPerLog();

  if(IdentificationOPerLog == true)
    
    var info = _FormFisclogInfo(4, PartyId, null, Request);
    
    res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
      
  end; 
  
  return res;
    
end;

macro FormFisclogInfoY(PartyId, Request)

  var res = true;

  var IdentificationOPerLog = GetIdentificationOPerLog();
    
  if(IdentificationOPerLog == true)
    
    var info = _FormFisclogInfo(4, PartyId, null, null, Request);
    
    res = WriteFiscLog(UOL_WEB_SEARCH_IDENT_CLIENT, info);
      
  end; 
  
  return res;
    
end;    

//BP_GetProductById(1);

// var p = TWsSearchClientRequest();

// p.LastName = "Test";
// p.FirstName = "F";
// p.Patronymic = "F";
// p.BirthDate = date( 1, 1, 2013 );
// p.INN = "123";

// var PaprKind = TRecHandler("paprkind");

// PaprKind.rec.paperkind    = 0;

// p.PaprKind = PaprKind.rec;

// p.PIDSeries = "111";
// p.PIDNumber = "222";
// p.ObjectNumber = "123";

// var Objects = TRecHandler("objects");

// Objects.rec.objecttype        = 780;

// p.Objects = Objects.rec;

// IdentClient(p);

// GetObjectsList(null);


 //GetClientProductsTree( 4503 );
//GetClntProdObj(1);
