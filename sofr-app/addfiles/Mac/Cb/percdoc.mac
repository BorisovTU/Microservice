 /*
 $Name: percdoc.mac
 $Module: Ядро ГКБО
 $Description: Макрос формирования документа оплаты процентов
 */
/* -@H------------------------------------------------------------------
*            Автоматизированная банковская система RS-Bank
*                 Библиотека интерпретируемых модулей
*                  Copyright (c) JV R-Style 1993-96
*
*   File Name        : percdoc.mac
*
*   Description      : Макрос формирования документа оплаты процентов
*
*   Respons.         : Галашкин А.А. (SAS)
*
*   History          : Создан : 19.02.97
*
* ----------------------------------------------------------------@H-
  PA 1.06.98  При повторной проводке счет плательщика меняется на счет
              просрочки, счет получателя на счет прибылей будущих периодов
  11.10.2000, Михайлов С.: не надо портить Документ.Ground, он передается
    из C
*----------------------------------------------------------------------*/
IMPORT BankInter;

Record Документ( arhdoc );         /* запись операционного документа */
Record ДокументOB( obdocum  );         /* запись операционного документа */
record СчетПр( pcacc );                /* счет процентов */

/*-------------------------------------------------------------------------\
|       Макроопределение возможных значений параметра "Вид"                |
\-------------------------------------------------------------------------*/
const ОПЛАТА_ПРОЦЕНТОВ = 0,
      ОПЛАТА_ПЕНИ      = 1;

/*-------------------------------------------------------------------------\
|       Макроопределение возможных значений параметра "Тип"                |
\-------------------------------------------------------------------------*/
const ПРОВОДКА_ДОКУМЕНТА     = 0,
      ПОМЕЩЕНИЕ_В_ОТЛОЖЕННЫЕ = 1,
      ПОВТОРНАЯ_ПРОВОДКА     = 2,
      ПОВТОРНО_В_ОТЛОЖЕННЫЕ  = 3;

CONST ПроводкаОплатаПроцентов = 202;
CONST ТипГрафикаЕжедневный    = 5;

/*-------------------------------------------------------------------------\
|       Макроопределение идентификатора референса номеров документов
|       порождаемых оплатой процентов                                      |
\-------------------------------------------------------------------------*/

private const ID_РЕФЕРЕНСА_ДОКУМЕНТОВ_ОПЛАТЫ_ПРОЦЕНТОВ = 125;


private macro GenMyReference( numDoc:@string  )
var
  RefID = 0;

  numDoc = "";
  if( (GetReferenceIDByType( 649 /*OBJTYPE_PERCENT*/, 1, RefID ) == 0) AND (RefID != 0))
      GenerateReference(RefID, numDoc);
  end;
end;

/*--------------------------------------------------------------------------\
|Выполняет формирование операционного документа на оплату процентов или пени|
\--------------------------------------------------------------------------*/
macro СделатьДокумент( Вид, СчетПроцентов, Тип  )
/*   if( Вид == ОПЛАТА_ПРОЦЕНТОВ )
      Документ.Ground = "Оплата процентов";
   else
      Документ.Ground = "Оплата пени";
   end;
*/
   file   ДоговорX( crdcontr );

   var НомерДокумента = "";
   setbuff( СчетПр, СчетПроцентов );

   if( СчетПр.GraphType != ТипГрафикаЕжедневный )
      if( Вид == ОПЛАТА_ПРОЦЕНТОВ )
        if( Тип == ПОВТОРНАЯ_ПРОВОДКА )
          if(( СчетПр.objectType == 1) or (СчетПр.objectType == 2 )) /*тип счета - договор*/
            ДоговорX.szContractNumber = СчетПр.account;
            if( GetEQ( ДоговорX ))
              Документ.Account_Payer = ДоговорX.snrExpPercentAccount;
              GetString( Документ.Account_Receiver,"Счет прибылей будущих периодов: ",25);
            else
              MsgBox( "Договор N" + СчетПр.account + " не найден.");
              return false;
            end;
          end;
        end;
      end;
   else
      Документ.UserField1   = СчетПр.AutoKey;
      Документ.Account_Payer = СчетПр.PayerAccount;
      Документ.Account_Receiver = СчетПр.PercReceiverAccount;
   end;

   GenMyReference(@НомерДокумента);
   Документ.Numb_Document = НомерДокумента;

   return true;
end;
