/*
$Name:        ws_checptter.mac
$Module:      Главная книга
$Description: Макрос конвейера проверки субъектов на терроризм
*/


Import FMInter, PTInter, RSD, "serviceaction.mac";
private const OBJTYPE_PARTY = 3;

private var ParmTaskID     = 0;   
private var ParmExecID     = 0;   
private var ParmConvTypeID = 0;
private var ParmPackID     = 0;   
private var ParmPartyID    = 0;  

private macro GetCnvSelectParms(ExecID, ConvTypeID )
  var GenObj;
  var RetObj;
  var Xml = "";

  var List = 0;

  var query:string =  "SELECT to_char(T_PARAMS) FROM DCNVEXECCNV_DBT WHERE T_EXECID = ? AND T_CONVTYPEID = ?";

  var cmd = RSDCommand( query );
  cmd.addParam( "", RSDBP_IN, ExecID );
  cmd.addParam( "", RSDBP_IN, ConvTypeID );
  var rs = RsdRecordset( cmd );

  if( rs and rs.moveNext() )
    Xml = ( rs.value(0) );
  end;

  if(ConvertToRSL(Xml, GenObj) == 0)
    RetObj = GenObj;
  end;

  return RetObj;
end;

macro MassCheckPartyTerror(TaskID, ExecID, ConvTypeID, OperationID, PackID, Params)

  var fmchptconvexec = TbFile("fm_chptconvexec.dbt", "W");
  var sqlString, cmd;
  var Retval = true;

  var CheckTerr = "X";
  var SkipCheckedTerr = "";
               
  var CheckAddr = "";     
  var SkipCheckedAddr = "";

  var iProp = GenPropID( Params, "CheckTerr" );
  if( iProp != -1 )
    if(Params.CheckTerr == 88)
      CheckTerr = "X";
    end;
  end;

  iProp = GenPropID( Params, "SkipCheckedTerr" );
  if( iProp != -1 )
    if(Params.SkipCheckedTerr == 88)
      SkipCheckedTerr = "X";
    end;
  end;

  iProp = GenPropID( Params, "CheckAddr" );
  if( iProp != -1 )
    if(Params.CheckAddr == 88)
      CheckAddr = "X";
    end;
  end;

  iProp = GenPropID( Params, "SkipCheckedAddr" );
  if( iProp != -1 )
    if(Params.SkipCheckedAddr == 88)
      SkipCheckedAddr  = "X";
    end;
  end;


  if(Params.List == NULL )
    var SelParams = GetCnvSelectParms(ExecID, ConvTypeID );

    iProp = GenPropID( SelParams, "CheckTerr" );
    if( iProp != -1 )
      if(SelParams.CheckTerr == 88)
        CheckTerr = "X";
      else
        CheckTerr = "";
      end;
    end;

    iProp = GenPropID( SelParams, "SkipCheckedTerr" );
    if( iProp != -1 )
      if(SelParams.SkipCheckedTerr == 88)
        SkipCheckedTerr = "X";
      else
        SkipCheckedTerr = "";
      end;
    end;

    iProp = GenPropID( SelParams, "CheckAddr" );
    if( iProp != -1 )
      if(SelParams.CheckAddr == 88)
        CheckAddr = "X";
      else
        CheckAddr = "";
      end;
    end;

    iProp = GenPropID( SelParams, "SkipCheckedAddr" );
    if( iProp != -1 )
      if(SelParams.SkipCheckedAddr == 88)
        SkipCheckedAddr  = "X";
      else
        SkipCheckedAddr  = "";
      end;
    end;
  end;

  if(Params.DateUpdate == NULL)
    Params.DateUpdate = date(0,0,0);
  end;

  if(Params.DateInsert == NULL)
    Params.DateInsert = date(0,0,0);
  end;

  if(Params.DateDelete == NULL)
    Params.DateDelete = date(0,0,0);
  end;

  var AddCond = "t_partyid IN (" + 
                " SELECT t_objectid " +
                "   FROM dcnvdoc_dbt " +
                "  WHERE t_execid = " + execID + 
                "    AND t_convtypeid = " + convTypeID +
                "    AND t_packid =  " + PackID +
                "    AND t_objecttype = "+ OBJTYPE_PARTY +
                " )";



  var FileParty = TbFile("party.dbt", "R");

  FileParty.AddFilter(AddCond);

  var stat = FileParty.getGE();
  while( stat AND Retval )
    ParmTaskID     = TaskID; 
    ParmExecID     = ExecID; 
    ParmConvTypeID = ConvTypeID; 
    ParmPackID     = PackID;
    ParmPartyID    = FileParty.rec.PartyID;
    
    Retval = FM_CheckPartyConv( FileParty, Params.List, Params.TerrorPercent, Params.DateUpdate, Params.DateInsert, Params.DateDelete, "SetPositiveResult", CheckTerr, CheckAddr, SkipCheckedTerr, SkipCheckedAddr);

    fmchptconvexec.Clear();
    fmchptconvexec.rec.TaskID     = TaskID;               
    fmchptconvexec.rec.ExecID     = ExecID;               
    fmchptconvexec.rec.ConvTypeID = ConvTypeID;           
    fmchptconvexec.rec.PackID     = PackID;               
    fmchptconvexec.rec.PartyID    = FileParty.rec.PartyID;

    fmchptconvexec.Insert();

    stat = FileParty.next();
  end;

  FileParty.DropFilter();

  sqlString = "UPDATE dcnvpack_dbt SET T_STATE = T_STATE + 1 WHERE T_EXECID = ? AND T_CONVTYPEID = ? AND T_PACKID = ?";

  cmd = RSDCommand( sqlString );
//  cmd.addParam( "", RSDBP_IN, 102 );
  cmd.addParam( "", RSDBP_IN, ExecID );
  cmd.addParam( "", RSDBP_IN, ConvTypeID );
  cmd.addParam( "", RSDBP_IN, PackID );

  cmd.Execute();

  return 0;
end;

macro SetPositiveResult(RecConv)
  var fmchptconv = TbFile("fm_chptconv.dbt", "W");
  record chptconvRec("fm_chptconv.dbt");
  var RetVal = true;
  var err;

  SetBuff(chptconvRec,RecConv);
  Copy(fmchptconv, chptconvRec);

  fmchptconv.rec.TaskID     = ParmTaskID    ;
  fmchptconv.rec.ExecID     = ParmExecID    ;
  fmchptconv.rec.ConvTypeID = ParmConvTypeID;
  fmchptconv.rec.PackID     = ParmPackID    ;
  fmchptconv.rec.PartyID    = ParmPartyID   ;
  fmchptconv.rec.PtCode     = ПолучитьКодСубъекта( ParmPartyID, PTCK_CONTR, err );
  if(err)
    fmchptconv.rec.PtCode = "";
  end;

  RetVal = fmchptconv.Insert();

  return RetVal;
end;

