/*
$Name:        biljrprn1.mac
$Module:      Бухгалтерия банка 
$Description: Макрос печати журнала
*/


import "or_rep_h.mac", globals, "CbReport_h.mac";
Import oralib, rsexts, PTInter, BilFacturaInter;
import BankInter;

private Var Direction;
private Var JournalID;
private Var Dolz_1;
private Var FIO_1;
private Var PrnDepartment = 0;
private Var BeginDate     : DATE;
private Var EndDate       : DATE;
private Var NumStr        = 1;
private Var FPrintHead     = true;
private Var FPrintBottom   = true;
                                                       
private FILE BILSFJOURNAL ("bilsfjournal.dbt");
private FILE FININSER     ("fininstr.dbt") KEY 0;
private VAR  SfJournal = BILSFJOURNAL;
private VAR  acssql_query:string= "" ;
private VAR  acssql_from:string = "";


PRIVATE MACRO GetPeriod(dt1:date, dt2:date, year: integer)
  var day1, mon1, year1;
  var day2, mon2, year2;
  datesplit(dt1, day1, mon1, year1);  
  datesplit(dt2, day2, mon2, year2);  

  if(year1 != year2)
    return "";
  end;

  SetParm(2, year1);

  if(mon1 == mon2)
    return MonName(mon1);
  end;
   
  if((mon1<=3) AND (mon2<=3))
    return "I - квартал";
  end; 

  if((mon1>=4) AND (mon2>=4) AND (mon1<=6) AND (mon2<=6))
    return "II - квартал";
  end; 

  if((mon1>=7) AND (mon2>=7) AND (mon1<=9) AND (mon2<=9) )
    return "III - квартал";
  end; 

  if((mon1>=10) AND (mon2>=10) AND (mon1<=12) AND (mon2<=12) )
    return "IV - квартал";
  end; 

  return "";
END;

PRIVATE MACRO GetNoNDSSign( FacturaID )
  var rs;
  var sqlString = "SELECT DISTINCT(T_NDSRATE) FROM DBILFACTURALINE_DBT WHERE T_FACTURAID = " + string(FacturaID) +" ORDER BY T_NDSRATE";
  var NDSRate = 0;
  var RetVal = false;

  rs = RsdRecordset( sqlString );

  while(rs.moveNext())
    NDSRate = rs.value(0);
    if(NDSRate == -1)
      RetVal = true;
    else
      RetVal = false;
    end;
  end;

  return RetVal;
END;

PRIVATE MACRO GetCompresNameCurrency( iCode )
  FININSER.FIID = iCode;
  if( getEQ( FININSER ) )    return  FININSER.Ccy;
  else                          return  string(iCode);
  end;
end;

PRIVATE CLASS (CB_CReportTemplate) Sf_DistrReport

  var NumTableStr = 0; 

  var BeginHeadNum =1; // начало шапки
  var EndHeadNum   =8; // конец шапки
  
  var BeginBottomNum =16; // начало подписей
  var EndBottomNum   =25; // конец подписей 



  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

   PRIVATE MACRO PrintHead( IsNotEmpty : bool)
    var date1, date2, sqlString, rs, count, i, period = "", strPeriod = "", year = 0;
    record Party(party);
    var tmpr;
    if(IsNotEmpty == true)

      date1 = SfJournal.OpenDate;
      if(SfJournal.CloseDate == date(0,0,0))
        date2 = {CurDate};
      else     
        date2 = SfJournal.CloseDate;
      end;

      ПолучитьСубъекта ({OurBank}, Party ); 

      period = GetPeriod(date1, date2, year );

      if((period == NULL) OR (period == ""))
        strPeriod = "за период с " + string(date1) + " по " + string(date2);
      else
        strPeriod = "за "+ period + " " + year + " года";
      end;

      PrintFormatString( NULL,
                       "JNum"        , "ЖУРНАЛ УЧЕТА ПОЛУЧЕННЫХ И ВЫСТАВЛЕННЫХ СЧЕТОВ-ФАКТУР",
                       "RecNameTitle", "Наименование налогоплательщика",
                       "ReceiverName", Party.Name,
                       "ReceINNTitle", "ИНН/КПП налогоплательщика",
                       "ReceiverINN" , ПолучитьКодСубъекта( {OurBank}, PTCK_INN ), 
                       "DateP"       , strPeriod
                     );
   else
      PrintFormatString( NULL,
                       "JNum"        , "",
                       "RecNameTitle", "",
                       "ReceiverName", "",
                       "ReceINNTitle", "",
                       "ReceiverINN" , "", 
                       "DateP"       , ""
                     );


      DeleteRow(BeginHeadNum, EndHeadNum);
   end;

 END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
   NumTableStr = 0; 
   SetActiveSheet( "jrd" );
  
   SetNumberPage("Страница ", NumStr);

   PrintHead(FPrintHead);

   RegisterTable( "N1_MainTable", NULL,
                  "NN"                ,
                  "CDate"             ,
                  "Mode_Code"         ,
                  "Oper_Code"         ,
                  "CNumberSrc"        ,
                  "CDateSrc"          ,
                  "CNumberFc"         , 
                  "CDateFc"           ,  
                  "Cnumber_Corr"      ,
                  "Cdate_Corr"        ,
                  "CReceiverName"     ,
                  "CReceiverINN"      ,
                  "Valuta_NC"         ,
                  "TotalWithNDS"      ,
                  "TotalNDS"          ,
                  "MSumma_All"        ,
                  "PSumma_All"        ,
                  "MSumma_NDS"        ,
                  "PSumma_NDS"      
                );

  END;

  PRIVATE MACRO EndReport()
    var RowFrom = 0, RowTo = 0;  
    EndTable();
    if(FPrintBottom == true)
      PrintFormatString( NULL,
                        "Dolz" , Dolz_1,  
                        "FIO" , FIO_1
                         );
    else
      RowFrom = BeginBottomNum + NumTableStr;
      RowTo   = EndBottomNum + NumTableStr;

      if(FPrintHead == false)
        RowFrom = RowFrom - (EndHeadNum - BeginHeadNum + 1);
        RowTo   = RowTo   - (EndHeadNum - BeginHeadNum + 1);
      end;

      DeleteRow(RowFrom, RowTo);
    end;
   
  END;

                                                                  
  PRIVATE MACRO PrintLine( NN, CDate, Mode_Code, Oper_Code, CNumberSrc, CDateSrc, CNumberFc, CDateFc, Cnumber_Corr, Cdate_Corr, CReceiverName, CReceiverINN, Valuta_NC, TotalWithNDS, TotalNDS, MSumma_All, PSumma_All, MSumma_NDS, PSumma_NDS )

     PrintTableLine( "NN"           ,  NN           ,  null,
                     "CDate"        ,  CDate        ,  null,
                     "Mode_Code"    ,  Mode_Code    ,  null,
                     "Oper_Code"    ,  Oper_Code    ,  null,
                     "CNumberSrc"   ,  CNumberSrc   ,  null,
                     "CDateSrc"     ,  CDateSrc     ,  null,
                     "CNumberFc"    ,  CNumberFc    ,  null,
                     "CDateFc"      ,  CDateFc      ,  null,
                     "Cnumber_Corr" ,  Cnumber_Corr ,  null,
                     "Cdate_Corr"   ,  Cdate_Corr   ,  null,
                     "CReceiverName",  CReceiverName,  null,
                     "CReceiverINN" ,  CReceiverINN ,  null,
                     "Valuta_NC"    ,  Valuta_NC    ,  null,
                     "TotalWithNDS" ,  TotalWithNDS ,  null,
                     "TotalNDS"     ,  TotalNDS     ,  null,
                     "MSumma_All"   ,  MSumma_All   ,  null,
                     "PSumma_All"   ,  PSumma_All   ,  null,
                     "MSumma_NDS"   ,  MSumma_NDS   ,  null,
                     "PSumma_NDS"   ,  PSumma_NDS   ,  null
                   );                                       

  END;


  PRIVATE MACRO PrintFacturaDistrWR( rs : RsdRecordset, NN : @integer )
    FILE bilfactura("bilfactura.dbt") key 4;
    FILE bilfacturaSecond("bilfactura.dbt") key 4;

    var CDate, Mode_Code, Oper_Code, CNumberSrc, CDateSrc, CNumber, CDateFc, Cnumber_Corr, Cdate_Corr, CReceiverName, CReceiverINN, Valuta_NC, TotalWithNDS, TotalNDS, MSumma_All, PSumma_All, MSumma_NDS, PSumma_NDS;
    var IsNoDistrib = "", Assignment = 0, FacturaID = 0; 
    var SrcFacturaNumber : string;
    var SrcCDate         : date;
    var num, IsSrcFacturaNumberNULL, IsSrcCDateNULL;
    var modifyRecord:bool = false; 
    // BILFACTURA

    var TotalAmount ;
    var InBook      ;
    var FIC         ;
    var FIID        ; 
    rs.value("SrcFacturaNumber", IsSrcFacturaNumberNULL);
    rs.value("SrcCreationDate" , IsSrcCDateNULL        );


    Mode_Code = "1";
    Oper_Code = "";
    Cnumber_Corr = ""; 
    Cdate_Corr   = date(0,0,0);


    IsNoDistrib  = rs.value("T_ISNODISTRIB");
    Assignment   = rs.value("T_ASSIGNMENT" );

    FacturaID    = rs.value("T_FACTURAID" );

    if(IsNoDistrib == "X")
      CDate        = "";
    else
      CDate        = date(rs.value("T_CREATIONDATE"));
    end;

    //Для остальных
    CDateSrc    = date(rs.value("t_CreationDate"));  
    CNumberSrc  = rs.value("t_FacturaNumber");   
    CNumber = "";

    var SFacturaID = 0;                                
    if(Assignment == OBJSFASSIGNMENT_MODIFY) // Исправление 
      bilfactura.facturaID = rs.value("srcFacturaID");
      if(getEQ(bilfactura))
        if(bilfactura.Assignment == OBJSFASSIGNMENT_RECALC)
          modifyRecord = true;    
          SFacturaID = bilfactura.facturaID;
        end;  
      end;                                     
    end; 

    if((Assignment == OBJSFASSIGNMENT_RECALC) AND (modifyRecord))
      SFacturaID = FacturaID;
    elif(Assignment == OBJSFASSIGNMENT_RECALC) // Пересчет
      SFacturaID = FacturaID;
      
      if(rs.value("srcCorrectionNum") == 0)
        CDate     = date(rs.value("t_CreationDate"));
      end;                                  
    end;

    if(SFacturaID > 0) 
       var sString = " SELECT fc.t_FacturaNumber, fc.t_CreationDate  FROM DBILFACTURASOURCE_DBT fs, DBILFACTURA_DBT fc  " +
                   "  WHERE fs.T_FACTURAID = "+ SFacturaID + 
                   "    AND fc.T_FACTURAID =  fs.T_SOURCEFACTURAID"
                   " ORDER BY fc.t_CreationDate ";

       var scmd = RsdCommand( sString );
       scmd.NullConversion = true;
       var srs = RsdRecordset( scmd );

       CNumberSrc = "";
       CDateSrc =""; 

       while( srs.moveNext() )
         if(CNumberSrc != "")
           CNumberSrc = CNumberSrc + ", ";
           CDateSrc = CDateSrc + ", ";
         end;
         CNumberSrc = CNumberSrc + srs.value("t_FacturaNumber");       
         CDateSrc = CDateSrc  + string(date(srs.value("t_CreationDate")));        
       end;
    end;


    if(rs.value("SrcCorrectionNum"))
      CNumber_Corr  = rs.value("SrcCorrectionNum");
      CDate_Corr    = date(rs.value("SrcCreationDate"));
    elif(rs.value("CorrectionNum"))
      CNumber_Corr  = rs.value("CorrectionNum");
      CDate_Corr    = date(rs.value("t_CreationDate"));
    else
      CDate_Corr    = CNumber_Corr = "";
    end;

    CReceiverName = rs.value("T_RECEIVERNAME");
    CReceiverINN  = rs.value("T_RECEIVERINN" );

    if(Assignment == 5) // Пересчет
      TotalWithNDS = "";
      TotalNDS     = "";

      if(rs.value("T_TOTALWITHNDS") > $0 )
        PSumma_All = string(rs.value("T_TOTALWITHNDS"));
        MSumma_All = "";
      else
        PSumma_All = "";
        MSumma_All = string(-rs.value("T_TOTALWITHNDS"));
      end;   

      if(rs.value("T_TOTALNDS") > $0 )  
        if(rs.value("t_IsNoNds") == "X")
          PSumma_NDS = "без НДС";
        else
          PSumma_NDS = string(rs.value("T_TOTALNDS"));
        end;

        MSumma_NDS = "";
      else
        PSumma_NDS = "";

        if(rs.value("t_IsNoNds") == "X")
          MSumma_NDS = "без НДС";
        else
          MSumma_NDS = string(-rs.value("T_TOTALNDS"));
        end;
      end;     
    else
      TotalWithNDS = string(rs.value("T_TOTALWITHNDS"));
      if(rs.value("t_IsNoNds") == "X")
        TotalNDS     = "без НДС";
      else
        TotalNDS     = string(rs.value("T_TOTALNDS"));
      end;
    end;

    Valuta_NC = rs.value("FiName");

var sqlString = "SELECT DISTINCT BILOPRCODE.T_CODE FROM DBILOPRCODE_DBT BILOPRCODE, DBILFACTURALINE_DBT BILFACTURALINE WHERE BILFACTURALINE.T_FACTURAID = " + FacturaId;
    sqlString = sqlString + " AND BILOPRCODE.T_ID = BILFACTURALINE.T_OPRCODEID ORDER BY BILOPRCODE.T_CODE ASC";

    var coders = RsdRecordset(sqlString);

    Oper_Code = "";

    while(coders.moveNext())
        if(Oper_Code == "")
                Oper_Code = coders.value("T_CODE");
        else
                Oper_Code = Oper_Code + ", " + coders.value("T_CODE");
        end;
    end;

    PrintLine( NN, CDate, Mode_Code, Oper_Code, CNumberSrc, CDateSrc, CNumber, CDateFc, Cnumber_Corr, Cdate_Corr, CReceiverName, CReceiverINN, Valuta_NC, TotalWithNDS, TotalNDS, MSumma_All, PSumma_All, MSumma_NDS, PSumma_NDS  );
  END;



  PRIVATE MACRO Create()
    var date1, date2, sqlString, rs, count, i;
    record Party(party);

    var EmptyStr = "                                                                                                   ";

    date1 = BeginDate;
    date2 = EndDate  ;

    sqlString = "SELECT COUNT(1) FROM DBILFACTURA_DBT BILFACTURA "+acssql_from+ " WHERE BILFACTURA.T_REGDATE BETWEEN to_date('" + date1 +
     "', 'dd.mm.yyyy') AND to_date( '"+ date2 +"', 'dd.mm.yyyy') AND BILFACTURA.T_DIRECTION = "+ Direction + 
     " AND " + acssql_query ;

    if(PrnDepartment != 0)
        sqlString = sqlString + " AND BILFACTURA.T_DEPARTMENT = " + PrnDepartment;
    end;

    rs = RsdRecordset( sqlString );

    rs.moveNext();

    count = rs.value(0);

    if( count == 0 )

    else
    
       sqlString = " SELECT BILFACTURA.T_FACTURAID, BILFACTURA.T_ISNONDS, BILFACTURA.T_CREATIONDATE, BILFACTURA.T_FACTURANUMBER, BILFACTURA.T_RECEIVERNAME, BILFACTURA.T_RECEIVERINN, BILFACTURA.T_TOTALAMOUNT, BILFACTURA.T_TOTALNDS, BILFACTURA.T_TOTALWITHNDS, BILFACTURA.T_ISNODISTRIB, BILFACTURA.T_ASSIGNMENT, FI.T_NAME || ', ' || FI.T_ISO_NUMBER AS FiName, BILFACTURA.T_FIID, "
                   " BILFACTURA.t_correctionnum as CorrectionNum, NVL(BFSRC.t_assignment, 0) as SrcFacturaAssignment, NVL(BFSRC.t_CorrectionNum, 0) as srcCorrectionNum, NVL(BFSRC.t_FacturaNumber, '') AS SrcFacturaNumber, NVL(BFSRC.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) AS SrcCreationDate, NVL(BFSRC.t_FacturaID, 0) as SrcFacturaID "
                   " FROM DBILFACTURA_DBT BILFACTURA, DBILFACTURA_DBT BFSRC, DFININSTR_DBT FI, DBILSFTYPE_DBT FT  ";
       sqlString = sqlString + acssql_from + 
                   " WHERE BILFACTURA.T_REGDATE BETWEEN to_date( '"+date1+"', 'dd.mm.yyyy') AND to_date( '"+date2+"', 'dd.mm.yyyy')" +
                   " AND BILFACTURA.T_DIRECTION = "+ Direction +
                   " AND BILFACTURA.T_SOURCEFACTURAID = BFSRC.T_FACTURAID(+) "+
                   " AND BILFACTURA.T_FIID = FI.T_FIID(+) " +
                   " AND BILFACTURA.T_SFTYPEID = FT.T_SFTYPEID " +
                   " AND FT.T_POSTTOJOURNAL = 'X' " +
                   " AND " + acssql_query ;         
       if(PrnDepartment != 0)
           sqlString = sqlString + " AND BILFACTURA.T_DEPARTMENT = " + PrnDepartment;
       end;

       sqlString = sqlString + " ORDER BY BILFACTURA.T_REGDATE, BILFACTURA.T_FACTURANUMBER ";

       var cmd = RsdCommand( sqlString );
       cmd.NullConversion = true;
     
       rs = RsdRecordset( cmd ); 

       i = 1;
       while( rs.moveNext() )
         PrintFacturaDistrWR( rs, i );
         i = i + 1;
       end;

       NumTableStr = i-1; 
     end;


  END;

  initCB_CReportTemplate( null, "biljrddot1.xls" );
END;

/*-----------------------------------------------------------------------------------*/
PRIVATE CLASS (CB_CReportTemplate) Sf_ObtReport

  var NumTableStr = 0; 

  var BeginHeadNum =1; // начало шапки
  var EndHeadNum   =8; // конец шапки
  
  var BeginBottomNum =16; // начало подписей
  var EndBottomNum   =25; // конец подписей 



  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

   PRIVATE MACRO PrintHead( IsNotEmpty : bool)
    var date1, date2, sqlString, rs, count, i, period = "", strPeriod = "", year = 0;
    record Party(party);
    var tmpr;
    if(IsNotEmpty == true)

      date1 = SfJournal.OpenDate;
      if(SfJournal.CloseDate == date(0,0,0))
        date2 = {CurDate};
      else     
        date2 = SfJournal.CloseDate;
      end;

      ПолучитьСубъекта ({OurBank}, Party ); 

      period = GetPeriod(date1, date2, year );

      if((period == NULL) OR (period == ""))
        strPeriod = "за период с "+string(date1) + " по "+string(date2);
      else
        strPeriod = "за "+ period + " " + year + " года";
      end;

      PrintFormatString( NULL,
                       "JNum"        , "ЖУРНАЛ УЧЕТА ПОЛУЧЕННЫХ И ВЫСТАВЛЕННЫХ СЧЕТОВ-ФАКТУР",
                       "RecNameTitle", "Наименование налогоплательщика",
                       "ReceiverName", Party.Name,
                       "ReceINNTitle", "ИНН/КПП налогоплательщика",
                       "ReceiverINN" , ПолучитьКодСубъекта( {OurBank}, PTCK_INN ), 
                       "DateP"       , strPeriod
                     );
   else
      PrintFormatString( NULL,
                       "JNum"        , "",
                       "RecNameTitle", "",
                       "ReceiverName", "",
                       "ReceINNTitle", "",
                       "ReceiverINN" , "", 
                       "DateP"       , ""
                     );


      DeleteRow(BeginHeadNum, EndHeadNum);
   end;

 END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    NumTableStr = 0; 
    SetActiveSheet( "jro" );
   
    SetNumberPage("Страница ", NumStr);

    PrintHead(FPrintHead);

    RegisterTable( "N1_MainTable", NULL,
                   "NN"                ,
                   "CDate"             ,
                   "Mode_Code"         ,
                   "Oper_Code"         ,
                   "CNumberSrc"        ,
                   "CDateSrc"          ,
                   "CNumberFc"         , 
                   "CDateFc"           ,  
                   "Cnumber_Corr"      ,
                   "Cdate_Corr"        ,
                   "CReceiverName"     ,
                   "CReceiverINN"      ,
                   "Valuta_NC"         ,
                   "TotalWithNDS"      ,
                   "TotalNDS"          ,
                   "MSumma_All"        ,
                   "PSumma_All"        ,
                   "MSumma_NDS"        ,
                   "PSumma_NDS"      
                 );

  END;

  PRIVATE MACRO EndReport()
    var RowFrom = 0, RowTo = 0;  
    EndTable();
    if(FPrintBottom == true)
      PrintFormatString( NULL,
                        "Dolz" , Dolz_1,  
                        "FIO" , FIO_1
                         );
    else
      RowFrom = BeginBottomNum + NumTableStr;
      RowTo   = EndBottomNum + NumTableStr;

      if(FPrintHead == false)
        RowFrom = RowFrom - (EndHeadNum - BeginHeadNum + 1);
        RowTo   = RowTo   - (EndHeadNum - BeginHeadNum + 1);
      end;

      DeleteRow(RowFrom, RowTo);
    end;
   
  END;

                                                                  
  PRIVATE MACRO PrintLine( NN, CDate, Mode_Code, Oper_Code, CNumberSrc, CDateSrc, CNumberFc, CDateFc, Cnumber_Corr, Cdate_Corr, CReceiverName, CReceiverINN, Valuta_NC, TotalWithNDS, TotalNDS, MSumma_All, PSumma_All, MSumma_NDS, PSumma_NDS )

     PrintTableLine( "NN"           ,  NN           ,  null,
                     "CDate"        ,  CDate        ,  null,
                     "Mode_Code"    ,  Mode_Code    ,  null,
                     "Oper_Code"    ,  Oper_Code    ,  null,
                     "CNumberSrc"   ,  CNumberSrc   ,  null,
                     "CDateSrc"     ,  CDateSrc     ,  null,
                     "CNumberFc"    ,  CNumberFc    ,  null,
                     "CDateFc"      ,  CDateFc      ,  null,
                     "Cnumber_Corr" ,  Cnumber_Corr ,  null,
                     "Cdate_Corr"   ,  Cdate_Corr   ,  null,
                     "CReceiverName",  CReceiverName,  null,
                     "CReceiverINN" ,  CReceiverINN ,  null,
                     "Valuta_NC"    ,  Valuta_NC    ,  null,
                     "TotalWithNDS" ,  TotalWithNDS ,  null,
                     "TotalNDS"     ,  TotalNDS     ,  null,
                     "MSumma_All"   ,  MSumma_All   ,  null,
                     "PSumma_All"   ,  PSumma_All   ,  null,
                     "MSumma_NDS"   ,  MSumma_NDS   ,  null,
                     "PSumma_NDS"   ,  PSumma_NDS   ,  null
                   );                                       

  END;


  PRIVATE MACRO PrintFacturaObtWR( rs : RsdRecordset, NN : @integer )

    FILE bilfactura("bilfactura.dbt") key 4;
    FILE bilfacturaSecond("bilfactura.dbt") key 4;
                                
    var CDate, Mode_Code, Oper_Code, CNumberSrc, CDateSrc, CNumber, CDateFc, Cnumber_Corr, Cdate_Corr, CReceiverName, CReceiverINN, Valuta_NC, TotalWithNDS, TotalNDS, MSumma_All, PSumma_All, MSumma_NDS, PSumma_NDS;
    var IsNoDistrib = "", Assignment = 0, FacturaID = 0; 
    var SrcFacturaNumber : string;
    var SrcCDate         : date;
    var num, i, IsSrcFacturaNumberNULL, IsSrcCDateNULL; 
    var modifyRecord:bool = false; 
    // BILFACTURA

    var TotalAmount ;
    var InBook      ;
    var FIC         ;
    var FIID        ; 
    rs.value("SrcFacturaNumber", IsSrcFacturaNumberNULL);
    rs.value("SrcCreationDate" , IsSrcCDateNULL        );


    Mode_Code = "1";
    Oper_Code = "";
    Cnumber_Corr = ""; 
    Cdate_Corr   = date(0,0,0);


    IsNoDistrib  = rs.value("T_ISNODISTRIB");
    Assignment   = rs.value("T_ASSIGNMENT" );

    FacturaID    = rs.value("T_FACTURAID" );

    if(IsNoDistrib == "X")
      CDate        = "";
    else
      CDate        = date(rs.value("T_ACQUISITIONDATE"));
    end;

    CDateSrc    = date(rs.value("t_CreationDate"));  
    CNumberSrc  = rs.value("t_FacturaNumber");   
    CNumber = "";
                                    
    var SFacturaID = 0;                                
    if(Assignment == OBJSFASSIGNMENT_MODIFY) // Исправление 
      bilfactura.facturaID = rs.value("srcFacturaID");
      if(getEQ(bilfactura))
        if(bilfactura.Assignment == OBJSFASSIGNMENT_RECALC)
          modifyRecord = true;    
          SFacturaID = bilfactura.facturaID;
        end;  
      end;                                     
    end; 

    if((Assignment == OBJSFASSIGNMENT_RECALC) AND (modifyRecord))
      SFacturaID = FacturaID;
    elif(Assignment == OBJSFASSIGNMENT_RECALC) // Пересчет
      SFacturaID = FacturaID;
      
      if(rs.value("srcCorrectionNum") == 0)
        CDate     = date(rs.value("t_CreationDate"));
      end;                                  
    end;

    if(SFacturaID > 0) 
       var sString = " SELECT fc.t_FacturaNumber, fc.t_CreationDate  FROM DBILFACTURASOURCE_DBT fs, DBILFACTURA_DBT fc  " +
                   "  WHERE fs.T_FACTURAID = "+ SFacturaID + 
                   "    AND fc.T_FACTURAID =  fs.T_SOURCEFACTURAID"
                   " ORDER BY fc.t_CreationDate ";

       var scmd = RsdCommand( sString );
       scmd.NullConversion = true;
       var srs = RsdRecordset( scmd );

       CNumberSrc = "";
       CDateSrc =""; 

       while( srs.moveNext() )
         if(CNumberSrc != "")
           CNumberSrc = CNumberSrc + ", ";
           CDateSrc = CDateSrc + ", ";
         end;
         CNumberSrc = CNumberSrc + srs.value("t_FacturaNumber");       
         CDateSrc = CDateSrc  + string(date(srs.value("t_CreationDate")));        
       end;
    end;


    if(rs.value("SrcCorrectionNum"))
      CNumber_Corr  = rs.value("SrcCorrectionNum");
      CDate_Corr    = date(rs.value("SrcCreationDate"));
    elif(rs.value("CorrectionNum"))
      CNumber_Corr  = rs.value("CorrectionNum");
      CDate_Corr    = date(rs.value("t_CreationDate"));
    else
      CDate_Corr    = CNumber_Corr = "";
    end;

    CReceiverName = rs.value("T_SUPPLIERNAME"  );
    CReceiverINN  = rs.value("T_SUPPLIERINN"   );

    if(Assignment == 5) // Пересчет для НДС(еще один if, что б не путаться)
      TotalWithNDS = "";
      TotalNDS     = "";

      if(rs.value("T_TOTALWITHNDS") > $0 )
        PSumma_All = string(rs.value("T_TOTALWITHNDS"));
        MSumma_All = "";
      else
        PSumma_All = "";
        MSumma_All = string(-rs.value("T_TOTALWITHNDS"));
      end;   

      if(rs.value("T_TOTALNDS") > $0 )  
        if(rs.value("t_IsNoNds") == "X")
          PSumma_NDS = "без НДС";
        else
          PSumma_NDS = string(rs.value("T_TOTALNDS"));
        end;

        MSumma_NDS = "";
      else
        PSumma_NDS = "";

        if(rs.value("t_IsNoNds") == "X")
          MSumma_NDS = "без НДС";
        else
          MSumma_NDS = string(-rs.value("T_TOTALNDS"));
        end;
      end;   
    else      
      TotalWithNDS = string(rs.value("T_TOTALWITHNDS"));
      if(rs.value("t_IsNoNds") == "X")
        TotalNDS     = "без НДС";
      else
        TotalNDS     = string(rs.value("T_TOTALNDS"));
      end;
    end;

var sqlString = "SELECT DISTINCT BILOPRCODE.T_CODE FROM DBILOPRCODE_DBT BILOPRCODE, DBILFACTURALINE_DBT BILFACTURALINE WHERE BILFACTURALINE.T_FACTURAID = " + FacturaId;
    sqlString = sqlString + " AND BILOPRCODE.T_ID = BILFACTURALINE.T_OPRCODEID ORDER BY BILOPRCODE.T_CODE ASC";

    var coders = RsdRecordset(sqlString);

    Oper_Code = "";


    while(coders.moveNext())
        if(Oper_Code == "")
                Oper_Code = coders.value("T_CODE");
        else
                Oper_Code = Oper_Code + ", " + coders.value("T_CODE");
        end;
    end;

    Valuta_NC = rs.value("FiName");

    PrintLine( NN, CDate, Mode_Code, Oper_Code, CNumberSrc, CDateSrc, CNumber, CDateFc, Cnumber_Corr, Cdate_Corr, CReceiverName, CReceiverINN, Valuta_NC, TotalWithNDS, TotalNDS, MSumma_All, PSumma_All, MSumma_NDS, PSumma_NDS  );
  END;



  PRIVATE MACRO Create()
    var date1, date2, sqlString, rs, count, i;
    record Party(party);

    var EmptyStr = "                                                                                                   ";

    date1 = BeginDate;
    date2 = EndDate  ;

    sqlString = "SELECT COUNT(1) FROM DBILFACTURA_DBT BILFACTURA "+acssql_from+ " WHERE BILFACTURA.T_REGDATE BETWEEN to_date('" + date1 +
     "', 'dd.mm.yyyy') AND to_date( '"+ date2 +"', 'dd.mm.yyyy') AND BILFACTURA.T_DIRECTION = "+ Direction + 
     " AND " + acssql_query ;

    if(PrnDepartment != 0)
        sqlString = sqlString + " AND BILFACTURA.T_DEPARTMENT = " + PrnDepartment;
    end;

    rs = RsdRecordset( sqlString );

    rs.moveNext();

    count = rs.value(0);

    if( count == 0 )

    else
    
       sqlString = " SELECT BILFACTURA.T_FACTURAID, BILFACTURA.T_ISNONDS, BILFACTURA.T_CREATIONDATE, BILFACTURA.T_ACQUISITIONDATE,  BILFACTURA.T_FACTURANUMBER, BILFACTURA.T_SUPPLIERNAME, BILFACTURA.T_SUPPLIERINN, BILFACTURA.T_TOTALAMOUNT, BILFACTURA.T_TOTALNDS, BILFACTURA.T_TOTALWITHNDS, BILFACTURA.T_ISNODISTRIB, BILFACTURA.T_ASSIGNMENT, FI.T_NAME || ', ' || FI.T_ISO_NUMBER AS FiName, BILFACTURA.T_FIID, "
                   " NVL(BFSRC.t_facturanumber, '') as SrcFacturaNumber, NVL(BILFACTURA.t_correctionNum, 0) as CORRECTIONNUM, NVL(BFSRC.t_CorrectionNum, 0) as srcCorrectionNum, NVL(BFSRC.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) AS SrcCreationDate, NVL(BFSRC.t_FacturaID, 0) as SrcFacturaID "
                   " FROM dbilfactura_dbt bilfactura, DBILFACTURA_DBT BFSRC, DFININSTR_DBT FI, DBILSFTYPE_DBT FT  ";
       sqlString = sqlString + acssql_from + 
                   " WHERE BILFACTURA.T_REGDATE BETWEEN to_date( '"+date1+"', 'dd.mm.yyyy') AND to_date( '"+date2+"', 'dd.mm.yyyy')" +
                   " AND BILFACTURA.T_DIRECTION = "+ Direction +
                   " AND BILFACTURA.T_SOURCEFACTURAID = BFSRC.T_FACTURAID(+) "+
                   " AND BILFACTURA.T_FIID = FI.T_FIID(+) " +
                   " AND BILFACTURA.T_SFTYPEID = FT.T_SFTYPEID " +
                   " AND FT.T_POSTTOJOURNAL = 'X' " +
                   " AND " + acssql_query ;         
       if(PrnDepartment != 0)
           sqlString = sqlString + " AND BILFACTURA.T_DEPARTMENT = " + PrnDepartment;
       end;

       sqlString = sqlString + " ORDER BY BILFACTURA.T_REGDATE, BILFACTURA.T_FACTURANUMBER ";

       rs = RsdRecordset( sqlString );

       i = 1;
       while( rs.moveNext() )
         PrintFacturaObtWR( rs, i );
         i = i + 1;
       end;

       NumTableStr = i-1; 
     end;


  END;

  initCB_CReportTemplate( null, "biljrodot1.xls" );
END;


/*-----------------------------------------------------------------------------------*/
MACRO PrintDocument1( ncopy, pJournalID, pDirection, pDolz_1, pFIO_1, pPrnDepartment, pBeginDate, pEndDate, pNumStr, pFPrintHead, pFPrintBottom ):bool
  Var stat = 0;
  Var NumPage  = 1 ;
  var TempFile;

  JournalID      =  pJournalID;      
  Direction      =  pDirection;   
  Dolz_1         =  pDolz_1;      
  FIO_1          =  pFIO_1;       
  PrnDepartment  =  pPrnDepartment;
  BeginDate      =  pBeginDate;    
  EndDate        =  pEndDate;      
  NumStr         =  pNumStr;       
  FPrintHead     =  pFPrintHead;     
  FPrintBottom   =  pFPrintBottom;


  ClearRecord(BILSFJOURNAL);
  BILSFJOURNAL.JournalID = JournalID;
  if(not GetEQ(BILSFJOURNAL))
    return false;
  end;

  if(GetObjectRestriction(acssql_query, 111, {oper}, "BILFACTURA", CNTX_BilFactura,"BILFACTURA.DBT", acssql_from, true ))
    if(acssql_from != "")
      acssql_from = " , " +acssql_from;
    end;
  
    if(Direction == 1)
        Sf_DistrReport().Run();
    else if(Direction == 2)
        Sf_ObtReport().Run();
    end;
    end;
  end;

  return true;
END;
