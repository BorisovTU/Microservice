/*
 $Name: ResidencyAccordanceMass.mac
 $Module: Ядро ГКБО 
 $Description: Процедура проверки условий соответствия резидентности субъекта
 */
 /*
	Процедура проверки условий соответствия резидентности субъекта
 */
import PTInter, Rsd, BankInter, "ResidencyAccordance.mac";

macro CheckMassResidencyAccordance()
    var chk : ChkRsdntAcc;
    var AllMasks = GetAllMasks();
    chk.ClearTempTable();
    
    var MasksSql = ConvertMaskToSQLFormat(AllMasks, "acc.t_Account");
    
    /*
    Найти и сохранить во временной таблице все открытые счета, 
    которые открыты на балансовом счете второго порядка, 
    у которого в поле "Группа счета? присутствует значение "Н"
    (Счета нерезидентов) и клиенты которых являются резидентами 
    */
    var sql =   "INSERT INTO DCHKRSDNTACC_TMP (";
    sql = sql + "SELECT acc.t_Client, acc.t_Account, CHR (0) t_ForResident ";
    sql = sql + "     FROM daccount_dbt acc, dparty_dbt pt ";
    sql = sql + "     WHERE     acc.t_Open_Close = CHR (0) ";
    sql = sql + "       AND (acc.t_Balance, acc.t_Chapter) IN ";
    sql = sql + "          (SELECT t_Balance, t_Chapter ";
    sql = sql + "             FROM dbalance_dbt ";
    sql = sql + "            WHERE t_Type_Balance LIKE '%Н%') ";
    sql = sql + "       AND pt.t_PartyID = acc.t_Client ";
    sql = sql + "       AND pt.t_NotResident = CHR (0) ";
    sql = sql + ")";
    
    var cmd : RsdCommand = RsdCommand(sql);
    cmd.Execute();
    
    /*
    Найти и сохранить во временной таблице все открытые счета, 
    которые открыты на балансовом счете второго порядка, 
    у которого в поле "Группа счета" отсутствует значение "Н"
    (Счета нерезидентов) и клиенты которых являются нерезидентами 
    */
    sql =   "INSERT INTO DCHKRSDNTACC_TMP (";
    sql = sql + "SELECT acc.t_Client, acc.t_Account, CHR (88) t_ForResident ";
    sql = sql + "    FROM daccount_dbt acc, dparty_dbt pt ";
    sql = sql + "    WHERE     acc.t_Open_Close = CHR (0) ";
    sql = sql + "        AND (acc.t_Balance, acc.t_Chapter) NOT IN ";
    sql = sql + "      (SELECT t_Balance, t_Chapter ";
    sql = sql + "        FROM dbalance_dbt ";
    sql = sql + "        WHERE t_Type_Balance LIKE '%Н%') ";
    sql = sql + "    AND pt.t_PartyID = acc.t_Client ";
    sql = sql + "    AND pt.t_NotResident = CHR (88) ";
    sql = sql + ")";
    cmd.CmdText = sql;
    cmd.Execute();
    
    /*
    Найти и сохранить во временной таблице все открытые счета, 
    номера которых удовлетворяют маске AllMasks и клиенты 
    которых являются резидентами
    */
    sql =   "INSERT INTO DCHKRSDNTACC_TMP (";
    sql = sql + "SELECT acc.t_Client, acc.t_Account, CHR (0) t_ForResident ";
    sql = sql + "    FROM DACCOUNT_DBT ACC, DPARTY_DBT PT";
    sql = sql + "    WHERE     ACC.T_OPEN_CLOSE = CHR (0)";
    sql = sql + "        AND " + MasksSql + " ";
    sql = sql + "      AND PT.T_PARTYID = ACC.T_CLIENT ";
    sql = sql + "        AND PT.T_NOTRESIDENT = CHR (0)";
    sql = sql + ")";
    cmd.CmdText = sql;
    cmd.Execute();
    
    /*
    Найти и сохранить во временной таблице все открытые счета, 
    номера которых не удовлетворяют маске AllMasks и клиенты 
    которых являются нерезидентами
    */
    sql =   "INSERT INTO DCHKRSDNTACC_TMP (";
    sql = sql + "SELECT acc.t_Client, acc.t_Account, CHR (88) t_ForResident ";
    sql = sql + "    FROM DACCOUNT_DBT ACC, DPARTY_DBT PT";
    sql = sql + "    WHERE     ACC.T_OPEN_CLOSE = CHR (0)";
    sql = sql + "        AND NOT" + MasksSql + " ";
    sql = sql + "      AND PT.T_PARTYID = ACC.T_CLIENT ";
    sql = sql + "        AND PT.T_NOTRESIDENT = CHR (88)";
    sql = sql + ")";
    cmd.CmdText = sql;
    cmd.Execute();
    
    PrintResidencyAccordanceReport();
end;

CheckMassResidencyAccordance();