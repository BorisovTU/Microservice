/*
$Name:           estimmass.mac
$Module:         Ядро ГКБО
$Description:    Дистрибутивные функции пакетной процедуры переоценки
*/
import XmlRpcInter, FmInter, PTInter, RSD, likepy;

import rsbformsinter, "revaluation_panel.mac";
import "ws_dprt.mac", "ws_fiunilist.mac", "chapter_panel.mac", "account_widget.mac";




macro TWebNameKindWrp (_id:integer, _name:string)
  var obj = TWebNameKind();
  obj.ID = _id;
  obj.Name = _name;
  return obj;
end;

private macro GetFiKindFromArray(FIKindList, FIKind)
  var i = 0;
  var FIKindF;

  while (i < FIKindList.size)
    if (FIKindList[i].Id == FIKind)
      FIKindF = FIKindList[i];
    end;

    i = i + 1;
  end;

  return FIKindF;
end;

// OVERESTIM_PARM        
macro GetOvEstimAccParm(
 
 BackOut,
 RestIn,
 RestOut, 
 RestZero, 
 DprtID, 
 DprtType, 
 Chapter, 
 AccountKind, 
 AccountMask, 
 AccountId,
 RegulateDate, 
 FIKind, 
 FIID, 
 FirstCarryNumber, 
 RegCarry, 
 ActuateAccOvervalue, 
 PrintReport, 
 PrintOrders, 
 AllDays)


 var res, err;

/// panelObj
  var panelObj  = TWebReValuationPanelObject();
  
/// RegulateDate
  panelObj.RegulateDate = RegulateDate;
  
/// Department
  panelObj.Department = GetTWsDepartmentByCode(DprtID);
  panelObj.IsAllDprtsSelected = false;

///  OperCanExecServProcHead
  GetRegistryValue("COMMON\\СЕРВИСНЫЕ ПРОЦЕДУРЫ\\ЗАПУСК СЕРВИСНЫХ ПРОЦЕДУР", V_BOOL, res, err);

  if(err == 0)
    if((res == true) and (DprtID == {NumDprt}))
      panelObj.OperCanExecServProcHead = true;
    else
      panelObj.OperCanExecServProcHead = false;
    end;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end; 
///  RestKind
  panelObj.RestKindList = MakeArray(
                            TWebNameKindWrp(1, "Входящие"),
                            TWebNameKindWrp(2, "Исходящие"),
                            TWebNameKindWrp(3, "Исходящие, равные нулю"));

  var RestCount = 0;

  if(RestIn)
    RestCount = RestCount + 1;
  end;

  if(RestOut)
    RestCount = RestCount + 1;
  end;

  // GetRegistryValue("CB\\CONSENTACNT\\DEFAULT_REST_IN", V_BOOL, res, err);
  if (RestCount == 1)
    if(RestIn)
      panelObj.RestKind = panelObj.RestKindList[0];
    elif(RestOut)
      panelObj.RestKind = panelObj.RestKindList[1];
      if (RestZero)
        panelObj.RestKind = panelObj.RestKindList[2];
      end;
    else
      panelObj.RestKind = panelObj.RestKindList[2];
    end;
  else
    panelObj.RestKind = TArray;

    if(RestIn)
      panelObj.RestKind[panelObj.RestKind.size] = panelObj.RestKindList[0];
    end;

    if(RestOut)
      if (RestZero)
        panelObj.RestKind[panelObj.RestKind.size] = panelObj.RestKindList[2];
      else
        panelObj.RestKind[panelObj.RestKind.size] = panelObj.RestKindList[2];
      end;
    end;
  end;


/// ChapterListSelected
  panelObj.ChapterListSelected = TArray();
  if(Chapter == 0)
    panelObj.IsAllChaptersSelected = true;
  else
    panelObj.ChapterListSelected[0] = WebCore_GetChapterObject(Chapter);
  end;
  
/// AccKind
  panelObj.AccKindList = MakeArray(
                            TWebNameKindWrp(1, "активные"),
                            TWebNameKindWrp(2, "пассивные"),
                            TWebNameKindWrp(3, "без остатка"));
  
  if(AccountKind == 0)
    panelObj.IsAllAccKindsSelected = true;
  else
    panelObj.AccKind = panelObj.AccKindList[AccountKind];
  end;
/// Account
  if(AccountMask == "")
    panelObj.IsAllAccountsSelected = true;
  else
    panelObj.IsAllAccountsSelected = false;
    if(Web_StringIsMaskEx(AccountMask, CSMFL_Mask ))
      panelObj.Account = TWebAccount();
      panelObj.Account.Account = AccountMask;
    else
      if ( (AccountId!=0) and (AccountId!=null) )
        panelObj.Account = WebCore_CreateTWebAccountFromBD1(AccountId);
      elif ( (AccountMask!=0) and (AccountMask!=null) )
        panelObj.Account = WebCore_CreateTWebAccountFromBD2(AccountMask);
        if (panelObj.Account==null)
          MsgBox("Неверно указана маска счета");
          RunError("Неверно указана маска счета");
        end;
      end;
    end;
  end;
  
/// FIKind
  panelObj.FIKindList = MakeArray(
                            TWebNameKindWrp(1, "Валюты"),
                            TWebNameKindWrp(6, "Драгметаллы"));
  
  if(FIKind == 0)
    panelObj.IsAllFIKindsSelected = true;
  else
    panelObj.FIKind = GetFiKindFromArray(panelObj.FIKindList, FIKind);
    //panelObj.FIKind = panelObj.FIKindList[FIKind];
    
///  FIListSelected
    if(FIID == -1)
      panelObj.IsAllFIsSelected = true;
    else 
      panelObj.IsAllFIsSelected = false;
      panelObj.FIListSelected = TArray();
      panelObj.FIListSelected[0] = GetTWsFinInstrByID(FIID, panelObj.FIKind.ID);
    end;
  end;
  
///  
  
  panelObj.ActuateAccOvervalue = ActuateAccOvervalue;
  panelObj.FirstCarryNumber = FirstCarryNumber;
  panelObj.RegCarry    = RegCarry;
  panelObj.AllDays     = AllDays;
  panelObj.PrintReport = PrintReport; 
  panelObj.PrintOrders = PrintOrders; 
  panelObj.Backout     = Backout; 

  GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\БЕЗОПАСНОСТЬ\\ACCESS_REGRUB", V_STRING, res, err);

  if(err == 0)
    if(res == "FULL")
      panelObj.FullAccess = true;
    else
      panelObj.FullAccess = false;
    end;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  
  
  
  var strParm  = "";
  ConvertToXML(panelObj, NULL, @strParm);

  return strParm;
end;

macro PrintOvEsAccReport(ParamID:integer)
 
  var f = GetReValuationReport(ParamID);
  return f;
  
end;
