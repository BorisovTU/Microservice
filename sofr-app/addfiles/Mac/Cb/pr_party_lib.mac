/*
$Name:           pr_party_lib.mac
$Module:         Ядро ГКБО
$Description:    Библиотека функций для печати анкеты субъекта
*/

Import PTInter, CTInter, FMInter, "globals.mac", "adress.mac", "pt_lib.mac", cb_sql;
import impcomm;
import RSD, oralib, likepy;

private file attr("objattr.dbt") key 0;

private file objgroup (objgroup) write;     /* Категории признаков  */
private file objattr2 (objattr) key 2 write; /* Иерархия  признаков */
private file objatcor (objatcor) key 2 write; /* Иерархия  признаков */



private file partyreg("objrgdoc.dbt") key 1;
private file partcode("objcode.dbt");
private file ptfrzng("ptfrzng.dbt") key 0;

private var AttrID, RegDocID;

/* Примечания для Контрагентов */
private const ДатаЗаполненияАнкеты  = 1;
private const СрокХраненияАнкеты    = 2;
private const Прим_ОрганыУправления = 4;
private const КодыФормГосСтатНабл   = 7;
private const Прим_Учредители       = 8;
private const Прим_Лицензии         = 9;
private const Прим_Органы           = 10;
private const Прим_Подразделения    = 11;
private const Прим_ВидыДеятельности = 12;
private const Прим_ПостКонтрагенты  = 13;
private const Прим_ИсторияРепутация = 14;
private const Прим_ХарактОпераций   = 15;
private const Прим_ОценкаРиска      = 16;
private const ДатаОбновленияАнкеты  = 45;
private const Прим_ДолжностьЛица    = 60; // Должность лица некоторой категории по 115-ФЗ
private const Прим_РодствоСЛицом    = 61; // Родство с лицом некоторой категории по 115-ФЗ
private const Прим_ДеловОтнош       = 62; // Цель установления деловых отношений с банком
private const Прим_ФинансПоложении  = 63; // Сведения о финансовом положении
private const Прим_ДеловРепутации   = 64; // Сведения о деловой репутации
private const Прим_ПроисхождСредств = 65; // Сведения о происхождении денежных средств и имущества
private const Прим_МестоОсновнойДеят= 64; // Место ведения основной деятельности иностранной структуры без образования юридического лица
private const Прим_ИмуществоБОЮЛ    = 65; // Состав имущества в управлении иностранной структуры без образования юридического лица
private const Прим_ДопРегНомера     = 73; // Доп. регистрационные номера иностранной структуры без образования юридич.лица
private const Прим_ДопКодыНалог     = 74; // Доп. коды налогоплательщика иностранной структуры без образования юридич.лица




  var _sУчредители = "",
      _sЛицензии = "",
      _sОрганы = "",
      _sОрганыУправления = "",
      _sПодразделения = "",
      _sВидыДеятельности = "",
      _sПостКонтрагенты = "",
      _sИсторияРепутация = "",
      _sХарактОпераций = "",
      _sОценкаРиска = "",
      _sДолжностьЛица = "",
      _sРодствоСЛицом = "",
      _sДеловОтнош       = "",      
      _sФинансПоложении  = "",
      _sДеловРепутации   = "",
      _sПроисхождСредств = "",   
      _sМестоОсновнойДеят= "",
      _sИмуществоБОЮЛ    = "", 
      _sДопРегНомера     = "",
      _sДопКодыНалог     = "" 
      ;


var _sAccountOper = "", _sAccountControlOper = "";

macro _DefineDateByRegDateMod(InitialDate : date, StartDate : date, DocDate : date) : date
  var RegDateMod = 0;
  var error;
  var RetDate = date(0, 0, 0);
  GetRegistryValue("ФИНМОНИТОРИНГ\\REGDATE_MOD", V_INTEGER, RegDateMod, error);
  if(not error)
    if(RegDateMod == 1)
      RetDate = DocDate;
    elif(RegDateMod == 2)
      if((DocDate != date(0, 0, 0)) and (DocDate < StartDate))
        RetDate = DocDate;
      else
        RetDate = StartDate;
      end;
    elif(RegDateMod == 3)
      RetDate = InitialDate;
    elif(RegDateMod == 4)
      if(InitialDate != date(0, 0, 0))
        RetDate = InitialDate;
      elif(StartDate != date(0, 0, 0))
        RetDate = StartDate;
      elif(DocDate != date(0, 0, 0))
        RetDate = DocDate;
      end;
    else/*RegDateMod == 0*/
      RetDate = StartDate;
    end;
  end;
  return RetDate;
end;

/* Организационно-правовая форма */
macro ЗначениеКатегории( ObjType, _object, Категория, EmptyName, IsFullName )
  
  var Name = "";

  if( EmptyName != null ) Name = EmptyName; end;

  
  if( GetMainObjAttr( null, ObjType, _object, Категория, AttrID ) )
    
    ClearRecord( attr );
    attr.ObjectType = ObjType;
    attr.GroupID    = Категория;
    attr.AttrID     = AttrID;
    
    if( GetEQ(attr) )

      if( IsFullName ) Name = attr.FullName;
      else             Name = attr.Name;
      end;

    end;

  end;
  
  return Name;

end;



macro ПолучитьИмяКатегории( ObjType, Категория, CodeList, NumInList, IsFullName )

  var Name = "";
   
  ClearRecord( objattr2 );
  objattr2.ObjectType = ObjType;
  objattr2.GroupID    = Категория;
  objattr2.CodeList   = CodeList;
  objattr2.NumInList  = NumInList;
  
  if( GetEQ(objattr2) )

    if( IsFullName ) Name = objattr2.FullName;
    else             Name = objattr2.Name;
    end;

  end;

  
  return Name;

end;

macro _getRSetValue( rs : RsdRecordset, colName : string, defValue : variant ) : variant
  
  var RSetValue = rs.value(colName);

  if( RSetValue == nullval ) RSetValue = defValue; end;

  return RSetValue;

end;


macro To_SQLData( dt : date )

  var strDate : string;

  if( dt == Date(0,0,0) )
    strDate = "01.01.0001";
  else
    strDate = string(dt:f);
  end;

  return "to_date('" + strDate + "', 'DD.MM.YYYY')";

end;

macro ConvEmptyStr(Str)
  if(Str != "")
    return Str;
  else
    return " ";
  end;
end;

/* Получить код субъекта по PartyID и CodeKind */
macro ПолучитьКод( PartyID, CodeKind );
  var Code : string;
  
  var strSql : string;
  var rs : RsdRecordset;

  Code = "";

  strSql = "SELECT t_code FROM dpartcode_dbt WHERE t_CodeKind = " + CodeKind + " AND t_PartyID = " + PartyID + ";";

  rs = RsdRecordset( strSql );

  if( rs.MoveNext() )
    Code = rs.value( 0 );
  end;
    
  return Code;      
end;

macro Регистрация( client, ptreg, Number )
  var stat = false; 

  Number = "";

  ClearRecord( ptreg);
  stat = ПолучитьДанныеРегистрации( null, Number, client.PartyID, ptreg );

  SetParm( 2, Number );

  return stat;
end;

macro ПолучитьЮридическийАдрес( client )
  record RecordAdress ( adress );

  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(client.PartyID,RecordAdress);

  return RecordAdress.Adress;
end;

macro ПолучитьФактическийАдрес( client )

  record RecordAdress ( adress );

  ClearRecord(RecordAdress);
  НайтиАдресСубъекта(client.PartyID,PTADDR_REAL,RecordAdress);

  return RecordAdress.Adress;

end;

macro ПолучитьПочтовыйАдрес( client )
  record RecordAdress ( adress );

  ClearRecord(RecordAdress);
  НайтиПочтовыйАдресСубъекта(client.PartyID,RecordAdress);

  return RecordAdress.Adress;
end;

/* Получить ИНН по PartyID */
macro ПолучитьИНН( PartyID )
  var INN, FullINN;
  FullINN = ПолучитьКод( PartyID, PTCK_INN );
//  SplitFullINN( FullINN, INN, null );
  return FullINN;
end;

macro GetPartyReg( client, _partyreg, ListKind_Ref, DocKindID, Number )
  var stat;
  var RegDocID;

  ClearRecord( _partyreg );

  if( CB_GetRegistry( OBJTYPE_PARTY, client.PartyID, ListKind_Ref, DocKindID, _partyreg, Number ) == 0 )    
    SetParm( 4, Number );
    return true;
  else
    Number = "";
    SetParm( 4, Number );
  end;
  return false;
end;


macro ПолучитьСНИЛС( client )

  record ptreg("objrgdoc.dbt");
  file regParty("party.dbt");

  var Code = "";
  Code = ПолучитьКод( client.PartyID, PTCK_SNILS );

  if(Code == "")
    var Number: string;

    if( GetPartyReg( client, ptreg, REGPT_PENSFOND, OBJKDOC_CERTIFICATE_OF_INSURANCE, Number ) )
      Code = ptreg.Number;                  

      if(Code == "")
        Code = ptreg.Series;
      end;
    end;
  end;

  return Code;
end;


private macro GetContactValues(PartyID, ContactKind)  

  var strSql : string;
  var rs : RsdRecordset;

  var str = "";

  strSql = "SELECT t_Value FROM DCONTACT_DBT WHERE t_PartyID = " + PartyID +" AND t_ContactKind = "+ContactKind+" ORDER BY t_IsMain DESC ";

  rs = RsdRecordset( strSql );

  while( rs.MoveNext() )
    if (str != "" )
      str = str +", ";
    end;

    str = str + rs.value( 0 );
  end;

  return str;
end;
/* Номера контактных телефонов и факсов */
macro ТелефоныФаксы( client )
  var str;
  var Value;

  str = "";
  //тел.: <телефон>, <телефон>, факс: <факс>, телекс: <телекс>, эл.почта: <E-mail>

  Value = GetContactValues(client.PartyID, 1);
  if (Value != "")
    str = str + "тел.: " + Value;
  end;

  // факс 
  Value = GetContactValues(client.PartyID, 3);
  if (Value !="")
    if(str != "")
      str = str + ", ";
    end;
    str = str + "факс: " + Value;
  end;

  //телекс 
  Value = GetContactValues(client.PartyID, 4);
  if (Value != "")
    if(str != "")
      str = str + ", ";
    end;
    str = str + "телекс: " + Value;
  end;

  // эл-ная почта 
  Value = GetContactValues(client.PartyID, 5);
  if (Value != "")
    if(str != "")
      str = str + ", ";
    end;
    str = str + "эл-ная почта: " + Value;
  end;

  return str;
end;

/* АдресЭлектроннойПочты */
macro ПолучитьАдресЭлектроннойПочты( client )
  var str;
  var Value = ""; 
  FindAdressContactValue(client.PartyID, PTADDR_REAL, CNTADR_E_MAIL, Value);
  return Value;
end;

macro ПрочитатьПримечания_str(client)
  _sУчредители = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_Учредители );
  _sЛицензии = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_Лицензии );
  _sОрганы = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_Органы );
  _sОрганыУправления = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ОрганыУправления );
  _sПодразделения = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_Подразделения );
  _sВидыДеятельности = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ВидыДеятельности );
  _sПостКонтрагенты = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ПостКонтрагенты );
  _sИсторияРепутация = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ИсторияРепутация );
  _sХарактОпераций = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ХарактОпераций );
  //_sОценкаРиска = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ОценкаРиска );
  _sДолжностьЛица = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ДолжностьЛица );
  _sРодствоСЛицом = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_РодствоСЛицом );
  //_sДеловОтнош       = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ДеловОтнош       );
  //_sФинансПоложении  = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ФинансПоложении  );
  //_sДеловРепутации   = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ДеловРепутации   );
  //_sПроисхождСредств = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ПроисхождСредств );

  _sМестоОсновнойДеят = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_МестоОсновнойДеят );
  _sИмуществоБОЮЛ     = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ИмуществоБОЮЛ     );
  _sДопРегНомера      = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ДопРегНомера     );
  _sДопКодыНалог      = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), Прим_ДопКодыНалог     );


end;

private macro FormatFmIdentRs(rs : @RsdRecordset, str : @string)
  if (str != "")
    str = str +"\n\n";
  end;

  if (rs.value("t_Text") != "")
    str = str + rs.value(0);
    if (rs.value("t_FileSize") != 0)
      str = str + "\nФайл: " + rs.value("t_FileName");
    end;
  else
    str = str + "Файл: " + rs.value("t_FileName");
  end;
end;

macro ПрочитатьИдентифицирующееCведение(client, kind)
  var str = "";
  var strSql = "SELECT t_Text, t_FileName, t_FileSize from dfmidentptrec_dbt where t_PartyID = " + client.PartyID + " AND t_Kind = " + kind;
  var rs = RsdRecordset(strSql);

  while(rs.MoveNext())
    FormatFmIdentRs(@rs, @str);
  end;

  return str;
end;

private macro MarkFMIDENTPTRECName(name, suffix, num)
  var result = name;

  if (suffix != "")
    result = result + suffix + "_";
  end;

  if (num != 0)
    result = result + num;
  end;
  return result;
end;

macro ИдентифицирующиеCведения(client, Kind, TableName, Row, suffix)
  var strSql = "SELECT T1.T_TEXT, "
  "        T1.T_FILENAME, "
  "        T1.T_FILESIZE, "
  "        T2.T_SHORTNAME "
  "    FROM DFMIDENTPTREC_DBT T1, DFMIDENTPARTY_DBT T2 "
  "  WHERE     T1.T_KIND IN (    SELECT T_ID "
  "                                FROM DFMIDENTPARTY_DBT "
  "                          START WITH T_PARENT =  " + Kind + 
  "                          CONNECT BY PRIOR T_ID = T_PARENT) "
  "        AND T1.T_KIND = T2.T_ID and t_PartyID = " + client.PartyID;
  var rs = RsdRecordset(strSql);

  var fmidentptreckind = TArray;
  var fmidentptrec = TArray;

  while(rs.MoveNext())
    var str  = "";
    FormatFmIdentRs(@rs, @str);
    fmidentptreckind[fmidentptreckind.size] = rs.value("T_SHORTNAME");
    fmidentptrec[fmidentptrec.size] = str;
  end;

  if (fmidentptrec.size)
    [~MultipleRow]; 
    println(TableName);
    println(fmidentptrec.size - 1);
    println("#");
    println(Row);

    var k = 0;
    var num;
    while(k < fmidentptrec.size)
      num = k + 1;
      println(MarkFMIDENTPTRECName("~fmidentptreckind_", suffix, num));
      println(fmidentptreckind[k]);

      println(MarkFMIDENTPTRECName("~fmidentptrec_", suffix, num));
      println(fmidentptrec[k]);
      k = k + 1;
    end;
  else
    println(MarkFMIDENTPTRECName("~fmidentptreckind_", suffix, 1));
    println("Сведения не найдены");

    println(MarkFMIDENTPTRECName("~fmidentptrec_", suffix, 1));
    println("");
  end;
end;

macro СведенияисточникахПроисхожденияДенежныхСредств(client, TableName, Row)
  var Kind = 16;
  var strSql = "SELECT T1.T_TEXT, "
  "        T1.T_FILENAME, "
  "        T1.T_FILESIZE, "
  "        T2.T_SHORTNAME "
  "    FROM DFMIDENTPTREC_DBT T1, DFMIDENTPARTY_DBT T2 "
  "  WHERE     T1.T_KIND IN (  " + Kind + ",   (SELECT T_ID "
  "                                FROM DFMIDENTPARTY_DBT "
  "                          START WITH T_PARENT =  " + Kind + 
  "                          CONNECT BY PRIOR T_ID = T_PARENT)) "
  "        AND T1.T_KIND = T2.T_ID and t_PartyID = " + client.PartyID;

  var rs = RsdRecordset(strSql);
  var fmidentptrec = TArray;
  while(rs.MoveNext())
    var str  = "";
    FormatFmIdentRs(@rs, @str);
    fmidentptrec[fmidentptrec.size] = str;
  end;

  if (fmidentptrec.size != 0)
    [~MultipleRow]; 
    println(TableName);
    println(fmidentptrec.size - 1);
    println("#");
    println(Row);

    var k = 0;
    var num;
    while(k < fmidentptrec.size)
      num = k + 1;

      println(MarkFMIDENTPTRECName("~fmidentptrec_", "money", num));
      println(fmidentptrec[k]);
      k = k + 1;
    end;
  else
    [~fmidentptrec_money_1];
    println("Сведения не найдены");
  end;
end;

//Идентифицирующие сведения
macro ПрочитатьИдентифицирующиеCведения(client, rowoffset)
  _sПроисхождСредств = ПрочитатьИдентифицирующееCведение(client, 16);
  _sДеловОтнош = ПрочитатьИдентифицирующееCведение(client, 1);
  _sФинансПоложении = ПрочитатьИдентифицирующееCведение(client, 5);
  _sДеловРепутации = ПрочитатьИдентифицирующееCведение(client, 13);

  // Сведения о целях установления и предполагаемом характере деловых отношений с кредитной органи-зацией, сведения о целях финансово-хозяйственной деятельности
  if (rowoffset != -1)
    СведенияисточникахПроисхожденияДенежныхСредств(client, 1, rowoffset+ 20);
    ИдентифицирующиеCведения(client, 13, 1, rowoffset + 18, "reputation");
    ИдентифицирующиеCведения(client, 5, 1, rowoffset + 16, "fin");
    ИдентифицирующиеCведения(client, 1, 1, rowoffset + 14, "bis"); 
  end;
  // Сведения о финансовом положении
  //ИдентифицирующиеCведения(client, 5, 1, 16, "fin");
end;

macro ПолучитьКодыФГСН( client )

  var КодыФГСН = "";
  var i, j : integer;
  var GroupOKGU = 0;
  var SysDate = date;

  var ObjCat = RsbObjCategories( OBJTYPE_PARTY, UniID( client, OBJTYPE_PARTY ));
  i = 0;

  /*ОКПО - party.OKPO*/
  if( StrLen( client.OKPO ) > 0 )
    КодыФГСН = "ОКПО: " + client.OKPO;
  end;

  /*ОКНХ - категория <Коды ОКОНХ> - objatcor.GroupID = 7, Категория множественная*/
  if( ObjCat.GetFirst( 7, {curdate}, attr ) == 0)
    if(КодыФГСН != "")
      КодыФГСН = КодыФГСН + "\n";  
    end;

    КодыФГСН = КодыФГСН + "ОКОНХ: " + attr.NameObject;
    while( ObjCat.GetNext( attr ) == 0)
      КодыФГСН = КодыФГСН + ", " + attr.NameObject;
    end;
  end;

  if(SysDate < date(01,01,2016))
    /*ОКВЭД - категория <Код ОКВЭД> - objatcor.GroupID = 17. Множественная*/
    if( ObjCat.GetFirst( 17, {curdate}, attr ) == 0)
      if(КодыФГСН != "")
        КодыФГСН = КодыФГСН + "\n";  
      end;
    
      КодыФГСН = КодыФГСН + "ОКВЭД: " + attr.NameObject;
      while( ObjCat.GetNext( attr ) == 0)
        КодыФГСН = КодыФГСН + ", " + attr.NameObject;
      end;
    end;
  end;
  /*ОКВЭД2 - категория <Код ОКВЭД2> - objatcor.GroupID = 64. Множественная*/
  if( ObjCat.GetFirst( 64, {curdate}, attr ) == 0)
    if(index(КодыФГСН, "ОКВЭД: ") == 0)
      if(КодыФГСН != "")
        КодыФГСН = КодыФГСН + "\n";  
      end;
      КодыФГСН = КодыФГСН + "ОКВЭД: " + attr.NameObject;
    else
      КодыФГСН = КодыФГСН + ", " + attr.NameObject;
    end;
    while( ObjCat.GetNext( attr ) == 0)
      КодыФГСН = КодыФГСН + ", " + attr.NameObject;
    end;
  end;

  if(SysDate < date(01,01,2016))
    /*ОКДП - категория <Код ОКДП> - objatcor.GroupID = 43. Множественная*/
    if( ObjCat.GetFirst( 43, {curdate}, attr ) == 0)
      if(КодыФГСН != "")
        КодыФГСН = КодыФГСН + "\n";  
      end;
    
      КодыФГСН = КодыФГСН + "ОКДП: " + attr.NameObject;
      while( ObjCat.GetNext( attr ) == 0)
        КодыФГСН = КодыФГСН + ", " + attr.NameObject;
      end;
    end;
  end;
  /*ОКПД2 - категория <Код ОКПД2> - objatcor.GroupID = 65. Множественная*/
  if( ObjCat.GetFirst( 65, {curdate}, attr ) == 0)
    if(index(КодыФГСН, "ОКПД: ") == 0)
      if(КодыФГСН != "")
        КодыФГСН = КодыФГСН + "\n";  
      end;
      КодыФГСН = КодыФГСН + "ОКПД: " + attr.NameObject;
    else
      КодыФГСН = КодыФГСН + ", " + attr.NameObject;
    end;
    while( ObjCat.GetNext( attr ) == 0)
      КодыФГСН = КодыФГСН + ", " + attr.NameObject;
    end;
  end;

  /*ОКФС - категория <Код ОКФС> - objatcor.GroupID = 27. Не множественная*/
  if( ObjCat.GetMainAttr( 27, {curdate}, attr ) == 0)
    if(КодыФГСН != "")
      КодыФГСН = КодыФГСН + "\n";  
    end;

    КодыФГСН = КодыФГСН + "ОКФС: " + attr.NameObject;
  end;

  /*ОКОПФ - категория <Код ОКОПФ> - objatcor.GroupID = 28. Не множественная*/
  if( ObjCat.GetMainAttr( 53, {curdate}, attr ) == 0)
    if(КодыФГСН != "")
      КодыФГСН = КодыФГСН + "\n";  
    end;
    КодыФГСН = КодыФГСН + "ОКОПФ: " + attr.NameObject;
  end;
  
  /*ОКОГУ - категория <Код ОКОГУ> - objatcor.GroupID = 38. Не множественная*/

  if(SysDate < date(01,01,2012))
    GroupOKGU = 38;
  else
    GroupOKGU = 48;
  end;

  if( ObjCat.GetMainAttr( GroupOKGU, {curdate}, attr ) == 0)
    if(КодыФГСН != "")
      КодыФГСН = КодыФГСН + "\n";  
    end;

    КодыФГСН = КодыФГСН + "ОКОГУ: " + attr.NameObject;
  end;

  return КодыФГСН;
end;



macro ПолучитьКатегорию( client, Number )

  var КодыФГСН = "";
  var i, j : integer;
  var GroupOKGU = 0;
  var SysDate = date;

  var ObjCat = RsbObjCategories( OBJTYPE_PARTY, UniID( client, OBJTYPE_PARTY ));
  i = 0;
  /*ОКАТО - категория <Справочник ОКАТО>  -- objatcor.GroupID = 12. Не множественная*/
  if( ObjCat.GetMainAttr( Number, {curdate}, attr ) == 0)
    КодыФГСН = attr.NameObject;
  end;
  
  return КодыФГСН;
end;


macro ReadDate( rs : RsdRecordset, num : integer )

  var val, IsNull;
  var dt : date;
  var day : integer, mon : integer, year : integer;

  val = rs.value(num, IsNull);

  if( IsNull )
    
    dt = null;

  else

    dt = val;

    DateSplit( dt, day, mon, year );
    if( (day == 1) and (mon == 1) and (year == 1) )
      dt = Date(0, 0, 0);
    end;
  
  end;

  return dt;

end;

private macro GetDprtPartyID( DprtID : integer )
  
  file dprt("dp_dep.dbt");
  var PartyID : integer = -1;

  dprt.Code = DprtID;

  if( getEQ(dprt) )
    PartyID = dprt.PartyID;
  end;

  return PartyID;

end;

macro ДолжностиСотрудника( str : @string, PartyID : integer, PersonID : integer )
  
  var strSql : string;
  var rs : RsdRecordset;

  var Post : string;

  strSql = "select t_Post from dofficer_dbt where t_PartyID = " + PartyID + " and t_PersonID = " + PersonID;
  
  rs = RsdRecordset( strSql );

  while( rs.MoveNext() )
    Post = rs.value(0);
    if( Post != "" )
      str = str + ", " + Post;
    end;
  end;

end;

macro СотрудникПоСчету( oper : integer )

  file person("person.dbt");

  var PartyID : integer;
  var str : string;

  str = "";
  
  if( oper )
    
    person.Oper = oper;
  
    if( getEQ(person) )
    
      str = person.Name;

      if( (str != "") and (person.PartyID > 0) )

        PartyID = GetDprtPartyID(person.CodeDepart);

        if( PartyID > 0 )

          ДолжностиСотрудника( @str, PartyID, person.PartyID );
        
        end;

      end;
  
    end;

  end;

  return str;

end;

/* ПервыйСчетКлиента */
macro ПервыйСчет_str( client, _Open_Date : @date )
  var OpenDate : date, Oper : integer, ControlOper : integer;
  var strOper : string, strControlOper : string;
  var PartyID : integer;
  var InstOpenDate : date;
  var AccountID = 0;

  macro МинимальнаяДатаОткрытияСчета( client, onlyOpened : bool )
    var strSql = "";
    var rs : RsdRecordset;
    var params : TArray;
    var OpenDate : date;

    OpenDate = null;

    strSql = strSql + "SELECT MIN(t_Open_Date) ";
    strSql = strSql + "  FROM daccount_dbt ";
    strSql = strSql + " WHERE t_Client = :Client ";
    if(onlyOpened)
      strSql = strSql + " AND t_Open_Close = CHR(0) ";
    end;
    params = makeArray( SQLParam("Client", client.PartyID ));
    rs = execSQLselect( strSql, params, true );
    if( rs.MoveNext() )
      OpenDate = ReadDate( rs, 0 );
    end;
    
    return OpenDate;

  end;

  macro ДобавитьТипСчета( strSql : @string, ТипСчета : string )
    strSql = strSql + ", DECODE(INSTR(t_Type_Account,'" + ТипСчета + "'), 0, 1, 0) \"" + ТипСчета +"\" ";
  end;

  macro ДобавитьТипСчетаСорт( strSql : @string, ТипСчета : string )
    strSql = strSql + ", \"" + ТипСчета +"\"";
  end;
  
  macro _СчетаЗаДату( strSql : @string, client, TableName : string, OpenDate : date )
    
    strSql = strSql + "SELECT t_Open_Date a_Open_Date, t_Oper a_Oper, t_ControlOper a_ControlOper, t_AccountID a_AccountID ";
    
    ДобавитьТипСчета( @strSql, "L" );
    ДобавитьТипСчета( @strSql, "Ч" );
    ДобавитьТипСчета( @strSql, "X" );
    ДобавитьТипСчета( @strSql, "Я" );
    ДобавитьТипСчета( @strSql, "Q" );
    
    strSql = strSql + "  FROM " + TableName;
    strSql = strSql + " WHERE t_Client = " + string(client.PartyID);
    strSql = strSql + "   AND t_Open_Date = " + To_SQLData(OpenDate);
    if(client.LegalForm == PTLEGF_INST)
      strSql = strSql + "   AND t_Open_Close = CHR(0) ";
    end;

  end;

  macro СчетаЗаДату( client, OpenDate : @date, Oper : @integer, ControlOper : @integer, AccountID : @integer )
    
    var strSql : string;
    var rs : RsdRecordset;
    AccountID = 0;

    strSql = "";
    _СчетаЗаДату( @strSql, client, "daccount_dbt" , OpenDate );

    strSql = strSql + " ORDER BY a_Open_Date";

    ДобавитьТипСчетаСорт( @strSql, "L" );
    ДобавитьТипСчетаСорт( @strSql, "Ч" );
    ДобавитьТипСчетаСорт( @strSql, "X" );
    ДобавитьТипСчетаСорт( @strSql, "Я" );
    ДобавитьТипСчетаСорт( @strSql, "Q" );

    rs = RsdRecordset( strSql );

    if( rs.MoveNext() )
      OpenDate    = ReadDate( rs, 0 );
      Oper        = rs.value(1);
      ControlOper = rs.value(2);
      AccountID   = rs.value(3);
    end;

  end;

  macro IsExistRecAcc(AccountID)
    file accounts ( "account.dbt"  )  key 1;

    var IsExRa = false;
    var StrAccID = "";

    var strSql : string;
    var rs : RsdRecordset;

    ClearRecord(accounts);
    accounts.AccountID = AccountID;

    if( getEQ( accounts ) )
      StrAccID = UniID(accounts, 0, 3 );
    
      strSql = " SELECT 1 " +
               " FROM doprdocs_dbt oprd, doproper_dbt opro " +
               " WHERE oprd.t_DocKind = 3 " +
               "  AND oprd.t_DocumentID = '" + StrAccID + "' "+
               "  AND oprd.t_ID_Operation = opro.t_ID_Operation ";
    

      rs = RsdRecordset( strSql );

      if( rs.MoveNext() )
        IsExRa = true;
      end;
    end;


    return IsExRa;
  end;

  PartyID = client.PartyID;

  OpenDate = МинимальнаяДатаОткрытияСчета( client, false );
  
  if( OpenDate != null )
    
    if(client.LegalForm == PTLEGF_INST)
      InstOpenDate = МинимальнаяДатаОткрытияСчета( client, true );
      if( InstOpenDate != null )
        СчетаЗаДату( client, @InstOpenDate, @Oper, @ControlOper, @AccountID );
      end;
    else
      СчетаЗаДату( client, @OpenDate, @Oper, @ControlOper, @AccountID );
    end;

  else
    
    Oper        = 0;
    ControlOper = 0;

  end;

  _Open_Date   = OpenDate;
  
  strOper        = СотрудникПоСчету( Oper );

  if(IsExistRecAcc(AccountID))
    strControlOper = СотрудникПоСчету( ControlOper );
  else
    strControlOper = "";
  end;

  _sAccountOper =  strOper;
  _sAccountControlOper = strControlOper;
end;

macro PrintDate( dt : date )
  var strDate : string;

  if( dt == null )
    strDate = "";
  elif( dt == Date(0,0,0) )
    strDate = "00.00.0000";
  else
    strDate = string(dt:f);
  end;

  return strDate;
end;


macro ПолучитьСведЛицоОткрывающееСчет( client )

  var strSql : string;
  var cmd : RsdCommand;
  var rs : RsdRecordset;

  var СведЛицоОткрывающееСчет : string;
 
  СведЛицоОткрывающееСчет = "";

  strSql = "SELECT t_DelegatePost, t_DelegateName1, t_DelegateName2, t_DelegateName3 " +
           "FROM dreqopena_dbt WHERE " +
           "  EXISTS(SELECT 1 FROM daccount_dbt acc WHERE acc.t_Account = t_Account AND acc.t_Code_Currency = t_Code_Currency) AND " +
           "  t_DelegateName1 <> CHR(1) AND t_ClientID = " + client.PartyID;
  

   cmd = RsdCommand( strSql );
   cmd.NullConversion = true;
   rs = RsdRecordset( cmd );

  if( rs.MoveNext() )
    if( StrLen(rs.value(0)) > 0 )
      СведЛицоОткрывающееСчет = СведЛицоОткрывающееСчет + rs.value(0) + " ";
    end;

    if( StrLen(rs.value(1)) > 0 )
      СведЛицоОткрывающееСчет = СведЛицоОткрывающееСчет + rs.value(1) + " ";
    end;

    if( StrLen(rs.value(2)) > 0 )
      СведЛицоОткрывающееСчет = СведЛицоОткрывающееСчет + rs.value(2) + " ";
    end;

    if( StrLen(rs.value(3)) > 0 )
      СведЛицоОткрывающееСчет = СведЛицоОткрывающееСчет + rs.value(3);
    end;

  end;

  return СведЛицоОткрывающееСчет;
end;

macro ПолучитьДатуЗакрытия(PartyID) : date
  var rs, sqlStr;
  sqlStr = "SELECT NVL(MAX(t_sysdate), TO_DATE('01010001','ddmmyyyy')) FROM dptprmhist_dbt WHERE t_partyid=" + PartyID +
           " AND t_paramkindid = 100 AND t_valueafter = 'X'";
  rs = SQL_ExecuteAndGetRs(sqlStr); 
  rs.moveNext(); 
  return rs.value(0);
end;

macro ПолучитьКапитал( PartyID, DeclareCapital : @string, RealCapital : @string);
  var Code : string;
  
  var strSql : string;
  var rs : RsdRecordset;

  DeclareCapital = "";
  RealCapital = "";

  strSql = "select t_DeclareCapital, t_RealCapital, t_CapitalFI from dinstitut_dbt where t_Partyid = " + PartyID + ";";

  rs = RsdRecordset( strSql );
  
  if( rs.MoveNext() )
    DeclareCapital = string(rs.value( 0 ));
    RealCapital    = string(rs.value( 1 ));
  end;
    
  return true;      
end;


macro ПолучитьДатыАнкеты(client, FormDateFill :@date, FormDateModif :@date, FormDateStore :@date)
  
  FormDateFill  = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), ДатаЗаполненияАнкеты );
  FormDateModif = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), ДатаОбновленияАнкеты );
  FormDateStore = readNoteForObject(OBJTYPE_PARTY, UniID(client, OBJTYPE_PARTY), СрокХраненияАнкеты   );

  if( FormDateFill  == null ) FormDateFill  = date(0, 0, 0); end;
  if( FormDateModif == null ) FormDateModif = date(0, 0, 0); end;
  if( FormDateStore == null ) FormDateStore = date(0, 0, 0); end;

  if( FormDateModif == date(0, 0, 0) ) FormDateModif = FormDateFill; end;

end;

// Физ. лица

macro ПолучитьМестоРождения( client )

  var stat;
  var find = 0;
  file region ("ptregion.dbt") key 0;
  file persn("persn.dbt") key 0;

  ClearRecord( persn );
  persn.PersonID = client.PartyID;
  GetEQ( persn );

  var AddressTEMP = "";

  if(StrLen(persn.BirsPlase)>0)
    AddressTEMP = persn.BirsPlase;
  else

    if(StrLen(persn.RegionBorn)>0)
      region.CodeRegion = persn.RegionBorn;
      stat = GetEQ(region);
      if(stat)
        AddressTEMP = AddressTEMP + region.NameRegion;
        find = 1;
      end;
    end;

    if(StrLen(persn.RaionBorn)>0)
      if(find) AddressTEMP = AddressTEMP + ", "; end;
      AddressTEMP = AddressTEMP + persn.RaionBorn;
      find = 1;
    end;

    if(StrLen(persn.PlaceBorn)>0)
      if(find) AddressTEMP = AddressTEMP + ", "; end;
      AddressTEMP = AddressTEMP + persn.PlaceBorn;
      find = 1;
    end;

  end;

  return AddressTEMP;
end;

macro ДобавитьСтроку( str, add_string, prefix )
  if( Trim(add_string) != "" )
    if( str )
      str = str + ", ";
    end;
    str = str + prefix + add_string;
  end;
  return str;
end;

macro ПолучитьУдостоверение( persn )
  file ppkind("paprkind.dbt");
  record persnidc("persnidc.dbt");

  var str;
  str = "";
  /* Вид документа */
  if( GetPersonIdc(persn.PersonId, persnidc) )
    ppkind.PaperKind = persnidc.PaperKind;
    if( GetEQ(ppkind) )
      str = ДобавитьСтроку( str, ppkind.Name, "" );
    end;
  end;
  /* серия */
  str = ДобавитьСтроку( str, persnidc.PaperSeries, "серия " );
  /* номер */
  str = ДобавитьСтроку( str, persnidc.PaperNumber, "номер " );
  /* выдан */
  str = ДобавитьСтроку( str, persnidc.PaperIssuer, "выдан " );
  /* дата выдачи */
  str = ДобавитьСтроку( str, string(persnidc.PaperIssuedDate:f), "дата выдачи " );
  
  if(ppkind.SetValidToDate == "X")
    str = ДобавитьСтроку( str, string(persnidc.ValidToDate:f), "действует до " );
  end;

  return str;
end;


macro ПолучитьДокументНаПребывание ( PartyID );
  var str;
  str = "";
 
  var strSql : string;
  var cmd;
  var rs : RsdRecordset;
  var RegStartDate;
  var RegFinishDate;

  strSql = " SELECT kdoc.T_NAME, rgd.T_SERIES, rgd.T_NUMBER, rgd.T_INITIALDATE, rgd.T_STARTDATE, rgd.T_DOCDATE, rgd.T_FINISHDATE " +
           "   FROM dobjrgdoc_dbt rgd, dobjkdoc_dbt kdoc " +
           "  WHERE rgd.T_REGDOCKIND <> " + OBJKDOC_MIGRATORY_DOCUMENT +                                              
           "       AND rgd.T_OBJECTTYPE = 3 " +                                                 
           "       AND rgd.T_OBJECTID = " + PartyID +
           "       AND kdoc.T_OBJECTTYPE = rgd.T_OBJECTTYPE " +                                
           "       AND kdoc.T_REGDOCKIND = rgd.T_REGDOCKIND " +
           "       AND kdoc.T_ISREGSERTIFICATE = 'X'";

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  rs = RsdRecordset( cmd );
  // "<описание>, серия <серия>, номер <номер>, дата начала срока пребывания <дата начала действия регистрации>, дата окончания срока пребывания <дата окончания действия реги-страции>"
  while( rs.MoveNext() )
    RegStartDate = _DefineDateByRegDateMod(rs.value( "T_INITIALDATE" ), rs.value( "T_STARTDATE" ), rs.value( "T_DOCDATE" ));
    RegFinishDate = rs.value( "T_FINISHDATE" );

    str = ДобавитьСтроку( str, rs.value( "T_NAME" ), "" );
    str = ДобавитьСтроку( str, rs.value( "T_SERIES" ), "серия" );
    str = ДобавитьСтроку( str, rs.value( "T_NUMBER" ), "номер" );
    str = ДобавитьСтроку( str, string(RegStartDate:f), "дата начала срока пребывания " );
    str = ДобавитьСтроку( str, string(RegFinishDate:f), "дата окончания срока пребывания " );

  end;
    
  return str;      
end;



macro GetCountryName( CodeLat3 : string ) : string

  var cmd, rs, sqlquery;

  var RetVal="";

   sqlquery="select t_name from dcountry_dbt where t_codelat3='"+CodeLat3+"'";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 
     RetVal=rs.value ("t_name");
   end;

   return RetVal;
end;


macro ПолучитьВиза(client)
  /*record ptreg("partyreg.dbt");*/
  record ptreg("objrgdoc.dbt");
  file regParty("party.dbt");

  var Number: string;
  var str, tmp_str;
  str = "";

  if( client.NotResident == "X" )   /* "Виза" */
    if( GetPartyReg( client, ptreg, REGPT_MID, OBJKDOC_VISA, Number ) )
      str = ДобавитьСтроку( str, "Виза", "Вид документа " );
      /* выдана */
      if( ptreg.RegPartyID > 0 )
        ClearRecord(regParty);
        regParty.PartyID = ptreg.RegPartyID;
        GetEQ( regParty );
        str = ДобавитьСтроку( str, regParty.Name, "выдана " );
      end;
      /* дата выдачи */
      str = ДобавитьСтроку( str, string(ptreg.DocDate:f), "дата выдачи " );
      /* срок */
      tmp_str = "";
      if( (ptreg.StartDate != Date(0, 0, 0)) or (ptreg.FinishDate != Date(0, 0, 0)) )
        tmp_str = " - ";
      end;
      str = ДобавитьСтроку( str, string(ptreg.FinishDate:f) + tmp_str + string(ptreg.StartDate:f), "срок " );
      /* серия */
      str = ДобавитьСтроку( str, ptreg.Series, "серия " );
      /* номер */
      str = ДобавитьСтроку( str, ptreg.Number, "номер " );
    end;
  end;

  return str;
end;

macro ПолучитьМиграционнуюКарту( client )
  //   "номер <номер>, дата начала срока пребывания <дата начала действия регистрации>, дата окончания срока пребывания <дата окончания действия регистрации>"
  // Данные документа регистрации вида "МИГРКРТ", выданного органом "ИммСлужб":
  
  /*record ptreg("partyreg.dbt");*/
  record ptreg("objrgdoc.dbt");
  file regParty("party.dbt");
                
  var Number: string;
  var str, tmp_str;
  str = "";

  if( client.NotResident == "X" )   /* "Иммиграционная служба" */     /* Миграционная карта */
    if( GetPartyReg( client, ptreg, REGPT_IMIGRATE_SERVICE, OBJKDOC_MIGRATORY_DOCUMENT, Number ) )
      str = str + "номер " + Number;                  
      str = str + ", дата начала срока пребывания " + string(_DefineDateByRegDateMod(ptreg.InitialDate, ptreg.StartDate, ptreg.DocDate):f);
      str = str + ", дата окончания срока пребывания  " + string(ptreg.FinishDate:f);
      // OBJRGDOC 
    end;
  end;

  return str;
end;


macro ПолучитьНазваниеАнкеты(PartyID, PartyKind, IsEmployer ) 
  var RetStr = "";
  var error = 0;
  if( PartyKind == 43 )
    RetStr = "выгодоприобретателя";
  else
    if(IsEmployer == "X")
      RetStr = "предпринимателя";
    else 
      if(ВидСубъекта(PartyID, PTK_CLIENT, error, {OperDprt}))
        RetStr = "клиента";
      else
        RetStr = "субъекта экономики";
      end;
    end;
  end;

  return RetStr;
end;

macro СведенияОТерроризме( PartyID, TerrListPos : @string, TerrList : @string, Decision : @string)
  
  ClearRecord( ptfrzng );
  ptfrzng.PartyID = PartyID;
  // PTFRZNG
  if( GetEQ(ptfrzng) )
    TerrListPos = "номер записи в Перечне: " + ptfrzng.TerrListPos;
    TerrList = ptfrzng.TerrListNumber +" от " + string(ptfrzng.TerrListDate:f);
    Decision = ptfrzng.DecisionNumber+ " от " + string(ptfrzng.DecisionDate:f);


  else
    TerrListPos = "Сведений о причастности к экстремизму и терроризму нет";
    TerrList = "";
    Decision = "";
  end;
end;



macro УровеньРискаУстановлен( PartyID  ) : string
  var cmd, rs, sqlquery;

  var RetVal=" ";

   sqlquery=" SELECT rl.t_BeginDate, rl.t_Oper, pr.t_Name as PrName, dp.t_Name AS DepName, pt.t_Name PtDepName " +
            "   FROM DPTRISKLEVEL_DBT rl, dperson_dbt pr, ddp_dep_dbt dp, dparty_dbt pt " +
            "  WHERE rl.t_PartyID = " + PartyID + 
            "    AND rl.t_Oper = pr.t_Oper " +
            "    AND pr.t_CodeDepart =  dp.t_Code " +
            "    AND pt.t_PartyID = dp.t_PartyID " +
            "    AND rl.t_BeginDate <= "+ To_SQLData({curdate})+
            "  ORDER BY  rl.t_BeginDate DESC ";

   cmd = RsdCommand( sqlquery );
   cmd.NullConversion = true;

   rs = RsdRecordset( cmd );

   cmd.execute;

   // "<дата назначения уровня риска>; пользователь: <номер назначившего пользователя> <ФИО пользователя>; филиал: <пользовательский идентификатор узла ТС - филиала пользователя> 
   //  <полное наименование субъекта экономики, связанного с узлом ТС филиала>".
   if ( rs.moveNext ) 

     RetVal = string(date(_getRSetValue( rs, "t_BeginDate", date(0, 0, 0))));
     RetVal = RetVal + "; пользователь: " + _getRSetValue( rs, "t_Oper", "" );
     RetVal = RetVal + " " + _getRSetValue( rs, "PrName", "" );
     RetVal = RetVal + "; филиал: " + _getRSetValue( rs, "DepName", "" );
     RetVal = RetVal + " " + _getRSetValue( rs, "PtDepName", "" );;
   end;

   return RetVal;
end;


macro СведенияОЗамораживании( PartyID )
  
  var RetVal = " ";
   
  ClearRecord( ptfrzng );
  ptfrzng.PartyID = PartyID;
  // PTFRZNG
  if( GetEQ(ptfrzng) )

    if(ptfrzng.FreezingGround == FREEZING_BY_TERRLIST)
    // Дата и время замораживания: <dd.mm.yyyy> <hh:mm:ss>; основание: субъект включен в перечень террористов номер <номер перечня> от <дата перечня>, запись номер <номер записи в перечне>."
      RetVal = "Дата и время замораживания: " + string(date(ptfrzng.FreezingDate):f) +" "+ string(time(ptfrzng.FreezingTime):f)+"; ";
      RetVal = RetVal + "основание: субъект включен в перечень террористов номер " +ptfrzng.TerrListNumber+ " от " + string(date(ptfrzng.TerrListDate):f) ;
      RetVal = RetVal + ", запись номер " + ptfrzng.TerrListPos;
    else
    // Дата и время замораживания: <dd.mm.yyyy> <hh:mm:ss>; основание: решение уполномоченного органа от <дата решения> номер <номер решения>."   
      RetVal = "Дата и время замораживания: " + string(date(ptfrzng.FreezingDate):f) +" "+ string(time(ptfrzng.FreezingTime):f)+"; ";
      RetVal = RetVal + "основание: решение уполномоченного органа от " +string(date(ptfrzng.DecisionDate):f) ;
      RetVal = RetVal + "номер " + ptfrzng.DecisionNumber;
    end

  end;
end;



/*
 *   Печать cведений о представителях
 */
macro ПечатьСведенийОПредставителях( PartyID, ArrayProxy )

  var Code : string;
  var Name : string;
  var DocNumber : string;
  var DocDate   : date;
  var DocDesc   : string;
  var PostName  : string;
  var ProxyID   : integer;

  var Account   : string;
  var TermTo    : date;
  var PrxSauth  : string;

  var cmd : RsdCommand;
  var rs : RsdRecordset;
  var strSql : string;

  var cmd2 : RsdCommand;
  var rs2 : RsdRecordset;
  var strSql2 : string;

  var Flag1  : integer; 

  var Count : integer;

  
  strSql = " SELECT ptc.t_Code, pt.t_Name, px.t_DocNumber, px.t_DocDate, px.t_DocDesc, nvl(llv.t_Name, chr(1))AS PostName, px.t_ProxyID " +
           " FROM dptproxy_dbt px, dpartcode_dbt ptc, dparty_dbt pt, dllvalues_dbt llv " +
           " WHERE px.t_PartyID = " + PartyID +
           "   AND ptc.t_PartyID = px.t_ProxyID " +                                                             
           "   AND ptc.t_CodeKind = 1 " +                                                                        
           "   AND pt.t_PartyID = px.t_ProxyID " +                                                              
           "   AND llv.t_Element(+) = px.t_Post " +                                                                
           "   AND llv.t_List(+) = 1128 ";

  cmd = RsdCommand( strSql );

  cmd.nullConversion = true;

  cmd.addParam( "", RSDBP_IN, PartyID    );
  cmd.addParam( "", RSDBP_IN, PTCK_CONTR );

  rs = RsdRecordset( cmd );

  Count = 0;

  while( rs.MoveNext() )
    
    Code = _getRSetValue( rs, "t_Code", "" );
    Name = _getRSetValue( rs, "t_Name", "" );

    DocNumber = _getRSetValue( rs, "t_DocNumber", "" );
    DocDate   = _getRSetValue( rs, "t_DocDate", date(0, 0, 0) );

    DocDesc   = _getRSetValue( rs, "t_DocDesc", "" );
    PostName  = _getRSetValue( rs, "PostName", "" );

    ProxyID   = _getRSetValue( rs, "t_ProxyID", 0 );
    
    ArrayProxy(Count) = ProxyID;

    if( Count > 0 )
      println;
    end;

    /*
      Представитель: <75>
      " документ: <76> от <77>
      " сведения о документе: <78>
      " должность: <79>
      право подписи: 81 
    */

    println("Представитель: ", Code, " ", Name );
    println("  документ: ", DocNumber, " от ", string(DocDate:f));
    println("  сведения о документе: ", DocDesc );
    println("  должность: ", PostName );

    strSql2 = "SELECT T_ACCOUNT, T_TERMTO " +
              " FROM DPTPRXSAUTH_DBT " +
              " WHERE T_PARTYID = " + PartyID +
              "  AND T_PROXYID = " + ProxyID +
              " ORDER BY T_TERMTO DESC ";
//              "  AND T_TERMTO <= to_date('"+string({curdate}:f)+"','DD.MM.YYYY')" ;

    cmd2 = RsdCommand( strSql2 );

    cmd2.nullConversion = true;

    rs2 = RsdRecordset( cmd2 );

    PrxSauth = "постоянно, все счета";

    Flag1 = 0;
    while( rs2.MoveNext() )
      Account  = _getRSetValue( rs2, "T_ACCOUNT", "" );
      TermTo   = _getRSetValue( rs2, "T_TERMTO", date(0, 0, 0) );

      if(TermTo < {curdate})
        if(Flag1 == 0)
          PrxSauth = "Срок полномочий" + string(TermTo:f) + " срок полномочий истек";
          Flag1 = 3;
        end;
      else
        
        if(Flag1 == 0 )
          PrxSauth = "до "; 
        else
          PrxSauth = PrxSauth + "\n до "; 
        end;
        
        if(TermTo != date(0, 0, 0))
          PrxSauth = PrxSauth + string(TermTo:f);
        else
          PrxSauth = PrxSauth + "постоянно";
        end;

        if(Account != "")
          PrxSauth = PrxSauth + ", счет " + Account;
        else
          PrxSauth = PrxSauth + ", любой счет";
        end;

        Flag1 = 1;
      end;
    end;

    println("право подписи: ", PrxSauth );

    Count = Count + 1;
  end;

  if( Count == 0 )
    println("Представителей нет" );
  end;

end;

/*Сведения о представителе*/
macro СведенияОПредставителе(PartyID)

  var Code : string;
  var Name : string;
  var DocNumber : string;
  var DocDate   : date;
  var ValidityDate : date;
  var DocDesc   : string;
  var PostName  : string;
  var ProxyID   : integer;

  var Account   : string;
  var TermTo    : date;
  var PrxSauth  : string;

  var cmd : RsdCommand;
  var rs : RsdRecordset;
  var strSql : string;

  var cmd2 : RsdCommand;
  var rs2 : RsdRecordset;
  var strSql2 : string;

  var Flag1  : integer; 

  var Count : integer;

  strSql = " SELECT ptc.t_Code, pt.t_Name, px.t_DocNumber, px.t_DocDate, px.t_DocDesc, llv.t_Name AS PostName, px.t_ProxyID , PX.T_VALIDITYDATE" +
           " FROM dptproxy_dbt px, dpartcode_dbt ptc, dparty_dbt pt, (select * from dllvalues_dbt where t_List = 1128) llv " +
           " WHERE px.t_ProxyID = " + PartyID +
           "   AND ptc.t_PartyID = px.t_PartyID " +                                                             
           "   AND ptc.t_CodeKind = 1 " +                                                                        
           "   AND pt.t_PartyID = px.t_PartyID " +                                                              
           "   AND px.t_Post = llv.t_Element (+)";

  cmd = RsdCommand( strSql );

  cmd.nullConversion = true;

  cmd.addParam( "", RSDBP_IN, PartyID    );
  cmd.addParam( "", RSDBP_IN, PTCK_CONTR );

  rs = RsdRecordset( cmd );

  Count = 0;

  while( rs.MoveNext() )
    
    Code = _getRSetValue( rs, "t_Code", "" );
    Name = _getRSetValue( rs, "t_Name", "" );

    DocNumber = _getRSetValue( rs, "t_DocNumber", "" );
    DocDate   = _getRSetValue( rs, "t_DocDate", date(0, 0, 0) );
    ValidityDate = _getRSetValue( rs, "t_ValidityDate", date(0, 0, 0) );
    DocDesc   = _getRSetValue( rs, "t_DocDesc", "" );
    PostName  = _getRSetValue( rs, "PostName", "" );

    ProxyID   = _getRSetValue( rs, "t_ProxyID", 0 );
    
    if( Count > 0 )
      println;
    end;

    /*
      Является представителем для: <82>
      " документ: <76> от <77>
      " сведения о документе: <78>
      " должность: <79>
      " право подписи: <81>
    */

    println("Является представителем для: ", Code, " ", Name );
    println("  документ: ", DocNumber, " от ", string(DocDate:f), " срок действия ", string(ValidityDate:f));
    println("  сведения о документе: ", DocDesc );
    println("  должность: ", PostName );

    strSql2 = "SELECT T_ACCOUNT, T_TERMTO " +
              " FROM DPTPRXSAUTH_DBT " +
              " WHERE T_PARTYID = " + PartyID +
              "  AND T_PROXYID = " + ProxyID +
              " ORDER BY T_TERMTO DESC ";
//              "  AND T_TERMTO <= to_date('"+string({curdate}:f)+"','DD.MM.YYYY')" ;

    cmd2 = RsdCommand( strSql2 );

    cmd2.nullConversion = true;

    rs2 = RsdRecordset( cmd2 );

    PrxSauth = "постоянно, все счета";

    Flag1 = 0;
    while( rs2.MoveNext() )
      Account  = _getRSetValue( rs2, "T_ACCOUNT", "" );
      TermTo   = _getRSetValue( rs2, "T_TERMTO", date(0, 0, 0) );

      if(TermTo < {curdate})
        if(Flag1 == 0)
          PrxSauth = "Срок полномочий" + string(TermTo:f) + " срок полномочий истек";
          Flag1 = 3;
        end;
      else
        
        if(Flag1 == 0 )
          PrxSauth = "до "; 
        else
          PrxSauth = PrxSauth + "\n до "; 
        end;
        
        if(TermTo != date(0, 0, 0))
          PrxSauth = PrxSauth + string(TermTo:f);
        else
          PrxSauth = PrxSauth + "постоянно";
        end;

        if(Account != "")
          PrxSauth = PrxSauth + ", счет " + Account;
        else
          PrxSauth = PrxSauth + ", любой счет";
        end;

        Flag1 = 1;
      end;
    end;

    println("право подписи: ", PrxSauth );

    Count = Count + 1;
  end;

  if( Count == 0 )
    println("Представителем не является" );
  end;

end;


/*начало - это добавляется по 127591*/
private macro _ПолучитьИсториюПримечания(client, noteKind)
  file notetext("notetext.dbt") key 5; /*по автоинкременту*/
  var retval = "";
  
  var strSql : string;
  var rs : RsdRecordset;

  strSql = "SELECT t_ID FROM dnotetext_dbt " + 
           " WHERE t_ObjectType = 3 " + 
           "   AND t_DocumentID = '" + UniID(client, OBJTYPE_PARTY) + "' " + 
           "   AND t_NoteKind = " + noteKind + " " +
           "   AND t_Date <= SYSDATE " + 
           " ORDER BY t_Date";

  rs = RsdRecordset(strSql);
  while(rs.MoveNext())
    ClearRecord(notetext);
    notetext.ID = rs.value(0);

    if(getEQ(notetext))
      retval = retval + "\n";
      retval = retval + GetNoteValue(notetext) + ", " + СотрудникПоСчету(notetext.Oper);
    end;
  end;

  return retval;      
end;

private macro _ПолучитьТекущееПримечание(client, noteKind)
  file notetext("notetext.dbt") key 5; /*по автоинкременту*/
  var retval = "";
  
  var strSql : string;
  var rs : RsdRecordset;

  strSql = "SELECT t_ID FROM dnotetext_dbt " + 
           " WHERE t_ObjectType = 3 " + 
           "   AND t_DocumentID = '" + UniID(client, OBJTYPE_PARTY) + "' " + 
           "   AND t_NoteKind = " + noteKind + " " +
           "   AND t_Date <= SYSDATE " + 
           "   AND t_ValidToDate >= SYSDATE";

  rs = RsdRecordset(strSql);
  if(rs.MoveNext())
    ClearRecord(notetext);
    notetext.ID = rs.value(0);

    if(getEQ(notetext))
      retval = GetNoteValue(notetext) + ", " + СотрудникПоСчету(notetext.Oper);
    end;
  end;

  return retval;      
end;

macro ПолучитьДатыОформленияАнкеты
(
  client, 
  АнкетаОформлена : @string, 
  АнкетаОбновлена : @string, 
  НеобходимостьИдентификации : @string
)
  var stat = 0;
  var ResultCode : integer;
  var NextCheckDate : date;
  var DiagClient : bool;
  var DiagProxy : bool;
  var DiagBeneficiary : bool;
  var DiagBeneOwner : bool;
  var FormCreateDate : date;

  АнкетаОформлена = _ПолучитьТекущееПримечание(client, 1);
  /*АнкетаОформлена = АнкетаОформлена + "\n" + _ПолучитьИсториюПримечания(client, 1);*/

  АнкетаОбновлена = _ПолучитьТекущееПримечание(client, 45);
  АнкетаОбновлена = АнкетаОбновлена + "\n" + _ПолучитьИсториюПримечания(client, 45);

  stat = PT_CheckNeedIndentifyParty
  (
    client.PartyID, //in Системный ID субъекта
    null, //[in] PARTY
    null, //[in] Дата, по состоянию на которую проверяется необходимость идентификации
    null, //[in] Системный ID обслуживающего филиала
    null, //[in] Флаговый признак необходимости учёта обслуживания в подчиненных филиалах
    null, //[in] Флаговый признак исключения из проверки субъектов, идентификация которых не проводится
    null, //[in] Флаговый признак проверки клиентов
    null, //[in] Флаговый признак проверки представителей субъекта
    null, //[in] Флаговый признак проверки выгодоприобретателей
    null, //[in] Флаговый признак проверки бенефициарных владельцев
    null, //[in] AlertDate
    @ResultCode        , //out см. описание кода результата выше
    @NextCheckDate     , //out Дата следующего обновления идентификации
    @DiagClient        , //out Диагностирована необходимость идентификации субъекта при варианте клиент
    @DiagProxy         , //out Диагностирована необходимость идентификации субъекта при варианте представитель субъекта
    @DiagBeneficiary   , //out Диагностирована необходимость идентификации субъекта при варианте выгодоприобретатель
    @DiagBeneOwner     , //out Диагностирована необходимость идентификации субъекта при варианте бенефициарный владелец
    @FormCreateDate      //out Дата оформления анкеты
  );

  if(not stat)
    if(ResultCode == 1)
      НеобходимостьИдентификации = "Идентификация не проводится";
    elif(ResultCode == 2)
      НеобходимостьИдентификации = "Идентификация не проводится";
    elif(ResultCode == 3)
      НеобходимостьИдентификации = "Истекает срок обновления анкеты: " + string(NextCheckDate:f) + ".\nРекомендуется обновить анкету.";
    elif(ResultCode == 4)
      НеобходимостьИдентификации = "Истек срок обновления анкеты: " + string(NextCheckDate:f) + ".\nНеобходимо обновить анкету.";
    end;
  end;
end;
/*окончание - это добавляется по 127591*/

macro GetCateg66(client)
 
  var RetStr = "";

  var ObjCat = RsbObjCategories( OBJTYPE_PARTY, UniID( client, OBJTYPE_PARTY ));

  /*63 "Хозяйственное общество, имеющее стратегическое значение", Категория множественная*/
  if( ObjCat.GetFirst( 63, {curdate}, attr ) == 0)
    if(RetStr != "")
      RetStr = RetStr + "\n";  
    end;

    RetStr = RetStr + "Хозяйственное общество, имеющее стратегическое значение: ";

    RetStr = RetStr + attr.Name;
    while( ObjCat.GetNext( attr ) == 0)
     RetStr = RetStr + ", " + attr.Name;
    end;
  end;

  // Если у субъекта имеется признак "Нежелательная иностранная или международная НПО" категории 16 "Тип субъекта", внести краткое название этого признака.
  if(ObjCat.IsAttrPresense(16, 12, null, null, true, {curdate}))
    if(RetStr != "")
      RetStr = RetStr + "\n";  
    end;

    RetStr = RetStr + "Нежелательная иностранная или международная НПО";  
    /*
    ClearRecord( attr );
    attr.ObjectType = 3;
    attr.GroupID    = 16;
    attr.AttrID     = 12;
    
    if( GetEQ(attr) )
      RetStr = RetStr + attr.Name;
    end;
    */
  end;
  
  // Если у субъекта имеется признак "Иностранная структура без образования юридического ли-ца" категории 16 "Тип субъекта", 
   ClearRecord(objgroup);
   objgroup.ObjectType = OBJTYPE_PARTY;
   objgroup.GroupID = 11;

   var addFlag = false;
   if ( GetEQ(objgroup) )

      ClearRecord(objattr2);

      objattr2.ObjectType = OBJTYPE_PARTY;
      objattr2.GroupID = 16;
//      objattr2.CodeList  = "";
      objattr2.NumInList = "11";

      if ( GetEQ(objattr2) )
        if(ObjCat.IsAttrPresense(16, objattr2.AttrID, null, null, true, {curdate}))
          addFlag = true;
        end;
  
        var strSql = " SELECT t_AttrID FROM dobjattr_dbt WHERE T_OBJECTTYPE = 3 AND T_GROUPID = 16 " +
                     " START WITH T_PARENTID = "+ objattr2.AttrID + " AND T_OBJECTTYPE = 3 AND T_GROUPID = 16 " +
                     " CONNECT BY PRIOR T_ATTRID = T_PARENTID AND T_OBJECTTYPE = 3 AND T_GROUPID = 16 ";

        var rs = RsdRecordset( strSql );
        var AttrID = 0;
        var AddStr = "";
        while( rs.MoveNext() )
          AttrID = rs.value( 0 );

          ClearRecord( attr );
          attr.ObjectType = 3;
          attr.GroupID    = 16;
          attr.AttrID   = AttrID;
          
//          OBJATTR

          if( GetEQ(attr) )

            if(ObjCat.IsAttrPresense(16, AttrID, null, null, true, {curdate}))
              if(AddStr == "")                      
                AddStr = AddStr + ": ";  
              else
                AddStr = AddStr + ", ";  
              end;

              AddStr = AddStr + attr.Name;
              addFlag = true;
            end;
          end;

        end;


         if(addFlag == true)   // "Иностранная структура без образования юридического ли-ца"
           if(RetStr != "")
             RetStr = RetStr + "\n";  
           end;
  
           RetStr = RetStr + objattr2.Name;
         end;
         
         RetStr = RetStr + AddStr;

    end;
  end;

  return RetStr;
end;


macro IsForeignParty(client)
  var objectid = UniID(client, OBJTYPE_PARTY);

  var query =  "SELECT count(1) FROM dobjatcor_dbt WHERE t_ObjectType = 3 AND t_Object = :Object AND t_GroupID = 16 "
                          "AND T_VALIDFROMDATE <= :VALIDFROMDATE  AND (T_VALIDTODATE = to_date('01.01.0001', 'DD.MM.YYYY') OR T_VALIDTODATE >= :VALIDTODATE) "
                          "AND t_AttrID IN (SELECT t_AttrID FROM dobjattr_dbt WHERE T_OBJECTTYPE = 3 AND T_GROUPID = 16 "
                          "START WITH T_ATTRID IN (select t_attrID from dobjattr_dbt where t_ObjectType = 3 AND t_GroupID = 16 AND t_NumInList = '11') AND T_OBJECTTYPE = 3 AND T_GROUPID = 16 "
                          "CONNECT BY PRIOR T_ATTRID = T_PARENTID AND T_OBJECTTYPE = 3 AND T_GROUPID = 16) ";


  var Nrec = 0;
  var params = makeArray(SQLParam("Object", objectid),
                         SQLParam("VALIDFROMDATE", {curdate}),
                         SQLParam("VALIDTODATE", {curdate}));

  var rs = execSQLselect(query, params, false);

  if(rs and rs.moveNext())
    Nrec = int(rs.value(0));
  end;

  if(Nrec > 0)
    return true;
  else
    return false;
  end;
end;



macro PrintPlaceWork(PartyID)
    var result = "";
    var cmd = RsdCommand("SELECT T1.T_PLACEWORK, DECODE(T1.T_POST, CHR(1), DECODE(T2.T_NAME, NULL, CHR(1)), T1.T_POST), T_DATE "
                        "    FROM DPERSNPLACEWORK_DBT T1, DLLVALUES_DBT T2 "
                        "   WHERE     T_PARTYID = ? "
                        "         AND T2.T_ELEMENT(+) = T1.T_POSTTYPE "
                        "         AND T2.T_LIST(+) = 4036 "
                        "ORDER BY T_ISMAIN DESC, T_ID ASC");
    cmd.addParam("", RSDBP_IN, PartyID);
    cmd.NullConversion = true;
    cmd.execute();
    var rs = RsdRecordset(cmd);
        
    while (rs.MoveNext())
        if (result != "")
            result = result + "; "; 
        end;
        result = result + rs.value(0);
            
        if (strlen(rs.value(1)))
           result = result + ", " + rs.value(1);
        end;
            
        if (rs.value(2) != ZeroValue(V_DATE))
            result = result + " c " + String(Date(rs.value(2)):f);
        end;
    end;
    
    return result;
end;


