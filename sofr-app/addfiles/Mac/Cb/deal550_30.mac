//-----------------------------------------------------------------------------
// Блок      : 26002 - "Обработка отвергнутой сделки"
// Шаг       : 30    - "Отвержение сделки"
// Назначение: Макрос шага
// Описание  : Макрос шага
//-----------------------------------------------------------------------------

import PaymInter, InsCarryDoc, "oralib.mac", "likepy.mac";

var PaymentObj: RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
MACRO ExecuteStep( doc, paymDoc, KindDoc, ID_Operation, ID_Step )
  var pmlink = existsSQLselect(string("select 1 from dpmpaym_dbt pmpaym, dpmlink_dbt pmlink where ",
                                      " pmlink.t_InitialPayment = ? ",
                                  " and pmlink.t_LinkKind = ? ",
                                  " and pmlink.t_PurposePayment = pmpaym.t_PaymentID "),
                        makeArray(SQLParam("", PaymentObj.PaymentID),
                                  SQLParam("", PMLINK_KIND_DEALPAYMENT)));
  if (pmlink)
    msgbox("Исполнение сделки невозможно. Не завершена обработка документов сделки");
    return 1;
  end;

  if(not InsertOprStatus(2601, 2 )) //Отвергнута
    msgbox("Ошибка при установке статуса платежа");
    return 1;
  end;
  PaymentObj.PaymStatus = PM_REJECTED;
  return 0;
END;