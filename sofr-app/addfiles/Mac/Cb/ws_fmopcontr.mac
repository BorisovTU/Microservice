Import ws_lib_fun, fm_str, BankInter, GateInter;
Import FMInter, PTInter, FIInter, "globals.mac";

const FM_OPERATION5_50 = 3100;

/*
    Класс TWsGateFmOpContr - информация об операции ФМ во внешней системе
*/
class TWsGateFmOpContr

  var Type          : integer; /* Вид операции. */
                               /* Возможные значение:
                                  1 - Операция по легализации
                                  2 - Операция отказа от заключения договора банковского счета (ОС)
                                  3 - Операция отказа от проведения операции (ОО)
                                  4 - Операция расторжения договора счета (ОД)*/
  var Oper          : integer; /* Операционист */
  var FmDate        : date   ; /* Дата ввода */
  var Code_Currency : string ; /* Идентификатор ФИ счета во внешней системе, вызывающей сервис. Если внешняя система, не идентифицировала себя при вызове, то принимаем, что по умолчанию это код ISO. */
  var SumRub        ;//: money  ; /* Сумма в рублях */
  var SumCur        ;//: money  ; /* Сумма в валюте */
  var Date_Carry    : date   ; /* Дата проводки */
  var Ground        : string ; /* Основание */
  var Carry_Oper    : integer; /* Операционист, проводивший док-т */
  var Terror        : integer; /* Признак опер. связан. с терроризмом */
  var AttrBankPayer : integer; /* Признак банка плательщика */
  var AttrBankReceiver : integer; /* Признак банка получателя */
  var AttrOpAssign  : integer; /* Признак совер. операции по поручению */
  var Date_S        : date   ; /* Дата выявления */
  var NumbDoc       : string ; /* Номер документа-источника */
  var DatePayD      : date   ; /* Дата документа-источника */
  var SumConv       ;//: money  ; /* Конверсия_сумма */
  var CurConv       : integer; /* Конверсия_валюта */
  var TypeMeans     : integer; /* Вид средств */
  var RejectCode    : integer; /* Основание операции отказа */
  var Action        : integer; /* Вид действия над операцией ФМ. Возможные значения: MODIFY_IN, MODIFY_ALL */
end;

/*
    Класс TWsGateFmOpCnAddr - информация об адресах участников операции ФМ
 */
class TWsGateFmOpCnAddr

  var Region   : string; /* Регион: вид + название */
  var OKATO    : string; /* ОКАТО */
  var Place    : string; /* Населенный пункт: вид + название*/
  var Street   : string; /* Улица: вид + название */
  var House    : string; /* Номер дома (владения) */
  var Building : string; /* Номер корпуса (строения) */
  var Apartment: string; /* Квартира (офис) */
  var Code     : string; /* Код КЛАДР */
  var Action   : integer; /* Вид действия над операцией ФМ. */
end;

/*
    Класс TWsGateFmOpCntrPt - информация об участниках операции ФМ во внешней системе (5.50).
 */
class TWsGateFmOpCntrPt

  var Kind         : integer; /* Код вида участника */
  var ClientCode   : string ; /* Идентификатор клиента счета во внешней системе, вызывающей сервис. Если внешняя система, не идентифицировала себя при вызове, то принимаем, что по умолчанию это код вида ClientCodeKind. */
  var Type         : string ; /* Код типа участника. Возможные значения:'Н' - невозможно установить тип участника операции 
                                                                      'Ю' - юридическое лицо
                                                                      'Ф' - физическое лицо
                                                                      'П' - ПБОЮЛ            */
  var Name         : string ; /* Название */
  var szCountryR   : string ; /* Страна регистрации */
  var szTerritoryR : string ; /* Территория регистрации */
  var szAddressR   : string ; /* Адрес регистрации */
  var szCountryP   : string ; /* Страна нахождения */
  var szTerritoryP : string ; /* Территория нахождения */
  var szAddressP   : string ; /* Адрес нахождения */
  var CodeDocum    : string ; /* Документ, удостоверяющий личность */
  var PaperSeries  : string ; /* Серия документа */
  var PaperNumber  : string ; /* Номер документа */
  var PaperIssuedDate : date; /* Дата выдачи */
  var PaperIssuer  : string ; /* Кем выдан */
  var Birthday     : date   ; /* Дата рождения */
  var INN          : string ; /* ИНН */
  var OKPO         : string ; /* ОКПО */
  var RegNumber    : string ; /* Регистрационный номер */
  var AttrParty    : string ; /* Признак участника */
  var AccountParty : string ; /* Номер счета плат. или получ. */
  var NameKO       : string ; /* Наименование КО */
  var CountryKO    : integer; /* Код места нахождения КО */
  var TerritoryKO  : integer; /* Код территории */
  var BICKO        : string ; /* БИК банка */
  var NameKOCor    : string ; /* Наименование банка-корр. КО */
  var CountryKOCor : integer; /* Код места нахождения банка-корр. КО */
  var TerritoryKOCor : integer; /* Код территории */
  var BICKOCor     : string ; /* БИК банка-корр. */
  var NameHO       : string ; /* Наименование вышестоящей организации */
  var HOCountry    : integer; /* Код страны регистрации */
  var HOTerritory  : integer; /* Код территории */
  var HOAddress    : string ; /* Место регистрации */
  var CodeDocumSt  : string ; /* Код типа документа на пребывание */
  var InfoDocumSt  : string ; /* Сведения о документе на пребывание */
  var InfoMigrMap  : string ; /* Данные миграционной карты */
  var DocStBegin   : date   ; /* Дата документа на пребывание */
  var DocStEnd     : date   ; /* Дата документа на пребывание */
  var MigrMapBegin : date   ; /* Дата миграционной карты */
  var MigrMapEnd   : date   ; /* Дата миграционной карты */
  var CorAccount   : string ; /* Корреспон. счет */
  var PIPDL        : string ; /* ПИПДЛ (Принадлежность к ИДПЛ) 
                                 Возможные значение:
                                 пустая строка - Значение "не задано". Используется как значение по умолчанию, а также для участников, являющихся юридическими лицами.
                                 "00" - Принадлежность к ИДПЛ: в ином случае.
                                 "01" - Принадлежность к ИДПЛ: является ИДПЛ.
                                 "02" - Принадлежность к ИДПЛ: родственник ИДПЛ. */
  var ProfitGainer : integer; /* Наличие выгодоприобретателя */
  var CardCode     : integer; /* Сведения об использовании БК код */
  var CardBIC      : string ; /* БИК эмитента */
  var CardCaption  : string ; /* Сведения об использовании БК наименов */
  var szAddressB   : string ; /* Место рождения */
  var VD           : string ; /* Код подразделения */
  var RegAdress    : TWsGateFmOpCnAddr; /* Адрес регистрации */
  var FactAdress   : TWsGateFmOpCnAddr; /* Фактический адрес (адрес местонахождения) */
  var Action       : integer; /* Вид действия над операцией ФМ. */
end;

/*
    Класс TWsGateFmOpCode - информация о коде операции ФМ
 */
class TWsGateFmOpCode

  var Code     : string ; /* Код операции */
  var CodeKind : integer; /* Вид кода операции. 
                             Возможные значений:
                             1 - Код операции для контроля (ОК)
                             2 - Код необычных операций (НО) */
  var Action   : integer; /* Вид действия над операцией ФМ. 
                             Возможны значение:
                             ADD
                             REMOVE. */
end;

/*
    Класс TWsGateFmOpContrParm
 */
class TWsGateFmOpContrParm

  var OpContr      : TWsGateFmOpContr; /* Параметры операции ФМ - объект класса TWsGateFmOpContr */
  var OpCntrPtList : TArray; /*of TWsGateFmOpCntrPt; */ /* Участники операции ФМ - массива объектов класса TWsGateFmOpCntrPt */
  var OpCodeList   : TArray; /* of TWsGateFmOpCode; */ /* Коды операции ФМ - массива объектов класса TWsGateFmOpCode */
end;

private macro _CreateOpContr /* Создание операции ФМ. */
(
  wsOpContr : TWsGateFmOpContr
 ,iAppID : integer
 ,OpContr /*: TWsGateFmOpContr*/     /* Параметры операции ФМ. */
)

  var ParamN      : integer;
  var ObjectName  : string;
 
  var FIID : integer; /* ИД фининструмента лицевого счета */

  ParamN     = 1;
  ObjectName = "OpContr";

  record fininstr("fininstr.dbt");

  WS_SetAttributeValue( @wsOpContr.Type, ParamN, ObjectName, "Type", OpContr, V_INTEGER , true, null, true );

  if( OpContr.Code_Currency != null )
    FIID = WS_GetFIID( OpContr.Code_Currency, iAppID );
  end;
  if( FIID != null ) wsOpContr.Code_Currency = FIID; end;

  WS_SetAttributeValue( @wsOpContr.Date_Carry      , ParamN, ObjectName, "Date_Carry"      , OpContr, V_DATE   , true, null, true  );
  WS_SetAttributeValue( @wsOpContr.FmDate          , ParamN, ObjectName, "FmDate"          , OpContr, V_DATE   , true, null, true  );
  WS_SetAttributeValue( @wsOpContr.SumCur          , ParamN, ObjectName, "SumCur"          , OpContr, V_MONEY  , true, null, true  );
  WS_SetAttributeValue( @wsOpContr.SumRub          , ParamN, ObjectName, "SumRub"          , OpContr, V_MONEY  , true, null, true  );
  WS_SetAttributeValue( @wsOpContr.Oper            , ParamN, ObjectName, "Oper"            , OpContr, V_INTEGER, false, null, true );
  WS_SetAttributeValue( @wsOpContr.Carry_Oper      , ParamN, ObjectName, "Carry_Oper"      , OpContr, V_INTEGER, false, null, true );
  WS_SetAttributeValue( @wsOpContr.Ground          , ParamN, ObjectName, "Ground"          , OpContr, V_STRING , true, null, true  );
  WS_SetAttributeValue( @wsOpContr.Terror          , ParamN, ObjectName, "Terror"          , OpContr, V_INTEGER, false, null, true );
  WS_SetAttributeValue( @wsOpContr.AttrBankPayer   , ParamN, ObjectName, "AttrBankPayer"   , OpContr, V_INTEGER, false, null, true );
  WS_SetAttributeValue( @wsOpContr.AttrBankReceiver, ParamN, ObjectName, "AttrBankReceiver", OpContr, V_INTEGER, false, null, true );  
  WS_SetAttributeValue( @wsOpContr.AttrOpAssign    , ParamN, ObjectName, "AttrOpAssign"    , OpContr, V_INTEGER, false, null, true );   
  WS_SetAttributeValue( @wsOpContr.Date_S          , ParamN, ObjectName, "Date_S"          , OpContr, V_DATE   , false, null, true );   
  WS_SetAttributeValue( @wsOpContr.NumbDoc         , ParamN, ObjectName, "NumbDoc"         , OpContr, V_STRING , false, null, true );   
  WS_SetAttributeValue( @wsOpContr.DatePayD        , ParamN, ObjectName, "DatePayD"        , OpContr, V_DATE   , false, null, true );   
  //WS_SetAttributeValue( @wsOpContr.CurConv         , ParamN, ObjectName, "CurConv"         , OpContr, V_INTEGER, false, null, true );   
  if( OpContr.CurConv != null )
    if( ПолучитьФинИнПоISO(OpContr.CurConv, fininstr) )
      wsOpContr.CurConv = fininstr.FIID;
    end;
  end;

  WS_SetAttributeValue( @wsOpContr.SumConv         , ParamN, ObjectName, "SumConv"         , OpContr, V_MONEY  , false, null, true );   
  WS_SetAttributeValue( @wsOpContr.TypeMeans       , ParamN, ObjectName, "TypeMeans"       , OpContr, V_INTEGER, false, null, true );

  if(OpContr.Type == 1) 
    WS_SetAttributeValue( @wsOpContr.RejectCode      , ParamN, ObjectName, "RejectCode"      , OpContr, V_INTEGER, false, null, true );
  else
    if(OpContr.Type == 2)
      if( (OpContr.RejectCode >= 1) AND (OpContr.RejectCode <= 5) )
        WS_SetAttributeValue( @wsOpContr.RejectCode  , ParamN, ObjectName, "RejectCode"      , OpContr, V_INTEGER,  true, null, true );
      else
        RunError("Недопустимое значение основания операции отказа");
      end;
    else if(OpContr.Type == 3)
      if( (OpContr.RejectCode == 7) OR (OpContr.RejectCode == 8) )
        WS_SetAttributeValue( @wsOpContr.RejectCode  , ParamN, ObjectName, "RejectCode"      , OpContr, V_INTEGER,  true, null, true );
      else
        RunError("Недопустимое значение основания операции отказа");
      end;
    else if(OpContr.Type == 4)
      if(OpContr.RejectCode == 9)
        WS_SetAttributeValue( @wsOpContr.RejectCode  , ParamN, ObjectName, "RejectCode"      , OpContr, V_INTEGER,  true, null, true );
      else
        RunError("Недопустимое значение основания операции отказа");
      end;
    end;
    end;
    end;
  end;

end;

/*
    функция инициализации fmopr
 */
private macro _Record_OpContr( fmopr, wsOpContr : TWsGateFmOpContr)

  if( wsOpContr.Type             != null ) fmopr.OperationType    = wsOpContr.Type            ; end;
  if( wsOpContr.Code_Currency    != null ) fmopr.FIID             = wsOpContr.Code_Currency   ; end;  
  if( wsOpContr.Date_Carry       != null ) fmopr.DateCarry        = wsOpContr.Date_Carry      ; end;
  if( wsOpContr.FmDate           != null ) fmopr.Date             = wsOpContr.FmDate          ; end;
  if( wsOpContr.SumCur           != null ) fmopr.Sum              = wsOpContr.SumCur          ; end;
  if( wsOpContr.SumRub           != null ) fmopr.SumEquivalent    = wsOpContr.SumRub          ; end;
  if( wsOpContr.Oper             != null ) fmopr.Oper             = wsOpContr.Oper            ; end;
  if( wsOpContr.Carry_Oper       != null ) fmopr.Executer         = wsOpContr.Carry_Oper      ; end;
  if( wsOpContr.Ground           != null ) fmopr.Ground           = wsOpContr.Ground          ; end;
  if( wsOpContr.Terror           != null ) fmopr.TerrorSign       = wsOpContr.Terror          ; end;
  if( wsOpContr.AttrBankPayer    != null ) fmopr.PayerBankSign    = wsOpContr.AttrBankPayer   ; end;
  if( wsOpContr.AttrBankReceiver != null ) fmopr.ReceiverBankSign = wsOpContr.AttrBankReceiver; end;
  if( wsOpContr.AttrOpAssign     != null ) fmopr.OprByOrderSign   = wsOpContr.AttrOpAssign    ; end;
  if( wsOpContr.Date_S           != null ) fmopr.DateReveal       = wsOpContr.Date_S          ; end;
  if( wsOpContr.NumbDoc          != null ) fmopr.PaymDocNumber    = wsOpContr.NumbDoc         ; end;
  if( wsOpContr.DatePayD         != null ) fmopr.PaymDocDate      = wsOpContr.DatePayD        ; end;
  if( wsOpContr.CurConv          != null ) fmopr.ConvOprCurrency  = wsOpContr.CurConv         ; end;
  if( wsOpContr.SumConv          != null ) fmopr.ConvOprSum       = wsOpContr.SumConv         ; end;
  if( wsOpContr.TypeMeans        != null ) fmopr.MoneySign        = wsOpContr.TypeMeans       ; end;
  if( wsOpContr.RejectCode       != null ) fmopr.RejectCode       = wsOpContr.RejectCode      ; end;

end;


private macro _CreateOpCntrPt /* Создание участника операции . */
(
  fmopr  //: RsbFMOperation
 ,wsOpContrPt : TWsGateFmOpCntrPt
 ,iAppID : integer
 ,OpCntrPt /*: TArray */     /* Участники операции ФМ. */
)


  var RegAdress, FactAdress;

  var wsRegAdress : TWsGateFmOpCnAddr;
      wsRegAdress = TWsGateFmOpCnAddr;

  var wsRFactAdress : TWsGateFmOpCnAddr;
      wsRFactAdress = TWsGateFmOpCnAddr;

  var ParamN      : integer;
  var ObjectName  : string;
 
  var Kind : integer;
  var PartySign : string;
  var PaperIssuer : string;  
  var PaperIssuerCode : string;
  
  var Client        : integer; /* ИД клиента лицевого счета        */
  var ClientCode : string;

  ParamN     = 1;
  ObjectName = "OpCntrPt";

  var OprParty;

  WS_SetAttributeValue( @RegAdress , 1, "", "RegAdress" , OpCntrPt, V_GENOBJ, false, null, true );
  WS_SetAttributeValue( @FactAdress, 1, "", "FactAdress", OpCntrPt, V_GENOBJ, false, null, true );

  WS_SetAttributeValue( @Kind, ParamN, ObjectName, "Kind",  OpCntrPt, V_INTEGER, false, null, true ); ///false null ???   

  if(Kind != 0)
      OprParty = fmopr.OprParty(Kind);

    WS_SetAttributeValue( @wsOpContrPt.AttrParty, ParamN, ObjectName, "AttrParty", OpCntrPt, V_STRING , false, null, true );   
    if( wsOpContrPt.AttrParty != null ) OprParty.PartySign  = int(wsOpContrPt.AttrParty); end;
 
 
    WS_SetAttributeValue( @ClientCode, ParamN, ObjectName, "ClientCode",  OpCntrPt, V_STRING, false, null, true );       
    /* определяем клиента счета */
    if( ClientCode != null )
      Client = WS_GetPartyID( ClientCode, NULL, iAppID );
    end;
    /* Заполняем буфер лицевого счета */
    if( Client != null ) OprParty.PartyID = Client; end;
 
    WS_SetAttributeValue( @wsOpContrPt.Type, ParamN, ObjectName, "Type",  OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.Type != null ) OprParty.PartyType  = wsOpContrPt.Type; end;

    if( (OprParty.PartyType != "Ю") OR (OprParty.PartyType != "Ф") OR (OprParty.PartyType != "П") OR (OprParty.PartyType != "Н") )
      OprParty.PartyType == "Н"
    end;
    
    WS_SetAttributeValue( @wsOpContrPt.Name, ParamN, ObjectName, "Name", OpCntrPt, V_STRING , false, null, true );   
    if( wsOpContrPt.Name != null ) OprParty.Name  = wsOpContrPt.Name; end;

    WS_SetAttributeValue( @wsOpContrPt.PIPDL, ParamN, ObjectName, "PIPDL", OpCntrPt, V_STRING , false, null, true );   
    if( wsOpContrPt.PIPDL != null ) OprParty.ForeignPublicFunctionary  = wsOpContrPt.PIPDL; end;
    
    WS_SetAttributeValue( @wsOpContrPt.szCountryR, ParamN, ObjectName, "szCountryR", OpCntrPt, V_STRING , false, null, true );
    if( wsOpContrPt.szCountryR != null ) OprParty.RegCountry  = wsOpContrPt.szCountryR; end;

    WS_SetAttributeValue( @wsOpContrPt.szTerritoryR, ParamN, ObjectName, "szTerritoryR", OpCntrPt, V_STRING , false, null, true );   
    if( wsOpContrPt.szTerritoryR != null ) OprParty.RegTerritory  = wsOpContrPt.szTerritoryR; end;

    WS_SetAttributeValue( @wsOpContrPt.szAddressR              , ParamN, ObjectName, "szAddressR", OpCntrPt          , V_STRING , false, null, true );   
    if( wsOpContrPt.szAddressR != null ) OprParty.RegAddress  = wsOpContrPt.szAddressR; end;

//////////////////////////////////?????????????????????????????
    WS_SetAttributeValue( @wsRegAdress.OKATO, ParamN, ObjectName, "OKATO", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.OKATO != null ) OprParty.RegAddrOKATO  = wsRegAdress.OKATO; end;
    
    WS_SetAttributeValue( @wsRegAdress.Region, ParamN, ObjectName, "Region", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.Region != null ) OprParty.RegAddrRegion  = wsRegAdress.Region; end;
    
    WS_SetAttributeValue( @wsRegAdress.Place, ParamN, ObjectName, "Place", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.Place != null ) OprParty.RegAddrPlaceName  = wsRegAdress.Place; end;
    
    WS_SetAttributeValue( @wsRegAdress.Street, ParamN, ObjectName, "Street", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.Street != null ) OprParty.RegAddrStreet  = wsRegAdress.Street; end;

    WS_SetAttributeValue( @wsRegAdress.House, ParamN, ObjectName, "House", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.House != null ) OprParty.RegAddrHouse  = wsRegAdress.House; end;

    WS_SetAttributeValue( @wsRegAdress.Building, ParamN, ObjectName, "Building", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.Building != null ) OprParty.RegAddrBuilding  = wsRegAdress.Building; end;

    WS_SetAttributeValue( @wsRegAdress.Apartment, ParamN, ObjectName, "Apartment", RegAdress, V_STRING, false, null, true );   
    if( wsRegAdress.Apartment != null ) OprParty.RegAddrOffice  = wsRegAdress.Apartment; end;
///////////////////////////////////

    WS_SetAttributeValue( @wsOpContrPt.szCountryP, ParamN, ObjectName, "szCountryP", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.szCountryP != null ) OprParty.StayCountry  = wsOpContrPt.szCountryP; end;

    WS_SetAttributeValue( @wsOpContrPt.szTerritoryP, ParamN, ObjectName, "szTerritoryP", OpCntrPt, V_STRING , false, null, true );   
    if( wsOpContrPt.szTerritoryP != null ) OprParty.StayTerritory  = wsOpContrPt.szTerritoryP; end;
        
    WS_SetAttributeValue( @wsOpContrPt.szAddressP             , ParamN, ObjectName, "szAddressP", OpCntrPt          , V_STRING , false, null, true );   
    if( wsOpContrPt.szAddressP != null ) OprParty.StayAddress  = wsOpContrPt.szAddressP; end;

//////////////////////////////////
    WS_SetAttributeValue( @wsRFactAdress.OKATO, ParamN, ObjectName, "OKATO", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.OKATO != null ) OprParty.StayAddrOKATO  = wsRFactAdress.OKATO; end;

    WS_SetAttributeValue( @wsRFactAdress.Region, ParamN, ObjectName, "Region", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.Region != null ) OprParty.StayAddrRegion  = wsRFactAdress.Region; end;

    WS_SetAttributeValue( @wsRFactAdress.Place, ParamN, ObjectName, "Place", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.Place != null ) OprParty.StayAddrPlaceName  = wsRFactAdress.Place; end;

    WS_SetAttributeValue( @wsRFactAdress.Street, ParamN, ObjectName, "Street", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.Street != null ) OprParty.StayAddrStreet  = wsRFactAdress.Street; end;

    WS_SetAttributeValue( @wsRFactAdress.House, ParamN, ObjectName, "House", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.House != null ) OprParty.StayAddrHouse  = wsRFactAdress.House; end;

    WS_SetAttributeValue( @wsRFactAdress.Building, ParamN, ObjectName, "Building", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.Building != null ) OprParty.StayAddrBuilding  = wsRFactAdress.Building; end;

    WS_SetAttributeValue( @wsRFactAdress.Apartment, ParamN, ObjectName, "Apartment", FactAdress, V_STRING, false, null, true );   
    if( wsRFactAdress.Apartment != null ) OprParty.StayAddrOffice  = wsRFactAdress.Apartment; end;
///////////////////////////////////

    WS_SetAttributeValue( @wsOpContrPt.RegNumber, ParamN, ObjectName, "RegNumber", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.RegNumber != null ) OprParty.RegNumber  = wsOpContrPt.RegNumber; end;

    WS_SetAttributeValue( @wsOpContrPt.INN, ParamN, ObjectName, "INN", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.INN != null ) OprParty.INN  = wsOpContrPt.INN; end;
    
    WS_SetAttributeValue( @wsOpContrPt.OKPO, ParamN, ObjectName, "OKPO", OpCntrPt, V_STRING, false, null, true, true );   
    if( wsOpContrPt.OKPO != null ) OprParty.OKPO  = wsOpContrPt.OKPO; end;
    
    WS_SetAttributeValue( @wsOpContrPt.Birthday, ParamN, ObjectName, "Birthday", OpCntrPt, V_DATE, false, null, true );   
    if( wsOpContrPt.Birthday != null ) OprParty.Birthday  = wsOpContrPt.Birthday; end;
    
    WS_SetAttributeValue( @wsOpContrPt.szAddressB, ParamN, ObjectName, "szAddressB", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.szAddressB != null ) OprParty.BirthPlace  = wsOpContrPt.szAddressB; end;
    
    WS_SetAttributeValue( @wsOpContrPt.CodeDocum, ParamN, ObjectName, "CodeDocum", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.CodeDocum != null ) OprParty.CodeDocum  = wsOpContrPt.CodeDocum; end;
    
    WS_SetAttributeValue( @wsOpContrPt.PaperSeries, ParamN, ObjectName, "PaperSeries", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.PaperSeries != null ) OprParty.PaperSeries  = wsOpContrPt.PaperSeries; end;    

    WS_SetAttributeValue( @wsOpContrPt.PaperNumber, ParamN, ObjectName, "PaperNumber", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.PaperNumber != null ) OprParty.PaperNumber  = wsOpContrPt.PaperNumber; end;

    WS_SetAttributeValue( @wsOpContrPt.PaperIssuedDate, ParamN, ObjectName, "PaperIssuedDate", OpCntrPt, V_DATE, false, null, true );   
    if( wsOpContrPt.PaperIssuedDate != null ) OprParty.PaperIssuedDate  = wsOpContrPt.PaperIssuedDate; end;

    WS_SetAttributeValue( @wsOpContrPt.PaperIssuer, ParamN, ObjectName, "PaperIssuer", OpCntrPt, V_STRING, false, null, true );   
    WS_SetAttributeValue( @wsOpContrPt.VD, ParamN, ObjectName, "VD", OpCntrPt, V_STRING, false, null, true );   

    if(wsOpContrPt.PaperIssuer != null)
      OprParty.PaperIssuer  = wsOpContrPt.PaperIssuer;
      if(wsOpContrPt.VD != null)
        OprParty.PaperIssuer = wsOpContrPt.PaperIssuer + ". Код подразделения " + wsOpContrPt.VD;
      end; 
    end;

    WS_SetAttributeValue( @wsOpContrPt.NameHO, ParamN, ObjectName, "NameHO", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.NameHO != null ) OprParty.SuperiorName  = wsOpContrPt.NameHO; end;

    WS_SetAttributeValue( @wsOpContrPt.HOCountry, ParamN, ObjectName, "HOCountry", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.HOCountry != null ) OprParty.SuperiorCountry  = wsOpContrPt.HOCountry; end;

    WS_SetAttributeValue( @wsOpContrPt.HOTerritory, ParamN, ObjectName, "HOTerritory", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.HOTerritory != null ) OprParty.SuperiorTerritory  = wsOpContrPt.HOTerritory; end;

    WS_SetAttributeValue( @wsOpContrPt.HOAddress, ParamN, ObjectName, "HOAddress", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.HOAddress != null ) OprParty.SuperiorAddress  = wsOpContrPt.HOAddress; end;

    WS_SetAttributeValue( @wsOpContrPt.CodeDocumSt, ParamN, ObjectName, "CodeDocumSt", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.CodeDocumSt != null ) OprParty.RightVisitDocCode  = wsOpContrPt.CodeDocumSt; end;

    WS_SetAttributeValue( @wsOpContrPt.InfoDocumSt, ParamN, ObjectName, "InfoDocumSt", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.InfoDocumSt != null ) 
      OprParty.RightVisitDocSeries  = substr(wsOpContrPt.InfoDocumSt, 1, 20);
      if(strlen(wsOpContrPt.InfoDocumSt) > 20)
        OprParty.RightVisitDocNumber  = substr(wsOpContrPt.InfoDocumSt, 21, 20);
      end; 
    end;

    WS_SetAttributeValue( @wsOpContrPt.DocStBegin, ParamN, ObjectName, "DocStBegin", OpCntrPt, V_DATE, false, null, true );   
    if( wsOpContrPt.DocStBegin != null ) OprParty.RightVisitDocDateStart  = wsOpContrPt.DocStBegin; end;

    WS_SetAttributeValue( @wsOpContrPt.DocStEnd, ParamN, ObjectName, "DocStEnd", OpCntrPt, V_DATE, false, null, true );   
    if( wsOpContrPt.DocStEnd != null ) OprParty.RightVisitDocDateEnd  = wsOpContrPt.DocStEnd; end;

    WS_SetAttributeValue( @wsOpContrPt.InfoMigrMap, ParamN, ObjectName, "InfoMigrMap", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.InfoMigrMap != null ) OprParty.MigratoryCardNumber  = wsOpContrPt.InfoMigrMap; end;

    WS_SetAttributeValue( @wsOpContrPt.MigrMapBegin, ParamN, ObjectName, "MigrMapBegin", OpCntrPt, V_DATE, false, null, true );   
    if( wsOpContrPt.MigrMapBegin != null ) OprParty.MigratoryCardDateStart  = wsOpContrPt.MigrMapBegin; end;

    WS_SetAttributeValue( @wsOpContrPt.MigrMapEnd, ParamN, ObjectName, "MigrMapEnd", OpCntrPt, V_DATE, false, null, true );   
    if( wsOpContrPt.MigrMapEnd != null ) OprParty.MigratoryCardDateEnd  = wsOpContrPt.MigrMapEnd; end;

    WS_SetAttributeValue( @wsOpContrPt.ProfitGainer, ParamN, ObjectName, "ProfitGainer", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.ProfitGainer != null ) OprParty.BeneficiarySign  = wsOpContrPt.ProfitGainer; end;

    WS_SetAttributeValue( @wsOpContrPt.AccountParty, ParamN, ObjectName, "AccountParty", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.AccountParty != null ) OprParty.Account  = wsOpContrPt.AccountParty; end;

    WS_SetAttributeValue( @wsOpContrPt.CorAccount, ParamN, ObjectName, "CorAccount", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.CorAccount != null ) OprParty.CorrAccount  = wsOpContrPt.CorAccount; end;

    WS_SetAttributeValue( @wsOpContrPt.BICKO, ParamN, ObjectName, "BICKO", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.BICKO != null ) OprParty.BankCode  = wsOpContrPt.BICKO; end;

    WS_SetAttributeValue( @wsOpContrPt.NameKO, ParamN, ObjectName, "NameKO", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.NameKO != null ) OprParty.BankName  = wsOpContrPt.NameKO; end;
    
    WS_SetAttributeValue( @wsOpContrPt.CountryKO, ParamN, ObjectName, "CountryKO", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.CountryKO != null ) OprParty.BankCountry  = wsOpContrPt.CountryKO; end;

    WS_SetAttributeValue( @wsOpContrPt.TerritoryKO, ParamN, ObjectName, "TerritoryKO", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.TerritoryKO != null ) OprParty.BankTerritory  = wsOpContrPt.TerritoryKO; end;

    WS_SetAttributeValue( @wsOpContrPt.CardBIC, ParamN, ObjectName, "CardBIC", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.CardBIC != null ) OprParty.CardIssuerCode  = wsOpContrPt.CardBIC; end;

    WS_SetAttributeValue( @wsOpContrPt.CardCaption, ParamN, ObjectName, "CardCaption", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.CardCaption != null ) OprParty.CardIssuerName  = wsOpContrPt.CardCaption; end;

    WS_SetAttributeValue( @wsOpContrPt.CardCode, ParamN, ObjectName, "CardCode", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.CardCode != null ) OprParty.CardHolderSign  = wsOpContrPt.CardCode; end;

    WS_SetAttributeValue( @wsOpContrPt.BICKOCor, ParamN, ObjectName, "BICKOCor", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.BICKOCor != null ) OprParty.CorrCode  = wsOpContrPt.BICKOCor; end;

    WS_SetAttributeValue( @wsOpContrPt.NameKOCor, ParamN, ObjectName, "NameKOCor", OpCntrPt, V_STRING, false, null, true );   
    if( wsOpContrPt.NameKOCor != null ) OprParty.CorrName  = wsOpContrPt.NameKOCor; end;

    WS_SetAttributeValue( @wsOpContrPt.CountryKOCor, ParamN, ObjectName, "CountryKOCor", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.CountryKOCor != null ) OprParty.CorrCountry  = wsOpContrPt.CountryKOCor; end;

    WS_SetAttributeValue( @wsOpContrPt.TerritoryKOCor, ParamN, ObjectName, "TerritoryKOCor", OpCntrPt, V_INTEGER, false, null, true );   
    if( wsOpContrPt.TerritoryKOCor != null ) OprParty.CorrTerritory = wsOpContrPt.TerritoryKOCor; end;
  end;
 
end;


/*  Сервис FM_CreateOpContr - Сервис выполняет создание операции ФМ в v6

    Параметры. 
      OpContrParm   - Параметры операции ФМ
      iAppID        - Ид. внешней системы.
      szOpContrCode - Идентификатор операции ФМ во внешней системе
*/
macro FM_CreateOpContr( OpContrParm, iAppID : integer, szOpContrCode : string )

  var fmopr  : RsbFMOperation;
 
  var wsOpContrParm : TWsGateFmOpContrParm;

  var OpContr, OpCntrPtList;

  var wsOpContr : TWsGateFmOpContr;
      wsOpContr = TWsGateFmOpContr;

  var wsOpCntrPt : TWsGateFmOpCntrPt;
      wsOpCntrPt = TWsGateFmOpCntrPt;



  wsOpContrParm = TWsGateFmOpContrParm;
  
  /* проверяем корректность задания параметров Web-сервиса */
  WS_CheckParameter( 1, OpContrParm, true, V_GENOBJ );

/*  WS_CheckParameter( 2, iAppID       , szOpContrCode != null, V_INTEGER);
  WS_CheckParameter( 3, szOpContrCode, iAppID != null       , V_STRING );*/

  WS_CheckParameter( 2, iAppID       , false, V_INTEGER  );
  WS_CheckParameter( 3, szOpContrCode, false, V_STRING);


  WS_SetAttributeValue( @OpContr, 1, "", "OpContr", OpContrParm, V_GENOBJ, true, null, true );

  WS_SetAttributeValue( @OpCntrPtList, 1, "", "OpCntrPtList", OpContrParm, V_GENOBJ, false, null, true );

  fmopr = RsbFMOperation;

  fmopr.DocKind = FM_OPERATION5_50;
  fmopr.DocumentID = szOpContrCode;

  fmopr.Department = {OperDprt};

////////////////////////////////////////////////////
  _CreateOpContr( wsOpContr, iAppID, OpContrParm.OpContr );
  _Record_OpContr(fmopr, wsOpContr);
////////////////////////////////////////////////////
  var OpCntrPt;
  var i = 0;

  if( OpCntrPtList != null )

    while(i < OpCntrPtList.size()) /*[FS] массив с одним null-овым элементом тоже может иметь не нулевой размер...*/
      if(OpCntrPtList[i] != null) /*[FS] ...поэтому здесь и во всех подобных местах должна быть проверка элемента массива на null*/
     _CreateOpCntrPt( fmopr, wsOpCntrPt, iAppID, OpCntrPtList[i] );
      end;
    i = i + 1;
  end;
  end;

////////////////////////////////////////////////////
  var _OpCodeList;
 
  var j = 0;

  if( (GenPropID(OpContrParm, "OpCodeList") != -1) and (OpContrParm.OpCodeList != null) )
  while(j < OpContrParm.OpCodeList.size())

      var Code     : string;
      var CodeKind : integer;

    _OpCodeList = OpContrParm.OpCodeList[j]; 

      WS_SetAttributeValue( @Code    , 1, "OpContrParm.OpCodeList", "Code"    , _OpCodeList, V_STRING , true , null, true );
      WS_SetAttributeValue( @CodeKind, 1, "OpContrParm.OpCodeList", "CodeKind", _OpCodeList, V_INTEGER, false, null, true );
      
      fmopr.AddCode( Code, CodeKind );

    j = j + 1;
  end;
  end;
////////////////////////////////////////////////////

  if( not fmopr.Save() )   
    RunError(fmopr.ErrorMessage);
  else
    return fmopr.OperationID;
  end;
end;
 
/**
 *  Функция проверки корректности задания атрибута
 *
 *    @param AttribName   Название атрибута
 *    @param SrcObject    Объект Web-сервиса, свойством которого является атрибут
 *    @param AttribType   Требуемый тип значения атрибута
 */

private macro WS_AttrNotEmpty(   AttribName  :  string
                               , SrcObject   :  object
                               , AttribType  :  integer )
  var AttrNotEmpty : bool;
      AttrNotEmpty = false;

  var PropValue : variant;

  var iProp = GenPropID( SrcObject, AttribName );

  if( not(iProp == -1) )
    PropValue = GenGetProp( SrcObject, AttribName );
    if( (PropValue != null) and (ValType(PropValue) == AttribType) )
     AttrNotEmpty = true;
    end;
  end; 
 return AttrNotEmpty;
end;

private macro _UpdateOpContr
(
  fmopr   : RsbFMOperation
 ,iAppID  : integer
 ,OpContr /*: TArray */     /* Участники операции ФМ. */
)
  var FIID : integer; 
  var stat : bool;
 
  if( WS_AttrNotEmpty( "Type", OpContr, V_INTEGER ) ) fmopr.OperationType = OpContr.Type; 
  elif(strupr(OpContr.Action) == 3) fmopr.OperationType = 0; //"MODIFY_ALL" 
  end;

  if( WS_AttrNotEmpty( "Code_Currency", OpContr, V_STRING) ) 
    FIID = WS_GetFIID( OpContr.Code_Currency, iAppID );
    if( FIID != null ) 
      fmopr.FIID = FIID; 
    end;
  elif(strupr(OpContr.Action) == 3) 
     fmopr.FIID = 0;
  end;
  
  stat = WS_AttrNotEmpty( "Action", OpContr, V_INTEGER);

  if( WS_AttrNotEmpty( "Date_Carry", OpContr, V_DATE) ) fmopr.DateCarry = OpContr.Date_Carry; 
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.DateCarry = date(0, 0, 0); 
  end;

  if( WS_AttrNotEmpty( "FmDate", OpContr, V_DATE ) ) fmopr.Date  = OpContr.FmDate; 
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.Date = date(0, 0, 0);
  end;

  if( WS_AttrNotEmpty( "SumRub", OpContr, V_MONEY ) ) fmopr.SumEquivalent = OpContr.SumRub; 
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.SumEquivalent = Money(0);
  end;

  if(WS_AttrNotEmpty( "SumCur", OpContr, V_MONEY ) ) fmopr.Sum = OpContr.SumCur;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.Sum = Money(0);
  end;

  if( WS_AttrNotEmpty( "Oper", OpContr, V_INTEGER ) ) fmopr.Oper = OpContr.Oper;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.Oper = 0;
  end;

  if( WS_AttrNotEmpty( "Carry_Oper", OpContr, V_INTEGER ) ) fmopr.Executer = OpContr.Carry_Oper;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.Executer = 0;
  end;

  if( WS_AttrNotEmpty( "Ground", OpContr, V_STRING ) ) fmopr.Ground = OpContr.Ground;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.Ground  = "";
  end;

  if( WS_AttrNotEmpty( "Terror", OpContr, V_INTEGER ) ) fmopr.TerrorSign = OpContr.Terror;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.TerrorSign = 0;
  end;

  if( WS_AttrNotEmpty( "AttrBankPayer", OpContr, V_INTEGER ) ) fmopr.PayerBankSign = OpContr.AttrBankPayer;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.PayerBankSign = 0;
  end;
 
  if( WS_AttrNotEmpty( "AttrBankReceiver", OpContr, V_INTEGER ) ) fmopr.ReceiverBankSign = OpContr.AttrBankReceiver;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.ReceiverBankSign = 0;
  end;

  if( WS_AttrNotEmpty( "AttrOpAssign", OpContr, V_INTEGER ) ) fmopr.OprByOrderSign = OpContr.AttrOpAssign;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.OprByOrderSign = 0;
  end;
 
  if( WS_AttrNotEmpty( "Date_S", OpContr, V_DATE ) ) fmopr.DateReveal = OpContr.Date_S;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.DateReveal = date(0, 0, 0);
  end;

  if( WS_AttrNotEmpty( "NumbDoc", OpContr, V_STRING) ) fmopr.PaymDocNumber = OpContr.NumbDoc;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.PaymDocNumber = "";
  end;

  if(WS_AttrNotEmpty( "DatePayD", OpContr, V_DATE)) fmopr.PaymDocDate = OpContr.DatePayD;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.PaymDocDate = date(0, 0, 0);
  end;

  if( WS_AttrNotEmpty( "SumConv", OpContr, V_MONEY ) ) fmopr.ConvOprSum = OpContr.SumConv;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.ConvOprSum = Money(0);
  end; 
 
  if( WS_AttrNotEmpty( "CurConv", OpContr, V_INTEGER ) ) fmopr.ConvOprCurrency = OpContr.CurConv;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.ConvOprCurrency = 0;
  end;

  if( WS_AttrNotEmpty( "TypeMeans", OpContr, V_INTEGER ) ) fmopr.MoneySign = OpContr.TypeMeans;
  elif( (stat) AND (strupr(OpContr.Action) == 3) ) fmopr.MoneySign = 0;
  end;
  
end;

private macro _ModifyCntrPt /* Изменение участника операции. MODIFY_IN или MODIFY_ALL */
(
  fmopr   : RsbFMOperation
 ,iAppID  : integer
 ,OpCntrPt /*: TArray */     /* Участники операции ФМ. */
)

  var Kind : integer;
  
  var i = 0;
  var Client        : integer; /* ИД клиента лицевого счета        */

  if(WS_AttrNotEmpty( "Kind", OpCntrPt, V_INTEGER ) and fmopr.OprParty(OpCntrPt.Kind) != null ) 
 
    if( WS_AttrNotEmpty( "AttrParty", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).PartySign  = OpCntrPt.AttrParty; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).PartySign = "";
    end;
   
    if( WS_AttrNotEmpty( "ClientCode", OpCntrPt, V_STRING ) )
     Client = WS_GetPartyID( OpCntrPt.ClientCode, NULL, iAppID );
    end;
    /* Заполняем буфер лицевого счета */
    if( Client != null ) fmopr.OprParty(OpCntrPt.Kind).PartyID = Client; end;

    if( WS_AttrNotEmpty( "Type", OpCntrPt, V_STRING ) ) 
      if( ( OpCntrPt.Type == "Ю") OR ( OpCntrPt.Type == "Ф") OR ( OpCntrPt.Type == "П") OR ( OpCntrPt.Type == "Н") )      
        fmopr.OprParty(OpCntrPt.Kind).PartyType  = OpCntrPt.Type; 
      end;
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).PartyType = "Н";
    end;

    if( WS_AttrNotEmpty( "Name", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).Name  = OpCntrPt.Name; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).Name = "";
    end;

    if( WS_AttrNotEmpty( "PIPDL", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).ForeignPublicFunctionary  = OpCntrPt.PIPDL; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).ForeignPublicFunctionary = "";
    end;
    
    if( WS_AttrNotEmpty( "szCountryR", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegCountry  = OpCntrPt.szCountryR; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegCountry = "";
    end;
 
    if( WS_AttrNotEmpty( "szTerritoryR", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegTerritory  = OpCntrPt.szTerritoryR; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegTerritory = "";
    end;
 
    if( WS_AttrNotEmpty( "szAddressR", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddress  = OpCntrPt.szAddressR; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddress = "";
    end;

////////
    if(OpCntrPt.RegAdress.Action == 2)  
      if( WS_AttrNotEmpty( "OKATO", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrOKATO  = OpCntrPt.RegAdress.OKATO; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).OKATO = "";
      end;
 
      if( WS_AttrNotEmpty( "Region", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrRegion  = OpCntrPt.RegAdress.Region; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddrRegion = "";
      end;
 
      if( WS_AttrNotEmpty( "Place", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrPlaceName  = OpCntrPt.RegAdress.Place; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddrPlaceName = "";
      end;
 
      if( WS_AttrNotEmpty( "Street", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrStreet  = OpCntrPt.RegAdress.Street; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddrStreet = "";
      end;
 
      if( WS_AttrNotEmpty( "House", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrHouse  = OpCntrPt.RegAdress.House; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddrHouse = "";
      end;
 
      if( WS_AttrNotEmpty( "Building", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrBuilding  = OpCntrPt.RegAdress.Building; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddrBuilding = "";
      end;
 
      if( WS_AttrNotEmpty( "Apartment", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegAddrOffice  = OpCntrPt.RegAdress.Apartment; 
      elif(OpCntrPt.RegAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegAddrOffice = "";
      end;
    end;
/////////////////
 
    if( WS_AttrNotEmpty( "szCountryP", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayCountry  = OpCntrPt.szCountryP; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayCountry = "";
    end;
 
    if( WS_AttrNotEmpty( "szTerritoryP", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayTerritory  = OpCntrPt.szTerritoryP; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayTerritory = "";
    end;
 
    if( WS_AttrNotEmpty( "szAddressP", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddress  = OpCntrPt.szAddressP; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddress = "";
    end;

/////////// 
    if(OpCntrPt.FactAdress.Action == 2)  
      if( WS_AttrNotEmpty( "OKATO", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrOKATO  = OpCntrPt.FactAdress.OKATO; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrOKATO = "";
      end;
 
      if( WS_AttrNotEmpty( "Region", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrRegion   = OpCntrPt.FactAdress.Region; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrRegion = "";
      end;
    
      if( WS_AttrNotEmpty( "Place", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrPlaceName  = OpCntrPt.FactAdress.Place; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrPlaceName = "";
      end;
 
      if( WS_AttrNotEmpty( "Street", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrStreet   = OpCntrPt.FactAdress.Street; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrStreet = "";
      end;
 
      if( WS_AttrNotEmpty( "House", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrHouse   = OpCntrPt.FactAdress.House; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrHouse = "";
      end;
 
      if( WS_AttrNotEmpty( "Building", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrBuilding   = OpCntrPt.FactAdress.Building; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrBuilding = "";
      end;
 
      if( WS_AttrNotEmpty( "Apartment", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).StayAddrOffice   = OpCntrPt.FactAdress.Apartment; 
      elif(OpCntrPt.FactAdress.Action == 3) fmopr.OprParty(OpCntrPt.Kind).StayAddrOffice = "";
      end;
    end;
///////// 

    if( WS_AttrNotEmpty( "RegNumber", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RegNumber  = OpCntrPt.RegNumber; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RegNumber = "";
    end;
 
    if( WS_AttrNotEmpty( "INN", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).INN  = OpCntrPt.INN; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).INN = "";
    end;
 
    if( WS_AttrNotEmpty( "OKPO", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).OKPO  = OpCntrPt.OKPO; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).OKPO = "";
    end;
 
    if( WS_AttrNotEmpty( "Birthday", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).Birthday  = OpCntrPt.Birthday; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).Birthday = date(0, 0, 0);
    end;
 
    if( WS_AttrNotEmpty( "szAddressB", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).BirthPlace  = OpCntrPt.szAddressB; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).BirthPlace = "";
    end;
 
    if( WS_AttrNotEmpty( "CodeDocum", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).CodeDocum  = OpCntrPt.CodeDocum; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CodeDocum = "";
    end;
 
    if( WS_AttrNotEmpty( "PaperSeries", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).PaperSeries  = OpCntrPt.PaperSeries; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).PaperSeries = "";
    end;
 
    if( WS_AttrNotEmpty( "PaperNumber", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).PaperNumber  = OpCntrPt.PaperNumber; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).PaperNumber = "";
    end;
 
    if( WS_AttrNotEmpty( "PaperIssuedDate", OpCntrPt, V_DATE ) ) fmopr.OprParty(OpCntrPt.Kind).PaperIssuedDate  = OpCntrPt.PaperIssuedDate; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).PaperIssuedDate = date(0, 0, 0);
    end;
 
    if( WS_AttrNotEmpty( "PaperIssuer", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).PaperIssuer  = OpCntrPt.PaperIssuer; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).PaperIssuer = "";
    end;
 
    if( WS_AttrNotEmpty( "NameHO", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).SuperiorName  = OpCntrPt.NameHO; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).SuperiorName = "";
    end;
 
    if( WS_AttrNotEmpty( "HOCountry", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).SuperiorCountry  = OpCntrPt.HOCountry; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).SuperiorCountry = 0;
    end;
 
    if( WS_AttrNotEmpty( "HOTerritory", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).SuperiorTerritory  = OpCntrPt.HOTerritory; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).SuperiorTerritory = 0;
    end;
  
    if( WS_AttrNotEmpty( "HOAddress", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).SuperiorAddress  = OpCntrPt.HOAddress; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).SuperiorAddress = "";
    end;
  
    if( WS_AttrNotEmpty( "CodeDocumSt", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).RightVisitDocCode  = OpCntrPt.CodeDocumSt; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RightVisitDocCode = "";
    end;
  
    if( WS_AttrNotEmpty( "DocStBegin", OpCntrPt, V_DATE ) ) fmopr.OprParty(OpCntrPt.Kind).RightVisitDocDateStart  = OpCntrPt.DocStBegin; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RightVisitDocDateStart = date(0, 0, 0);
    end;
 
    if( WS_AttrNotEmpty( "DocStEnd", OpCntrPt, V_DATE ) ) fmopr.OprParty(OpCntrPt.Kind).RightVisitDocDateEnd  = OpCntrPt.DocStEnd; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).RightVisitDocDateEnd = date(0, 0, 0);
    end;
  
    if( WS_AttrNotEmpty( "InfoMigrMap", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).MigratoryCardNumber  = OpCntrPt.InfoMigrMap; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).MigratoryCardNumber = "";
    end;
    
    if( WS_AttrNotEmpty( "MigrMapBegin", OpCntrPt, V_DATE ) ) fmopr.OprParty(OpCntrPt.Kind).MigratoryCardDateStart  = OpCntrPt.MigrMapBegin; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).MigratoryCardDateStart = date(0, 0, 0);
    end;
 
    if( WS_AttrNotEmpty( "MigrMapEnd", OpCntrPt, V_DATE ) ) fmopr.OprParty(OpCntrPt.Kind).MigratoryCardDateEnd  = OpCntrPt.MigrMapEnd; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).MigratoryCardDateEnd = date(0, 0, 0);
    end;
 
    if( WS_AttrNotEmpty( "ProfitGainer", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).BeneficiarySign  = OpCntrPt.ProfitGainer; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).BeneficiarySign = 0;
    end;
 
    if( WS_AttrNotEmpty( "AccountParty", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).Account  = OpCntrPt.AccountParty; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).Account = "";
    end;
 
    if( WS_AttrNotEmpty( "CorAccount", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).CorrAccount  = OpCntrPt.CorAccount; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CorrAccount = "";
    end;
 
    if( WS_AttrNotEmpty( "BICKO", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).BankCode  = OpCntrPt.BICKO; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).BankCode = "";
    end;
 
    if( WS_AttrNotEmpty( "NameKO", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).BankName  = OpCntrPt.NameKO; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).BankName = "";
    end;
 
    if( WS_AttrNotEmpty( "CountryKO", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).BankCountry  = OpCntrPt.CountryKO; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).BankCountry = 0;
    end;
 
    if( WS_AttrNotEmpty( "TerritoryKO", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).BankTerritory  = OpCntrPt.TerritoryKO; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).BankTerritory = 0;
    end;
 
    if( WS_AttrNotEmpty( "CardBIC", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).CardIssuerCode  = OpCntrPt.CardBIC; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CardIssuerCode = "";
    end;
 
    if( WS_AttrNotEmpty( "CardCaption", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).CardIssuerName  = OpCntrPt.CardCaption; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CardIssuerName = "";
    end;
 
    if( WS_AttrNotEmpty( "CardCode", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).CardHolderSign  = OpCntrPt.CardCode; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CardHolderSign = 0;
    end;
 
    if( WS_AttrNotEmpty( "BICKOCor", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).CorrCode  = OpCntrPt.BICKOCor; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CorrCode = "";
    end;
 
    if( WS_AttrNotEmpty( "NameKOCor", OpCntrPt, V_STRING ) ) fmopr.OprParty(OpCntrPt.Kind).CorrName  = OpCntrPt.NameKOCor; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CorrName = "";
    end;
 
    if( WS_AttrNotEmpty( "CountryKOCor", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).CorrCountry  = OpCntrPt.CountryKOCor; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CorrCountry = 0;
    end;
 
    if( WS_AttrNotEmpty( "TerritoryKOCor", OpCntrPt, V_INTEGER ) ) fmopr.OprParty(OpCntrPt.Kind).CorrTerritory  = OpCntrPt.TerritoryKOCor; 
    elif(OpCntrPt.Action == 3) fmopr.OprParty(OpCntrPt.Kind).CorrTerritory = 0;
    end;
  end;
end;

private macro ActionParm( Action : integer)

  if((Action != 1) or (Action != 2) or (Action != 3) or (Action != 4) or (Action == null))
    Action = 1;
  end;  
  return Action;
end;

private macro _UpdateOpCntrPtList
(
  fmopr        : RsbFMOperation
 ,iAppID       : integer
 ,OpCntrPtList /*: TArray */     /* Участники операции ФМ. */
)
  var OpCntrParty;
  var i = 0;
  var stat : bool;
  var _Action : integer;

  var wsOpCntrPt : TWsGateFmOpCntrPt;
      wsOpCntrPt = TWsGateFmOpCntrPt;

  while(i < OpCntrPtList.size())
    OpCntrParty = OpCntrPtList[i];
    stat = WS_AttrNotEmpty( "Action", OpCntrParty, V_INTEGER);
    if(stat) _Action = OpCntrParty.Action; end;

    if(_Action == 1)  //"ADD"
      _CreateOpCntrPt(fmopr, wsOpCntrPt, iAppID, OpCntrParty)
    elif(_Action == 4) //"REMOVE"
      fmopr.OprParty(OpCntrParty.Kind).Clear;
    elif((_Action == 2) OR (_Action == 3)) // "MODIFY_IN" "MODIFY_ALL"
      _ModifyCntrPt(fmopr, /*wsOpCntrPt,*/ iAppID, OpCntrParty);
    end;
    i = i + 1;
  end;
end;

private macro _UpdateOpCodeList
(
  fmopr        : RsbFMOperation
 ,OpCodeList /*: TArray */     /* Коды операции ФМ. */
)
 
  var OpCode;
  var stat : bool;
  var _Action : integer; 
      _Action = 1;
  var i = 0;

  while(i < OpCodeList.size())
    OpCode = OpCodeList[i];
    stat = WS_AttrNotEmpty( "Action", OpCode, V_INTEGER);
    if(stat) _Action = ActionParm(OpCode.Action); end;

    if( _Action == 1 )

      var Code     : string;
      var CodeKind : integer;

      WS_SetAttributeValue( @Code    , 1, "OpContrParm.OpCodeList", "Code"    , OpCode, V_STRING , true , null, true); /*[FS] добавляем корректное чтение параметров...*/
      WS_SetAttributeValue( @CodeKind, 1, "OpContrParm.OpCodeList", "CodeKind", OpCode, V_INTEGER, false, null, true); /*[FS] ...это должно стать негласным стандартом для обращения к свойствам*/
      
      fmopr.AddCode(Code, CodeKind);
    end;
    i = i + 1;
  end;

end;


/*  Сервис FM_UpdateOpContr - выполняет изменений операции ФМ

    Параметры.
        OpContrParm   - Параметры операции ФМ
        szOpContrCode - Идентификатор операции ФМ во внешней системе
        iAppID        - ИД внешней системы
 */
macro FM_UpdateOpContr( OpContrParm, iAppID : integer, szOpContrCode : string )

  var fmopr : RsbFMOperation;
      fmopr = RsbFMOperation;

  var wsOpContrParm : TWsGateFmOpContrParm;

  var OpContr, OpCntrPtList, OpCodeList;

  wsOpContrParm = TWsGateFmOpContrParm;
  
  /* проверяем корректность задания параметров Web-сервиса */
  WS_CheckParameter( 1, OpContrParm, true, V_GENOBJ );

  WS_CheckParameter( 2, iAppID       , szOpContrCode != null, V_INTEGER);
  WS_CheckParameter( 3, szOpContrCode, iAppID != null       , V_STRING );

  WS_SetAttributeValue( @OpContr, 1, "", "OpContr", OpContrParm, V_GENOBJ, true, null, true );

  WS_SetAttributeValue( @OpCntrPtList, 1, "", "OpCntrPtList", OpContrParm, V_GENOBJ, false, null, true );
  
  WS_SetAttributeValue( @OpCodeList, 1, "", "OpCodeList", OpContrParm, V_GENOBJ, false, null, true );
  
  var stat;

  stat = fmopr.FindByDoc(FM_OPERATION5_50, szOpContrCode, {OperDprt});
  if (stat == false)
    RunError( "Операция ФМ с идентификатором " + szOpContrCode + " не найдена.");
  else
    if( not(OpContr == null) )
      _UpdateOpContr( fmopr, iAppID, OpContr );
    end;
    if( not(OpCntrPtList == null) )
      _UpdateOpCntrPtList( fmopr, iAppID, OpCntrPtList );
    end;
    if( not(OpCodeList == null) )
      _UpdateOpCodeList( fmopr, OpCodeList );
    end;
  end; 

  if( not fmopr.Save() )   
    RunError(fmopr.ErrorMessage);
  else
    return 0;
  end;
end;

/*
    Сервис FM_DeleteOpContr - удаление операции ФМ в v6

    Параметры.
        szOpContrCode  - Ид. операциониста во внешней системе
        iAppID       - ИД внешней системы
 */
macro FM_DeleteOpContr( iAppID : integer, szOpContrCode : string)

  var fmopr : RsbFMOperation;
      fmopr = RsbFMOperation;

  var stat;

  stat = fmopr.FindByDoc(FM_OPERATION5_50, szOpContrCode, {OperDprt});
  if (stat == false)
    RunError( "Операция ФМ с идентификатором " + szOpContrCode + " не найдена.");
  else
    if( not fmopr.Delete )   
      RunError(fmopr.ErrorMessage);
    else
      return 0;
    end;
  end; 
end;