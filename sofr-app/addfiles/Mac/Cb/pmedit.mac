 /*
 $Name: pmedit.mac
 $Module: ББ/РКО
 $Description: Общие проверки изменений при редактировании документов
 */

import "pm_opr.mac", "likepy.mac", PSInter;

class TCheckUpdateParam(_pm_paym, _debet, _credit, _rm, _pspaydem, _pspayord, _cb_doc, _multydoc, _pmakkr, _curtr)
  var pm_paym, debet, credit, rm, pspaydem, pspayord, cb_doc, multydoc, pmakkr, curtr;
  if (ValType(_pm_paym) == V_STRUC)
    pm_paym = TRecHandler("pmpaym.dbt");
    Copy(pm_paym, _pm_paym);
  else
    pm_paym = _pm_paym;
  end;
  if (ValType(_debet) == V_STRUC)
    debet = TRecHandler("pmprop.dbt");
    Copy(debet, _debet);
  else
    debet = _debet;
  end;
  if (ValType(_credit) == V_STRUC)
    credit = TRecHandler("pmprop.dbt");
    Copy(credit, _credit);
  else
    credit = _credit;
  end;
  if (ValType(_rm) == V_STRUC)
    rm = TRecHandler("pmrmprop.dbt");
    Copy(rm, _rm);
  else
    rm = _rm;
  end;
  if (ValType(_pspaydem) == V_STRUC)
    pspaydem = TRecHandler("pspaydem.dbt");
    Copy(pspaydem, _pspaydem);
  else
    pspaydem = _pspaydem;
  end;
  if (ValType(_pspayord) == V_STRUC)
    pspayord = TRecHandler("pspayord.dbt");
    Copy(pspayord, _pspayord);
  else
    pspayord = _pspayord;
  end;

  if (ValType(_cb_doc) == V_STRUC)
    cb_doc = TRecHandler("cb_doc.dbt");
    Copy(cb_doc, _cb_doc);
  else
    cb_doc = _cb_doc;
  end;
  if (ValType(_multydoc) == V_STRUC)
    multydoc = TRecHandler("multydoc.dbt");
    Copy(multydoc, _multydoc);
  else
    multydoc = _multydoc;
  end;

  if (ValType(_pmakkr) == V_STRUC)
    pmakkr = TRecHandler("pmakkr.dbt");
    Copy(pmakkr, _pmakkr);
  else
    pmakkr = _pmakkr;
  end;

  if (ValType(_curtr) == V_STRUC)
    curtr = TRecHandler("pmcurtr.dbt");
    Copy(curtr, _curtr);
  else
    curtr = _curtr;
  end;
end;

// Cпособ создания
private const  CM_Undef = 0          // Не определен
              ,CM_Hand = 1           // Ручками
              ,CM_Auto = 2           // Автоматом
              ,CM_CardPay = 3        // Частичная оплата
              ,CM_ExecClaimOrder = 4 // Платеж создан по исполнении требования ЭСИД
              ,CM_CollectOrder = 5   // Платеж создан по исполнении инкассового ЭСИД
              ;  

// Состояние платежа
private const  PS_Undef = 0             // Не определен
              ,PS_Preparing = 1         // Отложенные
              ,PS_OpenBeforeControl = 2 // Открытые перед контролем
              ,PS_Manual = 3            // На ручной обработке
              ,PS_Unknown = 4           // В картотеке невыясн.
              ,PS_BO = 5                // На обработке в бэк-офисе
              ,PS_OpenAfterControl = 6  // Открытые документы после выполнения контроля (в проекте "Иначе")
              ,PS_OpenInMBR = 7         // Открыт, выгружен в МБР
              ,PS_Rejected = 8          // Отвергнут
              ,PS_Close = 9             // Закрыт
              ;  

// Сервисы ввода
private const  IS_pmaddpi = 1  // Разноска
              ,IS_pmco = 2     // Коды валютной операции
              ,IS_pmroute = 3  // Маршрут платежа
              ,IS_symbcash = 4  // Кассовые символы
              ;

private const  TypeAction_Field = 1 // Сравнить поле
              ,TypeAction_Struct = 2 // Сравнить структуру
              ,TypeAction_InputServ = 3 // Изменения в сервисе ввода
              ;

private const  UNSET_CHAR = ""
              ,SET_CHAR = "X"
              ;


// Параметры для сравнения
private class CmpPrm( p_TypeAction, p_newRec, p_oldRec, p_RecFieldName, p_InputServ, p_PaymentID )

  var TypeAction = p_TypeAction,  // Тип действия
      newRec = p_newRec,          // Новая запись
      oldRec = p_oldRec,          // Старая запись
      RecFieldName = p_RecFieldName,   // Название поля записи
      InputServ = p_InputServ,      // Номер сервиса ввода
      PaymentID = p_PaymentID       // ID платежа
      ;
end;

// Контенер для создания массива полей, которые нельзя редактировать
private class TNotChangeArrayCreator(p_new: TCheckUpdateParam, p_old: TCheckUpdateParam)

  var new: TCheckUpdateParam = p_new;
  var old: TCheckUpdateParam = p_old;

  var NotChangeArray = TArray();
  
  macro cmpInputServ( InputServ /*Константа из IS_* */, PaymentID )
    NotChangeArray[NotChangeArray.size] = CmpPrm(TypeAction_InputServ, null, null, null, InputServ, PaymentID );
  end;

  macro cmpStruct( newSruct, oldSruct )
    if( newSruct and oldSruct )
      NotChangeArray[NotChangeArray.size] = CmpPrm(TypeAction_Struct, newSruct, oldSruct);
    end;
  end;

  macro pm_paym( FieldName )
    NotChangeArray[NotChangeArray.size] = CmpPrm(TypeAction_Field, new.pm_paym.rec, old.pm_paym.rec, FieldName );
  end;

  macro debet( FieldName )
    if( new.debet )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.debet.rec, old.debet.rec, FieldName );
    end;
  end;

  macro credit( FieldName )
    if( new.credit )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.credit.rec, old.credit.rec, FieldName );
    end;
  end;

  macro pmprop_out( FieldName )
    if( new.debet and (new.debet.rec.IsSender == UNSET_CHAR) and (new.debet.rec.Group == PAYMENTS_GROUP_EXTERNAL) )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.debet.rec, old.debet.rec, FieldName );
    elif( new.credit and (new.credit.rec.IsSender == UNSET_CHAR) and (new.credit.rec.Group == PAYMENTS_GROUP_EXTERNAL) )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.credit.rec, old.credit.rec, FieldName );
    end;
  end;

  macro rm( FieldName )
    if( new.rm )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.rm.rec, old.rm.rec, FieldName );
    end;
  end;

  macro pspaydem( FieldName )
    if( new.pspaydem )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.pspaydem.rec, old.pspaydem.rec, FieldName );
    end;
  end;

  macro pspayord( FieldName )
    if( new.pspayord )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.pspayord.rec, old.pspayord.rec, FieldName );
    end;
  end;

  macro cb_doc( FieldName )
    if( new.cb_doc )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.cb_doc.rec, old.cb_doc.rec, FieldName );
    end;
  end;

  macro multydoc( FieldName )
    if( new.multydoc )
      NotChangeArray[NotChangeArray.size] = CmpPrm( TypeAction_Field, new.multydoc.rec, old.multydoc.rec, FieldName );
    end;
  end;

end;


private macro CheckProp(nch)
  var item;
  var PaymentObj;
  for (item, nch)
    if( item.TypeAction == TypeAction_Field )
      if (GenGetProp(item.newRec, item.RecFieldName) != GenGetProp(item.oldRec, item.RecFieldName))
        return CHANG_NOTKEEP;
      end;
    elif( (item.TypeAction == TypeAction_Struct) and not IsEqualRecHandler(item.newRec, item.oldRec) )
      return CHANG_NOTKEEP;
    elif( item.TypeAction == TypeAction_InputServ )
      
      if( not PaymentObj )
        PaymentObj = RsbPayment(item.PaymentID);
      end;

      if((item.InputServ == IS_pmaddpi) and PaymentObj.PIList(PRT_Debet).IsChanged() and PaymentObj.PIList(PRT_Credit).IsChanged())
        return CHANG_NOTKEEP;
      elif((item.InputServ == IS_pmco) and PaymentObj.PmCO.IsChanged() )
        return CHANG_NOTKEEP;
      /*
      elif(item.InputServ == IS_pmroute ) Этого объекта нет в rsl, поэтому пока и не делаем
        return CHANG_NOTKEEP;
      */
      elif((item.InputServ == IS_symbcash) and PaymentObj.CashSymbols.IsChanged())
        return CHANG_NOTKEEP;
      end;
    end;
  end;
  return 0;
end;


private macro AddAmounts( nch )
  nch.pm_paym("BaseAmount");
  nch.pm_paym("Amount");
  nch.pm_paym("PayAmount");
end;

private macro AddFIIDs( nch )
  nch.pm_paym("BaseFIID");
  nch.pm_paym("FIID");
  nch.pm_paym("PayFIID");
end;

private macro AddRates( nch )
   nch.pm_paym("IsInverse");
   nch.pm_paym("Point");
   nch.pm_paym("Rate");
   nch.pm_paym("RateDate");
   nch.pm_paym("RateType");
   nch.pm_paym("Scale");
   nch.pm_paym("BasePoint");
   nch.pm_paym("BaseRate");
   nch.pm_paym("BaseRateDate");
   nch.pm_paym("BaseRateType");
   nch.pm_paym("BaseScale");
   nch.pm_paym("IsBaseInverse");
end;

private macro AddFutureAmounts( nch )
   nch.pm_paym("FuturePayerAmount");
   nch.pm_paym("FutureReceiverAmount");
end;

private macro AddFutureFIIDs( nch )
  nch.pm_paym("FIID_FuturePayAcc");
  nch.pm_paym("FIID_FutureRecAcc");
end;

private macro AddFutureRates( nch )
   nch.pm_paym("IsInverse");
   nch.pm_paym("Point");
   nch.pm_paym("Rate");
   nch.pm_paym("RateDate");
   nch.pm_paym("RateType");
   nch.pm_paym("Scale");
   nch.pm_paym("BasePoint");
   nch.pm_paym("BaseRate");
   nch.pm_paym("BaseRateDate");
   nch.pm_paym("BaseRateType");
   nch.pm_paym("BaseScale");
end;

private macro AddTypeDocuments( nch )
  nch.cb_doc("TypeDocument");
  nch.multydoc("TypeDocument");
  nch.pm_paym("TypeDocument");
  nch.cb_doc("UserTypeDocument");
  nch.multydoc("UserTypeDocument");
  nch.pm_paym("UserTypeDocument");
end;

private macro AddTaxProp( nch )
  nch.rm("BttTICode");
  nch.rm("OKATOCode");
  nch.rm("TaxAuthorState");
  nch.rm("TaxPmDate");
  nch.rm("TaxPmGround");
  nch.rm("TaxPmNumber");
  nch.rm("TaxPmPeriod");
  nch.rm("TaxPmType");
end;

private macro AddAdditionalProp( nch )
  nch.pm_paym("PartPaymDateMain");
  nch.pm_paym("PartPaymNumber");
  nch.pm_paym("PartPaymNumMain");
  nch.pm_paym("PartPaymRestAmountMain");
  nch.pm_paym("PartPaymShifrMain");
  nch.pm_paym("I2PlaceDate");
  nch.pm_paym("PayerBankMarkDate");
  nch.pm_paym("ReceiverBankMarkDate");
  nch.pm_paym("PayerBankEnterDate");
  nch.rm("PayerChargeOFfDate");
  nch.rm("DocDispatchDate");
  nch.pm_paym("CreationDate");
  nch.pm_paym("CreationTime");
end;

private macro AddTransferOutProp( nch )
  nch.pmprop_out( "TpID" );
  nch.pmprop_out( "TpSchemID" );
  nch.pmprop_out( "SubKindMessage" );
  nch.pmprop_out( "RlsFormID" );
end;

private macro AddVOProp( nch )
  nch.cmpStruct( nch.new.curtr, nch.old.curtr );
  nch.cmpInputServ( IS_pmco, nch.new.pm_paym.rec.PaymentID );
end;


private macro AddUserField( nch )
  nch.pm_paym("UserField1");
  nch.pm_paym("UserField2");
  nch.pm_paym("UserField3");
  nch.pm_paym("UserField4");
end;

private macro AddKindOperations( nch )
  
  nch.pm_paym( "KindOperation");
  nch.pspayord("Kind_Operation");
  nch.cb_doc("Kind_Operation");
  nch.multydoc("Kind_Operation");
  // Пока только эти первички, как руки дойдут и другие добавим
end;

private macro AddDebetBankCode( nch )
  nch.debet("CodeKind");
  nch.debet("BankCode");
end;

private macro AddCreditBankCode( nch )
  nch.credit("CodeKind");
  nch.credit("BankCode");
end;

private macro CheckChangePreparingHand(new, old)
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  return nch.NotChangeArray;
end;

private macro CheckChangePreparingAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverName");
  nch.rm("ReceiverINN");
  nch.rm("Ground");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.rm("AdditionalInfo");
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;

private macro CheckChangePreparingCardPay(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverName");
  nch.rm("ReceiverINN");
  nch.rm("Ground");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.rm("AdditionalInfo");
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );
  
  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.

  return nch.NotChangeArray;
end;

private macro CheckChangePreparingExecClaimOrder(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Date");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.rm("AdditionalInfo");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("PayCondition");
    nch.pspaydem("Accept");
  end;
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  AddVOProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );
  AddUserField( nch );
  
  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.

  return nch.NotChangeArray;
end;

private macro CheckChangePreparingCollectOrder(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Date");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddVOProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );
  AddUserField( nch );
  
  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.

  return nch.NotChangeArray;
end;


private macro CheckChangeOpenBeforeControlHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.pm_paym("ValueDate");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverINN");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  AddUserField( nch );

  return nch.NotChangeArray;
end;


private macro CheckChangeOpenBeforeControlAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverName");
  nch.rm("ReceiverINN");
  nch.rm("Ground");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;


private macro CheckChangeManualHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  nch.rm("PaymentKind");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverName");
  nch.rm("ReceiverINN");
  nch.rm("Ground");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;

private macro CheckChangeManualAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  nch.rm("PaymentKind");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverName");
  nch.rm("ReceiverINN");
  nch.rm("Ground");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;

private macro CheckChangeUnknownHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  nch.rm("PaymentKind");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");

  // Проверять только для кредитовых
  if( nch.new.credit.rec.IsSender == UNSET_CHAR )
    nch.rm("PayerName");
    nch.rm("PayerINN");
  end;

  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");

  // Проверять только для дебетовых
  if( nch.new.debet.rec.IsSender == UNSET_CHAR )
    nch.rm("ReceiverName");
    nch.rm("ReceiverINN");
  end;

  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;

private macro CheckChangeUnknownAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  nch.rm("PaymentKind");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch );
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");

  // Проверять только для кредитовых
  if( nch.new.credit.rec.IsSender == UNSET_CHAR )
    nch.rm("PayerName");
    nch.rm("PayerINN");
  end;

  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");

  // Проверять только для дебетовых
  if( nch.new.debet.rec.IsSender == UNSET_CHAR )
    nch.rm("ReceiverName");
    nch.rm("ReceiverINN");
  end;

  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;

private macro CheckChangeBOHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");
  nch.rm("Date");
  nch.pm_paym("ValueDate");
  nch.rm("PaymentKind");
  AddAmounts( nch );
  AddFIIDs( nch );
  AddRates( nch );
  nch.pm_paym("IsFixAmount");
  AddFutureAmounts( nch ); 
  AddFutureFIIDs( nch );
  AddFutureRates( nch );
  nch.rm("Priority");
  nch.pm_paym("PayerAccount");
  nch.rm("PayerName");
  nch.rm("PayerINN");
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");
  nch.rm("PayerBankName");
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");
  nch.rm("ReceiverBankName");
  nch.pm_paym("ReceiverAccount");
  nch.rm("ReceiverName");
  nch.rm("ReceiverINN");
  nch.rm("Ground");
  nch.rm("PayDate");
  nch.rm("ShifrOper");
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");
  nch.rm("NeedNotify");
  AddKindOperations( nch );
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");
  nch.pm_paym("ComissAccount");
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );
  AddTransferOutProp( nch );
  nch.pmprop_out( "TransferDate" );
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;
  nch.pspaydem("AcceptPeriod");
  AddTypeDocuments( nch );
  AddTaxProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );
  nch.cmpStruct( new.pmakkr, old.pmakkr );

  return nch.NotChangeArray;
end;

private macro CheckChangeBOAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");                            
  nch.rm("Date");                              
  nch.pm_paym("ValueDate");                         
  nch.rm("PaymentKind");                  
  AddAmounts( nch );                           
  AddFIIDs( nch );                             
  AddRates( nch );                             
  nch.pm_paym("IsFixAmount");                  
  AddFutureAmounts( nch ); 
  AddFutureFIIDs( nch );                       
  AddFutureRates( nch );                       
  nch.rm("Priority");                          
  nch.pm_paym("PayerAccount");                 
  nch.rm("PayerName");                         
  nch.rm("PayerINN");                          
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");                
  nch.rm("PayerBankName");                     
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");             
  nch.rm("ReceiverBankName");                  
  nch.pm_paym("ReceiverAccount");              
  nch.rm("ReceiverName");                      
  nch.rm("ReceiverINN");                       
  nch.rm("Ground");
  nch.rm("PayDate");                           
  nch.rm("ShifrOper");                         
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                          
  nch.rm("NeedNotify");                        
  AddKindOperations( nch );                    
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");                     
  nch.pm_paym("ComissAccount");                
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );                
  AddTransferOutProp( nch );                   
  nch.pmprop_out( "TransferDate" );            
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;               
  nch.pspaydem("AcceptPeriod");                
  AddTypeDocuments( nch );                     
  AddTaxProp( nch );                           
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );              
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                           

  return nch.NotChangeArray;
end;

private macro CheckChangeOpenAfterControlHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");                             
  nch.rm("Date");                               
  nch.pm_paym("ValueDate");                          
  nch.rm("PaymentKind");                   
  AddAmounts( nch );                            
  AddFIIDs( nch );                              
  AddRates( nch );                              
  nch.pm_paym("IsFixAmount");                   
  AddFutureAmounts( nch );                      
  AddFutureFIIDs( nch );                        
  AddFutureRates( nch );                        
  nch.rm("Priority");                           
  nch.pm_paym("PayerAccount");                  
  nch.rm("PayerName");                          
  nch.rm("PayerINN");                           
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");                 
  nch.rm("PayerBankName");                      
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");              
  nch.rm("ReceiverBankName");                   
  nch.pm_paym("ReceiverAccount");               
  nch.rm("ReceiverName");                       
  nch.rm("ReceiverINN");                        
  nch.rm("Ground");
  nch.rm("PayDate");                            
  nch.rm("ShifrOper");                          
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                           
  nch.rm("NeedNotify");                         
  AddKindOperations( nch );                     
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");                      
  nch.pm_paym("ComissAccount");                 
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );                 
  AddTransferOutProp( nch );                    
  nch.pmprop_out( "TransferDate" );             
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );               
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;                 
  nch.pspaydem("AcceptPeriod");                 
  AddTypeDocuments( nch );                      
  AddTaxProp( nch );                            
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );               
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                              

  return nch.NotChangeArray;
end;

private macro CheckChangeOpenAfterControlAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  nch.rm("PaymentKind");                 
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");            
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");                        
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  AddKindOperations( nch );                   
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;             
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  return nch.NotChangeArray;
end;

private macro CheckChangeOpenInMBRHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  nch.rm("PaymentKind");                 
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");            
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");                        
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  AddKindOperations( nch );                   
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;               
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.

  return nch.NotChangeArray;
end;

private macro CheckChangeOpenInMBRAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  
  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  nch.rm("PaymentKind");                 
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");            
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");                        
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  AddKindOperations( nch );                   
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;              
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.

  return nch.NotChangeArray;
end;

private macro CheckChangeRejectedHand(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);
  AddKindOperations( nch );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )              
    nch.pspaydem("PayCondition");
  end;             
  nch.pspaydem("AcceptPeriod");               
  return nch.NotChangeArray;
end;

private macro CheckChangeRejectedAuto(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  nch.pm_paym("PayerBankID");                      
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  nch.pm_paym("ReceiverBankID");                     
  nch.rm("ReceiverCorraccNostro");            
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");                        
  AddKindOperations( nch );                   
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;              
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  return nch.NotChangeArray;
end;

private macro CheckChangeRejectedCardPay(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  nch.pm_paym("PayerBankID");                      
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  nch.pm_paym("ReceiverBankID");                     
  nch.rm("ReceiverCorraccNostro");            
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");                        
  AddKindOperations( nch );                   
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");               
  end;
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.
  return nch.NotChangeArray;
end;

private macro CheckChangeRejectedExecClaimOrder(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Date");                             
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("PayCondition");
    nch.pspaydem("Accept");
  end;
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddVOProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            
  AddUserField( nch );

  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.
  return nch.NotChangeArray;
end;

private macro CheckChangeRejectedCollectOrder(new, old);
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Date");                             
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ShifrOper");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  nch.cmpInputServ( IS_symbcash, nch.new.pm_paym.rec.PaymentID );
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  nch.pspaydem("PayCondition");
  if( not old.pspayord or ( old.pspayord and old.pspayord.rec.DocKind != PSPOKIND_REQUEST ) )
    nch.pspaydem("PayCondition");
  end;             
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddVOProp( nch );
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            
  AddUserField( nch );

  // Документы обоснования покупки валюты: записи ps_ordoc - не ясно как тут это достать.
  return nch.NotChangeArray;
end;

private macro CheckChangeCloseHand(new, old)
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  nch.rm("PaymentKind");
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");               
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  AddKindOperations( nch );                   
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;              
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  return nch.NotChangeArray;
end;

private macro CheckChangeCloseAuto(new, old)
  var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

  nch.rm("Number");                           
  nch.rm("Date");                             
  nch.pm_paym("ValueDate");                        
  nch.rm("PaymentKind");
  AddAmounts( nch );                          
  AddFIIDs( nch );                            
  AddRates( nch );                            
  nch.pm_paym("IsFixAmount");                 
  AddFutureAmounts( nch );                    
  AddFutureFIIDs( nch );                      
  AddFutureRates( nch );                      
  nch.rm("Priority");                         
  nch.pm_paym("PayerAccount");                
  nch.rm("PayerName");                        
  nch.rm("PayerINN");                         
  AddDebetBankCode( nch );
  nch.pm_paym("PayerBankID");
  nch.rm("PayerCorrAccNostro");               
  nch.rm("PayerBankName");                    
  AddCreditBankCode( nch );
  nch.pm_paym("ReceiverBankID");
  nch.rm("ReceiverCorraccNostro");               
  nch.rm("ReceiverBankName");                 
  nch.pm_paym("ReceiverAccount");             
  nch.rm("ReceiverName");                     
  nch.rm("ReceiverINN");                      
  nch.rm("Ground");
  nch.rm("PayDate");                          
  nch.rm("ShifrOper");
  nch.pm_paym("NumberPack");
  nch.rm("Instancy");                         
  nch.rm("NeedNotify");                       
  AddKindOperations( nch );                   
  nch.rm("ComissCharges");                    
  nch.pm_paym("ComissAccount");               
  nch.rm("AdditionalInfo");
  nch.pmprop_out( "Corschem" );               
  AddTransferOutProp( nch );                  
  nch.pmprop_out( "TransferDate" );           
  nch.cmpInputServ( IS_pmaddpi, nch.new.pm_paym.rec.PaymentID );             
  nch.pspaydem("PayCondition");
  if( old.pspayord and old.pspayord.rec.DocKind == PSPOKIND_REQUEST )
    nch.pspaydem("Accept");
  end;               
  nch.pspaydem("AcceptPeriod");               
  AddTypeDocuments( nch );                    
  AddTaxProp( nch );                          
  AddAdditionalProp( nch );
  nch.cmpInputServ( IS_pmroute, nch.new.pm_paym.rec.PaymentID );             
  nch.cmpStruct( new.pmakkr, old.pmakkr );                                            

  return nch.NotChangeArray;
end;

macro StandartCheckUpdate(new: TCheckUpdateParam, old: TCheckUpdateParam)

  var CreationMethod = CM_Undef;
  
  // Определяем к какой категории относится платеж по способу создания
  if( (old.pm_paym.rec.DocKind == PS_PAYORDER) and ( old.pspayord.rec.DocKind == PSPOKIND_DEMAND ) and (old.pm_paym.rec.PrimDocOrigin == PD_OR_PAYEEBANK) )
    CreationMethod = CM_ExecClaimOrder;
  elif( (old.pm_paym.rec.DocKind == PS_PAYORDER) and ( old.pspayord.rec.DocKind == PSPOKIND_REQUEST ) and (old.pm_paym.rec.PrimDocOrigin == PD_OR_PAYEEBANK) )
    CreationMethod = CM_CollectOrder;
  elif( ( old.pm_paym.rec.Origin == PAYMENT_OR_MANUAL ) and ( (old.pm_paym.rec.PartPaymNumMain == "") or ( old.pm_paym.rec.Purpose == PM_PURP_BANKPAYORDER ) ) )
    CreationMethod = CM_Hand;
  elif( ( InList(old.pm_paym.rec.Origin, PAYMENT_OR_ELECTR, PAYMENT_OR_AUTO ) ) and (old.pm_paym.rec.PartPaymNumMain == "") )
    CreationMethod = CM_Auto;
  elif( old.pm_paym.rec.PartPaymNumMain != "" )
    CreationMethod = CM_CardPay;
  end;

  var PaymentState = PS_Undef;
  var Ctrl: Integer = 0;
  var Index: Integer = 0;
  var Manual: Integer = 0;
  var pmprop_external =  null;

  if( old.credit and (old.credit.rec.Group == PAYMENTS_GROUP_EXTERNAL) )
    pmprop_external = old.credit;
  elif( old.debet and (old.debet.rec.Group == PAYMENTS_GROUP_EXTERNAL) )
    pmprop_external = old.debet;
  end;

  // Определить к какой категории относится платеж по состоянию
  if( old.pm_paym.rec.PrimDocKind == PS_BUYCURORDER )
    
    PM_GetOprStatus( old.pm_paym.rec.PrimDocKind, old.pm_paym.rec.DocumentID, OPR_BC_CONTROL, @Ctrl );

    if( old.pm_paym.rec.PaymStatus == PM_PREPARING )
      PaymentState = PS_Preparing;
    elif((Ctrl != OPR_BC_ST_CTRL_CONTROL) and not InList(old.pm_paym.rec.PaymStatus, PM_FINISHED, PM_REJECTED))
      PaymentState = PS_OpenBeforeControl;
    elif((Ctrl == OPR_BC_ST_CTRL_CONTROL) and not InList(old.pm_paym.rec.PaymStatus, PM_FINISHED, PM_REJECTED))
      PaymentState = PS_OpenAfterControl;
    elif( old.pm_paym.rec.PaymStatus == PM_REJECTED )
      PaymentState = PS_Rejected;
    elif( old.pm_paym.rec.PaymStatus == PM_FINISHED )
      PaymentState = PS_Close;
    end;
  else

    PM_GetOprStatus( old.pm_paym.rec.PrimDocKind, old.pm_paym.rec.PaymentID, OPR_PAYM_CONTROL, @Ctrl );
    PM_GetOprStatus( old.pm_paym.rec.PrimDocKind, old.pm_paym.rec.PaymentID, OPR_PAYM_INDEX, @Index );
    PM_GetOprStatus( old.pm_paym.rec.PrimDocKind, old.pm_paym.rec.PaymentID, OPR_PAYM_MANUAL, @Manual );   

    if( ( old.pm_paym.rec.PrimDocKind != WL_INDOC ) and  ( old.pm_paym.rec.PaymStatus == PM_PREPARING ) or
        ( old.pm_paym.rec.PrimDocKind == WL_INDOC ) and  ( pmprop_external ) and ( pmprop_external.rec.PropStatus == PM_PROP_LOADED ) )
      PaymentState = PS_Preparing;
    elif( (Ctrl != OPR_PAYM_ST_CTRL_CONTROL ) and not InList(old.pm_paym.rec.PaymStatus, PM_FINISHED, PM_REJECTED))
      PaymentState = PS_OpenBeforeControl;
    elif((Ctrl == OPR_PAYM_ST_CTRL_CONTROL) and (Index == OPR_PAYM_ST_INDEX_UNKNOWN))
      PaymentState = PS_Unknown;
    elif((Ctrl == OPR_PAYM_ST_CTRL_CONTROL) and (Manual == OPR_PAYM_ST_MANUAL_NEED))
      PaymentState = PS_Manual;
    elif((old.pm_paym.rec.PaymStatus >= PM_IS_SENDING) and (old.pm_paym.rec.PaymStatus != PM_FINISHED))
      PaymentState = PS_OpenInMBR;
    elif( InList(old.pm_paym.rec.PaymStatus, PM_KVITWAIT, PM_KVITPROCESSING) )
      PaymentState = PS_BO;
    elif((Ctrl == OPR_PAYM_ST_CTRL_CONTROL) and not InList(old.pm_paym.rec.PaymStatus, PM_FINISHED, PM_REJECTED))
      PaymentState = PS_OpenAfterControl;
    elif( old.pm_paym.rec.PaymStatus == PM_REJECTED )
      PaymentState = PS_Rejected;
    elif( old.pm_paym.rec.PaymStatus == PM_FINISHED )
      PaymentState = PS_Close;
    end;
  end;

  // Доопределяем происхождение: для некоторых состояний платежа происхождения CM_ExecClaimOrder, CM_CollectOrder, CM_CardPay сводятся к CM_Auto
  if( InList(CreationMethod, CM_ExecClaimOrder, CM_CollectOrder, CM_CardPay) and InList(PaymentState, PS_OpenBeforeControl, PS_Unknown, PS_Manual, PS_BO, PS_OpenAfterControl, PS_OpenInMBR, PS_Close))
    CreationMethod = CM_Auto;
  end;

  var NotChangeField = TArray();
  var stat = 0;


  // Проверки этого if описаны в PRJ_000173_Изменения форматов документов по 1256-У_текущая_сборка.doc#50
  if( stat == 0 )
    if( (new.pspaydem) and (new.pm_paym) and (new.pspaydem.rec.PreAcptID != 0) )

      var nch:TNotChangeArrayCreator = TNotChangeArrayCreator(new, old);

      if (new.pspaydem.rec.AcceptTerm == PM_DEMAND_TERM_WITHOUTACCEPT )
        nch.pspaydem("AcceptTerm");
      end;

      nch.pm_paym("PayerBankEnterDate");
      nch.pm_paym("Payer");             
      nch.pm_paym("PayerAccount");      
      nch.pm_paym("ReceiverBankID");    
      nch.pm_paym("ReceiverAccount");   
      nch.pm_paym("Receiver");          
      if ( (not PM_IsBankInTS( new.pm_paym.rec.ReceiverBankID)) and (new.rm) )
        nch.rm("ReceiverName");
      end;

      stat = CheckProp(nch.NotChangeArray);
      if( stat == CHANG_NOTKEEP )
        MsgBox("В документе указаны реквизиты, которые противоречат заранее данному акцепту, уже привязанному к требованию. Удалите связь документа с ЗДА, после чего внесенные изменения можно будет сохранить");
      end;
    end;  
  end;

  // Далее стандартные проверки PRJ_001256_Проверки при сохранении платежа.doc
  // Получаем поля структур, которые нельзя редактировать
  if( stat == 0 )
    if((PaymentState == PS_Undef) or (CreationMethod == CM_Undef))
      msgbox("Не определено состояние платежа при проверке возможности сохранения");
      return CHANG_NOTKEEP;
    elif( PaymentState == PS_Preparing )

      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangePreparingHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangePreparingAuto(new, old);
      elif( CreationMethod == CM_CardPay )
        NotChangeField = CheckChangePreparingCardPay(new, old);
      elif( CreationMethod == CM_ExecClaimOrder )
        NotChangeField = CheckChangePreparingExecClaimOrder(new, old);
      elif( CreationMethod == CM_CollectOrder )
        NotChangeField = CheckChangePreparingCollectOrder(new, old);
      end;
    elif( PaymentState == PS_OpenBeforeControl )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeOpenBeforeControlHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeOpenBeforeControlAuto(new, old);
      end;
    elif( PaymentState == PS_Manual )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeManualHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeManualAuto(new, old);
      end;
    elif( PaymentState == PS_Unknown )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeUnknownHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeUnknownAuto(new, old);
      end;
    elif( PaymentState == PS_BO )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeBOHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeBOAuto(new, old);
      end;
    elif( PaymentState == PS_OpenAfterControl )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeOpenAfterControlHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeOpenAfterControlAuto(new, old);
      end;
    elif( PaymentState == PS_OpenInMBR )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeOpenInMBRHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeOpenInMBRAuto(new, old);
      end;
    elif( PaymentState == PS_Rejected )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeRejectedHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeRejectedAuto(new, old);
      elif( CreationMethod == CM_CardPay )
        NotChangeField = CheckChangeRejectedCardPay(new, old);
      elif( CreationMethod == CM_ExecClaimOrder )
        NotChangeField = CheckChangeRejectedExecClaimOrder(new, old);
      elif( CreationMethod == CM_CollectOrder )
        NotChangeField = CheckChangeRejectedCollectOrder(new, old);
      end;
    elif( PaymentState == PS_Close )
      if( CreationMethod == CM_Hand )
        NotChangeField = CheckChangeCloseHand(new, old);
      elif( CreationMethod == CM_Auto )
        NotChangeField = CheckChangeCloseAuto(new, old);
      end;
    end;

    if( NotChangeField.size > 0 )
      stat = CheckProp(NotChangeField);
    end;

    if ((stat == CHANG_NOTKEEP) and (new.pm_paym.rec.PaymStatus >= PM_IS_SENDING) and (new.pm_paym.rec.PaymStatus != PM_FINISHED))
      if (GetTrue(True, "Документ выгружен. Редактирование может привести к расхождению реквизитов платежа и сообщения. Сохранить изменения?"))
        stat = 0;
      end;
    end;
  end;

  return stat;

end;