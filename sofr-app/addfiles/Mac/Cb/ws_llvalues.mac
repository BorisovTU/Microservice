import rcw;
import rsd;
import rsbdataset;

class TWsLlvalues(_element : integer, _code : string, _name : string, _list : integer)
  var Element = _element;
  var Code    = _code;
  var Name    = _name;
  var List    = _list;
end;

MACRO GetListLlvalues(List:integer, Mode)
   var p;

   if(List <= 0)
     RunError("Не задан вид справочника");
   end;
   
   var result = TArray();
   var query = "select * from dllvalues_dbt where t_List = " + string(List) + " ORDER BY t_element";

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   while (ds.MoveNext())
      p = TWsLlvalues(ds.Element, ds.Code, ds.Name, List);

      result.value(result.Size) = p;
   end;

   return result;
END;


/* Создание объекта TWsLlvalues через параметры */
macro CreateLLValueFromParam
(
  Element, 
  Code,
  Name,
  List
)
  var llValueItem : TWsLlvalues;

  llValueItem.Element  = Element;
  llValueItem.Code     = Code;
  llValueItem.Name     = Name;
  llValueItem.List     = List;

  return llValueItem;
end;

/* Создание объекта TWsLlvalues из базы */
macro CreateLLValueFromAppServ(List, Element)
  var p;

  var query = "select * from dllvalues_dbt where t_List = " + string(List) + " AND t_Element = " + string(Element);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
                      
  if (ds.MoveNext())
    p = TWsLlvalues();

    p.Element = Element;
    p.Code    = ds.T_Code;
    p.Name    = ds.T_Name;
    p.List    = List;
  else
    return null;
  end;

  return p;
end;                                                
macro LookUp( List,
              sub                 : string,
              listLen             : integer):TArray
              
  var result = TArray();
  var p;

  var query = "select * from dllvalues_dbt where t_List = " + string(List) + " AND t_Element ";

  query = query + " LIKE LOWER ('%' || ? || '%') ";

  if( listLen != 0 )

    query = query + " AND ROWNUM < " + string(listLen);

  end;

  var cmd = RSDCommand(query);
  
  cmd.addParam( "", RSDBP_IN, sub );
      
  cmd.NullConversion = true;
  
  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  while (ds.moveNext())

    p = TWsLlvalues();

    p.Element = ds.T_Element;
    p.Code    = ds.T_Code;
    p.Name    = ds.T_Name;
    p.List    = List;

    result.value(result.Size) = p;

  end;

  return result;

end;                       