/*
$Name: ic_payments.mac
$Module: ÅÅ
$Description: ·•‡¢®· èÑ
*/
import ws_CrPaym, CTInter;

class TPayment
var
  PaymentID: string,
  PaymentKind,
  SubKind,
  PaymStatus: integer,
  CurrentStatusText,
  PaymentPriority,
  ShifrOper: string,
  ValueDate: Date,
  Number: string,
  Date: Date,
  ClientDate: Date,
  BankDate: Date,
  CloseDate: Date,
  PayDate: Date,
  DocKind: integer,
  Chapter: integer,
  NumberPack: integer,
  Instancy,
  Ground: string,
  Payer: integer,
  PayerCodeKind: integer,
  PayerCode: string,
  PayerName: string,
  PayerINN: string,
  PayerAccount,
  PayerFIID: integer,
  PayerFIISO: string,
  PayerAmount: Money,
  PayerBankCodeKind: integer,
  PayerBankCode: string,
  PayerBankName: string,
  PayerBankID: integer,
  PayerCorrAccNostro: string,
  PayerCorrBankCodeKind: integer,
  PayerCorrBankCode: string,
  PayerCorrBankName: string,
  PayerCorrBankID: integer,
  PayerBankMarkDate,
  PayerChargeOffDate,
  Receiver: integer,
  ReceiverCodeKind: integer,
  ReceiverCode: string,
  ReceiverName: string,
  ReceiverINN: string,
  ReceiverAccount: string,
  ReceiverFIID: integer,
  ReceiverFIISO: string,
  ReceiverAmount: Money,
  ReceiverBankCodeKind: integer,
  ReceiverBankCode: string,
  ReceiverBankName: string,
  ReceiverBankID: integer,
  ReceiverCorrAccNostro: string,
  ReceiverCorrBankCodeKind: integer,
  ReceiverCorrBankCode: string,
  ReceiverCorrBankName: string,
  ReceiverCorrBankAccount: string,
  ReceiverCorrBankID: integer,
  TaxAuthorState,
  TaxPmDate,
  TaxPmGround,
  TaxPmNumber,
  TaxPmPeriod,
  TaxPmType,
  UIN: string,
  PaperKind,
  PaperSeries,
  PaperNumber,
  PaperIssuedDate,
  PaperIssuer,
  AkkrAccRealReceiver,
  AkkrAddCondition,
  AkkrDate,
  AkkrPayCondition,
  AkkrRepresentation,
  AkkrType,
  BaseAmount,
  BaseFIID: integer,
  BaseFIISO: string,
  IsBaseInverse,
  BaseRatePoint,
  BaseRateValue,
  BaseRateDate,
  BaseRateType,
  BaseRateScale,
  RateIsInverse,
  RatePoint,
  RateValue,
  RateDate,
  RateType,
  RateScale,
  I2PlaceDate: Date,
  PartPaymDateMain,
  PartPaymNumMain,
  PartPaymNumber,
  PartPaymRestAmountMain,
  PartPaymShifrMain,
  Accept,
  AcceptDate,
  AcceptTerm,
  IndexPlaceDate,
  IndexExitDate,
  AcceptPeriod,
  CashSymbolCredit,
  CashSymbolDebet,
  CheckTerror,
  IsVO,
  COVector,
  VO_Accept,
  VO_Direct,
  VO_FIID,
  VO_FIIDISO,
  VO_Oper,
  VO_OperFIO,
  VO_PayerBankCode: string,
  VO_PayerBankCodeKind: integer,
  VO_PayerBankCountry: string,
  VO_PayerBankID: integer,
  VO_ReceiverBankCode: string,
  VO_ReceiverBankCodeKind: integer,
  VO_ReceiverBankCountry: string,
  VO_ReceiverBankID: integer,
  ComissAccount,
  ComissCharges,
  ComissFIID: integer,
  ComissFIISO: string,
  TypeDocument,
  UserTypeDocument,
  AdditionalInfo,
  ClaimID: integer,
  Department,
  OKATOCode,
  Oper,
  OperFIO,
  Origin,
  SymbNotBalCredit,
  SymbNotBalDebet,
  BttTICode,
  BCOrdKind: integer,
  UserField1,
  UserField2,
  UserField3,
  UserField4,
  PostDate: Date,
  PostTime: Time,
  CashSymbols,
  Notes,
  Categories;
end;

class TPMNote
  var NoteKind: string;
  var NoteValue: string;
  var Date: Date;
end;

class TPMCategories
  var GroupID: integer;
  var AttrID: string;
  var AttrCode: string;
  var AttrName: string;
end;

class TPMCashSymbol
  var Symbol: string;
  var Sum: Money;
end;

class TPMCO
  var ContractDate: Date;
  var ContractFIID: Integer;
  var ContractFIISO: string;
  var ContractNumber: string;
  var PassportDate: Date;
  var PassportNumber: string;
  var ContractRegDate: Date;
  var ContractUIN: string;
  var VO_Code: string;
end;

private macro GetDocumentID(ObjectType: integer, DocKind: integer, PaymentID : integer)
  record pmpaym(pmpaym);  
  pmpaym.PaymentID = PaymentID;
  return makeObjectID( ObjectType, DocKind, pmpaym );
end;

macro GetPayDocList(IDs)
  var size;
  if (valtype(IDs) == V_GENOBJ)
    size = IDs.size;
  else
    size = asize(IDs);
  end;
  var IDpaym = TArray(size / 2);
  var IDsub = TArray(size / 2);
  var IDSpaym = TArray(size / 2);
  var IDacctrn = TArray(size / 2);
  var IDSacctrn = TArray(size / 2);
  var index1, index2;
  for(var item, IDs)
    index1 = index(item, "//");
    index2 = index(item, "//", index1 + 2);
    if (index1 == 0)
      IDpaym[IDpaym.size] = int(item);
      IDsub[IDsub.size] = 0;
      IDSpaym[IDSpaym.size] = string(item);
    elif (index2 != 0)
      if (substr(item, index2 + 2) == 0)
        IDpaym[IDpaym.size] = int(substr(item, 1, index1));
        IDsub[IDsub.size] = int(substr(item, index1 + 2, index2 - index1 - 2));
        IDSpaym[IDSpaym.size] = string(item);
      else
        IDacctrn[IDacctrn.size] = int(substr(item, index2 + 2));
        IDSacctrn[IDSacctrn.size] = string(item);
      end;
    end;
  end;
  var Result = TArray(size);
  var ins: RsbSQLInsert;
  var old, query;
  if (IDpaym.size > 0)
    execSQL("truncate table doprtemp_tmp");
    ins = RsbSQLInsert(string("insert into doprtemp_tmp (t_ID_Operation, t_OrderID, t_DocumentID) ",
                              "values (?, ?, ?)"), 3, IDpaym.size);
    ins.AddParam(V_INTEGER, IDpaym);
    ins.AddParam(V_INTEGER, IDsub);
    ins.AddParam(V_STRING, IDSpaym, 35);

    old = SetDialogFlag(0);
    if (not ins.Insert())
      SetDialogFlag(old);
      RunError("éË®°™† Ø‡® ®≠®Ê®†´®ß†Ê®® ·Ø®·™† Ø´†‚•¶•©");
    end;
    SetDialogFlag(old);
    query = string(
                   "SELECT val.*,\n",
                   "       PM_SCRHLP.GetFICode (t_PayerFIID, 1) t_PayerFIISO,\n",
                   "       PM_SCRHLP.GetFICode (t_ReceiverFIID, 1) t_ReceiverFIISO,\n",
                   "       PM_SCRHLP.GetFICode (t_BaseFIID, 1) t_BaseFIISO,\n",
                   "       PM_SCRHLP.GetFICode (t_VO_FIID, 1) t_VO_FIIDISO,\n",
                   "       PM_SCRHLP.GetFICode (t_ComissFIID, 1) t_ComissFIISO,\n",
                   "       PM_SCRHLP.GetPaymStatusName (t_PaymStatus) t_CurrentStatusText,\n",
                   "       NVL (\n",
                   "          (SELECT 1\n",
                   "             FROM DUAL\n",
                   "            WHERE EXISTS\n",
                   "                     (SELECT 1\n",
                   "                        FROM dsymbcash_dbt sc\n",
                   "                       WHERE     sc.t_DocKind = val.t_PSCDocKind\n",
                   "                             AND sc.t_ApplicationKey = val.t_PSCAppKey)),\n",
                   "          0)\n",
                   "          IsCashSymbols,\n",
                   "       NVL (\n",
                   "          (SELECT 1\n",
                   "             FROM DUAL\n",
                   "            WHERE EXISTS\n",
                   "                     (SELECT 1\n",
                   "                        FROM dnotetext_dbt nt\n",
                   "                       WHERE     nt.t_ObjectType = 501    -- OBJTYPE_PAYMENT\n",
                   "                             AND nt.t_DocumentID =\n",
                   "                                    LPAD (val.t_pmPaymentID, 10, '0'))),\n",
                   "          0)\n",
                   "          IsPaymentNotes,\n",
                   "       NVL (\n",
                   "          (SELECT 1\n",
                   "             FROM DUAL\n",
                   "            WHERE EXISTS\n",
                   "                     (SELECT 1\n",
                   "                        FROM dnotetext_dbt nt\n",
                   "                       WHERE     nt.t_ObjectType = val.t_ObjectType\n",
                   "                             AND nt.t_DocumentID =\n",
                   "                                    LPAD (val.t_pmPaymentID, 34, '0'))),\n",
                   "          0)\n",
                   "          IsNotes,\n",
                   "       NVL (\n",
                   "          (SELECT 1\n",
                   "             FROM DUAL\n",
                   "            WHERE EXISTS\n",
                   "                     (SELECT 1\n",
                   "                        FROM dobjatcor_dbt nt\n",
                   "                       WHERE     nt.t_ObjectType = 501     --OBJTYPE_PAYMENT\n",
                   "                             AND nt.t_Object =\n",
                   "                                    LPAD (val.t_pmPaymentID, 10, '0'))),\n",
                   "          0)\n",
                   "          IsPaymentCategories,\n",
                   "       NVL (\n",
                   "          (SELECT 1\n",
                   "             FROM DUAL\n",
                   "            WHERE EXISTS\n",
                   "                     (SELECT 1\n",
                   "                        FROM dobjatcor_dbt nt\n",
                   "                       WHERE     nt.t_ObjectType = val.t_ObjectType\n",
                   "                             AND nt.t_Object =\n",
                   "                                    LPAD (val.t_pmPaymentID, 34, '0'))),\n",
                   "          0)\n",
                   "          IsCategories\n",
                   "  FROM (SELECT val.t_PaymentID,\n",
                   "               val.t_PaymentKind,\n",
                   "               val.t_SubKind,\n",
                   "               val.t_PaymStatus,\n",
                   "               val.t_PaymentPriority,\n",
                   "               val.t_ShifrOper,\n",
                   "               val.t_ValueDate,\n",
                   "               val.t_Number,\n",
                   "               val.t_Date,\n",
                   "               val.t_ClientDate,\n",
                   "               val.t_BankDate,\n",
                   "               val.t_CloseDate,\n",
                   "               val.t_PayDate,\n",
                   "               val.t_DocKind,\n",
                   "               val.t_Chapter,\n",
                   "               val.t_NumberPack,\n",
                   "               val.t_Instancy,\n",
                   "               NVL(cre.t_Ground, NVL(deb.t_Ground, val.t_Ground)) t_Ground,\n",
                   "               case when (val.t_DebetCount <= 1 OR not deb.t_Ground is NULL) and val.t_Payer > 0 then val.t_Payer else NULL end t_Payer,\n",
                   "               case when val.t_DebetCount = 0 then val.t_PayerCodeKind else NULL end t_PayerCodeKind,\n",
                   "               case when val.t_DebetCount = 0 then val.t_PayerCode else NULL end t_PayerCode,\n",
                   "               case when NOT deb.t_Ground is NULL then\n",
                   "                         case when RSI_RSB_MASK.CompareStringWithMask(RSB_Common.GetRegStrValue('PS\\REQOPENACC\\ëóÖíÄ äãàÖçíéÇ'), deb.t_Account) = 1 then (select t_Name from dparty_dbt where t_PartyID = deb.t_AccountClient)\n",
                   "                              else deb.t_NameAccount end\n",
                   "                    else val.t_PayerName end t_PayerName,\n",
                   "               case when val.t_DebetCount = 0 then val.t_PayerINN else NULL end t_PayerINN,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then NVL(deb.t_Account, val.t_PayerAccount) else NULL end t_PayerAccount,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then NVL(deb.t_FIID, val.t_PayerFIID) else NULL end t_PayerFIID,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then NVL(deb.t_Amount, val.t_PayerAmount) else NULL end t_PayerAmount,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerBankCodeKind else NULL end t_PayerBankCodeKind,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerBankCode else NULL end t_PayerBankCode,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerBankName else NULL end t_PayerBankName,\n",
                   "               case when (val.t_DebetCount <= 1 OR not deb.t_Ground is NULL) and val.t_PayerBankID > 0 then val.t_PayerBankID else NULL end t_PayerBankID,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerCorrAccNostro else NULL end t_PayerCorrAccNostro,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerCorrBankCodeKind else NULL end t_PayerCorrBankCodeKind,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerCorrBankCode else NULL end t_PayerCorrBankCode,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerCorrBankName else NULL end t_PayerCorrBankName,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerCorrBankID else NULL end t_PayerCorrBankID,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerBankMarkDate else NULL end t_PayerBankMarkDate,\n",
                   "               case when val.t_DebetCount <= 1 OR not deb.t_Ground is NULL then val.t_PayerChargeOffDate else NULL end t_PayerChargeOffDate,\n",
                   "               case when (val.t_CreditCount <= 1 OR not cre.t_Ground is NULL) and val.t_Receiver > 0 then val.t_Receiver else NULL end t_Receiver,\n",
                   "               case when val.t_CreditCount = 0 then val.t_ReceiverCodeKind else NULL end t_ReceiverCodeKind,\n",
                   "               case when val.t_CreditCount = 0 then val.t_ReceiverCode else NULL end t_ReceiverCode,\n",
                   "               case when NOT cre.t_Ground is NULL then\n",
                   "                         case when RSI_RSB_MASK.CompareStringWithMask(RSB_Common.GetRegStrValue('PS\\REQOPENACC\\ëóÖíÄ äãàÖçíéÇ'), cre.t_Account) = 1 then (select t_Name from dparty_dbt where t_PartyID = cre.t_AccountClient)\n",
                   "                              else cre.t_NameAccount end\n",
                   "                    else val.t_ReceiverName end t_ReceiverName,\n",
                   "               case when val.t_CreditCount = 0 then val.t_ReceiverINN else NULL end t_ReceiverINN,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then NVL(cre.t_Account, val.t_ReceiverAccount) else NULL end t_ReceiverAccount,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then NVL(cre.t_FIID, val.t_ReceiverFIID) else NULL end t_ReceiverFIID,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then NVL(cre.t_Amount, val.t_ReceiverAmount) else NULL end t_ReceiverAmount,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverBankCodeKind else NULL end t_ReceiverBankCodeKind,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverBankCode else NULL end t_ReceiverBankCode,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverBankName else NULL end t_ReceiverBankName,\n",
                   "               case when (val.t_CreditCount <= 1 OR not cre.t_Ground is NULL) and val.t_ReceiverBankID > 0 then val.t_ReceiverBankID else NULL end t_ReceiverBankID,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverCorrAccNostro else NULL end t_ReceiverCorrAccNostro,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverCorrBankCodeKind else NULL end t_ReceiverCorrBankCodeKind,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverCorrBankCode else NULL end t_ReceiverCorrBankCode,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverCorrBankName else NULL end t_ReceiverCorrBankName,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverCorrBankAccount else NULL end t_ReceiverCorrBankAccount,\n",
                   "               case when val.t_CreditCount <= 1 OR not cre.t_Ground is NULL then val.t_ReceiverCorrBankID else NULL end t_ReceiverCorrBankID,\n",
                   "               val.t_TaxAuthorState,\n",
                   "               val.t_TaxPmDate,\n",
                   "               val.t_TaxPmGround,\n",
                   "               val.t_TaxPmNumber,\n",
                   "               val.t_TaxPmPeriod,\n",
                   "               val.t_TaxPmType,\n",
                   "               val.t_UIN,\n",
                   "               val.t_PaperKind,\n",
                   "               val.t_PaperSeries,\n",
                   "               val.t_PaperNumber,\n",
                   "               val.t_PaperIssuedDate,\n",
                   "               val.t_PaperIssuer,\n",
                   "               val.t_AkkrAccRealReceiver,\n",
                   "               val.t_AkkrAddCondition,\n",
                   "               val.t_AkkrDate,\n",
                   "               val.t_AkkrPayCondition,\n",
                   "               val.t_AkkrRepresentation,\n",
                   "               val.t_AkkrType,\n",
                   "               val.t_BaseAmount,\n",
                   "               val.t_BaseFIID,\n",
                   "               val.t_IsBaseInverse,\n",
                   "               val.t_BaseRatePoint,\n",
                   "               val.t_BaseRateValue,\n",
                   "               val.t_BaseRateDate,\n",
                   "               val.t_BaseRateType,\n",
                   "               val.t_BaseRateScale,\n",
                   "               NVL(cre.t_IsInverse, NVL(deb.t_IsInverse, val.t_RateIsInverse)) t_RateIsInverse,\n",
                   "               NVL(cre.t_Point, NVL(deb.t_Point, val.t_RatePoint)) t_RatePoint,\n",
                   "               NVL(cre.t_Rate, NVL(deb.t_Rate, val.t_RateValue)) t_RateValue,\n",
                   "               NVL(cre.t_RateDate, NVL(deb.t_RateDate, val.t_RateDate)) t_RateDate,\n",
                   "               NVL(cre.t_RateType, NVL(deb.t_RateType, val.t_RateType)) t_RateType,\n",
                   "               NVL(cre.t_Scale, NVL(deb.t_Scale, val.t_RateScale)) t_RateScale,\n",
                   "               val.t_I2PlaceDate,\n",
                   "               val.t_PartPaymDateMain,\n",
                   "               val.t_PartPaymNumMain,\n",
                   "               val.t_PartPaymNumber,\n",
                   "               val.t_PartPaymRestAmountMain,\n",
                   "               val.t_PartPaymShifrMain,\n",
                   "               val.t_Accept,\n",
                   "               val.t_AcceptDate,\n",
                   "               val.t_AcceptTerm,\n",
                   "               --val.t_IndexPlaceDate,\n",
                   "               --val.t_IndexExitDate,\n",
                   "               val.t_AcceptPeriod,\n",
                   "               NVL(cre.t_CashSymbol, val.t_CashSymbolCredit) t_CashSymbolCredit,\n",
                   "               NVL(deb.t_CashSymbol, val.t_CashSymbolDebet) t_CashSymbolDebet,\n",
                   "               val.t_CheckTerror,\n",
                   "               val.t_IsVO,\n",
                   "               val.t_VO_Accept,\n",
                   "               val.t_VO_Direct,\n",
                   "               val.t_VO_FIID,\n",
                   "               val.t_VO_Oper,\n",
                   "               val.t_VO_OperFIO,\n",
                   "               val.t_VO_PayerBankCode,\n",
                   "               val.t_VO_PayerBankCodeKind,\n",
                   "               val.t_VO_PayerBankCountry,\n",
                   "               val.t_VO_PayerBankID,\n",
                   "               val.t_VO_ReceiverBankCode,\n",
                   "               val.t_VO_ReceiverBankCodeKind,\n",
                   "               val.t_VO_ReceiverBankCountry,\n",
                   "               val.t_VO_ReceiverBankID,\n",
                   "               val.t_ComissAccount,\n",
                   "               val.t_ComissCharges,\n",
                   "               val.t_ComissFIID,\n",
                   "               val.t_TypeDocument,\n",
                   "               val.t_UserTypeDocument,\n",
                   "               val.t_AdditionalInfo,\n",
                   "               val.t_ClaimID,\n",
                   "               val.t_Department,\n",
                   "               val.t_OKATOCode,\n",
                   "               val.t_Oper,\n",
                   "               val.t_OperFIO,\n",
                   "               val.t_Origin,\n",
                   "               val.t_SymbNotBalCredit,\n",
                   "               val.t_SymbNotBalDebet,\n",
                   "               val.t_BttTICode,\n",
                   "               val.t_BCOrdKind,\n",
                   "               val.t_UserField1,\n",
                   "               val.t_UserField2,\n",
                   "               val.t_UserField3,\n",
                   "               val.t_UserField4,\n",
                   "               --var.t_PostDate,\n",
                   "               --val.t_PostTime,\n",
                   "               val.t_pmPaymentID,\n",
                   "               val.t_PSCAppKey,\n",
                   "               val.t_PSCDocKind,\n",
                   "               val.t_ObjectType\n",
                   "          FROM (SELECT pmpaym.t_TypeDocument,\n",
                   "                       tmp.t_DocumentID t_PaymentID,\n",
                   "                       tmp.t_OrderID t_pmAddPIID,\n",
                   "                       pmpaym.t_UserTypeDocument,\n",
                   "                       psord.t_DocKind t_SubKind,\n",
                   "                       psdem.t_AcceptDate,\n",
                   "                       psdem.t_AcceptPeriod,\n",
                   "                       psdem.t_AcceptTerm,\n",
                   "                       acceptName.t_szNameAlg t_Accept,\n",
                   "                       akkr.t_Date t_AkkrDate,\n",
                   "                       akkr.t_Type t_AkkrType,\n",
                   "                       akkr.t_Representation t_AkkrRepresentation,\n",
                   "                       akkr.t_AddCondition t_AkkrAddCondition,\n",
                   "                       akkr.t_AccRealReceiver t_AkkrAccRealReceiver,\n",
                   "                       akkr.t_PayCondition t_AkkrPayCondition,\n",
                   "                       NVL (bcord.t_BCOrdKind, 0) t_BCOrdKind,\n",
                   "                       psc.t_PaperKind,\n",
                   "                       psc.t_PaperSeries,\n",
                   "                       psc.t_PaperNumber,\n",
                   "                       psc.t_PaperIssuedDate,\n",
                   "                       psc.t_PaperIssuer,\n",
                   "                       pmpaym.t_PartPaymNumber,\n",
                   "                       pmpaym.t_PartPaymShifrMain,\n",
                   "                       pmpaym.t_PartPaymNumMain,\n",
                   "                       pmpaym.t_PartPaymDateMain,\n",
                   "                       pmpaym.t_PartPaymRestAmountMain,\n",
                   "                       pmpaym.t_PaymentID t_pmPaymentID,\n",
                   "                       pmpaym.t_BaseFIID,\n",
                   "                       pmpaym.t_BaseAmount,\n",
                   "                       pmpaym.t_FIID t_PayerFIID,\n",
                   "                       pmpaym.t_Amount t_PayerAmount,\n",
                   "                       pmpaym.t_PayFIID t_ReceiverFIID,\n",
                   "                       pmpaym.t_PayAmount t_ReceiverAmount,\n",
                   "                       pmpaym.t_RateType,\n",
                   "                       pmpaym.t_Scale t_RateScale,\n",
                   "                       pmpaym.t_Point t_RatePoint,\n",
                   "                       pmpaym.t_Rate t_RateValue,\n",
                   "                       pmpaym.t_IsInverse t_RateIsInverse,\n",
                   "                       pmpaym.t_RateDate,\n",
                   "                       pmpaym.t_BaseRateType,\n",
                   "                       pmpaym.t_BaseScale t_BaseRateScale,\n",
                   "                       pmpaym.t_BasePoint t_BaseRatePoint,\n",
                   "                       pmpaym.t_BaseRate t_BaseRateValue,\n",
                   "                       pmpaym.t_IsBaseInverse,\n",
                   "                       pmpaym.t_BaseRateDate,\n",
                   "                       rmprop.t_Date,\n",
                   "                       pmpaym.t_PayerBankEnterDate t_BankDate,\n",
                   "                       pmpaym.t_CloseDate,\n",
                   "                       rmprop.t_PayDate,\n",
                   "                       pmpaym.t_ValueDate,\n",
                   "                       rmprop.t_ClientDate,\n",
                   "                       rmprop.t_PayerChargeOffDate,\n",
                   "                       pmpaym.t_DocKind,\n",
                   "                       pmpaym.t_PayerBankID,\n",
                   "                       deb.t_CodeKind t_PayerBankCodeKind,\n",
                   "                       deb.t_BankCode t_PayerBankCode,\n",
                   "                       rmprop.t_PayerBankName,\n",
                   "                       rmprop.t_Instancy,\n",
                   "                       pmpaym.t_PayerAccount,\n",
                   "                       pmpaym.t_PayerCode,\n",
                   "                       pmpaym.t_PayerCodeKind,\n",
                   "                       rmprop.t_PayerCorrAccNostro,\n",
                   "                       pmpaym.t_Payer,\n",
                   "                       rmprop.t_PayerName,\n",
                   "                       rmprop.t_PayerINN,\n",
                   "                       deb.t_CorrID t_PayerCorrBankID,\n",
                   "                       deb.t_CorrCodeKind t_PayerCorrBankCodeKind,\n",
                   "                       deb.t_CorrCode t_PayerCorrBankCode,\n",
                   "                       pmpaym.t_PayerBankMarkDate,\n",
                   "                       rmprop.t_PayerCorrBankName,\n",
                   "                       pmpaym.t_ReceiverCodeKind,\n",
                   "                       pmpaym.t_ReceiverCode,\n",
                   "                       pmpaym.t_ReceiverBankID,\n",
                   "                       cred.t_CodeKind t_ReceiverBankCodeKind,\n",
                   "                       cred.t_BankCode t_ReceiverBankCode,\n",
                   "                       rmprop.t_ReceiverBankName,\n",
                   "                       pmpaym.t_ReceiverAccount,\n",
                   "                       rmprop.t_ReceiverCorrAccNostro,\n",
                   "                       pmpaym.t_Receiver,\n",
                   "                       rmprop.t_ReceiverName,\n",
                   "                       rmprop.t_ReceiverINN,\n",
                   "                       cred.t_CorrID t_ReceiverCorrBankID,\n",
                   "                       cred.t_CorrCodeKind t_ReceiverCorrBankCodeKind,\n",
                   "                       cred.t_CorrCode t_ReceiverCorrBankCode,\n",
                   "                       rmprop.t_ReceiverCorrBankName,\n",
                   "                       cred.t_CorrAcc t_ReceiverCorrBankAccount,\n",
                   "                       rmprop.t_Number,\n",
                   "                       rmprop.t_Ground,\n",
                   "                       pmpaym.t_NumberPack,\n",
                   "                       rmprop.t_ShifrOper,\n",
                   "                       rmprop.t_Priority t_PaymentPriority,\n",
                   "                       rmprop.t_TaxAuthorState,\n",
                   "                       rmprop.t_BttTICode,\n",
                   "                       rmprop.t_TaxPmGround,\n",
                   "                       rmprop.t_TaxPmPeriod,\n",
                   "                       rmprop.t_TaxPmNumber,\n",
                   "                       rmprop.t_TaxPmDate,\n",
                   "                       rmprop.t_TaxPmType,\n",
                   "                       rmprop.t_UIN,\n",
                   "                       rmprop.t_OKATOCode,\n",
                   "                       rmprop.t_CashSymbolDebet,\n",
                   "                       rmprop.t_CashSymbolCredit,\n",
                   "                       rmprop.t_SymbNotBalDebet,\n",
                   "                       rmprop.t_SymbNotBalCredit,\n",
                   "                       pmpaym.t_Origin,\n",
                   "                       pmpaym.t_Department,\n",
                   "                       pmpaym.t_Chapter,\n",
                   "                       pmpaym.t_Oper,\n",
                   "                       pmpaym.t_UserField1,\n",
                   "                       pmpaym.t_UserField2,\n",
                   "                       pmpaym.t_UserField3,\n",
                   "                       pmpaym.t_UserField4,\n",
                   "                       pmpaym.t_ComissFIID,\n",
                   "                       pmpaym.t_ComissAccount,\n",
                   "                       curtr.t_IsVO t_IsVO,\n",
                   "                       curtr.t_Accept t_VO_Accept,\n",
                   "                       curtr.t_Oper t_VO_Oper,\n",
                   "                       curtr.t_FIID t_VO_FIID,\n",
                   "                       curtr.t_Direct t_VO_Direct,\n",
                   "                       curtr.t_PayerBankID t_VO_PayerBankID,\n",
                   "                       curtr.t_PayerBankCodeKind t_VO_PayerBankCodeKind,\n",
                   "                       curtr.t_PayerBankCode t_VO_PayerBankCode,\n",
                   "                       curtr.t_PayerBankCountry t_VO_PayerBankCountry,\n",
                   "                       curtr.t_ReceiverBankID t_VO_ReceiverBankID,\n",
                   "                       curtr.t_ReceiverBankCodeKind t_VO_ReceiverBankCodeKind,\n",
                   "                       curtr.t_ReceiverBankCode t_VO_ReceiverBankCode,\n",
                   "                       curtr.t_ReceiverBankCountry t_VO_ReceiverBankCountry,\n",
                   "                       pmpaym.t_CheckTerror,\n",
                   "                       rmprop.t_AdditionalInfo,\n",
                   "                       pmpaym.t_ClaimID,\n",
                   "                       pmpaym.t_I2PlaceDate,\n",
                   "                       DECODE (rmprop.t_PaymentKind,\n",
                   "                               CHR (0), 'ç',\n",
                   "                               rmprop.t_PaymentKind)\n",
                   "                          t_PaymentKind,\n",
                   "                       NVL (pmpaym.t_PaymStatus, 32000) t_PaymStatus,\n",
                   "                       rmprop.t_ComissCharges,\n",
                   "                       NVL (VO.t_Name, CHR (1)) t_VO_OperFIO,\n",
                   "                       NVL (oper.t_Name, CHR (1)) t_OperFIO,\n",
                   "                       DECODE (\n",
                   "                          psc.t_Status,\n",
                   "                          3                          /*STAT_CASH_ORDER_CLOSE*/\n",
                   "                           ,    LPAD (psc.t_ConnectAppKind, 5, '0')\n",
                   "                             || psc.t_ConnectAppKey,\n",
                   "                          LPAD (pmpaym.t_PaymentID, 34, '0'))\n",
                   "                          t_PSCAppKey,\n",
                   "                       DECODE (psc.t_IsCurrency, 'X', 7       /*DLDOC_CARRYC*/\n",
                   "                                                       , 1     /*DLDOC_CARRY*/\n",
                   "                                                          ) t_PSCDocKind,\n",
                   "                       PM_COMMON.DefineObjectKind (pmpaym.t_DocKind)\n",
                   "                          t_ObjectType,\n",
                   "                       (SELECT COUNT (1)\n",
                   "                          FROM dpmaddpi_dbt pmadd\n",
                   "                         WHERE     pmadd.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                               AND pmadd.t_DebetCredit = 0 /*PM_COMMON.PRT_DEBET*/\n",
                   "                                                          )\n",
                   "                          t_DebetCount,\n",
                   "                       (SELECT COUNT (1)\n",
                   "                          FROM dpmaddpi_dbt pmadd\n",
                   "                         WHERE     pmadd.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                               AND pmadd.t_DebetCredit = 1 /*PM_COMMON.PRT_CREDIT*/\n",
                   "                                                          )\n",
                   "                          t_CreditCount,\n",
                   "                       (SELECT pmadd.t_PmAddPIID\n",
                   "                          FROM dpmaddpi_dbt pmadd\n",
                   "                         WHERE     pmadd.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                               AND pmadd.t_DebetCredit = 0 /*PM_COMMON.PRT_DEBET*/\n",
                   "                               AND ROWNUM = 1)\n",
                   "                          t_DebetAddPIID,\n",
                   "                       (SELECT pmadd.t_PmAddPIID\n",
                   "                          FROM dpmaddpi_dbt pmadd\n",
                   "                         WHERE     pmadd.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                               AND pmadd.t_DebetCredit = 1 /*PM_COMMON.PRT_CREDIT*/\n",
                   "                               AND ROWNUM = 1)\n",
                   "                          t_CreditAddPIID\n",
                   "                  FROM dpmpaym_dbt pmpaym,\n",
                   "                       dpmrmprop_dbt rmprop,\n",
                   "                       dpmcurtr_dbt curtr,\n",
                   "                       dpmprop_dbt cred,\n",
                   "                       dpmprop_dbt deb,\n",
                   "                       dpspaydem_dbt psdem,\n",
                   "                       dpmakkr_dbt akkr,\n",
                   "                       dpscshdoc_dbt psc,\n",
                   "                       dpspayord_dbt psord,\n",
                   "                       dnamealg_dbt acceptName,\n",
                   "                       dperson_dbt oper,\n",
                   "                       dperson_dbt VO,\n",
                   "                       dps_bcord_dbt bcord,\n",
                   "                       doprtemp_tmp tmp\n",
                   "                 WHERE     pmpaym.t_PaymentID = tmp.t_ID_Operation\n",
                   "                       AND rmprop.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                       AND curtr.t_PaymentID(+) = pmpaym.t_PaymentID\n",
                   "                       AND cred.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                       AND cred.t_debetcredit = 1\n",
                   "                       AND deb.t_PaymentID = pmpaym.t_PaymentID\n",
                   "                       AND deb.t_debetcredit = 0\n",
                   "                       AND psdem.t_OrderID(+) = pmpaym.t_PaymentID\n",
                   "                       AND psord.t_OrderID(+) = pmpaym.t_PaymentID\n",
                   "                       AND acceptName.t_iNumberAlg(+) = psdem.t_Accept\n",
                   "                       AND acceptName.t_iTypeAlg(+) = 2988\n",
                   "                       AND akkr.t_PaymentID(+) = pmpaym.t_PaymentID\n",
                   "                       AND psc.t_AutoKey(+) = pmpaym.t_PaymentID\n",
                   "                       AND bcord.t_PaymentID(+) = pmpaym.t_PaymentID\n",
                   "                       AND oper.t_Oper(+) = pmpaym.t_Oper\n",
                   "                       AND VO.t_Oper(+) = curtr.t_Oper) val,\n",
                   "               dpmaddpi_dbt deb,\n",
                   "               dpmaddpi_dbt cre\n",
                   "         WHERE     deb.t_PaymentID(+) = val.t_pmPaymentID\n",
                   "               AND deb.t_DebetCredit(+) = 0            /*PM_COMMON.PRT_DEBET*/\n",
                   "               AND deb.t_PmAddPIID(+) =\n",
                   "                      DECODE (val.t_DebetCount, 1, t_DebetAddPIID, val.t_pmAddPIID)\n",
                   "               AND cre.t_PaymentID(+) = val.t_pmPaymentID\n",
                   "               AND cre.t_DebetCredit(+) = 1           /*PM_COMMON.PRT_CREDIT*/\n",
                   "               AND cre.t_PmAddPIID(+) =\n",
                   "                      DECODE (val.t_CreditCount, 1, t_CreditAddPIID, val.t_pmAddPIID)) val\n");
    var rs = execSQLSelect(query);
    rs.NullConversion = true;
    while (rs.moveNext())
      var res = TPayment();
     
      var i:integer = 0,
          count:integer = rs.FldCount - 1,
          fld:RsdField;
      for( i, 0, count, 1 )
        fld = rs.Fld(i);  
        if ((ValType(fld.Value) != 26) and (GenPropID(res, SubStr( fld.Name, 3 )) != -1))
          GenSetProp( res, SubStr( fld.Name, 3 ), fld.Value );
        end;
      end;
      res.CashSymbols = TArray();
      if (rs.value("IsCashSymbols"))
        var trs = execSQLSelect("select t_Symbol, t_Sum from dsymbcash_dbt sc where sc.t_DocKind = ? and sc.t_ApplicationKey = ?", 
                                  makeArray(SQLParam("", rs.value("t_PSCDocKind")), SQLParam("", rs.value("t_PSCAppKey"))));
        trs.NullConversion = true;
        while (trs.moveNext())
          var val = TPMCashSymbol;
          count = trs.FldCount - 1;
          for( i, 0, count, 1 )
            fld = trs.Fld(i);
            if (GenPropID(val, SubStr( fld.Name, 3 )) != -1)
              GenSetProp( val, SubStr( fld.Name, 3 ), fld.Value );
            end;
          end;
          res.CashSymbols[res.CashSymbols.size] = val;
        end;
      end;
      res.Notes = TArray();
      if (rs.value("IsPaymentNotes"))
        var DocumentID = GetDocumentID(OBJTYPE_PAYMENT, 0, rs.value("t_pmPaymentID"));
        trs = execSQLSelect(string("select t_NoteKind, t_Name from dnotekind_dbt nk where nk.t_ObjectType = ? and ",
                                   "exists (select 1 from dnotetext_dbt nt where nt.t_ObjectType = nk.t_ObjectType and nt.t_NoteKind = nk.t_NoteKind and nt.t_DocumentID = ?)"), 
                                  makeArray(SQLParam("", OBJTYPE_PAYMENT), SQLParam("", DocumentID)));
        trs.NullConversion = true;
        while (trs.moveNext())
          val = TPMNote;
          val.NoteKind = trs.value(1);
          val.NoteValue = string(readNoteForObject(OBJTYPE_PAYMENT, DocumentID, trs.value(0), NULL, val.Date));
          if (val.Date != date(0,0,0))
            res.Notes[res.Notes.size] = val;
          end;
        end;
      end;
      res.Categories = TArray();
      if (rs.value("IsPaymentCategories"))
        trs = execSQLSelect("select atcor.t_GroupID, atcor.t_AttrID, attr.t_NumInList t_AttrCode, attr.t_FullName t_AttrName from dobjatcor_dbt atcor, dobjattr_dbt attr where attr.t_ObjectType = atcor.t_ObjectType and attr.t_AttrID = atcor.t_AttrID and atcor.t_GroupID = attr.t_GroupID and atcor.t_ObjectType = ? and atcor.t_Object = ? and atcor.t_ValidToDate = ?", 
                                  makeArray(SQLParam("", OBJTYPE_PAYMENT), 
                                            SQLParam("", GetDocumentID(OBJTYPE_PAYMENT, 0, rs.value("t_pmPaymentID"))),
                                            SQLParam("", date(31,12,9999))));
        trs.NullConversion = true;
        while (trs.moveNext())
          val = TPMCategories();
          count = trs.FldCount - 1;
          for( i, 0, count, 1 )
            fld = trs.Fld(i);
            if (GenPropID(val, SubStr( fld.Name, 3 )) != -1)
              GenSetProp( val, SubStr( fld.Name, 3 ), fld.Value );
            end;
          end;
          res.Categories[res.Categories.size] = val;
        end;
      end;
      if (rs.value("IsNotes"))
        var ObjectType = rs.value("t_ObjectType");
        DocumentID = GetDocumentID(0, res.DocKind, rs.value("t_pmPaymentID"));
        trs = execSQLSelect(string("select t_NoteKind, t_Name from dnotekind_dbt nk where nk.t_ObjectType = ? and ",
                                   "exists (select 1 from dnotetext_dbt nt where nt.t_ObjectType = nk.t_ObjectType and nt.t_NoteKind = nk.t_NoteKind and nt.t_DocumentID = ?)"), 
                                  makeArray(SQLParam("", ObjectType), SQLParam("", DocumentID)));
        trs.NullConversion = true;
        while (trs.moveNext())
          val = TPMNote;
          val.NoteKind = trs.value(1);
          val.NoteValue = readNoteForObject(ObjectType, DocumentID, trs.value(0), NULL, val.Date);
          if (val.Date != date(0,0,0))
            res.Notes[res.Notes.size] = val;
          end;
        end;
      end;
      if (rs.value("IsCategories"))
        trs = execSQLSelect("select atcor.t_GroupID, atcor.t_AttrID, attr.t_NumInList t_AttrCode, attr.t_FullName t_AttrName from dobjatcor_dbt atcor, dobjattr_dbt attr where attr.t_ObjectType = atcor.t_ObjectType and attr.t_AttrID = atcor.t_AttrID and atcor.t_GroupID = attr.t_GroupID and atcor.t_ObjectType = ? and atcor.t_Object = ? and atcor.t_ValidToDate = ?", 
                                  makeArray(SQLParam("", rs.value("t_ObjectType")), 
                                            SQLParam("", GetDocumentID(0, res.DocKind, rs.value("t_pmPaymentID"))),
                                            SQLParam("", date(31,12,9999))));
        trs.NullConversion = true;
        while (trs.moveNext())
          val = TPMCategories();
          count = trs.FldCount - 1;
          for( i, 0, count, 1 )
            fld = trs.Fld(i);
            if (GenPropID(val, SubStr( fld.Name, 3 )) != -1)
              GenSetProp( val, SubStr( fld.Name, 3 ), fld.Value );
            end;
          end;
          res.Categories[res.Categories.size] = val;
        end;
      end;

      res.COVector = TArray();
      if (res.IsVO == "X")
        trs = execSQLSelect("select t_ContractDate, t_ContractFIID, PM_SCRHLP.GetFICode(t_ContractFIID, 1) t_ContractFIISO, " + 
                                   "t_ContractNumber, t_ContractRegDate t_PassportDate, t_ContractUIN t_PassportNumber, t_ContractRegDate, t_ContractUIN, " + 
                                   "t_VO_CodeStr t_VO_Code from dpmco_dbt where t_PaymentID = ?",
                                 makeArray(SQLParam("", rs.value("t_pmPaymentID"))));
        trs.NullConversion = true;
        while (trs.moveNext())
          val = TPMCO();
          count = trs.FldCount - 1;
          for( i, 0, count, 1 )
            fld = trs.Fld(i);
            if (GenPropID(val, SubStr( fld.Name, 3 )) != -1)
              GenSetProp( val, SubStr( fld.Name, 3 ), fld.Value );
            end;
          end;
          res.COVector[res.COVector.size] = val;
        end;
      end;
      
      Result[Result.size] = res;
    end;
  end;

  if (IDacctrn.size > 0)
    execSQL("truncate table doprtemp_tmp");
    ins = RsbSQLInsert(string("insert into doprtemp_tmp (t_ID_Operation, t_OrderID, t_DocumentID) ",
                              "values (?, 0, ?)"), 2, IDacctrn.size);
    ins.AddParam(V_INTEGER, IDacctrn);
    ins.AddParam(V_STRING, IDSacctrn, 35);

    old = SetDialogFlag(0);
    if (not ins.Insert())
      SetDialogFlag(old);
      RunError("éË®°™† Ø‡® ®≠®Ê®†´®ß†Ê®® ·Ø®·™† Ø‡Æ¢Æ§Æ™");
    end;
    SetDialogFlag(old);
    query = string(
                   "SELECT val.*,\n",
                   "       PM_SCRHLP.GetFICode (t_PayerFIID, 1) t_PayerFIISO,\n",
                   "       PM_SCRHLP.GetFICode (t_ReceiverFIID, 1) t_ReceiverFIISO,\n",
                   "       NVL (\n",
                   "          (SELECT 1\n",
                   "             FROM DUAL\n",
                   "            WHERE EXISTS\n",
                   "                     (SELECT 1\n",
                   "                        FROM dsymbcash_dbt sc\n",
                   "                       WHERE     sc.t_AccTrnID = val.t_AccTrnID)),\n",
                   "          0)\n",
                   "          IsCashSymbols\n",
                   "  FROM (SELECT trn.t_TypeDocument,\n",
                   "                       tmp.t_DocumentID t_PaymentID,\n",
                   "                       trn.t_AccTrnID t_AccTrnID,\n"
                   "                       trn.t_UserTypeDocument,\n",
                   "                       trn.t_FIID_Payer t_PayerFIID,\n",
                   "                       trn.t_Sum_Payer t_PayerAmount,\n",
                   "                       trn.t_FIID_Receiver t_ReceiverFIID,\n",
                   "                       trn.t_Sum_Receiver t_ReceiverAmount,\n",
                   "                       trn.t_Scale t_RateScale,\n",
                   "                       trn.t_Point t_RatePoint,\n",
                   "                       trn.t_Rate t_RateValue,\n",
                   "                       trn.t_IsInverse t_RateIsInverse,\n",
                   "                       trn.t_Date_Carry t_Date,\n",
                   "                       trn.t_Date_Carry t_BankDate,\n",
                   "                       trn.t_Date_Carry t_CloseDate,\n",
                   "                       trn.t_Date_Carry t_PayDate,\n",
                   "                       trn.t_Date_Carry t_ValueDate,\n",
                   "                       trn.t_Date_Carry t_ClientDate,\n",
                   "                       0 t_DocKind,\n",
                   "                       dep.t_PartyID t_PayerBankID,\n",
                   "                       3 t_PayerBankCodeKind,\n",
                   "                       RSI_RSBPARTY.PT_GetPartyCode(dep.t_PartyID, 3) t_PayerBankCode,\n",
                   "                       pb.t_Name t_PayerBankName,\n",
                   "                       trn.t_Account_Payer t_PayerAccount,\n",
                   "                       bnk.t_CorAcc t_PayerCorrAccNostro,\n",
                   "                       pay.t_Client t_Payer,\n",
                   "                       case when RSI_RSB_MASK.CompareStringWithMask(RSB_Common.GetRegStrValue('PS\\REQOPENACC\\ëóÖíÄ äãàÖçíéÇ'), trn.t_Account_Payer) = 1 then (select t_Name from dparty_dbt where t_PartyID = pay.t_Client)\n",
                   "                              else pay.t_NameAccount end t_PayerName,\n",
                   "                       dep.t_PartyID t_ReceiverBankID,\n",
                   "                       3 t_ReceiverBankCodeKind,\n",
                   "                       RSI_RSBPARTY.PT_GetPartyCode(dep.t_PartyID, 3) t_ReceiverBankCode,\n",
                   "                       pb.t_Name t_ReceiverBankName,\n",
                   "                       trn.t_Account_Receiver t_ReceiverAccount,\n",
                   "                       bnk.t_CorAcc t_ReceiverCorrAccNostro,\n",
                   "                       rec.t_Client t_Receiver,\n",
                   "                       case when RSI_RSB_MASK.CompareStringWithMask(RSB_Common.GetRegStrValue('PS\\REQOPENACC\\ëóÖíÄ äãàÖçíéÇ'), trn.t_Account_Receiver) = 1 then (select t_Name from dparty_dbt where t_PartyID = rec.t_Client)\n",
                   "                              else rec.t_NameAccount end t_ReceiverName,\n",
                   "                       '0' t_Number,\n",
                   "                       trn.t_Ground,\n",
                   "                       trn.t_Number_Pack t_NumberPack,\n",
                   "                       trn.t_Shifr_Oper t_ShifrOper,\n",
                   "                       trn.t_Priority t_PaymentPriority,\n",
                   "                       trn.t_Department,\n",
                   "                       trn.t_Chapter,\n",
                   "                       trn.t_Oper,\n",
                   "                       trn.t_UserField1,\n",
                   "                       trn.t_UserField2,\n",
                   "                       trn.t_UserField3,\n",
                   "                       trn.t_UserField4,\n",
                   "                       trn.t_ClaimID,\n",
                   "                       32000 t_PaymStatus,\n",
                   "                       trn.t_Date_Carry t_PostDate,\n",
                   "                       trn.t_SystemTime t_PostTime,\n",
                   "                       NVL (oper.t_Name, CHR (1)) t_OperFIO\n",
                   "                  FROM dacctrn_dbt trn,\n",
                   "                       daccount_dbt rec,\n",
                   "                       daccount_dbt pay,\n",
                   "                       ddp_dep_dbt dep,\n",
                   "                       dparty_dbt pb,\n",
                   "                       dbankdprt_dbt bnk,\n",
                   "                       dperson_dbt oper,\n",
                   "                       doprtemp_tmp tmp\n",
                   "                 WHERE     trn.t_AcctrnID = tmp.t_ID_Operation\n",
                   "                   AND oper.t_Oper(+) = trn.t_Oper\n",
                   "                   AND rec.t_AccountID(+) = trn.t_AccountID_Receiver\n",
                   "                   AND pay.t_AccountID(+) = trn.t_AccountID_Payer\n",
                   "                   AND dep.t_Code(+) = trn.t_Department\n",
                   "                   AND pb.t_PartyID(+) = dep.t_PartyID\n",
                   "                   AND bnk.t_PartyID(+) = dep.t_PartyID) val\n");
    rs = execSQLSelect(query);
    rs.NullConversion = true;
    while (rs.moveNext())
      res = TPayment();
      count = rs.FldCount - 1;
      for( i, 0, count, 1 )
        fld = rs.Fld(i);  
        if ((ValType(fld.Value) != 26) and (GenPropID(res, SubStr( fld.Name, 3 )) != -1))
          GenSetProp( res, SubStr( fld.Name, 3 ), fld.Value );
        end;
      end;
      res.CashSymbols = TArray();
      if (rs.value("IsCashSymbols"))
        trs = execSQLSelect("select t_Symbol, t_Sum from dsymbcash_dbt sc where sc.t_AccTrnID = ?",
                                  makeArray(SQLParam("", rs.value("t_AccTrnID"))));
        trs.NullConversion = true;
        while (trs.moveNext())
          val = TPMCashSymbol;
          count = trs.FldCount - 1;
          for( i, 0, count, 1 )
            fld = trs.Fld(i);
            if (GenPropID(val, SubStr( fld.Name, 3 )) != -1)
              GenSetProp( val, SubStr( fld.Name, 3 ), fld.Value );
            end;
          end;
          res.CashSymbols[res.CashSymbols.size] = val;
        end;
      end;
      
      Result[Result.size] = res;
    end;
  end;
  if (Result.size == 0)
    RunError("ç• ≠†©§•≠(Î) ß†Ø‡†Ë®¢†•¨Î©(•) Ø´†‚•¶(®)");
  end;
  return Result;
end;