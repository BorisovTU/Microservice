/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v6.0.020
                 Copyright (c) R-Style Software Lab

  Имя файла        : mpcrmcd.mac

  Библиотека       : 

  Описание         : 

  Программист      : Дурягин Евгений (DEA)

  Создан           : 18.05.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter,  globals, library, FIInter;
    
var   DateCalculateBegin, 
      DateCalculateEnd,
      ContractID,
      ContractBoffice,
      ContractNumber,
      ContractAccount,
      OperNum,
      Schedkind,
      DateMin,
      OperName,
      Daily,
      OpKind,
      OperId,
      DocID,
      OperDate,
      contr,
      goper, 
      gCalcDateBegin, 
      gCalcDateEnd, 
      gPartyIDFil, 
      gTypeOfAccounts, 
      gFininstrFIID,
      gFininstrCode, 
      gFininstrName,
      gAccountMask, 
      gPartyIDClient,
      gClientName,
      gbackoffice, 
      gNumberMin, 
      gNumberMax, 
      gGrCalc, 
      gGrCalcName,
      gCalcID, 
      gCalcName,
      gRateID, 
      gRateName,
      gUserType, 
      gBeginDateMin, 
      gBeginDateMax;


RECORD contract( prccontract );
record Document(arhdoc);
/* ------------------------------- */

private macro PumpBO(BO)
   var cmd, RS;
   cmd = RSDCommand( " select t_code from dllvalues_dbt where t_list = 1118 and t_element = ? " ) ; 
   cmd.addParam( "", RSDBP_IN, BO );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      ContractBoffice = Rs.code;
   end;
end;

private macro PrintBottom(Days,TotalSum,SumFact)
   [├────────────────┴───────────────┴───────┴───────────┴────────┴───────────┴─────────────┴────────────┤];
   [│ Итого по расчету:                                                                                  │];
   [├────────────────┬───────────────┬───────┬───────────┬────────┬───────────┬─────────────┬────────────┤];
   if (Schedkind == 1) 
   [│################│###############│###### │           │        │########## │             │            │]
   (Date(DateCalculateBegin):c, Date(DateCalculateEnd):c, Days, TotalSum:0:5:z); 
   end;
   if (Schedkind != 1) 
   [│################│###############│###### │           │        │########## │             │ ########## │]
   (Date(DateCalculateBegin):c, Date(DateCalculateEnd):c, Days, TotalSum:0:5, SumFact); 
   end;
   [└────────────────┴───────────────┴───────┴───────────┴────────┴───────────┴─────────────┴────────────┘];
   [   ];
   [  Операционист:     #### #########](OperNum,OperName);
end;

private macro PrintLine(rs, Sum)
   [├────────────────┼───────────────┼───────┼───────────┼────────┼───────────┼─────────────┼────────────┤];
   [│################│###############│#######│###########│########│###########│             │            │]
   (Date(rs.STARTDATE):c, Date(rs.ENDDATE):c, rs.DAYSNUM, rs.Rest, rs.Rate, Sum:0:5:z); 
end;   

private macro PrintGraphRecord(rs, Days,Summ)
   [│################│###############│#######│           │        │###########│#############│############│]
   (Date(rs.PERIODBEGINDATE):c, Date(rs.PERIODENDDATE):c, Days, Summ:0:5:z, Date(rs.DATEREAL):c:z, rs.SUMFACT:z); 
end;                                                       

private macro PrintAddChargeHead(void)
   [├────────────────┴───────────────┴───────┴───────────┴────────┴───────────┴─────────────┴────────────┤];
   [│ Строка доначисления:                                                                               │];
   [├────────────────┬───────────────┬───────┬───────────┬────────┬───────────┬─────────────┬────────────┤];
end;

private macro PrintSubHead(void)
   [├────────────────┴───────────────┴───────┴───────────┴────────┴───────────┴─────────────┴────────────┤];
   if (Schedkind == 1)
   [│ По графику расчёта:                                                                                │];
   end;                                                     
   if (Schedkind == 2)
   [│ По графику начисления:                                                                             │];
   end;
   if (Schedkind == 3)
   [│ По графику оплаты:                                                                                 │];
   end;
   [├────────────────┬───────────────┬───────┬───────────┬────────┬───────────┬─────────────┬────────────┤];

end;

private macro PrintTempDailyItog(TotalSumR,i,BegDate,EndDate)
   [├────────────────┴───────────────┴───────┴───────────┴────────┴───────────┴─────────────┴────────────┤];
   [│ По ежедневному расчёту:                                                                            │];
   [├────────────────┬───────────────┬───────┬───────────┬────────┬───────────┬─────────────┬────────────┤];
   [│################│###############│#######│           │        │###########│             │            │]
   (Date(BegDate):c, Date(EndDate):c, i, TotalSumR:0:5:z); 
   
end;



private macro CalcOnePeriod(RS, Schedkind, isfirst, Days:@integer, Itog:@money)

   var DDate, BegDate, EndDate,
       cmd,cmd2,rs2,
       sum,
       i = 0,
       DaySum = $0,
       TotalSum = $0,
       TotalSumR = $0,
       ISum = $0,
       stat = 0;
   stat = 0;
   DDate = RS.Date;
   BegDate = RS.PeriodBeginDate;
   EndDate = RS.PeriodEndDate;
   //ничего не нашли
   if (DDate == date (0,0,0))
      stat = 1;
   end;

   if (stat == 0)
      cmd = RSDCommand( "{ ? = call RSB_PERCENT.PRC_CALCPERCENTVALUES ( ?, ?, ?, ?, ? ) }" );
      cmd.addParam( "retval", RSDBP_OUT, V_INTEGER );
      cmd.addParam( "Sum", RSDBP_OUT, V_NUMERIC );
      cmd.addParam( "", RSDBP_IN, ContractID );
      cmd.addParam( "", RSDBP_IN, BegDate );
      cmd.addParam( "", RSDBP_IN, EndDate );
      if (strlen(Daily)>0)
         cmd.addParam( "", RSDBP_IN, 1 );
      else
         cmd.addParam( "", RSDBP_IN, 0 );
      end;
      cmd.execute();
      Sum = cmd.value( "Sum" );
      cmd2 = RSDCommand( "select T_STARTDATE,T_ENDDATE,T_DAYSNUM,T_REST,T_RATE,T_SUM from DPRCCALCPRCVAL_TMP" );
      cmd2.execute();
      rs2 = TRsbDataSet(cmd2);
      while( rs2.movenext() )
          ISum = rs2.Sum;
          if (Schedkind != 1)
             ISum = round(ISum,2);
          end; 
          TotalSum = TotalSum + ISum;
          PrintLine(rs2,ISum);
          i = i + 1;
      end;
      Itog = TotalSum;
      Days = i;
   end;
   
end;
  


/*****************************************************************************
               Печать отчёта прогноза расчёта процентов
******************************************************************************/

macro MpcPrognosisGenReport( ContractBuf, ShedKind, DateCalcBegin, DateCalcEnd, isDaily )

   var  Data, RS, cmd,
        iSum = $0,
        iDays = 0,
        TotalSum = $0,
        TotalDays = 0,
   FactSum = $0,
   Summa = $0;

   
   SetBuff( contract, ContractBuf );
   DateCalculateBegin = DateCalcBegin; 
   DateCalculateEnd = DateCalcEnd;
   Schedkind = ShedKind;
   // для отладки
/*   ContractID = ContractBuf.ContractID;
   PumpBO(ContractBuf.BackOffice);
   ContractNumber = ContractBuf.Number; 
   ContractAccount = ContractBuf.Account; 
*/

   ContractID = contract.ContractID;
   PumpBO(contract.BackOffice);
   ContractNumber = contract.Number; 
   ContractAccount = contract.Account;    

   Daily = isDaily;
   OperNum = {oper};
   OperName = {Name_Oper};
   cmd = RSDCommand( " select min(T_PERIODBEGINDATE) as mindate, min(T_DATE) from " +
     " (select T_DATE, T_PERIODBEGINDATE, T_PERIODENDDATE, T_SPECIALTYPE,t_DATEREAL from DPRCCNTSCHED_DBT " + 
     "    where T_CONTRACTID = ? and T_SCHEDULEKIND = ? and  T_SPECIALTYPE <> 1 " +
     "    and (T_DATEREAL is NULL or T_DATEREAL = TO_DATE('01.01.0001') ) " +
          "     and T_PERIODBEGINDATE >= TO_DATE(?) and T_PERIODENDDATE <= TO_DATE(?) " +
          "    order by T_PERIODBEGINDATE) ") ; 

   cmd.addParam( "", RSDBP_IN, ContractID );
   cmd.addParam( "", RSDBP_IN, Schedkind );
   cmd.addParam( "", RSDBP_IN, DateCalculateBegin );
   cmd.addParam( "", RSDBP_IN, DateCalculateEnd );
   cmd.execute();

   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      DateMin = Rs.mindate;
   end;

   PrintAddChargeHead();
                               
   cmd = RSDCommand( "select T_DATE, T_PERIODBEGINDATE, T_PERIODENDDATE, T_SPECIALTYPE, T_SUMCALC, T_SUMFACT, T_DATEREAL from DPRCCNTSCHED_DBT " +
                      "where T_CONTRACTID = ? and T_SCHEDULEKIND = ? and T_PERIODENDDATE <= ? " +
                      "and T_PERIODBEGINDATE >= ? order by T_PERIODBEGINDATE " );
   cmd.addParam( "", RSDBP_IN, ContractID );
   cmd.addParam( "", RSDBP_IN, Schedkind );
   cmd.addParam( "", RSDBP_IN, DateCalculateEnd );
   cmd.addParam( "", RSDBP_IN, DateCalculateBegin );

   cmd.execute();

   RS = TRsbDataSet(cmd);
   if (Daily==88)
    while( RS.movenext() and (Rs.PERIODBEGINDATE != DateMin) )
      if (Rs.SPECIALTYPE != 1)
         CalcOnePeriod(RS, Schedkind, true, @iDays, @iSum);
         if (RS.SUMCALC != iSum)
       iDays = DATE(RS.PERIODENDDATE) - DATE(RS.PERIODBEGINDATE);
       PrintTempDailyItog(iSum,iDays,Rs.PERIODBEGINDATE,Rs.PERIODENDDATE);
       PrintSubHead();
       PrintGraphRecord(RS,iDays,RS.SUMCALC);
         else
            PrintSubHead();
            PrintGraphRecord(RS,iDays,iSum);
         end;
         TotalSum = TotalSum + iSum;
         TotalDays = TotalDays + iDays;
    Summa = Summa + RS.SUMCALC;
         if (ValType(RS.SUMFACT) != V_UNDEF)
    FactSum = FactSum + RS.SUMFACT;
    end;
      end;
      if (Rs.SPECIALTYPE == 1)
         PrintAddChargeHead(); 
      end;
    end;
   end;
   if ( ((ValType(DateMin) != V_UNDEF) and (ValType(Rs.PERIODBEGINDATE) != V_UNDEF)  and (Rs.PERIODBEGINDATE == DateMin)) or (RS.movenext()) ) 
      if (Rs.SPECIALTYPE != 1)
           CalcOnePeriod(RS, Schedkind, false, @iDays, @iSum);
           TotalSum = TotalSum + iSum;
           TotalDays = TotalDays + iDays;
      PrintSubHead();
      iDays = DATE(RS.PERIODENDDATE) - DATE(RS.PERIODBEGINDATE);
           PrintGraphRecord(RS,iDays,iSum);
      Summa = Summa + iSum;
           if (ValType(RS.SUMFACT) != V_UNDEF)
    FactSum = FactSum + RS.SUMFACT;
      end;
      end;
      if (Rs.SPECIALTYPE == 1)
           PrintAddChargeHead(); 
      end;
   end;
   TotalDays =  Date(DateCalculateEnd) - Date(DateCalculateBegin) ;

   PrintBottom(TotalDays, Summa, FactSum);
 
end;

private macro CarryPrintHead()              
   [           ###############################################]({Name_Bank});
   if ({OperDprt} != {OperDprtNode})
   [           ###############################################]({OperDprt}:l);
   end;
   [      ];
   if (OpKind == 4521)
   [       Распоряжение на проведение операции начисления процентов ];
   end;
   if (OpKind == 4522)
   [       Распоряжение на проведение операции оплаты процентов ];
   end;
   if (OpKind == 4523)
   [       Распоряжение на проведение операции доначисления процентов ];
   end;
   if (OpKind == 4524)
   [       Распоряжение на проведение операции реклассификации актива процентов ];
   end;
   if (OpKind == 4525)
   [       Распоряжение на проведение операции выноса на просрочку процентов ];
   end;
   [   ];
   [  Дата начала расчета:    ##########](Date(DateCalculateBegin):c);
   [  Дата окончания расчета: ##########](Date(DateCalculateEnd):c);
   [  Процентный договор:     #### ####](ContractBoffice,ContractNumber);
   [  Лицевой счет:           ####################](ContractAccount);
   [  Дата расчета:         ##########](Date({curdate}):c);
   [   ];
   [┌──────┬─────────────────────────────┬────────┬─────────┬─────────────────────────────┬──────────┬─────────────┐];
   [│ №№   │         Счёт дебета         │ Валюта │  Сумма  │        Счёт кредита         │  Валюта  │   Сумма     │];
   [│      │                             │ дебета │  дебета │                             │  кредита │  кредита    │];
end;

private macro PrintLineCarryRep (Document, first)
   if (first)
   [├──────┼─────────────────────────────┼────────┼─────────┼─────────────────────────────┼──────────┼─────────────┤];
   else
   [├──────┼─────────────────────────────┬────────┬─────────┬─────────────────────────────┬──────────┬─────────────┤];
   end;
   [│######│#############################│########│#########│#############################│##########│#############│]
   (Document.Numb_Document:c, Document.Account_Payer:c, ПолучитьКодФинИн(Document.Code_Currency):c, Document.Sum:c, Document.Account_Receiver:c, ПолучитьКодФинИн(Document.Code_Currency):c, Document.Sum:c );
   [│      ├─────────────────────────────┴────────┴─────────┴─────────────────────────────┴──────────┴─────────────┤];
   [│      │#######################################################################################################│](Document.Ground:w);
end;

private macro CarryPrintBottom()
   [└──────┴───────────────────────────────────────────────────────────────────────────────────────────────────────┘];
   [   ];
   [  ################# ]("Подписи: ");
   [  Операционист:     #### #########](OperNum,OperName);
end;

private macro PrintLinesCarry()
   var  Data, RS, cmd, DocumentID, iAppKind, ApplicationKey, first,  
   iAppKindStr:string ;

   cmd = RSDCommand( " select T_ID_OPERATION from doproper_dbt, dprccntopr_dbt " +
        " where dprccntopr_dbt.T_DOCID = ? and TO_NUMBER (doproper_dbt.T_DOCUMENTID) = dprccntopr_dbt.T_DOCID " + 
   " and doproper_dbt.T_KIND_OPERATION = ? ") ; 
   cmd.addParam( "", RSDBP_IN, DocID );
   cmd.addParam( "", RSDBP_IN, OpKind );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
   OperId = RS.T_ID_OPERATION;
   else
   [├──────┼─────────────────────────────┴────────┴─────────┴─────────────────────────────┴──────────┴─────────────┤];    
     return;
   end;
   
   cmd = RSDCommand( " select doc.t_documentid from doprdocs_dbt doc, doproper_dbt oper where oper.T_ID_OPERATION = ? " + 
       " and doc.T_DOCKIND = 1 " +
       " and doc.T_ID_OPERATION = oper.T_ID_OPERATION ") ; 
   cmd.addParam( "", RSDBP_IN, OperId );
   cmd.execute();

   RS = TRsbDataSet(cmd);
   first = true;
   while ( RS.movenext() )
       DocumentID = RS.t_documentid;
       iAppKindStr = SubStr(DocumentID,1,5);
       ApplicationKey = SubStr(DocumentID,6);
       iAppKind = Int(iAppKindStr);
  if( CB_GetDocument(Document, iAppKind, ApplicationKey) == 0 )
            PrintLineCarryRep(Document,first);
       end;
       first = false;
   end;
end;

private macro MpcPumpFieldsForCarryHead()
   var  Data, RS, cmd;
   
   OperNum = {oper};
   OperName = {Name_Oper};
   cmd = RSDCommand( " select  t_backoffice, t_number, t_account, t.t_begindate, t.t_enddate, t_operdate " + 
     " from dprccontract_dbt y, dprccntopr_dbt t " + 
     " where y.t_contractid = t.T_CONTRACTID and t.t_docid = ? and t_operkind = ? ") ; 
   cmd.addParam( "", RSDBP_IN, DocID );
   cmd.addParam( "", RSDBP_IN, OpKind );

   cmd.execute();

   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      ContractBoffice = RS.backoffice;
      ContractNumber = RS.number;
      ContractAccount = RS.account;
      DateCalculateBegin = RS.begindate;
      DateCalculateEnd = RS.enddate;
      OperDate = RS.operdate;
   end;


end;

macro MpcCarryGenReport( DocIDLocal, OperKindLocal )
DocID = DocIDLocal;
OpKind = OperKindLocal;
MpcPumpFieldsForCarryHead();
PumpBO(ContractBoffice);
CarryPrintHead();
PrintLinesCarry();
CarryPrintBottom();
end;

// для отладки

// MpcCarryGenReport(26,4522);
/* 
var  Data, RS, cmd;
cmd = RSDCommand( "select * from  dprccontract_dbt where t_contractid = 8 ") ;
cmd.execute();
RS = TRsbDataSet(cmd);
RS.movenext(); 

MpcPrognosisGenReport( RS, 1, "17.06.2007", "30.06.2008", "X" );
*/

private macro PrintHead()
   [   Протокол выполнения процедуры ежедневного расчета процентов ];


   [ Дата операции:    ##########](Date(OperDate):c);
   [ Операционист:    #### #########](OperNum,OperName);
   [ Дата начала расчета:    ##########   Дата окончания расчета: ##########](Date(DateCalculateBegin):c, Date(DateCalculateEnd):c);
   [ Филиал:           ###################################### ]({OperDprt});   
 
   [ Вид счетов:       ##################](gTypeOfAccounts);
   [ Код валюты:       #### ############################ ](gFininstrCode, gFininstrName);
   [ Маска лицевых счетов: ####################### ](gAccountMask);
   [ Клиент:           ###################################### ](gClientName);
   [ Бэк-офис:         ############] (gbackoffice);
   [ Номер договора:      c   ######  по ######  ](gNumberMin, gNumberMax);
   [ Группа условий расчета:  ######  ###################### ] (gGrCalc, gGrCalcName);
   [ Условие расчета:         ######  ###################### ] (gCalcID, gCalcName);
   [ Процентная ставка:       ######  ###################### ] (gRateID, gRateName);
   [ Пользовательский тип:    #######################](gUserType);
   [ Дата начала договора:    от ##########   до: ##########](Date(gBeginDateMin):c, Date(gBeginDateMax):c);
   [------------------------------------------------------------------------------------------------------------------];


   [  ];
   [           ###############################################]({Name_Bank});
   if ({OperDprt} != {OperDprtNode})
   [           ###############################################]({OperDprt}:l);
   end;
   [      ];
   if (Schedkind == 1)
   [                      Прогноз расчета процентов ];
   end;
   if (Schedkind == 2)
   [                      Прогноз начисления процентов ];
   end;
   if (Schedkind == 3)
   [                      Прогноз оплаты процентов ];
   end;
   [   ];
   [  Процентный договор:     #### ####](ContractBoffice,ContractNumber);
   [  Лицевой счет:           ####################](ContractAccount);
   [  Дата расчета:         ##########](Date({curdate}):c);
   [   ];
   [┌────────────────┬───────────────┬───────┬───────────┬────────┬───────────┬─────────────┬────────────┐];
   [│ Начальная дата │ Конечная дата │ Число │ Остаток   │ Ставка │ Сумма     │ Факт. дата  │ Факт. сумма│];
   [│                │               │ дней  │           │ в год  │ процентов │ операции    │ процентов  │];
end;

macro MpcDailyCalcReport(oper, CalcDateBegin, CalcDateEnd, PartyIDFil, TypeOfAccounts, FininstrFIID, AccountMask, PartyIDClient, backoffice, NumberMin, NumberMax, GrCalc, CalcID, RateID, UserType, BeginDateMin, BeginDateMax)
  goper = oper; 
  gCalcDateBegin = CalcDateBegin; 
  gCalcDateEnd = CalcDateEnd; 
  gPartyIDFil = PartyIDFil; 
  gTypeOfAccounts = TypeOfAccounts; 
  gFininstrFIID = FininstrFIID; 
  gAccountMask = AccountMask; 
  gPartyIDClient = PartyIDClient; 
  gbackoffice = backoffice; 
  gNumberMin = NumberMin; 
  gNumberMax = NumberMax; 
  gGrCalc = GrCalc; 
  gCalcID = CalcID; 
  gRateID = RateID; 
  gUserType = UserType; 
  gBeginDateMin = BeginDateMin; 
  gBeginDateMax = BeginDateMax;
       OperDate ={curdate};
      //  PumpNames();
  PrintHead();

end;