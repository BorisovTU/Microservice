/*-------------------------------------------------------------------------
          €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank v6.0.020
                 Copyright (c) R-Style Software Lab

  ˆ¬ï ä ©«         : mpcrpbs.mac

  ¨¡«¨®â¥ª        : 

  Ž¯¨á ­¨¥         : 

  à®£à ¬¬¨áâ      : „ãàï£¨­ ….€. (DEA)

  ‘®§¤ ­           : 22.05.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter,  globals, FIInter;
	  
var   ContractID,
      ContractBoffice,
      Boffice,
      ContractNumber,
      ContractAccount,
      goper, 
      gMode,
      gProcDate,	
      gPartyIDFil, 
      gDepName,
      gDepID,
      gTypeOfAccounts, 
      gFininstrFIID,
      gFininstrName, 
      gFininstrCode,
      gAccountMask, 
      gPartyIDClient, 
      gClientName,
      gbackoffice, 
      gNumberMin, 
      gNumberMax, 
      gGrCalc, 
      gGrCalcName,
      gGrCalcNumber,
      gCalcID, 
      gCalcName,
      gCalcNumber,
      gRateID, 
      gRateName,
      gRateNumber,
      gUserType, 
      gBeginDateMin, 
      gBeginDateMax;

RECORD contract( prccontract );

/* ------------------------------- */

private macro PumpDepName()
   var cmd, RS;
   if (gDepID == -1)
      gDepName = "® ¢á¥¬ ä¨«¨ « ¬";     
   else
      cmd = RSDCommand( "select par.t_shortname from dparty_dbt par, ddp_dep_dbt dep " +
                         "where par.t_partyid = dep.t_partyid and dep.t_code =  ? " ) ; 
      cmd.addParam( "", RSDBP_IN, gDepID);
      cmd.execute();
      RS = TRsbDataSet(cmd);
      if (RS.movenext() )
         gDepName = Rs.shortname;
      end;
   end;
end;

private macro PumpDepID()
   var cmd, RS;
   if (gPartyIDFil >= 0)           
      cmd = RSDCommand( "select t_code from ddp_dep_dbt where t_PartyID =  ? " ) ; 
      cmd.addParam( "", RSDBP_IN, gPartyIDFil);
      cmd.execute();
      
      RS = TRsbDataSet(cmd);
      if (RS.movenext() )
         gDepID = Rs.code;
      else
         gDepID = 0;
      end;
      
   else
      gDepID = 0;
   end;
end;


private macro PumpClientName()
   var cmd, RS;
   cmd = RSDCommand( " select t_shortname from dparty_dbt where t_PartyID =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gPartyIDClient);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gClientName = Rs.shortname;
   else
      gClientName = "";
   end;
end;

private macro PumpBO(BO)
   var cmd, RS;
   cmd = RSDCommand( " select t_code from dllvalues_dbt where t_list = 1118 and t_element = ? " ) ; 
   cmd.addParam( "", RSDBP_IN, BO );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      ContractBoffice = Rs.code;
   else
      ContractBoffice = "";
   end;
end;

private macro PumpNames()
   var fininstr,  cmd, RS;
   PumpDepName();
   PumpClientName();
   fininstr = TRecHandler("fininstr.dbt");
   if (®«ãç¨âì”¨­ˆ­( gFininstrFIID, fininstr ) == 0)
   	gFininstrName = fininstr.rec.Name; 
   	gFininstrCode = fininstr.rec.FI_Code;
   end;

   cmd = RSDCommand( " select t_number, t_shortname from dprcgrcalc_dbt where t_groupcalcid =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gGrCalc);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gGrCalcName = Rs.shortname;
      gGrCalcNumber = Rs.number;
   else
      gGrCalcName = "";
      gGrCalcNumber = 0;
   end;

   cmd = RSDCommand( " select t_number, t_shortname from dprccalc_dbt where t_calcid =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gCalcID);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gCalcName = Rs.shortname;
      gCalcNumber = Rs.number;
   else
      gCalcName = "";
      gCalcNumber = 0 ;
   end;

   cmd = RSDCommand( " select t_number, t_shortname from dprcrate_dbt where t_rateid =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gRateID);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gRateName = Rs.shortname;
      gRateNumber = Rs.number;
   else
      gRateName = "";
      gRateNumber = 0;
   end;
   PumpBO(gbackoffice);
end;

private macro PrintMainSubHead()
   if (gMode == 3)
   [   à®â®ª®« ã¤ «¥­¨ï ¬ áá®¢®© ®¯¥à æ¨¨ " ç¨á«¥­¨¥ ¯à®æ¥­â®¢" ];
   end;
   if (gMode == 4)
   [   à®â®ª®« ã¤ «¥­¨ï ¬ áá®¢®© ®¯¥à æ¨¨ "Ž¯« â  ¯à®æ¥­â®¢" ];
   end;
   [ ];
   [ „ â  ®¯¥à æ¨¨:    ##########](Date({curdate}):c);
   [ Ž¯¥à æ¨®­¨áâ:    #### #########]({oper}, {Name_Oper});
   if (gMode == 3)
   [ „ â  ­ ç¨á«¥­¨ï:  ########## ](Date(gProcDate):c) ;
   end;
   if (gMode == 4)
   [ „ â  ®¯« âë:  ########## ](Date(gProcDate):c) ;
   end;
   [ ”¨«¨ «:           ###################################### ](gDepName);   
   [ ];

end;

private macro PrintMainHead()

   PrintMainSubHead();
 
   [ ‚¨¤ áç¥â®¢:       ##################](gTypeOfAccounts);
   [ Š®¤ ¢ «îâë:       #### ############################ ](gFininstrCode, gFininstrName);
   [ Œ áª  «¨æ¥¢ëå áç¥â®¢: ####################### ](gAccountMask);
   [ Š«¨¥­â:           ###################################### ](gClientName);
   [ íª-®ä¨á:         ############] (ContractBoffice);
   [ ®¬¥à ¤®£®¢®à :      c   ######  ¯® ######  ](gNumberMin, gNumberMax);
   [ ƒàã¯¯  ãá«®¢¨© à áç¥â :  ######  ###################### ] (gGrCalcNumber, gGrCalcName);
   [ “á«®¢¨¥ à áç¥â :         ######  ###################### ] (gCalcNumber, gCalcName);
   [ à®æ¥­â­ ï áâ ¢ª :       ######  ###################### ] (gRateNumber, gRateName);
   [ ®«ì§®¢ â¥«ìáª¨© â¨¯:    #######################](gUserType);
   if (gBeginDateMin == NULL)
	[ „ â  ­ ç «  ¤®£®¢®à :    ®â 00.00.0000  ¤®: ##########](Date(gBeginDateMax):c);
   else
       [ „ â  ­ ç «  ¤®£®¢®à :    ®â ##########   ¤®: ##########](Date(gBeginDateMin):c, Date(gBeginDateMax):c);
   end;
   [---------------------------------------------------------------------------------------------------------];
end;                         

private macro PrintLine(RS);
   var Boffice;
   Boffice = RS.backoffice;
   ContractNumber = RS.number;
   PumpBO(Boffice);
   ContractAccount = RS.account;
   gPartyIDClient = RS.client;  
   PumpClientName();
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [³#############################³#########################³######### ###################³]
        (ContractAccount:c, gClientName:c, ContractBoffice:c, ContractNumber:l  ); 
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]

end;

private macro PrintSubHead() 
   [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
   [³        ‹¨æ¥¢®© áç¥â         ³        Š«¨¥­â           ³ ®¬¥à ¯à®æ¥­â­®£® ¤®£®¢®à   ³];
end;

private macro PrintErrorLine(ErrMsg)
  var i = 0;
  array StringArray;

  if((ErrMsg != "") AND (ErrMsg != NULL))

    StrSplit( StrSubst(ErrMsg, "|", " " ), StringArray, 70);

    while ( StrLen(StringArray(i) ) > 0)
                 [³ ##################################################################################  ³] ( StringArray(i) );
                 i = i + 1;
    end;  

  end;
end;

private macro PrintDetailLine(ContrID)
   var  RS, cmd, state; 

   cmd = RSDCommand( "select t_state, t_coment from dprcsrvacc_tmp where t_contractid = ? ") ;
   cmd.addParam( "", RSDBP_IN, ContrID );
   cmd.execute();
   RS = TRsbDataSet(cmd);

   if (RS.movenext())
      if (gMode == 3)
         state = RS.state;
         if (state == -3)
         	[³ “¤ «¥­¨¥ ®¯¥à æ¨¨ ­ ç¨á«¥­¨ï ¯à®¨§¢¥¤¥­®.                                           ³];
         else
         	[³ Žè¨¡ª  ã¤ «¥­¨ï ®¯¥à æ¨¨ ­ ç¨á«¥­¨ï.                                                ³];
                PrintErrorLine(RS.coment);
         end;
      end;
      if (gMode == 4)
         state = RS.state;
         if (state == -3)
         	[³ “¤ «¥­¨¥ ®¯¥à æ¨¨ ®¯« âë ¯à®¨§¢¥¤¥­®.                                               ³];
         else
		[³ Žè¨¡ª  ã¤ «¥­¨ï ®¯¥à æ¨¨ ®¯« âë.                                                    ³];
                PrintErrorLine(RS.coment);
         end;
      end;
   end;
   [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
END;


private macro ShowRep(ContrID) 

   var  RS, cmd;

   cmd = RSDCommand( "select t_backoffice, t_number, t_account, t_client from  dprccontract_dbt where t_contractid = ? ") ;
   cmd.addParam( "", RSDBP_IN, ContrID );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext())
       PrintSubHead();
       PrintLine(RS);
       PrintDetailLine(ContrID);
   end;
end;

private macro ShowReportForFilial() 
   var count = 0, RS, cmd;
   cmd = RSDCommand ("select t_contractid from dprcsrvacc_tmp where t_contractid is not NULL and t_contractid > 0 and t_department =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gDepID);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   while( RS.movenext())
      ShowRep(RS.contractid);
      count = count + 1;
   end;
   if (count == 0)
      [ ¥â ¯à®æ¥­âëå ¤®£®¢®à®¢, ã¤®¢«¥â¢®àïîé¨å ãá«®¢¨ï¬ § ¯ãáª  ];
      [ ];
   end;
end;



/*****************************************************************************
                    Ž¡é¨¥ ä-¨ ¤«ï ¯¥ç â¨ ®âç¥â  ®âª â  á¥à¢. ®¯¥à æ¨¨ 
******************************************************************************/

macro MpcBackStepSrvReport (oper, ProcDate, Mode, PartyIDFil, TypeOfAccounts, FininstrFIID, AccountMask, PartyIDClient, backoffice, NumberMin, NumberMax, GrCalc, CalcID, RateID, UserType, BeginDateMin, BeginDateMax)

   var  RS, cmd;

   	goper = oper; 
	gProcDate = ProcDate; 
	gMode = Mode;
	gPartyIDFil = PartyIDFil; 
	gTypeOfAccounts = TypeOfAccounts; 
	gFininstrFIID = FininstrFIID; 
	gAccountMask = AccountMask; 
	gPartyIDClient = PartyIDClient; 
	gbackoffice = backoffice; 
	gNumberMin = NumberMin; 
	gNumberMax = NumberMax; 
	gGrCalc = GrCalc; 
	gCalcID = CalcID; 
	gRateID = RateID; 
	gUserType = UserType; 
	gBeginDateMin = BeginDateMin; 
	gBeginDateMax = BeginDateMax;

   if (gPartyIDFil > 0)
      PumpDepID();
   else
      gDepID = -1;
   end;
   
	PumpNames();
   PrintMainHead();

       if (gPartyIDFil > 0)
          //PumpDepID();
          ShowReportForFilial();
       else         
          cmd = RSDCommand ("select distinct t_department from dprcsrvacc_tmp where t_department is not NULL and t_department > 0 ");
          cmd.execute();
          RS = TRsbDataSet(cmd);
          while( RS.movenext())
             gDepID = RS.code;
             PumpDepName();
             [ ];
             [ ”¨«¨ «:           ###################################### ](gDepName);         
             [ ];
             ShowReportForFilial();
          end;
       end;

end;
END;

