 /*
 $Name: wcl_pt_access.mac
 $Module: Главная книга
 $Description: Макрос панели субъектов - старый
 */

import rsbdataset;
import rsd;
import "wcl_pt_classes.mac";
import "globals.mac";
import PTInter;
import BankInter;
//import rcw;
//import CTInter;

///////////////////////////////////////////////////////////
// Преобразовать объект фильтра к SQL выражению
///////////////////////////////////////////////////////////
MACRO FilterToSQL(Filter)
   var query = "";

   if (ValType(Filter) == V_UNDEF)
      return "";
   end;

   if ((ValType(Filter.Name) != V_UNDEF) and (strlen(Filter.Name) > 0))
      query = query + " AND LOWER(t.T_NAME) LIKE LOWER('%" + Filter.Name + "%') ";
   end;

   if ((ValType(Filter.Id) != V_UNDEF) and (Filter.Id > 0))
      query = query + " AND t.T_PARTYID LIKE ('%" + string(Filter.Id) + "%') ";
   end;

   if ((ValType(Filter.Code) != V_UNDEF) and (strlen(Filter.Code) > 0))
      query = query + " AND LOWER(PARTCODE.T_CODE) LIKE LOWER('%" + Filter.Code + "%') ";
   end;

   return query;
end;

// ///////////////////////////////////////////////////////////
// // получить картинку-изображение клиента в HEX-строке
// ///////////////////////////////////////////////////////////
// MACRO GetPartyImage(ObjectType:integer, ObjectID:integer, ImageType:integer):TWsImage

   // var p:TWsImage;
   // if ((ValType(ImageType) == V_UNDEF) or (ImageType <= 0))
      // // по умолчанию считаем, что нужно фото субъекта
      // p.ImageType = 2;
   // else
      // p.ImageType = ImageType;
   // end;


   // var query = "select i.*, RSB_PRDCLIENT.BlobToHex(T_FMTBLOBDATA_XXXX) as HexData from dimage_dbt i,dimgdata_dbt d where I.T_IMAGEID = D.T_IMAGEID and d.t_objecttype = " + string(ObjectType) + " and D.T_IMAGETYPE = " + 
		// p.ImageType + " and d.t_objectid = " + string(ObjectID) + " and d.T_CLOSEDATE = TO_DATE ('01010001', 'DDMMYYYY') ORDER BY D.T_IMAGEID desc ";
    
    // println(query);

   // var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   // if( ds.MoveNext() )
      // p.HexData = ds.HexData;
   // else
      // return null;
   // end;

   // return p;
// END;

macro GetPartyRowNumWithFilter(partyid, ConstFilter, UserFilter, listkind, codekind, partykindcollection_str):INTEGER
   var result:INTEGER;

  file lst("partylst.dbt");
  
  if(listkind == NULL)
    listkind = 1;
  end;
  
  lst.Listkind = listkind;
  
  var stat = GetEQ( lst );
  if( stat )

 var query = "select RN from ( select ROWNUM \"RN\", T_PARTYID from ( " +
"SELECT T.T_PARTYID, (select partcode.t_code from dpartcode_dbt partcode where partcode.t_codekind = "+ string(codekind) +
  " and partcode.t_partyid = t.t_partyid and rownum = 1) as T_CODE " + string(GetPartySQLStr(lst));

  query = query + FilterToSQL(ConstFilter) + FilterToSQL(UserFilter);
  

   query = query + " ORDER BY T_CODE, T_NAME)) where T_PARTYID = " + string(partyid);
   
  if(partykindcollection_str != "")

    query = query + " AND T_PARTYID IN " +
                    " (SELECT PO.T_PARTYID " +
                    " FROM DPARTYOWN_DBT PO " +
                    " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection_str) + " )) "
                                   
  end;    
   
     println(query);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      result = ds.RN;
   end;
   
   end;

   return result;
   
END;


///////////////////////////////////////////////////////////
// Получить общее количество субъектов (для паджинации)
///////////////////////////////////////////////////////////
MACRO GetPartyCountWithFilter(ConstFilter, UserFilter, listkind, partykindcollection_str):INTEGER
   var result:INTEGER;
   //var query = "SELECT COUNT(t_partyid) C FROM dparty_dbt;";
   // var query = 
// "select count(*) c from ( " +
// "SELECT   T.T_PARTYID            " +
// "  FROM DPARTY_DBT T                " +
// "  LEFT JOIN DPARTCODE_DBT PARTCODE " +
// "                                 ON T.T_PARTYID = PARTCODE.T_PARTYID AND PARTCODE.T_CODEKIND = 1 " +
// "WHERE 1 = 1 ";

  file lst("partylst.dbt");
  
  if(listkind == NULL)
    listkind = 1;
  end;
  
  lst.Listkind = listkind;
  
  var stat = GetEQ( lst );
  if( stat )

 var query = "select count(*) c from ( " +
"SELECT   T.T_PARTYID " + string(GetPartySQLStr(lst));

/*if ((ValType(NameCond) != V_UNDEF) and (strlen(NameCond) > 0))
   query = query + " AND LOWER(t.T_NAME) LIKE LOWER('%" + NameCond + "%') ";
end;

if ((ValType(INNCond) != V_UNDEF) and (strlen(INNCond) > 0))
   query = query + " AND LOWER(INN.T_CODE) LIKE LOWER('%" + INNCond + "%') ";
end;*/
  query = query + FilterToSQL(ConstFilter) + FilterToSQL(UserFilter);
  
  if(partykindcollection_str != "")

    query = query + " AND T.T_PARTYID IN " +
                    " (SELECT PO.T_PARTYID " +
                    " FROM DPARTYOWN_DBT PO " +
                    " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection_str) + " )) "
                                   
  end;   

   query = query + ")";
   
println(query);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      result = ds.C;
   end;

   end;

   return result;
   
END;

// macro GetPartyList_New(InputParam : TInputParamGetPartyList):TOutputParamGetPartyList

  // if(InputParam == V_UNDEF)
    // RunError("Не задан параметр сервиса");
  // end;
  
  // var result = TOutputParamGetPartyList();
  
  // var query = 
  
// "SELECT O.T_CODE AS CODE," +
// "       P.T_PARTYID AS PARTYID," +
// "       P.T_NAME AS FULLNAME," +
// "       P.T_LEGALFORM AS LEGALFORM," +
// "       N.T_NAME AS NAME" +
// "  FROM DPARTY_DBT P" +
// "       LEFT OUTER JOIN DOBJCODE_DBT O" +
// "          ON     P.T_PARTYID = O.T_OBJECTID" +
// "             AND O.T_OBJECTTYPE = 3" +
// "             AND O.T_CODEKIND = " + string(InputParam.CodeKind) +
// "       LEFT OUTER JOIN DPARTYNAME_DBT N" +
// "          ON N.T_PARTYID = P.T_PARTYID AND N.T_NAMETYPEID = " + string(InputParam.NameKind) +
// " WHERE LOWER (O.T_CODE) LIKE LOWER ('%" + subCode + "%') AND ROWNUM < " + string(listLen);  

// end;

MACRO GetOurBank():integer
  return {OurBank};
END;

MACRO GetListTitle(listkind):string
  var result;
  var stat;
  
  file lst("partylst.dbt");
  
  if(listkind == NULL)
    listkind = 1;
  end;
  
  lst.Listkind = listkind;
  
  stat = GetEQ( lst );
  
  if(stat)
    result = lst.ListTitle
  else
    result = "";
  end;
   
  return result;
END;

///////////////////////////////////////////////////////////
// Получить список пользователей постранично
// PageSize - размер страницы
// PageNum - номер страницы НАЧИНАЯ С 0 !!!
// NameCond, INNCond - like-условия фильтра
///////////////////////////////////////////////////////////

MACRO GetPartyListWithFilter(PageSize:INTEGER, PageNum:INTEGER, ConstFilter, UserFilter, listkind, namekind, codekind, partykindcollection_str):TArray
  var stat : bool;
   var result = TArray();
   var i;
   var p;

  // var lst = Tbfile ("partylst", "R", 0);
  file lst("partylst.dbt");
  
  if(listkind == NULL)
    listkind = 1;
  end;
  
  if(namekind == NULL)
    namekind = 1;
  end;
  
  lst.Listkind = listkind;
  
  stat = GetEQ( lst );
  if( stat )
   
   // var query = "SELECT AA.*, (select count(t_partyid) from dprdclient_dbt where t_partyid = AA.T_PARTYID) as PRODUCT_COUNT FROM (SELECT ROWNUM \"RN\", T.*, 'parent_name' \"PARENT_NAME\", 'inn_code' \"INN\", PARTCODE.T_CODE" +
// "			FROM DPARTY_DBT T " +
// "         LEFT OUTER JOIN DPARTCODE_DBT PARTCODE  " +
// "                         ON T.T_PARTYID = PARTCODE.T_PARTYID AND PARTCODE.T_CODEKIND = 1" +
// "              WHERE 1 = 1 ";

  var query = "SELECT * FROM (SELECT ROWNUM \"RN\", AA.*, (select count(t_partyid) from dprdclient_dbt where t_partyid = AA.T_PARTYID) as PRODUCT_COUNT FROM" +
  " (SELECT T.*, (select ptn.t_name from dpartyname_dbt ptn where ptn.t_nametypeid = "+ string(namekind) +
  " and ptn.t_partyid = t.t_partyid and rownum = 1) as name_," +
  " (select partcode.t_code from dpartcode_dbt partcode where partcode.t_codekind = "+ string(codekind) +
  " and partcode.t_partyid = t.t_partyid and rownum = 1) as T_CODE," +
  " (SELECT TO_DATE (TO_CHAR (MAX (TO_DATE (TO_CHAR (t_sysdate, 'DDMMYYYY') || TO_CHAR (t_systime, 'HH24MISS'), 'DDMMYYYYHH24MISS')), 'DDMMYYYY'), 'DDMMYYYY') " +
  "  FROM dptprmhist_dbt WHERE T_PARTYID = t.t_partyid) as d," +
  " (SELECT TO_DATE ('01010001' || TO_CHAR (MAX (TO_DATE (TO_CHAR (t_sysdate, 'DDMMYYYY') || TO_CHAR (t_systime, 'HH24MISS'), 'DDMMYYYYHH24MISS')), 'HH24MISS'), 'DDMMYYYYHH24MISS') " +
  "  FROM dptprmhist_dbt WHERE T_PARTYID = t.t_partyid) as t," +
  " 'parent_name' \"PARENT_NAME\", 'inn_code' \"INN\" " + string(GetPartySQLStr(lst));

/*if ((ValType(NameCond) != V_UNDEF) and (strlen(NameCond) > 0))
   query = query + " AND LOWER(t.T_NAME) LIKE LOWER('%" + NameCond + "%') ";
end;

if ((ValType(INNCond) != V_UNDEF) and (strlen(INNCond) > 0))
   query = query + " AND LOWER(INN.T_CODE) LIKE LOWER('%" + INNCond + "%') ";
end;*/

  query = query + FilterToSQL(ConstFilter) + FilterToSQL(UserFilter);


query = query + "ORDER BY T_CODE, T_NAME) AA ";

if(partykindcollection_str != "")

  query = query + " WHERE AA.T_PARTYID IN " +
                  " (SELECT PO.T_PARTYID " +
                  " FROM DPARTYOWN_DBT PO " +
                  " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection_str) + " )) "
                                 
end;                                 

query = query + " ) ";

if(PageSize != 0)
  query = query + "WHERE RN BETWEEN " + string(PageSize*(PageNum) + 1)  + " and " + string(PageSize*(PageNum + 1));
end;

// query = query + " ORDER BY T_CODE, T_NAME";

println(query);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   while (ds.MoveNext())
      p = TWsGenericParty();
      p.Code = ds.CODE;
      p.Name = ds.NAME;
      p.Name_ = ds.NAME_;
      p.ShortName = ds.SHORTNAME;
      p.ID = ds.PartyID;
      p.LegalForm = ds.LEGALFORM;
      // p.Changed = ds.CHANGE_DATETIME;
      p.LastChangedDate = ds.d;
      p.LastChangedTime = ds.t;
      p.ProductCount = ds.PRODUCT_COUNT;
                
      result.value(result.Size) = p;
   end;

 end;

   return result;

END;

///////////////////////////////////////////////////////////
// Получить сквозной номер субъекта (для нахождения в скроллинге)
// NameCond, INNCond - like-условия фильтра
///////////////////////////////////////////////////////////
MACRO GetPartyRowNumber(partyId:integer, NameCond, INNCond):Integer
   var result = -1; // сразу не найдено
   var i;
   var p;
   var query = "SELECT * FROM (SELECT ROWNUM \"RN\", T.*, MT.T_NAME \"PARENT_NAME\", INN.T_CODE \"INN\", PARTCODE.T_CODE " +
"			FROM DPARTY_DBT T " +
"         LEFT OUTER JOIN DPARTY_DBT MT " +
"                         ON MT.T_PARTYID = T.T_MAINPARTYID " +
"         LEFT OUTER JOIN DPARTCODE_DBT PARTCODE  " +
"                         ON T.T_PARTYID = PARTCODE.T_PARTYID AND PARTCODE.T_CODEKIND = 1  " +
"         LEFT OUTER JOIN DPARTCODE_DBT INN " +
"                         ON T.T_PARTYID = INN.T_PARTYID AND INN.T_CODEKIND = 16 WHERE 1 = 1 ";


if ((ValType(NameCond) != V_UNDEF) and (strlen(NameCond) > 0))
   query = query + " AND LOWER(t.T_NAME) LIKE LOWER('%" + NameCond + "%') ";
end;

if ((ValType(INNCond) != V_UNDEF) and (strlen(INNCond) > 0))
   query = query + " AND LOWER(INN.T_CODE) LIKE LOWER('%" + INNCond + "%') ";
end;


query = query + "ORDER BY 2)  " +
"WHERE T_PARTYID = " + string(partyId);

query = query + " ORDER BY 1";

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      result = ds.RN;
   end;

   return result;
END;

///////////////////////////////////////////////////////////
// Получить иерархический список стран
///////////////////////////////////////////////////////////
MACRO GetCountryList(filter):STRING
   var result:STRING;
   var query;

   if ((ValType(filter) != V_UNDEF) and (strlen(filter) > 0))
      query = 
"SELECT 1, XMLELEMENT(country_list,  " +
" (SELECT DBMS_XMLGEN.GETXMLTYPE    " +
" (DBMS_XMLGEN.NEWCONTEXTFROMHIERARCHY     " +
" ('select level,               " +
" XMLElement(        " +
" country,            " +
" XMLElement(PARENTCOUNTRYID, T_PARENTCOUNTRYID),       " +
" XMLElement(COUNTRYID, T_COUNTRYID),      " +
" XMLElement(FULLNAME, case when T_FULLNAME = chr(1) then NULL else T_FULLNAME end),  " +
" XMLElement(NAME, case when T_NAME = chr(1) then NULL else T_NAME end),  " +
" XMLElement(CodeCyr3, case when T_CodeCyr3 = chr(1) then NULL else T_CodeCyr3 end),  " +
" XMLElement(CodeLat3, case when T_CodeLat3 = chr(1) then NULL else T_CodeLat3 end),  " +
" XMLElement(CodeLat2, case when T_CodeLat2 = chr(1) then NULL else T_CodeLat2 end),  " +
" XMLElement(CodeNum, case when T_CodeNum3 = chr(1) then NULL else T_CodeNum3 end),  " +
" XMLElement(OffshoreGroup, T_OffshoreGroup))  " +
" from   " +
" (SELECT c.*, o.T_OffshoreGroup FROM DCOUNTRY_DBT c  LEFT OUTER JOIN DOFSHHIST_DBT O ON O.T_COUNTRYID = C.T_COUNTRYID " +
" where LOWER(C.T_NAME) LIKE LOWER(''%" + filter + "%'') or C.T_COUNTRYID in (SELECT c.T_ParentCountryID FROM DCOUNTRY_DBT c " +
" where LOWER(C.T_NAME) LIKE LOWER(''%" + filter + "%'')) " +
" )   " +
" START WITH T_PARENTCOUNTRYID = 0  " +
" CONNECT BY PRIOR T_COUNTRYID = T_PARENTCOUNTRYID ORDER SIBLINGS BY T_NAME'))  " +
" FROM DUAL)).GETCLOBVAL() XMLDOC  " +
" FROM DUAL";

   else
      query = 
"SELECT 1, XMLELEMENT(country_list,  " +
" (SELECT DBMS_XMLGEN.GETXMLTYPE    " +
" (DBMS_XMLGEN.NEWCONTEXTFROMHIERARCHY     " +
" ('select level,               " +
" XMLElement(        " +
" country,            " +
" XMLElement(PARENTCOUNTRYID, T_PARENTCOUNTRYID),       " +
" XMLElement(COUNTRYID, T_COUNTRYID),      " +
" XMLElement(FULLNAME, case when T_FULLNAME = chr(1) then NULL else T_FULLNAME end),  " +
" XMLElement(NAME, case when T_NAME = chr(1) then NULL else T_NAME end),  " +
" XMLElement(CodeCyr3, case when T_CodeCyr3 = chr(1) then NULL else T_CodeCyr3 end),  " +
" XMLElement(CodeLat3, case when T_CodeLat3 = chr(1) then NULL else T_CodeLat3 end),  " +
" XMLElement(CodeLat2, case when T_CodeLat2 = chr(1) then NULL else T_CodeLat2 end),  " +
" XMLElement(CodeNum, case when T_CodeNum3 = chr(1) then NULL else T_CodeNum3 end),  " +
" XMLElement(OffshoreGroup, T_OffshoreGroup))  " +
" from   " +
" (SELECT c.*, o.T_OffshoreGroup FROM DCOUNTRY_DBT c LEFT OUTER JOIN DOFSHHIST_DBT O ON O.T_COUNTRYID = C.T_COUNTRYID )   " +
" START WITH T_PARENTCOUNTRYID = 0  " +
" CONNECT BY PRIOR T_COUNTRYID = T_PARENTCOUNTRYID ORDER SIBLINGS BY T_NAME'))  " +
" FROM DUAL)).GETCLOBVAL() XMLDOC  " +
" FROM DUAL";
   end;

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      result = ds.XMLDOC;
   end;

   return result;
   
END;


   VAR OffshoreGroup:integer;


///////////////////////////////////////////////////////////
// Получить информацию о стране (для панели) по
// латинскому коду
///////////////////////////////////////////////////////////
MACRO GetCountryByCodeLat3(Lat3:STRING):TWsCountry
   var p;

   var query = "select * from dcountry_dbt where T_CODELAT3 = '" + string(Lat3) + "'";

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      p = TWsCountry();
      p.CountryId = ds.COUNTRYID;
      p.ParentId = ds.T_PARENTCOUNTRYID;
      p.Name = ds.NAME;
      p.FullName = ds.FULLNAME;
      p.CodeCyr3 = ds.CODECYR3;
      p.CodeLat3 = ds.CODELAT3;
      p.CodeLat2 = ds.CODELAT2;
      p.CodeNum = ds.CODENUM3;
   else
      return null;
   end;


   return p;
END;

///////////////////////////////////////////////////////////
// Получить информацию о стране субъекта по идентификатору
// субъекта
///////////////////////////////////////////////////////////
MACRO GetCountryByPartyId(partyId:INTEGER):TWsCountry
   var p;

   var query = "select c.* from dcountry_dbt c where T_CODELAT3 = (select t_nrcountry from dparty_dbt where t_partyid = " + 
               string(partyId) + " and LENGTH(t_nrcountry) > 1)";

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      p = TWsCountry();
      p.CountryId = ds.COUNTRYID;
      p.ParentId = ds.T_PARENTCOUNTRYID;
      p.Name = ds.NAME;
      p.FullName = ds.FULLNAME;
      p.CodeCyr3 = ds.CODECYR3;
      p.CodeLat3 = ds.CODELAT3;
      p.CodeLat2 = ds.CODELAT2;
      p.CodeNum = ds.CODENUM3;
   else
      return null;
   end;


   return p;
END;


MACRO GetPartyIDCList(PartyId:INTEGER):TWsNaturalParty
   var p;
   var result = TArray();
   var query = "select * from dpersnidc_dbt i, dpaprkind_dbt k where I.T_PAPERKIND = K.T_PAPERKIND and I.T_PERSONID = " + string(PartyId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   while (ds.MoveNext())
      p = TWsIDC();
      p.PersonId = ds.PERSONID;
      p.KindId = ds.PAPERKIND;
      p.Kind = ds.NAME;
      p.Series = ds.PAPERSERIES;
      p.Number = ds.PAPERNUMBER;
      p.Issuer = ds.PAPERISSUER;
      p.IssueDate = ds.PAPERISSUEDDATE;
      p.IssuerCode = ds.PAPERISSUERCODE;
      if (ds.ISMAIN == "X")
         p.IsMain = true;
      else
         p.IsMain = false;
      end;

      result.value(result.Size) = p;
   end;


   return result;
END;

///////////////////////////////////////////////////////////
// Получить информацию о субъекте вместе с кодом (краткую)
// заданного вида
///////////////////////////////////////////////////////////
private MACRO GetPartyByID(PartyId:INTEGER, CodeKind:INTEGER, NameKind:INTEGER ):TWsGenericParty
   var p = TWsGenericParty();
   
   if(NameKind == NULL)
    NameKind = 1;
   end;
   
   var query = 
"SELECT O.T_CODE AS CODE," +
"       P.T_PARTYID AS PARTYID," +
"       P.T_NAME AS FULLNAME," +
"       P.T_LEGALFORM AS LEGALFORM," +
"       N.T_NAME AS NAME," +
"       P.T_SHORTNAME AS SHORTNAME," +
"       P.T_CHANGE_DATE AS CHANGE_DATE" +
"  FROM DPARTY_DBT P" +
"       LEFT OUTER JOIN DOBJCODE_DBT O" +
"          ON     P.T_PARTYID = O.T_OBJECTID" +
"             AND O.T_OBJECTTYPE = 3" +
"             AND O.T_CODEKIND = " + string(CodeKind) +
"       LEFT OUTER JOIN DPARTYNAME_DBT N" +
"          ON N.T_PARTYID = P.T_PARTYID AND N.T_NAMETYPEID = " + string(NameKind) +
" WHERE P.T_PARTYID = " + string(PartyId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      
      p.Code = ds.CODE;
      p.ID        = ds.PARTYID;
      p.Name      = ds.FULLNAME;
      p.LegalForm = ds.LEGALFORM;
      p.Name_     = ds.NAME;
      p.ShortName = ds.SHORTNAME;
      p.Changed = ds.CHANGE_DATE;
      
   end;

   return p;

END;

///////////////////////////////////////////////////////////
// Получить код субъекта с датой
///////////////////////////////////////////////////////////
MACRO GetPartyCode(PartyId:INTEGER, CodeKind:INTEGER, code:@STRING, codedate:@DATE)
   var result; 
   var query = "select code.t_code as c, CODE.T_BANKDATE as d from dobjcode_dbt code where code.t_objecttype = 3 AND code.t_codekind = " + string(CodeKind) + " and code.t_objectid = " + string(PartyId);
//" AND RSBSESSIONDATA.cURDATE() >=  t_bankdate " +
//" AND RSBSESSIONDATA.CURDATE() < DECODE(t_bankclosedate, TO_DATE('01.01.0001', 'DD.MM.YYYY'), TO_DATE('31.12.9999', 'DD.MM.YYYY'), t_bankclosedate)" ;
   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   if (ds.MoveNext())
      code = ds.C;

      if (ValType(codedate) != V_UNDEF)
         codedate = ds.d;
      end;
   end;

   return result;
   
END;

///////////////////////////////////////////////////////////
// Получить данные о регистрационном документе субъекта
///////////////////////////////////////////////////////////
MACRO GetPartyRegDoc(PartyId:INTEGER, CodeKind:INTEGER, RegOrgCodeKind:INTEGER, DocKind:INTEGER):TWsRegDocument
   var p = TWsRegDocument();
   var orgId;
   var query = "select o.*, kd.* from dobjrgdoc_dbt o, dobjkdoc_dbt kd where O.T_REGDOCKIND = KD.T_REGDOCKIND and  o.t_objecttype = 3 and o.t_objectid = " 
               + string(PartyId) + "and O.T_REGDOCKIND = " + string(DocKind);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      p.DocNumber = ds.NUMBER;
      orgId = ds.REGPARTYID;
      p.Party = GetPartyByID(orgId, RegOrgCodeKind);
      p.RegPlace = ds.REGPLACE;
      
      // ЋЉЏЋ (­г ў®в ­г¦Ґ­ § зҐ¬-в®!!)
      //GetPartyCode(PartyId, CodeKind, @p.OKPO, @p.OKPODATE);
      GetPartyCode(PartyId, CodeKind, @p.Code, @p.CodeDate);

   end;

   return p;
END;

///////////////////////////////////////////////////////////
// Получить информацию о физлице (для панели)
///////////////////////////////////////////////////////////
MACRO GetNaturalPartyByID(PartyId:INTEGER):TWsNaturalParty
   var p;

   var query = "select pt.*, ps.*, (select count(t_partyid) from dprdclient_dbt where t_partyid = pt.T_PARTYID) as PRODUCT_COUNT from dparty_dbt pt,dpersn_dbt ps where PT.T_PARTYID = PS.T_PERSONID AND t_partyid = " + string(PartyId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      p = TWsNaturalParty();
      // TWsGenericParty

      GetPartyCode(PartyId, 1, @p.Code);

      p.Name = ds.NAME;
      p.ShortName = ds.SHORTNAME;
      p.ID = ds.PartyID;
      p.LegalForm = ds.LEGALFORM;
      p.Changed = ds.T_CHANGE_DATE;

      // TWsNaturalParty
      p.Name1 = ds.NAME1;
      p.Name2 = ds.NAME2;
      p.Name3 = ds.NAME3;
      if (ds.IsMale == "X")
         p.IsMale = true;
      else
         p.IsMale = false;
      end;

      p.Birth = ds.BORN;
      p.Death = ds.DEATH;
      p.NRCountry = ds.NRCOUNTRY;
      if (ds.NOTRESIDENT == "X")
         p.IsNR = true;
      else
         p.IsNR = false;
      end;

      p.Offshore = ds.OFSHOREZONE;
      p.ProductCount = ds.PRODUCT_COUNT;

      // место рождения
      p.PlaceOfBirth = ds.BIRSPLASE;
      p.CityOfBirth = ds.PLACEBORN;
      p.RegionOfBirth = ds.REGIONBORN;
      p.RaionOfBirth = ds.RAIONBORN;

      p.Work = ds.PLACEWORK;

      // объектые поля
      // список удостоверений личности
      p.ListIDC = GetPartyIDCList(p.ID);

      // объект -страна
      p.Country = GetCountryByCodeLat3(p.NRCountry);

      // Регистрация в налоговом органе
      p.TaxAuthorityReg = GetPartyRegDoc(p.ID, 16 ,28, 14);

      // Государственная регистрация
      p.PrivateEntrepreneur = GetPartyRegDoc(p.ID, 27 ,1, 4);

      // p.PartyImage = GetPartyImage(p.ID);


   else
      RunError("‘гЎкҐЄв ­Ґ ­ ©¤Ґ­.");
   end;


   return p;
END;

///////////////////////////////////////////////////////////
// Получить список наименований субъекта
///////////////////////////////////////////////////////////
MACRO GetPartyNameList(PartyID:integer):TArray
   var query = "select PartyName.*, PartyKName.*, PartyKName.T_NAME as KindName from DPARTYNAME_DBT PartyName, DPARTYKNAME_DBT PartyKName where PARTYKNAME.T_NAMETYPEID = PARTYNAME.T_NAMETYPEID  "
" and PARTYNAME.T_PARTYID = " + string(PartyID);

   var p;
   var result = TArray();

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   while (ds.MoveNext())
      p = TWsPartyName();

   p.Number = ds.PartyNameId;  /* Номер */
   p.KindName = ds.KindName; /* Вид наименования */
   p.Name = ds.Name;     /* Наименование */
   p.Amount = ds.FREQ;  /* Частота */

      if (ds.ISJURIC == "X")
         p.IsLegal = true;
      else
         p.IsLegal = false;
      end;

      if (ds.T_ISPHYSIC == "X")
         p.IsNormal = true;
      else
         p.IsNormal = false;
      end;

      result.value(result.Size) = p;
   end;


   return result;
END;

///////////////////////////////////////////////////////////
// Получить информацию о юрлице (для панели)
///////////////////////////////////////////////////////////
MACRO GetLegalPartyByID(PartyId:INTEGER):TWsLegalParty
   var p;

   var query = "select p.*, (select count(t_partyid) from dprdclient_dbt where t_partyid = p.T_PARTYID) as PRODUCT_COUNT from dparty_dbt p where t_partyid = " + string(PartyId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      p = TWsLegalParty();
      // TWsGenericParty
      GetPartyCode(PartyId, 1, @p.Code);
      p.Name = ds.NAME;
      p.ShortName = ds.SHORTNAME;
      p.ID = ds.PartyID;
      p.LegalForm = ds.LEGALFORM;
      p.Changed = ds.T_CHANGE_DATE;

      // TWsLegalParty
      p.NRCountry = ds.NRCOUNTRY;
      if (ds.NOTRESIDENT == "X")
         p.IsNR = true;
      else
         p.IsNR = false;
      end;

      p.Offshore = ds.OFSHOREZONE;
      p.ProductCount = ds.PRODUCT_COUNT;

      // объектые поля
      // объект -страна
      p.Country = GetCountryByCodeLat3(p.NRCountry);

      p.NamesList = GetPartyNameList(PartyID);

      // вышестоящая организация
      p.ParentParty =  GetPartyByID(ds.T_SUPERIOR, 1);

      // Регистрация в налоговом органе
      p.TaxAuthorityReg = GetPartyRegDoc(p.ID, 16 ,28, 14);

      // Государственная регистрация
      p.StateRegistration = GetPartyRegDoc(p.ID, 27 ,1, 4);
   end;

   return p;
END;

MACRO FindPARTYOWN( PartyID:integer, PartyKind:integer ):integer
   var Select, Pt;

   Select = RSDCommand("Select * From dpartyown_dbt Where t_PartyKind = ? and t_PartyID = ?");

   Select.addParam("", RSDBP_IN, PartyKind);
   Select.addParam("", RSDBP_IN, PartyID);
   Select.execute();

   Pt = TRsbDataSet(Select);

   if( Pt.MoveNext() )
      return 0;
   end;

   return 1;
END;


///////////////////////////////////////////////////////////
// Получить список продуктов клиента
///////////////////////////////////////////////////////////
MACRO GetProductList(PartyID:integer):STRING
   var result:STRING = "";
   var query, ds;

   if( PartyID > 0 )
      query = " SELECT 1, XMLELEMENT( product_list, " +
              "                    (SELECT DBMS_XMLGEN.getxmltype( DBMS_XMLGEN.newcontextfromhierarchy( 'select t_level, XMLElement(product, " + 
              " XMLElement(\"id\",                 t_id), " +
              " XMLElement(\"parentid\",           t_parentid), " +
              " XMLElement(\"prodobjname\",        case when t_prodobjname = chr(1) then NULL else t_prodobjname end), " +
              " XMLElement(\"number\",             case when t_number = chr(1) then NULL else t_number end), " +
              " XMLElement(\"name\",               case when t_name = chr(1) then NULL else t_name end), " +
              " XMLElement(\"begindate\",          t_begindate), " +
              " XMLElement(\"enddate\",            t_enddate), " +
              " XMLElement(\"partyname\",          case when t_partyname = chr(1) then NULL else t_partyname end), " +
              " XMLElement(\"partyid\",            t_partyid) " +
              "                                                                                                                    ) " +
              "                                                                                            from table(rsb_prdclient.f_prdclient(" + string(PartyID) + ")) '" +
              "                                                                                       ) " +
              "                                                  ) " +
              "                       FROM DUAL " + 
              "                    ) " +
              "                  ).GETCLOBVAL() xmldoc " +
              " FROM DUAL;";
     
      ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
      if (ds.MoveNext())
         result = ds.XMLDOC;
      end;
   end;

   return result;
END;

///////////////////////////////////////////////////////////
// Получить информацию о продукте (для панели)
///////////////////////////////////////////////////////////
MACRO GetProductInfo(ProductId:INTEGER):TWsPrdProduct
   var p:TWsPrdProduct;
   var query = " SELECT  (SELECT t.t_name FROM dprdkind_dbt t WHERE t.t_productkindid = (SELECT t1.t_productkindid FROM dprdproduct_dbt t1 WHERE t1.t_productid = p.t_productid)) t_prodobjname " +
               "        ,(SELECT t.t_name FROM dprdproduct_dbt t WHERE t.t_productid = p.t_parentclientproductid) t_parentname " +
               "        ,(SELECT t.t_name FROM dprdproduct_dbt t WHERE t.t_productid = p.t_productid) t_name " +
               "        ,p.t_begindate t_begindate " +
               "        ,p.t_enddate t_enddate " +
               "        ,(SELECT t.t_code FROM ddp_dep_dbt t WHERE t.t_code = p.t_branch) t_branchcode " +
               "        ,(SELECT t.t_name FROM dparty_dbt t WHERE t.t_partyid = (SELECT t1.t_partyid FROM ddp_dep_dbt t1 WHERE t1.t_code = p.t_branch)) t_partyname " +
               "        ,(SELECT t.t_name FROM dservkind_dbt t WHERE t.t_servisekind =  (SELECT t1.t_servicekind FROM dprdproduct_dbt t1 WHERE t1.t_productid = p.t_productid)) t_servicekind " +
               "        ,(SELECT t.t_number FROM dsfcontr_dbt t WHERE t.t_id = p.t_sfcontrid) t_sfcontrnumber " +
               "        ,(SELECT t.t_dateconc FROM dsfcontr_dbt t WHERE t.t_id = p.t_sfcontrid) t_sfcontrdateconc " +
               "        ,(SELECT t.t_name FROM dllvalues_dbt t WHERE t.t_list = 1050 and  t.t_element =  (SELECT t1.t_productdockindid FROM dprdproduct_dbt t1 WHERE t1.t_productid = p.t_productid)) t_productdockindname " +
               "        ,p.t_docnumber t_docnumber " +
               "        ,p.t_docdate t_docdate " +
               "   FROM dprdclient_dbt p " +
               "  WHERE p.t_clientproductid = " + string(ProductId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if( ds.MoveNext() )
      p.Product            = ds.prodobjname;
      p.ParentName         = ds.parentname;
      p.Name               = ds.name;
      p.BeginDate          = ds.begindate;
      p.EndDate            = ds.enddate;
      p.BranchCode         = ds.branchcode;
      p.Branch             = ds.partyname;
      p.ServiceKind        = ds.servicekind;
      p.SfContrNumber      = ds.sfcontrnumber;
      p.SfContrDateConc    = ds.sfcontrdateconc;
      p.ProductDocKindName = ds.productdockindname;
      p.DocNumber          = ds.docnumber;
      p.DocDate            = ds.docdate;
   end;

   return p;
END;

///////////////////////////////////////////////////////////
// Получить информацию о объекте (для панели)
///////////////////////////////////////////////////////////
MACRO GetObjectInfo(ObjectId:INTEGER):TWsPrdObject
   var p:TWsPrdObject;
   var query = " SELECT  (SELECT t.t_code FROM dpartcode_dbt t WHERE t.t_partyid = t1.t_partyid AND t.t_codekind = 1) t_code " +
               "        ,(SELECT t.t_name FROM dparty_dbt t WHERE t.t_partyid = t1.t_partyid) t_fullname " +
               "        ,t2.t_name " +
               "        ,(SELECT t.t_name FROM dobjects_dbt t WHERE t.t_objecttype = t3.t_objecttype) t_parentobjtypename " +
               "        ,(SELECT t.t_name FROM dprdkind_obj_dbt t WHERE t.t_productkindid = t4.t_productkindid AND t.t_objectproductkindid = t4.t_objectproductkindid) t_parentobjname " +
               "        ,t4.t_objectnumber t_parentobjectnumber " +
               "        ,(SELECT t.t_name FROM dobjects_dbt t WHERE t.t_objecttype = t1.t_objecttype) t_objtypename " +
               "        ,(SELECT t.t_name FROM dprdkind_obj_dbt t WHERE t.t_productkindid = p.t_productkindid AND t.t_objectproductkindid = p.t_objectproductkindid) t_objname " +
               "        ,p.t_objectnumber t_objectnumber " +
               "        ,p.t_begindate t_begindate " +
               "        ,p.t_enddate t_enddate " +
               "        ,p.t_objecttype t_objecttype " +
               "        ,p.t_objectid t_objectid " +
               "   FROM dprdclientobj_dbt p " +
               "   FULL JOIN dprdclient_dbt t1 ON (t1.t_clientproductid = p.t_clientproductid) " +
               "   FULL JOIN dprdproduct_dbt t2 ON (t2.t_productid = t1.t_productid) " +
               "   FULL JOIN dprdclientobj_dbt t4 ON (t4.t_clntprodobjid = p.t_parentid) " +
               "   FULL JOIN dprdclient_dbt t3 ON (t3.t_clientproductid = t4.t_clientproductid) " +
               " WHERE p.t_clntprodobjid = " + string(ObjectId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if( ds.MoveNext() )
      p.Name               = ds.name;
      p.ParentObjTypeName  = ds.parentobjtypename;
      p.ParentObjName      = ds.parentobjname;
      p.ParentObjectNumber = ds.parentobjectnumber;
      p.ObjTypeName        = ds.objtypename;
      p.ObjName            = ds.objname;
      p.ObjectNumber       = ds.objectnumber;
      p.BeginDate          = ds.begindate;
      p.EndDate            = ds.enddate;
      //CT_ObjGetDateValidity(ds.objecttype, ds.objectid, p.ActBeginDate, p.ActEndDate);
   end;

   return p;
END;

///////////////////////////////////////////////////////////
// чтение данных физлица (для панели веб-интерфейса)
///////////////////////////////////////////////////////////
MACRO GetPersnById(id:integer)
   var WsPersn = TWsPersnFull;
   var Party = RsbParty(id);

  WsPersn.LastName = Party.LastName;
  WsPersn.FirstName = Party.FirstName;
  WsPersn.Patronymic = Party.Patronymic;

  WsPersn.BirthDate  = Party.BirthDate;
  WsPersn.BirthPlace = Party.BirthPlace;

  if (Party.IsMale == true)
     WsPersn.Male = 1;
  else 
     WsPersn.Male = 0;
  end;

  WsPersn.Ethnos = Party.Ethnos;
  WsPersn.IsEmployer = Party.IsEmployer;
  WsPersn.LicenceNumber = Party.LicenceNumber;
  WsPersn.LicenceDate = Party.LicenceDate;
  WsPersn.RegionBorn = Party.RegionBorn;
  WsPersn.RaionBorn = Party.RaionBorn;
  WsPersn.PlaceBorn = Party.PlaceBorn;
  WsPersn.PlaceWork = Party.PlaceWork;
  WsPersn.DeathDate = Party.DeathDate;
  WsPersn.IsGroupAuthor = Party.IsGroupAuthor;
  WsPersn.IsGroupwil = Party.IsGroupwil;
  WsPersn.PensCardNumber = Party.PensCardNumber;
  WsPersn.PensCardDate = Party.PensCardDate;
  WsPersn.IsNotResident = Party.IsNotResident;
  WsPersn.NRCountry = Party.NRCountry;
  WsPersn.IsOffshoreResident = Party.IsOffshoreResident;
  WsPersn.SectionPeople = Party.SectionPeople;
  WsPersn.IsLiterate = Party.IsLiterate;
  WsPersn.IsSpecialAccess = Party.IsSpecialAccess;
  WsPersn.IsInterRelated = Party.IsInterRelated;
  WsPersn.TaxInstitution = Party.TaxInstitution;
  WsPersn.TaxRegDate = Party.TaxRegDate;
  WsPersn.SetAccSearchAlg = Party.SetAccSearchAlg;

   return WsPersn;
END;

///////////////////////////////////////////////////////////
// чтение данных юрлица (для панели веб-интерфейса)
///////////////////////////////////////////////////////////
MACRO GetInstById(id:integer)
   var WsInst = TWsInst;
   var Party = RsbParty(id);



  WsInst.ShortName = Party.ShortName; 
  WsInst.FullName = Party.FullName; 
  WsInst.IsNotResident = Party.IsNotResident;
  WsInst.NRCountry = Party.NRCountry;
  // WsInst.IsOffshoreResident = Party.IsOffshoreResident; // непонятно, куда делся
  WsInst.TaxInstitution = Party.TaxInstitution;
  WsInst.TaxRegDate = Party.TaxRegDate;
  WsInst.SetAccSearchAlg = Party.SetAccSearchAlg;
  WsInst.SuperiorID = Party.SuperiorID;

  return WsInst;
END;
      

/* ‘®§¤ ­ЁҐ ®ЎкҐЄв  TWsPtOffice зҐаҐ§ Ї а ¬Ґвал */
macro CreateCountryFromParam
(
  CountryId, 
  ParentId, 
  Name, 
  FullName, 
  CodeCyr3, 
  CodeLat3, 
  CodeLat2,
  CodeNum,
  OffshoreGroup,
  Children
)
  var countryItem : TWsCountry;

  countryItem.CountryId     = CountryId;
  countryItem.ParentId      = ParentId;
  countryItem.Name          = Name;
  countryItem.FullName      = FullName;
  countryItem.CodeCyr3      = CodeCyr3;
  countryItem.CodeLat3      = CodeLat3;
  countryItem.CodeLat2      = CodeLat2;
  countryItem.CodeNum       = CodeNum;
  countryItem.OffshoreGroup = OffshoreGroup;
  countryItem.Children      = Children;

  return countryItem;
end;

macro GetCountryByCountryId(countryId : integer)
  var p;

   var query = "select * from dcountry_dbt where t_countryid = " + string(countryId);

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
                        
   if (ds.MoveNext())
      p = TWsCountry();
      p.CountryId = ds.COUNTRYID;
      p.ParentId = ds.T_PARENTCOUNTRYID;
      p.Name = ds.NAME;
      p.FullName = ds.FULLNAME;
      p.CodeCyr3 = ds.CODECYR3;
      p.CodeLat3 = ds.CODELAT3;
      p.CodeLat2 = ds.CODELAT2;
      p.CodeNum = ds.CODENUM3;
   else
      return null;
   end;

   return p;
end;

/* ‘®§¤ ­ЁҐ ®ЎкҐЄв  TWsPtOffice б Ї®¤Є зЄ®© Name_Type Ё§ Ў §л */
macro CreateCountryFromAppServ(CodeLat3 : string, CountryId : integer)
  var countryItem : TWsCountry;

  if((ValType(CodeLat3) != V_UNDEF) AND (strlen(CodeLat3) > 0))
    return GetCountryByCodeLat3(CodeLat3);
  elif((ValType(CountryId) != V_UNDEF) AND (CountryId > 0))
    return GetCountryByCountryId(CountryId);
  else
    return NULL;
  end;
end;         
                            
//var o = GetPartyImage(9, 2);
//println(o.HexData);

// var ttt = GetPartyList(1, 1, NULL, NULL, 3, 1);
// println("123456");