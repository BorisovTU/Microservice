//-----------------------------------------------------------------------------
// Блок      : 26001 - "Исполнение сделки"
// Шаг       : 20    - "Исполнение сделки"
// Назначение: Макрос шага
// Описание  : Макрос шага
//-----------------------------------------------------------------------------

import PaymInter, InsCarryDoc, "oralib.mac", "likepy.mac";

var PaymentObj: RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
MACRO ExecuteStep( doc, paymDoc, KindDoc, ID_Operation, ID_Step )
  var pmlink = existsSQLselect(string("select 1 from dpmpaym_dbt pmpaym, dpmlink_dbt pmlink where ",
                                      " pmlink.t_InitialPayment = ? ",
                                  " and pmlink.t_LinkKind = ? ",
                                  " and pmlink.t_PurposePayment = pmpaym.t_PaymentID ",
                                  " and pmpaym.t_PaymStatus <> ?"),
                        makeArray(SQLParam("", PaymentObj.PaymentID),
                                  SQLParam("", PMLINK_KIND_DEALPAYMENT),
                                  SQLParam("", PM_FINISHED)));
  if (pmlink)
    msgbox("По сделке выгружены документы оплаты. Отвержение запрещено.");
    return 1;
  end;
  if(not InsertOprStatus(2601, 4 )) //Завершена
    msgbox("Ошибка при установке статуса платежа");
    return 1;
  end;
  return 0;
END;