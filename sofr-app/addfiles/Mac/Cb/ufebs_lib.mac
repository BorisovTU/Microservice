/*
 $Name: ufebs_lib.mac
 $Module: Ядро ГКБО 
 $Description: АРМ КБР
 */
 /*
  АРМ КБР
 */
import "globals.mac";
import BankInter;
import rcw;
import RSD;

private var Simulate = false;

private macro GetHashValue()
  var strHash = "";

  strHash = readNoteForObject( 92/*OBJTYPE_USER*/, string( {oper}:o:10 ), 1 );

  return strHash
end;


private macro CreateUfebsObject(interface, rsax : @variant)
    var ufebs;
    if (isStandAlone())  
        // Если двузвенка
        ufebs = ActiveX (interface);
    else
        // Если трехзвенка              
        rsax = CreateObject ("rsax","TRsAxServer","RsAxServer", isStandAlone());
        ufebs = rsax.CreateComObject (interface);
    end;
    return ufebs;
OnError
    RunError("", "Не удалось создать интерфейс " + interface);
end;

private macro TestsaveFile(filename, what)
    var stream = TStream(filename, "C");
    stream.write(what, V_STRING);
    stream.flush();
end;

private macro UFEBS_PutString(str)
    var tmp = "";
    EncodeBase64(str, tmp);
    return tmp;
end;

private macro UFEBS_GetString(str)
    var tmp = "";
    DecodeBase64(str, tmp);
    return tmp;
end;

// Функция формирования ЗК ЭС
macro UFEBS_makeZKES(
    inIds,        // Массив идентификаторов ЭС
    inXml,        // Массив ЭС
    Conditions,   // Условия исполнения (не обязательно)
    outIds,       // Массив идентификаторов обработанных ЭС
    outXml,       // Массив обработанных ЭС
    checkStat,    // Результат проверки ЭП (числовое представление)
    checkErrText, // Результат проверки ЭП (текстовое представление)
    err           // Код результата исполнения (текстовое представление)
)
//begin
    var stat = 0;
    var i = 0;
    if (Simulate)
        if (inIds.size > 2)
            while(i < inIds.size)
                if (i < 2)
                    checkStat[checkStat.size] = -2146435067;
                    checkErrText[checkErrText.size] = "Признак ошибки обработки ЭС в составе пакета ЭС";
                else
                    checkStat[checkStat.size] = 0;
                    checkErrText[checkErrText.size] = "";
                end;
                outIds[outIds.size] = inIds[i];
                outXml[outXml.size] = inXml[i];
                i = i + 1;
            end;
        else
            stat = -2146435067;
            SetParm(7, "Признак ошибки обработки ЭС в составе пакета ЭС");
        end;
        
        return stat;
    end;
    
    // **********************************************************************************
    var rsax;
    var obj = CreateUfebsObject("UfebsLib.UFEBSQuery", rsax);
    
    obj.useBase64 = true;
    obj.Conditions = UFEBS_PutString(Conditions);
    var hash = GetHashValue();
    obj.Hash = UFEBS_PutString(hash);

    while(i < inIds.size)
        var tmp = UFEBS_PutString(inIds[i]);
        obj.addDocument(tmp, UFEBS_PutString(inXml[i]));
        i = i + 1;
    end;

    var response = obj.makeZKES();
    stat = response.execState;
    SetParm(7, UFEBS_GetString(response.execStateText));
    while (response.next())
        var size = outIds.size;
        outIds[size] = UFEBS_GetString(response.docID);
        outXml[size] = UFEBS_GetString(response.document);
        checkStat[size] = response.stat;
        checkErrText[size] = UFEBS_GetString(response.statText);
    end;
    
    obj = NULL;
    rsax = NULL;
    
    return stat;
end;

// Функция проверки ЗК ЭС
macro UFEBS_checkZKES(
  inIds,         // Массив идентификаторов ЭС
  inXml,         // Массив ЭС
  Conditions,    // Условия исполнения (не обязательно)
  checkStat,     // Результат проверки ЭП (числовое представление)
  checkErrText,  // Результат проверки ЭП (текстовое представление)
  funcTime,      // Время подписания проверенной ЭП 
  certPublisher, // Идентифицирующие данные сертификата: издатель 
  certSerial,    // Идентифицирующие данные сертификата: серийный номер 
  certOwner,     // Идентифицирующие данные сертификата: имя владельца 
  err            // Код результата исполнения (текстовое представление)
)
//begin
    var stat = 0;
    var i = 0;
    
    if (Simulate)
        if (inIds.size > 2)
            while(i < inIds.size)
                if (i < 2)
                    checkStat[checkStat.size] = -2146435067;
                    checkErrText[checkErrText.size] = "Признак ошибки обработки ЭС в составе пакета ЭС";
                else
                    checkStat[checkStat.size] = 0;
                    checkErrText[checkErrText.size] = "";
                end;
                funcTime[funcTime.size] = time();
                certPublisher[certPublisher.size] = "certPublisher";
                certSerial[certSerial.size] = "certSerial";
                certOwner[certOwner.size] = "certOwner";
                i = i + 1;
            end;
        else
            stat = -2146435067;
            SetParm(9, "Признак ошибки обработки ЭС в составе пакета ЭС");
        end;
        
        return stat;
    end;
    
    // **********************************************************************************
    var rsax;
    var obj = CreateUfebsObject("UfebsLib.UFEBSQuery", rsax);
    
    obj.useBase64 = true;
    obj.Conditions = UFEBS_PutString(Conditions);
    var hash = GetHashValue();
    obj.Hash = UFEBS_PutString(hash);

    while(i < inIds.size)
        var tmp = UFEBS_PutString(inIds[i]);
        obj.addDocument(tmp, UFEBS_PutString(inXml[i]));
        i = i + 1;
    end;
    
    var response = obj.checkZKES();
    stat = response.execState;
    SetParm(9, UFEBS_GetString(response.execStateText));
    
    while (response.next())
        var size = checkStat.size;
        checkStat[size] = response.stat;
        checkErrText[size] = UFEBS_GetString(response.statText);
        funcTime[size] = UFEBS_GetString(response.funcTime);
        certPublisher[size] = UFEBS_GetString(response.certPublisher);
        certSerial[size] = UFEBS_GetString(response.certSerial);
        certOwner[size] = UFEBS_GetString(response.certOwner);
    end;

    obj = NULL;
    rsax = NULL;
    
    return stat;
end;

// Функция формирования ЗК пакета ЭС
macro UFEBS_makeZKPackES(
    inIds,       // Массив идентификаторов ЭС
    inXml,       // Массив ЭС
    Conditions,  // Условия исполнения (не обязательно)
    outIds,      // Массив идентификаторов обработанных ЭС
    outXml,      // Массив обработанных ЭС
    checkStat,   // Результат проверки ЭП (числовое представление)
    checkErrText,// Результат проверки ЭП (текстовое представление)
    err          // Код результата исполнения (текстовое представление)
)
//begin
    var stat = 0;
    var i = 0;
    
    if (Simulate)
        if (inIds.size > 2)
            while(i < inIds.size)
                if (i < 2)
                    checkStat[checkStat.size] = -2146435067;
                    checkErrText[checkErrText.size] = "Признак ошибки обработки ЭС в составе пакета ЭС";
                else
                    checkStat[checkStat.size] = 0;
                    checkErrText[checkErrText.size] = "";
                end;
                outIds[outIds.size] = inIds[i];
                outXml[outXml.size] = inXml[i];
                i = i + 1;
            end;
        else
            stat = -2146435067;
            SetParm(7, "Признак ошибки обработки ЭС в составе пакета ЭС");
        end;
        
        return stat;
    end;
    
    // **********************************************************************************
    var rsax;
    var obj = CreateUfebsObject("UfebsLib.UFEBSQuery", rsax);
    
    obj.useBase64 = true;
    obj.Conditions = UFEBS_PutString(Conditions);
    var hash = GetHashValue();
    obj.Hash = UFEBS_PutString(hash);

    while(i < inIds.size)
        var tmp = UFEBS_PutString(inIds[i]);
        obj.addDocument(tmp, UFEBS_PutString(inXml[i]));
        i = i + 1;
    end;

    var response = obj.makeZKPackES();
    stat = response.execState;
    SetParm(7, UFEBS_GetString(response.execStateText));
    while (response.next())
        var size = outIds.size;
        outIds[size] = UFEBS_GetString(response.docID);
        outXml[size] = UFEBS_GetString(response.document);
        checkStat[size] = response.stat;
        checkErrText[size] = UFEBS_GetString(response.statText);
    end;
    
    obj = NULL;
    rsax = NULL;
    
    return stat;
end;

// Функция проверки ЗК пакета ЭС
macro UFEBS_checkZKPackES(
    inIds,         // Массив идентификаторов ЭС
    inXml,         // Массив ЭС
    Conditions,    // Условия исполнения (не обязательно)
    checkStat,     // Результат проверки ЭП (числовое представление)
    checkErrText,  // Результат проверки ЭП (текстовое представление)
    funcTime,      // Время подписания проверенной ЭП 
    certPublisher, // Идентифицирующие данные сертификата: издатель 
    certSerial,    // Идентифицирующие данные сертификата: серийный номер 
    certOwner,     // Идентифицирующие данные сертификата: имя владельца 
    err            // Код результата исполнения (текстовое представление)
)
//begin
    var stat = 0;
    var i = 0;
    
    if (Simulate)
        if (inIds.size > 2)
            while(i < inIds.size)
                if (i < 2)
                    checkStat[checkStat.size] = -2146435067;
                    checkErrText[checkErrText.size] = "Признак ошибки обработки ЭС в составе пакета ЭС";
                else
                    checkStat[checkStat.size] = 0;
                    checkErrText[checkErrText.size] = "";
                end;
                funcTime[funcTime.size] = time();
                certPublisher[certPublisher.size] = "certPublisher";
                certSerial[certSerial.size] = "certSerial";
                certOwner[certOwner.size] = "certOwner";
                i = i + 1;
            end;
        else
            stat = -2146435067;
            SetParm(9, "Признак ошибки обработки ЭС в составе пакета ЭС");
        end;

        return stat;
    end;
    
    // **********************************************************************************
    var rsax;
    var obj = CreateUfebsObject("UfebsLib.UFEBSQuery", rsax);
 
    obj.useBase64 = true;
    obj.Conditions = UFEBS_PutString(Conditions);
    var hash = GetHashValue();
    obj.Hash = UFEBS_PutString(hash);

    while(i < inIds.size)
        var tmp = UFEBS_PutString(inIds[i]);
        obj.addDocument(tmp, UFEBS_PutString(inXml[i]));
        i = i + 1;
    end;
                       
    var response = obj.checkZKPackES();
    stat = response.execState;
    SetParm(9, UFEBS_GetString(response.execStateText));
    
    while (response.next())
        var size = checkStat.size;
        checkStat[size] = response.stat;
        checkErrText[size] = UFEBS_GetString(response.statText);
        funcTime[size] = UFEBS_GetString(response.funcTime);
        certPublisher[size] = UFEBS_GetString(response.certPublisher);
        certSerial[size] = UFEBS_GetString(response.certSerial);
        certOwner[size] = UFEBS_GetString(response.certOwner);
    end;

    obj = NULL;
    rsax = NULL;
    
    return stat;
end;

// Функция формирования КА
macro UFEBS_makeKA(
    inIds,         // Массив идентификаторов ЭС
    inXml,         // Массив ЭС
    Conditions,    // Условия исполнения (не обязательно)
    outKA,         // Массив оформленных конвертов КА
    checkStat,     // Результат проверки ЭП (числовое представление)
    checkErrText,  // Результат проверки ЭП (текстовое представление)
    err            // Код результата исполнения (текстовое представление)
)
//begin
    var stat = 0;
    var i = 0;
    
    if (Simulate)
        if (inIds.size > 2)
            while(i < inIds.size)
                if (i < 2)
                    checkStat[checkStat.size] = -2146435067;
                    checkErrText[checkErrText.size] = "Признак ошибки обработки ЭС в составе пакета ЭС";
                else
                    checkStat[checkStat.size] = 0;
                    checkErrText[checkErrText.size] = "";
                end;
                outKA[outKA.size] = inXml[i];
                i = i + 1;
            end;
        else
            stat = -2146435067;
            SetParm(6, "Признак ошибки обработки ЭС в составе пакета ЭС");
        end;

        return stat;
    end;
    
    // **********************************************************************************
    var rsax;
    var obj = CreateUfebsObject("UfebsLib.UFEBSQuery", rsax);
    
    obj.useBase64 = true;
    obj.Conditions = UFEBS_PutString(Conditions);
    var hash = GetHashValue();
    obj.Hash = UFEBS_PutString(hash);

    while(i < inIds.size)
        var tmp = UFEBS_PutString(inIds[i]);
        obj.addDocument(tmp, UFEBS_PutString(inXml[i]));
        i = i + 1;
    end;
    
    var response = obj.makeKA();
    stat = response.execState;
    SetParm(6, UFEBS_GetString(response.execStateText));
    
    while (response.next())
        var size = checkStat.size;
        checkStat[size] = response.stat;
        checkErrText[size] = UFEBS_GetString(response.statText);
        outKA[size] = UFEBS_GetString(response.document);
    end;

    obj = NULL;
    rsax = NULL;
    
    return stat;
end;

// Функция проверки КА
macro UFEBS_checkKA(
    inIds,         // Массив идентификаторов ЭС
    inKA,          // Массив оформленных конвертов КА
    checkStat,     // Результат проверки ЭП (числовое представление)
    checkErrText,  // Результат проверки ЭП (текстовое представление)
    funcTime,      // Время подписания проверенной ЭП 
    certPublisher, // Идентифицирующие данные сертификата: издатель 
    certSerial,    // Идентифицирующие данные сертификата: серийный номер 
    certOwner,     // Идентифицирующие данные сертификата: имя владельца 
    err            // Код результата исполнения (текстовое представление)
)
//begin
    var stat = 0;
    var i = 0;
    
    if (Simulate)
        if (inIds.size > 2)
            while(i < inIds.size)
                if (i < 2)
                    checkStat[checkStat.size] = -2146435067;
                    checkErrText[checkErrText.size] = "Признак ошибки обработки ЭС в составе пакета ЭС";
                else
                    checkStat[checkStat.size] = 0;
                    checkErrText[checkErrText.size] = "";
                end;
                funcTime[funcTime.size] = time();
                certPublisher[certPublisher.size] = "certPublisher";
                certSerial[certSerial.size] = "certSerial";
                certOwner[certOwner.size] = "certOwner";
                i = i + 1;
            end;
        else
            stat = -2146435067;
            SetParm(8, "Признак ошибки обработки ЭС в составе пакета ЭС");
        end;

        return stat;
    end;
    
    // **********************************************************************************
    var rsax;
    var obj = CreateUfebsObject("UfebsLib.UFEBSQuery", rsax);
    
    var hash = GetHashValue();
    obj.Hash = UFEBS_PutString(hash);


    obj.useBase64 = true;
    while(i < inIds.size)
        var tmp = UFEBS_PutString(inIds[i]);
        obj.addDocument(tmp, UFEBS_PutString(inKA[i]));
        i = i + 1;
    end;
    
    var response = obj.checkKA();
    stat = response.execState;
    SetParm(8, UFEBS_GetString(response.execStateText));
    
    while (response.next())
        var size = checkStat.size;
        checkStat[size] = response.stat;
        checkErrText[size] = UFEBS_GetString(response.statText);
        funcTime[size] = UFEBS_GetString(response.funcTime);
        certPublisher[size] = UFEBS_GetString(response.certPublisher);
        certSerial[size] = UFEBS_GetString(response.certSerial);
        certOwner[size] = UFEBS_GetString(response.certOwner);
    end;

    obj = NULL;
    rsax = NULL;
    
    return stat;
end;

macro UFEBS_KeyList(
    keyValue,
    owner,
    serialNumber,
    err
)
    var rsax;
    var ufebs = CreateUfebsObject("UfebsLib.UFEBSCore", rsax);
    var keylist = ufebs.keys();
    
    keylist.useBase64 = true;
    var stat = keylist.stat;
    SetParm(3, UFEBS_GetString(keylist.statText));
    
    if (stat == 0)
        while( keylist.next())
            var size = keyValue.size;
            keyValue[size] = UFEBS_GetString(keylist.keyValue);
            owner[size] = UFEBS_GetString(keylist.owner);
            serialNumber[size] = UFEBS_GetString(keylist.serialNumber);
        end;
    end;    
    ufebs = NULL;
    rsax = NULL;

    return stat;
end;


macro UFEBS_DicLoad(statText, pse, localstore, ldap, pincode, flag )
    var rsax;
    var stat = 0;

    var diclist = CreateUfebsObject("UfebsLib.UFEBSDictionaryList", rsax);

    diclist.useBase64 = true;

    var hash = GetHashValue();

    var result = diclist.load(UFEBS_PutString(pse), 
                              UFEBS_PutString(localstore), 
                              UFEBS_PutString(ldap), 
                              UFEBS_PutString(pincode), 
                              flag,
                              UFEBS_PutString(hash));

    if(not result)
      stat = diclist.stat; 
      statText = diclist.statText;
      SetParm(0, UFEBS_GetString(statText));
    end;

    diclist = NULL;
    rsax = NULL;

    return stat;
end;




macro UFEBS_DicUnload(statText, pse, localstore, ldap, pincode, flag )
    var rsax;
    var stat = 0;

    var diclist = CreateUfebsObject("UfebsLib.UFEBSDictionaryList", rsax);

    diclist.useBase64 = true;

    var result = diclist.unload(UFEBS_PutString(pse), 
                                UFEBS_PutString(localstore), 
                                UFEBS_PutString(ldap), 
                                UFEBS_PutString(pincode), 
                                flag);

    if(not result)
      stat = diclist.stat; 
      statText = diclist.statText;
      SetParm(0, UFEBS_GetString(statText));
    end;

    diclist = NULL;
    rsax = NULL;

    return stat;
end;


macro UFEBS_DicList(
   statText           // Код результата исполнения (текстовое представление)
)
    var rsax;

    var cmd : RsdCommand;
    var sqlstr;
    cmd = RsdCommand("DELETE FROM dufebsdic_tmp");
    cmd.execute();

    var diclist = CreateUfebsObject("UfebsLib.UFEBSDictionaryList", rsax);
    var stat = diclist.refresh();
    stat = diclist.stat;

    diclist.useBase64 = true;

    if(stat)
      SetParm(0, UFEBS_GetString(diclist.statText));
    end;

    var ufebsdicCache = RsbSQLInsert("ufebsdic.tmp");

    var isempty = true;
    if (stat == 0)
        var ufebsdic = TRecHandler("ufebsdic.tmp");
        while( diclist.next())

          ClearRecord( ufebsdic );
          ufebsdic.rec.localName       = UFEBS_GetString(diclist.localName ) ;
          ufebsdic.rec.pse             = UFEBS_GetString(diclist.pse       );
          ufebsdic.rec.localstore      = UFEBS_GetString(diclist.localstore);
          ufebsdic.rec.ldap            = UFEBS_GetString(diclist.ldap      );
          ufebsdic.rec.pincode         = UFEBS_GetString(diclist.pincode   );
          ufebsdic.rec.flag            = diclist.flag      ;
          if(diclist.isloading == true)
            ufebsdic.rec.isloading       = "X" ;
          else
            ufebsdic.rec.isloading       = "" ;
          end;


          ufebsdicCache.AddRecord( ufebsdic );
          isempty = false;
        end;
    end;    

    if(isempty == false)
      if(not ufebsdicCache.Insert())
        stat = 1;
      end;
    end;

    diclist = NULL;
    rsax = NULL;

    return stat;
end;
