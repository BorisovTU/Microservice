import rsd, cb_sql;

/*
 Копирование значений полей текущей записи Recordset'а по таблице
 в свойства объекта TRecHandler по одноименной таблице.
 Требование к полям Recordset'а:
   - имена полей Recordset'а должны совпадать с именами полей TRecHandler
     и иметь префикс "t_": значение поля Recordset'а с именем t_partyid
     в TRecHandler будет скопировано в поле partyid
*/
macro _CopyRecordsetToRecHandler(rs, rh)
  var ifld = 0;
  var nfld = FldNumber(rh);
  var val;
  var savedNullConv;

  if(IsEqClass("RsdRecordset", rs))
    savedNullConv = rs.Command.NullConversion;
    rs.Command.NullConversion = true;
  end;

  while(ifld < nfld)
    val = rs.value("t_" + FldName(rh, ifld));
    if(ValType(GenGetProp(rh.rec, FldName(rh, ifld))) == V_STRING)
      GenSetProp(rh.rec, FldName(rh, ifld), SQL_ConvTypeStr(val));
    elif(val != null)
      GenSetProp(rh.rec, FldName(rh, ifld), rs.value("t_" + FldName(rh, ifld), null, ValType(GenGetProp(rh.rec, FldName(rh, ifld)))));
    end;
    ifld = ifld + 1;
  end;

  if(IsEqClass("RsdRecordset", rs))
    rs.Command.NullConversion = savedNullConv;
  end;
end;

macro GetCodeKind( ObjectType )

  var cmd, rs;

  var codekindRec = TRecHandler("objkcode");
  var codekindArray = TArray;

  cmd = RsdCommand("select * from dobjkcode_dbt where t_objecttype = " + string(ObjectType));
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, codekindRec);

    var p = TRecHandler("objkcode");
    copy(p, codekindRec);

    codekindArray[codekindArray.size] = p.rec;

  end;

  return codekindArray;

end;