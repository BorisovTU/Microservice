/*
  $Name:         bb_cp.mac
  $Module:       ББ
  $Description:  Макрос скроллинга валютных платежей банка
*/
//-----------------------------------------------------------------------------
// Блок      : Вне блока
// Шаг       : Вне шага
// Назначение: Макрос скроллинга
// Описание  : Макрос скроллинга валютных платежей банка
//-----------------------------------------------------------------------------

import bbcpdoc;
import "cb_FillFactura.mac";


/* Установка подсказки для скролингов из макроса */

private const Hint_ByValueDate:string =
"/*+FIRST_ROWS LEADING(t bbcpord pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx11) USE_NL(t bbcpord pmprop pmrmprop oproper oprcurst)*/";

private const Hint_ByCloseDate:string =
"/*+FIRST_ROWS LEADING(t bbcpord pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx15) USE_NL(t bbcpord pmprop pmrmprop oproper oprcurst)*/";

private const Hint_ByStatus   :string =
"/*+FIRST_ROWS LEADING(t bbcpord pmprop pmrmprop oproper oprcurst) INDEX(t DPMPAYM_DBT_IDX16) INDEX(bbcpord DBBCPORD_DBT_IDX0) USE_NL(t bbcpord pmprop pmrmprop oproper oprcurst)*/";

private const Hint_ByStep     :string =
"/*+FIRST_ROWS LEADING(oprstep oproper t bbcpord pmprop pmrmprop oprcurst) INDEX(oprstep doprstep_dbt_idx10) INDEX(bbcpord dbbcpord_dbt_idx0) INDEX(t dpmpaym_dbt_idx0) USE_NL(oprstep oproper t bbcpord pmprop pmrmprop oprcurst)*/";

MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string
  /* Все, Закрытые */
  if( ( ScrolStates == PSSK_ALL ) or 
      ( ScrolStates == PSSK_CLOSED ) ) 

    var dtflt:PMScrolDateFltr = PMScrolDateFltr();

    if( dtflt.IsSet( DTFL_CLOSEDATE ) )
      return Hint_ByCloseDate;
    elif( dtflt.IsSet( DTFL_VALUEDATE ) )
      return Hint_ByValueDate;
    else
      return Hint_ByCloseDate;
    end;

  /* Отложенные, Открытые, Отвергнутые */
  elif( ( ScrolStates == PSSK_DEFER ) or 
        ( ScrolStates == PSSK_OPEN ) or 
        ( ScrolStates == PSSK_REJECTED_WORK ) )
    return Hint_ByStatus;
  /* Подготовленные к шагу */
  elif( ScrolStates == PSSK_STEP )
    return Hint_ByStep;
  end;

  return DefaultHint;

END;

macro Новый_Документ( )

  if( r_pmpaym.DocKind == BBANK_CPORDER )
    return BB_CurPayOrderNewDoc();
  end;

  msgbox("Неизвестный вид документа");
  return 1;
end;

macro  Проверить_Документ( Режим )
  
  if( r_pmpaym.DocKind == BBANK_CPORDER )
    // KS 19.08.2019 При вводе платежа (исходящий, введён вручную) проверять заполненность поля "Пачка", в случае нулевого значения предупреждать, что такой платёж не будет выгружен в БИС;
    if( ( r_credit.corschem != -1 ) and ( r_pmpaym.Origin == PAYMENT_OR_MANUAL ) and ( r_pmpaym.NumberPack==0 ) )
      if ( RsbGetTrue( False,True,"Номер пачки не задан!|Платеж не будет выгружен в БИС|Продолжить?")==False )
         return 1;
      end;
    end;

    return BB_CurPayOrderCheckDoc( Режим );
  end;

  msgbox("Неизвестный вид документа");
  return 1;

end;

macro    Функция_Пользователя( Режим:integer  )

  // Режим == 4 (UFN_SCROL_FMASS) Вызов пользоветельской макро функции до группового выполнения
  // Режим == 6 (UFN_SCROL_LMASS) Вызов пользоветельской макро функции после группового выполнения
  // Для данных режимов буфера не заполняются
  if ( (Режим == 4) OR (Режим == 6))
    return 0;
  end;

 /*
 Возможные значения Режим:
  UFN_PANEL_INPUT(1) - функция вызвана из панели ввода объекта;
  UFN_PANEL_EDIT(2) - функция вызвана из панели корректировки объекта;
  UFN_SCROL(3) - функция вызвана из панели скролинга, единичный вызов, любая корректировка объекта запрещена;
  UFN_SCROL_FMASS(4) - функция вызвана из панели скролинга, работа по нескольким записям, вызов до начала обработки, любая корректировка объекта запрещена;
 
// Пример работы: 
 if( Режим == UFN_SCROL )
   return UPDTPAGE;    // Обновить страницу записей и область скролинга
   //return UPDTREC;     // Обновить текущую запись, загрузив из файла
 end;
 */
  
  if( r_pmpaym.DocKind == BBANK_CPORDER )
    return BB_CurPayOrderUserFunc( Режим );
  end;

  msgbox("Неизвестный вид документа");
  return 1;

end;
