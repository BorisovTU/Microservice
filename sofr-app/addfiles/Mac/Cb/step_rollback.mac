import SFInter, DealsInter, BankInter, CTInter, FIInter, PTInter, 
      globals, cb_sql, oralib, likepy, dldlngfun, /*lim_utils,*/ dlquery, dlcontrfunc,
      sp_car, "or_rep_h.mac";

private macro GetMAINSQL()
  var sql = 
   "SELECT sfd.t_id AS SfDefID, step.* "
   +" FROM dsfdef_dbt sfd, "
   +"      dsfcomiss_dbt sfcomiss, "
   +"      dsfcontr_dbt sfcontr, "
   +"      doproper_dbt opro, "
   +"      doprstep_dbt step "
   +"WHERE sfd.t_feetype = 1 "
   +"  AND sfd.t_commnumber = 1063 "
   +"  AND sfcomiss.t_feeType = sfd.t_feeType  "
   +"  AND sfcomiss.t_number = sfd.t_commNumber "
   +"  AND sfcontr.t_ID = sfd.t_SfContrID "
   +"  AND sfcontr.t_partyID <> 1 "
   +"  AND sfcontr.t_ServKind = 1 "
   +"  AND sfd.t_Sum <> 0  "
   +"  AND sfd.t_Status = 30  "
   +"  AND opro.t_dockind = 51 "
   +"  AND opro.t_documentid = LPAD (sfd.t_id, 34, '0') "
   +"  AND step.t_id_operation = opro.t_id_operation "
   +"  AND step.T_SYMBOL = CHR (142) "
   +"  AND step.T_ISEXECUTE = 'X' "
   +"  ORDER BY sfd.t_id DESC ";
   
   return sql;
end;

//PRIVATE CONST IS_REAL = true; 

private macro ExecuteWork()

//  if(RslDefCon.IsInTrans)
//    RslDefCon.RollbackTrans();
//  end;
//  RslDefCon.BeginTrans();

  var cmd = DL_RSDCommand(GetMAINSQL());
  var count = cmd.GetCount();
  var ds = cmd.Execute();

  var stat = 0;

  var counter = 0;

  if (count > 0)
    InitProgress(count, "Выполнение отката", "Выполнение отката");
    while (ds.MoveNext())
      UseProgress((counter = counter + 1));

      // stat = Opr_BackoutStep(ds.ID_Operation, ds.ID_Step);
      stat = SfDefBackoutStep(ds.SfDefID, ds.ID_Operation, ds.ID_Step);

      if (stat != 0)
        RunError("Ошибка отката шага оплаты по ID Операции " + ds.ID_Operation);
      end;
    end;
    RemProgress();
  end;

//  if (IS_REAL)
//    RslDefCon.CommitTrans();
//  else 
//    RslDefCon.RollbackTrans();
//  end;

OnError(err)
  //var errMsg = GetFullErrorMessage(err); // Вернуть при необходимости
  var errMsg = GetErrMsg(); 
  MsgBox(errMsg);
//  if(RslDefCon.IsInTrans)
//    RslDefCon.RollbackTrans();
//  end;
end;

ExecuteWork();
