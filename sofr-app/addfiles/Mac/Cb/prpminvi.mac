/*
 $Name:        prpminvi.mac
 $Module:      РКО
 $Description: Печать инкассового поручения (WR)
*/

/************************************************************************/
/*         Автоматизированная банковская система RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 2002              */
/*                                                                      */
/*  Имя файла      : prpminvi.mac                                       */
/*                                                                      */
/*  Описание       : Печать инкассового поручения (WR)                  */
/*                   (требование-поручение)                             */
/*                                                                      */
/*  Программист    : Дроздов И.Е.                                       */
/*                                                                      */
/*  Создан         : 22.09.04                                           */
/*                                                                      */
/************************************************************************/

import "BnkTemplReport.mac", "pmbudg_lib.mac";
import prpm;

class (BnkTemplReport)PayRequest0401071Report(PayerP:TPartyProperties, ReceiverP:TPartyProperties)

   var PayerPr = PayerP;
   var ReceiverPr = ReceiverP;

   var paym   :TRecHandler = TRecHandler( "pmpaym.dbt",   "bank.def" );
   var debet  :TRecHandler = TRecHandler( "pmprop.dbt",   "bank.def" );
   var credit :TRecHandler = TRecHandler( "pmprop.dbt",   "bank.def" );
   var prop   :TRecHandler = TRecHandler( "pmrmprop.dbt", "bank.def" );
   var payord :TRecHandler = TRecHandler( "pspayord.dbt", "bank.def" );
   var paydem :TRecHandler = TRecHandler( "pspaydem.dbt", "bank.def" );
   
   copy( paym   , pr_pmpaym   );
   copy( debet  , pr_debet    );
   copy( credit , pr_credit   );
   copy( prop   , pr_pmrmprop );
   copy( payord , pr_pspayord );
   copy( paydem , pr_pspaydem );

  macro Create()

    var PDate:date    = date(0, 0, 0),
        Sum:string = string( paym.rec.Amount );

    if( paym.rec.DocKind == PS_PAYORDER )
      if(payord.rec.DocKind == PSPOKIND_REQUEST)
        PDate = paydem.rec.AcceptDate;
        Sum   = paydem.rec.ReqSum;
      end;
    end;

    StrSet(Sum, StrBrk(Sum, ".,"), "-");

    var pINN, pKPP, rINN, rKPP;
    splitINN_KPP(PayerPr.INN, pINN, pKPP);
    splitINN_KPP(ReceiverPr.INN, rINN, rKPP);

    SetSheetName( prop.rec.Number );

    //заполнение фрейма
    SetValues( "DateInto", string(paym.rec.PayerBankEnterDate:f),
               "ChargeOffDate", string(prop.rec.PayerChargeOffDate:f),
               "Data", string(prop.rec.Date:f), 
               "PaymentKind", GetPaymentKind(prop.rec.PaymentKind),
               "Number", prop.rec.Number,
               "TaxAuthor", prop.rec.TaxAuthorState,
               "AmountInLine", RubToStrAlt(Sum),
               "pINN", pINN, 
               "pKPP", pKPP,
               "Amount", Sum,
               "pName", PayerPr.Name,
               "pAccount", string(PayerPr.Account),
               "pBankName", PayerPr.BankName,
               "pBankBIC", PayerPr.BankBIC,
               "pBankAccount", string(PayerPr.BankCorrAccount),
               "rBankName", ReceiverPr.BankName,
               "rBankBIC", ReceiverPr.BankBIC,
               "rBankAccount", string(ReceiverPr.BankCorrAccount),
               "rINN", rINN,
               "rKPP", rKPP,
               "rAccount", string(ReceiverPr.Account),
               "ShifrOper", prop.rec.ShifrOper,
               "rName", ReceiverPr.Name,
               "ShifrNazn", "",
               "ShifrCode", IfThenElse(prop.rec.Date < Date(31,3,2014), "", prop.rec.UIN),
               "Priority", prop.rec.Priority,
               "RezPole", "",
               "BttTICode", IfThenElse(prop.rec.TaxAuthorState, prop.rec.BttTICode,   ""),
               "OkatoCode", IfThenElse(prop.rec.TaxAuthorState, prop.rec.OKATOCode,   ""),
               "TaxPmGround", IfThenElse(prop.rec.TaxAuthorState, prop.rec.TaxPmGround, ""),
               "TaxPmPeriod", IfThenElse(prop.rec.TaxAuthorState, prop.rec.TaxPmPeriod, ""),
               "TaxPmNumber", IfThenElse(prop.rec.TaxAuthorState, prop.rec.TaxPmNumber, ""),
               "TaxPmDate", IfThenElse(prop.rec.TaxAuthorState, prop.rec.TaxPmDate,   ""),
               "TaxPmType", GetForm110Str(prop),
               "Ground", prop.rec.Ground,
               "I2PlaceDate", string(paym.rec.I2PlaceDate),
               "PayerBankMarkDate", string(paym.rec.PayerBankMarkDate)
             );
    
    
    
     var partPayList :TPartPayList;
     var table:object;
     var i = 0;
     
     if( paym.rec.DocKind == PS_PAYORDER )
       partPayList = TPartPayList(payord.rec.OrderID);
     end;

     if((partPayList != null) and (partPayList.size > 0))
       table = RegisterTable("PartPayments");
       while( i < partPayList.size )
         table.SetValueCell("PartCount",  string(partPayList.Value(i).SubPurp));  
         table.SetValueCell("PartNumber", partPayList.Value(i).Number);           
         table.SetValueCell("PartPayDate", string(partPayList.Value(i).PayDate:f));
         table.SetValueCell("PartAmount", string(partPayList.Value(i).Amount:f));
         table.SetValueCell("PartRest", string(partPayList.Value(i).Rest:f));
         table.AddStr();
         i = i + 1;
       end;
       table.EndTable();
     end;
  end;

   initBnkTemplReport("PayRequest0401071.xls");
end;


MACRO PrintIncashRequestRSF():bool

  var PayerPr   :TPartyProperties = TPartyProperties( "Payer",    pr_pmpaym, pr_debet,  pr_pmrmprop);
  var ReceiverPr:TPartyProperties = TPartyProperties( "Receiver", pr_pmpaym, pr_credit, pr_pmrmprop);

  return PayRequest0401071Report( PayerPr, ReceiverPr ).Print();
END;
