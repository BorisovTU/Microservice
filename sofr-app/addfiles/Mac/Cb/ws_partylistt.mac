 /*
 $Name: ws_partylistt.mac
 $Module: ├ыртэр  ъэшур
 $Description: ╠ръЁюё ышёЄрыъш ёєс·хъЄют °рсыюэ
 */
import "ws_partylistclass.mac";

class (PartyList) PartyListMy

  macro GetList(pagesize            : integer,
                pagenum             : integer,
                listkind            : integer,
                namekind            : integer,
                codekind            : integer,
                partykindcollection : string,
                filteritems,
                orderitems):TArray

    var result = TArray();

    var strAddWhere:string = "";

    var p;

    var query = GetPartySQL(1, namekind, codekind);
    
    query = query + " ORDER BY " + PT_GetSortStr(orderitems, "t.t_partyid", "t.");

    query = query + " ) AA) tt WHERE 1=1 ";

    query = query + "                AND tt.T_PARTYID IN (SELECT tp.t_partyid "
                    "                                     FROM dparty_dbt tp, dpartyown_dbt partyown, dpartylst_dbt pl "
                    "                                    WHERE     pl.t_listkind IN (9,10) "
                    "                                          AND partyown.t_PartyID = tp.t_PartyID "
                    "                                          AND partyown.t_PartyKind = pl.t_partykind "
                    "                                          AND partyown.t_SubKind = 0 "
                    "                                          AND tp.t_Locked = CHR (0) "
                    "                                          AND tp.t_PartyID IN "
                    "                                                 (SELECT t_PartyID "
                    "                                                    FROM dclient_dbt "
                    "                                                   WHERE     t_ServiceKind = pl.t_servicekind "
                    "                                                         AND t_Department IN (" + {OperDprt} + " ) ";
    query = query + "                                                         AND t_StartDate <= " + To_SQLData({curdate});
                    
    query = query + "                                                         AND (   t_FinishDate = "
                    "                                                                    TO_DATE ('01 01 0001', 'DD MM YYYY') "
                    "                                                              OR t_FinishDate > " + To_SQLData({curdate});
                    
    query = query + "                                                         AND (t_Branch = 0)))) ";

    if( partykindcollection != "" )

      query = query + " AND tt.T_PARTYID IN " +
                      " (SELECT PO.T_PARTYID " +
                      " FROM DPARTYOWN_DBT PO " +
                      " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection) + " )) ";

    end;

    strAddWhere = GetPartyAddWhereCondition( FilterItems );

    if( strAddWhere != "" )
       query = query + strAddWhere;
    end;

    if( pagesize > 0 )
      query = query + " AND tt.RN BETWEEN " + string(PageSize*(PageNum) + 1) + " AND " + string(PageSize*(PageNum + 1)) ;
    end;

    println("*** GetPartyList ***");
    println(query);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    ds.NullConversion = true;

    while (ds.MoveNext())

      p = TWsPartyEx();

      SetParty(p, ds);

      result.value(result.Size) = p;

    end;

    return result;

  end;

end;

///////////////////////////////////////////////////////////
// Получить список пользователей постранично
// PageSize - размер страницы
// PageNum - номер страницы НАЧИНАЯ С 0 !!!
///////////////////////////////////////////////////////////

macro GetPartyList( pagesize            : integer,
                    pagenum             : integer,
                    listkind            : integer,
                    namekind            : integer,
                    codekind            : integer,
                    partykindcollection : string,
                    filteritems,
                    orderitems,
                    param):TArray
                    
  var obj = PartyListMy();    
  
  return obj.GetList( pagesize, pagenum, listkind, namekind, codekind, partykindcollection, filteritems, orderitems );
                    

end;

///////////////////////////////////////////////////////////
// Получить общее количество субъектов (для паджинации)
///////////////////////////////////////////////////////////

macro GetPartyCount(listkind            : integer,
                    namekind            : integer,
                    codekind            : integer,
                    partykindcollection : string,
                    filteritems,
                    param):integer               
  var obj = PartyListMy();    
  return obj.GetCount( listkind, namekind, codekind, partykindcollection, filteritems);                    

end;

///////////////////////////////////////////////////////////
// Получить объект TWsPartyEx по CodeName
///////////////////////////////////////////////////////////

macro CheckPartyByCodeName(listkind            : integer,
							  mode                : integer,
                              namekind            : integer,
                              codeKind            : integer,
                              Str                 : string,
                              param):bool
  
  var obj = PartyListMy();    
  return obj.GetByCheck(listkind, mode, namekind, codeKind, Str );                              

end;

///////////////////////////////////////////////////////////
// Возвращает список субъектов длинны listLen по
// частичному совпадению значения кода вида кода codeKind или наименования
///////////////////////////////////////////////////////////

macro LookupPartyByCodeName(mode                : integer,
                            listkind            : integer,
                            namekind            : integer,
                            codeKind            : integer,
                            partykindcollection : string,
                            sub                 : string,
                            listLen             : integer,
                            param):TArray
  
  var obj = PartyListMy();  
  
  return obj.Lookup(mode, listkind, namekind, codeKind, partykindcollection, sub, listLen);                            

end;

////////////////////////////////////////////////
// Возвращает номер строки для partyid
////////////////////////////////////////////////

macro GetPartyRowNum(partyid             : integer,
                     listkind            : integer,
                     namekind            : integer,
                     codekind            : integer,
                     partykindcollection : string,
                     param) : integer
                     
  var obj = PartyListMy();
  
  return obj.GetRowNum(partyid, listkind, namekind, codekind, partykindcollection);

end;