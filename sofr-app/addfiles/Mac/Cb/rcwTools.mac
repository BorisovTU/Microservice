 import rcw;

  class CMacroReplacer(_from, _to)
    private var from;
    private var to;
    private var ret;

    macro _ReplaceMacro()
      ret = ReplaceMacro(from, to);
      /*println("ReplaceMacro(from \"",from,"\", to \"",to,"\") = ",ret);*/
      if(not ret)
        RunError(string("Не удалось заменить процедуру \"",from,"\" на процедуру \"",to,"\"")); 
      end;
    end;
    
    macro _RestoreMacro()
      ret = ReplaceMacro(from);
      /*println("clear ReplaceMacro() for \"",from,"\" = ",ret);*/
    end;

    macro destructor()
      _RestoreMacro();
    end;

    from = _from;
    to   = _to;
    _ReplaceMacro();

  end; /* end of class CMacroReplacer */


  class CMacroReplacerStack
    private var replacers=TArray();

    macro push(replacer)
      replacers[replacers.size()]=replacer;
    end;

    macro replace()
      var i = replacers.size();
      var meth;
      while(i > 0)
        meth = R2M(replacers[i - 1], "_ReplaceMacro");
        if(meth != null)
          CallR2M(meth);
        end;
        i = i - 1;
      end;
    end;

    macro restore()
      var i = replacers.size();
      var meth;
      while(i > 0)
        meth = R2M(replacers[i - 1], "_RestoreMacro");
        if(meth != null)
          CallR2M(meth);
        end;
        i = i - 1;
      end;
    end;

    macro destructor()
      var i=replacers.size();
      while(i > 0)
        replacers[i-1]=null;
        i=i-1;
      end;
    end;
  end; /* end of class CMacroReplacerStack */


  macro _RCWIsRemoteClass(obj):bool
    return IsEqClass("RCW\\TDispProxy",obj) OR
           IsEqClass("RCW\\TRslWraper",obj)/* OR
           (index(GenClassName(obj),"RCW\\") == 1)*/;
  end;

  macro _RCWIsEqClass(className,obj)
/*    println("_RCWIsEqClass: ",className," ",obj);*/
    if(IsEqClass(className,obj))
      return true; end;
/*    if(IsEqClass("RCW\\TDispProxy",obj) OR
       IsEqClass("RCW\\TRslWraper",obj) OR
       IsEqClass("RCW\\" + className,obj))*/
    if(index(GenClassName(obj,true),"RCW\\") == 1)
//    if(_RCWIsRemoteClass(obj))
//      return _RemoteRSL.host.call("IsEqClass",className,obj); end;
      return obj._callHost("IsEqClass",className,obj); end;
    return false;
/*  OnError(x)
    println("Runtime error in _RCWIsEqClass!");
    println("className=>",className,"<");
    println("obj=>",obj,"<");
    PrintObject(obj);
    println("host=>",_RemoteRSL.host,"<");
    PrintObject(_RemoteRSL.host);
    println("Error: ",x.message);
    println(x.err);
    var i;
    if((ValType(x.err) == V_GENOBJ) AND IsEqClass("TRsComErr",x.err))
      println(x.err.count);
      i=0;
      while(i < x.err.count)
        println(x.err.message(i));
        i=i+1;
      end;
      PrintObject(x.err);
    end;
    RunError();*/
  end;

  macro _RCWGenClassName(obj,disableRedirection)
    if((
        (ValType(disableRedirection) != V_BOOL) OR
        (not disableRedirection)
       ) AND
       (
        /*IsEqClass("RCW\\TDispProxy",obj) OR
        IsEqClass("RCW\\TRslWraper",obj) OR*/
        (index(GenClassName(obj),"RCW\\") == 1)
       ))
/*    if(_RCWIsRemoteClass(obj))*/
      return obj._callHost("GenClassName",obj); end;
    return GenClassName(obj);
  end;

  macro _RCWGenPropID(obj,propName)
    if(_RCWIsRemoteClass(obj))
      return obj._callHost("GenPropID",obj,propName); end;
    return GenPropID(obj,propName);
  end;


  class(CMacroReplacerStack) CTransparentRemoting
    InitCMacroReplacerStack();

    push(CMacroReplacer("IsEqClass","_RCWIsEqClass"));
    push(CMacroReplacer("GenClassName","_RCWGenClassName"));
    push(CMacroReplacer("GenPropID","_RCWGenPropID"));
  end; /* end of class _CTransparentRemotingForLocalInstance */


  macro AdaptRemoteObject(obj)
    if(not ClrRmtOnRelease(obj))
      RunError(string("Не удалось включить немедленное освобождение удаленного объекта ",obj)); end;
    return obj;
  end;

  macro IsRCWError(err):bool
    if((ValType(err) == V_GENOBJ) AND IsEqClass("TRsComErr",err))
      return true; end;
    return false;
  end;

  macro GetRCWErrorDesc(err)
    if(not IsRCWError(err))
      return null; end;
    var i=0;
    var desc="RSCOM Error:";
    while(i < err.count)
      desc=desc + "\n" + err.message(i);
      i=i+1;
    end;
    desc=desc + "\nTotal RSCOM errors: " + string(err.count);
    return desc;
  end;
