/*──────────────────────────────────────────────────────────────────────────?
  RS-Bank 5.1                                          R-Style SoftLab

  File Name   : rep_tcno.mac
  Programmer  : Богдано?
  Description : Сче? БУ, н?вошедш? ??блиц?соответстви?
  Comment     :
  Modification: 
└───────────────────────────────────────────────────────────────────────────*/
IMPORT BankInter, CurrInter, FIInter, globals;

FILE tc ( tc_nd );
FILE Валю? ( fininstr ) key 2;
FILE obchap ( obchaptr );

FILE  a    ( account);
FILE  ac   ("account$.dbt") key 4; 

FILE dprt( dp_dep);
FILE op  ( person );

FILE temp( "acc_clnt.tmp" ) key 1000 write; /* Вре??йл */



CONST NumChapt = 5;

Private Var   ChapTek = -1,
        aref,  /* текущи??йл счето?         */
        FilTek = -1,
        ПечатьФил?? = False,
        Уче?окрытия,
        Да?На??,
        Да?Кон?,
        Filial, 
        MaskAccount,
        NameFile,
        WorkDir,
        Count = 0,
        CountCur = 0,
        Currency,
        Chapter ;
//        {oper},
//        {curdate};

Private ARRAY ArrCur;
/*---------------------------------------------------------------------------*/
macro IsAccVal(a)                 /* Сче?рублевого покрытия */

    if ( ( index( a.Type_Account, "П" ) > 0 )
      or ( index( a.Type_Account, "Н" ) > 0 )
      or ( index( a.Type_Account, "М" ) > 0 ) )
         return TRUE;
    else return FALSE;
    end;

end;

/*---------------------------------------------------------------------------*/
MACRO GetNameCur ( Cur, Cod, Name)

  keynum( Валю?, 0 );
  Валю?.FIID = Cur;

  if ( GetEQ( Валю? ) )
    setparm ( 1, Валю?.FI_CODE );
    setparm ( 2, Валю?.Name );
  else
    msgbox ("Н?найд? ко??люты: " + string(Cur));
  end; 

END;

/*---------------------------------------------------------------------------*/
MACRO GetNameOper( )

  op.Oper = {oper};

  if(  getEQ( op ) ) return  op.Name;
  else  return    "Н?найд? оп?ационис?"+ string({oper});
  end;

end;


/* ----------------------------------------------------- */

MACRO NameDprt( Num )

  dprt.Code = Num;

  if ( getEQ( dprt) ) return dprt.Name + " " + dprt.Comment;
  else                return "Н?найд? филиа??номеро?"+ string(Num);
  end;

END;


/* ----------------------------------------------------- */
MACRO LZ( num, len )
var str1, len1;

    str1 = trim( string( num ) );
    len1 = strlen( str1 );

    if ( len1 >= len ) return str1;
    else               return  mkstr("0", len-len1 ) + str1; /* слева */
    end;

END;


/* ----------------------------------------------------- */
MACRO GetNameChap ( Chap )   

    obchap.Chapter = Chap;

    if ( getEQ( obchap ) ) return obchap.symbol + ". " + obchap.Name;
    else                   return "";
    end;

END;

/* ----------------------------------------------------- */
MACRO Header
Var DatBeg;

if ( Да?На?? == Date( 0, 0, 0 ) )
     DatBeg = "00.00.0000";
else
     DatBeg = string ( Да?На??:f );
end;

  
[                      Сче? БУ, открыты??п?ио??########## по ##########,
                                   н?вошедш? ??блиц?соответстви?

  Да? ?полн?ия ##########

  Исполнит??#### #

 ]( DatBeg, Да?Кон?:f, {curdate}:f, {oper}, GetNameOper() );

END;

/* ----------------------------------------------------- */

MACRO PutChapter

[ Г??  #                       ] ( GetNameChap ( temp.Chapter ));

END;

MACRO PutFilial

[ Фил?? #                       
                                  ] ( NameDprt ( temp.Client ));
END;

MACRO PutTable ( )

Var CurCod, CurName;

    GetNameCur ( temp.Code_Currency, CurCod, CurName );

[
  Валю?  ###  #
 ┌─────────────────────────┬──────────┬─────────────────────────────────┬────────────────────?
 ?  Номе? счета  БУ      ?  Да?   ?     Оборо???ты открыти?    ?      Текущий      ?
 ?                        ?открыти?├────────────────┬────────────────?      остато?     ?
 ?                        ?         ?   дебе?      ?    кредит     ?                   ?
 ├─────────────────────────┼──────────┼────────────────┼────────────────┼────────────────────?

( CurCod, CurName );
END;

MACRO PutRaz
[├─────────────────────────┬──────────┬────────────────┬────────────────┬────────────────────?;
END;

MACRO Footer
[└─────────────────────────┴──────────┴────────────────┴────────────────┴────────────────────?;
END;


MACRO PrintAccount( )

[?########################?#########?###############?###############?###################?
( temp.ConnectAccount,     temp.RepDate:f,  temp.Debet:0:2, temp.Kredit:0:2, temp.RestIn:0:2 );

[?##########################################################################################?
( temp.NameAccount:w );


END;                                                                          

MACRO PutItog( )
Var CurCod, CurName;

    GetNameCur ( Currency, CurCod, CurName );

[Всего счето?по ?люте ###: ###### 

]
( CurCod, CountCur );

END;                                                                          

/* ----------------------------------------------------- */


MACRO FiltrAccount ( aref )

 macro FiltrCur ( Cur )
 var i = 0;

    while ( i < asize ( ArrCur ) )
      if ( ArrCur( i ) == Cur )
           return true;
      end;
      i = i + 1;
    end;

    return false;

 end; /* FiltrCur   */

 macro Ест?че?Т?

    tc.ChapterFU = aref.Chapter;
    tc.FIIDFU    = aref.Code_Currency;
    tc.AccountFU = aref.Account;
    tc.FIIDNU    = 0;
    tc.AccountNU = "";

    if ( getGe( tc ) and  ( tc.ChapterFU == aref.Chapter )      and
                          ( tc.FIIDFU    == aref.Code_Currency )     and
                          ( tc.AccountFU == aref.Account )
       )
        return TRUE;
    else
        return FALSE;

    end;

 end;  /* Ест?че?Т?*/

     if ( ( Уче?окрытия or ( not Уче?окрытия and not IsAccVal ( aref ) ) ) and
          ( ( Filial == 0 ) or ( aref.Department == Filial ) ) and
          ( FiltrCur ( aref.Code_Currency ) ) and
          ( aref.Open_Date >= Да?На?? ) and ( aref.Open_Date <= Да?Кон? ) and
          ( CompareStrWithMasks( MaskAccount, aref.Account ) == 0 ) and
            not Ест?че?Т?
        )
        return True;
     else 
        return FALSE;
     end;

END;

MACRO FormFile ()
Var rc, crec = 0;

  rewind ( aref );
 
  aref.Code_Currency = ArrCur(0);
  aref.Account = 0;
  aref.Open_Close = "";

  if ( Chapter > 0 )
      aref.Chapter = Chapter;
  else
      aref.Chapter = 1;
  end;

  rc = GetGe (aref) and
       ( ( Chapter  > 1 ) and ( aref.Chapter == Chapter ) or
         ( Chapter <= 1 )
       );

  initProgress( NRecords( aref ), "Запис?во вр??ный ?йл, ~Alt-Break~ - прекратить", "Поис?счето?);
 
/*  цикл по счета?     */
 while ( rc )

   if ( FiltrAccount ( aref ) )

         ClearRecord (temp);


         if ( strlen( aref.Sort ) > 0 )
              temp.Account = aref.Sort;                
         else
              temp.Account = aref.Account;                
         end;

         temp.Chapter = aref.Chapter;
         temp.ConnectAccount = aref.Account;      
         temp.RepDate        = aref.Open_Date; 
         temp.Date           = Date( 0, 0, 0 ); 
         temp.NameAccount    = aref.NameAccount;  
         temp.Client         = aref.Department;   
         temp.Code_Currency  = aref.Code_Currency;

         if ( FilTek != aref.Department ) 

              if ( FilTek != -1 )
                   ПечатьФил?? = TRUE;
              end;
              FilTek = aref.Department;
         end;


      /* Остатк??обороты на лицево?счет?*/
     if ( aref.Code_Currency == 0 )
         temp.RestIn = abs( restA( aref.Account, {curdate}, null, aref.Chapter ) );
         temp.Kredit = KreditA( aref.Account, aref.Open_Date, {curdate}, aref.Chapter );
         temp.Debet  = DebetA ( aref.Account, aref.Open_Date, {curdate}, aref.Chapter);
     else
         temp.RestIn = abs( restAC( aref.Account, aref.Code_Currency, {curdate}, null, aref.Chapter ) );
         temp.Kredit = KreditAC( aref.Account, aref.Code_Currency, aref.Open_Date, {curdate}, aref.Chapter );
         temp.Debet  = DebetAC( aref.Account, aref.Code_Currency, aref.Open_Date, {curdate}, aref.Chapter);
     end;

   
     if ( not insert( temp ) )
       exit( 0, "Н?внес?а ?пис?во вр??ный ?йл дл?счета БУ " + aref.Account );
     end;

     Count = Count + 1;

  end;  /*  if FiltrAccount  */

     crec = crec + 1;
     UseProgress( crec );

     if ( Chapter > 0 )
       rc = next (aref) and ( aref.Chapter == Chapter );
       if ( ( Currency > 0 ) and ( aref.Open_Close == "З" ) )
          rc = rc and ( aref.Code_Currency == Currency )
       end;
     else
       rc = next ( aref )and ( aref.Chapter <= NumChapt );
     end;


 end; /*  while  */ 

    RemProgress;

END;

MACRO  ПечатьОтчетаИ?айла
Var IndRaz = 0;

  keynum( temp, 4 );

  initProgress( NRecords( temp ), " ", "Печать отчета");
  Count = 0;
  FilTek = -1;
  Currency = -1;
  Chapter = -1;

  rewind( temp );

  while (next(temp))

     if ( ПечатьФил?? or ( Filial > 0 ) )

        if ( FilTek != temp.Client )

            IndRaz = 0;
            if ( FilTek != -1 )
               Footer;
               PutItog;
               CountCur = 0;
            end;

               PutFilial;
               PutChapter;
               PutTable;
            
            FilTek = temp.Client;
            Chapter = temp.Chapter;
            Currency = temp.Code_Currency ;
        end;

     end;

        if ( Chapter != temp.Chapter )

            IndRaz = 0;
            if ( Chapter != -1 )
               Footer;
               PutItog;
               CountCur = 0;
            end;

               PutChapter;
               PutTable;
            
            Chapter = temp.Chapter;
            Currency = temp.Code_Currency ;

        elif ( Currency != temp.Code_Currency )

            IndRaz = 0;
            if ( Currency != -1 )
               Footer;
               PutItog;
               CountCur = 0;
            end;

            Currency = temp.Code_Currency ;
            PutTable;

        end;


        if ( IndRaz ) PutRaz;  end;
        PrintAccount();
        IndRaz = 1;

    CountCur = CountCur + 1;
    Count    = Count + 1;

    UseProgress( Count );

  end;

  RemProgress;



END;

MACRO PrintReport( Fil, Chapt, Curr, Mask, BegDate, EndDate, Cover )
var  i, rc ;

  NameFile = GetWorkFileName( "a_tcn" );

  if ( not create( temp, NameFile) or not open( temp, NameFile ) )
    exit( 0, "Н?откры?вр??ный ?йл " + NameFile );
  end;


 Да?На??  =  BegDate;
 Да?Кон?   =  EndDate;
 MaskAccount =  Mask;
 Currency    =  Curr;
 Chapter     =  Chapt;

 Filial = Fil; 

  if ( Cover == "" )
      Уче?окрытия = FALSE;
  else
      Уче?окрытия = TRUE;
  end;


     if ( Curr >= 0 )
         ArrCur( 0 ) = Curr; 
     else
       i = 0;
       rewind ( Валю? );

          Валю?.FI_Kind   = FIKIND_CURRENCY;
          Валю?.AvoirKind = 0;
          rc = GetGe( Валю? );

          while ( rc and  ( Валю?.FI_Kind == FIKIND_CURRENCY ) )
             ArrCur( i ) = Валю?.FIID; 
             i = i + 1;
             rc = next( Валю? ); 
          end;

     end;

     if   ( Curr > 0 )
            aref = ac;   FormFile;
     elif ( Curr == 0 )
            aref = a;    FormFile;
     else
            aref = a;    FormFile;
            aref = ac;   FormFile;
     end;



   if ( Count > 0 )
       Header;
       ПечатьОтчетаИ?айла;
       Footer();
       PutItog;
   else
       println( "Лицевых счето??отображению н?найд?о." );
   end;




END;
                    
/*PrintReport( 0, 0, 3, "*", Date(0,0,0), Date(1,11,2002), "" );*/

/*EOF*/