/*
 $Name: cnv_funcobj.mac
 $Module: Ядро ГКБО 
 $Description: Запуск функций конвейера
*/

import "FuncObj.mac", ServiceAction, BankInter, RSD;

macro cnvStartFunc(ObjectType, ObjectID, Param, GUID, FuncObjID)
  var cmd, rs;
  var ReturnObj = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);

  ReturnObj.state = FUNCOBJ_RESULT_OK;
  ReturnObj.errorText = "";
  ReturnObj.errorCode = 0;

  cmd = RSDCommand( "SELECT t_ID, length(t_Data) as len, t_Data FROM DFUNCOBJ_DBT WHERE T_ID = ?" );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, FuncObjID     );

  var DataXml = "";
  rs = RsdRecordSet(cmd);
  if (rs.moveNext())
    var LenXml = int(rs.value("len"));
    rs.Fld("t_Data").Read(DataXml, LenXml);
  end; 

  var RSLResult;
  var XMLResult : string;
  /* запускаем локальное выполнение переданного XML-запроса */
  XMLResult = XmlRpcLocalCall( DataXml );

  /* преобразуем XML-ответ в объект RSL*/
  ConvertToRSL( XMLResult, RSLResult );

  if( (ValType(RSLResult) == V_GENOBJ) and (GenPropID(RSLResult, "faultString") != -1) )
    /* если вернули объект с полем faultString, значит была ошибка выполнения */
    ReturnObj.state     = FUNCOBJ_RESULT_ERROR;
    ReturnObj.errorText = toOEM(RSLResult.faultString, true);
    ReturnObj.errorCode = FUNCOBJ_STATE_FATAL_ERROR;
  end;
/*
  file OutFile("") txt write;  
  var OutStr = " FuncObjID = " + FuncObjID +
               " ObjectType = " + ObjectType +
               " ObjectID = " + ObjectID +
               " Param = " + Param + 
               " DataXml = " + DataXml + 
               " XMLResult =" + XMLResult;

  var stat = Open( OutFile, "..\\TxtFile\\MyTest.txt");
  if((stat == true))
     OutFile.str = OutStr;
     insert(OutFile);
     close(OutFile);
  end;
*/
  return ReturnObj;
end;