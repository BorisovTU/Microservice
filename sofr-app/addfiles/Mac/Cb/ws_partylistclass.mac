/*
$Name:        ws_partylistclass.mac
$Module:      WEB - Общее
$Description: Макрос с реализаций класса для отбора субъектов
*/

import BankInter;
import "ws_datafilter.mac";
import "pr_party_lib.mac";
import "ws_partyclasses.mac";
import "ws_partycommon.mac";
import "ws_llvalues.mac";
import "commonutil.mac";

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

macro PT_GetSortStr( OrderItems,            /* Параметры сортировки */
                     Table:string           /* Название таблицы c . */
                   ):String

  var SortStr:string = "";

   SortStr = " " + Table + "t_" + OrderItems[0].Column + " " + PT_IIF(OrderItems[0].Direction == 0, "asc", "desc");
   var i:integer = 1;
   while( i < OrderItems.size() )
      SortStr = SortStr + ", " + Table + "t_" + OrderItems[i].Column + " " + PT_IIF(OrderItems[i].Direction == 0, "asc", "desc");
      i = i + 1;
   end;
   SortStr = SortStr + " ";

  return SortStr;

end;

private macro StringCondition(filteritems, value, FlagUpper) : string

  var condition = "";
  var conditionNOT = "";
  var condB = "";
  var condE = "";

  if( filteritems.IsNot )
    conditionNOT = " NOT ";
  else
    conditionNOT = " ";
  end;

  if( filteritems.Condition == FilterCondition_Null )
    condB = " = CHR(1) ";
  end;

  if( filteritems.Condition == FilterCondition_Equal )
    condB = " LIKE ";
    condE = " ";
  end;

  if( filteritems.Condition == FilterCondition_StartWith )
    condB = " LIKE ";
    condE = " || '%'";
  end;

  if( filteritems.Condition == FilterCondition_Include )
    condB = " LIKE '%' || ";
    condE = " || '%'";
  end;

  condition = condition + conditionNOT;

  condition = condition + condB;

  if( filteritems.Condition != FilterCondition_Null )

    if(FlagUpper)

      condition = condition + " UPPER ('" + string(value) + "') ";

    else

      condition = condition + "'" + string(value) + "'";

    end;
  end;

  condition = condition + condE;

  return condition;

end;

macro GetPartyAddWhereCondition(
  FilterItems/*:TArray of FilterCondItem*/
):String

  var condition = "";
  var conditionNOT = "";

  var FilterItemsCount = 0;
  var ValueCount = 0;

  while( FilterItemsCount < FilterItems.Size )

    if( FilterItems[FilterItemsCount].Id == 0 ) // Наименование субъекта

      condition = condition + " AND t.t_partyid in (select t_partyid from dpartyname_dbt where ";

      if(FilterItems[FilterItemsCount].Value[0].NameTypeId > 0)
        condition = condition + " t_nametypeid = ";
        condition = condition + string(FilterItems[FilterItemsCount].Value[0].NameTypeId);
      else
        condition = condition + " 1 = 1 ";
      end;

      condition = condition + " and UPPER(t_name) ";

      condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0].Name, true);

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 1 ) // Вышестоящая организация

      conditionNOT = "";

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;    

      if( (FilterItems[FilterItemsCount].Condition == FilterCondition_Equal) OR (FilterItems[FilterItemsCount].Condition == 4096) ) // FilterCondition_Direct

        if(FilterItems[FilterItemsCount].Value.Size == 0)

          condition = condition + " AND t.t_partyid " + conditionNOT + " in (select t_partyid from dparty_dbt where ";
          condition = condition + " t_superior = -1 ) ";

        else

          ValueCount = 0;

          condition = condition + " AND t.t_partyid " + conditionNOT + " in (select t_partyid from dparty_dbt where ";
          condition = condition + " t_superior in (";

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].partyid);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              condition = condition + ", ";

            end;

            ValueCount = ValueCount + 1;

        end;

          condition = condition + " )) ";          

      end;

      end;

      if( (FilterItems[FilterItemsCount].Condition == FilterCondition_All) OR (FilterItems[FilterItemsCount].Condition == 8192) ) // FilterCondition_Hierarchy
      
        if(FilterItems[FilterItemsCount].Value.Size != 0)

          ValueCount = 0;

          condition = condition + " AND t.t_partyid " + conditionNOT + " in (select t_partyid from dparty_dbt ";
          condition = condition + " START WITH t_superior in ( ";
          
          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].partyid);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              condition = condition + ", ";

            end;

            ValueCount = ValueCount + 1;

          end;

          condition = condition + " ) "; 
          
          condition = condition + " CONNECT BY t_superior = PRIOR t_partyid ) ";
          
        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 2 ) // Является нерезидентом

        condition = condition + " AND t.t_partyid in (select t_partyid from dparty_dbt ";

        if(FilterItems[FilterItemsCount].Value[0])
          condition = condition + " where t_notresident = 'X'";
        else
          condition = condition + " where t_notresident = CHR(0)";
        end;

        condition = condition + " ) ";

      end;

    if( FilterItems[FilterItemsCount].Id == 3 ) // ОКПО

      condition = condition + " AND t.t_partyid in (select t_partyid from dpartyname_dbt where UPPER(t_okpo) ";

      condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0], true);

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 4 ) // Код

      condition = condition + " AND t.t_partyid in (select t_partyid from dpartcode_dbt where ";
      condition = condition + " t_codekind = ";
      condition = condition + string(FilterItems[FilterItemsCount].Value[0].CodeKind);
      
      condition = condition + " and UPPER(t_code) ";
      condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0].Name, true);

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 5 ) // Налоговая инспекция

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        if(FilterItems[FilterItemsCount].Value.Size == 0)

          condition = condition + " AND t.t_partyid in (select t_partyid from dparty_dbt where ";
          condition = condition + " t_taxinstitution = -1 ) ";

        else

          ValueCount = 0;

          condition = condition + " AND t.t_partyid in (select t_partyid from dparty_dbt where ";
          condition = condition + " t_taxinstitution in (";

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].partyid);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              condition = condition + ", ";

            end;

            ValueCount = ValueCount + 1;

          end;

          condition = condition + " )) ";

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 6 ) // Форма субъекта

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND t.t_partyid in (select t_partyid from dparty_dbt where ";
        condition = condition + " t_legalform = ";
        condition = condition + string(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 7 ) // Вид субъектов
    
      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        if(FilterItems[FilterItemsCount].Value.Size == 0)

            condition = condition + " AND t.t_partyid ";
            
            condition = condition + " in (select t_partyid from dpartyown_dbt ) ";

        else

          ValueCount = 0;

          condition = condition + " AND t.t_partyid in (select t_partyid from dpartyown_dbt where ";
          condition = condition + " t_partykind ";
          condition = condition + " in (";

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].partykind);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              condition = condition + ", ";

            end;

            ValueCount = ValueCount + 1;

          end;

          condition = condition + " )) ";

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 8 ) // Регистрационный документ: вид

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_RegPartyKind =";
        condition = condition + string(FilterItems[FilterItemsCount].Value[0].RegPartyKind);
        condition = condition + " AND ORD.t_RegDocKind =";
        condition = condition + string(FilterItems[FilterItemsCount].Value[0].RegDocKind);
        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 9 ) // Регистрационный документ: период действия

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_From )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_startdate >= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_finishdate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_startdate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

        condition = condition + " AND (ORD.t_FinishDate =  " + To_SQLData(date(0, 0, 0)) +
                                " OR ORD.t_FinishDate >= " + To_SQLData(FilterItems[FilterItemsCount].Value[1]) + ")";
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_startdate = ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 10 ) // Регистрационный документ: серия, номер

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 ";

        if((FilterItems[FilterItemsCount].Value[0].Series != null) AND
           (FilterItems[FilterItemsCount].Value[0].Series != ""))
          condition = condition + " AND UPPER(ORD.t_Series) = UPPER(";
          condition = condition + string(FilterItems[FilterItemsCount].Value[0].Series);
          condition = condition + " ) ";
        end;

        if((FilterItems[FilterItemsCount].Value[0].Number != null) AND
           (FilterItems[FilterItemsCount].Value[0].Number != ""))
          condition = condition + " AND UPPER(ORD.t_Number) = UPPER(";
          condition = condition + string(FilterItems[FilterItemsCount].Value[0].Number);
          condition = condition + " ) ";
        end;

        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 11 ) // Регистрационный документ: кем выдан

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        if(FilterItems[FilterItemsCount].Value.Size == 0)

          condition = condition + " and t.t_partyid in (select t_objectid from dobjrgdoc_dbt ord where ";
          condition = condition + " ord.t_ObjectType = 3 and t_RegPartyID = 0 )";

        else

          ValueCount = 0;

          condition = condition + " and t.t_partyid in (select t_objectid from dobjrgdoc_dbt ord where ";
          condition = condition + " ord.t_ObjectType = 3 and t_RegPartyID in (";

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].partyid);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              condition = condition + ", ";

            end;

            ValueCount = ValueCount + 1;

          end;

          condition = condition + " )) ";   

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 12 ) // Регистрационный документ: дата выдачи

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_From )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_docdate >= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_docdate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_docdate Between ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " AND ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[1]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND EXISTS (SELECT 1 FROM dobjrgdoc_dbt ORD WHERE ORD.t_ObjectID = t.t_PartyID ";
        condition = condition + " AND ORD.t_ObjectType = 3 AND ORD.t_docdate = ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 13 ) // Регистрационный документ: регистрационный номер

      condition = condition + " and t.t_partyid in (select t_partyid from dobjrgdoc_dbt ord, dpartcode_dbt cd where ";
      condition = condition + " ord.t_ObjectID = cd.t_PartyID and ord.t_ObjectType = 3 and ord.t_codekind = cd.t_codekind and UPPER(cd.t_code) ";

      condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0], true);

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 14 ) // Удостоверение личности: вид

      conditionNOT = "";

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;    

      condition = condition + " AND t.t_partyid " + conditionNOT + " in (select t.t_partyid from dpersnidc_dbt where t_personid = t.t_PartyID AND t_paperkind = ";

      condition = condition + string(FilterItems[FilterItemsCount].Value[0]);

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 15 ) // Удостоверение личности: серия, номер

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND t.t_partyid in (select t.t_partyid from dpersnidc_dbt where t_personid = t.t_PartyID";

        if((FilterItems[FilterItemsCount].Value[0].Series != null) AND
           (FilterItems[FilterItemsCount].Value[0].Series != ""))
          condition = condition + " AND UPPER(t_paperseries) = UPPER(";
          condition = condition + string(FilterItems[FilterItemsCount].Value[0].Series);
          condition = condition + " ) ";
        end;

        if((FilterItems[FilterItemsCount].Value[0].Number != null) AND
           (FilterItems[FilterItemsCount].Value[0].Number != ""))
          condition = condition + " AND UPPER(t_papernumber) = UPPER(";
          condition = condition + string(FilterItems[FilterItemsCount].Value[0].Number);
          condition = condition + " ) ";
        end;

        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 16 ) // Удостоверение личности: кем выдано

      condition = condition + " AND t.t_partyid in (select t.t_partyid from dpersnidc_dbt where t_personid = t.t_PartyID AND UPPER(t_paperissuer) ";

      condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0], true);

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 17 ) // Удостоверение личности: дата выдачи

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_From )

        condition = condition + " AND EXISTS (SELECT 1 FROM dpersnidc_dbt WHERE t_personid = t.t_PartyID ";
        condition = condition + " AND t_paperissueddate >= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

        condition = condition + " AND EXISTS (SELECT 1 FROM dpersnidc_dbt WHERE t_personid = t.t_PartyID ";
        condition = condition + " AND t_paperissueddate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

        condition = condition + " AND EXISTS (SELECT 1 FROM dpersnidc_dbt WHERE t_personid = t.t_PartyID ";
        condition = condition + " AND t_paperissueddate Between ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " AND ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[1]);
        condition = condition + " ) ";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND EXISTS (SELECT 1 FROM dpersnidc_dbt WHERE t_personid = t.t_PartyID ";
        condition = condition + " AND t_paperissueddate = ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 18 ) // Является участником срочных платежей в рублях

        condition = condition + " AND ";

        if(FilterItems[FilterItemsCount].Value[0] == false)
          
          condition = condition + " NOT ";

        end;
        
        condition = condition + " LPAD (t.t_partyid, 10, '0') IN "
                                "           (SELECT t_object "
                                "              FROM dobjattr_dbt at, dobjatcor_dbt ac "
                                "             WHERE     at.t_groupid = 35 "
                                "                   AND at.t_objecttype = 3 "
                                "                   AND at.t_codelist = CHR (1) "
                                "                 AND at.t_numinlist = '1' "
                                "                   AND AT.T_ATTRID = ac.t_attrid "
                                "                   AND ac.t_groupid = 35 "
                                "                   AND ac.t_objecttype = 3) ";
      end;

    if( FilterItems[FilterItemsCount].Id == 19 ) // Является участником срочных платежей в валюте

        condition = condition + " AND ";

        if(FilterItems[FilterItemsCount].Value[0] == false)

          condition = condition + " NOT ";

        end;
        
        condition = condition + " LPAD (t.t_partyid, 10, '0') IN "
                                "           (SELECT t_object "
                                "              FROM dobjattr_dbt at, dobjatcor_dbt ac "
                                "             WHERE     at.t_groupid = 36 "
                                "                   AND at.t_objecttype = 3 "
                                "                   AND at.t_codelist = CHR (1) "
                                "                 AND at.t_numinlist = '1' "
                                "                   AND AT.T_ATTRID = ac.t_attrid "
                                "                   AND ac.t_groupid = 36 "
                                "                   AND ac.t_objecttype = 3) ";
      end;

    if( FilterItems[FilterItemsCount].Id == 20 ) // Клиент: филиал

      condition = condition + " and exists "
                              "           (select 1 "
                              "              from dptsvdp_dbt pd, dpartyown_dbt po "
                              "            where pd.t_partyid = t.t_partyid "
                              "                  and pd.t_partykind = 1 "
                              "                  and po.t_partykind = 1 "
                              "                  and po.t_partyid = pd.t_partyid ";

      if( (FilterItems[FilterItemsCount].Condition == FilterCondition_Equal) AND (FilterItems[FilterItemsCount].Value != null) AND (FilterItems[FilterItemsCount].Value.Size > 0) )

        ValueCount = 0;

        condition = condition + " and pd.t_department in (";

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].Code);

          if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

            condition = condition + ", ";

          end;

          ValueCount = ValueCount + 1;

        end;

        condition = condition + ") ";          

      end;

      if( (FilterItems[FilterItemsCount].Condition == FilterCondition_All) AND (FilterItems[FilterItemsCount].Value != null) AND (FilterItems[FilterItemsCount].Value.Size > 0) )

        condition = condition + " and pd.t_department in (select dp.t_code ";
        condition = condition + "                             from ddp_dep_dbt dp ";
        
        ValueCount = 0;

        condition = condition + "                           start with dp.t_code in (";

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].Code);

          if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

            condition = condition + ", ";

          end;

          ValueCount = ValueCount + 1;

        end;

        condition = condition + ") ";          
        
        condition = condition + "                           connect by dp.t_parentcode = prior dp.t_code) ";
      end;

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 21 ) // Клиент: вид обслуживания
    
      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )
      
        if(FilterItems[FilterItemsCount].Value.Size != 0)

          var ServKinds = "";

          ValueCount = 0;

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            ServKinds = ServKinds + string(FilterItems[FilterItemsCount].Value[ValueCount].servisekind);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              ServKinds = ServKinds + ", ";

            end;

            ValueCount = ValueCount + 1;

          end;


          condition = condition + " AND  ";
          condition = condition + " EXISTS "
                                  "         (SELECT 1 "
                                  "            FROM dclient_dbt CL1 "
                                  "           WHERE     CL1.t_PartyID = t.t_PartyID ";
          condition = condition + "                 AND CL1.t_ServiceKind IN (" + ServKinds + ")"
                                  "                 AND CL1.t_Department IN "
                                  "                        (    SELECT DP.t_Code "
                                  "                               FROM ddp_dep_dbt DP ";
          condition = condition + "                         START WITH DP.t_Code = " + {OperDprt};
          condition = condition + "                         CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) "
                                  "  AND EXISTS "
                                  "         (SELECT 1 "
                                  "            FROM dptsvdp_dbt PD "
                                  "           WHERE     PD.t_PartyID = t.t_PartyID "
                                  "                 AND PD.t_PartyKind = 1 "
                                  "                 AND PD.t_Department IN "
                                  "                        (    SELECT DP.t_Code "
                                  "                               FROM ddp_dep_dbt DP "
                                  "                         START WITH DP.t_Code = " + {OperDprt};
          condition = condition + "                         CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) ";
        
        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 22 ) // Клиент: период обслуживания

      condition = condition + " AND EXISTS "
                              "   (SELECT 1 "
                              "      FROM dclient_dbt CL1 "
                              "     WHERE CL1.t_PartyID = t.t_PartyID AND ";

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_From )

        condition = condition + " CL1.t_startdate >= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

        condition = condition + " CL1.t_finishdate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

        condition = condition + " CL1.t_startdate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

        condition = condition + " AND (CL1.t_FinishDate =  " + To_SQLData(date(0, 0, 0)) +
                                " OR CL1.t_FinishDate >= " + To_SQLData(FilterItems[FilterItemsCount].Value[1]) + ")";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " CL1.t_startdate = ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      condition = condition + " AND CL1.t_Department IN "
                              "     (    SELECT DP.t_Code "
                              "            FROM ddp_dep_dbt DP "
                              "      START WITH DP.t_Code = " + {OperDprt};
      condition = condition + "      CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) "
                              " AND EXISTS "
                              "    (SELECT 1 "
                              "       FROM dptsvdp_dbt PD "
                              "      WHERE     PD.t_PartyID = t.t_PartyID "
                              "            AND PD.t_PartyKind = 1 "
                              "            AND PD.t_Department IN "
                              "             (    SELECT DP.t_Code "
                              "                    FROM ddp_dep_dbt DP "
                              "              START WITH DP.t_Code = " + {OperDprt};
      condition = condition + "              CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 23 ) // Клиент: тарифный план

      conditionNOT = "";

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;     

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND  " + conditionNOT +
        "   EXISTS "
        "             (SELECT 1 "
        "                FROM dptdpsfplan_dbt PSP "
        "               WHERE PSP.t_PartyID = t.t_PartyID ";
        
        if((FilterItems[FilterItemsCount].Value != null) AND (FilterItems[FilterItemsCount].Value.Size > 0))
        
          condition = condition + " AND PSP.t_SfPlanID in ( ";
          
          ValueCount = 0;

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].sfplanid);

            if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

              condition = condition + ", ";

            end;

            ValueCount = ValueCount + 1;

          end;

          condition = condition + " ) ";         
        
        end;
        
        condition = condition + " AND PSP.t_Department IN "
        "                   (    SELECT DP.t_Code "
        "                          FROM ddp_dep_dbt DP "
        "                    START WITH DP.t_Code = " + {OperDprt};
        condition = condition + " CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code) "
        "                  AND EXISTS "
        "                   (SELECT 1 "
        "                      FROM dsfplan_dbt SP "
        "                     WHERE SP.t_SfPlanID = PSP.t_SfPlanID ";


        if(FilterItems[FilterItemsCount].Value[0].date != date(0, 0, 0))

          condition = condition + " AND SP.t_Begin <= " + To_SQLData(FilterItems[FilterItemsCount].Value[0].date);
          condition = condition + " AND " + To_SQLData(FilterItems[FilterItemsCount].Value[0].date) + " < DECODE( "
          "                                 SP.t_End, "
          "                                 TO_DATE('01.01.0001', 'DD.MM.YYYY'), "
          "                                 TO_DATE('31.12.9999', 'DD.MM.YYYY'), "
          "                                 SP.t_End) ";

        end;

        condition = condition + " )) "
        "   AND EXISTS "
        "      (SELECT 1 "
        "         FROM dptsvdp_dbt PD "
        "        WHERE     PD.t_PartyID = t.t_PartyID "
        "              AND PD.t_PartyKind = 1 "
        "              AND PD.t_Department IN "
        "               (    SELECT DP.t_Code "
        "                      FROM ddp_dep_dbt DP "
        "                START WITH DP.t_Code = " + {OperDprt};
        condition = condition + " CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 24 ) // Банковский продукт: вид

      condition = condition + " AND "
                              " EXISTS "
                              "           (SELECT 1 "
                              "              FROM dprdclient_dbt PC "
                              "             WHERE     PC.t_PartyID = t.t_PartyID "
                              "                   AND PC.t_ProductID IN (SELECT PP.t_ProductID "
                              "                                            FROM dprdproduct_dbt PP "
                              "                                           WHERE PP.t_ProductKindID = " + FilterItems[FilterItemsCount].Value[0] + " ) ";
      condition = condition + "                          AND PC.t_Branch IN "
                              "                          (    SELECT DP.t_Code "
                              "                                 FROM ddp_dep_dbt DP "
                              "                           START WITH DP.t_Code = " + {OperDprt};
      condition = condition + "                          CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 25 ) // Банковский продукт: наименование

      conditionNOT = "";

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;     

      condition = condition + " AND " + conditionNOT + " EXISTS "
                              "   (SELECT 1 "
                              "      FROM dprdclient_dbt PC "
                              "     WHERE     PC.t_PartyID = t.t_PartyID ";

      if((FilterItems[FilterItemsCount].Value != null) AND (FilterItems[FilterItemsCount].Value.Size > 0))
      
        condition = condition + " AND PC.t_ProductID IN ( ";
        
        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount].productid);

          if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

            condition = condition + ", ";

          end;

          ValueCount = ValueCount + 1;

        end;

      condition = condition + " ) ";
      
      end;      
      
      condition = condition + " AND PC.t_Branch IN "
                              "                    (SELECT DP.t_Code "
                              "                           FROM ddp_dep_dbt DP "
                              "                     START WITH DP.t_Code = " + {OperDprt};
      condition = condition + "                     CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) ";


    end;

    if( FilterItems[FilterItemsCount].Id == 26 ) // Банковский продукт: период обслуживания

      condition = condition + " AND EXISTS "
                              "           (SELECT 1 "
                              "              FROM dprdclient_dbt PC "
                              "             WHERE PC.t_PartyID = t.t_PartyID AND ";

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_From )

        condition = condition + " PC.t_begindate >= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

        condition = condition + " PC.t_enddate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

        condition = condition + " PC.t_begindate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

        condition = condition + " AND (PC.t_enddate =  " + To_SQLData(date(0, 0, 0)) +
                                " OR PC.t_enddate >= " + To_SQLData(FilterItems[FilterItemsCount].Value[1]) + ")";

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " PC.t_begindate = ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      condition = condition + "             AND PC.t_Branch IN "
                              "                 (SELECT DP.t_Code "
                              "                        FROM ddp_dep_dbt DP "
                              "                  START WITH DP.t_Code = " + {OperDprt};
      condition = condition + "                  CONNECT BY DP.t_ParentCode = PRIOR DP.t_Code)) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 27 ) // Введен пользователем

      conditionNOT = "";
    
      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;     

      condition = condition + " AND t.t_PartyID " + conditionNOT + " IN (SELECT OC.t_ObjectID "
                              "                               FROM dobjcode_dbt OC "
                                          "                              WHERE 1=1 ";
                                          
      if((FilterItems[FilterItemsCount].Value != null) AND (FilterItems[FilterItemsCount].Value.Size > 0))
      
        condition = condition + " AND OC.t_UserID in ( ";
        
        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          condition = condition + string(FilterItems[FilterItemsCount].Value[ValueCount]);

          if(ValueCount != FilterItems[FilterItemsCount].Value.Size - 1)

            condition = condition + ", ";

          end;

          ValueCount = ValueCount + 1;

        end;

        condition = condition + " ) ";         
      
      end;

      condition = condition + "                    AND OC.t_ObjectType = 3 "
                              "                    AND OC.t_CodeKind = 1 "
                              "                    AND OC.t_BankDate = "
                              "                     (SELECT MIN (OC1.t_BankDate) "
                              "                        FROM dobjcode_dbt OC1 "
                              "                       WHERE     OC1.t_CodeKind = 1 "
                              "                             AND OC1.t_ObjectType = 3 "
                              "                         AND OC1.t_ObjectID = OC.t_ObjectID)) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 28 ) // Состояние физического лица

        condition = condition + " AND t.t_partyid in (select t_personid from dpersn_dbt where ";
        condition = condition + " t_death ";

        if(FilterItems[FilterItemsCount].Value[0] == 1)

          condition = condition + " = " + To_SQLData(date(0, 0, 0));

        end;

        if(FilterItems[FilterItemsCount].Value[0] == 2)

          condition = condition + " != " + To_SQLData(date(0, 0, 0));

        end;

        condition = condition + " ) ";

      end;

    if( FilterItems[FilterItemsCount].Id == 29 ) // ФИО физического лица

      condition = condition + " AND t.t_partyid in (select t_personid from dpersn_dbt where 1 = 1";

      if((FilterItems[FilterItemsCount].Value[0].name1 != null) AND (FilterItems[FilterItemsCount].Value[0].name1 != ""))

        condition = condition + " AND UPPER(t_name1) ";
        condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0].name1, true);

      end;

      if((FilterItems[FilterItemsCount].Value[0].name2 != null) AND (FilterItems[FilterItemsCount].Value[0].name2 != ""))

        condition = condition + " AND UPPER(t_name2) ";
        condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0].name2, true);

      end;

      if((FilterItems[FilterItemsCount].Value[0].name3 != null) AND (FilterItems[FilterItemsCount].Value[0].name3 != ""))

        condition = condition + " AND UPPER(t_name3) ";
        condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0].name3, true);

      end;

      condition = condition + " ) ";

    end;

    if( FilterItems[FilterItemsCount].Id == 30 ) // Является предпринимателем

        condition = condition + " AND t.t_partyid in (select t_personid from dpersn_dbt where ";

        if(FilterItems[FilterItemsCount].Value[0])
          condition = condition + " t_isemployer = 'X'";
        else
          condition = condition + " t_isemployer = CHR(0)";
        end;

        condition = condition + " ) ";

      end;

    if( FilterItems[FilterItemsCount].Id == 31 ) // Принадлежность к ИПДЛ

      if( FilterItems[FilterItemsCount].Value.Size > 0 )

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        conditionNOT = "";

        if( FilterItems[FilterItemsCount].IsNot )
          conditionNOT = " NOT ";
        else
          conditionNOT = " ";
        end;

      end;

      condition = condition + " AND t.t_partyid " + conditionNOT;
      condition = condition + " IN "
                              "         (SELECT ac.t_object "
                              "            FROM dobjattr_dbt at, dobjatcor_dbt ac "
                              "           WHERE     at.t_groupid = 34 "
                              "                 AND at.t_objecttype = 3 "
                                "                 AND at.t_codelist = chr(1) ";

      ValueCount = 0;

      while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

        if(FilterItems[FilterItemsCount].Value[ValueCount] == 0);

          condition = condition + " AND (at.t_numinlist = '1' OR at.t_numinlist = '2') ";

        end;

        if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

          condition = condition + " AND at.t_numinlist = '3' ";

        end;

        if(FilterItems[FilterItemsCount].Value[ValueCount] == 2);

          condition = condition + " AND at.t_numinlist IN ('4', '5', '6', '7') ";

        end;

        ValueCount = ValueCount + 1;

      end;

      condition = condition + "                   AND at.t_attrid = ac.t_attrid "
                              "                   AND ac.t_objecttype = 3 ";
      condition = condition + "                   AND ac.t_validfromdate <= " + To_SQLData({curdate});
      condition = condition + "                   AND ac.t_validtodate >= " + To_SQLData({curdate});
      condition = condition + " ) ";

    end;

    end;

    if( FilterItems[FilterItemsCount].Id == 32 ) // Синхронизация с ЦБД клиентов

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        conditionNOT = "";

        if( FilterItems[FilterItemsCount].IsNot )
          conditionNOT = " NOT ";
        else
          conditionNOT = " ";
        end;

        condition = condition + " AND t.t_partyid " + conditionNOT + " IN "
                                "                 (SELECT t_partyid "
                                "                    FROM dparty_dbt "
                                "                   WHERE     t_legalform = 2 ";

        if(FilterItems[FilterItemsCount].Value[0].Checked_1)

          condition = condition + "                       AND t_cbdk_issynch = 'X' "
                                  "                       AND t_cbdk_dateupdate != " + To_SQLData(date(0, 0, 0));

        end;

        if(FilterItems[FilterItemsCount].Value[0].Checked_2)

          condition = condition + "                       AND t_CBDK_issynch = CHR (0) "
                                  "                       AND t_cbdk_dateupdate != " + To_SQLData(date(0, 0, 0));

        end;

        if(FilterItems[FilterItemsCount].Value[0].Checked_3)

          condition = condition + "                       AND t_CBDK_dateupdate = " + To_SQLData(date(0, 0, 0));

        end;

        condition = condition + " ) ";

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 33 ) // Не обновлять при импорте

        condition = condition + " AND t.t_partyid in (select t_partyid from dparty_dbt where ";

        if(FilterItems[FilterItemsCount].Value[0])
          condition = condition + " t_notupdateonimport = 'X'";
        else
          condition = condition + " t_notupdateonimport = CHR(0)";
        end;

        condition = condition + " ) ";

      end;

    if( FilterItems[FilterItemsCount].Id == 34 ) // Форма субъекта

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        if(FilterItems[FilterItemsCount].Value.Size > 0)

          var lfStr = "";

          ValueCount = 0;

          while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

            if(FilterItems[FilterItemsCount].Value[ValueCount] == 0);

              lfStr = lfStr + "1,";

            end;

            if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

              lfStr = lfStr + "2,";

            end;

            ValueCount = ValueCount + 1;

          end;

          lfStr = SubStr(lfStr, 1, StrLen(lfStr) - 1);

          if(lfStr != "")

            condition = condition + " AND t.t_partyid in (select t_partyid from dparty_dbt where t_legalform IN (";
            condition = condition + string(lfStr) + ")) ";
          end;

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 35 ) // Статус банкротства физлица
         
      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

          if((FilterItems[FilterItemsCount].Value != null) AND (FilterItems[FilterItemsCount].Value.Size > 0))
          
            if( FilterItems[FilterItemsCount].IsNot )
            
              condition = condition + " AND RSI_RSBPARTY.GetPartyBankruptStatus(t.T_PARTYID, t.T_LEGALFORM, SYSDATE) NOT IN (  ";
              
            else
            
              condition = condition + " AND RSI_RSBPARTY.GetPartyBankruptStatus(t.T_PARTYID, t.T_LEGALFORM, SYSDATE) IN (  ";
            
            end;

            ValueCount = 0;
            
            while( ValueCount < FilterItems[FilterItemsCount].Value.Size )
            
                condition = condition + string(filteritems[filteritemscount].Value[ValueCount].element);
              
                ValueCount = ValueCount + 1;
                  
                if((ValueCount > 0) AND (ValueCount < FilterItems[FilterItemsCount].Value.Size))
                    
                  condition = condition + " , ";
                      
                end;

            end;
            
            condition = condition + " ) ";

          end;        

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == 36 ) // Полное наименование
    
      condition = condition + " AND UPPER(t.t_name) ";

      condition = condition + StringCondition(FilterItems[FilterItemsCount], FilterItems[FilterItemsCount].Value[0], true);
      
    end;
    
    if( FilterItems[FilterItemsCount].Id == 37 ) // Системный ID
    
      condition = condition + GetFilterIntegerSQLCondition(FilterItems[FilterItemsCount], "AND t.t_partyid");    
    
    end;

    FilterItemsCount = FilterItemsCount + 1;

  end;

  return condition;
end;

macro SetParty(p, ds)

  p.partyid           = ds.partyid;
  p.iownerkind        = ds.iownerkind;
  p.legalform         = ds.legalform;
  p.shortname         = ds.shortname;
  p.name              = ds.name;
  p.addname           = ds.addname;
  p.okpo              = ds.okpo;
  p.notresident       = ds.notresident;
  p.superior          = ds.superior;
  p.change_date       = ds.change_date;
  p.change_dateprev   = ds.change_dateprev;
  p.locked            = ds.locked;
  p.taxinstitution    = ds.taxinstitution;
  p.taxregdate        = ds.taxregdate;
  p.systype           = ds.systype;
  p.usertype          = ds.usertype;
  p.userfield1        = ds.userfield1;
  p.userfield2        = ds.userfield2;
  p.userfield3        = ds.userfield3;
  p.userfield4        = ds.userfield4;
  p.nrcountry         = ds.nrcountry;
  p.consolidaterecord = ds.consolidaterecord;
  p.setaccsearchalg   = ds.setaccsearchalg;
  p.branch            = ds.branch;
  p.numsession        = ds.numsession;
  p.ofshorezone       = ds.ofshorezone;
  p.mainpartyid       = ds.mainpartyid;
  p.isprobdoubler     = ds.isprobdoubler;
  p.isdoubler         = ds.isdoubler;
  p.hasdoubler        = ds.hasdoubler;
  p.paramsetid        = ds.paramsetid;
  //hashvalue   raw
  p.latname           = ds.latname;
  p.cbdk_issynch      = ds.cbdk_issynch;
  p.cbdk_dateupdate   = ds.cbdk_dateupdate;
  p.cbdk_timeupdate   = ds.cbdk_timeupdate;
  p.cbdk_synchinfo    = ds.cbdk_synchinfo;
  p.reserve           = ds.reserve;

  p.partyname         = ds.partyname;
  p.code              = ds.code;
  p.lastchangeddate   = ds.lastchangeddate;
  p.lastchangedtime   = ds.lastchangedtime;
  p.legalimagepath    = ds.legalimagepath;

  p.born              = SQL_ConvType(ds.born);
  p.paperseriesnumber = SQL_ConvTypeStr(ds.paperseriesnumber);

end;

macro SetParty_old(p, ds)

  p.partyid           = ds.partyid;
  p.iownerkind        = ds.iownerkind;
  p.legalform         = ds.legalform;
  p.shortname         = ds.shortname;
  p.name              = ds.name;
  p.addname           = ds.addname;
  p.okpo              = ds.okpo;
  p.notresident       = ds.notresident;
  p.superior          = ds.superior;
  p.change_date       = ds.change_date;
  p.change_dateprev   = ds.change_dateprev;
  p.locked            = ds.locked;
  p.taxinstitution    = ds.taxinstitution;
  p.taxregdate        = ds.taxregdate;
  p.systype           = ds.systype;
  p.usertype          = ds.usertype;
  p.userfield1        = ds.userfield1;
  p.userfield2        = ds.userfield2;
  p.userfield3        = ds.userfield3;
  p.userfield4        = ds.userfield4;
  p.nrcountry         = ds.nrcountry;
  p.consolidaterecord = ds.consolidaterecord;
  p.setaccsearchalg   = ds.setaccsearchalg;
  p.branch            = ds.branch;
  p.numsession        = ds.numsession;
  p.ofshorezone       = ds.ofshorezone;
  p.mainpartyid       = ds.mainpartyid;
  p.isprobdoubler     = ds.isprobdoubler;
  p.isdoubler         = ds.isdoubler;
  p.hasdoubler        = ds.hasdoubler;
  p.paramsetid        = ds.paramsetid;
  //hashvalue   raw
  p.latname           = ds.latname;
  p.cbdk_issynch      = ds.cbdk_issynch;
  p.cbdk_dateupdate   = ds.cbdk_dateupdate;
  p.cbdk_timeupdate   = ds.cbdk_timeupdate;
  p.cbdk_synchinfo    = ds.cbdk_synchinfo;
  p.reserve           = ds.reserve;

  p.partyname         = ds.partyname;
  p.code              = ds.code;
  p.lastchangeddate   = ds.lastchangeddate;
  p.lastchangedtime   = ds.lastchangedtime;
  p.legalimagepath    = ds.legalimagepath;

end;

///
///
///
class TBankruptWarning(_id : integer, _bankruptStatus : integer, _message : string)

    var Id : integer = _id;
    var BankruptStatus : integer = _bankruptStatus;
    var Message : string = _message;
    
end;
///

////////////////////////////////////////////////////////////////////////////////////////////////////////////
// class PartyList
////////////////////////////////////////////////////////////////////////////////////////////////////////////

class PartyList( IsAllParty : bool, IsList : bool )

  var m_IsAllParty : bool;
  var m_IsList : bool;

  if( IsAllParty == null )
    m_IsAllParty = false;
  else
    m_IsAllParty = IsAllParty;
  end;

  if( IsList == null )
    m_IsList = false;
  else
    m_IsList = IsList;
  end;

  macro GetPartySQL(listkind : integer, namekind : integer, codekind, paperkind : integer) : string
    var query = "";

    var stat = true;

    file lst("partylst.dbt");

    lst.Listkind = listkind;

    stat = GetEQ( lst );

    if( stat )

      query =
      "                   SELECT tt.*, " +
      "                          (SELECT ptn.t_name " +
      "                             FROM dpartyname_dbt ptn " +
      "                            WHERE     ptn.t_nametypeid = " + string(namekind) +
      "                                  AND ptn.t_partyid = tt.t_partyid " +
      "                                  AND ROWNUM = 1) " +
      "                             AS T_PartyName, " +
      "                          (SELECT partcode.t_code " +
      "                             FROM "+CU_IIF(lst.Locked == "X", "DPARTCODECLOSED_VIEW", "DPARTCODE_OPENED_VIEW") +" partcode " +
      "                            WHERE     partcode.t_codekind = " + string(codekind) +
      "                                  AND partcode.t_partyid = tt.t_partyid " +
      "                                  AND ROWNUM = 1) " +
      "                             AS T_CODE, " +
      "                          DECODE ( " +
      "                             (SELECT TO_DATE ( " +
      "                                        TO_CHAR ( " +
      "                                           MAX ( " +
      "                                              TO_DATE ( " +
      "                                                    TO_CHAR (t_sysdate, " +
      "                                                             'DDMMYYYY') " +
      "                                                 || TO_CHAR (t_systime, " +
      "                                                             'HH24MISS'), " +
      "                                                 'DDMMYYYYHH24MISS')), " +
      "                                           'DDMMYYYY'), " +
      "                                        'DDMMYYYY') " +
      "                                FROM dptprmhist_dbt " +
      "                               WHERE T_PARTYID = tt.t_partyid), " +
      "                             NULL, TO_DATE ('01010001', 'DDMMYYYYHH24MISS'), " +
      "                             (SELECT TO_DATE ( " +
      "                                        TO_CHAR ( " +
      "                                           MAX ( " +
      "                                              TO_DATE ( " +
      "                                                    TO_CHAR (t_sysdate, " +
      "                                                             'DDMMYYYY') " +
      "                                                 || TO_CHAR (t_systime, " +
      "                                                             'HH24MISS'), " +
      "                                                 'DDMMYYYYHH24MISS')), " +
      "                                           'DDMMYYYY'), " +
      "                                        'DDMMYYYY') " +
      "                                FROM dptprmhist_dbt " +
      "                               WHERE T_PARTYID = tt.t_partyid)) " +
      "                             AS T_LastChangedDate, " +
      "                          (SELECT TO_DATE ( " +
      "                                        '01010001' " +
      "                                     || TO_CHAR ( " +
      "                                           MAX ( " +
      "                                              TO_DATE ( " +
      "                                                    TO_CHAR (t_sysdate, " +
      "                                                             'DDMMYYYY') " +
      "                                                 || TO_CHAR (t_systime, " +
      "                                                             'HH24MISS'), " +
      "                                                 'DDMMYYYYHH24MISS')), " +
      "                                           'HH24MISS'), " +
      "                                     'DDMMYYYYHH24MISS') " +
      "                             FROM dptprmhist_dbt " +
      "                            WHERE T_PARTYID = tt.t_partyid) " +
      "                             AS T_LastChangedTime, " +
      "                          DECODE(tt.t_legalform, 1, '', " +
      "                                                2, '/Resources/Images/Icon85_16.png') AS t_legalimagepath, " +
      "                          (SELECT T_BORN FROM DPERSN_DBT WHERE T_PERSONID = tt.t_partyid) AS born, ";
      if(paperkind < 0)
      
        query = query + " (SELECT DECODE (T_PAPERSERIES, CHR (1), '', T_PAPERSERIES) || DECODE (T_PAPERSERIES, CHR (1), '', ' ') || DECODE (T_PAPERNUMBER, CHR (1), '', T_PAPERNUMBER) FROM DPERSNIDC_DBT WHERE T_PERSONID = tt.t_partyid AND T_ISMAIN = 'X' ) as paperseriesnumber ";      
      
      else
        
        query = query + " (SELECT DECODE (T_PAPERSERIES, CHR (1), '', T_PAPERSERIES) || DECODE (T_PAPERSERIES, CHR (1), '', ' ') || DECODE (T_PAPERNUMBER, CHR (1), '', T_PAPERNUMBER) FROM DPERSNIDC_DBT WHERE T_PERSONID = tt.t_partyid AND T_PAPERKIND = " + string(paperkind) + " ) as paperseriesnumber ";
        
      end;
      
      query = query + 
      " FROM (SELECT ROWNUM RN, AA.* " +
      "    FROM ( SELECT t.* " +
      string(GetPartySQLStr(lst, m_IsAllParty, m_IsList));

    end;

    return query;

  end;

  private macro GetCodeParents( IsGetCodeParents, p, codekind )

    if((IsGetCodeParents == true) AND (p.legalform == 1) AND ((p.code == null) OR (p.code == "")))
        
      var cmd, rs,  flag = false;

      var queryIn ;

      var PartyObj;
    
      queryIn = " SELECT d.t_partyid FROM ddp_dep_dbt d WHERE d.t_partyid != :partyid CONNECT BY d.t_code = PRIOR d.T_PARENTCODE START WITH d.t_partyid = :partyid  ";
      
      cmd = RsdCommand(queryIn);
      
      cmd.addParam( "partyid", RSDBP_IN, p.partyid);

      rs = RsdRecordset(cmd);

      while (rs.movenext)

        PartyObj = RsbParty(SQL_ConvType(rs.value("t_partyid")));
        
        if((PartyObj.Code(codekind) != null) AND (PartyObj.Code(codekind) != ""))
        
          p.code = PartyObj.Code(codekind);
            
          flag = true;
          
          break;
        
        end;
        
        PartyObj = null;

      end; 
    
      if(flag == false)
        
        queryIn = " SELECT p.t_partyid  FROM DPARTY_DBT p WHERE P.T_LEGALFORM = 1 AND P.t_partyid != :partyid CONNECT BY p.t_partyid = PRIOR P.T_SUPERIOR START WITH p.t_partyid = :partyid ";
        
        cmd = RsdCommand(queryIn);
          
        cmd.addParam( "partyid", RSDBP_IN, p.partyid);

        rs = RsdRecordset(cmd);

        while (rs.movenext)

          PartyObj = RsbParty(SQL_ConvType(rs.value("t_partyid")));
        
          if((PartyObj.Code(codekind) != null) AND (PartyObj.Code(codekind) != ""))
          
            p.code = PartyObj.Code(codekind);
            
            break;
          
          end;
          
          PartyObj = null;

        end; 
        
      end;
      
      

    end;
  
  end;
  
  macro GetList(pagesize            : integer,
                pagenum             : integer,
                listkind            : integer,
                namekind            : integer,
                codekind            : integer,
                paperkind           : integer,
                partykindcollection : string,
                filteritems,
                orderitems,
                PartyEx,
                IsGetCodeParents):TArray

    var result = TArray();

    var strAddWhere:string = "";

    var p;

    var query = " select * from (SELECT * FROM ( ";
    
    query = query + GetPartySQL(listkind, namekind, codekind, paperkind);
    
    strAddWhere = GetPartyAddWhereCondition( FilterItems );

    if( strAddWhere != "" )
       query = query + strAddWhere;
    end;

    if( partykindcollection != "" )

      query = query + " AND t.T_PARTYID IN " +
                      " (SELECT PO.T_PARTYID " +
                      " FROM DPARTYOWN_DBT PO " +
                      " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection) + " )) ";

    end;
	
	if( (PartyEx != null) AND (PartyEx.size != 0)  )

	  var i =0;
	  
      query = query + " AND t.T_PARTYID NOT IN (" ;
	  
	  while(i<PartyEx.size)

	    query = query + PartyEx[i];
		
		if(i+1<PartyEx.size)
		
		  query = query +",";
		
		end;
		
		i= i+1;
	  
	  end;
	  
	  query = query + ")"

    end;
    
    query = query + " ORDER BY t.t_partyid ";

    query = query + " ) AA ) tt ";
    

    query = query + " ) ";
    
    if( (orderitems == null) or (OrderItems.Size() > 0) )

      query = query + " ORDER BY " + PT_GetSortStr(orderitems, "");
    
    end;
  
    query = query + " ) ";

    if( pagesize > 0 )
      query = query + " WHERE RN BETWEEN " + string(PageSize*(PageNum) + 1) + " AND " + string(PageSize*(PageNum + 1)) ;
    end;

    PT_PrintDebug( "ws_partylistclass.mac.log", "*** GetList ***");
    PT_PrintDebug( "ws_partylistclass.mac.log", query);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    ds.NullConversion = true;

    while (ds.MoveNext())

      p = TWsPartyEx();

      SetParty(p, ds);

      GetCodeParents(IsGetCodeParents, p, codekind);	
	  

      result.value(result.Size) = p;

    end;

    return result;

  end;

  macro GetCount( listkind            : integer,
                  namekind            : integer,
                  codekind            : integer,
                  partykindcollection : string,
                  filteritems,
                  PartyEx):integer

    var result : integer;
	
    var strAddWhere:string = "";

    var query = "SELECT COUNT(*) C FROM ( ";

    query = query + GetPartySQL(listkind, namekind, codekind, -1);

    strAddWhere = GetPartyAddWhereCondition( FilterItems );

    if( strAddWhere != "" )
      query = query + strAddWhere;
    end;

    if( partykindcollection != "" )

      query = query + " AND t.T_PARTYID IN " +
                      " (SELECT PO.T_PARTYID " +
                      " FROM DPARTYOWN_DBT PO " +
                      " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection) + " )) ";

    end;
	
	if( (PartyEx != null) AND (PartyEx.size != 0)  )

	  var i =0;
	  
      query = query + " AND t.T_PARTYID NOT IN (" ;
	  
	  while(i<PartyEx.size)

	    query = query + PartyEx[i];
		
		if(i+1<PartyEx.size)
		
		  query = query +",";
		
		end;
		
		i= i+1;
	  
	  end;
	  
	  query = query + ")"

    end;

    query = query + " ) AA ) tt ";

    query = query + ")";

    PT_PrintDebug( "ws_partylistclass.mac.log", "*** GetCount ***");
    PT_PrintDebug( "ws_partylistclass.mac.log", query);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    ds.NullConversion = true;

    if (ds.MoveNext())

      result = ds.c;

    end;

    return result;

  end;
  
  macro GetPartySQLold(listkind : integer, namekind : integer, codekind : integer) : string

    var query = "";

    var stat : bool;

    file lst("partylst.dbt");

    lst.Listkind = listkind;

    stat = GetEQ( lst );

    if( stat )

      query =
      "                   SELECT t.*, " +
      "                          (SELECT ptn.t_name " +
      "                             FROM dpartyname_dbt ptn " +
      "                            WHERE     ptn.t_nametypeid = " + string(namekind) +
      "                                  AND ptn.t_partyid = t.t_partyid " +
      "                                  AND ROWNUM = 1) " +
      "                             AS T_PartyName, " +
      "                          (SELECT partcode.t_code " +
      "                             FROM dpartcode_dbt partcode " +
      "                            WHERE     partcode.t_codekind = " + string(codekind) +
      "                                  AND partcode.t_partyid = t.t_partyid " +
      "                                  AND ROWNUM = 1) " +
      "                             AS T_CODE, " +
      "                          (SELECT TO_DATE ( " +
      "                                     TO_CHAR ( " +
      "                                        MAX ( " +
      "                                           TO_DATE ( " +
      "                                                 TO_CHAR (t_sysdate, 'DDMMYYYY') " +
      "                                              || TO_CHAR (t_systime, 'HH24MISS'), " +
      "                                              'DDMMYYYYHH24MISS')), " +
      "                                        'DDMMYYYY'), " +
      "                                     'DDMMYYYY') " +
      "                             FROM dptprmhist_dbt " +
      "                            WHERE T_PARTYID = t.t_partyid) " +
      "                             AS T_LastChangedDate, " +
      "                          (SELECT TO_DATE ( " +
      "                                        '01010001' " +
      "                                     || TO_CHAR ( " +
      "                                           MAX ( " +
      "                                              TO_DATE ( " +
      "                                                    TO_CHAR (t_sysdate, " +
      "                                                             'DDMMYYYY') " +
      "                                                 || TO_CHAR (t_systime, " +
      "                                                             'HH24MISS'), " +
      "                                                 'DDMMYYYYHH24MISS')), " +
      "                                           'HH24MISS'), " +
      "                                     'DDMMYYYYHH24MISS') " +
      "                             FROM dptprmhist_dbt " +
      "                            WHERE T_PARTYID = t.t_partyid) " +
      "                             AS T_LastChangedTime, " +
      "                          DECODE(t.t_legalform, 1, '', " +
      "                                                2, '/Resources/Images/Icon85_16.png') AS t_legalimagepath " +
      string(GetPartySQLStr(lst, m_IsAllParty, m_IsList));

    end;

    return query;

  end;  
  
 macro GetByCheck( listkind            : integer,
				   mode                : integer,
                   namekind            : integer,
                   codeKind            : integer,
                   Str                 : string): bool

    var p=false;
	var query = "";
    var stat = true;

	file lst("partylst.dbt");
    lst.Listkind = listkind;

    stat = GetEQ( lst );
	if( stat )
		query = query +
		" SELECT t.t_partyid " +
		string(GetPartySQLStr(lst, m_IsAllParty, m_IsList))+
		" AND t.t_partyid IN ( ";
		if(mode == 0)

				  query = query + " SELECT partcode.t_partyid " +
								  "  FROM dpartcode_dbt partcode " +
								  " WHERE partcode.t_codekind = " + string(codeKind) +
								  "  AND LOWER (partcode.T_CODE) = LOWER (?) ) ";

		end;

		if(mode == 1)
				
				  query = query + " SELECT ptn.t_partyid " +
								  "  FROM dpartyname_dbt ptn " +
								  " WHERE ptn.t_nametypeid = " + string(namekind) +
								  "  AND LOWER (ptn.T_NAME) = LOWER (?) ) ";

		end;
		
	end;
	PT_PrintDebug( "ws_partylistclass.mac.log", "*** GetByCheck ***");
	PT_PrintDebug( "ws_partylistclass.mac.log", query);
	var cmd = RSDCommand(query);
		
    cmd.addParam( "", RSDBP_IN, Str );		
	cmd.NullConversion = true;		
	cmd.Execute();
		
    var ds = TRsbDataSet( cmd );

    if (ds.MoveNext())

     p=true;

    end;
	
    return p;
	
  end;
	
  
  macro LookUp( mode                : integer,
                listkind            : integer,
                namekind            : integer,
                codeKind            : integer,
                partykindcollection : string,
                sub                 : string,
                listLen             : integer,
                PartyEx ,
                IsGetCodeParents):TArray

    var result = TArray();
    var p;

    var query = " SELECT * FROM ( " + GetPartySQLold(listkind, namekind, codekind);
    
    if(mode == 0)

      query = query + " ORDER BY T_CODE ";

    end;

    if(mode == 1)

      query = query + " ORDER BY T_NAME ";

    end;    
    
    query = query + " ) AA WHERE ";

    if(mode == 0)

      query = query + " LOWER (AA.T_CODE) ";

    end;

    if(mode == 1)

      query = query + " LOWER (AA.T_NAME) ";

    end;

    query = query + " LIKE LOWER ('%' || ? || '%') ";

    if( listLen != 0 )

      query = query + " AND ROWNUM < " + string(listLen);

    end;

    if( partykindcollection != "" )

      query = query + " AND AA.T_PARTYID IN " +
                      " (SELECT PO.T_PARTYID " +
                      " FROM DPARTYOWN_DBT PO " +
                      " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection) + " )) ";

    end;

	if( (PartyEx != null) AND (PartyEx.size != 0)  )

	  var i =0;
	  
      query = query + " AND tt.T_PARTYID NOT IN (" ;
	  
	  while(i<PartyEx.size)
	  
	    i= i+1;
	  
	    query = query + PartyEx[i];
		
		if(i!=PartyEx.size)
		
		  query = query +",";
		
		end;
	  
	  end;
	  
	  query = query + ")"

    end;
    
    var cmd = RSDCommand(query);
    
    cmd.addParam( "", RSDBP_IN, sub );
        
    cmd.NullConversion = true;
    
    cmd.Execute();

    PT_PrintDebug( "ws_partylistclass.mac.log", "*** LookUp ***");
    PT_PrintDebug( "ws_partylistclass.mac.log", cmd.CmdText);    

    var ds = TRsbDataSet( cmd );

    while (ds.moveNext())

      PT_PrintDebug( "ws_partylistclass.mac.log", ds.partyid);
      
      p = TWsPartyEx();

      SetParty_old(p, ds);

      GetCodeParents(IsGetCodeParents, p, codekind);

      result.value(result.Size) = p;

    end;

    return result;

  end;  

  macro WebCore_PT_PartyBankruptWarning(PartyIDList):WebResponseBuilder

    var res = 0;
	
    var BankruptStatus, Message;

    ResponseBuilder = WebResponseBuilder();

    var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
    var i =0;
    var bankruptStatuses = TArray();
    while(i < PartyIDList.size)

      res = PartyBankruptWarning(PartyIDList[i], false, true, @BankruptStatus, @Message );
	
      if(res != 0)
        AddErrorMessage(@ErrorMessage);
      else
        bankruptStatuses[bankruptStatuses.Size] = TBankruptWarning(PartyIDList[i], BankruptStatus, Message);
      end;  
	  
      i=i+1;
	  
    end;
		
    responseBuilder.SetUserObject(bankruptStatuses);
		
    return responseBuilder.Result;
		
  end;
		
  macro WebCore_PT_GetPartybankruptStatus(PartyID, OnDate)

      var res = 0;
        
      if(OnDate == null)
          OnDate = Date;
      end;  
	  
      var BankruptStatus;

      ResponseBuilder = WebResponseBuilder();
      
      var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
        
      var BankruptSts = 0;     

      res = GetPartyBankruptStatus(PartyID, OnDate, BankruptSts);

      if(res != 0)
            AddErrorMessage(@ErrorMessage);        
      else      
           BankruptStatus = CreateLLValueFromAppServ(3564, BankruptSts);
      end;

      responseBuilder.SetUserObject(BankruptStatus);

      return responseBuilder.Result;
  end; 


  macro GetRowNum( partyid             : integer,
                   listkind            : integer,
                   namekind            : integer,
                   codekind            : integer,
                   partykindcollection : string) : integer

    var result = 0;

    var query = GetPartySQL(listkind, namekind, codekind, -1);

    if( partykindcollection != "" )

      query = query + " AND t.T_PARTYID IN " +
                      " (SELECT PO.T_PARTYID " +
                      " FROM DPARTYOWN_DBT PO " +
                      " WHERE PO.T_PARTYKIND IN ( " + string(partykindcollection) + " )) ";

    end;

    query = query + " ORDER BY t.t_partyid ) AA ) tt WHERE 1 = 1 ";

    query = query + " AND tt.t_partyid = " + string(partyid);

    PT_PrintDebug( "ws_partylistclass.mac.log", "*** GetRowNum ***");
    PT_PrintDebug( "ws_partylistclass.mac.log", query);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    ds.NullConversion = true;

    if (ds.MoveNext())

      result = ds.RN;

    end;

    return result;

  end;

end;

/////////////////////////////////////////////////////////////////////////////////////////////////////////
