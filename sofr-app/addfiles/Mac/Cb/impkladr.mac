/*
$Name:        impkladr.mac
$Module:      ГКБО
$Description: Импорт справочников КЛАДР
*/



// Импорт справочников КЛАДР
// А. Новиков, 06.10.2005

import dbf2ora, RSD, cb_sql;

var stat, cmd;
var TxtPath;

GetRegistryValue("CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР", V_STRING, TxtPath, stat);

if( stat != 0 ) 
  MsgBox ("Ошибка чтения настройки CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР"); 
end;

FILE kladr_dbf    ("kladr.dbf"   ) dbf;
FILE street_dbf   ("street.dbf"  ) dbf;
FILE doma_dbf     ("doma.dbf"    ) dbf;
FILE socrbase_dbf ("socrbase.dbf") dbf;
FILE altnames_dbf ("altnames.dbf") dbf;
FILE flat_dbf     ("flat.dbf"    ) dbf;

if( SubStr(TxtPath, strlen(TxtPath)) != "\\" )
  TxtPath = TxtPath + "\\";
end;

if( not OPEN(kladr_dbf, TxtPath+"kladr.dbf"))
  MsgBox ("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл kladr.dbf не может быть открыт!!!"); 
  return 1;
end;

dbf2ora(TxtPath + "kladr.dbf","kladr_dbf");

SQL_Execute("create index kladr_dbf_idx0 on kladr_dbf(t_status)", "Создание индексов...");
SQL_Execute("create index kladr_dbf_idx1 on kladr_dbf(t_code)","Создание индексов...");
SQL_Execute("create index kladr_dbf_idx2 on kladr_dbf(replace(replace(replace(upper(trim(translate(t_name,'AaBCcEeHKkMmOoPpTuXxYy','ААВССЕЕНККМТООРРТИХХУУ'))),' ', ' '||chr(2)),chr(2)||' '),chr(2)))","Создание индексов...");
SQL_Execute("begin dbms_stats.gather_table_stats(ownname=>sys_context('USERENV','SESSION_USER'),tabname=>'KLADR_DBF',estimate_percent=>10); end;","Сбор статистики...");

if( not OPEN(street_dbf, TxtPath+"street.dbf"))
  MsgBox ("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл street.dbf не может быть открыт!!!"); 
  return 1;
end;

dbf2ora(TxtPath + "street.dbf","street_dbf");

SQL_Execute("create index street_dbf_idx0 on street_dbf(t_code)", "Создание индексов...");
SQL_Execute("create index street_dbf_idx1 on street_dbf(substr(t_code,1,15))", "Создание индексов...");
SQL_Execute("create index street_dbf_idx2 on street_dbf(replace(replace(replace(upper(trim(translate(t_name,'AaBCcEeHKkMmOoPpTuXxYy','ААВССЕЕНККМТООРРТИХХУУ'))),' ', ' '||chr(2)),chr(2)||' '),chr(2)))","Создание индексов...");
SQL_Execute("begin dbms_stats.gather_table_stats(ownname=>sys_context('USERENV','SESSION_USER'),tabname=>'STREET_DBF',estimate_percent=>10); end;","Сбор статистики...");

if( not OPEN(doma_dbf, TxtPath+"doma.dbf"))
  MsgBox ("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл doma.dbf не может быть открыт!!!"); 
  return 1;
end;

dbf2ora(TxtPath + "doma.dbf","doma_dbf");

if( not OPEN(socrbase_dbf, TxtPath+"socrbase.dbf"))
  MsgBox ("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл socrbase.dbf не может быть открыт!!!"); 
  return 1;
end;

dbf2ora(TxtPath + "socrbase.dbf","socrbase_dbf");

SQL_Execute("delete from dadmterr_dbt where t_Kladr = chr(88);", "Обновление справочников...");
SQL_Execute("insert into dadmterr_dbt (t_Place, t_NamePlace, t_Kladr) select place, placename, chr(88) from " +
            "  (select distinct(trim(chr(32) from t_scname)) as place, trim(chr(32) from t_socrname) as placename " + 
            "  from socrbase_dbf where (t_level between 1 and 5) and " +
            "    (not trim(chr(32) from t_scname) in (select t_place from dadmterr_dbt)));", "Обновление справочников...");

SQL_Execute("update dadmterr_dbt set t_Kladr = chr(88) " + 
            "where t_Place in (select distinct(trim(chr(32) from t_scname)) from socrbase_dbf);", "Обновление справочников...");

SQL_Execute("update dadmterr_dbt set t_RegionLevel = chr(0), t_ProvinceLevel = chr(0), " + 
            "  t_DistrictLevel = chr(0), t_PlaceLevel = chr(0), t_StreetLevel = chr(0) " + 
            "where t_Kladr = chr(88); ", "Обновление справочников...");

SQL_Execute("update dadmterr_dbt set t_RegionLevel = chr(88) where t_Kladr = chr(88) and (t_Place, t_NamePlace) in (select distinct(trim(chr(32) from t_scname)), trim(chr(32) from t_socrname) from socrbase_dbf where t_level = 1);", "Обновление справочников...");
SQL_Execute("update dadmterr_dbt set t_ProvinceLevel = chr(88) where t_Kladr = chr(88) and (t_Place, t_NamePlace) in (select distinct(trim(chr(32) from t_scname)), trim(chr(32) from t_socrname) from socrbase_dbf where t_level = 2);", "Обновление справочников...");
SQL_Execute("update dadmterr_dbt set t_DistrictLevel = chr(88) where t_Kladr = chr(88) and (t_Place, t_NamePlace) in (select distinct(trim(chr(32) from t_scname)), trim(chr(32) from t_socrname) from socrbase_dbf where t_level = 3);", "Обновление справочников...");
SQL_Execute("update dadmterr_dbt set t_PlaceLevel = chr(88) where t_Kladr = chr(88) and (t_Place, t_NamePlace) in (select distinct(trim(chr(32) from t_scname)), trim(chr(32) from t_socrname) from socrbase_dbf where t_level = 4);", "Обновление справочников...");
SQL_Execute("update dadmterr_dbt set t_StreetLevel = chr(88) where t_Kladr = chr(88) and (t_Place, t_NamePlace) in (select distinct(trim(chr(32) from t_scname)), trim(chr(32) from t_socrname) from socrbase_dbf where t_level = 5);", "Обновление справочников...");

if( not OPEN(altnames_dbf, TxtPath+"altnames.dbf"))
  MsgBox ("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл altnames.dbf не может быть открыт!!!"); 
  return 1;
end;

dbf2ora(TxtPath + "altnames.dbf","altnames_dbf");

if( not OPEN(flat_dbf, TxtPath+"flat.dbf"))
  MsgBox ("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл flat.dbf не может быть открыт!!!"); 
  return 1;
end;

dbf2ora(TxtPath + "flat.dbf","flat_dbf");
