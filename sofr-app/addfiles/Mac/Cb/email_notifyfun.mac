/*
$Name:        email_notifyfun.mac
$Module:      Главная книга
$Description: Функции для отправки уведомлений по электронной почте.
*/
/*
Изменения:
   Добавлены пользовательские расширения функционала.
   При изменении исходного макроса, необходимо выполнить актуализацию!
*/


import or_tools, oralib, likepy, commonutil, globals, "MoCommon.mac", DealsInter;
Import osfile, "dlutils.mac";
//import "secinter.mac"; !!!Не должно быть тут специфичных макросов Дилинга иначе переопределяются глобальные константы SET_CHAR
//Import SbCrdInter; ВР. Использовался для sleep(). Заменено на RslWait()

private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
end;

private const OBJTYPE_ATTACHEMAIL = 318; /*318 - distr*/

PRIVATE MACRO processPath( p_path )
  var l_str, l_p, l_path = "";

  p_path = trim( p_path );

  if( substr( p_path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
   p_path = substr( p_path, 3 );

   l_str  = getCWD(false);    
   l_p    = strbrk( l_str, "\\" );
   while( l_p != 0 )
    l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
    l_str  = substr( l_str, l_p + 1 );
    l_p    = strbrk( l_str, "\\" );
   end;
   return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

  elif( substr( p_path, 1, 1 ) == "." ) /* ссылка на текущий каталог */
   return ( getCWD + substr( p_path, 2 ) );
  end;

  return p_path;
END;

private macro SplitEmailString(emailString: @String): String
   var result = "";
   var commaPos = StrBrk(emailString, ",");
   var semicolonPos = StrBrk(emailString, ";");

   if(StrLen(Trim(emailString)) == 0)
      return null;
   end;

   if((commaPos == 0) and (semicolonPos == 0))
      result = Trim(emailString);
      emailString = "";
   elif(commaPos == 0)
      result = Trim(SubStr(emailString, 1, semicolonPos - 1));
      emailString = Trim(SubStr(emailString, semicolonPos + 1));
   elif(semicolonPos == 0)
      result = Trim(SubStr(emailString, 1, commaPos - 1));
      emailString = Trim(SubStr(emailString, commaPos + 1));
   elif(commaPos < semicolonPos)
      result = Trim(SubStr(emailString, 1, commaPos - 1));
      emailString = Trim(SubStr(emailString, commaPos + 1));
   else
      result = Trim(SubStr(emailString, 1, semicolonPos - 1));
      emailString = Trim(SubStr(emailString, semicolonPos + 1));
   end;

   return result;
end;

private macro Contains(list: TArray, s: String): Bool
   for (var s0, list)
      if (s0 == s)
         return true;
      end;
   end;
   return false;
end;

private macro GetEmailList(emailString: String, emailList: TArray): TArray
   if (emailList == null)
      emailList = TArray();
   end;
    
   while (true)
      var email = splitEmailString(@emailString);
      if (email == null)
         break;
      end;
      if (email != "")
         if (not contains(emailList, email))
             emailList(emailList.size) = email;
         end;
      end;
   end;
    
   return emailList;
end;

private macro GetConcatenatedEmails(emailList: TArray): TArray
   var ccEmailList = TArray();
   var ccEmail = "";

   for (var email, emailList)
      if (StrLen(email) > 2000)
         continue;
      end;
      if ((StrLen(ccEmail) + StrLen(email)) < 1999)
         if (StrLen(ccEmail) > 0)
            ccEmail = ccEmail + ";" + email;
         else
            ccEmail = email;
         end;
      else
         ccEmailList(ccEmailList.size) = ccEmail;
         ccEmail = email;
      end;
   end;

   if (StrLen(ccEmail) > 0)
      ccEmailList(ccEmailList.size) = ccEmail;
   end;

   return ccEmailList;
end;

// Добавить уведомление для отправки в БД
MACRO AddNotifyToDbt(head: String, text: String, emailList, attachList, emailListCC, emailListBCC )

   var isAttach = false;
   var isMail   = false;
   var isCC     = false;
   var isBCC    = false;
   var count = 0, countM = 0, countCC = 0, countBCC = 0, i = 0;
   var cEmailList, cEmailListCC, cEmailListBCC;
   var emails, emailsCC, emailsBCC;
   if ((emailList != null) and
       ((ValType(emailList) == V_GENOBJ) and (emailList.size != 0)) or
        ((ValType(emailList) == V_STRING) and (emailList != "")))
         isMail = true;
   end;
   if ((emailListCC != null) and
       ((ValType(emailListCC) == V_GENOBJ) and (emailListCC.size != 0)) or
        ((ValType(emailListCC) == V_STRING) and (emailListCC != "")))
         isCC = true;
   end;
   if ((emailListBCC != null) and
       ((ValType(emailListBCC) == V_GENOBJ) and (emailListBCC.size != 0)) or
        ((ValType(emailListBCC) == V_STRING) and (emailListBCC != "")))
         isBCC = true;
   end;
   if( ( isMail == false ) and ( isCC == false ) and ( isBCC == false ) )  // если нет ни одного адреса
     return;
   end;

   if ((attachList != null) and
       ((ValType(attachList) == V_GENOBJ) and (attachList.size != 0)) or
        ((ValType(attachList) == V_STRING) and (attachList != "")))
         isAttach = true;
   end;

   var aEmailList;
   if(isMail)
      if(ValType(emailList) == V_STRING)
         aEmailList = GetEmailList(emailList);
      else
         aEmailList = emailList;
      end;
      cEmailList = getConcatenatedEmails(aEmailList);
      countM = cEmailList.size;
   end;
   var aEmailListCC;
   if(isCC)
      if(ValType(emailListCC) == V_STRING)
         aEmailListCC = GetEmailList(emailListCC);
      else
         aEmailListCC = emailListCC;
      end;
      cEmailListCC = getConcatenatedEmails(aEmailListCC);
      countCC = cEmailListCC.size;
   end;
   var aEmailListBCC;
   if(isBCC)
      if(ValType(emailListBCC) == V_STRING)
         aEmailListBCC = GetEmailList(emailListBCC);
      else
         aEmailListBCC = emailListBCC;
      end;
      cEmailListBCC = getConcatenatedEmails(aEmailListBCC);
      countBCC = cEmailListBCC.size;
   end;
   if(countM > countCC)
      count = countM;
   else 
      count = countCC;
   end;
   if(countBCC > count)
      count = countBCC;
   end;

   /*<bpv оборачиваем в транзакцию, чтобы наше сообщение никто не увел раньше времени*/
   RslDefCon.BeginTrans();
   /*>bpv*/

   var query = "INSERT INTO DEMAIL_NOTIFY2_DBT (" +
               "    T_DATEADD, " +
               "    T_EMAIL, " +
               "    T_EMAIL_CC, " +
               "    T_EMAIL_BCC, " +
               "    T_HEAD, " +
               "    T_TEXT " +
          //     "    T_ISSEND " + /* bpv попытка отловить ошибку массовой рассылки. Сначала ставим признак, что отправлено, потом загрузим атач и потом снимем признак*/
               ") VALUES (SYSDATE, ?, ?, ?, ?, ?)" +
               " returning T_ID into ? "   
                ;

//   var queryissend = " update DEMAIL_NOTIFY2_DBT set t_issend = chr(0) where t_id = ?";

   while (count > 0)
      if(countM > 0)
        emails = cEmailList[i];
      else
        emails = "";
      end;

      if(countCC > 0)
        emailsCC = cEmailListCC[i];
      else
        emailsCC = "";
      end;

      if(countBCC > 0)
        emailsBCC = cEmailListBCC[i];
      else
        emailsBCC = "";
      end;

      var params = makeArray(
              SQLParam("T_EMAIL", emails),
              SQLParam("T_EMAIL_CC", emailsCC),
              SQLParam("T_EMAIL_BCC", emailsBCC),
              SQLParam("T_HEAD", head),
              SQLParam("T_TEXT", text),
            //  SQLParam("T_ISSEND", StrFor(88)),/*bpv*/
              SQLParam("T_ID", V_INTEGER, RSDBP_OUT)  // value(3)
                      );
      execSQL(query, params, true);
      var MailID = params.value(5).value;/*bpv 5 на 6*/
//      if (isAttach)
//         for (var attach, attachList)
//            if( not LoadImageObj(attach, OBJTYPE_ATTACHEMAIL, L_Z( MailID /*m_RS.FIID*/, 10 ), 1) );
//               MsgBox("К записи о сообщении не удалось прикрепить файл сообщения");
//            end;
//         end;
//      end;
      /*>bpv*/
    /*  var paramsissend = makeArray(
              SQLParam("T_ID", MailID));
      execSQL(queryissend, paramsissend, true);
      */
      /*<bpv*/
      count    = count - 1;
      countM   = countM - 1;
      countCC  = countCC - 1;
      countBCC = countBCC - 1;
      i= i + 1;
   end;

   /*>bpv*/
   RslDefCon.CommitTrans();
   /*<bpv*/

END;

// AddNotifyToDbt в автономной транзакции
// Вызывается из сишника!!!
MACRO AddNotifyToDbtAtnm(head: String, text: String, emailList)
   if ((emailList == null) or
       ((ValType(emailList) == V_GENOBJ) and (emailList.size == 0)) or
        ((ValType(emailList) == V_STRING) and (emailList == "")))
      return;
   end;

   var aEmailList;
   if(ValType(emailList) == V_STRING)
      aEmailList = GetEmailList(emailList);
   else
      aEmailList = emailList;
   end;

   var cEmailList = getConcatenatedEmails(aEmailList);
   var query = 
            " DECLARE  "
            "   PRAGMA AUTONOMOUS_TRANSACTION; "
            " BEGIN "
               "INSERT INTO DEMAIL_NOTIFY2_DBT (" +
               "    T_DATEADD, " +
               "    T_EMAIL, " +
               "    T_HEAD, " +
               "    T_TEXT " +
               ") VALUES (SYSDATE, ?, ?, ?); "
               "COMMIT; "
            " END;";
   for (var emails, cEmailList)
      var params = makeArray(
              SQLParam("T_EMAIL", emails),
              SQLParam("T_HEAD", head),
              SQLParam("T_TEXT", text));
      execSQL(query, params, true);
   end;
END;

private macro GetPartyShortName( PartyID : integer ) : string
   var select : string = "select t_ShortName "
                         "  from dparty_dbt "
                         " where t_PartyID = :PartyID";
 
   var params : TArray = TArray();
   params[params.size] = SQLParam( "PartyID", PartyID );
 
   var rset : RsdRecordset = execSQLselect( select, params );
   if( rset AND rset.moveNext() )
      return rset.Value( 0 );
   else
      return "";
   end;
end;

private macro GetStringRegValue(RegName:string)
   var RegistryPath = "COMMON\\EMAIL\\" + RegName;
   var str = "";
   var stat = 0;

   GetRegistryValue(RegistryPath, V_STRING, str, stat);
   if(stat)
      msgbox("Не найдена настройка в реестре банка:", RegistryPath);
   elif(str == "")
      msgbox("Не задано значение настройки:", RegistryPath);
   end;

   return str;
end;

//SMTP-сервер для отправки почты 
private macro GetMailSMTPServer()
   return GetStringRegValue("MAIL_SMTPSERVER");
end;

//Логин для доступа к почтовому серверу (e-mail, с которого выполняется отправка) 
private macro GetMailUserName()
   return GetStringRegValue("MAIL_USERNAME");
end;

//Пароль для доступа к почтовому серверу 
private macro GetMailUserPassword()
   return GetStringRegValue("MAIL_PASSWORD");
end;

//Порт SMTP-сервера
private macro GetMailServerPort()
   var RegistryPath = "COMMON\\EMAIL\\MAIL_SERVERPORT";
   var val = 0;
   var stat = 0;
  
   GetRegistryValue(RegistryPath, V_INTEGER, val, stat);
   if(stat) 
      msgbox("Не найдена настройка в реестре банка:", RegistryPath);      
   elif(val <= 0)
      msgbox("Не задано значение настройки:", RegistryPath);
   end;
 
   return val;
end;

//Используется ли шифрование на SMTP-сервере?
private macro GetMailUseSSL()
   var RegistryPath = "COMMON\\EMAIL\\MAIL_USESSL";
   var val = false;
   var stat = 0;
   
   GetRegistryValue(RegistryPath, V_BOOL, val, stat);
   if(stat) 
      msgbox("Не найдена настройка в реестре банка:", RegistryPath);      
   end;
 
   return val;
end;

//Используется ли аутентификация на SMTP-сервере?
private macro GetMailUseSmtpAuth()
   var RegistryPath = "COMMON\\EMAIL\\MAIL_USESMTPAUTH";
   var val = false;
   var stat = 0;
   
   GetRegistryValue(RegistryPath, V_BOOL, val, stat);
   if(stat) 
      msgbox("Не найдена настройка в реестре банка:", RegistryPath);      
   end;
 
   return val;
end;

// Прочитать CLOB  
private macro GetClobData(ID:integer, LengthClob:integer)
   var dataSetLength;
   var Amount = 32000;
   var Offset = 0;
   var Data = "";

   if(LengthClob > 0)
      while((LengthClob - Offset * Amount) > 0)
         var cmd = RSDCommand( " DECLARE  "
                              +"  v_clobData CLOB; "
                              +"  v_amount INTEGER := " + String(Amount) + "; "
                              +"  v_buffer VARCHAR2(" +String(Amount) + "); "
                              +" BEGIN "
                              +"   select T_TEXT into v_clobData FROM DEMAIL_NOTIFY_DBT WHERE T_ID = ?;"
                              +"   DBMS_LOB.READ(v_clobData, v_amount, " + String(Offset * Amount + 1) + ", v_buffer);"
                              +"   ? := v_buffer; "
                              +" END;");

         cmd.addParam("", RSDBP_IN, ID );
         cmd.addParam("", RSDBP_OUT, V_STRING, Amount + 1);
         cmd.execute();
         Data = Data + cmd.value(1);
         Offset = Offset + 1;
      end;
   end;

   return Data;
end;


// Прочитать CLOB 2
private macro GetClobData2(ID:integer, LengthClob:integer)
   var dataSetLength;
   var Amount = 32000;
   var Offset = 0;
   var Data = "";

   if(LengthClob > 0)
      while((LengthClob - Offset * Amount) > 0)
         var cmd = RSDCommand( " DECLARE  "
                              +"  v_clobData CLOB; "
                              +"  v_amount INTEGER := " + String(Amount) + "; "
                              +"  v_buffer VARCHAR2(" +String(Amount) + "); "
                              +" BEGIN "
                              +"   select T_TEXT into v_clobData FROM DEMAIL_NOTIFY2_DBT WHERE T_ID = ?;"
                              +"   DBMS_LOB.READ(v_clobData, v_amount, " + String(Offset * Amount + 1) + ", v_buffer);"
                              +"   ? := v_buffer; "
                              +" END;");

         cmd.addParam("", RSDBP_IN, ID );
         cmd.addParam("", RSDBP_OUT, V_STRING, Amount + 1);
         cmd.execute();
         Data = Data + cmd.value(1);
         Offset = Offset + 1;
      end;
   end;

   return Data;
end;


PRIVATE MACRO GetFullPath(txtPath)
  var Path = "";
  if( substr( txtPath, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
    txtPath = substr(txtPath, 3 );
  end;

  if( substr( txtPath, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
    txtPath = substr(txtPath, 2 );
  end;

  Path = GetCurDir(true) + "\\" + txtPath ; 

  // получить полный путь
  return Path;
END;

// Отправить уведомления
// fromCnv - запуск из конвейера
// interface_mode - интерфейсный режим
MACRO SendNotyfyToEmail(fromCnv:bool, interface_mode:bool)
   var err = 0, errMes = "", query, ID, IsSend, text_body;
   var OldDialogFlag = SetDialogFlag(CU_IIF(interface_mode, 1, 0));

   var SMTPServer   = GetMailSMTPServer();
   var UserName     = GetMailUserName();
   var UserPassword = GetMailUserPassword();
   var ServerPort   = GetMailServerPort();
   var UseSSL       = GetMailUseSSL();
   var UseSmtpAuth  = GetMailUseSmtpAuth();
    
   macro SendNotyfy(fromCnv, rs, text_body, errMes:@String)
      var stat = 0, email = NULL, ax = NULL;
    

      var jvm = createObject( "rsjvm", "TJavaHost" );
      var RsMail = jvm.CreateJavaObject( "ru.softlab.core.mail.RsMail", "<init>" );

      if(RsMail != NULL)
         var StrUseSSL = "";
         if(UseSSL)
           StrUseSSL = "X";
         end;

         var StrUseSmtpAuth = "";
         if(UseSmtpAuth)
           StrUseSmtpAuth = "X";
         end;

         RsMail.Sender(UserName, UserPassword, SMTPServer, ServerPort, StrUseSSL, StrUseSmtpAuth);
         RsMail.ClearListAttach();

         var email_from = UserName;
         var email_from_name = GetPartyShortName({OurBank});
         var email_to       = rs.value("t_Email");
         var email_subject  = rs.value("t_Head");
         var email_cc       = rs.value("t_Email_cc"); 
         var email_bcc      = rs.value("t_Email_bcc"); 

    //  приклепление файлов
         var fullname = "", FullPath = "", tmpDir = "";
         var ImageID = 0;
         var codeID = L_Z( rs.value("t_ID") , 10 );

         var queryImg = " select d.t_imageid "
                        "  , d.t_filename "
                        "  from dimgdata_dbt d "
                        " where "
                        "  d.t_imagetype = 1 " 
                        "  and d.t_objecttype  = " + OBJTYPE_ATTACHEMAIL +
                        "  and d.t_objectid = '" + codeID  + "'" +
                        "  and d.t_closedate = TO_DATE ('01010001', 'DDMMYYYY') ORDER BY d.t_IsMain desc ";
        
         var ds = TRsbDataSet(queryImg);
        
         while( ds.MoveNext() )
           fullname = "";
           ImageID = 0;
           FullPath = "";
           tmpDir = "";
           ImageID = ds.ImageID;
           WEB_ShowImageByID(ImageID, @fullname);
           FullPath = processPath(fullname) ;
           RsMail.AddAttachment(FullPath);
         end;

        if(not err )
          stat = RsMail.Send(email_subject, text_body, email_from, email_from_name, email_to, email_bcc, email_cc);
        end;

      else
         stat = 1;
      end;

      return stat;
   OnError(er)
      stat = 1;
      if(IsEqClass("TRsComErr", er.err))
         errMes = "Ошибка при отправке: " + er.err.Message(1);
      elif(er.AxCode)
         errMes = "Ошибка при отправке: " + er.AxMes;
      end;
   
      if(errMes == "")
        errMes = er.module+ " "+er.line+" "+er.message;
      end;

      return stat;
   end;

   if((SMTPServer != "") and 
//      (UserName != "") and
//      (UserPassword != "") and
      (ServerPort > 0)
     )
     // отберем уведомления для отправки
      query = "SELECT T_ID, T_EMAIL, T_EMAIL_CC, T_EMAIL_BCC, T_HEAD, NVL(DBMS_LOB.GETLENGTH(T_TEXT), 0) AS T_LENGTHCLOB " +
              "  FROM DEMAIL_NOTIFY2_DBT " +
              " WHERE T_ISSEND = CHR(0) " +
              "ORDER BY T_DATEADD FOR UPDATE";
      var rs = execSQLselect( query );
      while( rs AND rs.moveNext() )
         err = 0; errMes = ""; IsSend = "chr(0)";
         ID = int(rs.Value("T_ID"));
         text_body = GetClobData2(ID, int(rs.Value("T_LENGTHCLOB")));
         // отправим
         err = SendNotyfy(fromCnv, rs, text_body, @errMes);//bpv на тесте отключаем ! 
         if( (not err) and (errMes == "") )
            IsSend = "chr(88)";
         end;
         // обновим статус
         errMes = SubStr(errMes,1,200);
         query = "UPDATE DEMAIL_NOTIFY2_DBT SET " +
                 "    T_DATESEND = SYSDATE, " +
                 "    T_ISSEND = "+IsSend+", " +
                 "    T_ERROR = '"+errMes+"' " +
                 " WHERE T_ID = ?";
         var params = makeArray(SQLParam("T_ID", ID));
         execSQL(query, params, true);

         RslWait(1000);
      end;
   end;

   SetDialogFlag(OldDialogFlag);
END;



// Тестовые настройки (в банке будет свой почтовый сервер):
//   MAIL_SMTPSERVER: smtp.mail.ru
//   MAIL_SERVERPORT: 465
//   MAIL_USESSL:     YES
//   MAIL_USERNAME:   <почта на mail.ru>
//   MAIL_PASSWORD:   <логин от почты>

//AddNotifyToDbt("Заголовок 1", "Сообщение 1", "test@bryansk.softlab.ru");
//SendNotyfyToEmail(false, true);


/*-----------------------------------------*/
/* !!! - Пользовательские расширения - !!! */
/*-----------------------------------------*/
/* При изменении дистрибутивного макроса   */
/* необходим анализ и актуализация         */
/*-----------------------------------------*/

// Добавить уведомление для отправки в БД
MACRO u_AddNotifyToDbt_w_mode(isHtml, head: String, text: String, emailList, attachList, emailListCC, emailListBCC, p_send_mode )
   var v_ret_id_list = TArray(); /* Список идентификаторов вставленных записей */
   var v_send_mode = ""; /* Значение, которое будет записано в t_issend (если пустая строка, то сохраняем chr(0)) */

   var isAttach = false;
   var isMail   = false;
   var isCC     = false;
   var isBCC    = false;
   var count = 0, countM = 0, countCC = 0, countBCC = 0, i = 0;
   var cEmailList, cEmailListCC, cEmailListBCC;
   var emails, emailsCC, emailsBCC;

   if(ValType(isHtml) != V_BOOL)
      isHtml = false;
   end;

   if(ValType(p_send_mode) != V_UNDEF)
      v_send_mode = substr(string(p_send_mode), 1, 1);
   end;

   if ((emailList != null) and
       ((ValType(emailList) == V_GENOBJ) and (emailList.size != 0)) or
        ((ValType(emailList) == V_STRING) and (emailList != "")))
         isMail = true;
   end;
   if ((emailListCC != null) and
       ((ValType(emailListCC) == V_GENOBJ) and (emailListCC.size != 0)) or
        ((ValType(emailListCC) == V_STRING) and (emailListCC != "")))
         isCC = true;
   end;
   if ((emailListBCC != null) and
       ((ValType(emailListBCC) == V_GENOBJ) and (emailListBCC.size != 0)) or
        ((ValType(emailListBCC) == V_STRING) and (emailListBCC != "")))
         isBCC = true;
   end;
   if( ( isMail == false ) and ( isCC == false ) and ( isBCC == false ) )  // если нет ни одного адреса
     return;
   end;

   if ((attachList != null) and
       ((ValType(attachList) == V_GENOBJ) and (attachList.size != 0)) or
        ((ValType(attachList) == V_STRING) and (attachList != "")))
         isAttach = true;
   end;

   var aEmailList;
   if(isMail)
      if(ValType(emailList) == V_STRING)
         aEmailList = GetEmailList(emailList);
      else
         aEmailList = emailList;
      end;
      cEmailList = getConcatenatedEmails(aEmailList);
      countM = cEmailList.size;
   end;
   var aEmailListCC;
   if(isCC)
      if(ValType(emailListCC) == V_STRING)
         aEmailListCC = GetEmailList(emailListCC);
      else
         aEmailListCC = emailListCC;
      end;
      cEmailListCC = getConcatenatedEmails(aEmailListCC);
      countCC = cEmailListCC.size;
   end;
   var aEmailListBCC;
   if(isBCC)
      if(ValType(emailListBCC) == V_STRING)
         aEmailListBCC = GetEmailList(emailListBCC);
      else
         aEmailListBCC = emailListBCC;
      end;
      cEmailListBCC = getConcatenatedEmails(aEmailListBCC);
      countBCC = cEmailListBCC.size;
   end;
   if(countM > countCC)
      count = countM;
   else 
      count = countCC;
   end;
   if(countBCC > count)
      count = countBCC;
   end;

   var query;

   if(v_send_mode == "")
      query = "INSERT INTO DEMAIL_NOTIFY_DBT (" +
              "    T_DATEADD, " +
              "    T_EMAIL, " +
              "    T_EMAIL_CC, " +
              "    T_EMAIL_BCC, " +
              "    T_HEAD, " +
              "    T_ISHTML, " +
              "    T_TEXT " +
              ") VALUES (SYSDATE, ?, ?, ?, ?, ?, ?)" +
              " returning T_ID into ? "   
               ;
   else
      query = "INSERT INTO DEMAIL_NOTIFY_DBT (" +
              "    T_DATEADD, " +
              "    T_EMAIL, " +
              "    T_EMAIL_CC, " +
              "    T_EMAIL_BCC, " +
              "    T_HEAD, " +
              "    T_ISHTML, " +
              "    T_TEXT, " +
              "    T_ISSEND " +
              ") VALUES (SYSDATE, ?, ?, ?, ?, ?, ?, ?)" +
              " returning T_ID into ? "   
               ;
   end;

   while (count > 0)
      if(countM > 0)
        emails = cEmailList[i];
      else
        emails = "";
      end;

      if(countCC > 0)
        emailsCC = cEmailListCC[i];
      else
        emailsCC = "";
      end;

      if(countBCC > 0)
        emailsBCC = cEmailListBCC[i];
      else
        emailsBCC = "";
      end;

      var params;

      if(v_send_mode == "")
         params = makeArray(
            SQLParam("T_EMAIL", emails),
            SQLParam("T_EMAIL_CC", emailsCC),
            SQLParam("T_EMAIL_BCC", emailsBCC),
            SQLParam("T_HEAD", head),
            SQLParam("T_ISHTML", IIF(isHtml,"X","")),
            SQLParam("T_TEXT", text),
            SQLParam("T_ID", V_INTEGER, RSDBP_OUT)  // value(6)
                           );
      else
         params = makeArray(
            SQLParam("T_EMAIL", emails),
            SQLParam("T_EMAIL_CC", emailsCC),
            SQLParam("T_EMAIL_BCC", emailsBCC),
            SQLParam("T_HEAD", head),
            SQLParam("T_ISHTML", IIF(isHtml,"X","")),
            SQLParam("T_TEXT", text),
            SQLParam("T_ISSEND", v_send_mode),
            SQLParam("T_ID", V_INTEGER, RSDBP_OUT)  // value(7)
                           );
      end;
      execSQL(query, params, true);
      var MailID;
      if(v_send_mode == "")
         MailID = params.value(6).value;
         /* Сохраняем для возврата из функции */
         v_ret_id_list.value(v_ret_id_list.size) = params.value(6).value;
      else
         MailID = params.value(7).value;
         /* Сохраняем для возврата из функции */
         v_ret_id_list.value(v_ret_id_list.size) = params.value(7).value;
      end;

      if (isAttach)
         for (var attach, attachList)
            if( not LoadImageObj(attach, OBJTYPE_ATTACHEMAIL, L_Z( MailID /*m_RS.FIID*/, 10 ), 1) );
               MsgBox("К записи о сообщении не удалось прикрепить файл сообщения");
            end;
         end;
      end;
      count    = count - 1;
      countM   = countM - 1;
      countCC  = countCC - 1;
      countBCC = countBCC - 1;
      i= i + 1;
   end;

   /* Возвращаем список идентификаторов писем */
   return v_ret_id_list;
END;


// Отправить уведомления
// fromCnv - запуск из конвейера
// interface_mode - интерфейсный режим
MACRO u_SendNotyfyToEmail(fromCnv:bool, interface_mode:bool, p_send_list)

return; //maa230519 временно из за локов
   const VC_LETTER_ID_PRM = "p_letter_id_";
   const VC_LETTER_PROC_MARK = "P"; /* Метка для t_issend - запись в процессе обработки (для асинхронного режима) */
   const VC_SUBMIT_PERIOD_SYNCH = 10; /* Количество минут, после которого письма из синхронной обработки начинают отправляться в асинхронном режиме */
   const VC_SUBMIT_PROC_MSG = 20; /* Количество минут, после которого письма, взятые в обработку, начинают отправляться повторно */
   const VC_VERSION_ERR = 10; /* Значение t_version, после которого письма перестают попадать в обработку */
   var v_sql;
   var v_cmd = NULL;
   var v_aux_cntr;
   var v_query_part;

   var err = 0, errMes = "", query, ID, IsSend, text_body;
   var OldDialogFlag = SetDialogFlag(CU_IIF(interface_mode, 1, 0));

   var SMTPServer   = GetMailSMTPServer();
   var UserName     = GetMailUserName();
   var UserPassword = GetMailUserPassword();
   var ServerPort   = GetMailServerPort();
   var UseSSL       = GetMailUseSSL();
   var UseSmtpAuth  = GetMailUseSmtpAuth();

   macro SendNotyfy(fromCnv, rs, text_body, errMes:@String)
      var stat = 0, email = NULL, ax = NULL;

      var jvm = createObject( "rsjvm", "TJavaHost" );
      var RsMail = jvm.CreateJavaObject( "ru.softlab.core.mail.RsMail", "<init>" );

      if(RsMail != NULL)
         var StrUseSSL = "";
         if(UseSSL)
           StrUseSSL = "X";
         end;

         var StrUseSmtpAuth = "";
         if(UseSmtpAuth)
           StrUseSmtpAuth = "X";
         end;

         RsMail.Sender(UserName, UserPassword, SMTPServer, ServerPort, StrUseSSL, StrUseSmtpAuth);
         RsMail.ClearListAttach();

         var email_from = UserName;
         var email_from_name = GetPartyShortName({OurBank});
         var email_to       = rs.value("t_Email");
         var email_subject  = rs.value("t_Head");
         var email_cc       = rs.value("t_Email_cc"); 
         var email_bcc      = rs.value("t_Email_bcc"); 

    //  приклепление файлов
         var fullname = "", FullPath = "", tmpDir = "";
         var ImageID = 0;
         var codeID = L_Z( rs.value("t_ID") , 10 );

         var queryImg = " select d.t_imageid "
                        "  , d.t_filename "
                        "  from dimgdata_dbt d "
                        " where "
                        "  d.t_imagetype = 1 " 
                        "  and d.t_objecttype  = " + OBJTYPE_ATTACHEMAIL +
                        "  and d.t_objectid = '" + codeID  + "'" +
                        "  and d.t_closedate = TO_DATE ('01010001', 'DDMMYYYY') ORDER BY d.t_IsMain desc ";
        
         var ds = TRsbDataSet(queryImg);
        
         while( ds.MoveNext() )
           fullname = "";
           ImageID = 0;
           FullPath = "";
           tmpDir = "";
           ImageID = ds.ImageID;
           WEB_ShowImageByID(ImageID, @fullname);
           FullPath = processPath(fullname) ;
           stat = RsMail.Send(email_subject, text_body, email_from, email_from_name, email_to, email_bcc, email_cc);
         end;

        if(not err )
          email.send;
        end;

      else
         stat = 1;
      end;

      return stat;
   OnError(er)
      stat = 1;
      if(IsEqClass("TRsComErr", er.err))
         errMes = "Ошибка при отправке: " + er.err.Message(1);
      elif(er.AxCode)
         errMes = "Ошибка при отправке: " + er.AxMes;
      end;
   
      if(errMes == "")
        errMes = er.module+ " "+er.line+" "+er.message;
      end;

      return stat;
   end;


   if((SMTPServer != "") and
//      (UserName != "") and
//      (UserPassword != "") and
      (ServerPort > 0)
     )
      var rs;

      // отберем уведомления для отправки
      if(ValType(p_send_list) == V_UNDEF)
         v_sql =         "DECLARE ";
         v_sql = v_sql + "    v_proc_mark CHAR(1 char) := :p_proc_mark; ";
         v_sql = v_sql + "BEGIN ";
         v_sql = v_sql + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE demail_notify_tmp'; ";

         v_sql = v_sql + "    INSERT INTO demail_notify_tmp (t_id, t_dateadd, t_datesend, t_issend, t_error) ";
         v_sql = v_sql + "                           (SELECT t_id, t_dateadd, t_datesend, t_issend, t_error ";
         v_sql = v_sql + "                              FROM demail_notify_dbt ";
         v_sql = v_sql + "                             WHERE (t_issend = CHR(0) ";
         v_sql = v_sql + "                                OR (((t_issend NOT IN (CHR(88), v_proc_mark)) OR (t_issend IS NULL)) ";
         /* !!! - ВНИМАНИЕ! Предполагается, что в случае "синхронной" отправки письмо должно уйти за указанное количество минут - !!! */
         /* !!! - Если письмо за это время не ушло, то будет предпринята попытка отправки в обычном режиме - !!! */
         v_sql = v_sql + "                                    AND T_DATEADD < (SYSDATE - NUMTODSINTERVAL(:p_submit_period_synch, 'MINUTE'))) ";
         v_sql = v_sql + "                                OR (t_issend = v_proc_mark ";
         v_sql = v_sql + "                                    AND T_DATESEND < (SYSDATE - NUMTODSINTERVAL(:p_submit_proc_msg, 'MINUTE')))) ";
         /* !!! - Возможно, стоит вынести в виде настройки - !!! */
         /* !!! - То же значение используется и в ws_check_job.mac - !!! */
         v_sql = v_sql + "                               AND T_VERSION < :p_version_err); ";

         v_sql = v_sql + "    UPDATE demail_notify_dbt ";
         v_sql = v_sql + "       SET t_issend = v_proc_mark, ";
         v_sql = v_sql + "           t_datesend = SYSDATE ";
         v_sql = v_sql + "     WHERE t_id IN (SELECT t_id FROM demail_notify_tmp); ";

         v_sql = v_sql + "    COMMIT; ";
         v_sql = v_sql + "END; ";

         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_proc_mark", RSDBP_IN, VC_LETTER_PROC_MARK);
         v_cmd.addParam("p_submit_period_synch", RSDBP_IN, VC_SUBMIT_PERIOD_SYNCH);
         v_cmd.addParam("p_submit_proc_msg", RSDBP_IN, VC_SUBMIT_PROC_MSG);
         v_cmd.addParam("p_version_err", RSDBP_IN, VC_VERSION_ERR);
         v_cmd.execute();

         v_cmd.close(); v_cmd = NULL; v_sql = NULL;

         /* "Стандартный" режим отправки - отбираем все не отправленные сообщения (t_issend = chr(0)) */
         /* Дистрибутив + отбор дополнительных не отправленных сообщений */

         query = "SELECT T_ID, T_EMAIL, T_EMAIL_CC, T_EMAIL_BCC, T_HEAD, NVL(DBMS_LOB.GETLENGTH(T_TEXT), 0) AS T_LENGTHCLOB " +
                 "  FROM DEMAIL_NOTIFY_DBT " +
                 " WHERE T_ID IN (SELECT T_ID FROM DEMAIL_NOTIFY_TMP) " +
                 "   AND T_ISSEND <> CHR(88) " +
                 "ORDER BY T_DATEADD";

                 rs = execSQLselect( query );

      else
         /* Отправляем только указанные в списке письма */
         query = "SELECT T_ID, T_EMAIL, T_EMAIL_CC, T_EMAIL_BCC, T_HEAD, NVL(DBMS_LOB.GETLENGTH(T_TEXT), 0) AS T_LENGTHCLOB " +
                 "  FROM DEMAIL_NOTIFY_DBT " +
         /* Чтобы не обрабатывать пустой список (p_send_list.size = 0) */
                 " WHERE T_ID = 0 ";
         /* Берем значения из списка, если они есть */
         v_aux_cntr = 0;
         while(v_aux_cntr < p_send_list.size)
            if(v_aux_cntr == 0)
               query = query + "OR T_ID IN (";
            else
               query = query + ", ";
            end;

            query = query + string(":", VC_LETTER_ID_PRM, v_aux_cntr);

            v_aux_cntr = v_aux_cntr + 1;
         end;
         if(v_aux_cntr != 0)
            query = query + ") ";
         end;
         v_cmd = RSDCommand(query);

         v_aux_cntr = 0;
         while(v_aux_cntr < p_send_list.size)
            v_cmd.addParam(string(VC_LETTER_ID_PRM, v_aux_cntr), RSDBP_IN, p_send_list.value(v_aux_cntr));
            v_aux_cntr = v_aux_cntr + 1;
         end;

         rs = RSDRecordSet(v_cmd);

      end;

      while( rs AND rs.moveNext() )
         err = 0; errMes = ""; IsSend = "chr(0)";
         ID = int(rs.Value("T_ID"));
         text_body = GetClobData(ID, int(rs.Value("T_LENGTHCLOB")));
         // отправим
         err = SendNotyfy(fromCnv, rs, text_body, @errMes);
         if( (not err) and (errMes == "") )
            IsSend = "chr(88)";

            v_query_part = " tbl_dbt.T_ISSEND = "+IsSend+", ";
         else
           if(ValType(p_send_list) == V_UNDEF) //maa20190522
               /* Возвращаем статус, который был до попытки отправки */
               v_query_part = " tbl_dbt.T_ISSEND = (SELECT tbl_tmp.t_issend ";
               v_query_part = v_query_part + "        FROM demail_notify_tmp tbl_tmp ";
               v_query_part = v_query_part + "       WHERE tbl_tmp.t_id = tbl_dbt.t_id), ";
            else
                v_query_part = "";
            end;
         end;
         // обновим статус
         errMes = SubStr(errMes,1,200);
         query = "UPDATE DEMAIL_NOTIFY_DBT tbl_dbt SET " +
                 "    tbl_dbt.T_DATESEND = SYSDATE, " +
                 v_query_part +
                 "    tbl_dbt.T_ERROR = '"+errMes+"' " +
                 " WHERE tbl_dbt.T_ID = ?";
         var params = makeArray(SQLParam("T_ID", ID));
         execSQL(query, params, true);

         RslWait(1000);
      end;

      if(ValType(v_cmd) != V_UNDEF)
         rs.close(); v_cmd.close(); rs = NULL; v_cmd = NULL;
      end;
   end;

   SetDialogFlag(OldDialogFlag);
END;


/*--------------------------------------------------------*/
/*        ПОЛЬЗОВАТЕЛЬСКИЙ КЛАСС ДЛЯ ОТПРАВКИ ПИСЕМ       */
/*--------------------------------------------------------*/
/* Создан в целях:                                        */
/* - разделить синхронный и асинхронный процессы отправки */
/* - ограничить область видимости функции SendNotyfy()    */
/*--------------------------------------------------------*/
// p_fromCnv - запуск из конвейера
// p_interface_mode - интерфейсный режим
class c_email_submit_tp_sep(p_fromCnv:bool, p_interface_mode:bool)
   private const GC_LETTER_ID_PRM = "p_letter_id_";
   private const GC_LETTER_PROC_MARK = "P"; /* Метка для t_issend - запись в процессе обработки (для асинхронного режима) */
   private const GC_LETTER_ERR_MARK = "E"; /* Метка для t_issend - запись отмечена как  */
   private const GC_SUBMIT_PERIOD_SYNCH = 10; /* Количество минут, после которого письма из синхронной обработки начинают отправляться в асинхронном режиме */
   private const GC_SUBMIT_PROC_MSG = 20; /* Количество минут, после которого письма, взятые в обработку, начинают отправляться повторно */
   private const GC_VERSION_ERR = 10; /* Значение t_version, после которого письма перестают попадать в обработку */

   var gv_err = 0;
   var gv_message_err = "";

   private var gv_fromCnv = NULL;
   private var gv_interface_mode = NULL;

   private var gv_SMTPServer   = NULL;
   private var gv_UserName     = NULL;
   private var gv_UserPassword = NULL;
   private var gv_ServerPort   = NULL;
   private var gv_UseSSL       = NULL;
   private var gv_UseSmtpAuth  = NULL;


   /*--------------------------*/
   /* Отправка выбранных писем */
   /*--------------------------*/
   private macro m_send_notify(p_fromCnv, p_rs, p_text_body, html:bool, p_errMes:@String )//shev
      private var v_stat = 0;
      private var v_email = NULL;
      private var v_ax = NULL;
      private var v_aux_buf;

      var v_jvm = createObject( "rsjvm", "TJavaHost" );
      var v_RsMail = v_jvm.CreateJavaObject( "ru.softlab.core.mail.RsMail", "<init>" );


      if(v_RsMail != NULL)
         var StrUseSSL = "";
         if(gv_UseSSL)
           StrUseSSL = "X";
         end;
         
         var StrUseSmtpAuth = "";
         if(gv_UseSmtpAuth)
           StrUseSmtpAuth = "X";
         end;

         v_RsMail.Sender(gv_UserName, gv_UserPassword, gv_SMTPServer, gv_ServerPort, StrUseSSL, StrUseSmtpAuth);
         v_RsMail.ClearListAttach();

         var v_email_from = gv_UserName;
         var v_email_from_name = GetPartyShortName({OurBank});
         var v_email_to       = "";
         var v_email_subject  = "";
         var v_email_cc       = "";
         var v_email_bcc      = "";

         /* 20191128 - kva: пытаемся не допустить CHR(1) в CDO.Message */
         v_aux_buf = ValType(p_rs.value("t_Email"));
         if((v_aux_buf != V_UNDEF) and (v_aux_buf != 26))
            v_email_to = p_rs.value("t_Email");
         else
            v_email_to = "";
         end;

         v_email_subject = p_rs.value("t_Head");

         /* 20191128 - kva: пытаемся не допустить CHR(1) в CDO.Message */
         v_aux_buf = ValType(p_rs.value("t_Email_cc"));
         if((v_aux_buf != V_UNDEF) and (v_aux_buf != 26))
            v_email_cc = p_rs.value("t_Email_cc");
         else
            v_email_cc = "";
         end;

         /* 20191128 - kva: пытаемся не допустить CHR(1) в CDO.Message */
         v_aux_buf = ValType(p_rs.value("t_Email_bcc"));
         if((v_aux_buf != V_UNDEF) and (v_aux_buf != 26))
            v_email_bcc = p_rs.value("t_Email_bcc");
         else
            v_email_bcc = "";
         end;

    //  приклепление файлов
         var v_fullname = "";
         var v_FullPath = "";
         var v_tmpDir = "";
         var v_ImageID = 0;
         var v_codeID = L_Z( p_rs.value("t_ID") , 10 );

         var v_queryImg = " select d.t_imageid "
                        "  , d.t_filename "
                        "  from dimgdata_dbt d "
                        " where "
                        "  d.t_imagetype = 1 " 
                        "  and d.t_objecttype  = " + OBJTYPE_ATTACHEMAIL +
                        "  and d.t_objectid = '" + v_codeID  + "'" +
                        "  and d.t_closedate = TO_DATE ('01010001', 'DDMMYYYY') ORDER BY d.t_IsMain desc ";
        
         var v_ds = TRsbDataSet(v_queryImg);
        
         while( v_ds.MoveNext() )
            v_fullname = "";
            v_ImageID = 0;
            v_FullPath = "";
            v_tmpDir = "";
            v_ImageID = v_ds.ImageID;
            WEB_ShowImageByID(v_ImageID, @v_fullname);
//shev для отладки отчета брокера
           var TestDir = "D:\\RSHB_SOFR\\WorkFile\\AfterWebShowRep";
           if(ExistDir(TestDir) != 0)
             MakeDir(TestDir); 
           end;
           v_FullPath = processPath(v_fullname) ;
           CopyFile(v_FullPath, TestDir+"\\"+substr(v_fullname,13)); 
//shev для отладки отчета брокера
//            v_FullPath = processPath(v_fullname) ;
           v_RsMail.AddAttachment(v_FullPath);
         end;

         if(not gv_err )
           if(html)
              var v_HtmlBody = "<!doctype html> <html> <body>";
              v_HtmlBody = v_HtmlBody + p_text_body;
              v_HtmlBody = v_HtmlBody + ("<br> <br> <br> <div align= ""center""> <Font size = 2 color=#0000FF> </font> </div>");
              v_HtmlBody = v_HtmlBody + "</body></html>";
              v_stat = v_RsMail.SendHtml(v_email_subject, v_HtmlBody, v_email_from, v_email_from_name, v_email_to, v_email_bcc, v_email_cc);
           else
              v_stat = v_RsMail.Send(v_email_subject, p_text_body, v_email_from, v_email_from_name, v_email_to, v_email_bcc, v_email_cc);
           end;
         end;

      else
         v_stat = 1;
      end;

      return v_stat;
   OnError(v_er)
      v_stat = 1;
      if(IsEqClass("TRsComErr", v_er.err))
         p_errMes = "Ошибка при отправке: " + v_er.err.Message(1);
      elif(v_er.AxCode)
         p_errMes = "Ошибка при отправке: " + v_er.AxMes;
      end;
   
      if(p_errMes == "")
         p_errMes = v_er.module+ " "+v_er.line+" "+v_er.message;
      end;

      return v_stat;
   end;
   /*-----------------------*/
   /* macro m_send_notify() */
   /*-----------------------*/


   /*-------------------------------------------*/
   /* Асинхронный отбор и запуск отправки писем */
   /*-------------------------------------------*/
   macro m_send_asynch()
      private var v_OldDialogFlag;
      private var v_errMes = "";
      private var v_sql;
      private var v_cmd = NULL;
      private var v_rs = NULL;
      private var v_query;
      private var v_query_part;
      private var v_ID;
      private var v_text_body;
      private var v_IsSend;
      private var v_isHtml;
//return; // ВЫКЛ. e-mail
      if((gv_SMTPServer != "") and
//         (gv_UserName != "") and
//         (gv_UserPassword != "") and
         (gv_ServerPort > 0)
        )

         v_OldDialogFlag = SetDialogFlag(CU_IIF(gv_interface_mode, 1, 0));

         /* отберем уведомления для отправки */
         v_sql =         "DECLARE ";
         v_sql = v_sql + "    v_proc_mark CHAR(1 char) := :p_proc_mark; ";
         v_sql = v_sql + "    v_err_mark CHAR(1 char) := :p_err_mark; ";
         v_sql = v_sql + "BEGIN ";
         v_sql = v_sql + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE demail_notify_tmp'; ";

         v_sql = v_sql + "    INSERT INTO demail_notify_tmp (t_id, t_dateadd, t_datesend, t_issend, t_error) ";
         v_sql = v_sql + "                           (SELECT t_id, t_dateadd, t_datesend, t_issend, t_error ";
         v_sql = v_sql + "                              FROM demail_notify_dbt ";
         v_sql = v_sql + "                             WHERE (t_issend = CHR(0) ";
         v_sql = v_sql + "                                OR (((t_issend NOT IN (CHR(88), v_proc_mark, v_err_mark)) OR (t_issend IS NULL)) ";
         /* !!! - ВНИМАНИЕ! Предполагается, что в случае "синхронной" отправки письмо должно уйти за указанное количество минут - !!! */
         /* !!! - Если письмо за это время не ушло, то будет предпринята попытка отправки в обычном режиме - !!! */
         v_sql = v_sql + "                                    AND T_DATEADD < (SYSDATE - NUMTODSINTERVAL(:p_submit_period_synch, 'MINUTE'))) ";
         v_sql = v_sql + "                                OR (t_issend = v_proc_mark ";
         v_sql = v_sql + "                                    AND T_DATESEND < (SYSDATE - NUMTODSINTERVAL(:p_submit_proc_msg, 'MINUTE')))) ";
         /* !!! - Возможно, стоит вынести в виде настройки - !!! */
         /* !!! - То же значение используется и в ws_check_job.mac - !!! */
         v_sql = v_sql + "                               AND T_VERSION < :p_version_err ";
         /* !!! - Сразу фильтруем записи без адресов - !!! */
         v_sql = v_sql + "                               AND (   LENGTH(NVL(t_email, '1')) > 1 ";
         v_sql = v_sql + "                                    OR LENGTH(NVL(t_email_cc, '1')) > 1 ";
         v_sql = v_sql + "                                    OR LENGTH(NVL(t_email_bcc, '1')) > 1)); ";

         v_sql = v_sql + "    UPDATE demail_notify_dbt ";
         v_sql = v_sql + "       SET t_issend = v_proc_mark, ";
         v_sql = v_sql + "           t_datesend = SYSDATE ";
         v_sql = v_sql + "     WHERE t_id IN (SELECT t_id FROM demail_notify_tmp); ";

         v_sql = v_sql + "    COMMIT; ";
         v_sql = v_sql + "END; ";

         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_proc_mark", RSDBP_IN, GC_LETTER_PROC_MARK);
         v_cmd.addParam("p_err_mark", RSDBP_IN, GC_LETTER_ERR_MARK);
         v_cmd.addParam("p_submit_period_synch", RSDBP_IN, GC_SUBMIT_PERIOD_SYNCH);
         v_cmd.addParam("p_submit_proc_msg", RSDBP_IN, GC_SUBMIT_PROC_MSG);
         v_cmd.addParam("p_version_err", RSDBP_IN, GC_VERSION_ERR);
         v_cmd.execute();

         v_cmd.close(); v_cmd = NULL; v_sql = NULL;

         /* "Стандартный" режим отправки - отбираем все не отправленные сообщения (t_issend = chr(0)) */
         /* Дистрибутив + отбор дополнительных не отправленных сообщений */

         /* 20191128 - kva: пытаемся не допустить CHR(1) в CDO.Message */
         v_query =           "  SELECT T_ID, T_HEAD, ";
         v_query = v_query + "         DECODE(T_EMAIL, CHR(1), NULL, T_EMAIL) AS T_EMAIL, ";
         v_query = v_query + "         DECODE(T_EMAIL_CC, CHR(1), NULL, T_EMAIL_CC) AS T_EMAIL_CC, ";
         v_query = v_query + "         DECODE(T_EMAIL_BCC, CHR(1), NULL, t_EMAIL_BCC) AS t_EMAIL_BCC, ";
         v_query = v_query + "         NVL(DBMS_LOB.GETLENGTH(T_TEXT), 0) AS T_LENGTHCLOB, ";
         v_query = v_query + "         NVL(T_ISHTML, chr(1)) AS T_ISHTML ";
         v_query = v_query + "    FROM DEMAIL_NOTIFY_DBT ";
         v_query = v_query + "   WHERE T_ID IN (SELECT T_ID FROM DEMAIL_NOTIFY_TMP) ";
         v_query = v_query + "     AND T_ISSEND NOT IN (CHR(88), '" + GC_LETTER_ERR_MARK + "') ";
         v_query = v_query + "ORDER BY T_DATEADD ";

         v_rs = execSQLselect( v_query );

         while( v_rs AND v_rs.moveNext() )
            gv_err = 0;
            v_errMes = "";
            v_IsSend = "chr(0)";
            v_ID = int(v_rs.Value("T_ID"));
            v_isHtml = SQL_ConvTypeStr(v_rs.Value("T_ISHTML")) == "X";
            v_text_body = GetClobData(v_ID, int(v_rs.Value("T_LENGTHCLOB")));
            // отправим
            gv_err = m_send_notify(gv_fromCnv, v_rs, v_text_body, v_isHtml, @v_errMes);
            gv_message_err = v_errMes;
            if( (not gv_err) and (v_errMes == "") )
               v_IsSend = "chr(88)";

               v_query_part = " tbl_dbt.T_ISSEND = " + v_IsSend + ", ";
            else
               /* Возвращаем статус, который был до попытки отправки */
               v_query_part = " tbl_dbt.T_ISSEND = (SELECT tbl_tmp.t_issend ";
               v_query_part = v_query_part + "        FROM demail_notify_tmp tbl_tmp ";
               v_query_part = v_query_part + "       WHERE tbl_tmp.t_id = tbl_dbt.t_id), ";
            end;
            // обновим статус
            v_errMes = Substr(v_errMes,1,200);
            v_query = "UPDATE DEMAIL_NOTIFY_DBT tbl_dbt SET " +
                    "    tbl_dbt.T_DATESEND = SYSDATE, " +
                    v_query_part +
                    "    tbl_dbt.T_ERROR = '" + v_errMes + "' " +
                    " WHERE tbl_dbt.T_ID = ?";
            var v_params = makeArray(SQLParam("T_ID", v_ID));
            execSQL(v_query, v_params, true);

            RslWait(1000);
         end;

         if(ValType(v_cmd) != V_UNDEF)
            v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL;
         end;

         SetDialogFlag(v_OldDialogFlag);
      end;
   OnError(v_er)
      SetDialogFlag(v_OldDialogFlag);
      gv_err = 1;
      RunError(v_er);
   end;
   /*-----------------------*/
   /* macro m_send_asynch() */
   /*-----------------------*/


   /*------------------------------------------*/
   /* Синхронный отбор и запуск отправки писем */
   /*------------------------------------------*/
   macro m_send_synch(p_send_list)
      private var v_OldDialogFlag;
      private var v_query;
      private var v_query_part;
      private var v_cmd = NULL;
      private var v_rs = NULL;
      private var v_aux_cntr;
      private var v_ID;
      private var v_text_body;
      private var v_errMes = "";
      private var v_IsSend;
      private var v_isHtml;
//return; // ВЫКЛ. e-mail
      if(ValType(p_send_list) != V_UNDEF)
         if((gv_SMTPServer != "") and
//            (gv_UserName != "") and
//            (gv_UserPassword != "") and
            (gv_ServerPort > 0)
           )

            v_OldDialogFlag = SetDialogFlag(CU_IIF(gv_interface_mode, 1, 0));

            /* отберем уведомления для отправки */
            /* Отправляем только указанные в списке письма */
            /* 20191128 - kva: пытаемся не допустить CHR(1) в CDO.Message */
            v_query =           "SELECT T_ID, T_HEAD, ";
            v_query = v_query + "       DECODE(T_EMAIL, CHR(1), NULL, T_EMAIL) AS T_EMAIL, ";
            v_query = v_query + "       DECODE(T_EMAIL_CC, CHR(1), NULL, T_EMAIL_CC) AS T_EMAIL_CC, ";
            v_query = v_query + "       DECODE(T_EMAIL_BCC, CHR(1), NULL, t_EMAIL_BCC) AS t_EMAIL_BCC, ";
            v_query = v_query + "       NVL(T_ISHTML, chr(1)) AS T_ISHTML, ";
            v_query = v_query + "       NVL(DBMS_LOB.GETLENGTH(T_TEXT), 0) AS T_LENGTHCLOB ";
            v_query = v_query + "  FROM DEMAIL_NOTIFY_DBT ";
            /* Чтобы не обрабатывать пустой список (p_send_list.size = 0) */
            v_query = v_query + " WHERE T_ID = 0 ";
            /* Берем значения из списка, если они есть */
            v_aux_cntr = 0;
            while(v_aux_cntr < p_send_list.size)
               if(v_aux_cntr == 0)
                  v_query = v_query + "OR T_ID IN (";
               else
                  v_query = v_query + ", ";
               end;

               v_query = v_query + string(":", GC_LETTER_ID_PRM, v_aux_cntr);

               v_aux_cntr = v_aux_cntr + 1;
            end;
            if(v_aux_cntr != 0)
               v_query = v_query + ") ";
            end;
            v_cmd = RSDCommand(v_query);

            v_aux_cntr = 0;
            while(v_aux_cntr < p_send_list.size)
               v_cmd.addParam(string(GC_LETTER_ID_PRM, v_aux_cntr), RSDBP_IN, p_send_list.value(v_aux_cntr));
               v_aux_cntr = v_aux_cntr + 1;
            end;

            v_rs = RSDRecordSet(v_cmd);

            while( v_rs AND v_rs.moveNext() )
               gv_err = 0; v_errMes = ""; v_IsSend = "chr(0)";
               v_ID = int(v_rs.Value("T_ID"));
               v_isHtml = SQL_ConvTypeStr(v_rs.Value("T_ISHTML")) == "X";
               v_text_body = GetClobData(v_ID, int(v_rs.Value("T_LENGTHCLOB")));
               // отправим
               gv_err = m_send_notify(gv_fromCnv, v_rs, v_text_body, v_isHtml, @v_errMes);
               gv_message_err = v_errMes;
               if( (not gv_err) and (v_errMes == "") )
                  v_IsSend = "chr(88)";

                  v_query_part = " tbl_dbt.T_ISSEND = " + v_IsSend + ", ";
               else
                  v_query_part = "";
               end;
               // обновим статус
               v_errMes = Substr(v_errMes,1,200);
               v_query = "UPDATE DEMAIL_NOTIFY_DBT tbl_dbt SET " +
                       "    tbl_dbt.T_DATESEND = SYSDATE, " +
                       v_query_part +
                       "    tbl_dbt.T_ERROR = '" + v_errMes + "' " +
                       " WHERE tbl_dbt.T_ID = ?";
               var v_params = makeArray(SQLParam("T_ID", v_ID));
               execSQL(v_query, v_params, true);

               RslWait(1000);
            end;

            if(ValType(v_cmd) != V_UNDEF)
               v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL;
            end;
            
            SetDialogFlag(v_OldDialogFlag);
         end;
      end;
   OnError(v_er)
      SetDialogFlag(v_OldDialogFlag);
      gv_err = 1;
      RunError(v_er);
   end;
   /*----------------------*/
   /* macro m_send_synch() */
   /*----------------------*/


   /* Конструктор */
   private macro m_init_email_submit_tp_sep(i_fromCnv, i_interface_mode)
      gv_fromCnv = i_fromCnv;
      gv_interface_mode = i_interface_mode;

      gv_SMTPServer   = GetMailSMTPServer();
      gv_UserName     = GetMailUserName();
      gv_UserPassword = GetMailUserPassword();
      gv_ServerPort   = GetMailServerPort();
      gv_UseSSL       = GetMailUseSSL();
      gv_UseSmtpAuth  = GetMailUseSmtpAuth();
   end; /* macro m_init_email_submit_tp_sep() */

   m_init_email_submit_tp_sep(p_fromCnv, p_interface_mode);

end;
/*--------------------------------------------------------*/
/*              class c_email_submit_tp_sep()             */
/*--------------------------------------------------------*/

macro GetMainRSHBBrokerAddress()
  return GetStringRegValueOrDefValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\БРОКЕРСКИЙ_ПОЧТОВЫЙ_АДРЕС", "broker@rshb.ru");
end;