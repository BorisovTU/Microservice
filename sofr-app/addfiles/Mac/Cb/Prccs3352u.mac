/*
 $Name:        Prccs3352u.mac
 $Module:      РКО, ББ
 $Description: Печать валютного кассового ордера по 3352-У
*/

// Программист: TDV 2014

import prcc_common;

private macro CheckFIID()
  if( (pr_pmpaym.rec.FIID == pr_pmpaym.rec.PayFIID) AND (pr_pmpaym.rec.FIID == NATCUR) )
    MsgBox( "Документ не является валютным, печать невозможна" );
    return FALSE;
  end;
  return TRUE;
end;

private macro PrintOrderData( data : TCurOrderPrintData, ncopy : integer )

  array ArrayBankName, ArrayAmountRecStr, ArrayAmountSendStr;
  
  
  while( ncopy > 0 )
    StrSplit(data.BankName, ArrayBankName, 72, 72, 2);    
    StrSplit(data.AmountRecStr, ArrayAmountRecStr, 53, 45, 3);    
    StrSplit(data.AmountSendStr, ArrayAmountSendStr, 53, 45, 3);    
    ncopy = ncopy - 1;
    [                                                                                          ┌───────────────┐
                  Валютный кассовый ордер                                                      │   Код формы   │
                                                                                               │ документа по  │
                                                                                               │ ОКУД 0401106  │
                      ┌──────┐                                                                 └───────────────┘
     КАССОВЫЙ ОРДЕР N │ #### │                                                                                  
                      └──────┘           #######################                                              
                                       ───────────────────────────                                              
                                                  Дата                                                          
     Наименование уполномоченного банка ########################################################################
                                        ────────────────────────────────────────────────────────────────────────
                                        ########################################################################
                                        ────────────────────────────────────────────────────────────────────────
                       ┌─────────┐                                                                              
     Код вида операции │ ####### │                                                                              
                       └─────────┘                                                                              
                                                                                          ПРИХОД         Символ 
                                                          ┌────────────────────┬────────────────────────┬──────┐
     Принято #############################################│счет N              │     Сумма цифрами      │      │
             ─────────────────────────────────────────────┤                    │                        │      │
                          (сумма прописью)                │####################│###       ##############│ #### │
     #####################################################│                    │                        │      │
     ─────────────────────────────────────────────────────┼────────────────────┼────────────────────────┼──────┤
     #####################################################│                    │          РАСХОД        │      │
     ─────────────────────────────────────────────────────┼────────────────────┼────────────────────────┼──────┤
     Выдано  #############################################│счет N              │     Сумма цифрами      │      │
             ─────────────────────────────────────────────┤                    │                        │      │
                          (сумма прописью)                │                    │                        │      │
     #####################################################│####################│###       ##############│ #### │
     ─────────────────────────────────────────────────────┤                    │                        │      │
     #####################################################│                    │                        │      │
     ─────────────────────────────────────────────────────┴────────────────────┴────────────────────────┴──────┘
                                                                                                           
     ────────────────────────────  ──────────────────  ──────────────────────────────                           
       (наименование должности)     (личная подпись)        (фамилия, инициалы)                                 
     
                                                                                                                
     ─────────────────────  ──────────  ────────────────     ─────────────────────  ──────────  ────────────────
          (наименование       (личная      (фамилия,               (наименование      (личная      (фамилия,    
            должности)        подпись)     инициалы)                 должности)       подпись)     инициалы)    ]
     
                                                                  
      (data.Number:c,    
       data.DateStr:c,     
       ArrayBankName(0):l, 
       ArrayBankName(1):l,             
       data.OpCode:c,        
       ArrayAmountRecStr(0):l, 
       data.DebAcc:l, data.DFI:l, data.Amount:r, IfThenElse( strlen(data.sDeb.value(0)) > 0, data.sDeb.value(0), ""):c,       
       ArrayAmountRecStr(1):l,     
       ArrayAmountRecStr(2):l,    
       ArrayAmountSendStr(0):l,        
       ArrayAmountSendStr(1):l, data.CredAcc:l, data.CFI:l, data.PayAmount:r, IfThenElse( strlen(data.sCred.value(0)) > 0, data.sCred.value(0), ""):c,
       ArrayAmountSendStr(2):l );
    StrSplit(data.AmountRecStr, ArrayAmountRecStr, 49, 41, 3);    
    StrSplit(data.AmountSendStr, ArrayAmountSendStr, 49, 41, 3);    
       
    [

                                                                                               ┌───────────────┐
                  Валютный кассовый ордер                                                      │   Код формы   │
                                                                                               │ документа по  │
                                                                                               │ ОКУД 0401106  │
                      ┌──────┐                                                                 └───────────────┘
     ВАЛЮТНЫЙ ОРДЕР N │ #### │                                                                                  
                      └──────┘           #######################                                              
                                       ───────────────────────────                                              
                                                  Дата                                                          
     Наименование уполномоченного банка ########################################################################
                                        ────────────────────────────────────────────────────────────────────────
                                        ########################################################################
                                        ────────────────────────────────────────────────────────────────────────
                       ┌─────────┐                                                                              
     Код вида операции │ ####### │                                                                              
                       └─────────┘                                                                              
                                                               ДЕБЕТ                   Сумма цифрами            
                                                      ┌────────────────────┬────────────────┬──────────────────┐
     Принято #########################################│счет N              │                │                  │
             ─────────────────────────────────────────┤                    │                │                  │
                   (сумма прописью)                   │####################│ ############## │### ##############│
     #################################################│                    │                │                  │
     ─────────────────────────────────────────────────┼────────────────────┴────────────────┴──────────────────┤
     #################################################│        КРЕДИТ                                          │
     ─────────────────────────────────────────────────┼────────────────────┬────────────────┬──────────────────┤
     Выдано  #########################################│счет N              │                │                  │
             ─────────────────────────────────────────┤                    │                │                  │
                          (сумма прописью)            │####################│ ############## │### ##############│
     #################################################│                    │                │                  │
     ─────────────────────────────────────────────────┼────────────────────┴────────────────┼──────────────────┤
     #################################################│                               Символ│       ####       │
     ─────────────────────────────────────────────────┴─────────────────────────────────────┴──────────────────┘
                                                                                                                
     ──────────────────────────────  ─────────────────────                                                      
        (наименование должности)      (фамилия, инициалы)                                                       ]
            
            // Валютный кассовый ордер
      (data.Number:c,    
       data.DateStr:c,     
       ArrayBankName(0):l, 
       ArrayBankName(1):l, 
       data.OpCode:c,      
       ArrayAmountRecStr(0):l, 
       data.DebAcc:l,    data.AmountD17:c,   data.DFI:l,         data.AmountD19:r, 
       ArrayAmountRecStr(1):l, 
       ArrayAmountRecStr(2):l, 
       ArrayAmountSendStr(0):l,
       data.CredAcc:l,   data.AmountD20:c,   IfThenElse(data.AmountD22, data.CFI, ""):l,         data.AmountD22:r,   
       ArrayAmountSendStr(1):l,
       ArrayAmountSendStr(2):l, IfThenElse( strlen(data.sCred.value(0)) > 0,data.sCred.value(0), ""):c);

    [        
                                                  Курсовая разница                                              
        ┌─────────────────────────────────────────────────┬─────────────────────────────────────────────────┐   
        │ДОХОД                                            │ РАСХОД                                          │   
        ├─────────────────────────────────────────────────┼─────────────────────────────────────────────────┤   
        │          ДЕБЕТ                 Сумма цифрами    │          ДЕБЕТ                 Сумма цифрами    │   
        ├───────────────────────────┬─────────────────────┼───────────────────────────┬─────────────────────┤   
        │счет N ####################│    ##############   │счет N ####################│    ##############   │   
        ├───────────────────────────┤                     ├───────────────────────────┤                     │   
        │          КРЕДИТ           │                     │          КРЕДИТ           │                     │   
        ├───────────────────────────┤                     ├───────────────────────────┤                     │   
        │счет N ####################│                     │счет N ####################│                     │   
        └───────────────────────────┴─────────────────────┴───────────────────────────┴─────────────────────┘   
                                                                                                                
     ─────────────────────  ──────────  ────────────────     ─────────────────────  ──────────  ────────────────
          (наименование       (личная      (фамилия,               (наименование      (личная      (фамилия,    
            должности)        подпись)     инициалы)                 должности)       подпись)     инициалы)    ]

       // Курсовая разница   
      (data.AccTrnPayDeb:l, data.AccTrnRecSumDeb:c, data.AccTrnPayCred:l,   data.AccTrnRecSumCred:c,
       data.AccTrnRecDeb:l,                         data.AccTrnRecCred:l );
    end;
  return TRUE;
end;

/* Буфер мультивалютного документа, чтобы печать не ругалась */
var pr_multydoc:TRecHandler = TRecHandler( "multydoc.dbt" );
/* Буфер мемордера, чтобы печать не ругалась */
var pr_cb_doc  :TRecHandler = TRecHandler( "cb_doc.dbt"   ); 

macro PrintDocument( ncopy:integer ):bool
  var stat : bool = TRUE,
      data : TCurOrderPrintData = TCurOrderPrintData();

  stat = CheckFIID();

  if( stat )
    if( InList( pr_pmpaym.rec.DocKind, 15, 70, 410, 420, 430, 440, 445 ) )
      data.InitByCashOrder( pr_pmpaym, pr_pmrmprop, pr_pscshdoc );
      stat = PrintOrderData( data, ncopy );
    else
      MsgBox("Данный вид документа не поддерживается макросом");
      stat = FALSE;
    end;
  end;
  return stat;
end;
