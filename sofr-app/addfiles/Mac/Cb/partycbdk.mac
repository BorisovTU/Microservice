import PTInter, BankInter;

const 
  _REGPATH_OFFLINEMODE = "CB\\PARTY\\CBDK\\OFFLINEMODE"
 ,_REGPATH_REFRESHSYNC = "CB\\PARTY\\CBDK\\PERSON\\REFRESHSYNC"
 ,_REGPATH_MESMACROPERSON = "CB\\PARTY\\CBDK\\PERSON\\MESMACROPERSON"
 ,_REGPATH_MESMACROLINKPERSONS = "CB\\PARTY\\CBDK\\PERSON\\MESMACROLINKPERSONS";

const
  result_None       = 0   //Субъект найден 
 ,result_NotFound   = 1   //Субъект не найден
 ,result_Cancel     = 2   //Отказ от ввода
 ,result_NotSync    = 3   //Синхронизацию выполнять не надо
 ,result_NotSynced  = 4;  //Синхронизация не выполнена

macro BeforeOpenCreatePanel(Party : RsbParty)
  var stat : integer;
  var Result : integer;
  var Fields : RsbCBDKFindPartyFields;
  var OffLineMode = false;

  GetRegistryValue(_REGPATH_OFFLINEMODE, V_BOOL, OffLineMode, stat);
  if(stat != 0) 
    msgbox("Ошибка чтения настройки ", _REGPATH_OFFLINEMODE);
  end;
  
  if(not OffLineMode)
    Fields = RsbCBDKFindPartyFields;
    Fields.LastName    = Party.LastName   ;
    Fields.FirstName   = Party.FirstName  ;
    Fields.Patronymic  = Party.Patronymic ;
    Fields.PaperKind   = Party.PaperKind  ;
    Fields.PaperSeries = Party.PaperSeries;
    Fields.PaperNumber = Party.PaperNumber;                                   
    
    if(not CBDK_FindPartyPanel(Fields, Party, Result))
      return Result;
    end;
    return 1; 
  end;
  return stat;
end;

macro BeforeOpenEditPanel(cIdentProgram : string, Party : RsbParty)
  var stat : integer;
  var Result;
  var Fields : RsbCBDKFindPartyFields;
  var OffLineMode = false;
  var RefreshSync = false;
  var MesMacroPerson = "";

  GetRegistryValue(_REGPATH_OFFLINEMODE, V_BOOL, OffLineMode, stat);
  if(stat != 0) 
    msgbox("Ошибка чтения настройки ", _REGPATH_OFFLINEMODE);
  end;
  
  GetRegistryValue(_REGPATH_REFRESHSYNC, V_BOOL, RefreshSync, stat);
  if(stat != 0) 
    msgbox("Ошибка чтения настройки ", _REGPATH_REFRESHSYNC);
  end;
  
  if(OffLineMode or (not RefreshSync))
    return result_NotSync;
  end;

  if((Party.CBDK_DateUpdate == date(0, 0, 0)) and (cIdentProgram != "В") and (cIdentProgram != "Ц"))
    return result_NotSync;
  end;

  GetRegistryValue(_REGPATH_MESMACROPERSON, V_STRING, MesMacroPerson, stat);
  if(stat != 0) 
    msgbox("Ошибка чтения настройки ", _REGPATH_MESMACROPERSON);
  else
    Result = ExecMacroFile(MesMacroPerson, "PartySyncQuery", Party);
    if((Result == 3/*субъект не найден*/) or (Result == "\"Клиент в ЦБД не найден\""))
      Party.CBDK_isSynch = false;
    end;
    Party.Update();
  end;
  return result_None;
end;

macro CreateLink(objlink)
  record link("objlink.dbt");
  var stat = 0;
  var PartyFirst : RsbParty;
  var PartySecond : RsbParty;
  var MesMacroPerson = "";
  var MesMacroLinkPerson = "";
  SetBuff(link, objlink);
  PartyFirst = RsbParty(link.ObjectID);
  PartySecond = RsbParty(link.AttrID);
  
  if((PartyFirst.CBDK_DateUpdate == date(0, 0, 0)) and (PartySecond.CBDK_DateUpdate == date(0, 0, 0)))
    //msgbox("Выходим с ошибкой: PartyFirst.CBDK_DateUpdate = ", PartyFirst.CBDK_DateUpdate, ", PartySecond.CBDK_DateUpdate = ", PartySecond.CBDK_DateUpdate);
    stat = 1;
  else
    GetRegistryValue(_REGPATH_MESMACROLINKPERSONS, V_STRING, MesMacroLinkPerson, stat);
    if(stat != 0) 
      msgbox("Ошибка чтения настройки ", _REGPATH_MESMACROLINKPERSONS);
    else
      stat = ExecMacroFile(MesMacroLinkPerson, "PartyCreateLink", PartyFirst, PartySecond, link);
    end;
  end;
  return stat;
end;

macro AfterChoice(cIdentProgram : string, Party : RsbParty)
  var stat;
  var Fields : RsbCBDKFindPartyFields;
  var OffLineMode = false;
  var RefreshSync = false;
  var MesMacroPerson = "";

  //msgbox("Проверка входа в AfterChoice Party.FullName = ", Party.FullName, ", Party.CBDK_DateUpdate = ", Party.CBDK_DateUpdate);

  GetRegistryValue(_REGPATH_OFFLINEMODE, V_BOOL, OffLineMode, stat);
  if(stat != 0) 
    msgbox("Ошибка чтения настройки ", _REGPATH_OFFLINEMODE);
  end;
  
  GetRegistryValue(_REGPATH_REFRESHSYNC, V_BOOL, RefreshSync, stat);
  if(stat != 0) 
    msgbox("Ошибка чтения настройки ", _REGPATH_REFRESHSYNC);
  end;
  
  if(OffLineMode or (not RefreshSync))
    if((Party.CBDK_DateUpdate == date(0, 0, 0)) and ((cIdentProgram == "В") or (cIdentProgram == "Ц")))
      GetRegistryValue(_REGPATH_MESMACROPERSON, V_STRING, MesMacroPerson, stat);
      if(stat != 0) 
        msgbox("Ошибка чтения настройки ", _REGPATH_MESMACROPERSON);
      else
        stat = ExecMacroFile(MesMacroPerson, "PartyUnsyncQuery", Party);
      end;
    end;
  else
    if((Party.CBDK_DateUpdate == date(0, 0, 0)) and (cIdentProgram != "В") and (cIdentProgram != "Ц"))
      stat = 0;
    else
      GetRegistryValue(_REGPATH_MESMACROPERSON, V_STRING, MesMacroPerson, stat);
      if(stat != 0) 
        msgbox("Ошибка чтения настройки ", _REGPATH_MESMACROPERSON);
      else
        stat = ExecMacroFile(MesMacroPerson, "PartySyncQuery", Party);
      end;
      if(stat == "\"Клиент в ЦБД не найден\"")
        Party.CBDK_IsSynch = false;
      end;
      Party.Update();
    end;
  end;

  return stat;
end;
