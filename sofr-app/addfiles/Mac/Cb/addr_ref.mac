/*
$Name: addr_ref.mac
$Module: Ядро ГКБО
$Description: Макрос заполняющий адрес из референса
*/
/*****************************************************************************\
   Макрос заполняющий адрес из референса
\*****************************************************************************/
import globals, PtInter, ptfias;

/*****************************************************************************/
macro AddElement( stringBuffer, newElement )
 var result:string; 
 if( strlen(stringBuffer) == 0 ) 
   result = newElement;
 else 
   result = stringBuffer + ", " + newElement;
 end;
 return result;
end;

macro AddElementSpace( stringBuffer, newElement )
  var result:string; 
  if( strlen(stringBuffer) == 0 ) 
    result = newElement;
  else 
    result = stringBuffer + " " + newElement;
  end;
  return result;
end;

private macro _GenResultAddressUser(AddressRec)
  var Result:string = "";   //8 зяпятых <PostIndex>,<RegionNum>,<Province>,<District>,<Place>,<<Plan>_><Street>,<House>,<<NumCorps>_><Building>,<Flat>
  
  Result = Result + AddressRec.PostIndex;
  Result = Result + ",";
  
  if( AddressRec.RegionNum != "" )
    Result = Result + AddressRec.RegionNum;
  end;
  Result = Result + ",";
  
  if( AddressRec.Province != "" )
    Result = Result + AddressRec.Province + " " + AddressRec.CodeProvince;
  end;
  Result = Result + ",";
  
  if( AddressRec.District != "" )
    Result = Result + AddressRec.District + " " + AddressRec.CodeDistrict;
  end;
  Result = Result + ",";
  
  if( AddressRec.Place != "" )
    Result = Result + AddressRec.Place + " " + AddressRec.CodePlace;
  end;
  Result = Result + ",";
  
  if( AddressRec.Plan != "" )
    Result = Result + AddressRec.Plan + " " + AddressRec.CodePlan;   
    
    if(AddressRec.Street != "")
      Result = Result + " ";
    end;
  end;

  if( AddressRec.Street != "" )
    Result = Result + AddressRec.Street + " " + AddressRec.CodeStreet;
  end;
  Result = Result + ",";
  
  if( AddressRec.House != "" )
    Result = Result + AddressRec.House;
  end;
  Result = Result + ",";
  
  if( AddressRec.NumCorps != "" )
    Result = Result + AddressRec.NumCorps;
  
    if((AddressRec.Building != ""))
      Result = Result + " ";
    end;
  end;
  
  if( AddressRec.Building != "" )
    Result = Result + AddressRec.Building;
  end;
  Result = Result + ",";
  
  if( AddressRec.Flat != "" )
    Result = Result + AddressRec.Flat;
  end;

  return Result;
end;

/*****************************************************************************/
private macro _GetAddressUserRec(AddressRec)
  var Result:string = "";
  var Kladr = false, stat, status_ = -1;

  /*если государство не Россия, то формировать адрес по Кладру не нужно*/
  if( AddressRec.Country == "RUS" )
    GetRegistryValue( "CB\\PARTY\\КЛАДР\\КЛАДР", V_BOOL, Kladr, stat );

    if( Kladr )
      if( formingKLADRRec( AddressRec, 1, @status_ ) != 0 )
        return "refernce";
      end;
    end;

    if( Kladr )
      Result = _GenResultAddressUser(AddressRec);
    end;
  end;

  if( Result != "" )
    AddressRec.adress = Result;
  end;
  return "refernce";
end;

/*****************************************************************************/
private macro _GetAddressUserMem( ObjAddr )
  var Result:string = "";
  var Kladr = false, stat, status_ = -1;

  file country("country.dbt") key 2;
  record adress(adress);
  SetBuff( adress, ObjAddr );

  /*если государство не Россия, то формировать адрес по Кладру не нужно*/
  if( adress.Country == "RUS" )
    GetRegistryValue( "CB\\PARTY\\КЛАДР\\КЛАДР", V_BOOL, Kladr, stat );

    if( Kladr )
      if( formingKLADR( ObjAddr, 1, @status_ ) != 0 )
        return "refernce";
      end;
    end;

    if( Kladr )
      Result = _GenResultAddressUser(adress);
    end;
  end;

  if( Result != "" )
    adress.adress = Result;
  end;
  return "refernce";
end;

/*****************************************************************************/
macro GetAddressUser( SeqValue, ObjKind, ObjAddr )
  var val;
  /*
  при вызове из rpchkaddress.mac 4ый параметр == true (параметры с 0),
  при генерации адресной строки из панели адреса этот параметр не передается
  */
  GetParm(3, val);
  if((valtype(val) == V_BOOL) and (val == true))
    return _GetAddressUserRec(ObjAddr);
  else
    return _GetAddressUserMem(ObjAddr);
  end;
end;

/*****************************************************************************/
macro GetAddress( SeqValue, ObjKind, ObjAddr )

  var val;
  GetParm(3, val);

  var Result:string = "";
  var Kladr = false, stat, status_ = -1;

  file country("country.dbt") key 2;
  record adress(adress);
  
  if((valtype(val) == V_BOOL) and (val == true))
    Copy( adress, ObjAddr );
  else
  SetBuff( adress, ObjAddr );
  end;

  /*если государство не Россия, то формировать адрес по Кладру не нужно*/
  if( adress.Country == "RUS" )
    GetRegistryValue( "CB\\PARTY\\КЛАДР\\КЛАДР", V_BOOL, Kladr, stat );
    
    if( Kladr )
      if((valtype(val) == V_BOOL) and (val == true))
        if( formingKLADRRec( ObjAddr, 1, @status_ ) != 0 )
          Copy(ObjAddr, adress);
          return "refernce";
        end;
      else
      if( formingKLADR( ObjAddr, 1, @status_ ) != 0 )
        return "refernce";
      end;
    end;
      
    end;
  end;

 /* 2. Почтовый индекс */
 if( adress.PostIndex != "" ) Result = AddElement( Result, adress.PostIndex ); end;

 /* 3. Название государства */
 if(( adress.Country != "" ) and ( adress.Country != {ResidentCountryCode} ))
    country.CodeLat3 = adress.Country;
    if( GetEQ(country) )
      Result = AddElement( Result, country.Name ); 
    end;
 end;

 /* 4. название региона */
 if(( status_ != 2 ) and ( status_ != 3 ) and ( status_ != 5 ) and ( adress.Region != "" ) and ( adress.CodeRegion != "" )) 
   if(( adress.CodeRegion == "г." ) or ( adress.CodeRegion == "г" ))
     Result = AddElement( Result, adress.CodeRegion + " " + adress.Region ); 
   else
     Result = AddElement( Result, adress.Region + " " + adress.CodeRegion ); 
   end;
 end;

 /* 5. название района */
 if(( status_ != 1 ) and ( status_ != 3 ) and ( status_ != 4 ) and ( status_ != 5 ) and ( adress.Province != "" ) and ( adress.CodeProvince != "" )) 
   if(( adress.CodeProvince == "г." ) or ( adress.CodeProvince == "г" ))
     Result = AddElement( Result, adress.CodeProvince + " " + adress.Province ); 
   else
     Result = AddElement( Result, adress.Province + " " + adress.CodeProvince ); 
   end;
 end;

 /* 6. название города */
 if(( adress.District != "" ) and ( adress.CodeDistrict != "" )) 
   if(( adress.CodeDistrict == "г." ) or ( adress.CodeDistrict == "г" ))
     Result = AddElement( Result, adress.CodeDistrict + " " + adress.District ); 
   else
     Result = AddElement( Result, adress.District + " " + adress.CodeDistrict ); 
   end;
 end;

 /* 7. название населенного пункта */
 if(( adress.Place != "" ) and ( adress.CodePlace != "" )) 
   if(( adress.CodePlace == "г." ) or ( adress.CodePlace == "г" ))
     Result = AddElement( Result, adress.CodePlace + " " + adress.Place ); 
   else
     Result = AddElement( Result, adress.Place + " " + adress.CodePlace ); 
   end;
 end;

 /* 8. Название улицы */
 if(( adress.Street != "" ) and ( adress.CodeStreet != "" )) 
   Result = AddElement( Result, adress.CodeStreet + " " + adress.Street ); 
 end;

 /* 9. Дом, квартира и тд */
 if( adress.House != "" ) 
   Result = AddElement( Result, "д. " + adress.House ); 
 end;
 if( adress.NumCorps != "" ) 
   Result = AddElement( Result, "корп. " + adress.NumCorps ); 
 end;
 if( adress.Flat != "" ) 
   Result = AddElement( Result, "кв. " + adress.Flat ); 
 end;

 adress.adress = Result;
 
 if((valtype(val) == V_BOOL) and (val == true))
   Copy(ObjAddr, adress);
 end; 
  
 return "refernce";
end;

/*****************************************************************************/
macro GetAddressFinMon( SeqValue, ObjKind, ObjAddr )

  var val;
  GetParm(3, val);

 var Result:string = "";
 var Kladr = false, stat, status_ = -1;

 file country("country.dbt") key 2;
  record adress(adress);
  
  if((valtype(val) == V_BOOL) and (val == true))
    Copy( adress, ObjAddr );
  else
    SetBuff( adress, ObjAddr );
  end;

  /*если государство не Россия, то формировать адрес по Кладру не нужно*/
  if( adress.Country == "RUS" )
    GetRegistryValue( "CB\\PARTY\\КЛАДР\\КЛАДР", V_BOOL, Kladr, stat );
    
    if( Kladr )
      if((valtype(val) == V_BOOL) and (val == true))
        if( formingKLADRRec( ObjAddr, 1, @status_ ) != 0 )
          Copy(ObjAddr, adress);
          return "refernce";
        end;
      else
        if( formingKLADR( ObjAddr, 1, @status_ ) != 0 )
          return "refernce";
        end;
    end;
      
    end;
  end;

 /* 2. Почтовый индекс */
 if( adress.PostIndex != "" ) Result = AddElement( Result, adress.PostIndex ); end;

 /* 3. Название государства */
 if(( adress.Country != "" ) and ( adress.Country != {ResidentCountryCode} ))
   country.CodeLat3 = adress.Country;
   if( GetEQ(country) )
     Result = AddElement( Result, country.Name ); 
   end;
 end;

 /* 4. название региона */
 if(( status_ != 2 ) and ( status_ != 3 ) and ( status_ != 5 ) and ( adress.Region != "" ) and ( adress.CodeRegion != "" )) 
   if(( adress.CodeRegion == "г." ) or ( adress.CodeRegion == "г" ))
     Result = AddElement( Result, adress.CodeRegion + " " + adress.Region ); 
   else
     Result = AddElement( Result, adress.Region + " " + adress.CodeRegion ); 
   end;
 end;

 /* 5. название района */
 if(( status_ != 1 ) and ( status_ != 3 ) and ( status_ != 4 ) and ( status_ != 5 ) and ( adress.Province != "" ) and ( adress.CodeProvince != "" )) 
   if(( adress.CodeProvince == "г." ) or ( adress.CodeProvince == "г" ))
     Result = AddElement( Result, adress.CodeProvince + " " + adress.Province ); 
   else
     Result = AddElement( Result, adress.Province + " " + adress.CodeProvince ); 
   end;
 end;

 /* 6. название города */
 if(( adress.District != "" ) and ( adress.CodeDistrict != "" )) 
   if(( adress.CodeDistrict == "г." ) or ( adress.CodeDistrict == "г" ))
     Result = AddElement( Result, adress.CodeDistrict + " " + adress.District ); 
   else
     Result = AddElement( Result, adress.District + " " + adress.CodeDistrict ); 
   end;
 end;

 /* 7. название населенного пункта */
 if(( adress.Place != "" ) and ( adress.CodePlace != "" )) 
   Result = AddElement( Result, adress.CodePlace + " " + adress.Place ); 
 end;

 /* название планировочной структуры */
 if(( adress.Plan != "" ) and ( adress.CodePlan != "" )) 
   Result = AddElement( Result, adress.CodePlan + " " + adress.Plan ); 
 end;

 /* 8. Название улицы */
 if(( adress.Street != "" ) and ( adress.CodeStreet != "" )) 
   Result = AddElement( Result, adress.CodeStreet + " " + adress.Street ); 
 end;

 /* 9. Дом, квартира и тд */
 if( adress.House != "" ) 
   Result = AddElement( Result, "д. " + adress.House ); 
 end;
 if( adress.NumCorps != "" ) 
   Result = AddElement( Result, "корп. " + adress.NumCorps ); 
 end;
 if( adress.Building != "" ) 
   Result = AddElement( Result, "стр. " + adress.Building ); 
 end;
 if( adress.Flat != "" ) 
   Result = AddElement( Result, "кв. " + adress.Flat ); 
 end;

 adress.adress = Result;
 
 if((valtype(val) == V_BOOL) and (val == true))
   Copy(ObjAddr, adress);
 end; 
  
 return "refernce";
end;
/*****************************************************************************/

macro GetAddressPost( SeqValue, ObjKind, ObjAddr )

  var val;
  GetParm(3, val);

  var Result:string = "";
  var Kladr = false, stat, status_ = -1;
  var TempHouse:string = "";

  file country("country.dbt") key 2;
  record adress(adress);
  
  if((valtype(val) == V_BOOL) and (val == true))
    Copy( adress, ObjAddr );
  else
    SetBuff( adress, ObjAddr );
  end;

  /*
  Сформировать адрес в строковом представлении, подставив значения свойств объекта адреса в формате:
  [планировочная структура, ][улица, ][дом, ][помещение, ][населённый пункт, ][район, ][регион, ][<индекс>] 
  */

  if(( adress.Plan != "" ) and ( adress.CodePlan != "" )) 
    Result = AddElement( Result, adress.CodePlan + " " + adress.Plan ); 
  end;

  if(( adress.Street != "" ) and ( adress.CodeStreet != "" )) 
    Result = AddElement( Result, adress.CodeStreet + " " + adress.Street ); 
  end;

  if( adress.House != "" ) 
    TempHouse = AddElementSpace( TempHouse, "д. " + adress.House ); 
  end;
  if( adress.NumCorps != "" ) 
    TempHouse = AddElementSpace( TempHouse, "к. " + adress.NumCorps ); 
  end;
  if( adress.Building != "" ) 
    TempHouse = AddElementSpace( TempHouse, "стр. " + adress.Building ); 
  end;
 
  if(TempHouse != "")
    Result = AddElement( Result, TempHouse ); 
  end;

  if( adress.Flat != "" ) 
    Result = AddElement( Result, adress.Flat ); 
  end;

  if(( adress.Place != "" ) and ( adress.CodePlace != "" )) 
    Result = AddElement( Result, adress.CodePlace + " " + adress.Place ); 
  elif(( adress.District != "" ) and ( adress.CodeDistrict != "" ))
    Result = AddElement( Result, adress.CodeDistrict + " " + adress.District ); 
  end;

  if(( adress.Province != "" ) and ( adress.CodeProvince != "" )) 
    Result = AddElement( Result, adress.Province + " " + adress.CodeProvince ); 
  end;
  
  if(( adress.Region != "" ) and ( adress.CodeRegion != "" )) 
    Result = AddElement( Result, adress.Region + " " + adress.CodeRegion ); 
  end;
  
  if( adress.PostIndex != "" ) Result = AddElement( Result, adress.PostIndex ); end;

  adress.adress = Result;
 
  if((valtype(val) == V_BOOL) and (val == true))
    Copy(ObjAddr, adress);
  end; 
  
  return "refernce";
end;
/*****************************************************************************/
