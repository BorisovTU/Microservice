/*************************************************************************************
*  Макрос для проверки контрольной суммы архива (как при сохранении копии дня, так   *
*  и при восстановлении копии). Макрос принимает: name - имя архива,                 *
*                                                 arh_path - путь к архиву,          *
*                                                 type - тип (0 - архивирование      *
*                                                             1 - разархивирование)  *
*                                                                                    *
*  Макрос написан для работы с программой HContr32.exe                               *
*************************************************************************************/

import lib_path;

file hash("hash.lst") txt write;
file cntrsum_1("arhcontr.1") txt;
file cntrsum_2("arhcontr.2") txt write;
file cntrsum_3("arhcontr.3") txt;

/* программа рассчитывающая контрольную сумму */
var name_prog = "d:\\bank50\\hcontr\\hcontr32.exe";

MACRO CalcContrArh( name, arh_path, type )
         
/* Только для Сбербанка, программа который понимает ТОЛЬКО поный путь к каталогу */
/* необходимо это путь прописывать полностью ручками в макросе, поскольку путь к */
/* архивному каталогу, лежащий в bank.ini, может не соответствовать формату      */
/* программы                                                                     */

        if( type == 1 ) 
          arh_path = "d:\\bank50\\arh\\ARHFILE";
        else
          arh_path = "d:\\bank50\\arhfile";
        end;

	hash.str = arh_path;
	if( insert(hash) == TRUE )
	   Run( name_prog, "arhcontr.1", "Подсчет контрольной суммы", null );
           close(hash);
           open(hash);
	   hash.str = "arhcontr.2";
	   if( insert(hash) == TRUE )
              rewind( cntrsum_1 );
              while( next(cntrsum_1) )
                if( index(cntrsum_1.str, ".") )
                  cntrsum_2.str = FileFromPath( cntrsum_1.str );
                else
                  cntrsum_2.str = cntrsum_1.str;
                end;

                if( insert(cntrsum_2) == FALSE )
                  msgbox("Ошибка");
                  return 1;
                end;

              end;

              close(cntrsum_2);

	      Run( name_prog, "arhcontr.3", "Подсчет контрольной суммы", null );

              rewind(cntrsum_3);
	      next(cntrsum_3);
	      next(cntrsum_3);
              return cntrsum_3.str;
           else
	           msgbox("Ошибка");
           end;
	else
           msgbox("Ошибка");
	end;
END;
