/*
$Name:             bbcp_rep.mac
$Module:           Ядро Banking
$Description:      Печать ведомости расхождения для документа и дубликата
*/
/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.10                                         R-Style Software Lab

  File Name   : bbcp_rep.mac
  Created     : 23.02.2003
  Programmer  : Андреева Е.П.
  Description : Печать ведомости расхождения для документа и дубликата
└───────────────────────────────────────────────────────────────────────────*/
IMPORT  PaymInter, FIInter, "ver_rep.mac", likepy, oralib, globals, pmbuff;

var pr_rep:integer, 
    locked:string,
    locktax:string;

const  BB_ORDER = 27,
       PS_ORDER = 202,
       PS_DURQ = 263;

const  CP_PF_NUMBER                = 1,
       CP_PF_DATE                  = 2,
       CP_PF_VALUEDATE             = 3,
       CP_PF_ORDERAMOUNT           = 4,
       CP_PF_ORDERFICODE           = 5,
       CP_PF_ORDERFINAME           = 6,
       CP_PF_P_CK                  = 7,
       CP_PF_P_CK_NAME             = 8,
       CP_PF_P_CODE                = 9,
       CP_PF_P_FICODE              = 10,
       CP_PF_PAYERACCOUNT          = 11,
       CP_PF_P_NAME                = 12,
       CP_PF_P_INN                 = 13,
       CP_PF_CORR_CK               = 14,
       CP_PF_CORR_CK_NAME          = 15,
       CP_PF_CORR_CODE             = 16,
       CP_PF_CORR_ACCOUNT          = 17,
       CP_PF_CORR_NAME             = 18,
       CP_PF_CODEKIND              = 19,
       CP_PF_KINDCODE_RECEIVERNAME = 20,
       CP_PF_BANKCODE              = 21,
       CP_PF_CORRACCNOSTRO         = 22,
       CP_PF_NAME                  = 23,
       CP_PF_R_CK                  = 24,
       CP_PF_R_CK_NAME             = 25,
       CP_PF_R_CODE                = 26,
       CP_PF_R_FICODE              = 27,
       CP_PF_RECEIVERACCOUNT       = 28,
       CP_PF_BENEFICIARY           = 29,
       CP_PF_R_INN                 = 30,
       CP_PF_RATETYPENAME          = 31,
       CP_PF_RATEFICODE1           = 32,
       CP_PF_RATEFICODE2           = 33,
       CP_PF_GROUND                = 34,
       CP_PF_COMISSCODE            = 35,
       CP_PF_COMISSFICODE          = 36,
       CP_PF_COMISSACCOUNT         = 37,
       CP_PF_SYMBNOTBALDEBET       = 38,
       CP_PF_INSTRUCTIONCODE       = 39,
       CP_PF_INSTANCY              = 40,
       CP_PF_NUMBERPACK            = 41,
       CP_PF_DEPARTMENTNAME        = 42,
       CP_PF_KIND_OPERATION        = 43,
       CP_PF_KIND_OPERATIONNAME    = 44,
       CP_PF_PRIORITY              = 45;

const  kz_pf_FI_Code                  = 1, 
       kz_pf_FI_NAME                  = 2, 
       kz_pf_ValueDate                = 3, 
       kz_pf_Number                   = 4, 
       kz_pf_Date                     = 5, 
       kz_pf_Amount                   = 6, 
       kz_pf_Reference                = 7, 
       kz_pf_PayerCodeKind            = 8, 
       kz_pf_KindCode_PAY             = 9, 
       kz_pf_PayerCode                = 10,
       kz_pf_PayerAccount             = 11,
       kz_pf_PayerINN                 = 12,
       kz_pf_kzPayerCode              = 13,
       kz_pf_PayerName                = 14,
       kz_pf_CorrCodeKind             = 15,
       kz_pf_KindCode_Corr            = 16,
       kz_pf_CorrCode                 = 17,
       kz_pf_CorrRNN                  = 18,
       kz_pf_ReceiverCorrBankName     = 19,
       kz_pf_CodeKind                 = 20,
       kz_pf_KindCode_ACC             = 21,
       kz_pf_BankCode                 = 22,
       kz_pf_BankRNN                  = 23,
       kz_pf_ReceiverBankName         = 24,
       kz_pf_ReceiverCodeKind         = 25,
       kz_pf_KindCode_BNF             = 26,
       kz_pf_ReceiverCode             = 27,
       kz_pf_ReceiverAccount          = 28,
       kz_pf_ReceiverINN              = 29,
       kz_pf_kzReceiverCode           = 30,
       kz_pf_ReceiverName             = 31,
       kz_pf_kzReceiverCountry        = 32,
       kz_pf_kzReceiverCountryName    = 33,
       kz_pf_KNP_Name                 = 34,
       kz_pf_KNP_Note                 = 35,
       kz_pf_Ground                   = 36,
       kz_pf_kzContractNumber         = 37,
       kz_pf_kzContractDate           = 38,
       kz_pf_kzIPS                    = 39,
       kz_pf_COMISSCODE               = 40,
       kz_pf_Priority                 = 41,
       kz_pf_IsInstancy               = 42,
       kz_pf_NumberPack               = 43,
       kz_pf_DepartmentName           = 44,
       kz_pf_Kind_Operation           = 45,
       kz_pf_Kind_OperationName       = 46,
       kz_pf_kzPayerCountry           = 47,
       kz_pf_kzOperationCode          = 49;
      
/* Нумерация полей в панелях */
const  INRQ_PF_NUMBER             = 1,
       INRQ_PF_DATE               = 2,             
       INRQ_PF_KINDPAYMENT        = 3,      
       INRQ_PF_KINDPAYMENTNAME    = 4,
       INRQ_PF_VALUEDATE          = 5,        
       INRQ_PF_INTO_BANK          = 6,        
       INRQ_PF_PSBCNUMBER         = 7,
       INRQ_PF_PSBCDATE           = 8,
       INRQ_PF_INN_PAYER          = 9,
       INRQ_PF_PAYER              = 10,            
       INRQ_PF_AUTHSTAT           = 11,         
       INRQ_PF_SUM                = 12,
       INRQ_PF_FI_CODE            = 13,
       INRQ_PF_FI_NAME            = 14,
       INRQ_PF_ACCOUNT_PAYER      = 15,
       INRQ_PF_BANK_RECEIVER      = 16,
       INRQ_PF_KINDCODE_RECEIVER  = 17,
       INRQ_PF_KINDCODE_RECEIVERNAME = 18,
       INRQ_PF_CODE_RECEIVER      = 19,    
       INRQ_PF_CORRACC_RECEIVER   = 20, 
       INRQ_PF_INN_RECEIVER       = 21,     
       INRQ_PF_RECEIVER           = 22,          
       INRQ_PF_ACCOUNT_RECEIVER   = 23, 
       INRQ_PF_GROUND             = 24,           
       INRQ_PF_SHIFR_OPER         = 25,       
       INRQ_PF_GROUNDNUM          = 26,
       INRQ_PF_PAY_DATE           = 27,         
       INRQ_PF_PRIORITY           = 28,         
       INRQ_PF_NUMBERPACK         = 29,       
       INRQ_PF_DEPARTMENTNAME     = 30,
       INRQ_PF_KIND_OPERATION     = 31,   
       INRQ_PF_KIND_OPERATIONNAME = 32;
  
const  INRQ_PF_KZ_NUMBER            = 1,
       INRQ_PF_KZ_DATE              = 2,
       INRQ_PF_KZ_KINDPAYMENT       = 3,
       INRQ_PF_KZ_KINDPAYMENTNAME   = 4,
       INRQ_PF_KZ_VALUEDATE         = 5,
       INRQ_PF_KZ_RNN_PAYER         = 6,
       INRQ_PF_KZ_PayerCode         = 7,   
       INRQ_PF_KZ_PAYER             = 8,
       INRQ_PF_KZ_KBK_Name          = 9,
       INRQ_PF_KZ_KBK               = 10,
       INRQ_PF_KZ_SUM               = 11,
       INRQ_PF_KZ_ACCOUNT_PAYER     = 12,
       INRQ_PF_KZ_BANK_RECEIVER     = 13,
       INRQ_PF_KZ_KINDCODE_RECEIVER = 14,
       INRQ_PF_KZ_KINDCODE_RECEIVERNAME = 15,
       INRQ_PF_KZ_CODE_RECEIVER     = 16,
       INRQ_PF_KZ_INN_RECEIVER      = 17,
       INRQ_PF_KZ_RecieverCode      = 18,   
       INRQ_PF_KZ_RECEIVER          = 19,
       INRQ_PF_KZ_ACCOUNT_RECEIVER  = 20, 
       INRQ_PF_KZ_KNP_Name          = 21,   
       INRQ_PF_KZ_GROUND            = 22, 
       INRQ_PF_KZ_KNP               = 23,
       INRQ_PF_KZ_SHIFR_OPER        = 24,
       INRQ_PF_KZ_PAY_DATE          = 25,
       INRQ_PF_KZ_PRIORITY          = 26,
       INRQ_PF_KZ_MINIMIZATIONTURN  = 27, 
       INRQ_PF_KZ_NUMBERPACK        = 28,
       INRQ_PF_KZ_DEPARTMENTNAME    = 29,
       INRQ_PF_KZ_KIND_OPERATION    = 30,
       INRQ_PF_KZ_KIND_OPERATIONNAME = 31,
       INRQ_PF_KZ_COUNTRY_PAYER     = 32,
       INRQ_PF_KZ_COUNTRYNAME_PAYER = 33,
       INRQ_PF_KZ_COUNTRY_RECEIVER  = 34,
       INRQ_PF_KZ_COUNTRYNAME_RECEIVER = 35,
       INRQ_PF_KZ_OPERATIONCODE     = 36,
       INRQ_PF_KZ_INTO_BANK         = 37,        
       INRQ_PF_KZ_PSBCDATE          = 38,
       INRQ_PF_KZ_PSBCNUMBER        = 39,
       INRQ_PF_KZ_FI_CODE           = 40,
       INRQ_PF_KZ_FI_NAME           = 41,
       INRQ_PF_KZ_CORRACC_RECEIVER  = 42,
       INRQ_PF_KZ_MCMETHODNAME      = 43;    
 
    
PRIVATE MACRO needUseKZpm():bool
  var err:integer = 0;
  var locale:string = "";
  GetRegistryValue("CB\\PAYMENTS\\PANEL\\LOCALE", V_STRING, locale, err);
  return ( ( err == 0 ) AND ( index( strupr(locale), "KZ" ) ) );
END;

PRIVATE MACRO getKNPName( Element:integer ):string
  var query:string = " select llv.T_NAME " +
                       " from dllvalues_dbt llv " +
                      " where llv.T_LIST = 1804 " +
                        " and llv.T_ELEMENT = :ELEMENT ";
  VAR params:TArray = makeArray( SQLParam( "ELEMENT", Element ) );
  VAR rset:RsdRecordset = execSQLselect( query, params, TRUE );

  if( rset and rset.moveNext() )
    return ( rset.value(0) );
  end;     
  return string(Element);
END;

macro RQ_Print_Cround( pn1, pn2 )
   Print_LargeStr("'" + pn1 + "'", "'" + pn2 + "'", "Основание документа (назначение)");
end;

MACRO RQ_Print_ReportDupl(PaymentID, Number, Amount, ValueDate)
[
  Для дубликата платежного документа
     N дубликата #########################
     Сумма:   ############################
     Дата валютирования:  ################
  Найден первичный документ
]
(r_pmdurmpp.Number:l, r_pmdupaym.PayAmount:l:f, r_pmdupaym.ValueDate:l);
END;

MACRO RQ_Print_Report()

  var i = 0;
  var needKZ:bool = needUseKZpm();

  RQ_Print_ReportDupl(r_pmdupaym.PaymentID, r_pmdurmpp.Number, r_pmdupaym.PayAmount, r_pmdupaym.ValueDate);
[    Платежное поручение N ##########################
     Сумма:   ############################
     Дата валютирования:  ################
]
( r_pmrmprop.Number:l, r_pmpaym.PayAmount:l:f, r_pmpaym.ValueDate:l);
             
/* Ведомость расхождения печатается при соответствующей настройке */
if( pr_rep )
   Print_Head();
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_NUMBER, INRQ_PF_NUMBER ), 1 ) == " ") and (r_pmrmprop.Number != r_pmdurmpp.Number))
      Print_SmallStr(r_pmrmprop.Number, r_pmdurmpp.Number, "Номер документа"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_DATE, INRQ_PF_DATE ), 1 ) == " ") and (r_pmrmprop.Date != r_pmdurmpp.Date))
      Print_SmallStr(r_pmrmprop.Date, r_pmdurmpp.Date, "Дата (заполняемая клиентом)"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_KINDPAYMENT, INRQ_PF_KINDPAYMENT ), 1 ) == " ") and (r_pmrmprop.PaymentKind != r_pmdurmpp.PaymentKind))
      Print_PaymentKind(r_pmrmprop.PaymentKind, r_pmdurmpp.PaymentKind); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_VALUEDATE, INRQ_PF_VALUEDATE ), 1 ) == " ") and (r_pmpaym.ValueDate != r_pmdupaym.ValueDate))
      Print_SmallStr(r_pmpaym.ValueDate, r_pmdupaym.ValueDate, "Дата"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_INTO_BANK, INRQ_PF_INTO_BANK ), 1 ) == " ") and (r_pmpaym.PayerBankEnterDate != r_pmdupaym.PayerBankEnterDate))
      Print_SmallStr(r_pmpaym.PayerBankEnterDate, r_pmdupaym.PayerBankEnterDate, "Поступ. в банк плат."); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_PSBCNUMBER, INRQ_PF_PSBCNUMBER ), 1 ) == " ") and (r_psinrq.PSBCNumber != r_psduinrq.PSBCNumber))
      Print_SmallStr(r_psinrq.PSBCNumber, r_psduinrq.PSBCNumber, "Номер поруч. на продажу"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_PSBCDATE, INRQ_PF_PSBCDATE ), 1 ) == " ") and (r_psinrq.PSBCDate != r_psduinrq.PSBCDate))
      Print_SmallStr(r_psinrq.PSBCDate, r_psduinrq.PSBCDate, "Дата поруч. на продажу"); i = i+1;
   end;
   if(((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_RNN_PAYER, INRQ_PF_INN_PAYER ), 1 ) == " ") or (SubStr( locktax, tax_fld_PayerINN, 1 ) == " ") or (SubStr( locktax, tax_fld_PayerKPP, 1 ) == " "))and
      (r_pmrmprop.PayerINN != r_pmdurmpp.PayerINN))
      Print_PayerINN(r_pmrmprop.PayerINN, r_pmdurmpp.PayerINN); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_PAYER, INRQ_PF_PAYER ), 1 ) == " ") and (r_pmrmprop.PayerName != r_pmdurmpp.PayerName))
      Print_PayerName(r_pmrmprop.PayerName,r_pmdurmpp.PayerName); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_SUM, INRQ_PF_SUM ), 1 ) == " ") and (r_pmpaym.PayAmount != r_pmdupaym.PayAmount))
      Print_Amount(r_pmpaym.PayAmount, r_pmdupaym.PayAmount, "Сумма"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_FI_CODE, INRQ_PF_FI_CODE ), 1 ) == " ") and (r_pmpaym.PayFIID != r_pmdupaym.PayFIID))
      Print_SmallStr(r_pmpaym.PayFIID, r_pmdupaym.PayFIID, "Валюта счета плательщика"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_ACCOUNT_PAYER, INRQ_PF_ACCOUNT_PAYER ), 1 ) == " ") and (r_pmpaym.PayerAccount != r_pmdupaym.PayerAccount))
      Print_SmallStr(r_pmpaym.PayerAccount, r_pmdupaym.PayerAccount, "Счет плательщика"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_BANK_RECEIVER, INRQ_PF_BANK_RECEIVER ), 1 ) == " ") and (r_pmrmprop.ReceiverBankName != r_pmdurmpp.ReceiverBankName))
      Print_ReceiverBankName(r_pmrmprop.ReceiverBankName, r_pmdurmpp.ReceiverBankName); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_KINDCODE_RECEIVER, INRQ_PF_KINDCODE_RECEIVER ), 1 ) == " ") and (r_credit.CodeKind != r_ducredit.CodeKind))
      Print_CodeKind(r_credit.CodeKind, r_ducredit.CodeKind); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_CODE_RECEIVER, INRQ_PF_CODE_RECEIVER ), 1 ) == " ") and (r_credit.BankCode != r_ducredit.BankCode))
      Print_SmallStr(r_credit.BankCode, r_ducredit.BankCode, "Код банка получателя"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_CORRACC_RECEIVER, INRQ_PF_CORRACC_RECEIVER ), 1 ) == " ") and (r_pmrmprop.ReceiverCorrAccNostro != r_pmdurmpp.ReceiverCorrAccNostro))
      Print_SmallStr(r_pmrmprop.ReceiverCorrAccNostro, r_pmdurmpp.ReceiverCorrAccNostro, "Корсчет банка получателя в РКЦ"); i = i+1;
   end;
   if(((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_INN_RECEIVER, INRQ_PF_INN_RECEIVER ), 1 ) == " ") or (SubStr( locktax, tax_fld_ReceiverINN, 1 ) == " ") or (SubStr( locktax, tax_fld_ReceiverKPP, 1 ) == " ")) and
      (r_pmrmprop.ReceiverINN != r_pmdurmpp.ReceiverINN))
      Print_ReceiverINN(r_pmrmprop.ReceiverINN, r_pmdurmpp.ReceiverINN); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_RECEIVER, INRQ_PF_RECEIVER ), 1 ) == " ") and (r_pmrmprop.ReceiverName != r_pmdurmpp.ReceiverName))
      Print_ReceiverName(r_pmrmprop.ReceiverName, r_pmdurmpp.ReceiverName); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_ACCOUNT_RECEIVER, INRQ_PF_ACCOUNT_RECEIVER ), 1 ) == " ") and (r_pmpaym.ReceiverAccount != r_pmdupaym.ReceiverAccount))
      Print_SmallStr(r_pmpaym.ReceiverAccount, r_pmdupaym.ReceiverAccount, "Счет получателя"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_GROUND, INRQ_PF_GROUND ), 1 ) == " ") and (r_pmrmprop.Ground != r_pmdurmpp.Ground))
      RQ_Print_Cround(r_pmrmprop.Ground, r_pmdurmpp.Ground); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_SHIFR_OPER, INRQ_PF_SHIFR_OPER ), 1 ) == " ") and (r_pmrmprop.ShifrOper != r_pmdurmpp.ShifrOper))
      Print_SmallStr(r_pmrmprop.ShifrOper, r_pmdurmpp.ShifrOper, "Шифр"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_PAY_DATE, INRQ_PF_PAY_DATE ), 1 ) == " ") and (r_pmrmprop.PayDate != r_pmdurmpp.PayDate))
      Print_SmallStr(r_pmrmprop.PayDate, r_pmdurmpp.PayDate, "Срок платежа"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_PRIORITY, INRQ_PF_PRIORITY ), 1 ) == " ") and (r_pmrmprop.Priority != r_pmdurmpp.Priority))
      Print_SmallStr(r_pmrmprop.Priority, r_pmdurmpp.Priority, "Очередность платежа"); i = i+1;
   end;
   if((SubStr( locked, IfThenElse( needKZ, INRQ_PF_KZ_NUMBERPACK, INRQ_PF_NUMBERPACK ), 1 ) == " ") and (r_pmpaym.NumberPack != r_pmdupaym.NumberPack))
      Print_SmallStr(r_pmpaym.NumberPack, r_pmdupaym.NumberPack, "Номер пачки"); i = i+1;
   end;

   /* Всякие налоговые заморочки - кроме ИНН и КПП */
   if(((SubStr( locked, INRQ_PF_AUTHSTAT, 1 ) == " ") or (SubStr( locktax, tax_fld_AuthorStatusCode, 1 ) == " ") ) and
      (r_pmrmprop.TaxAuthorState != r_pmdurmpp.TaxAuthorState))
      Print_SmallStr(r_pmrmprop.TaxAuthorState, r_pmdurmpp.TaxAuthorState, "Статус составителя"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_TaxCode, 1 ) == " ") and (r_pmrmprop.BttTICode != r_pmdurmpp.BttTICode))
      Print_SmallStr(r_pmrmprop.BttTICode, r_pmdurmpp.BttTICode, "Код бюджетной классификации"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_OKATOCode, 1 ) == " ") and (r_pmrmprop.OKATOCode != r_pmdurmpp.OKATOCode))
      Print_SmallStr(r_pmrmprop.OKATOCode, r_pmdurmpp.OKATOCode, "Код ОКАТО"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_GroundCode, 1 ) == " ") and (r_pmrmprop.TaxPmGround != r_pmdurmpp.TaxPmGround))
      Print_SmallStr(r_pmrmprop.TaxPmGround, r_pmdurmpp.TaxPmGround, "Код основания документа"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_Period, 1 ) == " ") and (r_pmrmprop.TaxPmPeriod != r_pmdurmpp.TaxPmPeriod))
      Print_SmallStr(r_pmrmprop.TaxPmPeriod, r_pmdurmpp.TaxPmPeriod, "Налоговый период"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_Number, 1 ) == " ") and (r_pmrmprop.TaxPmNumber != r_pmdurmpp.TaxPmNumber))
      Print_SmallStr(r_pmrmprop.TaxPmNumber, r_pmdurmpp.TaxPmNumber, "Номер налогового документа"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_Date, 1 ) == " ") and (r_pmrmprop.TaxPmDate != r_pmdurmpp.TaxPmDate))
      Print_SmallStr(r_pmrmprop.TaxPmDate, r_pmdurmpp.TaxPmDate, "Дата налогового документа"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_TypeCode, 1 ) == " ") and (r_pmrmprop.TaxPmType != r_pmdurmpp.TaxPmType))
      Print_SmallStr(r_pmrmprop.TaxPmType, r_pmdurmpp.TaxPmType, "Код типа налогового платежа"); i = i+1;
   end;

  if( needKZ )
    if( (SubStr( locked, INRQ_PF_KZ_KNP_Name, 1 ) == " ") AND (r_pmkz.groundcode != r_pmdupkz.groundcode) )
      Print_SmallStr(getKNPName(r_pmkz.GroundCode), getKNPName(r_pmdupkz.GroundCode), "Код назначения платежа"); i = i+1;
    end;
    if( (SubStr( locked, INRQ_PF_KZ_PayerCode, 1 ) == " ") AND (r_pmkz.PayerCode != r_pmdupkz.PayerCode) )
      Print_SmallStr(r_pmkz.PayerCode, r_pmdupkz.PayerCode, "Код отправителя денег"); i = i+1;
    end;
    if( (SubStr( locked, INRQ_PF_KZ_RecieverCode, 1 ) == " ") AND (r_pmkz.ReceiverCode != r_pmdupkz.ReceiverCode) )
      Print_SmallStr(r_pmkz.ReceiverCode, r_pmdupkz.ReceiverCode, "Код бенефициара"); i = i+1;
    end;
    if( (SubStr( locked, INRQ_PF_KZ_COUNTRY_PAYER, 1 ) == " ") AND (r_pmkz.PayerCountry != r_pmdupkz.PayerCountry) )
      Print_SmallStr(r_pmkz.PayerCountry, r_pmdupkz.PayerCountry, "Код страны отправителя"); i = i+1;
    end;
    if( (SubStr( locked, INRQ_PF_KZ_COUNTRY_RECEIVER, 1 ) == " ") AND (r_pmkz.ReceiverCountry != r_pmdupkz.ReceiverCountry) )
      Print_SmallStr(r_pmkz.ReceiverCountry, r_pmdupkz.ReceiverCountry, "Код страны получателя"); i = i+1;
    end; 
    if((SubStr( locked, INRQ_PF_KZ_OPERATIONCODE, 1 ) == " ") and (r_pmkz.OperationCode != r_pmdupkz.OperationCode))
      Print_SmallStr(r_pmkz.OperationCode, r_pmdupkz.OperationCode, "Код операции"); i = i+1;
    end;
  end;

   Print_Kolvo(i);
end;
return;
END;

MACRO Print_ReportHeader()
[                          Отчет о групповой верификации                        ];
[                        валютных документов и дубликатов                       ];
[───────────────────────────────────────────────────────────────────────────────];
END;

MACRO Print_ReportItog()
  Print_Itog();
END;

macro Print_FIID(fiid1, fiid2)
   Print_SmallStr(fiid1, fiid2, "Валюта");
end;

macro Print_Reference(pn1,pn2)
   Print_LargeStr("'"+pn1+"'","'"+pn2+"'","Ссылка");
end;

macro Print_Cround(pn1,pn2)
   Print_LargeStr("'"+pn1+"'","'"+pn2+"'","Детали платежа");
end;

private macro Print_Charges(c1, c2)
  var str_1:string = "", str_2:string = "";

    if( c1 == 1 ) str_1 = "OUR";
  elif( c1 == 2 ) str_1 = "SHA";
  else            str_1 = "BEN";
   end;

    if( c2 == 1 ) str_2 = "OUR";
  elif( c2 == 2 ) str_2 = "SHA";
  else            str_2 = "BEN";
   end;
  Print_SmallStr(str_1, str_2, "Комиссии и расходы");
end;

private MACRO GetVOCode(VO_Code)
  FILE llval(llvalues) key 0;
  var Code = "";
  llval.List = 1805;
  llval.Element = VO_Code;
  if( getEQ(llval) )
    return llval.Code;
  end;
  return Code;
END;

PRIVATE MACRO Print_ReportPMCO(locked, i)
  
  if((SubStr(locked, kz_pf_kzIPS, 1) == " ") and (r_pmco.ContractUIN != r_pmdupco.ContractUIN))
    Print_SmallStr(r_pmco.ContractUIN, r_pmdupco.ContractUIN, "Уникальный номер контракта"); i = i+1;
  end;

  if((SubStr(locked, kz_pf_kzContractNumber, 1) == " ") and (r_pmco.ContractNumber != r_pmdupco.ContractNumber))
    Print_SmallStr(r_pmco.ContractNumber, r_pmdupco.ContractNumber, "Номер контракта"); i = i+1;
  end;

  if((SubStr(locked, kz_pf_kzContractDate, 1) == " ") and (r_pmco.ContractDate != r_pmdupco.ContractDate))
    Print_SmallStr(r_pmco.ContractDate, r_pmdupco.ContractDate, "Дата контракта"); i = i+1;
  end;
   
  SetParm(1,i);
end;

MACRO CP_Print_Report()
  
  var i:integer = 0;
  var needKZ:bool = needUseKZpm();

// шапка
if( r_pmpaym.DocKind == PS_ORDER )
[
  Для дубликата валютного платежного документа
     Номер:              #########################
     Сумма перевода:     ############################
     Валюта перевода:    #####
     Дата валютирования: ################
  Найдено валютное платежное поручение
     Номер               ##########################
     Сумма перевода:     ############################
     Валюта перевода:    #####
     Дата валютирования: ################
]
( r_pmdurmpp.Number:l, r_pmdupaym.BaseAmount:l:f, ПолучитьКодФинИН(r_pmdupaym.BaseFIID):l, r_pmdupaym.ValueDate:l,
   r_pmrmprop.Number:l,  r_pmpaym.BaseAmount:l:f, ПолучитьКодФинИН(r_pmpaym.BaseFIID):l,  r_pmpaym.ValueDate:l);
else
[
  Для дубликата валютного платежа банка
     Номер:              #########################
     Сумма перевода:     ############################
     Валюта перевода:    #####
     Дата валютирования: ################
  Найден валютный платеж банка
     Номер               ##########################
     Сумма перевода:     ############################
     Валюта перевода:    #####
     Дата валютирования: ################
]
( r_pmdurmpp.Number:l, r_pmdupaym.BaseAmount:l:f, ПолучитьКодФинИН(r_pmdupaym.BaseFIID):l, r_pmdupaym.ValueDate:l,
  r_pmrmprop.Number:l, r_pmpaym.BaseAmount:l:f, ПолучитьКодФинИН(r_pmpaym.BaseFIID):l, r_pmpaym.ValueDate:l);
end;

  // Ведомость расхождения печатается при соответствующей настройке
  if( pr_rep )
    Print_Head();

    if( (substr(locked, IfThenElse( needKZ, kz_pf_Number, CP_PF_NUMBER ), 1) == " ") and 
        (r_pmrmprop.Number != r_pmdurmpp.Number) )
      Print_SmallStr(r_pmrmprop.Number, r_pmdurmpp.Number, "Номер"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, kz_pf_Date, CP_PF_DATE ), 1) == " ") and
        (r_pmrmprop.Date != r_pmdurmpp.Date) )
       Print_SmallStr(r_pmrmprop.Date, r_pmdurmpp.Date, "Дата"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_pf_ValueDate, CP_PF_VALUEDATE ), 1) == " ") and
        (r_pmpaym.ValueDate != r_pmdupaym.ValueDate) )
       Print_SmallStr(r_pmpaym.ValueDate, r_pmdupaym.ValueDate, "Валютирование"); i = i+1;
    end;

    if( not needKZ )
      if( (substr(locked, CP_PF_P_FICODE, 1) == " ") and
          (r_pmpaym.FIID != r_pmdupaym.FIID) )
        Print_FIID(ПолучитьКодФинИН(r_pmpaym.FIID), ПолучитьКодФинИН(r_pmdupaym.FIID)); i = i+1;
      end;
      if( (substr( locked, CP_PF_CORRACCNOSTRO, 1 ) == " ") and 
          (r_pmrmprop.ReceiverCorrAccNostro != r_pmdurmpp.ReceiverCorrAccNostro) )
        Print_SmallStr(r_pmrmprop.ReceiverCorrAccNostro, r_pmdurmpp.ReceiverCorrAccNostro, "Корсчет банка бенефициара"); i = i+1;
      end;
    else
      if( (substr(locked, KZ_PF_Reference, 1) == " ") and (r_pmrmprop.Reference != r_pmdurmpp.Reference) )
        Print_Reference(r_pmrmprop.Reference, r_pmdurmpp.Reference); i = i+1;
      end;
      if( (SubStr( locked, KZ_PF_KNP_Name, 1 ) == " ") AND (r_pmkz.groundcode != r_pmdupkz.groundcode) )
        Print_SmallStr(getKNPName(r_pmkz.GroundCode), getKNPName(r_pmdupkz.GroundCode), "Код назначения платежа"); i = i+1;
      end;
      if( (SubStr( locked, KZ_PF_kzPayerCode, 1 ) == " ") AND (r_pmkz.PayerCode != r_pmdupkz.PayerCode) )
        Print_SmallStr(r_pmkz.PayerCode, r_pmdupkz.PayerCode, "Код отправителя денег"); i = i+1;
      end;
      if( (SubStr( locked, KZ_PF_kzReceiverCode, 1 ) == " ") AND (r_pmkz.ReceiverCode != r_pmdupkz.ReceiverCode) )
        Print_SmallStr(r_pmkz.ReceiverCode, r_pmdupkz.ReceiverCode, "Код бенефициара"); i = i+1;
      end;
      if( (SubStr( locked, KZ_PF_kzPayerCountry, 1 ) == " ") AND (r_pmkz.PayerCountry != r_pmdupkz.PayerCountry) )
        Print_SmallStr(r_pmkz.PayerCountry, r_pmdupkz.PayerCountry, "Код страны отправителя"); i = i+1;
      end;
      if( (SubStr( locked, KZ_PF_kzReceiverCountry, 1 ) == " ") AND (r_pmkz.ReceiverCountry != r_pmdupkz.ReceiverCountry) )
        Print_SmallStr(r_pmkz.ReceiverCountry, r_pmdupkz.ReceiverCountry, "Код страны получателя"); i = i+1;
      end; 
      if((SubStr( locked, kz_pf_kzOperationCode, 1 ) == " ") and (r_pmkz.OperationCode != r_pmdupkz.OperationCode))
        Print_SmallStr(r_pmkz.OperationCode, r_pmdupkz.OperationCode, "Код операции"); i = i+1;
      end;
    end;

    if( (substr( locked, IfThenElse( needKZ, kz_pf_Amount, CP_PF_ORDERAMOUNT ), 1 ) == " ") and 
        (r_pmpaym.OrderAmount != r_pmdupaym.OrderAmount) )
      Print_Amount(r_pmpaym.OrderAmount, r_pmdupaym.OrderAmount, "Сумма перевода"); i = i+1;
    end;
    if( (substr( locked, IfThenElse( needKZ, KZ_PF_FI_Code, CP_PF_ORDERFICODE ), 1 ) == " ") and 
        (r_pmpaym.OrderFIID != r_pmdupaym.OrderFIID) )
      Print_SmallStr(ПолучитьКодФинИН(r_pmpaym.OrderFIID), ПолучитьКодФинИН(r_pmdupaym.OrderFIID), "Валюта перевода"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_PayerAccount, CP_PF_PAYERACCOUNT ), 1) == " ") and
        (r_pmpaym.PayerAccount != r_pmdupaym.PayerAccount) )
      Print_SmallStr(r_pmpaym.PayerAccount, r_pmdupaym.PayerAccount, "Счет плательщика"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_PayerCodeKind, CP_PF_P_CK ), 1) == " ") and
        (r_pmpaym.PayerCodeKind != r_pmdupaym.PayerCodeKind) )
      Print_SmallStr(r_pmpaym.PayerCodeKind, r_pmdupaym.PayerCodeKind, "Вид кода плательщика"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_PayerCode, CP_PF_P_CODE ), 1) == " ") and
        (r_pmpaym.PayerCode != r_pmdupaym.PayerCode) )
      Print_SmallStr(r_pmpaym.PayerCode, r_pmdupaym.PayerCode, "Код плательщика"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_PayerName, CP_PF_P_NAME ), 1) == " ") and 
        (r_pmrmprop.PayerName != r_pmdurmpp.PayerName) )
      Print_PayerName(r_pmrmprop.PayerName, r_pmdurmpp.PayerName); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_ReceiverCorrBankName, CP_PF_CORR_NAME ), 1) == " ") and
        (r_pmrmprop.ReceiverCorrBankName != r_pmdurmpp.ReceiverCorrBankName) )
      Print_LargeStr("'"+r_pmrmprop.ReceiverCorrBankName+"'","'"+r_pmdurmpp.ReceiverCorrBankName+"'", "Название банка посредника"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_ReceiverBankName, CP_PF_NAME ), 1) == " ") and
        (r_pmrmprop.ReceiverBankName != r_pmdurmpp.ReceiverBankName) )
      Print_ReceiverBankName(r_pmrmprop.ReceiverBankName, r_pmdurmpp.ReceiverBankName); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_ReceiverCodeKind, CP_PF_R_CK ), 1) == " ") and
        (r_pmpaym.ReceiverCodeKind != r_pmdupaym.ReceiverCodeKind) )
      Print_SmallStr(r_pmpaym.ReceiverCodeKind, r_pmdupaym.ReceiverCodeKind, "Вид кода получателя"); i = i+1;
    end;

    if( (substr(locked, IfThenElse( needKZ, KZ_PF_ReceiverCode, CP_PF_R_CODE ), 1) == " ") and 
        (r_pmpaym.ReceiverCode != r_pmdupaym.ReceiverCode) )
      Print_SmallStr(r_pmpaym.ReceiverCode, r_pmdupaym.ReceiverCode, "Код получателя"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_ReceiverAccount, CP_PF_RECEIVERACCOUNT ), 1) == " ") and 
        (r_pmpaym.ReceiverAccount != r_pmdupaym.ReceiverAccount) )
      Print_SmallStr(r_pmpaym.ReceiverAccount, r_pmdupaym.ReceiverAccount, "Счет получателя"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_ReceiverName, CP_PF_BENEFICIARY ), 1) == " ") and 
        (r_pmrmprop.ReceiverName != r_pmdurmpp.ReceiverName) )
      Print_ReceiverName(r_pmrmprop.ReceiverName, r_pmdurmpp.ReceiverName); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_IsInstancy, CP_PF_INSTANCY ), 1) == " ") and 
        (r_pmrmprop.Instancy != r_pmdurmpp.Instancy) )
      Print_SmallStr(r_pmrmprop.Instancy, r_pmdurmpp.Instancy, "Срочность"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_NumberPack, CP_PF_NUMBERPACK ), 1) == " ") and 
        (r_pmpaym.NumberPack != r_pmdupaym.NumberPack) )
      Print_SmallStr(r_pmpaym.NumberPack, r_pmdupaym.NumberPack, "Номер пачки"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_Priority, CP_PF_PRIORITY ), 1) == " ") and 
        (r_pmrmprop.Priority != r_pmdurmpp.Priority) )
      Print_SmallStr(r_pmrmprop.Priority, r_pmdurmpp.Priority, "Очередность платежа"); i = i+1;
    end;

    if( not needKZ )
      if( (substr( locked, CP_PF_INSTRUCTIONCODE, 1 ) == " ") and (r_pmrmprop.InstructionCode != r_pmdurmpp.InstructionCode) )
        Print_LargeStr("'"+r_pmrmprop.InstructionCode+"'", "'"+r_pmdurmpp.InstructionCode+"'", "Код инструкции"); i=i+1;
      end;
      if( (substr( locked, CP_PF_COMISSFICODE, 1 ) == " ") and (r_pmpaym.ComissFIID != r_pmdupaym.ComissFIID) )
        Print_SmallStr(ПолучитьКодФинИН(r_pmpaym.ComissFIID), ПолучитьКодФинИН(r_pmdupaym.ComissFIID), "Валюта комиссии"); i=i+1;
      end;
      if( (substr( locked, CP_PF_COMISSACCOUNT, 1 ) == " ") and (r_pmpaym.ComissAccount != r_pmdupaym.ComissAccount) )
        Print_SmallStr(r_pmpaym.ComissAccount, r_pmdupaym.ComissAccount, "Счет плательщика"); i = i+1;
      end;
    else
      if( (substr( locked, KZ_PF_PayerINN, 1 ) == " ") and (r_pmrmprop.PayerINN != r_pmdurmpp.PayerINN) )
        Print_PayerINN(r_pmrmprop.PayerINN,r_pmdurmpp.PayerINN); i = i+1;
      end;
    end;
    // общее
    if( ( substr(locked, IfThenElse( needKZ, KZ_PF_Ground, CP_PF_R_INN ), 1) == " " ) and
        (r_pmrmprop.ReceiverINN != r_pmdurmpp.ReceiverINN) )
      Print_ReceiverINN(r_pmrmprop.ReceiverINN, r_pmdurmpp.ReceiverINN); i=i+1;
    end;
    if( ( substr(locked, IfThenElse( needKZ, KZ_PF_Ground, CP_PF_GROUND ), 1) == " " ) and
        (r_pmrmprop.Ground != r_pmdurmpp.Ground) )
      Print_Cround(r_pmrmprop.Ground, r_pmdurmpp.Ground); i=i+1;
    end;
    if( ( substr(locked, IfThenElse( needKZ, KZ_PF_COMISSCODE, CP_PF_COMISSCODE ), 1) == " " ) and
        (r_pmrmprop.ComissCharges != r_pmdurmpp.ComissCharges) )
      Print_Charges(r_pmrmprop.ComissCharges,r_pmdurmpp.ComissCharges); i=i+1;
    end;

    if( (substr(locked, IfThenElse( needKZ, KZ_PF_CorrCodeKind, CP_PF_CORR_CK ), 1) == " ") and
        (r_credit.CorrCodeKind != r_ducredit.CorrCodeKind) )
      Print_SmallStr(r_credit.CorrCodeKind, r_ducredit.CorrCodeKind, "Вид кода банка посредника"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_CorrCode, CP_PF_CORR_CODE ), 1) == " ") and 
        (r_credit.CorrCode != r_ducredit.CorrCode) )
      Print_SmallStr(r_credit.CorrCode, r_ducredit.CorrCode, "Код банка посредника"); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_CodeKind, CP_PF_CODEKIND ), 1) == " ") and
        (r_credit.CodeKind != r_ducredit.CodeKind) )
      Print_CodeKind(r_credit.CodeKind, r_ducredit.CodeKind); i = i+1;
    end;
    if( (substr(locked, IfThenElse( needKZ, KZ_PF_BankCode, CP_PF_BANKCODE ), 1) == " ") and
        (r_credit.BankCode != r_ducredit.BankCode) )
      Print_SmallStr(r_credit.BankCode, r_ducredit.BankCode, "Код банка получателя"); i = i+1;
    end;
   
    if( needKZ ) // валютные реквизиты есть только в панели казахстана
      Print_ReportPMCO( locked, i );
    end;

    Print_Kolvo(i);
  end;
END;

MACRO Print_Report()

  if( r_pmdupaym.DocKind == PS_DURQ )
    RQ_Print_Report();
  else
    CP_Print_Report();
  end;

END;