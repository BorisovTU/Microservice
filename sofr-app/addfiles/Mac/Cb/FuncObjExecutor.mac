/*
$Name:           FuncObjExecutor.mac
$Module:         Ядро ГКБО
$Description:    Реализация класса RslFuncObjExecutor
*/

import RSD, "FuncObj.mac", "globals.mac";

class RslFuncObjExecutor(url:string, maxThreads:integer)

  var m_taskID = 0, 
      m_execID = 0, 
      m_convTypeID = 0,
      m_operationID = 0;

  // добавляет задание в очередь
  macro Add(request:string, timeOut:integer, priority:integer, taskID:integer, execID:integer, convTypeID:integer, operationID:integer, packID:integer)
    m_taskID      = taskID     ;
    m_execID      = execID     ;
    m_convTypeID  = convTypeID ;
    m_operationID = operationID;

    var cmd, rs;

    cmd = RSDCommand( " INSERT INTO dfuncobjcnv_dbt (T_TASKID, T_EXECID, T_CONVTYPEID, T_OPERATIONID, T_PACKID) " +
                      " VALUES (?, ?, ?, ?, ?) RETURNING T_FUNCOBJID INTO ?" );

    cmd.addParam( "", RSDBP_IN, taskID                        );  // T_TASKID      
    cmd.addParam( "", RSDBP_IN, execID                        );  // T_EXECID      
    cmd.addParam( "", RSDBP_IN, convTypeID                    );  // T_CONVTYPEID  
    cmd.addParam( "", RSDBP_IN, operationID                   );  // T_OPERATIONID 
    cmd.addParam( "", RSDBP_IN, packID                        );  // T_PACKID      
   
    cmd.addParam( "T_FUNCOBJID", RSDBP_OUT, V_INTEGER );  // T_FUNCOBJID

    cmd.execute();
    var FuncObjID = cmd.value("T_FUNCOBJID");

    var FuncObjParam = "taskID=" + taskID + ",execID=" + execID + ",convTypeID=" + convTypeID + ",operationID=" + operationID + ",packID=" + packID + ",funcObjID=" + FuncObjID;

    cmd = RSDCommand( " INSERT INTO dfuncobj_dbt (T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_STATE, T_ERRORCODE, T_ERRORTEXT, T_ERRORDATETIME, T_EXECCOUNT, T_MODULE, T_PRIORITY, T_VERSION, T_SESSIONID, T_OPER, T_DATA) " +
                          " VALUES (?, ?, ?, ?, ?, ?, ?, NULL, ?, ?, NVL((SELECT T_PRIORITY FROM DCNVOPRTYPE_DBT WHERE T_OPERATIONID = ?), ?), ?, ?, ?, ?)  " );
   
    cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE,   
    cmd.addParam( "", RSDBP_IN, FuncObjID                     );  // T_OBJECTID,     
    cmd.addParam( "", RSDBP_IN, 110                           );  // T_FUNCID,       
    cmd.addParam( "", RSDBP_IN, FuncObjParam                  );  // T_PARAM,        
    cmd.addParam( "", RSDBP_IN, 0                             );  // T_STATE,        
    cmd.addParam( "", RSDBP_IN, 0                             );  // T_ERRORCODE,    
    cmd.addParam( "", RSDBP_IN, ""                            );  // T_ERRORTEXT,    
    // cmd.addParam( "", RSDBP_IN, NULL                       );  // T_ERRORDATETIME,
    cmd.addParam( "", RSDBP_IN, 0                             );  // T_EXECCOUNT,    
    cmd.addParam( "", RSDBP_IN, 0                             );  // T_MODULE,
    cmd.addParam( "", RSDBP_IN, operationID                   );  // T_OPERATIONID,
    cmd.addParam( "", RSDBP_IN, 30                            );  // PRIORITY DEFAULT,     
    cmd.addParam( "", RSDBP_IN, 0                             );  // T_VERSION,      
    cmd.addParam( "", RSDBP_IN, 0                             );  // T_SESSIONID,    
    cmd.addParam( "", RSDBP_IN, {oper}                        );  // T_OPER,         
    cmd.addParam( "", RSDBP_IN, request                       );  // T_DATA          

    cmd.execute();
  end;

  // добавляет задание в очередь с приоритезацией запросов
  macro AddRequestWithConvPriority(request:string, timeOut:integer, priority:integer, convPriority: integer)
    if (timeOut == null)
      timeOut = 0;
    end;

    if (priority == null)
      priority = 0;
    end;

    if (convPriority == null)
      convPriority = 0;
    end;

    //executor.addRequestWithConvPriority(request, timeOut, priority, convPriority);
  end;


  // запускает выполнение всех заданий из очереди
  macro Run()
    //executor.run();
  end;

  // выполняет проверку окончания выполнения
  macro IsFinish()
   // return executor.isFinish();
   return false;
  end;


  // приостановка выполнения заданий
  macro Pause()
    //executor.pause();
  end;


  // полностью "обнуляет" класс и готовит его для новой процедуры распараллеливания
  macro Reset()
    // executor.reset();
  end;


  // очищает очередь заданий
  macro clearQueue()
    // executor.clearQueue();
  end;


  // Сколько пакетов находится в очереди на выполнение
  macro GetWaitingTaskCount()
    //return executor.getWaitingTaskCount();
    var cmd, rs;
    var resCount = 0;

    cmd = RSDCommand( " SELECT count(1)                                  " +
                      " FROM DFUNCOBJ_DBT                                " +
                      " WHERE T_OBJECTTYPE = ?                           " +
                      "   AND T_STATE = ?                                " +
                      "   AND T_OBJECTID IN ( SELECT T_FUNCOBJID         " +
                      "                       FROM dfuncobjcnv_dbt       " +
                      "                      WHERE T_TASKID = ?          " +
                      "                        AND T_EXECID = ?          " +
                      "                        AND T_CONVTYPEID = ?      " +
                      "                        AND T_OPERATIONID = ? )   ");

    cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_OK              );  // T_STATE
    cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
    cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID      
    cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID  
    cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
   

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = int(rs.value(0));
    end;

    return resCount;
  end;


  // Сколько сервисов выполнено успешно
  macro GetSuccessTaskCount()
    //return executor.getSuccessTaskCount();
    var cmd, rs;
    var resCount = 0;

    cmd = RSDCommand( "SELECT COUNT(hist.T_ID)                                    " +
                      "FROM DFUNCOBJ_HIST_DBT hist,DFUNCOBJ_HISTPARM_DBT histparm " +
                      "WHERE hist.T_OBJECTTYPE = ?                                " +
                      "AND hist.T_ID = histparm.T_HISTID                          " +
                      "AND histparm.T_STATE = ?                                   " +
                      "AND hist.T_OBJECTID IN ( SELECT T_FUNCOBJID                " +
                      "                           FROM dfuncobjcnv_dbt            " +
                      "                          WHERE T_TASKID = ?               " +
                      "                            AND T_EXECID = ?               " +
                      "                            AND T_CONVTYPEID = ?           " +
                      "                            AND T_OPERATIONID = ? )        ");

    cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_PROCESS         );  // T_STATE
    cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
    cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID      
    cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID  
    cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
   

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = int(rs.value(0));
    end;

    return resCount;
  end;


  // Сколько сервисов выполнено с ошибкой
  macro GetFaultTaskCount()
    // return executor.getFaultTaskCount();
    var cmd, rs;
    var resCount = 0;

    cmd = RSDCommand( " SELECT count(1)                                  " +
                      " FROM DFUNCOBJ_DBT                                " +
                      " WHERE T_OBJECTTYPE = ?                           " +
                      "   AND T_STATE IN (?)                             " +
                      "   AND T_OBJECTID IN ( SELECT T_FUNCOBJID         " +
                      "                       FROM dfuncobjcnv_dbt       " +
                      "                      WHERE T_TASKID = ?          " +
                      "                        AND T_EXECID = ?          " +
                      "                        AND T_CONVTYPEID = ?      " +
                      "                        AND T_OPERATIONID = ? )   ");

    cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_FATAL_ERROR     );  // T_STATE
    cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
    cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID      
    cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID  
    cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
   

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = int(rs.value(0));
    end;

    cmd = RSDCommand( "SELECT COUNT(DISTINCT hist.T_ID)                           " +
                      "FROM DFUNCOBJ_HIST_DBT hist,DFUNCOBJ_HISTPARM_DBT histparm " +
                      "WHERE hist.T_OBJECTTYPE = ?                                " +
                      "AND hist.T_ID = histparm.T_HISTID                          " +
                      "AND histparm.T_STATE IN (?)                                " +
                      "AND hist.T_OBJECTID IN ( SELECT T_FUNCOBJID                " +
                      "                           FROM dfuncobjcnv_dbt            " +
                      "                          WHERE T_TASKID = ?               " +
                      "                            AND T_EXECID = ?               " +
                      "                            AND T_CONVTYPEID = ?           " +
                      "                            AND T_OPERATIONID = ? )        ");

    cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_FATAL_ERROR     );  // T_STATE
    cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
    cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID      
    cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID  
    cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
   

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = resCount + int(rs.value(0));
    end;


    return resCount;
  end;


  // Сколько сервисов в работе
  macro GetWorkingTaskCount()
    var cmd, rs;
    var resCount = 0;

    //return executor.getWorkingTaskCount();
    cmd = RSDCommand( "SELECT COUNT(DISTINCT hist.T_ID)                           " +
                      "FROM DFUNCOBJ_HIST_DBT hist                                " +
                      "WHERE hist.T_OBJECTTYPE = ?                                " +
                      "AND hist.T_ID = histparm.T_HISTID                          " +
                      "AND (SELECT MAX(histparm.T_STATE) FROM DFUNCOBJ_HISTPARM_DBT histparm WHERE histparm.T_HISTID = hist.T_ID) = 0" +
                      "AND hist.T_OBJECTID IN ( SELECT T_FUNCOBJID                " +
                      "                           FROM dfuncobjcnv_dbt            " +
                      "                          WHERE T_TASKID = ?               " +
                      "                            AND T_EXECID = ?               " +
                      "                            AND T_CONVTYPEID = ?           " +
                      "                            AND T_OPERATIONID = ? )        ");

    cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
    cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID      
    cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID  
    cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
   

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = int(rs.value(0));
    end;

    return resCount;
  end;

  
  // Получить спсок ошибок
  macro GetFaultTasks( clearList )
     var i = 0;
     var ArrErr = TArray;
     var cmd, rs;
     var resCount = 0;

     cmd = RSDCommand( " SELECT T_ERRORTEXT                               " +
                       " FROM DFUNCOBJ_DBT                                " +
                       " WHERE T_OBJECTTYPE = ?                           " +
                       "   AND T_STATE <> ?                               " +
                       "   AND T_ERRORTEXT IS NOT NULL                    " +
                       "   AND T_ERRORTEXT <> CHR(1)                      " +
                       "   AND T_OBJECTID IN ( SELECT T_FUNCOBJID         " +
                       "                       FROM dfuncobjcnv_dbt       " +
                       "                      WHERE T_TASKID = ?          " +
                       "                        AND T_EXECID = ?          " +
                       "                        AND T_CONVTYPEID = ?      " +
                       "                        AND T_OPERATIONID = ? )   ");

     cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
     cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_OK              );  // T_STATE
     cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
     cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID      
     cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID  
     cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
    

     rs = RsdRecordset( cmd );
     if( rs and rs.moveNext() )
        ArrErr[i] = rs.value(0);
        i = i + 1;
     end;

     return ArrErr;
  end;

  macro SetCnvPackError()
     var sqlString = "UPDATE dcnvpack_dbt pck SET (t_Error, t_ErrMsg)  = (SELECT T_ERRORCODE, T_ERRORTEXT " +
                                                                         "  FROM DFUNCOBJ_DBT fun, DFUNCOBJCNV_DBT funobj " + 
                                                                         "  WHERE fun.T_OBJECTTYPE = ? " +
                                                                         "  AND fun.T_OBJECTID = funobj.T_FUNCOBJID " + 
                                                                         "  AND funobj.T_TASKID = ? " + 
                                                                         "  AND pck.t_ExecID = funobj.T_EXECID " +  
                                                                         "  AND pck.t_ConvTypeID = funobj.T_CONVTYPEID " +
                                                                         "  AND funobj.T_OPERATIONID = ? " +
                                                                         "  AND pck.t_PackID = funobj.t_PackID) " + 
                    " WHERE pck.t_ExecID = ? " +
                    " AND pck.t_ConvTypeID = ? " +
                    " AND pck.t_Error = 0 " +
                    " AND (pck.t_ErrMsg IS NULL OR pck.t_ErrMsg = chr(1)) " +
                    //если без этой проверки делать update, то мы всегда t_error делаем NULL, что ломает прикладную логику
                    " AND EXISTS " +
                    "        (SELECT 1 " +
                    "           FROM DFUNCOBJ_DBT fun, DFUNCOBJCNV_DBT funobj " +
                    "          WHERE     fun.T_OBJECTTYPE = ? " +
                    "                AND fun.T_OBJECTID = funobj.T_FUNCOBJID " +
                    "                AND funobj.T_TASKID = ? " +
                    "                AND pck.t_ExecID = funobj.T_EXECID " +
                    "                AND pck.t_ConvTypeID = funobj.T_CONVTYPEID " +
                    "                AND funobj.T_OPERATIONID = ? " +
                    "                AND pck.t_PackID = funobj.t_PackID) ";


     var cmd = RSDCommand( sqlString );
     cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
     cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
     cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 
     cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID
     cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID            
     cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
     cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID      
     cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID 

     cmd.Execute();

     sqlString = "UPDATE dcnvpack_dbt pck SET t_ErrMsg = NVL((SELECT T_ACTIONTEXT " +
                                                             "  FROM DFUNCOBJ_HIST_DBT hist, DFUNCOBJ_HISTPARM_DBT histparm, DFUNCOBJCNV_DBT funobj " + 
                                                             " WHERE hist.T_OBJECTTYPE = ? " +
                                                             "   AND hist.T_ID = histparm.T_HISTID " +
                                                             "   AND histparm.T_STATE IN (?) " +
                                                             "   AND hist.T_OBJECTID = funobj.T_FUNCOBJID " + 
                                                             "   AND funobj.T_TASKID = ? " +  
                                                             "   AND pck.t_ExecID = funobj.T_EXECID " +
                                                             "   AND pck.t_ConvTypeID = funobj.T_CONVTYPEID " +
                                                             "   AND funobj.T_OPERATIONID = ? " +
                                                             "   AND pck.t_PackID = funobj.t_PackID), chr(1)) " +
                 " WHERE pck.t_ExecID = ? " +
                 "   AND pck.t_ConvTypeID = ? " +
                 "   AND pck.t_Error = 0 " +
                 "   AND (pck.t_ErrMsg IS NULL OR pck.t_ErrMsg = chr(1)) " ; 

     cmd = RSDCommand( sqlString );
     cmd.addParam( "", RSDBP_IN, 4600                          );  // T_OBJECTTYPE
     cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_FATAL_ERROR     );  // T_STATE
     cmd.addParam( "", RSDBP_IN, m_taskID                      );  // T_TASKID
     cmd.addParam( "", RSDBP_IN, m_operationID                 );  // T_OPERATIONID
     cmd.addParam( "", RSDBP_IN, m_execID                      );  // T_EXECID
     cmd.addParam( "", RSDBP_IN, m_convTypeID                  );  // T_CONVTYPEID            
         
     cmd.Execute();
  end;

  macro Destructor
/*
    if(executor != NULL)
      executor.reset();
    end;
*/
  end;

end;