/************************************************************************/
/*                                                                      */   
/* Репликация операционистов в 5.50 через Шлюз                          */
/*                                                                      */
/************************************************************************/

import ServiceAction, BankInter, globals, CTInter, PTInter, Календарь, mfo_lib;


var nCount : integer;

 

MACRO ActionOperman( macroFuncName, ParmForFunc, ErrorMessage : @string )
  var error : string;
  var locale:string = "";
  GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_5.50\\SERVICE_PATH", V_STRING, locale, error);
  
  if(error != 0)
    msgbox("Ошибка pежима задания пути к сервису ТК 5.50."); 
    exit;   
  end;

//url - путь к web-сервису = значение настройки "COMMON\WORK_MODE\WORK_WITH_5.50\SERVICE_PATH" 
  var url = locale;   
  var method = "XMLRPCCall";   
  var outParams;   
  var encoding;   
  var outResponse;   
  var errMsg:string;   
  var obj;   
  var i = 0;   
  var guid = CreateGUID();   
  var mes = TXRRequest();   
  mes.reqId = CreateGUID();   
//mes.macroName - название макрофайла обработки запроса   
  mes.macroName = "ws_operman";   
//mes.macroFunc - название макрофункции обработки запроса   
  mes.macroFunc = macroFuncName;   
  mes.direction = "1";   
//mes.Parm - параметр макрофункции   
  mes.Parm = ParmForFunc;  
  var inParams = TArray;   
  var prm_request = RslSoapPrm;   
  var prm_timeout = RslSoapPrm;   
  var prm_priority = RslSoapPrm;   
  prm_request.Name = "request";   
  prm_request.Value = mes.GenerateMessage();   
  inParams[0] = prm_request;   
  prm_timeout.Name = "timeout";   
  prm_timeout.Value = 0;   
  inParams[1] = prm_timeout;   
  prm_priority.Name = "priority";   
  prm_priority.Value = 0;   
  inParams[2] = prm_priority;   
  var stat = CallSimpleExtService(guid, url, method, inParams, "", "", 0, outParams, encoding, 
                                outResponse, errMsg);
  if(stat)
    ErrorMessage = errMsg;
    return stat;
  else
// создаем MS-парсер
    var xml = CreateXMLParser();   
    xml.validateOnParse = true;   
    xml.async = false;   
// парсим полученный SOAP-ответ   
    var res = xml.loadXML(outResponse);   
    var XMLRPCCallResult = xml.getElementsByTagName("XMLRPCCallResult");   
    var XMLResult = XMLRPCCallResult.item(0).text;   
    stat = ConvertToRsl(XMLResult, obj);   
// проверить существование информации об ошибке в ответе сервиса
    var iprop = GenPropID(obj, "faultString"); 
    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте
      //errMsg = obj.faultString;
      ErrorMessage = obj.faultString;
      return 1;//println("faultString=", obj.faultString);
    end;
   
  end;

  return 0; 
  
END;