/*
$Name:             pmbo1.mac
$Module:           Ядро Banking
$Description:      Макрос шага. Блок - 29010 "Обработка в БО". Шаг - 10 "Передача в бэк-офис"
*/

import PaymInter, BankInter, lnpaym, OprInter, "IncomingPaymentReceive.mac", bnk_common;

var PaymentObj:RsbPayment;

MACRO ExecuteStep( doc, paymDoc ):integer

  var stat = 0;
  PaymentObj.PaymStatus = PM_KVITWAIT;
  
  if( PaymentObj.ToBackOffice == "В" )
    PaymentObj.ReplicationSession = 0;
    PaymentObj.ReplicationBO = "В";
  end;

  if((stat == 0) and Bnk_WorkWithRetail() and (PaymentObj.ToBackOffice == "В"))
    stat = receiveIncomingPayment(PaymentObj.PaymentID, PaymentObj.DocKind);
  end;
  
  return stat;
END;

MACRO CheckStepAction( mes:integer ):integer
  var stat = 0;
  if( mes == OP_BACKOUT_STEP )
    if((stat == 0) and Bnk_WorkWithRetail() and (PaymentObj.ToBackOffice == "В"))
      stat = rollback_receiveIncomingPayment(PaymentObj.PaymentID, PaymentObj.DocKind);
    end;
  end;
 
  return stat;
END;
