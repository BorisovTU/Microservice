/*
$Name:             prpmini.mac 
$Module:           
$Description:      ¥ç âì ¨­ª áá®¢®£® ¯®àãç¥­¨ï (âà¥¡®¢ ­¨¥-¯®àãç¥­¨¥) 
                   à®£à ¬¬¨áâ    : ‘¬¨à­®¢ ‘.‚. SMR PRN     
                   ‘®§¤ ­         : 10.10.02       
*/

import prpm, gnd120p, "pmbudg_lib.mac";

/* ¥ç âì ¨­ª áá®¢®£® ¯®àãç¥­¨ï ¯® 1256-“ */
MACRO PrintIncashRequest1256(ncopy:integer):bool
  var PayerProps   :TPartyProperties = TPartyProperties("Payer",    pr_pmpaym, pr_debet,  pr_pmrmprop);
  var ReceiverProps:TPartyProperties = TPartyProperties("Receiver", pr_pmpaym, pr_credit, pr_pmrmprop);
  var partPayList  :TPartPayList;

  var ground        :string,
      PayDate       :date    = date(0, 0, 0),
      I2_Date       :date    = date(0, 0, 0),
      chargeOffDate :date    = date(0, 0, 0),
      Date_Into     :date,
      ReqSum        :moneyl  = $0.0,
      i             :integer,
      pINN:string, pKPP:string,
      rINN:string, rKPP:string,
      IsBudg :bool = IsBudgetPaym(pr_pmrmprop.rec.TaxAuthorState, pr_pmpaym.rec.PayType);
      
  ground = InterpretGround( pr_pmrmprop.rec.Ground );
  
  ReqSum  = pr_pmpaym.rec.BaseAmount;
  if( pr_pmpaym.rec.DocKind == PS_PAYORDER )
    if(pr_pspayord.rec.DocKind == PSPOKIND_REQUEST)
      PayDate = pr_pspaydem.rec.AcceptDate;
      ReqSum  = pr_pspaydem.rec.ReqSum;
    end;
    partPayList = TPartPayList(pr_pspayord.rec.OrderID);
  end;

  I2_Date       = pr_pmpaym.rec.I2PlaceDate;
  chargeOffDate = pr_pmrmprop.rec.PayerChargeOffDate;
  Date_Into     = pr_pmpaym.rec.PayerBankEnterDate;
  splitINN_KPP(PayerProps.INN,    pINN, pKPP);
  splitINN_KPP(ReceiverProps.INN, rINN, rKPP);
  
  ARRAY SS, SG, SBP, SBR, SP, SR, SQ, UIN;

  strsplit( PayerProps.Name,        SP,    51, 51, 4 );
  strsplit( ReceiverProps.Name,     SR,    51, 51, 4 );
  strsplit( PayerProps.BankName,    SBP,   51, 51, 3 );
  strsplit( ReceiverProps.BankName, SBR,   51, 51, 3 );
  strsplit( ground,                 SG,    68, 68, 3 );
  strsplit( RubToStrAlt(pr_pmpaym.rec.Amount), SS, 60, 60, 4 );
  strsplit( RubToStrAlt(ReqSum),    SQ,    82, 82, 3 );
  strsplit( GetUIN( pr_pmrmprop.rec.Date, pr_pmrmprop.rec.UIN, pr_pmpaym.rec.PayType ), UIN, 13, 13, 2);

  while(ncopy != 0)
    [
                                                                                     ÚÄÄÄÄÄÄÄÄÄ¿
                                                                                     ³ 0401071 ³
         ############            ##########                                          ÀÄÄÄÄÄÄÄÄÄÙ
      ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ®áâã¯. ¢ ¡ ­ª ¯« â.   ‘¯¨á ­® á® áç. ¯« â.

                                                          ##########  #############       ÚÄÄÄÄ¿
      ˆŠ€‘‘‚… “—…ˆ… N #######################      ÄÄÄÄÄÄÄÄÄÄ  ÄÄÄÄÄÄÄÄÄÄÄÄÄ       ³ ## ³
                                                            („ â )    (‚¨¤ ¯« â¥¦ )       ÀÄÄÄÄÙ

      ‘ã¬¬    ³##################################################################################
      ¯à®¯¨áìî³##################################################################################
              ³##################################################################################
     ÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ˆ ############ ³ Š #########                    ³ ‘“ŒŒ€ ³##############################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
      ####################################################³       ³
      ####################################################ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ####################################################³ ‘ç.N. ³##############################
      ####################################################³       ³
      ‹€’…‹œ™ˆŠ                                          ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ####################################################³ ˆŠ   ³##############################
      ####################################################ÃÄÄÄÄÄÄÄ´
      ####################################################³ ‘ç.N. ³##############################
      €Š ‹€’…‹œ™ˆŠ€                                    ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ####################################################³ ˆŠ   ³##############################
      ####################################################ÃÄÄÄÄÄÄÄ´
      ####################################################³ ‘ç.N. ³##############################
      €Š ‹“—€’…‹Ÿ                                     ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ˆ ############ ³ Š #########                    ³ ‘ç.N. ³##############################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
                                                          ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄ
                                                          ³‚¨¤ ¯.³#########    ³          ³
      ####################################################ÃÄÄÄÄÄÄÄ´             ³ ç¥à.¯«. ³ ###
      ####################################################³ §.¯«.³             ³          ³
      ####################################################ÃÄÄÄÄÄÄÄ´             ÃÄÄÄÄÄÄÄÄÄÄ´
      ####################################################³ Š®¤   ³#############³ ¥§.¯®«¥ ³
      ‹“—€’…‹œ                                          ³       ³#############³          ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÂÄÄÄÁÄÄÄÄÄÄÄÄÂÄÁÄÄÄÄÄ
      ####################³ ########### ³ ## ³ ########## ³ ############### ³ ########## ³ ##
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄ
       §­ ç¥­¨¥ ¯« â¥¦ :
      ##########################################################################################
      ##########################################################################################
      ##########################################################################################
                                                                     ##########
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
                                    ®¤¯¨á¨                          â¬¥âª¨ ¡ ­ª  ¯®«ãç â¥«ï

                                                                              
                         ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                          
            Œ..                                                                   „ â  ¯®¬¥é¥­¨ï
                         ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                           ¢ ª àâ®â¥ªã
                                                                                   ##########

      ÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ   â¬¥âª¨ ¡ ­ª 
       N ç.  ³   N ¯« â.  ³  „ â       ³  ‘ã¬¬        ³   ‘ã¬¬      ³ ®¤¯¨áì      ¯« â¥«ìé¨ª 
       ¯« â. ³   ®à¤¥à    ³  ¯« â.     ³  ç áâ¨ç­®£®  ³   ®áâ âª    ³              ##########
             ³            ³  ®à¤¥à     ³  ¯« â¥¦      ³   ¯« â¥¦    ³
    ]
     (Date_Into:f:c, chargeOffDate:f:c, pr_pmrmprop.rec.Date:f:c, GetPaymentKind(pr_pmrmprop.rec.PaymentKind):c, 
      pr_pmrmprop.rec.Number:l, pr_pmrmprop.rec.TaxAuthorState, SQ(0):l, SQ(1):l, SQ(2),
      Str0(pINN, IsBudg), Str0(pKPP, IsBudg), ReqSum:l:f,
      SP(0):l, SP(1):l, SP(2):l, PayerProps.Account:l, SP(3):l,
      SBP(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,PayerProps.BankBIC):l, SBP(1):l, SBP(2):l, PayerProps.BankCorrAccount:l,
      SBR(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,ReceiverProps.BankBIC):l, SBR(1):l, SBR(2):l, ReceiverProps.BankCorrAccount:l,
      Str0(rINN, IsBudg), Str0(rKPP, IsBudg), ReceiverProps.Account:l,
      pr_pmrmprop.rec.ShifrOper:l, 
      SR(0):l, pr_pmrmprop.rec.Priority:z, SR(1):l, SR(2):l, SR(3):l,
      UIN(0),
      UIN(1),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, Str0(pr_pmrmprop.rec.BttTICode,   IsBudg), ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, Str0(pr_pmrmprop.rec.OKATOCode,   IsBudg), ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, Str0(pr_pmrmprop.rec.TaxPmGround, IsBudg), ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, Str0(pr_pmrmprop.rec.TaxPmPeriod, IsBudg), ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, Str0(pr_pmrmprop.rec.TaxPmNumber, IsBudg), ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, Str0(pr_pmrmprop.rec.TaxPmDate,   IsBudg), ""),
      GetForm110Str(pr_pmrmprop),
      SG(0):l,SG(1):l,SG(2):l,
      pr_pmpaym.rec.ReceiverBankMarkDate:f, I2_Date:f, pr_pmpaym.rec.PayerBankMarkDate:f );

    
    if( pr_pmpaym.rec.DocKind == PS_PAYORDER )
      if( partPayList.size )
        [ ÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ];
      end;
      i = 0;
      while(i < partPayList.size)
        [  ##### ³ ########## ³ ########## ³ ############ ³ ########### ³]
        ( partPayList.Value(i).SubPurp:l, 
          partPayList.Value(i).Number:l, 
          partPayList.Value(i).PayDate:f:c,
          partPayList.Value(i).Amount:l:f,
          partPayList.Value(i).Rest:l:f );
        i=i+1;
      end;
    end;
    [ ÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ
    ];
    
    ncopy = ncopy - 1;
  end;
  
  return TRUE;
  
END;

MACRO PrintIncashRequest(ncopy:integer):bool
  var isPrintEOF:bool;               // ¥ç âì á¨¬¢®«  ®ª®­ç ­¨ï «¨áâ 
  if( not GetParm( 1, isPrintEOF ) ) // ¯® ã¬®«ç ­¨î ¯¥ç â âì ­ ¤®
    isPrintEOF = true;
  end;        
  if( pr_PrintEA )
    PrintEAHeader();
  end;
  var stat = 0;
  stat = PrintIncashRequest1256(ncopy);
  if( isPrintEOF )
    PrintEOF();
  end;
  return stat;
END;