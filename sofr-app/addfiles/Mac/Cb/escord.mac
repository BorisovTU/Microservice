/******************************************************************************
    Макрос печати платежа в форме СБ "Эскорд"

    13.08.2001 Бизяев А., Бабин А.
******************************************************************************/
IMPORT BankInter, PTInter, OprInter, PaymInter, FIInter, globals, prpm, 
 cryptdlm, MesInter, rsd;

RECORD party_record (party);
RECORD fininstr_record (fininstr); 

FILE pmpopknd( pmpopknd ) key 0;

/*
FILE wlpm_escord( wlpm ) key 1; /*PaymentID+Direct+WlPmNum*/
FILE wlmeslnk_escord( wlmeslnk ) Key 1; /*ObjID+ObjKind+Direct+MesID */
FILE wlmes_escord( wlmes ) key 0; /*MesID*/
FILE wlsess_escord( wlsess ) key 0; /*SessionID*/
FILE tpSchem_escord( wltpshem ) key 0; 
FILE pmhist_escord( pmhist );
FILE person_escord( person );
*/

VAR  wlpm_escord     = TBFile("wlpm.dbt",     "R", 1 );
VAR  wlmeslnk_escord = TBFile("wlmeslnk.dbt", "R", 1 );
VAR  wlmes_escord    = TBFile("wlmes.dbt",    "R", 0 );
VAR  wlsess_escord   = TBFile("wlsess.dbt",   "R", 0 );
VAR  tpSchem_escord  = TBFile("wltpshem.dbt", "R", 0 );
VAR  pmhist_escord   = TBFile("pmhist.dbt",   "R", 0 );
VAR  person_escord   = TBFile("person.dbt",   "R", 0 );

VAR needFiltrSQL = false;
if ( isSQL ) needFiltrSQL = true;
end;

const PM_IN = "X", PM_OUT = "", SBRF3 = 4;

CLASS ESCORD
   var Title                  : string,  /*  50     0 Заголовок документа             */
       Number                 : string,  /*  16    50 Номер платежа                   */
       Date_Create            : date,    /*   4    66 Дата создания                   */
       KK_Creator             : string,  /*  11    70 Код клиринга создателя          */
       Name_KK_Creator        : string,  /*  80    81 Название создателя              */
       KK_Sender              : string,  /*  11   161 Код клиринга отправителя        */
       Name_KK_Sender         : string,  /*  80   172 Название отправителя            */
       KK_Receiver            : string,  /*  11   252 Код клиринга получателя         */
       Name_KK_Receiver       : string,  /*  80   263 Название получателя             */
       Sum                    : moneyl,  /*   8   343 Сумма                           */
       Currency               : string,  /*   4   351 Вид активов                     */
       Date_Value             : date,    /*   4   355 Дата валютирования              */
       Exp_Payer              : string,  /*  16   359 Расходы с плательщика           */
       Basic_Document         : string,  /*  16   375 Первичный документ              */
       NonSystem_Document     : string,  /*  16   391 Внесистемный документ           */
       Date_Processing        : date,    /*   4   407 Дата обработки                  */
       MessageType            : string,  /*   4   411 Тип Сообщения                   */
       ConnectionType         : string,  /*  16   415 Вид связи                       */
       KS                     : string,  /*  81   431 Ключ                            */
       Ground                 : string,  /* 211   447 Назначение платежа              */
       PartyInfo              : string,  /* 211   658 Информация участника            */
       Name_Payer             : string,  /* 161   869 Имя плательщика                 */
       INN_Payer              : string,  /*  13  1030 ИНН плательщика                 */
       PaymentSystem_Payer    : string,  /*  16  1043 Расчетная система плательщика   */
       BIC_Payer              : string,  /*  10  1059 Код банка                       */
       CorrAcc_Payer          : string,  /*  26  1069 Корсчет банка плательщика       */
       BankName_Payer         : string,  /*  81  1095 Назв. банка плательщика         */
       Account_Payer          : string,  /*  26  1176 Счет плательщика                */
       Dep_Payer              : string,  /*  16  1202 филиал                          */
       Name_Receiver          : string,  /* 161  1218                                 */
       INN_Receiver           : string,  /*  13  1379                                 */
       PaymentSystem_Receiver : string,  /*  16  1392                                 */
       BIC_Receiver           : string,  /*  10  1408                                 */
       CorrAcc_Receiver       : string,  /*  26  1418                                 */
       BankName_Receiver      : string,  /*  81  1444                                 */
       Account_Receiver       : string,  /*  26  1525                                 */
       Dep_Receiver           : string,  /*  16  1551                                 */
       Name_Transit           : string,  /* 161  1567 Название посредника             */
       PaymentSystem_Transit  : string,  /*  16  1567 посредник                       */
       BIC_Transit            : string,  /*  10  1583                                 */
       CorrAcc_Transit        : string,  /*  26  1593                                 */
       BankName_Transit       : string,  /*  81  1619                                 */
       PaymentWay             : string,  /*  16  1700 Способ расчета                  */
       Urgency                : string,  /*  16  1716 Срочность исполнения            */
       Priority               : integer, /*   2  1732 приоритет                       */
       StatusRequest          : string,  /*  16  1734 Запрос статуса                  */
       DPP                    : date,    /*   4  1750 ДПП                             */
       Date_EndOfService      : date,    /*   4  1754 Дата окончания обслуживания     */
       Name_Oper              : string,  /*  21  1758                                 */
       Name_Control           : string,  /*  21  1779                                 */
       OperInfo               : string,  /*  81  1800                                 */
       Ext_Info               : string;  /*  81  1881 Дополнительная информация       */

   var Direct, FIID;

   macro Clear()
       FIID = 0;
       Title                  = "";
       Number                 = "";
       Date_Create            = date(0,0,0);
       KK_Creator             = "";
       Name_KK_Creator        = "";
       KK_Sender              = "";
       Name_KK_Sender         = "";
       KK_Receiver            = "";
       Name_KK_Receiver       = "";
       Sum                    = moneyl( 0 ); 
       Currency               = "";
       Date_Value             = date(0,0,0);  
       Exp_Payer              = "";
       Basic_Document         = "";
       NonSystem_Document     = "";
       Date_Processing        = date(0,0,0);  
       MessageType            = "";
       ConnectionType         = "";
       KS                     = "";
       Ground                 = "";
       PartyInfo              = "";
       Name_Payer             = "";
       INN_Payer              = "";
       PaymentSystem_Payer    = "";
       BIC_Payer              = "";
       CorrAcc_Payer          = "";
       BankName_Payer         = "";
       Account_Payer          = "";
       Dep_Payer              = "";
       Name_Receiver          = "";
       INN_Receiver           = "";
       PaymentSystem_Receiver = "";
       BIC_Receiver           = "";
       CorrAcc_Receiver       = "";
       BankName_Receiver      = "";
       Account_Receiver       = "";
       Dep_Receiver           = "";
       Name_Transit           = "";
       PaymentSystem_Transit  = "";
       BIC_Transit            = "";
       CorrAcc_Transit        = "";
       BankName_Transit       = "";
       PaymentWay             = "";
       Urgency                = "";
       Priority               = 0 ;
       StatusRequest          = "";
       DPP                    = date(0,0,0);  
       Date_EndOfService      = date(0,0,0);  
       Name_Oper              = "";
       Name_Control           = "";
       OperInfo               = "";
       Ext_Info               = "";
   end;

   Clear();
end;

CLASS TPMVALPROP( pmpaym, pmrmprop )
    var Number                : string,
        ClientDate            : date,
        MessageType           : string,
        PaymentKind           : string,
        Ground                : string,
        PartyInfo             : string,
        PayerName             : string,
        PayerINN              : string,
        PayerBankName         : string,
        ReceiverName          : string,
        ReceiverINN           : string,
        ReceiverCorrAccNostro : string,
        PayerCorrAccNostro    : string,
        ReceiverBankName      : string,
        NonSystem_Document    : string,
        Priority              : integer;
     record Bank(party);

     macro CreateNonSystem_Document( Number, ClientDate, Priority )
        var field_value, День, Месяц, Год;

        datesplit( ClientDate, День, Месяц, Год );

        if( День  < 10 )   День  = String( "0", день  );  end;
        if( Месяц < 10 )   Месяц = String( "0", месяц );  end;
        Год = SubStr( String( год ), 3 );

        field_value = "000"
        + StrSubst( String(Number:6:r), " ", "0" ) /* N клиентского документа */
        + String( День, Месяц, Год )               /* Дата приема документа от клиента */
        + String( Priority );                      /* Очередность платежа */

        return field_value;
     end;

     /* Заполняем по рублевым свойствам */
     Number                = pmrmprop.Number;
     ClientDate            = pmrmprop.ClientDate;
     MessageType           = pmrmprop.MessageType;
     PaymentKind           = pmrmprop.PaymentKind;
     Ground                = pmrmprop.Ground;
     PartyInfo             = pmrmprop.PartyInfo;
     PayerName             = pmrmprop.PayerName;
     PayerINN              = pmrmprop.PayerINN;
     PayerBankName         = pmrmprop.PayerBankName;
     ReceiverName          = pmrmprop.ReceiverName;
     ReceiverINN           = pmrmprop.ReceiverINN;
     ReceiverCorrAccNostro = pmrmprop.ReceiverCorrAccNostro;
     PayerCorrAccNostro    = pmrmprop.PayerCorrAccNostro;
     ReceiverBankName      = pmrmprop.ReceiverBankName;
     Priority              = pmrmprop.Priority;
     NonSystem_Document    = CreateNonSystem_Document( pmrmprop.Number, pmrmprop.Date, pmrmprop.Priority );

end;

var e = ESCORD, pmvalprop;


/******************************************************************************
    Основной макрос печати
******************************************************************************/
MACRO PrintEscord( e )
    VAR
        j, INN,
        сумма_прописью;
    record fi ( fininstr );

    ARRAY 
        SP, NS, NR, BS, BR, GR, PI, NT, BT;

    if ( e.FIID==0 )
       сумма_прописью = rubtostralt( e.Sum );
    else
       if ( ПолучитьФинИн(e.FIID, fi)==0 )
          сумма_прописью = CurToStrAlt(e.Sum , null, null, int(fi.ISO_Number));
       else
          сумма_прописью = CurToStrAlt(e.Sum , null, null, int(""));
       end;
    end;

    strsplit(сумма_прописью,  SP, 60, 60, 2);
    strsplit(e.PartyInfo,     PI, 60, 60, 4);
    strsplit(e.Name_Payer,    NS, 60, 60, 2);
    strsplit(e.Name_Receiver, NR, 60, 60, 2);
    strsplit(e.BankName_Payer,    BS, 60, 60, 2);
    strsplit(e.BankName_Receiver, BR, 60, 60, 2);
    strsplit(e.Name_Transit,  NT, 60, 60, 2);
    strsplit(e.BankName_Transit,  BT, 60, 60, 2);
    strsplit(e.Ground, GR, 60, 60, 4);

/* понеслась печать */
[


                 ###########################################                 
]( e.Title:l );
[
 ДОКУМЕНТ              : ############################################################
 ДАТА СОЗДАНИЯ         : ##########
 СОЗДАТЕЛЬ             : ########## #################################################
 ОТПРАВИТЕЛЬ           : ########## #################################################
 ПОЛУЧАТЕЛЬ            : ########## #################################################             
 СУММА                 : ################
                       : ############################################################]
( e.Number:l, e.Date_Create:f, e.KK_Creator, e.Name_KK_Creator, e.KK_Sender, e.Name_KK_Sender, e.KK_Receiver, e.Name_KK_Receiver, e.Sum:a:l, SP(0):l );

if (StrLen(trim(SP(1))) > 0)
[                      : ############################################################] 
( SP(1):l );         
end;

[ВИД АКТИВОВ           : ###
 ДАТА ВАЛЮТИРОВАНИЯ    : ##########                   
 РАСХОДЫ С ПЛАТЕЛЬЩИКА : ################  
 ПЕРВИЧНЫЙ ДОКУМЕНТ    : ################                                        
 ВНЕСИСТЕМНЫЙ ДОКУМЕНТ : ################
 ДАТА ОБРАБОТКИ        : ##########        
 ТИП СООБЩЕНИЯ         : ###
 ВИД СВЯЗИ             : ################                    
 КЛЮЧ                  : ############################################################    
 НАЗНАЧЕНИЕ ПЛАТЕЖА    : ############################################################]                 
( e.Currency, e.Date_Value:f, e.Exp_Payer, e.Basic_Document, e.NonSystem_Document, 
  e.Date_Processing:f, e.MessageType, e.ConnectionType, e.KS, GR(0):l );
j = 1;
while ( (j<=3) and (StrLen(trim(GR(j))) > 0) )
[                      : ############################################################] ( GR(j):l );         
    j=j+1;
end;

[ИНФОРМАЦИЯ УЧАСТНИКА  : ############################################################] ( PI(0):l );     
j = 1;
while ( (j<=3) and (StrLen(trim(PI(j))) > 0) )
[                      : ############################################################] ( PI(j):l );         
    j=j+1;
end;

[РЕКВИЗИТЫ ПЛАТЕЛЬЩИКА : ############################################################] ( NS(0):l );     
if (StrLen(trim(NS(1))) > 0)
[                      : ############################################################] ( NS(1):l );         
end;

SplitFullINN(e.INN_Payer, INN, null);
[   ИНН                : ###############       
    Расчетная система  : ###############   
    Код банка          : #########                          
    Корсчет банка      : #########################               
    Наименование банка : ############################################################]           
( INN:l, e.PaymentSystem_Payer:l, e.BIC_Payer, e.CorrAcc_Payer:l, BS(0):l  );

if (StrLen(trim(BS(1))) > 0)
[                      : ############################################################] ( BS(1):l );         
end;

[   Номер счета        : #########################             
    Номер филиала      : ###############]               
( e.Account_Payer:l, e.Dep_Payer );

[РЕКВИЗИТЫ ПОЛУЧАТЕЛЯ  : ############################################################] ( NR(0):l );     
if (StrLen(trim(NR(1))) > 0)
[                      : ############################################################] ( NR(1):l );         
end;

SplitFullINN(e.INN_Receiver, INN, null);

[   ИНН                : ###############       
    Расчетная система  : ###############   
    Код банка          : #########                          
    Корсчет банка      : #########################               
    Наименование банка : ############################################################]           
( INN:l, e.PaymentSystem_Receiver:l, e.BIC_Receiver, e.CorrAcc_Receiver:l, BR(0):l  );

if (StrLen(trim(BR(1))) > 0)
[                      : ############################################################] ( BR(1):l );         
end;

[   Номер счета        : #########################             
    Номер филиала      : ###############]               
( e.Account_Receiver:l, e.Dep_Receiver );
   
[РЕКВИЗИТЫ ПОСРЕДНИКА  : ############################################################] ( NT(0):l );     
if (StrLen(trim(NT(1))) > 0)
[                      : ############################################################] ( NT(1):l );         
end;

[   Расчетная система  : ###############   
    Код банка          : #########                          
    Корсчет банка      : #########################               
    Наименование банка : ############################################################]           
( e.PaymentSystem_Transit:l, e.BIC_Transit, e.CorrAcc_Transit:l, BT(0):l  );

if (StrLen(trim(BT(1))) > 0)
[                      : ############################################################] ( BT(1):l );         
end;

[ТИП ОБСЛУЖИВАНИЯ      : 
    Способ расчета     : ############################################################
    Срочн.исполнения   : ############################################################
    Приоритет          : #
    Запрос статуса     : ###############
    ДПП                : ##########
    Дата оконч.обслуж. : ##########
                       :                
 ИМЯ ОПЕРАТОРА         : ############################################################                             
 ИМЯ КОНТРОЛЕРА        : ############################################################                             
 ИНФОРМАЦИЯ ОПЕРАТОРА  : ############################################################                             
 ─────────────────────────────────────────────────────────────────────────────────────────
 ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ
 ####################################################################################
 ═════════════════════════════════════════════════════════════════════════════════════════
 
]( e.PaymentWay:l, e.Urgency:l, e.Priority, e.StatusRequest:l, e.DPP:f, 
   e.Date_EndOfService:f, e.Name_Oper:l, e.Name_Control:l, e.OperInfo:l, e.Ext_Info:l);
END;

macro PrintEscordMass( e, ncopy )
   while( ncopy )
      PrintEscord( e );
      ncopy = ncopy - 1;
   end;
end;

/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO ПолучитьУчастника( MesBankID, КодУчастника, НазваниеУчастника )
    VAR
        err = "";
    if( ПолучитьСубъекта( MesBankID, party_record ) == 0 )
        НазваниеУчастника = party_record.Name;
    else
        НазваниеУчастника = "участник не найден в справочнике";
    end;
    КодУчастника = ПолучитьКодСубъекта( MesBankID, 5, err );
    if( err )
        КодУчастника = "Не задан";
    end;
    SetParm( 1, КодУчастника );
    SetParm( 2, НазваниеУчастника );
END;

/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO ПолучитьИНН( MesBankID, ИНН )
    VAR
        err = "";
    if( ПолучитьСубъекта( MesBankID, party_record ) == 0 )
        ИНН = GetPartyINN( party_record.PartyID, 1 );
    else
        ИНН = "";
    end;
    SetParm( 1, ИНН );
END;


/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO ВидПлатежа( PaymentKind )
    pmpopknd.PaymentKind = PaymentKind;
    if( GetEQ(pmpopknd) )
        Return pmpopknd.Name
    else
        Return "не задан"
    end;
END;

/*
macro НайтиШапкуПлатежа( PaymentID )
    var Direct = e.Direct, b_continue = TRUE, wlpmID = 0, oldKey, alter = 0;

    while( b_continue )
       ClearRecord( wlpm_escord );
       wlpm_escord.rec.PaymentID = PaymentID;
       wlpm_escord.rec.Direct = Direct;
       b_continue = wlpm_escord.GetGE;
       while( b_continue AND (wlpm_escord.rec.PaymentID==PaymentID) AND (wlpm_escord.rec.Direct==Direct) )
           wlpmID = wlpm_escord.rec.WlPmID;
           b_continue =  wlpm_escord.next;
       end;
       if ( (not wlpmID) AND (alter==0) )
          alter = 1;
          if ( Direct==PM_IN )
             Direct = PM_OUT;
          else 
             Direct = PM_IN; 
          end;
          b_continue = TRUE;
       else 
          b_continue = FALSE;
       end;
    end;

    if ( wlpmID )
        oldKey = keyNum( wlpm_escord, 0 );
        wlpm_escord.rec.wlpmID = wlpmID;
        b_continue = wlpm_escord.GetEQ;
        keyNum( wlpm_escord, oldKey );
    end;
    return b_continue;
*/

macro НайтиШапкуПлатежа( PaymentID )
    var Direct = e.Direct, b_continue = TRUE, wlpmID = 0, 
        DirectAlt, wlpmIDAlt = 0;

       if ( Direct==PM_IN )     DirectAlt = PM_OUT;
       else                     DirectAlt = PM_IN; 
       end;

       ClearRecord( wlpm_escord );
       if ( needFiltrSQL )
         wlpm_escord.addFilter(string("t_PaymentID=",PaymentID));
       end;
       wlpm_escord.rec.PaymentID = PaymentID;
       b_continue = wlpm_escord.GetGE;
       while( b_continue AND (wlpm_escord.rec.PaymentID==PaymentID) )
           if (wlpm_escord.rec.Direct==Direct)
                wlpmID = wlpm_escord.rec.WlPmID;
                b_continue =  false;
           elif (wlpm_escord.rec.Direct==DirectAlt)
                wlpmIDAlt = wlpm_escord.rec.WlPmID;
           end;
           if ( b_continue )
             b_continue =  wlpm_escord.next;
           end;
       end;
       if ( wlpmID == 0 ) wlpmID = wlpmIDAlt;
       end;

       if ( needFiltrSQL )
         wlpm_escord.dropFilter;
       end;

   return wlpmID;
end;

/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO НайтиСообщение( PaymentID, errString )
    VAR result = true;

    VAR wlpmID = НайтиШапкуПлатежа(PaymentID);

    errString = "";
        
/*    if( НайтиШапкуПлатежа(PaymentID) ) */
    if( WlPmID > 0 )
        /* ищем связку в wlmeslnk */
        ClearRecord( wlmeslnk_escord );
        if ( needFiltrSQL )
          wlmeslnk_escord.addFilter(string("t_ObjID=",WlPmID));
        end;
        wlmeslnk_escord.rec.ObjID = WlPmID; /* wlpm_escord.WlPmID;*/
        if( wlmeslnk_escord.GetGE AND (wlmeslnk_escord.rec.ObjID == WlPmID )) /*wlpm_escord.WlPmID) )*/
            /* ищем сообщение */
            ClearRecord( wlmes_escord );
            wlmes_escord.rec.MesID = wlmeslnk_escord.rec.MesID;
            if( wlmes_escord.GetEQ )
               tpSchem_escord.rec.TpShemID = wlmes_escord.rec.TpSchemID;
               if ( tpSchem_escord.GetEQ )
                 if ( tpSchem_escord.rec.TpID!=SBRF3 )
                    errString = "Платеж обрабатывается не по транспорту SBRF3";
                    result = false;
                 end;
               else
                 errString = "Ошибка поиска транспортной схемы";
                 result = false;
               end;
            else
                errString = "Ошибка поиска сообщения";
                result = false;
            end;
        else
            errString = "Ошибка поиска связи с сообщением";
            result = false;
        end;

        if ( needFiltrSQL )
          wlmeslnk_escord.dropFilter;
        end;
    else
        errString = "Платеж не выгружен в МБР";
        result = false;
    end;

    SetParm( 1, errString );
    Return result;
END;

MACRO ПолучитьПодпись( PaymentID, Direct, prop )
    var CryptoAPI = RsCryptoAPI(), rsms, TpID = 0, Signature = "", rs, partContext = "";

    if ( not НайтиСообщение(PaymentID, Signature) )
       return Signature;
    end;
    if ( Direct == PM_OUT )
       /* Проверяем был ли платеж проконтролирован */
       if ( prop.PropStatus<PM_PROP_MESCONTROL )
          return "Сообщение не проконтролировано ";
       end;
       partContext = "|Формирование_транспортного_файла";
    else
       partContext = "|Обработка_сообщения";
    end;
    rs = RsdRecordSet(string("select tpschem.t_TpID from dwltpshem_dbt tpschem, dwlmes_dbt mes ",
          "where tpschem.t_TpShemID = mes.t_TpSchemID and mes.t_MesID = ", wlmes_escord.rec.MesID) );
    if(not rs.moveNext())
        return Signature;
    end;
    TpID = rs.Value(0);
    if( not CryptoAPI.IsCryptoActionNeeded(string("ТранспортМБР|", TpID, partContext), 370) )
        return Signature;
    end;
    rsms = RsbMessage( wlmes_escord.rec.MesID );
    if( CryptoAPI.ExecCryptoAction(string("ТранспортМБР|", TpID, partContext), rsms ))
        /* Определяем ключ */
        return CryptoAPI.GetLastSignature();
    end;
    return Signature;
END;

MACRO ПолучитьНомер( PaymentID )
    VAR Номер = "";

    if ( НайтиСообщение(PaymentID, Номер) )
       Номер = substr( wlmes_escord.rec.TRN, 17, 6);
    end;
    
    Return Номер;
END;

/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO ПолучитьСеансПлатежа( PaymentID, Операционист )
    VAR Строка = "";

    if ( НайтиСообщение(PaymentID, Строка) )
       /* ищем сеанс */
       ClearRecord( wlsess_escord );
       wlsess_escord.rec.SessionID = wlmes_escord.rec.SessionID;
       if( (wlmes_escord.rec.SessionID>0) AND wlsess_escord.GetEQ )
           Строка = String("из файла ", wlsess_escord.rec.FileName);
           /* ищем опера */
           ClearRecord( person_escord );
           person_escord.rec.Oper = wlsess_escord.rec.UserID;
           if( person_escord.GetEQ   )
               Операционист = String(person_escord.rec.Oper, " ", person_escord.rec.Name);
           else
               Операционист = String(person_escord.rec.Oper, " (в списке не найден)");
           end;
       else
           if ( wlmes_escord.rec.SessionID )
              Строка = "НЕ ЗАДАН (wlsess - ошибка)";
           else
              Строка = "НЕ ЗАДАН";
           end;
       end;
    end;
    
    SetParm( 1, Операционист );
    Return Строка;
END;

/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO ПолучитьАвтораПлатежа( PaymentID )
    VAR
        строка = "";

    /* ищем первую запист в истории по платежу */
    ClearRecord( pmhist_escord );
    if ( needFiltrSQL )
        pmhist_escord.addFilter(string("t_PaymentID=",PaymentID));
    end;
    pmhist_escord.rec.PaymentID = PaymentID;
    if( pmhist_escord.GetGE AND (pmhist_escord.rec.PaymentID == PaymentID))
        /* ищем опера */
        ClearRecord( person_escord );
        person_escord.rec.Oper = pmhist_escord.rec.Oper;
        if( person_escord.GetEQ   )
            строка = String(person_escord.rec.Oper, " ", person_escord.rec.Name);
        else
            строка = String(person_escord.rec.Oper, " (в списке не найден)");
        end;
    else
        строка = " Платеж не обрабатывался";
    end;
    if ( needFiltrSQL )
        pmhist_escord.dropFilter;
    end;
    Return строка;
END;

/******************************************************************************
  Вспомогательная функция  
******************************************************************************/
MACRO ПолучитьКонтролераПлатежа( PaymentID )
    VAR
        строка = "";
    /* ищем запись о контроле в истории по платежу (статус на отправке)*/
    KeyNum( pmhist_escord, 0 ); /*PaymentID+StatusIDTo*/
    ClearRecord( pmhist_escord );
    pmhist_escord.rec.PaymentID = PaymentID;
    pmhist_escord.rec.StatusIDTo = 3010;
    if( pmhist_escord.GetEQ )
        /* ищем опера */
        ClearRecord( person_escord );
        person_escord.rec.Oper = pmhist_escord.rec.Oper;
        if( person_escord.GetEQ )
            строка = String(person_escord.rec.Oper, " ", person_escord.rec.Name);
        else
            строка = String(person_escord.rec.Oper, " (в списке не найден)");
        end;
    else
        строка = " Платеж не контролировался";
    end;

    Return строка;
END;


/******************************************************************************
    Печать в виде Платежного Дебетового АВИЗО (входящий документ)
******************************************************************************/
MACRO Escord_Print_AVISO_Debet( ncopy, pmpaym, pmprop, pmvalprop )
    e.Clear();
    e.FIID = pmpaym.PayFIID;
    /* заполняем поля для печати*/
    e.Title               = "ДЕБЕТОВОЕ АВИЗО";  /*    SNR        50 Заголовок документа          */
    e.Number              = ПолучитьНомер(pmpaym.PaymentID);        /*    STRING     16 Номер платежа                */
    e.Date_Create         = pmpaym.ValueDate;        /*    DATE        4 Дата создания                */
    /* вычисляем участников */
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Creator, e.Name_KK_Creator );
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Sender, e.Name_KK_Sender );
    ПолучитьУчастника( pmpaym.ReceiverMesBankID, e.KK_Receiver, e.Name_KK_Receiver );
    e.Sum                 = pmpaym.Amount;          /*    MONEY       8 Сумма                        */
    ПолучитьФинИн( pmpaym.FIID, fininstr_record );
    e.Currency            = fininstr_record.Ccy;    /*    STRING      4 Вид активов                  */
    e.Date_Value          = pmpaym.ValueDate;       /*    DATE        4 Дата валютирования           */
    e.Exp_Payer           = "НЕТ";                  /*    STRING     16 Расходы с плательщика        */
    e.Basic_Document      = String(pmpaym.DocKind, "/", pmpaym.DocumentID, "/", pmpaym.PaymentID);                     /*    STRING     16 Первичный документ           */
    e.NonSystem_Document  = pmvalprop.NonSystem_Document; /*    STRING     16 Внесистемный документ        */
    e.Date_Processing     = pmpaym.ValueDate;       /*    DATE        4 Дата обработки               */
    e.MessageType         = pmvalprop.MessageType;   /*    STRING      4 Тип Сообщения                */
    e.ConnectionType      = ВидПлатежа( pmvalprop.PaymentKind ); /*    STRING     16 Вид связи                    */
    e.KS                  = ПолучитьПодпись( pmpaym.PaymentID, e.Direct, pmprop );              /*    STRING     16 Ключ                         */
    e.Ground              = pmvalprop.Ground;        /*    STRING    211 Назначение платежа           */
    e.PartyInfo           = pmvalprop.PartyInfo;     /*    STRING    211 Информация участника         */
    e.Name_Payer          = pmvalprop.PayerName;     /*    STRING    161 Имя плательщика              */
    if( pmvalprop.PayerINN == "" )
       ПолучитьИНН( pmpaym.PayerBankID, e.INN_Payer );
    else
       e.INN_Payer           = pmvalprop.PayerINN;  /*    STRING     13 ИНН плательщика              */
    end;
    e.PaymentSystem_Payer = "МФО";                  /*    STRING     16 Расчетная система плательщика*/                  
    e.BIC_Payer           = {MFO_Bank};             /*    STRING     10 Код банка                    */
    e.CorrAcc_Payer       = {CORAC_Bank};           /*    STRING     26 Корсчет банка плательщика    */
    e.BankName_Payer      = pmvalprop.PayerBankName; /*    STRING     81 Назв. банка плательщика      */
    e.Account_Payer       = pmpaym.PayerAccount;    /*    STRING     26 Счет плательщика             */
    e.Dep_Payer           = "";                     /*    STRING     16 филиал                       */
    e.Name_Receiver       = pmvalprop.ReceiverName;  /*    STRING    161                              */
    if( pmvalprop.ReceiverINN == "" )
       ПолучитьИНН( pmpaym.ReceiverBankID, e.INN_Receiver );
    else
       e.INN_Receiver     = pmvalprop.PayerINN;  /*    STRING     13 ИНН плательщика              */
    end;
    e.PaymentSystem_Receiver = "МФО";               /*    STRING     16                             */ 
    e.BIC_Receiver        = pmprop.BankCode;        /*    STRING     10                              */
    e.CorrAcc_Receiver    = pmvalprop.ReceiverCorrAccNostro; /*    STRING     26                              */
    e.BankName_Receiver   = pmvalprop.ReceiverBankName;      /*    STRING     81                              */
    e.Account_Receiver    = pmpaym.ReceiverAccount;         /*    STRING     26                              */
    e.Dep_Receiver        = ""; /*    STRING     16                              */
    e.Name_Transit        = ""; /*    STRING    161 Название посредника          */
    e.PaymentSystem_Transit = ""; /*   STRING     16 посредник                   */ 
    e.BIC_Transit         = ""; /*    STRING     10                              */
    e.CorrAcc_Transit     = ""; /*    STRING     26                              */
    e.BankName_Transit    = ""; /*    STRING     81                              */
    e.PaymentWay          = "Валовые платежи"; /*    STRING     16 Способ расчета               */
    e.Urgency             = "Несрочный платеж"; /*    STRING     16 Срочность исполнения         */
    e.Priority            = pmvalprop.Priority; /*    INT         2 приоритет                    */
    e.StatusRequest       = "Нет запроса"; /*    STRING     16 Запрос статуса               */
    e.DPP                 = pmprop.TransferDate; /*    DATE        4 ДПП                          */
    e.Date_EndOfService   = Date(0,0,0); /*    DATE        4 Дата окончания обслуживания  */
    e.Name_Oper           = ПолучитьСеансПлатежа( pmpaym.PaymentID, e.Name_Control ); /*    STRING     21     */
    /*e.Name_Control        = ПолучитьКонтролераПлатежа( pmpaym.PaymentID );*/ /*    STRING     21                              */
    e.OperInfo            = ""; /*    STRING     81                              */
    e.Ext_Info            = ""; /*    STRING     81 Дополнительная информация    */
                                                                             
    PrintEscordMass( e, ncopy );
    Return 0;
END;


/******************************************************************************
    Печать в виде Платежного Кредитового АВИЗО (входящий документ)
******************************************************************************/
MACRO Escord_Print_AVISO_Credit( ncopy, pmpaym, pmprop, pmvalprop )
    e.Clear();
    e.FIID = pmpaym.PayFIID;
    /* заполняем поля для печати*/
    e.Title               = "КРЕДИТОВОЕ АВИЗО";  /*    SNR        50 Заголовок документа          */
    e.Number              = ПолучитьНомер(pmpaym.PaymentID);        /*    STRING     16 Номер платежа                */
    e.Date_Create         = pmpaym.ValueDate; /*pmvalprop.ClientDate; */   /*    DATE        4 Дата создания                */
    /* вычисляем участников */
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Creator, e.Name_KK_Creator );
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Sender, e.Name_KK_Sender );
    ПолучитьУчастника( pmpaym.ReceiverMesBankID, e.KK_Receiver, e.Name_KK_Receiver );
    e.Sum                 = pmpaym.Amount;          /*    MONEY       8 Сумма                        */
    ПолучитьФинИн( pmpaym.FIID, fininstr_record );
    e.Currency            = fininstr_record.Ccy;    /*    STRING      4 Вид активов                  */
    e.Date_Value          = pmpaym.ValueDate;       /*    DATE        4 Дата валютирования           */
    e.Exp_Payer           = "НЕТ";                  /*    STRING     16 Расходы с плательщика        */
    e.Basic_Document      = String(pmpaym.DocKind, "/", pmpaym.DocumentID, "/", pmpaym.PaymentID);                     /*    STRING     16 Первичный документ           */
    e.NonSystem_Document  = pmvalprop.NonSystem_Document; /*    STRING     16 Внесистемный документ        */
    e.Date_Processing     = pmpaym.ValueDate;       /*    DATE        4 Дата обработки               */
    e.MessageType         = pmvalprop.MessageType;   /*    STRING      4 Тип Сообщения                */
    e.ConnectionType      = ВидПлатежа( pmvalprop.PaymentKind ); /*    STRING     16 Вид связи                    */
    e.KS                  = ПолучитьПодпись( pmpaym.PaymentID, e.Direct, pmprop );              /*    STRING     16 Ключ                         */
    e.Ground              = pmvalprop.Ground;        /*    STRING    211 Назначение платежа           */
    e.PartyInfo           = pmvalprop.PartyInfo;     /*    STRING    211 Информация участника         */
    e.Name_Payer          = pmvalprop.PayerName;     /*    STRING    161 Имя плательщика              */
    if( pmvalprop.PayerINN == "" )
       ПолучитьИНН( pmpaym.PayerBankID, e.INN_Payer );
    else
       e.INN_Payer           = pmvalprop.PayerINN;  /*    STRING     13 ИНН плательщика              */
    end;
    e.PaymentSystem_Payer = "МФО";                  /*    STRING     16 Расчетная система плательщика*/                  
    e.BIC_Payer           = pmprop.BankCode;        /*    STRING     10                              */
    e.CorrAcc_Payer       = pmvalprop.PayerCorrAccNostro; /*    STRING     26                              */
    e.BankName_Payer      = pmvalprop.PayerBankName; /*    STRING     81 Назв. банка плательщика      */
    e.Account_Payer       = pmpaym.PayerAccount;    /*    STRING     26 Счет плательщика             */
    e.Dep_Payer           = "";                     /*    STRING     16 филиал                       */
    e.Name_Receiver       = pmvalprop.ReceiverName;  /*    STRING    161                              */
    if( pmvalprop.ReceiverINN == "" )
       ПолучитьИНН( pmpaym.ReceiverBankID, e.INN_Receiver );
    else
       e.INN_Receiver     = pmvalprop.ReceiverINN;  /*    STRING     13 ИНН             */
    end;
    e.PaymentSystem_Receiver = "МФО";               /*    STRING     16                             */ 
    e.BIC_Receiver        = {MFO_Bank};             /*    STRING     10                              */
    e.CorrAcc_Receiver    = {CORAC_Bank};           /*    STRING     26                              */
    e.BankName_Receiver   = pmvalprop.ReceiverBankName;      /*    STRING     81                              */
    e.Account_Receiver    = pmpaym.ReceiverAccount;         /*    STRING     26                              */
    e.Dep_Receiver        = ""; /*    STRING     16                              */
    e.Name_Transit        = ""; /*    STRING    161 Название посредника          */
    e.PaymentSystem_Transit = ""; /*   STRING     16 посредник                   */ 
    e.BIC_Transit         = ""; /*    STRING     10                              */
    e.CorrAcc_Transit     = ""; /*    STRING     26                              */
    e.BankName_Transit    = ""; /*    STRING     81                              */
    e.PaymentWay          = "Валовые платежи"; /*    STRING     16 Способ расчета               */
    e.Urgency             = "Несрочный платеж"; /*    STRING     16 Срочность исполнения         */
    e.Priority            = pmvalprop.Priority; /*    INT         2 приоритет                    */
    e.StatusRequest       = "Нет запроса"; /*    STRING     16 Запрос статуса               */
    e.DPP                 = pmprop.TransferDate; /*    DATE        4 ДПП                          */
    e.Date_EndOfService   = Date(0,0,0); /*    DATE        4 Дата окончания обслуживания  */
    e.Name_Oper           = ПолучитьСеансПлатежа( pmpaym.PaymentID, e.Name_Control ); /*    STRING     21     */
    /*e.Name_Control        = ПолучитьКонтролераПлатежа( pmpaym.PaymentID );*/ /*    STRING     21                              */
    e.OperInfo            = ""; /*    STRING     81                              */
    e.Ext_Info            = ""; /*    STRING     81 Дополнительная информация    */
                                                                             
    PrintEscordMass( e, ncopy );
    Return 0;
END;


/******************************************************************************
    Печать в виде Платежного требования
******************************************************************************/
MACRO Escord_Print_PayDem( ncopy, pmpaym, pmprop, pmvalprop )
    e.Clear();
    e.FIID = pmpaym.PayFIID;
    /* заполняем поля для печати*/
    e.Title               = "ПЛАТЕЖНОЕ ТРЕБОВАНИЕ";  /*    SNR        50 Заголовок документа          */
    e.Number              = ПолучитьНомер(pmpaym.PaymentID);        /*    STRING     16 Номер платежа                */
    e.Date_Create         = pmpaym.ValueDate; /*pmvalprop.ClientDate; */   /*    DATE        4 Дата создания                */
    /* вычисляем участников */
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Creator, e.Name_KK_Creator );
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Sender, e.Name_KK_Sender );
    ПолучитьУчастника( pmpaym.ReceiverMesBankID, e.KK_Receiver, e.Name_KK_Receiver );
    e.Sum                 = pmpaym.Amount;          /*    MONEY       8 Сумма                        */
    ПолучитьФинИн( pmpaym.FIID, fininstr_record );
    e.Currency            = fininstr_record.Ccy;    /*    STRING      4 Вид активов                  */
    e.Date_Value          = pmpaym.ValueDate;       /*    DATE        4 Дата валютирования           */
    e.Exp_Payer           = "НЕТ";                  /*    STRING     16 Расходы с плательщика        */
    e.Basic_Document      = String(pmpaym.DocKind, "/", pmpaym.DocumentID, "/", pmpaym.PaymentID);                     /*    STRING     16 Первичный документ           */
    e.NonSystem_Document  = pmvalprop.NonSystem_Document; /*    STRING     16 Внесистемный документ        */
    e.Date_Processing     = pmpaym.ValueDate;       /*    DATE        4 Дата обработки               */
    e.MessageType         = pmvalprop.MessageType;   /*    STRING      4 Тип Сообщения                */
    e.ConnectionType      = ВидПлатежа( pmvalprop.PaymentKind ); /*    STRING     16 Вид связи                    */
    e.KS                  = ПолучитьПодпись( pmpaym.PaymentID, e.Direct, pmprop );              /*    STRING     16 Ключ                         */
    e.Ground              = pmvalprop.Ground;        /*    STRING    211 Назначение платежа           */
    e.PartyInfo           = pmvalprop.PartyInfo;     /*    STRING    211 Информация участника         */
    e.Name_Payer          = pmvalprop.PayerName;     /*    STRING    161 Имя плательщика              */
    if( pmvalprop.PayerINN == "" )
       ПолучитьИНН( pmpaym.PayerBankID, e.INN_Payer );
    else
       e.INN_Payer           = pmvalprop.PayerINN;  /*    STRING     13 ИНН плательщика              */
    end;
    e.PaymentSystem_Payer = "МФО";                  /*    STRING     16 Расчетная система плательщика*/                  
    e.BIC_Payer           = pmprop.BankCode;        /*    STRING     10                              */
    e.CorrAcc_Payer       = pmvalprop.PayerCorrAccNostro; /*    STRING     26                              */
    e.BankName_Payer      = pmvalprop.PayerBankName; /*    STRING     81 Назв. банка плательщика      */
    e.Account_Payer       = pmpaym.PayerAccount;    /*    STRING     26 Счет плательщика             */
    e.Dep_Payer           = "";                     /*    STRING     16 филиал                       */
    e.Name_Receiver       = pmvalprop.ReceiverName;  /*    STRING    161                              */
    if( pmvalprop.ReceiverINN == "" )
       ПолучитьИНН( pmpaym.ReceiverBankID, e.INN_Receiver );
    else
       e.INN_Receiver     = pmvalprop.ReceiverINN;  /*    STRING     13 ИНН            */
    end;
    e.PaymentSystem_Receiver = "МФО";               /*    STRING     16                             */ 
    e.BIC_Receiver        = {MFO_Bank};        /*    STRING     10                              */
    e.CorrAcc_Receiver    = {CORAC_Bank}; /*    STRING     26                              */
    e.BankName_Receiver   = pmvalprop.ReceiverBankName;      /*    STRING     81                              */
    e.Account_Receiver    = pmpaym.ReceiverAccount;         /*    STRING     26                              */
    e.Dep_Receiver        = ""; /*    STRING     16                              */
    e.Name_Transit        = ""; /*    STRING    161 Название посредника          */
    e.PaymentSystem_Transit = ""; /*   STRING     16 посредник                   */ 
    e.BIC_Transit         = ""; /*    STRING     10                              */
    e.CorrAcc_Transit     = ""; /*    STRING     26                              */
    e.BankName_Transit    = ""; /*    STRING     81                              */
    e.PaymentWay          = "Валовые платежи"; /*    STRING     16 Способ расчета               */
    e.Urgency             = "Несрочный платеж"; /*    STRING     16 Срочность исполнения         */
    e.Priority            = pmvalprop.Priority; /*    INT         2 приоритет                    */
    e.StatusRequest       = "Нет запроса"; /*    STRING     16 Запрос статуса               */
    e.DPP                 = pmprop.TransferDate; /*    DATE        4 ДПП                          */
    e.Date_EndOfService   = Date(0,0,0); /*    DATE        4 Дата окончания обслуживания  */
    e.Name_Oper           = ПолучитьАвтораПлатежа( pmpaym.PaymentID ); /*    STRING     21                              */
    e.Name_Control        = ПолучитьКонтролераПлатежа( pmpaym.PaymentID ); /*    STRING     21                              */
    e.OperInfo            = ""; /*    STRING     81                              */
    e.Ext_Info            = ""; /*    STRING     81 Дополнительная информация    */
                                                                             
    PrintEscordMass( e, ncopy );
    Return 0;
END;

/******************************************************************************
    Печать в виде Платежного поручения
******************************************************************************/
MACRO Escord_Print_PayOrder( ncopy, pmpaym, pmprop, pmvalprop )
    e.Clear();
    e.FIID = pmpaym.PayFIID;
    /* заполняем поля для печати*/
    e.Title               = "ПЛАТЕЖНОЕ ПОРУЧЕНИЕ";  /*    SNR        50 Заголовок документа          */
    e.Number              = ПолучитьНомер(pmpaym.PaymentID);        /*    STRING     16 Номер платежа                */
    e.Date_Create         = pmpaym.ValueDate; /*pmvalprop.ClientDate; */   /*    DATE        4 Дата создания                */
    /* вычисляем участников */
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Creator, e.Name_KK_Creator );
    ПолучитьУчастника( pmpaym.PayerMesBankID, e.KK_Sender, e.Name_KK_Sender );
    ПолучитьУчастника( pmpaym.ReceiverMesBankID, e.KK_Receiver, e.Name_KK_Receiver );
    e.Sum                 = pmpaym.Amount;          /*    MONEY       8 Сумма                        */
    ПолучитьФинИн( pmpaym.FIID, fininstr_record );
    e.Currency            = fininstr_record.Ccy;    /*    STRING      4 Вид активов                  */
    e.Date_Value          = pmpaym.ValueDate;       /*    DATE        4 Дата валютирования           */
    e.Exp_Payer           = "НЕТ";                  /*    STRING     16 Расходы с плательщика        */
    e.Basic_Document      = String(pmpaym.DocKind, "/", pmpaym.DocumentID, "/", pmpaym.PaymentID);                     /*    STRING     16 Первичный документ           */
    e.NonSystem_Document  = pmvalprop.NonSystem_Document; /*    STRING     16 Внесистемный документ        */
    e.Date_Processing     = pmpaym.ValueDate;       /*    DATE        4 Дата обработки               */
    e.MessageType         = pmvalprop.MessageType;   /*    STRING      4 Тип Сообщения                */
    e.ConnectionType      = ВидПлатежа( pmvalprop.PaymentKind ); /*    STRING     16 Вид связи                    */
    e.KS                  = ПолучитьПодпись( pmpaym.PaymentID, e.Direct, pmprop );              /*    STRING     16 Ключ                         */
    e.Ground              = pmvalprop.Ground;        /*    STRING    211 Назначение платежа           */
    e.PartyInfo           = pmvalprop.PartyInfo;     /*    STRING    211 Информация участника         */
    e.Name_Payer          = pmvalprop.PayerName;     /*    STRING    161 Имя плательщика              */
    if( pmvalprop.PayerINN == "" )
       ПолучитьИНН( pmpaym.PayerBankID, e.INN_Payer );
    else
       e.INN_Payer           = pmvalprop.PayerINN;  /*    STRING     13 ИНН плательщика              */
    end;
    e.PaymentSystem_Payer = "МФО";                  /*    STRING     16 Расчетная система плательщика*/                  
    e.BIC_Payer           = {MFO_Bank};             /*    STRING     10 Код банка                    */
    e.CorrAcc_Payer       = {CORAC_Bank};           /*    STRING     26 Корсчет банка плательщика    */
    e.BankName_Payer      = pmvalprop.PayerBankName; /*    STRING     81 Назв. банка плательщика      */
    e.Account_Payer       = pmpaym.PayerAccount;    /*    STRING     26 Счет плательщика             */
    e.Dep_Payer           = "";                     /*    STRING     16 филиал                       */
    e.Name_Receiver       = pmvalprop.ReceiverName;  /*    STRING    161                              */
    if( pmvalprop.ReceiverINN == "" )
       ПолучитьИНН( pmpaym.ReceiverBankID, e.INN_Receiver );
    else
       e.INN_Receiver     = pmvalprop.ReceiverINN;  /*    STRING     13 ИНН            */
    end;
    e.PaymentSystem_Receiver = "МФО";               /*    STRING     16                             */ 
    e.BIC_Receiver        = pmprop.BankCode;        /*    STRING     10                              */
    e.CorrAcc_Receiver    = pmvalprop.ReceiverCorrAccNostro; /*    STRING     26                              */
    e.BankName_Receiver   = pmvalprop.ReceiverBankName;      /*    STRING     81                              */
    e.Account_Receiver    = pmpaym.ReceiverAccount;         /*    STRING     26                              */
    e.Dep_Receiver        = ""; /*    STRING     16                              */
    e.Name_Transit        = ""; /*    STRING    161 Название посредника          */
    e.PaymentSystem_Transit = ""; /*   STRING     16 посредник                   */ 
    e.BIC_Transit         = ""; /*    STRING     10                              */
    e.CorrAcc_Transit     = ""; /*    STRING     26                              */
    e.BankName_Transit    = ""; /*    STRING     81                              */
    e.PaymentWay          = "Валовые платежи"; /*    STRING     16 Способ расчета               */
    e.Urgency             = "Несрочный платеж"; /*    STRING     16 Срочность исполнения         */
    e.Priority            = pmvalprop.Priority; /*    INT         2 приоритет                    */
    e.StatusRequest       = "Нет запроса"; /*    STRING     16 Запрос статуса               */
    e.DPP                 = pmprop.TransferDate; /*    DATE        4 ДПП                          */
    e.Date_EndOfService   = Date(0,0,0); /*    DATE        4 Дата окончания обслуживания  */
    e.Name_Oper           = ПолучитьАвтораПлатежа( pmpaym.PaymentID ); /*    STRING     21                              */
    e.Name_Control        = ПолучитьКонтролераПлатежа( pmpaym.PaymentID ); /*    STRING     21                              */
    e.OperInfo            = ""; /*    STRING     81                              */
    e.Ext_Info            = ""; /*    STRING     81 Дополнительная информация    */
                                                                             
    PrintEscordMass( e, ncopy );
    Return 0;
END;


/******************************************************************************
    Универсальная функция печати в форме Эскорд
******************************************************************************/
MACRO Escord_Print( Use_VRSL, MassCopy, pmpaym, debet, credit, pmrmprop )
    var ncopy, err = 0, errString;

    if ( Use_VRSL )
       [В данной версии печать в форме Эскорд на VRSL не поддерживается];
       return 0;
    end;

    /* разбираемся - что за платеж */
    if ( ((debet.BankCode != "") AND (debet.IsSender == "")) OR
         ((credit.BankCode != "") AND (credit.IsSender == "")) )
        e.Direct = PM_OUT;
    elif ( ((debet.BankCode != "") AND (debet.IsSender != "")) OR
           ((credit.BankCode != "") AND (credit.IsSender != "")) )
        e.Direct = PM_IN;
    else
        /* внутренний документ */
        [ ВНУТРЕННИЙ ДОКУМЕНТ];
        return 0;
    end;

    if(MassCopy == 0)
       ncopy = 1;
       if ( not GetInt(ncopy,"Введите количество копий.",3))
         ncopy = 0;
       end;
    else
       ncopy = MassCopy;
    end;

    if ( ncopy<=0 ) 
       exit(1);
    end;

    pmvalprop = TPMVALPROP( pmpaym, pmrmprop );

    if( debet.BankCode != "")
        if( debet.IsSender == "" )
            /* начальный дебетовый (платежное требование) */
            Return Escord_Print_PayDem( ncopy, pmpaym, debet, pmvalprop )
        else
            /* ответный кредитовый (Кредитовое АВИЗО) */
            Return Escord_Print_AVISO_Credit( ncopy, pmpaym, debet, pmvalprop )
        end;
    elif( credit.BankCode != "" )
        if( credit.IsSender == "" )
            /* начальный кредитовый (платежное поручение) */
            Return Escord_Print_PayOrder( ncopy, pmpaym, credit, pmvalprop );
        else
            /* ответный дебетовый (Дебетовое АВИЗО) */
            Return Escord_Print_AVISO_Debet( ncopy, pmpaym, credit, pmvalprop );
        end;
    end;
    Return 0;
END;

/* Печать в новом стиле */
MACRO PrintDocument(ncopy:integer):bool
  var stat:integer;
  stat = Escord_Print( FALSE, ncopy, pr_pmpaym.rec, pr_debet.rec, pr_credit.rec, pr_pmrmprop.rec );
  return (stat == 0);
END;

