Import bankinter, rsd, rcw, cb_sql, PTInter; 

const english_char = "AaBCcEeЁёHKkMmOoPpTuXxYybDdFfGghIiJjLlnQqRrSstUVvWwZz!@#$%^&*=+№;:?\"\\/|`~[]{}<>";
const russian_char = "ААВССЕЕЕЕНККМТООРРТИХХУУ                                                       ";

file kladr_dbf    ("kladr.dbf")    dbf;
file street_dbf   ("street.dbf")   dbf;
file altnames_dbf ("altnames.dbf") dbf;
file doma_dbf     ("doma.dbf")     dbf;
file flat_dbf     ("flat.dbf")     dbf;

/***********************************************************************
   Копирует текущее содержимое Recordset'а в буфер файла или структуры

   fbuff          - буфер файла или структуры
   rset           - Recordset или TRsbDataSet
   start_rset_pos - позиция Recordset'a, начиная с которой будут копи-
                    роваться значения.  

   Возвращаемое значение: НЕТ
***********************************************************************/
macro _CopyRSetToFBuff( fbuff, rset )
  var idx   = 0,
      nflds = FldNumber( fbuff ),
      val,
      NullConv;

  ClearRecord(fbuff);

  if( IsEqClass( "RsdRecordset", rset ))
    NullConv = rset.Command.NullConversion;
    rset.Command.NullConversion = true;
  end;

  while( idx < nflds )
    val = rset.value( "t_" + FldName( fbuff, idx ) );
    if( ValType( fbuff( idx ) ) == V_STRING )
      fbuff( idx ) = SQL_ConvTypeStr( val );
    elif( val != NULL )
      fbuff( idx ) = rset.value( "t_" + FldName( fbuff, idx ), null, ValType( fbuff( idx ) ) );
    end;
    idx = idx + 1;
  end;

  if( IsEqClass( "RsdRecordset", rset ))
    rset.Command.NullConversion = NullConv;
  end;
end;

macro normalization( oldstr )
  var newstr, i, retstr; 
  newstr = oldstr;
  retstr = "";
  
  i = 0;
  while( i < StrLen(english_char))
    i = i + 1;
    newstr = StrSubst( newstr, SubStr(english_char,i,1), SubStr(russian_char,i,1));
  end;
  newstr = Trim( newstr );
  newstr = StrUpr( newstr );

  i = 0;
  while( i < StrLen(newstr))
    i = i + 1;
    if( ( CodeFor(SubStr(newstr,i,1)) != 32 ) or ( CodeFor(SubStr(newstr,i-1,1)) != 32))
      retstr = retstr + SubStr(newstr,i,1);
    end;
  end;
  return retstr;
end;

macro sql_normalization ( column_name )
  var retstr;

  retstr = "replace(replace(replace(upper(trim(translate(" + column_name + ",'" + english_char + "','" + russian_char + "'))),' ', ' '||chr(2)),chr(2)||' '),chr(2))";

  return retstr;
end;

private macro MesPrnBox(mess, prnMess)
  if((prnMess == null) or (prnMess != 0))
    if(prnMess == null)
      msgbox(mess); 
    end;
  else
    println(mess);
  end;
end;

private macro ConfirmMesPrn(mess, prnMess)
  var Result = 0;
  array TextYN;
  array ButtonYN;
  ButtonYN( 0 ) = " Да ";
  ButtonYN( 1 ) = " Нет ";
  TextYN(0) = mess;

  if((prnMess == null) or (prnMess != 0))
    if(prnMess == null)
      Result = confwin( TextYN, ButtonYN ); 
    end;
  else
    Result = 0;
  end;
  return Result;
end;

/* Проверка существования таблиц */
macro is_tab_exists( prnMess )
  var rs;

  rs = RsdRecordset("select 1 from kladr_dbf where 1 = 0");
  rs.movenext;

  rs = RsdRecordset("select 1 from street_dbf where 1 = 0");
  rs.movenext;

  rs = RsdRecordset("select 1 from doma_dbf where 1 = 0");
  rs.movenext;

  rs = RsdRecordset("select 1 from flat_dbf where 1 = 0");
  rs.movenext;

  rs = RsdRecordset("select 1 from altnames_dbf where 1 = 0");
  rs.movenext;

  OnError(err);
  MesPrnBox("Справочники КЛАДР не загружены!", prnMess);
  exit;
end;

/* Проверка кода на актуальность и присутствие в справочниках */
macro check_actual_KLADR( address, TempKladr : @string, askUser, tmpStatus )

  array TextYN;
  array ButtonYN;
  array ButtonCNC;

  var i;
  var Result = 0;
  var cmd, rs;

  ButtonYN( 0 ) = " Да ";
  ButtonYN( 1 ) = " Нет ";
  ButtonCNC( 0 ) = " Заменить на новый ";
  ButtonCNC( 1 ) = " Отменить ";

  if(( strlen( address.Kladr ) == 13 ) or
     ( strlen( address.Kladr ) == 17 ))
    if( substr( address.Kladr, strlen( address.Kladr ) - 1, 2 ) != "00" )
      if( tmpStatus == -1 )
        TextYN(0) = "Заданный код КЛАДР неактуальный. Заменить его на актуальный?";
        Result = confwin( TextYN, ButtonYN );
        if( Result == 0 )
          TempKladr = address.Kladr;
          address.Kladr = substr( address.Kladr, 1, strlen( address.Kladr ) - 2 ) + "00";
        end;
      end;
    end;
    if( strlen( address.Kladr ) == 13 )
      i = 0;
      while( i < 2 )
        i = i + 1;
        cmd = RsdCommand("select * from kladr_dbf where t_code = '" + address.Kladr + "'");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          _CopyRSetToFBuff( kladr_dbf, rs );
          if( kladr_dbf.Index != "" )
            address.PostIndex = trim( kladr_dbf.Index );
          end;
        else
          if( i < 2 )
            cmd = RsdCommand("select * from altnames_dbf where trim(chr(32) from t_oldcode) = '" + address.Kladr + "'");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( altnames_dbf, rs );
              if( askUser )
                TextYN(0) = "Заданный код КЛАДР устарел. Новое значение кода по таблице altnames.dbf: " + altnames_dbf.newcode;
                Result = confwin( TextYN, ButtonCNC );
                if( Result == 0 )
                  address.Kladr = trim( altnames_dbf.newcode );
                end;       
              else
                address.Kladr = trim( altnames_dbf.newcode );
              end;
              if(( Result == 0 ) and ( check_actual_KLADR( address, @TempKladr, false, tmpStatus )))
                return 1; 
              end;
            end;
          else
            msgbox( "Код КЛАДР: " + address.Kladr + " отсутствует в файле kladr.dbf" );
            return 1;
          end;
        end;
      end;
    end;    
  
    if( strlen( address.Kladr ) == 17 )
      i = 0;
      while( i < 2 )
        i = i + 1;
        cmd = RsdCommand("select * from street_dbf where t_code = '" + address.Kladr + "'");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          _CopyRSetToFBuff( street_dbf, rs );
          if( street_dbf.Index != "" )
            address.PostIndex = trim( street_dbf.Index );
          end;
        else
          if( i < 2 )
            cmd = RsdCommand("select * from altnames_dbf where trim(chr(32) from t_oldcode) = '" + address.Kladr + "'");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( altnames_dbf, rs );
              if( askUser )
                TextYN(0) = "Заданный код КЛАДР устарел. Новое значение кода по таблице altnames.dbf: " + altnames_dbf.newcode;
                Result = confwin( TextYN, ButtonCNC );
                if( Result == 0 )
                  address.Kladr = trim( altnames_dbf.newcode );
                end;
              else
                address.Kladr = trim( altnames_dbf.newcode );
              end;
              if(( Result == 0 ) and ( check_actual_KLADR( address, @TempKladr, false, tmpStatus )))
                return 1; 
              end;
            end;
          else
            msgbox( "Код КЛАДР: " + address.Kladr + " отсутствует в файле street.dbf" );
            return 1;
          end;
        end;
      end;
    end;    
  end; 
  
  if( strlen( address.Kladr ) == 19 )
    i = 0;
    while( i < 2 )
      i = i + 1;
      cmd = RsdCommand("select * from doma_dbf where t_code = '" + address.Kladr + "'");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        _CopyRSetToFBuff( doma_dbf, rs );
        if( doma_dbf.Index != "" )
          address.PostIndex = trim( doma_dbf.Index );
        end;
      else
        if( i < 2 )
          cmd = RsdCommand("select * from altnames_dbf where trim(chr(32) from t_oldcode) = '" + address.Kladr + "'");
          rs = RsdRecordset( cmd );           
          if( rs.movenext )
            _CopyRSetToFBuff( altnames_dbf, rs );
            if( askUser )
              TextYN(0) = "Заданный код КЛАДР устарел. Новое значение кода по таблице altnames.dbf: " + altnames_dbf.newcode;
              Result = confwin( TextYN, ButtonCNC );
              if( Result == 0 )
                address.Kladr = trim( altnames_dbf.newcode );
              end;       
            end;
            if(( Result == 0 ) and ( check_actual_KLADR( address, @TempKladr, false, tmpStatus )))
              return 1; 
            end;
          end;
        else
          msgbox( "Код КЛАДР: " + address.Kladr + " отсутствует в файле doma.dbf" );
          return 1;
        end;
      end;
    end;
  end;    
  
  if( strlen( address.Kladr ) == 23 )
    cmd = RsdCommand("select * from flat_dbf where t_code = '" + address.Kladr + "'");
    rs = RsdRecordset( cmd );           
    if( rs.movenext )
      _CopyRSetToFBuff( flat_dbf, rs );
      if( doma_dbf.Index != "" )
        address.PostIndex = trim( doma_dbf.Index );
      end;
    else
      msgbox( "Код КЛАДР: " + address.Kladr + " отсутствует в файле flat.dbf" );
      return 1;
    end;
  end;    

  return 0;
end;

/*
Если prnMess == null, то сообщения об ошибках выводятся на экран
Если prnMess == 0   , то сообщения об ошибках выводятся в отчет макроса
Если prnMess != 0   , то сообщения об ошибках не выводятся никуда

placeFld - поле текущее на форме адреса при ручном вводе наименований адресных объектов
*/
private macro formingKLADREx( ptaddress, mode, status_:@integer, prnMess, retKladr:@string, placeFld )
  var i;
  var Text;
  var Result;
  array ButtonCCC;
  array ButtonCC;
  array ButtonC;
  array TextCC;
  var ColumnsR  : TArray = TArray;
  var ColumnsPr : TArray = TArray;
  var ColumnsD  : TArray = TArray;
  var ColumnsP  : TArray = TArray;
  var ColumnsS  : TArray = TArray;

  var TempKladr, TempPostIndex, TempOkato;
  var Region  , CodeRegion  , newRegion  , newCodeRegion  ,
      Province, CodeProvince, newProvince, newCodeProvince,
      District, CodeDistrict, newDistrict, newCodeDistrict,
      Place   , CodePlace   , newPlace   , newCodePlace   ,   
      Street  , CodeStreet  , newStreet  , newCodeStreet  ;
  var House, NumCorps, newHouse, newNumCorps;
  var tmpStatus = status_;
  
  var stat, cmd, rs;
  var TxtPath;

  macro EvProc( rs, cmd, id, key )
    if(( cmd == DLG_KEY ) and ( key == 13 ))
      return CM_SELECT;
    end;
  end;
  /* Вспомогательная процедура подготовки информации с атрибутами полей*/
  macro AddCol( ar,ind, fld, head, width, rdonly )
    ar.value( ind * 6 + 0 ) = fld;
    ar.value( ind * 6 + 1 ) = head;
    ar.value( ind * 6 + 2 ) = width;
    ar.value( ind * 6 + 3 ) = 2;   // fldType
    ar.value( ind * 6 + 4 ) = -1;  // decPoint
    ar.value( ind * 6 + 5 ) = 0;   // reserv
  end;
                          
  ButtonCCC( 0 ) = " Заменить ";
  ButtonCCC( 1 ) = " Оставить ";
  ButtonCCC( 2 ) = " Отменить ";

  ButtonCC( 0 ) = " Заменить ";
  ButtonCC( 1 ) = " Отменить ";

  ButtonC( 0 )  = " Отменить ";

  GetRegistryValue("CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР", V_STRING, TxtPath, stat);
  if( stat != 0 ) 
    MesPrnBox("Ошибка чтения настройки CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР", prnMess); 
  end;
  
  if( SubStr( TxtPath, strlen( TxtPath )) != "\\" )
    TxtPath = TxtPath + "\\";
  end;
  
  if( not open( kladr_dbf, TxtPath + "kladr.dbf" ))
    MesPrnBox("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл kladr.dbf не может быть открыт!!!", prnMess); 
    return 1;
  end;
  if( not open( street_dbf, TxtPath + "street.dbf" ))
    MesPrnBox("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл street.dbf не может быть открыт!!!", prnMess); 
    return 1;
  end;
  if( not open( altnames_dbf, TxtPath + "altnames.dbf" ))
    MesPrnBox("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл altnames.dbf не может быть открыт!!!", prnMess); 
    return 1;
  end;
  if( not open( doma_dbf, TxtPath + "doma.dbf" ))
    MesPrnBox("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл doma.dbf не может быть открыт!!!", prnMess); 
    return 1;
  end;
  if( not open( flat_dbf, TxtPath + "flat.dbf" ))
    MesPrnBox("настройка реестра CB\\PARTY\\КЛАДР\\ЗАГРУЗКА КЛАДР задана неверно,|| или файл flat.dbf не может быть открыт!!!", prnMess); 
    return 1;
  end;

  is_tab_exists(prnMess);

  record address( adress );  
  record addressDOMA( adress );  

  if((prnMess == null) or (prnMess != 0))
    SetBuff( address, ptaddress );
  else
    Copy( address, ptaddress );
  end;

  stat = 1;

  CodeRegion   = address.CodeRegion;
  CodeProvince = address.CodeProvince;
  CodeDistrict = address.CodeDistrict;
  CodePlace    = address.CodePlace;
  CodeStreet   = address.CodeStreet;
  
  if(( strlen( CodeRegion ) > 1 ) and ( SubStr( CodeRegion, strlen( CodeRegion )) == "." ))
    CodeRegion = SubStr( CodeRegion, 1, strlen( CodeRegion ) - 1 );                    
  end;
  if(( strlen( CodeProvince ) > 1 ) and ( SubStr( CodeProvince, strlen( CodeProvince )) == "." ))
    CodeProvince = SubStr( CodeProvince, 1, strlen( CodeProvince ) - 1 );
  end;
  if(( strlen( CodeDistrict ) > 1) and ( SubStr( CodeDistrict, strlen( CodeDistrict )) == "." ))
    CodeDistrict = SubStr( CodeDistrict, 1, strlen(CodeDistrict) - 1 );                       
  end;
  if(( strlen( CodePlace ) > 1 ) and ( SubStr( CodePlace, strlen( CodePlace )) == "." ))
    CodePlace = SubStr( CodePlace, 1, strlen( CodePlace ) - 1 );
  end;
  if(( strlen( CodeStreet ) > 1 ) and ( SubStr( CodeStreet, strlen( CodeStreet )) == "." ))
    CodeStreet = SubStr( CodeStreet, 1, strlen( CodeStreet ) - 1 );
  end;

  /* Определение кода КЛАДР по адресным полям */
  if( mode == 0 )
    TempKladr = "";
    TempPostIndex = "";
    /* НОРМАЛИЗАЦИЯ */  
    Region   = normalization( address.Region );
    Province = normalization( address.Province );
    District = normalization( address.District );
    Place    = normalization( address.Place );
    Street   = normalization( address.Street );
    House    = normalization( address.House );
    NumCorps = normalization( address.NumCorps );

    if( Region == "" )
      MesPrnBox("Не задан регион!", prnMess); 
      return 1;
    end;

    /* поиск региона */
    i = 0;
    if((placeFld == 0) or (placeFld >= 2))
    if( address.PostIndex != "" )
      cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        i = rs.value(0);
        if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
          cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
          rs = RsdRecordset( cmd );           
          if( rs.movenext )
            _CopyRSetToFBuff( kladr_dbf, rs );
            TempKladr          = trim( kladr_dbf.code );
            TempPostIndex      = trim( kladr_dbf.index);
            address.CodeRegion = trim( kladr_dbf.socr );
            address.Region     = trim( kladr_dbf.name );
            address.RegionNum  = trim( substr(trim( kladr_dbf.code), 1, 2));
            if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
          end;
        end;
      end;
    end;
    if(( i != 1 ) and ( address.Okato != "" ))
      cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        i = rs.value(0);
        if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
          cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
          rs = RsdRecordset( cmd );           
          if( rs.movenext )
            _CopyRSetToFBuff( kladr_dbf, rs );
            TempKladr          = trim( kladr_dbf.code );
            TempPostIndex      = trim( kladr_dbf.index);
            address.CodeRegion = trim( kladr_dbf.socr );
            address.Region     = trim( kladr_dbf.name );
            address.RegionNum  = trim( substr(trim( kladr_dbf.code), 1, 2));
            if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
          end;
        end;
      end;
    end;
    if( i != 1 )
      cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000';");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        i = rs.value(0);
        if( i == 0 )
          MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeRegion + " " + address.Region, prnMess); 
          return 1;
        elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
          cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000';");
          rs = RsdRecordset( cmd );           
          if( rs.movenext )
            _CopyRSetToFBuff( kladr_dbf, rs );
            TempKladr          = trim( kladr_dbf.code );
            TempPostIndex      = trim( kladr_dbf.index);
            address.CodeRegion = trim( kladr_dbf.socr );
            address.Region     = trim( kladr_dbf.name );
            address.RegionNum  = trim( substr(trim( kladr_dbf.code), 1, 2));
            if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
          end;
        elif ( i > 1 )
          cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Region + "' and trim(t_socr) = '" + CodeRegion + "' and t_code like '__00000000000';");
          AddCol( ColumnsR, 0, "t_Name"  , "Наименование", null, true);
          AddCol( ColumnsR, 1, "t_Socr"  , "Тип", null, true);
          AddCol( ColumnsR, 2, "t_Code"  , "Код", null, true);
          AddCol( ColumnsR, 3, "t_Index" , "Индекс", null, true);
          AddCol( ColumnsR, 4, "t_Gninmb", "Налог.орг.", null, true);
          AddCol( ColumnsR, 5, "t_Uno"   , "Номер ИМНС", null, true);
          AddCol( ColumnsR, 6, "t_Okatd" , "Код ОКАТО", null, true);
          AddCol( ColumnsR, 7, "t_Status", "Статус", null, true);
          rs = RSDRecordset( cmd , RSDVAL_CLIENT, RSDVAL_STATIC );
          if( RunScroll( rs, 8, ColumnsR, "Регионы", "EvProc", "Выбрать регион", "~Esc~ Отмена, ~Enter~ Выбор", true ))
            _CopyRSetToFBuff( kladr_dbf, rs );
            TempKladr          = trim( kladr_dbf.code );
            TempPostIndex      = trim( kladr_dbf.index);
            address.CodeRegion = trim( kladr_dbf.socr );
            address.Region     = trim( kladr_dbf.name );
            address.RegionNum  = trim( substr(trim( kladr_dbf.code), 1, 2));
            if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
          end;
        end;
      end;
    end;
    end;

    /* поиск района */
    if((placeFld == 0) or (placeFld >= 5))
    if(( address.CodeProvince != "" ) or ( address.Province != "" ))
      i = 0;
      if( address.PostIndex != "" )
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeProvince = trim( kladr_dbf.socr );
              address.Province     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeProvince = trim( kladr_dbf.socr );
              address.Province     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if( i != 1 )
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeProvince + " " + address.Province, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeProvince = trim( kladr_dbf.socr );
              address.Province     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          elif ( i > 1 )
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Province + "' and trim(t_socr) = '" + CodeProvince + "' and substr( t_code, 1, 2 ) = '" + substr( TempKladr, 1, 2 ) + "' and t_code like '_____00000000';");
            rs = RSDRecordset( cmd , RSDVAL_CLIENT, RSDVAL_STATIC );
            AddCol( ColumnsPr, 0, "t_Name"  , "Наименование", null, true);
            AddCol( ColumnsPr, 1, "t_Socr"  , "Тип", null, true);
            AddCol( ColumnsPr, 2, "t_Code"  , "Код", null, true);
            AddCol( ColumnsPr, 3, "t_Index" , "Индекс", null, true);
            AddCol( ColumnsPr, 4, "t_Gninmb", "Налог.орг.", null, true);
            AddCol( ColumnsPr, 5, "t_Uno"   , "Номер ИМНС", null, true);
            AddCol( ColumnsPr, 6, "t_Okatd" , "Код ОКАТО", null, true);
            AddCol( ColumnsPr, 7, "t_Status", "Статус", null, true);
            if( RunScroll( rs, 8, ColumnsPr, "Районы", "EvProc", "Выбрать район", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeProvince = trim( kladr_dbf.socr );
              address.Province     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
    end;
    end;

    /* поиск города */
    if((placeFld == 0) or (placeFld >= 8))
    if(( address.CodeDistrict != "" ) or ( address.District != "" ))
      i = 0;
      if( address.PostIndex != "" )
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeDistrict = trim( kladr_dbf.socr );
              address.District     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeDistrict = trim( kladr_dbf.socr );
              address.District     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if( i != 1 )
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeDistrict + " " + address.District, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeDistrict = trim( kladr_dbf.socr );
              address.District     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          elif ( i > 1 )
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + District + "' and trim(t_socr) = '" + CodeDistrict + "' and substr( t_code, 1, 5 ) = '" + substr( TempKladr, 1, 5 ) + "' and t_code like '________00000';");
            rs = RSDRecordset( cmd , RSDVAL_CLIENT, RSDVAL_STATIC );
            AddCol( ColumnsD, 0, "t_Name"  , "Наименование", null, true);
            AddCol( ColumnsD, 1, "t_Socr"  , "Тип", null, true);
            AddCol( ColumnsD, 2, "t_Code"  , "Код", null, true);
            AddCol( ColumnsD, 3, "t_Index" , "Индекс", null, true);
            AddCol( ColumnsD, 4, "t_Gninmb", "Налог.орг.", null, true);
            AddCol( ColumnsD, 5, "t_Uno"   , "Номер ИМНС", null, true);
            AddCol( ColumnsD, 6, "t_Okatd" , "Код ОКАТО", null, true);
            AddCol( ColumnsD, 7, "t_Status", "Статус", null, true);
            if( RunScroll( rs, 8, ColumnsD, "Города", "EvProc", "Выбрать город", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr            = trim( kladr_dbf.code );
              TempPostIndex        = trim( kladr_dbf.index);
              address.CodeDistrict = trim( kladr_dbf.socr );
              address.District     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
    end;
    end;

    /* поиск населенного пункта */
    if((placeFld == 0) or (placeFld >= 11))
    if(( address.CodePlace != "" ) or ( address.Place != "" ))
      i = 0;
      if( address.PostIndex != "" )
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr         = trim( kladr_dbf.code );
              TempPostIndex     = trim( kladr_dbf.index);
              address.CodePlace = trim( kladr_dbf.socr );
              address.Place     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr         = trim( kladr_dbf.code );
              TempPostIndex     = trim( kladr_dbf.index);
              address.CodePlace = trim( kladr_dbf.socr );
              address.Place     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if( i != 1 )
        cmd = RsdCommand("select count(1) from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodePlace + " " + address.Place, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr         = trim( kladr_dbf.code );
              TempPostIndex     = trim( kladr_dbf.index);
              address.CodePlace = trim( kladr_dbf.socr );
              address.Place     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          elif ( i > 1 )
            cmd = RsdCommand("select * from kladr_dbf where " + sql_normalization("t_Name") + "= '" + Place + "' and trim(t_socr) = '" + CodePlace + "' and substr( t_code, 1, 8 ) = '" + substr( TempKladr, 1, 8 ) + "' and t_code like '___________00';");
            rs = RSDRecordset( cmd , RSDVAL_CLIENT, RSDVAL_STATIC );
            AddCol( ColumnsP, 0, "t_Name"  , "Наименование", null, true);
            AddCol( ColumnsP, 1, "t_Socr"  , "Тип", null, true);
            AddCol( ColumnsP, 2, "t_Code"  , "Код", null, true);
            AddCol( ColumnsP, 3, "t_Index" , "Индекс", null, true);
            AddCol( ColumnsP, 4, "t_Gninmb", "Налог.орг.", null, true);
            AddCol( ColumnsP, 5, "t_Uno"   , "Номер ИМНС", null, true);
            AddCol( ColumnsP, 6, "t_Okatd" , "Код ОКАТО", null, true);
            AddCol( ColumnsP, 7, "t_Status", "Статус", null, true);
            if( RunScroll( rs, 8, ColumnsP, "Населенные пункты", "EvProc", "Выбрать населенный пункт", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff( kladr_dbf, rs );
              TempKladr         = trim( kladr_dbf.code );
              TempPostIndex     = trim( kladr_dbf.index);
              address.CodePlace = trim( kladr_dbf.socr );
              address.Place     = trim( kladr_dbf.name );
              if(trim(kladr_dbf.ocatd) != "") TempOkato = kladr_dbf.ocatd; end;
            end;
          end;
        end;
      end
    end;
    end;

    /* поиск улицы */
    if((placeFld == 0) or (placeFld >= 15))
    if(( address.CodeStreet != "" ) or ( address.Street != "" ))
      i = 0;
      if( address.PostIndex != "" )
        cmd = RsdCommand("select count(1) from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00' and trim(t_index) = '" + trim( address.PostIndex ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( street_dbf, rs );
              TempKladr          = trim( street_dbf.code );
              TempPostIndex      = trim( street_dbf.index);
              address.CodeStreet = trim( street_dbf.socr );
              address.Street     = trim( street_dbf.name );
              if(trim(street_dbf.ocatd) != "") TempOkato = street_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
        cmd = RsdCommand("select count(1) from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00' and trim(t_ocatd) = '" + trim( address.Okato ) + "';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( street_dbf, rs );
              TempKladr          = trim( street_dbf.code );
              TempPostIndex      = trim( street_dbf.index);
              address.CodeStreet = trim( street_dbf.socr );
              address.Street     = trim( street_dbf.name );
              if(trim(street_dbf.ocatd) != "") TempOkato = street_dbf.ocatd; end;
            end;
          end;
        end;
      end;
      if( i != 1 )
        cmd = RsdCommand("select count(1) from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00';");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeStreet + " " + address.Street, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
            cmd = RsdCommand("select * from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00';");
            rs = RsdRecordset( cmd );           
            if( rs.movenext )
              _CopyRSetToFBuff( street_dbf, rs );
              TempKladr          = trim( street_dbf.code );
              TempPostIndex      = trim( street_dbf.index);
              address.CodeStreet = trim( street_dbf.socr );
              address.Street     = trim( street_dbf.name );
              if(trim(street_dbf.ocatd) != "") TempOkato = street_dbf.ocatd; end;
            end;
          elif ( i > 1 )
            cmd = RsdCommand("select * from street_dbf where " + sql_normalization("t_Name") + "= '" + Street + "' and trim(t_socr) = '" + CodeStreet + "' and substr( t_code, 1, 11 ) = '" + substr( TempKladr, 1, 11 ) + "' and t_code like '_______________00';");
            rs = RSDRecordset( cmd , RSDVAL_CLIENT, RSDVAL_STATIC );
            AddCol( ColumnsS, 0, "t_Name"  , "Наименование", null, true);
            AddCol( ColumnsS, 1, "t_Socr"  , "Тип", null, true);
            AddCol( ColumnsS, 2, "t_Code"  , "Код", null, true);
            AddCol( ColumnsS, 3, "t_Index" , "Индекс", null, true);
            AddCol( ColumnsS, 4, "t_Gninmb", "Налог.орг.", null, true);
            AddCol( ColumnsS, 5, "t_Uno"   , "Номер ИМНС", null, true);
            AddCol( ColumnsS, 6, "t_Okatd" , "Код ОКАТО", null, true);
            if( RunScroll( rs, 7, ColumnsS, "Улицы", "EvProc", "Выбрать улицу", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff( street_dbf, rs );
              TempKladr          = trim( street_dbf.code );
              TempPostIndex      = trim( street_dbf.index);
              address.CodeStreet = trim( street_dbf.socr );
              address.Street     = trim( street_dbf.name );
              if(trim(street_dbf.ocatd) != "") TempOkato = street_dbf.ocatd; end;
            end;
          end;
        end;
      end;
    else
      /*Для случаев, когда дома не привязаны к улицам нужно дополнить код нулями до размера кода улицы*/
      if(address.House != "")
        TempKladr = substr(TempKladr, 1, 11) + "000000";
      end;
    end;
    end;

    /* поиск дома */
    if((placeFld == 0) or (placeFld >= 19))
    if( address.House != "" )
      i = 0;
      if( address.NumCorps != "" )
        cmd = RsdCommand("select count(1) from doma_dbf where " + sql_normalization("t_Korp") + "= '" + NumCorps + "' and substr( t_code, 1, 15 ) = '" + substr( TempKladr, 1, 15 ) + "'");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if ( i > 1 )
            cmd = RsdCommand("select * from doma_dbf where " + sql_normalization("t_Korp") + "= '" + NumCorps + "' and substr( t_code, 1, 15 ) = '" + substr( TempKladr, 1, 15 ) + "'");
            rs = RsdRecordset( cmd );           
            while( rs.movenext and ( strlen(TempKladr) < 19 ))
              _CopyRSetToFBuff( doma_dbf, rs );
              if( PTCheckHouseInMask( normalization(trim(doma_dbf.name)), House ))
                TempKladr          = trim( doma_dbf.code  );
                TempPostIndex      = trim( doma_dbf.index );
                if(trim(doma_dbf.ocatd) != "") TempOkato = doma_dbf.ocatd; end;
              end;
            end;
          end;
        end;
      end;
      if( strlen(TempKladr) < 19 )
        cmd = RsdCommand("select count(1) from doma_dbf where substr( t_code, 1, 15 ) = '" + substr( TempKladr, 1, 15 ) + "'");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          i = rs.value(0);
          if ( i > 0 )
            cmd = RsdCommand("select * from doma_dbf where substr( t_code, 1, 15 ) = '" + substr( TempKladr, 1, 15 ) + "'");
            rs = RsdRecordset( cmd );           
            while( rs.movenext and ( strlen(TempKladr) < 19 ))
              _CopyRSetToFBuff( doma_dbf, rs );
              if( PTCheckHouseInMask( normalization(trim(doma_dbf.name)), House ))
                TempKladr          = trim( doma_dbf.code  );
                TempPostIndex      = trim( doma_dbf.index );
                address.NumCorps   = trim( doma_dbf.korp  );
                if(trim(doma_dbf.ocatd) != "") TempOkato = doma_dbf.ocatd; end;
              end;
            end;
          end;
        end;
      end;
      if((i > 0) and (strlen(TempKladr) < 19))
        if( strlen(address.NumCorps) > 0 )
          i = ConfirmMesPrn("Указанный номер дома " + address.House + ", корпус " + address.NumCorps + " не найден в КЛАДР. Вы уверены в его правильности?", prnMess); 
        else
          i = ConfirmMesPrn("Указанный номер дома " + address.House + " не найден в КЛАДР. Вы уверены в его правильности?", prnMess); 
        end;
        if(i == 0)
          MesPrnBox("Будет использован индекс, код КЛАДР и код ОКАТО улицы", prnMess);
        else
          return 1;
        end;
      end;
    end;
    end;
    if((trim(address.Kladr) == trim(TempKladr)) and (trim(address.PostIndex) == trim(TempPostIndex)) and (trim(address.Okato) == trim(TempOkato)))
      MesPrnBox("Проверка выполнена успешно", prnMess); 
    end;
    i = 0;
    if((trim(address.Kladr) != "") and (trim(address.Kladr) != trim(TempKladr)))
      if(trim(TempKladr) != "")
        i = ConfirmMesPrn("Введенное значение кода КЛАДР не соответствует справочному. Заменить?", prnMess);
      else
        MesPrnBox("Код КЛАДР отсутствует в КЛАДР", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.Kladr = trim( TempKladr );
      retKladr = trim( TempKladr );
    end;
    i = 0;
    if((trim(address.PostIndex) != "") and (trim(address.PostIndex) != trim(TempPostIndex)))
      if(trim(TempKladr) != "")
        i = ConfirmMesPrn("Введенное значение индекса не соответствует КЛАДР. Заменить?", prnMess); 
      else
        MesPrnBox("Индекс отсутствует в КЛАДР", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.PostIndex = trim( TempPostIndex );
    end;
    i = 0;
    if((trim(address.Okato) != "") and (trim(address.Okato) != trim(TempOkato)))
      if(trim(TempKladr) != "")
        i = ConfirmMesPrn("Введенное значение ОКАТО не соответствует КЛАДР. Заменить?", prnMess); 
      else
        MesPrnBox("Код ОКАТО отсутствует в КЛАДР", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.Okato = trim( TempOkato );
    end;
  end;/* if( mode == 0 )*/
  
  /* Определение адресных полей по коду КЛАДР*/
  if( mode == 1 )
    newHouse        = "";
    newNumCorps     = "";
    newCodeStreet   = "";
    newStreet       = "";
    newCodePlace    = "";
    newPlace        = "";
    newCodeDistrict = "";
    newDistrict     = "";
    newCodeProvince = "";
    newProvince     = "";
    newCodeRegion   = "";
    newRegion       = "";
    TempKladr       = "";

    if( trim( address.Kladr ) == "" )
      msgbox( "Заполните код КЛАДР!" );
      return 1;
    end;

    /* Проветка цифр в коде кладр */
    i = 1;
    while( i <= strlen( address.Kladr ))
      if(( substr( address.Kladr, i, 1 ) != "0" ) and 
         ( substr( address.Kladr, i, 1 ) != "1" ) and 
         ( substr( address.Kladr, i, 1 ) != "2" ) and 
         ( substr( address.Kladr, i, 1 ) != "3" ) and 
         ( substr( address.Kladr, i, 1 ) != "4" ) and 
         ( substr( address.Kladr, i, 1 ) != "5" ) and 
         ( substr( address.Kladr, i, 1 ) != "6" ) and 
         ( substr( address.Kladr, i, 1 ) != "7" ) and 
         ( substr( address.Kladr, i, 1 ) != "8" ) and 
         ( substr( address.Kladr, i, 1 ) != "9" ))
        msgbox( "Код КЛАДР содержит недопустимые символы! " + substr( address.Kladr, i, 1 ));
        return 1;
      end;
      i = i + 1;
    end;
    /* Проверка региона в коде кладр */
    if( substr( address.Kladr, 1, 2 ) == "00" )
      msgbox( "Код КЛАДР должен обязательно содержать код региона!" );
      return 1;
    end;
    
    if(( strlen( address.Kladr ) != 13 ) and
       ( strlen( address.Kladr ) != 17 ) and
       ( strlen( address.Kladr ) != 19 ) and
       ( strlen( address.Kladr ) != 23 ))
      msgbox( "Длина кода КЛАДР не соответствует допустимому значению: 13, 17, 19 или 23 знака!" );
      return 1;
    end;

    /* Проверка кода на актуальность и присутствие в справочниках */
    if( check_actual_KLADR( address, @TempKladr, true, tmpStatus ))
      return 1;
    end;       
    
    /* Заполнение адресных полей формы */
    TempKladr = address.Kladr;
    if( strlen( TempKladr ) > 17 )
      TempKladr = substr( TempKladr, 1, 15 ) + "00";
    end;

    if( strlen( TempKladr ) == 17 )
      cmd = RsdCommand("select * from street_dbf where t_code = '" + TempKladr + "'");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        _CopyRSetToFBuff( street_dbf, rs );
        newCodeStreet = street_dbf.socr;
        newStreet     = street_dbf.name;
      end;
      TempKladr = substr( TempKladr, 1, 11 ) + "00";
    end;

    if( substr( TempKladr, 9, 3 ) != "000" )
      cmd = RsdCommand("select * from kladr_dbf where t_code = '" + TempKladr + "'");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        _CopyRSetToFBuff( kladr_dbf, rs );
        newCodePlace = kladr_dbf.socr;
        newPlace     = kladr_dbf.name;
        if( kladr_dbf.status == "1" )
          status_ = 4;
        elif( kladr_dbf.status == "3" )
          status_ = 5;
        end;
      end;
      TempKladr = substr( TempKladr, 1, 8 ) + "00000";
    end;

    if( substr( TempKladr, 6, 3 ) != "000" )
      cmd = RsdCommand("select * from kladr_dbf where t_code = '" + TempKladr + "'");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        _CopyRSetToFBuff( kladr_dbf, rs );
        newCodeDistrict = kladr_dbf.socr;
        newDistrict     = kladr_dbf.name;
        if( kladr_dbf.status == "1" )
          status_ = 1;
        elif( kladr_dbf.status == "2" )
          status_ = 2;
        elif( kladr_dbf.status == "3" )
          status_ = 3;
        end;
      end;
      TempKladr = substr( TempKladr, 1, 5 ) + "00000000";
    end;

    if( substr( TempKladr, 3, 3 ) != "000" )
      cmd = RsdCommand("select * from kladr_dbf where t_code = '" + TempKladr + "'");
      rs = RsdRecordset( cmd );           
      if( rs.movenext )
        _CopyRSetToFBuff( kladr_dbf, rs );
        newCodeProvince = kladr_dbf.socr;
        newProvince     = kladr_dbf.name;
      end;
      TempKladr = substr( TempKladr, 1, 2 ) + "00000000000";
    end;

    cmd = RsdCommand("select * from kladr_dbf where t_code = '" + TempKladr + "'");
    rs = RsdRecordset( cmd );           
    if( rs.movenext )
      _CopyRSetToFBuff( kladr_dbf, rs );
      newCodeRegion = kladr_dbf.socr;
      newRegion     = kladr_dbf.name;
    end;

    i = 0;

    if( strlen( address.Kladr ) == 19 )
      if( tmpStatus != -1 )
        Copy( addressDOMA, address );

        addressDOMA.NumCorps     = trim( newNumCorps    );
        addressDOMA.House        = trim( newHouse       );
        addressDOMA.CodeStreet   = trim( newCodeStreet  );
        addressDOMA.Street       = trim( newStreet      );
        addressDOMA.CodePlace    = trim( newCodePlace   );
        addressDOMA.Place        = trim( newPlace       );
        addressDOMA.CodeDistrict = trim( newCodeDistrict);
        addressDOMA.District     = trim( newDistrict    );
        addressDOMA.CodeProvince = trim( newCodeProvince);
        addressDOMA.Province     = trim( newProvince    );
        addressDOMA.CodeRegion   = trim( newCodeRegion  );
        addressDOMA.Region       = trim( newRegion      );

        if( PTListKLADR_DOMA( addressDOMA ))
          newHouse    = addressDOMA.House   ;
          newNumCorps = addressDOMA.NumCorps;
        else
          return 1;
        end;
      else
        cmd = RsdCommand("select * from doma_dbf where t_code = '" + address.Kladr + "'");
        rs = RsdRecordset( cmd );           
        if( rs.movenext )
          _CopyRSetToFBuff( doma_dbf, rs );
          if( PTCheckHouseInMask( normalization(trim(doma_dbf.name)), normalization(address.House) )) // "24 1" != "24/1"
            newNumCorps = address.NumCorps; 
            newHouse    = address.House   ;
          else
            newNumCorps = doma_dbf.korp;
            newHouse    = doma_dbf.name;
          end;
        end;
      end;
    end;

    if(( trim( address.Region   ) != "" ) or
       ( trim( address.Province ) != "" ) or
       ( trim( address.District ) != "" ) or
       ( trim( address.Place    ) != "" ) or
       ( trim( address.Street   ) != "" ) or
       ( trim( address.House    ) != "" ) or
       ( trim( address.NumCorps ) != "" ) )
      TextCC( i ) = "Значения полей адреса не совпадают с найденными в справочнике КЛАДР:";

      if( trim( newRegion     ) != trim( address.Region     ))
        i = i + 1;
        if( trim( newRegion ) == "" )
          TextCC( i ) = "Найденное значение поля 'Регион': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Регион': " + trim( newCodeRegion ) + " " + trim( newRegion );
        end;
      end;
      
      if( trim( newProvince     ) != trim( address.Province     ))
        i = i + 1;
        if( trim( newProvince ) == "" )
          TextCC( i ) = "Найденное значение поля 'Район': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Район': " + trim( newCodeProvince ) + " " + trim( newProvince );
        end;
      end;
          
      if( trim( newDistrict     ) != trim( address.District     ))
        i = i + 1;
        if( trim( newDistrict ) == "" )
          TextCC( i ) = "Найденное значение поля 'Город': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Город': " + trim( newCodeDistrict ) + " " + trim( newDistrict );
        end;
      end;
          
      if( trim( newPlace     ) != trim( address.Place     ))
        i = i + 1;
        if( trim( newPlace ) == "" )
          TextCC( i ) = "Найденное значение поля 'Населенный пункт': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Населенный пункт': " + trim( newCodePlace ) + " " + trim( newPlace );
        end;
      end;
           
      if( trim( newStreet     ) != trim( address.Street     ))
        i = i + 1;
        if( trim( newStreet ) == "" )
          TextCC( i ) = "Найденное значение поля 'Улица': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Улица': " + trim( newCodeStreet ) + " " + trim( newStreet );
        end;
      end;

      if((tmpStatus != -1) and (trim(newHouse) != trim(address.House)))
        i = i + 1;
        if( trim( newHouse ) == "" )
          TextCC( i ) = "Найденное значение поля 'Дом': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Дом': " + trim( newHouse );
        end;
      end;

      if((tmpStatus != -1) and (trim(newNumCorps) != trim(address.NumCorps)))
        i = i + 1;
        if( trim( newNumCorps ) == "" )
          TextCC( i ) = "Найденное значение поля 'Корпус': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Корпус': " + trim( newNumCorps );
        end;
      end;

      if( i > 0 )
        if(index(newHouse, ",") or index(newHouse, "-") or index(newHouse, "Н") or index(newHouse, "Ч"))
          Result = confwin( TextCC, ButtonC );
        elif(tmpStatus != -1)
          Result = confwin( TextCC, ButtonCC );
          if( Result == 0 )
            address.NumCorps     = trim( newNumCorps    );
            address.House        = trim( newHouse       );
            address.CodeStreet   = trim( newCodeStreet  );
            address.Street       = trim( newStreet      );
            address.CodePlace    = trim( newCodePlace   );
            address.Place        = trim( newPlace       );
            address.CodeDistrict = trim( newCodeDistrict);
            address.District     = trim( newDistrict    );
            address.CodeProvince = trim( newCodeProvince);
            address.Province     = trim( newProvince    );
            address.CodeRegion   = trim( newCodeRegion  );
            address.Region       = trim( newRegion      );
          else
            return 1;
          end;
        else
          Result = confwin( TextCC, ButtonCCC );
          if( Result == 0 )
            if(trim(newNumCorps) != "")
              address.NumCorps     = trim( newNumCorps    );
            end;
            if(trim(newHouse) != "")
              address.House        = trim( newHouse       );
            end;
            address.CodeStreet   = trim( newCodeStreet  );
            address.Street       = trim( newStreet      );
            address.CodePlace    = trim( newCodePlace   );
            address.Place        = trim( newPlace       );
            address.CodeDistrict = trim( newCodeDistrict);
            address.District     = trim( newDistrict    );
            address.CodeProvince = trim( newCodeProvince);
            address.Province     = trim( newProvince    );
            address.CodeRegion   = trim( newCodeRegion  );
            address.Region       = trim( newRegion      );
          elif( Result == 2)
            return 1;
          end;
        end;
      end;
    else
      if((tmpStatus != -1) and (trim(newNumCorps) != ""))
        address.NumCorps     = trim( newNumCorps    );
      end;
      if((tmpStatus != -1) and (trim(newHouse) != ""))
        address.House        = trim( newHouse       );
      end;
      address.CodeStreet   = trim( newCodeStreet  );
      address.Street       = trim( newStreet      );
      address.CodePlace    = trim( newCodePlace   );
      address.Place        = trim( newPlace       );
      address.CodeDistrict = trim( newCodeDistrict);
      address.District     = trim( newDistrict    );
      address.CodeProvince = trim( newCodeProvince);
      address.Province     = trim( newProvince    );
      address.CodeRegion   = trim( newCodeRegion  );
      address.Region       = trim( newRegion      );
    end;

    if((prnMess == null) or (prnMess != 0))
    else
      Copy( ptaddress, address );
    end;

  end; /*if( mode == 1 )*/
  return 0;
end;

macro formingKLADR( ptaddress, mode, status_ : @integer )
  return formingKLADREx( ptaddress, mode, @status_, null, null, 0 );
end;

macro formingKLADRRec( ptaddress, mode, status_ : @integer )
  return formingKLADREx( ptaddress, mode, @status_, 0, null, 0 );
end;

macro formingKLADRQuiet( ptaddress, mode, placeFld, status_ : @integer )
  return formingKLADREx( ptaddress, mode, @status_, 1, null, placeFld );
end;

macro formingKLADRQuietRec( ptaddress, mode, placeFld, status_ : @integer )
  return formingKLADREx( ptaddress, mode, @status_, 0, null, placeFld );
end;

macro formingKLADRfromOKATO( ptaddress, retKladr:@string )
  return formingKLADREx( ptaddress, 0, null, 0, @retKladr, 0 );
end;
