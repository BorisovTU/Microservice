/*
$Name: fm_outex.mac
$Module: Фин. мониторинг 
$Description: Контроль противодействия легализации доходов, полученных преступным путем. Файловый обмен, выгрузка в ТФ из принятого файла ОЭС.
*/


Import BankInter,  FMInter, "fm_out_util", "globals.mac";
Import "dbf2ora.mac";
/*
 *    Настройки
 */

/* Код терр. учреждения по ОКАТО */
private var KTU : string;

/* Коды нашего банка */
private var BANK_INN : string;
private var REGN     : string;
private var NUMBF_S  : string;


/* Контактный телевон ответственного исполнителя */
private var TEL : string;

/* Эталонный файл выгрузки */
private var DIR_ORIG;

/*директории "ФИНМОНИТОРИНГ / DIR_OUT"*/
private var DIR_OUT;

/* макрос выгрузки */
private var OutFileName;
private var OutFileType;

/*
 * Определить тип транспортного файла,
 * в который необходимо выгрузить данную операцию
 */
private macro DefineFileType( OesFileName ) 

  return Int( SubStr( OesFileName, 5, 1 ) );

end;


/*
 * Сформировать название файла выгрузки
 * Возвращаемое значение: название файла
 */
private macro CreateOutFileName( Date_Seance, Seance, Repeat, OesFileName, TypeOperation )
  
  var day, mon, year, fname, ext;
  var OutFileName;

  var error;
  /* вид кода филиала */
  var BankID, DprtCodeParty, DprtCodeKind;

  OutFileType = DefineFileType( OesFileName );

  DateSplit( Date_Seance, day , mon, year );

  /* имя файла для КФМ*/  
  fname = SubStr( {MFO_Bank}, 5, 5 ) + string(OutFileType);
  if( day < 10 ) 
     fname = fname + "0" ;
  end;
  fname = fname + String(day);
  
  /* расширение */
  ext = "";
  if( Seance < 10 ) 
     ext =  "0";
  end;

  if (TypeOperation == FM_OPER_SEANCE_TYPE_LEGAL)
    ext = ext + Seance + "1" ; 
  else
    ext = ext + Seance + "3" ;
  end;

  /* формируем файл */
  OutFileName = MergeFile( FM_GetOutDir(), fname, ext );
  
  return OutFileName;

end;

private macro FindNumbPByID(Code4, ID, Date_P )
  file FileOes ( ) dbf;  
  var rs;
  var sqlString = "SELECT T_Name  FROM  DFM_FILEIMPORT_DBT WHERE SUBSTR(t_NAME, 1,  4) = '" + Code4 +"' ORDER BY T_DATEIMPORT DESC"; 
  var NameTF = "";
  var Numb_P = 0;

  var DIR_IMPWORK_Path, stat;
  GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_IMPWORK", V_STRING, DIR_IMPWORK_Path, stat);
  if( stat != 0 ) 
    MsgBox ("Ошибка чтения настройки ФИНМОНИТОРИНГ\\DIR_IMPWORK"); 
  end;

  if( SubStr( DIR_IMPWORK_Path, strlen( DIR_IMPWORK_Path )) != "\\" )
    DIR_IMPWORK_Path = DIR_IMPWORK_Path + "\\";
  end;
  
  rs = RsdRecordset( sqlString );

  while(rs.moveNext() AND (Numb_P ==0))
    NameTF = rs.value(0);

    if( open( FileOes, DIR_IMPWORK_Path + NameTF ))  // Если не открыли - за ошибку не считаем
      if(FldIndex ( FileOes, "ID" ) != -1)
        while( (next(FileOes)) AND (Numb_P == 0) )                     
          if(FileOes.ID == ID)
            Numb_P = FileOes.Numb_P;
            Date_P = FileOes.Date_P;
          end;
        end;         
      end;
      Close( FileOes );
    end;
  end;

  if(Numb_P > 0)
    SetParm(2, Date_P);
  end;

  return Numb_P;
end;



private macro FindLastNumbP(FCode4, FNumb_P, Date_P, Seance, FName)
  file FileOes ( ) dbf;  

  var rs;
  var sqlString = ""; 
  var NameTF = "";
  var Numb_P = 0;
  var FSeance = 0;

  if(FCode4 != "")
    sqlString = "SELECT T_Name, T_Seance  FROM  DFM_FILEIMPORT_DBT WHERE SUBSTR(t_NAME, 1,  4) = '" + FCode4 +"' ORDER BY T_DATEIMPORT DESC"; 
  else
    sqlString = "SELECT T_Name, T_Seance  FROM  DFM_FILEIMPORT_DBT ORDER BY T_DATEIMPORT DESC"; 
  end;

  var DIR_IMPWORK_Path, stat;
  GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_IMPWORK", V_STRING, DIR_IMPWORK_Path, stat);
  if( stat != 0 ) 
    MsgBox ("Ошибка чтения настройки ФИНМОНИТОРИНГ\\DIR_IMPWORK"); 
  end;

  if( SubStr( DIR_IMPWORK_Path, strlen( DIR_IMPWORK_Path )) != "\\" )
    DIR_IMPWORK_Path = DIR_IMPWORK_Path + "\\";
  end;
  
  rs = RsdRecordset( sqlString );

  while(rs.moveNext() AND (Numb_P ==0))
    NameTF = rs.value(0);
    FSeance = rs.value(1);

    if( open( FileOes, DIR_IMPWORK_Path + NameTF ))  // Если не открыли - за ошибку не считаем
      if(FldIndex ( FileOes, "NUMB_P" ) != -1)
        while( (next(FileOes)) AND (Numb_P == 0) )                     
          if(FileOes.NUMB_P == FNumb_P)
            Numb_P = FileOes.Numb_P;
            Date_P = FileOes.Date_P;
            Seance = FSeance;
            FName = NameTF;
          end;
        end;         
      end;
      Close( FileOes );
    end;
  end;

  if(Numb_P > 0)
    SetParm(2, Date_P);
    SetParm(3, Seance);
    SetParm(4, FName);
    
  end;

  return int(Numb_P);
end;



/* Макрофункция вызывается в начале выгрузки
 *
 *   Возвращаемые значения:
 *      0 - продолжить выгрузку
 *  not 0 - остановить выгрузку
 *
 */
private macro OutStart()
 
  /* определим код территориального учреждения по ОКАТО */
  KTU = FM_GetKTU();
  if( Trim(KTU) == "" )
    msgbox( "Не определен код территории учреждения по ОКАТО" );
    return 1;
  end;
  
  BANK_INN = GetCodeParty( {OurBank}, PTCK_INN );

  ПолучитьНомерРегистрацииБанка( @REGN, @NUMBF_S );

  return 0;

end;


/* Макрофункция вызывается по завершении выгрузки
 *
 *   Возвращаемое значение не анализируется
 *
 */
private macro OutFinish()
end;



/*
 *  2. Выгрузка в транспортный файл 
 *
 *   Параметры:
 *      Date_Seance : date     - дата выгрузки
 *      Seance      : integer  - номер сеанса выгрузки
 *      First       : bool     - флаг выгрузки первой записи
 *      Repeat      : bool     - признак выгрузки в случае ошбики структурного контроля первичного файла
 *
 *   Перед вызовом макрофункции заполняются структуры:
 *      OpContr       - запись об операции, подлежащей контролю
 *
 *   Возвращаемые значения:
 *      
 *      0    - запись успешно обработана
 *      1    - операция должна быть выгружена другим сеансом
 *      2    - прерывание выполнения
 *
 */
private macro OutTFfromFileOES_LG( Date_Seance, Seance, First, Repeat, OesFileName )   

   file f1 ( "fz115.dbf" ) dbf;
   file f2 ( "fz115.dbf" ) dbf write;

   file FileOes ( ) dbf write;
   file filesr  ( ) dbf;

   var SelRecFileName = "fm_sel.dbf";

   var DIR_IMPWORK_Path, stat;
   GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_IMPWORK", V_STRING, DIR_IMPWORK_Path, stat);
   if( stat != 0 ) 
     MsgBox ("Ошибка чтения настройки ФИНМОНИТОРИНГ\\DIR_IMPWORK"); 
   end;
   
   
   if( SubStr( DIR_IMPWORK_Path, strlen( DIR_IMPWORK_Path )) != "\\" )
     DIR_IMPWORK_Path = DIR_IMPWORK_Path + "\\";
   end;
   
  
   if( not open( FileOes, DIR_IMPWORK_Path + OesFileName ))
     msgbox("настройка реестра ФИНМОНИТОРИНГ\\DIR_IMPWORK задана неверно,|| или файл ОЭС не может быть открыт!!!"); 
     return 2;
   end;


   var RegNumber;

   var day, mon, i;   

   if( not Open( f1, DIR_ORIG ) )
     MsgBox( "Невозможно открыть эталонный файл " + DIR_ORIG + ", заданный в настройках подсистемы" );
     return 2;
   end;

   
   if( First ) /* если выгрузка первой записи - создаем файл */
     
     OutFileName = CreateOutFileName( Date_Seance, Seance, Repeat, OesFileName, FM_OPER_SEANCE_TYPE_LEGAL);

     if( not clone( f1, OutFileName ) )
       MsgBox( "Невозможно создать файл выгрузки " + OutFileName );
       return 2;
     end;
   else
     if( OutFileType != DefineFileType( Repeat ) )
       return 1;
     end;
   end;

   if( not open( f2, OutFileName ) )
     MsgBox( "Невозможно открыть файл выгрузки " + OutFileName );
     return 2;
   end;   
   
  private macro IsRecInsert()

    var nrecs;
   
    if( Not ExistFile (DIR_IMPWORK_Path + SelRecFileName) )
      return true;
    else
      if( Open( filesr, DIR_IMPWORK_Path + SelRecFileName ) )      
        nrecs = NRecords( filesr );            
        if( nrecs == 0 )
          return true;
        else
          while( next(filesr) )                     
            if( (FileOES.action == filesr.ACTION ) 
                AND (FileOES.numb_p == filesr.NUMB_P ) 
                AND (FileOES.date_p == filesr.DATE_P ) )
              Close( filesr );
              return false;                           
            end;
          end;         
        end;            
      end;
    end;   

    Close( filesr );
    return true;
  end;

 
 while( next(FileOES) )
   if( IsRecInsert() == true )
   ClearRecord( f2 );

   Copy(f2, FileOES);

   /* некоторые поля при выгрузке необходимо переопределить */
   f2.REGN       = REGN;  
   f2.NUMBF_S    = NUMBF_S;    
   f2.KTU_S      = KTU;    
   f2.BIK_S      = {MFO_Bank};   
   f2.ND_KO      = BANK_INN;
   
   f2.BRANCH   = 1;
   f2.KTU_SS   = FileOES.KTU_S;
   f2.BIK_SS   = FileOES.BIK_S;    
   f2.NUMBF_SS = FileOES.NUMBF_S;

   var err = 0;
   if(f2.NUMB_P == 0)
     if(f2.Action == 1)
       var SeqVal = 0;
       GetSequenceValue(246, SeqVal);
       f2.NUMB_P = FileOES.NUMB_P = SeqVal;
       Update( FileOES );
     else
       var DATE_P;
       var code4 = substr(OesFileName,1,4);
       f2.NUMB_P = FindNumbPByID(code4, FileOES.ID, @DATE_P);
       if(f2.NUMB_P == 0)
         //MsgBox( "Не найден файл ОЭС, содержащий первично отправленное сообщение для заполнения полей NUMB_P и DATE_P" ); // !!! ADD REPORT
         FileOES.ERRMSG = "Не найден файл ОЭС, содержащий первично отправленное сообщение для заполнения полей NUMB_P и DATE_P";
         err = 1;
       else
         FileOES.NUMB_P = f2.NUMB_P;
         FileOES.DATE_P = f2.DATE_P = DATE_P;
         FileOES.ERRMSG = "0";
       end;
       Update( FileOES );
     end;
   end;

   /* Подкорректируем некоторые поля */
   DateSplit( {curdate}, day, mon);
   i = 0;
   while ( i < FldNumber(f2) )

      if ( ( ValType ( f2(i) ) == V_STRING ) and ( ( Trim( f2(i) ) == "" ) or (Trim( f2(i) ) == ",") ) )
         f2(i) = "0" ;
      elif ( ( ValType ( f2(i) ) == V_DATE ) and ( f2(i) == Date(0,0,0) ) )
         f2(i) = Date( 1, 1, 2099) ;
      end;

      i = i + 1;

   end;

   if(err == 0)
     if ( not Insert( f2 ) )
        MsgBox( "Ошибка вставки записи в транспортный файл" );
        return 2;
     end;
   end;
   end;
 end;

 Close(FileOES);
   return 0; /* Запись успешно выгружена */

end;


private macro OutTFfromFileOES_REJ( Date_Seance, Seance, First, Repeat, OesFileName )   

   file f1 ( "fz115rej.dbf" ) dbf;
   file f2 ( "fz115rej.dbf" ) dbf write;

   file FileOes ( ) dbf write;
   file filesr  ( ) dbf;

   var SelRecFileName = "fm_sel.dbf";

   var DIR_IMPWORK_Path, stat;
   GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_IMPWORK", V_STRING, DIR_IMPWORK_Path, stat);
   if( stat != 0 ) 
     MsgBox ("Ошибка чтения настройки ФИНМОНИТОРИНГ\\DIR_IMPWORK"); 
   end;
   
   
   if( SubStr( DIR_IMPWORK_Path, strlen( DIR_IMPWORK_Path )) != "\\" )
     DIR_IMPWORK_Path = DIR_IMPWORK_Path + "\\";
   end;
   
  
   if( not open( FileOes, DIR_IMPWORK_Path + OesFileName ))
     msgbox("настройка реестра ФИНМОНИТОРИНГ\\DIR_IMPWORK задана неверно,|| или файл ОЭС не может быть открыт!!!"); 
     return 2;
   end;


   var RegNumber;

   var day, mon, i;   

   if( not Open( f1, DIR_ORIG ) )
     MsgBox( "Невозможно открыть эталонный файл " + DIR_ORIG + ", заданный в настройках подсистемы" );
     return 2;
   end;

   
   if( First ) /* если выгрузка первой записи - создаем файл */
     
     OutFileName = CreateOutFileName( Date_Seance, Seance, Repeat, OesFileName, FM_OPER_SEANCE_TYPE_REJ_ACC_OPR );

     if( not clone( f1, OutFileName ) )
       MsgBox( "Невозможно создать файл выгрузки " + OutFileName );
       return 2;
     end;
   else
     if( OutFileType != DefineFileType( Repeat ) )
       return 1;
     end;
   end;

   if( not open( f2, OutFileName ) )
     MsgBox( "Невозможно открыть файл выгрузки " + OutFileName );
     return 2;
   end;   
   
  private macro IsRecInsert()

    var nrecs;
   
    if( Not ExistFile (DIR_IMPWORK_Path + SelRecFileName) )
      return true;
    else
      if( Open( filesr, DIR_IMPWORK_Path + SelRecFileName ) )      
        nrecs = NRecords( filesr );            
        if( nrecs == 0 )
          return true;
        else
          while( next(filesr) )                     
            if( (FileOES.action == filesr.ACTION ) 
                AND (FileOES.numb_p == filesr.NUMB_P ) 
                AND (FileOES.date_p == filesr.DATE_P ) )
              Close( filesr );
              return false;                           
            end;
          end;         
        end;            
      end;
    end;   

    Close( filesr );
    return true;
  end;

 
 while( next(FileOES) )
   if( IsRecInsert() == true )
   ClearRecord( f2 );

   Copy(f2, FileOES);

   /* некоторые поля при выгрузке необходимо переопределить */
   f2.REGN       = REGN;  
   f2.NUMBF_S    = NUMBF_S;    
   f2.KTU_S      = KTU;    
   f2.BIK_S      = {MFO_Bank};   
//   f2.ND_KO      = BANK_INN;
   
   f2.BRANCH   = 1;
   f2.KTU_SS   = FileOES.KTU_S;
   f2.BIK_SS   = FileOES.BIK_S;    
   f2.NUMBF_SS = FileOES.NUMBF_S;

   var err = 0;
   if(f2.NUMB_P == 0)
     if(f2.Action == 1)
       var SeqVal = 0;
       GetSequenceValue(247, SeqVal);
       f2.NUMB_P = FileOES.NUMB_P = SeqVal;
       Update( FileOES );
     else
       var code4 = substr(OesFileName,1,4);
       f2.NUMB_P = FindNumbPByID(code4, FileOES.ID );
       if(f2.NUMB_P == 0)
//         MsgBox( "Не найден файл ОЭС, содержащий первично отправленное сообщение для заполнения полей NUMB_P и DATE_P" ); // !!! ADD REPORT
         FileOES.ERRMSG = "Не найден файл ОЭС, содержащий первично отправленное сообщение для заполнения полей NUMB_P и DATE_P";
         err = 1;
       else
         FileOES.NUMB_P = f2.NUMB_P;
         FileOES.ERRMSG = "0";
       end;

       Update( FileOES );
     end;
   end;


   /* Подкорректируем некоторые поля */
   DateSplit( {curdate}, day, mon);
   i = 0;
   while ( i < FldNumber(f2) )

      if ( ( ValType ( f2(i) ) == V_STRING ) and ( ( Trim( f2(i) ) == "" ) or (Trim( f2(i) ) == ",") ) )
         f2(i) = "0" ;
      elif ( ( ValType ( f2(i) ) == V_DATE ) and ( f2(i) == Date(0,0,0) ) )
         f2(i) = Date( 1, 1, 2099) ;
      end;

      i = i + 1;

   end;

   if(err == 0)
     if ( not Insert( f2 ) )
        MsgBox( "Ошибка вставки записи в транспортный файл" );
        return 2;
     end;
   end;
   end;
 end;

 Close(FileOES);
   
   return 0; /* Запись успешно выгружена */

end;

private macro OutTFfromFileOES( Date_Seance, Seance, First, Repeat, OesFileName, TypeOperation )   
  var stat = 0;
  /* определим название файла-эталона */
  if(TypeOperation == FM_OPER_SEANCE_TYPE_LEGAL)
    DIR_ORIG = FM_GetDirOrigUnloadFile();
  else
    GetRegistryValue( "ФИНМОНИТОРИНГ\\DIR_ORIG_UNLOAD_ROA_FILE", V_STRING, DIR_ORIG, stat );
  end;
   
  if( Trim(DIR_ORIG) == "" )
    msgbox( "В настройках подсистемы не задан эталонный файл выгрузки" );
    return 1;
  end;

  if(TypeOperation == FM_OPER_SEANCE_TYPE_LEGAL) 
    return OutTFfromFileOES_LG( Date_Seance, Seance, First, Repeat, OesFileName )   
  else
    return OutTFfromFileOES_REJ( Date_Seance, Seance, First, Repeat, OesFileName )   
  end;
end;


private macro FM_ImpFileToOra( ImportFileDir, ImportFileName )

  var err;

  if( not dbf2ora(ImportFileDir + "\\" + ImportFileName, "dfm_fileimport_tmp", "Загрузка файла " + ImportFileName + " в БД",err, 1))
    msgbox(err);
    exit;
  end;

end;



