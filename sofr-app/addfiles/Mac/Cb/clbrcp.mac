/* Макрос отправки подтверждений в Клиент Банка */

import iborwp,rsd;

/* Признак отправлять подтверждения сразу, минуя помещене в список подготовки */
private const  sendImmediately = true;
private record oprrcpst(oprrcpst);

/* Макропроцедура отправки подтверждения в Клиент Банка по идентификатору в АБС */
MACRO clbMakeReceipt(cID:string, oprrcpst_buff) : bool
  setbuff(oprrcpst, oprrcpst_buff);
  var sqlString, rst, ReceiptIniIsNULL, ReceiptIni; 

  /* cID - строковый идентификатор документа в АБС, для которого необходимо отправить подтверждение с параметрами oprrcpst */

 sqlString = " SELECT T_RECEIPTINI " +
              " FROM DDP_DEP_DBT "+
              " WHERE T_CODE = " + oprrcpst.Department;


  rst = RsdRecordset( sqlString );
  rst.moveNext();
  rst.value("T_RECEIPTINI" , ReceiptIniIsNULL);

  if( ReceiptIniIsNULL != true )
    ReceiptIni = rst.value("T_RECEIPTINI" );
  else
    ReceiptIni = NULL;
  end;


  var result = clbMakeReceiptByABSId(cID, sendImmediately, oprrcpst.ReceiptType, oprrcpst.ShortDesc, oprrcpst.Desc, ReceiptIni);
  /* Если вернулось false, то значит в БОУРМ нет документа с таким идентификатором, поэтому за ошибку не считаем */

  return true;

onError (er)
   var count, i;
   var strError;
   strError = "Ошибка отправки подтверждения.";
   if (IsEqClass ("TRsComErr", er.err))
      count = er.err.Count;
      i = 0;
      while (i < count)
         strError = strError + "\n "+ er.err.Message (i) + " (Code = " + er.err.Code (i) +
                  ", Level = " + er.err.Level (i) + ")" ;
         i = i + 1
      end
   end;

   MsgBox(strError);

   return false;
END;
