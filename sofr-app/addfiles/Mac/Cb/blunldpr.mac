/*
$Name:        blunldpr.mac
$Module:      Бухгалтерия банка 
$Description: Протокол Процедуры выгрузки данных по НДС для декларации
*/

import BankInter, globals, oralib, rsd, BilFacturaInter, likepy, PTInter, FIInter;

record bilfunloadparam("bilfunloadparam.rec");

private const _DocKind_Buy     = 1; /*"Книга покупок"*/
private const _DocKind_BuyAdd  = 2; /*"Дополнительные листы книги покупок"*/
private const _DocKind_Sale    = 3; /*"Книга продаж"*/
private const _DocKind_SaleAdd = 4; /*"Дополнительные листы книги продаж"*/
private const _DocKind_DstBF   = 5; /*"Журнал учета выставленных СФ посредника"*/
private const _DocKind_ObtBF   = 6; /*"Журнал учета полученных СФ посредника"*/
private const _DocKind_BF173   = 7; /*"СФ, выставленные лицами из п. 5 ст. 173 НКРФ"*/

private var __СумНДСВсКПк       ;
private var __СуммаВсехСумНДСВыч;
private var __СтПродБезНДС18    ;
private var __СтПродБезНДС10    ;
private var __СтПродБезНДС0     ;
private var __СумНДСВсКПр18     ;
private var __СумНДСВсКПр10     ;
private var __СтПродОсвВсКПр    ;
private var __ИтСтПродКПр18     ;
private var __ИтСтПродКПр10     ;
private var __ИтСтПродКПр0      ;
private var __СумНДСИтКПр18     ;
private var __СумНДСИтКПр10     ;
private var __ИтСтПродОсвКПр    ;
private var __СумНДСИтКПк       ;
private var __СумНДС            ;
private var __СумНДСИтП1Р8      ;

private macro _GetDepartmentName(DprtID) : string
  var sqlString : string;
  var rs : RsdRecordset;

  if(DprtID > 0)
    sqlString = "SELECT t_Name " +
                "FROM ddp_dep_dbt " +
                "WHERE t_Code = " + DprtID;
    rs = RsdRecordset( sqlString );
    if( rs.moveNext())
      return rs.value( 0 );
    end;
  else
    return "Все";
  end;

  return "";
end;

private macro _GetFileSIDRowsQuantity(DocKind, FileSID : @string, Quantity : @integer, CheckVal : @string)
  var sqlStr = "";
  var params : TArray;
  var rs;

  FileSID = "";
  Quantity = 0;
  CheckVal = "";

  sqlStr = sqlStr + "SELECT t_FileSID, t_Quantity, t_CheckVal FROM dbfunloadlog_tmp ";
  sqlStr = sqlStr + "WHERE t_DocKind = :DocKind                         ";

  params = makeArray(SQLParam("DocKind", DocKind)
                    );

  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    FileSID = rs.value(0);
    Quantity = rs.value(1);
    CheckVal = rs.value(2);
  end;
end;

private macro _PrintBadRecs(DocKind)
  var sqlStr = "";
  var params : TArray;
  var rs;

  var Number;
  var RegDate;
  var BadAttrDesc;
  array _BadAttrDesc;
  var j;
  var i = 0;

  sqlStr = sqlStr + "SELECT t_Number, t_RegDate, t_BadAttrDesc FROM dbfunloadbadrec_tmp ";
  sqlStr = sqlStr + "WHERE t_DocKind = :DocKind ORDER BY t_RegDate                      ";

  params = makeArray(SQLParam("DocKind", DocKind)
                    );

  rs = execSQLselect(sqlStr, params, true);
  while(rs and rs.moveNext())

    if(i == 0)
[В следующих записях отсутствуют обязательные реквизиты:];
[+-----------------------------------+----------------+--------------------------------------------------------+];
[|              Номер                |Дата регистрации|               Отсутствующий реквизит                   |];
[+-----------------------------------+----------------+--------------------------------------------------------+];
    end;

    Number = rs.value(0);
    RegDate = rs.value(1);
    BadAttrDesc = rs.value(2);

    j = 0;
    StrSplit(BadAttrDesc, _BadAttrDesc, 56, 56, 10 );
    while(StrLen(_BadAttrDesc(j)) > 0)
      if(j == 0)

[|###################################|   ##########   |########################################################|] (Number, date(RegDate):f, _BadAttrDesc(j));
      else
[|                                   |                |########################################################|] (_BadAttrDesc(j));
      end;
      j = j + 1;
    end;
    
    i = i + 1;
  end;
  if(i > 0)
[+-----------------------------------+----------------+--------------------------------------------------------+];
  end;
end;


private macro _PrintProtocol()
  var FileSID;
  var Quantity;
  var CheckVal;

[Протокол Процедуры выгрузки данных по НДС для декларации

];
[Дата, время:  ########## ########                                                 ] (date:f, time:f);                
[Пользователь: ##### #                                                             ] ({oper}, {Name_Oper});   
[
Период формирования: ########## - ##########] (bilfunloadparam.DateFrom:f, bilfunloadparam.DateTo:f);
[Филиал: #] (_GetDepartmentName(bilfunloadparam.DprtID));
  
  if(bilfunloadparam.LoadBuyBBE == "X")
[
Раздел 8. Данные книги покупок
];
    _GetFileSIDRowsQuantity(_DocKind_Buy, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла #
успешно завершена.
В файл включено ######## записей книги покупок.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_Buy);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют записи книги покупок.
];
    end;
  end;
  
  if(bilfunloadparam.LoadBuyAddBBE == "X")
[
Приложение 1 к разделу 8. Данные дополнительных листов книги покупок
];
    _GetFileSIDRowsQuantity(_DocKind_BuyAdd, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла # 
успешно завершена.
В файл включено ######## записей дополнительных листов книги покупок.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_BuyAdd);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют записи дополнительных листов книги покупок.
];
    end;
  end;
  
  if(bilfunloadparam.LoadSaleBBE == "X")
[
Раздел 9. Данные книги продаж
];
    _GetFileSIDRowsQuantity(_DocKind_Sale, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла # 
успешно завершена.
В файл включено ######## записей книги продаж.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_Sale);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют записи книги продаж.
];
    end;
  end;
  
  if(bilfunloadparam.LoadSaleAddBBE == "X")
[
Приложение 1 к разделу 9. Данные дополнительных листов книги продаж
];
    _GetFileSIDRowsQuantity(_DocKind_SaleAdd, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла # 
успешно завершена.
В файл включено ######## записей дополнительных листов книги продаж.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_SaleAdd);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют записи дополнительных листов книги продаж.
];
    end;
  end;
  
  if(bilfunloadparam.DstBFLoadType > 0)
[
Раздел 10. Данные журнала выставленных СФ
];
    _GetFileSIDRowsQuantity(_DocKind_DstBF, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла # 
успешно завершена.
В файл включено ######## СФ журнала выставленных СФ.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_DstBF);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют СФ, вошедшие в журнал выставленных СФ.
];
    end;
  end;
  
  if(bilfunloadparam.ObtBFLoadType > 0)
[
Раздел 11. Данные журнала полученных СФ
];
    _GetFileSIDRowsQuantity(_DocKind_ObtBF, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла # 
успешно завершена.
В файл включено ######## СФ журнала полученных СФ.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_ObtBF);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют СФ, вошедшие в журнал полученных СФ.
];
    end;
  end;
  
  if(bilfunloadparam.BF173LoadType > 0)
[
Раздел 12. Данные по СФ, выставленным лицами, указанными в п.5 ст.173 НКРФ
];
    _GetFileSIDRowsQuantity(_DocKind_BF173, @FileSID, @Quantity, @CheckVal);
    if((FileSID != "") and (CheckVal == "") and (Quantity != 0))
[Процедура формирования файла # 
успешно завершена.
В файл включено ######## СФ.
] (FileSID + ".xml", Quantity);
_PrintBadRecs(_DocKind_BF173);
    elif(CheckVal != "")
[Файл не сформирован. Не выполняется контрольное соотношение: #
] ("\"" + CheckVal + "\"");
    else
[В заданном периоде отсутствуют СФ, выставленные лицами, указанными в п.5 ст.173 НКРФ.
];
    end;
  end;

end;

/* Очистить таблицу */
private macro _TruncTable(tableName) : bool
  return execSQL( string( "TRUNCATE TABLE ", tableName, ";" ) );
end;

private macro _AddRowsToBilBEUnload_1_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_RegDate BETWEEN :BeginDate AND :EndDate " + /*!!BeginDate!!*/ /*!!EndDate!!*/
              "      AND bilbookentry.t_BookID = :BookID" + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilbookentry.t_AnnulEntry = 0 " +
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_Assignment <> :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_1_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_RegDate BETWEEN :BeginDate AND :EndDate " + /*!!BeginDate!!*/ /*!!EndDate!!*/
              "      AND bilbookentry.t_BookID = :BookID" + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilbookentry.t_AnnulEntry = 0 " +
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_Assignment <> :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_2_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_RegDate BETWEEN :BeginDate AND :EndDate " + /*!!BeginDate!!*/ /*!!EndDate!!*/
              "      AND bilbookentry.t_BookID = :BookID" + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilbookentry.t_AnnulEntry <> 0 " +
              "      AND bilbookentry.t_AnnulDate < :AnnulDate " +
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_Assignment <> :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("AnnulDate", EndDate);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_2_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_RegDate BETWEEN :BeginDate AND :EndDate " + /*!!BeginDate!!*/ /*!!EndDate!!*/
              "      AND bilbookentry.t_BookID = :BookID" + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilbookentry.t_AnnulEntry <> 0 " +
              "      AND bilbookentry.t_AnnulDate < :AnnulDate " +
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_Assignment <> :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("AnnulDate", EndDate);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_3_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_RegDate BETWEEN :BeginDate AND :EndDate " + /*!!BeginDate!!*/ /*!!EndDate!!*/
              "      AND bilbookentry.t_BookID = :BookID" + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilbookentry.t_AnnulEntry = 0 " +
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_Assignment = :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND bilfactura.t_RegDate BETWEEN :BeginDate2 AND :EndDate2 " +
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);
  i = params.size;
  params[i] = SQLParam("BeginDate2", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate2", EndDate);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_3_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              "  ,(SELECT bilfactura.t_FacturaID AS t_FacturaID, bilfactura.t_TotalWithNDS AS t_TotalWithNDS " +
              "      FROM dbilbookentry_dbt bilbookentry, dbilfactura_dbt bilfactura " +
                     acssql_from + 
              "     WHERE bilbookentry.t_RegDate BETWEEN :BeginDate1 AND :EndDate1 " +
              "       AND bilbookentry.t_BookID = :BookID1 " +
              "       AND bilbookentry.t_Direction = :Direction1 " +
              "       AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID " +
              "       AND bilfactura.t_RegDate BETWEEN :BeginDate3 AND :EndDate3 " +
              "       AND " + 
                    acssql_where ;
  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate1", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate1", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID1", BookID);
  i = params.size;
  params[i] = SQLParam("Direction1", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate3", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate3", EndDate);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID1 "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID1", DprtID);
  end;

  sqlString = sqlString + 
              "   ) srcf " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_BookID = :BookID2 " + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction2 " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilfactura.t_Assignment = :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = srcf.t_FacturaID " +
              "      AND bilfactura.t_TotalWithNDS > 0 " +
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("BookID2", BookID);
  i = params.size;
  params[i] = SQLParam("Direction2", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID2 "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID2", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_4_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction)
  var sqlString;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              "  ,(SELECT bilfactura.t_FacturaID AS t_FacturaID, bilfactura.t_TotalWithNDS AS t_TotalWithNDS " +
              "      FROM dbilbookentry_dbt bilbookentry, dbilfactura_dbt bilfactura " +
                     acssql_from + 
              "     WHERE bilbookentry.t_RegDate BETWEEN :BeginDate1 AND :EndDate1 " +
              "       AND bilbookentry.t_BookID = :BookID1 " +
              "       AND bilbookentry.t_Direction = :Direction1 " +
              "       AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID " +
              "       AND " + 
                    acssql_where ;

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate1", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate1", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID1", BookID);
  i = params.size;
  params[i] = SQLParam("Direction1", Direction);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID1 "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID1", DprtID);
  end;

  sqlString = sqlString + 
              "   ) srcf " +
              acssql_from +                                     
              " WHERE " +
              "          bilbookentry.t_BookID = :BookID2 " + /*BookID +*/ /*!!BookID!!*/
              "      AND bilbookentry.t_Direction = :Direction2 " + /*Direction +*/ /*!!Direction!!*/
              "      AND bilfactura.t_Assignment = :Assignment " + /*OBJSFASSIGNMENT_RECALC +*/ /*Пересчет*/ /*!!Assignment!!*/
              "      AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID " +
              "      AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+) " +
              "      AND bilfactura.t_SourceFacturaID = srcf.t_FacturaID " +
              "      AND bilfactura.t_TotalWithNDS <= 0 " +
              "      AND bilfactura.t_RegDate BETWEEN :BeginDate2 AND :EndDate2 " +
              "      AND " + 
              acssql_where;

  i = params.size;
  params[i] = SQLParam("BookID2", BookID);
  i = params.size;
  params[i] = SQLParam("Direction2", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);
  i = params.size;
  params[i] = SQLParam("BeginDate2", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate2", EndDate);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID2 "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID2", DprtID);
  end;

  return execSQL(sqlString, params);

end;

/*5.2.1 Функция получения списка ЗК основной книги покупок*/
private macro _FillBilBEUnload_Buy(BookID, DateFrom, DateTo, DprtID)
  var acssql_where : string;
  var acssql_from : string; 

  if(GetObjectRestriction(acssql_where, 111, {oper}, "bilbookentry", CNTX_BilBookEntry, "bilbookentry.dbt", acssql_from, true))
    if(acssql_from != "")
      acssql_from = " , " + acssql_from + " ";
    end;

    _AddRowsToBilBEUnload_1_Buy(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 2);
    _AddRowsToBilBEUnload_2_Buy(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 2);
    _AddRowsToBilBEUnload_3_Buy(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 2);
  end;
end;

/*5.2.9 Функция получения списка ЗК основной книги продаж*/
private macro _FillBilBEUnload_Sale(BookID, DateFrom, DateTo, DprtID)
  var acssql_where : string;
  var acssql_from : string; 

  if(GetObjectRestriction(acssql_where, 111, {oper}, "bilbookentry", CNTX_BilBookEntry, "bilbookentry.dbt", acssql_from, true))
    if(acssql_from != "")
      acssql_from = " , " + acssql_from + " ";
    end;

    _AddRowsToBilBEUnload_1_Sale(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 1);
    _AddRowsToBilBEUnload_2_Sale(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 1);
    _AddRowsToBilBEUnload_3_Sale(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 1);
    _AddRowsToBilBEUnload_4_Sale(acssql_from, acssql_where, BookID, DateFrom, DateTo, DprtID, 1);
  end;
end;

/*5.2.2 Функция заполнения сумм ЗК в разрезе ставок НДС*/
private macro _FillBilBEUnloadAmounts(IsAddBook)
  var sqlString;
  var params = TArray;

  sqlString = "UPDATE dbilbeunload_tmp tmp " + 
              "   SET " + 
              "     tmp.t_Amount0 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_Amount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 0 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_Free = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_Amount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = -1 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_Amount10 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_Amount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 10 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_NDSAmount10 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_NDSAmount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 10 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_Amount18 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_Amount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 18 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_NDSAmount18 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_NDSAmount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 18 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_Amount20 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_Amount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 20 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              "    ,tmp.t_NDSAmount20 = " + 
              "       ( " + 
              "        SELECT SUM(bes.t_NDSAmount) " + 
              "          FROM dbkentsum_dbt bes " + 
              "         WHERE bes.t_BookEntryID = tmp.t_BookEntryID " + 
              "           AND bes.t_NDSRate = 20 " + 
              "           AND bes.t_FIID = 0 " + 
              "       ) " +
              " WHERE tmp.t_Assignment <> " + OBJSFASSIGNMENT_PREPAYMENT +
              " ";
  
  execSQL(sqlString, params);

  sqlString = "UPDATE dbilbeunload_tmp tmp " + 
              "   SET " + 
              "     tmp.t_Amount0 = 0 " + 
              "    ,tmp.t_Amount10 = 0 " + 
              "    ,tmp.t_NDSAmount10 = 0 " + 
              "    ,tmp.t_Amount18 = 0 " + 
              "    ,tmp.t_NDSAmount18 = 0 " + 
              "    ,tmp.t_Amount20 = 0 " + 
              "    ,tmp.t_NDSAmount20 = 0 " + 
              " WHERE tmp.t_Assignment = " + OBJSFASSIGNMENT_PREPAYMENT +
              " ";
  
  execSQL(sqlString, params);

  if(not IsAddBook)
    sqlString = "UPDATE dbilbeunload_tmp tmp " + 
                "   SET " + 
                "     tmp.t_Amount0 = -tmp.t_Amount0 " + 
                "    ,tmp.t_Amount10 = -tmp.t_Amount10 " + 
                "    ,tmp.t_NDSAmount10 = -tmp.t_NDSAmount10 " + 
                "    ,tmp.t_Amount18 = -tmp.t_Amount18 " + 
                "    ,tmp.t_NDSAmount18 = -tmp.t_NDSAmount18 " + 
                "    ,tmp.t_Amount20 = -tmp.t_Amount20 " + 
                "    ,tmp.t_NDSAmount20 = -tmp.t_NDSAmount20 " + 
                "    ,tmp.t_TotalWithNDS = -tmp.t_TotalWithNDS " + 
                "    ,tmp.t_TotalWithNDSCurr = -tmp.t_TotalWithNDSCurr " + 
                " WHERE tmp.t_AnnulEntry <> 0 " +
                " ";
    
    execSQL(sqlString, params);
  end;

  sqlString = "UPDATE dbilbeunload_tmp tmp " + 
              "   SET " + 
              "     tmp.t_Amount0 = -tmp.t_Amount0 " + 
              "    ,tmp.t_Amount10 = -tmp.t_Amount10 " + 
              "    ,tmp.t_NDSAmount10 = -tmp.t_NDSAmount10 " + 
              "    ,tmp.t_Amount18 = -tmp.t_Amount18 " + 
              "    ,tmp.t_NDSAmount18 = -tmp.t_NDSAmount18 " + 
              "    ,tmp.t_Amount20 = -tmp.t_Amount20 " + 
              "    ,tmp.t_NDSAmount20 = -tmp.t_NDSAmount20 " + 
              "    ,tmp.t_TotalWithNDS = -tmp.t_TotalWithNDS " + 
              "    ,tmp.t_TotalWithNDSCurr = -tmp.t_TotalWithNDSCurr " + 
              " WHERE tmp.t_Assignment = " + OBJSFASSIGNMENT_RECALC + 
              "   AND tmp.t_FacturaDirection <> tmp.t_BookDirection " +
              " ";
  
  execSQL(sqlString, params);
end;

private macro _CountBilBEUnload()
  var sqlStr = "";
  var rs;
  var params : TArray;
  var Count;

  sqlStr = sqlStr + "SELECT COUNT(*)         ";
  sqlStr = sqlStr + "  FROM dbilbeunload_tmp ";

  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    Count = rs.value(0);
  end;
  return Count;
end;

private macro _CountBilSFUnload()
  var sqlStr = "";
  var rs;
  var params : TArray;
  var Count;

  sqlStr = sqlStr + "SELECT COUNT(*)         ";
  sqlStr = sqlStr + "  FROM dbilsfunload_tmp ";

  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    Count = rs.value(0);
  end;
  return Count;
end;

private macro _InsertBFUnloadLog(DocKind, FileSID, Quantity, CheckVal)
  var sqlStr = "";
  var params : TArray;

  sqlStr = sqlStr + "INSERT INTO dbfunloadlog_tmp                     ";
  sqlStr = sqlStr + "(t_DocKind, t_FileSID, t_Quantity, t_CheckVal)   ";
  sqlStr = sqlStr + "VALUES                                           ";
  sqlStr = sqlStr + "(:DocKind, :FileSID, :Quantity, :CheckVal)       ";

  params = makeArray(SQLParam("DocKind", DocKind)
                    ,SQLParam("FileSID", FileSID)
                    ,SQLParam("Quantity", Quantity)
                    ,SQLParam("CheckVal", CheckVal)
                    );

  return execSQL(sqlStr, params);
end;

private macro _InsertBFUnloadBadRec(DocKind : integer, Number : string, RegDate : date, BadAttrDesc : string)
  var sqlStr = "";
  var params : TArray;

  sqlStr = sqlStr + "INSERT INTO dbfunloadbadrec_tmp                   ";
  sqlStr = sqlStr + "(t_DocKind, t_Number, t_RegDate, t_BadAttrDesc)   ";
  sqlStr = sqlStr + "VALUES                                            ";
  sqlStr = sqlStr + "(:DocKind, :DocNumber, :RegDate, :BadAttrDesc)       ";

  params = makeArray(SQLParam("DocKind", DocKind)
                    ,SQLParam("DocNumber", Number)
                    ,SQLParam("RegDate", RegDate)
                    ,SQLParam("BadAttrDesc", BadAttrDesc)
                    );

  return execSQL(sqlStr, params);
end;

private macro _GetTaxInstitutionCode(PartyID)
  var sqlStr = "";
  var rs;
  var params : TArray;
  var Code = "";

  sqlStr = sqlStr + "SELECT t_Code                          ";
  sqlStr = sqlStr + "  FROM dpartcode_dbt                   ";
  sqlStr = sqlStr + " WHERE t_PartyID =                     ";
  sqlStr = sqlStr + "       (SELECT t1.t_TaxInstitution     ";
  sqlStr = sqlStr + "          FROM dparty_dbt t1           ";
  sqlStr = sqlStr + "         WHERE t1.t_PartyID = :PartyID ";
  sqlStr = sqlStr + "       )                               ";
  sqlStr = sqlStr + "   AND t_CodeKind = :CodeKind          ";

  params = makeArray(SQLParam("PartyID", PartyID)
                    ,SQLParam("CodeKind", PTCK_MNS)
                    );

  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    Code = rs.value(0);
  end;
  return Code;
end;

private macro _GetSeqNextVal()
  var sqlStr = "";
  var params : TArray;
  var rs;
  var NextVal;

  sqlStr = "SELECT BFEXMLFILE_SID_SEQ.NEXTVAL FROM DUAL";

  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    NextVal = int(rs.value(0));
  end;
  return NextVal;
end;

/*5.1   Функция формирования имени файла выгрузки*/
private macro _FormUnloadFileName(DocKind)
  var UnloadFileName;
  var TaxInstitutionCode;
  var OurBankINN;
  var YearMonDay;
  var SeqValue;

  if  (DocKind == _DocKind_Buy    )
    UnloadFileName = "NO_NDS.8";
  elif(DocKind == _DocKind_BuyAdd )
    UnloadFileName = "NO_NDS.81";
  elif(DocKind == _DocKind_Sale   )
    UnloadFileName = "NO_NDS.9";
  elif(DocKind == _DocKind_SaleAdd)
    UnloadFileName = "NO_NDS.91";
  elif(DocKind == _DocKind_DstBF  )
    UnloadFileName = "NO_NDS.10";
  elif(DocKind == _DocKind_ObtBF  )
    UnloadFileName = "NO_NDS.11";
  elif(DocKind == _DocKind_BF173  )
    UnloadFileName = "NO_NDS.12";
  end;

  TaxInstitutionCode = _GetTaxInstitutionCode({OurBank});

  OurBankINN = ПолучитьКодСубъекта({OurBank}, PTCK_INN);

  if(index(OurBankINN, "/") > 0)
    /*разрядный код вида "ИНН" "нашего" банка без знака "/"*/
    OurBankINN = substr(OurBankINN, 1, index(OurBankINN, "/") - 1) + substr(OurBankINN, index(OurBankINN, "/") + 1);
  end;

  YearMonDay = string(date():f);
  YearMonDay = substr(YearMonDay, 7, 4) + substr(YearMonDay, 4, 2) + substr(YearMonDay, 1, 2);

  SeqValue = _GetSeqNextVal();

  UnloadFileName = UnloadFileName + "_" + TaxInstitutionCode + "_" + TaxInstitutionCode + "_" + OurBankINN + "_" + YearMonDay + "_" + SeqValue;

  return UnloadFileName;
end;

private macro _PrintLnANSI(str)
  /*Чтобы работала ToANSI нужно установить в rsreq.ini FORCE_OEM_ANSI_CVT = Y*/
  println(ToANSI(str, true));
end;

macro _GetDBVersion()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT                                                                     ";
  query = query + "  TRIM(TO_CHAR(t_Ver, '0')) || '.' ||                                      ";
  query = query + "  TRIM(TO_CHAR(t_Rel, '00')) || '.' ||                                     ";
  query = query + "  TRIM(TO_CHAR(t_Build, '000')) || '.' ||                                  ";
  query = query + "  TRIM(TO_CHAR(t_Patch, '000')) || '.' ||                                  ";
  query = query + "  TRIM(TO_CHAR(t_Update, '00'))                                            ";
  query = query + "FROM dsetupdat_dbt                                                         ";
  query = query + "ORDER BY t_Ver DESC, t_Rel DESC, t_Build DESC, t_Patch DESC, t_Update DESC ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСВсКПк()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount10, 0)) + SUM(NVL(t_NDSAmount18, 0)) + SUM(NVL(t_NDSAmount20, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СуммаВсехСумНДСВыч()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT SUM(NVL(t_NDSAmount10, 0) + NVL(t_NDSAmount18, 0) + NVL(t_NDSAmount20, 0)) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _GetBFFacturaNumbersCreationDatesForFacturaID
(
  FacturaNumbers : @string
 ,CreationDates : @string
 ,FacturaID
)
  var query = "";
  var params : TArray;
  var rs;
  
  FacturaNumbers = "";
  CreationDates = "";

  query = query + "SELECT bilfactura.t_FacturaNumber, TO_CHAR(bilfactura.t_CreationDate, 'dd.mm.yyyy') ";
  query = query + "  FROM dbilfacturasource_dbt bfsrc, dbilfactura_dbt bilfactura ";
  query = query + " WHERE bfsrc.t_FacturaID = :FacturaID ";
  query = query + "   AND bilfactura.t_FacturaID = bfsrc.t_SourceFacturaID ";

  params = makeArray(SQLParam("FacturaID", FacturaID));
  rs = execSQLselect(query, params, true);
  while(rs and rs.moveNext())
    if(strlen(FacturaNumbers) > 0)
      FacturaNumbers = FacturaNumbers + ",";
    end;
    if(strlen(CreationDates) > 0)
      CreationDates = CreationDates + ",";
    end;

    FacturaNumbers = FacturaNumbers + rs.value(0);
    CreationDates = CreationDates + rs.value(1);
  end;
end;

/*5.2.7 Функция получения дат и номеров СФ*/
private macro _GetBFFacturaNumbersCreationDates
(
  FacturaNumbers : @string
 ,CreationDates : @string
 ,rs
)
  FacturaNumbers = "";
  CreationDates = "";

  if(rs.value("t_Assignment") == OBJSFASSIGNMENT_RECALC)

    _GetBFFacturaNumbersCreationDatesForFacturaID(@FacturaNumbers, @CreationDates, rs.value("t_FacturaID"));
    
  elif(rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY)
    if(rs.value("t_SrcAssignment") == OBJSFASSIGNMENT_RECALC)
      
      _GetBFFacturaNumbersCreationDatesForFacturaID(@FacturaNumbers, @CreationDates, rs.value("t_SrcFacturaID"));
      
    else
      FacturaNumbers = rs.value("t_SrcFacturaNumber");
      CreationDates = string(date(rs.value("t_SrcCreationDate")):f);
    end;
  else
    FacturaNumbers = rs.value("t_FacturaNumber");
    CreationDates = string(date(rs.value("t_CreationDate")):f);
  end;
end;

/*5.2.8 Функция получения номера и даты корректировочного СФ*/
private macro _GetBFFacturaNumberCreationDate_Correction
(
  FacturaNumber : @string
 ,CreationDate : @string
 ,CorrectionNum : @string
 ,CorrectionDate : @string
 ,rs
)
  FacturaNumber = "";
  CreationDate = "";
  CorrectionNum = "";
  CorrectionDate = "";

  if(rs.value("t_Assignment") == OBJSFASSIGNMENT_RECALC)

    FacturaNumber = rs.value("t_FacturaNumber");
    CreationDate = string(date(rs.value("t_CreationDate")):f);
    
  elif(rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY)
    if(rs.value("t_SrcAssignment") == OBJSFASSIGNMENT_RECALC)
      
      FacturaNumber = rs.value("t_SrcFacturaNumber");
      CreationDate = string(date(rs.value("t_SrcCreationDate")):f);
      CorrectionNum = rs.value("t_CorrectionNum");
      CorrectionDate = string(date(rs.value("t_SrcCreationDate")):f);

    end;
  end;
end;

/*5.2.4 Функция получения страны и номера таможенной декларации*/
private macro _GetBFCountryCodeGTDNumber
(
  CountryCode : @string
 ,GTDNumber : @string
 ,FacturaID
)
  CountryCode = "";
  GTDNumber = "";

  var query = "";
  var params : TArray;
  var rs;
  
  CountryCode = "";
  GTDNumber = "";

  query = query + "SELECT DISTINCT NVL(t_GTDNumber, CHR(1)), NVL(t_CodeNum3, CHR(1)), t_Country     ";
  query = query + "  FROM (SELECT bfl.t_GTDNumber, c.t_CodeNum3, UPPER (bfl.t_Country) AS t_Country ";
  query = query + "          FROM dbilfacturaline_dbt bfl, dcountry_dbt c                           ";
  query = query + "         WHERE     bfl.t_FacturaID = :FacturaID                                  ";
  query = query + "               AND UPPER (c.t_Name(+)) = UPPER (bfl.t_Country))                  ";
  query = query + " ORDER BY t_Country                                                              "; 

  params = makeArray(SQLParam("FacturaID", FacturaID));
  rs = execSQLselect(query, params, true);
  
  while(rs and rs.moveNext())
    if((strlen(GTDNumber) > 0) and (strlen(rs.value(0)) > 0))
      GTDNumber = GTDNumber + ",";
    end;
    if((strlen(CountryCode) > 0) and (strlen(rs.value(1)) > 0))
      CountryCode = CountryCode + ",";
    end;

    if(strlen(rs.value(0)) > 0)
      GTDNumber = GTDNumber + rs.value(0);
    end;
    if(strlen(rs.value(1)) > 0)
      CountryCode = CountryCode + rs.value(1);
    end;
  end;
end;

/*5.2.5 Функция получения кода вида операции*/
private macro _GetBilOprCodes(FacturaID)
  var Codes = "";
  var query = "";
  var params : TArray;
  var rs;
  
  query = query + "SELECT DISTINCT boc.t_Code                          ";
  query = query + "  FROM dbilfacturaline_dbt bfl, dbiloprcode_dbt boc ";
  query = query + " WHERE bfl.t_FacturaID = :FacturaID                 ";
  query = query + "   AND boc.t_ID = bfl.t_OprCodeID                   ";
  query = query + " ORDER BY boc.t_Code                                ";

  params = makeArray(SQLParam("FacturaID", FacturaID));
  rs = execSQLselect(query, params, true);
  
  while(rs and rs.moveNext())
    if(strlen(Codes) > 0)
      Codes = Codes + ",";
    end;

    Codes = Codes + rs.value(0);
  end;

  return Codes;
end;

/*5.2.6 Функция определения наименования и ИНН участника сделки по СФ*/
private macro _GetBilFAgentPtNameINN
(
  IsAgent
 ,FacturaID
 ,PtKind
 ,Name : @string
 ,INN : @string
)
  var query = "";
  var params : TArray;
  var rs;

  if((IsAgent == "X") and (FacturaID > 0))
    query = query + "SELECT t_Name, t_INN                      ";
    query = query + "  FROM dbilfagentpt_dbt                   ";
    query = query + " WHERE t_FacturaID = :FacturaID           ";
    query = query + "   AND t_PtKind = :PtKind                 ";
    
    params = makeArray(SQLParam("FacturaID", FacturaID), SQLParam("PtKind", PtKind));
    rs = execSQLselect(query, params, true);
    
    if(rs and rs.moveNext())
      Name = rs.value(0);
      INN = rs.value(1);
    end;
  end;
end;

private macro _BilBEUnloadIntoFileRecs_Buy(DocKind)
  var query = "";
  var rs;
  var rownum = 1;
  var FacturaNumbers;
  var CreationDates;
  var FacturaNumber;
  var CreationDate;
  var CorrectionNum;
  var CorrectionDate;
  var CountryCode;
  var GTDNumber;
  var PayNum = "";
  var PayDate;
  var SupplierName, SupplierINN;
  var sINN = "", sKPP = "";

  query = query + "SELECT ";
  query = query + "  t0.t_BookEntryID                                 /* 0*/ ";
  query = query + " ,t0.t_FacturaID                                   /* 1*/ ";
  query = query + " ,t0.t_SfTypeID                                    /* 2*/ ";
  query = query + " ,t0.t_Assignment                                  /* 3*/ ";
  query = query + " ,t0.t_FacturaNumber                               /* 4*/ ";
  query = query + " ,t0.t_CreationDate                                /* 5*/ ";
  query = query + " ,t0.t_CorrectionNum                               /* 6*/ ";
  query = query + " ,NVL(t0.t_TotalWithNDS, 0)     t_TotalWithNDS     /* 7*/ ";
  query = query + " ,t0.t_SrcFacturaID                                /* 8*/ ";
  query = query + " ,t0.t_SrcAssignment                               /* 9*/ ";
  query = query + " ,t0.t_SrcFacturaNumber                            /*10*/ ";
  query = query + " ,t0.t_SrcCreationDate                             /*11*/ ";
  query = query + " ,t0.t_SrcCorrectionNum                            /*12*/ ";
  query = query + " ,t0.t_FacturaDirection                            /*13*/ ";
  query = query + " ,t0.t_BookDirection                               /*14*/ ";
  query = query + " ,NVL(t0.t_Amount0, 0)          t_Amount0          /*15*/ ";
  query = query + " ,NVL(t0.t_Amount10, 0)         t_Amount10         /*16*/ ";
  query = query + " ,NVL(t0.t_NDSAmount10, 0)      t_NDSAmount10      /*17*/ ";
  query = query + " ,NVL(t0.t_Amount18, 0)         t_Amount18         /*18*/ ";
  query = query + " ,NVL(t0.t_NDSAmount18, 0)      t_NDSAmount18      /*19*/ ";
  query = query + " ,NVL(t0.t_Amount20, 0)         t_Amount20         /*20*/ ";
  query = query + " ,NVL(t0.t_NDSAmount20, 0)      t_NDSAmount20      /*21*/ ";
  query = query + " ,NVL(t0.t_Free, 0)             t_Free             /*22*/ ";
  query = query + " ,NVL(t0.t_TotalWithNDSCurr, 0) t_TotalWithNDSCurr /*23*/ ";
  query = query + " ,t0.t_AnnulEntry                                  /*24*/ ";
  query = query + " ,bilbookentry.t_FIID                                       /*25*/ ";
  query = query + " ,bilbookentry.t_EntryDate                                  /*26*/ ";
  query = query + " ,bilbookentry.t_SupplierName                               /*27*/ ";
  query = query + " ,bilbookentry.t_SupplierINN                                /*28*/ ";
  query = query + " ,bilbookentry.t_IsSupplierAgent                            /*29*/ ";
  query = query + " ,bilbookentry.t_FacturaID               bbe_t_FacturaID    /*30*/ ";
  query = query + " ,bilbookentry.t_EntryNumber                                /*31*/ ";
  query = query + " ,bilbookentry.t_RegDate                                    /*32*/ ";
  query = query + "  FROM dbilbeunload_tmp t0, dbilbookentry_dbt bilbookentry         ";
  query = query + " WHERE bilbookentry.t_BookEntryID = t0.t_BookEntryID               ";
  query = query + "   AND t0.t_BookEntryID <> 0                              "; /*это условие нужно для режима BuyAdd, а в режиме Buy такой записи в таблице нет*/
  query = query + " ORDER BY bilbookentry.t_RegDate                                   ";

  rs = execSQLselect(query, null, true);
  while(rs and rs.moveNext())
    if(DocKind == _DocKind_Buy)
      _PrintLnANSI("    <КнПокСтр>");
    elif(DocKind == _DocKind_BuyAdd)
      _PrintLnANSI("    <КнПокДЛСтр>");
    end;

    if(string(rownum) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Порядковый номер");
    end;
    _PrintLnANSI("     <НомерПор>" + rownum + "</НомерПор>");

    _GetBFFacturaNumbersCreationDates(@FacturaNumbers, @CreationDates, rs);
    if(string(FacturaNumbers) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Номер счета-фактуры продавца");
    end;
    _PrintLnANSI("     <НомСчФПрод>" + FacturaNumbers + "</НомСчФПрод>");
    _PrintLnANSI("     <ДатаСчФПрод>" + CreationDates + "</ДатаСчФПрод>");
    
    if((rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY) and (rs.value("t_SrcAssignment") != OBJSFASSIGNMENT_RECALC))
      _PrintLnANSI("     <НомИспрСчФ>" + rs.value("t_CorrectionNum") + "</НомИспрСчФ>");
      _PrintLnANSI("     <ДатаИспрСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаИспрСчФ>");
    end;

    _GetBFFacturaNumberCreationDate_Correction(@FacturaNumber, @CreationDate, @CorrectionNum, @CorrectionDate, rs);
	
	if ((FacturaNumber != "") and (ValType(FacturaNumber) != V_UNDEF))
		_PrintLnANSI("     <НомКСчФПрод>" + FacturaNumber + "</НомКСчФПрод>");
	end;
	
	if ((ValType(CreationDate) != V_UNDEF) and (CreationDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаКСчФПрод>" + CreationDate + "</ДатаКСчФПрод>");
	end;
	
	if ((CorrectionNum != "") and (ValType(CorrectionNum) != V_UNDEF))
		_PrintLnANSI("     <НомИспрКСчФ>" + CorrectionNum + "</НомИспрКСчФ>");
	end;
	
	if ((ValType(CorrectionDate) != V_UNDEF) and (CorrectionDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаИспрКСчФ>" + CorrectionDate + "</ДатаИспрКСчФ>");
	end;
    _GetBFCountryCodeGTDNumber(@CountryCode, @GTDNumber, rs.value("t_FacturaID"));
    _PrintLnANSI("     <НомТД>" + StrSubst(GTDNumber,",",";") + "</НомТД>");

    _PrintLnANSI("     <ОКВ>" + ПолучитьКодФинИн(rs.value("t_FIID")) + "</ОКВ>");
    
    if(string(money(rs.value("t_TotalWithNDS"))) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Стоимость покупок по счету-фактуре, разница стоимости по корректировочному счету-фактуре (включая налог), в валюте счета-фактуры");
    end;
    _PrintLnANSI("     <СтоимПокупВ>" + money(rs.value("t_TotalWithNDS")) + "</СтоимПокупВ>");

    if(string(money(rs.value("t_NDSAmount10") + rs.value("t_NDSAmount18") + rs.value("t_NDSAmount20"))) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Сумма налога по счету-фактуре, разница суммы налога по корректировочному счету-фактуре, принимаемая к вычету, в рублях и копейках");
    end;
    _PrintLnANSI("     <СумНДСВыч>" + money(rs.value("t_NDSAmount10") + rs.value("t_NDSAmount18") + rs.value("t_NDSAmount20")) + "</СумНДСВыч>");

    if(string(_GetBilOprCodes(rs.value("t_FacturaID"))) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Код вида операции");
    end;
    _PrintLnANSI("     <КодВидОпер>" + _GetBilOprCodes(rs.value("t_FacturaID")) + "</КодВидОпер>");

    _PrintLnANSI("     <ДатаУчТов>" + string(date(rs.value("t_EntryDate")):f) + "</ДатаУчТов>");

    _PrintLnANSI("     <ДокПдтвУпл>");

    PayDate = BFGetMaxDateDocBookEntry(rs.value("t_BookEntryID"), PayNum);
    if(string(PayNum) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Номер документа, подтверждающего уплату налога");
    end;
    _PrintLnANSI("      <НомДокПдтвУпл>" + PayNum + "</НомДокПдтвУпл>");
    
    if(string(PayDate:f) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Дата документа, подтверждающего уплату налога");
    end;
    _PrintLnANSI("      <ДатаДокПдтвУпл>" + string(PayDate:f) + "</ДатаДокПдтвУпл>");

    _PrintLnANSI("     </ДокПдтвУпл>");

    _PrintLnANSI("     <СвПрод>");

    SupplierName = rs.value("t_SupplierName");
    SupplierINN = rs.value("t_SupplierINN");

    _GetBilFAgentPtNameINN(rs.value("t_IsSupplierAgent"), rs.value("bbe_t_FacturaID"), 2, @SupplierName, @SupplierINN);
    if((strlen(SupplierINN) == 12) and (index(SupplierINN, "/") == 0))
      _PrintLnANSI("      <СведИП>");
      _PrintLnANSI("       <ИННФЛ>" + SupplierINN + "</ИННФЛ>");
      _PrintLnANSI("      </СведИП>");
    else
		_PrintLnANSI("      <СведЮЛ>");
		SplitFullINN(SupplierINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
		_PrintLnANSI("      </СведЮЛ>");
    end;

    _PrintLnANSI("     </СвПрод>");

    if((rs.value("t_IsSupplierAgent") == "X") and (rs.value("t_SfTypeID") == 6/*СФ посредника*/))
      _PrintLnANSI("     <СвПос>");
      
      SupplierINN = rs.value("t_SupplierINN");

      if((strlen(SupplierINN) == 12) and (index(SupplierINN, "//") == 0))
        _PrintLnANSI("      <СведИП>");
        _PrintLnANSI("       <ИННФЛ>" + SupplierINN + "</ИННФЛ>");
        _PrintLnANSI("      </СведИП>");
      else
        _PrintLnANSI("      <СведЮЛ>");
		SplitFullINN(SupplierINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
        _PrintLnANSI("      </СведЮЛ>");
      end;
      
      _PrintLnANSI("     </СвПос>");
    end;

/*
    _PrintLnANSI("     <></>");
*/

    if(DocKind == _DocKind_Buy)
      _PrintLnANSI("    </КнПокСтр>");
    elif(DocKind == _DocKind_BuyAdd)
      _PrintLnANSI("    </КнПокДЛСтр>");
    end;
  
    rownum = rownum + 1;
  end;
end;

private macro _BilBEUnloadIntoFileRecs_Sale(DocKind)
  var query = "";
  var rs;
  var rownum = 1;
  var FacturaNumbers;
  var CreationDates;
  var FacturaNumber;
  var CreationDate;
  var CorrectionNum;
  var CorrectionDate;
  var CountryCode;
  var GTDNumber;
  var PayNum = "";
  var PayDate;
  var ReceiverName, ReceiverINN;
  var sINN = "", sKPP = "";

  query = query + "SELECT ";
  query = query + "  t0.t_BookEntryID                                 /* 0*/ ";
  query = query + " ,t0.t_FacturaID                                   /* 1*/ ";
  query = query + " ,t0.t_SfTypeID                                    /* 2*/ ";
  query = query + " ,t0.t_Assignment                                  /* 3*/ ";
  query = query + " ,t0.t_FacturaNumber                               /* 4*/ ";
  query = query + " ,t0.t_CreationDate                                /* 5*/ ";
  query = query + " ,t0.t_CorrectionNum                               /* 6*/ ";
  query = query + " ,NVL(t0.t_TotalWithNDS, 0)     t_TotalWithNDS     /* 7*/ ";
  query = query + " ,t0.t_SrcFacturaID                                /* 8*/ ";
  query = query + " ,t0.t_SrcAssignment                               /* 9*/ ";
  query = query + " ,t0.t_SrcFacturaNumber                            /*10*/ ";
  query = query + " ,t0.t_SrcCreationDate                             /*11*/ ";
  query = query + " ,t0.t_SrcCorrectionNum                            /*12*/ ";
  query = query + " ,t0.t_FacturaDirection                            /*13*/ ";
  query = query + " ,t0.t_BookDirection                               /*14*/ ";
  query = query + " ,NVL(t0.t_Amount0, 0)          t_Amount0          /*15*/ ";
  query = query + " ,NVL(t0.t_Amount10, 0)         t_Amount10         /*16*/ ";
  query = query + " ,NVL(t0.t_NDSAmount10, 0)      t_NDSAmount10      /*17*/ ";
  query = query + " ,NVL(t0.t_Amount18, 0)         t_Amount18         /*18*/ ";
  query = query + " ,NVL(t0.t_NDSAmount18, 0)      t_NDSAmount18      /*19*/ ";
  query = query + " ,NVL(t0.t_Amount20, 0)         t_Amount20         /*20*/ ";
  query = query + " ,NVL(t0.t_NDSAmount20, 0)      t_NDSAmount20      /*21*/ ";
  query = query + " ,NVL(t0.t_Free, 0)             t_Free             /*22*/ ";
  query = query + " ,NVL(t0.t_TotalWithNDSCurr, 0) t_TotalWithNDSCurr /*23*/ ";
  query = query + " ,t0.t_AnnulEntry                                  /*24*/ ";
  query = query + " ,bilbookentry.t_FIID                                       /*25*/ ";
  query = query + " ,bilbookentry.t_EntryDate                                  /*26*/ ";
  query = query + " ,bilbookentry.t_ReceiverName                               /*27*/ ";
  query = query + " ,bilbookentry.t_ReceiverINN                                /*28*/ ";
  query = query + " ,bilbookentry.t_IsReceiverAgent                            /*29*/ ";
  query = query + " ,bilbookentry.t_FacturaID               bbe_t_FacturaID    /*30*/ ";
  query = query + " ,bilbookentry.t_EntryNumber                                /*31*/ ";
  query = query + " ,bilbookentry.t_RegDate                                    /*32*/ ";
  query = query + "  FROM dbilbeunload_tmp t0, dbilbookentry_dbt bilbookentry         ";
  query = query + " WHERE bilbookentry.t_BookEntryID = t0.t_BookEntryID               ";
  query = query + "   AND t0.t_BookEntryID <> 0                              "; /*это условие нужно для режима SaleAdd, а в режиме Sale такой записи в таблице нет*/
  query = query + " ORDER BY bilbookentry.t_RegDate                                   ";

  rs = execSQLselect(query, null, true);
  while(rs and rs.moveNext())
    if(DocKind == _DocKind_Sale)
      _PrintLnANSI("    <КнПродСтр>");
    elif(DocKind == _DocKind_SaleAdd)
      _PrintLnANSI("    <КнПродДЛСтр>");
    end;

    if(string(rownum) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Порядковый номер");
    end;
    _PrintLnANSI("     <НомерПор>" + rownum + "</НомерПор>");

    _GetBFFacturaNumbersCreationDates(@FacturaNumbers, @CreationDates, rs);
    if(string(FacturaNumbers) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Номер счета-фактуры продавца");
    end;
    _PrintLnANSI("     <НомСчФПрод>" + FacturaNumbers + "</НомСчФПрод>");
    if(string(CreationDates) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Дата счета-фактуры продавца");
    end;
    _PrintLnANSI("     <ДатаСчФПрод>" + CreationDates + "</ДатаСчФПрод>");
    
    if((rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY) and (rs.value("t_SrcAssignment") != OBJSFASSIGNMENT_RECALC))
      _PrintLnANSI("     <НомИспрСчФ>" + rs.value("t_CorrectionNum") + "</НомИспрСчФ>");
      _PrintLnANSI("     <ДатаИспрСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаИспрСчФ>");
    end;

    _GetBFFacturaNumberCreationDate_Correction(@FacturaNumber, @CreationDate, @CorrectionNum, @CorrectionDate, rs);
	
	if ((FacturaNumber != "") and (ValType(FacturaNumber) != V_UNDEF))
		_PrintLnANSI("     <НомКСчФПрод>" + FacturaNumber + "</НомКСчФПрод>");
	end;
	
	if ((ValType(CreationDate) != V_UNDEF) and (CreationDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаКСчФПрод>" + CreationDate + "</ДатаКСчФПрод>");
	end;
	
	if ((CorrectionNum != "") and (ValType(CorrectionNum) != V_UNDEF))
		_PrintLnANSI("     <НомИспрКСчФ>" + CorrectionNum + "</НомИспрКСчФ>");
	end;
	
	if ((ValType(CorrectionDate) != V_UNDEF) and (CorrectionDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаИспрКСчФ>" + CorrectionDate + "</ДатаИспрКСчФ>");
	end;

    /*
    _GetBFCountryCodeGTDNumber(@CountryCode, @GTDNumber, rs.value("t_FacturaID"));
    _PrintLnANSI("     <НомТД>" + GTDNumber + "</НомТД>");
    */

    _PrintLnANSI("     <ОКВ>" + ПолучитьКодФинИн(rs.value("t_FIID")) + "</ОКВ>");
    
    if(ПолучитьКодФинИн(rs.value("t_FIID")) != "643")
      _PrintLnANSI("     <СтоимПродСФВ>" + money(rs.value("t_TotalWithNDS")) + "</СтоимПродСФВ>");
    else
      _PrintLnANSI("     <СтоимПродСФ>" + money(rs.value("t_TotalWithNDSCurr")) + "</СтоимПродСФ>");
    end;

    _PrintLnANSI("     <СтоимПродСФ18>" + money(rs.value("t_Amount18")) + "</СтоимПродСФ18>");
    _PrintLnANSI("     <СтоимПродСФ10>" + money(rs.value("t_Amount10")) + "</СтоимПродСФ10>");
    _PrintLnANSI("     <СтоимПродСФ0>" + money(rs.value("t_Amount0")) + "</СтоимПродСФ0>");
    _PrintLnANSI("     <СумНДССФ18>" + money(rs.value("t_NDSAmount18")) + "</СумНДССФ18>");
    _PrintLnANSI("     <СумНДССФ10>" + money(rs.value("t_NDSAmount10")) + "</СумНДССФ10>");
    _PrintLnANSI("     <СтоимПродОсв>" + money(rs.value("t_Free")) + "</СтоимПродОсв>");

    if(string(_GetBilOprCodes(rs.value("t_FacturaID"))) == "")
      _InsertBFUnloadBadRec(DocKind, rs.value("t_EntryNumber"), rs.value("t_RegDate"), "Код вида операции");
    end;
    _PrintLnANSI("     <КодВидОпер>" + _GetBilOprCodes(rs.value("t_FacturaID")) + "</КодВидОпер>");

    _PrintLnANSI("     <ДатаУчТов>" + string(date(rs.value("t_EntryDate")):f) + "</ДатаУчТов>");

    _PrintLnANSI("     <ДокПдтвОпл>");

    PayDate = BFGetMaxDateDocBookEntry(rs.value("t_BookEntryID"), PayNum);
    _PrintLnANSI("      <НомДокПдтв>" + PayNum + "</НомДокПдтв>");
    _PrintLnANSI("      <ДатаДокПдтв>" + string(PayDate:f) + "</ДатаДокПдтв>");

    _PrintLnANSI("     </ДокПдтвОпл>");

    _PrintLnANSI("     <СвПокуп>");

    ReceiverName = rs.value("t_ReceiverName");
    ReceiverINN = rs.value("t_ReceiverINN");

    _GetBilFAgentPtNameINN(rs.value("t_IsReceiverAgent"), rs.value("bbe_t_FacturaID"), 3, @ReceiverName, @ReceiverINN);

    if((strlen(ReceiverINN) == 12) and (index(ReceiverINN, "/") == 0))
      _PrintLnANSI("      <СведИП>");
      _PrintLnANSI("       <ИННФЛ>" + ReceiverINN + "</ИННФЛ>");
      _PrintLnANSI("      </СведИП>");
    else
		_PrintLnANSI("      <СведЮЛ>");
		SplitFullINN(ReceiverINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
		_PrintLnANSI("      </СведЮЛ>");
    end;

    _PrintLnANSI("     </СвПокуп>");

    if((rs.value("t_IsReceiverAgent") == "X") and (rs.value("t_SfTypeID") == 6/*СФ посредника*/))
      _PrintLnANSI("     <СвПос>");
      
      ReceiverINN = rs.value("t_ReceiverINN");

      if((strlen(ReceiverINN) == 12) and (index(ReceiverINN, "/") == 0))
        _PrintLnANSI("      <СведИП>");
        _PrintLnANSI("       <ИННФЛ>" + ReceiverINN + "</ИННФЛ>");
        _PrintLnANSI("      </СведИП>");
      else
		_PrintLnANSI("      <СведЮЛ>");
        SplitFullINN(ReceiverINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
        _PrintLnANSI("      </СведЮЛ>");
      end;
      
      _PrintLnANSI("     </СвПос>");
    end;

/*
    _PrintLnANSI("     <></>");
*/

    if(DocKind == _DocKind_Sale)
      _PrintLnANSI("    </КнПродСтр>");
    elif(DocKind == _DocKind_SaleAdd)
      _PrintLnANSI("    </КнПродДЛСтр>");
    end;
  
    rownum = rownum + 1;
  end;
end;

/*5.3.1 Функция выгрузки данных по книге покупок*/
private macro _BilBEUnloadIntoFile_Buy()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilBEUnload();
  var CheckRes = 0;

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_Buy, "", 0, "");
  else

    __СумНДСВсКПк = money(_СумНДСВсКПк());
    __СуммаВсехСумНДСВыч = money(_СуммаВсехСумНДСВыч());

    if((CheckRes == 0) and (__СумНДСВсКПк != __СуммаВсехСумНДСВыч))
      CheckRes = 1;
    end;

    if(CheckRes == 0)
    
      UnloadFileName = _FormUnloadFileName(_DocKind_Buy);
      GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
      if(stat != 0) 
        UnloadFilePath = "..\\txtfile\\"; 
      end;
      if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
        UnloadFilePath = UnloadFilePath + "\\";
      end;
      
      FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";
      
      setoutput(FullUnloadFileName);
      
      _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");
      
      _PrintLnANSI("<Файл>");
      
      _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
      _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
      _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");
      
      _PrintLnANSI(" <Документ>");
      
      _PrintLnANSI("  <Индекс>0000080</Индекс>");
      _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	  
	  if (bilfunloadparam.CorrectNum != 0)
		_PrintLnANSI("  <ПризнСвед8>" + bilfunloadparam.Actuality + "</ПризнСвед8>");
	  end;
      
      if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))
      
        _PrintLnANSI("   <КнигаПокуп>");
      
        if(string(__СумНДСВсКПк) == "")
          _InsertBFUnloadBadRec(_DocKind_Buy, "", date(0, 0, 0), "Сумма налога всего по книге покупок в рублях и копейках");
        end;
        _PrintLnANSI("   <СумНДСВсКПк>" + __СумНДСВсКПк + "</СумНДСВсКПк>");
      
        _BilBEUnloadIntoFileRecs_Buy(_DocKind_Buy);
      
        _PrintLnANSI("   </КнигаПокуп>");
        
      end;
      
      _PrintLnANSI(" </Документ>");
      
      _PrintLnANSI("</Файл>");
      
      setoutput(null);

      _InsertBFUnloadLog(_DocKind_Buy, UnloadFileName, Count, "");
    elif(CheckRes == 1)
      _InsertBFUnloadLog(_DocKind_Buy, "", 0, "Сумма всех значений СумНДСВыч = СумНДСВсКПк");
    end;
  end;
end;

private macro _СтПродБезНДС18()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Amount18, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродБезНДС10()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Amount10, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродБезНДС0()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Amount0, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСВсКПр18()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount18, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСВсКПр10()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount10, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродОсвВсКПр()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Free, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp                                                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

/*5.3.3 Функция выгрузки данных по книге продаж*/
private macro _BilBEUnloadIntoFile_Sale()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilBEUnload();

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_Sale, "", Count, "");
  else
    __СтПродБезНДС18 = money(_СтПродБезНДС18());
    __СтПродБезНДС10 = money(_СтПродБезНДС10());
    __СтПродБезНДС0  = money(_СтПродБезНДС0()); 
    __СумНДСВсКПр18  = money(_СумНДСВсКПр18()); 
    __СумНДСВсКПр10  = money(_СумНДСВсКПр10()); 
    __СтПродОсвВсКПр = money(_СтПродОсвВсКПр());
    
    UnloadFileName = _FormUnloadFileName(_DocKind_Sale);
    GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
    if(stat != 0) 
      UnloadFilePath = "..\\txtfile\\"; 
    end;
    if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
      UnloadFilePath = UnloadFilePath + "\\";
    end;

    FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";

    setoutput(FullUnloadFileName);

    _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");

    _PrintLnANSI("<Файл>");

    _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
    _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
    _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");

    _PrintLnANSI(" <Документ>");

    _PrintLnANSI("  <Индекс>0000090</Индекс>");
    _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	
	if (bilfunloadparam.CorrectNum != 0)
		_PrintLnANSI("  <ПризнСвед9>" + bilfunloadparam.Actuality + "</ПризнСвед9>");
	end;

    if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))

      _PrintLnANSI("   <КнигаПрод>");

      _PrintLnANSI("   <СтПродБезНДС18>" + __СтПродБезНДС18 + "</СтПродБезНДС18>");
      _PrintLnANSI("   <СтПродБезНДС10>" + __СтПродБезНДС10 + "</СтПродБезНДС10>");
      _PrintLnANSI("   <СтПродБезНДС0>"  + __СтПродБезНДС0  + "</СтПродБезНДС0>");
      _PrintLnANSI("   <СумНДСВсКПр18>"  + __СумНДСВсКПр18  + "</СумНДСВсКПр18>");
      _PrintLnANSI("   <СумНДСВсКПр10>"  + __СумНДСВсКПр10  + "</СумНДСВсКПр10>");
      _PrintLnANSI("   <СтПродОсвВсКПр>" + __СтПродОсвВсКПр + "</СтПродОсвВсКПр>");

      _BilBEUnloadIntoFileRecs_Sale(_DocKind_Sale);

      _PrintLnANSI("   </КнигаПрод>");
      
    end;

    _PrintLnANSI(" </Документ>");
    
    _PrintLnANSI("</Файл>");

    setoutput(null);


    _InsertBFUnloadLog(_DocKind_Sale, UnloadFileName, Count, "");
  end;
end;

private macro _ИтСтПродКПр18()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(t_Amount18, 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0 ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _ИтСтПродКПр10()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(t_Amount10, 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0 ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _ИтСтПродКПр0()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(t_Amount0, 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0 ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСИтКПр18()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(t_NDSAmount18, 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0 ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСИтКПр10()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(t_NDSAmount10, 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0 ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _ИтСтПродОсвКПр()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(t_Free, 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0 ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродВсП1Р9_18()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Amount18, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp  ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродВсП1Р9_10()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Amount10, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp  ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродВсП1Р9_0()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Amount0, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp  ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСВсП1Р9_18()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount18, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp  ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСВсП1Р9_10()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount10, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp  ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СтПродОсвП1Р9Вс()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_Free, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp  ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

/*5.3.4 Функция выгрузки данных по дополнительным листам книги продаж*/
private macro _BilBEUnloadIntoFile_SaleAdd()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilBEUnload();
  var CheckRes = 0;

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_SaleAdd, "", Count, "");
  else
    __ИтСтПродКПр18  = money(_ИтСтПродКПр18()) ;
    __ИтСтПродКПр10  = money(_ИтСтПродКПр10()) ;
    __ИтСтПродКПр0   = money(_ИтСтПродКПр0())  ;
    __СумНДСИтКПр18  = money(_СумНДСИтКПр18()) ;
    __СумНДСИтКПр10  = money(_СумНДСИтКПр10()) ;
    __ИтСтПродОсвКПр = money(_ИтСтПродОсвКПр());

    if((CheckRes == 0) and (bilfunloadparam.LoadSaleBBE == "X"))
      if((CheckRes == 0) and (__ИтСтПродКПр18 != __СтПродБезНДС18))
        CheckRes = 1;
      end;
      if((CheckRes == 0) and (__ИтСтПродКПр10 != __СтПродБезНДС10))
        CheckRes = 2;
      end;
      if((CheckRes == 0) and (__ИтСтПродКПр0 != __СтПродБезНДС0))
        CheckRes = 3;
      end;
      if((CheckRes == 0) and (__СумНДСИтКПр18 != __СумНДСВсКПр18))
        CheckRes = 4;
      end;
      if((CheckRes == 0) and (__СумНДСИтКПр10 != __СумНДСВсКПр10))
        CheckRes = 5;
      end;
      if((CheckRes == 0) and (__ИтСтПродОсвКПр != __СтПродОсвВсКПр))
        CheckRes = 6;
      end;
    end;
    
    if(CheckRes == 0)

      UnloadFileName = _FormUnloadFileName(_DocKind_SaleAdd);
      GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
      if(stat != 0) 
        UnloadFilePath = "..\\txtfile\\"; 
      end;
      if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
        UnloadFilePath = UnloadFilePath + "\\";
      end;
   
      FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";
   
      setoutput(FullUnloadFileName);
   
      _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");
   
      _PrintLnANSI("<Файл>");
   
      _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
      _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
      _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");
   
      _PrintLnANSI(" <Документ>");
   
      _PrintLnANSI("  <Индекс>0000091</Индекс>");
      _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	  
	  if (bilfunloadparam.CorrectNum != 0)
		_PrintLnANSI("  <ПризнСвед91>" + bilfunloadparam.Actuality + "</ПризнСвед91>");
	  end;
   
      if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))
   
        _PrintLnANSI("   <КнигаПродДЛ>");
   
        _PrintLnANSI("   <ИтСтПродКПр18>"  + __ИтСтПродКПр18  + "</ИтСтПродКПр18>");
        _PrintLnANSI("   <ИтСтПродКПр10>"  + __ИтСтПродКПр10  + "</ИтСтПродКПр10>");
        _PrintLnANSI("   <ИтСтПродКПр0>"   + __ИтСтПродКПр0   + "</ИтСтПродКПр0>");
        _PrintLnANSI("   <СумНДСИтКПр18>"  + __СумНДСИтКПр18  + "</СумНДСИтКПр18>");
        _PrintLnANSI("   <СумНДСИтКПр10>"  + __СумНДСИтКПр10  + "</СумНДСИтКПр10>");
        _PrintLnANSI("   <ИтСтПродОсвКПр>" + __ИтСтПродОсвКПр + "</ИтСтПродОсвКПр>");
   
        _PrintLnANSI("   <СтПродВсП1Р9_18>" + money(_СтПродВсП1Р9_18()) + "</СтПродВсП1Р9_18>");
        _PrintLnANSI("   <СтПродВсП1Р9_10>" + money(_СтПродВсП1Р9_10()) + "</СтПродВсП1Р9_10>");
        _PrintLnANSI("   <СтПродВсП1Р9_0>" + money(_СтПродВсП1Р9_0()) + "</СтПродВсП1Р9_0>");
        _PrintLnANSI("   <СумНДСВсП1Р9_18>" + money(_СумНДСВсП1Р9_18()) + "</СумНДСВсП1Р9_18>");
        _PrintLnANSI("   <СумНДСВсП1Р9_10>" + money(_СумНДСВсП1Р9_10()) + "</СумНДСВсП1Р9_10>");
        _PrintLnANSI("   <СтПродОсвП1Р9Вс>" + money(_СтПродОсвП1Р9Вс()) + "</СтПродОсвП1Р9Вс>");
   
        _BilBEUnloadIntoFileRecs_Sale(_DocKind_SaleAdd);
   
        _PrintLnANSI("   </КнигаПродДЛ>");
        
      end;
   
      _PrintLnANSI(" </Документ>");
      
      _PrintLnANSI("</Файл>");
   
      setoutput(null);

      _InsertBFUnloadLog(_DocKind_SaleAdd, UnloadFileName, Count - 1, "");
    elif(CheckRes == 1)
      _InsertBFUnloadLog(_DocKind_SaleAdd, "", 0, "ИтСтПродКПр18 = СтПродБезНДС18");
    elif(CheckRes == 2)
      _InsertBFUnloadLog(_DocKind_SaleAdd, "", 0, "ИтСтПродКПр10 = СтПродБезНДС10");
    elif(CheckRes == 3)
      _InsertBFUnloadLog(_DocKind_SaleAdd, "", 0, "ИтСтПродКПр0 = СтПродБезНДС0");
    elif(CheckRes == 4)
      _InsertBFUnloadLog(_DocKind_SaleAdd, "", 0, "СумНДСИтКПр18 = СумНДСВсКПр18");
    elif(CheckRes == 5)
      _InsertBFUnloadLog(_DocKind_SaleAdd, "", 0, "СумНДСИтКПр10 = СумНДСВсКПр10");
    elif(CheckRes == 6)
      _InsertBFUnloadLog(_DocKind_SaleAdd, "", 0, "ИтСтПродОсвКПр = СтПродОсвВсКПр");
    end;
  end;
end;

private macro _GetBilBooksTypeForOpenCloseDate(DateFrom, DateTo, Direction)
  var sqlStr = "";
  var rs;
  var params : TArray;

  sqlStr = sqlStr + "SELECT t_BookID, t_OpenDate, t_CloseDate ";
  sqlStr = sqlStr + "  FROM dbilbook_dbt                      ";
  sqlStr = sqlStr + " WHERE     t_BookType = :BookType        ";
  sqlStr = sqlStr + "       AND t_OpenDate <= :CloseDate       ";
  sqlStr = sqlStr + "       AND (t_CloseDate = to_date('01.01.0001', 'DD.MM.YYYY') OR t_CloseDate >= :OpenDate) ";

  params = makeArray(SQLParam("BookType", Direction)
                    ,SQLParam("CloseDate", DateTo)
                    ,SQLParam("OpenDate", DateFrom)
                    );
  rs = execSQLselect(sqlStr, params, true);

  return rs;
end;

private macro _GetBilBooksByDirection_Buy(DateFrom, DateTo, DprtID)
  var sqlStr = "";
  var rs;
  var params : TArray;
  var BookID;

  rs = _GetBilBooksTypeForOpenCloseDate(DateFrom, DateTo, 2);
  
  while(rs and rs.moveNext())
    BookID = rs.value(0);

    _FillBilBEUnload_Buy(BookID, DateFrom, DateTo, DprtID);
  end;
  _FillBilBEUnloadAmounts(false);

  _BilBEUnloadIntoFile_Buy();
end;

private macro _GetBilBooksByDirection_Sale(DateFrom, DateTo, DprtID)
  var sqlStr = "";
  var rs;
  var params : TArray;
  var BookID;

  rs = _GetBilBooksTypeForOpenCloseDate(DateFrom, DateTo, 1);
  
  while(rs and rs.moveNext())
    BookID = rs.value(0);

    _FillBilBEUnload_Sale(BookID, DateFrom, DateTo, DprtID);
  end;
  _FillBilBEUnloadAmounts(false);

  _BilBEUnloadIntoFile_Sale();
end;

private macro _CheckBilBEAddUnload_BookEntryID_0()
  var rs = execSQLselect("SELECT COUNT(1) FROM dbilbeaddunload_tmp WHERE t_BookEntryID <> 0", null, true);
  if(rs and rs.moveNext())
    if(rs.value(0) == 0)
      execSQL("INSERT INTO dbilbeaddunload_tmp (t_BookEntryID) VALUES (0)", null);
    end;
  end;
end;

private macro _FillBilBEAddUnloadAmounts_BookEntryID_0()
  var sqlString;
  var params = TArray;

  sqlString = "UPDATE dbilbeaddunload_tmp tmp " + 
              "   SET " + 
              "     tmp.t_Amount0 = NVL(tmp.t_Amount0, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_Amount0) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_Amount10 = NVL(tmp.t_Amount10, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_Amount10) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_NDSAmount10 = NVL(tmp.t_NDSAmount10, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_NDSAmount10) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_Amount18 = NVL(tmp.t_Amount18, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_Amount18) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_NDSAmount18 = NVL(tmp.t_NDSAmount18, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_NDSAmount18) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_Amount20 = NVL(tmp.t_Amount20, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_Amount20) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_NDSAmount20 = NVL(tmp.t_NDSAmount20, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_NDSAmount20) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              "    ,tmp.t_Free = NVL(tmp.t_Free, 0) + " + 
              "       ( " + 
              "        SELECT SUM(t1.t_Free) " + 
              "          FROM dbilbeunload_tmp t1 " + 
              "       ) " +
              " WHERE tmp.t_BookEntryID = 0 " +
              " ";
	execSQL(sqlString, params);	
	
	var deleteSqlString = 
	"delete from DBILBEADDUNLOAD_TMP where " +  
	"	 t_Amount0     is NULL " + 
	"AND t_Amount10    is NULL " + 
	"AND t_NDSAmount10 is NULL " + 
	"AND t_Amount18    is NULL " + 
	"AND t_NDSAmount18 is NULL " + 
	"AND t_Amount20    is NULL " + 
	"AND t_NDSAmount20 is NULL " + 
	"AND t_Free        is NULL " + 
	"AND t_BookEntryID = 0;";
	
	execSQL(deleteSqlString, params);
end;


private macro _GetRsAnnulDateForBookOpenCloseDate_Buy(acssql_from, acssql_where, BookID, OpenDate, CloseDate, DprtID, Direction)
  var sqlStr, rs; 
  var params = TArray;
  var i;

  sqlStr = "SELECT DISTINCT AnnulDate FROM ( " +
           "  SELECT bilbookentry.t_AnnulDate as AnnulDate " +
           "    FROM DBILBOOKENTRY_DBT bilbookentry " + 
           acssql_from +
           "   WHERE bilbookentry.t_RegDate BETWEEN :DateFrom_1_1 AND :DateTo_1_1 " +
           "     AND bilbookentry.t_Direction = :Direction_1_1" +
           "     AND " + acssql_where;
  
  i = params.size;
  params[i] = SQLParam("DateFrom_1_1", OpenDate);
  i = params.size;
  params[i] = SQLParam("DateTo_1_1", CloseDate);
  i = params.size;
  params[i] = SQLParam("Direction_1_1", Direction);
  
  if(DprtID != 0)
    sqlStr = sqlStr + " AND bilbookentry.t_Department = :DprtID_1_1 ";
    i = params.size;
    params[i] = SQLParam("DprtID_1_1", DprtID);
  end;
     
  sqlStr = sqlStr +
           "     AND bilbookentry.t_BookID = :BookID_1_1 AND bilbookentry.t_AnnulEntry <> 0 " +
           "  UNION " +
           "  SELECT bilbookentry.t_RegDate as AnnulDate " +
           "    FROM DBILBOOKENTRY_DBT bilbookentry " + 
           acssql_from +  
           "   WHERE bilbookentry.t_RegDate > :DateTo_2_1 " +
           "        AND bilbookentry.t_Direction = :Direction_2_1 " +
           "        AND bilbookentry.t_BookID = :BookID_2_1" +
           "        AND " + acssql_where;

  i = params.size;
  params[i] = SQLParam("BookID_1_1", BookID);
  i = params.size;
  params[i] = SQLParam("DateTo_2_1", CloseDate);
  i = params.size;
  params[i] = SQLParam("Direction_2_1", Direction);
  i = params.size;
  params[i] = SQLParam("BookID_2_1", BookID);

  if(DprtID != 0)
    sqlStr = sqlStr + " AND bilbookentry.t_Department = :DprtID_2_1 ";
    i = params.size;
    params[i] = SQLParam("DprtID_2_1", DprtID);
  end;

  sqlStr = sqlStr +  " UNION " ;

  sqlStr = sqlStr +
           " SELECT bilbookentry.t_RegDate AS AnnulDate " +
           "   FROM dbilbookentry_dbt bilbookentry, dbilfactura_dbt bilfactura " +  
           acssql_from +                   
           "  WHERE " +
           "     (( bilbookentry.t_RegDate BETWEEN :DateFrom_3_1 AND :DateTo_3_1 "+
           "           AND bilfactura.t_RegDate > :DateTo_3_2 "+
           "     OR ( bilbookentry.t_RegDate > :DateTo_3_3 ) "+
           "   )  " +
           " AND bilbookentry.t_BookID = :BookID_3_1 " +
           " AND bilbookentry.t_Direction = :Direction_3_1 " + 
           " AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
           " AND bilfactura.t_Assignment = :Assignment_3_1 " + /*Пересчет*/
           " AND " + acssql_where; 

  i = params.size;
  params[i] = SQLParam("DateFrom_3_1", OpenDate);
  i = params.size;
  params[i] = SQLParam("DateTo_3_1", CloseDate);
  i = params.size;
  params[i] = SQLParam("DateTo_3_2", CloseDate);
  i = params.size;
  params[i] = SQLParam("DateTo_3_3", CloseDate);
  i = params.size;
  params[i] = SQLParam("BookID_3_1", BookID);
  i = params.size;
  params[i] = SQLParam("Direction_3_1", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment_3_1", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlStr = sqlStr + " AND bilbookentry.t_Department = :DprtID_3_1 ";
    i = params.size;
    params[i] = SQLParam("DprtID_3_1", DprtID);
  end;

  sqlStr = sqlStr + " )) ORDER BY AnnulDate" ;

  rs = execSQLselect(sqlStr, params, true);

  return rs;
end;

private macro _GetRsAnnulDateForBookOpenCloseDate_Sale(acssql_from, acssql_where, BookID, OpenDate, CloseDate, DprtID, Direction)
  var sqlStr, rs; 
  var params = TArray;
  var i;

  sqlStr = "SELECT DISTINCT AnnulDate FROM ( " +
           "  SELECT bilbookentry.t_AnnulDate as AnnulDate " +
           "    FROM DBILBOOKENTRY_DBT bilbookentry " + 
           acssql_from +
           "   WHERE bilbookentry.t_RegDate BETWEEN :DateFrom_1_1 AND :DateTo_1_1 " +
           "     AND bilbookentry.t_Direction = :Direction_1_1" +
           "     AND " + acssql_where;
  
  i = params.size;
  params[i] = SQLParam("DateFrom_1_1", OpenDate);
  i = params.size;
  params[i] = SQLParam("DateTo_1_1", CloseDate);
  i = params.size;
  params[i] = SQLParam("Direction_1_1", Direction);
  
  if(DprtID != 0)
    sqlStr = sqlStr + " AND bilbookentry.t_Department = :DprtID_1_1 ";
    i = params.size;
    params[i] = SQLParam("DprtID_1_1", DprtID);
  end;
     
  sqlStr = sqlStr +
           "     AND bilbookentry.t_BookID = :BookID_1_1 AND bilbookentry.t_AnnulEntry <> 0 " +
           "  UNION " +
           "  SELECT bilbookentry.t_RegDate as AnnulDate " +
           "    FROM DBILBOOKENTRY_DBT bilbookentry " + 
           acssql_from +  
           "   WHERE bilbookentry.t_RegDate > :DateTo_2_1 " +
           "        AND bilbookentry.t_Direction = :Direction_2_1 " +
           "        AND bilbookentry.t_BookID = :BookID_2_1" +
           "        AND " + acssql_where;

  i = params.size;
  params[i] = SQLParam("BookID_1_1", BookID);
  i = params.size;
  params[i] = SQLParam("DateTo_2_1", CloseDate);
  i = params.size;
  params[i] = SQLParam("Direction_2_1", Direction);
  i = params.size;
  params[i] = SQLParam("BookID_2_1", BookID);

  if(DprtID != 0)
    sqlStr = sqlStr + " AND bilbookentry.t_Department = :DprtID_2_1 ";
    i = params.size;
    params[i] = SQLParam("DprtID_2_1", DprtID);
  end;

  sqlStr = sqlStr +  " UNION " ;

  sqlStr = sqlStr +
           " SELECT bilbookentry.t_RegDate AS AnnulDate " +
           "   FROM dbilbookentry_dbt bilbookentry, dbilfactura_dbt bilfactura " +  
           acssql_from +                   
           "  WHERE " +
           "     (( bilbookentry.t_RegDate BETWEEN :DateFrom_3_1 AND :DateTo_3_1 "+
           "           AND (bilfactura.t_TotalWithNDS <= 0 OR bilfactura.t_RegDate BETWEEN :DateFrom_3_2 AND :DateTo_3_2) "+
           "     OR ( bilbookentry.t_RegDate > :DateTo_3_3 ) "+
           "   )  " +
           " AND bilbookentry.t_BookID = :BookID_3_1 " +
           " AND bilbookentry.t_Direction = :Direction_3_1 " + 
           " AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
           " AND bilfactura.t_Assignment = :Assignment_3_1 " + /*Пересчет*/
           " AND " + acssql_where; 

  i = params.size;
  params[i] = SQLParam("DateFrom_3_1", OpenDate);
  i = params.size;
  params[i] = SQLParam("DateTo_3_1", CloseDate);
  i = params.size;
  params[i] = SQLParam("DateFrom_3_2", OpenDate);
  i = params.size;
  params[i] = SQLParam("DateTo_3_2", CloseDate);
  i = params.size;
  params[i] = SQLParam("DateTo_3_3", CloseDate);
  i = params.size;
  params[i] = SQLParam("BookID_3_1", BookID);
  i = params.size;
  params[i] = SQLParam("Direction_3_1", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment_3_1", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlStr = sqlStr + " AND bilbookentry.t_Department = :DprtID_3_1 ";
    i = params.size;
    params[i] = SQLParam("DprtID_3_1", DprtID);
  end;

  sqlStr = sqlStr + " )) ORDER BY AnnulDate" ;

  rs = execSQLselect(sqlStr, params, true);

  return rs;
end;

private macro _AddRowsToBilBEUnload_1_BuyAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction, AnnulDate)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE (( bilbookentry.t_RegDate BETWEEN :BeginDate1 AND :EndDate1 " +
              "   AND bilbookentry.t_AnnulEntry <> 0 " +
              "   AND bilbookentry.t_AnnulDate = :AnnulDate1) " +
              " OR (bilbookentry.t_BookEntryID IN " + 
              "      (SELECT t_AnnulEntry FROM dbilbookentry_dbt " + 
              "        WHERE t_AnnulEntry <> 0 " + 
              "          AND t_RegDate BETWEEN :BeginDate2 AND :EndDate2 " + 
              "          AND t_AnnulDate = :AnnulDate2)) "+
              " OR (bilbookentry.t_RegDate > :EndDate3 "+
              "     AND bilbookentry.t_RegDate = :AnnulDate3)"
              "    ) " +
              " AND bilbookentry.t_BookID = :BookID " +
              " AND bilbookentry.t_Direction = :Direction " +
              " AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              " AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+)" +
              " AND " + acssql_where; 

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate1", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate1", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate1", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BeginDate2", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate2", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate2", AnnulDate);
  i = params.size;
  params[i] = SQLParam("EndDate3", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate3", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_2_BuyAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction, AnnulDate)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE  " +
              "    bilbookentry.t_RegDate = :AnnulDate1 AND " + 
              "     (( bilbookentry.t_RegDate BETWEEN :BeginDate1 AND :EndDate1 "+
              "           AND bilfactura.t_RegDate > :EndDate2) "+
              "     OR ( bilbookentry.t_RegDate > :EndDate3) "+
              "    ) " +
              " AND bilbookentry.t_BookID = :BookID " +
              " AND bilbookentry.t_Direction = :Direction " +
              " AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              " AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+)" +
              " AND bilfactura.t_Assignment = :Assignment " + /*Пересчет*/
              " AND " + acssql_where; 

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("AnnulDate1", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BeginDate1", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate1", EndDate);
  i = params.size;
  params[i] = SQLParam("EndDate2", EndDate);
  i = params.size;
  params[i] = SQLParam("EndDate3", EndDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_1_SaleAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction, AnnulDate)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE (( bilbookentry.t_RegDate BETWEEN :BeginDate1 AND :EndDate1 " +
              "   AND bilbookentry.t_AnnulEntry <> 0 " +
              "   AND bilbookentry.t_AnnulDate = :AnnulDate1) " +
              " OR (bilbookentry.t_BookEntryID IN " + 
              "      (SELECT t_AnnulEntry FROM dbilbookentry_dbt " + 
              "        WHERE t_AnnulEntry <> 0 " + 
              "          AND t_RegDate BETWEEN :BeginDate2 AND :EndDate2 " + 
              "          AND t_AnnulDate = :AnnulDate2)) "+
              " OR (bilbookentry.t_RegDate > :EndDate3 "+
              "     AND bilbookentry.t_RegDate = :AnnulDate3)"
              "    ) " +
              " AND bilbookentry.t_BookID = :BookID " +
              " AND bilbookentry.t_Direction = :Direction " +
              " AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              " AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+)" +
              " AND bilfactura.t_Assignment <> :Assignment " + /*OBJSFASSIGNMENT_RECALC*/
              " AND " + acssql_where; 

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("BeginDate1", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate1", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate1", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BeginDate2", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate2", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate2", AnnulDate);
  i = params.size;
  params[i] = SQLParam("EndDate3", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate3", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _AddRowsToBilBEUnload_2_SaleAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, Direction, AnnulDate)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   bilbookentry.t_BookEntryID  " +
              "  ,bilfactura.t_FacturaID     " +
              "  ,NVL(bilfactura.t_SfTypeID, 0) " +
              "  ,bilfactura.t_Assignment " +
              "  ,NVL(bilfactura.t_FacturaNumber, CHR(1)) " +
              "  ,NVL(bilfactura.t_CreationDate, TO_DATE('01.01.0001', 'dd.mm.yyyy')) " +
              "  ,bilfactura.t_CorrectionNum " +
              "  ,bilbookentry.t_Amount " +
              "  ,bilbookentry.t_AmountCurr " +
              "  ,NVL(bfsrc.t_FacturaID, 0) " +
              "  ,bfsrc.t_Assignment " +
              "  ,NVL(bfsrc.t_FacturaNumber, CHR(1)) " +
              "  ,bfsrc.t_CreationDate " +
              "  ,NVL(bfsrc.t_CorrectionNum, 0) " +
              "  ,bilfactura.t_Direction " +
              "  ,:iDirection " + /*!!iDirection!!*/
              "  ,bilbookentry.t_AnnulEntry " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              "  ,0 " +
              " FROM " +
              "   dbilbookentry_dbt bilbookentry " +
              "  ,dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt bfsrc " +
              acssql_from +                                     
              " WHERE  " +
              "    bilbookentry.t_RegDate = :AnnulDate1 AND " + 
              "     (( bilbookentry.t_RegDate BETWEEN :BeginDate1 AND :EndDate1 "+
              "           AND (bilfactura.t_TotalWithNDS <= 0 OR bilfactura.t_RegDate BETWEEN :BeginDate2 AND :EndDate2)) "+
              "     OR ( bilbookentry.t_RegDate > :EndDate3 AND bilbookentry.t_RegDate = :AnnulDate2 ) "+
              "    ) " +
              " AND bilbookentry.t_BookID = :BookID " +
              " AND bilbookentry.t_Direction = :Direction " +
              " AND bilbookentry.t_FacturaID = bilfactura.t_FacturaID(+) " +
              " AND bilfactura.t_SourceFacturaID = bfsrc.t_FacturaID(+)" +
              " AND bilfactura.t_Assignment = :Assignment " + /*Пересчет*/
              " AND " + acssql_where; 

  i = params.size;
  params[i] = SQLParam("iDirection", Direction);
  i = params.size;
  params[i] = SQLParam("AnnulDate1", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BeginDate1", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate1", EndDate);
  i = params.size;
  params[i] = SQLParam("BeginDate2", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate2", EndDate);
  i = params.size;
  params[i] = SQLParam("EndDate3", EndDate);
  i = params.size;
  params[i] = SQLParam("AnnulDate2", AnnulDate);
  i = params.size;
  params[i] = SQLParam("BookID", BookID);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("Assignment", OBJSFASSIGNMENT_RECALC);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID "/* + PrnDepartment*/; /*!!DprtID!!*/
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);

end;

private macro _CopyRowsToBilBEAddUnload()
  var sqlString;

  sqlString = " INSERT INTO dbilbeaddunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " FROM dbilbeunload_tmp " ;

  return execSQL(sqlString, null);

end;

private macro _CopyRowsToBilBEUnload()
  var sqlString;

  sqlString = " INSERT INTO dbilbeunload_tmp " +
              " (                    " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " )                    " +
              " SELECT               " +
              "   t_BookEntryID      " +
              "  ,t_FacturaID        " +
              "  ,t_SfTypeID         " +
              "  ,t_Assignment       " +
              "  ,t_FacturaNumber    " +
              "  ,t_CreationDate     " +
              "  ,t_CorrectionNum    " +
              "  ,t_TotalWithNDS     " +
              "  ,t_TotalWithNDSCurr " +
              "  ,t_SrcFacturaID     " +
              "  ,t_SrcAssignment    " +
              "  ,t_SrcFacturaNumber " +
              "  ,t_SrcCreationDate  " +
              "  ,t_SrcCorrectionNum " +
              "  ,t_FacturaDirection " +
              "  ,t_BookDirection    " +
              "  ,t_AnnulEntry       " +
              "  ,t_Amount0          " +
              "  ,t_Amount10         " +
              "  ,t_NDSAmount10      " +
              "  ,t_Amount18         " +
              "  ,t_NDSAmount18      " +
              "  ,t_Amount20         " +
              "  ,t_NDSAmount20      " +
              "  ,t_Free             " +
              " FROM dbilbeaddunload_tmp " ;

  return execSQL(sqlString, null);

end;

/*5.2.3 Функция получения списка ЗК дополнительных листов книги покупок*/
private macro _FillBilBEUnload_BuyAdd(BookID, BeginDate, EndDate, DprtID)
  var acssql_where : string;
  var acssql_from : string; 
  var rs; 

  _TruncTable("dbilbeunload_tmp");

  if(GetObjectRestriction(acssql_where, 111, {oper}, "bilbookentry", CNTX_BilBookEntry, "bilbookentry.dbt", acssql_from, true))
    if(acssql_from != "")
      acssql_from = " , " + acssql_from + " ";
    end;

    _AddRowsToBilBEUnload_1_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 2);
    _AddRowsToBilBEUnload_2_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 2);
    _AddRowsToBilBEUnload_3_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 2);

    _FillBilBEUnloadAmounts(false);
    
    _CheckBilBEAddUnload_BookEntryID_0();
    
    _FillBilBEAddUnloadAmounts_BookEntryID_0();
    
    rs = _GetRsAnnulDateForBookOpenCloseDate_Buy(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 2);
    
    while(rs and rs.moveNext())
      _TruncTable("dbilbeunload_tmp");
      _AddRowsToBilBEUnload_1_BuyAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 2, date(rs.value("AnnulDate")));
      _AddRowsToBilBEUnload_2_BuyAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 2, date(rs.value("AnnulDate")));
      
      _FillBilBEUnloadAmounts(true);
    
      _CopyRowsToBilBEAddUnload();
    end;
  end;
end;

/*5.2.10 Функция получения списка ЗК дополнительных листов книги продаж*/
private macro _FillBilBEUnload_SaleAdd(BookID, BeginDate, EndDate, DprtID)
  var acssql_where : string;
  var acssql_from : string; 
  var rs; 

  _TruncTable("dbilbeunload_tmp");

  if(GetObjectRestriction(acssql_where, 111, {oper}, "bilbookentry", CNTX_BilBookEntry, "bilbookentry.dbt", acssql_from, true))
    if(acssql_from != "")
      acssql_from = " , " + acssql_from + " ";
    end;

    _AddRowsToBilBEUnload_1_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1);
    _AddRowsToBilBEUnload_2_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1);
    _AddRowsToBilBEUnload_3_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1);
    _AddRowsToBilBEUnload_4_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1);

    _FillBilBEUnloadAmounts(false);
    
    _CheckBilBEAddUnload_BookEntryID_0();
    
    _FillBilBEAddUnloadAmounts_BookEntryID_0();
    
    rs = _GetRsAnnulDateForBookOpenCloseDate_Sale(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1);
    
    while(rs and rs.moveNext())
      _TruncTable("dbilbeunload_tmp");
      _AddRowsToBilBEUnload_1_SaleAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1, date(rs.value("AnnulDate")));
      _AddRowsToBilBEUnload_2_SaleAdd(acssql_from, acssql_where, BookID, BeginDate, EndDate, DprtID, 1, date(rs.value("AnnulDate")));
      
      _FillBilBEUnloadAmounts(true);
    
      _CopyRowsToBilBEAddUnload();
    end;
  end;
end;

private macro _СумНДСИтКПк()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount10, 0)) + SUM(NVL(t_NDSAmount18, 0)) + SUM(NVL(t_NDSAmount20, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp WHERE t_BookEntryID = 0                                                     ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _СумНДСИтП1Р8()
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT NVL(SUM(NVL(t_NDSAmount10, 0)) + SUM(NVL(t_NDSAmount18, 0)) + SUM(NVL(t_NDSAmount20, 0)), 0) ";
  query = query + "  FROM dbilbeunload_tmp /*???WHERE t_BookEntryID <> 0*/                                             ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

/*5.3.2 Функция выгрузки данных по дополнительным листам книги покупок*/
private macro _BilBEUnloadIntoFile_BuyAdd()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilBEUnload();
  var CheckRes = 0;

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_BuyAdd, "", 0, "");
  else

    __СумНДСИтКПк = money(_СумНДСИтКПк());
    __СумНДС = money(_СуммаВсехСумНДСВыч());
    __СумНДСИтП1Р8 = money(_СумНДСИтП1Р8());

    if((CheckRes == 0) and (bilfunloadparam.LoadBuyBBE == "X"))
      if(__СумНДСИтКПк != __СумНДСВсКПк)
        CheckRes = 1;
      end;
    end;

    if((CheckRes == 0) and (__СумНДСИтКПк + __СумНДС != __СумНДСИтП1Р8))
      CheckRes = 2;
    end;

    if(CheckRes == 0)
      UnloadFileName = _FormUnloadFileName(_DocKind_BuyAdd);
      GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
      if(stat != 0) 
        UnloadFilePath = "..\\txtfile\\"; 
      end;
      if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
        UnloadFilePath = UnloadFilePath + "\\";
      end;
      
      FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";
      
      setoutput(FullUnloadFileName);
      
      _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");
      
      _PrintLnANSI("<Файл>");
      
      _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
      _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
      _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");
      
      _PrintLnANSI(" <Документ>");
      
      _PrintLnANSI("  <Индекс>0000081</Индекс>");
      _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	  
	  if (bilfunloadparam.CorrectNum != 0)
		_PrintLnANSI("  <ПризнСвед81>" + bilfunloadparam.Actuality + "</ПризнСвед81>");
	  end;
      
      if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))
      
        _PrintLnANSI("   <КнигаПокупДЛ>");

        if(string(__СумНДСИтКПк) == "")
          _InsertBFUnloadBadRec(_DocKind_BuyAdd, "", date(0, 0, 0), "Итоговая сумма налога по книге покупок");
        end;
        if(string(__СумНДСИтП1Р8) == "")
          _InsertBFUnloadBadRec(_DocKind_BuyAdd, "", date(0, 0, 0), "СумНДСИтП1Р8");
        end;
        
        _PrintLnANSI("   <СумНДСИтКПк>" + __СумНДСИтКПк + "</СумНДСИтКПк>");
        _PrintLnANSI("   <СумНДСИтП1Р8>" + __СумНДСИтП1Р8 + "</СумНДСИтП1Р8>");
      
        _BilBEUnloadIntoFileRecs_Buy(_DocKind_BuyAdd);
      
        _PrintLnANSI("   </КнигаПокупДЛ>");
        
      end;
      
      _PrintLnANSI(" </Документ>");
      
      _PrintLnANSI("</Файл>");
      
      setoutput(null);
      
      _InsertBFUnloadLog(_DocKind_BuyAdd, UnloadFileName, Count - 1/*без учета записи с t_BookEntryID = 0*/, "");
    elif(CheckRes == 1)
      _InsertBFUnloadLog(_DocKind_BuyAdd, "", 0, "СумНДСИтКПк = СумНДСВсКПк");
    elif(CheckRes == 2)
      _InsertBFUnloadLog(_DocKind_BuyAdd, "", 0, "СумНалПокуп = СтоимТовСНалВс - СтоимТовБНалВс");
    end;
  end;
end;

private macro _GetBilBooksByDirection_BuyAdd(DateFrom, DateTo, DprtID)
  var sqlStr = "";
  var rs;
  var params : TArray;
  var BookID;
  var BeginDate;
  var EndDate;

  rs = _GetBilBooksTypeForOpenCloseDate(DateFrom, DateTo, 2);
  
  while(rs and rs.moveNext())
    BookID = int(rs.value(0));
    BeginDate = date(rs.value(1));
    EndDate = date(rs.value(2));

    _FillBilBEUnload_BuyAdd(BookID, BeginDate, IfThenElse(EndDate == date(0, 0, 0), {curdate}, EndDate), DprtID);
  end;

  _TruncTable("dbilbeunload_tmp");
  _CopyRowsToBilBEUnload();

  _BilBEUnloadIntoFile_BuyAdd();
end;

private macro _GetBilBooksByDirection_SaleAdd(DateFrom, DateTo, DprtID)
  var sqlStr = "";
  var rs;
  var params : TArray;
  var BookID;
  var BeginDate;
  var EndDate;

  rs = _GetBilBooksTypeForOpenCloseDate(DateFrom, DateTo, 1);
  
  while(rs and rs.moveNext())
    BookID = int(rs.value(0));
    BeginDate = date(rs.value(1));
    EndDate = date(rs.value(2));

    _FillBilBEUnload_SaleAdd(BookID, BeginDate, IfThenElse(EndDate == date(0, 0, 0), {curdate}, EndDate), DprtID);
  end;

  _TruncTable("dbilbeunload_tmp");
  _CopyRowsToBilBEUnload();

  _BilBEUnloadIntoFile_SaleAdd();
end;

private macro _GetBilSFJournalForOpenCloseDate(DateFrom, DateTo, Direction)
  var sqlStr = "";
  var rs;
  var params : TArray;

  sqlStr = sqlStr + "SELECT t_JournalID                       ";
  sqlStr = sqlStr + "  FROM dbilsfjournal_dbt                 ";
  sqlStr = sqlStr + " WHERE     t_JournalType = :JournalType  ";
  sqlStr = sqlStr + "       AND t_OpenDate >= :OpenDate       ";
  sqlStr = sqlStr + "       AND t_CloseDate <= :CloseDate     ";

  params = makeArray(SQLParam("JournalType", Direction)
                    ,SQLParam("OpenDate", DateFrom)
                    ,SQLParam("CloseDate", DateTo)
                    );
  rs = execSQLselect(sqlStr, params, true);

  return rs;
end;

private macro _AddRowsToBilSFUnload_DstBF(acssql_from, acssql_where, JournalID, BeginDate, EndDate, DprtID, Direction, SfTypeID)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilsfunload_tmp " +
              " (                    " +
              "   t_FacturaID          " +
              "  ,t_BEAmount           " +
              "  ,t_FICode             " +
              "  ,t_SrcFacturaID       " +
              "  ,t_SrcAssignment      " +
              "  ,t_SrcFacturaNumber   " +
              "  ,t_SrcCreationDate    " +
              "  ,t_SrcCorrectionNum   " +
              "  ,t_InitFacturaNumber  " +
              "  ,t_InitCreationDate   " +
              "  ,t_InitSupplierINN    " +
              " )                    " +
              " SELECT               " +
              "   bilfactura.t_FacturaID         " +
              "  ,bilbookentry.t_Amount           " +
              "  ,fi.t_ISO_Number        " +
              "  ,srcbf.t_FacturaID      " +
              "  ,srcbf.t_Assignment     " +
              "  ,srcbf.t_FacturaNumber  " +
              "  ,srcbf.t_CreationDate   " +
              "  ,srcbf.t_CorrectionNum  " +
              "  ,initbf.t_FacturaNumber " +
              "  ,initbf.t_CreationDate  " +
              "  ,initbf.t_SupplierINN   " +
              " FROM " +
              "   dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt srcbf " +
              "  ,dbilbookentry_dbt bilbookentry " +
              "  ,dfininstr_dbt fi " +
              "  ,dbilsftype_dbt ft " +
              "  ,dbilfactura_dbt initbf " +
              acssql_from +                                     
              " WHERE bilfactura.t_RegDate BETWEEN :BeginDate AND :EndDate " +
              " AND bilfactura.t_Direction = :Direction" +
              " AND bilfactura.t_JournalID = :JournalID " +
              " AND bilfactura.t_SourceFacturaID = srcbf.t_FacturaID(+) "+
              " AND bilfactura.t_FacturaID = bilbookentry.t_FacturaID(+) " +
              " AND bilfactura.t_SupplierFacturaID = initbf.t_FacturaID(+) " +
              " AND bilfactura.t_FIID = fi.t_FIID(+) "
              " AND bilfactura.t_SFTypeID = ft.t_SFTypeID "
              " AND ft.t_PostToJournal = 'X' " +
              " AND " + acssql_where; 
  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);
  i = params.size;
  params[i] = SQLParam("JournalID", JournalID);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilbookentry.t_Department = :DprtID ";
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  if(SfTypeID > 0)
    sqlString = sqlString + " AND bilfactura.t_SfTypeID = :SfTypeID ";
    i = params.size;
    params[i] = SQLParam("SfTypeID", SfTypeID);
  end;

  return execSQL(sqlString, params);

end;

/*5.2.11 Функция получения списка СФ*/
private macro _FillBilSFUnload(Direction, JournalID, BeginDate, EndDate, DprtID, SfTypeID)
  var acssql_where : string;
  var acssql_from : string; 
  var rs; 

  if(GetObjectRestriction(acssql_where, 111, {oper}, "bilbookentry", CNTX_BilBookEntry, "bilbookentry.dbt", acssql_from, true))
    if(acssql_from != "")
      acssql_from = " , " + acssql_from + " ";
    end;

    _AddRowsToBilSFUnload_DstBF(acssql_from, acssql_where, JournalID, BeginDate, EndDate, DprtID, Direction, SfTypeID);
  end;
end;

/*5.2.12 Функция определения стоимости товаров и суммы НДС по СФ*/
private macro _GetTotalWithNDSTotalNDS(TotalWithNDS : @string, TotalNDS : @string, rs)
  TotalWithNDS = "";
  TotalNDS = "";

  if(rs.value("t_Assignment") != OBJSFASSIGNMENT_RECALC)
    TotalWithNDS = string(money(rs.value("t_TotalWithNDS")));
    if(rs.value("t_IsNoNds") == "X")
      TotalNDS = "без НДС";
    else
      TotalNDS = string(money(rs.value("t_TotalNDS")));
    end;
  end;
end;

/*5.2.13 Функция определения разниц стоимости и налога по корректировочному СФ*/
private macro _GetSummas(PSumma_All : @string, MSumma_All : @string, PSumma_NDS : @string, MSumma_NDS : @string, rs)

  PSumma_All = "";
  MSumma_All = "";
  PSumma_NDS = "";
  MSumma_NDS = "";

  if(rs.value("t_Assignment") == OBJSFASSIGNMENT_RECALC)
    if(rs.value("t_TotalWithNDS") > 0)
      PSumma_All = string(money(rs.value("t_TotalWithNDS")));
    else
      MSumma_All = string(money(-rs.value("t_TotalWithNDS")));
    end;
    
    if(rs.value("t_TotalNDS") > 0)
      if(rs.value("t_IsNoNds") == "X")
        PSumma_NDS = "без НДС";
      else
        PSumma_NDS = string(money(rs.value("t_TotalNDS")));
      end;
    else
      if(rs.value("t_IsNoNds") == "X")
        MSumma_NDS = "без НДС";
      else
        MSumma_NDS = string(money(-rs.value("t_TotalNDS")));
      end;
    end;
  end;
end;

private macro _BilBEUnloadIntoFileRecs_DstBF
  var query = "";
  var rs;
  var rownum = 1;
  var FacturaNumbers;
  var CreationDates;
  var FacturaNumber;
  var CreationDate;
  var CorrectionNum;
  var CorrectionDate;
  var CountryCode;
  var GTDNumber;
  var PayNum = "";
  var PayDate;
  var ReceiverINN, SupplierINN;
  var TotalWithNDS, TotalNDS;
  var PSumma_All, MSumma_All, PSumma_NDS, MSumma_NDS;
  var sINN = "", sKPP = "";

  query = query + "SELECT ";
  query = query + "  t0.t_FacturaID                                              /* 0*/ ";
  query = query + " ,t0.t_BEAmount                                               /* 1*/ ";
  query = query + " ,t0.t_FICode                                                 /* 2*/ ";
  query = query + " ,t0.t_SrcFacturaID                                           /* 3*/ ";
  query = query + " ,t0.t_SrcAssignment                                          /* 4*/ ";
  query = query + " ,NVL(t0.t_SrcFacturaNumber, CHR(1))                         t_SrcFacturaNumber  /* 5*/ ";
  query = query + " ,NVL(t0.t_SrcCreationDate, TO_DATE('01010001','ddmmyyyy'))  t_SrcCreationDate   /* 6*/ ";
  query = query + " ,NVL(t0.t_SrcCorrectionNum, 0)                              t_SrcCorrectionNum  /* 7*/ ";
  query = query + " ,NVL(t0.t_InitFacturaNumber, CHR(1))                        t_InitFacturaNumber /* 8*/ ";
  query = query + " ,NVL(t0.t_InitCreationDate, TO_DATE('01010001','ddmmyyyy')) t_InitCreationDate  /* 9*/ ";
  query = query + " ,NVL(t0.t_InitSupplierINN, CHR(1))                          t_InitSupplierINN   /*10*/ ";
  query = query + " ,bilfactura.t_FacturaNumber                                          /*11*/ ";
  query = query + " ,bilfactura.t_CreationDate                                           /*12*/ ";
  query = query + " ,bilfactura.t_CorrectionNum                                          /*13*/ ";
  query = query + " ,bilfactura.t_Assignment                                             /*14*/ ";
  query = query + " ,bilfactura.t_ReceiverINN                                            /*15*/ ";
  query = query + " ,bilfactura.t_SfTypeID                                               /*16*/ ";
  query = query + " ,bilfactura.t_IsSupplierAgent                                        /*17*/ ";
  query = query + " ,bilfactura.t_SupplierFacturaID                                      /*18*/ ";
  query = query + " ,bilfactura.t_IsNoNds                                                /*19*/ ";
  query = query + " ,bilfactura.t_TotalWithNDS                                           /*20*/ ";
  query = query + " ,bilfactura.t_TotalNDS                                               /*21*/ ";
  query = query + " ,bilfactura.t_RegDate                                                /*22*/ ";
  query = query + "  FROM dbilsfunload_tmp t0, dbilfactura_dbt bilfactura            ";
  query = query + " WHERE bilfactura.t_FacturaID = t0.t_FacturaID                    ";
  query = query + " ORDER BY bilfactura.t_RegDate                                    ";

  rs = execSQLselect(query, null, true);
  while(rs and rs.moveNext())
    _PrintLnANSI("    <ЖУчВыстСчФСтр>");

    if(string(rownum) == "")
      _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Порядковый номер");
    end;
    _PrintLnANSI("     <НомерПор>" + rownum + "</НомерПор>");

    if(string(date(rs.value("t_CreationDate")):f) == "")
      _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата выставления");
    end;
    _PrintLnANSI("     <ДатаВыст>" + string(date(rs.value("t_CreationDate")):f) + "</ДатаВыст>");

    _GetBFFacturaNumbersCreationDates(@FacturaNumbers, @CreationDates, rs);
    if(string(FacturaNumbers) == "")
      _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Номер счета-фактуры");
    end;
    _PrintLnANSI("     <НомСчФПрод>" + FacturaNumbers + "</НомСчФПрод>");
    if(string(CreationDates) == "")
      _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата счета-фактуры");
    end;
    _PrintLnANSI("     <ДатаСчФПрод>" + CreationDates + "</ДатаСчФПрод>");

    if(rs.value("t_SrcCorrectionNum") != 0)
      _PrintLnANSI("     <НомИспрСчФ>" + rs.value("t_SrcCorrectionNum") + "</НомИспрСчФ>");
      _PrintLnANSI("     <ДатаИспрСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаИспрСчФ>");
    elif((rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY) and (rs.value("t_SrcAssignment") != OBJSFASSIGNMENT_RECALC))
      _PrintLnANSI("     <НомИспрСчФ>" + rs.value("t_CorrectionNum") + "</НомИспрСчФ>");
      _PrintLnANSI("     <ДатаИспрСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаИспрСчФ>");
    end;

    _GetBFFacturaNumberCreationDate_Correction(@FacturaNumber, @CreationDate, @CorrectionNum, @CorrectionDate, rs);
	
	if ((FacturaNumber != "") and (ValType(FacturaNumber) != V_UNDEF))
		_PrintLnANSI("     <НомКСчФПрод>" + FacturaNumber + "</НомКСчФПрод>");
	end;
	
	if ((ValType(CreationDate) != V_UNDEF) and (CreationDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаКСчФПрод>" + CreationDate + "</ДатаКСчФПрод>");
	end;
	
	if ((CorrectionNum != "") and (ValType(CorrectionNum) != V_UNDEF))
		_PrintLnANSI("     <НомИспрКСчФ>" + CorrectionNum + "</НомИспрКСчФ>");
	end;
	
	if ((ValType(CorrectionDate) != V_UNDEF) and (CorrectionDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаИспрКСчФ>" + CorrectionDate + "</ДатаИспрКСчФ>");
	end;

    if(string(_GetBilOprCodes(rs.value("t_FacturaID"))) == "")
      _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Код вида операции");
    end;
    _PrintLnANSI("     <КодВидОпер>" + _GetBilOprCodes(rs.value("t_FacturaID")) + "</КодВидОпер>");

    _PrintLnANSI("     <СвПокуп>");
    
    ReceiverINN = rs.value("t_ReceiverINN");
    
    if((strlen(ReceiverINN) == 12) and (index(ReceiverINN, "/") == 0))
      _PrintLnANSI("      <СведИП>");
      _PrintLnANSI("       <ИННФЛ>" + ReceiverINN + "</ИННФЛ>");
      _PrintLnANSI("      </СведИП>");
    else
		_PrintLnANSI("      <СведЮЛ>");
		SplitFullINN(ReceiverINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
		_PrintLnANSI("      </СведЮЛ>");
    end;
    
    _PrintLnANSI("     </СвПокуп>");
    
    _PrintLnANSI("     <СвПосрДеят>");
    
    if((rs.value("t_SfTypeID") == 6) and (rs.value("t_IsSupplierAgent") == "X") and (rs.value("t_SupplierFacturaID") > 0))
      if(string(rs.value("t_InitFacturaNumber")) == "")
        _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Номер счета-фактуры, полученного от продавца");
      end;
      if(string(date(rs.value("t_InitCreationDate")):f) == "")
        _InsertBFUnloadBadRec(_DocKind_DstBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата счета-фактуры, полученного от продавца");
      end;

      _PrintLnANSI("      <НомСчФОтПрод>" + rs.value("t_InitFacturaNumber") + "</НомСчФОтПрод>");
      _PrintLnANSI("      <ДатаСчФОтПрод>" + string(date(rs.value("t_InitCreationDate")):f) + "</ДатаСчФОтПрод>");
    end;
    
    _PrintLnANSI("     <ОКВ>" + rs.value("t_FICode") + "</ОКВ>");


    _GetTotalWithNDSTotalNDS(@TotalWithNDS, @TotalNDS, rs);

    _PrintLnANSI("     <СтоимТовСчФВс>" + TotalWithNDS + "</СтоимТовСчФВс>");
    _PrintLnANSI("     <СумНДССчФ>" + TotalNDS + "</СумНДССчФ>");

    _GetSummas(@PSumma_All, @MSumma_All, @PSumma_NDS, @MSumma_NDS, rs);

    _PrintLnANSI("     <РазСтКСчФУм>" + MSumma_All + "</РазСтКСчФУм>");
    _PrintLnANSI("     <РазСтКСчФУв>" + PSumma_All + "</РазСтКСчФУв>");
    _PrintLnANSI("     <РазНДСКСчФУм>" + MSumma_NDS + "</РазНДСКСчФУм>");
    _PrintLnANSI("     <РазНДСКСчФУв>" + PSumma_NDS + "</РазНДСКСчФУв>");

    if(rs.value("t_InitSupplierINN") != "")
      _PrintLnANSI("     <СвПрод>");
      
      SupplierINN = rs.value("t_InitSupplierINN");

      if((strlen(SupplierINN) == 12) and (index(SupplierINN, "/") == 0))
        _PrintLnANSI("      <СведИП>");
        _PrintLnANSI("       <ИННФЛ>" + SupplierINN + "</ИННФЛ>");
        _PrintLnANSI("      </СведИП>");
      else
		_PrintLnANSI("      <СведЮЛ>");
        SplitFullINN(SupplierINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
        _PrintLnANSI("      </СведЮЛ>");
      end;
      
      _PrintLnANSI("     </СвПрод>");
    end;
    
    _PrintLnANSI("     </СвПосрДеят>");

    _PrintLnANSI("    </ЖУчВыстСчФСтр>");
  
    rownum = rownum + 1;
  end;
end;

/*5.3.5 Функция выгрузки данных по журналу учета выданных СФ*/
private macro _BilBEUnloadIntoFile_DstBF()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilSFUnload();

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_DstBF, "", Count, "");
  else
    UnloadFileName = _FormUnloadFileName(_DocKind_DstBF);
    GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
    if(stat != 0) 
      UnloadFilePath = "..\\txtfile\\"; 
    end;
    if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
      UnloadFilePath = UnloadFilePath + "\\";
    end;

    FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";

    setoutput(FullUnloadFileName);

    _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");

    _PrintLnANSI("<Файл>");

    _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
    _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
    _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");

    _PrintLnANSI(" <Документ>");

    _PrintLnANSI("  <Индекс>0000100</Индекс>");
    _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	
	if (bilfunloadparam.CorrectNum != 0)
		_PrintLnANSI("  <ПризнСвед10>" + bilfunloadparam.Actuality + "</ПризнСвед10>");
	end;

    if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))

      _PrintLnANSI("   <ЖУчВыстСчФ>");

      _BilBEUnloadIntoFileRecs_DstBF();

      _PrintLnANSI("   </ЖУчВыстСчФ>");
      
    end;

    _PrintLnANSI(" </Документ>");
    
    _PrintLnANSI("</Файл>");

    setoutput(null);


    _InsertBFUnloadLog(_DocKind_DstBF, UnloadFileName, Count, "");
  end;
end;

private macro _КодВидСд(DealKind)
  var query = "";
  var rs;
  var retValue = "";

  query = query + "SELECT t_Code ";
  query = query + "  FROM dllvalues_dbt WHERE t_List = 2760 AND t_Element = " + DealKind;

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    retValue = rs.value(0);
  end;
  return retValue;
end;

private macro _BilBEUnloadIntoFileRecs_ObtBF
  var query = "";
  var rs;
  var rownum = 1;
  var FacturaNumbers;
  var CreationDates;
  var FacturaNumber;
  var CreationDate;
  var CorrectionNum;
  var CorrectionDate;
  var CountryCode;
  var GTDNumber;
  var PayNum = "";
  var PayDate;
  var ReceiverINN, SupplierINN;
  var TotalWithNDS, TotalNDS;
  var PSumma_All, MSumma_All, PSumma_NDS, MSumma_NDS;
  var SubAgentName, SubAgentINN;
  var sINN = "", sKPP = "";

  query = query + "SELECT ";
  query = query + "  t0.t_FacturaID                                              /* 0*/ ";
  query = query + " ,t0.t_BEAmount                                               /* 1*/ ";
  query = query + " ,t0.t_FICode                                                 /* 2*/ ";
  query = query + " ,t0.t_SrcFacturaID                                           /* 3*/ ";
  query = query + " ,t0.t_SrcAssignment                                          /* 4*/ ";
  query = query + " ,NVL(t0.t_SrcFacturaNumber, CHR(1))                         t_SrcFacturaNumber  /* 5*/ ";
  query = query + " ,NVL(t0.t_SrcCreationDate, TO_DATE('01010001','ddmmyyyy'))  t_SrcCreationDate   /* 6*/ ";
  query = query + " ,NVL(t0.t_SrcCorrectionNum, 0)                              t_SrcCorrectionNum  /* 7*/ ";
  query = query + " ,NVL(t0.t_InitFacturaNumber, CHR(1))                        t_InitFacturaNumber /* 8*/ ";
  query = query + " ,NVL(t0.t_InitCreationDate, TO_DATE('01010001','ddmmyyyy')) t_InitCreationDate  /* 9*/ ";
  query = query + " ,NVL(t0.t_InitSupplierINN, CHR(1))                          t_InitSupplierINN   /*10*/ ";
  query = query + " ,bilfactura.t_FacturaNumber                                          /*11*/ ";
  query = query + " ,bilfactura.t_CreationDate                                           /*12*/ ";
  query = query + " ,bilfactura.t_CorrectionNum                                          /*13*/ ";
  query = query + " ,bilfactura.t_Assignment                                             /*14*/ ";
  query = query + " ,bilfactura.t_ReceiverINN                                            /*15*/ ";
  query = query + " ,bilfactura.t_SfTypeID                                               /*16*/ ";
  query = query + " ,bilfactura.t_IsSupplierAgent                                        /*17*/ ";
  query = query + " ,bilfactura.t_SupplierFacturaID                                      /*18*/ ";
  query = query + " ,bilfactura.t_IsNoNds                                                /*19*/ ";
  query = query + " ,bilfactura.t_TotalWithNDS                                           /*20*/ ";
  query = query + " ,bilfactura.t_TotalNDS                                               /*21*/ ";
  query = query + " ,bilfactura.t_DealKind                                               /*22*/ ";
  query = query + " ,bilfactura.t_SupplierINN                                            /*23*/ ";
  query = query + " ,bilfactura.t_RegDate                                                /*24*/ ";
  query = query + "  FROM dbilsfunload_tmp t0, dbilfactura_dbt bilfactura            ";
  query = query + " WHERE bilfactura.t_FacturaID = t0.t_FacturaID                    ";
  query = query + " ORDER BY bilfactura.t_RegDate                                    ";

  rs = execSQLselect(query, null, true);
  while(rs and rs.moveNext())
    _PrintLnANSI("    <ЖУчПолучСчФСтр>");

    if(string(rownum) == "")
      _InsertBFUnloadBadRec(_DocKind_ObtBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Порядковый номер");
    end;
    _PrintLnANSI("     <НомерПор>" + rownum + "</НомерПор>");

    if(string(date(rs.value("t_CreationDate")):f) == "")
      _InsertBFUnloadBadRec(_DocKind_ObtBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата получения");
    end;
    _PrintLnANSI("     <ДатаПолуч>" + string(date(rs.value("t_CreationDate")):f) + "</ДатаПолуч>");

    _GetBFFacturaNumbersCreationDates(@FacturaNumbers, @CreationDates, rs);
    if(string(FacturaNumbers) == "")
      _InsertBFUnloadBadRec(_DocKind_ObtBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Номер счета-фактуры");
    end;
    if(string(FacturaNumbers) == "")
      _InsertBFUnloadBadRec(_DocKind_ObtBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата счета-фактуры");
    end;
    _PrintLnANSI("     <НомСчФПрод>" + FacturaNumbers + "</НомСчФПрод>");
    _PrintLnANSI("     <ДатаСчФПрод>" + CreationDates + "</ДатаСчФПрод>");

    if(rs.value("t_SrcCorrectionNum") != 0)
      _PrintLnANSI("     <НомИспрСчФ>" + rs.value("t_SrcCorrectionNum") + "</НомИспрСчФ>");
      _PrintLnANSI("     <ДатаИспрСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаИспрСчФ>");
    elif((rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY) and (rs.value("t_SrcAssignment") != OBJSFASSIGNMENT_RECALC))
      _PrintLnANSI("     <НомИспрСчФ>" + rs.value("t_CorrectionNum") + "</НомИспрСчФ>");
      _PrintLnANSI("     <ДатаИспрСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаИспрСчФ>");
    end;

    _GetBFFacturaNumberCreationDate_Correction(@FacturaNumber, @CreationDate, @CorrectionNum, @CorrectionDate, rs);
	if ((FacturaNumber != "") and (ValType(FacturaNumber) != V_UNDEF))
		_PrintLnANSI("     <НомКСчФПрод>" + FacturaNumber + "</НомКСчФПрод>");
	end;
	
	if ((ValType(CreationDate) != V_UNDEF) and (CreationDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаКСчФПрод>" + CreationDate + "</ДатаКСчФПрод>");
	end;
	
	if ((CorrectionNum != "") and (ValType(CorrectionNum) != V_UNDEF))
		_PrintLnANSI("     <НомИспрКСчФ>" + CorrectionNum + "</НомИспрКСчФ>");
	end;
	
	if ((ValType(CorrectionDate) != V_UNDEF) and (CorrectionDate != ZeroValue (V_DATE)))
		_PrintLnANSI("     <ДатаИспрКСчФ>" + CorrectionDate + "</ДатаИспрКСчФ>");
	end;

    if(rs.value("t_DealKind") != 0)
      if(string(_КодВидСд(rs.value("t_DealKind"))) == "")
        _InsertBFUnloadBadRec(_DocKind_ObtBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Код вида сделки");
      end;
      _PrintLnANSI("     <КодВидСд>" + _КодВидСд(rs.value("t_DealKind")) + "</КодВидСд>");
    end;

    _PrintLnANSI("     <ОКВ>" + rs.value("t_FICode") + "</ОКВ>");

    _GetTotalWithNDSTotalNDS(@TotalWithNDS, @TotalNDS, rs);

    _PrintLnANSI("     <СтоимТовСчФВс>" + TotalWithNDS + "</СтоимТовСчФВс>");
    _PrintLnANSI("     <СумНДССчФ>" + TotalNDS + "</СумНДССчФ>");

    _GetSummas(@PSumma_All, @MSumma_All, @PSumma_NDS, @MSumma_NDS, rs);

    _PrintLnANSI("     <РазСтКСчФУм>" + MSumma_All + "</РазСтКСчФУм>");
    _PrintLnANSI("     <РазСтКСчФУв>" + PSumma_All + "</РазСтКСчФУв>");
    _PrintLnANSI("     <РазНДСКСчФУм>" + MSumma_NDS + "</РазНДСКСчФУм>");
    _PrintLnANSI("     <РазНДСКСчФУв>" + PSumma_NDS + "</РазНДСКСчФУв>");
    
    if(string(_GetBilOprCodes(rs.value("t_FacturaID"))) == "")
      _InsertBFUnloadBadRec(_DocKind_ObtBF, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Код вида операции");
    end;
    _PrintLnANSI("     <КодВидОпер>" + _GetBilOprCodes(rs.value("t_FacturaID")) + "</КодВидОпер>");

    if(rs.value("t_SupplierINN") != "")
      _PrintLnANSI("     <СвПрод>");
      
      SupplierINN = rs.value("t_SupplierINN");

      if((strlen(SupplierINN) == 12) and (index(SupplierINN, "/") == 0))
        _PrintLnANSI("      <СведИП>");
        _PrintLnANSI("       <ИННФЛ>" + SupplierINN + "</ИННФЛ>");
        _PrintLnANSI("      </СведИП>");
      else
		_PrintLnANSI("      <СведЮЛ>");
        SplitFullINN(SupplierINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
		_PrintLnANSI("      </СведЮЛ>");
      end;
      
      _PrintLnANSI("     </СвПрод>");
    end;
    
    SubAgentName = "";
    SubAgentINN = "";

    _GetBilFAgentPtNameINN(true, rs.value("t_FacturaID"), 1, @SubAgentName, @SubAgentINN);

    if(SubAgentINN != "")
      _PrintLnANSI("     <СвКомис>");
      
      if((strlen(SubAgentINN) == 12) and (index(SubAgentINN, "/") == 0))
        _PrintLnANSI("      <СведИП>");
        _PrintLnANSI("       <ИННФЛ>" + SupplierINN + "</ИННФЛ>");
        _PrintLnANSI("      </СведИП>");
      else
		_PrintLnANSI("      <СведЮЛ>");
        SplitFullINN(SupplierINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
        _PrintLnANSI("      </СведЮЛ>");
      end;
      
      _PrintLnANSI("     </СвКомис>");
    end;

    _PrintLnANSI("    </ЖУчПолучСчФСтр>");
  
    rownum = rownum + 1;
  end;
end;

private macro _BilBEUnloadIntoFileRecs_BF173
  var query = "";
  var rs;
  var rownum = 1;
  var FacturaNumbers;
  var CreationDates;
  var FacturaNumber;
  var CreationDate;
  var CorrectionNum;
  var CorrectionDate;
  var CountryCode;
  var GTDNumber;
  var PayNum = "";
  var PayDate;
  var ReceiverINN, SupplierINN;
  var TotalWithNDS, TotalNDS;
  var PSumma_All, MSumma_All, PSumma_NDS, MSumma_NDS;
  var SubAgentName, SubAgentINN;
  var sINN = "", sKPP = "";

  query = query + "SELECT ";
  query = query + "  t0.t_FacturaID                                              /* 0*/ ";
  query = query + " ,t0.t_BEAmount                                               /* 1*/ ";
  query = query + " ,t0.t_FICode                                                 /* 2*/ ";
  query = query + " ,t0.t_SrcFacturaID                                           /* 3*/ ";
  query = query + " ,t0.t_SrcAssignment                                          /* 4*/ ";
  query = query + " ,NVL(t0.t_SrcFacturaNumber, CHR(1))                         t_SrcFacturaNumber  /* 5*/ ";
  query = query + " ,NVL(t0.t_SrcCreationDate, TO_DATE('01010001','ddmmyyyy'))  t_SrcCreationDate   /* 6*/ ";
  query = query + " ,NVL(t0.t_SrcCorrectionNum, 0)                              t_SrcCorrectionNum  /* 7*/ ";
  query = query + " ,NVL(t0.t_InitFacturaNumber, CHR(1))                        t_InitFacturaNumber /* 8*/ ";
  query = query + " ,NVL(t0.t_InitCreationDate, TO_DATE('01010001','ddmmyyyy')) t_InitCreationDate  /* 9*/ ";
  query = query + " ,NVL(t0.t_InitSupplierINN, CHR(1))                          t_InitSupplierINN   /*10*/ ";
  query = query + " ,bilfactura.t_FacturaNumber                                          /*11*/ ";
  query = query + " ,bilfactura.t_CreationDate                                           /*12*/ ";
  query = query + " ,bilfactura.t_CorrectionNum                                          /*13*/ ";
  query = query + " ,bilfactura.t_Assignment                                             /*14*/ ";
  query = query + " ,bilfactura.t_ReceiverINN                                            /*15*/ ";
  query = query + " ,bilfactura.t_SfTypeID                                               /*16*/ ";
  query = query + " ,bilfactura.t_IsSupplierAgent                                        /*17*/ ";
  query = query + " ,bilfactura.t_SupplierFacturaID                                      /*18*/ ";
  query = query + " ,bilfactura.t_IsNoNds                                                /*19*/ ";
  query = query + " ,bilfactura.t_TotalWithNDS                                           /*20*/ ";
  query = query + " ,bilfactura.t_TotalNDS                                               /*21*/ ";
  query = query + " ,bilfactura.t_DealKind                                               /*22*/ ";
  query = query + " ,bilfactura.t_SupplierINN                                            /*23*/ ";
  query = query + " ,bilfactura.t_TotalAmount                                            /*24*/ ";
  query = query + " ,bilfactura.t_RegDate                                                /*25*/ ";
  query = query + "  FROM dbilsfunload_tmp t0, dbilfactura_dbt bilfactura            ";
  query = query + " WHERE bilfactura.t_FacturaID = t0.t_FacturaID                    ";
  query = query + " ORDER BY bilfactura.t_RegDate                                    ";

  rs = execSQLselect(query, null, true);
  while(rs and rs.moveNext())
    _PrintLnANSI("    <ВыстСчФ_173.5>");

    if(string(rs.value("t_FacturaNumber")) == "")
      _InsertBFUnloadBadRec(_DocKind_BF173, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Номер счета-фактуры");
    end;
    _PrintLnANSI("     <НомСчФ>" + rs.value("t_FacturaNumber") + "</НомСчФ>");

    if(rs.value("t_Assignment") == OBJSFASSIGNMENT_MODIFY)
      if(string(date(rs.value("t_SrcCreationDate")):f) == "")
        _InsertBFUnloadBadRec(_DocKind_BF173, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата счета-фактуры");
      end;
      _PrintLnANSI("     <ДатаСчФ>" + string(date(rs.value("t_SrcCreationDate")):f) + "</ДатаСчФ>");
    else
      if(string(date(rs.value("t_CreationDate")):f) == "")
        _InsertBFUnloadBadRec(_DocKind_BF173, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Дата счета-фактуры");
      end;
      _PrintLnANSI("     <ДатаСчФ>" + string(date(rs.value("t_CreationDate")):f) + "</ДатаСчФ>");
    end;

    _PrintLnANSI("     <ОКВ>" + rs.value("t_FICode") + "</ОКВ>");

    if(rs.value("t_Assignment") == OBJSFASSIGNMENT_PREPAYMENT)
      _PrintLnANSI("     <СтоимТовБНалВс>-</СтоимТовБНалВс>");
    else
      if(string(rs.value("t_TotalAmount")) == "")
        _InsertBFUnloadBadRec(_DocKind_BF173, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Стоимость товаров (работ, услуг), имущественных прав без налога - всего");
      end;
      _PrintLnANSI("     <СтоимТовБНалВс>" + rs.value("t_TotalAmount") + "</СтоимТовБНалВс>");
    end;

    if(rs.value("t_IsNoNds") == "X")
      _PrintLnANSI("     <СумНалПокуп>без НДС</СумНалПокуп>");
    else
      if(string(rs.value("t_TotalNDS")) == "")
        _InsertBFUnloadBadRec(_DocKind_BF173, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Сумма налога, предъявляемая покупателю");
      end;
      _PrintLnANSI("     <СумНалПокуп>" + rs.value("t_TotalNDS") + "</СумНалПокуп>");
    end;

    if(string(rs.value("t_TotalWithNDS")) == "")
      _InsertBFUnloadBadRec(_DocKind_BF173, rs.value("t_FacturaNumber"), rs.value("t_RegDate"), "Стоимость товаров (работ, услуг), имущественных прав с налогом - всего");
    end;
    _PrintLnANSI("     <СтоимТовСНалВс>" + rs.value("t_TotalWithNDS") + "</СтоимТовСНалВс>");

    _PrintLnANSI("     <СвПокуп>");
    
    ReceiverINN = rs.value("t_ReceiverINN");
    
    if((strlen(ReceiverINN) == 12) and (index(ReceiverINN, "/") == 0))
      _PrintLnANSI("      <СведИП>");
      _PrintLnANSI("       <ИННФЛ>" + ReceiverINN + "</ИННФЛ>");
      _PrintLnANSI("      </СведИП>");
    else
		_PrintLnANSI("      <СведЮЛ>");
		SplitFullINN(ReceiverINN, sINN, sKPP);
		_PrintLnANSI("       <ИННЮЛ>" + sINN + "</ИННЮЛ>");
		_PrintLnANSI("       <КПП>" + sKPP + "</КПП>");
      _PrintLnANSI("      </СведЮЛ>");
    end;
    
    _PrintLnANSI("     </СвПокуп>");

    _PrintLnANSI("    </ВыстСчФ_173.5>");
  
    rownum = rownum + 1;
  end;
end;

/*5.3.6 Функция выгрузки данных по журналу учета полученных СФ*/
private macro _BilBEUnloadIntoFile_ObtBF()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilSFUnload();

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_ObtBF, "", Count, "");
  else
    UnloadFileName = _FormUnloadFileName(_DocKind_ObtBF);
    GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
    if(stat != 0) 
      UnloadFilePath = "..\\txtfile\\"; 
    end;
    if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
      UnloadFilePath = UnloadFilePath + "\\";
    end;

    FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";

    setoutput(FullUnloadFileName);

    _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");

    _PrintLnANSI("<Файл>");

    _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
    _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
    _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");

    _PrintLnANSI(" <Документ>");

    _PrintLnANSI("  <Индекс>0000110</Индекс>");
    _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	
	if (bilfunloadparam.CorrectNum)
		_PrintLnANSI("  <ПризнСвед11>" + bilfunloadparam.Actuality + "</ПризнСвед11>");
	end;

    if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))

      _PrintLnANSI("   <ЖУчПолучСчФ>");

      _BilBEUnloadIntoFileRecs_ObtBF();

      _PrintLnANSI("   </ЖУчПолучСчФ>");
      
    end;

    _PrintLnANSI(" </Документ>");
    
    _PrintLnANSI("</Файл>");

    setoutput(null);


    _InsertBFUnloadLog(_DocKind_ObtBF, UnloadFileName, Count, "");
  end;
end;

private macro _Check_BF173()
  var query = "";
  var rs;

  query = query + "SELECT ";
  query = query + "  t0.t_FacturaID                                             ";
  query = query + " ,bilfactura.t_TotalWithNDS                                          ";
  query = query + " ,bilfactura.t_TotalNDS                                              ";
  query = query + " ,bilfactura.t_TotalAmount                                           ";
  query = query + "  FROM dbilsfunload_tmp t0, dbilfactura_dbt bilfactura               ";
  query = query + " WHERE bilfactura.t_FacturaID = t0.t_FacturaID                       ";
  query = query + "   AND bilfactura.t_TotalNDS <> bilfactura.t_TotalWithNDS - bilfactura.t_TotalAmount ";

  rs = execSQLselect(query, null, true);
  if(rs and rs.moveNext())
    return 1;
  end;
  return 0;
end;

/*5.3.7 Функция выгрузки данных по выставленным СФ согласно п.5 ст. 173 НКРФ*/
private macro _BilBEUnloadIntoFile_BF173()
  var stat;
  var UnloadFileName;
  var UnloadFilePath;
  var FullUnloadFileName;
  var Count = _CountBilSFUnload();
  var CheckRes = 0;

  if(Count == 0)
    _InsertBFUnloadLog(_DocKind_BF173, "", 0, "");
  else

    CheckRes = _Check_BF173();
    if(CheckRes == 0)
      UnloadFileName = _FormUnloadFileName(_DocKind_BF173);
      GetRegistryValue("CB\\BILLFACT\\ВЫГРУЗКА_ДАННЫХ_ДЛЯ_ДЕКЛАРАЦИИ\\ПУТЬ_К_КАТАЛОГУ_ВЫГРУЗКИ_ФАЙЛОВ", V_STRING, UnloadFilePath, stat);
      if(stat != 0) 
        UnloadFilePath = "..\\txtfile\\"; 
      end;
      if(substr(UnloadFilePath, strlen(UnloadFilePath)) != "\\")
        UnloadFilePath = UnloadFilePath + "\\";
      end;
   
      FullUnloadFileName = UnloadFilePath + UnloadFileName + ".xml";
   
      setoutput(FullUnloadFileName);
   
      _PrintLnANSI("<?xml version=\"1.0\" encoding=\"windows-1251\"?>");
   
      _PrintLnANSI("<Файл>");
   
      _PrintLnANSI(" <ИдФайл>" + UnloadFileName + "</ИдФайл>");
      _PrintLnANSI(" <ВерсПрог>RS-Bank " + _GetDBVersion() + "</ВерсПрог>");
      _PrintLnANSI(" <ВерсФорм>5.04</ВерсФорм>");
   
      _PrintLnANSI(" <Документ>");
   
      _PrintLnANSI("  <Индекс>0000120</Индекс>");
      _PrintLnANSI("  <НомКорр>" + bilfunloadparam.CorrectNum + "</НомКорр>");
	  
	  if (bilfunloadparam.CorrectNum != 0)
		_PrintLnANSI("  <ПризнСвед12>" + bilfunloadparam.Actuality + "</ПризнСвед12>");
	  end;
   
      if((bilfunloadparam.CorrectNum == 0) or (bilfunloadparam.Actuality == 0))
   
        _BilBEUnloadIntoFileRecs_BF173();
        
      end;
   
      _PrintLnANSI(" </Документ>");
      
      _PrintLnANSI("</Файл>");
   
      setoutput(null);
   
      _InsertBFUnloadLog(_DocKind_BF173, UnloadFileName, Count, "");
    elif(CheckRes == 1)
      _InsertBFUnloadLog(_DocKind_BF173, "", 0, "СумНалПокуп = СтоимТовСНалВс - СтоимТовБНалВс");
    end;
  end;
end;

private macro _GetDstBF()
  var sqlStr = "";
  var rs;
  var params : TArray;
  var JournalID;
  var BeginDate;
  var EndDate;

  rs = _GetBilSFJournalForOpenCloseDate(bilfunloadparam.DateFrom, bilfunloadparam.DateTo, 1);
  
  while(rs and rs.moveNext())
    JournalID = int(rs.value(0));
    BeginDate = date(rs.value(0));
    EndDate = date(rs.value(0));

    _FillBilSFUnload(1, JournalID, bilfunloadparam.DateFrom, 
                     bilfunloadparam.DateTo, bilfunloadparam.DprtID, 
                     IfThenElse(bilfunloadparam.DstBFLoadType == 2, 6/*СФ посредника*/, 0));
  end;

  _BilBEUnloadIntoFile_DstBF();
end;

private macro _GetObtBF()
  var sqlStr = "";
  var rs;
  var params : TArray;
  var JournalID;
  var BeginDate;
  var EndDate;

  rs = _GetBilSFJournalForOpenCloseDate(bilfunloadparam.DateFrom, bilfunloadparam.DateTo, 2);
  
  while(rs and rs.moveNext())
    JournalID = int(rs.value(0));
    BeginDate = date(rs.value(0));
    EndDate = date(rs.value(0));

    _FillBilSFUnload(2, JournalID, bilfunloadparam.DateFrom, 
                     bilfunloadparam.DateTo, bilfunloadparam.DprtID, 
                     IfThenElse(bilfunloadparam.ObtBFLoadType == 2, 6/*СФ посредника*/, 0));
  end;

  _BilBEUnloadIntoFile_ObtBF();
end;

private macro _AddRowsToBilSFUnload_BF173(acssql_from, acssql_where, BeginDate, EndDate, DprtID, Direction, NotPostedToJournal)
  var sqlString;
  var rs;
  var params = TArray;
  var i;

  sqlString = " INSERT INTO dbilsfunload_tmp " +
              " (                    " +
              "   t_FacturaID          " +
              "  ,t_BEAmount           " +
              "  ,t_FICode             " +
              "  ,t_SrcFacturaID       " +
              "  ,t_SrcAssignment      " +
              "  ,t_SrcFacturaNumber   " +
              "  ,t_SrcCreationDate    " +
              "  ,t_SrcCorrectionNum   " +
              "  ,t_InitFacturaNumber  " +
              "  ,t_InitCreationDate   " +
              "  ,t_InitSupplierINN    " +
              " )                    " +
              " SELECT               " +
              "   bilfactura.t_FacturaID         " +
              "  ,NULL                   " +
              "  ,fi.t_ISO_Number        " +
              "  ,srcbf.t_FacturaID      " +
              "  ,srcbf.t_Assignment     " +
              "  ,NULL                   " +
              "  ,srcbf.t_CreationDate   " +
              "  ,NULL                   " +
              "  ,NULL                   " +
              "  ,NULL                   " +
              "  ,NULL                   " +
              " FROM " +
              "   dbilfactura_dbt bilfactura " +
              "  ,dbilfactura_dbt srcbf " +
              "  ,dfininstr_dbt fi " +
              acssql_from +                                     
              " WHERE bilfactura.t_RegDate BETWEEN :BeginDate AND :EndDate " +
              " AND bilfactura.t_Direction = :Direction" +
              " AND bilfactura.t_SourceFacturaID = srcbf.t_FacturaID(+) "+
              " AND bilfactura.t_FIID = fi.t_FIID(+) "
              " AND " + acssql_where; 

  if(NotPostedToJournal)
    sqlString = sqlString + " AND bilfactura.t_JournalID = 0 ";
  end;

  i = params.size;
  params[i] = SQLParam("BeginDate", BeginDate);
  i = params.size;
  params[i] = SQLParam("EndDate", EndDate);
  i = params.size;
  params[i] = SQLParam("Direction", Direction);

  if(DprtID != 0)
    sqlString = sqlString + " AND bilfactura.t_Department = :DprtID ";
    i = params.size;
    params[i] = SQLParam("DprtID", DprtID);
  end;

  return execSQL(sqlString, params);
end;

/*5.2.14 Функция получения данных по СФ*/
private macro _FillBilSFUnload_BF173(Direction, BeginDate, EndDate, DprtID, NotPostedToJournal)
  var acssql_where : string;
  var acssql_from : string; 
  var rs; 

  if(GetObjectRestriction(acssql_where, 111, {oper}, "bilfactura", CNTX_BilBookEntry, "bilfactura.dbt", acssql_from, true))
    if(acssql_from != "")
      acssql_from = " , " + acssql_from + " ";
    end;

    _AddRowsToBilSFUnload_BF173(acssql_from, acssql_where, BeginDate, EndDate, DprtID, Direction, NotPostedToJournal);
  end;
end;

private macro _GetBF173()
  var sqlStr = "";
  var rs;
  var params : TArray;
  var JournalID;
  var BeginDate;
  var EndDate;

  _FillBilSFUnload_BF173(2, bilfunloadparam.DateFrom, 
                         bilfunloadparam.DateTo, bilfunloadparam.DprtID, 
                         IfThenElse(bilfunloadparam.BF173LoadType == 2, true, false));

  
  _BilBEUnloadIntoFile_BF173();
end;

macro RunUnload(param)
  setbuff(bilfunloadparam, param);

  _TruncTable("dbfunloadlog_tmp");
  _TruncTable("dbfunloadbadrec_tmp");

  if(bilfunloadparam.LoadBuyBBE == "X")
    _TruncTable("dbilbeunload_tmp");
    _GetBilBooksByDirection_Buy(bilfunloadparam.DateFrom, bilfunloadparam.DateTo, bilfunloadparam.DprtID);
  end;
  if(bilfunloadparam.LoadBuyAddBBE == "X")
    _TruncTable("dbilbeaddunload_tmp");
    _GetBilBooksByDirection_BuyAdd(bilfunloadparam.DateFrom, bilfunloadparam.DateTo, bilfunloadparam.DprtID);
  end;
  if(bilfunloadparam.LoadSaleBBE == "X")
    _TruncTable("dbilbeunload_tmp");
    _GetBilBooksByDirection_Sale(bilfunloadparam.DateFrom, bilfunloadparam.DateTo, bilfunloadparam.DprtID);
  end;
  if(bilfunloadparam.LoadSaleAddBBE == "X")
    _TruncTable("dbilbeaddunload_tmp");
    _GetBilBooksByDirection_SaleAdd(bilfunloadparam.DateFrom, bilfunloadparam.DateTo, bilfunloadparam.DprtID);
  end;

  if(bilfunloadparam.DstBFLoadType > 0)
    _TruncTable("dbilsfunload_tmp");
    _GetDstBF();
  end;
  if(bilfunloadparam.ObtBFLoadType > 0)
    _TruncTable("dbilsfunload_tmp");
    _GetObtBF();
  end;
  if(bilfunloadparam.BF173LoadType > 0)
    _TruncTable("dbilsfunload_tmp");
    _GetBF173();
  end;

  _PrintProtocol();
end;