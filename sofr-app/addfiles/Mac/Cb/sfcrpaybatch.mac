/**                                                                                                             
 @file sfcrpaybatch.mac                                                                                           
 @brief РКО (ПЗО): Макрос формирования документов оплаты по УК
                                                                                                                
 #tag                                                                                                          
 - functional_block:Ядро ГКБО                
 - functional_block:ПЗО                                                                                                                                          
 - code_type:API 
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2024.01.26 |Жиц М.В.       |BOSS-2118           |BIQ-14887. Корректировка описания проводки начисления/оплаты по инвест. советнику                                      
 |2024.01.16 |Жиц М.В.       |DEF-59858           |BIQ-14887. Код ЕКК не указан в проводке начисления\оплаты комиссии                                      
 |2023.12.12 |Жиц М.В.       |BIQ-14887           |Реализация обработки комиссии "ИнвестСоветник"                                      
 |?          |?              |?                   |Создание                                                                                                                                                                                                                                                            
*/ 

import "sfcommon.mac", "sfpay_lib.mac", "sfground.mac", "sfpay.mac", "sfacctrnbatch.mac", "sfbatch_lib.mac", "sfdefopr.mac";
import dlcontrfunc, dl_car;
import "role_model.mac";//ролевая модель

record ClientAccVUCred( account );
record ClientAccVUDeb( account );

Private macro Sf_IsInstalledRKO()
  return false;
end;

class DLContrFixComACCData(SfcontrID, AccDate)
  class SFContrAccData()
    var SFUse = False;
    var DLContrID = 0;
    var SFContrID = 0;
    var SFServkind = 0;
    var SFServkindSub = 0;
    var SFMarketID = 0;
    var AccPayer = "";
    var Account47423:string = "";
    var Account458:string = "";
    var RestAcc:money = 0;
    var PaySUM:money = 0;
 
    private macro GetClientAccount(dogid, CatID, fiid) 
      var sql, cmd, rs, Birgacc = "";
      var AccBuf = TRecHandler("account");
      AccBuf.Clear();

      sql = " select mc.* from dsfcontr_dbt sf, dmcaccdoc_dbt mc where sf.t_id = ? and MC.T_CATID = ? and mc.t_iscommon = 'X' and mc.t_clientcontrid = sf.t_id and mc.t_currency = ?";
      cmd = RSDCommand(sql);
      cmd.AddParam("dogid", RSDBP_IN, dogid);
      cmd.AddParam("BirgId", RSDBP_IN, CatID);
      cmd.AddParam("fiid", RSDBP_IN, fiid);

      rs = RSDRecordSet(cmd);
      if(rs.MoveNext())
        Birgacc = rs.value("t_account");
      end;

      return Birgacc;
    end;
 
    macro init(pDLContrID, pSFContrID, pSFServkind, pSFServkindSub, pSFMarketID, carryDate)
      SFUse = True;
      DLContrID = pDLContrID;
      SFContrID = pSFContrID;
      SFServkind = pSFServkind;
      SFServkindSub = pSFServkindSub;
      SFMarketID = pSFMarketID;
 
      AccPayer = GetClientAccount(pSFContrID, 70/*ДС клиента, ц/б*/, 0);
      RestAcc = RestAC(AccPayer, NATCUR/*PayFiid*/, date(carryDate), NULL, 1); 

      if((SFServkind == 1) and (SFServkindSub == 8) and (SFMarketID == 2)) //Инициализируем значения только для ФР ММВБ, т.к. в другие всё равно не используются
        Account47423 = GetClientAccount(pSFContrID, 818/*+РасчетыКомисс1*/, 0);
        Account458 = GetClientAccount(pSFContrID, 1055/*Треб. с н.с. брок*/, 0);
      end;
    end;
  end;

  var EDP = False;
  var SFMMVBData = SFContrAccData();
  var SFSPBData  = SFContrAccData();
  var SFCURData  = SFContrAccData();
  var SFFXData   = SFContrAccData();
  var SFOutData  = SFContrAccData();
  var unLimitSum = 0;
 
  macro GetAccDataArr()
    var Arr = TArray();
    if(SFMMVBData.SFUse)
      Arr(Arr.Size) = SFMMVBData;
    end;
 
    if(SFCURData.SFUse)
      Arr(Arr.Size) = SFCURData;
    end;

    if(SFOutData.SFUse)
      Arr(Arr.Size) = SFOutData;
    end;
 
    if(SFFXData.SFUse)
      Arr(Arr.Size) = SFFXData;
    end;
 
    if(SFSPBData.SFUse)
      Arr(Arr.Size) = SFSPBData;
    end;
 
    return Arr;
  end;

  private macro ДоговорЕДП(dlcontrid, sfcontrid)
    var cmd, DataSet;
    var sql = "";
  
    sql =  " SELECT 1 \n" +
           "  FROM dsfcontr_dbt s, dobjatcor_dbt a \n" +
           " WHERE     s.t_servkindsub = 8 \n" +
           "       AND a.t_objecttype = 659 \n" +
           "       AND a.t_groupid = 102 \n" +
           "       AND a.t_attrid = 1 \n" +
           "       AND a.t_object = LPAD (s.t_id, 10, '0') \n" ;
  
    if((ValType(dlcontrid) != V_UNDEF) and (dlcontrid > 0))
      sql = sql + "       AND s.t_id IN (SELECT t_sfcontrid \n" +
                  "                        FROM ddlcontrmp_dbt \n" +
                  "                       WHERE t_dlcontrid = ?) \n";
      cmd = DL_RSDCommand(sql); 
      cmd.AddParam(dlcontrid);  
    else
      sql = sql +  "      AND s.t_id = ?  \n";
      cmd = DL_RSDCommand(sql); 
      cmd.AddParam(sfcontrid);
    end;
  
    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      return true;
    end;

    return false;
  end;
 
  macro CalcPaySum(SumForDistrib)
    var TotalSum:money = SumForDistrib;

    var TempPaySum;

    if (TotalSum > 0) 
      if(SFMMVBData.RestAcc < TotalSum)
        SFMMVBData.PaySum = SFMMVBData.RestAcc;
        TotalSum = TotalSum - SFMMVBData.RestAcc;
      else 
        SFMMVBData.PaySum = TotalSum; 
        TotalSum = 0;
      end;  
    end;

    if((TotalSum > 0) and (SFCURData.SFUse))
      if(SFCURData.RestAcc < TotalSum)
        SFCURData.PaySum = SFCURData.RestAcc;
        TotalSum = TotalSum - SFCURData.RestAcc;
      else
        SFCURData.PaySum = TotalSum; 
        TotalSum = 0;
      end;
    end;

    if((TotalSum > 0) and (SFOutData.SFUse))
      if(SFOutData.RestAcc < TotalSum)
        SFOutData.PaySum = SFOutData.RestAcc;
        TotalSum = TotalSum - SFOutData.RestAcc;
      else
        SFOutData.PaySum = TotalSum; 
        TotalSum = 0;
      end;
    end;

    if((TotalSum > 0) and (SFFXData.SFUse))
      if(SFFXData.RestAcc < TotalSum)
        SFFXData.PaySum = SFFXData.RestAcc;
        TotalSum = TotalSum - SFFXData.RestAcc;
      else
        SFFXData.PaySum = TotalSum; 
        TotalSum = 0;
      end;
    end;

    if((TotalSum > 0) and (SFSPBData.SFUse))
      if(SFSPBData.RestAcc < TotalSum)
        SFSPBData.PaySum = SFSPBData.RestAcc;
        TotalSum = TotalSum - SFSPBData.RestAcc;
      else
        SFSPBData.PaySum = TotalSum; 
        TotalSum = 0;
      end;
    end;

    if(TotalSum > 0)
      unLimitSum = TotalSum;
    end;
  end;

  private macro init(SfContrID, AccDate)
    private var sql, cmd, rs;
    /*конструктор*/
    if(ДоговорЕДП(0, SFContrID))
      EDP = True;   
    end;
    
    sql = "select mp1.t_dlcontrid, " + 
          "       mp1.t_sfcontrid, " +  
          "       mp1.t_marketid, " + 
          "       sfc.t_servkind, " + 
          "       sfc.t_servkindsub " + 
          "  from ddlcontrmp_dbt mp, ddlcontrmp_dbt mp1, dsfcontr_dbt sfc " +
          " where mp.t_sfcontrid = ? " + 
          "   and mp1.t_dlcontrid = mp.t_dlcontrid " + 
          "   and sfc.t_id = mp1.t_sfcontrid ";
    cmd = DL_RSDCommand();
    cmd.AddParam(SFContrID);
    rs = cmd.Execute(sql);

    while(rs.movenext)      
      if((rs.servkind == 1) and (rs.servkindsub == 8) and (rs.marketid == 2)) // ММВБ фондовый
        SFMMVBData.Init(rs.DLContrID, rs.SFContrID, rs.Servkind, rs.ServKindSub, rs.MarketID, AccDate);
      elif((not EDP) and (rs.servkind == 1) and (rs.servkindsub == 8) and (rs.marketid == 151337)) // СПБ фондовый
        SFSPBData.Init(rs.DLContrID, rs.SFContrID, rs.Servkind, rs.ServKindSub, rs.MarketID, AccDate);
      elif((not EDP) and (rs.servkind == 21) and (rs.servkindsub == 8) and (rs.marketid == 2)) // Валютный
        SFCURData.Init(rs.DLContrID, rs.SFContrID, rs.Servkind, rs.ServKindSub, rs.MarketID, AccDate);
      elif((not EDP) and (rs.servkind == 15) and (rs.servkindsub == 8) and (rs.marketid == 2)) // Срочный
        SFFXData.Init(rs.DLContrID, rs.SFContrID, rs.Servkind, rs.ServKindSub, rs.MarketID, AccDate);
      elif((rs.servkind == 1) and (rs.servkindsub == 9) and (rs.marketid == -1)) // Внебиржа
        SFOutData.Init(rs.DLContrID, rs.SFContrID, rs.Servkind, rs.ServKindSub, rs.MarketID, AccDate);
      end;  
    end;
  end;

  init(SfContrID, AccDate);
end;

macro UpdateSfDefSum(sfdefArray)
  var stat = 0;
  var nArray = sfdefArray.size();
  var i = 0;
  var sfdefsumhistCache = RsbSQLInsert("sfdefsumhist.dbt");

  var DefIDArray      = TArray;
  var FeeTypeArray    = TArray;

  var sizea = 0;
  while( i < nArray )
    var IndexSfDefArray = i;
    if((sfdefArray[IndexSfDefArray].IsNDSSumReset == true ) AND (sfdefArray[IndexSfDefArray].Error == 0))
      var sfdefsumhist = TRecHandler("sfdefsumhist.dbt");
      ClearRecord( sfdefsumhist );

      sfdefsumhist.rec.FeeType     = sfdefArray[IndexSfDefArray].sfdef.rec.FeeType;
      sfdefsumhist.rec.ID          = sfdefArray[IndexSfDefArray].sfdef.rec.ID;
      sfdefsumhist.rec.OperationID = sfdefArray[IndexSfDefArray].oprID_Operation;
      sfdefsumhist.rec.StepID      = sfdefArray[IndexSfDefArray].oprID_Step;
      sfdefsumhist.rec.Sum         = sfdefArray[IndexSfDefArray].sfdef.rec.Sum;
      sfdefsumhist.rec.SumNDS      = sfdefArray[IndexSfDefArray].sfdef.rec.SumNDS;
      
      sfdefsumhistCache.AddRecord( sfdefsumhist );

      var IncDocID = String(sfdefArray[IndexSfDefArray].sfdef.rec.FeeType:5)+String(sfdefArray[IndexSfDefArray].sfdef.rec.ID:10);
      IncDocID = StrSubst( IncDocID, " ", "0" );
      AddDocumentToStepMass(2007, IncDocID, sfdefArray[IndexSfDefArray].oprID_Operation, sfdefArray[IndexSfDefArray].oprID_Step); // SFDEF_SUM_HIST       = 2007

      DefIDArray[i]      = sfdefArray[IndexSfDefArray].sfdef.rec.ID;
      FeeTypeArray[i]    = sfdefArray[IndexSfDefArray].sfdef.rec.FeeType;

      sizea = sizea + 1;
    end;
    i = i + 1;
  end;

  if(sizea > 0)
    if(not sfdefsumhistCache.Insert())
      stat = 1;
    end;
  end;

  if(sizea > 0)
    var strSql = "UPDATE dsfdef_dbt SET t_Sum = t_Sum + t_SumNDS, t_SumNDS = 0 WHERE t_FeeType = ? and t_ID = ?" ;

    var upd = RsbSQLInsert(strSql, 2, sizea );
    upd.AddParam( V_INTEGER, FeeTypeArray );
    upd.AddParam( V_INTEGER, DefIDArray   );

    if(not upd.Insert())
      stat = 1;
    end;
  end;

  return stat;
end;

private macro SfFormDocumentsBatch(sfdefArray, sfrepaccCache, SfSrvDoc)
  var stat:integer = 0;
  var cmd, rs, strSql;
  var accTrnData;

  // Для сохранения ошибок
  var ErrorStatusArray  = TArray;
  var ErrorMessageArray = TArray; 
  var DocKindArray      = TArray;
  var DocumentIDArray   = TArray;

  var BankID = {OurBank};
  var OperDprt = {OperDprt};

  // Получить свободный остаток на счете плательщика с учетом претензий
  strSql = "UPDATE dsfpaydoc_tmp tmp " +
           "SET tmp.t_FreeRest = RSI_RsbAccTransaction.AccGetFreeAmountEx( tmp.t_PayerAccount, 1, tmp.t_PayerFIID, tmp.t_DateCarry, -1, 0, 0 ) " ;

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.execute();   

  // Получить свободный остаток с учетом картотек
  strSql = "UPDATE dsfpaydoc_tmp tmp " +
           "SET tmp.t_FreeRest = tmp.t_FreeRest +" +
           "  (SELECT NVL(SUM(ind.t_Sum),0) FROM dpsindacc_dbt ind " +
           "    WHERE ind.t_account = tmp.t_PayerAccount " +
           "    AND ind.t_chapter = 1 AND ind.t_fiid = tmp.t_PayerFIID) ";

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.execute();   

  // Перевести суммы комиссии и НДС в нужные валюты
  // Сумму свободного остатка в валюту счетов по КУ, если получатель наш банк и комиссия начислена:
  strSql = " UPDATE dsfpaydoc_tmp tmp " +
           " SET tmp.t_ConvFreeRest = " +
           " RSI_RSB_FIInstr.ConvSum( tmp.t_FreeRest, tmp.t_PayerFIID, tmp.t_FIIDPaySum, tmp.t_DateCarry, 0 ) ";
 
  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.execute();   

  // Суммы оплаты комиссии и ее НДС в  валюту счетов по КУ
  strSql = " UPDATE dsfpaydoc_tmp tmp                                                                                         " +
           " SET tmp.t_ConvPaySum =                                                                                           " +
           "       RSI_RSB_FIInstr.ConvSumType( tmp.t_PaySum, tmp.t_FIIDSum, tmp.t_FIIDPaySum, t_RateType, tmp.t_DateCarry, 0 ), " +
           "     tmp.t_ConvTaxSum =                                                                                           " +
           "       RSI_RSB_FIInstr.ConvSumType( tmp.t_TaxSum, tmp.t_FIIDSum, tmp.t_FIIDPaySum, t_RateType, tmp.t_DateCarry, 0 )  " +
           " WHERE tmp.t_FIIDSum <> tmp.t_FIIDPaySum                                                                             " ;

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.execute();   

  // Сумму комиссии в валюту счета получателя, если получатель не наши банк или по комиссии не было начисления:
  strSql = " UPDATE dsfpaydoc_tmp tmp                                                                                 " +
           " SET tmp.t_ConvPaySum =                                                                                   " +
           "       RSI_RSB_FIInstr.ConvSum( tmp.t_ConvPaySum, tmp.t_FIIDPaySum, tmp.t_ReceiverFIID, tmp.t_DateCarry, 0 ) " +
           " WHERE tmp.t_FIIDPaySum <> tmp.t_ReceiverFIID                                                                " +
           "   AND (tmp.t_ReceiverID != ? OR tmp.t_IsIncluded != 'X')                                          " ;

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, BankID );
  cmd.execute();   

  // Сумму НДС комиссии из валюты счета по КУ в нац. валюту для проводки учета НДС:
  strSql = " UPDATE dsfpaydoc_tmp tmp                                                                      " +
           " SET tmp.t_ConvTaxSumNC =                                                                      " +
           "       RSI_RSB_FIInstr.ConvSum( tmp.t_ConvTaxSum, tmp.t_FIIDPaySum, ?, tmp.t_DateCarry, 0 )       " +
           " WHERE tmp.t_FIIDPaySum <> ?                                                                      " ;

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, NATCUR );
  cmd.addParam( "", RSDBP_IN, NATCUR );
  cmd.execute();   

  strSql = " UPDATE dsfpaydoc_tmp tmp " +
           " SET tmp.t_Error = ?, " +
           "     tmp.t_ErrMsg = ? " +
           " WHERE t_ConvFreeRest < (t_ConvPaySum + t_ConvTaxSum) " +
           "   AND NOT EXISTS(SELECT ac.t_accountid FROM daccount_dbt ac " +
           "                  WHERE ac.t_account = tmp.t_PayerAccount AND ac.t_chapter = 1 AND ac.t_code_currency = tmp.t_PayerFIID " +
           "                  AND ac.t_Type_Account LIKE ('%Ф%')) "; 

  cmd = RsdCommand( strSql );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, 1 );
  cmd.addParam( "", RSDBP_IN, "Недостаточно средств на счете плательщика. Формирование проводки оплаты невозможно." );
  cmd.execute();   
         
  var IsBankOrderForComm = bBankorderForComm_Setting();

  var sfdefAccTrnCharger = TSfDefAccTrnDataCharger();

  strSql = " SELECT defcom.t_conid, paydoc.*, NVL(ground.t_Ground, chr(1)) As groundVO, payeracc.t_Department As PayerDprt, recacc.t_Department As RecDprt, fininstr.t_Ccy As fiidCCY, " +
           "        DECODE(paydoc.t_RateType,0, RSI_RSB_FIInstr.ConvSum(paydoc.t_PaySum + paydoc.t_TaxSum , paydoc.t_FIIDSum, paydoc.t_FIIDPaySum, paydoc.t_DateCarry, 0 ), "
           "                                    RSI_RSB_FIInstr.ConvSumType(paydoc.t_PaySum + paydoc.t_TaxSum , paydoc.t_FIIDSum, paydoc.t_FIIDPaySum, paydoc.t_RateType, paydoc.t_DateCarry, 0 )) As ConvTotalSum, " +
           "        RSI_RSB_FIInstr.ConvSum(paydoc.t_ConvTaxSum , paydoc.t_FIIDPaySum, paydoc.t_PayerFIID, paydoc.t_DateCarry, 0 ) As ConvTaxSumPayer " +
           " FROM dsfpaydoc_tmp paydoc, dsfground_tmp ground, daccount_dbt payeracc, daccount_dbt recacc, dfininstr_dbt fininstr, dsfdefcom_dbt defcom" + 
           " WHERE paydoc.t_SfDefID = ground.t_SfDefID(+) " + 
           " AND payeracc.t_Account = paydoc.t_PayerAccount " + 
           " AND payeracc.t_Chapter = 1 " + 
           " AND payeracc.t_Code_Currency = paydoc.t_PayerFIID " + 
           " AND recacc.t_Account = paydoc.t_ReceiverAccount " + 
           " AND recacc.t_Chapter = 1 " + 
           " AND recacc.t_Code_Currency = paydoc.t_ReceiverFIID " +
           " AND fininstr.t_FIID = paydoc.t_FIIDSum AND defcom.t_ID = paydoc.t_sfdefid"; 

   cmd = RsdCommand( strSql ); 
   cmd.NullConversion = true;

   cmd.execute();   
   var i = 0;
   rs = RsdRecordset( cmd ); 
   while( rs.moveNext() )
     var ErrorNum = rs.value("t_Error"); 
     var ErrorMsg = rs.value("t_ErrMsg"); 
     var SfDefArrayIndex = rs.value("t_ArrayIndex");

     if(ErrorNum != 0)
       sfdefArray[SfDefArrayIndex].Error = ErrorNum;
       // Сформировать соответствующую запись для отчета sfrepacc.tmp.
       var sfrepacc = TRecHandler ("sfrepacc.tmp");
       ClearRecord( sfrepacc );
                                                                 
       sfrepacc.rec.debit           = rs.value("t_PayerAccount");
       sfrepacc.rec.credit          = rs.value("t_CalcAccount");  //счет кредита проводки
       sfrepacc.rec.BeginDate       = sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin;
       sfrepacc.rec.EndDate         = sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd  ;
       sfrepacc.rec.TransactionDate = rs.value("t_DateCarry"); 
       sfrepacc.rec.Amount          = rs.value("t_ConvPaySum") + rs.value("t_ConvTaxSum");
       sfrepacc.rec.ContrID         = sfdefArray[SfDefArrayIndex].SfDef.rec.SfContrID    ;
       sfrepacc.rec.FeeType         = SF_FEE_TYPE_PERIOD;                                ;
       sfrepacc.rec.ComissNumber    = sfdefArray[SfDefArrayIndex].SfDef.rec.CommNumber   ;
       sfrepacc.rec.Comment         = ErrorMsg;
       sfrepacc.rec.ErrorCode       = ErrorNum;
       sfrepacc.rec.SfDefcomID      = rs.value("t_SfDefID");
       sfrepacc.rec.Kind            = 1;
       sfrepacc.rec.Department      = sfdefArray[SfDefArrayIndex].SfDef.rec.Department   ;

       if(sfrepaccCache != NULL)
         sfrepaccCache.AddRecord( sfrepacc );
       end;

       // Для сохранения ошибок в doprtemp_tmp
       ErrorStatusArray[ErrorStatusArray.size]   = ErrorNum;
       ErrorMessageArray[ErrorMessageArray.size] = ErrorMsg;
       DocKindArray[DocKindArray.size]           = 51;
       var DocID = String(rs.value("t_SfDefID"):34);
       DocID = StrSubst( DocID, " ", "0" );
       DocumentIDArray[DocumentIDArray.size]     = DocID;

     else
       var PayerID    = rs.value("t_PayerID");
       var ReceiverID = rs.value("t_ReceiverID");
       var IsIncluded = rs.value("t_IsIncluded");

       var CalcNDSAccount = rs.value("t_CalcNDSAccount");
       var CalcAccount    = rs.value("t_CalcAccount");
       var TaxSum         = round(money(rs.value("t_TaxSum")));
       var ConvTaxSum     = round(money(rs.value("t_ConvTaxSum")));
       var ConvTotalSum   = round(money(rs.value("ConvTotalSum")));
       var ConvTaxSumPayer = round(money(rs.value("ConvTaxSumPayer")));

       var GroundVO   = rs.value("groundVO" );
       var ComissCode = rs.value("t_ComissCode");
       var fiidCCY    = rs.value("fiidCCY");

       var SfDefID         = rs.value("t_SfDefID");
       var OperationID     = rs.value("t_OperationID"); 
       var StepID          = rs.value("t_StepID");

       sfdefAccTrnCharger.SetPoint();

       // Если получатель комиссии "Наш банк" и комиссия учтена в доход 
       if((ReceiverID == BankID) AND (IsIncluded == "X"))

         // Если счета начисления НДС "+Расчеты НДС[, НВПИ]" и комиссии "+Расчеты[, НВПИ]" совпадают и комиссия облагается НДС;
         if((CalcNDSAccount == CalcAccount) AND (ConvTaxSum != $0))
           accTrnData = RsbAccTransactionData();

           accTrnData.Chapter = 1;
           accTrnData.Date_Carry    = rs.value("t_DateCarry");
           accTrnData.ResultCarry = SFPAY_CARRY;

           accTrnData.Department   = OperDprt;

           accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
           accTrnData.AccountPayer    = rs.value("t_PayerAccount");

           accTrnData.FIIDReceiver    = rs.value("t_CalcFIID");
           accTrnData.AccountReceiver = rs.value("t_CalcAccount");
           accTrnData.SumReceiver     = rs.value("t_ConvPaySum") + rs.value("t_ConvTaxSum");

           accTrnData.Ground       = trim(string(GroundVO) + " " + "Оплата комиссии " + ComissCode + ". В том числе НДС " + TaxSum + " " + fiidCCY + ".");

           if(IsBankOrderForComm == true)
             accTrnData.Shifr_Oper = SF_SHIFR_OPER_BANK_ORDER;
           end;

           sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);
         else  // Иначе (счета начисления комиссии и НДС не совпадают или комиссия не облагается НДС (t_ConvTaxSum равно 0 )):
           if((StrUpr(ComissCode) == "БРОКЕРФИКС") OR (StrUpr(ComissCode) == "ИНВЕСТСОВЕТНИК"))
             var pSFContrID = GetSfIDFromSFDEF(rs.value("t_SFDefID"));
             var FD, errtxt;

             var retvalGetMO = GetMainOperInGroup(159);
             if(retvalGetMO <= 0)
               retvalGetMO = {Oper};
             end;

             if(pSFContrID != 0)
               var tst = DLContrFixComACCData(pSFContrID, rs.value("t_DateCarry"));
               var AccountNachComm:string = "";

               tst.CalcPaySum(rs.value("ConvTotalSum") );
                                
               if((tst.unLimitSum > 0) and (not sfdefArray[SfDefArrayIndex].IsPayFromCFT))
                 ErrorNum = 1;
                 ErrorMsg = "Не хватает средств для списания комиссии с брокерских счетов клиента";
                 sfdefArray[SfDefArrayIndex].Error = ErrorNum;
                 // Сформировать соответствующую запись для отчета sfrepacc.tmp.
                 sfrepacc = TRecHandler ("sfrepacc.tmp");
                 ClearRecord( sfrepacc );
                                                                           
                 sfrepacc.rec.debit           = rs.value("t_PayerAccount");
                 sfrepacc.rec.credit          = rs.value("t_CalcAccount");  //счет кредита проводки
                 sfrepacc.rec.BeginDate       = sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin;
                 sfrepacc.rec.EndDate         = sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd  ;
                 sfrepacc.rec.TransactionDate = rs.value("t_DateCarry"); 
                 sfrepacc.rec.Amount          = rs.value("t_ConvPaySum") + rs.value("t_ConvTaxSum");
                 sfrepacc.rec.ContrID         = sfdefArray[SfDefArrayIndex].SfDef.rec.SfContrID    ;
                 sfrepacc.rec.FeeType         = SF_FEE_TYPE_PERIOD;                                ;
                 sfrepacc.rec.ComissNumber    = sfdefArray[SfDefArrayIndex].SfDef.rec.CommNumber   ;
                 sfrepacc.rec.Comment         = ErrorMsg;
                 sfrepacc.rec.ErrorCode       = ErrorNum;
                 sfrepacc.rec.SfDefcomID      = rs.value("t_SfDefID");
                 sfrepacc.rec.Kind            = 1;
                 sfrepacc.rec.Department      = sfdefArray[SfDefArrayIndex].SfDef.rec.Department   ;
                 sfrepacc.rec.contrid         = rs.value("t_conid");
                 sfrepacc.rec.contrnum        = GetNameDBO(rs.value("t_conid"));

                 if(sfrepaccCache != NULL)
                   sfrepaccCache.AddRecord( sfrepacc );
                 end;

                 // Для сохранения ошибок в doprtemp_tmp
                 ErrorStatusArray[ErrorStatusArray.size] = ErrorNum;
                 ErrorMessageArray[ErrorMessageArray.size] = ErrorMsg;
                 DocKindArray[DocKindArray.size] = 51;
                 DocID = StrSubst(String(rs.value("t_SfDefID"):34), " ", "0");
                 DocumentIDArray[DocumentIDArray.size] = DocID;

               elif(not sfdefArray[SfDefArrayIndex].IsPayFromCFT)
                 var AccArr = tst.GetAccDataArr();
                 var AccArrEn = AccArr.createEnum;

                 while(AccArrEn.next)
                   if((AccArrEn.item.SFServkind == 1) and (AccArrEn.item.SFServkindSub == 8) and (AccArrEn.item.SFMarketID == 2))
                     if(SfDefIsDebtOverdue(sfdefArray[SfDefArrayIndex].SfDef.rec.FeeType, sfdefArray[SfDefArrayIndex].SfDef.rec.ID))
                       AccountNachComm = AccArrEn.Item.Account458; 
                     else
                       AccountNachComm = AccArrEn.Item.Account47423;
                     end;
                   end;

                   if((AccArrEn.Item.AccPayer != "") and (AccountNachComm != "") and (AccArrEn.Item.PaySum > 0))
                     accTrnData = RsbAccTransactionData();
                     accTrnData.Chapter         = 1;
                     accTrnData.Number_Pack     = 10;
                     accTrnData.Oper            = retvalGetMO;
                     accTrnData.Date_Carry      = rs.value("t_DateCarry");
                     accTrnData.ResultCarry     = SFPAY_CARRY;
                     accTrnData.Department      = OperDprt;
                     accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
                     accTrnData.AccountPayer    = AccArrEn.Item.AccPayer;
                     accTrnData.FIIDReceiver    = rs.value("t_ReceiverFIID");
                     accTrnData.AccountReceiver = AccountNachComm;
                     accTrnData.SumPayer        = AccArrEn.Item.PaySum;
                     accTrnData.Shifr_Oper      = SF_SHIFR_OPER_BANK_ORDER;

                     if(StrUpr(ComissCode) == "ИНВЕСТСОВЕТНИК")
                       accTrnData.Ground = "Оплата комиссии за услугу по инвест консультированию ";
                       if(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin)) == GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)))
                         accTrnData.Ground = accTrnData.Ground + "за " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)));
                       else
                         accTrnData.Ground = accTrnData.Ground + "c " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin))) + " по " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)));
                       end;
                       accTrnData.Ground = accTrnData.Ground + " " + string(GetNameMonthRP(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + " " + string(GetYear(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + 
                                           " по брок.дог. " + GetNameDBO(AccArrEn.item.SFContrID) +" от "+ GetDateDBO(AccArrEn.item.SFContrID) + ", клиент - " + GetFIO(rs.value("t_PayerID")) + ", EKK - " + GetEKKDBO(AccArrEn.item.SFContrID);
                     else //БРОКЕРФИКС
                       accTrnData.Ground = trim("Оплата ежемесячной комиссии по договору " + GetNameDBO(AccArrEn.item.SFContrID) + " за " + string(GetNameMonth(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + " " + string(GetYear(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) );
                     end;
                     sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);
                   end;

                   //ВУ
                   FD = DL_SubContrFD(AccArrEn.Item.SFContrID);
                   ClearRecord(ClientAccVUCred);
                   ClearRecord(ClientAccVUDeb);
                   var ErrAcc = false;

                   if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccVUCred, rs.value("t_DateCarry"), rs.value("t_PayerFIID") ))
                     errtxt = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                     msgbox(errtxt);
                     ErrAcc = True;
                   end;
                   if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccVUDeb, rs.value("t_DateCarry"), rs.value("t_PayerFIID") ))
                     errtxt = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
                     msgbox(errtxt);
                     ErrAcc = True;
                   end;

                   if((not ErrAcc) and (AccArrEn.Item.PaySum > 0)) 
                     accTrnData = RsbAccTransactionData();
                     accTrnData.Chapter         = ClientAccVUCred.Chapter;
                     accTrnData.Oper            = retvalGetMO;
                     accTrnData.Date_Carry      = rs.value("t_DateCarry");
                     accTrnData.ResultCarry     = SFPAY_CARRY;
                     accTrnData.Department      = OperDprt;
                     accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
                     accTrnData.AccountPayer    = ClientAccVUDeb.Account;
                     accTrnData.FIIDReceiver    = rs.value("t_ReceiverFIID");
                     accTrnData.AccountReceiver = ClientAccVUCred.Account;
                     accTrnData.SumPayer        = AccArrEn.Item.PaySum;
                     accTrnData.Shifr_Oper      = SF_SHIFR_OPER_BANK_ORDER;

                     if(StrUpr(ComissCode) == "ИНВЕСТСОВЕТНИК")
                       accTrnData.Ground = "Оплата комиссии за услугу по инвест консультированию ";
                       if(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin)) == GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)))
                         accTrnData.Ground = accTrnData.Ground + "за " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)));
                       else
                         accTrnData.Ground = accTrnData.Ground + "c " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin))) + " по " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)));
                       end;
                       accTrnData.Ground = accTrnData.Ground + " " + string(GetNameMonthRP(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + " " + string(GetYear(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + 
                                           " по брок.дог. " + GetNameDBO(AccArrEn.item.SFContrID) +" от "+ GetDateDBO(AccArrEn.item.SFContrID) + ", клиент - " + GetFIO(rs.value("t_PayerID")) + ", EKK - " + GetEKKDBO(AccArrEn.item.SFContrID);
                     else //БРОКЕРФИКС
                       accTrnData.Ground = trim("Оплата ежемесячной комиссии по договору " + GetNameDBO(AccArrEn.item.SFContrID) + " за " + string(GetNameMonth(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + " " + string(GetYear(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) );
                     end;
                     sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);
                   end;
                 end;
               else // Оплата со счета ЦФТ
                 if(SfDefIsDebtOverdue(sfdefArray[SfDefArrayIndex].SfDef.rec.FeeType, sfdefArray[SfDefArrayIndex].SfDef.rec.ID))
                   AccountNachComm = tst.SFMMVBData.Account458; 
                 else
                   AccountNachComm = tst.SFMMVBData.Account47423;
                 end;

                 accTrnData = RsbAccTransactionData();
                 accTrnData.Chapter         = 1;
                 accTrnData.Number_Pack     = 10;
                 accTrnData.Oper            = retvalGetMO;
                 accTrnData.Date_Carry      = rs.value("t_DateCarry");
                 accTrnData.ResultCarry     = SFPAY_CARRY;
                 accTrnData.Department      = OperDprt;
                 accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
                 accTrnData.AccountPayer    = sfdefArray[SfDefArrayIndex].AccountCFT;
                 accTrnData.FIIDReceiver    = rs.value("t_ReceiverFIID");
                 accTrnData.AccountReceiver = AccountNachComm;
                 accTrnData.SumPayer        = rs.value("ConvTotalSum");
                 accTrnData.Shifr_Oper      = SF_SHIFR_OPER_BANK_ORDER;
                 accTrnData.UserField2      = "1"; //Не выгружать проводку

                 accTrnData.Ground = "Безакцептное списание задолженности по комиссии брокера, согласно п. 5.8 Регламента 15-Р. ";
                 if(StrUpr(ComissCode) == "ИНВЕСТСОВЕТНИК")
                   accTrnData.Ground = accTrnData.Ground + "за услугу по инвест консультированию ";
                   if(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin)) == GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)))
                     accTrnData.Ground = accTrnData.Ground + "за " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)));
                   else
                     accTrnData.Ground = accTrnData.Ground + "c " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodBegin))) + " по " + string(GetDay(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd)));
                   end;
                   accTrnData.Ground = accTrnData.Ground + " " + string(GetNameMonthRP(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + " " + string(GetYear(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + 
                                       " по Соглашению " + GetNameDBO(sfdefArray[SfDefArrayIndex].SfDef.rec.SfContrID) + " от " + GetDateDBO(sfdefArray[SfDefArrayIndex].SfDef.rec.SfContrID) + ". НДС не облагается.";
                 else //БРОКЕРФИКС
                   accTrnData.Ground = accTrnData.Ground + "по Соглашению " + GetNameDBO(sfdefArray[SfDefArrayIndex].SfDef.rec.SfContrID) + " от " + GetDateDBO(sfdefArray[SfDefArrayIndex].SfDef.rec.SfContrID) + 
                                       " за " + string(GetNameMonth(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + " " + string(GetYear(date(sfdefArray[SfDefArrayIndex].SfDef.rec.DatePeriodEnd))) + ". НДС не облагается.";
                 end;
                 sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);
               end;
             end;
           else
             accTrnData = RsbAccTransactionData();
         
             accTrnData.Chapter = 1;
             accTrnData.Date_Carry    = rs.value("t_DateCarry");
             accTrnData.ResultCarry = SFPAY_CARRY;
         
             accTrnData.Department   = OperDprt;
         
             accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
             accTrnData.AccountPayer    = rs.value("t_PayerAccount");
         
             accTrnData.FIIDReceiver    = rs.value("t_CalcFIID");
             accTrnData.AccountReceiver = rs.value("t_CalcAccount");
         
            // Условие обнуления суммы НДС УК
             if((TaxSum != $0) AND ((ConvTaxSum == $0) OR (ConvTaxSumPayer == $0)))
               accTrnData.SumReceiver  = rs.value("ConvTotalSum");
             else
               accTrnData.SumReceiver = rs.value("t_ConvPaySum");
             end;
         
             accTrnData.Ground          = trim(GroundVO + " " + "Оплата комиссии " + ComissCode +".");
         
             if(IsBankOrderForComm == true)
               accTrnData.Shifr_Oper = SF_SHIFR_OPER_BANK_ORDER;
             end;
         
             sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);
         
             // Условие обнуления суммы НДС УК
             if((TaxSum != $0) AND ((ConvTaxSum == $0) OR (ConvTaxSumPayer == $0)))
               sfdefArray[SfDefArrayIndex].IsNDSSumReset = true;
             end;
         
             // Если комиссия облагается НДС(t_ConvTaxSum не равно 0), то выполнить проводку по оплате НДС
             if(((ConvTaxSum != $0) AND (ConvTaxSumPayer != $0)))
               accTrnData = RsbAccTransactionData();
         
               accTrnData.Chapter = 1;
               accTrnData.Date_Carry    = rs.value("t_DateCarry");
               accTrnData.ResultCarry = SFPAY_CARRY;
         
               accTrnData.Department   = OperDprt;
         
               accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
               accTrnData.AccountPayer    = rs.value("t_PayerAccount");
         
               accTrnData.FIIDReceiver    = rs.value("t_CalcFIID");
               accTrnData.AccountReceiver = rs.value("t_CalcNDSAccount");
               accTrnData.SumReceiver     = rs.value("t_ConvTaxSum");
               accTrnData.Ground       = trim(GroundVO + " " +  "Оплата НДС комиссии " + ComissCode +".");
         
               if(IsBankOrderForComm == true)
                 accTrnData.Shifr_Oper = SF_SHIFR_OPER_BANK_ORDER;
               end;
         
               sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_NDSPAY, 0, OperationID, StepID);
             end;
           end;
         end;

         if((ConvTaxSum != $0) AND (rs.value("t_ConvTaxSumNC") != $0) AND (ConvTaxSumPayer != $0))
           accTrnData = RsbAccTransactionData();

           accTrnData.Chapter = 1;
           accTrnData.Date_Carry    = rs.value("t_DateCarry");
           accTrnData.ResultCarry = SFPAY_CARRY;

           accTrnData.Department   = OperDprt;

           accTrnData.FIIDPayer       = rs.value("t_CalcFIID");
           accTrnData.AccountPayer    = rs.value("t_MinusNDSAcrAccount");

           accTrnData.FIIDReceiver    = NATCUR;
           accTrnData.AccountReceiver = rs.value("t_MinusNDSAccount");
           accTrnData.SumReceiver     = rs.value("t_ConvTaxSumNC");

           accTrnData.Ground       = "Учет НДС комиссии " + ComissCode + ".";


           if(IsBankOrderForComm == true)
             accTrnData.Shifr_Oper = SF_SHIFR_OPER_BANK_ORDER;
           end;

           sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_NDSDISCOUNT, 0, OperationID, StepID);
         end;
       else // Иначе: комиссия не начислена или получатель комиссии не наш банк.
         if(ReceiverID == BankID)
           accTrnData = RsbAccTransactionData();
           accTrnData.Chapter = 1;

           accTrnData.Date_Carry    = rs.value("t_DateCarry");
           accTrnData.ResultCarry = SFPAY_CARRY;

           accTrnData.Department   = OperDprt;

           accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
           accTrnData.AccountPayer    = rs.value("t_PayerAccount");

           accTrnData.FIIDReceiver    = rs.value("t_ReceiverFIID");
           accTrnData.AccountReceiver = rs.value("t_ReceiverAccount");

           // Условие обнуления суммы НДС УК
           if((TaxSum != $0) AND ((ConvTaxSum == $0) OR (ConvTaxSumPayer == $0)))
             accTrnData.SumPayer  = rs.value("ConvTotalSum");
           else
             accTrnData.SumPayer  = rs.value("t_ConvPaySum");
           end;

           accTrnData.Ground       = trim(GroundVO + " " + "Оплата комиссии " + ComissCode + ".");

           if(IsBankOrderForComm == true)
             accTrnData.Shifr_Oper = SF_SHIFR_OPER_BANK_ORDER;
           end;

           sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);

           // Условие обнуления суммы НДС УК
           if((TaxSum != $0) AND ((ConvTaxSum == $0) OR (ConvTaxSumPayer == $0)))
             sfdefArray[SfDefArrayIndex].IsNDSSumReset = true;
           end;

           if((ConvTaxSum != $0) AND (rs.value("t_ConvTaxSumNC") != $0) AND (ConvTaxSumPayer != $0))
             accTrnData = RsbAccTransactionData();

             accTrnData.Chapter = 1;
             accTrnData.Date_Carry      = rs.value("t_DateCarry");
             accTrnData.ResultCarry     = SFPAY_CARRY;

             accTrnData.Department      = OperDprt;

             accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
             accTrnData.AccountPayer    = rs.value("t_PayerAccount");

             accTrnData.FIIDReceiver    = NATCUR;
             accTrnData.AccountReceiver = rs.value("t_MinusNDSAccount");
             accTrnData.SumReceiver     = rs.value("t_ConvTaxSumNC");

             accTrnData.Ground          = trim(GroundVO + " " + "Оплата НДС комиссии " + ComissCode +".");

             if(IsBankOrderForComm == true)
               accTrnData.Shifr_Oper = SF_SHIFR_OPER_BANK_ORDER;
             end;

             sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_NDSPAY, 0, OperationID, StepID);
           end;

         elif (PayerID == BankID) // Иначе если плательщик комиссии наш банк
           // Выполнить проводку по оплате комиссии со счета СПИ плательщика на счет СПИ получателя в валюте оплаты комиссии за дату оплаты:
            accTrnData = RsbAccTransactionData();
            accTrnData.Chapter = 1;

            accTrnData.Date_Carry    = rs.value("t_DateCarry");
            accTrnData.ResultCarry = SFPAY_CARRY;

            accTrnData.Department   = OperDprt;

            accTrnData.FIIDPayer       = rs.value("t_PayerFIID");
            accTrnData.AccountPayer    = rs.value("t_PayerAccount");

            // Условие обнуления суммы НДС УК
            if((TaxSum != $0) AND ((ConvTaxSum == $0) OR (ConvTaxSumPayer == $0)))
              accTrnData.SumReceiver  = rs.value("ConvTotalSum");
            else
              accTrnData.SumReceiver  = rs.value("t_ConvPaySum");
            end;
            
            accTrnData.FIIDReceiver    = rs.value("t_ReceiverFIID");
            accTrnData.AccountReceiver = rs.value("t_ReceiverAccount");

            accTrnData.Ground       = trim(GroundVO + " " + "Оплата комиссии " + ComissCode + ".");

            sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_COMISSPAY, 0, OperationID, StepID);

            // Условие обнуления суммы НДС УК
            if((TaxSum != $0) AND (ConvTaxSum == $0))
              sfdefArray[SfDefArrayIndex].IsNDSSumReset = true;
            end;

            if((ConvTaxSum != $0) AND (rs.value("t_ConvTaxSumNC") != $0) AND (ConvTaxSumPayer != $0))
              // Если комиссия облагается НДС, то выполнить проводку по оплате НДС со счет КУ "+НДС" на счет СПИ получателя комиссии в нац. валюте за дату оплаты
              accTrnData = RsbAccTransactionData();
              accTrnData.Chapter = 1;

              accTrnData.Date_Carry    = rs.value("t_DateCarry");
              accTrnData.ResultCarry = SFPAY_CARRY;

              accTrnData.Department   = OperDprt;

              accTrnData.FIIDPayer       = NATCUR;
              accTrnData.AccountPayer    = rs.value("t_NDSAccount ");
              accTrnData.SumPayer = rs.value("t_ConvTaxSumNC");

              accTrnData.FIIDReceiver    = rs.value("t_ReceiverFIID");
              accTrnData.AccountReceiver = rs.value("t_ReceiverAccount ");

              accTrnData.Ground       = trim(GroundVO + " " + "Оплата НДС комиссии " + ComissCode +".");

              sfdefAccTrnCharger.AddDocsTrn(accTrnData, SfDefArrayIndex, SFDOCS_LINKKIND_NDSPAY, 0, OperationID, StepID);
            end;
         end;
       end;

       sfdefAccTrnCharger.ClearPoint();
     end;
   end;

  if(DocumentIDArray.size > 0)
     var upd = RsbSQLInsert("UPDATE doprtemp_tmp SET t_errorstatus = ?, t_errormessage = ? WHERE t_dockind = ? AND t_documentid = ?", 4, DocumentIDArray.Size );
     upd.AddParam( V_INTEGER, ErrorStatusArray        );
     upd.AddParam( V_STRING , ErrorMessageArray, 2000 );
     upd.AddParam( V_INTEGER, DocKindArray            );
     upd.AddParam( V_STRING , DocumentIDArray  , 35   );
     if(not upd.Insert())
       stat = 1;
     end;
  end;

  stat = sfdefAccTrnCharger.ExecuteTrnDataArray2(sfdefArray);

  if(stat == 0)
    stat = UpdateSfDefSum(sfdefArray);
  end;
                          
  return stat;
end;


// Формирование документов оплаты по УК
macro SFCreateDocPayBatch(FeeType, BlockID, Number_Step, SfSrvDoc)
  var stat:integer = 0;
  var cmd, rs, strSql;
  var oprID_Operation = 0; 
  var oprID_Step      = 0; 
  var sfdefArray       = TArray;
  var flagTrnPay      = false; // Оплата проводками  
  var ObjectType = 0;

  record SfContr(SfContr);
  record SfConcom(sfconcom);
  record SfComissRec("sfcomiss.dbt"); // Для MakeObjectID

  ClearTempTable("dsfpaydoc_tmp");
  ClearTempTable("dsfground_tmp");
  ClearTempTable("drefgenprm_tmp");
  
  if(FeeType == SF_FEE_TYPE_PERIOD)  
    ObjectType = OBJTYPE_SFDEFCOM;
    if(SfSrvDoc.Kind != 2) // SFSRVDOC_KIND_PAY = 2
      MsgBox("Выполнение шага \"Формирование документов оплаты\" возможно только из процедуры оплаты");
      return 1;
    end;
  elif (FeeType == SF_FEE_TYPE_SINGLE)
    ObjectType = OBJTYPE_OPRSFCOM;
  else
    return stat;
  end;

  var CashSize = SfCashSizeGetRegValue();
  var sfrepacc = TRecHandler ("sfrepacc.tmp");

  SfGroundAddVOBatch(FeeType, SfSrvDoc, BlockID, Number_Step);

  // Определить массив sfFormPayDocParamsArray, в котором будут временно храниться объекты класса TSfFormPayDocParams с параметрами для функции SfFormPayDoc 
  var sfFormPayDocParamsArray = TArray; 

  var sfpaydocCache = RsbSQLInsert("sfpaydoc.tmp");
  var sfrepaccCache = NULL;

  if(FeeType == SF_FEE_TYPE_PERIOD)
    sfrepaccCache = RsbSQLInsert("sfrepacc.tmp")
  end;
    cmd = RsdCommand(); 
    cmd.NullConversion = true;

    strSql =" SELECT tmp.t_ID_Operation As oprID_Operation, tmp.t_ID_Step As oprID_Step, " +

// УПК
            " sfdef.t_ID As sfdefID, sfdef.t_Sum As sfdefSum, sfdef.t_SumNDS As sfdefSumNDS, " + 
            " sfdef.t_FIID_Sum As sfdefFIID_Sum, sfdef.t_Status As sfdefStatus, sfdef.t_IsIncluded As sfdefIsIncluded, sfdef.t_Department As sfdefDepartment, " +
            " sfdef.t_FacturaID As sfdefFacturaID, sfdef.t_DatePeriodBegin As sfdefDatePeriodBegin, sfdef.t_DatePeriodEnd As sfdefDatePeriodEnd, sfdef.t_commNumber As sfdefcommNumber, sfdef.t_DateFee As sfdefDateFee, sfdef.t_FeeType As sfdefFeeType, " +

// ДО
            " contr.t_ID As contrID, contr.t_ServKind As contrServKind, " +
            " contr.t_PartyID As contrPartyID, contr.t_Department As contrDepartment, " +
            " contr.t_PayRateID As contrPayRateID, contr.t_PayRateDateKind As contrPayRateDateKind, " +
            " contr.t_PayRatePercent As contrPayRatePercent, " +
            " contr.t_PayFIID As contrPayFIID, contr.t_Number As contrNumber, contr.t_DateConc contrDateConc, " +
            " contr.t_PayMethod As contrPayMethod, contr.t_PreAcptID As contrPreAcptID, contr.t_DateBegin As contrDateBegin," +

// Вд комиссии sfcomiss
            " sfcomiss.t_feeType As feeType, sfcomiss.t_number As commNumber, " +
            " sfcomiss.t_InstantPayment As InstantPayment, sfcomiss.t_RateType As comissRateType, sfcomiss.t_Code As comissCode, " +

            " DECODE(sfcomiss.t_FIID_paySum, -1, sfdef.t_FIID_Sum, sfcomiss.t_FIID_paySum) As payFIID, " +

// СПИ получателя УПК
            " sicredit.t_Account As sicreditAccount, sicredit.t_FIID As sicreditFIID, sicredit.t_PartyID As sicreditPartyID, sicredit.t_BankID As sicreditBankID, sicredit.t_Department As sicreditDepartment, " +

// СПИ плательщика УПК
            " sidebet.t_Account As sidebetAccount, sidebet.t_FIID As sidebetFIID, sidebet.t_PartyID As sidebetPartyID, sidebet.t_BankID As sidebetBankID, sidebet.t_NoAccept As sidebetNoAccept, sidebet.t_Department As sidebetDepartment, " +

// счета по КУ +Расчеты
            " NVL(pluscalc.t_Account, chr(0)) As plusCalcAccount, NVL(pluscalc.t_FIID, -1) As plusCalcFIID, " +

// счета по КУ +Расчеты, НДС
            " NVL(pluscalcnds.t_Account, chr(0)) As plusCalcNDSAccount, NVL(pluscalcnds.t_FIID, -1) As plusCalcNDSFIID, " +

// счета по КУ -НДС начисленный
            " NVL(minusndsacr.t_Account, chr(0)) As minusNDSAcrAccount, NVL(minusndsacr.t_FIID, -1) As minusNDSAcrFIID, " +

// счета по КУ -НДС
            " NVL(minusnds.t_Account, chr(0)) As minusNDSAccount, NVL(minusnds.t_FIID, -1) As minusNDSFIID, " +

// код ВО для основание 
            " NVL(ground.t_Ground, chr(1)) As groundVO " ;

    if(FeeType == SF_FEE_TYPE_PERIOD)
      strSql = strSql + " ,NVL(fromcft.t_CarryAccount, chr(1)) As accountCFT, NVL(fromcft.t_CarrySum, 0) As debtSumCFT ";
    end;

    strSql = strSql + "  FROM doprtemp_tmp tmp, dsfdef_dbt sfdef " +
                      " INNER JOIN dsfcontr_dbt contr ON contr.t_ID = sfdef.t_SfContrID " +
                      " INNER JOIN dsfcomiss_dbt sfcomiss ON sfcomiss.t_feetype = sfdef.t_feetype AND sfcomiss.t_number = sfdef.t_commnumber " +
                      " INNER JOIN dsfsi_dbt sicredit ON sicredit.t_ObjectType = ? AND sicredit.t_DebetCredit = "+BANK_CREDIT+" AND sicredit.t_ObjectID = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
                      " INNER JOIN dsfsi_dbt sidebet ON sidebet.t_ObjectType = ? AND sidebet.t_DebetCredit = "+BANK_DEBET+" AND sidebet.t_ObjectID = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
                      "  LEFT JOIN dsfsi_dbt pluscalc ON pluscalc.t_ObjectType = ? AND pluscalc.t_DebetCredit = "+CALC_SFSI_KIND+" AND pluscalc.t_ObjectID = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
                      "  LEFT JOIN dsfsi_dbt pluscalcnds ON pluscalcnds.t_ObjectType = ? AND pluscalcnds.t_DebetCredit = "+CALCNDS_SFSI_KIND+" AND pluscalcnds.t_ObjectID = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
                      "  LEFT JOIN dsfsi_dbt minusndsacr ON minusndsacr.t_ObjectType = ? AND minusndsacr.t_DebetCredit = "+NDSACRUAL_SFSI_KIND+" AND minusndsacr.t_ObjectID = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
                      "  LEFT JOIN dsfsi_dbt minusnds ON minusnds.t_ObjectType = ? AND minusnds.t_DebetCredit = "+NDS_SFSI_KIND+" AND minusnds.t_ObjectID = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
                      "  LEFT JOIN dsfground_tmp ground ON ground.t_SfDefID = sfdef.t_ID ";

    cmd.addParam( "", RSDBP_IN, ObjectType ); 
    cmd.addParam( "", RSDBP_IN, ObjectType ); 
    cmd.addParam( "", RSDBP_IN, ObjectType ); 
    cmd.addParam( "", RSDBP_IN, ObjectType ); 
    cmd.addParam( "", RSDBP_IN, ObjectType ); 
    cmd.addParam( "", RSDBP_IN, ObjectType ); 

    if(FeeType == SF_FEE_TYPE_PERIOD)
      strSql = strSql + "  LEFT JOIN duserdebttocft_dbt tocft ON tocft.t_DebtSourceID = sfdef.t_ID AND tocft.t_DebtType IN (1,2) " +
                        "  LEFT JOIN duserdebtfromcft_dbt fromcft ON fromcft.t_DebtID = tocft.t_ID " +
                        " WHERE tmp.t_ErrorStatus = 0 " +
                        "   AND sfdef.t_FeeType = ?  " +
                        "   AND sfdef.t_ID = to_number(tmp.t_documentID) " +
                        " ORDER BY sfdef.t_Department, sfdef.t_SfContrID, sfdef.t_feeType, sfdef.t_commNumber, sfdef.t_DatePeriodBegin "; 
      cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_PERIOD );
    else
      strSql = strSql + " WHERE sfdef.t_FeeType = ? " +
                        "   AND sfdef.t_ID = tmp.t_SfDefID " +
                        "   AND tmp.t_BlockID = ? " +
                        "   AND tmp.t_Number_Step = ? " +
                        "   AND tmp.t_AutoFormDocs = 'X' " +
                        " ORDER BY tmp.t_ID_Operation, sfdef.t_feeType, sfdef.t_commNumber "; 
      cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_SINGLE );
      cmd.addParam( "", RSDBP_IN, BlockID );
      cmd.addParam( "", RSDBP_IN, Number_Step );
    end;

    cmd.CmdText = strSql;

    cmd.execute();   
    var i = 0;
    rs = RsdRecordset( cmd ); 
    while( rs.moveNext() )
      oprID_Operation = rs.value("oprID_Operation");
      oprID_Step      = rs.value("oprID_Step");

      var sfFormDocParams = TSfFormPayDocParams();

      var DefOpr = SfDefOpr();

      ClearRecord(DefOpr.SfDef);
      DefOpr.SfDef.rec.ID         = rs.value("sfdefID");
      DefOpr.SfDef.rec.Sum        = rs.value("sfdefSum");
      DefOpr.SfDef.rec.SumNDS     = rs.value("sfdefSumNDS");
      DefOpr.SfDef.rec.FIID_Sum   = rs.value("sfdefFIID_Sum");
      DefOpr.SfDef.rec.Status     = rs.value("sfdefStatus");
      DefOpr.SfDef.rec.IsIncluded = rs.value("sfdefIsIncluded");
      DefOpr.SfDef.rec.FacturaID  = rs.value("sfdefFacturaID");
      DefOpr.SfDef.rec.DatePeriodBegin = rs.value("sfdefDatePeriodBegin");
      DefOpr.SfDef.rec.DatePeriodEnd   = rs.value("sfdefDatePeriodEnd");
      DefOpr.SfDef.rec.CommNumber      = rs.value("sfdefcommNumber");
      DefOpr.SfDef.rec.SfContrID       = rs.value("contrID");
      DefOpr.SfDef.rec.DateFee         = rs.value("sfdefDateFee");
      DefOpr.SfDef.rec.FeeType         = rs.value("sfdefFeeType");
      DefOpr.SfDef.rec.Department      = rs.value("sfdefDepartment");
      
      DefOpr.OldStatus       = DefOpr.SfDef.rec.Status;
      DefOpr.oprID_Operation = oprID_Operation;
      DefOpr.oprID_Step      = oprID_Step;     

      if((FeeType == SF_FEE_TYPE_PERIOD) and (rs.value("accountCFT") != ""))
        DefOpr.IsPayFromCFT = true;
        DefOpr.AccountCFT = rs.value("accountCFT");
        DefOpr.DebtSumCFT = rs.value("debtSumCFT");
      end;

      var SfComiss = TRecHandler("sfcomiss.dbt");
      ClearRecord(SfComiss);
      SfComiss.rec.FeeType        = rs.value("feeType");
      SfComiss.rec.Number         = rs.value("commNumber");
      SfComiss.rec.InstantPayment = rs.value("InstantPayment");
      SfComiss.rec.RateType       = rs.value("comissRateType");
      SfComiss.rec.Code           = rs.value("comissCode");

      sfFormDocParams.sfcomiss = SfComiss;
      
      if(SfComiss.rec.InstantPayment != "X")
        DefOpr.SfDef.rec.Status = SFDEFCOM_STATUS_CALCULATED;
      else
        var ReceiverAccount = rs.value("SICREDITACCOUNT");
        var pSfConCom, pSFContr;
        var SfComFixPD;

        if(((StrUpr(rs.value("COMISSCODE")) == "БРОКЕРФИКС") or (StrUpr(rs.value("COMISSCODE")) == "ИНВЕСТСОВЕТНИК")) and 
           (GetSfContrBuf(rs.value("CONTRID"), @pSFContr)) and 
           (GetSfConCom(rs.value("CONTRID"), rs.value("COMISSCODE"), @pSFConCom)) and
           (SfSrvDoc.Kind != 2) // SFSRVDOC_KIND_PAY = 2
          )
          SfComFixPD = SfConComPrimDocFix( 51, pSfConCom, pSfContr, 0 );
          ReceiverAccount = MC_FindAndOpenAccount("+КВ, ц/б",
                                                  SfComFixPD,
                                                  DefOpr.SfDef.rec.DateFee,
                                                  0,
                                                  MC_OPENACC_CREATE);
        end;

        var sicredit = TRecHandler("sfsi.dbt");
        ClearRecord(sicredit);
        sicredit.rec.Account            = ReceiverAccount;
        sicredit.rec.FIID               = rs.value("sicreditFIID");
        sicredit.rec.PartyID            = rs.value("sicreditPartyID");
        sicredit.rec.BankID             = rs.value("sicreditBankID");
        sicredit.rec.ReceiverNDSAccount = rs.value("minusNDSAccount");
        sicredit.rec.Department         = rs.value("sicreditDepartment");

        sfFormDocParams.sicredit = sicredit;

        var sidebet = TRecHandler("sfsi.dbt");
        ClearRecord(sidebet);
        sidebet.rec.Account    = rs.value("sidebetAccount");
        sidebet.rec.FIID       = rs.value("sidebetFIID");
        sidebet.rec.PartyID    = rs.value("sidebetPartyID");
        sidebet.rec.BankID     = rs.value("sidebetBankID");
        sidebet.rec.NoAccept   = rs.value("sidebetNoAccept");
        sidebet.rec.Department = rs.value("sidebetDepartment");

        sfFormDocParams.sidebet = sidebet;
        
        ClearRecord(SfContr);
        SfContr.id               = rs.value("contrID"             );
        SfContr.servkind         = rs.value("contrServKind"       );
        SfContr.partyid          = rs.value("contrPartyID"        );
        SfContr.department       = rs.value("contrDepartment"     );
        SfContr.payrateid        = rs.value("contrPayRateID"      );
        SfContr.payratedatekind  = rs.value("contrPayRateDateKind");
        SfContr.payratepercent   = rs.value("contrPayRatePercent" );
        SfContr.payfiid          = rs.value("contrPayFIID"        );
        SfContr.number           = rs.value("contrNumber"         );
        SfContr.dateconc         = rs.value("contrDateConc"       );
        SfContr.paymethod        = rs.value("contrPayMethod"      );
        SfContr.preacptid        = rs.value("contrPreAcptID"      );
        SfContr.DateBegin        = rs.value("contrDateBegin"      );

        var isNVPI = false;
        if((SfContr.payfiid != DefOpr.SfDef.rec.FIID_Sum) AND (SfContr.payratedatekind != SFINV_RATEDATEKIND_DRAWN))
          isNVPI = true;
        else
          isNVPI = false;
        end;

        // 8.5.6. Определить массив bilfDocArray для получения параметров для формирования ЗК по УПК для ДО с методом оплаты "проводками".
        // 8.5.7. Сформировать основание документа оплаты УПК ground с помощью функции BuildGroundWithVO().

        if((not Sf_IsInstalledRKO()) OR (SfContr.paymethod == SF_PAY_METHOD_DOCUMENT)) // Оплата проводками 
          flagTrnPay = true;
          var sfpaydoc = TRecHandler("sfpaydoc.tmp");
          ClearRecord( sfpaydoc );
          sfpaydoc.rec.ArrayIndex         = i;
          sfpaydoc.rec.SfDefID            = DefOpr.SfDef.rec.ID;
          sfpaydoc.rec.PayerAccount       = sidebet.rec.Account;
          sfpaydoc.rec.PayerFIID          = sidebet.rec.FIID;
//          sfpaydoc.rec.PayerDprt          = 
          sfpaydoc.rec.PayerID            = sidebet.rec.PartyID;
          sfpaydoc.rec.ReceiverAccount    = sicredit.rec.Account;
          sfpaydoc.rec.ReceiverFIID       = sicredit.rec.FIID;
//          sfpaydoc.rec.ReceiverDprt       = 
          sfpaydoc.rec.ReceiverID         = sicredit.rec.PartyID;

          if(FeeType == SF_FEE_TYPE_PERIOD)
            sfpaydoc.rec.DateCarry          = SfSrvDoc.DatePay;
          else
            sfpaydoc.rec.DateCarry          = DefOpr.SfDef.rec.DateFee; // DateFee ??
          end;

          sfpaydoc.rec.FreeRest           = $0;
          sfpaydoc.rec.ConvFreeRest       = $0;
          sfpaydoc.rec.PaySum             = DefOpr.SfDef.rec.Sum;     
          sfpaydoc.rec.TaxSum             = DefOpr.SfDef.rec.SumNDS;  
          sfpaydoc.rec.FIIDSum            = DefOpr.SfDef.rec.FIID_Sum;
          sfpaydoc.rec.FIIDPaySum         = rs.value("payFIID");
          sfpaydoc.rec.ConvPaySum         = DefOpr.SfDef.rec.Sum;
          sfpaydoc.rec.ConvTaxSum         = DefOpr.SfDef.rec.SumNDS;
          sfpaydoc.rec.ConvTaxSumNC       = DefOpr.SfDef.rec.SumNDS;
          sfpaydoc.rec.RateType           = SfComiss.rec.RateType;
          sfpaydoc.rec.CalcFIID           = rs.value("plusCalcFIID");
          sfpaydoc.rec.CalcAccount        = rs.value("plusCalcAccount");
          sfpaydoc.rec.CalcNDSAccount     = rs.value("plusCalcNDSAccount");
          sfpaydoc.rec.MinusNDSAcrAccount = rs.value("minusNDSAcrAccount");
          sfpaydoc.rec.MinusNDSAccount    = rs.value("minusNDSAccount");
          sfpaydoc.rec.OperationID        = rs.value("oprID_Operation"); 
          sfpaydoc.rec.StepID             = rs.value("oprID_Step");      
          sfpaydoc.rec.IsIncluded         = DefOpr.SfDef.rec.IsIncluded;
          sfpaydoc.rec.ComissCode         = SfComiss.rec.Code;
          sfpaydoc.rec.Error              = 0;
          sfpaydoc.rec.ErrMsg             = "";

          sfpaydocCache.AddRecord( sfpaydoc );
        else
          sfFormDocParams.payParams = TSfPayParams();
          var groundVO = rs.value("groundVO");
          Copy(SfComissRec, SfComiss);   

          if(FeeType == SF_FEE_TYPE_PERIOD)
            sfFormDocParams.payParams.payDate    = SfSrvDoc.DatePay; // Дата взимания оплаты УПК dsfsrvdoc_dbt.T_DATEPAY.
          else
            sfFormDocParams.payParams.payDate    = DefOpr.SfDef.rec.DateFee; // DateFee ??
          end;
          
          sfFormDocParams.payParams.ground       = BuildGroundBatch(groundVO, DefOpr.SfDef.rec, SfComissRec, SfContr);
          sfFormDocParams.payParams.paySum       = DefOpr.SfDef.rec.Sum   ; // Сумма комиссии без НДС: DSFDEFCOM_DBT.T_COMMSUM.
          sfFormDocParams.payParams.taxSum       = DefOpr.SfDef.rec.SumNDS; // Сумма НДС: DSFDEFCOM_DBT.T_NDSSUM.
          sfFormDocParams.payParams.FIID         = DefOpr.SfDef.rec.FIID_Sum; // Валюта УПК: DSFDEFCOM_DBT.T_FIID_COMMSUM.
          sfFormDocParams.payParams.primKind     = SFCONTR_DOC;
          sfFormDocParams.payParams.primID       = sfcontr.ID;
          sfFormDocParams.payParams.PreAcptID    = sfcontr.PreAcptID;

          if(FeeType == SF_FEE_TYPE_PERIOD)
            sfFormDocParams.payParams.objectType = OBJTYPE_SFDEFCOM;
          else
            sfFormDocParams.payParams.objectType = OBJTYPE_OPRSFCOM;
          end;

          sfFormDocParams.payParams.objectBuf    = DefOpr.SfDef.rec;
          sfFormDocParams.payParams.payMethod    = SfContr.paymethod;
          sfFormDocParams.payParams.IsIncluded   = DefOpr.SfDef.rec.IsIncluded ;
          sfFormDocParams.payParams.PlusCalc_Account          = rs.value("plusCalcAccount");
          sfFormDocParams.payParams.PlusCalcNDS_Account       = rs.value("plusCalcNDSAccount");
          sfFormDocParams.payParams.MinusNdsAcrual_Account    = rs.value("minusNDSAcrAccount");
          sfFormDocParams.payParams.MinusNds_Account          = rs.value("minusNDSAccount");
          sfFormDocParams.payParams.isNVPI       = isNVPI; 
          sfFormDocParams.payParams.FacturaID    = DefOpr.SfDef.rec.FacturaID;
          sfFormDocParams.payParams.PreAcptID    = SfContr.preacptid;
          sfFormDocParams.payParams.IsNDSSumReset = false;

          var err = CheckCreateSfPayment(sfFormDocParams.sidebet, sfFormDocParams.sicredit, SfComissRec, sfFormDocParams.payParams);

          if(err == 0)
             sfFormDocParams.sfdefIndex =  sfdefArray.size;
             sfFormDocParams.payParams.IsChecked = true;

             var j = sfFormPayDocParamsArray.size();
             sfFormPayDocParamsArray[j] = sfFormDocParams;
          elif(FeeType == SF_FEE_TYPE_PERIOD)
            ClearRecord( sfrepacc );
            sfrepacc.rec.sfdefcomID      = DefOpr.SfDef.rec.ID;
            sfrepacc.rec.debit           = sidebet.rec.Account;
            sfrepacc.rec.credit          = sicredit.rec.Account;
            sfrepacc.rec.BeginDate       = DefOpr.SfDef.rec.DatePeriodBegin;
            sfrepacc.rec.EndDate         = DefOpr.SfDef.rec.DatePeriodEnd  ;
            sfrepacc.rec.Amount          = DefOpr.SfDef.rec.Sum;
            sfrepacc.rec.ContrID         = SfContr.id;
            sfrepacc.rec.FeeType         = SF_FEE_TYPE_PERIOD;
            sfrepacc.rec.ComissNumber    = SfComiss.rec.Number;
            sfrepacc.rec.InvoiceID       = -1;
            sfrepacc.rec.Kind            = 1;
            sfrepacc.rec.Department      = DefOpr.SfDef.rec.Department;

            if(err > 0)
              sfrepacc.rec.ErrorCode = sfFormDocParams.payParams.ErrorNum;
              sfrepacc.rec.Comment = sfFormDocParams.payParams.ErrorMsg;
            end;

            if(sfrepaccCache != null)
              sfrepaccCache.AddRecord( sfrepacc );
            end;
          end;

          DefOpr.IsNDSSumReset = sfFormDocParams.payParams.IsNDSSumReset;
        end;

        if(SfContr.paymethod != SF_PAY_METHOD_DOCUMENT)
          DefOpr.SfDef.rec.Status = SFDEFCOM_STATUS_FOR_PAY;
          /*DEF-56637->*/
          if (FeeType == SF_FEE_TYPE_PERIOD)
            DefOpr.SfDef.rec.DatePay = SfSrvDoc.DatePay; //Установка Даты Оплаты для оплаченной комиссии
          end; 
          /*<-DEF-56637*/
        end;
      end;

      var iit = i;
      sfdefArray[iit] = DefOpr;
      i = i + 1;
    end;

    if((stat == 0) AND (flagTrnPay == true))
      if(not sfpaydocCache.Insert())
        stat = 1;
      end;
    end;

    // Вставка проводок
    if((stat == 0) AND (flagTrnPay == true))
       stat = SfFormDocumentsBatch(sfdefArray, sfrepaccCache, SfSrvDoc);
    end;

    if(sfFormPayDocParamsArray.size() > 0)
      var refgenprmCache = RsbSQLInsert("refgenprm.tmp");    
      var num = sfFormPayDocParamsArray.size();

      var RefID = 0;
      if(stat == 0)
        if( GetReferenceIDByType( OBJTYPE_PSPAYORD, /*Рублевый платежный документ*/
                                  REFOBJ_SVORDER,   /*ObjectType = 500; номер требования банка к клиентам (РКО)*/
                                  RefID ) != 0 )
          MsgBox( "Ошибка при генерации номера платежа" );
          stat = 1; // ADD Err !!!
        end;
      end;

      var it = 0;
      if(stat == 0)
        i = 0;
        while (i <num)
          it = i;
          if(sfFormPayDocParamsArray[it].payParams.ErrorNum == 0)
            var refgenprm = TRecHandler("refgenprm.tmp");
            ClearRecord( refgenprm );

            refgenprm.rec.ID = i;
            refgenprm.rec.ObjKind = OBJTYPE_PSPAYORD;
            refgenprm.rec.ObjectID = 0;
            refgenprmCache.AddRecord(refgenprm);
          end;
          i = i + 1;
        end;
        
        if(not refgenprmCache.Insert())
          stat = 1;
        end
      end;

      if(stat == 0)
        stat = GenerateReferenceMass( RefID, false );
      end;

      if(stat == 0)
        var  cmdRef = RsdCommand(); 
        cmdRef.NullConversion = true;

        var strSqlRef ="SELECT t_ID, t_Error, t_RefNum, t_ErrMsg FROM  drefgenprm_tmp ORDER BY t_ID";

        cmdRef.CmdText = strSqlRef;

        cmdRef.execute();   
        i = 0;
        var rsRef = RsdRecordset( cmdRef ); 
        while( rsRef.moveNext() )
          var Ref_ID     = rsRef.value("t_ID");
          var Ref_Error  = rsRef.value("t_Error");
          var Ref_RefNum = rsRef.value("t_RefNum");
          var Ref_ErrMsg = rsRef.value("t_ErrMsg");

          sfFormDocParams = sfFormPayDocParamsArray[Ref_ID];
          //var DefOpr = sfdefArray[sfFormDocParams.sfdefIndex];

          if((Ref_Error != NULL) AND (Ref_Error != 0))
            sfFormPayDocParamsArray[Ref_ID].payParams.SetError( Ref_Error, Ref_ErrMsg );
          else
            sfFormPayDocParamsArray[Ref_ID].payParams.RefPaymNum = Ref_RefNum;
          end;
        end;
      end;

      if(stat == 0)
        var pmBatch = BatchMode( num );
        var oprchildCache = RsbSQLInsert("oprchild.tmp");

        i = 0;
        while (i <num)
          it = i;
          sfFormDocParams = sfFormPayDocParamsArray[it];
          DefOpr = sfdefArray[sfFormDocParams.sfdefIndex];

          if(sfFormDocParams.payParams.ErrorNum == 0) 
            var oprchild = TRecHandler("oprchild.tmp");
            ClearRecord( oprchild );
            oprchild.rec.ID_Operation = DefOpr.oprID_Operation;
            oprchild.rec.ID_Step      = DefOpr.oprID_Step;     
            oprchild.rec.MassOprStart = "X";
            oprchild.rec.FilterKind   = OPPF_FITALL;

            SfFormDocsCommon( 
                null, 
                sfFormDocParams.sidebet, // СПИ по дебету УПК
                sfFormDocParams.sicredit, // СПИ по кредиту УПК
                sfFormDocParams.sfcomiss.rec, // буфер вида периодический комиссии
                sfFormDocParams.payParams, // параметры оплаты
                null, // параметры sfinvlnk
                null, // сумма в валюте ТО    
                null, // @bilfDocArray, ADD!!
                true, // IsBatchMode признак пакетного режима    
                oprchild.rec );

            oprchildCache.AddRecord( oprchild ); 
          end;

          i = i + 1;
        end;

        // Выполнить пакетную вставку в doprchild_tmp  
        if(stat == 0)
          if(not oprchildCache.Insert())
            stat = 1;
          end;
        end;

        if(stat == 0)
          pmBatch.TransferToBase( false );
        end;
      end;

      // Выполнить пакетную вставку ЗК .
      if(stat == 0)
        // stat = bbeBatch.run(); ADD !!
      end;

      if((stat == 0) AND (FeeType == SF_FEE_TYPE_PERIOD))
        i = 0;
        it = 0;
        while (i <num)
          it = i;
          sfFormDocParams = sfFormPayDocParamsArray[it];
          DefOpr = sfdefArray[sfFormDocParams.sfdefIndex];

          ClearRecord( sfrepacc );
          sfrepacc.rec.sfdefcomID      = DefOpr.SfDef.rec.ID;
          sfrepacc.rec.debit           = sfFormDocParams.sidebet.rec.Account;
          sfrepacc.rec.credit          = sfFormDocParams.sicredit.rec.Account;
          sfrepacc.rec.BeginDate       = DefOpr.SfDef.rec.DatePeriodBegin;
          sfrepacc.rec.EndDate         = DefOpr.SfDef.rec.DatePeriodEnd  ;
          sfrepacc.rec.Amount          = DefOpr.SfDef.rec.Sum;
          sfrepacc.rec.ContrID         = DefOpr.SfDef.rec.SfContrID;
          sfrepacc.rec.FeeType         = SF_FEE_TYPE_PERIOD;
          sfrepacc.rec.ComissNumber    = sfFormDocParams.sfcomiss.rec.Number;
          sfrepacc.rec.InvoiceID       = -1;
          sfrepacc.rec.Kind            = 1;
          sfrepacc.rec.Department      = DefOpr.SfDef.rec.Department;
                 
          if(sfFormDocParams.payParams.ErrorNum > 0)
            sfrepacc.rec.ErrorCode = sfFormDocParams.payParams.ErrorNum;
            sfrepacc.rec.Comment = sfFormDocParams.payParams.ErrorMsg;
          end;

          if(sfrepaccCache != NULL)
            sfrepaccCache.AddRecord( sfrepacc );
          end;

          i = i + 1;
        end;
      end;

    end;

    // Выполнить пакетную вставку в dsfrepacc_tmp
    if(FeeType == SF_FEE_TYPE_PERIOD)
      if(not sfrepaccCache.Insert())
        stat = 1;
      end;
    end;

    if(stat == 0)
      stat = UpdateSfDefStatusSfOpr( sfdefArray );
    end;

    // Пакетно обновить сумму комиссии и сумму НДС по тем УПК, для которых сумма НДС была обнулена после конвертации из валюты УК в валюту оплаты/начисления.
    if(stat == 0)
      stat = UpdateSfDefSum( sfdefArray );
    end;

  return stat;
end;