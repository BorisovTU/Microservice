/*
Макрос выполнения шага "Оплата" сервисной операции сопровождения ДО
*/

Import InsCarryDoc, "sfsrv_lib.mac";

record SfContr("sfcontr.dbt");
record SfConComRec("sfconcom.dbt");
record SfComissRec("sfcomiss.dbt");

record SfSrvDocRec("sfsrvdoc.dbt");

macro ExecuteStep( outBuff, primDoc )

  var stat = 0;

  setbuff( SfContr, primDoc  );

  var rs, cmd;
  record SfDefCom("sfdef.dbt");
  record SfAccrue("sfaccrue.dbt");

  var PayerAccount = "", ReceiverAccount = "";
  var NDSPayerAccount : string, NDSReceiverAccount : string;

  var prevFIID_CommSum = -1;
  var PayerFIID = -1, ReceiverFIID = -1;

  var SfConComPD : SfConComPrimDoc;
  var IsNVPI:bool;

  var AccTrnID = 0, AccTrnID_NDS = 0;

  var Action = DEFCOM_ACTIONKIND_PAY;
  var Comment = "";

  cmd = RsdCommand( " SELECT * FROM DSFDEFTMP_TMP WHERE t_Action = ? AND t_Skip = chr(0) " );
  cmd.addParam( "", RSDBP_IN, Action );

  rs = RsdRecordset( cmd );
  while( rs.moveNext() )    

    SfSrv_FillSfDefComRecord( rs, SfDefCom );
    SfSrv_FillSfAccrueRecord( rs, SfAccrue );
    
    var TrnDate = date(rs.value("T_ACRTRNDATE"));
    if( TrnDate == date(0,0,0) )
      TrnDate = {BranchCurDate};
    end;
    
    if( prevFIID_CommSum != SfDefCom.FIID_Sum )
      prevFIID_CommSum = SfDefCom.FIID_Sum;
      IsNVPI = SfSrv_IsNVPICarry( SfContr.PayFIID, SfDefCom.FIID_Sum, SfContr.PayRateDateKind );

      SfConComPD = SfConComPrimDoc( 83, SfConComRec, SfContr, SfDefCom.FIID_Sum);

      stat = SfSrv_GetCarryParms( IsNVPI, SfConComPD, SfDefCom, SfAccrue, SfContr,  
                                  @PayerFIID, @ReceiverFIID,
                                  @PayerAccount, @ReceiverAccount, @NDSPayerAccount, @NDSReceiverAccount, 0, 0 );
    end;

    if( stat == 0 )
      if( (SfDefCom.Status == SFDEFCOM_STATUS_CALCULATED) AND (SfComissRec.ReceiverID == {HeadBankID}) )
        if( SfAccrue.Amount > $0 )
          stat = SfSrvCarryAccrue( PayerFIID, ReceiverFIID, SfDefCom, SfAccrue, SfContr, SfConComRec, 
                                   PayerAccount, ReceiverAccount, NDSPayerAccount, NDSReceiverAccount,
                                   @AccTrnID, @AccTrnID_NDS, 0, 0 );
        end;
      else
        if( SfAccrue.Amount != $0 )
          stat = SfSrvCarryAccrue( PayerFIID, ReceiverFIID, SfDefCom, SfAccrue, SfContr, SfConComRec, 
                                   PayerAccount, ReceiverAccount, NDSPayerAccount, NDSReceiverAccount,
                                   @AccTrnID, @AccTrnID_NDS, 0, 0 );
        end;
      end;

      if( (stat == 0) AND ((SfAccrue.Amount != 0) OR (SfAccrue.NDSAmount != $0)) )
        stat = SfSrv_AddSfDocs( Action, SfDefCom, AccTrnID, AccTrnID_NDS );
      end;
    end;

    if( stat == 0 )
      ChangeSfDefTmpStatus( SfDefCom, SFDEFCOM_STATUS_CALCULATED );
    end;

    SfSrv_InsertAccrueLogRec( SfDefCom, SfAccrue, PayerAccount, ReceiverAccount, 0, stat, Comment );
    
    if( stat == 0 )
      stat = SfSrv_FormDocs( OutBuff, SfContr, SfComissRec, SfDefCom, SfAccrue, 
                             SfConComPD, isNVPI, PayerAccount, ReceiverAccount, TrnDate, false, 0, 0 );
    end;
  end;

  return stat;
end;


macro PostStepAction( message,     /* данный параметр может принимать следующие */
                             /* значения: 1 - выполнение шага; 2 - откат шага;  */
                errTrn,      /* статус выполнения шага. Если параметр не равен 0*/
                             /* произошла ошибка                                */
                FirstDoc,    /* указатель на первичный документ                 */
                ID_Oper,     /* внутренний идентификатор операции               */
                Number_Step, /* номер шага операции          */
                KindOper,    /* номер вида операции                             */
                KindDoc,     /* номер вида первичного документа                 */
                KindStep,    /* вид шага операции                               */
                ID_Step )    /* идентификатор шага операции                     */

  var strQuery = "", cmd;
  setbuff( SfContr, FirstDoc );

  /* Происходит откат */
  if( (message==OP_EXECUTE_STEP) AND errTrn )
    SfSrv_UpdateAccrueLogRec( SfContr, errTrn );
    return 0;    
  end;

  return 0;
end;