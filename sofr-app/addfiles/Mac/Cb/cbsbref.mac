/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*        Макроса формирования референса исходящего сообщения SBRF3         */
/*                                                                          */
/*  Имя файла: cbsbref.mac                                                  */
/*  Создан:  21.02.03                                              AAV      */
/****************************************************************************/

import CTInter, PTInter, BankInter, "cbsbtls.mac", "globals.mac";

record sbrefpmpaym (pmpaym);
record sbrefwlinfo (wlinfo);


macro GetRefOutMes( SeqValue, ObjKind, ObjAddr )
  var refer, dd, mm, yy, PayerMesID = {OurBank}, CodePayerMesBank, CodeClir, error;
  
  if( ObjKind==OBJTYPE_PAYMENT )    
    SetBuff( sbrefpmpaym,  ObjAddr );
    PayerMesID = sbrefpmpaym.PayerMesBankID;
  elif( ObjKind==OBJTYPE_INFO )    
    SetBuff( sbrefwlinfo,  ObjAddr );
    PayerMesID = sbrefwlinfo.OfficeID;
  end;

  CodeClir = PTCK_CLIRING;

  CodePayerMesBank = ПолучитьКодСубъекта( PayerMesID, CodeClir, Error );
  if( error!=0 )
    return "";
  end;

  /* Формируем 22-символьный уникальный идентификатор */
  datesplit( {curdate}, dd, mm, yy );
  refer = String( dd:2, mm:2, (yy - int(yy/1000)*1000):2, CodePayerMesBank:10:r, SeqValue:6 );
  refer = StrSubst( refer, " ", "0" );

  return refer;
end;