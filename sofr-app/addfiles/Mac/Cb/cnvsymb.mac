/*
   Макрос предназначен для конвертирования файла symbcash.dbt в связи с изменением хранения данных
   для непроведенных кассовых докментов
*/

file symbcash( symbcash ) write;

macro ConvertSymbCash
var stat = true, count = 0;

   println( "Сконвертированы записи:" );
   rewind( symbcash );
   InitProgress( Nrecords( symbcash ) );
   while( stat and next( symbcash ) )

      if( strlen(symbcash.ApplicationKey) == 12 )
        symbcash.Date = Date(0,0,0000);
      end;

      println( "DocKind=", symbcash.DocKind, ", Kind=", symbcash.Kind,
               ", ApplicationKey=", symbcash.ApplicationKey, ", Symbol=", symbcash.Symbol );

      stat = update( symbcash );
      if( not stat )
         println( "Ошибка при обновлении записи в файл, DocKind=", symbcash.DocKind, ", Kind=", symbcash.Kind,
                  ", ApplicationKey=", symbcash.ApplicationKey, ", Symbol=", symbcash.Symbol );
      end;
      count = count + 1;
      UseProgress( count );
   end;                    
   RemProgress();
   if( stat )
      println( "\nКонвертирование произведено без ошибок" );
   else
      println( "\nОшибки при конвертации" );
   end;

end;

macro UpdateFiles( p_srcDir, p_destDir )
   var stat = 0;

   if ( substr(p_destDir, strlen(p_destDir)) != "\\" )
      p_destDir = p_destDir + "\\";
   end;
   if ( substr(p_srcDir, strlen(p_srcDir)) != "\\" )
      p_srcDir = p_srcDir + "\\";
   end;

   if ( not open(symbcash, p_destDir + "symbcash.dbt" ) )
      println("Ошибка открытия файла " + p_destDir + " symbcash.dbt");
      return false;
   end;

   stat = ConvertSymbCash( );

   return stat;

end;
