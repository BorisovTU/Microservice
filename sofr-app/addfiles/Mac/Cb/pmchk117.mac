//-----------------------------------------------------------------------------
// Блок     : 29014  - "Предобработка платежа банка"
//            29015  - "Предобработка требования банка"
//            29016  - "Предобработка клиентского платежа"
//            29017  - "Предобработка кассового документа"
//            29018  - "Предобработка мемориального документа"
// Шаг      : 50(40) - "Контроль по 117-И"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, InsCarryDoc, CTInter, pm_setst, oralib, likepy, cbsttls;

private CONST SET_CHAR   = "X";
private CONST UNSET_CHAR = "";

MACRO КонтрольПо117И( Payment:RsbPayment )

  var stat:integer = 0;
  var Reject = "";
  var RejectGround:string = "";

  stat = Payment.PM_Check117( Reject, RejectGround );

  if( Reject == UNSET_CHAR )
    if(Payment.VO_Accept == ACPT_CC_NEED)
      if( УстановитьСтатусыПлатежа( OPR_PAYM_CURCONTROL, OPR_PAYM_ST_CURCONTROL_YES ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return -1;
      end;
    else
      if( УстановитьСтатусыПлатежа( OPR_PAYM_CURCONTROL, OPR_PAYM_ST_CURCONTROL_NO ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return -1;
      end;
    end;
  else
      msgbox( RejectGround );
      if( RejectPayment( Payment, RejectGround ) )
        return -1;
      end;
      
      MemoryError( stat ); // GetErrMsg сбрасывает ошибку поэтому надо звать MemoryError
      DisplayError();

  end;
  
  return 0; // Продолжить выполнение шага
END;
