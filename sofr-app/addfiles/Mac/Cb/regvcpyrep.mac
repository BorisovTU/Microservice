import regvalrep;

private macro ObjReportPrint( KeyID )

  var ObjNum = "", ObjName = "", Comment = "", RepText = "";

  var StrQuery = " SELECT t_ObjNum, t_ObjName, RSB_STRUCT.getString(t_FMTBLOBDATA_XXXX) As colComment " +
                 " FROM dregvcpyrep_tmp WHERE t_KeyID = ? ";

  var cmd = RsdCommand( StrQuery );

  cmd.addParam( "", RSDBP_IN, KeyID );

  var rs = RsdRecordset( cmd );
  while( rs.moveNext() )
    
    if( rs.value("t_ObjNum") == NULLVAL )
      ObjNum = "";
    else
      ObjNum = rs.value("t_ObjNum");
    end;
    
    if( rs.value("t_ObjName") == NULLVAL )
      ObjName = "";
    else
      ObjName = rs.value("t_ObjName");
    end;
    
    if( rs.value("colComment") == NULLVAL )
      Comment = "";
    else
      Comment = rs.value("colComment");
    end;
    
    RepText = ObjNum + " " + ObjName + " " + Comment;

[####################################################################################]( RepText:w );
  end;

end;


private macro ReportPrint( iCopyKind )

  var Reg = "";

  var cmd = RsdCommand( "SELECT * FROM dregvalcopy_tmp" );
  var rs = RsdRecordset( cmd );  

/*Настройки, которые участвовали в процедуре тиражирования, и соответствующие результаты их тиражирования:  
  Reg       Полное наименование настройки (regvalcopy.Path), значение которой тиражируется. 
В отчет попадают все настройки, которые есть в таблице regvalcopy.tmp. 
  Obj       Объект тиражирования. Варианты:
- если выбрано <C1> - ничего не выводим.
- если выбрано <C2> - узлы ТС, указанные в списке <N6>.
- если выбрано <C3> - пользователи, указанные в списке <N6>.
Выводим строку из объединенных значений полей <N6> и <A6>.
Объекты выводятся в разрезе настроек <Reg> и по каждому объекты формируем отдельную строку в отчете.
  Txt       Результат тиражирования. Подробнее что выводить описано в Примечании. */
  while( rs.moveNext() )
    Reg = rs.value( "t_Path" );
[
 ####################################################################################]( Reg );
    ObjReportPrint( rs.value("t_KeyID") );
  end;

end;

macro RegValCopyReport( iCopyKind, SrcNum, SrcName, bRealValues, bNotUpdate )

  var strCopyKind = "", Conditions = "";

  if( iCopyKind == REP_DEFAULTVALUES )
    strCopyKind = "по умолчанию";
  elif( iCopyKind == REP_BRANCHVALUES )
    strCopyKind = "для узлов ТС";
  elif( iCopyKind == REP_USERVALUES )
    strCopyKind = "для пользователей";
  end;

  if( bRealValues == true )
    Conditions = "Только действующие значения.";
  end;

  if( bNotUpdate == true )
    Conditions = Conditions + " Не изменять имеющиеся значения";
  end;

  /*Сформирован*/
  var ExecuterInfo = "";
  ExecuterInfo = {oper} + ", " + GetTypePersonName({cTypePerson}) + ", " + {Name_Oper} + ", " + GetOperDprtNodeInfo();

  var UserPost = GetUserPost();



[ Протокол тиражирования значений настроек реестра                                   ];

[ Вариант: ####################                                                      ]( strCopyKind );
[ Образец: ##### ################################################################### ]( SrcNum, SrcName );
[ Условия: ######################################################################### ]( Conditions );
 
[ Сформирован: ##################################################################### ]( ExecuterInfo );
[ Дата/время:  ########## ##########                                                 ]( date(), time() );
 
[ ---------------------------------------------------------------------------------- ];

 ReportPrint();

[ 
  ----------------------------------------------------------------------------------
                                                                                    
  ###############################          ###############################          ]( UserPost, {Name_Oper} );



end;