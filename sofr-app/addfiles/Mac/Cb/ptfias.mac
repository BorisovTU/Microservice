/*
$Name: ptfias.mac
$Module: Ядро ГКБО
$Description: Макрос, заполняющий адрес по коду ФИАС и наоборот
*/
Import bankinter, rsd, rcw, cb_sql, PTInter, commonutil, likepy, oralib; 

const english_char = "AaBCcEeЁёHKkMmOoPpTuXxYybDdFfGghIiJjLlnQqRrSstUVvWwZz!@#$%^&*=+№;:?\"\\|`~[]{}<>";
const russian_char = "ААВССЕЕЕЕНККМТООРРТИХХУУ                                                      ";

const REGION_AOLEVEL = 1;
const AREA_AOLEVEL = 3;
const CITY_AOLEVEL = 4;
const PLACE_AOLEVEL = 6;
const PLAN_AOLEVEL = 65;
const STREET_AOLEVEL = 7;

/*
file kladr_dbf    ("kladr.dbf")    dbf;
file street_dbf   ("street.dbf")   dbf;
file altnames_dbf ("altnames.dbf") dbf;
file doma_dbf     ("doma.dbf")     dbf;
file flat_dbf     ("flat.dbf")     dbf;
*/

file as_addrobj_dbt ("as_addrobj.dbt");
file as_house_dbt   ("as_house.dbt");

/***********************************************************************
   Копирует текущее содержимое Recordset'а в буфер файла или структуры

   fbuff          - буфер файла или структуры
   rset           - Recordset или TRsbDataSet
   start_rset_pos - позиция Recordset'a, начиная с которой будут копи-
                    роваться значения.  

   Возвращаемое значение: НЕТ
***********************************************************************/
macro _CopyRSetToFBuff( fbuff, rset )
  var idx   = 0,
      nflds = FldNumber( fbuff ),
      val,
      NullConv;

  ClearRecord(fbuff);

  if( IsEqClass( "RsdRecordset", rset ))
    NullConv = rset.Command.NullConversion;
    rset.Command.NullConversion = true;
  end;

  while( idx < nflds )
    val = rset.value( "t_" + FldName( fbuff, idx ) );
    if( ValType( fbuff( idx ) ) == V_STRING )
      fbuff( idx ) = SQL_ConvTypeStr( val );
    elif( val != NULL )
      fbuff( idx ) = rset.value( "t_" + FldName( fbuff, idx ), null, ValType( fbuff( idx ) ) );
    end;
    idx = idx + 1;
  end;

  if( IsEqClass( "RsdRecordset", rset ))
    rset.Command.NullConversion = NullConv;
  end;
end;

macro normalization( oldstr )
  var newstr, i, retstr; 
  newstr = oldstr;
  retstr = "";
  
  i = 0;
  while( i < StrLen(english_char))
    i = i + 1;
    newstr = StrSubst( newstr, SubStr(english_char,i,1), SubStr(russian_char,i,1));
  end;
  newstr = Trim( newstr );
  newstr = StrUpr( newstr );

  i = 0;
  while( i < StrLen(newstr))
    i = i + 1;
    if( ( CodeFor(SubStr(newstr,i,1)) != 32 ) or ( CodeFor(SubStr(newstr,i-1,1)) != 32))
      retstr = retstr + SubStr(newstr,i,1);
    end;
  end;
  return retstr;
end;

macro sql_normalization ( column_name )
  var retstr;

  retstr = "replace(replace(replace(upper(trim(translate(" + column_name + ",'" + english_char + "','" + russian_char + "'))),' ', ' '||chr(2)),chr(2)||' '),chr(2))";

  return retstr;
end;

private macro MesPrnBox(mess, prnMess)
  if((prnMess == null) or (prnMess != 0))
    if(prnMess == null)
      msgbox(mess); 
    end;
  else
    println(mess);
  end;
end;

private macro ConfirmMesPrn(mess, prnMess)
  var Result = 0;
  array TextYN;
  array ButtonYN;
  ButtonYN( 0 ) = " Да ";
  ButtonYN( 1 ) = " Нет ";
  TextYN(0) = mess;

  if((prnMess == null) or (prnMess != 0))
    if(prnMess == null)
      Result = confwin( TextYN, ButtonYN ); 
    end;
  else
    Result = 0;
  end;
  return Result;
end;

/* Проверка существования таблиц */
macro is_tab_exists( prnMess )
  var rs;

  rs = RsdRecordset("select 1 from das_addrobj_dbf where 1 = 0");
  rs.movenext;

  rs = RsdRecordset("select 1 from das_house_dbf where 1 = 0");
  rs.movenext;

  OnError(err);
  MesPrnBox("Справочники ФИАС не загружены!", prnMess);
  exit;
end;

private macro _Lpad(pStr, pAddStr, pNewLen)
  var _retval = string(pStr);
  var _StrLen = strlen(_retval);
  while((_StrLen < pNewLen) and (strlen(string(pAddStr)) > 0))
    _retval = string(pAddStr) + _retval;
    _StrLen = strlen(_retval);
  end;
  _retval = substr(_retval, strlen(_retval) - pNewLen + 1);
  return _retval;
end;

private macro _GetAddrobjFiasCodeForAOGuid(AOGuid, DefaultCode)
  var retval = DefaultCode;
  var query;
  var params : TArray;
  var rs;

  CaptureOutput;
[
SELECT 
  TRIM(t_RegionCode) || 
  TRIM(t_AreaCode) || 
  TRIM(t_CityCode) || 
  TRIM(t_PlaceCode) || 
  TRIM(t_PlanCode) || 
  TRIM(t_StreetCode) 
FROM das_addrobj_dbt WHERE t_AOGuid = :AOGuid

];
  query = StopCaptureOutput;

  params = makeArray(SQLParam("AOGuid", AOGuid)
                    );
      
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    retval = rs.value(0);
  end;

  return retval;
end;

/*
Если prnMess == null, то сообщения об ошибках выводятся на экран
Если prnMess == 0   , то сообщения об ошибках выводятся в отчет макроса
Если prnMess != 0   , то сообщения об ошибках не выводятся никуда

placeFld - поле текущее на форме адреса при ручном вводе наименований адресных объектов
*/
private macro formingFIASEx( ptaddress, mode, status_:@integer, prnMess, retFias:@string, placeFld )
  var i;
  var Text;
  var Result;
  array ButtonCCC;
  array ButtonCC;
  array ButtonC;
  array TextCC;
  var ColumnsR  : TArray = TArray;
  var ColumnsPr : TArray = TArray;
  var ColumnsD  : TArray = TArray;
  var ColumnsP  : TArray = TArray;
  var ColumnsPn : TArray = TArray;
  var ColumnsS  : TArray = TArray;
  var ColumnsH  : TArray = TArray;

  var TempFias, TempPostIndex, TempOkato, TempOktmo, TempFiasGuid;
  var Region  , CodeRegion  , newRegion  , newCodeRegion  ,
      Province, CodeProvince, newProvince, newCodeProvince,
      District, CodeDistrict, newDistrict, newCodeDistrict,
      Place   , CodePlace   , newPlace   , newCodePlace   ,   
      Plan    , CodePlan    , newPlan    , newCodePlan    ,   
      Street  , CodeStreet  , newStreet  , newCodeStreet  ;
  var House, NumCorps, Building, newHouse, newNumCorps, newBuilding;
  var tmpStatus = status_;
  
  var FormalName, ShortName, AOLevel;
  
  var stat, cmd, rs;

  var query;
  var params : TArray;

  macro EvProc( rs, cmd, id, key )
    if(( cmd == DLG_KEY ) and ( key == 13 ))
      return CM_SELECT;
    end;
  end;
  /* Вспомогательная процедура подготовки информации с атрибутами полей*/
  macro AddCol( ar,ind, fld, head, width, rdonly )
    ar.value( ind * 6 + 0 ) = fld;
    ar.value( ind * 6 + 1 ) = head;
    ar.value( ind * 6 + 2 ) = width;
    ar.value( ind * 6 + 3 ) = 2;   // fldType
    ar.value( ind * 6 + 4 ) = -1;  // decPoint
    ar.value( ind * 6 + 5 ) = 0;   // reserv
  end;
                          
  ButtonCCC( 0 ) = " Заменить ";
  ButtonCCC( 1 ) = " Оставить ";
  ButtonCCC( 2 ) = " Отменить ";

  ButtonCC( 0 ) = " Заменить ";
  ButtonCC( 1 ) = " Отменить ";

  ButtonC( 0 )  = " Отменить ";

  record address( adress );  
  record addressDOMA( adress );  

  if((prnMess == null) or (prnMess != 0))
    SetBuff( address, ptaddress );
  else
    Copy( address, ptaddress );
  end;

  stat = 1;

  CodeRegion   = address.CodeRegion;
  CodeProvince = address.CodeProvince;
  CodeDistrict = address.CodeDistrict;
  CodePlace    = address.CodePlace;
  CodePlan     = address.CodePlan;
  CodeStreet   = address.CodeStreet;
  
  if(( strlen( CodeRegion ) > 1 ) and ( SubStr( CodeRegion, strlen( CodeRegion )) == "." ))
    CodeRegion = SubStr( CodeRegion, 1, strlen( CodeRegion ) - 1 );                    
  end;
  if(( strlen( CodeProvince ) > 1 ) and ( SubStr( CodeProvince, strlen( CodeProvince )) == "." ))
    CodeProvince = SubStr( CodeProvince, 1, strlen( CodeProvince ) - 1 );
  end;
  if(( strlen( CodeDistrict ) > 1) and ( SubStr( CodeDistrict, strlen( CodeDistrict )) == "." ))
    CodeDistrict = SubStr( CodeDistrict, 1, strlen(CodeDistrict) - 1 );                       
  end;
  if(( strlen( CodePlace ) > 1 ) and ( SubStr( CodePlace, strlen( CodePlace )) == "." ))
    CodePlace = SubStr( CodePlace, 1, strlen( CodePlace ) - 1 );
  end;
  if(( strlen( CodePlan ) > 1 ) and ( SubStr( CodePlan, strlen( CodePlan )) == "." ))
    CodePlan = SubStr( CodePlan, 1, strlen( CodePlan ) - 1 );
  end;
  if(( strlen( CodeStreet ) > 1 ) and ( SubStr( CodeStreet, strlen( CodeStreet )) == "." ))
    CodeStreet = SubStr( CodeStreet, 1, strlen( CodeStreet ) - 1 );
  end;

  /* Определение кода КЛАДР по адресным полям */
  if( mode == 0 )
    TempFias = "";
    TempFiasGuid = "";
    TempPostIndex = "";
    /* НОРМАЛИЗАЦИЯ */  
    Region   = normalization( address.Region );
    Province = normalization( address.Province );
    District = normalization( address.District );
    Place    = normalization( address.Place );
    Plan     = normalization( address.Plan );
    Street   = normalization( address.Street );
    House    = normalization( address.House );
    NumCorps = normalization( address.NumCorps );
    Building = normalization( address.Building );

    if( Region == "" )
      MesPrnBox("Не задан регион!", prnMess); 
      return 1;
    end;

    /* поиск региона */
    i = 0;
    if((placeFld == 0) or (placeFld >= 2))
    if( address.PostIndex != "" )
/*
      CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

      query = StopCaptureOutput;

      params = makeArray(SQLParam("FormalName", Region)
                      ,SQLParam("ShortName", CodeRegion)
                      ,SQLParam("AreaCode", "000")
                      ,SQLParam("CityCode", "000")
                      ,SQLParam("PlaceCode", "000")
                      ,SQLParam("PlanCode", "0000")
                      ,SQLParam("StreetCode", "0000")
                      ,SQLParam("NextID", "")
                      ,SQLParam("AOLevel", REGION_AOLEVEL)
                      ,SQLParam("PostalCode", trim(address.PostIndex))
                      );
      
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        i = rs.value(0);
        if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
          i = 0;
          CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

          query = StopCaptureOutput;
          
          params = makeArray(SQLParam("FormalName", Region)
                          ,SQLParam("ShortName", CodeRegion)
                          ,SQLParam("AreaCode", "000")
                          ,SQLParam("CityCode", "000")
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", REGION_AOLEVEL)
                          ,SQLParam("PostalCode", trim(address.PostIndex))
                          );
      
          rs = execSQLselect(query, params, true);
          while(rs and rs.moveNext() and (i < 2))
            if(i == 0)
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
            end;

            i = i + 1;
          end;

          if(i == 1)
            TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                 trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                 trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
            TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
            TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
            address.CodeRegion = trim(as_addrobj_dbt.ShortName);
            address.Region     = trim(as_addrobj_dbt.FormalName);
            address.RegionNum  = trim(as_addrobj_dbt.RegionCode);
            if(trim(as_addrobj_dbt.Okato) != "") 
              TempOkato = trim(as_addrobj_dbt.Okato); 
            end;
            if(trim(as_addrobj_dbt.Oktmo) != "") 
              TempOktmo = trim(as_addrobj_dbt.Oktmo); 
            end;
          end;
/*
        end;
      end;
*/
    end;
    
    if(( i != 1 ) and ( address.Okato != "" ))
/*
      CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

      query = StopCaptureOutput;

      params = makeArray(SQLParam("FormalName", Region)
                      ,SQLParam("ShortName", CodeRegion)
                      ,SQLParam("AreaCode", "000")
                      ,SQLParam("CityCode", "000")
                      ,SQLParam("PlaceCode", "000")
                      ,SQLParam("PlanCode", "0000")
                      ,SQLParam("StreetCode", "0000")
                      ,SQLParam("NextID", "")
                      ,SQLParam("AOLevel", REGION_AOLEVEL)
                      ,SQLParam("Okato", trim(address.Okato))
                      );
      
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        i = rs.value(0);
        if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
          i = 0;
          CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

          query = StopCaptureOutput;
          
          params = makeArray(SQLParam("FormalName", Region)
                            ,SQLParam("ShortName", CodeRegion)
                            ,SQLParam("AreaCode", "000")
                            ,SQLParam("CityCode", "000")
                            ,SQLParam("PlaceCode", "000")
                            ,SQLParam("PlanCode", "0000")
                            ,SQLParam("StreetCode", "0000")
                            ,SQLParam("NextID", "")
                            ,SQLParam("AOLevel", REGION_AOLEVEL)
                            ,SQLParam("Okato", trim(address.Okato))
                            );
          
          rs = execSQLselect(query, params, true);
          while(rs and rs.moveNext() and (i < 2))
            if(i == 0)
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
            end;

            i = i + 1;
          end;

          if(i == 1)
            TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                 trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                 trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
            TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
            TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
            address.CodeRegion = trim(as_addrobj_dbt.ShortName);
            address.Region     = trim(as_addrobj_dbt.FormalName);
            address.RegionNum  = trim(as_addrobj_dbt.RegionCode);
            if(trim(as_addrobj_dbt.Okato) != "") 
              TempOkato = trim(as_addrobj_dbt.Okato); 
            end;
            if(trim(as_addrobj_dbt.Oktmo) != "") 
              TempOktmo = trim(as_addrobj_dbt.Oktmo); 
            end;
          end;
/*
        end;
      end;
*/
    end;
    
    if( i != 1 )
/*
      CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

      query = StopCaptureOutput;

      params = makeArray(SQLParam("FormalName", Region)
                      ,SQLParam("ShortName", CodeRegion)
                      ,SQLParam("AreaCode", "000")
                      ,SQLParam("CityCode", "000")
                      ,SQLParam("PlaceCode", "000")
                      ,SQLParam("PlanCode", "0000")
                      ,SQLParam("StreetCode", "0000")
                      ,SQLParam("NextID", "")
                      ,SQLParam("AOLevel", REGION_AOLEVEL)
                      );
      
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        i = rs.value(0);
        if( i == 0 )
          MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeRegion + " " + address.Region, prnMess); 
          return 1;
        elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
          i = 0;
          CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

          query = StopCaptureOutput;
          
          params = makeArray(SQLParam("FormalName", Region)
                            ,SQLParam("ShortName", CodeRegion)
                            ,SQLParam("AreaCode", "000")
                            ,SQLParam("CityCode", "000")
                            ,SQLParam("PlaceCode", "000")
                            ,SQLParam("PlanCode", "0000")
                            ,SQLParam("StreetCode", "0000")
                            ,SQLParam("NextID", "")
                            ,SQLParam("AOLevel", REGION_AOLEVEL)
                            );
          
          rs = execSQLselect(query, params, true);
          while(rs and rs.moveNext() and (i < 2))
            if(i == 0)
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
            end;

            i = i + 1;
          end;

          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeRegion + " " + address.Region, prnMess); 
            return 1;
          end;
          
          if(i == 1)
            TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                 trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                 trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
            TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
            TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
            address.CodeRegion = trim(as_addrobj_dbt.ShortName);
            address.Region     = trim(as_addrobj_dbt.FormalName);
            address.RegionNum  = trim(as_addrobj_dbt.RegionCode);
            if(trim(as_addrobj_dbt.Okato) != "") 
              TempOkato = trim(as_addrobj_dbt.Okato); 
            end;
            if(trim(as_addrobj_dbt.Oktmo) != "") 
              TempOktmo = trim(as_addrobj_dbt.Oktmo); 
            end;
          end;
        if (( i > 1 ) and (prnMess == null))
          CaptureOutput;
[
SELECT ao.*,
       ao.t_RegionCode || 
       ao.t_AreaCode || 
       ao.t_CityCode || 
       ao.t_PlaceCode || 
       ao.t_PlaceCode || 
       ao.t_StreetCode || '0000' AS t_FullCode
  FROM das_addrobj_dbt ao
 WHERE    :FormalName = #
      AND ao.t_ShortName = :ShortName
      AND ao.t_AreaCode = :AreaCode
      AND ao.t_CityCode = :CityCode
      AND ao.t_PlaceCode = :PlaceCode
      AND ao.t_PlanCode = :PlanCode
      AND ao.t_StreetCode = :StreetCode
      AND ao.t_NextID = :NextID
      AND ao.t_AOLevel = :AOLevel
] (sql_normalization("ao.t_FormalName"));

          query = StopCaptureOutput;
          
          params = makeArray(SQLParam("FormalName", Region)
                            ,SQLParam("ShortName", CodeRegion)
                            ,SQLParam("AreaCode", "000")
                            ,SQLParam("CityCode", "000")
                            ,SQLParam("PlaceCode", "000")
                            ,SQLParam("PlanCode", "0000")
                            ,SQLParam("StreetCode", "0000")
                            ,SQLParam("NextID", "")
                            ,SQLParam("AOLevel", REGION_AOLEVEL)
                            );
          
          rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

          AddCol( ColumnsR, 0, "t_FormalName"  , "Наименование", null, true);
          AddCol( ColumnsR, 1, "t_ShortName"  , "Тип", null, true);
          AddCol( ColumnsR, 2, "t_FullCode"  , "Код", null, true);
          AddCol( ColumnsR, 3, "t_PostalCode" , "Индекс", null, true);
          AddCol( ColumnsR, 4, "t_IfnsFl", "Налог.орг.", null, true);
          AddCol( ColumnsR, 5, "t_TerrIfnsFl", "Номер ИМНС", null, true);
          AddCol( ColumnsR, 6, "t_Okato" , "Код ОКАТО", null, true);
          AddCol( ColumnsR, 7, "t_ActStatus", "Статус", null, true);

          if( RunScroll( rs, 8, ColumnsR, "Регионы", "EvProc", "Выбрать регион", "~Esc~ Отмена, ~Enter~ Выбор", true ))
            _CopyRSetToFBuff(as_addrobj_dbt, rs);
            TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                 trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                 trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
            TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
            TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
            address.CodeRegion = trim(as_addrobj_dbt.ShortName);
            address.Region     = trim(as_addrobj_dbt.FormalName);
            address.RegionNum  = trim(as_addrobj_dbt.RegionCode);
            if(trim(as_addrobj_dbt.Okato) != "") 
              TempOkato = trim(as_addrobj_dbt.Okato); 
            end;
            if(trim(as_addrobj_dbt.Oktmo) != "") 
              TempOktmo = trim(as_addrobj_dbt.Oktmo); 
            end;
          end;
        end;
/*
        end;
      end;
*/
    end;
    end;

    /* поиск района */
    if((placeFld == 0) or (placeFld >= 5))
    if(( address.CodeProvince != "" ) or ( address.Province != "" ))
      i = 0;
      if( address.PostIndex != "" )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Province)
                          ,SQLParam("ShortName", CodeProvince)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("CityCode", "000")
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", AREA_AOLEVEL)
                          ,SQLParam("PostalCode", trim(address.PostIndex))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
      
            params = makeArray(SQLParam("FormalName", Province)
                              ,SQLParam("ShortName", CodeProvince)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("CityCode", "000")
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", AREA_AOLEVEL)
                              ,SQLParam("PostalCode", trim(address.PostIndex))
                              );
          
            rs = execSQLselect(query, params, true);

            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeProvince = trim(as_addrobj_dbt.ShortName);
              address.Province     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;
      
        params = makeArray(SQLParam("FormalName", Province)
                          ,SQLParam("ShortName", CodeProvince)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("CityCode", "000")
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", AREA_AOLEVEL)
                          ,SQLParam("Okato", trim(address.Okato))
                          );
        
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
          
            params = makeArray(SQLParam("FormalName", Province)
                              ,SQLParam("ShortName", CodeProvince)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("CityCode", "000")
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", AREA_AOLEVEL)
                              ,SQLParam("Okato", trim(address.Okato))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeProvince = trim(as_addrobj_dbt.ShortName);
              address.Province     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if( i != 1 )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;
      
        params = makeArray(SQLParam("FormalName", Province)
                          ,SQLParam("ShortName", CodeProvince)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("CityCode", "000")
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", AREA_AOLEVEL)
                          );
        
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeProvince + " " + address.Province, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
          
            params = makeArray(SQLParam("FormalName", Province)
                              ,SQLParam("ShortName", CodeProvince)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("CityCode", "000")
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", AREA_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if( i == 0 )
              MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeProvince + " " + address.Province, prnMess); 
              return 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeProvince = trim(as_addrobj_dbt.ShortName);
              address.Province     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          if (( i > 1 ) and (prnMess == null))
            CaptureOutput;
[
SELECT ao.*,
       ao.t_RegionCode || 
       ao.t_AreaCode || 
       ao.t_CityCode || 
       ao.t_PlaceCode || 
       ao.t_PlaceCode || 
       ao.t_StreetCode || '0000' AS t_FullCode
  FROM das_addrobj_dbt ao
 WHERE    :FormalName = #
      AND ao.t_ShortName = :ShortName
      AND ao.t_RegionCode = :RegionCode
      AND ao.t_CityCode = :CityCode
      AND ao.t_PlaceCode = :PlaceCode
      AND ao.t_PlanCode = :PlanCode
      AND ao.t_StreetCode = :StreetCode
      AND ao.t_NextID = :NextID
      AND ao.t_AOLevel = :AOLevel
] (sql_normalization("ao.t_FormalName"));

            query = StopCaptureOutput;
          
            params = makeArray(SQLParam("FormalName", Province)
                              ,SQLParam("ShortName", CodeProvince)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("CityCode", "000")
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", AREA_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

            AddCol( ColumnsPr, 0, "t_FormalName"  , "Наименование", null, true);
            AddCol( ColumnsPr, 1, "t_ShortName"  , "Тип", null, true);
            AddCol( ColumnsPr, 2, "t_FullCode"  , "Код", null, true);
            AddCol( ColumnsPr, 3, "t_PostalCode" , "Индекс", null, true);
            AddCol( ColumnsPr, 4, "t_IfnsFl", "Налог.орг.", null, true);
            AddCol( ColumnsPr, 5, "t_TerrIfnsFl", "Номер ИМНС", null, true);
            AddCol( ColumnsPr, 6, "t_Okato" , "Код ОКАТО", null, true);
            AddCol( ColumnsPr, 7, "t_ActStatus", "Статус", null, true);

            if( RunScroll( rs, 8, ColumnsPr, "Районы", "EvProc", "Выбрать район", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeProvince = trim(as_addrobj_dbt.ShortName);
              address.Province     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          end;
/*
          end;
        end;
*/
      end;
    end;
    end;

    /* поиск города */
    if((placeFld == 0) or (placeFld >= 8))
    if(( address.CodeDistrict != "" ) or ( address.District != "" ))
      i = 0;
      if( address.PostIndex != "" )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", District)
                          ,SQLParam("ShortName", CodeDistrict)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", CITY_AOLEVEL)
                          ,SQLParam("PostalCode", trim(address.PostIndex))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", District)
                              ,SQLParam("ShortName", CodeDistrict)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", CITY_AOLEVEL)
                              ,SQLParam("PostalCode", trim(address.PostIndex))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeDistrict = trim(as_addrobj_dbt.ShortName);
              address.District     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", District)
                          ,SQLParam("ShortName", CodeDistrict)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", CITY_AOLEVEL)
                          ,SQLParam("Okato", trim(address.Okato))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", District)
                              ,SQLParam("ShortName", CodeDistrict)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", CITY_AOLEVEL)
                              ,SQLParam("Okato", trim(address.Okato))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeDistrict = trim(as_addrobj_dbt.ShortName);
              address.District     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if( i != 1 )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;
        
        params = makeArray(SQLParam("FormalName", District)
                          ,SQLParam("ShortName", CodeDistrict)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("PlaceCode", "000")
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", CITY_AOLEVEL)
                          );
            
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeDistrict + " " + address.District, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", District)
                              ,SQLParam("ShortName", CodeDistrict)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", CITY_AOLEVEL)
                              );
                
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if( i == 0 )
              MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeDistrict + " " + address.District, prnMess); 
              return 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeDistrict = trim(as_addrobj_dbt.ShortName);
              address.District     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          if (( i > 1 ) and (prnMess == null))
            CaptureOutput;
[
SELECT ao.*,
       ao.t_RegionCode || 
       ao.t_AreaCode || 
       ao.t_CityCode || 
       ao.t_PlaceCode || 
       ao.t_PlaceCode || 
       ao.t_StreetCode || '0000' AS t_FullCode
  FROM das_addrobj_dbt ao
 WHERE    :FormalName = #
      AND ao.t_ShortName = :ShortName
      AND ao.t_RegionCode = :RegionCode
      AND ao.t_AreaCode = :AreaCode
      AND ao.t_PlaceCode = :PlaceCode
      AND ao.t_PlanCode = :PlanCode
      AND ao.t_StreetCode = :StreetCode
      AND ao.t_NextID = :NextID
      AND ao.t_AOLevel = :AOLevel
] (sql_normalization("ao.t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", District)
                              ,SQLParam("ShortName", CodeDistrict)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("PlaceCode", "000")
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", CITY_AOLEVEL)
                              );
                
            rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

            AddCol( ColumnsD, 0, "t_FormalName"  , "Наименование", null, true);
            AddCol( ColumnsD, 1, "t_ShortName"  , "Тип", null, true);
            AddCol( ColumnsD, 2, "t_FullCode"  , "Код", null, true);
            AddCol( ColumnsD, 3, "t_PostalCode" , "Индекс", null, true);
            AddCol( ColumnsD, 4, "t_IfnsFl", "Налог.орг.", null, true);
            AddCol( ColumnsD, 5, "t_TerrIfnsFl", "Номер ИМНС", null, true);
            AddCol( ColumnsD, 6, "t_Okato" , "Код ОКАТО", null, true);
            AddCol( ColumnsD, 7, "t_ActStatus", "Статус", null, true);
            
            if( RunScroll( rs, 8, ColumnsD, "Города", "EvProc", "Выбрать город", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeDistrict = trim(as_addrobj_dbt.ShortName);
              address.District     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          end;
/*
          end;
        end;
*/
      end;
    end;
    end;

    /* поиск населенного пункта */
    if((placeFld == 0) or (placeFld >= 11))
    if(( address.CodePlace != "" ) or ( address.Place != "" ))
      i = 0;
      if( address.PostIndex != "" )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Place)
                          ,SQLParam("ShortName", CodePlace)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", PLACE_AOLEVEL)
                          ,SQLParam("PostalCode", trim(address.PostIndex))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Place)
                              ,SQLParam("ShortName", CodePlace)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLACE_AOLEVEL)
                              ,SQLParam("PostalCode", trim(address.PostIndex))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlace = trim(as_addrobj_dbt.ShortName);
              address.Place     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Place)
                          ,SQLParam("ShortName", CodePlace)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", PLACE_AOLEVEL)
                          ,SQLParam("Okato", trim(address.Okato))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Place)
                              ,SQLParam("ShortName", CodePlace)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLACE_AOLEVEL)
                              ,SQLParam("Okato", trim(address.Okato))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlace = trim(as_addrobj_dbt.ShortName);
              address.Place     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if( i != 1 )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Place)
                          ,SQLParam("ShortName", CodePlace)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlanCode", "0000")
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", PLACE_AOLEVEL)
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodePlace + " " + address.Place, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Place)
                              ,SQLParam("ShortName", CodePlace)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLACE_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if( i == 0 )
              MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodePlace + " " + address.Place, prnMess); 
              return 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlace = trim(as_addrobj_dbt.ShortName);
              address.Place     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          if (( i > 1 ) and (prnMess == null))
            CaptureOutput;
[
SELECT ao.*,
       ao.t_RegionCode || 
       ao.t_AreaCode || 
       ao.t_CityCode || 
       ao.t_PlaceCode || 
       ao.t_PlaceCode || 
       ao.t_StreetCode || '0000' AS t_FullCode
  FROM das_addrobj_dbt ao
 WHERE    :FormalName = #
      AND ao.t_ShortName = :ShortName
      AND ao.t_RegionCode = :RegionCode
      AND ao.t_AreaCode = :AreaCode
      AND ao.t_CityCode = :CityCode
      AND ao.t_PlanCode = :PlanCode
      AND ao.t_StreetCode = :StreetCode
      AND ao.t_NextID = :NextID
      AND ao.t_AOLevel = :AOLevel
] (sql_normalization("ao.t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Place)
                              ,SQLParam("ShortName", CodePlace)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlanCode", "0000")
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLACE_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

            AddCol( ColumnsP, 0, "t_FormalName"  , "Наименование", null, true);
            AddCol( ColumnsP, 1, "t_ShortName"  , "Тип", null, true);
            AddCol( ColumnsP, 2, "t_FullCode"  , "Код", null, true);
            AddCol( ColumnsP, 3, "t_PostalCode" , "Индекс", null, true);
            AddCol( ColumnsP, 4, "t_IfnsFl", "Налог.орг.", null, true);
            AddCol( ColumnsP, 5, "t_TerrIfnsFl", "Номер ИМНС", null, true);
            AddCol( ColumnsP, 6, "t_Okato" , "Код ОКАТО", null, true);
            AddCol( ColumnsP, 7, "t_ActStatus", "Статус", null, true);
            
            if( RunScroll( rs, 8, ColumnsP, "Населенные пункты", "EvProc", "Выбрать населенный пункт", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlace = trim(as_addrobj_dbt.ShortName);
              address.Place     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          end;
/*
          end;
        end;
*/
      end
    end;
    end;

    /* поиск планировочной структуры */
    if((placeFld == 0) or (placeFld >= 13))
    if(( address.CodePlan != "" ) or ( address.Plan != "" ))
      i = 0;
      if( address.PostIndex != "" )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Plan)
                          ,SQLParam("ShortName", CodePlan)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", PLAN_AOLEVEL)
                          ,SQLParam("PostalCode", trim(address.PostIndex))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Plan)
                              ,SQLParam("ShortName", CodePlan)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLAN_AOLEVEL)
                              ,SQLParam("PostalCode", trim(address.PostIndex))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlan = trim(as_addrobj_dbt.ShortName);
              address.Plan     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Plan)
                          ,SQLParam("ShortName", CodePlan)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", PLAN_AOLEVEL)
                          ,SQLParam("Okato", trim(address.Okato))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Plan)
                              ,SQLParam("ShortName", CodePlan)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLAN_AOLEVEL)
                              ,SQLParam("Okato", trim(address.Okato))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlan = trim(as_addrobj_dbt.ShortName);
              address.Plan     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if( i != 1 )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Plan)
                          ,SQLParam("ShortName", CodePlan)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                          ,SQLParam("StreetCode", "0000")
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", PLAN_AOLEVEL)
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodePlan + " " + address.Plan, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Plan)
                              ,SQLParam("ShortName", CodePlan)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLAN_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if( i == 0 )
              MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodePlan + " " + address.Plan, prnMess); 
              return 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlan = trim(as_addrobj_dbt.ShortName);
              address.Plan     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          if (( i > 1 ) and (prnMess == null))
            CaptureOutput;
[
SELECT ao.*,
       ao.t_RegionCode || 
       ao.t_AreaCode || 
       ao.t_CityCode || 
       ao.t_PlaceCode || 
       ao.t_PlaceCode || 
       ao.t_StreetCode || '0000' AS t_FullCode
  FROM das_addrobj_dbt ao
 WHERE    :FormalName = #
      AND ao.t_ShortName = :ShortName
      AND ao.t_RegionCode = :RegionCode
      AND ao.t_AreaCode = :AreaCode
      AND ao.t_CityCode = :CityCode
      AND ao.t_PlaceCode = :PlaceCode
      AND ao.t_StreetCode = :StreetCode
      AND ao.t_NextID = :NextID
      AND ao.t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Plan)
                              ,SQLParam("ShortName", CodePlan)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("StreetCode", "0000")
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", PLAN_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

            AddCol( ColumnsP, 0, "t_FormalName"  , "Наименование", null, true);
            AddCol( ColumnsP, 1, "t_ShortName"  , "Тип", null, true);
            AddCol( ColumnsP, 2, "t_FullCode"  , "Код", null, true);
            AddCol( ColumnsP, 3, "t_PostalCode" , "Индекс", null, true);
            AddCol( ColumnsP, 4, "t_IfnsFl", "Налог.орг.", null, true);
            AddCol( ColumnsP, 5, "t_TerrIfnsFl", "Номер ИМНС", null, true);
            AddCol( ColumnsP, 6, "t_Okato" , "Код ОКАТО", null, true);
            AddCol( ColumnsP, 7, "t_ActStatus", "Статус", null, true);
            
            if( RunScroll( rs, 8, ColumnsP, "Планировочные структуры", "EvProc", "Выбрать планировочную структуру", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodePlan = trim(as_addrobj_dbt.ShortName);
              address.Plan     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          end;
/*
          end;
        end;
*/
      end
    end;
    end;

    /* поиск улицы */
    if((placeFld == 0) or (placeFld >= 17))
    if(( address.CodeStreet != "" ) or ( address.Street != "" ))
      i = 0;
      if( address.PostIndex != "" )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Street)
                          ,SQLParam("ShortName", CodeStreet)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                          ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", STREET_AOLEVEL)
                          ,SQLParam("PostalCode", trim(address.PostIndex))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_PostalCode = :PostalCode
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Street)
                              ,SQLParam("ShortName", CodeStreet)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", STREET_AOLEVEL)
                              ,SQLParam("PostalCode", trim(address.PostIndex))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeStreet = trim(as_addrobj_dbt.ShortName);
              address.Street     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if(( i != 1 ) and ( address.Okato != "" ))
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Street)
                          ,SQLParam("ShortName", CodeStreet)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                          ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", STREET_AOLEVEL)
                          ,SQLParam("Okato", trim(address.Okato))
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
      AND t_Okato = :Okato
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Street)
                              ,SQLParam("ShortName", CodeStreet)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", STREET_AOLEVEL)
                              ,SQLParam("Okato", trim(address.Okato))
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeStreet = trim(as_addrobj_dbt.ShortName);
              address.Street     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
/*
          end;
        end;
*/
      end;
      if( i != 1 )
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("FormalName", Street)
                          ,SQLParam("ShortName", CodeStreet)
                          ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                          ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                          ,SQLParam("CityCode", substr(TempFias, 6, 3))
                          ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                          ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                          ,SQLParam("NextID", "")
                          ,SQLParam("AOLevel", STREET_AOLEVEL)
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if( i == 0 )
            MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeStreet + " " + address.Street, prnMess); 
            return 1;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    :FormalName = #
      AND t_ShortName = :ShortName
      AND t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_NextID = :NextID
      AND t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Street)
                              ,SQLParam("ShortName", CodeStreet)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", STREET_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_addrobj_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if( i == 0 )
              MesPrnBox("Ошибка в наименовании адресных данных: " + address.CodeStreet + " " + address.Street, prnMess); 
              return 1;
            end;

            if(i == 1)
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeStreet = trim(as_addrobj_dbt.ShortName);
              address.Street     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          if (( i > 1 ) and (prnMess == null))
            CaptureOutput;
[
SELECT ao.*,
       ao.t_RegionCode || 
       ao.t_AreaCode || 
       ao.t_CityCode || 
       ao.t_PlaceCode || 
       ao.t_PlaceCode || 
       ao.t_StreetCode || '0000' AS t_FullCode
  FROM das_addrobj_dbt ao
 WHERE    :FormalName = #
      AND ao.t_ShortName = :ShortName
      AND ao.t_RegionCode = :RegionCode
      AND ao.t_AreaCode = :AreaCode
      AND ao.t_CityCode = :CityCode
      AND ao.t_PlaceCode = :PlaceCode
      AND ao.t_PlanCode = :PlanCode
      AND ao.t_NextID = :NextID
      AND ao.t_AOLevel = :AOLevel
] (sql_normalization("t_FormalName"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("FormalName", Street)
                              ,SQLParam("ShortName", CodeStreet)
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", STREET_AOLEVEL)
                              );
            
            rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

            AddCol( ColumnsS, 0, "t_FormalName"  , "Наименование", null, true);
            AddCol( ColumnsS, 1, "t_ShortName"  , "Тип", null, true);
            AddCol( ColumnsS, 2, "t_FullCode"  , "Код", null, true);
            AddCol( ColumnsS, 3, "t_PostalCode" , "Индекс", null, true);
            AddCol( ColumnsS, 4, "t_IfnsFl", "Налог.орг.", null, true);
            AddCol( ColumnsS, 5, "t_TerrIfnsFl", "Номер ИМНС", null, true);
            AddCol( ColumnsS, 6, "t_Okato" , "Код ОКАТО", null, true);
            
            if( RunScroll( rs, 7, ColumnsS, "Улицы", "EvProc", "Выбрать улицу", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff(as_addrobj_dbt, rs);
              TempFias           = trim(as_addrobj_dbt.RegionCode) + trim(as_addrobj_dbt.AreaCode) + 
                                   trim(as_addrobj_dbt.CityCode) + trim(as_addrobj_dbt.PlaceCode) + 
                                   trim(as_addrobj_dbt.PlanCode) + trim(as_addrobj_dbt.StreetCode) + "0000";
              TempFiasGuid       = trim(as_addrobj_dbt.AOGUID);
              TempPostIndex      = trim(as_addrobj_dbt.PostalCode);
              address.CodeStreet = trim(as_addrobj_dbt.ShortName);
              address.Street     = trim(as_addrobj_dbt.FormalName);
              if(trim(as_addrobj_dbt.Okato) != "") 
                TempOkato = trim(as_addrobj_dbt.Okato); 
              end;
              if(trim(as_addrobj_dbt.Oktmo) != "") 
                TempOktmo = trim(as_addrobj_dbt.Oktmo); 
              end;
            end;
          end;
/*
          end;
        end;
*/
      end;
    else
      /*Для случаев, когда дома не привязаны к улицам нужно дополнить код нулями до размера кода улицы и дома*/
      if(address.House != "")
        TempFias = substr(TempFias, 1, 15) + "00000000";
      end;
    end;
    end;

    /* поиск дома */
    if((placeFld == 0) or (placeFld >= 19))
    if(address.House != "")
      i = 0;
      if((address.House != "") or (address.NumCorps != "") or (address.Building != ""))
/*
        CaptureOutput;
[
SELECT COUNT(*) FROM das_house_dbt 
 WHERE    :HouseNum = #
      AND :BuildNum = #
      AND :StrucNum = #
      AND t_AOGUID = :AOGUID
      AND t_EndDate > :Today
] (sql_normalization("t_HouseNum"), sql_normalization("t_BuildNum"), sql_normalization("t_StrucNum"));

        query = StopCaptureOutput;

        params = makeArray(SQLParam("HouseNum", address.House)
                          ,SQLParam("BuildNum", address.NumCorps)
                          ,SQLParam("StrucNum", address.Building)
                          ,SQLParam("AOGUID", TempFiasGuid)
                          ,SQLParam("Today", date())
                          );
      
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          i = rs.value(0);
          if( i == 0 )
            var _ConfStr = "Указанный номер дома " + address.House;
            if( strlen(address.NumCorps) > 0 )
              _ConfStr = _ConfStr + ", корпус " + address.NumCorps; 
            end;
            if( strlen(address.Building) > 0 )
              _ConfStr = _ConfStr + ", строение " + address.Building; 
            end;
            _ConfStr = _ConfStr + " не найден в ФИАС. Вы уверены в его правильности?"; 
            i = ConfirmMesPrn(_ConfStr, prnMess); 
            if((i == 0) and ((prnMess == null) or (prnMess == 0)))
              MesPrnBox("Будет использован индекс, код ФИАС, код ОКАТО и код ОКТМО вышестоящего адресного объекта", prnMess);
            else
              return 1;
            end;
          elif (( i == 1 ) or (not((prnMess == null) or (prnMess != 0))))
*/
            if((address.CodeRegion != "") and (address.Region != ""))
              FormalName = address.Region;
              ShortName = address.CodeRegion;
              AOLevel = REGION_AOLEVEL;
            end;
            if((address.CodeProvince != "") and (address.Province != ""))
              FormalName = address.Province;
              ShortName = address.CodeProvince;
              AOLevel = AREA_AOLEVEL;
            end;
            if((address.CodeDistrict != "") and (address.District != ""))
              FormalName = address.District;
              ShortName = address.CodeDistrict;
              AOLevel = CITY_AOLEVEL;
            end;
            if((address.CodePlace != "") and (address.Place != ""))
              FormalName = address.Place;
              ShortName = address.CodePlace;
              AOLevel = PLACE_AOLEVEL;
            end;
            if((address.CodePlan != "") and (address.Plan != ""))
              FormalName = address.Plan;
              ShortName = address.CodePlan;
              AOLevel = PLAN_AOLEVEL;
            end;
            if((address.CodeStreet != "") and (address.Street != ""))
              FormalName = address.Street;
              ShortName = address.CodeStreet;
              AOLevel = STREET_AOLEVEL;
            end;
            
            i = 0;
            CaptureOutput;
[
SELECT * FROM das_house_dbt 
 WHERE    :HouseNum = #
      AND :BuildNum = #
      AND :StrucNum = #
      AND t_AOGUID IN 
                 (SELECT as_addrobj.t_aoguid
                    FROM das_addrobj_dbt as_addrobj
                   WHERE     as_addrobj.t_plancode = :PlanCode
                         AND as_addrobj.t_placecode = :PlaceCode
                         AND as_addrobj.t_citycode = :CityCode
                         AND as_addrobj.t_areacode = :AreaCode
                         AND as_addrobj.t_regioncode = :RegionCode
                         AND as_addrobj.t_nextid = :NextID
                         AND as_addrobj.t_aolevel = :AOLevel
                         AND as_addrobj.t_formalname = :FormalName
                         AND as_addrobj.t_shortname = :ShortName)
      AND t_EndDate > :Today
] (sql_normalization("t_HouseNum"), sql_normalization("t_BuildNum"), sql_normalization("t_StrucNum"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("HouseNum", normalization(address.House))
                              ,SQLParam("BuildNum", normalization(address.NumCorps))
                              ,SQLParam("StrucNum", normalization(address.Building))
                              ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", AOLevel)
                              ,SQLParam("FormalName", FormalName)
                              ,SQLParam("ShortName", ShortName)
                              ,SQLParam("Today", date())
                              );
            
            rs = execSQLselect(query, params, true);
            while(rs and rs.moveNext() and (i < 2))
              if(i == 0)
                _CopyRSetToFBuff(as_house_dbt, rs);
              end;
            
              i = i + 1;
            end;

            if( i == 0 )
              var _ConfStr = "Указанный номер дома " + address.House;
              if( strlen(address.NumCorps) > 0 )
                _ConfStr = _ConfStr + ", корпус " + address.NumCorps; 
              end;
              if( strlen(address.Building) > 0 )
                _ConfStr = _ConfStr + ", строение " + address.Building; 
              end;
              _ConfStr = _ConfStr + " не найден в ФИАС. Вы уверены в его правильности?"; 
              i = ConfirmMesPrn(_ConfStr, prnMess); 
              if((i == 0) and ((prnMess == null) or (prnMess == 0)))
                MesPrnBox("Будет использован индекс, код ФИАС, код ОКАТО и код ОКТМО вышестоящего адресного объекта", prnMess);
              else
                return 1;
              end;
            end;
            
            if(i == 1)
              TempFias           = _GetAddrobjFiasCodeForAOGuid(trim(as_house_dbt.AOGuid), substr(TempFias, 1, 19)) + _Lpad(as_house_dbt.Counter, "0", 4);
              TempFiasGuid       = trim(as_house_dbt.HouseGUID);
              TempPostIndex      = trim(as_house_dbt.PostalCode);
              address.House = trim(as_house_dbt.HouseNum);
              address.NumCorps = trim(as_house_dbt.BuildNum);
              address.Building = trim(as_house_dbt.StrucNum);
              if(trim(as_house_dbt.Okato) != "") 
                TempOkato = trim(as_house_dbt.Okato); 
              end;
              if(trim(as_house_dbt.Oktmo) != "") 
                TempOktmo = trim(as_house_dbt.Oktmo); 
              end;
            end;

          if (( i > 1 ) and (prnMess == null))
            CaptureOutput;
[
SELECT ah.*, :Fias || TO_CHAR(ah.t_Counter, '0000') AS t_FullCode 
  FROM das_house_dbt ah
 WHERE    :HouseNum = #
      AND :BuildNum = #
      AND :StrucNum = #
      AND t_AOGUID IN 
                 (SELECT as_addrobj.t_aoguid
                    FROM das_addrobj_dbt as_addrobj
                   WHERE     as_addrobj.t_plancode = :PlanCode
                         AND as_addrobj.t_placecode = :PlaceCode
                         AND as_addrobj.t_citycode = :CityCode
                         AND as_addrobj.t_areacode = :AreaCode
                         AND as_addrobj.t_regioncode = :RegionCode
                         AND as_addrobj.t_nextid = :NextID
                         AND as_addrobj.t_aolevel = :AOLevel
                         AND as_addrobj.t_formalname = :FormalName
                         AND as_addrobj.t_shortname = :ShortName)
      AND ah.t_EndDate > :Today
] (sql_normalization("ah.t_HouseNum"), sql_normalization("ah.t_BuildNum"), sql_normalization("ah.t_StrucNum"));

            query = StopCaptureOutput;
            
            params = makeArray(SQLParam("Fias", substr(TempFias, 1, 19))
                              ,SQLParam("HouseNum", normalization(address.House))
                              ,SQLParam("BuildNum", normalization(address.NumCorps))
                              ,SQLParam("StrucNum", normalization(address.Building))
                              ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                              ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                              ,SQLParam("CityCode", substr(TempFias, 6, 3))
                              ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                              ,SQLParam("RegionCode", substr(TempFias, 1, 2))
                              ,SQLParam("NextID", "")
                              ,SQLParam("AOLevel", AOLevel)
                              ,SQLParam("FormalName", FormalName)
                              ,SQLParam("ShortName", ShortName)
                              ,SQLParam("Today", date())
                              );
            
            rs = execSQLselect(query, params, true, RSDVAL_CLIENT, RSDVAL_STATIC);

            AddCol( ColumnsH, 0, "t_HouseNum"  , "Дом", null, true);
            AddCol( ColumnsH, 1, "t_BuildNum"  , "Корпус", null, true);
            AddCol( ColumnsH, 2, "t_StrucNum"  , "Строение", null, true);
            AddCol( ColumnsH, 3, "t_FullCode"  , "Код", null, true);
            AddCol( ColumnsH, 4, "t_PostalCode" , "Индекс", null, true);
            AddCol( ColumnsH, 5, "t_IfnsFl", "Налог.орг.", null, true);
            AddCol( ColumnsH, 6, "t_TerrIfnsFl", "Номер ИМНС", null, true);
            AddCol( ColumnsH, 7, "t_Okato" , "Код ОКАТО", null, true);
            
            if( RunScroll( rs, 8, ColumnsH, "Дома", "EvProc", "Выбрать дом", "~Esc~ Отмена, ~Enter~ Выбор", true ))
              _CopyRSetToFBuff(as_house_dbt, rs);
              TempFias           = _GetAddrobjFiasCodeForAOGuid(trim(as_house_dbt.AOGuid), substr(TempFias, 1, 19)) + _Lpad(as_house_dbt.Counter, "0", 4);
              TempFiasGuid       = trim(as_house_dbt.HouseGUID);
              TempPostIndex      = trim(as_house_dbt.PostalCode);
              address.House = trim(as_house_dbt.HouseNum);
              address.NumCorps = trim(as_house_dbt.BuildNum);
              address.Building = trim(as_house_dbt.StrucNum);
              if(trim(as_house_dbt.Okato) != "") 
                TempOkato = trim(as_house_dbt.Okato); 
              end;
              if(trim(as_house_dbt.Oktmo) != "") 
                TempOktmo = trim(as_house_dbt.Oktmo); 
              end;
            end;
          end;
/*
          end;
        end;
*/
      end;
    end;
    end;
    if((trim(address.Fias) == trim(TempFias)) and 
       (trim(address.PostIndex) == trim(TempPostIndex)) and 
       (trim(address.Oktmo) == trim(TempOktmo)) and 
       (trim(address.Okato) == trim(TempOkato))
      )
      MesPrnBox("Проверка выполнена успешно", prnMess); 
    end;
    
    address.FiasGuid = trim( TempFiasGuid );
    
    i = 0;
    if((trim(address.Fias) != "") and (trim(address.Fias) != trim(TempFias)))
      if(trim(TempFias) != "")
        i = ConfirmMesPrn("Введенное значение кода ФИАС не соответствует справочному. Заменить?", prnMess);
      else
        MesPrnBox("Код ФИАС отсутствует в ФИАС", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.Fias = trim( TempFias );
      retFias = trim( TempFias );
    end;
    i = 0;
    if((trim(address.PostIndex) != "") and (trim(address.PostIndex) != trim(TempPostIndex)))
      if(trim(TempFias) != "")
        i = ConfirmMesPrn("Введенное значение индекса не соответствует ФИАС. Заменить?", prnMess); 
      else
        MesPrnBox("Индекс отсутствует в ФИАС", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.PostIndex = trim( TempPostIndex );
    end;
    i = 0;
    if((trim(address.Okato) != "") and (trim(address.Okato) != trim(TempOkato)))
      if(trim(TempFias) != "")
        i = ConfirmMesPrn("Введенное значение ОКАТО не соответствует ФИАС. Заменить?", prnMess); 
      else
        MesPrnBox("Код ОКАТО отсутствует в ФИАС", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.Okato = trim( TempOkato );
    end;
    i = 0;
    if((trim(address.Oktmo) != "") and (trim(address.Oktmo) != trim(TempOktmo)))
      if(trim(TempFias) != "")
        i = ConfirmMesPrn("Введенное значение ОКТМО не соответствует ФИАС. Заменить?", prnMess); 
      else
        MesPrnBox("Код ОКТМО отсутствует в ФИАС", prnMess); 
        i = 1;
      end;
    end;
    if(i == 0)
      address.Oktmo = trim( TempOktmo );
    end;
  end;/* if( mode == 0 )*/
  
  /* Определение адресных полей по коду КЛАДР*/
  if( mode == 1 )
    newHouse        = "";
    newNumCorps     = "";
    newCodeStreet   = "";
    newStreet       = "";
    newCodePlan     = "";
    newPlan         = "";
    newCodePlace    = "";
    newPlace        = "";
    newCodeDistrict = "";
    newDistrict     = "";
    newCodeProvince = "";
    newProvince     = "";
    newCodeRegion   = "";
    newRegion       = "";
    TempFias        = "";
    TempPostIndex   = "";
    TempOkato       = ""; 
    TempOktmo       = ""; 
    TempFiasGuid    = "";

    if( trim( address.Fias ) == "" )
      MesPrnBox("Заполните код ФИАС!", prnMess); 
      return 1;
    end;

    /* Проветка цифр в коде кладр */
    i = 1;
    while( i <= strlen( address.Fias ))
      if(( substr( address.Fias, i, 1 ) != "0" ) and 
         ( substr( address.Fias, i, 1 ) != "1" ) and 
         ( substr( address.Fias, i, 1 ) != "2" ) and 
         ( substr( address.Fias, i, 1 ) != "3" ) and 
         ( substr( address.Fias, i, 1 ) != "4" ) and 
         ( substr( address.Fias, i, 1 ) != "5" ) and 
         ( substr( address.Fias, i, 1 ) != "6" ) and 
         ( substr( address.Fias, i, 1 ) != "7" ) and 
         ( substr( address.Fias, i, 1 ) != "8" ) and 
         ( substr( address.Fias, i, 1 ) != "9" ))
        MesPrnBox("Код ФИАС содержит недопустимые символы! " + substr( address.Fias, i, 1 ), prnMess); 
        return 1;
      end;
      i = i + 1;
    end;
    
    /* Проверка региона в коде кладр */
    if( substr( address.Fias, 1, 2 ) == "00" )
      MesPrnBox("Код ФИАС должен обязательно содержать код региона!", prnMess); 
      return 1;
    end;
    
    if(( strlen( address.Fias ) != 23 ))
      MesPrnBox("Длина кода ФИАС не соответствует допустимому значению: 23 знака!", prnMess); 
      return 1;
    end;

    /* Заполнение адресных полей формы */
    TempFias = address.Fias;
    TempFiasGuid = "";/*address.FiasGuid;*/

    /*поиск улицы*/
    if((strlen(TempFias) == 23) and (substr(TempFias, 16, 4) != "0000"))
      CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
];

      query = StopCaptureOutput;

      params = makeArray(SQLParam("RegionCode", substr(TempFias, 1, 2))
                        ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                        ,SQLParam("CityCode", substr(TempFias, 6, 3))
                        ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                        ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                        ,SQLParam("StreetCode", substr(TempFias, 16, 4))
                        ,SQLParam("NextID", "")
                        );
    
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        _CopyRSetToFBuff(as_addrobj_dbt, rs);
        newCodeStreet = as_addrobj_dbt.ShortName;
        newStreet     = as_addrobj_dbt.FormalName;
        if(TempFiasGuid == "")
          TempFiasGuid = as_addrobj_dbt.AOGUID;
        end;
        if(TempPostIndex == "")
          TempPostIndex = trim(as_addrobj_dbt.PostalCode);
        end;
        if(TempOkato == "") 
          TempOkato = trim(as_addrobj_dbt.Okato); 
        end;
        if(TempOktmo == "") 
          TempOktmo = trim(as_addrobj_dbt.Oktmo); 
        end;
      end;
      TempFias = substr( TempFias, 1, 15) + "00000000";
    end;

    /*поиск планировочной структуры*/
    if((strlen(TempFias) == 23) and (substr( TempFias, 12, 4) != "0000"))
      CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
];

      query = StopCaptureOutput;

      params = makeArray(SQLParam("RegionCode", substr(TempFias, 1, 2))
                        ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                        ,SQLParam("CityCode", substr(TempFias, 6, 3))
                        ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                        ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                        ,SQLParam("StreetCode", substr(TempFias, 16, 4))
                        ,SQLParam("NextID", "")
                        );
    
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        _CopyRSetToFBuff(as_addrobj_dbt, rs);
        newCodePlan = as_addrobj_dbt.ShortName;
        newPlan     = as_addrobj_dbt.FormalName;
        if(TempFiasGuid == "")
          TempFiasGuid = as_addrobj_dbt.AOGUID;
        end;
        if(TempPostIndex == "")
          TempPostIndex = trim(as_addrobj_dbt.PostalCode);
        end;
        if(TempOkato == "") 
          TempOkato = trim(as_addrobj_dbt.Okato); 
        end;
        if(TempOktmo == "") 
          TempOktmo = trim(as_addrobj_dbt.Oktmo); 
        end;
      end;
      TempFias = substr( TempFias, 1, 11) + "000000000000";
    end;

    /*населенный пункт*/
    if((strlen(TempFias) == 23) and (substr( TempFias, 9, 3) != "000"))
      CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
];

      query = StopCaptureOutput;

      params = makeArray(SQLParam("RegionCode", substr(TempFias, 1, 2))
                        ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                        ,SQLParam("CityCode", substr(TempFias, 6, 3))
                        ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                        ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                        ,SQLParam("StreetCode", substr(TempFias, 16, 4))
                        ,SQLParam("NextID", "")
                        );
    
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        _CopyRSetToFBuff(as_addrobj_dbt, rs);
        newCodePlace = as_addrobj_dbt.ShortName; 
        newPlace     = as_addrobj_dbt.FormalName;
        if(TempFiasGuid == "")
          TempFiasGuid = as_addrobj_dbt.AOGUID;
        end;
        if(TempPostIndex == "")
          TempPostIndex = trim(as_addrobj_dbt.PostalCode);
        end;
        if(TempOkato == "") 
          TempOkato = trim(as_addrobj_dbt.Okato); 
        end;
        if(TempOktmo == "") 
          TempOktmo = trim(as_addrobj_dbt.Oktmo); 
        end;
      end;
      TempFias = substr( TempFias, 1, 8) + "000000000000000";
    end;

    /*город*/
    if((strlen(TempFias) == 23) and (substr( TempFias, 6, 3) != "000"))
      CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
];

      query = StopCaptureOutput;

      params = makeArray(SQLParam("RegionCode", substr(TempFias, 1, 2))
                        ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                        ,SQLParam("CityCode", substr(TempFias, 6, 3))
                        ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                        ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                        ,SQLParam("StreetCode", substr(TempFias, 16, 4))
                        ,SQLParam("NextID", "")
                        );
    
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        _CopyRSetToFBuff(as_addrobj_dbt, rs);
        newCodeDistrict = as_addrobj_dbt.ShortName; 
        newDistrict     = as_addrobj_dbt.FormalName;
        if(TempFiasGuid == "")
          TempFiasGuid = as_addrobj_dbt.AOGUID;
        end;
        if(TempPostIndex == "")
          TempPostIndex = trim(as_addrobj_dbt.PostalCode);
        end;
        if(TempOkato == "") 
          TempOkato = trim(as_addrobj_dbt.Okato); 
        end;
        if(TempOktmo == "") 
          TempOktmo = trim(as_addrobj_dbt.Oktmo); 
        end;
      end;
      TempFias = substr( TempFias, 1, 5) + "000000000000000000";
    end;

    /*район*/
    if((strlen(TempFias) == 23) and (substr( TempFias, 3, 3) != "000"))
      CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
];

      query = StopCaptureOutput;

      params = makeArray(SQLParam("RegionCode", substr(TempFias, 1, 2))
                        ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                        ,SQLParam("CityCode", substr(TempFias, 6, 3))
                        ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                        ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                        ,SQLParam("StreetCode", substr(TempFias, 16, 4))
                        ,SQLParam("NextID", "")
                        );
    
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        _CopyRSetToFBuff(as_addrobj_dbt, rs);
        newCodeProvince = as_addrobj_dbt.ShortName; 
        newProvince     = as_addrobj_dbt.FormalName;
        if(TempFiasGuid == "")
          TempFiasGuid = as_addrobj_dbt.AOGUID;
        end;
        if(TempPostIndex == "")
          TempPostIndex = trim(as_addrobj_dbt.PostalCode);
        end;
        if(TempOkato == "") 
          TempOkato = trim(as_addrobj_dbt.Okato); 
        end;
        if(TempOktmo == "") 
          TempOktmo = trim(as_addrobj_dbt.Oktmo); 
        end;
      end;
      TempFias = substr( TempFias, 1, 2) + "000000000000000000000";
    end;

    /*регион*/
    if((strlen(TempFias) == 23) and (substr( TempFias, 1, 2) != "00"))
      CaptureOutput;
[
SELECT * FROM das_addrobj_dbt 
 WHERE    t_RegionCode = :RegionCode
      AND t_AreaCode = :AreaCode
      AND t_CityCode = :CityCode
      AND t_PlaceCode = :PlaceCode
      AND t_PlanCode = :PlanCode
      AND t_StreetCode = :StreetCode
      AND t_NextID = :NextID
];

      query = StopCaptureOutput;

      params = makeArray(SQLParam("RegionCode", substr(TempFias, 1, 2))
                        ,SQLParam("AreaCode", substr(TempFias, 3, 3))
                        ,SQLParam("CityCode", substr(TempFias, 6, 3))
                        ,SQLParam("PlaceCode", substr(TempFias, 9, 3))
                        ,SQLParam("PlanCode", substr(TempFias, 12, 4))
                        ,SQLParam("StreetCode", substr(TempFias, 16, 4))
                        ,SQLParam("NextID", "")
                        );
    
      rs = execSQLselect(query, params, true);
      if(rs and rs.moveNext())
        _CopyRSetToFBuff(as_addrobj_dbt, rs);
        newCodeRegion = as_addrobj_dbt.ShortName; 
        newRegion     = as_addrobj_dbt.FormalName;
        if(TempFiasGuid == "")
          TempFiasGuid = as_addrobj_dbt.AOGUID;
        end;
        if(TempPostIndex == "")
          TempPostIndex = trim(as_addrobj_dbt.PostalCode);
        end;
        if(TempOkato == "") 
          TempOkato = trim(as_addrobj_dbt.Okato); 
        end;
        if(TempOktmo == "") 
          TempOktmo = trim(as_addrobj_dbt.Oktmo); 
        end;
      end;
    end;

    i = 0;

    if( strlen( address.Fias ) == 23 )
      if(substr(address.Fias, 20, 4) != "0000")
        CaptureOutput;
[
SELECT * 
  FROM das_house_dbt
 WHERE    t_AOGUID = :AOGUID
      AND t_Counter = TO_NUMBER(:Counter)
      AND t_EndDate > :Today
];

        query = StopCaptureOutput;
        
        params = makeArray(SQLParam("AOGUID", TempFiasGuid)
                          ,SQLParam("Counter", substr(address.Fias, 20, 4))
                          ,SQLParam("Today", date())
                          );
        
        rs = execSQLselect(query, params, true);
        if(rs and rs.moveNext())
          _CopyRSetToFBuff(as_house_dbt, rs);
          newHouse = trim(as_house_dbt.HouseNum);
          newNumCorps = trim(as_house_dbt.BuildNum);
          newBuilding = trim(as_house_dbt.StrucNum);
          TempFiasGuid = trim(as_house_dbt.HouseGUID);
          if(trim(as_house_dbt.PostalCode) != "") 
            TempPostIndex = trim(as_house_dbt.PostalCode);
          end;
          if(trim(as_house_dbt.Okato) != "") 
            TempOkato = trim(as_house_dbt.Okato); 
          end;
          if(trim(as_house_dbt.Oktmo) != "") 
            TempOktmo = trim(as_house_dbt.Oktmo); 
          end;
        end;
      end;
    end;

    if(( trim( address.Region   ) != "" ) or
       ( trim( address.Province ) != "" ) or
       ( trim( address.District ) != "" ) or
       ( trim( address.Place    ) != "" ) or
       ( trim( address.Plan     ) != "" ) or
       ( trim( address.Street   ) != "" ) or
       ( trim( address.House    ) != "" ) or
       ( trim( address.NumCorps ) != "" ) or
       ( trim( address.Building ) != "" ) )
      TextCC( i ) = "Значения полей адреса не совпадают с найденными в справочнике ФИАС:";

      if( trim( newRegion     ) != trim( address.Region     ))
        i = i + 1;
        if( trim( newRegion ) == "" )
          TextCC( i ) = "Найденное значение поля 'Регион': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Регион': " + trim( newCodeRegion ) + " " + trim( newRegion );
        end;
      end;
      
      if( trim( newProvince     ) != trim( address.Province     ))
        i = i + 1;
        if( trim( newProvince ) == "" )
          TextCC( i ) = "Найденное значение поля 'Район': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Район': " + trim( newCodeProvince ) + " " + trim( newProvince );
        end;
      end;
          
      if( trim( newDistrict     ) != trim( address.District     ))
        i = i + 1;
        if( trim( newDistrict ) == "" )
          TextCC( i ) = "Найденное значение поля 'Город': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Город': " + trim( newCodeDistrict ) + " " + trim( newDistrict );
        end;
      end;
          
      if( trim( newPlace     ) != trim( address.Place     ))
        i = i + 1;
        if( trim( newPlace ) == "" )
          TextCC( i ) = "Найденное значение поля 'Населенный пункт': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Населенный пункт': " + trim( newCodePlace ) + " " + trim( newPlace );
        end;
      end;
           
      if( trim( newPlan      ) != trim( address.Plan      ))
        i = i + 1;
        if( trim( newPlan  ) == "" )
          TextCC( i ) = "Найденное значение поля 'Планировочная структура': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Планировочная структура': " + trim( newCodePlan ) + " " + trim( newPlan );
        end;
      end;
           
      if( trim( newStreet     ) != trim( address.Street     ))
        i = i + 1;
        if( trim( newStreet ) == "" )
          TextCC( i ) = "Найденное значение поля 'Улица': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Улица': " + trim( newCodeStreet ) + " " + trim( newStreet );
        end;
      end;

      if((tmpStatus != -1) and (trim(newHouse) != trim(address.House)))
        i = i + 1;
        if( trim( newHouse ) == "" )
          TextCC( i ) = "Найденное значение поля 'Дом': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Дом': " + trim( newHouse );
        end;
      end;

      if((tmpStatus != -1) and (trim(newNumCorps) != trim(address.NumCorps)))
        i = i + 1;
        if( trim( newNumCorps ) == "" )
          TextCC( i ) = "Найденное значение поля 'Корпус': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Корпус': " + trim( newNumCorps );
        end;
      end;

      if((tmpStatus != -1) and (trim(newBuilding) != trim(address.Building)))
        i = i + 1;
        if( trim( newBuilding ) == "" )
          TextCC( i ) = "Найденное значение поля 'Строение': <Отсутствует>";
        else
          TextCC( i ) = "Найденное значение поля 'Строение': " + trim( newBuilding );
        end;
      end;

      if( i > 0 )
        if((prnMess == null) or (prnMess != 0))
          if(tmpStatus != -1)
            Result = confwin( TextCC, ButtonCC );
            if( Result == 0 )
              address.Building     = trim( newBuilding    );
              address.NumCorps     = trim( newNumCorps    );
              address.House        = trim( newHouse       );
              address.CodeStreet   = trim( newCodeStreet  );
              address.Street       = trim( newStreet      );
              address.CodePlan     = trim( newCodePlan    );
              address.Plan         = trim( newPlan        );
              address.CodePlace    = trim( newCodePlace   );
              address.Place        = trim( newPlace       );
              address.CodeDistrict = trim( newCodeDistrict);
              address.District     = trim( newDistrict    );
              address.CodeProvince = trim( newCodeProvince);
              address.Province     = trim( newProvince    );
              address.CodeRegion   = trim( newCodeRegion  );
              address.Region       = trim( newRegion      );

              address.FiasGuid     = TempFiasGuid;
              address.PostIndex    = TempPostIndex;
              address.Okato        = TempOkato;
              address.Oktmo        = TempOktmo;
            else
              return 1;
            end;
          else
            Result = confwin( TextCC, ButtonCCC );
            if( Result == 0 )
              if(trim(newBuilding) != "")
                address.Building     = trim( newBuilding    );
              end;
              if(trim(newNumCorps) != "")
                address.NumCorps     = trim( newNumCorps    );
              end;
              if(trim(newHouse) != "")
                address.House        = trim( newHouse       );
              end;
              address.CodeStreet   = trim( newCodeStreet  );
              address.Street       = trim( newStreet      );
              address.CodePlan     = trim( newCodePlan    );
              address.Plan         = trim( newPlan        );
              address.CodePlace    = trim( newCodePlace   );
              address.Place        = trim( newPlace       );
              address.CodeDistrict = trim( newCodeDistrict);
              address.District     = trim( newDistrict    );
              address.CodeProvince = trim( newCodeProvince);
              address.Province     = trim( newProvince    );
              address.CodeRegion   = trim( newCodeRegion  );
              address.Region       = trim( newRegion      );

              address.FiasGuid     = TempFiasGuid;
              address.PostIndex    = TempPostIndex;
              address.Okato        = TempOkato;
              address.Oktmo        = TempOktmo;
            elif( Result == 2)
              return 1;
            end;
          end;
        end;
      end;
    else
      if((tmpStatus != -1) and (trim(newBuilding) != ""))
        address.Building     = trim( newBuilding    );
      end;
      if((tmpStatus != -1) and (trim(newNumCorps) != ""))
        address.NumCorps     = trim( newNumCorps    );
      end;
      if((tmpStatus != -1) and (trim(newHouse) != ""))
        address.House        = trim( newHouse       );
      end;
      address.CodeStreet   = trim( newCodeStreet  );
      address.Street       = trim( newStreet      );
      address.CodePlan     = trim( newCodePlan    );
      address.Plan         = trim( newPlan        );
      address.CodePlace    = trim( newCodePlace   );
      address.Place        = trim( newPlace       );
      address.CodeDistrict = trim( newCodeDistrict);
      address.District     = trim( newDistrict    );
      address.CodeProvince = trim( newCodeProvince);
      address.Province     = trim( newProvince    );
      address.CodeRegion   = trim( newCodeRegion  );
      address.Region       = trim( newRegion      );

      address.FiasGuid     = TempFiasGuid;
      address.PostIndex    = TempPostIndex;
      address.Okato        = TempOkato;
      address.Oktmo        = TempOktmo;
    end;

  end; /*if( mode == 1 )*/
  
  if((prnMess == null) or (prnMess != 0))
  else
    Copy( ptaddress, address );
  end;
    
  return 0;
end;

macro formingKLADR( ptaddress, mode, status_ : @integer )
  return formingFIASEx( ptaddress, mode, @status_, null, null, 0 );
end;

macro formingKLADRRec( ptaddress, mode, status_ : @integer )
  return formingFIASEx( ptaddress, mode, @status_, 0, null, 0 );
end;

macro formingKLADRQuiet( ptaddress, mode, placeFld, status_ : @integer )
  return formingFIASEx( ptaddress, mode, @status_, 1, null, placeFld );
end;

macro formingKLADRQuietRec( ptaddress, mode, placeFld, status_ : @integer )
  return formingFIASEx( ptaddress, mode, @status_, 0, null, placeFld );
end;

macro formingKLADRfromOKATO( ptaddress, retFias:@string )
  return formingFIASEx( ptaddress, 0, null, 0, @retFias, 0 );
end;
