/*
$Name:        ws_accountlist.mac
$Module:      Web-общее
$Description: Макрос с реализацией листалки лицевых счетов
*/

import BankInter, rsd, RSD, cb_sql, "ws_validation.mac", "ws_objlinks.mac";

class AccountListInfo
  var AccountListCollection;
  var AccountCount;
end;

/* Аналог оператора ?: в си. */
private macro PT_IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
end;

private macro GetSortStr( OrderItems,            /* Параметры сортировки */
                          DefaultSortStr:string, /* Строка сортировки по умолчанию (первичному ключу) */
                          Table:string           /* Название таблицы c . */
                        ):String
                        
  var SortStr:string = "";

  if( (OrderItems == null) or (OrderItems.Size() <= 0) )
  
     SortStr = " " + DefaultSortStr + " ";
     
  else

     var i:integer = 0;
     
     while( i < OrderItems.size() )
        
          if (StrUpr(OrderItems[i].Column) == "ACCOUNT"    )  OrderItems[i].Column = "acc.T_ACCOUNT" ;
        elif (StrUpr(OrderItems[i].Column) == "ACCOUNTNAME")  OrderItems[i].Column = "acc.t_NameAccount";
        elif (StrUpr(OrderItems[i].Column) == "FI.FICODE"  )  OrderItems[i].Column = "fi.t_FI_Code";
        end;
        
        if( i != 0 )
          SortStr = SortStr + ", " + OrderItems[i].Column + " " + PT_IIF(OrderItems[i].Direction == 0, "asc", "desc");
        else 
          SortStr = SortStr + "  " + OrderItems[i].Column + " " + PT_IIF(OrderItems[i].Direction == 0, "asc", "desc");
        end;
        
        i = i + 1;
     end;
     
     SortStr = SortStr + ", " + DefaultSortStr;
     
  end;

  return SortStr;
  
end;

macro GetAccountList( pagesize : integer,
                              pagenum  : integer,
                              fiid     : integer,
                              chapter  : integer,
                              subname  : string,
                              subcod   : string,
                              listlen  : integer,
                              orderitems)

  var query = " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
              " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
              " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
              " WHERE fi.t_FIID = acc.t_Code_Currency "
              " AND chapt.t_Chapter = acc.t_Chapter ";

  if( fiid >= 0 )
  
    query = query + " AND acc.t_Code_Currency = " + string(fiid);
  
  end;
  
  if( chapter != 0)
  
    query = query + " AND acc.t_Chapter = " + string(chapter);
  
  end;

  if(subname != "")

    query = query + " AND LOWER(acc.t_NameAccount) LIKE LOWER('%" + subname + "%') ";
  
  end;
  
  if(subcod != "")
  
    query = query + " AND LOWER(acc.t_Account) LIKE LOWER('%" + subcod + "%') ";
  
  end;

  if( listlen != 0 )

    query = query + " AND ROWNUM < " + string(listlen);

  end;
  
  query = query + " ORDER BY " + GetSortStr(orderitems, "acc.t_Account", "acc.");
              
  if(pagesize != 0)
  
    query = SQL_WrapSelect( query, pagenum, pagesize);
    
  end;

  println("*** GetAccountList ***");
  println(query);              

  var cmd = RsdCommand( query );

  var rs = rsdRecordSet( cmd );

  var result = TArray();

  rs.Command.NullConversion = true;

  while( rs.moveNext() )
  
    var Account = TWsLinkedAccount;

    Account.ObChapter = TWsObChapter;
    Account.ObChapter.Chapter = rs.value("t_Chapter");
    Account.ObChapter.Name_ = rs.value("ChaptName");

    Account.Fi = TWsFi;
    Account.Fi.FIID = rs.value("t_Code_Currency");
    Account.Fi.FICode = rs.value("t_FI_Code");
    Account.Fi.FIName = rs.value("t_Name");

    Account.Fi.FIKind = TWsFIKind;
    Account.Fi.FIKind.Fi_Kind = rs.value("t_FI_Kind");

    Account.AccountID = rs.value("t_AccountID");
    Account.Account = rs.value("t_Account");
    Account.AccountName = rs.value("t_NameAccount");

    result.value(result.Size) = Account;

  end;

  return result;

end;

macro GetAccountCount(
                              fiid     : integer,
                              chapter  : integer,
                              subname  : string,
                              subcod   : string,
                              listlen  : integer)

  var result : integer;
  
  var query = "SELECT COUNT(*) C FROM ( ";
  
  query = query + " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
                  " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
                  " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
                  " WHERE fi.t_FIID = acc.t_Code_Currency "
                  " AND chapt.t_Chapter = acc.t_Chapter ";  
  
  if( fiid >= 0 )
  
    query = query + " AND acc.t_Code_Currency = " + string(fiid);
  
  end;
  
  if( chapter != 0)
  
    query = query + " AND acc.t_Chapter = " + string(chapter);
  
  end;  
  
  if(subname != "")

    query = query + " AND LOWER(acc.t_NameAccount) LIKE LOWER('%" + subname + "%') ";
  
  end;
  
  if(subcod != "")
  
    query = query + " AND LOWER(acc.t_Account) LIKE LOWER('%" + subcod + "%') ";
  
  end;

  if( listlen != 0 )

    query = query + " AND ROWNUM < " + string(listlen);

  end;

  query = query + ")";

  println("*** GetAccountCount ***");
  println(query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  ds.NullConversion = true;

  if (ds.MoveNext())

    result = ds.c;

  end;

  return result;

end;

///////////////////////////////////////////////////////////
// Получить информацию о Счете вместе с кодом (краткую)
// заданного вида
///////////////////////////////////////////////////////////

macro GetAccountByIDForList( AccountID : integer,
                             Fiid      : integer,
                             Chapter   : integer)
                             
  var responseBuilder = WebResponseBuilder;
  var error           = WsErrorMessage;
  var question        = WsQuestion;                                

  var p = TWsLinkedAccount();
  
  var query = " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
              " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
              " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
              " WHERE fi.t_FIID = acc.t_Code_Currency "
              " AND chapt.t_Chapter = acc.t_Chapter AND acc.t_AccountID = " + string(AccountID);

  if( fiid >= 0 )
  
    query = query + " AND acc.t_Code_Currency = " + string(fiid);
  
  end;
  
  if( chapter != 0)
  
    query = query + " AND acc.t_Chapter = " + string(chapter);
  
  end; 

  println("*** GetAccountByIDForList ***");
  println(query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  ds.NullConversion = true;

  if (ds.MoveNext())

    p = TWsLinkedAccount;

    p.ObChapter = TWsObChapter;
    p.ObChapter.Chapter = ds.Chapter;
    p.ObChapter.Name_ = ds.ChaptName;

    p.Fi = TWsFi;
    p.Fi.FIID = ds.Code_Currency;
    p.Fi.FICode = ds.FI_Code;
    p.Fi.FIName = ds.Name;

    p.Fi.FIKind = TWsFIKind;
    p.Fi.FIKind.Fi_Kind = ds.FI_Kind;

    p.AccountID = ds.AccountID;
    p.Account = ds.Account;
    p.AccountName = ds.NameAccount;

  end;

  responseBuilder.SetUserObject(p); 

  return responseBuilder.Result;
end;

///////////////////////////////////////////////////////////
// Получить объект TWsLinkedAccount по AccountId
///////////////////////////////////////////////////////////

macro GetTWsLinkedAccountByID( AccountId : integer ):TWsLinkedAccount

  var p = TWsLinkedAccount();
  
  var query = " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
              " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
              " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
              " WHERE fi.t_FIID = acc.t_Code_Currency "
              " AND chapt.t_Chapter = acc.t_Chapter AND acc.t_AccountID = " + string(AccountId);

  println("*** GetTWsLinkedAccountByID ***");
  println(query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  ds.NullConversion = true;

  if (ds.MoveNext())

    p.ObChapter = TWsObChapter;
    p.ObChapter.Chapter = ds.Chapter;
    p.ObChapter.Name_ = ds.ChaptName;

    p.Fi = TWsFi;
    p.Fi.FIID = ds.Code_Currency;
    p.Fi.FICode = ds.FI_Code;
    p.Fi.FIName = ds.Name;

    p.Fi.FIKind = TWsFIKind;
    p.Fi.FIKind.Fi_Kind = ds.FI_Kind;

    p.AccountID = ds.AccountID;
    p.Account = ds.Account;
    p.AccountName = ds.NameAccount;

  end;

  return p;

end;

///////////////////////////////////////////////////////////
// Получить объект TWsLinkedAccount по Code
///////////////////////////////////////////////////////////

macro GetTWsLinkedAccountByCode(Fiid                : integer,
                                Chapter             : integer,
                                Code                : string)
                                  
  var responseBuilder = WebResponseBuilder;
  var error           = WsErrorMessage;
  var question        = WsQuestion;                                    

  var p;
              
  var query = " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
              " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
              " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
              " WHERE fi.t_FIID = acc.t_Code_Currency "
              " AND chapt.t_Chapter = acc.t_Chapter AND LOWER (acc.t_Account) = LOWER ('" + Code + "') ";

  if( fiid >= 0 )
  
    query = query + " AND acc.t_Code_Currency = " + string(fiid);
  
  end;
  
  if( chapter != 0)
  
    query = query + " AND acc.t_Chapter = " + string(chapter);
  
  end;               

  println("*** GetTWsLinkedAccountExByCode ***");
  println(query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  ds.NullConversion = true;

  if (ds.MoveNext())

    p = TWsLinkedAccount;

    p.ObChapter = TWsObChapter;
    p.ObChapter.Chapter = ds.Chapter;
    p.ObChapter.Name_ = ds.ChaptName;

    p.Fi = TWsFi;
    p.Fi.FIID = ds.Code_Currency;
    p.Fi.FICode = ds.FI_Code;
    p.Fi.FIName = ds.Name;

    p.Fi.FIKind = TWsFIKind;
    p.Fi.FIKind.Fi_Kind = ds.FI_Kind;

    p.AccountID = ds.AccountID;
    p.Account = ds.Account;
    p.AccountName = ds.NameAccount;

  end;

  responseBuilder.SetUserObject(p); 

  return responseBuilder.Result;

end;

///////////////////////////////////////////////////////////
// Возвращает список субъектов длинны listLen по
// частичному совпадению значения кода subCode
///////////////////////////////////////////////////////////

macro LookupAccountByCode(Fiid            : integer,
                          Chapter         : integer,
                          subCode         : string,
                          listLen         : integer)
                          
  var result = TArray();
  var p;

  var query = " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
              " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
              " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
              " WHERE fi.t_FIID = acc.t_Code_Currency "
              " AND chapt.t_Chapter = acc.t_Chapter ";
              
  if( fiid >= 0 )
  
    query = query + " AND acc.t_Code_Currency = " + string(fiid);
  
  end;
  
  if( chapter != 0)
  
    query = query + " AND acc.t_Chapter = " + string(chapter);
  
  end;                
              
  query = query + " AND LOWER (acc.t_Account) LIKE LOWER ('%" + subCode + "%') ";

  if( listLen != 0 )

    query = query + " AND ROWNUM < " + string(listLen);

  end;

  println("*** LookupAccountByCode ***");
  println(query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  ds.NullConversion = true;

  while (ds.MoveNext())
  
    p = TWsLinkedAccount;

    p.ObChapter = TWsObChapter;
    p.ObChapter.Chapter = ds.Chapter;
    p.ObChapter.Name_ = ds.ChaptName;

    p.Fi = TWsFi;
    p.Fi.FIID = ds.Code_Currency;
    p.Fi.FICode = ds.FI_Code;
    p.Fi.FIName = ds.Name;

    p.Fi.FIKind = TWsFIKind;
    p.Fi.FIKind.Fi_Kind = ds.FI_Kind;

    p.AccountID = ds.AccountID;
    p.Account = ds.Account;
    p.AccountName = ds.NameAccount;

    result.value(result.Size) = p;

  end;

  return result;

end;

////////////////////////////////////////////////
// Возвращает номер строки для accountid
////////////////////////////////////////////////

macro GetAccountRowNum(accountid           : integer,
                       fiid                : integer,
                       chapter             : integer,
                       orderitems) : integer
                     
  var result = 0;
  
  var query = " SELECT RN " +
              "   FROM (SELECT ROWNUM RN, t_AccountID " +
              "           FROM ( ";  
  
  query = query + " SELECT acc.t_Chapter, acc.t_Code_Currency, acc.t_AccountID, acc.t_Account, acc.t_NameAccount, "
                  " fi.t_FI_Code, fi.t_Name, chapt.t_Name As ChaptName, fi.t_FI_Kind "
                  " FROM daccount_dbt acc , dfininstr_dbt fi, dobchaptr_dbt chapt "
                  " WHERE fi.t_FIID = acc.t_Code_Currency "
                  " AND chapt.t_Chapter = acc.t_Chapter ";

  if( fiid >= 0 )
  
    query = query + " AND acc.t_Code_Currency = " + string(fiid);
  
  end;
  
  if( chapter != 0)
  
    query = query + " AND acc.t_Chapter = " + string(chapter);
  
  end;
                                            
  query = query + " ORDER BY " + GetSortStr(orderitems, "acc.t_Account", "acc.");  

  query = query + " )) WHERE t_AccountID = " + string(accountid);

  println("*** GetAccountRowNum ***");
  println(query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  ds.NullConversion = true;

  if (ds.MoveNext())

    result = ds.RN;

  end;

  return result;  

end;

////////////////////////////////////////////////
// Возвращает AccountListInfo (AccountListCollection, AccountCount)
////////////////////////////////////////////////

macro GetAccountListInfoListAndCount( pagesize,
                                      pagenum,
                                      fiid,
                                      chapter,
                                      subname,
                                      subcod,
                                      listlen,
                                      orderitems )
                                      
  var responseBuilder = WebResponseBuilder;
  var error           = WsErrorMessage;
  var question        = WsQuestion;

  var p = AccountListInfo();
  
  p.AccountListCollection = GetAccountList( pagesize,
                                            pagenum,
                                            fiid,
                                            chapter,
                                            subname,
                                            subcod,
                                            listlen,
                                            orderitems );
                        
  p.AccountCount = GetAccountCount( fiid,
                                    chapter,
                                    subname,
                                    subcod,
                                    listlen );
  
  responseBuilder.SetUserObject(p); 

  return responseBuilder.Result;
  
end;

// GetTWsLinkedAccountByID( 1 );