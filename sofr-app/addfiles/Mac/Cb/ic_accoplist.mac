/*
$Name: ic_accoplist.mac
$Module: ББ
$Description: сервис выписки
*/

import ic_accoputils;

class TContrParty(_cmd)
  var BankBIC: String;
  var BankName: String;
  var Account: String;
  var Name: String;
  var INN: String;
  var PartyID: Integer;

  BankBIC = _cmd.value("t_BankBIC");
  BankName = _cmd.value("t_BankName");
  Account = _cmd.value("t_Account");
  Name = _cmd.value("t_Name");
  INN = _cmd.value("t_INN");
  PartyID = _cmd.value("t_PartyID");
end;

class (TExtractDocParent) TExtractDoc(_TypeAccStat, _NationalCurrency, _FIID, _cmd)
  var IsTax: Integer;
  var CounterParty: TContrParty = NULL;

  InitTExtractDocParent(_TypeAccStat, _NationalCurrency, _FIID, _cmd);
  IsTax = _cmd.value("t_IsTax");
  if (_TypeAccStat == 2)
    CounterParty = TContrParty(_cmd);
  end;
end;

macro GetAccountOperList(
                          AccountID: Integer, //Идентификатор счета в АБС
                          AccountNumber: String, //Номер счета (внешний) в АБС
                          DateFrom: date, //Начальная дата периода выписки
                          DateTo: date, //Конечная дата периода выписки
                          TypeAccStat: integer, //Тип выписки Возможные значения:(1 - краткая; 2 - расширенная.)
                          NationalCurrency: integer, //Признак национальной валюты Признак необходимости возврата сумм в национальной валюте. Возможные значения:0 - нет; 1 - да (по умолчанию)
                          MaxRowResponse: integer //Максимальное количество строк в ответе
                        )
  var FIID;
  if (CheckAndCorrectParams(@AccountID, @AccountNumber, @DateFrom, @DateTo, TypeAccStat, @NationalCurrency, @FIID))
    return TExtractInfo();
  end;
  var cmd;
  var Result: TExtractInfo = TExtractInfo(AccountID, AccountNumber, DateFrom, DateTo, NationalCurrency, FIID);

  var ncText = "";
  if (NationalCurrency == 0)
    ncText = " and decode(t_AccountID_Payer, ?, t_Sum_Payer, t_Sum_Receiver) <> 0";
  end;

  var sql_text = string("SELECT      t_FullPaymentID t_PaymentID, \n",
                             "       ad.t_Date_Carry t_PostDate, \n",
                             "       ad.t_SystemTime t_PostTime, \n",
                             "         RSB_ACCOUNT.restall (?, \n",
                             "                              1, \n",
                             "                              ?, \n",
                             "                              ?- 1, \n",
                             "                              NULL) \n",
                             "       + SUM (ad.t_AmountWithSign) \n",
                             "            OVER (ORDER BY \n",
                             "                     ad.t_Date_Carry, \n",
                             "                     ad.t_SystemDate, \n",
                             "                     ad.t_SystemTime, \n",
                             "                     ad.t_AccTrnID \n",
                             "                  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) \n",
                             "       - ad.t_AmountWithSign \n",
                             "          t_InBalance, \n",
                             "       ad.t_TurnType, \n",
                             "       ad.t_Amount, \n",
                             "       ad.t_AmountNatCur, \n",
                             "       ad.t_DocKind, \n",
                             "       ad.t_DocNumber, \n",
                             "       ad.t_DocDate, \n",
                             "       ad.t_Ground2 t_Ground, \n",
                             "       ad.t_BankBIC, \n",
                             "       ad.t_BankName, \n",
                             "       ad.t_Account, \n",
                             "       ad.t_Name, \n",
                             "       ad.t_IsTax, \n",
                             "       DECODE (ad.t_UsePayment, \n",
                             "               1, ad.t_INN, \n",
                             "               NVL (PM_SCRHLP.GetPartyCode (ad.t_PartyID, 16), CHR (1))) \n",
                             "          t_INN, \n",
                             "       ad.t_PartyID, \n",
                             "       ROWNUM t_RowNum \n",
                             "  FROM (SELECT CASE \n",
                             "                  WHEN ad.t_UsePayment = 0 THEN acc.t_Client \n",
                             "                  WHEN ad.t_TurnType = 1 THEN pmpaym.t_Receiver \n",
                             "                  ELSE pmpaym.t_Payer \n",
                             "               END \n",
                             "                  t_PartyID, \n",
                             "               DECODE (ad.t_UsePayment, \n",
                             "                       0, NVL ( (SELECT p.t_Name \n",
                             "                                   FROM dparty_dbt p \n",
                             "                                  WHERE p.t_PartyID = acc.t_Client), \n",
                             "                               CHR (1)), \n",
                             "                       t_ClientName) \n",
                             "                  t_Name, \n",
                             "               CASE \n",
                             "                  WHEN pmpaym.t_PaymentID IS NULL \n",
                             "                  THEN \n",
                             "                     DECODE (ad.t_TurnType, \n",
                             "                             1, ad.t_Account_Receiver, \n",
                             "                             ad.t_Account_Payer) \n",
                             "                  ELSE \n",
                             "                     DECODE (ad.t_TurnType, \n",
                             "                             1, pmpaym.t_ReceiverAccount, \n",
                             "                             pmpaym.t_PayerAccount) \n",
                             "               END \n",
                             "                  t_Account, \n",
                             "               CASE \n",
                             "                  WHEN ad.t_UsePayment = 0 \n",
                             "                  THEN \n",
                             "                     NVL (PM_SCRHLP.GetPartyCode ( \n",
                             "                             (SELECT t_PartyID \n",
                             "                                FROM ddp_dep_dbt \n",
                             "                               WHERE t_Code = ad.t_Department), \n",
                             "                             3                               /*CNST.PTCK_BIC*/ \n",
                             "                              ), \n",
                             "                          CHR (1)) \n",
                             "                  ELSE \n",
                             "                     NVL ( \n",
                             "                        ad.t_BankCode, \n",
                             "                        CASE \n",
                             "                           WHEN t_TurnType = 1 \n",
                             "                           THEN \n",
                             "                              NVL ( \n",
                             "                                 PM_SCRHLP.GetPartyCode ( \n",
                             "                                    pmpaym.t_ReceiverBankID, \n",
                             "                                    3                        /*CNST.PTCK_BIC*/ \n",
                             "                                     ), \n",
                             "                                 CHR (1)) \n",
                             "                           ELSE \n",
                             "                              NVL ( \n",
                             "                                 PM_SCRHLP.GetPartyCode ( \n",
                             "                                    pmpaym.t_PayerBankID, \n",
                             "                                    3                        /*CNST.PTCK_BIC*/ \n",
                             "                                     ), \n",
                             "                                 CHR (1)) \n",
                             "                        END) \n",
                             "               END \n",
                             "                  t_BankBIC, \n",
                             "               DECODE (ad.t_TurnType, 1, -ad.t_Amount, ad.t_Amount) t_AmountWithSign, \n",
                             "               ad.* \n",
                             "          FROM (SELECT NVL (prp.t_ShifrOper, ad.t_Shifr_Oper) t_DocKind, \n",
                             "                       NVL (prp.t_Number, '0') t_DocNumber, \n",
                             "                       NVL (prp.t_Date, ad.t_Date_Carry) t_DocDate, \n",
                             "                       NVL (prp.t_Ground, ad.t_Ground) t_Ground2, \n",
                             "                       NVL2( prp.t_TaxAuthorState, decode(prp.t_TaxAuthorState, chr(1), 1, 2), 1) t_IsTax, \n",
                             "                       DECODE (pp.t_CodeKind, 3                --CNST.PTCK_BIC \n",
                             "                                               , pp.t_BankCode, NULL) \n",
                             "                          t_BankCode, \n",
                             "                       CASE \n",
                             "                          WHEN ad.t_PaymentID IS NULL \n",
                             "                          THEN \n",
                             "                             NVL ( \n",
                             "                                (SELECT p.t_Name \n",
                             "                                   FROM ddp_dep_dbt dp, dparty_dbt p \n",
                             "                                  WHERE     dp.t_Code = ad.t_Department \n",
                             "                                        AND p.t_PartyID = dp.t_PartyID), \n",
                             "                                CHR (1)) \n",
                             "                          WHEN ad.t_TurnType = 1 \n",
                             "                          THEN \n",
                             "                             prp.t_ReceiverBankName \n",
                             "                          ELSE \n",
                             "                             prp.t_PayerBankName \n",
                             "                       END \n",
                             "                          t_BankName, \n",
                             "                       DECODE (ad.t_TurnType, \n",
                             "                               1, prp.t_ReceiverName, \n",
                             "                               prp.t_PayerName) \n",
                             "                          t_ClientName, \n",
                             "                       DECODE (ad.t_TurnType, \n",
                             "                               1, ad.t_Sum_Payer, \n",
                             "                               ad.t_Sum_Receiver) \n",
                             "                          t_Amount, \n",
                             "                       ad.t_Sum_NatCur t_AmountNatCur, \n",
                             "                       CASE \n",
                             "                          WHEN    ad.t_PaymentID IS NULL \n",
                             "                               OR EXISTS \n",
                             "                                     (SELECT 1 \n",
                             "                                        FROM dpmaddpi_dbt pma \n",
                             "                                       WHERE     pma.t_PaymentID = \n",
                             "                                                    ad.t_PaymentID \n",
                             "                                             AND pma.t_DebetCredit = ad.t_TurnType) \n",
                             "                          THEN \n",
                             "                             0 \n",
                             "                          ELSE \n",
                             "                             1 \n",
                             "                       END \n",
                             "                          t_UsePayment, \n",
                             "                       DECODE (t_TurnType, \n",
                             "                               1, NVL (prp.t_ReceiverINN, CHR (1)), \n",
                             "                               NVL (prp.t_PayerINN, CHR (1))) \n",
                             "                          t_INN, \n",
                             "                       ad.* \n",
                             "                  FROM (  SELECT pmd.t_PaymentID, \n",
                             "                                 TO_CHAR(NVL (pmd.t_PaymentID, 0)) || '//' || TO_CHAR(NVL (pmd.t_PmAddPIID, 0)) || '//' || TO_CHAR(ad.t_AccTrnID) t_FullPaymentID,\n",
                             "                                 DECODE ( \n",
                             "                                    ?, \n",
                             "                                    ad.t_AccountID_Receiver, ad.t_AccountID_Payer, \n",
                             "                                    ad.t_AccountID_Receiver) \n",
                             "                                    t_AccountID, \n",
                             "                                 DECODE (?, ad.t_AccountID_Payer, 1, 0) \n",
                             "                                    t_TurnType, \n",
                             "                                 ad.* \n",
                             "                            FROM dacctrn_dbt ad, dpmdocs_dbt pmd \n",
                             "                           WHERE     ad.t_Chapter = 1 \n",
                             "                                 AND ad.t_State = 1 \n",
                             "                                 AND (   ad.t_AccountID_Payer = ?\n",
                             "                                      OR ad.t_AccountID_Receiver = ?) \n",
                             "                                 AND ad.t_Date_Carry BETWEEN ? AND ?\n",
                                                               ncText,
                             "                                 AND pmd.t_AccTrnID(+) = ad.t_AccTrnID) ad, \n",
                             "                       dpmprop_dbt pp, \n",
                             "                       dpmrmprop_dbt prp \n",
                             "                 WHERE     pp.t_PaymentID(+) = ad.t_PaymentID \n",
                             "                       AND pp.t_DebetCredit(+) = ad.t_TurnType \n",
                             "                       AND prp.t_PaymentID(+) = ad.t_PaymentID) ad, \n",
                             "               dpmpaym_dbt pmpaym, \n",
                             "               daccount_dbt acc \n",
                             "         WHERE     acc.t_AccountID = ad.t_AccountID \n",
                             "               AND pmpaym.t_PaymentID(+) = ad.t_PaymentID) ad \n");

  var Params = MakeArray(
                               SQLParam("", AccountNumber), SQLParam("", FIID), SQLParam("", DateFrom), 
                               SQLParam("", AccountID), SQLParam("", AccountID), SQLParam("", AccountID), SQLParam("", AccountID),
                               SQLParam("", DateFrom), SQLParam("", DateTo));
  if (NationalCurrency == 0)
    Params[Params.size] = SQLParam("", AccountID);
  end;

  if (MaxRowResponse)
    sql_text = string("select t_PaymentID, \n",
                      "       t_PostDate, \n",
                      "       t_PostTime, \n",
                      "       t_InBalance, \n",
                      "       t_TurnType, \n",
                      "       t_Amount, \n",
                      "       t_AmountNatCur, \n",
                      "       t_DocKind, \n",
                      "       t_DocNumber, \n",
                      "       t_DocDate, \n",
                      "       t_Ground, \n",
                      "       t_BankBIC, \n",
                      "       t_BankName, \n",
                      "       t_Account, \n",
                      "       t_Name, \n",
                      "       t_IsTax, \n",
                      "       t_INN, \n",
                      "       t_PartyID \n",
                      "  from ( \n",
                      sql_text, ") \n",
                      " where t_RowNum > (select count(*) FROM dacctrn_dbt ad WHERE ad.t_Chapter = 1 \n",
                             "                                 AND ad.t_State = 1 \n",
                             "                                 AND (   ad.t_AccountID_Payer = ?\n",
                             "                                      OR ad.t_AccountID_Receiver = ?) \n",
                             "                                 AND ad.t_Date_Carry BETWEEN ? AND ?) - ?\n");
    Params[Params.size] = SQLParam("", AccountID);
    Params[Params.size] = SQLParam("", AccountID);
    Params[Params.size] = SQLParam("", DateFrom);
    Params[Params.size] = SQLParam("", DateTo);
    Params[Params.size] = SQLParam("", MaxRowResponse);
  end;

  cmd = execSQLSelect(sql_text, Params);
  while (cmd.moveNext())
    Result.PayDocList[Result.PayDocList.size] = TExtractDoc(TypeAccStat, NationalCurrency, FIID, cmd);
    Result.NumRowStat = Result.NumRowStat + 1;
  end;

  return Result;
end;