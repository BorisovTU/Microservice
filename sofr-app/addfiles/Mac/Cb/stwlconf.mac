import OprInter, PaymInter, likepy;

private macro ПлатежИсходящий( Payment:RsbPayment ):bool
 return ( ((Payment.PayerGroup == PAYMENTS_GROUP_EXTERNAL) AND (Payment.PayerIsSender != "X") AND (Payment.ReceiverGroup != PAYMENTS_GROUP_EXTERNAL)) OR
          ((Payment.ReceiverGroup == PAYMENTS_GROUP_EXTERNAL) AND (Payment.ReceiverIsSender != "X") AND (Payment.PayerGroup != PAYMENTS_GROUP_EXTERNAL)) );
end;

//------------------------------------------------------------------------------------------
// Заполнение подтверждения о проводке по платежу
//------------------------------------------------------------------------------------------
macro FillConfirmationParamObj( PaymentObj:RsbPayment, rec_wlconf )
  var DKFlag; //Эта переменная используется для обработки мемордеров и мутивал. документов
  
  //Необходимо для анализа мемордеров и мутивал. документов на работу с корсчетами
  if( (PaymentObj.DocKind == CB_MULTYDOC) OR (PaymentObj.DocKind == DLDOC_MEMORIALORDER))
     if( not GetParm(2,DKFlag) )
       DKFlag = 2;
     end;
     if( DKFlag == 1 )
        rec_wlconf.FIID        = PaymentObj.PayerFIID;
        rec_wlconf.Account     = PaymentObj.PayerAccount;
        rec_wlconf.Sum         = PaymentObj.PayerAmount;
        rec_wlconf.BankID      = PaymentObj.PayerBankID;
     else
        rec_wlconf.FIID        = PaymentObj.ReceiverFIID;
        rec_wlconf.Account     = PaymentObj.ReceiverAccount;
        rec_wlconf.Sum         = PaymentObj.ReceiverAmount;
        rec_wlconf.BankID      = PaymentObj.ReceiverBankID;
     end;
     rec_wlconf.Corschem       = -1; //ALLCORSCHEMNUMBER
     rec_wlconf.DocumentID     = PaymentObj.PaymentID;
     rec_wlconf.DocKind        = PaymentObj.DocKind;
     rec_wlconf.DateValue      = PaymentObj.ValueDate;
     rec_wlconf.Number         = PaymentObj.Number;
     rec_wlconf.DKFlag         = DKFlag;
     rec_wlconf.CodeKind       = 1; //PTCK_CONTR
     rec_wlconf.Description    = PaymentObj.Ground; 
     rec_wlconf.ReceiverAccount=PaymentObj.ReceiverAccount;

     if(PaymentObj.DocKind == CB_MULTYDOC)
        //rec_wlconf.BankID        = GetClientByAccount(rec_wlconf.FIID, rec_wlconf.Account);
     else
        //rec_wlconf.BankID        = GetClientCodeByAccount(rec_wlconf.FIID, rec_wlconf.Account, 1 /*PTCK_CONTR*/);
        rec_wlconf.ShifrOper     = PaymentObj.ShifrOper;
     end; 

  else
     rec_wlconf.FIID          = PaymentObj.BaseFIID;
     rec_wlconf.Corschem      = IfThenElse(ПлатежИсходящий(PaymentObj), PaymentObj.InCorschem, PaymentObj.OutCorschem); 
     rec_wlconf.DocumentID    = PaymentObj.PaymentID;
     rec_wlconf.DocKind       = PaymentObj.DocKind;
     rec_wlconf.DateValue     = PaymentObj.ValueDate;
     rec_wlconf.Number        = PaymentObj.Number;
     rec_wlconf.Sum           = IfThenElse(PaymentObj.IsCredit,PaymentObj.FutureReceiverAmount, PaymentObj.FuturePayerAmount);;
     if ( (PaymentObj.IsCredit and ПлатежИсходящий(PaymentObj)) or not
          (PaymentObj.IsCredit or  ПлатежИсходящий(PaymentObj)) )
       rec_wlconf.DKFlag        = 2;
       rec_wlconf.CorrBankName  = PaymentObj.ReceiverBankCorrName;
       rec_wlconf.BankName      = PaymentObj.ReceiverBankName;
       rec_wlconf.BankID        = PaymentObj.ReceiverBankID;
       rec_wlconf.CorrCodeKind  = PaymentObj.ReceiverBankCorrCodeKind;
       rec_wlconf.CorrCodeValue = PaymentObj.ReceiverBankCorrCode;
       rec_wlconf.CodeKind      = PaymentObj.ReceiverBankCodeKind;
       rec_wlconf.CodeValue     = PaymentObj.ReceiverBankCode;
     else
       rec_wlconf.DKFlag        = 1;
       rec_wlconf.CorrBankName  = PaymentObj.PayerBankCorrName;
       rec_wlconf.BankName      = PaymentObj.PayerBankName;
       rec_wlconf.BankID        = PaymentObj.PayerBankID;
       rec_wlconf.CorrCodeKind  = PaymentObj.PayerBankCorrCodeKind;
       rec_wlconf.CorrCodeValue = PaymentObj.PayerBankCorrCode;
       rec_wlconf.CodeKind      = PaymentObj.PayerBankCodeKind;
       rec_wlconf.CodeValue     = PaymentObj.PayerBankCode;
     end;
     rec_wlconf.ShifrOper     = string(PaymentObj.ShifrOper);
     // rec_wlconf.MessageType   = PaymentObj.MessageType;
     rec_wlconf.Description   = substr(PaymentObj.Ground, 1, 215); 
     rec_wlconf.TransferDate  = PaymentObj.InTransferDate; 
  end; 

  return true;
end;

//------------------------------------------------------------------------------------------
// Заполнение буфера подтверждения. Заполняет все поля, независимо от типа документа
//------------------------------------------------------------------------------------------
macro FillConfirmationParamByCarry( rec_wlconf, PaymentObj:RsbPayment, paymtr:RsbPaymTransaction, DKFlag )

  if((ValType(paymtr)!=V_UNDEF))
     rec_wlconf.FIID        = IfThenElse(DKFlag == 1, paymtr.FIIDPayer,    paymtr.FIIDReceiver    );   
     rec_wlconf.Account     = IfThenElse(DKFlag == 1, paymtr.AccountPayer, paymtr.AccountReceiver );
     rec_wlconf.Sum         = IfThenElse(DKFlag == 1, paymtr.SumPayer,     paymtr.SumReceiver     );
  else
     rec_wlconf.FIID        = IfThenElse(DKFlag == 1, PaymentObj.PayerFIID,       PaymentObj.ReceiverFIID    );  
     rec_wlconf.Account     = IfThenElse(DKFlag == 1, PaymentObj.PayerAccount,    PaymentObj.ReceiverAccount );
     rec_wlconf.Sum         = IfThenElse(DKFlag == 1, PaymentObj.PayerAmount,     PaymentObj.ReceiverAmount  );
  end;

  rec_wlconf.BankID         = IfThenElse(DKFlag == 1, PaymentObj.PayerBankID, PaymentObj.ReceiverBankID);
 
  rec_wlconf.FIID          = PaymentObj.BaseFIID;
  rec_wlconf.Corschem      = IfThenElse(ПлатежИсходящий(PaymentObj), PaymentObj.InCorschem, PaymentObj.OutCorschem); 
  rec_wlconf.DocumentID    = PaymentObj.PaymentID;
  rec_wlconf.DocKind       = PaymentObj.DocKind;
  rec_wlconf.DateValue     = PaymentObj.ValueDate;
  rec_wlconf.Number        = PaymentObj.Number;
//  rec_wlconf.Sum           = IfThenElse(PaymentObj.IsCredit,PaymentObj.FutureReceiverAmount, PaymentObj.FuturePayerAmount);;
  if ( (PaymentObj.IsCredit and ПлатежИсходящий(PaymentObj)) or not
       (PaymentObj.IsCredit or  ПлатежИсходящий(PaymentObj)) )
    rec_wlconf.CorrBankName  = PaymentObj.ReceiverBankCorrName;
    rec_wlconf.BankName      = PaymentObj.ReceiverBankName;
    rec_wlconf.BankID        = PaymentObj.ReceiverBankID;
    rec_wlconf.CorrCodeKind  = PaymentObj.ReceiverBankCorrCodeKind;
    rec_wlconf.CorrCodeValue = PaymentObj.ReceiverBankCorrCode;
    rec_wlconf.CodeKind      = PaymentObj.ReceiverBankCodeKind;
    rec_wlconf.CodeValue     = PaymentObj.ReceiverBankCode;
  else
    rec_wlconf.CorrBankName  = PaymentObj.PayerBankCorrName;
    rec_wlconf.BankName      = PaymentObj.PayerBankName;
    rec_wlconf.BankID        = PaymentObj.PayerBankID;
    rec_wlconf.CorrCodeKind  = PaymentObj.PayerBankCorrCodeKind;
    rec_wlconf.CorrCodeValue = PaymentObj.PayerBankCorrCode;
    rec_wlconf.CodeKind      = PaymentObj.PayerBankCodeKind;
    rec_wlconf.CodeValue     = PaymentObj.PayerBankCode;
  end;
  rec_wlconf.ShifrOper       = string(PaymentObj.ShifrOper);
  rec_wlconf.Description     = substr(PaymentObj.Ground, 1, 215); 
  rec_wlconf.TransferDate    = PaymentObj.InTransferDate; 
  rec_wlconf.ReceiverAccount = PaymentObj.ReceiverAccount;
  rec_wlconf.DKFlag          = DKFlag;



end;
