/*
$Name:        ws_codevalues.mac
$Module:      Главная книга
$Description: Макрос кодов
*/

import BankInter, CTInter, rsbdataset, oralib, "ws_partycommon.mac", "globals.mac";

PRIVATE VAR ParmObjectType;
PRIVATE VAR ParmObjectID;
PRIVATE VAR ParmCodeValueList;
PRIVATE VAR ParmCodeValue;

private var TrnFlag:bool = true;
private var gStat:integer = 0, gMessage:string = "";

PRIVATE VAR ParmResult;

class TWSCodeValue
  var CodeKindNumber    :integer;// Вид кода dobjcode_dbt.t_codekind
  var CodeKindName      :string ;// Наименование вида кода объекта dobjkcode_dbt.t_name,где dobjkcode_dbt.t_codekind = dobjcode_dbt.t_codekind и dobjkcode_dbt.t_objecttype = $(ObjectType)
  var CodeKindNameShort :string ;// Краткое наименование вида кода объекта dobjkcode_dbt.t_shortname, где dobjkcode_dbt.t_codekind = dobjcode_dbt.t_codekind и dobjkcode_dbt.t_objecttype = $(ObjectType)
  var CodeValue         :string ;// Код dobjcode_dbt.t_code
  var DateFrom          :Date   ;// Дата ввода dobjcode_dbt.t_bankdate
  var DateTo            :Date   ;// Дата закрытия dobjcode_dbt.t_bankclosedate
  var Autokey           :integer;// Уникальный ид. кода dobjcode_dbt.t_autokey
  var Action            :string ;// Действие с кодом, устанавливается во время редактирования списка кодов:
                                 //   == CREATE - код был добавлен в список кодов;
                                 //   == MODIFY - код был отредактирован в списке кодов;
                                 //   == REMOVE - код был удален в списке кодов.
end;

class TWSCodeKind
  var CodeKindNumber    :integer;// Вид кода dobjkcode_dbt.t_codekind
  var CodeKindName      :string ;// Наименование вида кода объекта dobjkcode_dbt.t_name
  var CodeKindNameShort :string ;// Краткое наименование вида кода объекта dobjkcode_dbt.t_shortname
  var CodeKindDuplicate :bool   ;// Признак множественности значений
end;

class TWSListCodeValues
  var CodeValues                ;// TArray<TWSCodeValue> Массив кодов найденных в БД для переданного заданного вида объекта и ид. объекта
  var CodeKinds                 ;// TArray<TWSCodeKind> Массив видов кодов для заданного вида объекта
  var CurDate           :Date   ;// Текущий опердень пользователя
  var LastOpenCurDate   :Date   ;// Последний открытый операционный день филиала
  var UserIsAdmin       :bool   ;// Признак принадлежности пользователя к Администраторам
end;

class TWSCheckResult
  var Result :bool;
end;

macro GetListCodeValues
(
  ObjectType : integer, // Вид объекта
  ObjectID   : integer  // Ид. объекта
)
  const CODEKIND_1 = 1, CODEKIND_2 = 2, CODEKIND_3 = 3, CODEKIND_4 = 4, CODEKIND_5 = 5, CODEKIND_6 = 6;

  var result = TWSListCodeValues();

  result.CodeValues = TArray();
  result.CodeKinds  = TArray();

  var p;

  if(ValType(ObjectType) == V_UNDEF)
    RunError("Не задан вид объекта");
  end;

  if(ValType(ObjectID) == V_UNDEF)
    RunError("Не задан идентификатор объекта: ObjectID = <" + ObjectID + ">");
  end;

  var query = "SELECT oc.T_CODEKIND AS CodeKindNumber," +
              "   okc.T_NAME AS CodeKindName," +
              "   okc.T_SHORTNAME AS CodeKindNameShort," +
              "   oc.T_CODE AS CodeValue," +
              "   oc.T_BANKDATE AS DateFrom," +
              "   oc.T_BANKCLOSEDATE AS DateTo," +
              "   oc.T_AUTOKEY AS Autokey" +
              " FROM DOBJCODE_DBT oc, DOBJKCODE_DBT okc" +
              " WHERE     oc.T_OBJECTTYPE = " + string(ObjectType) +
              "      AND okc.T_OBJECTTYPE = " + string(ObjectType) +
              "      AND  oc.T_OBJECTID = " + string(ObjectID) +
              "     AND  oc.T_CODEKIND = okc.T_CODEKIND" +
              " ORDER BY oc.T_CODEKIND, oc.T_BANKDATE";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while (ds.MoveNext())

    p = TWSCodeValue();

    p.CodeKindNumber    = ds.CodeKindNumber;
    p.CodeKindName      = ds.CodeKindName;
    p.CodeKindNameShort = ds.CodeKindNameShort;
    p.CodeValue         = ds.CodeValue;
    p.DateFrom          = ds.DateFrom;
    p.DateTo            = ds.DateTo;
    p.Autokey           = ds.Autokey;

    result.CodeValues.value(result.CodeValues.Size) = p;

  end;

  if( ObjectType == OBJTYPE_FININSTR )

    var query_sub;
    var ds_sub;

    // CODEKIND 1

    query = "SELECT T_FI_CODE AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      query_sub = "SELECT T_NAME AS CodeKindName, T_SHORTNAME AS CodeKindNameShort" +
                      " FROM DOBJKCODE_DBT" +
                      " WHERE T_OBJECTTYPE = " + string(ObjectType) +
                      "      AND T_CODEKIND = " + CODEKIND_1;

      ds_sub = TRsbDataSet(query_sub, RSDVAL_CLIENT, RSDVAL_STATIC);

      p = TWSCodeValue();

      if( ds_sub.MoveNext() )
        p.CodeKindNumber    = CODEKIND_1;
        p.CodeKindName      = ds_sub.CodeKindName;
        p.CodeKindNameShort = ds_sub.CodeKindNameShort;
      end;

      p.CodeValue = ds.CodeValue;

      result.CodeValues.value(result.CodeValues.Size) = p;

    end;

    // CODEKIND 2

    query = "SELECT T_ISO_NUMBER AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      query_sub = "SELECT T_NAME AS CodeKindName, T_SHORTNAME AS CodeKindNameShort" +
                      " FROM DOBJKCODE_DBT" +
                      " WHERE T_OBJECTTYPE = " + string(ObjectType) +
                      "      AND T_CODEKIND = " + CODEKIND_2;

      ds_sub = TRsbDataSet(query_sub, RSDVAL_CLIENT, RSDVAL_STATIC);

      p = TWSCodeValue();

      if( ds_sub.MoveNext() )
        p.CodeKindNumber    = CODEKIND_2;
        p.CodeKindName      = ds_sub.CodeKindName;
        p.CodeKindNameShort = ds_sub.CodeKindNameShort;
      end;

      p.CodeValue = ds.CodeValue;

      result.CodeValues.value(result.CodeValues.Size) = p;

    end;

    // CODEKIND 3

    query = "SELECT T_CCY AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      query_sub = "SELECT T_NAME AS CodeKindName, T_SHORTNAME AS CodeKindNameShort" +
                      " FROM DOBJKCODE_DBT" +
                      " WHERE T_OBJECTTYPE = " + string(ObjectType) +
                      "      AND T_CODEKIND = " + CODEKIND_3;

      ds_sub = TRsbDataSet(query_sub, RSDVAL_CLIENT, RSDVAL_STATIC);

      p = TWSCodeValue();

      if( ds_sub.MoveNext() )
        p.CodeKindNumber    = CODEKIND_3;
        p.CodeKindName      = ds_sub.CodeKindName;
        p.CodeKindNameShort = ds_sub.CodeKindNameShort;
      end;

      p.CodeValue = ds.CodeValue;

      result.CodeValues.value(result.CodeValues.Size) = p;

    end;

    // CODEKIND 4

    query = "SELECT T_LSIN AS CodeValue FROM DAVOIRISS_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      query_sub = "SELECT T_NAME AS CodeKindName, T_SHORTNAME AS CodeKindNameShort" +
                      " FROM DOBJKCODE_DBT" +
                      " WHERE T_OBJECTTYPE = " + string(ObjectType) +
                      "      AND T_CODEKIND = " + CODEKIND_4;

      ds_sub = TRsbDataSet(query_sub, RSDVAL_CLIENT, RSDVAL_STATIC);

      p = TWSCodeValue();

      if( ds_sub.MoveNext() )
        p.CodeKindNumber    = CODEKIND_4;
        p.CodeKindName      = ds_sub.CodeKindName;
        p.CodeKindNameShort = ds_sub.CodeKindNameShort;
      end;

      p.CodeValue = ds.CodeValue;

      result.CodeValues.value(result.CodeValues.Size) = p;

    end;

    // CODEKIND 5

    query = "SELECT T_ISIN AS CodeValue FROM DAVOIRISS_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      query_sub = "SELECT T_NAME AS CodeKindName, T_SHORTNAME AS CodeKindNameShort" +
                      " FROM DOBJKCODE_DBT" +
                      " WHERE T_OBJECTTYPE = " + string(ObjectType) +
                      "      AND T_CODEKIND = " + CODEKIND_5;

      ds_sub = TRsbDataSet(query_sub, RSDVAL_CLIENT, RSDVAL_STATIC);

      p = TWSCodeValue();

      if( ds_sub.MoveNext() )
        p.CodeKindNumber    = CODEKIND_5;
        p.CodeKindName      = ds_sub.CodeKindName;
        p.CodeKindNameShort = ds_sub.CodeKindNameShort;
      end;

      p.CodeValue = ds.CodeValue;

      result.CodeValues.value(result.CodeValues.Size) = p;

    end;

    // CODEKIND 6

    query = "SELECT T_CODEINACCOUNT AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      query_sub = "SELECT T_NAME AS CodeKindName, T_SHORTNAME AS CodeKindNameShort" +
                      " FROM DOBJKCODE_DBT" +
                      " WHERE T_OBJECTTYPE = " + string(ObjectType) +
                      "      AND T_CODEKIND = " + CODEKIND_6;

      ds_sub = TRsbDataSet(query_sub, RSDVAL_CLIENT, RSDVAL_STATIC);

      p = TWSCodeValue();

      if( ds_sub.MoveNext() )
        p.CodeKindNumber    = CODEKIND_6;
        p.CodeKindName      = ds_sub.CodeKindName;
        p.CodeKindNameShort = ds_sub.CodeKindNameShort;
      end;

      p.CodeValue = ds.CodeValue;

      result.CodeValues.value(result.CodeValues.Size) = p;

    end;

  end;

  query = "SELECT T_CODEKIND as CodeKindNumber," +
          " T_NAME as CodeKindName," +
          " T_SHORTNAME as CodeKindNameShort," +
          " T_DUPLICATE as CodeKindDuplicate" +
            " FROM DOBJKCODE_DBT " +
            " WHERE T_OBJECTTYPE = " + string(ObjectType) +
            " ORDER BY T_CODEKIND";

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while (ds.MoveNext())

    p = TWSCodeKind();

    p.CodeKindNumber    = ds.CodeKindNumber;
    p.CodeKindName      = ds.CodeKindName;
    p.CodeKindNameShort = ds.CodeKindNameShort;
    p.CodeKindDuplicate = ds.CodeKindDuplicate;

    result.CodeKinds.value(result.CodeKinds.Size) = p;

  end;

  query = "SELECT MAX(T_CURDATE) as LastOpenCurDate" +
              " FROM DCURDATE_DBT " +
              " WHERE T_ISCLOSED != 'X' AND T_BRANCH = " + string({OperDprt});

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())
    result.LastOpenCurDate = ds.LastOpenCurDate;
  end;

  result.CurDate     = {curdate};

  if( {cTypePerson} == TP_ADM )
    result.UserIsAdmin = true;
  else
    result.UserIsAdmin = false;
  end;

  return result;

end;

private macro SetCodeValue(codevalue, code_value)

  codevalue.objecttype    = ParmObjectType;
  codevalue.codekind      = code_value.CodeKindNumber;
  codevalue.objectid      = ParmObjectID;
  codevalue.code          = code_value.CodeValue;
  // codevalue.state         =
  codevalue.bankdate      = code_value.DateFrom;
  // codevalue.sysdate       =
  // codevalue.systime       =
  codevalue.userid        = {oper};
  // codevalue.branch        =
  // codevalue.numsession    =
  // codevalue.unique        =
  // codevalue.autokey       =
  codevalue.bankclosedate = code_value.DateTo;

end;

private macro IsChangeCodeValue(codevalue1, codevalue2):bool
   var RetVal = true;

   if( (codevalue1.codekind      == codevalue2.codekind      ) AND
       (codevalue1.code          == codevalue2.code          ) AND
       (codevalue1.bankdate      == codevalue2.bankdate      ) AND
       (codevalue1.bankclosedate == codevalue2.bankclosedate ) )
     RetVal = false;
   end;

   return  RetVal;
end;

private macro TrnSaveCodeValueList()

  var codevalue = Tbfile ("objcode", "W", 4);
  var codevalueOld = Tbfile ("objcode", "W", 4);
  
  codevalue.Clear();
  codevalueOld.Clear();

  VAR CodeValueList = ParmCodeValueList; // Виды ФИ
  var retval = true;

  var size = CodeValueList.size();
  var i = 0;
  var code_value;

  gStat = 0; gMessage = "";

  // Удаляем старые записи
  i = 0;
  while((i < size) AND (gStat == 0))
    code_value = CodeValueList(i);

    if(code_value.Action == "REMOVE")
      var query = "DELETE FROM DOBJCODE_DBT WHERE T_AUTOKEY = " + code_value.Autokey;
      ExecSQL(query);
    end;

    i = i +1;
  end;

  // Редактируем старые записи
  i = 0;
  while((i < size) AND (gStat == 0))
    code_value = CodeValueList(i);

    if(code_value.Action == "MODIFY")
      codevalueOld.Clear();
      
      if(code_value.Autokey != 0)
        codevalueOld.rec.Autokey = code_value.Autokey;
        if(not codevalueOld.GetEQ())
          gStat = 70;
          gMessage = "Конфликт. Документ изменен другим операционистом";
        end;
      end;

      if(gStat == 0)
        Copy(codevalue, codevalueOld);
        
        if(not codevalue.GetEQ())
          gStat = 70;
          gMessage = "Конфликт. Документ изменен другим операционистом";
        end; 
      end;
        
      if(gStat == 0)
        SetCodeValue(codevalue.rec, code_value);
        
        if(IsChangeCodeValue(codevalue.rec, codevalueOld.rec))
          if(not codevalue.update())
            gStat = 1;
            gMessage = "Ошибка обновления записи таблицы dobjcode_dbt";
          end;
        end;
      end;
    end;

    i = i +1;
  end;
  
  // Вставляем новые
  i = 0;
  while((i < size) AND (gStat == 0))
    code_value = CodeValueList(i);

    if(code_value.Action == "CREATE")
    
      codevalue.Clear();
      
      SetCodeValue(codevalue.rec, code_value);
      
      if(not codevalue.insert())
        gStat = 1;
        gMessage = "Ошибка вставки новой записи в таблицу dobjcode_dbt";
      end;
      
    end;

    i = i +1;
  end;

  if(gStat != 0 )
    retval = false;
  end;

  if((retval == false) and (TrnFlag == true))
    AbortTrn();
  end;

  return retval;

OnError( err )
  if(gMessage == "")
     gStat = -1;
     gMessage = err.message;
  end;
  if(TrnFlag == true)
     AbortTrn();
  end;
end;

macro SaveListCodeValues
(
  ObjectType : integer, // Вид объекта
  ObjectID   : integer, // Ид. объекта
  CodeValues : TArray   // Массив кодов для сохранения
)
  TrnFlag = true;

  if(ObjectType == V_UNDEF)
    RunError("Не задан вид объекта");
  end;

  var RetVal = NULL;

  ParmObjectType    = ObjectType;
  ParmObjectID      = ObjectID;
  ParmCodeValueList = CodeValues;
  
  if( ProcessTrn(NULL,"TrnSaveCodeValueList") != true )
    RunError("Ошибка сохранения");
  end;

  return RetVal;
end;

MACRO SaveListCodeValuesWOTrn
(
  ObjectType : integer, // Вид объекта
  ObjectID   : integer, // Ид. объекта
  CodeValues : TArray,  // Массив кодов для сохранения
  ErrorMsg   : @string
):integer
  var RetVal = 0;

  TrnFlag = false;

  if(ObjectType == V_UNDEF)
    RetVal   = 1;
    ErrorMsg = "Не задан вид объекта";
  elif(ObjectID == V_UNDEF)
    RetVal   = 1;
    ErrorMsg = "Не задан идентификатор объекта";
  else
    ParmObjectType    = ObjectType;
    ParmObjectID      = ObjectID;
    ParmCodeValueList = CodeValues;

    TrnSaveCodeValueList();

    RetVal = gStat;
    ErrorMsg = gMessage;
  end;

  return RetVal;
END;

private macro TrnSaveCodeValue()

  var codevalue = Tbfile ("objcode", "W", 4);
  var codevalueOld = Tbfile ("objcode", "W", 4);
  
  codevalue.Clear();
  codevalueOld.Clear();

  ParmResult = true;
  var stat = 0;

  // Редактируем старые записи

  if(ParmCodeValue.Action == "MODIFY")
    codevalueOld.Clear();
    
    if(ParmCodeValue.Autokey != 0)
      codevalueOld.rec.Autokey = ParmCodeValue.Autokey;
      if(not codevalueOld.GetEQ())
        stat = 70;
      end;
    end;

    if(stat == 0)
      Copy(codevalue, codevalueOld);
      
      if(not codevalue.GetEQ())
        stat = 70;
      end; 
    end;
      
    if(stat == 0)
      SetCodeValue(codevalue.rec, ParmCodeValue);
      
      if(IsChangeCodeValue(codevalue.rec, codevalueOld.rec))
        if(not codevalue.update())
          stat = 1;
        end;
      end;
    end;
  end;

  // Вставляем новые

  if(ParmCodeValue.Action == "CREATE")
  
    codevalue.Clear();
    
    SetCodeValue(codevalue.rec, ParmCodeValue);
    
    if(not codevalue.insert())
      stat = 1;
    end;
    
  end;

  if(stat != 0 )
    ParmResult = false;
  end;

  AbortTrn();
end;

macro CheckCodeValue
(
  ObjectType : integer, // Вид объекта
  ObjectID   : integer, // Ид. объекта
  CodeValue
)
  var CheckResult = TWSCheckResult();
  
  CheckResult.Result = true;

  ParmObjectType    = ObjectType;
  ParmObjectID      = ObjectID;
  ParmCodeValue     = CodeValue;
  
  ProcessTrn(NULL,"TrnSaveCodeValue");
  
  CheckResult.Result = ParmResult;
  
  return CheckResult;
end;

macro WebCore_GetObjCodeKindList(ObjectType, sub, listLen)

  var cmd, rs;

  var Arr = TArray;
  
  var Rec = TRecHandler("objkcode");

  var query = " SELECT t.* "
              "  FROM dobjkcode_dbt t WHERE t_objecttype = " + ObjectType;
  
  if(sub != "")
  
    query = query + " AND LOWER(T_NAME) LIKE LOWER ('%' || ? || '%') ";
  
  end;

  if( listLen != 0 )

    query = query + " AND ROWNUM < " + string(listLen);

  end;
  
  query = query + " ORDER BY t_CodeKind ";

  cmd = RsdCommand(query);
  
  cmd.NullConversion = true;
  
  if(sub != "")
  
    cmd.addParam( "", RSDBP_IN, sub );
  
  end;
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)
    
    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objkcode");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;
  
end;



  // setOutput("..\\txtfile\\SaveListCodeValues.log");
  // setOutput();

  // println("SaveListCodeValues");
  // println("------------------------------------------------------");

  // var codevalue;
  // var size = CodeValues.size();
  // var i = 0;
  // while((i < size))
    // codevalue = CodeValues(i);

    // println("CodeKindNumber = "   , codevalue.CodeKindNumber);
    // println("CodeKindName = "     , codevalue.CodeKindName);
    // println("CodeKindNameShort = ", codevalue.CodeKindNameShort);
    // println("CodeValue = "        , codevalue.CodeValue);
    // println("DateFrom = "         , codevalue.DateFrom);
    // println("DateTo = "           , codevalue.DateTo);
    // println("Autokey = "          , codevalue.Autokey);
    // println("Action = "           , codevalue.Action);
    // println("------------------------------------------------------");
    // i = i +1;
  // end;


    // println("do----------------------------------------------------");
    // println("objecttype = "   , codevalue.rec.objecttype);
    // println("codekind = "     , codevalue.rec.codekind);
    // println("objectid = "     , codevalue.rec.objectid);
    // println("code = "         , codevalue.rec.code);
    // println("state = "        , codevalue.rec.state);
    // println("bankdate = "     , codevalue.rec.bankdate);
    // println("sysdate = "      , codevalue.rec.sysdate);
    // println("systime = "      , codevalue.rec.systime);
    // println("userid = "       , codevalue.rec.userid);
    // println("branch = "       , codevalue.rec.branch);
    // println("numsession = "   , codevalue.rec.numsession);
    // println("unique = "       , codevalue.rec.unique);
    // println("autokey = "      , codevalue.rec.autokey);
    // println("bankclosedate = ", codevalue.rec.bankclosedate);
    // println("------------------------------------------------------");        
