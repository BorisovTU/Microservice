/*
$Name:           rpchkaddress.mac
$Module:         Ядро ГКБО
$Description:    Процедура проверки адресов по ФИАС
*/

import PTInter, CTInter, "globals.mac", cb_sql;
import rsd, oralib, likepy;
import "dlwreps.mac";
import "rpchkaddress_lib.mac";

file adrtype(adrtype);

var arrKladrObject : TArray;

arrKladrObject = TArray(10);

/*Таблица для результатов проверки*/
const _ResultTableNum = 2;

const
  _ResultRowType_ErrorElement = 1
 ,_ResultRowType_Correction   = 2
 ,_ResultRowType_Information  = 3
 ,_ResultRowType_ErrorAddress = 4
 ,_ResultRowType_NoError      = 5
 ,_ResultRowType_AddrCorrection = 6;

/*Порядковые номера полей для размножения в таблице для результатов проверки*/
const 
  _ResultEmptyRowNum   = 1
 ,_ResultPartyRowNum   = 2
 ,_ResultAddressRowNum = 3
 ,_ResultTitleRowNum   = 4;

private var _PrevPartyID     = 0;
private var _PrevAddressType = 0;

private var _PartyCount        = 0;
private var _AddressCount      = 0;
private var _ErrorCount        = 0;
private var _CorrectionCount   = 0;
private var _AddressErrorCount = 0;
private var _AddrCorrectionCount = 0;

private macro _MultipleRowToEnd
(
  table : integer
 ,num : integer
 ,row : integer
)
  [~MultipleRow]; 
  println(table); /*идентификатор таблицы*/      
  println(num);   /*необходимое количество строк*/
  println();      /*закладка для таблицы*/
  println(row);   /*номер ряда, который необходимо размножить*/
  println(1);     /*добавить в конец таблицы*/
end;

private macro _PrintResultParty(PartyID : integer)
  var query = "";
  var rs;
  var params : TArray;
  var PartyName;
  var LegalForm;
  var PartyCode;

  query = query + "SELECT ";
  query = query + "  t1.t_Name ";
  query = query + " ,t1.t_LegalForm ";
  query = query + " ,(SELECT NVL(t2.t_Code, CHR(1)) FROM dpartcode_dbt t2 WHERE t2.t_PartyID = t1.t_PartyID AND t2.t_CodeKind = 1)";
  query = query + "  FROM dparty_dbt t1 ";
  /*
  query = query + "  FULL OUTER JOIN dpartcode_dbt t2 ";
  query = query + "       ON (    t2.t_PartyID = t1.t_PartyID ";
  query = query + "           AND t2.t_CodeKind = 1 ";
  query = query + "          ) ";
  */
  query = query + " WHERE t1.t_PartyID = :PartyID ";

  params = makeArray(SQLParam("PartyID", PartyID)
                    );
  rs = execSQLselect(query, params, true);
  if(rs.moveNext())
    PartyName = rs.value(0);
    if(rs.value(1) == PTLEGF_INST)
      LegalForm = "юридическое лицо";
    else
      LegalForm = "физическое лицо";
    end;
    PartyCode = rs.value(2);

    [~party_id1];
    println(PartyID);

    [~party_code1];
    println(PartyCode);

    [~party_name1];
    println(PartyName);

    [~legal_form1];
    println(LegalForm);
  end;                         
end;

private macro _AddResultParty(PartyID : integer)
  _PartyCount = _PartyCount + 1;
  _MultipleRowToEnd(_ResultTableNum, 1, _ResultEmptyRowNum);
  _MultipleRowToEnd(_ResultTableNum, 1, _ResultPartyRowNum);
  _PrintResultParty(PartyID);
end;

private macro _PrintResultAddressType(AddressType : integer) : bool
  var AddressTypeName = "";
  adrtype.Type = AddressType;
  if(GetEQ(adrtype))
    AddressTypeName = adrtype.Name;
  end;
  [~address_type_name1];
  println(AddressTypeName);
end;

private macro _AddResultAddress(AddressType : integer)
  _AddressCount = _AddressCount + 1;
  _MultipleRowToEnd(_ResultTableNum, 1, _ResultAddressRowNum);
  _PrintResultAddressType(AddressType);
end;

private macro _AddResultTitle(RowType : integer, Title : string, Context : string)

  if(RowType == _ResultRowType_ErrorElement)
    _ErrorCount = _ErrorCount + 1;
  elif(RowType == _ResultRowType_Correction)
    _CorrectionCount = _CorrectionCount + 1;
  elif(RowType == _ResultRowType_AddrCorrection)
    _AddrCorrectionCount = _AddrCorrectionCount + 1;
  elif(RowType == _ResultRowType_ErrorAddress)
    _AddressErrorCount = _AddressErrorCount + 1;
  end;
  
  _MultipleRowToEnd(_ResultTableNum, 1, _ResultTitleRowNum);
  [~title1];
  println(Title);
  [~context1];
  println(Context);
end;

private macro _DeleteTemplateResult()
  [~DeleteRows]; 
  println(_ResultTableNum);                         /*идентификатор таблицы*/
  println("%");
  println(_ResultEmptyRowNum);                      /*номер первой строки*/
  println(/*_ResultEmptyRowNum + */_ResultTitleRowNum); /*номер последней строки*/
end;

private macro _PrintHeader
(
  InvokeOption : integer /* Вариант вызова */
 ,NotCheckedOnSave : bool /* Адреса, не проверяемые при сохранении: Да/Нет */
 ,AddressType : string /* Значение поля "Вид адреса" панели */
 ,CheckElements : string /* Значение поля "Элементы адреса" панели */
 ,CheckAddress : string /* Значение поля "Поле Адрес" панели */
 ,SavePrevious : bool /* Сохранять изменения в истории параметров субъекта: Да/Нет */
)
  [~execution_datetime];
  println(string(date()), " ", string(time()));

  [~oper_num];
  println({oper});

  [~oper_level];
  if  ({cRealTypePerson} == codefor("У")) println("Управляющий"      );
  elif({cRealTypePerson} == codefor("Б")) println("Главный бухгалтер");
  elif({cRealTypePerson} == codefor("Н")) println("Начальник отдела" );
  elif({cRealTypePerson} == codefor("О")) println("Операционист"     );
  elif({cRealTypePerson} == codefor("А")) println("Администратор"    );
  elif({cRealTypePerson} == codefor("С")) println("Старший смены"    );
  elif({cRealTypePerson} == codefor("Р")) println("Ревизор"          );
  elif({cRealTypePerson} == codefor("Д")) println("Адм. безопасности");
  else                                    println("");
  end;

  [~oper_name];
  println({Name_Oper});

  [~invoke_option];
  if  (InvokeOption == CHECK_ADDRESS_INVOKE_GRPPT) println("все адреса группы субъектов экономики");
  elif(InvokeOption == CHECK_ADDRESS_INVOKE_SELPT) println("все адреса выбранного субъекта экономики");
  elif(InvokeOption == CHECK_ADDRESS_INVOKE_ONEPT) println("все адреса субъекта экономики");
  elif(InvokeOption == CHECK_ADDRESS_INVOKE_GRPAD) println("выбранные адреса субъекта экономики");
  elif(InvokeOption == CHECK_ADDRESS_INVOKE_SELAD) println("выбранный адрес субъекта экономики");
  elif(InvokeOption == CHECK_ADDRESS_INVOKE_ONEAD) println("адрес субъекта экономики");
  else                                             println("");
  end;

  [~address_type];
  println(AddressType);

  [~not_checked_on_save];
  if(NotCheckedOnSave) println("Да" );
  else                 println("Нет");
  end;

  [~check_elements];
  println(CheckElements);

  [~check_address];
  println(CheckAddress);

  [~save_previous];
  if(SavePrevious) println("Да" );
  else             println("Нет");
  end;
end;

private macro _PrintFooter()
  [~party_count];
  println(_PartyCount);

  [~address_count];
  println(_AddressCount);

  [~error_count];
  println(_ErrorCount);

  [~correction_count];
  println(_CorrectionCount);

  [~address_error_count];
  println(_AddressErrorCount);

  [~addr_correction_count];
  println(_AddrCorrectionCount);
end;

private macro _PrintResultTable()
  var query = "";
  var rs;
  var params : TArray;
  var PartyID    ;
  var AddressType;
  var RowType    ;
  var Title      ;
  var Context    ;

  query = query + "SELECT ";
  query = query + "  t1.t_PartyID ";
  query = query + " ,NVL(t2.t_AddressType, -1) ";
  query = query + " ,NVL(t2.t_RowType, -1) ";
  query = query + " ,NVL(t2.t_Title, CHR(1)) ";
  query = query + " ,NVL(t2.t_Context, CHR(1)) ";
  query = query + "  FROM ";
  query = query + "   ( ";
  query = query + "    SELECT DISTINCT t_PartyID ";
  query = query + "      FROM dcheckaddress_tmp ";
  query = query + "   ) t1 ";
  query = query + " FULL JOIN drpchkaddress_tmp t2 ON (t2.t_PartyID = t1.t_PartyID)";
  query = query + " ORDER BY t1.t_PartyID, t2.t_AutoKey ";

  params = makeArray();
  rs = execSQLselect(query, params, true);
  while(rs and rs.moveNext())
    PartyID = rs.value(0);
    AddressType = rs.value(1);
    RowType = rs.value(2);
    Title = rs.value(3);
    Context = rs.value(4);

    /*Выводим данные в Word*/
    if(_PrevPartyID != PartyID)
    /*
    msgbox
      (
        "_PrintResultTable:"
       ,"|PartyID    =", PartyID    
       ,"|AddressType=", AddressType
       ,"|RowType    =", RowType    
       ,"|Title      =", Title      
       ,"|Context    =", Context    
      );
    */
      _PrevPartyID = PartyID;
      _PrevAddressType = AddressType;
      _AddResultParty(_PrevPartyID);
      if(_PrevAddressType > 0)
        _AddResultAddress(_PrevAddressType);
      end;
    elif(_PrevAddressType != AddressType)
      _PrevAddressType = AddressType;
      if(_PrevAddressType > 0)
        _AddResultAddress(_PrevAddressType);
      end;
    end;

    if(RowType > 0)
      _AddResultTitle(RowType, Title, Context);
    end;
  end;                         
end;

macro ReportCheckAddress
(
  InvokeOption : integer /* Вариант вызова */
 ,NotCheckedOnSave : bool /* Адреса, не проверяемые при сохранении: Да/Нет */
 ,AddressType : string /* Значение поля "Вид адреса" панели */
 ,CheckElements : string /* Значение поля "Элементы адреса" панели */
 ,CheckAddress : string /* Значение поля "Поле Адрес" панели */
 ,SavePrevious : bool /* Сохранять изменения в истории параметров субъекта: Да/Нет */
)
  PrintLn("ReportCheckAddress.dot");
  PrintLn("rpchkaddress");

  [~KillBm];
  
  /*вставить шапку*/
  _PrintHeader
    (
      InvokeOption
     ,NotCheckedOnSave
     ,AddressType
     ,CheckElements
     ,CheckAddress
     ,SavePrevious
    );
  /*вставить табличные данные*/
  _PrintResultTable();
  /*удалить шаблонные строки из протокола*/
  _DeleteTemplateResult();
  /*вставить подвал*/
  _PrintFooter();

  DLWREPS_PrintReportFromTagFile( SetOutput (GetTxtFileName ("rpchkaddressw")) );
  SetOutput(NULL, false);
end;

private macro _CheckAddressSpecSymb
(
  AddressObj : RsbPartyAddress
 /*,NotCheck : string*/
 ,ErrorData : RsbCheckAddressError
) : integer

  var stat = 0;

  if((stat == 0) and ((index(AddressObj.PostIndex, "*") != 0) or (index(AddressObj.PostIndex, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_POSTINDEX;
  end;

  if((stat == 0) and ((index(AddressObj.Region, "*") != 0) or (index(AddressObj.Region, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_REGION;
  end;

  if((stat == 0) and ((index(AddressObj.Province, "*") != 0) or (index(AddressObj.Province, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_PROVINCE;
  end;

  if((stat == 0) and ((index(AddressObj.District, "*") != 0) or (index(AddressObj.District, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_DISTRICT;
  end;

  if((stat == 0) and ((index(AddressObj.Place, "*") != 0) or (index(AddressObj.Place, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_PLACE;
  end;

  if((stat == 0) and ((index(AddressObj.Plan, "*") != 0) or (index(AddressObj.Plan, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_PLAN;
  end;

  if((stat == 0) and ((index(AddressObj.Street, "*") != 0) or (index(AddressObj.Street, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_STREET;
  end;

  if((stat == 0) and ((index(AddressObj.House, "*") != 0) or (index(AddressObj.House, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_HOUSE;
  end;

  if((stat == 0) and ((index(AddressObj.NumCorps, "*") != 0) or (index(AddressObj.NumCorps, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_NUMCORPS;
  end;

  if((stat == 0) and ((index(AddressObj.Building, "*") != 0) or (index(AddressObj.Building, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_BUILDING;
  end;

  if((stat == 0) and ((index(AddressObj.Flat, "*") != 0) or (index(AddressObj.Flat, "?") != 0)))
    stat = 1;
    ErrorData.Field = ADDRFLD_FLAT;
  end;

  if(stat == 1)
    ErrorData.Text = "Недопустимый символ '*' или '?' в наименованиях адресных объектов";
    ErrorData.MustCorrected = true;
  end;

  return stat;
end;

private macro _FormRowReportCheckAddress
(
  PartyID : integer
 ,AddressType : integer
 ,RowType : integer
 ,Title : string
 ,Context : string
)
  var query = "";  
  var cmd;
  
  query = query + "INSERT INTO drpchkaddress_tmp ";
  query = query + "( ";
  query = query + "  t_PartyID ";
  query = query + " ,t_AddressType ";
  query = query + " ,t_RowType ";
  query = query + " ,t_Title ";
  query = query + " ,t_Context ";
  query = query + ") ";
  query = query + "VALUES ";
  query = query + "( ";
  query = query + "  ? ";
  query = query + " ,? ";
  query = query + " ,? ";
  query = query + " ,? ";
  query = query + " ,? ";
  query = query + ") ";

  cmd = RsdCommand(query);

  cmd.addParam("", RSDBP_IN, PartyID    );
  cmd.addParam("", RSDBP_IN, AddressType);
  cmd.addParam("", RSDBP_IN, RowType    );
  cmd.addParam("", RSDBP_IN, Title      );
  cmd.addParam("", RSDBP_IN, Context    );
  
  cmd.execute();
end;

private macro _FormErrorReportCheckAddress
(
  PartyID : integer
 ,AddressType : integer
 ,ErrorData : RsbCheckAddressError
)
  var RowType = _ResultRowType_ErrorElement;
  if(ErrorData.Field == ADDRFLD_ADDRESS)
    RowType = _ResultRowType_ErrorAddress;
  end;

  _FormRowReportCheckAddress
  (
    PartyID
   ,AddressType
   ,RowType
   ,"Ошибка"
   ,ErrorData.Text
  )
end;

private macro _FormNoErrorReportCheckAddress
(
  PartyID : integer
 ,AddressType : integer
)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT 1 ";
  query = query + "  FROM drpchkaddress_tmp ";
  query = query + " WHERE t_PartyID = :PartyID ";
  query = query + "   AND t_AddressType = :AddressType ";

  params = makeArray(SQLParam("PartyID", PartyID)
                    ,SQLParam("AddressType", AddressType)
                    );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
  else
    _FormRowReportCheckAddress
      (
        PartyID
       ,AddressType
       ,_ResultRowType_NoError
       ,"Ошибок нет"
       ,""
      )
  end;                         
end;

private macro _IsAdrTypeAutoEdit(AddressType : integer) : bool
  var AutoEdit = false;
  adrtype.Type = AddressType;
  if(GetEQ(adrtype))
    if(adrtype.AutoEdit == "X")
      AutoEdit = true;
    end;
  end;
  return AutoEdit;  
end;

private macro _IsAdrTypeControl(AddressType : integer) : bool
  var Control = false;
  adrtype.Type = AddressType;
  if(GetEQ(adrtype))
    if(adrtype.Control == "X")
      Control = true;
    end;
  end;
  return Control;  
end;

private macro _RemoveSpecSymb(FromStr : string) : string
  var ToStr, i, Symb;

  ToStr = "";
  i = 0;
  while(i < strlen(FromStr))
    i = i + 1;
    Symb = substr(FromStr, i, 1);
    if((Symb != "*") and (Symb != "?"))
      ToStr = ToStr + Symb;
    end;
  end;

  return ToStr;
end;

private macro _GetFieldName(Field : integer) : string
  var FieldName = "";

  if(Field == ADDRFLD_POSTINDEX)
    FieldName = "<Индекс>";
  
  elif(Field == ADDRFLD_TERRITORY)
    FieldName = "<Территория>";
  
  elif(Field == ADDRFLD_COUNTRY)
    FieldName = "<Страна>";
  
  elif(Field == ADDRFLD_CODEREGION)
    FieldName = "<Краткое наименование вида региона>";
  
  elif(Field == ADDRFLD_CODEPROVINCE)
    FieldName = "<Краткое наименование вида района>";
  
  elif(Field == ADDRFLD_CODEDISTRICT)
    FieldName = "<Краткое наименование вида города>";
  
  elif(Field == ADDRFLD_CODEPLACE)
    FieldName = "<Краткое наименование вида населенного пункта>";
  
  elif(Field == ADDRFLD_CODEPLAN)
    FieldName = "<Краткое наименование вида планировочной структуры>";
  
  elif(Field == ADDRFLD_CODESTREET)
    FieldName = "<Краткое наименование вида улицы>";
  
  elif(Field == ADDRFLD_REGION)
    FieldName = "<Регион>";

  elif(Field == ADDRFLD_PROVINCE)
    FieldName = "<Район>";
  
  elif(Field == ADDRFLD_DISTRICT)
    FieldName = "<Город>";

  elif(Field == ADDRFLD_PLACE)
    FieldName = "<Населенный пункт>";

  elif(Field == ADDRFLD_PLAN)
    FieldName = "<Планировочная структура>";

  elif(Field == ADDRFLD_STREET)
    FieldName = "<Улица>";
  
  elif(Field == ADDRFLD_HOUSE)
    FieldName = "<Дом>";

  elif(Field == ADDRFLD_NUMCORPS)
    FieldName = "<Корпус>";

  elif(Field == ADDRFLD_BUILDING)
    FieldName = "<Строение>";

  elif(Field == ADDRFLD_FLAT)
    FieldName = "<Квартира>";

  elif(Field == ADDRFLD_ADDRESS)
    FieldName = "<Адрес>";

  elif(Field == ADDRFLD_OKATO)
    FieldName = "<ОКАТО>";

  elif(Field == ADDRFLD_OKTMO)
    FieldName = "<ОКТMО>";

  elif(Field == ADDRFLD_FIAS)
    FieldName = "<ФИАС>";

  end;

  return FieldName;
end;

private macro _GetSocrField(Field : integer) : integer
  var SocrField = -1;

  if(Field == ADDRFLD_REGION)
    SocrField = ADDRFLD_CODEREGION;
  
  elif(Field == ADDRFLD_PROVINCE)
    SocrField = ADDRFLD_CODEPROVINCE;
  
  elif(Field == ADDRFLD_DISTRICT)
    SocrField = ADDRFLD_CODEDISTRICT;
  
  elif(Field == ADDRFLD_PLACE)
    SocrField = ADDRFLD_CODEPLACE;
  
  elif(Field == ADDRFLD_PLAN)
    SocrField = ADDRFLD_CODEPLAN;
  
  elif(Field == ADDRFLD_STREET)
    SocrField = ADDRFLD_CODESTREET;
  
  end;

  return SocrField;
end;

private macro _CorrectAddressSpecSymb
(
  AddressObj : RsbPartyAddress
 ,ErrorData : RsbCheckAddressError
 ,ValueBefore : @string
 ,ValueAfter : @string
)
  if(ErrorData.Field == ADDRFLD_POSTINDEX)
    ValueBefore = AddressObj.PostIndex;
    AddressObj.PostIndex = _RemoveSpecSymb(AddressObj.PostIndex);
    ValueAfter = AddressObj.PostIndex;

  elif(ErrorData.Field == ADDRFLD_TERRITORY)
    ValueBefore = AddressObj.Territory;
    AddressObj.Territory = _RemoveSpecSymb(AddressObj.Territory);
    ValueAfter = AddressObj.Territory;

  elif(ErrorData.Field == ADDRFLD_COUNTRY)
    ValueBefore = AddressObj.Country;
    AddressObj.Country = _RemoveSpecSymb(AddressObj.Country);
    ValueAfter = AddressObj.Country;

  elif(ErrorData.Field == ADDRFLD_CODEREGION)
    ValueBefore = AddressObj.CodeRegion;
    AddressObj.CodeRegion = _RemoveSpecSymb(AddressObj.CodeRegion);
    ValueAfter = AddressObj.CodeRegion;

  elif(ErrorData.Field == ADDRFLD_CODEPROVINCE)
    ValueBefore = AddressObj.CodeProvince;
    AddressObj.CodeProvince = _RemoveSpecSymb(AddressObj.CodeProvince);
    ValueAfter = AddressObj.CodeProvince;

  elif(ErrorData.Field == ADDRFLD_CODEDISTRICT)
    ValueBefore = AddressObj.CodeDistrict;
    AddressObj.CodeDistrict = _RemoveSpecSymb(AddressObj.CodeDistrict);
    ValueAfter = AddressObj.CodeDistrict;

  elif(ErrorData.Field == ADDRFLD_CODEPLACE)
    ValueBefore = AddressObj.CodePlace;
    AddressObj.CodePlace = _RemoveSpecSymb(AddressObj.CodePlace);
    ValueAfter = AddressObj.CodePlace;

  elif(ErrorData.Field == ADDRFLD_CODEPLAN)
    ValueBefore = AddressObj.CodePlan;
    AddressObj.CodePlan = _RemoveSpecSymb(AddressObj.CodePlan);
    ValueAfter = AddressObj.CodePlan;

  elif(ErrorData.Field == ADDRFLD_CODESTREET)
    ValueBefore = AddressObj.CodeStreet;
    AddressObj.CodeStreet = _RemoveSpecSymb(AddressObj.CodeStreet);
    ValueAfter = AddressObj.CodeStreet;

  elif(ErrorData.Field == ADDRFLD_REGION)
    ValueBefore = AddressObj.Region;
    AddressObj.Region = _RemoveSpecSymb(AddressObj.Region);
    ValueAfter = AddressObj.Region;

  elif(ErrorData.Field == ADDRFLD_PROVINCE)
    ValueBefore = AddressObj.Province;
    AddressObj.Province = _RemoveSpecSymb(AddressObj.Province);
    ValueAfter = AddressObj.Province;

  elif(ErrorData.Field == ADDRFLD_DISTRICT)
    ValueBefore = AddressObj.District;
    AddressObj.District = _RemoveSpecSymb(AddressObj.District);
    ValueAfter = AddressObj.District;

  elif(ErrorData.Field == ADDRFLD_PLACE)
    ValueBefore = AddressObj.Place;
    AddressObj.Place = _RemoveSpecSymb(AddressObj.Place);
    ValueAfter = AddressObj.Place;
  
  elif(ErrorData.Field == ADDRFLD_PLAN)
    ValueBefore = AddressObj.Plan;
    AddressObj.Plan = _RemoveSpecSymb(AddressObj.Plan);
    ValueAfter = AddressObj.Plan;
  
  elif(ErrorData.Field == ADDRFLD_STREET)
    ValueBefore = AddressObj.Street;
    AddressObj.Street = _RemoveSpecSymb(AddressObj.Street);
    ValueAfter = AddressObj.Street;

  elif(ErrorData.Field == ADDRFLD_HOUSE)
    ValueBefore = AddressObj.House;
    AddressObj.House = _RemoveSpecSymb(AddressObj.House);
    ValueAfter = AddressObj.House;

  elif(ErrorData.Field == ADDRFLD_NUMCORPS)
    ValueBefore = AddressObj.NumCorps;
    AddressObj.NumCorps = _RemoveSpecSymb(AddressObj.NumCorps);
    ValueAfter = AddressObj.NumCorps;

  elif(ErrorData.Field == ADDRFLD_BUILDING)
    ValueBefore = AddressObj.Building;
    AddressObj.Building = _RemoveSpecSymb(AddressObj.Building);
    ValueAfter = AddressObj.Building;

  elif(ErrorData.Field == ADDRFLD_FLAT)
    ValueBefore = AddressObj.Flat;
    AddressObj.Flat = _RemoveSpecSymb(AddressObj.Flat);
    ValueAfter = AddressObj.Flat;

  elif(ErrorData.Field == ADDRFLD_ADDRESS)
    ValueBefore = AddressObj.Address;
    AddressObj.Address = _RemoveSpecSymb(AddressObj.Address);
    ValueAfter = AddressObj.Address;

  end;
end;

private macro _GetCorrectAddressValue
(
  AddressObj : RsbPartyAddress
 ,ErrorData : RsbCheckAddressError
 ,ValueBefore : @string
 ,ValueAfter : @string
)
  if(ErrorData.Field == ADDRFLD_POSTINDEX)
    ValueBefore = AddressObj.PostIndex;

  elif(ErrorData.Field == ADDRFLD_TERRITORY)
    ValueBefore = AddressObj.Territory;

  elif(ErrorData.Field == ADDRFLD_COUNTRY)
    ValueBefore = AddressObj.Country;

  elif(ErrorData.Field == ADDRFLD_CODEREGION)
    ValueBefore = AddressObj.CodeRegion;

  elif(ErrorData.Field == ADDRFLD_CODEPROVINCE)
    ValueBefore = AddressObj.CodeProvince;

  elif(ErrorData.Field == ADDRFLD_CODEDISTRICT)
    ValueBefore = AddressObj.CodeDistrict;

  elif(ErrorData.Field == ADDRFLD_CODEPLACE)
    ValueBefore = AddressObj.CodePlace;

  elif(ErrorData.Field == ADDRFLD_CODEPLAN)
    ValueBefore = AddressObj.CodePlan;

  elif(ErrorData.Field == ADDRFLD_CODESTREET)
    ValueBefore = AddressObj.CodeStreet;

  elif(ErrorData.Field == ADDRFLD_REGION)
    ValueBefore = AddressObj.Region;

  elif(ErrorData.Field == ADDRFLD_PROVINCE)
    ValueBefore = AddressObj.Province;

  elif(ErrorData.Field == ADDRFLD_DISTRICT)
    ValueBefore = AddressObj.District;

  elif(ErrorData.Field == ADDRFLD_PLACE)
    ValueBefore = AddressObj.Place;
  
  elif(ErrorData.Field == ADDRFLD_PLAN)
    ValueBefore = AddressObj.Plan;
  
  elif(ErrorData.Field == ADDRFLD_STREET)
    ValueBefore = AddressObj.Street;

  elif(ErrorData.Field == ADDRFLD_HOUSE)
    ValueBefore = AddressObj.House;

  elif(ErrorData.Field == ADDRFLD_NUMCORPS)
    ValueBefore = AddressObj.NumCorps;

  elif(ErrorData.Field == ADDRFLD_BUILDING)
    ValueBefore = AddressObj.Building;

  elif(ErrorData.Field == ADDRFLD_FLAT)
    ValueBefore = AddressObj.Flat;

  elif(ErrorData.Field == ADDRFLD_ADDRESS)
    ValueBefore = AddressObj.Address;

  elif(ErrorData.Field == ADDRFLD_OKATO)
    ValueBefore = AddressObj.Okato;

  elif(ErrorData.Field == ADDRFLD_OKTMO)
    ValueBefore = AddressObj.Oktmo;

  end;

  ValueAfter = ErrorData.CorrectValue;
end;

private macro _CorrectAddressValue
(
  AddressObj : RsbPartyAddress
 ,ErrorData : RsbCheckAddressError
 ,ValueBefore : @string
 ,ValueAfter : @string
)
  _GetCorrectAddressValue
    (
      AddressObj
     ,ErrorData
     ,@ValueBefore
     ,@ValueAfter
    );
  
  if(ErrorData.Field == ADDRFLD_POSTINDEX)
    AddressObj.PostIndex = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_TERRITORY)
    AddressObj.Territory = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_COUNTRY)
    AddressObj.Country = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_CODEREGION)
    AddressObj.CodeRegion = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_CODEPROVINCE)
    AddressObj.CodeProvince = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_CODEDISTRICT)
    AddressObj.CodeDistrict = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_CODEPLACE)
    AddressObj.CodePlace = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_CODEPLAN)
    AddressObj.CodePlan = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_CODESTREET)
    AddressObj.CodeStreet = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_REGION)
    AddressObj.Region = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_PROVINCE)
    AddressObj.Province = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_DISTRICT)
    AddressObj.District = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_PLACE)
    AddressObj.Place = ValueAfter;
  
  elif(ErrorData.Field == ADDRFLD_PLAN)
    AddressObj.Plan = ValueAfter;
  
  elif(ErrorData.Field == ADDRFLD_STREET)
    AddressObj.Street = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_HOUSE)
    AddressObj.House = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_NUMCORPS)
    AddressObj.NumCorps = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_BUILDING)
    AddressObj.Building = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_FLAT)
    AddressObj.Flat = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_ADDRESS)
    AddressObj.Address = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_OKATO)
    AddressObj.Okato = ValueAfter;

  elif(ErrorData.Field == ADDRFLD_OKTMO)
    AddressObj.Oktmo = ValueAfter;

  end;
end;

private macro _CorrectKladrValue
(
  AddressObj : RsbPartyAddress
 ,ErrorData : RsbCheckAddressError
 ,ValueBefore : @string
 ,ValueAfter : @string
)
  var tmpKladr : string;
  if(strlen(AddressObj.Fias) > strlen(ErrorData.CorrectValue))
    tmpKladr = ErrorData.CorrectValue + substr(AddressObj.Fias, strlen(ErrorData.CorrectValue) + 1);
  else
    tmpKladr = ErrorData.CorrectValue;
  end;
  AddressObj.Fias = tmpKladr;
end;

private macro _SetAddressObjToRec
(
  AddressObj : RsbPartyAddress
 ,AddressRec
)
  AddressRec.RegionNum    = AddressObj.RegionNumber;
  AddressRec.PostIndex    = AddressObj.PostIndex   ;
  AddressRec.Territory    = AddressObj.Territory   ;
  AddressRec.Country      = AddressObj.Country     ;
  AddressRec.CodeRegion   = AddressObj.CodeRegion  ;
  AddressRec.CodeProvince = AddressObj.CodeProvince;
  AddressRec.CodeDistrict = AddressObj.CodeDistrict;
  AddressRec.CodePlace    = AddressObj.CodePlace   ;
  AddressRec.CodePlan     = AddressObj.CodePlan    ;
  AddressRec.CodeStreet   = AddressObj.CodeStreet  ;
  AddressRec.Region       = AddressObj.Region      ;
  AddressRec.Province     = AddressObj.Province    ;
  AddressRec.District     = AddressObj.District    ;
  AddressRec.Place        = AddressObj.Place       ;
  AddressRec.Plan         = AddressObj.Plan        ;
  AddressRec.Street       = AddressObj.Street      ;
  AddressRec.House        = AddressObj.House       ;
  AddressRec.NumCorps     = AddressObj.NumCorps    ;
  AddressRec.Building     = AddressObj.Building    ;
  AddressRec.Flat         = AddressObj.Flat        ;
  AddressRec.Adress       = AddressObj.Address     ;
  AddressRec.Fias         = AddressObj.Fias        ;
  AddressRec.FiasGuid     = AddressObj.FiasGuid    ;
  AddressRec.Okato        = AddressObj.Okato       ;
  AddressRec.Oktmo        = AddressObj.Oktmo       ;
end;

private macro _SetAddressRecToObj
(
  AddressObj : RsbPartyAddress
 ,AddressRec
 ,NotCheck : string /* массив признаков в виде строки */
)
  AddressObj.RegionNumber = AddressRec.RegionNum   ;
  
  if(not hGetStrFlag(NotCheck, ADDRFLD_POSTINDEX)   ) AddressObj.PostIndex    = AddressRec.PostIndex   ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_TERRITORY)   ) AddressObj.Territory    = AddressRec.Territory   ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_COUNTRY)     ) AddressObj.Country      = AddressRec.Country     ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_CODEREGION)  ) AddressObj.CodeRegion   = AddressRec.CodeRegion  ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_CODEPROVINCE)) AddressObj.CodeProvince = AddressRec.CodeProvince; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_CODEDISTRICT)) AddressObj.CodeDistrict = AddressRec.CodeDistrict; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_CODEPLACE)   ) AddressObj.CodePlace    = AddressRec.CodePlace   ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_CODEPLAN)    ) AddressObj.CodePlan     = AddressRec.CodePlan    ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_CODESTREET)  ) AddressObj.CodeStreet   = AddressRec.CodeStreet  ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_REGION)      ) AddressObj.Region       = AddressRec.Region      ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_PROVINCE)    ) AddressObj.Province     = AddressRec.Province    ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_DISTRICT)    ) AddressObj.District     = AddressRec.District    ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_PLACE)       ) AddressObj.Place        = AddressRec.Place       ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_PLAN)        ) AddressObj.Plan         = AddressRec.Plan        ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_STREET)      ) AddressObj.Street       = AddressRec.Street      ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_HOUSE)       ) AddressObj.House        = AddressRec.House       ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_NUMCORPS)    ) AddressObj.NumCorps     = AddressRec.NumCorps    ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_BUILDING)    ) AddressObj.Building     = AddressRec.Building    ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_FLAT)        ) AddressObj.Flat         = AddressRec.Flat        ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_ADDRESS)     ) AddressObj.Address      = AddressRec.Adress      ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_FIAS)        ) AddressObj.Fias         = AddressRec.Fias        ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_OKATO)       ) AddressObj.Okato        = AddressRec.Okato       ; end;
  if(not hGetStrFlag(NotCheck, ADDRFLD_OKTMO)       ) AddressObj.Oktmo        = AddressRec.Oktmo       ; end;
end;

private macro _CheckAddressField_Address
(
  regim : integer
 ,regimAddressFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,ErrorData : RsbCheckAddressError
 ,NotCheck : string /* массив признаков в виде строки */
)
  var MacroFuncName; /*значение настройки для проверки адреса*/
  var MacroName; /*имя макроса из значения настройки для проверки адреса*/
  var FuncName; /*имя функции из значения настройки для проверки адреса*/
  var MacroFuncNameFound = false; /*признак выполнения*/
  var AddressCheckSuccess = false;
  var i, j, k;
  record AddressRec(adress);
  var AddressStr = null;
  var tmpAddressStr;
  var stat = 0;

  GetRegistryValue("CB\\PARTY\\КЛАДР\\ГЕНЕРАЦИЯ_АДРЕСА_ПРИ_ПРОВЕРКЕ", V_STRING, MacroFuncName, stat);

  if(stat == 0)
    while(MacroFuncName != "")
      i = index(MacroFuncName, "@");
      if(i > 0)
        j = index(MacroFuncName, ";");
        MacroName = substr(MacroFuncName, 1, i - 1);
        if(j > 0)
          FuncName = substr(MacroFuncName, i + 1, j);
          MacroFuncName = substr(MacroFuncName, j + 1);
        else
          FuncName = substr(MacroFuncName, i + 1);
          MacroFuncName = "";
        end;
    
        tmpAddressStr = AddressObj.Address;
        _SetAddressObjToRec
          (
            AddressObj
           ,AddressRec
          );

        MacroFuncNameFound = ExecMacroFile(MacroName, FuncName, 0, 0, AddressRec, true);
    
        if(MacroFuncNameFound != V_UNDEF)
          _SetAddressRecToObj
            (
              AddressObj
             ,AddressRec
             ,NotCheck
            );
          AddressObj.Address = tmpAddressStr;

          if(AddressStr == null)
            AddressStr = AddressRec.Adress;
          end;
          if(not AddressCheckSuccess)
            if(trimallspace_str(normalize_str(AddressObj.Address)) == trimallspace_str(normalize_str(AddressRec.Adress)))
              AddressCheckSuccess = true;
              MacroFuncName = "";
            end;
          end;
        end;
        
      else
        MacroFuncName = "";
      end;
    end;
  end;

  if((stat != 0) or (MacroFuncNameFound == V_UNDEF))
    ErrorData.Text = "Не задана или не найдена макрофункция генерации проверочного адреса";
    ErrorData.Field = ADDRFLD_ADDRESS;
    ErrorData.MustCorrected = false;
    if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
      ErrorData.MustCorrected = true;
    end;
    ErrorData.CheckType = CHECK_ADDRESS_KLADR;
    
  else
    if(not AddressCheckSuccess)
      stat = 1;
      ErrorData.Text = "Строковое значение адреса в поле <Адрес> не соответствует содержанию полей адреса";
      ErrorData.Field = ADDRFLD_ADDRESS;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = AddressStr;

    elif(AddressObj.Address != trimspace_str(AddressObj.Address))
      stat = 1;
      ErrorData.Text = "В строковом значении адреса в поле <Адрес> содержатся лишние пробелы: лидирующие, замыкающие или множественные";
      ErrorData.Field = ADDRFLD_ADDRESS;
      ErrorData.MustCorrected = false;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = AddressRec.Adress;
      
    elif(normalize_str(AddressObj.Address) != normalize_str(AddressRec.Adress))
      stat = 1;
      ErrorData.Text = "Строковое значение адреса в поле <Адрес> не точно соответствует содержанию полей адреса (возможно, различается регистр букв)";
      ErrorData.Field = ADDRFLD_ADDRESS;
      ErrorData.MustCorrected = false;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = AddressRec.Adress;
      
    end;
  end;

  return stat;
end;

private macro _CheckAddressOneField
(
  KladrObject : TKladrObject
 ,AddrName : string
 ,AddrSocr : string
 ,StrFlag : @string
)
  if(normalize_str(AddrName) != normalize_str(KladrObject.m_Name))
    hSetStrFlag(@StrFlag, hName, true);
  else
    if(AddrName != trim(KladrObject.m_Name))
      hSetStrFlag(@StrFlag, hNameLight, true);
    end;
  end;
  if(normalize_str(AddrSocr) != normalize_str(KladrObject.m_Socr))
    hSetStrFlag(@StrFlag, hType, true);
  else
    if(AddrSocr != trim(KladrObject.m_Socr))
      hSetStrFlag(@StrFlag, hTypeLight, true);
    end;
  end;
end;

private macro _InitKladrObjectByKladrRs(KladrObject : TKladrObject, rs)
  KladrObject.m_Name   = trim(rs.value(0));
  KladrObject.m_Socr   = trim(rs.value(1));
  KladrObject.m_Code   = trim(rs.value(2));
  KladrObject.m_Index  = trim(rs.value(3));
  KladrObject.m_Okato  = trim(rs.value(4));
  KladrObject.m_Status = rs.value(5);
  KladrObject.m_Oktmo  = trim(rs.value(6));
end;

/*
private macro _InitKladrObjectByStreetRs(KladrObject : TKladrObject, rs)
  KladrObject.m_Name   = trim(rs.value(0));
  KladrObject.m_Socr   = trim(rs.value(1));
  KladrObject.m_Code   = trim(rs.value(2));
  KladrObject.m_Index  = trim(rs.value(3));
  KladrObject.m_Okato  = rs.value(4);
end;
*/

private macro _InitKladrObjectByDomaRs(KladrObject : TKladrObject, rs)
  KladrObject.m_Name   = trim(rs.value(0));
  KladrObject.m_Socr   = "";
  KladrObject.m_Code   = trim(rs.value(1));
  KladrObject.m_Index  = trim(rs.value(2));
  KladrObject.m_Okato  = trim(rs.value(3));
  KladrObject.m_Korp   = trim(rs.value(4));
  KladrObject.m_Build  = trim(rs.value(5));
  KladrObject.m_Oktmo  = trim(rs.value(6));
end;

private macro _GetRegionKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lRegion) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 2);

  query = query + "SELECT ";
  query = query + "  t_FormalName ";
  query = query + " ,t_ShortName ";
  query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
  query = query + " ,t_PostalCode ";
  query = query + " ,t_Okato ";
  query = query + " ,t_ActStatus ";
  query = query + " ,t_Oktmo ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_AOLevel = :AOLevel ";
  query = query + "   AND t_RegionCode = :RegionCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("AOLevel", 1),
                     SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    _InitKladrObjectByKladrRs(arrKladrObject(lRegion), rs);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetProvinceKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lProvince) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 5);

  query = query + "SELECT ";
  query = query + "  t_FormalName ";
  query = query + " ,t_ShortName ";
  query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
  query = query + " ,t_PostalCode ";
  query = query + " ,t_Okato ";
  query = query + " ,t_ActStatus ";
  query = query + " ,t_Oktmo ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_AOLevel = :AOLevel ";
  query = query + "   AND t_RegionCode = :RegionCode ";
  query = query + "   AND t_AreaCode = :AreaCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("AOLevel", 3),
                     SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("AreaCode", substr(Code, 3, 3)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    _InitKladrObjectByKladrRs(arrKladrObject(lProvince), rs);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetDistrictKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lDistrict) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 8);

  query = query + "SELECT ";
  query = query + "  t_FormalName ";
  query = query + " ,t_ShortName ";
  query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
  query = query + " ,t_PostalCode ";
  query = query + " ,t_Okato ";
  query = query + " ,t_ActStatus ";
  query = query + " ,t_Oktmo ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_AOLevel = :AOLevel ";
  query = query + "   AND t_RegionCode = :RegionCode ";
  query = query + "   AND t_AreaCode = :AreaCode ";
  query = query + "   AND t_CityCode = :CityCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("AOLevel", 4),
                     SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("AreaCode", substr(Code, 3, 3)),
                     SQLParam("CityCode", substr(Code, 6, 3)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    _InitKladrObjectByKladrRs(arrKladrObject(lDistrict), rs);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetPlaceKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lPlace) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 11);

  query = query + "SELECT ";
  query = query + "  t_FormalName ";
  query = query + " ,t_ShortName ";
  query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
  query = query + " ,t_PostalCode ";
  query = query + " ,t_Okato ";
  query = query + " ,t_ActStatus ";
  query = query + " ,t_Oktmo ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_AOLevel = :AOLevel ";
  query = query + "   AND t_RegionCode = :RegionCode ";
  query = query + "   AND t_AreaCode = :AreaCode ";
  query = query + "   AND t_CityCode = :CityCode ";
  query = query + "   AND t_PlaceCode = :PlaceCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("AOLevel", 6),
                     SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("AreaCode", substr(Code, 3, 3)),
                     SQLParam("CityCode", substr(Code, 6, 3)),
                     SQLParam("PlaceCode", substr(Code, 9, 3)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    _InitKladrObjectByKladrRs(arrKladrObject(lPlace), rs);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetPlanKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lPlan) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 15);

  query = query + "SELECT ";
  query = query + "  t_FormalName ";
  query = query + " ,t_ShortName ";
  query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
  query = query + " ,t_PostalCode ";
  query = query + " ,t_Okato ";
  query = query + " ,t_ActStatus ";
  query = query + " ,t_Oktmo ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_AOLevel = :AOLevel ";
  query = query + "   AND t_RegionCode = :RegionCode ";
  query = query + "   AND t_AreaCode = :AreaCode ";
  query = query + "   AND t_CityCode = :CityCode ";
  query = query + "   AND t_PlaceCode = :PlaceCode ";
  query = query + "   AND t_PlanCode = :PlanCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("AOLevel", 65),
                     SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("AreaCode", substr(Code, 3, 3)),
                     SQLParam("CityCode", substr(Code, 6, 3)),
                     SQLParam("PlaceCode", substr(Code, 9, 3)),
                     SQLParam("PlanCode", substr(Code, 12, 4)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    _InitKladrObjectByKladrRs(arrKladrObject(lPlan), rs);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetStreetKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lStreet) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 19);

  query = query + "SELECT ";
  query = query + "  t_FormalName ";
  query = query + " ,t_ShortName ";
  query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
  query = query + " ,t_PostalCode ";
  query = query + " ,t_Okato ";
  query = query + " ,t_ActStatus ";
  query = query + " ,t_Oktmo ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_AOLevel = :AOLevel ";
  query = query + "   AND t_RegionCode = :RegionCode ";
  query = query + "   AND t_AreaCode = :AreaCode ";
  query = query + "   AND t_CityCode = :CityCode ";
  query = query + "   AND t_PlaceCode = :PlaceCode ";
  query = query + "   AND t_PlanCode = :PlanCode ";
  query = query + "   AND t_StreetCode = :StreetCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("AOLevel", 7),
                     SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("AreaCode", substr(Code, 3, 3)),
                     SQLParam("CityCode", substr(Code, 6, 3)),
                     SQLParam("PlaceCode", substr(Code, 9, 3)),
                     SQLParam("PlanCode", substr(Code, 12, 4)),
                     SQLParam("StreetCode", substr(Code, 16, 4)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    _InitKladrObjectByKladrRs(arrKladrObject(lStreet), rs);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetAddrObjFiasGuid
(
  AddressObj : RsbPartyAddress,
  AOGuid : @string
)
  var stat = 0;
  arrKladrObject(lStreet) = TKladrObject();
  AOGuid = "";

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 19);

  query = query + "SELECT ";
  query = query + "  t_AOGuid ";
  query = query + "  FROM das_addrobj_dbt ";
  query = query + " WHERE t_RegionCode = :RegionCode ";
  query = query + "   AND t_AreaCode = :AreaCode ";
  query = query + "   AND t_CityCode = :CityCode ";
  query = query + "   AND t_PlaceCode = :PlaceCode ";
  query = query + "   AND t_PlanCode = :PlanCode ";
  query = query + "   AND t_StreetCode = :StreetCode ";
  query = query + "   AND t_NextID = :NextID ";

  params = makeArray(SQLParam("RegionCode", substr(Code, 1, 2)),
                     SQLParam("AreaCode", substr(Code, 3, 3)),
                     SQLParam("CityCode", substr(Code, 6, 3)),
                     SQLParam("PlaceCode", substr(Code, 9, 3)),
                     SQLParam("PlanCode", substr(Code, 12, 4)),
                     SQLParam("StreetCode", substr(Code, 16, 4)),
                     SQLParam("NextID", "")
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    AOGuid = rs.value(0);
  else
    stat = 1;
  end;                         
  return stat;
end;

private macro _GetHouseKladrObject
(
  AddressObj : RsbPartyAddress
)
  var stat = 0;
  arrKladrObject(lHouse) = TKladrObject();

  var query = "";
  var rs;
  var params : TArray;
  var Code = substr(AddressObj.Fias, 1, 23);
  var AOGuid = "";
  
  stat = _GetAddrObjFiasGuid(AddressObj, @AOGuid);

  if(not stat)
    query = query + "SELECT ";
    query = query + "  t_HouseNum ";
    query = query + " ,:Code ";
    query = query + " ,t_PostalCode ";
    query = query + " ,t_Okato ";
    query = query + " ,t_BuildNum ";
    query = query + " ,t_StrucNum ";
    query = query + " ,t_Oktmo ";
    query = query + "  FROM das_house_dbt ";
    query = query + " WHERE t_AOGuid = :AOGuid ";
    query = query + "   AND TRIM(TO_CHAR(t_Counter, '0000')) = :Counter ";
    query = query + " ORDER BY t_EndDate DESC ";
    
    params = makeArray(SQLParam("Code", Code),
                       SQLParam("AOGuid", AOGuid),
                       SQLParam("Counter", substr(Code, 20, 4))
                      );

    rs = execSQLselect(query, params, true);
    if(rs and rs.moveNext())
      _InitKladrObjectByDomaRs(arrKladrObject(lHouse), rs);
    else
      stat = 1;
    end;                         
  end;
  return stat;
end;

private macro _QuickCheckAddressKladr
(
  RegionFlag   : @string
 ,ProvinceFlag : @string
 ,DistrictFlag : @string
 ,PlaceFlag    : @string
 ,PlanFlag     : @string
 ,StreetFlag   : @string
 ,HouseFlag    : @string
 ,AddressObj : RsbPartyAddress
)
  var stat = 0;

  hInitStrFlag(@RegionFlag  );
  hInitStrFlag(@ProvinceFlag);
  hInitStrFlag(@DistrictFlag);
  hInitStrFlag(@PlaceFlag   );
  hInitStrFlag(@PlanFlag    );
  hInitStrFlag(@StreetFlag  );
  hInitStrFlag(@HouseFlag   );

  if(strlen(AddressObj.Fias) < 2)
    stat = 1;
    hSetStrFlag(@RegionFlag  , hCode, true);
    hSetStrFlag(@ProvinceFlag, hCode, true);
    hSetStrFlag(@DistrictFlag, hCode, true);
    hSetStrFlag(@PlaceFlag   , hCode, true);
    hSetStrFlag(@PlanFlag    , hCode, true);
    hSetStrFlag(@StreetFlag  , hCode, true);
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    stat = _GetRegionKladrObject(AddressObj);
    if(stat == 0)
      _CheckAddressOneField
        (
          arrKladrObject(lRegion)
         ,AddressObj.Region
         ,AddressObj.CodeRegion
         ,@RegionFlag
        );
    else
      hSetStrFlag(@RegionFlag, hCode, true);
    end;
  end;

  if(strlen(AddressObj.Fias) < 5)
    stat = 1;
    hSetStrFlag(@ProvinceFlag, hCode, true);
    hSetStrFlag(@DistrictFlag, hCode, true);
    hSetStrFlag(@PlaceFlag   , hCode, true);
    hSetStrFlag(@PlanFlag    , hCode, true);
    hSetStrFlag(@StreetFlag  , hCode, true);
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    if(substr(AddressObj.Fias, 3, 3) != "000")
      stat = _GetProvinceKladrObject(AddressObj);
      if(stat == 0)
        _CheckAddressOneField
          (
            arrKladrObject(lProvince)
           ,AddressObj.Province
           ,AddressObj.CodeProvince
           ,@ProvinceFlag
          );
      else
        hSetStrFlag(@ProvinceFlag, hCode, true);
      end;
    else
      hSetStrFlag(@ProvinceFlag, hNotUse, true);
    end;
  end;

  if(strlen(AddressObj.Fias) < 8)
    stat = 1;
    hSetStrFlag(@DistrictFlag, hCode, true);
    hSetStrFlag(@PlaceFlag   , hCode, true);
    hSetStrFlag(@PlanFlag    , hCode, true);
    hSetStrFlag(@StreetFlag  , hCode, true);
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    if(substr(AddressObj.Fias, 6, 3) != "000")
      stat = _GetDistrictKladrObject(AddressObj);
      if(stat == 0)
        _CheckAddressOneField
          (
            arrKladrObject(lDistrict)
           ,AddressObj.District
           ,AddressObj.CodeDistrict
           ,@DistrictFlag
          );
      else
        hSetStrFlag(@DistrictFlag, hCode, true);
      end;
    else
      hSetStrFlag(@DistrictFlag, hNotUse, true);
    end;
  end;

  if(strlen(AddressObj.Fias) < 11)
    stat = 1;
    hSetStrFlag(@PlaceFlag   , hCode, true);
    hSetStrFlag(@PlanFlag    , hCode, true);
    hSetStrFlag(@StreetFlag  , hCode, true);
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    if(substr(AddressObj.Fias, 9, 3) != "000")
      stat = _GetPlaceKladrObject(AddressObj);
      if(stat == 0)
        _CheckAddressOneField
          (
            arrKladrObject(lPlace)
           ,AddressObj.Place
           ,AddressObj.CodePlace
           ,@PlaceFlag
          );
      else
        hSetStrFlag(@PlaceFlag, hCode, true);
      end;
    else
      hSetStrFlag(@PlaceFlag, hNotUse, true);
    end;
  end;

  if(strlen(AddressObj.Fias) < 15)
    stat = 1;
    hSetStrFlag(@PlanFlag    , hCode, true);
    hSetStrFlag(@StreetFlag  , hCode, true);
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    if(substr(AddressObj.Fias, 12, 4) != "0000")
      stat = _GetPlanKladrObject(AddressObj);
      if(stat == 0)
        _CheckAddressOneField
          (
            arrKladrObject(lPlan)
           ,AddressObj.Plan
           ,AddressObj.CodePlan
           ,@PlanFlag
          );
      else
        hSetStrFlag(@PlanFlag, hCode, true);
      end;
    else
      hSetStrFlag(@PlanFlag, hNotUse, true);
    end;
  end;

  if(strlen(AddressObj.Fias) < 19)
    stat = 1;
    hSetStrFlag(@StreetFlag  , hCode, true);
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    if(substr(AddressObj.Fias, 16, 4) != "0000")
      stat = _GetStreetKladrObject(AddressObj);
      if(stat == 0)
        _CheckAddressOneField
          (
            arrKladrObject(lStreet)
           ,AddressObj.Street
           ,AddressObj.CodeStreet
           ,@StreetFlag
          );
      else
        hSetStrFlag(@StreetFlag, hCode, true);
      end;
    else
      hSetStrFlag(@StreetFlag, hNotUse, true);
    end;
  end;

  if(strlen(AddressObj.Fias) < 23)
    stat = 1;
    hSetStrFlag(@HouseFlag   , hCode, true);
  end;
  
  if(stat == 0)
    if(substr(AddressObj.Fias, 20, 4) != "0000")
      stat = _GetHouseKladrObject(AddressObj);
      if(stat != 0)
        hSetStrFlag(@HouseFlag, hCode, true);
      end;
    else
      hSetStrFlag(@HouseFlag, hNotUse, true);
    end;
  end;

  return stat;
end;

private macro _GetKladrObjectLevel(Field : integer)
  var _ObjLevel = 0;
  if  (Field == ADDRFLD_REGION  ) _ObjLevel = lRegion  ;
  elif(Field == ADDRFLD_PROVINCE) _ObjLevel = lProvince;
  elif(Field == ADDRFLD_DISTRICT) _ObjLevel = lDistrict;
  elif(Field == ADDRFLD_PLACE   ) _ObjLevel = lPlace   ;
  elif(Field == ADDRFLD_PLAN    ) _ObjLevel = lPlan    ;
  elif(Field == ADDRFLD_STREET  ) _ObjLevel = lStreet  ;
  elif(Field == ADDRFLD_HOUSE   ) _ObjLevel = lHouse   ;
  end;
  return _ObjLevel;
end;

private macro _IsExistsKladrLevelN(Level : integer)
  var _IsExists = false;
  if  (Level == lRegion  ) _IsExists = GetKladrLevel1();
  elif(Level == lProvince) _IsExists = GetKladrLevel2();
  elif(Level == lDistrict) _IsExists = GetKladrLevel3();
  elif(Level == lPlace   ) _IsExists = GetKladrLevel4();
  elif(Level == lPlan    ) _IsExists = GetKladrLevel5();
  elif(Level == lStreet  ) _IsExists = GetKladrLevel6();
  elif(Level == lHouse   ) _IsExists = GetKladrLevel7();
  end;
  return _IsExists;
end;

private macro _GetErrorTextNotExistsKladrLevel(Field : integer)
  var ErrorText = "";
  if  (Field == ADDRFLD_REGION  ) ErrorText = "В ФИАС отсутствуют сведения о регионах. Проверить адрес по ФИАС невозможно"          ;
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "В ФИАС отсутствуют сведения о районах. Проверить адрес по ФИАС невозможно"           ;
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "В ФИАС отсутствуют сведения о городах. Проверить адрес по ФИАС невозможно"           ;
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "В ФИАС отсутствуют сведения о населенных пунктах. Проверить адрес по ФИАС невозможно";
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "В ФИАС отсутствуют сведения о планировочных структурах. Проверить адрес по ФИАС невозможно";
  elif(Field == ADDRFLD_STREET  ) ErrorText = "В ФИАС отсутствуют сведения о улицах. Проверить адрес по ФИАС невозможно"            ;
  elif(Field == ADDRFLD_HOUSE   ) ErrorText = "В ФИАС отсутствуют сведения о домах. Проверить адрес по ФИАС невозможно"             ;
  end;
  return ErrorText;
end;

private macro _GetErrorTextNotFoundCode
(
  Field : integer
 ,AddressObj : RsbPartyAddress
)
  var ErrorText = "";
  if  (Field == ADDRFLD_REGION  ) ErrorText = "В ФИАС не найден указанный в адресе регион с кодом "           + substr(AddressObj.Fias, 1,  2);
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "В ФИАС не найден указанный в адресе район с кодом "            + substr(AddressObj.Fias, 1,  5);
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "В ФИАС не найден указанный в адресе город с кодом "            + substr(AddressObj.Fias, 1,  8);
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "В ФИАС не найден указанный в адресе населенный пункт с кодом " + substr(AddressObj.Fias, 1, 11);
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "В ФИАС не найден указанный в адресе планировочная структура с кодом " + substr(AddressObj.Fias, 1, 15);
  elif(Field == ADDRFLD_STREET  ) ErrorText = "В ФИАС не найдена указанная в адресе улица с кодом "           + substr(AddressObj.Fias, 1, 19);
  elif(Field == ADDRFLD_HOUSE   ) ErrorText = "В ФИАС не найден указанный в адресе дом с кодом "              + substr(AddressObj.Fias, 1, 23);
  end;
  return ErrorText;
end;

private macro _GetErrorTextDeletedObject
(
  Field : integer
 ,AddressObj : RsbPartyAddress
)
  var ErrorText = "";
  if  (Field == ADDRFLD_REGION  ) ErrorText = "В адресе используется регион '"           + AddressObj.Region   + "', который указан в ФИАС как прекративший существование";
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "В адресе используется район '"            + AddressObj.Province + "', который указан в ФИАС как прекративший существование";
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "В адресе используется город '"            + AddressObj.District + "', который указан в ФИАС как прекративший существование";
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "В адресе используется населенный пункт '" + AddressObj.Place    + "', который указан в ФИАС как прекративший существование";
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "В адресе используется планировочная структура '" + AddressObj.Plan    + "', которая указана в ФИАС как прекратившая существование";
  elif(Field == ADDRFLD_STREET  ) ErrorText = "В адресе используется улица '"            + AddressObj.Street   + "', которая указана в ФИАС как прекратившая существование";
  elif(Field == ADDRFLD_HOUSE   ) ErrorText = "В адресе используется дом '"              + AddressObj.House    + "', который указан в ФИАС как прекративший существование";
  end;
  return ErrorText;
end;

private macro _GetErrorTextWrongName
(
  Field : integer
 ,AddressObj : RsbPartyAddress
)
  var ErrorText = "";
  if  (Field == ADDRFLD_REGION  ) ErrorText = "В адресе указано не соответствующее ФИАС наименование региона '"            + AddressObj.Region   + "'";
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "В адресе указано не соответствующее ФИАС наименование района '"             + AddressObj.Province + "'";
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "В адресе указано не соответствующее ФИАС наименование города '"             + AddressObj.District + "'";
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "В адресе указано не соответствующее ФИАС наименование населенного пункта '" + AddressObj.Place    + "'";
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "В адресе указано не соответствующее ФИАС наименование планировочной структуры '" + AddressObj.Plan    + "'";
  elif(Field == ADDRFLD_STREET  ) ErrorText = "В адресе указано не соответствующее ФИАС наименование улицы '"              + AddressObj.Street   + "'";
  elif(Field == ADDRFLD_HOUSE   ) ErrorText = "В адресе указано не соответствующее ФИАС наименование дома '"               + AddressObj.House    + "'";
  end;
  return ErrorText;
end;

private macro _GetErrorTextWrongNameLight
(
  Field : integer
 ,AddressObj : RsbPartyAddress
)
  var ErrorText = "";
  var kladrObjectLevel = _GetKladrObjectLevel(Field);
  var kladrValue = arrKladrObject(kladrObjectLevel).m_Name;
  if  (Field == ADDRFLD_REGION  ) ErrorText = "Наименование региона '"            + AddressObj.Region   + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "Наименование района '"             + AddressObj.Province + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "Наименование города '"             + AddressObj.District + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "Наименование населенного пункта '" + AddressObj.Place    + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "Наименование планировочной структуры '" + AddressObj.Plan+ "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_STREET  ) ErrorText = "Наименование улицы '"              + AddressObj.Street   + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_HOUSE   ) ErrorText = "Наименование дома '"               + AddressObj.House    + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  end;
  return ErrorText;
end;

private macro _GetErrorTextWrongType
(
  Field : integer
 ,AddressObj : RsbPartyAddress
)
  var ErrorText = "";
  if  (Field == ADDRFLD_REGION  ) ErrorText = "В адресе указан тип адресного объекта региона '"            + AddressObj.CodeRegion   + "', не соответствующий ФИАС";
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "В адресе указан тип адресного объекта района '"             + AddressObj.CodeProvince + "', не соответствующий ФИАС";
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "В адресе указан тип адресного объекта города '"             + AddressObj.CodeDistrict + "', не соответствующий ФИАС";
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "В адресе указан тип адресного объекта населенного пункта '" + AddressObj.CodePlace    + "', не соответствующий ФИАС";
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "В адресе указан тип адресного объекта планировочной структуры '" + AddressObj.CodePlan    + "', не соответствующий ФИАС";
  elif(Field == ADDRFLD_STREET  ) ErrorText = "В адресе указан тип адресного объекта улицы '"              + AddressObj.CodeStreet   + "', не соответствующий ФИАС";
  end;
  return ErrorText;
end;

private macro _GetErrorTextWrongTypeLight
(
  Field : integer
 ,AddressObj : RsbPartyAddress
)
  var ErrorText = "";
  var kladrObjectLevel = _GetKladrObjectLevel(Field);
  var kladrValue = arrKladrObject(kladrObjectLevel).m_Socr;
  if  (Field == ADDRFLD_REGION  ) ErrorText = "Тип региона '"            + AddressObj.CodeRegion   + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_PROVINCE) ErrorText = "Тип района '"             + AddressObj.CodeProvince + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_DISTRICT) ErrorText = "Тип города '"             + AddressObj.CodeDistrict + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_PLACE   ) ErrorText = "Тип населенного пункта '" + AddressObj.CodePlace    + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_PLAN    ) ErrorText = "Тип планировочной структуры '" + AddressObj.CodePlan    + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  elif(Field == ADDRFLD_STREET  ) ErrorText = "Тип улицы '"              + AddressObj.CodeStreet   + "' соответствует ФИАС, но не совпадает по написанию с ФИАС '" + kladrValue + "'";
  end;
  return ErrorText;
end;


private macro _FormErrorCorrectionReportCheckOneField
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
 ,Field : integer
 ,hErrorType : integer
)
  var FieldName : string;
  var ValueBefore : string;
  var ValueAfter : string;
  var MsgStr : string;

  if(regim == CHECK_ADDRESS_KLADR_MAC_REPORT)
    _FormErrorReportCheckAddress
      (
        PartyObj.PartyID
       ,AddressObj.AddressType
       ,ErrorData
      );
  end;

  if(regim == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
    _FormErrorReportCheckAddress
      (
        PartyObj.PartyID
       ,AddressObj.AddressType
       ,ErrorData
      );
    if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
      FieldName = _GetFieldName(ErrorData.Field);
      if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
        _CorrectAddressValue
          (
            AddressObj
           ,ErrorData
           ,@ValueBefore
           ,@ValueAfter
          );
        if  (hErrorType == hName)
          MsgStr = FieldName + ": наименование '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
        elif(hErrorType == hNameLight)
          MsgStr = FieldName + ": написание наименования '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
        elif(hErrorType == hType)
          MsgStr = FieldName + ": тип '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
        elif(hErrorType == hTypeLight)
          MsgStr = FieldName + ": написание типа '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
        end;
        _FormRowReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,_ResultRowType_Correction
           ,"Исправление"
           ,MsgStr
          );
      else
        _GetCorrectAddressValue
          (
            AddressObj
           ,ErrorData
           ,@ValueBefore
           ,@ValueAfter
          );
        if  (hErrorType == hName)
          MsgStr = FieldName + ": наименование '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
        elif(hErrorType == hNameLight)
          MsgStr = FieldName + ": написание наименования '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
        elif(hErrorType == hType)
          MsgStr = FieldName + ": тип '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
        elif(hErrorType == hTypeLight)
          MsgStr = FieldName + ": написание типа '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
        end;
        _FormRowReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,_ResultRowType_Information
           ,"Информация"
           ,MsgStr
          );
      end
    end;
  end;
end;

private macro _CheckAddressField_OneElement
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
 ,Field : integer
)
  var stat = 0;
  var SocrField = _GetSocrField(Field);
  var kladrObjectLevel = _GetKladrObjectLevel(Field);
  var CheckLight = false;
  ErrorData.CorrectValue = "";
  
  GetRegistryValue("CB\\PARTY\\КЛАДР\\ПРАВКА_РЕГИСТРА_ПРИ_ПРОВЕРКЕ", V_BOOL, CheckLight, stat);
  stat = 0;

  if((not hGetStrFlag(NotCheck, Field)) and (not hGetStrFlag(StrFlag, hNotUse)))
    if(not _IsExistsKladrLevelN(kladrObjectLevel))
      ErrorData.Text = _GetErrorTextNotExistsKladrLevel(Field);
      ErrorData.Field = Field;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      stat = 1;
    end;
    
    if((stat == 0) and hGetStrFlag(StrFlag, hCode))
      ErrorData.Text = _GetErrorTextNotFoundCode(Field, AddressObj);
      ErrorData.Field = Field;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      stat = 1;
    end;

    if((stat == 0) and hGetStrFlag(StrFlag, hDelete))
      ErrorData.Text = _GetErrorTextDeletedObject(Field, AddressObj);
      ErrorData.Field = Field;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      stat = 1;
    end;
    
    if((stat == 0) and hGetStrFlag(StrFlag, hName))
      ErrorData.Text = _GetErrorTextWrongName(Field, AddressObj);
      ErrorData.Field = Field;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = arrKladrObject(kladrObjectLevel).m_Name;
      stat = 1;

      _FormErrorCorrectionReportCheckOneField
        (
          regim
         ,regimOtherFields
         ,PartyObj
         ,AddressObj
         ,NotCheck
         ,ErrorData
         ,StrFlag
         ,Field
         ,hName
        );
    end;

    if((stat == 0) and CheckLight and hGetStrFlag(StrFlag, hNameLight))
      ErrorData.Text = _GetErrorTextWrongNameLight(Field, AddressObj);
      ErrorData.Field = Field;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = arrKladrObject(kladrObjectLevel).m_Name;
      stat = 1;

      _FormErrorCorrectionReportCheckOneField
        (
          regim
         ,regimOtherFields
         ,PartyObj
         ,AddressObj
         ,NotCheck
         ,ErrorData
         ,StrFlag
         ,Field
         ,hNameLight
        );
    end;

    if((stat == 0) and (SocrField > 0) and hGetStrFlag(StrFlag, hType))
      ErrorData.Text = _GetErrorTextWrongType(Field, AddressObj);
      ErrorData.Field = SocrField;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = arrKladrObject(kladrObjectLevel).m_Socr;
      stat = 1;

      _FormErrorCorrectionReportCheckOneField
        (
          regim
         ,regimOtherFields
         ,PartyObj
         ,AddressObj
         ,NotCheck
         ,ErrorData
         ,StrFlag
         ,SocrField
         ,hType
        );
    end;

    if((stat == 0) and CheckLight and (SocrField > 0) and hGetStrFlag(StrFlag, hTypeLight))
      ErrorData.Text = _GetErrorTextWrongTypeLight(Field, AddressObj);
      ErrorData.Field = SocrField;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = arrKladrObject(kladrObjectLevel).m_Socr;
      stat = 1;

      _FormErrorCorrectionReportCheckOneField
        (
          regim
         ,regimOtherFields
         ,PartyObj
         ,AddressObj
         ,NotCheck
         ,ErrorData
         ,StrFlag
         ,SocrField
         ,hTypeLight
        );
    end;

  end;
  return stat;
end;

private macro _CheckAddressField_Region
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  return _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_REGION
    );
end;
    
private macro _CheckAddressField_Province
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  return _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_PROVINCE
    );
end;
    
private macro _CheckAddressField_District
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  return _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_DISTRICT
    );
end;
    
private macro _CheckAddressField_Place
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  return _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_PLACE
    );
end;
    
private macro _CheckAddressField_Plan
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  return _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_PLAN
    );
end;
    
private macro _CheckAddressField_Street
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  return _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_STREET
    );
end;

private macro _PrepareDigitHouse
(
  LinkedStr : @string
 ,PrepHouse : @string
)
  var i;

  i = 0;
  while(i < strlen(LinkedStr))
    i = i + 1;
    if(   (substr(LinkedStr, i, 1) == " ")
       or (substr(LinkedStr, i, 1) == "/")
       or isalpha(substr(LinkedStr, i, 1))
      )
      i = strlen(LinkedStr);
    else
      PrepHouse = PrepHouse + substr(LinkedStr, i, 1);
    end;
  end;

  if(PrepHouse == "")
    i = 0;
    while(i < strlen(LinkedStr))
      i = i + 1;
      if(   (substr(LinkedStr, i, 1) == " ")
         or (substr(LinkedStr, i, 1) == "/")
         or ((substr(LinkedStr, i, 1) == "с") and isdigit(substr(LinkedStr, i + 1, 1)))
         or ((substr(LinkedStr, i, 1) == "к") and isdigit(substr(LinkedStr, i + 1, 1)))
         or (substr(LinkedStr, i, 3) == "кв.")
        )
        i = strlen(LinkedStr);
      else
        PrepHouse = PrepHouse + substr(LinkedStr, i, 1);
      end;
    end;
  end;

  if(PrepHouse != "")
    LinkedStr = trim(substr(LinkedStr, index(LinkedStr, PrepHouse) + strlen(PrepHouse)));
  end;
end;

private macro _PrepareDigitSlashHouse
(
  LinkedStr      : @string
 ,PrepSlashHouse : @string
)
  var i;

  if(index(LinkedStr, "/") != 0)
    LinkedStr = substr(LinkedStr, index(LinkedStr, "/") + 1);

    i = 0;
    while(i < strlen(LinkedStr))
      i = i + 1;
      if(   (substr(LinkedStr, i, 1) == " ")
         or (substr(LinkedStr, i, 1) == "/")
         or isalpha(substr(LinkedStr, i, 1))
        )
        i = strlen(LinkedStr);
      else
        PrepSlashHouse = PrepSlashHouse + substr(LinkedStr, i, 1);
      end;
    end;

    if(PrepSlashHouse == "")
      i = 0;
      while(i < strlen(LinkedStr))
        i = i + 1;
        if(   (substr(LinkedStr, i, 1) == " ")
           or (substr(LinkedStr, i, 1) == "/")
           or ((substr(LinkedStr, i, 1) == "с") and (isdigit(substr(LinkedStr, i + 1, 1)) or isalpha(substr(LinkedStr, i + 1, 1))))
           or ((substr(LinkedStr, i, 1) == "к") and (isdigit(substr(LinkedStr, i + 1, 1)) or isalpha(substr(LinkedStr, i + 1, 1))))
          )
          i = strlen(LinkedStr);
        else
          PrepSlashHouse = PrepSlashHouse + substr(LinkedStr, i, 1);
        end;
      end;
    end;
  end;

  if(PrepSlashHouse != "")
    LinkedStr = trim(substr(LinkedStr, index(LinkedStr, PrepSlashHouse) + strlen(PrepSlashHouse)));
  end;
end;

private macro _PrepareDigitCorps
(
  LinkedStr : @string
 ,PrepNumCorps : @string
)
  var i;
  var wasAlpha;
  var wasUpper;

  i = 0;
  wasAlpha = false;
  wasUpper = false;
  while(i < strlen(LinkedStr))
    i = i + 1;
    if(not wasAlpha and (i == 1))
      if(    (substr(LinkedStr, i, 1) == "к")
         and (   isalpha(substr(LinkedStr, i + 1, 1))
              or isdigit(substr(LinkedStr, i + 1, 1))
             )
        )
        wasAlpha = true;
        if(substr(LinkedStr, i, 1) == strupr("к"))
          wasUpper = true;
        end;
      end;
    elif(wasAlpha)
      if(   isdigit(substr(LinkedStr, i, 1))
         or (    isalpha(substr(LinkedStr, i, 1)) 
             and (   (wasUpper and (islower(substr(LinkedStr, i, 1)))
                     )
                  or ((not wasUpper) and (isupper(substr(LinkedStr, i, 1)))
                     )
                 )
            )
        )
        LinkedStr = trim(substr(LinkedStr, i));

        i = 0;
        wasAlpha = false;
        wasUpper = false;
        if(isalpha(substr(LinkedStr, 1, 1)))
          wasAlpha = true;
          if(isupper(substr(LinkedStr, 1, 1)))
            wasUpper = true;
          end;
        end;

        while(i < strlen(LinkedStr))
          i = i + 1;
          if(   (substr(LinkedStr, i, 1) == " ")
             or (substr(LinkedStr, i, 1) == "/")
             or ((substr(LinkedStr, i, 1) == "с") and (isdigit(substr(LinkedStr, i + 1, 1)) or isalpha(substr(LinkedStr, i + 1, 1))))
             or ((not wasAlpha) and isalpha(substr(LinkedStr, i, 1)))
             or (wasAlpha and wasUpper and islower(substr(LinkedStr, i, 1)))
             or (wasAlpha and (not wasUpper) and isupper(substr(LinkedStr, i, 1)))
            )
            i = strlen(LinkedStr);
          else
            PrepNumCorps = PrepNumCorps + substr(LinkedStr, i, 1);
          end;
        end;

        i = strlen(LinkedStr);
      end;
    else
      i = strlen(LinkedStr);
    end;
  end;

  if(PrepNumCorps != "")
    LinkedStr = trim(substr(LinkedStr, index(LinkedStr, PrepNumCorps) + strlen(PrepNumCorps)));
  end;
end;

private macro _PrepareDigitBuild
(
  LinkedStr : @string
 ,PrepNumBuild : @string
)
  var i;
  var wasAlpha;
  var wasUpper;

  i = 0;
  wasAlpha = false;
  wasUpper = false;
  while(i < strlen(LinkedStr))
    i = i + 1;
    if(not wasAlpha and (i == 1))
      if(    (substr(LinkedStr, i, 1) == "с")
         and (   isalpha(substr(LinkedStr, i + 1, 1))
              or isdigit(substr(LinkedStr, i + 1, 1))
             )
        )
        wasAlpha = true;
        if(substr(LinkedStr, i, 1) == strupr("с"))
          wasUpper = true;
        end;
      end;
    elif(wasAlpha)
      if(   isdigit(substr(LinkedStr, i, 1))
         or (    isalpha(substr(LinkedStr, i, 1)) 
             and (   (wasUpper and (islower(substr(LinkedStr, i, 1)))
                     )
                  or ((not wasUpper) and (isupper(substr(LinkedStr, i, 1)))
                     )
                 )
            )
        )
        LinkedStr = trim(substr(LinkedStr, i));

        i = 0;
        wasAlpha = false;
        wasUpper = false;
        if(isalpha(substr(LinkedStr, 1, 1)))
          wasAlpha = true;
          if(isupper(substr(LinkedStr, 1, 1)))
            wasUpper = true;
          end;
        end;

        while(i < strlen(LinkedStr))
          i = i + 1;
          if(   (substr(LinkedStr, i, 1) == " ")
             or (substr(LinkedStr, i, 1) == "/")
             or ((not wasAlpha) and isalpha(substr(LinkedStr, i, 1)))
             or (wasAlpha and wasUpper and islower(substr(LinkedStr, i, 1)))
             or (wasAlpha and (not wasUpper) and isupper(substr(LinkedStr, i, 1)))
            )
            i = strlen(LinkedStr);
          else
            PrepNumBuild = PrepNumBuild + substr(LinkedStr, i, 1);
          end;
        end;

        i = strlen(LinkedStr);
      end;
    else
      i = strlen(LinkedStr);
    end;
  end;

  if(PrepNumBuild != "")
    LinkedStr = trim(substr(LinkedStr, index(LinkedStr, PrepNumBuild) + strlen(PrepNumBuild)));
  end;
end;

private macro _PrepareAlphaHouse
(
  LinkedStr : @string
 ,PrepAlphaHouse : @string
)
  var i;
  var wasAlpha;
  var wasUpper;

  if(PrepAlphaHouse == "")
    if(not (   (substr(LinkedStr, 1, 1) == "/")
            or ((substr(LinkedStr, 1, 1) == "с") and (isdigit(substr(LinkedStr, 2, 1)) or isalpha(substr(LinkedStr, 2, 1))))
            or ((substr(LinkedStr, 1, 1) == "к") and (isdigit(substr(LinkedStr, 2, 1)) or isalpha(substr(LinkedStr, 2, 1))))
           )
      )
      
      i = 0;
      wasAlpha = false;
      wasUpper = false;
      if(isalpha(substr(LinkedStr, 1, 1)))
        wasAlpha = true;
        if(isupper(substr(LinkedStr, 1, 1)))
          wasUpper = true;
        end;
      end;

      while(i < strlen(LinkedStr))
        i = i + 1;
        if(   (substr(LinkedStr, i, 1) == " ")
           or (substr(LinkedStr, i, 1) == "/")
           or ((substr(LinkedStr, i, 1) == "с") and isdigit(substr(LinkedStr, i + 1, 1)))
           or ((substr(LinkedStr, i, 1) == "к") and isdigit(substr(LinkedStr, i + 1, 1)))
           or ((not wasAlpha) and isalpha(substr(LinkedStr, i, 1)))
           or (wasAlpha and wasUpper and islower(substr(LinkedStr, i, 1)))
           or (wasAlpha and (not wasUpper) and isupper(substr(LinkedStr, i, 1)))
          )
          i = strlen(LinkedStr);
        else
          PrepAlphaHouse = PrepAlphaHouse + substr(LinkedStr, i, 1);
        end;
      end;
    end;

    if(PrepAlphaHouse != "")
      LinkedStr = trim(substr(LinkedStr, index(LinkedStr, PrepAlphaHouse) + strlen(PrepAlphaHouse)));
    end;
  end;
end;


private macro _PrepareHouseNumCorps
(
  House : string
 ,NumCorps : string
 ,PrepDigitHouse      : @string
 ,PrepAlphaHouse      : @string
 ,PrepDigitSlashHouse : @string
 ,PrepAlphaSlashHouse : @string
 ,PrepDigitCorps      : @string
 ,PrepAlphaCorps      : @string
 ,PrepDigitBuild      : @string
 ,PrepAlphaBuild      : @string
)
  var LinkedStr = House;
  var tmpLinkedStr = "";
  var i;
  var wasAlpha;
  var wasUpper;
  
  PrepDigitHouse      = "";
  PrepAlphaHouse      = "";
  PrepDigitSlashHouse = "";
  PrepAlphaSlashHouse = "";
  PrepDigitCorps      = "";
  PrepAlphaCorps      = "";
  PrepDigitBuild      = "";
  PrepAlphaBuild      = "";

  if(trim(NumCorps) != "")
    if(strlwr(substr(trim(NumCorps), 1, 1)) != "к")
      if(islower(substr(trim(NumCorps), 1, 1)))
        LinkedStr = LinkedStr + strupr("к") + NumCorps;
      end;
      if(isupper(substr(trim(NumCorps), 1, 1)))
        LinkedStr = LinkedStr + "к" + NumCorps;
      end;
    end;
  end;

  LinkedStr = normalize_str_kladr(LinkedStr);

  _PrepareDigitHouse
    (
      @LinkedStr
     ,@PrepDigitHouse
    );
    
  _PrepareAlphaHouse
    (
      @LinkedStr
     ,@PrepAlphaHouse
    );

  _PrepareDigitSlashHouse
    (
      @LinkedStr
     ,@PrepDigitSlashHouse
    );

  _PrepareAlphaHouse
    (
      @LinkedStr
     ,@PrepAlphaSlashHouse
    );

  _PrepareDigitCorps
    (
      @LinkedStr
     ,@PrepDigitCorps
    );

  _PrepareAlphaHouse
    (
      @LinkedStr
     ,@PrepAlphaCorps
    );

  _PrepareDigitBuild
    (
      @LinkedStr
     ,@PrepDigitBuild
    );

  _PrepareAlphaHouse
    (
      @LinkedStr
     ,@PrepAlphaBuild
    );
end;

private macro _GetNextElementFromDomaName
(
  DomaStr : @string
 ,NextStr : @string
) : bool
  var IsExistsNext = false;
  var tmpDomaStr = "";
  var tmpNextStr = "";

  if(DomaStr != "")
    if(index(DomaStr, ",") != 0)
      NextStr = substr(DomaStr, 1, index(DomaStr, ",") - 1);
      DomaStr = substr(DomaStr, index(DomaStr, ",") + 1);
      IsExistsNext = true;
    else
      NextStr = DomaStr;
      DomaStr = "";
      IsExistsNext = true;
    end;
  end;

  if(not IsExistsNext)
    NextStr = "";
  end;

  return IsExistsNext;
end;

private macro _ParseDomaElement
(
  ElementStr : string
 ,IsRange : @bool
 ,IsOdd : @bool
 ,IsEven : @bool
 ,MinValue : @integer
 ,MaxValue : @integer
 ,DigitBuild : @string
 ,AlphaBuild : @string
 ,DigitCorps : @string
 ,AlphaCorps : @string
 ,DigitSlashHouse : @string
 ,AlphaSlashHouse : @string
 ,DigitHouse : @string
 ,AlphaHouse : @string
)
  var stat = 0;
  var i = 0;
  var wasAlpha = false;
  var wasUpper = false;
  var endDigit = false;
  var Element = ElementStr;
  var tmpElement = "";

  IsRange = false;
  IsOdd = false;
  IsEven = false;
  MinValue = 0;
  MaxValue = 0;
  DigitBuild = "";
  AlphaBuild = "";
  DigitCorps = "";
  AlphaCorps = "";
  DigitSlashHouse = "";
  AlphaSlashHouse = "";
  DigitHouse = "";
  AlphaHouse = "";

  if  (index(Element, "-") != 0)
    IsRange = true;
    if(substr(Element, 1, 1) == "Н")
      IsOdd = true;
    elif(substr(Element, 1, 1) == "Ч")
      IsEven = true;
    end;

    if((index(Element, "(") != 0) and (index(Element, ")") != 0))
      MinValue = int(substr(Element, index(Element, "(") + 1, index(Element, "-") - index(Element, "(") - 1));
      MaxValue = int(substr(Element, index(Element, "-") + 1, index(Element, ")") - index(Element, "-") - 1));
    else
      MinValue = int(substr(Element, 1, index(Element, "-") - 1));
      MaxValue = int(substr(Element, index(Element, "-") + 1));
    end;
    /*
    if((MaxValue == 999) or (MaxValue == 998))
      MaxValue = 0;
    end;
    */
  elif(index(Element, "_") != 0)
    IsRange = true;

    MinValue = int(substr(Element, 1, index(Element, "_") - 1));
    MaxValue = int(substr(Element, index(Element, "_") + 1));

    IsOdd = isodd(MinValue);
    IsEven = iseven(MinValue);
  else
    if(index(Element, "стр") != 0)
      tmpElement = substr(Element, index(Element, "стр") + 3);
      Element = substr(Element, 1, index(Element, "стр") - 1);
      i = 0;
      wasAlpha = false;
      wasUpper = false;
      endDigit = false;
      if(isalpha(substr(tmpElement, 1, 1)))
        wasAlpha = true;
        if(isupper(substr(tmpElement, 1, 1)))
          wasUpper = true;
        end;
      end;

      while(i < strlen(tmpElement))
        i = i + 1;
        if(not endDigit)
          if(   (substr(tmpElement, i, 1) == " ")
             or ((not wasAlpha) and isalpha(substr(tmpElement, i, 1)))
             or (wasAlpha and wasUpper and islower(substr(tmpElement, i, 1)))
             or (wasAlpha and (not wasUpper) and isupper(substr(tmpElement, i, 1)))
            )
            endDigit = true;
          else
            DigitBuild = DigitBuild + substr(tmpElement, i, 1);
          end;
        else
          if(substr(tmpElement, i, 1) == " ")
            i = strlen(tmpElement);
          else
            AlphaBuild = AlphaBuild + substr(tmpElement, i, 1);
          end;
        end;
      end;
    end;

    if(    (index(Element, "к") != 0) 
       and (   isdigit(substr(Element, index(Element, "к") + 1, 1)) 
            or isupper(substr(Element, index(Element, "к") + 1, 1)) 
           )
      )
      tmpElement = substr(Element, index(Element, "к") + 1);
      Element = substr(Element, 1, index(Element, "к") - 1);
      i = 0;
      wasAlpha = false;
      wasUpper = false;
      endDigit = false;
      if(isalpha(substr(tmpElement, 1, 1)))
        wasAlpha = true;
        if(isupper(substr(tmpElement, 1, 1)))
          wasUpper = true;
        end;
      end;

      while(i < strlen(tmpElement))
        i = i + 1;
        if(not endDigit)
          if(   (substr(tmpElement, i, 1) == " ")
             or ((not wasAlpha) and isalpha(substr(tmpElement, i, 1)))
             or (wasAlpha and wasUpper and islower(substr(tmpElement, i, 1)))
             or (wasAlpha and (not wasUpper) and isupper(substr(tmpElement, i, 1)))
            )
            endDigit = true;
          else
            DigitCorps = DigitCorps + substr(tmpElement, i, 1);
          end;
        else
          if(substr(tmpElement, i, 1) == " ")
            i = strlen(tmpElement);
          else
            AlphaCorps = AlphaCorps + substr(tmpElement, i, 1);
          end;
        end;
      end;
    end;

    if(    (index(Element, "/") != 0) 
       and (   isdigit(substr(Element, index(Element, "/") + 1, 1)) 
            or isupper(substr(Element, index(Element, "/") + 1, 1)) 
           )
      )
      tmpElement = substr(Element, index(Element, "/") + 1);
      Element = substr(Element, 1, index(Element, "/") - 1);
      i = 0;
      wasAlpha = false;
      wasUpper = false;
      endDigit = false;
      if(isalpha(substr(tmpElement, 1, 1)))
        wasAlpha = true;
        if(isupper(substr(tmpElement, 1, 1)))
          wasUpper = true;
        end;
      end;

      while(i < strlen(tmpElement))
        i = i + 1;
        if(not endDigit)
          if(   (substr(tmpElement, i, 1) == " ")
             or ((not wasAlpha) and isalpha(substr(tmpElement, i, 1)))
             or (wasAlpha and wasUpper and islower(substr(tmpElement, i, 1)))
             or (wasAlpha and (not wasUpper) and isupper(substr(tmpElement, i, 1)))
            )
            endDigit = true;
          else
            DigitSlashHouse = DigitSlashHouse + substr(tmpElement, i, 1);
          end;
        else
          if(substr(tmpElement, i, 1) == " ")
            i = strlen(tmpElement);
          else
            AlphaSlashHouse = AlphaSlashHouse + substr(tmpElement, i, 1);
          end;
        end;
      end;
    end;

    if(Element != "")
      tmpElement = Element;
      Element = "";

      i = 0;
      wasAlpha = false;
      wasUpper = false;
      endDigit = false;
      if(isalpha(substr(tmpElement, 1, 1)))
        wasAlpha = true;
        if(isupper(substr(tmpElement, 1, 1)))
          wasUpper = true;
        end;
      end;

      while(i < strlen(tmpElement))
        i = i + 1;
        if(not endDigit)
          if(   (substr(tmpElement, i, 1) == " ")
             or ((not wasAlpha) and isalpha(substr(tmpElement, i, 1)))
             or (wasAlpha and wasUpper and islower(substr(tmpElement, i, 1)))
             or (wasAlpha and (not wasUpper) and isupper(substr(tmpElement, i, 1)))
            )
            endDigit = true;
          else
            DigitHouse = DigitHouse + substr(tmpElement, i, 1);
          end;
        end;
        if(endDigit)
          if(substr(tmpElement, i, 1) == " ")
            i = strlen(tmpElement);
          else
            AlphaHouse = AlphaHouse + substr(tmpElement, i, 1);
          end;
        end;
      end;
    end;
  end;

  return stat;
end;

private macro _CompareHouseNumCorpsWithDomaName
(
  PrepDigitHouse      : string
 ,PrepAlphaHouse      : string
 ,PrepDigitSlashHouse : string
 ,PrepAlphaSlashHouse : string
 ,PrepDigitCorps      : string
 ,PrepAlphaCorps      : string
 ,PrepDigitBuild      : string
 ,PrepAlphaBuild      : string
 ,ErrorData : RsbCheckAddressError
)
  var stat = 1;
  var checked = false;
  var DomaObject : TKladrObject;
  DomaObject = arrKladrObject(lHouse);
  var DomaNameStr = CorrectHouseStr(DomaObject.m_Name);
  var NextElemStr = "";
  var IsRange : bool;
  var _IsOdd : bool;
  var _IsEven : bool;
  var MinValue : integer;
  var MaxValue : integer;
  var DigitBuild : string;
  var AlphaBuild : string;
  var DigitCorps : string;
  var AlphaCorps : string;
  var DigitSlashHouse : string;
  var AlphaSlashHouse : string;
  var DigitHouse : string;
  var AlphaHouse : string;

  var PrepMinValue : integer;
  var PrepMaxValue : integer;

  ErrorData.Text = "";

  while(    _GetNextElementFromDomaName(@DomaNameStr, @NextElemStr) 
        and (stat != 0) 
        and (ErrorData.Text == "")
       )
    _ParseDomaElement
      (
        NextElemStr
       ,@IsRange
       ,@_IsOdd
       ,@_IsEven
       ,@MinValue
       ,@MaxValue
       ,@DigitBuild
       ,@AlphaBuild
       ,@DigitCorps
       ,@AlphaCorps
       ,@DigitSlashHouse
       ,@AlphaSlashHouse
       ,@DigitHouse
       ,@AlphaHouse
      );

    if(    (PrepDigitHouse      != "")
       and (PrepDigitSlashHouse == "")
       and (PrepDigitCorps      == "")
       and (PrepDigitBuild      == "")
       and (PrepAlphaHouse      == "")
       and (PrepAlphaSlashHouse == "")
       and (PrepAlphaCorps      == "")
       and (PrepAlphaBuild      == "")
      )
      if  ((index(PrepDigitHouse, "_") != 0) and (index(NextElemStr, "_") != 0))
        PrepMinValue = int(substr(PrepDigitHouse, 1, index(PrepDigitHouse, "_") - 1));
        PrepMaxValue = int(substr(PrepDigitHouse, index(PrepDigitHouse, "_") + 1));

        if  (   (strlen(string(PrepMinValue)) != strlen(substr(PrepDigitHouse, 1, index(PrepDigitHouse, "_") - 1)))
             or (strlen(string(PrepMaxValue)) != strlen(substr(PrepDigitHouse, index(PrepDigitHouse, "_") + 1)))
            )
          ErrorData.Text = "Двойной номер дома не интерпретируется как диапазона номеров, проверка по ФИАС невозможна";

        elif(   (isodd(PrepMinValue) and iseven(PrepMaxValue))
             or (isodd(PrepMaxValue) and iseven(PrepMinValue))
            )
          ErrorData.Text = "В двойном номере дома границы диапазона номеров имеют разную чётность, проверка по ФИАС невозможна";

        elif(   (PrepMinValue < MinValue)
             or (PrepMaxValue > MaxValue)
            )
          ErrorData.Text = "Среди зарегистрированных в ФИАС домов с двойными номерами отсутствует указанный в адресе: не соответствует диапазон номеров";

        else
          stat = 0;

        end;
      
      elif(index(PrepDigitHouse, "_") == 0)
        if  (strupr(PrepDigitHouse) == strupr(DigitHouse))
          stat = 0;

        elif(strlen(string(int(PrepDigitHouse))) == strlen(PrepDigitHouse))
          if(    IsRange 
               and (MinValue <= int(PrepDigitHouse)) 
               and (int(PrepDigitHouse) <= MaxValue)
            )
            if  (_IsOdd and isodd(int(PrepDigitHouse)))
              stat = 0;
            elif(_IsEven and iseven(int(PrepDigitHouse)))
              stat = 0;
            elif((not _IsOdd) and (not _IsEven))
              stat = 0;
            end;
          end;
        end;
      end;
    else
      if(    (PrepDigitHouse      == DigitHouse     )
         and (PrepDigitSlashHouse == DigitSlashHouse)
         and (PrepDigitCorps      == DigitCorps     )
         and (PrepDigitBuild      == DigitBuild     )
         and (PrepAlphaHouse      == AlphaHouse     )
         and (PrepAlphaSlashHouse == AlphaSlashHouse)
         and (PrepAlphaCorps      == AlphaCorps     )
         and (PrepAlphaBuild      == AlphaBuild     )
        )
        stat = 0;  
      end;
    end;
  end;

  if  (    (stat != 0) 
       and (index(PrepDigitHouse, "_") != 0) 
       and (ErrorData.Text == "")
      )
    ErrorData.Text = "В ФИАС не зарегистрирован указанный в адресе дом с двойным номером";
  
  elif(    (stat != 0) 
       and (ErrorData.Text == "")
      )
    if(PrepDigitHouse != "")
      ErrorData.Text = "Дом задан неверно: в ФИАС не найдено ни одной записи, содержанию которой соответствует обозначение дома";
    else
      stat = 0;
    end;

  end;

  return stat;
end;

private macro _CheckHouseNumCorpsInDomaName
(
  House : string
 ,NumCorps : string
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  var PrepDigitHouse      : string;
  var PrepAlphaHouse      : string;
  var PrepDigitSlashHouse : string;
  var PrepAlphaSlashHouse : string;
  var PrepDigitCorps      : string;
  var PrepAlphaCorps      : string;
  var PrepDigitBuild      : string;
  var PrepAlphaBuild      : string;
  /*
  arrKladrObject(lHouse).m_Name;
  arrKladrObject(lHouse).m_Korp;
  */
  _PrepareHouseNumCorps
    (
      House
     ,NumCorps
     ,@PrepDigitHouse
     ,@PrepAlphaHouse
     ,@PrepDigitSlashHouse
     ,@PrepAlphaSlashHouse
     ,@PrepDigitCorps
     ,@PrepAlphaCorps
     ,@PrepDigitBuild
     ,@PrepAlphaBuild
    );

  stat = _CompareHouseNumCorpsWithDomaName
    (
      PrepDigitHouse
     ,PrepAlphaHouse
     ,PrepDigitSlashHouse
     ,PrepAlphaSlashHouse
     ,PrepDigitCorps
     ,PrepAlphaCorps
     ,PrepDigitBuild
     ,PrepAlphaBuild
     ,ErrorData
    );
  
  return stat;
end;

private macro _CheckAddressField_HouseKladr
(
  AddressObj : RsbPartyAddress
 ,ErrorData : RsbCheckAddressError
)
  return _CheckHouseNumCorpsInDomaName
    (
      AddressObj.House
     ,AddressObj.NumCorps
     ,ErrorData
    );
end;
    
private macro _CheckAddressField_House
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  var MsgStr;
  var FieldName;
  var ValueBefore;
  var ValueAfter;
  var stat = _CheckAddressField_OneElement
    (
      regim
     ,regimOtherFields
     ,PartyObj
     ,AddressObj
     ,NotCheck
     ,ErrorData
     ,StrFlag
     ,ADDRFLD_HOUSE
    );

  if((stat == 0) and (not hGetStrFlag(NotCheck, ADDRFLD_HOUSE)))
    stat = _CheckAddressField_HouseKladr
      (
        AddressObj
       ,ErrorData
      );
    
    if((stat != 0) and (ErrorData.Text != ""))
      ErrorData.Field = ADDRFLD_HOUSE;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;

      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
    
      _FormErrorReportCheckAddress
        (
          PartyObj.PartyID
         ,AddressObj.AddressType
         ,ErrorData
        );
      
      if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
        FieldName = _GetFieldName(ErrorData.Field);
        if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
          _CorrectAddressValue
            (
              AddressObj
             ,ErrorData
             ,@ValueBefore
             ,@ValueAfter
            );
          
          MsgStr = FieldName + ": значение '" + ValueBefore + "' заменено на '" + ValueAfter + "'";

          _FormRowReportCheckAddress
            (
              PartyObj.PartyID
             ,AddressObj.AddressType
             ,_ResultRowType_Correction
             ,"Исправление"
             ,MsgStr
            );
        else
          _GetCorrectAddressValue
            (
              AddressObj
             ,ErrorData
             ,@ValueBefore
             ,@ValueAfter
            );

          MsgStr = FieldName + ": значение '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";

          _FormRowReportCheckAddress
            (
              PartyObj.PartyID
             ,AddressObj.AddressType
             ,_ResultRowType_Information
             ,"Информация"
             ,MsgStr
            );
        end
      end;
    end;
  end;

  return stat;
end;
    
private macro _CheckAddressField_PostIndex
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  var MsgStr;
  var FieldName;
  var ValueBefore;
  var ValueAfter;
  var stat = 0;
  var i = lHouse;
  var KladrObject : TKladrObject;
  var IsOk = false;
  var ExistsAnyKladrObject = false;
  
  if(not hGetStrFlag(NotCheck, ADDRFLD_POSTINDEX))
    while((stat == 0) and (not IsOk) and (i >= lRegion))
      KladrObject = arrKladrObject(i);
      if(KladrObject != null)
        ExistsAnyKladrObject = true;
        if  (    (KladrObject.m_Index != "") 
             and (AddressObj.PostIndex != KladrObject.m_Index)
            )
          stat = 1;

          ErrorData.Text = "Почтовый индекс не соответствует ФИАС";
          ErrorData.Field = ADDRFLD_POSTINDEX;
          ErrorData.MustCorrected = false;
          if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
            ErrorData.MustCorrected = true;
          end;
          ErrorData.CheckType = CHECK_ADDRESS_KLADR;
          ErrorData.CorrectValue = KladrObject.m_Index;
          
          if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
            return stat;
          end;
          
          _FormErrorReportCheckAddress
            (
              PartyObj.PartyID
             ,AddressObj.AddressType
             ,ErrorData
            );

          if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
            FieldName = _GetFieldName(ErrorData.Field);
            if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
              _CorrectAddressValue
                (
                  AddressObj
                 ,ErrorData
                 ,@ValueBefore
                 ,@ValueAfter
                );
              
              MsgStr = FieldName + ": значение '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
      
              _FormRowReportCheckAddress
                (
                  PartyObj.PartyID
                 ,AddressObj.AddressType
                 ,_ResultRowType_Correction
                 ,"Исправление"
                 ,MsgStr
                );
            else
              _GetCorrectAddressValue
                (
                  AddressObj
                 ,ErrorData
                 ,@ValueBefore
                 ,@ValueAfter
                );
              
              MsgStr = FieldName + ": значение '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
      
              _FormRowReportCheckAddress
                (
                  PartyObj.PartyID
                 ,AddressObj.AddressType
                 ,_ResultRowType_Information
                 ,"Информация"
                 ,MsgStr
                );
            end
          end;
        
        elif(    (KladrObject.m_Index != "") 
             and (AddressObj.PostIndex != "") 
             and (AddressObj.PostIndex == KladrObject.m_Index)
            )
          IsOk = true;
        end;
      end;
      i = i - 1;
    end;

    if((not ExistsAnyKladrObject) and (AddressObj.PostIndex != ""))
      stat = 1;
      ErrorData.Text = "Почтовый индекс задан, но не может быть проверен, так как в ФИАС не найден проверяемый адрес";
      ErrorData.Field = ADDRFLD_POSTINDEX;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      
      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
      
      _FormErrorReportCheckAddress
        (
          PartyObj.PartyID
         ,AddressObj.AddressType
         ,ErrorData
        );
    end;
  
  end;

  return stat;
end;

private macro _CheckAddressField_Okato
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  var MsgStr;
  var FieldName;
  var ValueBefore;
  var ValueAfter;
  var stat = 0;
  var i = lHouse;
  var KladrObject : TKladrObject;
  var IsOk = false;
  var ExistsAnyKladrObject = false;
  
  if(not hGetStrFlag(NotCheck, ADDRFLD_OKATO))
    while((stat == 0) and (not IsOk) and (i >= lRegion))
      KladrObject = arrKladrObject(i);
      if(KladrObject != null)
        ExistsAnyKladrObject = true;
        if  (    (KladrObject.m_Okato != "") 
             and (AddressObj.Okato != KladrObject.m_Okato)
            )
          stat = 1;

          ErrorData.Text = "Код ОКАТО не соответствует ФИАС";
          ErrorData.Field = ADDRFLD_OKATO;
          ErrorData.MustCorrected = false;
          if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
            ErrorData.MustCorrected = true;
          end;
          ErrorData.CheckType = CHECK_ADDRESS_KLADR;
          ErrorData.CorrectValue = KladrObject.m_Okato;
          
          if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
            return stat;
          end;
          
          _FormErrorReportCheckAddress
            (
              PartyObj.PartyID
             ,AddressObj.AddressType
             ,ErrorData
            );

          if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
            FieldName = _GetFieldName(ErrorData.Field);
            if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
              _CorrectAddressValue
                (
                  AddressObj
                 ,ErrorData
                 ,@ValueBefore
                 ,@ValueAfter
                );
              
              MsgStr = FieldName + ": значение '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
      
              _FormRowReportCheckAddress
                (
                  PartyObj.PartyID
                 ,AddressObj.AddressType
                 ,_ResultRowType_Correction
                 ,"Исправление"
                 ,MsgStr
                );
            else
              _GetCorrectAddressValue
                (
                  AddressObj
                 ,ErrorData
                 ,@ValueBefore
                 ,@ValueAfter
                );
              
              MsgStr = FieldName + ": значение '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
      
              _FormRowReportCheckAddress
                (
                  PartyObj.PartyID
                 ,AddressObj.AddressType
                 ,_ResultRowType_Information
                 ,"Информация"
                 ,MsgStr
                );
            end
          end;
        
        elif(    (KladrObject.m_Okato != "") 
             and (AddressObj.Okato != "") 
             and (AddressObj.Okato == KladrObject.m_Okato)
            )
          IsOk = true;
        end;
      end;
      i = i - 1;
    end;

    if((not ExistsAnyKladrObject) and (AddressObj.Okato != ""))
      stat = 1;
      ErrorData.Text = "Код ОКАТО задан, но не может быть проверен, так как в ФИАС не найден проверяемый адрес";
      ErrorData.Field = ADDRFLD_OKATO;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      
      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
      
      _FormErrorReportCheckAddress
        (
          PartyObj.PartyID
         ,AddressObj.AddressType
         ,ErrorData
        );
    end;

  end;

  return stat;
end;

private macro _CheckAddressField_Oktmo
(
  regim : integer
 ,regimOtherFields : integer
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
 ,StrFlag : string
)
  var MsgStr;
  var FieldName;
  var ValueBefore;
  var ValueAfter;
  var stat = 0;
  var i = lHouse;
  var KladrObject : TKladrObject;
  var IsOk = false;
  var ExistsAnyKladrObject = false;
  
  if(not hGetStrFlag(NotCheck, ADDRFLD_OKTMO))
    while((stat == 0) and (not IsOk) and (i >= lRegion))
      KladrObject = arrKladrObject(i);
      if(KladrObject != null)
        ExistsAnyKladrObject = true;
        if  (    (KladrObject.m_Oktmo != "") 
             and (AddressObj.Oktmo != KladrObject.m_Oktmo)
            )
          stat = 1;

          ErrorData.Text = "Код ОКТМО не соответствует ФИАС";
          ErrorData.Field = ADDRFLD_OKTMO;
          ErrorData.MustCorrected = false;
          if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
            ErrorData.MustCorrected = true;
          end;
          ErrorData.CheckType = CHECK_ADDRESS_KLADR;
          ErrorData.CorrectValue = KladrObject.m_Oktmo;
          
          if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
            return stat;
          end;
          
          _FormErrorReportCheckAddress
            (
              PartyObj.PartyID
             ,AddressObj.AddressType
             ,ErrorData
            );

          if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
            FieldName = _GetFieldName(ErrorData.Field);
            if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
              _CorrectAddressValue
                (
                  AddressObj
                 ,ErrorData
                 ,@ValueBefore
                 ,@ValueAfter
                );
              
              MsgStr = FieldName + ": значение '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
      
              _FormRowReportCheckAddress
                (
                  PartyObj.PartyID
                 ,AddressObj.AddressType
                 ,_ResultRowType_Correction
                 ,"Исправление"
                 ,MsgStr
                );
            else
              _GetCorrectAddressValue
                (
                  AddressObj
                 ,ErrorData
                 ,@ValueBefore
                 ,@ValueAfter
                );
              
              MsgStr = FieldName + ": значение '" + ValueBefore + "' не заменено на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
      
              _FormRowReportCheckAddress
                (
                  PartyObj.PartyID
                 ,AddressObj.AddressType
                 ,_ResultRowType_Information
                 ,"Информация"
                 ,MsgStr
                );
            end
          end;
        
        elif(    (KladrObject.m_Oktmo != "") 
             and (AddressObj.Oktmo != "") 
             and (AddressObj.Oktmo == KladrObject.m_Oktmo)
            )
          IsOk = true;
        end;
      end;
      i = i - 1;
    end;

    if((not ExistsAnyKladrObject) and (AddressObj.Oktmo != ""))
      stat = 1;
      ErrorData.Text = "Код ОКТМО задан, но не может быть проверен, так как в ФИАС не найден проверяемый адрес";
      ErrorData.Field = ADDRFLD_OKTMO;
      ErrorData.MustCorrected = false;
      if(regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY)
        ErrorData.MustCorrected = true;
      end;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      
      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
      
      _FormErrorReportCheckAddress
        (
          PartyObj.PartyID
         ,AddressObj.AddressType
         ,ErrorData
        );
    end;

  end;

  return stat;
end;

private macro _CheckAddressKladr
(
  regim : integer
 ,regimOtherFields : integer
 ,regimAddressFields : integer
 ,SavePrevAdr : bool
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  var ValueBefore, ValueAfter, FieldName;
  var MsgStr;
  var RegionFlag   : string;
  var ProvinceFlag : string;
  var DistrictFlag : string;
  var PlaceFlag    : string;
  var PlanFlag     : string;
  var StreetFlag   : string;
  var HouseFlag    : string;
  var OldCode      : string;
  var OldLevel     : integer;
  var NewCode      : string;
  var NewLevel     : integer;
  var RepeatCheck  : integer;
  var SaveKladr    : string;

  SaveKladr = AddressObj.Fias;
  /*
  msgbox
  (
    "CheckAddressKladr:"
   ,"|regim=", regim
   ,"|regimOtherFields=", regimOtherFields
   ,"|regimAddressFields=", regimAddressFields
   ,"|SavePrevAdr=", SavePrevAdr
   ,"|PartyObj=", PartyObj
   ,"|AddressObj=", AddressObj
   ,"|NotCheck=", NotCheck
   ,"|ErrorData=", ErrorData
  );
  */
  if(regimOtherFields != CHECK_ADDRESS_KLADR_MAC_NOTCHECK)
    /*выполнить проверку на спецсимволы*/
    stat = _CheckAddressSpecSymb
      (
        AddressObj
       ,ErrorData
      );
    if(stat != 0)
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;

      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
    
      if(regim == CHECK_ADDRESS_KLADR_MAC_REPORT)
        _FormErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,ErrorData
          );
      end;

      if(regim == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
        _FormErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,ErrorData
          );
        if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
          if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
            FieldName = _GetFieldName(ErrorData.Field);
            _CorrectAddressSpecSymb
              (
                AddressObj
               ,ErrorData
               ,@ValueBefore
               ,@ValueAfter
              );
            MsgStr = FieldName + ": значение '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
            _FormRowReportCheckAddress
              (
                PartyObj.PartyID
               ,AddressObj.AddressType
               ,_ResultRowType_Correction
               ,"Исправление"
               ,MsgStr
              );
          else
            _FormRowReportCheckAddress
              (
                PartyObj.PartyID
               ,AddressObj.AddressType
               ,_ResultRowType_Information
               ,"Информация"
               ,"Исправление для вида адресов не разрешено"
              );
          end
        end;
      end;
    end;

    stat = 0;
    if(AddressObj.Country == "")
      stat = 1;

      ErrorData.Text = "Не указана страна. Проверить адрес по ФИАС невозможно, проверка прервана";
      ErrorData.Field = ADDRFLD_COUNTRY;
      ErrorData.MustCorrected = true;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
  
      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
      
      _FormErrorReportCheckAddress
        (
          PartyObj.PartyID
         ,AddressObj.AddressType
         ,ErrorData
        );
      return stat;
    end;

    if(AddressObj.Country != "RUS")
      if((regim == CHECK_ADDRESS_KLADR_MAC_REPORT) or (regim == CHECK_ADDRESS_KLADR_MAC_CORRECTION))
        _FormRowReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,_ResultRowType_Information
           ,"Информация"
           ,"Адрес не является российским, проверка по ФИАС не выполняется"
          );
      end;
    end;
  
    if(AddressObj.Territory == "")
      stat = 1;

      ErrorData.Text = "Не указана территория";
      ErrorData.Field = ADDRFLD_TERRITORY;
      ErrorData.MustCorrected = true;
      ErrorData.CheckType = CHECK_ADDRESS_KLADR;
      ErrorData.CorrectValue = "00";
  
      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;
      
      if(regim == CHECK_ADDRESS_KLADR_MAC_REPORT)
        _FormErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,ErrorData
          );
      end;
  
      if(regim == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
        _FormErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,ErrorData
          );
        if(regimOtherFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
          if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
            FieldName = _GetFieldName(ErrorData.Field);
            _CorrectAddressValue
              (
                AddressObj
               ,ErrorData
               ,@ValueBefore
               ,@ValueAfter
              );
            MsgStr = FieldName + ": значение '" + ValueBefore + "' заменено на '" + ValueAfter + "'";
            _FormRowReportCheckAddress
              (
                PartyObj.PartyID
               ,AddressObj.AddressType
               ,_ResultRowType_Correction
               ,"Исправление"
               ,MsgStr
              );
          else
            _FormRowReportCheckAddress
              (
                PartyObj.PartyID
               ,AddressObj.AddressType
               ,_ResultRowType_Information
               ,"Информация"
               ,"Исправление для вида адресов не разрешено"
              );
          end
        end;
      end;
    end;
  
    stat = 0;
    RepeatCheck = 1;
    while((AddressObj.Country == "RUS") and (RepeatCheck > 0))
      RepeatCheck = RepeatCheck - 1;
      /*выполнить быструю проверку*/
      stat = _QuickCheckAddressKladr
        (
          @RegionFlag
         ,@ProvinceFlag
         ,@DistrictFlag
         ,@PlaceFlag
         ,@PlanFlag
         ,@StreetFlag
         ,@HouseFlag
         ,AddressObj
        );
      /*
      msgbox
        ("Flags:"
        ,"|RegionFlag  =", RegionFlag  
        ,"|ProvinceFlag=", ProvinceFlag
        ,"|DistrictFlag=", DistrictFlag
        ,"|PlaceFlag   =", PlaceFlag   
        ,"|StreetFlag  =", StreetFlag  
        ,"|HouseFlag   =", HouseFlag
        );
      */
      if(    (stat == 0)
         and (index(RegionFlag  , "X") == 0)
         and (index(ProvinceFlag, "X") == 0)
         and (index(DistrictFlag, "X") == 0)
         and (index(PlaceFlag   , "X") == 0)
         and (index(PlanFlag    , "X") == 0)
         and (index(StreetFlag  , "X") == 0)
         and (index(HouseFlag   , "X") == 0)
        )
        _FormNoErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
          );
  
        return stat;
      end;
    end;

    if(AddressObj.Country == "RUS")
      if(AddressObj.Fias == "")
        ErrorData.Text = "Не заполнен код ФИАС";
        ErrorData.Field = ADDRFLD_FIAS;
        ErrorData.MustCorrected = true;
        ErrorData.CheckType = CHECK_ADDRESS_KLADR;
        stat = 1;
    
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Region
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,RegionFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Province
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,ProvinceFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_District
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,DistrictFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Place
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,PlaceFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Plan
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,PlanFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Street
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,StreetFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_House
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,HouseFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_PostIndex
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,HouseFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Okato
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,HouseFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;

      stat = _CheckAddressField_Oktmo
        (
           regim
          ,regimOtherFields
          ,PartyObj
          ,AddressObj
          ,NotCheck
          ,ErrorData
          ,HouseFlag
        );
      if(stat != 0)
        if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
          return stat;
        end;
      end;
    end;
  end;

  stat = 0;
  if(regimAddressFields != CHECK_ADDRESS_KLADR_MAC_NOTCHECK)
    /*Проверка поля <Адрес> на соответствие ФИАС*/

    if(not hGetStrFlag(NotCheck, ADDRFLD_ADDRESS))
      stat = _CheckAddressField_Address
        (
          regim
         ,regimAddressFields
         ,PartyObj
         ,AddressObj
         ,ErrorData
         ,NotCheck
        );
    end;

    if(stat != 0)
      if((regim == CHECK_ADDRESS_KLADR_MAC_MANDATORY) or (regim == CHECK_ADDRESS_KLADR_MAC_INFORMATIVE))
        return stat;
      end;

      if(regim == CHECK_ADDRESS_KLADR_MAC_REPORT)
        _FormErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,ErrorData
          );
      end;

      if(regim == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
        _FormErrorReportCheckAddress
          (
            PartyObj.PartyID
           ,AddressObj.AddressType
           ,ErrorData
          );
        if(regimAddressFields == CHECK_ADDRESS_KLADR_MAC_CORRECTION)
          FieldName = _GetFieldName(ErrorData.Field);
          if(_IsAdrTypeAutoEdit(AddressObj.AddressType))
            _CorrectAddressValue
              (
                AddressObj
               ,ErrorData
               ,@ValueBefore
               ,@ValueAfter
              );
            
            MsgStr = FieldName + ": '" + ValueBefore + "' заменен на '" + ValueAfter + "'";
            
            _FormRowReportCheckAddress
              (
                PartyObj.PartyID
               ,AddressObj.AddressType
               ,_ResultRowType_AddrCorrection
               ,"Исправление"
               ,MsgStr
              );
          else
            _GetCorrectAddressValue
              (
                AddressObj
               ,ErrorData
               ,@ValueBefore
               ,@ValueAfter
              );
            
            MsgStr = FieldName + ": '" + ValueBefore + "' не заменен на '" + ValueAfter + "', так как это запрещено для вида проверяемого адреса";
    
            _FormRowReportCheckAddress
              (
                PartyObj.PartyID
               ,AddressObj.AddressType
               ,_ResultRowType_Information
               ,"Информация"
               ,MsgStr
              );
          end;
        end;
      end;
    end;
  end;

  _FormNoErrorReportCheckAddress
    (
      PartyObj.PartyID
     ,AddressObj.AddressType
    );

  return stat;
end;

macro CheckAddressKladr
(
  regim : integer
 ,regimOtherFields : integer
 ,regimAddressFields : integer
 ,SavePrevAdr : bool
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  return _CheckAddressKladr
    (
      regim
     ,regimOtherFields
     ,regimAddressFields
     ,SavePrevAdr
     ,PartyObj
     ,AddressObj
     ,@NotCheck
     ,ErrorData
    );
end;

private macro _ShowDialogResultCheckAddress
(
  AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  var i = 0;
  var j = 0;
  var FieldName = _GetFieldName(ErrorData.Field);
  Array Text;
  Array Button;
  var choice;
  var ValueBefore : string;
  var ValueAfter : string;

  Button(j) = "   Прервать   ";
  j = j + 1;

  Text(i) = "Ошибка заполнения адреса";
  i = i + 1;
  Text(i) = "";
  i = i + 1;
  Text(i) = ErrorData.Text;
  i = i + 1;
  Text(i) = "";
  i = i + 1;
  if(FieldName != "")
    Text(i) = "Поле: " + FieldName;
    i = i + 1;
  end;
  Text(i) = "";
  i = i + 1;
  if(ErrorData.CorrectValue != "")
    Text(i) = "Исправить: " + ErrorData.CorrectValue;
    i = i + 1;
    Text(i) = "";
    i = i + 1;

    Button(j) = "  Исправить   ";
    j = j + 1;
  end;

  if(not ErrorData.MustCorrected)
    Button(j) = "  Пропустить  ";
    j = j + 1;
  end;

  choice = ConfWin(Text, Button);

  if  (choice == 0)
    stat = 1;
  elif((choice == 1) and (ErrorData.CorrectValue != ""))
    _CorrectAddressValue
      (
        AddressObj
       ,ErrorData
       ,@ValueBefore
       ,@ValueAfter
      );
    ErrorData.CorrectValue = "";
    stat = 0;
  elif((choice == 2) or ((choice == 1) and (not ErrorData.MustCorrected)))
    hSetStrFlag(@NotCheck, ErrorData.Field, true);
    ErrorData.CorrectValue = "";
    stat = 0;
  end;

  return stat;
end;

macro InteractiveCheckAddressKladr
(
  regim : integer
 ,regimOtherFields : integer
 ,regimAddressFields : integer
 ,SavePrevAdr : bool
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  
  while(stat == 0)
    stat = _CheckAddressKladr
      (
        regim
       ,regimOtherFields
       ,regimAddressFields
       ,SavePrevAdr
       ,PartyObj
       ,AddressObj
       ,@NotCheck
       ,ErrorData
      );
    if(stat != 0)
      stat = _ShowDialogResultCheckAddress
        (
          AddressObj
         ,@NotCheck
         ,ErrorData
        );
    else
      msgbox("Проверка успешна");
      return stat;  
    end;
  end;

  return stat;
end;

macro AutomaticCheckAddressKladr
(
  regim : integer
 ,regimOtherFields : integer
 ,regimAddressFields : integer
 ,SavePrevAdr : bool
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  
  while(stat == 0)
    stat = _CheckAddressKladr
      (
        regim
       ,regimOtherFields
       ,regimAddressFields
       ,SavePrevAdr
       ,PartyObj
       ,AddressObj
       ,@NotCheck
       ,ErrorData
      );
    if(stat != 0)
      stat = _ShowDialogResultCheckAddress
        (
          AddressObj
         ,@NotCheck
         ,ErrorData
        );
    else
      return stat;  
    end;
  end;

  return stat;
end;

private macro _GetKladrObject
(
  Fias : string
 ,KladrObject : TKladrObject
)
  var stat = 1;

  var query = "";
  var rs;
  var params : TArray;

  var queryH = "";
  var rsH;
  var paramsH : TArray;

  var queryO = "";
  var rsO;
  var paramsO : TArray;
  var ParentGuid = "";

  var Code = "";
  var AOGuid = "";
  var AOLevel = 1;

  if  (strlen(Fias) == 23)
    Code = Fias;

    if(substr(Code, 3, 3) != "000")
      AOLevel = 3;
    end;
    if(substr(Code, 6, 3) != "000")
      AOLevel = 4;
    end;
    if(substr(Code, 9, 3) != "000")
      AOLevel = 6;
    end;
    if(substr(Code, 12, 4) != "0000")
      AOLevel = 65;
    end;
    if(substr(Code, 16, 4) != "0000")
      AOLevel = 7;
    end;

    query = query + "SELECT ";
    query = query + "  t_FormalName ";
    query = query + " ,t_ShortName ";
    query = query + " ,t_RegionCode || t_AreaCode || t_CityCode || t_PlaceCode || t_PlanCode || t_StreetCode || '0000' AS t_Code ";
    query = query + " ,t_PostalCode ";
    query = query + " ,t_Okato ";
    query = query + " ,t_ActStatus ";
    query = query + " ,t_Oktmo ";
    query = query + " ,t_AOGuid ";
    query = query + " ,t_ParentGuid ";
    query = query + "  FROM das_addrobj_dbt ";
    query = query + " WHERE t_AOLevel = :AOLevel ";
    query = query + "   AND t_RegionCode = :RegionCode ";
    query = query + "   AND t_AreaCode = :AreaCode ";
    query = query + "   AND t_CityCode = :CityCode ";
    query = query + "   AND t_PlaceCode = :PlaceCode ";
    query = query + "   AND t_PlanCode = :PlanCode ";
    query = query + "   AND t_StreetCode = :StreetCode ";
    query = query + "   AND t_NextID = :NextID ";
    
    params = makeArray(SQLParam("AOLevel", AOLevel),
                       SQLParam("RegionCode", substr(Code, 1, 2)),
                       SQLParam("AreaCode", substr(Code, 3, 3)),
                       SQLParam("CityCode", substr(Code, 6, 3)),
                       SQLParam("PlaceCode", substr(Code, 9, 3)),
                       SQLParam("PlanCode", substr(Code, 12, 4)),
                       SQLParam("StreetCode", substr(Code, 16, 4)),
                       SQLParam("NextID", "")
                      );

    rs = execSQLselect(query, params, true);
    if(rs and rs.moveNext())
      if(substr(Fias, 20, 4) == "0000")
        _InitKladrObjectByKladrRs(KladrObject, rs);
        ParentGuid = rs.value(8);
        stat = 0;
        if((stat == 0) and (KladrObject.m_Okato == ""))
          queryO = queryO + "SELECT ";
          queryO = queryO + "  t_Okato ";
          queryO = queryO + "  FROM das_addrobj_dbt ";
          queryO = queryO + " WHERE t_AOGuid = :ParentGuid ";
          queryO = queryO + "   AND t_NextID = :NextID ";

          paramsO = makeArray(SQLParam("ParentGuid", ParentGuid),
                              SQLParam("NextID", "")
                             );

          rsO = execSQLselect(queryO, paramsO, true);
          if(rsO and rsO.moveNext())
            KladrObject.m_Okato = rsO.value(0);
          end;
        end;
      else
        AOGuid = rs.value(7);

        queryH = queryH + "SELECT ";
        queryH = queryH + "  t_HouseNum ";
        queryH = queryH + " ,:Code ";
        queryH = queryH + " ,t_PostalCode ";
        queryH = queryH + " ,t_Okato ";
        queryH = queryH + " ,t_BuildNum ";
        queryH = queryH + " ,t_StrucNum ";
        queryH = queryH + " ,t_Oktmo ";
        queryH = queryH + "  FROM das_house_dbt ";
        queryH = queryH + " WHERE t_AOGuid = :AOGuid ";
        queryH = queryH + "   AND TRIM(TO_CHAR(t_Counter, '0000')) = :Counter ";
        queryH = queryH + " ORDER BY t_EndDate DESC ";
        
        paramsH = makeArray(SQLParam("Code", Code),
                            SQLParam("AOGuid", AOGuid),
                            SQLParam("Counter", substr(Code, 20, 4))
                           );
        
        rsH = execSQLselect(queryH, paramsH, true);
        if(rsH and rsH.moveNext())
          _InitKladrObjectByDomaRs(KladrObject, rsH);
          stat = 0;
        end;                         
      end;
    end;                         
  end;

  return stat;
end;

private macro _FormalCheckAddressKladr
(
  PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  var RegAdresKladr = false;
  var RegKladr = false;
  var RegOkato = false;
  var KladrObject = TKladrObject();
  record AddressRec(adress);

  GetRegistryValue("CB\\PARTY\\КЛАДР\\АДРЕС КЛАДР", V_BOOL, RegAdresKladr, stat);
  if(stat != 0)
    RegAdresKladr = false;
  end;
  GetRegistryValue("CB\\PARTY\\КЛАДР\\КЛАДР", V_BOOL, RegKladr, stat);
  if(stat != 0 )
    RegKladr = false;
  end; 
  GetRegistryValue("CB\\PARTY\\КЛАДР\\СВЕРКА ОКАТО", V_BOOL, RegOkato, stat);
  if(stat != 0 )
    RegOkato = false;
  end; 
  stat = 0; 
  
  stat = _CheckAddressSpecSymb
    (
      AddressObj
     ,ErrorData
    );
  if((stat == 0) and _IsAdrTypeControl(AddressObj.AddressType))
    _SetAddressObjToRec
      (
        AddressObj
       ,AddressRec
      );
    if(Index(NotCheck, "X") == 0)
      stat = ExecMacroFile("party.mac", "ПроверитьАдресСубъекта", AddressRec);
      if(stat == 1)
        ErrorData.Text = "Ошибка при проверке адреса пользовательской функцией";
        ErrorData.MustCorrected = true;
      end;
    end;
  end;

  if((stat == 0) and (AddressObj.Country == ""))
    stat = 1;
    ErrorData.Text = "Не указана страна";
    ErrorData.Field = ADDRFLD_COUNTRY;
    ErrorData.MustCorrected = true;
  end;

  if((stat == 0) and (AddressObj.Territory == ""))
    stat = 1;
    ErrorData.Text = "Не указана территория";
    ErrorData.Field = ADDRFLD_TERRITORY;
    ErrorData.MustCorrected = true;
  end;

  if((stat == 0) and (AddressObj.Country == "RUS"))
    if((stat == 0) and (not hGetStrFlag(NotCheck, ADDRFLD_POSTINDEX)) and (AddressObj.PostIndex == ""))
      stat = 1;
      ErrorData.Text = "Не указан индекс";
      ErrorData.Field = ADDRFLD_POSTINDEX;
      ErrorData.MustCorrected = false;
    end;

    if((stat == 0) and (not hGetStrFlag(NotCheck, ADDRFLD_REGION)) and (AddressObj.Region == ""))
      stat = 1;
      ErrorData.Text = "Не указан регион";
      ErrorData.Field = ADDRFLD_REGION;
      ErrorData.MustCorrected = false;
    end;

    if((stat == 0) and RegKladr)
      if(    (stat == 0) 
         and (not hGetStrFlag(NotCheck, ADDRFLD_KLADR)) 
         and (AddressObj.Fias == "")
        )
        stat = 1;
        ErrorData.Text = "Не заполнен код ФИАС";
        ErrorData.Field = ADDRFLD_FIAS;
        if(RegAdresKladr)
          ErrorData.MustCorrected = true;
        else
          ErrorData.MustCorrected = false;
        end;
      end;

      if((stat == 0) and (AddressObj.Fias != ""))
        stat = _GetKladrObject
          (
            AddressObj.Fias
           ,KladrObject
          );
        if(stat != 0)
          ErrorData.Text = "Код ФИАС не найден в справочнике ФИАС";
          ErrorData.Field = ADDRFLD_KLADR;
          ErrorData.MustCorrected = true;
        end;
      end;

      if(    (stat == 0) 
         and (RegKladr) and (RegOkato) 
         and (AddressObj.Okato != "") 
         and (not hGetStrFlag(NotCheck, ADDRFLD_OKATO)) 
         and (AddressObj.Okato != KladrObject.m_Okato)
        )
        stat = 1;
        ErrorData.Text = "Код ОКАТО не соответствует коду ФИАС";
        ErrorData.Field = ADDRFLD_OKATO;
        ErrorData.MustCorrected = false;
      end;

      if(    (stat == 0) 
         and (RegKladr) and (RegOkato) 
         and (AddressObj.Oktmo != "") 
         and (not hGetStrFlag(NotCheck, ADDRFLD_OKTMO)) 
         and (AddressObj.Oktmo != KladrObject.m_Oktmo)
        )
        stat = 1;
        ErrorData.Text = "Код ОКТМО не соответствует коду ФИАС";
        ErrorData.Field = ADDRFLD_OKTMO;
        ErrorData.MustCorrected = false;
      end;
    end;
  end;

  if(stat != 0)
    ErrorData.CheckType = CHECK_ADDRESS_FORMAL;
  end;

  return stat;
end;

macro FormalCheckAddressKladr
(
  regim : integer
 ,regimOtherFields : integer
 ,regimAddressFields : integer
 ,SavePrevAdr : bool
 ,PartyObj : RsbParty
 ,AddressObj : RsbPartyAddress
 ,NotCheck : @string /* массив признаков в виде строки */
 ,ErrorData : RsbCheckAddressError
)
  var stat = 0;
  
  while(stat == 0)
    stat = _FormalCheckAddressKladr
      (
        PartyObj
       ,AddressObj
       ,@NotCheck
       ,ErrorData
      );
    if(stat != 0)
      stat = _ShowDialogResultCheckAddress
        (
          AddressObj
         ,@NotCheck
         ,ErrorData
        );
    else
      return stat;  
    end;
  end;

  return stat;
end;


