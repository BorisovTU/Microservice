/*
 $Name: moex_client.mac
 $Module: ядро
 $Description: клиент для публикации сообщений в очередь
 */

import rcw;

class AMQPMOEXClient(host:String, vhost:String, user:String, password:String, port:Integer, queue:String)
   private var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   private var IsConnect = false;
   private var client = jvm.createJavaObject("ru.softlab.rsbank.amqp.rabbitmq.AMQPPublisher", "<init>");

   macro publish(clientCode:String, contractNum:String, subContractNum:String, body:String)
     client.publishRegClientMessage(clientCode, contractNum, subContractNum, body);
   end;

   macro publishInStatus(clientCode:String, contractNum:String, subContractNum:String, status:Integer, body:String)
     client.publishRegClientMessageInStatus(clientCode, contractNum, subContractNum, body, status);
   end;

   macro init(host:String, vhost:String, user:String, password:String, port:Integer, queue:String)
     client.connect(host, vhost, user, password, port, queue);
     IsConnect = true;
   end;

   macro Destructor()
     if(IsConnect)
       client.disconnect();
     end;
   end;

   init(host, vhost, user, password, port, queue);
end;

// пример использования
// подключение к очереди bank_to_moex
//var client = AMQPMOEXClient("172.16.1.100", "test", "admin", "admin", 5672, "bank_to_moex");
// поместить в очередь сообщение <test></test>
//client.publish("33", "44", "55", "<test></test>");
//client.publishInStatus("33", "44", "55", 200, "<test></test>");