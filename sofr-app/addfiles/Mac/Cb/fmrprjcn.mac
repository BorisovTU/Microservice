/*
 $Name: fmrprjcn.mac
 $Module: Ядро ГКБО 
 $Description: ФМ.4077-У: Рекомендации по расторжению договора счета 
 */

import BankInter;
import cb_sql, rsd, globals, commonutil, likepy, oralib;

private var prevClientID;
private var countOO;
private var countOD;

private macro _AddQueryStr(params, i, FromDate, TillDate, ClientID, Rejects, Uploaded, ExcludeRJCN, IncludeRJCN)
  var query = "";


query = query + "SELECT CLNT.T_PARTYID AS tClientID, PT.T_NAME, MSG.T_MSGKIND, 'ОО' AS MSGKINDNAME, OPR.T_REJECTDATE AS tDate, DECODE(TRIM('0' FROM SUBSTR(OPR.T_RECNUMBER, LENGTH(OPR.T_RECNUMBER)-9)), '??????????', '?', chr(1),'-',TRIM('0' FROM SUBSTR(OPR.T_RECNUMBER, LENGTH(OPR.T_RECNUMBER)-9))) AS tNumb, ";
query = query + " PTOPER.T_ACCOUNTNUMBER,  ";
query = query + " DECODE(DPRT.T_SOURCEDPRT, 0, MSG.T_SOURCEDPRT, DPRT.T_SOURCEDPRT) AS SOURCEDPRT, (SELECT T_NAME FROM DDP_DEP_DBT WHERE T_CODE = DECODE(DPRT.T_SOURCEDPRT, 0, MSG.T_SOURCEDPRT, DPRT.T_SOURCEDPRT) ) AS NAMEDPRT ,  ";
query = query + " MSG.T_MSGSTATE, DECODE(MSG.T_MSGSTATE, 1, 'на контроль', 2, 'на визирование', 3, 'отложено', 4, 'на выгрузку', 5, 'выгружено', 6, 'отвергнуто', chr(1)) AS STATUSNAME, ";
query = query + "NVL(DECODE(OPR.T_OPERATIONINFO,CHR(1), NULL, OPR.T_OPERATIONINFO) || DECODE(OPR.T_ADDINFO,CHR(1),NULL, OPR.T_ADDINFO),chr(1)) AS ADDINFO ";
query = query + "FROM DFMRJSRVMSG_DBT MSG, DFMRJSRVMSGIDPRT_DBT DPRT, DFMRJCNCLCARRYOPER_DBT OPR, DFMRJSRVPTOPER_DBT PTOPER,DFMRJSRVCLNT_DBT CLNT, DPARTY_DBT PT  ";
query = query + "WHERE MSG.T_ID = DPRT.T_RJSRVMSGID ";
query = query + "  AND DPRT.T_ID = OPR.T_RJSRVMSGIDPRTID ";
query = query + "  AND OPR.T_ID = PTOPER.T_RJCNCLCARRYOPERID ";
query = query + "  AND PTOPER.T_RJSRVCLNTID = CLNT.T_ID ";

  if(ClientID > 0)
query = query + "  AND CLNT.T_PARTYID = :PartyID ";
    params.value(i) = SQLParam("PartyID", ClientID);
    i = i + 1;
  end;

query = query + "  AND MSG.T_MSGKIND = 2 /* RJSRVMSG_MSGKIND_REJ_OPER*/  ";
query = query + "  AND MSG.T_MSGSTATE = 5 /* RJSRVMSG_STATUS_UNLOADED */ ";

query = query + "  AND OPR.T_REJECTDATE BETWEEN :FromRJDate1 AND :TillRJDate1  ";

  params.value(i) = SQLParam("FromRJDate1", FromDate);
  i = i + 1;
  params.value(i) = SQLParam("TillRJDate1", TillDate);
  i = i + 1;

query = query + "  AND PT.T_PARTYID = CLNT.T_PARTYID ";
  if(Rejects > 1)
query = query + "  AND ( SELECT count(DISTINCT (OPR2.T_ID)) ";
query = query + "         FROM DFMRJSRVMSG_DBT MSG2, DFMRJSRVMSGIDPRT_DBT DPRT2,DFMRJCNCLCARRYOPER_DBT OPR2, DFMRJSRVPTOPER_DBT PTOPER2,DFMRJSRVCLNT_DBT CLNT2  ";
query = query + "        WHERE MSG2.T_ID = DPRT2.T_RJSRVMSGID ";
query = query + "          AND DPRT2.T_ID = OPR2.T_RJSRVMSGIDPRTID ";
query = query + "          AND OPR2.T_ID = PTOPER2.T_RJCNCLCARRYOPERID ";
query = query + "          AND PTOPER2.T_RJSRVCLNTID = CLNT2.T_ID ";
query = query + "          AND CLNT2.T_PARTYID = CLNT.T_PARTYID ";
query = query + "          AND MSG2.T_MSGKIND = 2 /* RJSRVMSG_MSGKIND_REJ_OPER*/  ";
query = query + "          AND MSG2.T_MSGSTATE = 5 /* RJSRVMSG_STATUS_UNLOADED */ ";
query = query + "      ) >= :Rejects2  ";

    params.value(i) = SQLParam("Rejects2", Rejects);
    i = i + 1;
  end;

  if(ExcludeRJCN)
query = query + "  AND CLNT.T_PARTYID NOT IN ( SELECT CLNT2.T_PARTYID ";
query = query + "  FROM DFMRJSRVMSG_DBT MSG2, DFMRJSRVMSGIDPRT_DBT DPRT2, DFMRJCNCLCONTRACC_DBT CON2, DFMRJSRVCLNT_DBT CLNT2 ";
query = query + "WHERE MSG2.T_ID = DPRT2.T_RJSRVMSGID ";
query = query + "  AND DPRT2.T_ID = CON2.T_RJSRVMSGIDPRTID ";
query = query + "  AND CON2.T_RJSRVCLNTID =  CLNT2.T_ID ";
query = query + "  AND MSG2.T_MSGKIND = 3 /* RJSRVMSG_MSGKIND_TERM_ACC_CNTR */  ";     
query = query + "  AND MSG2.T_MSGSTATE <> 6 /* RJSRVMSG_STATUS_REJECT */ ";
query = query + "  )     ";
  else
query = query + "UNION   ";
query = query + "SELECT CLNT.T_PARTYID AS tClientID, PT.T_NAME, MSG.T_MSGKIND, 'ОД' AS MSGKINDNAME, CON.T_REJECTDATE AS tDate, DECODE(TRIM('0' FROM SUBSTR(CON.T_RECNUMBER, LENGTH(CON.T_RECNUMBER)-9)), '??????????', '?', chr(1),'-',TRIM('0' FROM SUBSTR(CON.T_RECNUMBER, LENGTH(CON.T_RECNUMBER)-9))) AS tNumb, ";
query = query + " chr(1) AS tAccount,  ";
query = query + " DECODE(DPRT.T_SOURCEDPRT, 0, MSG.T_SOURCEDPRT, DPRT.T_SOURCEDPRT) AS SOURCEDPRT, (SELECT T_NAME FROM DDP_DEP_DBT WHERE T_CODE = DECODE(DPRT.T_SOURCEDPRT, 0, MSG.T_SOURCEDPRT, DPRT.T_SOURCEDPRT) ) AS NAMEDPRT,  ";
query = query + " MSG.T_MSGSTATE, DECODE(MSG.T_MSGSTATE, 1, 'на контроль', 2, 'на визирование', 3, 'отложено', 4, 'на выгрузку', 5, 'выгружено', 6, 'отвергнуто', chr(1)) AS STATUSNAME, CON.T_ADDINFO AS ADDINFO ";
query = query + "FROM DFMRJSRVMSG_DBT MSG, DFMRJSRVMSGIDPRT_DBT DPRT, DFMRJCNCLCONTRACC_DBT CON, DFMRJSRVCLNT_DBT CLNT, DPARTY_DBT PT ";
query = query + "WHERE MSG.T_ID = DPRT.T_RJSRVMSGID ";
query = query + "  AND DPRT.T_ID = CON.T_RJSRVMSGIDPRTID ";
query = query + "  AND CON.T_RJSRVCLNTID =  CLNT.T_ID ";

  if(ClientID > 0)
query = query + "  AND CLNT.T_PARTYID = :PartyID1 ";
    params.value(i) = SQLParam(":PartyID1", ClientID);
    i = i + 1;
  end;

query = query + "  AND MSG.T_MSGKIND = 3 /* RJSRVMSG_MSGKIND_TERM_ACC_CNTR*/  "; 
query = query + "  AND MSG.T_MSGSTATE <> 6 /* RJSRVMSG_STATUS_REJECT */ ";
query = query + "  AND PT.T_PARTYID = CLNT.T_PARTYID ";

query = query + "AND CLNT.T_PARTYID IN (SELECT CLNT2.T_PARTYID ";
query = query + "FROM DFMRJSRVMSG_DBT MSG2, DFMRJSRVMSGIDPRT_DBT DPRT2, DFMRJCNCLCARRYOPER_DBT OPR2, DFMRJSRVPTOPER_DBT PTOPER2,DFMRJSRVCLNT_DBT CLNT2 ";
query = query + "WHERE MSG2.T_ID = DPRT2.T_RJSRVMSGID ";
query = query + "  AND DPRT2.T_ID = OPR2.T_RJSRVMSGIDPRTID ";
query = query + "  AND OPR2.T_ID = PTOPER2.T_RJCNCLCARRYOPERID ";
query = query + "  AND PTOPER2.T_RJSRVCLNTID = CLNT2.T_ID ";

  if(ClientID > 0)
query = query + "  AND CLNT2.T_PARTYID = :PartyID2 ";
    params.value(i) = SQLParam(":PartyID2", ClientID);
    i = i + 1;
  end;

query = query + "  AND MSG2.T_MSGKIND = 2 /* RJSRVMSG_MSGKIND_REJ_OPER*/ ";
query = query + "  AND MSG2.T_MSGSTATE = 5 /* RJSRVMSG_STATUS_UNLOADED */ ";
query = query + "  AND OPR2.T_REJECTDATE BETWEEN :FromRJDate2 AND :TillRJDate2 ) ";

  params.value(i) = SQLParam("FromRJDate2", FromDate);
  i = i + 1;
  params.value(i) = SQLParam("TillRJDate2", TillDate);
  i = i + 1;

  end;

  return query;
end;

private macro _GetClientRecordset
(
  FromDate
 ,TillDate
 ,ClientID
 ,Rejects
 ,Uploaded
 ,ExcludeRJCN
 ,IncludeRJCN
)
  var query = "";
  var rs;
  var params = TArray;
  var i = 0;

  CaptureOutput;
[
WITH 
  oopt AS 
  (
   SELECT ocpt.t_ClientID
     FROM dopcntrpt_dbt ocpt, dopcontr_dbt oc
    WHERE    ocpt.t_OperationID = oc.t_OperationID 
         AND ocpt.t_Kind = 7
];
  query = query + StopCaptureOutput;

  if(ClientID > 0)
    CaptureOutput;
[
         AND ocpt.t_ClientID = :ClientID1 /*если "Клиент" > 0*/ 
];
    query = query + StopCaptureOutput;
    params.value(i) = SQLParam("ClientID1", ClientID);
    i = i + 1;
  end;

  CaptureOutput;
[
         AND oc.t_Date_Carry BETWEEN :FromDate1 AND :TillDate1 /*указанный "Период"*/
];
  query = query + StopCaptureOutput;
  params.value(i) = SQLParam("FromDate1", FromDate);
  i = i + 1;
  params.value(i) = SQLParam("TillDate1", TillDate);
  i = i + 1;

  CaptureOutput;
  if(Uploaded)
[        AND oc.t_Status = 5 /*выгружена, если установлен флаг "выгруженных"*/ 
];
  else
[        AND oc.t_Status != 8 /*не отвергнута, если не установлен флаг "выгруженных"*/
];
  end;
  query = query + StopCaptureOutput;

  CaptureOutput;
[
         AND oc.t_Type = 3 /*ОО (Отказ от проведения операции)*/
    GROUP BY ocpt.t_ClientID
    HAVING COUNT(*) >= :Rejects /*"Количество ОО"*/
  )
];
  query = query + StopCaptureOutput;
  params.value(i) = SQLParam("Rejects", Rejects);
  i = i + 1;

  if(ExcludeRJCN)
    CaptureOutput;
[
 ,odpt AS 
  (
   SELECT ocpt.t_ClientID
     FROM dopcntrpt_dbt ocpt, dopcontr_dbt oc
    WHERE    ocpt.t_OperationID = oc.t_OperationID 
         AND ocpt.t_Kind = 8
];
    query = query + StopCaptureOutput;

    if(ClientID > 0)
      CaptureOutput;
[
         AND ocpt.t_ClientID = :ClientID2 /*если "Клиент" > 0*/ 
];
      query = query + StopCaptureOutput;
      params.value(i) = SQLParam("ClientID2", ClientID);
      i = i + 1;
    end;

    CaptureOutput;
[
         AND oc.t_Date_Carry BETWEEN :FromDate2 AND :TillDate2 /*указанный "Период"*/
];
    query = query + StopCaptureOutput;
    params.value(i) = SQLParam("FromDate2", FromDate);
    i = i + 1;
    params.value(i) = SQLParam("TillDate2", TillDate);
    i = i + 1;

    CaptureOutput;
[        AND oc.t_Status != 8
         AND oc.t_Type = 4 /*ОД (Отказ от договора банковского счета)*/
    GROUP BY ocpt.t_ClientID
  )
];
    query = query + StopCaptureOutput;
  end;

  CaptureOutput;
[
 ,ptn AS
  (
   SELECT pt.t_PartyID, pt.t_Name
     FROM dparty_dbt pt, oopt
    WHERE pt.t_PartyID = oopt.t_ClientID
  )
SELECT  ocpt.t_ClientID AS tClientID,
         ptn.t_Name t_ClientName,
         oc.t_Type,
         CASE oc.t_Type WHEN 3 THEN 'ОО' WHEN 4 THEN 'ОД' END t_TypeName,
         oc.t_Date_Carry AS tDate,
         TO_CHAR(oc.t_Numb_P) AS tNumb,
         oc.t_RejectAccount,
         oc.t_Department,
         dp.t_Name t_DprtName,
         oc.t_Status,
         RSI_RsbFMKernel.GetStatusString (oc.t_Status) t_StatusName,
         oc.t_RejectGround
  FROM dopcntrpt_dbt ocpt, dopcontr_dbt oc, oopt, ptn, ddp_dep_dbt dp
 WHERE    ocpt.t_OperationID = oc.t_OperationID 
      AND ocpt.t_Kind IN (7, 8)
      AND ocpt.t_ClientID = oopt.t_ClientID

];
  query = query + StopCaptureOutput;

  if(ExcludeRJCN)
    CaptureOutput;
[
      AND ocpt.t_ClientID NOT IN (SELECT odpt.t_ClientID FROM odpt) /*если установлен "не включать, если есть операция ОД"*/ 
];
    query = query + StopCaptureOutput;
  end;

  CaptureOutput;
[
         AND oc.t_Date_Carry BETWEEN :FromDate3 AND :TillDate3 /*указанный "Период"*/
];
  query = query + StopCaptureOutput;
  params.value(i) = SQLParam("FromDate3", FromDate);
  i = i + 1;
  params.value(i) = SQLParam("TillDate3", TillDate);
  i = i + 1;

  CaptureOutput;
  if(Uploaded)
[
         AND (oc.t_Type = 4 OR oc.t_Status = 5) /*ОД или выгружена, если установлен флаг "выгруженных"*/ 
];
  else
[
         AND oc.t_Status != 8 /*не отвергнута, если не установлен флаг "выгруженных"*/
];
  end;
  query = query + StopCaptureOutput;

  CaptureOutput;
[      
      AND oc.t_Type IN (3, 4) /*ОО, ОД*/
      AND ptn.t_PartyID = ocpt.t_ClientID
      AND dp.t_Code = oc.t_Department
];
  query = query + StopCaptureOutput;

  query = query + " UNION ";
  query = query + _AddQueryStr(params, i, FromDate, TillDate, ClientID, Rejects, Uploaded, ExcludeRJCN, IncludeRJCN);
  query = query + " ORDER BY tClientID, tDate, tNumb ";

  rs = execSQLselect(query, params, true);

  return rs;
end;

private macro _PrintHeader()
[Рекомендации по расторжению договора счета];
[
];
[Дата:           ########## г.] (date);
[Время:          ########] (time);
[Пользователь:   ##### #] ({oper}, {Name_Oper});
[];
end;

private macro _PrintRecomendation()
  if((countOO >= 2) and (countOD == 0))
[Рекомендуется расторгнуть договор счета];
  end;
end;

private macro _PrintClient
(
  pClientID
 ,pClientName
 ,pType
 ,pTypeName
 ,pDate
 ,pNumb_P
 ,pRejectAccount
 ,pDepartment
 ,pDprtName
 ,pStatus
 ,pStatusName
 ,pRejectGround
)

  if((prevClientID == 0) and (pClientID < 0))
[
Рекомендаций нет];
  end;
  
  if((prevClientID > 0) and (prevClientID != pClientID))
    _PrintRecomendation();
  end;

  if((pClientID > 0) and (prevClientID != pClientID))
[
########## #] (pClientID, pClientName);
    prevClientID = pClientID;
    countOO = 0;
    countOD = 0;
  end;

  if(pClientID > 0)
    if(pTypeName == "ОО")
      countOO = countOO + 1;
[## ########## ########## ######################### ############ (####################) #] (pTypeName, date(pDate), pNumb_P, pRejectAccount, pDprtName, pStatusName, pRejectGround);
    end;
    if(pTypeName == "ОД")
      countOD = countOD + 1;
[## ########## ########## #] (pTypeName, date(pDate), pNumb_P, pRejectGround);
    end;
  end;
end;

macro PrintReport
(
  FromDate
 ,TillDate
 ,ClientID
 ,Rejects
 ,Uploaded
 ,ExcludeRJCN
 ,IncludeRJCN
)
  var rs;
  
  prevClientID = 0;

  _PrintHeader();
  rs = _GetClientRecordset
  (
    FromDate
   ,TillDate
   ,ClientID
   ,Rejects
   ,Uploaded
   ,ExcludeRJCN
   ,IncludeRJCN
  );

  while(rs.movenext())
    _PrintClient
    (
      rs.value("tClientID"     )
     ,rs.value("t_ClientName"   )
     ,rs.value("t_Type"         )
     ,rs.value("t_TypeName"     )
     ,rs.value("tDate"   )
     ,rs.value("tNumb"       )
     ,rs.value("t_RejectAccount")
     ,rs.value("t_Department"   )
     ,rs.value("t_DprtName"     )
     ,rs.value("t_Status"       )
     ,rs.value("t_StatusName"   )
     ,rs.value("t_RejectGround" )
    );
  end;

  _PrintClient(-1);

  return 0;
end;



