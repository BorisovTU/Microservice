/*
  @file ExRateAcc.mac
  @brief Точка доступа из макроса к формированию основания проводки курсовой разницы 
  #menu Главная книга
  #tag 
  - functional_block: Проводки

 # changeLog
 |date       |author        |tasks                                                     |note                                                        
 |-----------|--------------|----------------------------------------------------------|-------------------------------------------------------------
 |2023.10.18 |Дылгеров Ц.В. |DEF-53456                                                 | Основание генерируется из метода МВП;                   

*/

/*
 $Name: ExRateAcc.mac
 $Module: Ядро ГКБО 
 $Description: Точка доступа из макроса к формированию основания проводки курсовой разницы  
 */
 /*
  BaseTrn   - буфер записи основной мультивалютной проводки (Только чтение)
  ExRateAcc - буфер записи проводки курсовой разницы (Только чтение)
 */
import rsd,fiinter;

macro MakeAccTrnGround(BaseTrn : TRecHandler, ExRateAcc : TRecHandler)
    var Ground = ExRateAcc.rec.Ground;
    return Ground;
end;



/*
  macro GetCurrencyISO ( CurrCode )  //взято из fm_com.mac
    var cmdFI, rsFI;
    var cmd, rs;
    var isoNumber = "";
    var codeInAccount = "";
    var codeISO = "";
    cmdFI = RsdCommand( "select * from DFININSTR_DBT where T_FIID = " + String( currCode ) );
    cmdFI.execute( );
    rsFI = RsdRecordSet( cmdFI );

    if ( rsFI.moveNext( ) )
      isoNumber = String( rsFI.value( "T_ISO_NUMBER" ) );
      codeInAccount = rsFI.value( "T_CODEINACCOUNT" );

      cmd = RsdCommand( "select * from DCURRENCY_DBT where T_EXTERNALCODE in ( '" + isoNumber + "', '" + codeInAccount + "' )" );
      cmd.execute( );
      rs = RsdRecordset( cmd );

      if ( rs.moveNext( ) )
        codeISO = /*rs.Value( "T_EXTERNALCODE" ) + " (" + */rs.Value( "T_SHORT_NAME" )/* + ")"*/;  
      end;
      
    end;
    /*
    cmd = RsdCommand( "select * from DCURRENCY_DBT where T_CODE_CURRENCY=?" );
    cmd.addParam ("CODE_CURRENCY", RSDBP_IN );
    cmd.value ("CODE_CURRENCY") = CurrCode;
    cmd.execute( );
    rs = RsdRecordset( cmd );

    if ( rs.moveNext( ) )
      codeISO = rs.Value( "T_EXTERNALCODE" ) + " (" + rs.Value( "T_SHORT_NAME" ) + ")";  
    end;*/
    
    return codeISO;
       
  end;

  var stat; 
  var rate = $0; //если убрать типы, то возврат значений не будет работать!!!
  var scale:integer = 0, point:integer = 0;
  stat = fi_getrateondate(BaseTrn.rec.fiid_receiver,0,ExRateAcc.rec.date_carry,7,@rate,@scale,@point);
  var day,mon,year;
  DateSplit(ExRateAcc.rec.date_carry, day,mon,year);

    var Ground = "Нереализованная курсовая разница к сумме " + 
        string(BaseTrn.rec.sum_payer) + " " + //"{ValSum} " + 
        GetCurrencyISO(BaseTrn.rec.fiid_payer) + //"{ValFiCode}" + 
        ". Исходный документ Мем.ор. N '" + 
        string(ExRateAcc.rec.numb_document) +//"{NumbCFT}" + 
        "'  от " + 
        string(day,"/",mon,"/",year) + //"{Date}" + 
        ", валюта " + 
        GetCurrencyISO(BaseTrn.rec.fiid_payer) + //"{ValFiCode}" +
        ", курс операции " + 
        string(BaseTrn.rec.rate/pow(10,BaseTrn.rec.point)) + //"{Rate}" + 
        ", текущий курс " + 
        string(rate/pow(10,point)) + // "{Rate_CB}" +
        "."; 

    //ExRateAcc.rec.Ground;
*/