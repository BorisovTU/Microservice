/*---------------------------------------------------------------------------\
|                       Файл    Account.mac                                  |
\---------------------------------------------------------------------------*/


private Record Счет( account );
private Record СтарыйСчет( account );

private Record БалансовыеСчета( accblnc );
private Record СтарыеБалансовыеСчета( accblnc );

private Record  Субсчет (ACCSUB);
private Record  СтарыйСубсчет (ACCSUB);

private Record  ПроводкаСубсчета (ACCSUBDC);
private Record  СтараяПроводкаСубсчета (ACCSUBDC);

private macro Новый_счет()
        return  0;
end;

import cb_sql;  /* SQL-утилиты      */

/*
    Возможные значения параметра Режим
      OBJ_INSERT      - создание нового счета из списка лицевых счетов. Заполнены буферы Счет, БалансовыеСчета.
      OBJ_UPDATE      - обновление существующего счета из списка лицевых счетов. Заполнены буферы Счет, БалансовыеСчета, СтарыйСчет, СтарыеБалансовыеСчета.
      OBJ_CLOSE       - закрытие лицевого счета из списка лицевых счетов. Заполнены буферы Счет, БалансовыеСчета.
      OBJ_OPEN_CLOSED - закрытие лицевого счета из списка лицевых счетов. Заполнены буферы Счет, БалансовыеСчета.
 */
private macro Проверить_счет( Режим )

/* Пример проверки структуры номера лицевого счета.
   В позициях с 1-ой по 5-ую должен быть номер балансового счета.
   В позициях с 6-ой по 8-ую должен быть код валюты. */
// KS 08.05.2019 RSHBSOFR-469 В процедуре открытия счета вручную не работают проверки номера счета и номера второго порядка
   if ((Счет.Chapter == 1) or
       (Счет.Chapter == 3))
        var   ISO = "810";  /* Константа кода национальной валюты. */
        var   str;          /* Строка для сообщений. */
        
        if ( ( Index(Счет.Account, Счет.Balance) != 1 ) )
           str = "Номер лицевого счета "+Счет.Account+
                 "| в первых пяти позициях не содержит"
                 "| номера балансового счета "+Счет.Balance;
           MsgBox(str);
           return 1;
        end;

        var RS = TRsbDataSet("select 1 from dfininstr_dbt where t_codeinaccount='"+substr(Счет.Account, 6, 3)+"' and t_fiid="+Счет.Code_Currency);

        if( not RS.MoveNext() )
           str = "Номер лицевого счета "+Счет.Account+
                 "| в позициях 6,7,8 не содержит"
                 "| кода указанного финансового инструмента";
           MsgBox(str);
           return 1;
        end;

        if ( ( StrLen(Счет.Account) != 20 ) )
           str = "Длина номера счета не соответствует требуемой (20 символов)";
           MsgBox(str);
           return 1;
        end;

        RS = TRsbDataSet("select PMEA_MEMORDER.RSI_GETDEPARTMENTBIK("+Счет.department+") from dual");
        var DprtBIC;
        if( RS.MoveNext() )
          DprtBIC = rs.value(0);
        end;

        if ( ( GetKey(Счет.Account, DprtBIC) != Счет.Account ) )
           str = "Неверный ключ в номере счета! Правильный - " + GetKey(Счет.Account);
           MsgBox(str);
           return 1;
        end;

   end;
        return  0;
end;

private macro ФункцияПользователяСчет( )
        return 0;
end;

private macro Новая_ПроводкаСубсчета()
        return  0;
end;

// Режимы: 
// OBJ_INSERT - вставка
// OBJ_UPDATE - редактирование
// OBJ_DELETE - удаление 
private macro Проверить_ПроводкуСубсчета( Режим )
        return  0;
end;

private macro Новый_Субсчет()
        return  0;
end;

// Режимы: 
// OBJ_INSERT - вставка
// OBJ_UPDATE - редактирование
// OBJ_DELETE - удаление 
private macro Проверить_Субсчет( Режим )
        return  0;
end;

/*
  Режимы работы скроллинга:
  Chapter - глава, для которой открывается список;
  Open_Close - открытые/закрытые счета;
  PartyID - != 0, если в режиме счетов клиента;
  Balance - != "", если в режиме счетов балансового счета.
*/
private macro УстановитьПодсказку(Chapter, Open_Close, PartyID, Balance)
  return "";
end;


/* Показать панель счета? */
// mode:
// 0 - ACNT_PANEL_EDIT       
// 1 - ACNT_PANEL_INPUT      
// 2 - ACNT_PANEL_VIEW       
private macro Показать_Панель_Счета( mode:integer)

  //MsgBox("Показать_Панель_счета , ", mode, "   ", Счет.Account, "   ", Счет.Balance);
  //return 1;

  return 0;
end;



