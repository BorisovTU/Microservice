/* bb_coprn.mac                                   Бурак В.Ю.             */
/* ============= Печать платежного поручения ==============================


 =========================================================================*/
import prpm, likepy;
import "adress.mac";

var Client_Address, INN, Currency, sumstr, cur, 
    BankBen_Address, BankBen_SWIFT, AccCorrBank, 
    BankCorr_Name, BankCorr_Address, BankCorr_SWIFT;  



macro joinAddress(PostIndex:string, Address:string):string
  return join(map(filter(makeArray(PostIndex, Address)), @Trim), ", ");
end;

macro DrawReport( Number, _Date, 
                  Client_Name, Client_Address, INN,
                  Currency, Amount, Amount_str,
                  Payer_Account,
                  ComissCharges,
                  BankCorr_Name, BankCorr_Address, BankCorr_SWIFT, AccCorrBank,
                  BankBen_Name, BankBen_Address, BankBen_SWIFT, Beneficiary,
                  Beneficiary_Account,  
                  Details ) 

  if( pr_PrintEA )
    PrintEAHeader();
  end;

  var
    copy,
    SPOT, TOD,
    BEN, OUR, C_BEN, C_OUR;

  SPOT = "X";
  TOD  = "";
  /* OUR */
  if (ComissCharges == 0)
     BEN = "";
     OUR = "X";
     C_BEN = "";
     C_OUR = "X";
  end;
  /* BEN */
  if (ComissCharges == 2)
     BEN = "X";
     OUR = "";
     C_BEN = "X";
     C_OUR = "";
  end;
  /* SHA */
  if (ComissCharges == 2)
     BEN = "";
     OUR = "X";
     C_BEN = "X";
     C_OUR = "";
  end;

  replace( Details,     "\n", " " );
  replace( Beneficiary, "\n", " " );

  ARRAY ClN, ClA, Am, D, B;

  strsplit( Client_Name,    ClN,50,50,2 ); /* Имя клиента */
  strsplit( Client_Address, ClA,50,50,3 ); /* Адрес клиента */
  strsplit( Amount_str,      Am,50,50,4 ); /* Сумма прописью */
  strsplit( Details,          D,97,97,2 ); /* Детали платежа*/
  strsplit( Beneficiary,      B,97,97,2 ); /* Реквизиты бенефициара */ 

[
 +-----------------------------------------------------+-----------------------------------------------------+
 |                             +---------------+       |+---------------------------------------------------+|
 | ЗАЯВЛЕНИЕ НА ПЕРЕВОД НОМЕР  |###############|       ||  ЗАПОЛНЯЕТСЯ БАНКОМ                               ||
 | PAYMENT ORDER NUMBER        +---------------+       ||- - - - - - - - - - - - - - - - - - - - - - - - - -||
 |                  +----------+                       ||                                 +---------------+ ||
 | Дата/Date        |##########|                       ||  Комиссия за перевод            |               | ||
 |                  +----------+                       ||                                 +---------------+ ||
 |                                                     ||  Комиссия за Паспорт сделки     |               | ||
 |                                                     ||                                 +---------------+ ||
 |                                                     ||  НДС                            |               | ||
 |                                                     ||                                 +---------------+ ||
 +-----------------------------------------------------||- - - - - - - - - - - - - - - - - - - - - - - - - -+|
 |  :50: КЛИЕНТ/CLIENT                                 ||                         +-----------------------+ ||
 |  Имя клиента / Client's name                        ||  Сумма к переводу       |                       | ||
 |  ################################################## ||                         +-----------------------+ ||
 |  ################################################## ||  Банк-корреспондент                               ||
 |  Адрес/Address                                      ||                                                   ||
 |  ################################################## ||  :30: Дата валютирования                          ||
 |  ################################################## ||                                                   ||
 |  ################################################## ||- - - - - - - - - - - - - - - - - - - - - - - - - -+|
 |            +------------------------------------+   ||                                                   ||
 |  ИНН       |####################################|   || Подписи ответственных лиц                         ||
 |            +------------------------------------+   ||                                                   ||
 +-----------------------------------------------------|+---------------------------------------------------+|
 |                                                     +-----------------------------------------------------+
 |  :32:ПЛАТИТЬ/PAY                                       Сумма прописью / Amount in words                   |
 |  +--------------+-----------------------------+                                                           |
 |  |      ###     |#############################|        ################################################## |
 |  +--------------+-----------------------------+        ################################################## |
 |  Валюта платежа  Сумма цифрами                         ################################################## |
 |  Paymentcurrency Numerical Amount                      ################################################## |
 +--------------------------------------------------------------------+--------------------------------------+   
 |                                    +-----------------------------+ | Перевод на условиях:/Payment terms:  |
 |  Платеж осуществить с нашего счета |#############################| |              +---+             +---+ |
 |  Please debit our account No       +-----------------------------+ | обычный/SPOT |###| срочный/TOD |###| |
 |                                                                    |              +---+             +---+ |
 +--------------------------------------------------------------------+--------------------------------------+
 |                                                     +--+                                        +--+      |
 |  : :  Расходы по переводу нашего банка за наш счет  |##|             за счет получателя         |##|      |
 |       Charges of our bank for our account           +--+             for beneficiary's account  +--+      |
 +-----------------------------------------------------------------------------------------------------------+
 |                                                     +--+                                        +--+      |
 |  :71: Комиссии банков корреспондентов за наш счет   |##|             за счет получателя         |##|      |
 |       Correspondent`s charges for our account       +--+             for beneficiary's account  +--+      |
 +-----------------------------------------------------------------------------------------------------------+
 |  :56: БАНК-КОРРЕСПОНДЕНТ БАНКА ПОЛУЧАТЕЛЯ                                                                 |
 |       CORRESPONDENT BANK OF BENEFICIARY'S BANK                                                            |
 |       Наименование банка / Bank name                                                                      |
 |       ################################################################################################### |
 |       Адрес / Address                                                                                     |
 |       ################################################################################################### |
 |  S.W.I.F.T. код/code          +-----------------------------+        <CHIPS UID No, ABA No,               |
 |  или/or <...>                 |#############################|        Bank Code, Sort Code etc.>           |
 +-------------------------------+-----------------------------+---------------------------------------------+
 |  :57: БАНК ПОЛУЧАТЕЛЯ ПЛАТЕЖА / BENEFICIARY'S BANK                                                        |
 |       Наименование банка / Bank name                                                                      |
 |       ################################################################################################### |
 |       Адрес / Address                                                                                     |
 |       ################################################################################################### |
 |  Счет в банке-корресп.        +-----------------------------+                                             |
 |  Acc with corresp. Bank       |#############################|                                             |
 |                               +-----------------------------+                                             |
 |  S.W.I.F.T. код/code          +-----------------------------+        <CHIPS UID No, ABA No,               |
 |  или/or <...>                 |#############################|        Bank Code, Sort Code etc.>           |
 +-------------------------------+-----------------------------+---------------------------------------------+
 |  :59: ПОЛУЧАТЕЛЬ ПЛАТЕЖА / BENEFICIARY                                                                    |
 |       Имя получателя / Beneficiary's name                                                                 |
 |       Адрес / Address                                                                                     |
 |       ################################################################################################### |
 |       ################################################################################################### |
 |  Счет получателя номер        +-----------------------------+                                             |
 |  Beneficiary's Acc No         |#############################|                                             |
 +-------------------------------+-----------------------------+---------------------------------------------+
 |  :70: ДЕТАЛИ ПЛАТЕЖА / PAYMENT DETAILS                                                                    |
 |                                                                                                           |
 |       ################################################################################################### |
 |       ################################################################################################### |
 +-----------------------------------------------------------------------------------------------------------+
 |  В случае недостаточной информации для платежа Банк не несет ответственности за сроки прохождения платежа |
 |In case of incomplete or incorrect information in payment instructions the Bank incurs no responsibility   | 
 |                                      for processing of payment                                            |
 +-----------------------------------------------------------------------------------------------------------+


                 М.П.                    Подписи / Signatures

                                                                                                             
]                                                                                                             


 (Number:l,
  _Date:c:f,
  ClN(0):l, ClN(1):l,
  ClA(0):l, ClA(1):l, ClA(2):l,
  INN:c,
  Currency:c, Amount:r, Am(0):l,
  Am(1):l, Am(2):l, Am(3):l,
  Payer_Account:c, SPOT:c, TOD:c,
  OUR:l, BEN:l, C_OUR:l, C_BEN:l,
  BankCorr_Name:l, BankCorr_Address:l, BankCorr_SWIFT:c,
  BankBen_Name:l, BankBen_Address:l, 
  AccCorrBank:c, BankBen_SWIFT:c,
  B(0):l, B(1):l,
  Beneficiary_Account:c,
  D(0):l, D(1):l
 );

 return TRUE;
end;
    
/* Печать платежного поручения */
macro PrintDocument(ncopy:integer):bool
  
  var Name_Country, err, VRSL, report, stat;
  var DocKind:integer = pr_pmpaym.rec.DocKind;

  if( DocKind != BBANK_CPORDER )
    MsgBox("Данный вид документа не поддерживается макросом");
    return FALSE;
  end;

  FILE party    (party) key 0;
  FILE partcode (partcode) key 1;

  RECORD RecordAdress ( adress  );

   Currency = ПолучитьКодФинИН(pr_pmpaym.rec.FIID);

   party.PartyID = pr_pmpaym.rec.Payer;
   
   if(GetEq(party))
      if(НайтиЮридическийАдресСубъекта(party.PartyID,RecordAdress))
        Client_Address = joinAddress( RecordAdress.PostIndex, RecordAdress.Adress );
      else
        Client_Address = "";
      end;
      INN = GetPartyINN( party.PartyID, 1 );
   else
      Client_Address = "";
      INN = "";
   end;

   party.PartyID = pr_pmpaym.rec.ReceiverBankID;
   
   if(GetEq(party))
      if(НайтиЮридическийАдресСубъекта(party.PartyID,RecordAdress))
        BankBen_Address = joinAddress( RecordAdress.PostIndex, RecordAdress.Adress );
      else
        BankBen_Address = "";
      end;
   else
      BankBen_Address = "";
   end;

   BankBen_SWIFT = ПолучитьКодСубъекта( pr_pmpaym.rec.ReceiverBankID, PTCK_SWIFT, err );
   if(err)
      BankBen_SWIFT   = "";
   end;

   if ( (pr_credit.rec.PaymentID==pr_pmpaym.rec.PaymentID) AND (pr_credit.rec.IsSender!="X") )
      AccCorrBank    = pr_credit.rec.CorrAcc;
      BankCorr_SWIFT = pr_credit.rec.CorrCode;

      partcode.CodeKind = pr_credit.rec.CorrCodeKind;
      partcode.Code     = pr_credit.rec.CorrCode;
      if(getEQ(partcode))
         party.PartyID = partcode.PartyID;
         if(getEQ(party))
            if(НайтиЮридическийАдресСубъекта(party.PartyID,RecordAdress))
              BankCorr_Address = joinAddress(RecordAdress.PostIndex, RecordAdress.Adress );
            else
              BankCorr_Address = "";
            end;
            BankCorr_Name  =pr_pmrmprop.rec.ReceiverCorrBankName;
         else
            BankCorr_Address = "";
            BankCorr_Name  = "";
         end;
      else
         BankCorr_Name    = "";
         BankCorr_Address = "";
      end;
   else
      AccCorrBank    = pr_debet.rec.CorrAcc;
      BankCorr_SWIFT = pr_debet.rec.CorrCode;

      partcode.CodeKind = pr_debet.rec.CorrCodeKind;
      partcode.Code     = pr_debet.rec.CorrCode;
      if(getEQ(partcode))
         party.PartyID = partcode.PartyID;
         if(getEQ(party))
            if(НайтиЮридическийАдресСубъекта(party.PartyID,RecordAdress))
              BankCorr_Address = joinAddress(RecordAdress.PostIndex, RecordAdress.Adress );
            else
              BankCorr_Address = "";
            end;
            BankCorr_Name  = party.ShortName;
         else
            BankCorr_Address = "";
            BankCorr_Name  = "";
         end;
      else
         BankCorr_Name    = "";
         BankCorr_Address = "";
      end;
   end;

   sumstr = string(MoneyL(pr_pmpaym.rec.Amount));
   cur = CurToStrAlt(pr_pmpaym.rec.Amount , null, null, getISOCode(pr_pmpaym.rec.FIID) );

     while(ncopy > 0)
       DrawReport(pr_pmrmprop.rec.Number, pr_pmrmprop.rec.Date,
                  SubStr(pr_pmrmprop.rec.PayerName, 1, 100), SubStr(Client_Address, 1, 150 ), INN,
                  Currency, sumstr, cur,
                  pr_pmpaym.rec.PayerAccount,
                  pr_pmrmprop.rec.ComissCharges,
                  BankCorr_Name, BankCorr_Address, BankCorr_SWIFT, AccCorrBank,
                  pr_pmrmprop.rec.ReceiverBankName, BankBen_Address, BankBen_SWIFT, pr_pmrmprop.rec.ReceiverName,
                  pr_pmpaym.rec.ReceiverAccount,
                  pr_pmrmprop.rec.Ground );
       ncopy = ncopy - 1;
     end;
   return TRUE;
   
end;