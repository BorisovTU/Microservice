/*-----------------------------------------------------------------------*/
/*         Автоматизированная банковская система RS-Bank                 */
/*              Copyright (c) R-Style Software Lab                       */
/*                                                                       */
/*  Имя файла        : prpmstamp.mac                                     */
/*                                                                       */
/*  Описание         : Функции для печати платежного документа со штампом*/
/*                                                                       */
/*                                                                       */
/*  Программист      : Катюшин А.А.                                      */
/*                                                                       */
/*  Создан           : 05.05.09                                          */
/*                                                                       */
/*-----------------------------------------------------------------------*/

import prpm, adress, oralib;

macro GetShortNameOurBank()
   FILE Party( party ) key 0;
   party.PartyID = {OurBank};
   if ( getEQ(party) )
       return party.ShortName;
   end;
   return "";
end;

MACRO Stamp():TArray
  var select:string;
  var params:TArray;
  var rs:object;
  var Ret:TArray=TArray;
  var PaymentID:integer=pr_pmpaym.rec.PaymentID;

  Ret(0)="";
  Ret(1)="";
  Ret(2)="";
  Ret(3)="";
  Ret(4)="";
  Ret(5)="";
  Ret(6)="";
  Ret(7)="";
      
  RECORD addr ( adress );
  file bankdprt( bankdprt ) key 0;
  //Если дата списания заполнена вернуть заполненый штамп
  if( (pr_pmrmprop.rec.PayerChargeOffDate != NULL) and (pr_pmrmprop.rec.PayerChargeOffDate != date(0,0,0)))

    select = "Select t_purposepayment from dpmlink_dbt pmlink where pmlink.t_initialpayment = :PaymentID and  pmlink.t_linkkind = 2 order by pmlink.t_purposepayment desc;";

    params = makeArray(SQLParam("PaymnetID", PaymentID));

    rs = execSQLselect(select, params, false);

    if (rs.moveNext())
      PaymentID = rs.value(0);
    end;

    select = "Select person.t_name from dperson_dbt person, dindexv_dbt indexv, dpmdocs_dbt pmdocs, dpmpaym_dbt pmpaym "+
             "where pmdocs.t_paymentid = :PaymentID and pmdocs.t_applicationkind = indexv.t_iapplicationkind "+
             "and pmdocs.t_applicationkey = indexv.t_applicationkey and indexv.t_oper = person.t_oper "+
             "and pmpaym.t_paymentid = pmdocs.t_paymentid and indexv.t_account_payer = pmpaym.t_payeraccount "+
             "UNION "+
             "Select person.t_name from dperson_dbt person, dpmdocs_dbt pmdocs, darhdoc_dbt arh, dpmpaym_dbt pmpaym "+
             "where pmdocs.t_paymentid = :PaymentID and pmdocs.t_applicationkind = arh.t_iapplicationkind "+
             "and pmdocs.t_applicationkey = arh.t_applicationkey and arh.t_oper = person.t_oper "+
             "and pmpaym.t_paymentid = pmdocs.t_paymentid and arh.t_account_payer = pmpaym.t_payeraccount";
  
    params = makeArray(SQLParam("PaymnetID", PaymentID));

    rs = execSQLselect(select, params, false);

    if(rs and rs.moveNext())
      Ret(4) = rs.value(0);
    else
      return Ret;
    end;

    Ret(0) = GetShortNameOurBank();
    Ret(1) = "СБЕРБАНКА РОССИИ ОАО";
    
    
    Ret(2) = "г. ___________________";//для текстового режима
    Ret(7) = "г.                    ";//для RS-Forms
    if( НайтиЮридическийАдресСубъекта({OurBank}, addr))
      if( addr.Place != "" )
        Ret(2) = "г. " + addr.Place;
        Ret(7) = Ret(2);
      end;
    end;

    Ret(3) = pr_pmrmprop.rec.PayerChargeOffDate;        
   
    Ret(5)="БИК "+ПолучитьКодСубъекта( {OurBank}, PTCK_BIC );
  
    ClearRecord(bankdprt);
    bankdprt.PartyID = {OurBank};

    if( getEQ(bankdprt) )
      Ret(6)="к/сч. "+bankdprt.CorAcc;
    end;

  end;

  return Ret;
END;