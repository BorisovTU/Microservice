/*-------------------------------------------------------------------------
          €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank v6.020
                 Copyright (c) R-Style Software Lab

  ˆ¬ï ä ©«         : mpcrreg.mac

  Œ®¤ã«ì           : “ç¥â­®¥ ï¤à®. ®¢ë¥ ¯à®æ¥­âë

  Ž¯¨á ­¨¥         : ‚ë¢®¤ à¥¥áâà  á®§¤ ­­ëå ¤®ªã¬¥­â®¢ ¯® ¬ áá®¢ë¬ ®¯¥à æ¨ï¬

  à®£à ¬¬¨áâ      : „ãàï£¨­ …¢£¥­¨©, Š¨à ª®§®¢ Œ¨å ¨« 

  ‘®§¤ ­           : 25.05.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter,  globals, library, FIInter;
	              
var   gContractID,
      gContractBoffice,
      gContractNumber,
      gContractAccount,
      goper,
      gOperName = "",
      gOpKind,
      gServiceID,
      gDocID,
      gOperId,
      gOperDate,
      gPartyIDDep,
      gDepCode,
      gChapter,
      gDepName = "",
      gDepID,
      gSumD,
      gSumK;
  
record contract(prccontract);
record Document(arhdoc);
/* ------------------------------- */

// ®¤ª çª  ­ §¢ ­¨ï ª®­âà £¥­â 
PRIVATE MACRO PumpDepNamePartyID()
   var cmd, RS;

   cmd = RSDCommand( " select t_shortname from dparty_dbt where t_PartyID =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gPartyIDDep);
   cmd.execute();
   
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gDepName = Rs.shortname;
   end;
   
END;

private macro PumpDepID()
   var cmd, RS;
   if (gPartyIDDep >= 0)           
      cmd = RSDCommand( "select t_code from ddp_dep_dbt where t_PartyID =  ? " ) ; 
      cmd.addParam( "", RSDBP_IN, gPartyIDDep);
      cmd.execute();
      
      RS = TRsbDataSet(cmd);
      if (RS.movenext() )
         gDepID = Rs.code;
      else
         gDepID = 0;
      end;
      
   else
      gDepID = 0;
   end;
end;


// ®¤ª çª  ­ §¢ ­¨ï ä¨«¨ «  ¯® ª®¤ã                           
PRIVATE MACRO PumpDepNameDepCod()
   var cmd, RS;

   cmd = RSDCommand( " select t_shortname from dparty_dbt p, ddp_dep_dbt d where p.t_PartyID = d.t_PartyID and d.t_code = ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gDepCode);
   cmd.execute();
   
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gDepName = Rs.shortname;
   end;
   
END;


// ‚ë¢®¤ ®¤­®© áâà®ª¨ ¯® ¤®ªã¬¥­âã ¨«¨ ¯à®¢®¤ª¥                           
PRIVATE MACRO PrintLineCarryRep (Document, count, first)

   if ((count == 1) and (not first))
   [ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
   else
   [ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   end;
   
   [³######³#############################³########³#########³#############################³##########³#############³]
   (count:c, Document.PayerAccount:c, ®«ãç¨âìŠ®¤”¨­ˆ­(Document.PayerFIID):c, Document.PayerSum:c, Document.ReceiverAccount:c, ®«ãç¨âìŠ®¤”¨­ˆ­(Document.ReceiverFIID):c, Document.ReceiverSum:c );
   [³      ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [³      ³#######################################################################################################³](Document.Ground:w);
  
   gSumD = gSumD + Document.PayerSum;
   gSumK = gSumK + Document.ReceiverSum;
   
END;


// ‚ë¢®¤ áâà®ª ¯® ®¯¥à æ¨ï¬ ®¤­®© £« ¢ë
PRIVATE MACRO PrintLinesCarry()
   var  rs, first, cmd,cmd2,rs2,
        count = 0,
        PayerFIID = -1,
        ReceiverFIID = -1;

   cmd = RSDCommand( "select * from DPRCOPRDOCS_DBT OD, DPRCSRVDOC_DBT SD " +
                      "where OD.T_DOCID = SD.T_DOCID and SD.T_SERVICEID = ? " +
                      "and OD.T_CHAPTER = ? and (OD.T_PAYERDEPARTMENT = ? or OD.T_RECEIVERDEPARTMENT = ?) " +
                      "and OD.T_PAYERFIID = 0 order by OD.T_RECEIVERFIID asc") ; 
   cmd.addParam( "", RSDBP_IN, gServiceID );
   cmd.addParam( "", RSDBP_IN, gChapter );
   cmd.addParam( "", RSDBP_IN, gDepID );
   cmd.addParam( "", RSDBP_IN, gDepID );
   cmd.execute();

   gSumD = gSumK = 0;
   first = true;
   
   rs = TRsbDataSet(cmd);   
   while (rs.movenext() )
      if ((ReceiverFIID != rs.ReceiverFIID) and (count != 0))
         [ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
         [³      ³      ˆâ®£®                  ³########³#########³                             ³##########³#############³]
         (®«ãç¨âìŠ®¤”¨­ˆ­(rs.PayerFIID):c, gSumD:c, ®«ãç¨âìŠ®¤”¨­ˆ­(rs.ReceiverFIID):c, gSumK:c);	  
         [ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];	  
         count = 0;
         gSumK = gSumD = 0;
      end;
      count = count + 1;

      PrintLineCarryRep(rs, count, first);
      PayerFIID = rs.PayerFIID;
      ReceiverFIID = rs.ReceiverFIID;
   end;
   
   if ((count != 0))
      [ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
      [³      ³      ˆâ®£®                  ³########³#########³                             ³##########³#############³]
      (®«ãç¨âìŠ®¤”¨­ˆ­(PayerFIID):c, gSumD:c, ®«ãç¨âìŠ®¤”¨­ˆ­(ReceiverFIID):c, gSumK:c);	  
      [ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];	  
      count = 0;
      gSumK = gSumD = 0;
   end;


   cmd2 = RSDCommand( "select * from DPRCOPRDOCS_DBT OD, DPRCSRVDOC_DBT SD " +
                      "where OD.T_DOCID = SD.T_DOCID and SD.T_SERVICEID = ? " +
                      "and OD.T_CHAPTER = ? and (OD.T_PAYERDEPARTMENT = ? or OD.T_RECEIVERDEPARTMENT = ?) " +
                      "and OD.T_PAYERFIID > 0 order by OD.T_RECEIVERFIID, OD.T_PAYERFIID asc") ; 
   cmd2.addParam( "", RSDBP_IN, gServiceID );
   cmd2.addParam( "", RSDBP_IN, gChapter );
   cmd2.addParam( "", RSDBP_IN, gDepID );
   cmd2.addParam( "", RSDBP_IN, gDepID );
   cmd2.execute();

   gSumD = gSumK = 0;
   
   rs2 = TRsbDataSet(cmd2);   
   while (rs2.movenext() )
      if (((ReceiverFIID != rs2.ReceiverFIID) or (PayerFIID != rs2.ReceiverFIID)) and (count != 0))
         [³      ³      ˆâ®£®                  ³########³#########³                             ³##########³#############³]
         (®«ãç¨âìŠ®¤”¨­ˆ­(rs2.PayerFIID):c, gSumD:c, ®«ãç¨âìŠ®¤”¨­ˆ­(rs2.ReceiverFIID):c, gSumK:c);	  
         [ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];	  
         count = 0;
         gSumK = gSumD = 0;
      end;
      count = count + 1;

      PrintLineCarryRep(rs2, count, first);
      PayerFIID = rs2.PayerFIID;
      ReceiverFIID = rs2.ReceiverFIID;
   end;
   
   if ((count != 0))
      [³      ³      ˆâ®£®                  ³########³#########³                             ³##########³#############³]
      (®«ãç¨âìŠ®¤”¨­ˆ­(PayerFIID):c, gSumD:c, ®«ãç¨âìŠ®¤”¨­ˆ­(ReceiverFIID):c, gSumK:c);	  
      [ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];	  
      count = 0;
      gSumK = gSumD = 0;
   end;

   [  Ž¯¥à æ¨®­¨áâ:     #### #########](goper,gOperName);

END;


// ‚ë¢®¤ à¥¥áâà 
PRIVATE MACRO ShowRegisterForFilial()
   var  RS4, cmd2, Chapter,
        flagNoRecords = true;

   cmd2 = RSDCommand(" select distinct OD.T_CHAPTER from DPRCOPRDOCS_DBT OD, DPRCSRVDOC_DBT SD " +
                      " where OD.T_DOCID = SD.T_DOCID and SD.T_SERVICEID = ? " +
                      " and (OD.T_PAYERDEPARTMENT = ? or OD.T_RECEIVERDEPARTMENT = ?)"); 
   cmd2.addParam( "", RSDBP_IN, gServiceID );
   cmd2.addParam( "", RSDBP_IN, gDepID );
   cmd2.addParam( "", RSDBP_IN, gDepID );
   cmd2.execute();
   RS4 = TRsbDataSet(cmd2);

   while ( RS4.movenext() )
      flagNoRecords = false;
      [ ];
      [                   ###################################### ](gDepName);         
      [ ];
      [                                      ……‘’];

      if (gOpKind == 4521 )
         [        ¤®ªã¬¥­â®¢ ¯® ®¯¥à æ¨¨ " ç¨á«¥­¨¥ ¯à®æ¥­â®¢" §  ¤ âã ##########](Date(gOperDate):c);
      else
         [        ¤®ªã¬¥­â®¢ ¯® ®¯¥à æ¨¨ "Ž¯« â  ¯à®æ¥­â®¢" §  ¤ âã ##########](Date(gOperDate):c);
      end;
         
      [ ];
      gChapter = RS4.t_chapter;
      if (gChapter == 1)
         [  ® £« ¢¥:  1   « ­á®¢ë¥ áç¥â  ];
      else 
         [  ® £« ¢¥:  3  ‚­¥¡ « ­á®¢ë¥ áç¥â  ];
      end;
         
      [ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
      [³ ü    ³           ‘çñâ              ³ ‚ «îâ  ³  ‘ã¬¬   ³           ‘çñâ              ³  ‚ «îâ   ³   ‘ã¬¬      ³];
      [³ ¤®ª. ³            „â               ³   „â   ³    „â   ³            Šâ               ³    Šâ    ³     Šâ      ³];
      PrintLinesCarry();	  
   end;
   
   if (flagNoRecords)         
      [                   ###################################### ](gDepName);                        
      [ ];                                                                                           
      [                          ……‘’];                                                            
                                                                                                     
      if (gOpKind == 4521 )                                                                          
         [     ¤®ªã¬¥­â®¢ ¯® ®¯¥à æ¨¨ " ç¨á«¥­¨¥ ¯à®æ¥­â®¢" §  ¤ âã ##########](Date(gOperDate):c); 
      else                                                                                           
         [     ¤®ªã¬¥­â®¢ ¯® ®¯¥à æ¨¨ "Ž¯« â  ¯à®æ¥­â®¢" §  ¤ âã ##########](Date(gOperDate):c);     
      end;                                                                                           
                                                                                                     
      [ ];                                                                      
      [     ¥â áä®à¬¨à®¢ ­­ëå ¤®ªã¬¥­â®¢ ];
   end;
                                              	
END;
                                                                      
 
// ®¤ª çª  ¯®«¥© § £®«®¢ª 
PRIVATE MACRO PumpFieldsForCarryHead()
                                                             
   gOper = {oper};
   gOperName = {Name_Oper};
   PumpDepNamePartyID();

END;


// ƒ« ¢­ ï äã­ªæ¨ï ¢ë§®¢  à¥¥áâà  ¤®ªã¬¥­â®¢
MACRO MpcRegisterSrvReport (oper, OpDate, PartyIDDep, ServiceID, OpKind )
	var rs,cmd;

   goper = oper; 
   gOperDate = OpDate; 
   gPartyIDDep = PartyIDDep;
   gServiceID = ServiceID;
   gOpKind = OpKind;

   if (gPartyIDDep > 0)
      PumpDepID();
      PumpFieldsForCarryHead();       
      ShowRegisterForFilial();
      
   else
      cmd = RSDCommand ("select t_code, t_partyid from ddp_dep_dbt where t_nodetype = 1");
      cmd.execute();
      RS = TRsbDataSet(cmd);
      while( RS.movenext())
         gDepID = RS.code;
         gPartyIDDep = RS.PartyID;      
         PumpFieldsForCarryHead(); 
         ShowRegisterForFilial();  
      end;
   end;      

END;                                                          

