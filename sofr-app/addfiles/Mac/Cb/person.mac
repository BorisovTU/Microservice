/*---------------------------------------------------------------------------\
|                       Файл    person.mac                                   |
|                     Проверка операциониста                                 |
\---------------------------------------------------------------------------*/

import  BankInter, "party.mac", cb_SQL;

record Операционист(person);
record СтарыйОперационист(person);


macro PrintHeader()
[┌────────────────────────────────────────────────────────────────────────┐
 │               Проверка на удаление операциониста #####                 │
 │                                                                        │
]
(Операционист.Oper);
end;

macro PrintFooting()
[└───────────────────────────────────────────────────┴────────────────────┘];
end;

macro PrintHeaderAccount()
[├────────────────────────────────────────────────────────────────────────┤
 │                    Рублевые счета операциониста                        │
 ├──────────────┬────────────────────────────┬────────────────────────────┤];
end;

macro PrintHeaderAccountC()
[├──────────────┴────────────────────────────┴────────────────────────────┤
 │                    Валютные счета операциониста                        │
 ├──────────────┬────────────────────────────┬────────────────────────────┤];
end;

macro PrintHeaderClient()
[├──────────────┴────────────────────────────┴────────────────────────────┤
 │                        Клиенты операциониста                           │
 ├───────────────────────────────────────────────────┬────────────────────┤];
end;

macro PrintСчета( rs )
[│ Глава: ##### │ Счет: #################### │ (#)                        │]
(rs.value(0), rs.value(1), rs.value(2));
end;

macro PrintClient( rs )
[│ Код клиента: #################################### │ Вид обслуж: #####  │
]
( rs.value(0), rs.value(1));
end;

/* Вывод отчета */
macro ПоказОтчета(TxtFileName)
  file outfile() txt;

  if(open(outfile, TxtFileName))
    ViewFile(outfile);
    close(outfile);
  end;
end;

/* Проверка операциониста перед удалением */
macro ПроверитьОперационистаПередУдалением()
  var stat = 1;
  var retval = 0;
  var rs : RsdRecordset;
  var SqlString : string;

  PrintHeader();

  /* Проверяем счета */
  PrintHeaderAccount();

  SqlString =             " SELECT t_chapter, t_account, t_open_close ";
  SqlString = SqlString + " FROM daccount_dbt ";
  SqlString = SqlString + " WHERE t_oper = " + String( Операционист.Oper );
  SqlString = SqlString + " ORDER BY t_open_close, t_chapter, t_account; ";
  
  rs = RsdRecordset( SqlString );

  while( rs.moveNext() )
    retval = 1;
    PrintСчета( rs );
  end;
  
  /* Проверяем клиента */
  PrintHeaderClient();

  SqlString =             " SELECT p.t_code, c.t_servicekind ";
  SqlString = SqlString + " FROM dclient_dbt c ";
  SqlString = SqlString + " JOIN dpartcode_dbt p ";
  SqlString = SqlString + " ON p.t_partyid = c.t_partyid AND p.t_codekind = 1 ";
  SqlString = SqlString + " WHERE c.t_oper = " + String( Операционист.Oper );
  SqlString = SqlString + " ORDER BY p.t_code, c.t_servicekind; ";
  
  rs = RsdRecordset( SqlString );

  while( rs.moveNext() )
    retval = 1;
    PrintClient( rs );
  end;

  PrintFooting();
  
  return retval;
end;

macro ПроверитьОперациониста(Режим)
  var retval = 0, err;
  var txtDir, TxtFileName;
  
  GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR",
                   V_STRING, txtDir, err);
  TxtFileName = txtDir + "\\deloper." + String(UserNumber);
  /* Режимы проверки:
   PT_DEL  - удаление операциониста
   PT_INS  - ввод операциониста
   PT_EDIT - корректировка операциониста
   Возвращаемые значения:
   0 - разрешить операцию
   1 - запретить операцию
  */
  if(Режим == PT_DEL) /* удаление */
    SetOutput(TxtFileName);
    retval = ПроверитьОперационистаПередУдалением();
    SetOutput();
    if(retval)
      ПоказОтчета(TxtFileName);
      if(GetTrue(true, "Удалить операциониста?"))
        retval = 0;
      end;
    end;
  elif(Режим == PT_INS)  /* ввод */
  elif(Режим == PT_EDIT) /* корректировка */
  end;
  return retval;
end;