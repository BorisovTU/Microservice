/*
    Информирование о необработанных документах
    Картотека корр. счета -- CBINF CaRdFile

            Mikhailov S., 28.08.2001, Tue

    
*/

import cbinfcom;
import cbinfint;
import RSD;

private const  RM_PMOUTDOC    = 310;   /* Начальный платеж АРМ*/


/*__________________________________*/
macro CBINF_Proc( RegPath, OutType/*CBINF_Out...*/ )
    var this_stat, nmbRec = 0, cmd, rs;
    var IsOurDoc;
    
    file pmprop( pmprop ) key 0;

    CBINF_ErrorStatus = 0;
    CBINF_Result = 0;
    
    

    if( OutType == CBINF_OutReport )
        if( PrintHeader( RegPath, LIST_CARDFILE ) )
            return CBINF_StatusError;
        end;
    end;

/*    rewind ( pmprop );
  */  

        InitProgress( NRecords(pmprop), "Информирование о необработанных документах", "Картотека корр. счета" );
        
/*    while( next( pmprop ) )
  */
    cmd = RSDCommand("select t.T_PaymentID" +
                      " from dpmprop_dbt t " +
                      " where t.T_PropStatus = " + PM_PROP_CARDFILE );
    rs = RsdRecordset( cmd );           
    cmd.execute;

    while (rs.MoveNext)

            nmbRec = nmbRec + 1;
            UseProgress( nmbRec );
            
/*            if( pmprop.PropStatus == PM_PROP_CARDFILE )*/

                this_stat = IsOperDoc( IsOurDoc, rs.value(0), RM_PMOUTDOC, OutType );
                if( this_stat )
                        RemProgress( nmbRec );
                        return this_stat;
                end;

                if( IsOurDoc )        
                
                pmprop.PaymentID = rs.value(0);

                if( OutType == CBINF_OutMsg )
                
                    this_stat = MsgDocFound( RegPath, CBINF_CARDFILE, pmprop );
                    if( this_stat )
                                RemProgress( nmbRec );
                        return this_stat;
                    end;
                    
                elif( OutType == CBINF_OutReport )
                    this_stat = PrintLine( RegPath, CBINF_CARDFILE, pmprop );
                    if( this_stat )
                                RemProgress( nmbRec );
                        return this_stat;
                    end;
                    
                end;/*OutType*/
                
                end;/*IsOurDoc*/
                
/*            end;if pmprop.PropStatus */
            
        
    end;/*while*/


    RemProgress( nmbRec );

/**/
    if( OutType == CBINF_OutReport )
        if( PrintFooter( RegPath, LIST_CARDFILE ) )
            return CBINF_StatusError;
        end;
    end;


    return CBINF_StatusOk;
    
end;/*CBINF_Proc*/

/*test call
const REGPATH = "COMMON\\CBINFPARMS";
var ret;

ret = CBINF_Proc( REGPATH, CBINF_OutReport);

msgbox( "test : stat =  ", ret , " CBINF_Result = ", CBINF_Result );
*/



