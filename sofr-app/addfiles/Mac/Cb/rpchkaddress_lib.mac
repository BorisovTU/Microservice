/*
$Name:           rpchkaddress_lib.mac
$Module:         Ÿ¤à® ƒŠ
$Description:    ¨¡«¨®â¥ª  äã­ªæ¨© ¤«ï ¯à®æ¥¤ãàë ¯à®¢¥àª¨  ¤à¥á®¢ ¯® ”ˆ€‘
*/

private const english_char = "AaBCcEeğñHKkMmOoPpTuXxYybDdFfGghIiJjLlnQqRrSstUVvWwZz!@#$%^&*=+ü;:?\"\\/|`~[]{}<>";
private const russian_char = "€€‚‘‘…………ŠŠŒ’’ˆ••““                                                       ";

private const english_abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
private const russian_abc = "€‚ƒ„…ğ†‡ˆ‰Š‹Œ‘’“”•–—˜™œ›šŸ";
private const digit_abc   = "0123456789";

private const english_char_kladr = "AaBCcEeHKkMmnOoPpTuXx\\";
private const russian_char_kladr = "€ ‚‘á…¥ŠªŒ¬¯®à’¨•å/";

const 
  hCode      = 1
 ,hName      = 2
 ,hNameLight = 3
 ,hType      = 4
 ,hTypeLight = 5
 ,hNotUse    = 6
 ,hDelete    = 7

 ,hLast      = 8;

const
  lRegion   = 1
 ,lProvince = 2
 ,lDistrict = 3
 ,lPlace    = 4
 ,lPlan     = 5
 ,lStreet   = 6
 ,lHouse    = 7;

class TKladrObject
  var
    m_Name
   ,m_Socr
   ,m_Code
   ,m_Guid
   ,m_Index
   ,m_Okato
   ,m_Oktmo
   ,m_Status
   ,m_Korp
   ,m_Build;

  m_Name = "";
  m_Socr = "";
  m_Code = "";
  m_Guid = "";
  m_Index = "";
  m_Okato = "";
  m_Oktmo = "";
  m_Status = 0;
  m_Korp = "";
  m_Build = "";

end;

macro hInitStrFlag(StrFlag : @string)
  var i = 1;
  StrFlag = "";
  while(i < hLast)
    StrFlag = StrFlag + "0";
    i = i + 1;
  end;
end;

macro hGetStrFlag(StrFlag : string, hFlag : integer) : bool
  var Flag = false;
  if(substr(StrFlag, hFlag, 1) == "X")
    Flag = true;
  end;
  return Flag;
end;

macro hSetStrFlag(StrFlag : @string, hFlag : integer, vFlag : bool)
  var i = 1;
  var NewStr = "";
  var mLen = strlen(StrFlag);
  while(i <= mLen)
    if(i == hFlag)
      if(vFlag)
        NewStr = NewStr + "X";
      else
        NewStr = NewStr + "0";
      end;
    else
      NewStr = NewStr + substr(StrFlag, i, 1);
    end;
    i = i + 1;
  end;
  StrFlag = NewStr;
end;

macro normalize_str( oldstr )
  var newstr, i, retstr; 
  newstr = oldstr;
  retstr = "";
  
  i = 0;
  while( i < strlen(english_char))
    i = i + 1;
    newstr = strsubst(newstr, substr(english_char, i, 1), substr(russian_char, i, 1));
  end;
  newstr = trim( newstr );
  newstr = strupr( newstr );

  i = 0;
  while( i < strlen(newstr))
    i = i + 1;
    if( ( codefor(substr(newstr, i, 1)) != 32 ) or ( codefor(substr(newstr, i - 1, 1)) != 32))
      retstr = retstr + substr(newstr, i, 1);
    end;
  end;
  return retstr;
end;

macro trimspace_str( oldstr )
  var newstr, i, retstr; 
  newstr = oldstr;
  retstr = "";
  newstr = trim( newstr );
  
  i = 0;
  while( i < strlen(newstr))
    i = i + 1;
    if( ( codefor(substr(newstr, i, 1)) != 32 ) or ( codefor(substr(newstr, i - 1, 1)) != 32))
      retstr = retstr + substr(newstr, i, 1);
    end;
  end;
  return retstr;
end;

macro trimallspace_str( oldstr )
  var newstr, i, retstr; 
  newstr = oldstr;
  retstr = "";
  newstr = trim( newstr );
  
  i = 0;
  while( i < strlen(newstr))
    i = i + 1;
    if( codefor(substr(newstr, i, 1)) != 32 )
      retstr = retstr + substr(newstr, i, 1);
    end;
  end;
  return retstr;
end;

macro islower(symbol) : bool
  if((index(strlwr(english_abc), symbol) != 0) or (index(strlwr(russian_abc), symbol) != 0))
    return true;
  end;
  return false;
end;

macro isupper(symbol) : bool
  if((index(strupr(english_abc), symbol) != 0) or (index(strupr(russian_abc), symbol) != 0))
    return true;
  end;
  return false;
end;

macro isdigit(symbol) : bool
  if(index(digit_abc, symbol) != 0)
    return true;
  end;
  return false;
end;

macro isodd(number : integer)
  if(mod(number, 2) != 0)
    return true;
  end;
  return false;
end;

macro iseven(number : integer)
  if(mod(number, 2) == 0)
    return true;
  end;
  return false;
end;

macro isalpha(symbol) : bool
  if(islower(symbol) or isupper(symbol))
    return true;
  end;
  return false;
end;

macro normalize_str_kladr( oldstr : string )
  var newstr : string;
  var retstr : string; 
  var i : integer;
  newstr = oldstr;
  retstr = "";
  
  i = 0;
  while( i < strlen(english_char_kladr))
    i = i + 1;
    newstr = strsubst(newstr, substr(english_char_kladr, i, 1), substr(russian_char_kladr, i, 1));
  end;

  i = 0;
  while( i < strlen(newstr))
    i = i + 1;
    if(   isalpha(substr(newstr, i, 1)) 
       or isdigit(substr(newstr, i, 1)) 
       or (substr(newstr, i, 1) == "/")
       or (substr(newstr, i, 1) == ".")
       or (substr(newstr, i, 1) == "_")
      )
      retstr = retstr + substr(newstr, i, 1);
    else
      retstr = retstr + " ";
    end;
  end;
  newstr = trim(retstr);
  
  if(strlen(newstr) > 1)
    retstr = "";
    i = 0;
    while( i < strlen(newstr))
      i = i + 1;
      if((substr(newstr, i, 1) != " ") or (substr(newstr, i - 1, 1) != " "))
        retstr = retstr + substr(newstr, i, 1);
      end;
    end;
    newstr = trim(retstr);
  end;

  if(strlen(newstr) > 1)
    retstr = "";
    i = 0;
    while( i < strlen(newstr))
      i = i + 1;
      if(not (    (substr(newstr, i, 1) == " ")
              and (   (substr(newstr, i - 1, 1) == "/")
                   or (substr(newstr, i + 1, 1) == "/")
                   or (substr(newstr, i - 1, 1) == ".")
                   or (substr(newstr, i + 1, 1) == ".")
                   or (substr(newstr, i - 1, 1) == "_")
                   or (substr(newstr, i + 1, 1) == "_")
                  )
             )
        )
        retstr = retstr + substr(newstr, i, 1);
      end;
    end;
    newstr = trim(retstr);
  end;

  retstr = "";
  i = 0;
  while( i < strlen(newstr))
    i = i + 1;
    if(substr(newstr, i, 1) != ".")
      retstr = retstr + substr(newstr, i, 1);
    end;
  end;

  newstr = trim(retstr);
  
  if(strlen(newstr) > 1)
    retstr = "";
    i = 0;
    while( i < strlen(newstr))
      i = i + 1;
      if(not (    (substr(newstr, i, 1) == "_" )
              and isdigit(substr(newstr, i - 1, 1)) 
              and isalpha(substr(newstr, i + 1, 1))
             )
        )
        retstr = retstr + substr(newstr, i, 1);
      end;
    end;
    newstr = trim(retstr);
  end;
  
  return newstr;
end;

