import "globals.mac";
import CTInter, "pt_lib.mac", PTInter;

const LastNameStr     = "Фамилия";
const NameStr         = "Имя";
const PatronymicStr   = "Отчество";
const BirthDateStr    = "Дата рождения";
const AddressStr      = "Юридический адрес";
const ResidentStr     = "Резидентность";
const IdentityCardStr = "Документ, удостоверяющий личность";
const PensionCardStr  = "Пенсионное удостоверение";
const INNStr          = "ИНН";
const OGRNStr         = "ОГРН";
const RegistrationStr = "Данные регистрации";
const FullNameStr     = "Полное наименование";
const ShortNameStr    = "Краткое наименование";


private var IsEmptyRep = true;

var PTDUPPRMArray = TArray;

macro RepDoublerHeader()
[                           Поиск субъектов-дублеров                        ];
[                                                                           ];
[              Дата и время начала поиска : ########## ########             ]({curdate},time);
[                                                                           ];
end;


macro RepDoubler(PtDup, RslParm)

  record dup(PTDUPPRM);  
  SetBuff( dup, PtDup );
  record parm("REPDUPPRM.REC");
  SetBuff( parm, RslParm );

  IsEmptyRep = false;

if( dup.PartyType == 1) /* юридические лица */ 
[                                                                           ];
[                                                                           ];
[┌────────────────┬────────────────────────────┬───────────────────────────┐];
[│ Код субъекта:  │ ########################## │ ######################### │](parm.Code1:w,  parm.Code2:w);
[├────────────────┴────────────────────────────┴───────────────────────────┤];
[│ Тип субъектов: ######################################################## │]("юридические лица");
[│ Набор параметров: ##################################################### │](parm.ParmList:w);
[│ Процент совпадения: ################                                    │](parm.Coincindence);
[├────────────────┬────────────────────────────┬───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](FullNameStr:w,  parm.FullName1:w,  parm.FullName2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](ShortNameStr:w, parm.ShortName1:w, parm.ShortName2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](AddressStr:w,   parm.Address1:w,   parm.Address2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](ResidentStr:w,  parm.Resident1:w,  parm.Resident2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](INNStr:w,       parm.INN1:w,       parm.INN2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](OGRNStr:w,      parm.OGRN1:w,      parm.OGRN2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](RegistrationStr:w, parm.Registration1:w, parm.Registration2:w);
[└────────────────┴────────────────────────────┴───────────────────────────┘];
end;

if( dup.PartyType == 2) /* физические лица */  
[                                                                           ];
[                                                                           ];
[┌────────────────┬────────────────────────────┬───────────────────────────┐];
[│ Код субъекта:  │ ########################## │ ######################### │](parm.Code1:w,  parm.Code2:w);
[├────────────────┴────────────────────────────┴───────────────────────────┤];
[│ Тип субъектов: ######################################################## │]("физические лица");
[│ Набор параметров: ##################################################### │](parm.ParmList:w);
[│ Процент совпадения: ################                                    │](parm.Coincindence);
[├────────────────┬────────────────────────────┬───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](LastNameStr:w,  parm.LastName1:w,  parm.LastName2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](NameStr:w, parm.Name1:w, parm.Name2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](PatronymicStr:w,parm.Patronymic1:w,parm.Patronymic2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](BirthDateStr:w, parm.BirthDate1:w, parm.BirthDate2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](AddressStr:w,   parm.Address1:w,   parm.Address2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](ResidentStr:w,  parm.Resident1:w,  parm.Resident2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](IdentityCardStr:w, parm.IdentityCard1:w, parm.IdentityCard2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](PensionCardStr:w, parm.PensionCard1:w, parm.PensionCard2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](INNStr:w,         parm.INN1:w,         parm.INN2:w);
[└────────────────┴────────────────────────────┴───────────────────────────┘];
end;                                                                            

if( dup.PartyType == 3) /* физические лицо - педпрениматель */  
[                                                                           ];
[                                                                           ];
[┌────────────────┬────────────────────────────┬───────────────────────────┐];
[│ Код субъекта:  │ ########################## │ ######################### │](parm.Code1:w,  parm.Code2:w);
[├────────────────┴────────────────────────────┴───────────────────────────┤];
[│ Тип субъектов: ######################################################## │]("физические лица - педпрениматель");
[│ Набор параметров: ##################################################### │](parm.ParmList:w);
[│ Процент совпадения: ################                                    │](parm.Coincindence);
[├────────────────┬────────────────────────────┬───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](LastNameStr:w,  parm.LastName1:w,  parm.LastName2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](NameStr:w, parm.Name1:w, parm.Name2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](PatronymicStr:w,parm.Patronymic1:w,parm.Patronymic2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](BirthDateStr:w, parm.BirthDate1:w, parm.BirthDate2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](AddressStr:w,   parm.Address1:w,   parm.Address2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](ResidentStr:w,  parm.Resident1:w,  parm.Resident2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](IdentityCardStr:w, parm.IdentityCard1:w, parm.IdentityCard2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](PensionCardStr:w, parm.PensionCard1:w, parm.PensionCard2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](INNStr:w,       parm.INN1:w,      parm.INN2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](OGRNStr:w,      parm.OGRN1:w,      parm.OGRN2:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](RegistrationStr:w, parm.Registration1:w, parm.Registration2:w);
[└────────────────┴────────────────────────────┴───────────────────────────┘];
end;                                                                            
                                                                           
end;

MACRO PrmArrayONAdd( PrmID )
  PTDUPPRMArray[PTDUPPRMArray.size] = PrmID;
end;

PRIVATE MACRO IsOnPrm( PrmID )
  var iprm = 0;
  while ( iprm < PTDUPPRMArray.size )
    if (PTDUPPRMArray[iprm] == PrmID)
      return true;
    end;
    iprm = iprm + 1;
  end;
  return false;
end;

/**
 @brief Сформировать запись в отчет по дублированию BIQ-10268
 @param[in] Субъект Объект RsbParty по которому осуществляется поиск дубликата
 @param[in] СубъектДуб Объект RsbParty являющийся дубликатом
 @param[in] ParamSetID ID набора параметров по котором был осуществлен поиск дублера

 Сформировать запись в отчет по дублированию BIQ-10268 по входящим субъектам 
*/
macro RepDoublerCDI(Субъект, СубъектДуб, ParamSetID)
  IsEmptyRep = false;

  /**
   @brief Получить строку не/резидент субъекта
   @param[in] IsNotResident Флаг не резидента
   @return Не резидент если флаг IsNotResident == истина
   @return Резидент если флаг IsNotResident != истина

   Получить строку не/резидент субъекта
  */
  private macro GetResident(IsNotResident)
    if (IsNotResident)
      return "Не резидент";
    end;
    return "Резидент";
  end;

  private macro GetPartyTypeCDI(pParamSetID)
    var cmd, DS, PartyTypeCDI = "";
    
    cmd = RSDCommand( " select case when T_PARTYTYPE = 4 then 'ЮЛ резидент ' " +
                      "             when T_PARTYTYPE = 5 then 'ЮЛ нерезидент ' " +
                      "             when T_PARTYTYPE = 6 then 'ИП  ' " +
                      "             when T_PARTYTYPE = 7 then 'ФЛЧП ' " +
                      " else '' end PartyType" +
                      "  from DPTDUPPRM_DBT where T_PARAMSETID = ? ");

    cmd.addParam( "", RSDBP_IN, pParamSetID );
    cmd.execute();

    DS = TRsbDataSet(cmd);

    if (DS.MoveNext()) 
      PartyTypeCDI = DS.PartyType;
    end;

    return PartyTypeCDI;
  end;

  /**
   @brief Получить ОКОПФ
   @param[in] PartyID Идентификатор субъекта
   @return ОКОПФ

   Получить ОКОПФ по идентификатору субъекта
  */
  private macro getOKOPF (PartyID)
    var cmd, DS, OKOPF = "";
    
    cmd = RSDCommand( " select a.t_nameobject from  dobjatcor_dbt c " +
                      "  inner join DOBJATTR_DBT a " +
                      "  on a.t_groupid = c.t_groupid and  a.t_attrid = c.t_attrid  and  a.t_objecttype = c.t_objecttype " +
                      "  where a.t_objecttype = 3 " +
                      "  and a.t_groupid = 53 and c.t_object = lpad(?, 10, '0') and  c.t_validfromdate<=? And c.t_validtodate>?");

    cmd.addParam( "", RSDBP_IN, PartyID );
    cmd.addParam( "", RSDBP_IN, {Curdate} );
    cmd.addParam( "", RSDBP_IN, {Curdate} );
    cmd.execute();

    DS = TRsbDataSet(cmd);

    if (DS.MoveNext()) 
      OKOPF = DS.nameobject;
    end;

    return OKOPF;
  end;

  /**
   @brief Получить строку параметров поиска дублера
   @param[in] pParamSetID Идентификатор набора параметров
   @return Строка параметров поиска дублера

   Получить строку параметров поиска дублера 
   по идентификатору набора параметров
  */
  private macro getParmStr (pParamSetID)
    var cmd, DS, ParmStr = "";
    
    cmd = RSDCommand( " select case when T_LASTNAME = 'X' then ' Фамилия' else '' end || " +
                      "        case when T_NAME = 'X' then ' Имя' else '' end || " +
                      "        case when T_PATRONYMIC = 'X' then ' Отчество' else '' end || " +
                      "        case when T_BIRTHDATE = 'X' then ' Дата рождения' else '' end || " +
                      "        case when T_ADDRESS = 'X' then ' Юридический адрес' else '' end || " +
                      "        case when T_IDENTITYCARD = 'X' then ' Документ, удостоверяющий личность' else '' end || " +
                      "        case when T_PENSIONCARD = 'X' then ' Пенсионное удостоверение ' else '' end || " +
                      "        case when T_INN = 'X' then ' ИНН' else '' end || " +
                      "        case when T_OGRN = 'X' then ' ОГРН' else '' end || " +
                      "        case when T_REGISTRATION = 'X' then ' Данные регистрации' else '' end || " +
                      "        case when T_FULLNAME = 'X' then ' Полное наименование' else '' end || " +
                      "        case when T_SHORTNAME = 'X' then ' Краткое наименование' else '' end || " +
                      "        case when T_KIO = 'X' then ' КИО' else '' end || " +
                      "        case when T_OKOPF = 'X' then ' ОКОПФ' else '' end || " +
                      "        case when T_OKPO = 'X' then ' ОКПО' else '' end as ParmStr " +
                      "  from DPTDUPPRM_DBT where T_PARAMSETID = ? ");

    cmd.addParam( "", RSDBP_IN, pParamSetID );
    cmd.execute();

    DS = TRsbDataSet(cmd);

    if (DS.MoveNext()) 
      ParmStr = DS.ParmStr;
    end;

    return ParmStr;
  end;

if( Субъект.LegalForm == 1 ) /* юридические лица */ 
[                                                                           ];
[                                                                           ];
[┌────────────────┬────────────────────────────┬───────────────────────────┐];
[│ Код субъекта:  │ ########################## │ ######################### │](Субъект.code.GetCode(PTCK_CLIENT):w,                     СубъектДуб.code.GetCode(PTCK_CLIENT):w);
[├────────────────┴────────────────────────────┴───────────────────────────┤];
[│ Тип субъектов: ######################################################## │](GetPartyTypeCDI(ParamSetID):w);
[│ Набор параметров: ##################################################### │](getParmStr(ParamSetID):w);
[├────────────────┬────────────────────────────┬───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](FullNameStr:w,  Субъект.FullName:w,                      СубъектДуб.FullName:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](AddressStr:w,   Субъект.Address(1).Address:w,            СубъектДуб.Address(1).Address:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](ResidentStr:w,  GetResident(Субъект.IsNotResident()):w,  GetResident(СубъектДуб.IsNotResident()):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](INNStr:w,       Субъект.code.GetCode(PTCK_INN):w,        СубъектДуб.code.GetCode(PTCK_INN):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](OGRNStr:w,      Субъект.code.GetCode(PTCK_OGRN):w,       СубъектДуб.code.GetCode(PTCK_OGRN):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │]("ОКПО":w,       Субъект.OKPO:w,                          СубъектДуб.OKPO:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │]("ОКОПФ":w,      getOKOPF(Субъект.PartyID):w,             getOKOPF(СубъектДуб.PartyID):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │]("КИО",          Субъект.code.GetCode(62/*КИО*/):w,       СубъектДуб.code.GetCode(62/*КИО*/):w);
[└────────────────┴────────────────────────────┴───────────────────────────┘];
end;

if( Субъект.LegalForm != 1 ) /* физические лица */  
[                                                                           ];
[                                                                           ];
[┌────────────────┬────────────────────────────┬───────────────────────────┐];
[│ Код субъекта:  │ ########################## │ ######################### │](Субъект.code.GetCode(PTCK_CLIENT):w,                      СубъектДуб.code.GetCode(PTCK_CLIENT):w);
[├────────────────┴────────────────────────────┴───────────────────────────┤];
[│ Тип субъектов: ######################################################## │](GetPartyTypeCDI(ParamSetID):w);
[│ Набор параметров: ##################################################### │](getParmStr(ParamSetID):w);
[├────────────────┬────────────────────────────┬───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](NameStr:w,      Субъект.FullName:w,                       СубъектДуб.FullName:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](AddressStr:w,   Субъект.Address(1).Address:w,             СубъектДуб.Address(1).Address:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](ResidentStr:w,  GetResident(Субъект.IsNotResident()):w,   GetResident(СубъектДуб.IsNotResident()):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](INNStr:w,       Субъект.code.GetCode(PTCK_INN):w,         СубъектДуб.code.GetCode(PTCK_INN):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │](OGRNStr:w,      Субъект.code.GetCode(PTCK_OGRN):w,        СубъектДуб.code.GetCode(PTCK_OGRN):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │]("ОКПО":w,       Субъект.OKPO:w,                           СубъектДуб.OKPO:w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │]("ОКОПФ":w,      getOKOPF(Субъект.PartyID):w,              getOKOPF(СубъектДуб.PartyID):w);
[├────────────────┼────────────────────────────┼───────────────────────────┤];
[│ ############## │ ########################## │ ######################### │]("КИО",          Субъект.code.GetCode(62/*КИО*/):w,        СубъектДуб.code.GetCode(62/*КИО*/):w);
[└────────────────┴────────────────────────────┴───────────────────────────┘];
end; 

END;

/**
 @brief Проверка дублирования по BIQ-10268

 Проверка дублирования по параметрам добавленным в BIQ-10268
*/
PRIVATE MACRO DupForCDI()

private macro getCDISubType (PartyID)
  var AttrID : integer = 0;

  record party(party);
  party.PartyID = PartyID;

  var Error : integer = 0;
  GetMainObjAttr(Error, OBJTYPE_PARTY, party, 150, AttrID);
  if(Error)
    AttrID = 0;
  end;

  return AttrID;
end;

var NameCat = "", Субъект;
var cmd, PartyList;

cmd = RSDCommand( " SELECT DISTINCT t_PartyID " +
                  "   FROM dpartcode_dbt " +
                  "  WHERE t_code in (SELECT t_Code " +
                  "                    FROM (  SELECT COUNT (1) AS cnt, t_Code " +
                  "                              FROM dpartcode_dbt " +
                  "                             WHERE T_CODEKIND IN (16, 62) " +
                  "                          GROUP BY t_Code) " +
                  "                   WHERE cnt > 1)  " +
                  "        AND T_CODEKIND IN (16, 62) ");
        
cmd.execute();

PartyList = TRsbDataSet(cmd);

var cmdDupPrm, DupPrm, partyType = 0, PartyDubID = -1;

while( PartyList.MoveNext() )
  Субъект = RsbParty(PartyList.PartyID);
  partyType = 0;

  var stat = 0;
    if(Субъект.legalform == 1)
      var INN = "";
      SplitFullINN(ПолучитьКодСубъекта(Субъект.partyid, PTCK_INN, null, 0), INN, NULL);
      var OGRN = ПолучитьКодСубъекта(Субъект.partyid, 27);
      if( (StrLen(INN) > 10) and (StrLen(OGRN) < 2) )
          partyType = 7;
      else
        if( (StrLen(INN) > 10) or (StrLen(OGRN) > 13) )
          partyType = 6;
        else
          if (Субъект.IsNotResident())
            partyType = 5;
          else
            partyType = 4;
          end;
        end;         
      end;
    end;

    if(Субъект.legalform == 2)
      var sqlIE = "SELECT * " +
                  "  FROM (SELECT COUNT (1)     AS cat " +
                  "          FROM dobjatcor_dbt  c " +
                  "               INNER JOIN DOBJATTR_DBT a " +
                  "                   ON     a.t_groupid = c.t_groupid " +
                  "                      AND a.t_attrid = c.t_attrid " +
                  "                      AND a.t_objecttype = c.t_objecttype " +
                  "         WHERE     LPAD (" + Субъект.partyid + ", 10, '0') = c.t_object " +
                  "               AND a.t_objecttype = 3 " +
                  "               AND a.t_groupid = 53 " +
                  "               AND a.t_nameobject LIKE '5 01%'), " +
                  "       (SELECT COUNT (1)     AS employer " +
                  "          FROM dpersn_dbt pers " +
                  "         WHERE pers.t_personid = " + Субъект.partyid + " AND pers.t_isemployer = 'X')";

      var sqlPP = "SELECT COUNT (1) AS cat " +
                  "  FROM dobjatcor_dbt  c " +
                  "       INNER JOIN DOBJATTR_DBT a " +
                  "           ON     a.t_groupid = c.t_groupid " +
                  "              AND a.t_attrid = c.t_attrid " +
                  "              AND a.t_objecttype = c.t_objecttype " +
                  " WHERE     LPAD (" + Субъект.partyid + ", 10, '0') = c.t_object " +
                  "       AND a.t_objecttype = 3 " +
                  "       AND a.t_groupid = 53 " +
                  "       AND a.t_nameobject LIKE '5 02%' ";
      var setCat = false;
      var cmdD = rsdCommand( sqlIE );
      var data = TRsbDataSet(cmdd);
      
      if (data.moveNext())
        if ((data.cat > 0) or (data.employer > 0))
          partyType = 6;
        end;    
      end;
      
      cmdD = rsdCommand( sqlPP );
      data = TRsbDataSet(cmdd);
      if (data.moveNext())
        if (data.cat > 0)
          partyType = 7;
        end;    
      end;
    end;
  
  cmdDupPrm = RSDCommand( "SELECT T_PARAMSETID " +
                          "  FROM DPTDUPPRM_DBT " +
                          " WHERE T_PARTYTYPE = ? AND T_ISACTIVE = 'X' ");
  
  cmdDupPrm.addParam( "", RSDBP_IN, partyType );
  cmdDupPrm.execute();
  DupPrm = TRsbDataSet(cmdDupPrm);
  
  while (DupPrm.MoveNext())
    PartyDubID = -1;
    if(IsOnPrm(DupPrm.PARAMSETID))
      ExecMacroFile("checkDubParty.mac", "checkDubPartyOnCDI", Субъект, DupPrm.PARAMSETID, @PartyDubID );
      if (PartyDubID > 0)
        var СубъектДуб = RsbParty(PartyDubID);
        RepDoublerCDI(Субъект, СубъектДуб, DupPrm.PARAMSETID);
        СубъектДуб = NULL;
      end;
    end;
  end;
  Субъект = NULL;
end;

END;

MACRO RepDoublerFooter()

DupForCDI();

if(IsEmptyRep)
[                           Совпадений не найдено                           ];
end;

END;
