/*
 $Name: ws_xcompl_lib.mac
 $Module: RS-Connect
 $Description: Операция проверки X-Compliance
 */
 /* 
	Операция проверки X-Compliance
 */
import "cb_sql.mac", "globals.mac", rslx, rcw, rsexts;

// Предназначен для описания параметров запроса смежной АС, откуда поступил запрос
class TXCompHeaderInOut
    var SenderID      : String;  // Код смежной системы, присваиваемый ей в рамках работы с RS-Connect
    var MessageID     : String;  // Идентификатор запроса, формируемый в смежной АС, к RS-Connect
    var SenderPointID : Integer; // Идентификатор подразделения ? источника сообщения
end;

// Предназначен для описания параметров запроса смежной АС
class TXCompBodySearchOperationMassIn
    var NeedOldRecs         : String;  // Статус запрошенных записей
    var PackageSize         : String;  // Максимальное количество записей в пакете ответа
    var ObjectID            : String;  // Уникальный идентификатор созданного учетного объекта ? процедура отбора информации в RS-Connect
    var PackageNum          : Integer; // Порядковый номер сообщения ? пакета ответа от RS-Connect
    var CompletedPackageNum : Integer; // Сообщение АС о финале обработки пакета (запроса)
end;

// Предназначен для описания параметров запроса смежной АС, для поиска субъекта.
class TXCompRequestSearchOperationMass
    var QueryPar    : TXCompHeaderInOut; // Описываются параметры смежной АС, откуда поступил Запрос
    var ParamSelect : TXCompBodySearchOperationMassIn; // Параметры запроса к RS-Connect
end;

// Описываются параметры Ответа RS-Connect
class TXCompHeaderMassOut
    var SenderID      : String;  // Входной параметр
    var MessageID     : String;  // Входной параметр
    var SenderPointID : Integer; // Входной параметр
    var ObjectID      : String;  // Уникальный идентификатор созданного учетного объекта ? процедура отбора информации в RS-Connect
    var PackageNum    : String;  // Порядковый номер сообщения ? пакета ответа от RS-Connect
    var PackageCount  : string;  // Общее количество сообщений- пакетов ответов от RS-Connect
end;

// Предназначен для описания ответа
class TXCompInfoLongOut
    var RowID      : String; // ID записи справочника
    var IdentMess  : String; // ID анкеты
    var DateMess   : Date;   // Дата обновления анкеты
    var AttrDel    : String; // Признак удаления анкеты
    var FullName   : String; // Полное имя (ФИО) физического лица
    var LastName   : String; // В текущей версии не используется
    var FirstName  : String; // В текущей версии не используется
    var Patronymic : String; // В текущей версии не используется
    var birthdate  : String; // Дата рождения
    var NameDoc    : String; // Наименование документа, удостоверяющего личность.
    var SeriesDoc  : String; // Серия документа, удостоверяющего личность
    var NumDoc     : String; // Номер документа, удостоверяющего личность 
    var Issue      : String; // Дата выдачи и орган, выдавший документ удостоверяющий личность
    var CodeCat    : string; // Коды категории ПДЛ
    var DescrCat   : string; // Описание категорий ПДЛ
    var Job        : String; // При массовой проверке не заполняется
    var Biography  : string; // Должность физического лица
end;

// Описываются параметры Ответа RS-Connect
class TXCompResponseSearchOperationMass
    var AnswPar      : TXCompHeaderMassOut; // Предназначен для описания ответа
    var ResultSelect : TArray;              // Входной параметр
end;

// Предназначен для описания параметров запроса смежной АС, откуда поступил запрос
class TXCompListDoc
    var SeriesDoc : String; // Серия документа, удостоверяющего личность
    var NumDoc    : String; // Номер документа, удостоверяющего личность
end;

// Предназначен для описания параметров запроса смежной АС, для поиска анкеты субъекта
class TXCompBodySearchOperationIn
    var CL_ID      : String; // ID клиента в АС
    var FullName   : String; // Полное имя (ФИО) физического лица
    var LastName   : String; // В текущей версии не используется
    var FirstName  : String; // В текущей версии не используется
    var Patronymic : String; // В текущей версии не используется
    var birthdate  : Date;   // Дата рождения
    var ListDoc    : TArray; // Список документов субъекта АС
end;

// Предназначен для описания параметров запроса смежной АС, откуда поступил запрос
class TXCompRequestSearchOperation
    var QueryPar  : TXCompHeaderInOut;           // Серия документа, удостоверяющего личность
    var ParSelect : TXCompBodySearchOperationIn; // Номер документа, удостоверяющего личность
end;

// Предназначен для описания ответа
class TXCompOperationInfoShortOut
    var CL_ID      : String; // ID клиента в АС (из запроса)
    var RowID      : String; // ID записи справочника
    var IdentMess  : String; // ID анкеты
    var DateMess   : Date;   // Дата обновления анкеты
    var AttrDel    : String; // Признак удаления анкеты
    var FullName   : String; // Полное имя (ФИО) физического лица
    var LastName   : String; // В текущей версии не используется
    var FirstName  : String; // В текущей версии не используется
    var Patronymic : String; // В текущей версии не используется
    var birthdate  : String; // Дата рождения
    var NameDoc    : String; // Наименование документа, удостоверяющего личность.
    var SeriesDoc  : String; // Серия документа, удостоверяющего личность
    var NumDoc     : String; // Номер документа, удостоверяющего личность 
    var Issue      : String; // Дата выдачи и орган, выдавший документ удостоверяющий личность
    var CodeCat    : string; // Коды категории ПДЛ
    var DescrCat   : string; // Описание категорий ПДЛ
    var Job        : String; // При массовой проверке не заполняется
    var Biography  : string; // Должность физического лица
end;

// Предназначен для описания ответа
class TXCompResponseSearchOperation
    var AnswPar      : TXCompHeaderInOut; // Описываются параметры Ответа RS-Connect
    var SelectResult : TArray;            // Результат обработки запроса
end;

macro IsSetStr(str)
    var result = false;
    if((ValType(str) != V_UNDEF) and (strlen(str) != 0))
        result = true;
    end;
    return result;
end;

macro IsSetDate(dt)
    var result = false;
    if((ValType(dt) == V_DATE) and (dt != ZeroValue(V_DATE)))
        result = true;
    end;
    return result;
end;

macro IsSetInt(i)
    var result = false;
    if(ValType(i) == V_INTEGER)
        result = true;
    end;
    return result;
end;

macro IsSetBool(f)
    var result = false;
    if(ValType(f) == V_BOOL)
        result = true;
    end;
    return result;
end;

macro IsSetArray(f, size : @integer)
    var result = false;
    if(ValType(f) == 15)
        size = asize (f);
        if (size != 0)
            result = true;
        end;
    end;

    if(ValType(f) == 19)
        size = f.size;
        if (size != 0)
            result = true;
        end;
    end;

    return result;
end;

macro AddCondition(sql, condition, pOp)
  var out;
    var op = "AND";
    
    if (Valtype(pOp) != V_UNDEF)
        op = pOp;
    end;
  
  if ((Index(sql, "WHERE") == 0) and (strlen(sql) == 0))
    out = " WHERE " + condition;
  else
    out = sql + " " + op + " " + condition;
  end;
  
  return out;
end;