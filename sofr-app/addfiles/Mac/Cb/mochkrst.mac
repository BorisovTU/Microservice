//-----------------------------------------------------------------------------
// Блок     : 29018 - "Предобработка мемориального документа"
// Шаг      : 10    - "Проверка остатков по счетам"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import pm_chkrst, cbsttls;
import pmsummo;

// Варианты ответов
var Dlg_Ans_Carry   = " Оплатить ";
var Dlg_Ans_InQueue = " В очередь ";
var Dlg_Ans_Reject  = " Отвергнуть ";

const Dlg_Var_Carry   :integer = 0;
const Dlg_Var_InQueue :integer = 1;
const Dlg_Var_Reject  :integer = 2;

//-----------------------------------------------------------------------------
// Выбрать направление движения
//-----------------------------------------------------------------------------
private macro PM_ChooseDirect( Account:string ):integer

  Array Text;
  Array Buttons;
  var DialogFlag = TSetDialogFlag(1);

  var select_button:integer = Dlg_Var_Carry;

  Text(0) = "К корсчету " + Account + " есть неоплаченные документы. Оплатить документ?";
  Buttons(0) = Dlg_Ans_Carry;
  Buttons(1) = Dlg_Ans_InQueue;
  Buttons(2) = Dlg_Ans_Reject;

  select_button = ConfWin( Text, Buttons );
  
  return select_button;
end;

/*macro CheckPIAccountRest( parm:TExecFunPIParm ):integer
  var PaymentObj:object = GenObject( "RsbPayment", parm.pi.rec.PaymentID );

  var Account:string = parm.pi.rec.Account;
  var FIID:integer = parm.pi.rec.FIID;
  var Sum:integer = parm.pi.rec.Amount;
  var MinLimit;
  // Проверить свободный остаток
  var Rest = AccGetFreeAmount( Account, CHAPT1, FIID, PaymentObj.Priority, PaymentObj.ClaimID, {curdate} );

  if( IsLoroAccount(Account, FIID) and GetLimits(Account, FIID, @MinLimit) )
    if( Rest - Sum > MinLimit )
      return 0;
    end;
  else
    if( Rest > Sum )
      return 0;
    end;
  end;

  return 1;
end;*/

private macro MO_CheckPayerAccount(Account, FIID, Amount,Payment:RsbPayment,obj:object):integer
  var RestDebet;
  if( СчетПассивный(Account, obj.Chapter, FIID) and 
      ( not ЕстьПарныйСчет( Account, obj.Chapter, FIID ) ) )
    if( ( not AccGetFreeAmount( RestDebet, NULL, Account, obj.Chapter,FIID, {curdate}, Payment.Priority, Payment.ClaimID ) ) and 
        ( RestDebet < Amount ) )
      if(RejectPayment(Payment, "Недостаточно средств для списания со счёта "+Account))
        return 1; //Ошибка отвержения
      end;
        msgbox( "Недостаточно средств для списания со счёта "+Account);
      return 0; //Успешно отвергли
    end;
  end;
    
  return 2;  //Если не отвергли, т.е. поверка прошла успешно
end;

private macro MO_CheckReceiverAccount( Account, FIID, Amount, Payment:RsbPayment ):integer
  var RestCredit:money,
      Rest:money;
  if( СчетАктивный( Account, Payment.Chapter, FIID ) and (GetOprStatus(OPR_PAYM_INDEX) <= OPR_PAYM_ST_INDEX_NO) and
      ( ( Payment.ToBackOffice == "" ) or ( Payment.NotForBackOffice == "X" ) ))
    if( not CheckReceiverAccount( Account, FIID, Amount, Payment.ValueDate ) )
      if(RejectPayment(Payment, "Недостаточно средств для зачисления"))
        return 1; //Ошибка отвержения
      end;
      msgbox( "Недостаточно средств для зачисления" );
      return 0; //Успешно отвергли
    end;
  end;
  return 2;  //Если не отвергли, т.е. поверка прошла успешно
end;

MACRO MO_CheckAccRest( Payment:RsbPayment ):integer

  var stat = 0;//:integer = PM_CheckAccRestCommon( Payment );
  var obj:object;
  var pmaddpi_rs;
  var ret;
  var RestDebet;
  var RestCredit;
  var Rest;
  var Direct, MinLimit;
  var AllowOverdraft : bool = true;

  //Проверим остаток на счете плательщика  
  stat =  CheckRestAndMakeReserve( Payment, AllowOverdraft, true, true, true, 
                                   NULL, false, true, false, null, null, true, true );
  if(stat)
    return stat;
  end;

  //Проверяем получателя
  if( Payment.PIList(PRT_Credit).Size > 0 ) 
    //Для сводных проверяем все счета разноски  
    var piList:TArray = Payment.PIList(PRT_Credit).asTArray();
    var pi:TRecHandler;
    for( pi, piList )
      if( ( ret = MO_CheckReceiverAccount( pi.rec.Account, pi.rec.FIID, pi.rec.Amount, Payment ) ) != 2 ) 
        return ret;
      end;
    end;
  else
    //Если не сводный или сумма получателя не распределённая (т.е. распределённая сумма у ПЛАТЕЛЬЩИКА - Payment.IsFixPayerAmount==false), 
    //то просто проверим остаток на счете получателя
    if( ( ret = MO_CheckReceiverAccount( Payment.FutureReceiverAccount, Payment.FutureReceiverFIID, Payment.FutureReceiverAmount, Payment ) ) != 2 )
      return ret;
    end;
  end;

  if( УстановитьСтатусыПлатежа( OPR_PAYM_DO, OPR_PM_ST_ENTER, OPR_PAYM_CABS, OPR_PM_ST_MFR_YES ) )
    msgbox("Ошибка при установке сегментов статуса экземпляра операции");
    return 1;
  end;

  return 0;

END;
