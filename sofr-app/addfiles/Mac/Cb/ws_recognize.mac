/*
$Name:        ws_recognize.mac
$Module:      Ядро ГКБО
$Description: Интеграция с ABBYY PassportReader SDK 
*/

import rcw;
import BankInter;
import XmlRpcInter;
import rsexts;

private var engine;

macro GetEngine()
   if (engine == null)
      var engine = ClrObj ("ABBYY.PassportReaderSdk","ABBYY.PassportReaderSdk.RecognitionEngine");
      engine.LogMode = 4;
      if (not engine.Init())
         RunError("Ошибка инициализации объекта ABBYY.PassportReaderSdk. Возможно, отсутствует лицензия.");
      end; 

      engine.WarmUp();

   end;

   return engine;
   OnError(e)
      var err = GenGetProp(e, "AxMes"); 

      RunError(err + " Возможно, не установлен компонент ABBYY PassportReader SDK.");
end;

macro GetFilename()
    var guid = CreateGUID();
     
    var workfile = StrSubst(GetCurDir(false),"\\Obj","\\TxtFile") + "\\" + guid + ".jpg";
    return workfile;  
end;
     
macro Recognize(base64content:string, docType:string)

   var fileName = GetFilename();

   DecodeBase64ToFile(fileName, base64content);

   var result = GetEngine().Recognize(fileName, docType);

   var resultXml = result.GetXml(1,0);
   RemoveFile(fileName);
   return resultXml;
end;
