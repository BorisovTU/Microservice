/*
 $Name: d_r_pan_lib.mac
 $Module: Ядро ГКБО 
 $Description: Списание доходов/расходов
 */
 /*
	Списание доходов/расходов
 */
import FIInter,BankInter, "globals.mac";
var NewOper = true, Depart = 0, Date_Carry = Date(0,0,0);
var BalanceFrom = "", BalanceTo = "", AccountFrom = "", AccountTo = "", CurrencyFrom = ALLFININSTR, CurrencyTo = ALLFININSTR;
array mnuAccount, mnuRestType, mnuDepart, mnuBalance, DepartCode, DepartName;
file Опер( person );
var ServOper = false;
file dep(dp_dep);
record dr(dr_docs ,"userop.def");
file acc("account" ) key 0;
file bal("balance") key 0;
file p(person);
record dpan(RD_DOC ,"userop.lbr") dialog;

const 
  КатегорияДляОтчетности   = 1,
  ВидПДДоходыРасходы       = 5010,
  ВидОперацииДоходыРасходы = 5500;

const
  Входящий = "Входящий"
 ,Исходящий = "Исходящий";

const
  ТипВходящий = 1
 ,ТипИсходящий = 2;

macro Init(dlg_rec)
  var stat;
  ClearRecord(dlg_rec);
  dlg_rec.Date_Oper   = {curdate};
  dlg_rec.Date_Carry  = {curdate} - 1;
  GetRegistryValue("COMMON\\СЕРВИСНЫЕ ПРОЦЕДУРЫ\\ЗАПУСК СЕРВИСНЫХ ПРОЦЕДУР", V_BOOL, ServOper, stat, null, {oper});

  if(({NumDprt} == {OperDprtNode}) and (ServOper)) 
    dlg_rec.Department  = 0;
  else
    dlg_rec.Department  = {OperDprt};
  end;
  dlg_rec.Oper        = {oper};
  dlg_rec.RestDate    = {curdate} - 1;
  dlg_rec.RestType    = Исходящий;
  dlg_rec.BalanceFrom = "";
  dlg_rec.AccountFrom = "";
  dlg_rec.BalanceTo   = "";
  dlg_rec.AccountTo   = "";
  dlg_rec.LastChar1   = "X";
  dlg_rec.LastChar2   = "";
  dlg_rec.IsDepSave   = "X";
  dlg_rec.IsSPOD      = "X";
  dlg_rec.Ground      = "Перенос финансового результата";

  CurrencyFrom = ALLFININSTR; 
  CurrencyTo = ALLFININSTR;
end;

macro CheckNameOper(Oper)
  p.Oper = Oper;
  if(not GetEQ(p))
    return "<Операционист не найден>";
  else
    return p.Name;
  end;
end;

macro CheckNameDepartment(Department)
  if(Department == 0)
    return "Bсе филиалы";
  else
    dep.Code = Department;
    if(not GetEQ(dep))
      return "<Филиал не найден>";
    else
      return dep.Name;
    end;
  end;
end;

macro Read(temp_rec, rec, read_panel)
  ClearRecord(temp_rec);
  temp_rec.Date_Oper   = rec.Date_Oper  ;
  temp_rec.Date_Carry  = rec.Date_Carry ;
  temp_rec.Department  = rec.Department ;
  temp_rec.RestDate    = rec.RestDate   ;
  temp_rec.Oper        = rec.Oper       ;
  temp_rec.BalanceFrom = rec.BalanceFrom;
  temp_rec.BalanceTo   = rec.BalanceTo  ;
  temp_rec.AccountFrom = rec.AccountFrom;
  temp_rec.AccountTo   = rec.AccountTo  ;
  temp_rec.Ground      = rec.Ground     ;
  /*temp_rec.CurrencyFrom= CurrencyFrom   ;
  temp_rec.CurrencyTo  = CurrencyTo     ;*/
 
  if(read_panel)
    if(rec.LastChar1 == "X")
      temp_rec.LastChar = 1;
    elif(rec.LastChar2 == "X")
      temp_rec.LastChar = 2;
    end;

    if(rec.RestType == Входящий)
      temp_rec.RestType = ТипВходящий;
    elif(rec.RestType == Исходящий)
      temp_rec.RestType = ТипИсходящий;
    end;
  else
    if(rec.LastChar = 1)
      temp_rec.LastChar1 = "X";
      temp_rec.LastChar2 = "";
    elif(rec.LastChar = 2)
      temp_rec.LastChar1 = "";
      temp_rec.LastChar2 = "X";
    end;

    if(rec.RestType = ТипВходящий)
      temp_rec.RestType = Входящий;
    elif(rec.RestType = ТипИсходящий)
      temp_rec.RestType = Исходящий;
    end;
  end;
  
  temp_rec.IsDepSave   = rec.IsDepSave  ;
  temp_rec.IsSPOD      = rec.IsSPOD     ;
end;

macro ListAccountBalDprtFrom(dlg) 
  record accRec(account);
  var Balance;
  if((strlen(dlg.BalanceFrom) == 3) or (strlen(dlg.BalanceFrom) == 5))
    Balance = dlg.BalanceFrom + "*";
  end;
  
  if(ListAccount(accRec, 1, ALLFININSTR, dlg.AccountFrom, null, Balance, dlg.Department, true))
    dlg.AccountFrom = accRec.Account;
    CurrencyFrom = accRec.Code_Currency;
    if(dlg.BalanceFrom == "")
      dlg.BalanceFrom = accRec.Balance;
    end;
  end;
end;

macro ListAccountBalDprtTo(dlg) 
  record accRec(account);
  var Balance;
  if((strlen(dlg.BalanceTo) == 3) or (strlen(dlg.BalanceTo) == 5))
    Balance = dlg.BalanceTo + "*";
  end;
  
  if(ListAccount(accRec, 1, ALLFININSTR, dlg.AccountTo, null, Balance, dlg.Department, true))
    CurrencyTo = accRec.Code_Currency;
    dlg.AccountTo = accRec.Account;
  end;
end;

macro InitRestTypeMenu()

  asize(mnuRestType, 0);
  mnuRestType(0) = Исходящий + "          ";
  mnuRestType(1) = Входящий  + "          ";

  return true;
end;

macro InitDepartMenu()
  var i = 0, NullDepart = false;

  i = 1;
  asize(mnuDepart,0);
  asize(DepartCode,0);
  asize(DepartName,0);
  while(next(dep))
    if(dep.Code == 0)
      NullDepart = true;
    end; 
    if((dep.Status == 2) AND (dep.NodeType == 1) )
      mnuDepart(i)  = string(dep.Code) + " - " + dep.Name;
      DepartCode(i) = dep.Code;
      DepartName(i) = dep.Name;
      i = i + 1;
    end;
  end;
  if(not NullDepart)
    mnuDepart(0)  = "0 - Все филиалы";
    DepartCode(0) = 0;
    DepartName(0) = "Все филиалы";
  end;

  return true;
end;

macro InitBalanceMenu()
  var flag = true, i = 0;

  asize(mnuBalance,0);
  bal.Chapter  = 1;
  bal.iNumPlan = 0;
  bal.Balance  = "";
  if(GetGE(bal))    
    while(flag)
      mnuBalance(i) = bal.Balance + "                ";
      i = i + 1;
      flag = next(bal);

      if((bal.Chapter != 1) OR (bal.iNumPlan != 0))
        flag = false;
      end;
    end;
  end;

  return true;
end;

macro InitMenu()
  InitDepartMenu();
  InitBalanceMenu();
  InitRestTypeMenu();

  return true;
end;

macro StdInit(dlg, cmd, id, key)
    if(NewOper)
      if( not InitMenu() )
        return CM_CANCEL;
      end;
      Init(dlg);
      DisableFields(dlg, fldindex(dlg, "IsDepSave"));
    else
      Read(dlg, dr);
    end;
    
    dlg.Department_Name    = CheckNameDepartment(dlg.Department);
    dlg.Oper               = {oper};
    dlg.Oper_Name          = CheckNameOper(dlg.Oper);
      
    if(({NumDprt} != {OperDprtNode}) or (not ServOper))
      DisableFields(dlg, fldindex(dlg, "Department"));
    end;

    UpdateFields(dlg);
end;

