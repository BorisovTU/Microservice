/*
$Name: pdnchklog_xls.mac
$Module: Ядро ГКБО 
$Description: Протокол проверки обработки ПДн
*/

import "CbReport_h.mac";
import "pdnchklog_lib.mac";
//import "global.mac", ptinter, oralib, RsbDataSet, cb_sql, rsd, commonutil, likepy;



private var NumStr        = 1;



PRIVATE CLASS (CB_CReportTemplate) PdnChkReport(_PartyID, _PdnPartyKind)

  var NumTableStr = 0; 

  Var FPrintHead     = true;

  var PartyID       = _PartyID     ;
  var PdnPartyKind  = _PdnPartyKind;

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintHead( IsNotEmpty : bool)
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
//   var NumTableStr = 0; 
   SetActiveSheet( "Общие сведения" );
//   SetNumberPage("Страница ", NumStr);

   PrintHead(FPrintHead);

   RegisterTable( "N1_MainTable", NULL,
                  "dattim" ,
                  "datdat" ,
                  "usr"    ,
                  "usn"    ,
                  "sub"    ,
                  "csd"    
                );

  END;

  PRIVATE MACRO EndReport()
    var RowFrom = 0, RowTo = 0;  
    EndTable();
  END;

                                                                  
  PRIVATE MACRO PrintLine( dattim, datdat, usr, usn, sub, csd )

     PrintTableLine( "dattim"                ,  dattim                ,  null,
                     "datdat"                ,  datdat                ,  null,
                     "usr"                   ,  usr                   ,  null,
                     "usn"                   ,  usn                   ,  null,
                     "sub"                   ,  sub                   ,  null,
                     "csd"                   ,  csd                   ,  null
                   );                                       

  END;

   PRIVATE MACRO PrintCommon()

     var dattim = string(date:f);
     var datdat = string(time:f);
     var usr = string(({oper}));
     var usn = {Name_Oper};
     var sub = GetPartyFieldByID(PartyID);
     var csd = GetPdnPartyKindFieldByID(PdnPartyKind);
     
    PrintLine( dattim, datdat, usr, usn, sub, csd );
  END;

  PRIVATE MACRO Create()
     PrintCommon();
  END;

  initCB_CReportTemplate( null, "pdnchklog.xls" );
END;



PRIVATE CLASS (CB_CReportTemplate) PdnChkBranch_1()

  var NumTableStr = 0; 

  Var FPrintHead     = true;

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

   PRIVATE MACRO PrintHead( IsNotEmpty : bool)
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
//   var NumTableStr = 0; 
   SetActiveSheet( "Завершение обработки" );
//   SetNumberPage("Страница ", NumStr);

   PrintHead(FPrintHead);

   RegisterTable( "N2_MainTable", NULL,
                  "sub1_ID"   ,
                  "sub1_Code" ,
                  "sub1_Name" ,
                  "csd1"      ,
                  "cew1"      ,
                  "dew"    
                );

  END;

  PRIVATE MACRO EndReport()
    var RowFrom = 0, RowTo = 0;  
    EndTable();
  END;

                                                                  
  PRIVATE MACRO PrintLine( sub1_ID, sub1_Code, sub1_Name, csd1, cew1, dew)

     PrintTableLine( "sub1_ID"                  ,  sub1_ID                  ,  null,
                     "sub1_Code"                ,  sub1_Code                ,  null,
                     "sub1_Name"                ,  sub1_Name                ,  null,
                     "csd1"                     ,  csd1                     ,  null,
                     "cew1"                     ,  cew1                     ,  null,
                     "dew"                      ,  dew                      ,  null
                   );                                       

  END;

  PRIVATE MACRO PrintRs(rs)
     PrintLine( string(rs.value(0)), string(rs.value(1)), string(rs.value(2)), string(rs.value(3)), string(rs.value(4)), string(date(rs.value(5)):f));
  END;

  PRIVATE MACRO Create()

     var rs = GetRsForBranch(ЗавершениеОбработкиПДн);

     while( rs.MoveNext() )
       PrintRs(rs);
     end;

  END;

  initCB_CReportTemplate( null, "pdnchklog.xls" );
END;


private macro PrintPdnChkBranch_1(ObjPrint)

  var stat = true;
//  var stat =  ObjPrint.OpenTemplate("pdnchklog.xls");

  if(stat)
    ObjPrint.SheetChange("Завершение обработки");
    var Table = ObjPrint.RegisterTable("N2_MainTable");

    var rs = GetRsForBranch(ЗавершениеОбработкиПДн);

    while( rs.MoveNext() )
       var sub1_ID   = string(rs.value(0));
       var sub1_Code = string(rs.value(1));
       var sub1_Name = string(rs.value(2));
       var csd1      = string(rs.value(3));
       var cew1      = string(rs.value(4));
       var dew       = string(date(rs.value(5)):f);

       Table.SetValueCell("sub1_ID"                  ,  sub1_ID  );
       Table.SetValueCell("sub1_Code"                ,  sub1_Code);
       Table.SetValueCell("sub1_Name"                ,  sub1_Name); 
       Table.SetValueCell("csd1"                     ,  csd1     );
       Table.SetValueCell("cew1"                     ,  cew1     );
       Table.SetValueCell("dew"                      ,  dew      ); 
       Table.AddStr(); 
    end;

    Table.EndTable();

//    stat = ObjPrint.CopyAllSheetInTotalBook("Завершение обработки"); // кидаем закладку в книгу
  end;

  return stat;
end;



private macro PrintPdnChkBranch_2(ObjPrint)

  var stat = true;
//  var stat =  ObjPrint.OpenTemplate("pdnchklog.xls");

  if(stat)
    ObjPrint.SheetChange("Уничтожить ПДн");
    var Table = ObjPrint.RegisterTable("N3_MainTable");

    var rs = GetRsForBranch(НеобходимоУничтожитьПДн);

    while( rs.MoveNext() )
       var sub2_ID   = string(rs.value(0));
       var sub2_Code = string(rs.value(1));
       var sub2_Name = string(rs.value(2));
       var csd2      = string(rs.value(3));
       var cew2      = string(rs.value(4));
       var ddd2      = string(date(rs.value(5)):f);

       Table.SetValueCell("sub2_ID"                  ,  sub2_ID  );
       Table.SetValueCell("sub2_Code"                ,  sub2_Code);
       Table.SetValueCell("sub2_Name"                ,  sub2_Name); 
       Table.SetValueCell("csd2"                     ,  csd2     );
       Table.SetValueCell("cew2"                     ,  cew2     );
       Table.SetValueCell("ddd2"                     ,  ddd2     ); 
       Table.AddStr(); 
    end;

    Table.EndTable();

//    stat = ObjPrint.CopyAllSheetInTotalBook("Завершение обработки"); // кидаем закладку в книгу
  end;

  return stat;
end;


private macro PrintPdnChkBranch_3(ObjPrint)

  var stat = true;
//  var stat =  ObjPrint.OpenTemplate("pdnchklog.xls");

  if(stat)
    ObjPrint.SheetChange("Предупреждение");
    var Table = ObjPrint.RegisterTable("N4_MainTable");

    var rs = GetRsForBranch(ПредупреждениеОНеобходимостиУничтоженияПДн);

    while( rs.MoveNext() )
       var sub3_ID   = string(rs.value(0));
       var sub3_Code = string(rs.value(1));
       var sub3_Name = string(rs.value(2));
       var csd3      = string(rs.value(3));
       var cew3      = string(rs.value(4));
       var ddd3      = string(date(rs.value(5)):f);

       Table.SetValueCell("sub3_ID"                  ,  sub3_ID  );
       Table.SetValueCell("sub3_Code"                ,  sub3_Code);
       Table.SetValueCell("sub3_Name"                ,  sub3_Name); 
       Table.SetValueCell("csd3"                     ,  csd3     );
       Table.SetValueCell("cew3"                     ,  cew3     );
       Table.SetValueCell("ddd3"                     ,  ddd3     ); 
       Table.AddStr(); 
    end;

    Table.EndTable();

//    stat = ObjPrint.CopyAllSheetInTotalBook("Завершение обработки"); // кидаем закладку в книгу
  end;

  return stat;
end;


private macro PrintPdnChkBranch_4(ObjPrint)

  var stat = true;
//  var stat =  ObjPrint.OpenTemplate("pdnchklog.xls");

  if(stat)
    ObjPrint.SheetChange("Не оформлены ПДн");
    var Table = ObjPrint.RegisterTable("N5_MainTable");

    var rs = GetRsForBranch_4();

    while( rs.MoveNext() )
       var sub4_ID   = string(rs.value(0));
       var sub4_Code = string(rs.value(1));
       var sub4_Name = string(rs.value(2));

       Table.SetValueCell("sub4_ID"                  ,  sub4_ID  );
       Table.SetValueCell("sub4_Code"                ,  sub4_Code);
       Table.SetValueCell("sub4_Name"                ,  sub4_Name); 
       Table.AddStr(); 
    end;

    Table.EndTable();

//    stat = ObjPrint.CopyAllSheetInTotalBook("Завершение обработки"); // кидаем закладку в книгу
  end;

  return stat;
end;

macro PrintLogXls
(
  OpenCheck, 
  CloseCheck,
  PdnPartyKind,
  PartyID,
  CheckFinProc,
  CheckNeedDelete,
  CheckDecor,
  IsScheduler
)
  var ObjPrint:CTemplateXLS = CTemplateXLS();                                           // основной объект отчёта
  
  ObjPrint.CreateTotalBook();

  var stat =  ObjPrint.OpenTemplate("pdnchklog.xls");
  if( stat )
    Var Table = ObjPrint.RegisterTable("N1_MainTable");

    var dattim = string(date:f);
    var datdat = string(time:f);
    var usr = string(({oper}));
    var usn = {Name_Oper};
    var sub = GetPartyFieldByID(PartyID);
    var csd = GetPdnPartyKindFieldByID(PdnPartyKind);

    Table.SetValueCell("dattim"                ,  dattim);
    Table.SetValueCell("datdat"                ,  datdat);
    Table.SetValueCell("usr"                   ,  usr   ); 
    Table.SetValueCell("usn"                   ,  usn   );
    Table.SetValueCell("sub"                   ,  sub   );
    Table.SetValueCell("csd"                   ,  csd   ); 
    Table.AddStr(); 

    Table.EndTable();

//    stat = ObjPrint.CopyAllSheetInTotalBook("Общие сведения"); // кидаем закладку в книгу
  end;



  if(stat AND CheckFinProc)
    stat = PrintPdnChkBranch_1(ObjPrint);
  end;

  if(stat AND CheckNeedDelete)
    stat = PrintPdnChkBranch_2(ObjPrint);

     if(stat)
       stat = PrintPdnChkBranch_3(ObjPrint);
     end;
  end;

  if(stat AND CheckDecor)
    stat = PrintPdnChkBranch_4(ObjPrint);
  end;


  // Удаляем в обратном порядке
  if(not CheckDecor)
    ObjPrint.SheetDelete(5);
  end;

  if(not CheckNeedDelete)
    ObjPrint.SheetDelete(4);
    ObjPrint.SheetDelete(3);
  end;

  if(not CheckFinProc)
    ObjPrint.SheetDelete(2);
  end;

  stat = ObjPrint.CopyAllSheetInTotalBook(); // кидаем закладку в книгу

  ObjPrint.Close(FALSE);

  ObjPrint.SaveTotalBook("pdnchklog_" + strsubst(string(date:f), ".", "") + "_" + strsubst(string(time:f), ":", ""));
end;

