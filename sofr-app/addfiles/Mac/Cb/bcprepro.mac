/*
 $Name: bcprepro.mac
 $Module: Ядро Banking
 $Description: Предобработка требования банка
 */
//-----------------------------------------------------------------------------
// Блок     : 29015 - "Предобработка требования банка"
// Шаг      : 10    - "Предобработка"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, pmdefbo, pm_syscont, pmchk117, bcchkrst, pmfm, pmprepromass, pschkbnk,
       "bcfunc.mac";

var PaymentObj:RsbPayment;

MACRO ExecuteStep( doc, paymDoc )
  var stat:integer       = 0;
  var DO_segment:integer = OPR_PM_ST_DISCHARGE;

  if( stat == 0 )
    
    //Контроль
    if( PaymentObj.Origin == PAYMENT_OR_AUTO )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_CONTROL );
    else
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_NOTCONTROL );
    end;

    //Направление
    if( stat == 0 )
      if( PaymentObj.PayerGroup == PAYMENTS_GROUP_EXTERNAL )
        stat = УстановитьСтатусыПлатежа( OPR_PAYM_DIRECT, OPR_PM_ST_DIR_OUT );
      else
        stat = УстановитьСтатусыПлатежа( OPR_PAYM_DIRECT, OPR_PM_ST_DIR_INTERNAL );
      end;
    end;      
          
    //Уточнение причастности к терроризму - Не требуется
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_TERR, OPR_PAYM_ST_TERR_NOTNEED );
    end;  
          
    //Квитовка - не сквитован
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_OUT_KVIT, OPR_PM_ST_UNKVIT );
    end;

    //Квитанция - не сквитован
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_KVT, OPR_PM_ST_UNKVIT );
    end;  
    
    //ЦАБС - не проведен по счетам МФР 
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_CABS, OPR_PM_ST_MFR_NO );
    end;  
          
    //Обработка в БО - нет
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_BO_PROCESS, OPR_PAYM_ST_BO_NO );
    end;  
    
    // ПЗО
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_PZO, OPR_PAYM_ST_PZO_NOTNEED );
    end;

    // РО - не требуется
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_MANUAL, OPR_PAYM_ST_MANUAL_NOTNEED );
    end;  

    // МФ
    if( stat == 0 )
      if( PaymentObj.StartDepartment != PaymentObj.EndDepartment )
        stat = УстановитьСтатусыПлатежа( OPR_PAYM_BRANCH, OPR_PAYM_ST_BRANCH_YES );
      else
        stat = УстановитьСтатусыПлатежа( OPR_PAYM_BRANCH, OPR_PAYM_ST_BRANCH_NO );
      end;
    end;      
          
    // КАРТ - нет
    if( stat == 0 )
      stat = УстановитьСтатусыПлатежа( OPR_PAYM_INDEX, OPR_PAYM_ST_INDEX_NO );
    end;
    
    if( stat != 0 )      
      msgbox("Ошибка при установке статуса платежа");
      return 1;
    end;
  end;
  
  // Выбор бэк-офиса
  stat = ОпределениеБэкОфиса( PaymentObj );
  
  if( stat == 0 ) // Системный контроль
    stat = ExecuteSysControlStep( PaymentObj );
    if( stat < 0 )
      return 1;
    elif( stat > 0 )
      return 0;
    end;
  end;
  
  if( stat == 0 ) // Проверка на банкротство
    stat = ПроверитьСтатусБанкротства( PaymentObj );
    if( stat < 0 )
      return 1;
    elif( stat > 0 )
      return 0;
    end;
  end;
  
  if( stat )
    return stat;
  end;

  if( PaymentObj.DemandAcceptTerm == PM_DEMAND_TERM_ACCEPT )
  
    if( ПлатежВнутренний( PaymentObj ) )
      if( УстановитьСтатусыПлатежа( OPR_PAYM_INDEX, OPR_PAYM_ST_INDEX_TP ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return 1;
      end;
      DO_segment = OPR_PM_ST_ENTER;
    end;

    if( УстановитьСтатусыПлатежа( OPR_PAYM_DO, DO_segment ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return 1;
    end;
  
  else
    
    if( stat == 0 ) // Проверка на причастность к терроризму
      stat = ПроверкаПричастностиТерроризму( PaymentObj );
      if( stat < 0 )
        return 1;
      elif( stat > 0 )
        return 0;
      end;
    end;

    if( stat == 0 ) // Контроль по 117-И
      stat = КонтрольПо117И( PaymentObj );
      if( stat < 0 )
        return 1;
      elif( stat > 0 )
        return 0;
      end;
    end;
    
    if( stat == 0 ) // Проверка остатков по счетам
      stat = BC_CheckAccRest( PaymentObj );

      // если резерв не был создан, завершить выполнение шага
      if(stat)
        return ConvertPrcChkRsrvStatForStep(stat);
      end;

      // Если проверки прошли успешно
      if( ПлатежИсходящий(PaymentObj) and 
          IsBankClaimOutNostro(PaymentObj)
        )
        DO_segment = OPR_PM_ST_DISCHARGE;
      else
        DO_segment = OPR_PM_ST_ENTER;
      end;
      if( УстановитьСтатусыПлатежа( OPR_PAYM_DO, DO_segment ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return 1;
      end;

      // Для внутрифилиальных установить сегмент "ЦАБС" = "Проведен по счетам МФР"
      // (для остальных установка статуса в начале ExecuteStep)
      if( PaymentObj.StartDepartment == PaymentObj.EndDepartment )
        if( УстановитьСтатусыПлатежа( OPR_PAYM_CABS, OPR_PM_ST_MFR_YES ) )
          msgbox("Ошибка при установке сегментов статуса экземпляра операции");
          return 1;
        end;  
      end;
    end;

  end;

  return stat;
END;

/* -----------------------------------------------------------------------------
   Массовое выполнение шага "Предобработка требования банка"
   ----------------------------------------------------------------------------- */

/* -----------------------------------------------------------------------------
   Предтранзакционные действия 
   Все проверки отражаются только на временной таблице dpmprepro_tmp,
   никакие изменения в БД не делаются
   ----------------------------------------------------------------------------- */
macro PrepMassExecuteStep() 

  // Подготовительные действия
  var stat:integer = execStoredFunc( "BB_BCPREPRO.MassPreprocessPrepare", V_INTEGER );

  if( not stat )
    stat = PM_MassPreproPrepare();
  end;
  
  // Системный контроль
  if( not stat )
    stat = execStoredFunc( "BB_BCPREPRO.MassSysControlPrepare", V_INTEGER );
  end;

  // Проверка остатка
  if( not stat )
    stat = execStoredFunc( "BB_BCPREPRO.MassCheckRestPrepare", V_INTEGER );
  end;

  if( stat )
    MemoryError( stat );
  end;

  return stat;

end;

/* -----------------------------------------------------------------------------
   Транзакционные действия 
   Всё, что напроверяли, отражается на статусах документа, платежа, операции 
   ----------------------------------------------------------------------------- */
macro MassExecuteStep()
  
  var stat:integer = execStoredFunc( "BB_BCPREPRO.MassPreprocessExecute", V_INTEGER );

  if( not stat )
    stat = PM_MassPreproExecute();
  end;

  if( stat )
    MemoryError( stat );
  end;

  return stat;

end;


