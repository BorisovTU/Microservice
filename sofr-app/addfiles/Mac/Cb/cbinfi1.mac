/*
    Информирование о необработанных документах
    Картотека 1

            Mikhailov S., 22.08.2001, Wed

    
*/

import cbinfcom;
import cbinfint;
import RSD;

/*Вызываемая процедура*/
macro CBINF_Proc( RegPath /* Путь к настройкам в реестре */, OutType/* Способ вывода CBINF_Out...*/ )
    var this_stat, nmbRec = 0;
    file pspayord( pspayord ) key 2;
    file pspaydem( pspaydem ) key 0;
    var rs;
    var cmd;

    CBINF_ErrorStatus = 0;
    CBINF_Result = 0;
    
    if( OutType == CBINF_OutReport )
        if( PrintHeader( RegPath, LIST_I1 ) )
            return CBINF_StatusError;
        end;
    end;

/*    rewind ( pspayord );*/

        InitProgress( NRecords(pspayord), "Информирование о необработанных документах", "Картотека 1" );

/*    while( next( pspayord ) )
*/        
    cmd = RSDCommand("select t.T_OPER, t.t_OrderID" +
                      " from dpspayord_dbt t " +
                      " where t.T_CurrentState = 3 " +
                      " order by t.T_CurrentState, t.T_CloseDate, t.T_OrderID");
    rs = RsdRecordset( cmd );           
    cmd.execute;


    while (rs.MoveNext)

            nmbRec = nmbRec + 1;
            UseProgress( nmbRec );
            
        if( /*( pspayord.CurrentState == PSPO_ST_I1 ) and*/ ( CBINF_OperDocFit( rs.value(0) ) == 0 ) )

            pspaydem.OrderId = rs.value(1);

            if( not getEQ( pspaydem ) )

                CBINF_Error( "Не найдены реквизиты платежного документа " + rs.value(1), OutType );
                RemProgress( nmbRec );
                return CBINF_StatusError;
            end;

            if( pspaydem.AcceptDate < {curdate})

                pspayord.OrderId = rs.value(1); /* чтобы не исправлять cbinfcom.mac */

                if( OutType == CBINF_OutMsg )
                
                    this_stat = MsgDocFound( RegPath, CBINF_I1, pspayord );
                    if( this_stat )
                        RemProgress( nmbRec );
                        return this_stat;
                    end;
                    
                elif( OutType == CBINF_OutReport )

                    this_stat = PrintLine( RegPath, CBINF_I1, pspayord );
                    if( this_stat )
                        RemProgress( nmbRec );
                        return this_stat;
                    end;
                    
                end;/*OutType*/
            end;/*if pspaydem.AcceptDate*/
            
        end;/*if CBINF_OperDocFit*/
        
    end;/*while*/


        RemProgress( nmbRec );

/**/
    if( OutType == CBINF_OutReport )
        if( PrintFooter( RegPath, LIST_I1 ) )
            return CBINF_StatusError;
        end;
    end;


    return CBINF_StatusOk;
    
end;/*CBINF_Proc*/

/*test call
const REGPATH = "COMMON\\CBINFPARMS";
var ret;

ret = CBINF_Proc( REGPATH, CBINF_OutReport);

msgbox( "test : stat =  ", ret , " CBINF_Result = ", CBINF_Result );
*/

