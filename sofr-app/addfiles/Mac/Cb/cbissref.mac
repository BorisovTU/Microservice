/*************************************************************************
                   R-Style SoftWare Lab, RS-Bank 5.1                      
**************************************************************************
                  Подсистема "Межбанковские расчеты"                      
                Макрос формирования кода ценной бумаги
  Имя файла: cbissref.mac                                                    
  Создан:  // VSH 06.09.02    
**************************************************************************/

/*import ;*/

macro GenRef( Value, ObjKind, AddrBuf )
  var avoir = TRecHandler("avoirbuf");
  var fin = TBFile("fininstr","R",1);

  var Number, tNumber = "";
  var i = 1;

  SetBuff( avoir, AddrBuf );
  if(avoir.rec.LSIN)   /*26*/
     tNumber = avoir.rec.LSIN;
  elif(avoir.rec.ISIN) /*26*/
     tNumber = avoir.rec.ISIN;
  end;
  
  tNumber = trim(tNumber);

  if(tNumber)
     if(strlen(tNumber)<16)
        fin.rec.FI_Code = tNumber;
     else
        fin.rec.FI_Code = string(tNumber:15);
     end;

     if(not fin.GetEQ())
        return tNumber;
     else
        Number = string(tNumber:13,"/",i);
        while(strlen(Number) < 16)
           fin.rec.FI_Code = Number;
           if(not fin.GetEQ())
              return Number;
           end;
           i = i + 1;
           Number = string(tNumber:13,"/",i);
        end;
     end;
  end;

  return string( Value:15:o );

end;

