/*
    Информирование о необработанных документах
    Картотека невыясненных сумм -- CBINF RMiNPROP

            Mikhailov S., 28.08.2001, Tue

    
*/

import cbinfcom;
import cbinfint;
import FIInter;/*FIKIND_...*/
import Календарь;
import RSD;



private const  WL_INDOC       = 320;   /* Ответный электронный документ МБР*/


/*__________________________________*/
macro CBINF_Proc( RegPath, OutType/*CBINF_Out...*/ )
    var this_stat, nmbRec = 0;
    var IsOurDoc;
    var LimitDate;
    var rs;         
    var cmd;        
    var f;
    file rminprop (rminprop) key 0;
    file corschem( corschem ) key 1;

    CBINF_ErrorStatus = 0;
    CBINF_Result = 0;
    

    if( OutType == CBINF_OutReport )
        if( PrintHeader( RegPath, LIST_RMINPROP ) )
            return CBINF_StatusError;
        end;
    end;

    var nrc;
  rewind (corschem);

  while ( next (corschem))

      LimitDate = GetDateAfterWorkDays({CurDate},-(corschem.MaxDaysInUnknown));
      cmd = RSDCommand("select t.T_PAYMENTID, ascii(t.T_CLOSED), t.T_FIID, t.T_CORSCHEM, t.T_SUM," +
                        "(select count(*) from drminprop_dbt t " +
                           " where t.T_CLOSED <> 'X' " +
                             "  and t.T_FIID = " + corschem.FIID +
                             "  and t.T_CORSCHEM = " + corschem.NUMBER +
                             "  and t.T_PLACEDATE >= to_date('" + LimitDate + "', 'DD.MM.YYYY')) " +
                         " from drminprop_dbt t " +
                         " where t.T_CLOSED <> 'X' " +
                         "  and t.T_FIID = " + corschem.FIID +
                         "  and t.T_CORSCHEM = " + corschem.NUMBER +
                         "  and t.T_PLACEDATE >= to_date('" + LimitDate + "', 'DD.MM.YYYY') " +
                         " order by t.T_PLACEDATE, t.t_SUM");
      rs = RsdRecordset(cmd);
      cmd.execute;

      f = rs.MoveNext;
      if (f)
         InitProgress(int(rs.value(5)),Null,"Информирование о необработанных документах");
      end;
      Message("Просмотр схемы расчетов "+ corschem.name+ "..."); 
      while (f)
          UseProgress( nmbRec);
          rminprop.PaymentID = int(rs.value(0));
          GetEQ(rminprop);
          this_stat = IsOperDoc( IsOurDoc, rs.value(0), WL_INDOC , OutType );
          if( this_stat )
              RemProgress( nmbRec );
              return this_stat;
          end;

          if( IsOurDoc )

             if( OutType == CBINF_OutMsg )
                 

                 this_stat = MsgDocFound( RegPath, CBINF_RMINPROP, rminprop );
                 if( this_stat )
                          RemProgress( nmbRec );
                   return this_stat;
                 end;
              
             elif( OutType == CBINF_OutReport )
             this_stat = PrintLine( RegPath, CBINF_RMINPROP, rminprop );
                 if( this_stat )
                          RemProgress( nmbRec );
                   return this_stat;
                 end;
              
             end;
           end;
      
      nmbRec = nmbRec + 1;
      f = rs.MoveNext;
      end;/*while*/
   RemProgress( nmbRec );    

 end;


   if( OutType == CBINF_OutReport )
        if( PrintFooter( RegPath, LIST_RMINPROP ) )
            return CBINF_StatusError;
        end;
   end;

 return CBINF_StatusOk;
    
end;/*CBINF_Proc*/

/*test call
const REGPATH = "COMMON\\CBINFPARMS";
var ret;

ret = CBINF_Proc( REGPATH, CBINF_OutMsg);

msgbox( "test : stat =  ", ret , " CBINF_Result = ", CBINF_Result );

*/

