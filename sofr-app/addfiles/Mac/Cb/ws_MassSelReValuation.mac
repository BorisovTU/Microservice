/*
$Name:           ws_MassSelReValuation.mac
$Module:         Ядро ГКБО
$Description:    Дистрибутивные функции пакетной процедуры разбиения счетов переоценки на пачки
*/
import RSD, FMInter, PTInter, "globals.mac", "likepy.mac";
import "revaluation_panel.mac", oralib;


 
private const CASH_SIZE = 10000;


macro SelectPacketNum(taskID, execID, ConvTypeID, PacketSize, PanelObj)
 
  var retobj = WebCore_MakeReValuationAccList(PanelObj);  // TWebReValueAccPrm
  // retObj.Packs массив пачек, подготовленных для Web (PackSize  == CB\\CONSENTACNT\\ACCOUNT_PACKAGE_SIZE)
  // перепакуем в соответствии с настройками конвеера и запишем в convdoc

  var PacketNum = 0;

  var cmd = RsdCommand( "INSERT INTO dcnvdoc_dbt (t_TaskID,                  "
                        "                         t_ExecID,                  "
                        "                         t_ConvTypeID,              "
                        "                         t_PackID,                  "
                        "                         t_ObjectType,              "
                        "                         t_ObjectID)                "
                        "    SELECT ?,                                       "
                        "           ?,                                       "
                        "           ?,                                       "
                        "           TRUNC((ROWNUM - 1) / ?) + 1,             "
                        "           t_ParamID,                               "
                        "           t_RecID                                  "
                        "      FROM (  SELECT t_ParamID, t_RecID             "
                        "                FROM drevalueaccsel_dbt             "
                        "               WHERE t_ParamID = ? ORDER BY t_RecID)" );


  cmd.addParam( "", RSDBP_IN, taskID );
  cmd.addParam( "", RSDBP_IN, execID );
  cmd.addParam( "", RSDBP_IN, ConvTypeID );
  cmd.addParam( "", RSDBP_IN, PacketSize );
  cmd.addParam( "", RSDBP_IN, retobj.ParamID );
  
  cmd.execute();

  cmd = null;
  
  cmd = RsdCommand( "SELECT max(t_PackID) FROM dcnvdoc_dbt WHERE t_ExecID = ? AND t_ConvTypeID = ?" );

  cmd.addParam( "", RSDBP_IN, execID );
  cmd.addParam( "", RSDBP_IN, ConvTypeID );

  cmd.execute();

  var rs = RsdRecordset( cmd );

  if( rs.MoveNext() )
    PacketNum = SQL_ConvTypeInteger(rs.value(0));
  end;

  return PacketNum;

end;
