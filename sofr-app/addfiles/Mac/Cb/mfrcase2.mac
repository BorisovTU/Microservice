//-----------------------------------------------------------------------------
// Блок     : 29001 - "Межфилиальные расчеты ЦАБС"
// Шаг      : 20    - "Конечный филиал?"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, cbsttls, oralib;
var PaymentObj:RsbPayment;

MACRO ExecuteCaseStep(Kind_Operation, Number_Step, primdoc, KindDoc)

  var rset:object;
  var select:string;
  var params:TArray = TArray();

  if( PaymentObj.Department != PaymentObj.EndDepartment )
     if( PaymentObj.PaymStatus != PM_MFRPROCESSING )
     PaymentObj.PaymStatus = PM_MFRPROCESSING;
     end;
     return "10"; // Проводка по счетам МФР ЦАБС 
  else
     if( УстановитьСтатусыПлатежа( OPR_PAYM_CABS, OPR_PM_ST_MFR_YES ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return 1;
     end;
     select = " select pmhist.t_StatusIDFrom " +
              "   from dpmhist_dbt pmhist " +
              "  where pmhist.T_AUTOKEY in (select max(T_AUTOKEY) " +
              "                               from dpmhist_dbt " +
              "                              where T_PAYMENTID = pmhist.T_PAYMENTID) " +
              "  and pmhist.t_PaymentID = :PMPayment ";

     params[params.size] = SQLParam( "PMPayment", PaymentObj.PaymentID );
     rset = execSQLselect( select, params, TRUE );
 
     if( rset and rset.moveNext() )
       PaymentObj.PaymStatus = rset.value(0);
     else
       msgbox("Ошибка при поиске истории изменения статуса платежа");
       return 1;
     end;
     return ""; // Завершить выполнение блока
  end;

END;