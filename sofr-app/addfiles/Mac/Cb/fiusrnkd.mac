/*---------------------------------------------------------------------------\
|                             Файл    fiusrnkd.mac                           |

   Пользовательский расчет НКД. 

   Общая возможность выполнять пользовательский расчет НКД включается 
   настройкой "SECUR\POSSIBLE_USER_NKD". Для задания пользовательского расчета 
   по каждой бумаге необходимо ввести для бумаги текстовое примечание вида 
   "Пользовательский расчет НКД". Если такое примечание задано, то системная 
   процедура расчета НКД вызывает макрос Cb\fiusrnkd.mac - процедуру UserNKDCalc.
   
   В параметрах передается  текст примечания и все данные необходимые для 
   расчета НКД. Сумма возвращаемая макросом используется системой как 
   величина НКД. 

   В параметрах макроса также передается признак lastdate, который показывает 
   в каком режиме вызывается расчет НКД. Если lastdate = true, то расчет 
   выполняется для получения величины НКД с учетом совпадения даты расчета с 
   последней датой купонного периода, в этом случае НКД должно быть нулевым. 
   Необходимо учесть это при реализации пользовательских алгоритмов расчета НКД.

   Azartsov Valery V.
   //AV 03.05.2006
\---------------------------------------------------------------------------*/
import "globals.mac", "cb_sql.mac", OprInter;

PRIVATE RECORD fi   (fininstr);
PRIVATE RECORD avoir(avoiriss);

PRIVATE MACRO ПолучитьНКДПоКурсу( FIID, CalcDate, IsTrust )
  var RSD;
  var cmd = RSDCommand( "select RSB_PMWRTOFF.FindNKDCource( ?, ?, ? ) NKD from dual" );
  cmd.addParam( "", RSDBP_IN, FIID );
  cmd.addParam( "", RSDBP_IN, CalcDate );
  if(IsTrust)
     cmd.addParam( "", RSDBP_IN, 1 );
  else
     cmd.addParam( "", RSDBP_IN, 0 );
  end;
  cmd.execute();

  RSD = TRsbDataSet(cmd);
  if( RSD.MoveNext() )
     return RSD.rec.NKD;
  end;

  return 0;
END;

PRIVATE  MACRO SCUserNKDCalc( notetext:string, fi_addr, avoir_addr, amount:money, calcdate:date, lastdate:bool, opergroup:integer )
   var NKD:money = -$1.;
   setbuff( fi, fi_addr );
   setbuff( avoir, avoir_addr ); 

   return NKD;
END;


/* добалено для ДУ по запросу 134724 */
PRIVATE MACRO TSUserNKDCalc( notetext:string, fi_addr, avoir_addr, amount:money, calcdate:date, lastdate:bool, opergroup:integer )
   var NKD:money = -$1.;
   setbuff( fi, fi_addr );
   setbuff( avoir, avoir_addr ); 

   return NKD;
END;