 /*
 $Name: mpcpay50.mac
 $Module: RSACCOUNT
 $Description: Операция "Оплата по ПД". Шаг "Балансовый учет".
 */
/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v.6.00.020
                 Copyright (c) R-Style Software Lab

  Имя файла        : mpcpay50.mac

  Библиотека       : RSACCOUNT

  Описание         : Операция "Оплата по ПД". Шаг "Балансовый учет".

  Программист      : Kirakozov Michael (KMB)

  Создан           : 12.02.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet, CTInter, InsCarryDoc, BankInter, PaymInter, pm_common,
       PTInter,globals, CurrInter, mpcactacc, mpccarry, mpcpaym, SFInter,
       mpclb, mpcpayor;

// Вид создаваемого докумета РБ
const PRC_PAYMDOC_NONE           = 0, // не создаем
      PRC_PAYMDOC_BANKORDER      = 1, // банковский ордер
      PRC_PAYMDOC_BANKPAYM       = 2, // платеж банка
      PRC_PAYMDOC_CLIENTORDER    = 3, // клиентское требование
      PRC_PAYMDOC_CLIENTPAYM     = 4; // клиентский платеж


record contract_buf (prccontract);
record cntopr_buf (prccntopr);

private var ДАТА_ВВОДА;
GetRegistryValue ("COMMON\\МСФО\\ДАТА_ВВОДА", V_DATE, ДАТА_ВВОДА);
ДАТА_ВВОДА = Date(ДАТА_ВВОДА);

var UserAccount = "";   // 
var UserFIID = 0;
var UserAccount2 = "";

var prccontract = TBfile("prccontract.dbt"),
    cntsched = TBfile("prccntsched.dbt"),
    prccntopr = TBfile("prccntopr.dbt"),
    ContractID = 0,
    ResKind = 0,
    DocID = 0,
    TypeDocs = 0, 
    OldTypeDocs = 0;

var TrnMsg = "";
var SumChargeFact = $0;
var SumChargeBalance = $0;
var SumChargeNonBalance = $0;



// Проверить, инсталлировано ли РКО 
PRIVATE MACRO IsInstalledRKO()
  return true;
END;
   

// Актуалтзация лицевого счета по КУ
PRIVATE MACRO ActuateAcc(CatID, Account:@string, FIID:@integer, Chapter:@integer, acc_buf)
   var   cmd,rs,
         CatCode = "",
         CodeCurr,Chapt,
         stat = 0;

   cmd = RSDCommand ("select T_CODE from DMCCATEG_DBT where T_ID = ? ");
   cmd.addParam( "", RSDBP_IN, CatID );
   stat = cmd.execute();
   
   rs = TRsbDataSet(cmd);
   if (rs.movenext())
      CatCode = rs.code;   
   end;

   Account = MPC_ActAccountsForFD( ContractID, CatCode, @CodeCurr, @Chapt, acc_buf);
   
   if (ValType(Account) == V_UNDEF)
      Account = "";
   end;
   
   if (ValType(CodeCurr) != V_UNDEF)
      FIID = CodeCurr;
   end;

   if (ValType(Chapt) != V_UNDEF)
      Chapter = Chapt;
   end;
   
   return stat;
END;

PRIVATE MACRO СчетПроводки( PrcAccount, МаскиСчетов1 )
  var rs, cmd;
  var strQuery = "SELECT T_ACCOUNT_RECEIVER FROM DACCTRN_DBT WHERE T_ACCOUNT_PAYER = :PrcAccount";
  cmd = RsdCommand( strQuery );
  cmd.addParam( "", RSDBP_IN, PrcAccount );
  cmd.execute();      
 
  rs = TRsbDataSet( cmd );
  
  while( rs.movenext() )
    var Account_Receiver = rs.Account_Receiver;
    if( CompareStrWithMasks (МаскиСчетов1, Account_Receiver)  == 0 )
      return true;
    end;
  end;
  return false;
END;

private macro MoreAtrSub( party )
  
  file persn("persn.dbt") key 0;
  file objattr("objattr.dbt") key 0;
  var FindAttr:bool;
if( persn.PersonID = party.PartyID)
 if( getEQ( persn ) )
  if ( party.LegalForm == PTLEGF_PERSN )
    if( (persn.IsEmployer == "X") 
      OR ((CheckObjAttrPresence ( FindAttr, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), 16, 2, "", "", false ) == true) AND (FindAttr == true) ) 
      OR ((CheckObjAttrPresence ( FindAttr, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), 16, 3, "", "", false ) == true ) AND (FindAttr == true) )
    )
      return true;
    end;
  end;
 end;
end;
  return false;
end;

private macro BankPropertyYuris( party )

  var cmd;
  var rs;
  
  var isPro = false;

  if( party.LegalForm != PTLEGF_PERSN )
    
    cmd = RsdCommand( "SELECT * FROM dpartyown_dbt WHERE t_PartyID = :PartyID AND (t_PartyKind = 2 OR t_PartyKind = 56 OR t_PartyKind = 29 OR t_PartyKind = 55)" );
    cmd.addParam( "", RSDBP_IN, party.PartyID );
       
    rs = RsdRecordset( cmd );
  
    if( rs.moveNext() )
      return isPro = false;
    else
      return isPro = true;
    end;
  end;

  return isPro;

end;


PRIVATE MACRO Prc_AddGroundVO( Ground, PrcAccount, FIID, PrcClientID)
   
   var МаскиСчетов1 = "", МаскиСчетов2 = "", err, err1, err2, Flag;
    
   GetRegistryValue("BBANK\\PERCENT\\СЧЕТА КРЕДИТОВ", V_STRING, МаскиСчетов1, err1);
   GetRegistryValue("BBANK\\PERCENT\\СЧЕТА ПРОСРОЧКИ", V_STRING, МаскиСчетов2, err2);
      
   file party("party.dbt") key 0;

   party.PartyID = PrcClientID;
  GetRegistryValue( "COMMON\\ВЕДЕНИЕ БД ВО В ПРИКЛАДНЫХ БО", V_BOOL, Flag, err);
  if( Flag )
   if( getEQ( party ) )
     if ( (err1 == 0) AND (err2 == 0) )
       if( (FIID == NATCUR) AND (party.NotResident == "X") AND (party.LegalForm != PTLEGF_PERSN) ) 
         if ( (CompareStrWithMasks (МаскиСчетов1,PrcAccount) == 0 ) 
           OR ( (CompareStrWithMasks (МаскиСчетов2,PrcAccount) == 0 ) 
          AND (СчетПроводки( PrcAccount,МаскиСчетов1) == true )) )
             Ground = "{VO80010} " + ground;  
         else
             Ground = "{VO80050} " + ground;  
           end;
       elif( (FIID != NATCUR) AND (party.NotResident != "X") AND ( (MoreAtrSub( party ) == true) OR (BankPropertyYuris( party ) == true) ) ) 
         if ( (CompareStrWithMasks (МаскиСчетов1,PrcAccount) == 0) 
           OR ((CompareStrWithMasks (МаскиСчетов2,PrcAccount) == 0 )
          AND ( СчетПроводки(PrcAccount,МаскиСчетов1 ) == true)) )
             Ground = "{VO80110} " + ground;  
         else
           Ground = "{VO80150} " + ground;
           end;
         end;
       end;
     end;
   end;
   return Ground;
END;

// Проводки
PRIVATE MACRO DoOperationCarry()
    var ReceiverAccount, PayerAccount,
        ReceiverFIID, PayerFIID,
        Debet="",Credit="", 
        Debet2="",Credit2="",
        Debet3="",Credit3="",
        ReceiverSettAcc, PayerSettAcc,
        DebetSettAcc, CreditSettAcc,
        Debet2SettAcc, Credit2SettAcc,
        DebetCatID = 0,  DebetCatID2 = 0, DebetCatID3 = 0, 
        CreditCatID = 0,  CreditCatID2 = 0, CreditCatID3 = 0,
        DebetTypeID = 0, CreditTypeID = 0,
        Debet2TypeID = 0, Credit2TypeID = 0,
        Debet3TypeID = 0, Credit3TypeID = 0,
        DebetFIID, Debet2FIID, Debet3FIID,
        CreditFIID, Credit2FIID, Credit3FIID,
        ContrFIID,
        DebetDep    = 0,CreditDep  = 0,
        Debet2Dep   = 0,Credit2Dep = 0,
        Debet3Dep   = 0,Credit3Dep = 0,
        DebetCarrySum = $0, CreditCarrySum = $0,
        Debet2CarrySum = $0, Credit2CarrySum = $0,
        Debet3CarrySum = $0, Credit3CarrySum = $0,
        CarrySum = $0, CarrySum2 = $0, CarrySum3 = $0, PayerRest = $0,
        PaymentID,
        Chapter = 0, Chapter2 = 0, Chapter3 = 0,
        НазначениеПроводки  = "", 
        НазначениеПроводки2 = "",
        НазначениеПроводки3 = "",
        stat = 0,
        AlienAcc    = false,
        AlienAcc2   = false,
        AlienAcc3   = false,
        flagPostDoc = false,
        fd, AccTrn, AccTrn2,
        PaymentDoc  = PRC_PAYMDOC_NONE,
        PaymentDoc2 = PRC_PAYMDOC_NONE;

    RECORD settacc( settacc );
    record acc_buf (account);
    ContrFIID = prccontract.rec.fiid; 

    // определим счет получателя для привлечения
    if (ResKind == PRC_RESKIND_PRIV)
        if (prccontract.rec.IsReckonAmoung == "X")
            ReceiverAccount = prccontract.rec.account;
            Chapter = prccontract.rec.chapter;
            ReceiverFIID = ContrFIID;         
        elif (prccontract.rec.UseOurAccount == "X")
            ReceiverAccount = prccontract.rec.peraccount;
            Chapter = 1;
            GetAccountFIID(prccontract.rec.peraccount, @ReceiverFIID);
         
        elif (prccontract.rec.UseSPI == "X")
            if (FindSETTACC_PMAUTO( prccontract.rec.Client,  FIKIND_CURRENCY, prccontract.rec.FIID, PTSK_PAY, 4522, 0, 0, settacc ) == 0)
                ReceiverAccount      = settacc.Account;
                Chapter              = settacc.Chapter;
                ReceiverFIID         = settacc.FIID;
                ReceiverSettAcc     = settacc;
                if (settacc.bankid != {OurBank})             
                AlienAcc = true;
                end;
            else
                TrnMsg = "Не найдена СПИ";
                return 1;
            end;
        end; 
    end;

    // определим счет плательщика для размещения
    if (ResKind == PRC_RESKIND_RAZM)
        if (prccontract.rec.UseOurAccount == "X")
            PayerAccount = prccontract.rec.peraccount;
            Chapter = 1;
            GetAccountFIID(prccontract.rec.peraccount, @PayerFIID);
        elif (prccontract.rec.UseSPI == "X")
            if (FindSETTACC_PMAUTO( prccontract.rec.Client,  FIKIND_CURRENCY, prccontract.rec.FIID, PTSK_PAY, 4522, 0, 0, settacc ) == 0)
                PayerAccount      = settacc.Account;
                Chapter           = settacc.Chapter;
                PayerFIID         = settacc.FIID;
                PayerSettAcc      = settacc;
                if (settacc.bankid != {OurBank})
                    AlienAcc = true;
                end;
            else
                TrnMsg = "Не найдена СПИ";
                return 1;
            end;
        end;
    end;

    // привлечение
    if (TypeDocs == PRC_ACCSCHEMA_PRIV)
        Chapter = 1;
        DebetTypeID = 1;
        GetAccountFromList(ContractID, DebetTypeID, @Debet, @DebetCatID, @DebetFIID, @Chapter);
        Credit = ReceiverAccount;
        CreditFIID = ReceiverFIID;
        CreditSettAcc = ReceiverSettAcc;
        НазначениеПроводки = "Оплата процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;      
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = cntsched.rec.SumCalc;
    end;  

    // привлечение с доначислением
    if (TypeDocs == PRC_ACCSCHEMA_PRIV_ADDCH)
        Chapter = 1;
        DebetTypeID = 1;
        GetAccountFromList(ContractID, DebetTypeID, @Debet, @DebetCatID, @DebetFIID, @Chapter);
        Credit = ReceiverAccount;
        CreditFIID = ReceiverFIID;
        CreditSettAcc = ReceiverSettAcc;
        НазначениеПроводки = "Оплата начисленных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;      
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );        
        CarrySum = SumChargeFact;

        Chapter2 = 1;
        Debet2TypeID = 3;
        GetAccountFromList(ContractID, Debet2TypeID, @Debet2, @DebetCatID2, @Debet2FIID, @Chapter2);
        Credit2 = ReceiverAccount;
        Credit2FIID = ReceiverFIID;
        Credit2SettAcc = ReceiverSettAcc;
        AlienAcc2 = AlienAcc;
        НазначениеПроводки2 = "Оплата доначисленных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;      
        НазначениеПроводки2 = Prc_AddGroundVO( НазначениеПроводки2,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );                    
        CarrySum2 = cntsched.rec.SumCalc - SumChargeFact;
    end;  

    // размещение баланс
    if (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL)
        Chapter = 1;
        CreditTypeID = 1;
        GetAccountFromList(ContractID, CreditTypeID, @Credit, @CreditCatID, @CreditFIID, @Chapter);
        Debet = PayerAccount;
        DebetFIID = PayerFIID;
        DebetSettAcc = PayerSettAcc;
        НазначениеПроводки = "Оплата процентов за период с " + 
                    cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                    " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = cntsched.rec.SumCalc;
    end;

    // размещение внебаланс
    if (TypeDocs == PRC_ACCSCHEMA_RAZM_NONBAL)
        Chapter = 1;
        CreditTypeID = 3;
        GetAccountFromList(ContractID, CreditTypeID, @Credit, @CreditCatID, @CreditFIID, @Chapter);
        Debet = PayerAccount;
        DebetFIID = PayerFIID;
        DebetSettAcc = PayerSettAcc;
        НазначениеПроводки = "Оплата процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = cntsched.rec.SumCalc;

        Chapter2 = 3;
        Credit2TypeID = 5;
        GetAccountFromList(ContractID, Credit2TypeID, @Credit2, @CreditCatID2, @Credit2FIID, @Chapter2);  

        fd = PrcContractFD(ContractID);
         Debet2 = MC_FindAndOpenAccountEx("ВнебалСчетКорресп",
                                            fd,
                                        {curdate},
                                        NULL,
                                        MC_OPENACC_CREATE,
                                        acc_buf,
                                        NATCUR,
                                        NULL,
                                        MC_PAIRACCMODE_AUTO,
                                        NULL,
                                        NULL,
                                        null, null, null, null,
                                       {curdate}            /* дата начала действия счета */
                                       );                                       
        if (Debet2 == "") 
            TrnMsg = "Не удалось актуализировать счет плательщика";
            return 1;
        end;
        Debet2Dep = acc_buf.department;
        Debet2FIID = acc_buf.code_currency;
        НазначениеПроводки2 = "Списание начисленных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;                                 
        НазначениеПроводки2 = Prc_AddGroundVO( НазначениеПроводки2,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );                                              
        CarrySum2 = cntsched.rec.SumCalc;      
    end;

    // размещение баланс просрочка
    if (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_OD)
        Chapter = 1;
        CreditTypeID = 2;
        GetAccountFromList(ContractID, CreditTypeID, @Credit, @CreditCatID, @CreditFIID, @Chapter);
        Debet = PayerAccount;
        DebetFIID = PayerFIID;
        DebetSettAcc = PayerSettAcc;
        НазначениеПроводки = "Оплата просроченных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = cntsched.rec.SumCalc;
    end;

    // размещение внебаланс просрочка
    if (TypeDocs == PRC_ACCSCHEMA_RAZM_NONBAL_OD)
        Chapter = 1;
        CreditTypeID = 4;
        GetAccountFromList(ContractID, CreditTypeID, @Credit, @CreditCatID, @CreditFIID, @Chapter);
        Debet = PayerAccount;
        DebetFIID = PayerFIID;
        DebetSettAcc = PayerSettAcc;
        НазначениеПроводки = "Оплата просроченных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = cntsched.rec.SumCalc;

        Chapter2 = 3;
        Credit2TypeID = 6;
        GetAccountFromList(ContractID, Credit2TypeID, @Credit2, @CreditCatID2, @Credit2FIID, @Chapter2);  

        fd = PrcContractFD(ContractID);
        Debet2 = MC_FindAndOpenAccountEx("ВнебалСчетКорресп",
                                        fd,
                                        {curdate},
                                        NULL,
                                        MC_OPENACC_CREATE,
                                        acc_buf,
                                        NATCUR,
                                        NULL,
                                        MC_PAIRACCMODE_AUTO,
                                        NULL,
                                        NULL,
                                        null, null, null, null,
                                       {curdate}            /* дата начала действия счета */
                                       );      
        if (Debet2 == "") 
            TrnMsg = "Не удалось актуализировать счет плательщика";
            return 1;
        end;
        Debet2Dep = acc_buf.department; 
        Debet2FIID = acc_buf.code_currency;

        Credit2FIID = ContrFIID;
        НазначениеПроводки2 = "Списание просроченных начисленных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;                                 
        НазначениеПроводки2 = Prc_AddGroundVO( НазначениеПроводки2,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );                                               
        CarrySum2 = cntsched.rec.SumCalc;      
    end;

    // размещение баланс-внебаланс
    if (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL)
        Chapter = 1;
        CreditTypeID = 1;
        GetAccountFromList(ContractID, CreditTypeID, @Credit, @CreditCatID, @CreditFIID, @Chapter);
        Debet = PayerAccount;
        DebetFIID = PayerFIID;
        DebetSettAcc = PayerSettAcc;
        НазначениеПроводки = "Оплата процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = SumChargeBalance;

        Chapter2 = 1;
        Credit2TypeID = 3;
        GetAccountFromList(ContractID, Credit2TypeID, @Credit2, @CreditCatID2, @Credit2FIID, @Chapter2);
        Debet2 = PayerAccount;
        Debet2FIID = PayerFIID;
        Debet2SettAcc = PayerSettAcc;
        AlienAcc2 = AlienAcc;
        НазначениеПроводки2 = "Оплата процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки2 = Prc_AddGroundVO( НазначениеПроводки2,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum2 = SumChargeNonBalance;

        Chapter3 = 3;
        Credit3TypeID = 5;
        GetAccountFromList(ContractID, Credit3TypeID, @Credit3, @CreditCatID3, @Credit3FIID, @Chapter3);  

        fd = PrcContractFD(ContractID);
        Debet3 = MC_FindAndOpenAccountEx("ВнебалСчетКорресп",
                                        fd,
                                        {curdate},
                                        NULL,
                                        MC_OPENACC_CREATE,
                                        acc_buf,
                                        NATCUR,
                                        NULL,
                                        MC_PAIRACCMODE_AUTO,
                                        NULL,
                                        NULL,
                                        null, null, null, null,
                                       {curdate}            /* дата начала действия счета */
                                       );                                       
        if (Debet3 == "") 
            TrnMsg = "Не удалось актуализировать счет плательщика";
            return 1;
        end;
        Debet3Dep = acc_buf.department;
        Debet3FIID = acc_buf.code_currency;
        AlienAcc3 = AlienAcc;
        НазначениеПроводки3 = "Списание начисленных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;                                 
        НазначениеПроводки3 = Prc_AddGroundVO( НазначениеПроводки3,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );                                               
        CarrySum3 = SumChargeNonBalance;     
    end;

    // размещение баланс-внебаланс просрочка
    if (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD)
        Chapter = 1;
        CreditTypeID = 2;
        GetAccountFromList(ContractID, CreditTypeID, @Credit, @CreditCatID, @CreditFIID, @Chapter);
        Debet = PayerAccount;
        DebetFIID = PayerFIID;
        DebetSettAcc = PayerSettAcc;
        НазначениеПроводки = "Оплата просроченных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum = SumChargeBalance;
   
        Chapter2 = 1;
        Credit2TypeID = 4;
        GetAccountFromList(ContractID, Credit2TypeID, @Credit2, @CreditCatID2, @Credit2FIID, @Chapter2);
        Debet2 = PayerAccount;
        Debet2FIID = PayerFIID;
        Debet2SettAcc = PayerSettAcc;
        AlienAcc2 = AlienAcc;
        НазначениеПроводки2 = "Оплата просроченных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );
        CarrySum2 = SumChargeNonBalance;

        Chapter3 = 3;
        Credit3TypeID = 6;
        GetAccountFromList(ContractID, Credit3TypeID, @Credit3, @CreditCatID3, @Credit3FIID, @Chapter3);  

        fd = PrcContractFD(ContractID);
        Debet3 = MC_FindAndOpenAccountEx("ВнебалСчетКорресп",
                                        fd,
                                        {curdate},
                                        NULL,
                                        MC_OPENACC_CREATE,
                                        acc_buf,
                                        NATCUR,
                                        NULL,
                                        MC_PAIRACCMODE_AUTO,
                                        NULL,
                                        NULL,
                                        null, null, null, null,
                                       {curdate}            /* дата начала действия счета */
                                       );      
        if (Debet3 == "") 
            TrnMsg = "Не удалось актуализировать счет плательщика";
            return 1;
        end;

        Debet3Dep = acc_buf.department; 
        Debet3FIID = acc_buf.code_currency;

        Credit3FIID = ContrFIID;
        AlienAcc3 = AlienAcc;
        НазначениеПроводки3 = "Списание просроченных начисленных процентов за период с " + 
                cntsched.rec.PeriodBeginDate + " по " + cntsched.rec.PeriodEndDate +
                " для договора " +  prccontract.rec.Number + " по счету " + prccontract.rec.Account;                                 
        НазначениеПроводки = Prc_AddGroundVO( НазначениеПроводки,  prccontract.rec.account, prccontract.rec.fiid, prccontract.rec.Client );                                               
        CarrySum3 = SumChargeNonBalance;     
    end;


    // если не определены счета, то актуализируем сейчас
    if (ResKind == PRC_RESKIND_PRIV)
        if ((Debet == "") and (DebetCatID == 0)) 
            TrnMsg = "Не определен счет плательщика и не задана соотв.КУ для договора";
            return 1;
        else
            if ((Debet == "") and (CarrySum > 0))
                ActuateAcc(DebetCatID, @Debet, @DebetFIID, @Chapter, acc_buf);
                if (Debet == "")
                    TrnMsg = "Не удалось актуализировать счет плательщика";
                    return 1;
                else
                PrcSetCntAcc(ContractID, DebetTypeID, DebetFIID, Chapter, Debet);
                    DebetDep = acc_buf.department;
                end;   
            end;
        end;

        if (Credit == "")
            TrnMsg = "Не определен счет получателя";
            return 1;
        end;
    else
        if ((Credit == "") and (CreditCatID == 0))
            TrnMsg = "Не определен счет получателя и не задана соотв.КУ для договора";
            return 1;
        else
            if ((Credit == "") and (CarrySum > 0))
                ActuateAcc(CreditCatID, @Credit, @CreditFIID, @Chapter, acc_buf);
                if (Credit == "")
                    TrnMsg = "Не удалось актуализировать счет получателя";
                    return 1;
                else
                    PrcSetCntAcc(ContractID, CreditTypeID, CreditFIID, Chapter, Credit);
                    CreditDep = acc_buf.department;
                end;
            end;
        end;

        if (Debet == "")
            TrnMsg = "Не определен счет плательщика";
            return 1;
        end;
    end;

    if (ValType(DebetFIID) == V_UNDEF)
        DebetFIID = ContrFIID;
    end;

    if (ValType(CreditFIID) == V_UNDEF)
        CreditFIID = ContrFIID;
    end;

    if (DebetDep == 0)
        GetAccountDepartment(Debet, Chapter,DebetFIID, @DebetDep);
    end;

    if (CreditDep == 0)
        GetAccountDepartment(Credit,Chapter,CreditFIID,  @CreditDep);
    end;

    // Проверяем счета для 2-й проводки
    if ((TypeDocs == PRC_ACCSCHEMA_PRIV_ADDCH) or 
       (TypeDocs == PRC_ACCSCHEMA_RAZM_NONBAL) or
       (TypeDocs == PRC_ACCSCHEMA_RAZM_NONBAL_OD) or
       (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL) or
       (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD)
    )
        if ((Debet2 == "") and (DebetCatID2 == 0))
            TrnMsg = "Не определен счет плательщика и не задана соотв.КУ для договора";
            return 1;
        else
            if ((Debet2 == "") and (CarrySum2 > 0))
                ActuateAcc(DebetCatID2, @Debet2, @Debet2FIID, @Chapter2, acc_buf);
                if (Debet2 == "")
                    TrnMsg = "Не удалось актуализировать счет плательщика";
                    return 1; 
                else
                    PrcSetCntAcc(ContractID, Debet2TypeID, Debet2FIID, Chapter2, Debet2);
                    Debet2Dep = acc_buf.department;
                end;
            end;
        end;

        if ((Credit2 == "") and (CreditCatID2 == 0))
            TrnMsg = "Не определен счет получателя и не задана соотв.КУ для договора";
            return 1;
        else
            if ((Credit2 == "") and (CarrySum2 > 0))
                ActuateAcc(CreditCatID2, @Credit2, @Credit2FIID, @Chapter2, acc_buf);
                if (Credit2 == "")
                    TrnMsg = "Не удалось актуализировать счет получателя";
                    return 1;
                else
                    PrcSetCntAcc(ContractID, Credit2TypeID, Credit2FIID, Chapter2, Credit2);
                    Credit2Dep = acc_buf.department;
                end;
            end;
        end;

        if (ValType(Debet2FIID) == V_UNDEF)
            Debet2FIID = ContrFIID;
        end;

        if (ValType(Credit2FIID) == V_UNDEF)
            Credit2FIID = ContrFIID;
        end;

        if (Debet2Dep == 0)
            GetAccountDepartment(Debet2, Chapter2,Debet2FIID, @Debet2Dep);
        end;

        if (Credit2Dep == 0)
            GetAccountDepartment(Credit2, Chapter2,Credit2FIID, @Credit2Dep);
        end; 
    end;    


    // Проверяем счета для 3-й проводки
    if (
       (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL) or
       (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD)
    )
        if (Debet3 == "")
            TrnMsg = "Не определен счет плательщика";
            return 1;      
        end;

        if ((Credit3 == "") and (CreditCatID3 == 0))
            TrnMsg = "Не определен счет получателя и не задана соотв.КУ для договора";
            return 1;
        else
            if ((Credit3 == "") and (CarrySum3 > 0))
                ActuateAcc(CreditCatID3, @Credit3, @Credit3FIID, @Chapter3, acc_buf);
                if (Credit3 == "")
                    TrnMsg = "Не удалось актуализировать счет получателя";
                    return 1;
                else
                    PrcSetCntAcc(ContractID, Credit3TypeID, Credit3FIID, Chapter3, Credit3);
                    Credit3Dep = acc_buf.department;
                end;
            end;
        end; 

        if (ValType(Debet3FIID) == V_UNDEF)
            Debet3FIID = ContrFIID;
        end;

        if (ValType(Credit3FIID) == V_UNDEF)
            Credit3FIID = ContrFIID;
        end;

        if (Debet3Dep == 0)
            GetAccountDepartment(Debet3, Chapter3,Debet3FIID, @Debet3Dep);
        end;

        if (Credit3Dep == 0)
            GetAccountDepartment(Credit3, Chapter3,Credit3FIID, @Credit3Dep);
        end;      
    end;            


    // если работаем без РКО 
    if (not IsInstalledRKO())
        if (AlienAcc or (DebetDep != CreditDep))  
            if( UserAccount == "" ) /*Если счет в макросе не задан, то выдать сообщение*/
                if (CarrySum != 0)
                    if (ResKind == PRC_RESKIND_PRIV)
                        TrnMsg = "Невозможно создать проводку оплаты. Неизвестен счет получателя. |Требуется настройка макроса формирования проводок mpcpay50.mac";
                    else
                        TrnMsg = "Невозможно создать проводку оплаты. Неизвестен счет плательщика. |Требуется настройка макроса формирования проводок mpcpay50.mac";
                    end;
                    return 1;
                end;
            else /*Заполнить счет значением, задаваемым в макросе*/
                if (ResKind == PRC_RESKIND_PRIV)
                    Credit = UserAccount;
                    CreditFIID = UserFIID;
                else
                    Debet = UserAccount;
                    DebetFIID = UserFIID;
                end;
            end;
        end;  
         
      
        if (DebetFIID != ContrFIID)
            ConvSum(DebetCarrySum, CarrySum, prccntopr.rec.DocDate, ContrFIID, DebetFIID );
        else
            DebetCarrySum  = CarrySum;
        end;

        if (CreditFIID != ContrFIID)
            ConvSum(CreditCarrySum, CarrySum, prccntopr.rec.DocDate, ContrFIID, CreditFIID );
        else
            CreditCarrySum = CarrySum; 
        end;

        if ((CarrySum != 0) and ({curdate} < ДАТА_ВВОДА)) 
            stat = Prc_DocCarry( 
                              Chapter,                  // Глава
                              DebetFIID,                // Дебет Валюта
                              CreditFIID,               // Кредит Валюта
                              Debet,                    // Дебет
                              Credit,                   // Кредит
                              DebetCarrySum, 
                              CreditCarrySum,            // сколько
                              prccntopr.rec.DocDate,        // За какое число
                              "09",
                              NULL,
                              0,                         // CarryResult
                              НазначениеПроводки,
                              NULL,
                              NULL,
                              AccTrn
                           );

            if (stat)
                TrnMsg = "Ошибка отражения в учете";
                return 1;
            end;   

            PrcSaveOperDoc(
                           DocID, 
                           1,
                           Chapter,
                           Debet, 
                           DebetDep,
                           DebetFIID, 
                           money(DebetCarrySum),
                           Credit,
                           CreditDep,
                           CreditFIID,
                           money(CreditCarrySum),
                           НазначениеПроводки);

            if (PrcSetAccTrnQuitLink(cntsched.rec.CntSchedID, 
                                money(CarrySum), 
                                money(DebetCarrySum), 
                                prccntopr.rec.DocDate,
                                AccTrn.AccTrnID
                                ))
                return 1;
            end;
        end;
           
 
        if (PrcSetCntSchedFactSumByID(cntsched.rec.CntSchedID, cntsched.rec.SumCalc, {curdate}, cntsched.rec.DateReal) != 0)
            return 1;
        end;
  
        if (PrcSetOperSum(DocID, CarrySum) != 0)
            return 1;
        end;      
      
        TrnMsg = "Отражение в учете проведено";

        // вторая проводка 
        if (
            (TypeDocs == PRC_ACCSCHEMA_PRIV_ADDCH) or       // привлечение. доначисление делаем
            ((TypeDocs == PRC_ACCSCHEMA_RAZM_NONBAL) or      // размещение.внебаланс
            (TypeDocs == PRC_ACCSCHEMA_RAZM_NONBAL_OD) or   // размещение.внебаланс.просрочка 
            (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL) or  // размещение.баланс и внебаланс
            (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD) 
            and ({curdate} < ДАТА_ВВОДА)) // размещение.баланс и внебаланс.просрочка
        )
            if (AlienAcc2  or (Debet2Dep != Credit2Dep))  
                if ( UserAccount == "" ) // Если счет в макросе не задан, то выдать сообщение
                    if (CarrySum2 != 0)
                        if (ResKind == PRC_RESKIND_PRIV)
                            TrnMsg = "Невозможно создать проводку оплаты. Неизвестен счет получателя. |Требуется настройка макроса формирования проводок mpcpay50.mac";
                        else
                            TrnMsg = "Невозможно создать проводку оплаты. Неизвестен счет плательщика. |Требуется настройка макроса формирования проводок mpcpay50.mac";
                        end;
                        return 1;
                    end;
                else // Заполнить счет значением, задаваемым в макросе
                    if (ResKind == PRC_RESKIND_PRIV)
                        Credit2 = UserAccount;
                        Credit2FIID = UserFIID;
                    else
                        Debet2 = UserAccount;
                        Debet2FIID = UserFIID;
                    end;
                end;
            end; 

            if (Debet2FIID != ContrFIID)
                ConvSum(Debet2CarrySum, CarrySum2, prccntopr.rec.DocDate, ContrFIID, Debet2FIID );
            else
                Debet2CarrySum  = CarrySum2;
            end;

            if (Credit2FIID != ContrFIID)
                ConvSum(Credit2CarrySum, CarrySum2, prccntopr.rec.DocDate, ContrFIID, Credit2FIID );
            else
                Credit2CarrySum = CarrySum2; 
            end;

            if (CarrySum2 != 0) 
                stat = Prc_DocCarry( 
                              Chapter2,                    // Глава
                              Debet2FIID,                  // Дебет
                              Credit2FIID,                         // Валюта
                              Debet2,                      // Дебет
                              Credit2,                     // Кредит
                              Debet2CarrySum, 
                              Credit2CarrySum,              // сколько
                              prccntopr.rec.DocDate,          // За какое число
                              "09",
                              NULL,
                              0,                           // CarryResult
                              НазначениеПроводки2,
                              NULL,
                              NULL,
                              AccTrn2
                           );

                if (stat)
                    TrnMsg = "Ошибка отражения в учете";
                    return 1;
                end;
 
                PrcSaveOperDoc(
                            DocID, 
                            2,
                            Chapter2,
                            Debet2, 
                            Debet2Dep,
                            Debet2FIID, 
                            money(Debet2CarrySum),
                            Credit2,
                            Credit2Dep,
                            Credit2FIID,
                            money(Credit2CarrySum),
                        НазначениеПроводки2);

                if ((TypeDocs == PRC_ACCSCHEMA_PRIV_ADDCH) or 
                    (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL) or
                    (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD)
                    and ({curdate} < ДАТА_ВВОДА)
                )
                    if (PrcSetAccTrnQuitLink(cntsched.rec.CntSchedID,  money(CarrySum2), money(DebetCarrySum), prccntopr.rec.DocDate, AccTrn2.AccTrnID))
                        return 1;
                    end;
                end;
            end;
        end;

        // третья проводка 
        if (          
            ((TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL) or
            (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD)) and ({curdate} < ДАТА_ВВОДА)
        )
            if (AlienAcc3  or (Debet3Dep != Credit3Dep))  
                if ( UserAccount == "" ) // если счет в макросе не задан, то выдать сообщение
                    if (CarrySum3 != 0)
                        TrnMsg = "Невозможно создать проводку оплаты. Неизвестен счет плательщика. |Требуется настройка макроса формирования проводок mpcpay50.mac";
                        return 1;
                    end;
                else // Заполнить счет значением, задаваемым в макросе
                    Debet3 = UserAccount;
                    Debet3FIID = UserFIID;
                end;
            end; 

            if (Debet3FIID != ContrFIID)
                ConvSum(Debet3CarrySum, CarrySum3, prccntopr.rec.DocDate, ContrFIID, Debet3FIID );
            else
                Debet3CarrySum  = CarrySum3;
            end;

            if (Credit3FIID != ContrFIID)
                ConvSum(Credit3CarrySum, CarrySum3, prccntopr.rec.DocDate, ContrFIID, Credit3FIID );
            else
                Credit3CarrySum = CarrySum3; 
            end;

            if (CarrySum3 != 0) 
                stat = Prc_DocCarry( 
                                 Chapter3,                    // Глава
                                 Debet3FIID,                  // Дебет
                                 Credit3FIID,                         // Валюта
                                 Debet3,                      // Дебет
                                 Credit3,                     // Кредит
                                 Debet3CarrySum, 
                                 Credit3CarrySum,              // сколько
                                 prccntopr.rec.DocDate,          // За какое число
                                 "09",
                                 NULL,
                                 0,                           // CarryResult
                                 НазначениеПроводки3
                              );

                if (stat)
                    TrnMsg = "Ошибка отражения в учете";
                    return 1;
                end;             
 
                PrcSaveOperDoc(
                           DocID, 
                           3,
                           Chapter3,
                           Debet3, 
                           Debet3Dep,
                           Debet3FIID, 
                           money(Debet3CarrySum),
                           Credit3,
                           Credit3Dep,
                           Credit3FIID,
                           money(Credit3CarrySum),
                           НазначениеПроводки3);
            end;
        end;
    else  // если работаем с РКО
		if (ИнитЗначенияНастройкиПроцентов(PRC_REESTR_POSTDOC, @flagPostDoc) != 0)
			return 1;
        end;            
      
        if (prccontract.rec.ResKind == PRC_RESKIND_PRIV)   // привлечение
            if ((DebetDep == CreditDep) and (prccntopr.rec.isCreateMO == "X") and (not AlienAcc))
                PaymentDoc  = PRC_PAYMDOC_BANKORDER;         
            else
                PaymentDoc  = PRC_PAYMDOC_BANKPAYM;
            end;

            if (TypeDocs == PRC_ACCSCHEMA_PRIV_ADDCH)
                if ((Debet2Dep == Credit2Dep) and (prccntopr.rec.isCreateMO == "X") and (not AlienAcc))
                    PaymentDoc2  = PRC_PAYMDOC_BANKORDER;          
                else
                    PaymentDoc2  = PRC_PAYMDOC_BANKPAYM;
                end;
            end;
        else  // размещение
            if (AlienAcc)    // если счет плательщика не в нашем банке:
                TrnMsg = "Невозможно создать платежное требование |к счету, открытому не в нашем банке";
			    return 1;
            end;
         
		    //если счета открыты в разных филиалах, то формируется рублевое клиентское требование или клиентский валютный платеж и выгружается в РКО филиала плательщика.
            if (DebetDep != CreditDep)
                if ((DebetFIID == NATCUR) and (CreditFIID == NATCUR) and (prccontract.rec.FIID == NATCUR))
                PaymentDoc  = PRC_PAYMDOC_CLIENTORDER;
                else
                    PaymentDoc  = PRC_PAYMDOC_CLIENTPAYM;
                end;
            else //Иначе, если оба счета открыты в одном филиале:			
			    if (prccntopr.rec.isCreateMO == "X")
				    PaymentDoc  = PRC_PAYMDOC_BANKORDER;
			    else 
				    if ((Debet2FIID == NATCUR) and (Credit2FIID == NATCUR) and (prccontract.rec.FIID == NATCUR))
				    	PaymentDoc  = PRC_PAYMDOC_CLIENTORDER;
				    else
				    	PaymentDoc  = PRC_PAYMDOC_CLIENTPAYM;
				    end;
			    end; 
            end;

            if (          
                ((TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL) or
                (TypeDocs == PRC_ACCSCHEMA_RAZM_BAL_NONBAL_OD))
                and ({curdate} < ДАТА_ВВОДА)
            )
                if (AlienAcc2) /*i.  Если счет плательщика не в нашем банке:*/
				    TrnMsg = "Невозможно создать платежное требование |к счету, открытому не в нашем банке";
				    return 1;
                end;
			
                if (prccntopr.rec.isCreateMO == "X")
					PaymentDoc2  = PRC_PAYMDOC_BANKORDER;
			    else 
				    if ((Debet2FIID == NATCUR) and (Credit2FIID == NATCUR) and (prccontract.rec.FIID == NATCUR))
					    PaymentDoc2  = PRC_PAYMDOC_CLIENTORDER;
				    else
					    PaymentDoc2  = PRC_PAYMDOC_CLIENTPAYM;
				    end;
			    end;
            end;
        end;
      
        //  формируем документы РБ:
        // первый документ
        if ((PaymentDoc == PRC_PAYMDOC_BANKORDER) and (CarrySum > 0))
            Prc_CreateBankOrder( DebetFIID, 
                              CreditFIID, 
                              Debet, 
                              Credit, 
                              prccntopr.rec.DocDate, 
                              CarrySum, 
                              prccontract.rec.FIID,
                              НазначениеПроводки,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              DebetSettAcc,
                              CreditSettAcc,
                              flagPostDoc); 
      
        elif ((PaymentDoc == PRC_PAYMDOC_BANKPAYM) and (CarrySum > 0))
            Prc_FormBankPayment( DebetFIID, 
                              CreditFIID, 
                              Debet, 
                              Credit,
                              DebetDep,
                              CreditDep,
                              prccntopr.rec.DocDate, 
                              CarrySum, 
                              prccontract.rec.FIID, 
                              null, 
                              НазначениеПроводки,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              DebetSettAcc,
                              CreditSettAcc,
                              flagPostDoc);
      
        elif ((PaymentDoc == PRC_PAYMDOC_CLIENTORDER) and (CarrySum > 0))
            Prc_FormClientOrder( DebetFIID, 
                              CreditFIID, 
                              Debet, 
                              Credit, 
                              prccntopr.rec.DocDate, 
                              CarrySum, 
                              prccontract.rec.FIID,
                              НазначениеПроводки,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              DebetSettAcc,
                              CreditSettAcc,
                              flagPostDoc);
      
        elif ((PaymentDoc == PRC_PAYMDOC_CLIENTPAYM) and (CarrySum > 0))
            Prc_FormClientPaym( DebetFIID, 
                             CreditFIID, 
                             Debet, 
                             Credit, 
                             prccntopr.rec.DocDate, 
                             CarrySum, 
                             prccontract.rec.FIID,
                             НазначениеПроводки,
                             cntsched.rec.CntSchedID,
                             prccntopr.rec.DocID,
                             DebetSettAcc,
                             CreditSettAcc,
                             flagPostDoc);
        end;
      
        // второй документ
        if ((PaymentDoc2 == PRC_PAYMDOC_BANKORDER) and (CarrySum2 > 0))
            Prc_CreateBankOrder ( Debet2FIID, 
                              Credit2FIID, 
                              Debet2, 
                              Credit2, 
                              prccntopr.rec.DocDate, 
                              CarrySum2, 
                              prccontract.rec.FIID,
                              НазначениеПроводки2,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              Debet2SettAcc,
                              Credit2SettAcc,
                              flagPostDoc);
        elif ((PaymentDoc2 == PRC_PAYMDOC_BANKPAYM) and (CarrySum2 > 0))
            Prc_FormBankPayment ( Debet2FIID, 
                              Credit2FIID, 
                              Debet2, 
                              Credit2,
                              Debet2Dep,
                              Credit2Dep,
                              prccntopr.rec.DocDate, 
                              CarrySum2, 
                              prccontract.rec.FIID, 
                              null, 
                              НазначениеПроводки2,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              Debet2SettAcc,
                              Credit2SettAcc,
                              flagPostDoc);
        elif ((PaymentDoc2 == PRC_PAYMDOC_CLIENTORDER) and (CarrySum2 > 0))         
            Prc_FormClientOrder( Debet2FIID, 
                              Credit2FIID, 
                              Debet2, 
                              Credit2, 
                              prccntopr.rec.DocDate, 
                              CarrySum2, 
                              prccontract.rec.FIID,
                              НазначениеПроводки2,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              Debet2SettAcc,
                              Credit2SettAcc,
                              flagPostDoc);
        elif ((PaymentDoc2 == PRC_PAYMDOC_CLIENTPAYM) and (CarrySum2 > 0))         
            Prc_FormClientPaym(  Debet2FIID, 
                              Credit2FIID, 
                              Debet2, 
                              Credit2, 
                              prccntopr.rec.DocDate, 
                              CarrySum2, 
                              prccontract.rec.FIID,
                              НазначениеПроводки2,
                              cntsched.rec.CntSchedID,
                              prccntopr.rec.DocID,
                              Debet2SettAcc,
                              Credit2SettAcc,
                              flagPostDoc);
        end;

        if ((PaymentDoc != PRC_PAYMDOC_NONE) and (CarrySum > 0))
            if (DebetFIID != ContrFIID)
                ConvSum(DebetCarrySum, CarrySum, prccntopr.rec.DocDate, ContrFIID, DebetFIID );
            else
                DebetCarrySum  = CarrySum;
            end;

            if (CreditFIID != ContrFIID)
                ConvSum(CreditCarrySum, CarrySum, prccntopr.rec.DocDate, ContrFIID, CreditFIID );
            else
                CreditCarrySum = CarrySum; 
            end;         

            PrcSaveOperDoc(
                           DocID, 
                           1,
                           Chapter,
                           Debet, 
                           DebetDep,
                           DebetFIID, 
                           money(DebetCarrySum),
                           Credit,
                           CreditDep,
                           CreditFIID,
                           money(CreditCarrySum),
                           НазначениеПроводки);
        end;
      
        if ((PaymentDoc2 != PRC_PAYMDOC_NONE) and (CarrySum2 > 0))
            if (Debet2FIID != ContrFIID)
                ConvSum(Debet2CarrySum, CarrySum2, prccntopr.rec.DocDate, ContrFIID, Debet2FIID );
            else
                Debet2CarrySum  = CarrySum2;
            end;

            if (Credit2FIID != ContrFIID)
                ConvSum(Credit2CarrySum, CarrySum2, prccntopr.rec.DocDate, ContrFIID, Credit2FIID );
            else
                Credit2CarrySum = CarrySum2; 
            end;

            PrcSaveOperDoc(
                           DocID, 
                           2,
                           Chapter2,
                           Debet2, 
                           Debet2Dep,
                           Debet2FIID, 
                           money(Debet2CarrySum),
                           Credit2,
                           Credit2Dep,
                           Credit2FIID,
                           money(Credit2CarrySum),
                           НазначениеПроводки2);
        end;
      
    
        if (PrcSetPayState(cntsched.rec.CntSchedID, PRC_PAYSTATUS_NOT_PAID, cntsched.rec.PayState) != 0)
            return 1;
        end;
        TrnMsg = "Сформированные документы переданы в обработку";      
    end; // Если работаем с РКО
         
    if (TypeDocs == PRC_ACCSCHEMA_PRIV_ADDCH)
        if (PrcInsertAddChargePeriod( ContractID,
                                    prccntopr.rec.DocDate,
                                    cntsched.rec.periodbegindate,
                                    cntsched.rec.periodenddate,
                                    money(0),
                                    money(CarrySum2),
                                    prccntopr.rec.DocID) != 0)
            return 1;
        end;
    end;
      
   return 0;
END;


MACRO ExecuteStep(Buffer, Document)
   var cmd,rs,cmd2,rs2,
       ЗначениеНастройки,
       ChainBeginDate,
       ChainEndDate,
       stat = 0,
       BeginQual = 0,
       EndQual = 0,
       CurrQual = 0,
       CntSchedID = 0,
       CntOprDocID = 0,
       DateDecr;
   SetBuff( cntopr_buf, Document );
   ContractID = cntopr_buf.ContractID;
   DocID      = cntopr_buf.DocID;

   prccntopr.KeyNum = 0;  
   prccntopr.rec.DocID = DocID;
   if (not prccntopr.GetEQ)
      PrcSendMessage(ContractID, "Не найдена операция оплаты");
      return 1;
   end; 

   TypeDocs = prccntopr.rec.TypeDocs;
   OldTypeDocs = TypeDocs;
   ChainBeginDate = prccntopr.rec.BeginDate;
   ChainEndDate = prccntopr.rec.EndDate;

   ClearRecord( contract_buf );

   prccontract.KeyNum = 0;  
   prccontract.rec.ContractID = ContractID;
   if (not prccontract.GetEQ)
      PrcSendMessage(ContractID, "Не найден договор с ID = " + ContractID);
      return 1;
   end;

   ResKind = prccontract.rec.ResKind;
   CntOprDocID = prccntopr.rec.DocID;
   CntSchedID = GetCntSchedID(ContractID, 3 , prccntopr.rec.OperDate);
   if (CntSchedID != 0)
      cntsched.KeyNum = 0;  
      cntsched.rec.CntSchedID = CntSchedID;
      if (not cntsched.GetEQ)
         PrcSendMessage(ContractID, "Не найден период оплаты на дату" + prccntopr.rec.OperDate);
         return 1;
      end;
   else
      PrcSendMessage(ContractID, "Не найден период оплаты на дату" + prccntopr.rec.OperDate);
      return 1;
   end;


   if (cntsched.rec.SumCalc == 0)
      if (PrcSetCntSchedFactSumByID(CntSchedID, money(0), {curdate}, cntsched.rec.DateReal) != 0)
         return 1;
      end;
      return 0;   
   end;

   stat = PrcDefineTransSchema(ContractID, CntSchedID,prccntopr.rec.DocDate, @TypeDocs, 
                            @SumChargeFact, @SumChargeBalance, @SumChargeNonBalance);
   if (stat)
      if (stat > 1)
         MemoryError(stat);
         DisplayError();                            
      end;
      return 1;
   end;

   if (TypeDocs == 0)
      PrcSendMessage(ContractID, "Схема проводок не определена");
      return 1;
   end;

   PrcSetOperTypeDocs(DocID, TypeDocs, OldTypeDocs);
  
   if (DoOperationCarry() != 0)
      if (TrnMsg != "")
         PrcSendMessage(ContractID, TrnMsg);
      end;
      return 1;
   end;

   if (TrnMsg != "")
      PrcSendMessage(ContractID, TrnMsg);
   end;
   
   return 0;
   
END;


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */


   return 0;
END;




MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)       /* Вид шага операции */ 

  exit(1); 

END;

