//-----------------------------------------------------------------------------
// Блок      : 29011 - "Возврат из БО"
// Шаг       : 10    - "Обработка выполненных проводок"
// Назначение: Макрос шага
// Описание  : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, cbsttls, OprInter, pm_tools;

var PaymentObj:RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
MACRO ExecuteStep( doc, paymDoc, DocKind, ID_Operation )

  if( PaymentObj.PayerGroup != PAYMENTS_GROUP_EXTERNAL )
    PaymentObj.FreeReserve( PaymentObj.PayerAccount, 1/*CHAPT1*/ , PaymentObj.PayerFIID );
  end;

  var text;
  if( IsClaimByOperStep(ID_Operation) )
    text = "По платежному документу имеется документ, изменяющий претензию. ";
    if(not IsOprMultiExec())
      if( RsbGetTrue( false, false, text + "|Вы действительно хотите выполнить возврат платежного документа?" ) == false ) 
        return 1;
      end;
    else
      msgbox(text + "Платежный документ должен быть обработан в единичном режиме.");
      return 1;  
    end;
  end;

  // Удаляем проводки
  if( not OprDeleteDocumentsPaymObject(PaymentObj.PaymentID) )
    msgbox("Ошибка при удалении проводок");
    return 1;
  end;

  if( УстановитьСтатусыПлатежа( OPR_PAYM_STATE, OPR_PM_ST_REJECT ) )
    msgbox("Ошибка при установке сегментов статуса экземпляра операции");
    return 1;
  end;

  return 0;
END;
