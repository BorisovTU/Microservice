/************************************************************************/
/*         €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 2002              */
/*                                                                      */
/*  ˆ¬ï ä ©«       : mostvalpr.mac                                      */
/*                                                                      */
/*  ¯¨á ­¨¥       : ¥ç âì ®à¤¥à  ¯® ¯¥à¥¤ ç¥ æ¥­­®áâ¥© 0402102        */
/*                                                                      */
/*  à®£à ¬¬¨áâ    : —ãª¨­  ’.€.                                        */
/*                                                                      */
/*  ‘®§¤ ­         : 06.05.11                                           */
/*                                                                      */
/************************************************************************/

import globals;//, FIInter, PTInter, PaymInter;
import prpmbuff, prpmboi;

var pr_cb_doc:TRecHandler  = TRecHandler("cb_doc.dbt", "bank.def");

PRIVATE MACRO FillPayAmountStr( Amount, FIID, ArraySum )

  var CURtext = ""; 
  
  if( FIID != 0 )
    CURtext = CurToStrAlt(Amount, NULL, NULL, GetISOCode(FIID));    
  else  
    CURtext = RubToStrAlt(Amount);
  end;

  StrSplit(CURtext, ArraySum, 60, 60, 2);
   
END;

PRIVATE CLASS TPayInstruction
  var Account    : string,
      FIID       : integer,
      Amount     : string;
END;

/* ‡ ¯®«­¥­¨¥ áç¥â®¢ ¨ áã¬¬ ¨§ à §­®áª¨ ¨«¨ ¥á«¨ ­¥â à §­®áª¨ ¨§ ¯« â¥¦  Pmpaym */
private macro FillPIList( PIList:TArray, pmpaym:TRecHandler, DebetCredit:integer )
  
  var i : integer = 0;
  var pi : TPayInstruction;
  
  // ¨é¥¬ à §­®áªã ¢ pmaddpi
  var payment : RsbPayment = RsbPayment(pmpaym.rec.PaymentID),
      pmaddpi : TRecHandler = TRecHandler( "pmaddpi.dbt" ),
      stat    : integer = payment.PIList( DebetCredit ).First();

  if ( not stat ) // ¥á«¨ ¥áâì, § ¯®«­ï¥¬ ¨§ à §­®áª¨
    i = 0;
    while( not stat )
      stat = payment.PIList( DebetCredit ).Current( pmaddpi );
      if( not stat )
        pi = TPayInstruction();
        pi.Account    = pmaddpi.rec.Account;
        pi.FIID       = pmaddpi.rec.FIID;
        pi.Amount     = string(pmaddpi.rec.Amount:f);
        PIList.value( i ) = pi;
        i = i + 1;
        stat = payment.PIList( DebetCredit ).Next();
      end;
    end;
  else // ¥á«¨ ­¥â à §­®áª¨, ¡¥à¥¬ ¨§ pmpaym
    pi = TPayInstruction();
    if (DebetCredit == PRT_Debet)
      pi.Account = pmpaym.rec.PayerAccount;
      pi.FIID    = pmpaym.rec.FIID;
      pi.Amount  = string(pmpaym.rec.Amount:f);
    else
      pi.Account = pmpaym.rec.ReceiverAccount;
      pi.FIID    = pmpaym.rec.PayFIID;
      pi.Amount  = string(pmpaym.rec.PayAmount:f);
    end;
    PIList.value(0) = pi;       
  end;
end;

MACRO PrintOrder0402102(ncopy:integer)

  array aBankName, aAmount;
  StrSplit ( {Name_Bank}, aBankName, 38, 38, 3 );

  var DebetList : TArray, CreditList : TArray;
  DebetList  = TArray;
  FillPIList( DebetList, pr_pmpaym, PRT_Debet );
  CreditList = TArray;
  FillPIList( CreditList, pr_pmpaym, PRT_Credit );
  // …á«¨ ­¥â à §­®áª¨ ¨ ¯® ¤¥¡¥âã ¨ ¯® ªà¥¤¨âã, â® ¯®«¥ CredAmount ­¥ § ¯®«­ï¥âáï
  if ( (DebetList.size < 2) and (CreditList.size < 2) )
    CreditList.value(0).Amount = "";
  end;

  if ( DebetList.size < 2 )
    FillPayAmountStr( pr_pmpaym.rec.Amount, pr_pmpaym.rec.FIID, aAmount );
  else
    FillPayAmountStr( pr_pmpaym.rec.PayAmount, pr_pmpaym.rec.PayFIID, aAmount );
  end;

  while(ncopy > 0)
    ncopy = ncopy - 1;
    [
                                                                                   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                                                                                   ³    Š®¤ ä®à¬ë    ³
                                                                                   ³¤®ªã¬¥­â  ¯® Š“„³
                                         ÚÄÄÄÄÄÄÄÄÄÄÄÄ¿                            ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
          à¤¥à ¯® ¯¥à¥¤ ç¥ æ¥­­®áâ¥©  ü ³##########  ³                            ³     0402102     ³
                                         ÀÄÄÄÄÄÄÄÄÄÄÄÄÙ                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
         #
                                                                                ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       ¨¬¥­®¢ ­¨¥ ¡ ­ª :                                       „……’           ³    ‘ã¬¬  (æ¨äà ¬¨) ³
       ####################################### ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ####################################### ³áç¥â ü #########################³ ###################³]
    (  pr_pmrmprop.rec.Number:l,
       pr_pmrmprop.rec.Date:m:f,
       aBankName(0),
       aBankName(1), DebetList.value(0).Account:l, DebetList.value(0).Amount:r );
       
    var i : integer = 1;
    while( i < DebetList.size )

    [                                          ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³
                                               ³áç¥â ü #########################³ ###################³]
      (DebetList.value(i).Account:l, DebetList.value(i).Amount:r);
      i = i + 1;
    end;
      
    [                                          ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³
                                                                                ³                    ³
      Š®¬ã ¯à¨­ ¤«¥¦ â æ¥­­®áâ¨:                                Š…„ˆ’          ³                    ³
                                               ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³
                                               ³áç¥â ü #########################³ ###################³]
    ( CreditList.value(0).Account:l, CreditList.value(0).Amount:r );

    i = 1;   
    while( i < CreditList.size )

    [                                          ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³
                                               ³áç¥â ü #########################³ ###################³]
      (CreditList.value(i).Account:l, CreditList.value(i).Amount:r);
      i = i + 1;
    end;
    
    [                                          ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
      ‘®¤¥à¦ ­¨¥ ®¯¥à æ¨¨: ##########################################################################
      ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»
      º            ¨¬¥­®¢ ­¨¥ æ¥­­®áâ¥©                     ³    Š®«¨ç¥áâ¢®    ³    ‘ã¬¬  (æ¨äà ¬¨) º
      ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
      º                                                      ³                  ³                    º
      ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
      º                                                      ³                  ³                    º
      ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
      º                                                      ³                  ³                    º
      ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
      º                                                      ³                  ³                    º
      ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
      º                                                      ³                  ³                    º
      ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼
      ‘ã¬¬  ¯à®¯¨áìî á ãª § ­¨¥¬ ¢ «îâë: ############################################################
                                         ############################################################

      ãå£ «â¥àáª¨© à ¡®â­¨ª   ________________________  ___________________________________________
                                   («¨ç­ ï ¯®¤¯¨áì)             (ä ¬¨«¨ï, ¨­¨æ¨ «ë)

      –¥­­®áâ¨ ¯¥à¥¤ ­ë:
      Š áá®¢ë© à ¡®â­¨ª        ________________________  ___________________________________________
                                   («¨ç­ ï ¯®¤¯¨áì)             (ä ¬¨«¨ï, ¨­¨æ¨ «ë)

      Š«¨¥­â (à ¡®â­¨ª ¡ ­ª )                             
                               ________________________  ___________________________________________
                                   («¨ç­ ï ¯®¤¯¨áì)             (ä ¬¨«¨ï, ¨­¨æ¨ «ë)

      à¥¤êï¢«¥­ ¤®ªã¬¥­â, ã¤®áâ®¢¥àïîé¨© «¨ç­®áâì: 
      
          
    ]( pr_pmrmprop.rec.Ground,
       aAmount(0),
       aAmount(1) );
  end;


END;

MACRO PrintDocument(ncopy:integer):bool
  
  var DocKind:integer = pr_pmpaym.rec.DocKind;

  if( ( (DocKind != 70/*DLDOC_MEMORIALORDER*/) and (DocKind != 74/*DLDOC_SUMMARY_MEMORDER*/) ) or  
      pr_pmpaym.rec.Chapter != 3 )
    MsgBox("„ ­­ë© ¢¨¤ ¤®ªã¬¥­â  ­¥ ¯®¤¤¥à¦¨¢ ¥âáï ¬ ªà®á®¬");
    return FALSE;
  end;

  PrintOrder0402102(ncopy);

  return TRUE;
END;
