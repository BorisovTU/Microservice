/*
    Информирование о необработанных документах
    Картотека 2

            Mikhailov S., 22.08.2001, Wed

    
*/
import cbinfcom;
import cbinfint;
import CurrInter;
import RSD, cb_sql;

/*__________________________________*/
macro CBINF_Proc( RegPath, OutType/*CBINF_Out...*/ )
    var this_stat, nmbRec = 0, cmd, rs;

    var Rest ;
    
    file psindacc( psindacc ) key 0;
    file account( account ) key 0;/*ch acc*/
    file accountC( accountC ) key 0;/*ch acc code_currency */

    CBINF_ErrorStatus = 0;
    CBINF_Result = 0;
    

    if( OutType == CBINF_OutReport )
        if( PrintHeader( RegPath, LIST_I2 ) )
            return CBINF_StatusError;
        end;
    end;

/*    rewind ( psindacc );*/
    
        InitProgress( NRecords(psindacc), "Информирование о необработанных документах", "Картотека 2" );
        
/*    while( next( psindacc ) )*/
    cmd = RSDCommand("select t.*" +
                      " from dpsindacc_dbt t " +
                      " where t.T_IndexNum = " + CARDINDEX2 );
    rs = RsdRecordset( cmd );           
    cmd.execute;

    while (rs.MoveNext)

            nmbRec = nmbRec + 1;
            UseProgress( nmbRec );
            
/*        if( psindacc.IndexNum == CARDINDEX2  )*/

            CopyRSetToFBuff(psindacc, rs);

            Rest = Money( 0 );
            
            if( psindacc.FIID == 0 )
                account.chapter = psindacc.chapter;
                account.account = psindacc.account;
    
                if( not GetEq( account ))
                    CBINF_Error( "Не найден лицевой счет", OutType );
                        RemProgress( nmbRec );
                    return CBINF_StatusError;
                end;
    
                if( CBINF_OperDocFit( account.oper ) == 0 )
                    Rest = RestA( account.account, null, null, account.chapter );
                end;
    
                
            else
                accountC.code_currency = psindacc.fiid;
                accountC.chapter = psindacc.chapter;
                accountC.account = psindacc.account;
    
                if( not GetEq( accountC ))
                    CBINF_Error( "Не найден лицевой счет", outType );
                        RemProgress( nmbRec );
                    return CBINF_StatusError;
                end;
    
                if( CBINF_OperDocFit( accountC.oper ) == 0 )
                    Rest = RestAC( accountC.account, accountC.code_currency, null, null, accountC.chapter );
                end;
    
    
            end;/*if psindacc.fiid */
    
    
    
            if( Rest != Money( 0 ) )        
    /*Передаем остаток через структуру psindacc...*/        
                    psindacc.sum  = rest;
    
                    if( OutType == CBINF_OutMsg )
                    
                        this_stat = MsgDocFound( RegPath, CBINF_I2, psindacc );
                        if( this_stat )
                                        RemProgress( nmbRec );
                            return this_stat;
                        end;
                        
                    elif( OutType == CBINF_OutReport )
                        this_stat = PrintLine( RegPath, CBINF_I2, psindacc );
                        if( this_stat )
                                        RemProgress( nmbRec );
                            return this_stat;
                        end;
                        
                    end;/*OutType*/
                    
            end;/*if Rest */
/*        end; if indexnum */
    end;/*while*/


    RemProgress( nmbRec );

/**/
    if( OutType == CBINF_OutReport )
        if( PrintFooter( RegPath, LIST_I2 ) )
            return CBINF_StatusError;
        end;
    end;


    return CBINF_StatusOk;
    
end;/*CBINF_Proc*/

/*test call
const REGPATH = "COMMON\\CBINFPARMS";
var ret;

ret = CBINF_Proc( REGPATH, CBINF_OutReport);

msgbox( "test : stat =  ", ret , " CBINF_Result = ", CBINF_Result );

*/

