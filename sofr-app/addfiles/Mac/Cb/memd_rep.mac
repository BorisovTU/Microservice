/*
$Name: memd_rep.mac
$Module: Ядро ГКБО
$Description: Печать ведомости расхождения для документа и дубликата
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.10                                         R-Style Software Lab

  File Name   : memd_rep.mac
  Created     : 23.03.2003
  Programmer  : Андреева Е.П.
  Description : Печать ведомости расхождения для документа и дубликата
└───────────────────────────────────────────────────────────────────────────*/
IMPORT BankInter, PaymInter, "ver_rep.mac", FIInter, OprInter, globals, oralib, likepy;

 record morder     (memorder);
 record pm_paym    (pmpaym);
 record pm_debet   (pmprop);
 record pm_credit  (pmprop);
 record pm_rmprop  (pmrmprop);
 record pm_demand  (pmdemand);
 record pm_kz      (pmkz); 

 record dmorder    (memorddu);
 record dpm_paym   (pmdupaym);
 record dpm_debet  (pmduprop);
 record dpm_credit (pmduprop);
 record dpm_rmprop (pmdurmpp);
 record dpm_demand (pmdemand);
 record dpm_kz     (pmdupkz);

/*номера полей в панели*/
const mo_fld_Number     = 1,              
      mo_fld_Date       = 2,              
      mo_fld_Kind1      = 3,              
      mo_fld_Kind2      = 4,              
      mo_fld_INNP       = 5,              
      mo_fld_NameP      = 6,              
      mo_fld_Sum        = 7,              
      mo_fld_AccountP   = 8,              
      mo_fld_BankP      = 9,              
      mo_fld_CodeKindP  = 10,             
      mo_fld_CodeKind2P = 11,             
      mo_fld_CodeP      = 12,             
      mo_fld_BankAccP   = 13,             
      mo_fld_BankR      = 14,             
      mo_fld_CodeKindR  = 15,             
      mo_fld_CodeKind2R = 16,             
      mo_fld_CodeR      = 17,             
      mo_fld_BankAccR   = 18,             
      mo_fld_INNR       = 19,             
      mo_fld_NameR      = 20,             
      mo_fld_AccountR   = 21,             
      mo_fld_Ground     = 22,             
      mo_fld_Shifr      = 23,             
      mo_fld_Pack       = 24,             
      mo_fld_Priority   = 25,             
      mo_fld_PayDate    = 26,             
      mo_fld_ValueDate  = 27,             
      mo_fld_Department = 28,             
      mo_fld_Operation  = 29,             
      mo_fld_OpName     = 30;             

const mo_kzfld_Number         = 1, /* Для казахов */
      mo_kzfld_Date           = 2,
      mo_kzfld_KindPaym       = 3,
      mo_kzfld_KindPaymName   = 4,
      mo_kzfld_ValueDate      = 5,
      mo_kzfld_rnnpayer       = 6,
      mo_kzfld_payercode      = 7,
      mo_kzfld_payer          = 8,
      mo_kzfld_kbkname        = 9,
      mo_kzfld_kbk            = 10,
      mo_kzfld_sum            = 11,
      mo_kzfld_iikpayer       = 12,
      mo_kzfld_bnkreceiver    = 13,
      mo_kzfld_kndcoderec     = 14,
      mo_kzfld_kndcoderecname = 15,
      mo_kzfld_coderec        = 16,
      mo_kzfld_rnnreceiver    = 17,
      mo_kzfld_reccode        = 18,
      mo_kzfld_receiver       = 19,
      mo_kzfld_iikreceiver    = 20,
      mo_kzfld_knpname        = 21,
      mo_kzfld_ground         = 22,
      mo_kzfld_knp            = 23,
      mo_kzfld_shifroper      = 24,
      mo_kzfld_paydate        = 25,
      mo_kzfld_priority       = 26,
      mo_kzfld_instancy       = 27,
      mo_kzfld_numberpack     = 28,
      mo_kzfld_depname        = 29,
      mo_kzfld_kindoper       = 30,
      mo_kzfld_kindopername   = 31;


PRIVATE MACRO needUseKZpm():bool
  var err:integer = 0;
  var locale:string = "";
  GetRegistryValue("CB\\PAYMENTS\\PANEL\\LOCALE", V_STRING, locale, err);
  return ( ( err == 0 ) AND ( index( strupr(locale), "KZ" ) ) );
END;

PRIVATE MACRO getKNPName( Element:integer ):string
  var query:string = " select llv.T_NAME " +
                       " from dllvalues_dbt llv " +
                      " where llv.T_LIST = 1804 " +
                        " and llv.T_ELEMENT = :ELEMENT ";
  VAR params:TArray = makeArray( SQLParam( "ELEMENT", Element ) );
  VAR rset:RsdRecordset = execSQLselect( query, params, TRUE );

  if( rset and rset.moveNext() )
    return ( rset.value(0) );
  end;     
  return string(Element);
END;

macro Print_Cround(pn1,pn2)
   Print_LargeStr("'"+pn1+"'","'"+pn2+"'", "Назначение платежа");
end;

MACRO Print_ReportHeader()
[                          Отчет о групповой верификации                        ];
[                     платежных документов банка и дубликатов                   ];
[───────────────────────────────────────────────────────────────────────────────];
END;

MACRO Print_ReportItog()
  Print_Itog();
END;

MACRO Print_ReportMemOrder(dord, dpaym, drm, ddeb, dcred, ord, paym, rm, deb, cred, ddm, dm, dpmkz, pmkz, pr_rep, locked, locktax)
  setbuff( morder,     ord   );
  setbuff( dmorder,    dord  );
  setbuff( pm_paym,    paym  );
  setbuff( dpm_paym,   dpaym );
  setbuff( pm_debet,   deb   );
  setbuff( dpm_debet,  ddeb  );
  setbuff( pm_credit,  cred  );
  setbuff( dpm_credit, dcred );
  setbuff( pm_rmprop,  rm    );
  setbuff( dpm_rmprop, drm   );
  setbuff( pm_demand,  dm    );
  setbuff( dpm_demand, ddm   );
  setbuff( pm_kz,      pmkz  );
  setbuff( dpm_kz,     dpmkz );
  
  var i = 0;

if( morder.DocKind != DLDOC_BANKCLAIM )
[
  Для дубликата
     Номер:   #########################
     Сумма:   ############################
     Дата валютирования:  ################
  Найден документ
     Номер    ##########################
     Сумма:   ############################
     Дата валютирования:  ################
]

( dpm_rmprop.Number:l, dpm_paym.Amount:l:f, dpm_paym.ValueDate:l,
  pm_rmprop.Number:l,  pm_paym.Amount:l:f,  pm_paym.ValueDate:l   );
else
[
  Для дубликата
     Номер:   #########################
     Сумма:   ############################
     Дата валютирования:  ################
  Найден документ
     Номер    ##########################
     Сумма:   ############################
     Дата валютирования:  ################
]
( dpm_rmprop.Number:l, dpm_paym.BaseAmount:l:f, dpm_paym.ValueDate:l,
  pm_rmprop.Number:l,  pm_paym.BaseAmount:l:f,  pm_paym.ValueDate:l   );

end;

/* Ведомость расхождения печатается при соответствующей настройке */
if( pr_rep )
   Print_Head();
   if((SubStr( locked, mo_fld_Number, 1 ) == " ") and (pm_rmprop.Number != dpm_rmprop.Number))
      Print_SmallStr(pm_rmprop.Number, dpm_rmprop.Number, "Номер"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_Date, 1 ) == " ") and (pm_rmprop.Date != dpm_rmprop.Date))
      Print_SmallStr(pm_rmprop.Date, dpm_rmprop.Date, "Дата"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_Kind1, 1 ) == " ") and (pm_rmprop.PaymentKind != dpm_rmprop.PaymentKind))
      Print_PaymentKind(pm_rmprop.PaymentKind, dpm_rmprop.PaymentKind); i = i+1;
   end;

   if((SubStr( locked, mo_fld_Sum, 1 ) == " ") and (pm_paym.Amount != dpm_paym.Amount))
      Print_Amount(pm_paym.Amount, dpm_paym.Amount, "Сумма"); i = i+1;
   end;

   if(((SubStr( locked, mo_fld_INNP, 1 ) == " ") or (SubStr( locktax, tax_fld_PayerINN, 1 ) == " ") or (SubStr( locktax, tax_fld_PayerKPP, 1 ) == " "))and
      (pm_rmprop.PayerINN != dpm_rmprop.PayerINN))
      Print_PayerINN(pm_rmprop.PayerINN, dpm_rmprop.PayerINN); i = i+1;
   end;

   if((SubStr( locked, mo_fld_NameP, 1 ) == " ") and (pm_rmprop.PayerName != dpm_rmprop.PayerName))
      Print_PayerName(pm_rmprop.PayerName,dpm_rmprop.PayerName); i = i+1;
   end;

   if((SubStr( locked, mo_fld_AccountP, 1 ) == " ") and (pm_paym.PayerAccount != dpm_paym.PayerAccount))
      Print_SmallStr(pm_paym.PayerAccount, dpm_paym.PayerAccount, "Счет плательщика"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_BankP, 1 ) == " ") and (pm_rmprop.PayerBankName != dpm_rmprop.PayerBankName))
      Print_PayerBankName(pm_rmprop.PayerBankName,dpm_rmprop.PayerBankName); i = i+1;
   end;

   if((SubStr( locked, mo_fld_CodeKindP, 1 ) == " ") and (pm_debet.CodeKind != dpm_debet.CodeKind))
      Print_CodeKindP(pm_debet.CodeKind, dpm_debet.CodeKind); i = i+1;
   end;

   if((SubStr( locked, mo_fld_CodeP, 1 ) == " ") and (pm_debet.BankCode != dpm_debet.BankCode))
      Print_SmallStr(pm_debet.BankCode, dpm_debet.BankCode, "Код банка плательщика"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_BankAccP, 1 ) == " ") and (pm_rmprop.PayerCorrAccNostro != dpm_rmprop.PayerCorrAccNostro))
      Print_SmallStr(pm_rmprop.PayerCorrAccNostro, dpm_rmprop.PayerCorrAccNostro, "Корсчет банка получателя"); i = i+1;
   end;
      
   if((SubStr( locked, mo_fld_BankR, 1 ) == " ") and (pm_rmprop.ReceiverBankName != dpm_rmprop.ReceiverBankName))
      Print_ReceiverBankName(pm_rmprop.ReceiverBankName,dpm_rmprop.ReceiverBankName); i = i+1;
   end;

   if((SubStr( locked, mo_fld_CodeKindR, 1 ) == " ") and (pm_credit.CodeKind != dpm_credit.CodeKind))
      Print_CodeKind(pm_credit.CodeKind, dpm_credit.CodeKind); i = i+1;
   end;

   if((SubStr( locked, mo_fld_CodeR, 1 ) == " ") and (pm_credit.BankCode != dpm_credit.BankCode))
      Print_SmallStr(pm_credit.BankCode, dpm_credit.BankCode, "Код банка получателя"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_BankAccR, 1 ) == " ") and (pm_rmprop.ReceiverCorrAccNostro != dpm_rmprop.ReceiverCorrAccNostro))
      Print_SmallStr(pm_rmprop.ReceiverCorrAccNostro, dpm_rmprop.ReceiverCorrAccNostro, "Корсчет банка получателя"); i = i+1;
   end;

   if(((SubStr( locked, mo_fld_INNR, 1 ) == " ") or (SubStr( locktax, tax_fld_ReceiverINN, 1 ) == " ") or (SubStr( locktax, tax_fld_ReceiverKPP, 1 ) == " ")) and
      (pm_rmprop.ReceiverINN != dpm_rmprop.ReceiverINN))
      Print_ReceiverINN(pm_rmprop.ReceiverINN,dpm_rmprop.ReceiverINN); i = i+1;
   end;

   if((SubStr( locked, mo_fld_NameR, 1 ) == " ") and (pm_rmprop.ReceiverName != dpm_rmprop.ReceiverName))
      Print_ReceiverName(pm_rmprop.ReceiverName,dpm_rmprop.ReceiverName); i = i+1;
   end;

   if((SubStr( locked, mo_fld_AccountR, 1 ) == " ") and (pm_paym.ReceiverAccount != dpm_paym.ReceiverAccount))
      Print_SmallStr(pm_paym.ReceiverAccount, dpm_paym.ReceiverAccount, "Счет получателя"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_Ground, 1 ) == " ") and (pm_rmprop.Ground != dpm_rmprop.Ground))
      Print_Cround(pm_rmprop.Ground, dpm_rmprop.Ground); i = i+1;
   end;

   if((SubStr( locked, mo_fld_Shifr, 1 ) == " ") and (pm_rmprop.ShifrOper != dpm_rmprop.ShifrOper))
      Print_SmallStr(pm_rmprop.ShifrOper, dpm_rmprop.ShifrOper, "Шифр"); i = i+1;
   end;
   
   if((SubStr( locked, mo_fld_Pack, 1 ) == " ") and (pm_paym.NumberPack != dpm_paym.NumberPack))
      Print_SmallStr(pm_paym.NumberPack, dpm_paym.NumberPack, "Номер пачки"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_Priority, 1 ) == " ") and (pm_rmprop.Priority != dpm_rmprop.Priority))
      Print_SmallStr(pm_rmprop.Priority, dpm_rmprop.Priority, "Очередность"); i = i+1;
   end;

   if((SubStr( locked, mo_fld_PayDate, 1 ) == " ") and (pm_rmprop.PayDate != dpm_rmprop.PayDate))
      Print_SmallStr(pm_rmprop.PayDate, dpm_rmprop.PayDate, "Срок платежа"); i = i+1;
   end;
  
   if((SubStr( locked, mo_fld_ValueDate, 1 ) == " ") and (pm_paym.ValueDate != dpm_paym.ValueDate))
      Print_SmallStr(pm_paym.ValueDate, dpm_paym.ValueDate, "Валютирование"); i = i+1;
   end;

   /* Всякие налоговые заморочки - кроме ИНН и КПП */
   if((SubStr( locktax, tax_fld_AuthorStatusCode, 1 ) == " " ) and (pm_rmprop.TaxAuthorState != dpm_rmprop.TaxAuthorState))
      Print_SmallStr(pm_rmprop.TaxAuthorState, dpm_rmprop.TaxAuthorState, "Статус составителя"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_TaxCode, 1 ) == " ") and (pm_rmprop.BttTICode != dpm_rmprop.BttTICode))
      Print_SmallStr(pm_rmprop.BttTICode, dpm_rmprop.BttTICode, "Код бюджетной классификации"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_OKATOCode, 1 ) == " ") and (pm_rmprop.OKATOCode != dpm_rmprop.OKATOCode))
      Print_SmallStr(pm_rmprop.OKATOCode, dpm_rmprop.OKATOCode, "Код ОКАТО"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_GroundCode, 1 ) == " ") and (pm_rmprop.TaxPmGround != dpm_rmprop.TaxPmGround))
      Print_SmallStr(pm_rmprop.TaxPmGround, dpm_rmprop.TaxPmGround, "Код основания документа"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_Period, 1 ) == " ") and (pm_rmprop.TaxPmPeriod != dpm_rmprop.TaxPmPeriod))
      Print_SmallStr(pm_rmprop.TaxPmPeriod, dpm_rmprop.TaxPmPeriod, "Налоговый период"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_Number, 1 ) == " ") and (pm_rmprop.TaxPmNumber != dpm_rmprop.TaxPmNumber))
      Print_SmallStr(pm_rmprop.TaxPmNumber, dpm_rmprop.TaxPmNumber, "Номер налогового документа"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_Date, 1 ) == " ") and (pm_rmprop.TaxPmDate != dpm_rmprop.TaxPmDate))
      Print_SmallStr(pm_rmprop.TaxPmDate, dpm_rmprop.TaxPmDate, "Дата налогового документа"); i = i+1;
   end;

   if((SubStr( locktax, tax_fld_TypeCode, 1 ) == " ") and (pm_rmprop.TaxPmType != dpm_rmprop.TaxPmType))
      Print_SmallStr(pm_rmprop.TaxPmType, dpm_rmprop.TaxPmType, "Код типа налогового платежа"); i = i+1;
   end;
   
   if(needUseKZpm())
     if((SubStr( locked, mo_kzfld_payercode, 1 ) == " ") and (pm_kz.PayerCode!=dpm_kz.PayerCode))
        Print_SmallStr(pm_kz.PayerCode, dpm_kz.PayerCode, "Код отправителя денег"); i = i+1;
     end;

     if((SubStr( locked, mo_kzfld_reccode, 1 ) == " ") and (pm_kz.ReceiverCode!=dpm_kz.ReceiverCode))
       Print_SmallStr(pm_kz.ReceiverCode, dpm_kz.ReceiverCode, "Код бенефициара"); i = i+1;
     end;

     if((SubStr( locked, mo_kzfld_knp, 1 ) == " ") and (pm_kz.GroundCode!=dpm_kz.GroundCode))
       Print_SmallStr(getKNPName(pm_kz.GroundCode), getKNPName(dpm_kz.GroundCode), "Код назначения платежа"); i = i+1;
     end;     
   end;
   
   Print_Kolvo(i);
end;

return;
END;

/* Печать результатов верификации */
MACRO Print_Report(dord, dpaym, drm, ddeb, dcred, ord, paym, rm, deb, cred, ddm, dm, dpmkz, pmkz, pr_rep, locked, locktax)
  Print_ReportMemOrder (dord, dpaym, drm, ddeb, dcred, ord, paym, rm, deb, cred, ddm, dm, dpmkz, pmkz, pr_rep, locked, locktax);
  return 0;
END;

