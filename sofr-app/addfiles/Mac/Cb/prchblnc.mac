/*
$Name:           prchblnc.mac
$Module:         Ядро ГКБО
$Description:    Макрос формирования протокола проверки баланса
*/

/*
  Макрос формирования протокола проверки баланса

  Макрос пользовательской проверки должен содержать функцию с определенным именем и прототипом, пример реализации:

macro CheckBalance(Department, Chapter, ReportDate, TextLines)
  var i = 0;

  while(i < Chapter)
    TextLines[i] = "Department = " + string(Department) + ", Chapter = " + string(Chapter) + ", ReportDate = " + string(ReportDate);
    i = i + 1;
  end;

  return true;
end;

*/

import rsd, oralib, likepy, cb_sql, "globals.mac", FIInter;

var
  _CheckKind_1
 ,_CheckKind_2
 ,_CheckKind_3
 ,_CheckKind_4
 ,_CheckKind_5
 ,_CheckKind_6
 ,_CheckKind_7
 ,_CheckKind_8
 ,_MacroName
 ,_NatCurCode
 ;

private macro _FillReportCheckKind_1_NatCur
(
  Department
 ,ReportDate
 ,Chapter
 ,NatCurrency
)
  var query = "";
  var params : TArray;
  var AccTable;
  var RestFunc;
  var AddCondCurrency;

  if(NatCurrency)
    AccTable = "daccount_dbt";
    RestFunc = "RSB_ACCOUNT.resta(acc.t_Account, ?, acc.t_Chapter, 0)";
    AddCondCurrency = " AND acc.t_Code_Currency = 0 ";
  else
    AccTable = "daccount_dbt";
    RestFunc = "RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0)";
    AddCondCurrency = " AND acc.t_Code_Currency <> 0 ";
  end;

  query = query + "INSERT INTO dbalance_rep_tmp ";
  query = query + "( ";
  query = query + "  t_Department ";
  query = query + " ,t_Chapter ";
  query = query + " ,t_CheckKind ";
  query = query + " ,t_Account_1 ";
  query = query + " ,t_Kind_1 ";
  query = query + " ,t_Rest_1 ";
  query = query + " ,t_Val_1 ";
  query = query + ") ";
  query = query + "SELECT acc.t_Department ";
  query = query + "      ,acc.t_Chapter ";
  query = query + "      ,? ";
  query = query + "      ,acc.t_Account ";
  query = query + "      ,acc.t_Kind_Account ";
  query = query + "      ," + RestFunc + " ";
  query = query + "      ,fi.t_FI_Code ";
  query = query + "  FROM " + AccTable + " acc ";
  query = query + "      ,dfininstr_dbt fi ";
  query = query + " WHERE fi.t_FIID = acc.t_Code_Currency ";
  query = query + "   AND (   ? = 0  ";
  query = query + "        OR acc.t_Department = ?) ";
  query = query + "   AND (   (    ? = 0 ";
  query = query + "            AND (    acc.t_Chapter IN (SELECT t_Chapter ";
  query = query + "                                         FROM dobchaptr_dbt ";
  query = query + "                                        WHERE t_ExcludeFromFormalAcnt = CHR(0) ";
  query = query + "                                          AND t_Locked = CHR(0)) ";
  query = query + "                 AND acc.t_Chapter IN (SELECT t_Chapter FROM dnameplan_chaptr_dbt WHERE t_iNumPlan = 0))) ";
  query = query + "        OR acc.t_Chapter = ? ) ";
  query = query + "   AND acc.t_Type_Account NOT LIKE '%П%' ";
  query = query + "   AND acc.t_Type_Account NOT LIKE '%Щ%' ";
  query = query + "   AND (   (    acc.t_Kind_Account IN ('АП', '0') ";
  query = query + "            AND " + RestFunc + " <> 0) ";
  query = query + "        OR (    acc.t_Kind_Account = 'А' ";
  query = query + "            AND " + RestFunc + " > 0) ";
  query = query + "        OR (    acc.t_Kind_Account = 'П' ";
  query = query + "            AND " + RestFunc + " < 0) ";
  query = query + "       ) ";
  query = query + AddCondCurrency;

  params = makeArray
    (
      SQLParam("", 1)
     ,SQLParam("", ReportDate)
     ,SQLParam("", Department)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", Chapter)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
    );

  execSQL(query, params, true);
end;

private macro _FillReportCheckKind_1
(
  Department
 ,ReportDate
 ,Chapter
)
  _FillReportCheckKind_1_NatCur
  (
    Department
   ,ReportDate
   ,Chapter
   ,true
  );
  _FillReportCheckKind_1_NatCur
  (
    Department
   ,ReportDate
   ,Chapter
   ,false
  );
end;

private macro _FillReportCheckKind_2_NatCur
(
  Department
 ,ReportDate
 ,Chapter
 ,NatCurrency
)
  var query = "";
  var params : TArray;
  var AccTable;
  var RestFuncA;
  var RestFuncP;
  var AddCondCurrency;

  if(NatCurrency)
    AccTable = "daccount_dbt";
    RestFuncA = "RSB_ACCOUNT.resta(accA.t_Account, ?, accA.t_Chapter, 0)";
    RestFuncP = "RSB_ACCOUNT.resta(accP.t_Account, ?, accP.t_Chapter, 0)";
    AddCondCurrency = " AND accA.t_Code_Currency = 0 ";
  else
    AccTable = "daccount_dbt";
    RestFuncA = "RSB_ACCOUNT.restac(accA.t_Account, accA.t_Code_Currency, ?, accA.t_Chapter, 0)";
    RestFuncP = "RSB_ACCOUNT.restac(accP.t_Account, accP.t_Code_Currency, ?, accP.t_Chapter, 0)";
    AddCondCurrency = " AND accA.t_Code_Currency <> 0 ";
  end;

  query = query + "INSERT INTO dbalance_rep_tmp ";
  query = query + "( ";
  query = query + "  t_Department ";
  query = query + " ,t_Chapter ";
  query = query + " ,t_CheckKind ";
  query = query + " ,t_AccountA_2 ";
  query = query + " ,t_RestA_2 ";
  query = query + " ,t_ValA_2 ";
  query = query + " ,t_AccountP_2 ";
  query = query + " ,t_RestP_2 ";
  query = query + " ,t_ValP_2 ";
  query = query + ") ";
  query = query + "SELECT accA.t_Department ";
  query = query + "      ,accA.t_Chapter ";
  query = query + "      ,? ";
  query = query + "      ,accA.t_Account ";
  query = query + "      ," + RestFuncA + " ";
  query = query + "      ,fi.t_FI_Code ";
  query = query + "      ,accP.t_Account ";
  query = query + "      ," + RestFuncP + " ";
  query = query + "      ,fi.t_FI_Code ";
  query = query + "  FROM " + AccTable + " accA ";
  query = query + "      ," + AccTable + " accP ";
  query = query + "      ,dfininstr_dbt fi ";
  query = query + " WHERE fi.t_FIID = accA.t_Code_Currency ";
  query = query + "   AND (   ? = 0  ";
  query = query + "        OR accA.t_Department = ?) ";
  query = query + "   AND (   (    ? = 0 ";
  query = query + "            AND (    accA.t_Chapter IN (SELECT t_Chapter ";
  query = query + "                                          FROM dobchaptr_dbt ";
  query = query + "                                         WHERE t_ExcludeFromFormalAcnt = CHR(0) ";
  query = query + "                                           AND t_Locked = CHR(0)) ";
  query = query + "                 AND accA.t_Chapter IN (SELECT t_Chapter FROM dnameplan_chaptr_dbt WHERE t_iNumPlan = 0))) ";
  query = query + "        OR accA.t_Chapter = ? ) ";
  query = query + "   AND accA.t_Open_Date <= ? AND (? < accA.t_Close_Date OR accA.t_Close_Date = TO_DATE('01010001', 'DDMMYYYY'))";
  query = query + "   AND accA.t_Type_Account NOT LIKE '%П%' ";
  query = query + "   AND accA.t_Kind_Account = 'А' ";
  query = query + "   AND (   accA.t_Type_Account LIKE '%Ш%' ";
  query = query + "        OR accA.t_Type_Account LIKE '%N%' ";
  query = query + "       ) ";
  query = query + "   AND accA.t_PairAccount <> CHR(1) ";
  query = query + "   AND accP.t_Account       = accA.t_PairAccount ";
  query = query + "   AND accP.t_Code_Currency = accA.t_Code_Currency ";
  query = query + "   AND accP.t_Chapter       = accA.t_Chapter ";
  query = query + "   AND (   (    " + RestFuncA + " <> 0 ";
  query = query + "            AND " + RestFuncP + " <> 0 ";
  query = query + "           ) ";
  query = query + "        OR (    " + RestFuncA + " > 0 ";
  query = query + "            AND " + RestFuncP + " = 0 ";
  query = query + "           ) ";
  query = query + "        OR (    " + RestFuncA + " = 0 ";
  query = query + "            AND " + RestFuncP + " < 0 ";
  query = query + "           ) ";
  query = query + "       ) ";
  query = query + AddCondCurrency;

  params = makeArray
    (
      SQLParam("", 2)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", Department)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", Chapter)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
    );

  execSQL(query, params, true);
end;

private macro _FillReportCheckKind_2
(
  Department
 ,ReportDate
 ,Chapter
)
  _FillReportCheckKind_2_NatCur
  (
    Department
   ,ReportDate
   ,Chapter
   ,true
  );
  _FillReportCheckKind_2_NatCur
  (
    Department
   ,ReportDate
   ,Chapter
   ,false
  );
end;

private macro _GetContrBal(ContrBalA : @string, ContrBalP : @string, Chapter )
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT t_ContrBalA ";
  query = query + "      ,t_ContrBalP ";
  query = query + "  FROM dobchaptr_dbt ";
  query = query + " WHERE t_Chapter = ? ";

  params = makeArray
    (
      SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);

  if(rs and rs.moveNext)
    ContrBalA = rs.value(0);
    ContrBalP = rs.value(1);
    return true;
  end;

  return false;
end;

private macro _FillReportCheckKind_3
(
  Department
 ,ReportDate
 ,Chapter
)
  var query = "";
  var params : TArray;
  var ContrBalA, ContrBalP : string;

  if ( Chapter == 3 )

    _GetContrBal(@ContrBalA, @ContrBalP, Chapter);

    query = query + "INSERT INTO dbalance_rep_tmp ";
    query = query + "( ";
    query = query + "  t_Department ";
    query = query + " ,t_Chapter ";
    query = query + " ,t_CheckKind ";
    query = query + " ,t_Num_3 ";
    query = query + " ,t_AccountD_3 ";
    query = query + " ,t_AccountK_3 ";
    query = query + " ,t_Sum_3 ";
    query = query + " ,t_SumRub_3 ";
    query = query + ") ";
    query = query + "SELECT doc.t_Department ";
    query = query + "      ,doc.t_Chapter ";
    query = query + "      ,? ";
    query = query + "      ,doc.t_Numb_Document ";
    query = query + "      ,doc.t_Account_Payer ";
    query = query + "      ,doc.t_Account_Receiver ";
    query = query + "      ,doc.t_Sum_Payer ";
    query = query + "      ,doc.t_Sum_NatCur ";
    query = query + "  FROM dacctrn_dbt doc ";
    query = query + "      ,daccount_dbt accP ";
    query = query + "      ,daccount_dbt accR ";
    query = query + " WHERE doc.t_Date_Carry = ? ";
    query = query + "   AND doc.t_State = ? ";
    query = query + "   AND (   ? = 0  ";
    query = query + "        OR doc.t_Department = ?) ";
    query = query + "   AND doc.t_Chapter = ? ";
    query = query + "   AND accP.t_AccountID = doc.t_AccountID_Payer ";
    query = query + "   AND accR.t_AccountID = doc.t_AccountID_Receiver ";
    query = query + "   AND accP.t_Kind_Account IN ('А', 'П') ";
    query = query + "   AND accR.t_Kind_Account IN ('А', 'П') ";
    query = query + "   AND NOT (   (    (   accP.t_Balance = ? ";
    query = query + "                     OR (accP.t_Kind_Account = 'А' AND accP.t_Balance <> ?)) ";
    query = query + "                AND (   accR.t_Balance = ? ";
    query = query + "                     OR (accR.t_Kind_Account = 'А' AND accR.t_Balance <> ?))";
    query = query + "               ) ";
    query = query + "            OR (    (   accP.t_Balance = ? ";
    query = query + "                     OR (accP.t_Kind_Account = 'П' AND accP.t_Balance <> ?)) ";
    query = query + "                AND (   accR.t_Balance = ? ";
    query = query + "                     OR (accR.t_Kind_Account = 'П' AND accR.t_Balance <> ?))";
    query = query + "               ) ";
    query = query + "           ) ";
  
    params = makeArray
      (
        SQLParam("", 3)
       ,SQLParam("", ReportDate)
       ,SQLParam("", 1)
       ,SQLParam("", Department)
       ,SQLParam("", Department)
       ,SQLParam("", 3)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ContrBalP)
      );

    execSQL(query, params, true);
  end;

  if ( Chapter == 4 )

    _GetContrBal(@ContrBalA, @ContrBalP, Chapter);

    query = query + "INSERT INTO dbalance_rep_tmp ";
    query = query + "( ";
    query = query + "  t_Department ";
    query = query + " ,t_Chapter ";
    query = query + " ,t_CheckKind ";
    query = query + " ,t_Num_3 ";
    query = query + " ,t_AccountD_3 ";
    query = query + " ,t_AccountK_3 ";
    query = query + " ,t_Sum_3 ";
    query = query + " ,t_SumRub_3 ";
    query = query + ") ";
    query = query + "SELECT doc.t_Department ";
    query = query + "      ,doc.t_Chapter ";
    query = query + "      ,? ";
    query = query + "      ,doc.t_Numb_Document ";
    query = query + "      ,doc.t_Account_Payer ";
    query = query + "      ,doc.t_Account_Receiver ";
    query = query + "      ,doc.t_Sum_Payer ";
    query = query + "      ,doc.t_Sum_NatCur ";
    query = query + "  FROM dacctrn_dbt doc ";
    query = query + "      ,daccount_dbt accP ";
    query = query + "      ,daccount_dbt accR ";
    query = query + " WHERE doc.t_Date_Carry = ? ";
    query = query + "   AND doc.t_State = ? ";
    query = query + "   AND (   ? = 0  ";
    query = query + "        OR doc.t_Department = ?) ";
    query = query + "   AND doc.t_Chapter = ? ";
    query = query + "   AND accP.t_AccountID = doc.t_AccountID_Payer ";
    query = query + "   AND accR.t_AccountID = doc.t_AccountID_Receiver ";
    query = query + "   AND accP.t_Kind_Account IN ('А', 'П') ";
    query = query + "   AND accR.t_Kind_Account IN ('А', 'П') ";
    query = query + "   AND NOT (        (  (accP.t_Kind_Account = 'А' AND accR.t_Balance = ?)   ";
    query = query + "                    OR (accR.t_Kind_Account = 'А' AND accP.t_Balance = ?) ) ";
    query = query + "                OR  (  (accP.t_Kind_Account = 'П' AND accR.t_Balance = ?)   ";
    query = query + "                    OR (accR.t_Kind_Account = 'П' AND accP.t_Balance = ?) ) ";
    query = query + "           ) ";
  
    params = makeArray
      (
        SQLParam("", 3)
       ,SQLParam("", ReportDate)
       ,SQLParam("", 1)
       ,SQLParam("", Department)
       ,SQLParam("", Department)
       ,SQLParam("", 4)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ContrBalA)
      );

    execSQL(query, params, true);
  end;

end;

private macro _FillReportCheckKind_4
(
  Department
 ,ReportDate
 ,Chapter
)
  var query = "";
  var params : TArray;
  var RestFuncAccCur;
  var RestFuncNatCur;
  var ContrBalA, ContrBalP : string;

  RestFuncAccCur = "RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0)";
  RestFuncNatCur = "RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0, 0)";

  query = query + "INSERT INTO dbalance_rep_tmp ";
  query = query + "( ";
  query = query + "  t_Department ";
  query = query + " ,t_Chapter ";
  query = query + " ,t_CheckKind ";
  query = query + " ,t_RestA_4 ";
  query = query + " ,t_RestP_4 ";
  query = query + ") ";
  query = query + "SELECT acc.t_Department ";
  query = query + "      ,acc.t_Chapter ";
  query = query + "      ,? ";
  query = query + "      ,SUM(NVL( ";
  query = query + "               CASE ";
  query = query + "               WHEN fi.t_FI_Kind = 2 ";
  query = query + "               THEN ";
  query = query + "                   CASE ";
  query = query + "                   WHEN acc.t_Kind_Account = 'А' OR (acc.t_Kind_Account IN ('АП', '0') AND " + RestFuncAccCur + " < 0) ";
  query = query + "                   THEN " + RestFuncAccCur + " ";
  query = query + "                   ELSE 0 ";
  query = query + "                   END ";
  query = query + "               ELSE ";
  query = query + "                   CASE ";
  query = query + "                   WHEN acc.t_Kind_Account = 'А' OR (acc.t_Kind_Account IN ('АП', '0') AND " + RestFuncNatCur + " < 0) ";
  query = query + "                   THEN " + RestFuncNatCur + " ";
  query = query + "                   ELSE 0 ";
  query = query + "                   END ";
  query = query + "               END, 0 ";
  query = query + "              ) ";
  query = query + "          ) ";
  query = query + "      ,SUM(NVL( ";
  query = query + "               CASE ";
  query = query + "               WHEN fi.t_FI_Kind = 2 ";
  query = query + "               THEN ";
  query = query + "                   CASE ";
  query = query + "                   WHEN acc.t_Kind_Account = 'П' OR (acc.t_Kind_Account IN ('АП', '0') AND " + RestFuncAccCur + " > 0) ";
  query = query + "                   THEN " + RestFuncAccCur + " ";
  query = query + "                   ELSE 0 ";
  query = query + "                   END ";
  query = query + "               ELSE ";
  query = query + "                   CASE ";
  query = query + "                   WHEN acc.t_Kind_Account = 'П' OR (acc.t_Kind_Account IN ('АП', '0') AND " + RestFuncNatCur + " > 0) ";
  query = query + "                   THEN " + RestFuncNatCur + " ";
  query = query + "                   ELSE 0 ";
  query = query + "                   END ";
  query = query + "               END, 0 ";
  query = query + "              ) ";
  query = query + "          ) ";
  query = query + "  FROM daccount_dbt acc ";
  query = query + "      ,dfininstr_dbt fi ";
  query = query + " WHERE fi.t_FIID = acc.t_Code_Currency ";
  query = query + "   AND (   ? = 0  ";
  query = query + "        OR acc.t_Department = ?) ";
  query = query + "   AND (   (    ? = 0 ";
  query = query + "            AND (    acc.t_Chapter IN (SELECT t_Chapter ";
  query = query + "                                         FROM dobchaptr_dbt ";
  query = query + "                                        WHERE t_ExcludeFromFormalAcnt = CHR(0) ";
  query = query + "                                          AND t_Locked = CHR(0)) ";
  query = query + "                 AND acc.t_Chapter IN (SELECT t_Chapter FROM dnameplan_chaptr_dbt WHERE t_iNumPlan = 0))) ";
  query = query + "        OR acc.t_Chapter = ? ) ";
  query = query + "   AND " + RestFuncAccCur + " <> 0 ";
  query = query + " GROUP BY acc.t_Department, acc.t_Chapter ";

  params = makeArray
    (
      SQLParam("", 4)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", Department)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", Chapter)
     ,SQLParam("", ReportDate)
    );

  execSQL(query, params, true);

  if((Chapter == 0) or (Chapter == 3))
    _GetContrBal(@ContrBalA, @ContrBalP, 3);

    query = "";
    query = query + "UPDATE dbalance_rep_tmp rep ";
    query = query + "   SET ";
    query = query + "     rep.t_Rest99998_4 = NVL((SELECT SUM(NVL( ";
    query = query + "                                         CASE ";
    query = query + "                                         WHEN fi.t_FI_Kind = 2 ";
    query = query + "                                         THEN " + RestFuncAccCur + " ";
    query = query + "                                         ELSE " + RestFuncNatCur + " ";
    query = query + "                                         END, 0 ";
    query = query + "                                        ) ";
    query = query + "                                    ) ";
    query = query + "                            FROM daccount_dbt acc ";
    query = query + "                                ,dfininstr_dbt fi ";
    query = query + "                           WHERE fi.t_FIID = acc.t_Code_Currency ";
    query = query + "                             AND acc.t_Department = rep.t_Department ";
    query = query + "                             AND acc.t_Chapter = rep.t_Chapter ";
    query = query + "                             AND acc.t_Balance = ? ";
    query = query + "                         ), 0) ";
    query = query + "    ,rep.t_Rest99999_4 = NVL((SELECT SUM(NVL( ";
    query = query + "                                         CASE ";
    query = query + "                                         WHEN fi.t_FI_Kind = 2 ";
    query = query + "                                         THEN " + RestFuncAccCur + " ";
    query = query + "                                         ELSE " + RestFuncNatCur + " ";
    query = query + "                                         END, 0 ";
    query = query + "                                        ) ";
    query = query + "                                    ) ";
    query = query + "                            FROM daccount_dbt acc ";
    query = query + "                                ,dfininstr_dbt fi ";
    query = query + "                           WHERE fi.t_FIID = acc.t_Code_Currency ";
    query = query + "                             AND acc.t_Department = rep.t_Department ";
    query = query + "                             AND acc.t_Chapter = rep.t_Chapter ";
    query = query + "                             AND acc.t_Balance = ? ";
    query = query + "                         ), 0) ";
    query = query + " WHERE rep.t_CheckKind = ? ";
    query = query + "   AND rep.t_Chapter = ? ";

    params = makeArray
      (
        SQLParam("", ReportDate)
       ,SQLParam("", ReportDate)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ReportDate)
       ,SQLParam("", ReportDate)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", 4)
       ,SQLParam("", 3)
      );

    execSQL(query, params, true);
    
    query = "";
    query = query + "UPDATE dbalance_rep_tmp rep ";
    query = query + "   SET ";
    query = query + "     rep.t_RestAMinus_4 = rep.t_RestA_4 - rep.t_Rest99998_4 ";
    query = query + "    ,rep.t_RestPMinus_4 = rep.t_RestP_4 - rep.t_Rest99999_4 ";
    query = query + " WHERE rep.t_CheckKind = ? ";
    query = query + "   AND rep.t_Chapter = ? ";

    params = makeArray
      (
        SQLParam("", 4)
       ,SQLParam("", 3)
      );

    execSQL(query, params, true);
    
  end;

  if((Chapter == 0) or (Chapter == 4))
    _GetContrBal(@ContrBalA, @ContrBalP, 4);

    query = "";
    query = query + "UPDATE dbalance_rep_tmp rep ";
    query = query + "   SET ";
    query = query + "     rep.t_Rest99998_4 = NVL((SELECT SUM(NVL( ";
    query = query + "                                         CASE ";
    query = query + "                                         WHEN fi.t_FI_Kind = 2 ";
    query = query + "                                         THEN " + RestFuncAccCur + " ";
    query = query + "                                         ELSE " + RestFuncNatCur + " ";
    query = query + "                                         END, 0 ";
    query = query + "                                        ) ";
    query = query + "                                    ) ";
    query = query + "                            FROM daccount_dbt acc ";
    query = query + "                                ,dfininstr_dbt fi ";
    query = query + "                           WHERE fi.t_FIID = acc.t_Code_Currency ";
    query = query + "                             AND acc.t_Department = rep.t_Department ";
    query = query + "                             AND acc.t_Chapter = rep.t_Chapter ";
    query = query + "                             AND acc.t_Balance = ? ";
    query = query + "                         ), 0) ";
    query = query + "    ,rep.t_Rest99999_4 = NVL((SELECT SUM(NVL( ";
    query = query + "                                         CASE ";
    query = query + "                                         WHEN fi.t_FI_Kind = 2 ";
    query = query + "                                         THEN " + RestFuncAccCur + " ";
    query = query + "                                         ELSE " + RestFuncNatCur + " ";
    query = query + "                                         END, 0 ";
    query = query + "                                        ) ";
    query = query + "                                    ) ";
    query = query + "                            FROM daccount_dbt acc ";
    query = query + "                                ,dfininstr_dbt fi ";
    query = query + "                           WHERE fi.t_FIID = acc.t_Code_Currency ";
    query = query + "                             AND acc.t_Department = rep.t_Department ";
    query = query + "                             AND acc.t_Chapter = rep.t_Chapter ";
    query = query + "                             AND acc.t_Balance = ? ";
    query = query + "                         ), 0) ";
    query = query + " WHERE rep.t_CheckKind = ? ";
    query = query + "   AND rep.t_Chapter = ? ";

    params = makeArray
      (
        SQLParam("", ReportDate)
       ,SQLParam("", ReportDate)
       ,SQLParam("", ContrBalA)
       ,SQLParam("", ReportDate)
       ,SQLParam("", ReportDate)
       ,SQLParam("", ContrBalP)
       ,SQLParam("", 4)
       ,SQLParam("", 4)
      );

    execSQL(query, params, true);
    
    query = "";
    query = query + "UPDATE dbalance_rep_tmp rep ";
    query = query + "   SET ";
    query = query + "     rep.t_RestAMinus_4 = rep.t_RestA_4 - rep.t_Rest99998_4 ";
    query = query + "    ,rep.t_RestPMinus_4 = rep.t_RestP_4 - rep.t_Rest99999_4 ";
    query = query + " WHERE rep.t_CheckKind = ? ";
    query = query + "   AND rep.t_Chapter = ? ";

    params = makeArray
      (
        SQLParam("", 4)
       ,SQLParam("", 4)
      );

    execSQL(query, params, true);
    
  end;
end;

private macro _GetRest
(
  Chapter : integer
 ,Account : string
 ,Code_Currency : integer
 ,Date_Value : date
 ,Rest_Currency : integer
) : money
  var query = "";
  var rs;
  var params : TArray;
  var Rest : money;

  query = query + "SELECT CAST(RSB_ACCOUNT.restac(?, ?, ?, ?, 0, ?) AS NUMBER(32, 12)) FROM dual";

  params = makeArray
    (
      SQLParam("", Account)
     ,SQLParam("", Code_Currency)
     ,SQLParam("", Date_Value)
     ,SQLParam("", Chapter)
     ,SQLParam("", Rest_Currency)
    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Rest = money(rs.value(0));
  else
    Rest = $0;
  end;
  return Rest;
end;

private macro _GetDebet
(
  AccountID : integer
 ,Date_Carry : date
 ,NatCurrency
) : money
  var query = "";
  var rs;
  var params : TArray;
  var Debet : money;

  if(NatCurrency)
    query = query + "SELECT CAST(NVL(SUM(t.t_Sum_NatCur), 0) AS NUMBER(32, 12)) ";
  else
    query = query + "SELECT CAST(NVL(SUM(t.t_Sum_Payer), 0) AS NUMBER(32, 12)) ";
  end;
  query = query + "  FROM dacctrn_dbt t ";
  query = query + " WHERE t.t_Date_Carry = ? ";
  query = query + "   AND t.t_State = ? ";
  query = query + "   AND t.t_AccountID_Payer = ? ";

  params = makeArray
    (
      SQLParam("", Date_Carry)
     ,SQLParam("", 1)
     ,SQLParam("", AccountID)
    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Debet = money(rs.value(0));
  else
    Debet = $0;
  end;
  return Debet;
end;

private macro _GetCredit
(
  AccountID : integer
 ,Date_Carry : date
 ,NatCurrency
) : money
  var query = "";
  var rs;
  var params : TArray;
  var Credit : money;

  if(NatCurrency)
    query = query + "SELECT CAST(NVL(SUM(t.t_Sum_NatCur), 0) AS NUMBER(32, 12)) ";
  else
    query = query + "SELECT CAST(NVL(SUM(t.t_Sum_Receiver), 0) AS NUMBER(32, 12)) ";
  end;
  query = query + "  FROM dacctrn_dbt t ";
  query = query + " WHERE t.t_Date_Carry = ? ";
  query = query + "   AND t.t_State = ? ";
  query = query + "   AND t.t_AccountID_Receiver = ? ";

  params = makeArray
    (
      SQLParam("", Date_Carry)
     ,SQLParam("", 1)
     ,SQLParam("", AccountID)
    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Credit = money(rs.value(0));
  else
    Credit = $0;
  end;
  return Credit;
end;

private macro _GetAccounts_5
(
  Department : integer
 ,Chapter : integer
 ,Date_Carry : date
 ,NatCurrency
)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT acc.t_Account ";
  query = query + "      ,acc.t_Chapter ";
  query = query + "      ,acc.t_Code_Currency ";
  query = query + "      ,acc.t_Department ";
  query = query + "      ,fi.t_FI_Code ";
  query = query + "      ,acc.t_AccountID ";
  query = query + "  FROM daccount_dbt acc ";
  query = query + "      ,dfininstr_dbt fi ";
  query = query + " WHERE fi.t_FIID = acc.t_Code_Currency ";
  if(NatCurrency)
    query = query + "   AND fi.t_FI_Kind <> 2 ";
  else
    query = query + "   AND acc.t_Code_Currency <> 0 ";
  end;
  query = query + "   AND (   ? = 0 ";
  query = query + "        OR acc.t_Department = ?) ";
  query = query + "   AND (   (    ? = 0 ";
  query = query + "            AND (    acc.t_Chapter IN (SELECT t_Chapter ";
  query = query + "                                         FROM dobchaptr_dbt ";
  query = query + "                                        WHERE t_ExcludeFromFormalAcnt = CHR(0) ";
  query = query + "                                          AND t_Locked = CHR(0)) ";
  query = query + "                 AND acc.t_Chapter IN (SELECT t_Chapter FROM dnameplan_chaptr_dbt WHERE t_iNumPlan = 0))) ";
  query = query + "        OR acc.t_Chapter = ? ) ";
  query = query + "   AND EXISTS(SELECT 1 ";
  query = query + "                FROM dacctrn_dbt doc ";
  query = query + "               WHERE (   doc.t_AccountID_Payer = acc.t_AccountID ";
  query = query + "                      OR doc.t_AccountID_Receiver = acc.t_AccountID ) ";
  query = query + "                 AND doc.t_Chapter = acc.t_Chapter ";
  query = query + "                 AND doc.t_Date_Carry = ? ";
  query = query + "                 AND doc.t_State = ? ";
  query = query + "                 AND ROWNUM = 1 ";
  query = query + "             ) ";

  params = makeArray
    (
      SQLParam("", Department)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", Chapter)
     ,SQLParam("", Date_Carry)
     ,SQLParam("", 1)
    );

  rs = execSQLselect(query, params, true);

  return rs;
end;

private macro _InsertRowReportCheckKind_5
(
  Department : integer
 ,Account : string
 ,Chapter : integer
 ,Val : string
 ,RestIn : money
 ,Debet : money
 ,Kredit : money
 ,RestOut : money
)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "INSERT INTO dbalance_rep_tmp ";
  query = query + "( ";
  query = query + "  t_Department ";
  query = query + " ,t_Chapter ";
  query = query + " ,t_CheckKind ";
  query = query + " ,t_Account_5 ";
  query = query + " ,t_Val_5 ";
  query = query + " ,t_RestIn_5 ";
  query = query + " ,t_Debet_5 ";
  query = query + " ,t_Kredit_5 ";
  query = query + " ,t_RestOut_5 ";
  query = query + ") ";
  query = query + "VALUES ";
  query = query + "( ";
  query = query + "  ? /*t_Department*/ ";
  query = query + " ,? /*t_Chapter*/ ";
  query = query + " ,? /*t_CheckKind*/ ";
  query = query + " ,? /*t_Account_5*/ ";
  query = query + " ,? /*t_Val_5*/ ";
  query = query + " ,? /*t_RestIn_5*/ ";
  query = query + " ,? /*t_Debet_5*/ ";
  query = query + " ,? /*t_Kredit_5*/ ";
  query = query + " ,? /*t_RestOut_5*/ ";
  query = query + ") ";

  params = makeArray
    (
      SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", 5)
     ,SQLParam("", Account)
     ,SQLParam("", Val)
     ,SQLParam("", RestIn)
     ,SQLParam("", Debet)
     ,SQLParam("", Kredit)
     ,SQLParam("", RestOut)
    );

  execSQL(query, params, true);

end;

private macro _FillReportCheckKind_5_NatCur
(
  Department
 ,ReportDate
 ,Chapter
 ,NatCurrency
)
  var rs;
  var RestIn, RestOut, Debet, Kredit : money;
  var PrevReportDate = ReportDate - 1;
  var RestCurrency;
  var CodeCurrency;

  rs = _GetAccounts_5
    (
      Department
     ,Chapter
     ,ReportDate
     ,NatCurrency
    );

  while(rs and rs.moveNext)

    if(NatCurrency)
      RestCurrency = NATCUR;
      CodeCurrency = _NatCurCode;
    else
      RestCurrency = rs.value(2);
      CodeCurrency = rs.value(4);
    end;

    RestIn = _GetRest
      (
        rs.value(1)
       ,rs.value(0)
       ,rs.value(2)
       ,PrevReportDate
       ,RestCurrency
      );
      
    RestOut = _GetRest
      (
        rs.value(1)
       ,rs.value(0)
       ,rs.value(2)
       ,ReportDate
       ,RestCurrency
      );

    Debet = _GetDebet
      (
        rs.value(5)
       ,ReportDate
       ,NatCurrency
      );

    Kredit = _GetCredit
      (
        rs.value(5)
       ,ReportDate
       ,NatCurrency
      );

    if((RestIn - Debet + Kredit) != RestOut)
      _InsertRowReportCheckKind_5
      (
        rs.value(3)
       ,rs.value(0)
       ,rs.value(1)
       ,CodeCurrency
       ,RestIn
       ,Debet
       ,Kredit
       ,RestOut
      );
    end;
  end;

end;

private macro _FillReportCheckKind_5
(
  Department
 ,ReportDate
 ,Chapter
)
  _FillReportCheckKind_5_NatCur
  (
    Department
   ,ReportDate
   ,Chapter
   ,true
  );
  _FillReportCheckKind_5_NatCur
  (
    Department
   ,ReportDate
   ,Chapter
   ,false
  );
end;

private macro _FillReportCheckKind_6
(
  Department
 ,ReportDate
 ,Chapter
)
  var query = "";
  var params : TArray;

  query = query + "INSERT INTO dbalance_rep_tmp ";
  query = query + "( ";
  query = query + "  t_Department ";
  query = query + " ,t_Chapter ";
  query = query + " ,t_CheckKind ";
  query = query + " ,t_Account_6 ";
  query = query + " ,t_Val_6 ";
  query = query + " ,t_RestVal_6 ";
  query = query + " ,t_RestNacVal_6 ";
  query = query + " ,t_RestCB_6 ";
  query = query + ") ";
  query = query + "SELECT acc.t_Department ";
  query = query + "      ,acc.t_Chapter ";
  query = query + "      ,? ";
  query = query + "      ,acc.t_Account ";
  query = query + "      ,fi.t_FI_Code ";
  query = query + "      ,RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0) ";
  query = query + "      ,RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0, 0) ";
  query = query + "      ,ROUND(RSB_FIINSTR.ConvSum(RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0), acc.t_Code_Currency, 0, ?), 2) ";
  query = query + "  FROM daccount_dbt acc ";
  query = query + "      ,dfininstr_dbt fi ";
  query = query + " WHERE fi.t_FIID = acc.t_Code_Currency ";
  query = query + "   AND fi.t_FI_Kind IN (1, 6) ";
  query = query + "   AND acc.t_Code_Currency <> 0";
  query = query + "   AND (   ? = 0 ";
  query = query + "        OR acc.t_Department = ?) ";
  query = query + "   AND (   (    ? = 0 ";
  query = query + "            AND (    acc.t_Chapter IN (SELECT t_Chapter ";
  query = query + "                                         FROM dobchaptr_dbt ";
  query = query + "                                        WHERE t_ExcludeFromFormalAcnt = CHR(0) ";
  query = query + "                                          AND t_Locked = CHR(0)) ";
  query = query + "                 AND acc.t_Chapter IN (SELECT t_Chapter FROM dnameplan_chaptr_dbt WHERE t_iNumPlan = 0))) ";
  query = query + "        OR acc.t_Chapter = ? ) ";
  query = query + "   AND acc.t_Type_Account NOT LIKE '%Н%' ";
  query = query + "   AND (   RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0) <> 0 ";
  query = query + "        OR RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0, 0) <> 0) ";
  query = query + "   AND RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0, 0) <> ";
  query = query + "       ROUND(RSB_FIINSTR.ConvSum(RSB_ACCOUNT.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0), acc.t_Code_Currency, 0, ?), 2) ";

  params = makeArray
    (
      SQLParam("", 6)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", Department)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", Chapter)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
     ,SQLParam("", ReportDate)
    );

  execSQL(query, params, true);
end;

private macro _GetDepartmentChapter
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT dpdep.t_Code, chapt.t_Chapter ";
  query = query + "  FROM ddp_dep_dbt dpdep, dobchaptr_dbt chapt ";
  query = query + " WHERE (   ? = 0 ";
  query = query + "        OR dpdep.t_Code = ?) ";
  query = query + "   AND dpdep.t_NodeType = 1 ";
  query = query + "   AND dpdep.t_Status = 2 ";
  query = query + "   AND (   (    ? = 0 ";
  query = query + "            AND chapt.t_ExcludeFromFormalAcnt = CHR(0) ";
  query = query + "            AND chapt.t_Locked = CHR(0) ";
  query = query + "            AND chapt.t_Chapter IN (SELECT t_Chapter FROM dnameplan_chaptr_dbt WHERE t_iNumPlan = 0)) ";
  query = query + "        OR chapt.t_Chapter = ? ) ";
    
  params = makeArray
    (
      SQLParam("", Department)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", Chapter)
    );
    
  rs = execSQLselect(query, params, true);

  return rs;
end;

private macro _InsertRowReportCheckKind_7
(
  Department : integer
 ,Chapter : integer
 ,TextLine : string
)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "INSERT INTO dbalance_rep_tmp ";
  query = query + "( ";
  query = query + "  t_Department ";
  query = query + " ,t_Chapter ";
  query = query + " ,t_CheckKind ";
  query = query + " ,t_Message_7 ";
  query = query + ") ";
  query = query + "VALUES ";
  query = query + "( ";
  query = query + "  ? /*t_Department*/ ";
  query = query + " ,? /*t_Chapter*/ ";
  query = query + " ,? /*t_CheckKind*/ ";
  query = query + " ,? /*t_Message_7*/ ";
  query = query + ") ";

  params = makeArray
    (
      SQLParam("", Department)
     ,SQLParam("", Chapter)
     ,SQLParam("", 7)
     ,SQLParam("", TextLine)
    );

  execSQL(query, params, true);

end;

private macro _FillReportCheckKind_7
(
  Department
 ,ReportDate
 ,Chapter
)
  var TextLines : TArray;
  var i;
  var rs = _GetDepartmentChapter(Department, Chapter);

  while(rs and rs.moveNext)
    TextLines = TArray;
    if(ExecMacroFile(_MacroName, "CheckBalance", rs.value(0), rs.value(1), ReportDate, TextLines))
      i = 0;
      while(i < TextLines.size())
        _InsertRowReportCheckKind_7(rs.value(0), rs.value(1), TextLines[i]);
        i = i + 1;
      end;
    end;
  end;
end;

private macro _PrintReportCheckKind_1
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;
  var count = 0;

  query = query + "SELECT t_Account_1 ";
  query = query + "      ,t_Kind_1 ";
  query = query + "      ,t_Rest_1 ";
  query = query + "      ,t_Val_1 ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_Account_1 ";

  params = makeArray
    (
      SQLParam("", 1)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);
[

Корректность остатков:];

  while(rs and rs.moveNext())

    if(count == 0)
[];
[+-------------------------+---------+--------------------+---------------+];
[|Лицевой счет             |Вид счета|Остаток             |Валюта счета   |];
[+-------------------------+---------+--------------------+---------------+];
    end;
[|#########################|    #    |####################| #             |] (rs.value(0), rs.value(1), rs.value(2), rs.value(3));
    
    count = count + 1;

  end;

  if(count > 0)
[+-------------------------+---------+--------------------+---------------+

Счета с некорректными остатками: #######] (count); 
  else
[
Счета с некорректными остатками: нет];
  end;
end;

private macro _PrintReportCheckKind_2
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;
  var count = 0;

  query = query + "SELECT t_AccountA_2 ";
  query = query + "      ,t_RestA_2 ";
  query = query + "      ,t_ValA_2 ";
  query = query + "      ,t_AccountP_2 ";
  query = query + "      ,t_RestP_2 ";
  query = query + "      ,t_ValP_2 ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_AccountA_2 ";

  params = makeArray
    (
      SQLParam("", 2)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);
[

Парные и сворачиваемые счета:];

  while(rs and rs.moveNext())

    if(count == 0)
[];
[+-------------------------+--------------------+---------------+-------------------------+--------------------+---------------+];
[|Активный счет            |Остаток             |Валюта счета   |Пассивный счет           |Остаток             |Валюта счета   |];
[+-------------------------+--------------------+---------------+-------------------------+--------------------+---------------+];
    end;
[|#########################|####################| #             |#########################|####################| #             |] 
(rs.value(0), rs.value(1), rs.value(2), rs.value(3), rs.value(4), rs.value(5));
    
    count = count + 1;

  end;

  if(count > 0)
[+-------------------------+--------------------+---------------+-------------------------+--------------------+---------------+

Неурегулированные пары счетов: #######] (count); 
  else
[
Неурегулированные пары счетов: нет];
  end;
end;

private macro _PrintReportCheckKind_3
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;
  var count = 0;

  query = query + "SELECT t_Num_3 ";
  query = query + "      ,t_AccountD_3 ";
  query = query + "      ,t_AccountK_3 ";
  query = query + "      ,t_Sum_3 ";
  query = query + "      ,t_SumRub_3 ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_Num_3 ";

  params = makeArray
    (
      SQLParam("", 3)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);

if (Chapter == 3)
[

Проводки по счетам главы "Внебалансовые счета":];
end;

if (Chapter == 4)
[

Проводки по счетам главы "Счета по учету требований и обязательств по производным 
финансовым инструментам и прочим договорам (сделкам), по которым расчеты и поставка 
осуществляются не ранее следующего дня, после дня заключения договора (сделки)":];
end;

  while(rs and rs.moveNext())

    if(count == 0)
[];
[+--------------+-------------------------+-------------------------+--------------------+--------------------+];
[|№№            |Счет дебета              |Счет кредита             |Сумма проводки      |Сумма в рублевом    |];
[|              |                         |                         |                    |эквиваленте         |];
[+--------------+-------------------------+-------------------------+--------------------+--------------------+];
    end;
[|##############|#########################|#########################|####################|####################|] 
(rs.value(0), rs.value(1), rs.value(2), rs.value(3), rs.value(4));
    
    count = count + 1;

  end;

  if(count > 0)
[+--------------+-------------------------+-------------------------+--------------------+--------------------+

Некорректные проводки: #######] (count); 
  else
[
Некорректные проводки: нет];
  end;
end;

private macro _PrintReportCheckKind_4
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT CAST(t_RestA_4 AS NUMBER(32, 12)) ";
  query = query + "      ,CAST(t_RestP_4 AS NUMBER(32, 12)) ";
  query = query + "      ,CAST(t_RestAMinus_4 AS NUMBER(32, 12)) ";
  query = query + "      ,CAST(t_Rest99999_4 AS NUMBER(32, 12)) ";
  query = query + "      ,CAST(t_RestPMinus_4 AS NUMBER(32, 12)) ";
  query = query + "      ,CAST(t_Rest99998_4 AS NUMBER(32, 12)) ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_Num_3 ";

  params = makeArray
    (
      SQLParam("", 4)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);

[

Сходимость баланса:];

  while(rs and rs.moveNext())

    if(Chapter == 3)
[];
[+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+];
[|Сумма активных      |Сумма пассивных     |Сумма активных      |Сумма балансового   |Сумма пассивных     |Сумма балансового   |];
[|счетов              |счетов              |счетов (кроме       |99999               |счетов (кроме       |99998               |];
[|                    |                    |балансового 99998)  |                    |балансового 99999)  |                    |];
[|                    |                    |                    |                    |                    |                    |];
[+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+];
[|####################|####################|####################|####################|####################|####################|] 
(rs.value(0), rs.value(1), rs.value(2), rs.value(3), rs.value(4), rs.value(5));
[+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+];
    elif(Chapter == 4)
[];
[+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+];
[|Сумма активных      |Сумма пассивных     |Сумма активных      |Сумма балансового   |Сумма пассивных     |Сумма балансового   |];
[|счетов              |счетов              |счетов (кроме       |99997               |счетов (кроме       |99996               |];
[|                    |                    |балансового 99996)  |                    |балансового 99997)  |                    |];
[|                    |                    |                    |                    |                    |                    |];
[+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+];
[|####################|####################|####################|####################|####################|####################|] 
(rs.value(0), rs.value(1), rs.value(2), rs.value(3), rs.value(4), rs.value(5));
[+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+];
    else
[];
[+--------------------+--------------------+];
[|Сумма активных      |Сумма пассивных     |];
[|счетов              |счетов              |];
[|                    |                    |];
[|                    |                    |];
[+--------------------+--------------------+];
[|####################|####################|] 
(rs.value(0), rs.value(1));
[+--------------------+--------------------+];
    end;

  end;

  if(abs(rs.value(0)) == abs(rs.value(1)))
[
Нарушение баланса по главе: нет]; 
  else
[
Нарушение баланса по главе: да]; 
  end;

  if((Chapter == 3) or (Chapter == 4))
    if((abs(rs.value(2)) == abs(rs.value(3))) and (abs(rs.value(4)) == abs(rs.value(5))))
[Нарушение баланса счетов для корреспонденции: нет]; 
    else
[Нарушение баланса счетов для корреспонденции: да]; 
    end;
  end;
end;

private macro _PrintReportCheckKind_5
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;
  var count = 0;

  query = query + "SELECT t_Account_5 ";
  query = query + "      ,t_Val_5 ";
  query = query + "      ,t_RestIn_5 ";
  query = query + "      ,t_Debet_5 ";
  query = query + "      ,t_Kredit_5 ";
  query = query + "      ,t_RestOut_5 ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_Account_5, t_Val_5 ";

  params = makeArray
    (
      SQLParam("", 5)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);

[

Остатки с учетом оборотов за день:];

  while(rs and rs.moveNext())

    if(count == 0)
[];
[+-------------------------+---------------+--------------------+--------------------+--------------------+--------------------+];
[|Счет                     |Валюта         |Вх. остаток         |Дебет               |Кредит              |Исх. остаток        |];
[+-------------------------+---------------+--------------------+--------------------+--------------------+--------------------+];
    end;
[|#########################| #             |####################|####################|####################|####################|] 
(rs.value(0), rs.value(1), rs.value(2), rs.value(3), rs.value(4), rs.value(5));
    
    count = count + 1;

  end;

  if(count > 0)
[+-------------------------+---------------+--------------------+--------------------+--------------------+--------------------+

Счета с некорректными остатками: #######] (count); 
  else
[
Счета с некорректными остатками: нет];
  end;
end;

private macro _PrintReportCheckKind_6
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;
  var count = 0;

  query = query + "SELECT t_Account_6 ";
  query = query + "      ,t_Val_6 ";
  query = query + "      ,t_RestVal_6 ";
  query = query + "      ,t_RestNacVal_6 ";
  query = query + "      ,t_RestCB_6 ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_Account_6 ";

  params = makeArray
    (
      SQLParam("", 6)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);
[

Остатки валютных счетов:];

  while(rs and rs.moveNext())

    if(count == 0)
[];
[+-------------------------+---------------+--------------------+--------------------+--------------------+];
[|Лицевой счет             |Валюта счета   |Остаток в валюте    |Остаток счета в     |Остаток счета в     |];
[|                         |               |счета               |национальной валюте |национальной валюте |];
[|                         |               |                    |                    |по курсу ЦБ         |];
[+-------------------------+---------------+--------------------+--------------------+--------------------+];
    end;
[|#########################| #             |####################|####################|####################|] 
(rs.value(0), rs.value(1), rs.value(2), rs.value(3), rs.value(4));
    
    count = count + 1;

  end;

  if(count > 0)
[+-------------------------+---------------+--------------------+--------------------+--------------------+

Счета с некорректными остатками: #######] (count); 
  else
[
Счета с некорректными остатками: нет];
  end;
end;

private macro _PrintReportCheckKind_7
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT t_Message_7 ";
  query = query + "  FROM dbalance_rep_tmp ";
  query = query + " WHERE t_CheckKind = ? ";
  query = query + "   AND t_Department = ? ";
  query = query + "   AND t_Chapter = ? ";
  query = query + " ORDER BY t_RecordID ";

  params = makeArray
    (
      SQLParam("", 7)
     ,SQLParam("", Department)
     ,SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);
[

Пользовательская проверка:

];

  while(rs and rs.moveNext())
[#
] (rs.value(0));
  end;
end;

private macro _PrintReportChapter
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT t_Name ";
  query = query + "  FROM dobchaptr_dbt ";
  query = query + " WHERE t_Chapter = ? ";

  params = makeArray
    (
      SQLParam("", Chapter)
    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
[

Глава счетов:       #] (rs.value(0));
  end;                         

  if(_CheckKind_1)
    _PrintReportCheckKind_1(Department, Chapter);
  end;

  if(_CheckKind_2)
    _PrintReportCheckKind_2(Department, Chapter);
  end;

  if(_CheckKind_3 and (Chapter == 3))
    _PrintReportCheckKind_3(Department, Chapter);
  end;

  if(_CheckKind_8 and (Chapter == 4))
    _PrintReportCheckKind_3(Department, Chapter);
  end;

  if(_CheckKind_4)
    _PrintReportCheckKind_4(Department, Chapter);
  end;

  if(_CheckKind_5)
    _PrintReportCheckKind_5(Department, Chapter);
  end;

  if(_CheckKind_6)
    _PrintReportCheckKind_6(Department, Chapter);
  end;

  if(_CheckKind_7)
    _PrintReportCheckKind_7(Department, Chapter);
  end;

end;

private macro _PrintReportChapters
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;

  if(Chapter == 0)

    query = query + "SELECT t_Chapter ";
    query = query + "  FROM dobchaptr_dbt ";
    query = query + " WHERE t_ExcludeFromFormalAcnt = CHR(0) ";
    query = query + "   AND t_Locked = CHR(0) ";
    query = query + "   AND t_Chapter IN (SELECT t1.t_Chapter FROM dnameplan_chaptr_dbt t1 WHERE t1.t_iNumPlan = 0) ";
    
    params = makeArray();
    
    rs = execSQLselect(query, params, true);
    while(rs and rs.moveNext())
      _PrintReportChapter(Department, rs.value(0));
    end;                         

  else
    _PrintReportChapter(Department, Chapter);
  end;

end;

private macro _PrintReportDepartment
(
  Department
 ,Chapter
)
  var query = "";
  var params : TArray;
  var rs;

  query = query + "SELECT t_Name ";
  query = query + "  FROM dparty_dbt ";
  query = query + " WHERE t_PartyID = (SELECT t_PartyID ";
  query = query + "                      FROM ddp_dep_dbt ";
  query = query + "                     WHERE t_Code = ?) ";

  params = makeArray
    (
      SQLParam("", Department)
    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
[

Филиал:             #] (rs.value(0));
  end;                         

  _PrintReportChapters(Department, Chapter);

end;

private macro _PrintReportDepartments
(
  Department
 ,ReportDate
 ,Chapter
)

  var query = "";
  var params : TArray;
  var rs;

[Протокол проверки данных баланса за ##########] (ReportDate:f);

  if(Department == 0)
    query = query + "SELECT t_Code ";
    query = query + "  FROM ddp_dep_dbt ";
    query = query + " WHERE t_NodeType = 1 ";
    query = query + "   AND t_Status = 2 ";
    query = query + " ORDER BY t_Code ";
    
    params = makeArray();
      
    rs = execSQLselect(query, params, true);
    while(rs and rs.moveNext())
      _PrintReportDepartment(rs.value(0), Chapter);
    end;                         

  else
    _PrintReportDepartment(Department, Chapter);
  end;

end;

macro PrintReportCheckBalance
(
  Department
 ,ReportDate
 ,Chapter
 ,CheckKind_1
 ,CheckKind_2
 ,CheckKind_3
 ,CheckKind_4
 ,CheckKind_5
 ,CheckKind_6
 ,CheckKind_7
 ,CheckKind_8
 ,MacroName
)
  _CheckKind_1 = CheckKind_1;
  _CheckKind_2 = CheckKind_2;
  _CheckKind_3 = CheckKind_3;
  _CheckKind_4 = CheckKind_4;
  _CheckKind_5 = CheckKind_5;
  _CheckKind_6 = CheckKind_6;
  _CheckKind_7 = CheckKind_7;
  _CheckKind_8 = CheckKind_8;
  _MacroName   = MacroName;
  _NatCurCode  = ПолучитьКодФинИн(NATCUR);

  SQL_Execute("TRUNCATE TABLE dbalance_rep_tmp");

  if(_CheckKind_1)
    _FillReportCheckKind_1(Department, ReportDate, Chapter);
  end;

  if(_CheckKind_2)
    _FillReportCheckKind_2(Department, ReportDate, Chapter);
  end;

  if(_CheckKind_3 and ((Chapter == 0) or (Chapter == 3)))
    _FillReportCheckKind_3(Department, ReportDate, 3);
  end;

  if(_CheckKind_8 and ((Chapter == 0) or (Chapter == 4)))
    _FillReportCheckKind_3(Department, ReportDate, 4);
  end;

  if(_CheckKind_4)
    _FillReportCheckKind_4(Department, ReportDate, Chapter);
  end;

  if(_CheckKind_5)
    _FillReportCheckKind_5(Department, ReportDate, Chapter);
  end;

  if(_CheckKind_6)
    _FillReportCheckKind_6(Department, ReportDate, Chapter);
  end;

  if(_CheckKind_7 and (_MacroName != ""))
    _FillReportCheckKind_7(Department, ReportDate, Chapter);
  end;

  _PrintReportDepartments(Department, ReportDate, Chapter);

[

Операционист: ##### #
] ({oper}, {Name_Oper});

end;
