/*
 *  Макрос шага "Проведение исправительного оборота" операции "Исправительный оборот" по первичному документу "Мультивалютный документ"
 */
import BankInter, FIInter, CTInter, OprInter, PaymInter, RSD, InsCarryDoc, "cortur_lib.mac";

var Date_Rate : date;
var PaymentObj : RsbPayment;

macro ExecuteStep( doc, primdoc )
  var stat = 0;
  var ПроводкаИсправительная = PaymentObj.MakeTransaction();
  var ПроводкаКурсовойРазницы : RsbAccTransaction; /*Создаем только для сторно*/
  var Multy : RsbMultyDoc = RsbMultyDoc( PaymentObj.DocumentID );

  ПроводкаИсправительная.Chapter         = Multy.Chapter;
  ПроводкаИсправительная.FIIDPayer       = PaymentObj.PayerFIID;
  ПроводкаИсправительная.FIIDReceiver    = PaymentObj.ReceiverFIID;
  ПроводкаИсправительная.SumPayer        = PaymentObj.PayerAmount;
  ПроводкаИсправительная.SumReceiver     = PaymentObj.ReceiverAmount;
  ПроводкаИсправительная.AccountPayer    = PaymentObj.PayerAccount;
  ПроводкаИсправительная.AccountReceiver = PaymentObj.ReceiverAccount;
  ПроводкаИсправительная.Date_Carry      = PaymentObj.ValueDate;
  ПроводкаИсправительная.Numb_Document   = PaymentObj.Number;
  ПроводкаИсправительная.Ground          = PaymentObj.Ground;
  ПроводкаИсправительная.TypeDocument    = Multy.Type_Document;
  ПроводкаИсправительная.Number_Pack     = PaymentObj.NumberPack;
  ПроводкаИсправительная.Department      = PaymentObj.Department;
  ПроводкаИсправительная.Date_Rate       = Date_Rate;

  if(index(ПроводкаИсправительная.TypeDocument, "S") > 0)
    FillMultyCurrAccTrn(ПроводкаИсправительная, CB_MULTYDOC, Multy.AutoKey);
    ПроводкаКурсовойРазницы = RsbAccTransaction;
    FillMultyCurrExRateAccTrn(ПроводкаКурсовойРазницы, CB_MULTYDOC, Multy.AutoKey);

    ПроводкаКурсовойРазницы.Numb_Document    = PaymentObj.Number;
    ПроводкаКурсовойРазницы.Date_Carry       = ПроводкаИсправительная.Date_Carry;
    ПроводкаКурсовойРазницы.Ground           = ПроводкаИсправительная.Ground;
    ПроводкаКурсовойРазницы.TypeDocument     = ПроводкаИсправительная.TypeDocument;
    ПроводкаКурсовойРазницы.Number_Pack      = ПроводкаИсправительная.Number_Pack;
    ПроводкаКурсовойРазницы.Shifr_Oper       = ПроводкаИсправительная.Shifr_Oper;
    ПроводкаКурсовойРазницы.Department       = ПроводкаИсправительная.Department;
    ПроводкаКурсовойРазницы.UserTypeDocument = ПроводкаИсправительная.UserTypeDocument;
    ПроводкаКурсовойРазницы.ResultCarry      = DELTARATE_MCD;

    if(ПроводкаКурсовойРазницы.AccTrnID == 0)
      ПроводкаКурсовойРазницы.AccTrnID = CB_GetAccTrnID();
    end;

    ПроводкаИсправительная.ExRateAccTrnID = ПроводкаКурсовойРазницы.AccTrnID;
  end;

  if( not ПроводкаИсправительная.Carry() )
    stat = 1;
    msgbox( "Ошибка при вставке проводки" );
  end;

  if((stat == 0) and (index(ПроводкаИсправительная.TypeDocument, "S") > 0))
    /*Установить тип "Сторнирован" на исправляемый документ*/
    UpdateCorrectionalDoc(ПроводкаИсправительная.TypeDocument, PaymentObj.DocKind, PaymentObj.DocumentID);
  end;

  if((stat == 0) and (index(ПроводкаИсправительная.TypeDocument, "S") > 0))
    if( not ПроводкаКурсовойРазницы.Carry() )
      stat = 1;
      msgbox( "Ошибка при вставке проводки" );
    end;
  end;

  return stat;
end;

