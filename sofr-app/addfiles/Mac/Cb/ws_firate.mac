 /*
 $Name: ws_firate.mac
 $Module: Главная книга
 $Description: Макрос ФИ
 */
 

import rcw;
import rsd;
import rsbdataset;
import PTInter;
import FIInter;
import "globals.mac";
import "ws_ficlass.mac";
import "ws_validation.mac";
import "ws_datafilter.mac";
import "cb_sql.mac";
import "pr_party_lib.mac";
import "ws_person.mac";

PRIVATE VAR GRateObject;
PRIVATE VAR ParmRateID = 0;
PRIVATE VAR ParmRateVersion = 0;
PRIVATE VAR GParmRateList;
PRIVATE VAR GParmErrorMsg;
PRIVATE VAR IsCheckOnly = false;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  if(objErr.stat != 0)
    ErrorMessage.Code     = objErr.stat;
    ErrorMessage.Message  = objErr.message;
    ErrorMessage.Severity = MessageSeverity.RuntimeError;

    ResponseBuilder.AddMessage( ErrorMessage );
  end;

end;

macro getServiceError(errorCode, errorMessage, errorHelpPage, userObject)
    var responseBuilder = WebResponseBuilder;
    var error           = WsErrorMessage;

    error.Severity  = MessageSeverity.ValidationError;
    error.Code      = errorCode;
    error.Message   = errorMessage;
    error.Help      = errorHelpPage;

    responseBuilder.AddMessage(error); 

    responseBuilder.SetUserObject(userObject); 

    return responseBuilder.Result;
end;

macro GetFIIDCode( FIID )
   record fi ( fininstr );

  if( FIID != ALLFININSTR )
    if( ПолучитьФинИн( FIID, fi ) == 0 )
      return fi.fi_code;
    else
      return "";
    end;
  else
    return "";
  end;
end;

macro GetFIIDName( FIID )
   record fi ( fininstr );

  if( FIID != ALLFININSTR )
    if( ПолучитьФинИн( FIID, fi ) == 0 )
      return fi.Name;
    else
      return "";
    end;
  else
    return "";
  end;
end;

MACRO FI_GetRateHistValues(PageSize,PageNum,RateID:integer, filteritems)
   var p;
   var result = TArray();

   if(RateID <= 0)
     RunError("Не задан вид классификатора");
   end;

file ratedef ("ratedef.dbt") write key 0;

   ClearRecord(ratedef);

   ratedef.RateID = RateID;
   
   if(GetEQ( ratedef ))
      if(ratedef.SinceDate != Date(0, 0, 0))
   
        p = TWsFIRateHist();        // RATEDEF

        p.RateID       = ratedef.RateID    ;
        p.RateValue    = ratedef.Rate      ;
        p.Scale        = ratedef.Scale     ;
        p.Point        = ratedef.Point     ;
        p.SinceDate    = ratedef.SinceDate ;

        if(ratedef.IsInverse == "X")
          p.IsInverse = true;

          p.BaseCurr     = GetFIIDCode( ratedef.FIID );
          p.BaseCurrName = GetFIIDName( ratedef.FIID );
          p.QuotCurr     = GetFIIDCode( ratedef.OtherFI );
          p.QuotCurrName = GetFIIDName( ratedef.OtherFI );
        else
          p.IsInverse = false;

          p.BaseCurr     = GetFIIDCode( ratedef.OtherFI );
          p.BaseCurrName = GetFIIDName( ratedef.OtherFI );
          p.QuotCurr     = GetFIIDCode( ratedef.FIID );
          p.QuotCurrName = GetFIIDName( ratedef.FIID );
        end;

        if(ratedef.IsRelative == "X")
          p.IsRelative = true;
        else
          p.IsRelative = false;
        end;

        p.InputDate    = ratedef.InputDate ;
        p.InputTime    = ratedef.InputTime ;
        p.Oper         = FindPersonByNumber(ratedef.Oper) ;      

        if(ratedef.IsManualInput == "X")
          p.IsManualInput = true;
        else
          p.IsManualInput = false;
        end;

        result.value(result.Size) = p;
        
        var FilterItemsCount = 0;
        
        while( FilterItemsCount < FilterItems.Size )

          if( FilterItems[FilterItemsCount].Id == 0 )

            if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

              if( p.SinceDate <= FilterItems[FilterItemsCount].Value[0] )
              
              else
              
                result = TArray();
              
              end;

            end;

            if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

              if( p.SinceDate <= FilterItems[FilterItemsCount].Value[1] )
              
              else
              
                result = TArray();
              
              end;

            end;  
            
            if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

              if( p.SinceDate == FilterItems[FilterItemsCount].Value[0] )
              
              else
              
                result = TArray();
              
              end;

            end;

          end;

          FilterItemsCount = FilterItemsCount + 1;

        end;        
        
      end;
   end;  

   var query = " SELECT rh.t_RateID as RateID, rh.t_Rate as Rate, rh.t_Scale as Scale, " +
               " rh.t_Point as Point, rh.t_SinceDate as SinceDate, rh.t_IsInverse as IsInverse, rh.t_IsManualInput as IsManualInput, " +
               " rd.t_IsRelative as IsRelative, " +
               "        basefi.t_fi_code as bfi_code, basefi.t_Name as bfi_Name, " +
               "        quotfi.t_fi_code as qfi_code, quotfi.t_Name as qfi_Name, " +
               "        rh.t_InputDate as InputDate, rh.t_InputTime as InputTime, rh.t_Oper as Oper" +
               "   FROM  dratehist_dbt rh, dratedef_dbt rd, dfininstr_dbt basefi, dfininstr_dbt quotfi " +
               "  WHERE  rh.t_RateID = " + string(RateID) +
               "    AND  basefi.t_FIID(+) = rd.t_OtherFI " +
               "    AND  rd.t_RateID = rh.t_RateID " +
               "    AND  quotfi.t_FIID(+) = rd.t_FIID ";

  var condition = "";

  FilterItemsCount = 0;
  
  while( FilterItemsCount < FilterItems.Size )

    if( FilterItems[FilterItemsCount].Id == 0 )

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_From )

        condition = condition + " AND rh.t_SinceDate >= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_To )

        condition = condition + " AND rh.t_SinceDate <= ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Between )

        condition = condition + " AND rh.t_SinceDate Between ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);
        condition = condition + " AND ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[1]);

      end;

      if( FilterItems[FilterItemsCount].Condition == FilterCondition_Equal )

        condition = condition + " AND rh.t_SinceDate = ";
        condition = condition + To_SQLData(FilterItems[FilterItemsCount].Value[0]);

      end;

    end;

    FilterItemsCount = FilterItemsCount + 1;

  end;

  query = query + condition;

  query = query + " ORDER BY rh.t_SinceDate DESC";

  if(PageSize != 0)
  
    query = SQL_WrapSelect( query, PageNum, PageSize);
    
  end;

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   ds.NullConversion(true);

   while (ds.MoveNext())  
      p = TWsFIRateHist();

      p.RateID       = ds.RateID    ;
      p.RateValue    = ds.Rate      ;
      p.Scale        = ds.Scale     ;
      p.Point        = ds.Point     ;
      p.SinceDate    = date(ds.SinceDate) ;

      if(ds.IsInverse == "X")
        p.IsInverse = true;
      else        
        p.IsInverse = false;
      end;    

      if(ds.IsRelative == "X")
        p.IsRelative = true;
      else
        p.IsRelative = false;
      end;  

      p.BaseCurr     = ds.bfi_code  ;
      p.BaseCurrName = ds.bfi_Name  ;
      p.QuotCurr     = ds.qfi_code  ; 
      p.QuotCurrName = ds.qfi_Name  ; 
      p.InputDate    = date(ds.InputDate) ;
      p.InputTime    = time(ds.InputTime) ;
      p.Oper         = FindPersonByNumber(ds.Oper)      ;      

      if(ds.IsManualInput == "X")
        p.IsManualInput = true;
      else
        p.IsManualInput = false;
      end;        

      result.value(result.Size) = p;
   end;


   return result;
END;

MACRO FI_GetRateHistCount(RateID:integer, filteritems)

  var result = FI_GetRateHistValues( 0, 0, RateID, filteritems);

  return result.Size;

END;

MACRO FI_GetRateValues(FIID : integer, InRelationWithFIID)

   var p;

   var result = TArray();
   

   var query = " SELECT rd.t_RateID as RateID, "+
                      " rd.t_Name as RdName ," +
                      " basefi.t_FIID as BaseFIID, "+
                      " basefi.t_FI_Code as BaseFI_Code, "+
                      " basefi.t_fi_kind as FIKind, " +
                      " basefi.t_Name as BaseFIName, "+
                      " quotfi.t_FIID as QuotFIID, "+
                      " quotfi.t_FI_Code as QuotFI_Code, "+
                      " quotfi.t_Name as QuotFIName, "+
                      " rt.t_Type as RType, " +
                      " rt.t_TypeName as RTName, " +
                      " rt.t_IsMarketPlace as IsMarketPlace, " +
                      " rd.t_IsRelative as IsRelative," +
                      " rd.t_Informator as Informator ," +
                      " (SELECT t_Code FROM dpartcode_dbt WHERE t_PartyID = rd.t_Informator AND t_codekind = 1) as InfCode, " +
                      " (SELECT t_Code FROM dpartcode_dbt WHERE t_PartyID = rd.t_Market_Place AND t_codekind = 1) as MktCode, " +
                      " (SELECT t_Name FROM dparty_dbt WHERE t_PartyID = rd.t_Informator) as InfName,"+
                      " rd.t_Market_Place as MarketPlace," +
                      " (SELECT t_Name FROM dparty_dbt WHERE t_PartyID = rd.t_Market_Place) as MarkName," +
                      " (SELECT t_ShortName FROM dparty_dbt WHERE t_PartyID = rd.t_Market_Place) as MarkShortName," +
                      " rd.t_Section as Section ," +
                      " pto.t_OfficeCode as OfficeCode, "+ 
                      " pto.t_OfficeName as OfficeName, "+ 
                      " rd.t_Definition as  Definition," +
                      " rd.t_IsInverse as IsInverse," +
                      " rd.t_Rate as RateValue ," +
                      " rd.t_Scale as Scale," +
                      " rd.t_Point as Point," +
                      " rd.t_InputDate as InputDate," +
                      " rd.t_InputTime as InputTime," +
                      " rd.t_Oper as OperID ," +
                      " rd.t_IsDominant as IsDominant ," +
                      " rd.t_Version as Version ," +
                      " rd.t_IsManualInput as IsManualInput ," +
                      " (SELECT t_Name FROM dperson_dbt WHERE t_Oper = rd.t_Oper) as OperName, "+
                      " rd.t_SinceDate as SinceDate " +
               "  FROM dratedef_dbt rd, dfininstr_dbt basefi, dfininstr_dbt quotfi, dratetype_dbt rt, dptoffice_dbt pto  " +
               " WHERE (";

  if(ValType(InRelationWithFIID) == V_INTEGER)
    query = query + " (rd.t_OtherFI = " + String(FIID) + " AND rd.t_FIID = " + InRelationWithFIID + ")";
    query = query + " OR (rd.t_FIID = " + String(FIID) + " AND rd.t_OtherFI = " + InRelationWithFIID + ")";
  else
    query = query + " (rd.t_OtherFI = " + String(FIID) + " AND rd.t_FIID IN (SELECT t_FIID FROM dfininstr_dbt WHERE t_FI_Kind = 1))";
    query = query + " OR (rd.t_FIID = " + String(FIID) + " AND rd.t_OtherFI IN (SELECT t_FIID FROM dfininstr_dbt WHERE t_FI_Kind = 1))";
  end;


   query = query + ") AND rd.t_OtherFI = basefi.t_FIID ";
   query = query + " AND rd.t_FIID = quotfi.t_FIID ";
   query = query + " AND rd.t_Type = rt.t_Type ";
   query = query + " AND rd.t_Market_Place = pto.t_PartyID(+) ";
   query = query + " AND rd.t_Section = pto.t_OfficeID(+) ";
   
     
   query = query + " ORDER BY rd.t_SinceDate, rd.t_Type";

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   var err = 0;

   while (ds.MoveNext())
      p = TWsFIRateDef();

      p.RateID       = ds.RateID ;
      p.RateName     = ds.RdName ;
      
      var bri = TWsFinInstr();
      bri.FIID        = ds.BaseFIID;
      bri.CodeWidget  = ds.BaseFI_Code;
      bri.Name        = ds.BaseFIName;
      bri.Kind        = ds.FIKind;
      p.BaseFI        = bri ;

      var qri = TWsFinInstr();
      qri.FIID        = ds.QuotFIID;
      qri.CodeWidget  = ds.QuotFI_Code;
      qri.Name        = ds.QuotFIName;
      p.QuotFI        = qri ;

      var frt = TWsFIRateType();
      frt.TypeID   = ds.RType;
      frt.TypeName = ds.RTName;
      if(ds.IsMarketPlace == "X")
        frt.IsMarketPlace = true;
      else
        frt.IsMarketPlace = false;
      end;
      p.RateType     = frt ;

      if(ds.IsRelative == "X")
        p.IsRelative  = true;
      else
        p.IsRelative  = false;
      end;

      var inf = TWsFIRateParty();
      inf.ID   = ds.Informator;
      err = 0;
      inf.Code = ds.InfCode;
      inf.Name = ds.InfName;
      p.Informator   = inf;


      var mpls = TWsFIRateParty();
      mpls.ID   = ds.MarketPlace;
      err = 0;
      mpls.Code = ds.MktCode;
      mpls.Name = ds.MarkName;
      mpls.ShortName = ds.MarkShortName;
      p.MarketPlace  = mpls;

      var frs = TWsFIRateSection();
      frs.ID   = ds.Section;
      frs.Code = ds.OfficeCode;
      frs.Name = ds.OfficeName;
      p.Section      = frs;

      p.Comment      = ds.Definition ;


      var rv = TWsFIRateValue();

      rv.RateID    = ds.RateID;

      if(ds.IsInverse == "X")
        rv.IsInverse  = true;
      else
        rv.IsInverse = false;
      end;

      if(ds.IsRelative == "X")
        rv.IsRelative = true;
      else
        rv.IsRelative = false;
      end;
      
      rv.Rate      = ds.RateValue;
      rv.Scale     = ds.Scale;
      rv.Point     = ds.Point;
      rv.InputDate = date(ds.InputDate);
      rv.InputTime = time(ds.InputTime);
      rv.SinceDate = date(ds.SinceDate);

      rv.OperNum   = ds.OperID;  
      rv.OperName  = ds.OperName;
      p.RateValue  = rv ;

      if(ds.IsDominant == "X")
        p.IsDominant = true;
      else
        p.IsDominant = false;
      end;

      p.Version   = ds.Version;
      
      if(ds.IsManualInput == "X")
        p.IsManualInput  = true;
      else
        p.IsManualInput = false;
      end;      
      
      p.IsDelete  = false;

      result.value(result.Size) = p;
   end;


   return result;

END;

MACRO FI_SaveRateValue( rate : TWsFISaveRate ) // данные о курсе ФИ
  var retval = true;

  file ratedef ("ratedef.dbt") write key 0;

  ClearRecord(ratedef);

  if(rate.RateID != 0)
    ratedef.RateID = rate.RateID;
    retval = GetEQ( ratedef );
  end;

  if(retval)
    ratedef.OtherFI      = rate.BaseFIID     ;
    ratedef.FIID         = rate.QuotFIID     ;
    ratedef.Name         = rate.RateName     ;
    ratedef.Definition   = rate.Comment      ;
    ratedef.Type         = rate.RateTypeID   ;
    ratedef.IsRelative   = rate.IsRelative   ;
    ratedef.Informator   = rate.InformatorID ;
    ratedef.Market_Place = rate.MarketPlaceID;

    if(rate.RateValueIsInverse == true)
      ratedef.IsInverse    = "X";
    else
      ratedef.IsInverse    = "";
    end;

    ratedef.Rate         = rate.RateValueRate     ;
    ratedef.Scale        = rate.RateValueScale    ;
    ratedef.Point        = rate.RateValuePoint    ;
    ratedef.InputDate    = date(rate.RateValueInputDate);
    ratedef.InputTime    = time(rate.RateValueInputTime);
    ratedef.Oper         = rate.RateValueOperNum  ;
    ratedef.SinceDate    = date(rate.RateValueSinceDate);
    ratedef.Section      = rate.SectionID         ;

    if(rate.IsManualInput == true)
      ratedef.IsManualInput    = "X";
    else
      ratedef.IsManualInput    = "";
    end; 

    if(ratedef.SinceDate < date(1,1,2))
       ratedef.SinceDate = date(0,0,0);
    end;

    if(rate.RateID == 0)
      retval = Insert(ratedef);
    else
      retval = Update(ratedef);
    end;
  end;  

  return retval;
END;


PRIVATE MACRO IsRateDefValueChanged(rate1, rate2):bool
  var RetVal = true;

  if((rate1.IsInverse      == rate2.IsInverse    ) AND
       (rate1.Rate         == rate2.Rate         ) AND
       (rate1.Scale        == rate2.Scale        ) AND
       (rate1.Point        == rate2.Point        ) AND
       (rate1.InputDate    == rate2.InputDate    ) AND
       (rate1.InputTime    == rate2.InputTime    ) AND
       (rate1.Oper         == rate2.Oper         ) AND
       (rate1.SinceDate        == rate2.SinceDate    ) AND
       (rate1.IsManualInput    == rate2.IsManualInput    ))
    RetVal = false;
  end;

  return RetVal;
end;

PRIVATE MACRO IsChangeRateDef(rate1, rate2):bool
   var RetVal = true;

   if( (rate1.FIID         == rate2.FIID         ) AND
       (rate1.OtherFI      == rate2.OtherFI      ) AND
       (rate1.Name         == rate2.Name         ) AND
       (rate1.Definition   == rate2.Definition   ) AND
       (rate1.Type         == rate2.Type         ) AND
       (rate1.IsRelative   == rate2.IsRelative   ) AND
       (rate1.Informator   == rate2.Informator   ) AND
       (rate1.Market_Place == rate2.Market_Place ) AND
       (rate1.IsDominant   == rate2.IsDominant   ) AND
       (rate1.Section      == rate2.Section      ) AND    

       /* Значение курса */
       (rate1.IsInverse    == rate2.IsInverse    ) AND
       (rate1.Rate         == rate2.Rate         ) AND
       (rate1.Scale        == rate2.Scale        ) AND
       (rate1.Point        == rate2.Point        ) AND
       (rate1.InputDate    == rate2.InputDate    ) AND
       (rate1.InputTime    == rate2.InputTime    ) AND
       (rate1.Oper         == rate2.Oper         ) AND
       (rate1.SinceDate     == rate2.SinceDate    ) AND
       (rate1.IsManualInput == rate2.IsManualInput))

     RetVal = false;
   end;

   return  RetVal;
END;

PRIVATE MACRO SetRateDefValue(ratedef, rate, copyRateValueNeeded)
   ratedef.FIID         = rate.QuotFI.FIID;
   ratedef.OtherFI      = rate.BaseFI.FIID;
   ratedef.Name         = rate.RateName;
   ratedef.Definition   = rate.Comment;
   ratedef.Type         = rate.RateType.TypeID;

   if(rate.IsRelative == true)
     ratedef.IsRelative = "X";
   else
     ratedef.IsRelative = "";
   end;

   if(rate.IsDominant == true)
     ratedef.IsDominant = "X";
   else
     ratedef.IsDominant = "";
   end;

   ratedef.Informator   = rate.Informator.ID;
   ratedef.Market_Place = rate.MarketPlace.ID;
   ratedef.Section      = rate.Section.ID;

   if(rate.IsManualInput == true)
     ratedef.IsManualInput    = "X";
   else
     ratedef.IsManualInput    = "";
   end;   

   if(copyRateValueNeeded == true)     
     
   if(rate.RateValue.IsInverse == true)
     ratedef.IsInverse    = "X";
   else
     ratedef.IsInverse    = "";
   end;

   ratedef.Rate         = rate.RateValue.Rate;
   ratedef.Scale        = rate.RateValue.Scale;
   ratedef.Point        = rate.RateValue.Point;
   ratedef.InputDate    = rate.RateValue.InputDate;
   ratedef.InputTime    = rate.RateValue.InputTime;
   ratedef.Oper         = rate.RateValue.OperNum;
   ratedef.SinceDate    = rate.RateValue.SinceDate;
   
   end;
END;

PRIVATE MACRO SaveRateValueInHistory(ratedef)
  var stat = 0;

  record rp( rateparm );
  ClearRecord(rp);


  rp.FI_Code      =  ratedef.QuotFI.CodeWidget;
  rp.OtherFI      =  ratedef.BaseFI.CodeWidget;

  rp.Type         =  ratedef.RateType.TypeID;

  if(ratedef.RateValue.IsInverse == true)
    rp.IsInverse    = "X";
  else
    rp.IsInverse    = "";
  end;

  rp.Rate         =  ratedef.RateValue.Rate;
  rp.Scale        =  ratedef.RateValue.Scale;
  rp.Point        =  ratedef.RateValue.Point;
  rp.SinceDate    =  ratedef.RateValue.SinceDate;

  if(ratedef.IsRelative == true)
    rp.IsRelative = "X";
  else
    rp.IsRelative = "" ;
  end; 

  if(ratedef.IsDominant == true)
    rp.IsDominant ="X";
  else
    rp.IsDominant = "";
  end;

  rp.Market_Place =  ratedef.MarketPlace.ID;
  rp.Section      =  ratedef.Section.ID;

  if(rp.SinceDate < date(1,1,2))
    rp.SinceDate = date(0,0,0);
  end;

   if(ratedef.IsManualInput == true)
     rp.IsManualInput    = "X";
   else
     rp.IsManualInput    = "";
   end;   

  //RunError("Saving | SinceDate: " + rp.SinceDate);

  stat = УстановитьКурс(rp, rp.SinceDate);

  return stat;
end;


PRIVATE MACRO TrnSaveRateValueList(ParmRateList : TArray, ParmErrorMsg:@string) 
                                   
  VAR RateList  = ParmRateList; // Список Курсов
  var size      = RateList.size();
  var stat      = 0;
  var i         = 0;
  var rate;

  file ratedef ("ratedef.dbt") write key 0;
  file ratedefOld ("ratedef.dbt") write key 0;
  ClearRecord(ratedef);
  ClearRecord(ratedefOld);
  

  // Удаляем старые записи 
  i = 0;
  while((i < size) AND (stat == 0))
    rate = RateList(i);
 
    if((rate.IsDelete == true) AND (rate.RateID > 0))
      stat = FI_DeleteRateDef(rate.RateID, rate.Version);
    end;

    i = i + 1;
  end;

  if(stat != 0)
    ParmErrorMsg = GetErrMsg();
  end;
  
  // Редактируем старые записи 
  i = 0;
  while((i < size) AND (stat == 0))
    rate = RateList(i);
 
    if((rate.IsDelete == false) AND (rate.RateID != null) AND (rate.RateID > 0) )

      ClearRecord(ratedefOld);

      if(rate.RateID > 0)
        ratedefOld.RateID = rate.RateID;
        if(not GetEQ( ratedefOld ))
          stat = 70;
          ParmErrorMsg = "Конфликт. Документ изменен другим операционистом";
        end;
      end;

      if(stat == 0)
        Copy(ratedef, ratedefOld);
        SetRateDefValue(ratedef, rate, false);
        
        if(IsChangeRateDef(ratedef, ratedefOld))
          stat = FI_UpdateRateDef(ratedef, rate.Version);
        end;

        SetRateDefValue(ratedef, rate, true);

        if (IsRateDefValueChanged(ratedef, ratedefOld))
          stat = SaveRateValueInHistory(rate);
        end;

          if(stat != 0)
            ParmErrorMsg = GetErrMsg();
          end;
        end;
      end;

    i = i + 1;
  end;
  

  // Вставляем новые
  i = 0;
  while((i < size) AND (stat == 0))
    rate = RateList(i);
 
    if((rate.IsDelete == false) AND ((rate.RateID == null) OR (rate.RateID <= 0)) )
        ClearRecord(ratedef);
        SetRateDefValue(ratedef, rate, true);

        stat = FI_InsertRateDef(ratedef);

        if(stat != 0)
          ParmErrorMsg = GetErrMsg();
        end;
    end;

    i = i + 1;
  end;

  return stat;

END;

MACRO FI_SaveRateValueList( RateList : TArray, ErrorMsg : @string  ) // Список Курсов
  var RetVal = 0;

  InitError();

  RetVal = TrnSaveRateValueList(RateList, @ErrorMsg );

  return RetVal;
END;


PRIVATE MACRO SaveRateValueListTrnParm(ParmRateList : TArray, ParmErrorMsg:@string ) 
  return TrnSaveRateValueList(GParmRateList, @GParmErrorMsg) ;
END;

MACRO FI_SaveRateValueListTrn( RateList ) // Список Курсов
  var RetVal = true;

  InitError();

  GParmRateList = RateList;
  GParmErrorMsg = "";
  RetVal = ProcessTrn(NULL, "SaveRateValueListTrnParm");

  if(RetVal == false)
      RunError(GParmErrorMsg);
  end;

  return RetVal;  
END;

MACRO FI_GetRateTypeList(IsInternal)
   var p;

   var result = TArray();
   var query = "";

   if(IsInternal == null)
     query = "SELECT t_Type, t_TypeName, t_IsMarketPlace FROM dratetype_dbt ORDER BY t_Type";
   elif(IsInternal == true)
     query = "SELECT t_Type, t_TypeName, t_IsMarketPlace FROM dratetype_dbt WHERE t_IsInternal = 'X' ORDER BY t_Type";
   else
     query = "SELECT t_Type, t_TypeName, t_IsMarketPlace FROM dratetype_dbt WHERE t_IsInternal <> 'X' ORDER BY t_Type";
   end;

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   while (ds.MoveNext())
      p = TWsFIRateType();
      p.TypeID   = ds.Type;
      p.TypeName = ds.TypeName;
      p.IsMarketPlace = SQL_ConvTypeBool(ds.IsMarketPlace);

      result.value(result.Size) = p;
   end;

   return result;
END;


MACRO FI_GetRateType(Rate)
   var  cmd,rs;
   var p;
   var result = NULL;
   var query = "SELECT t_Type, t_TypeName, t_IsMarketPlace FROM dratetype_dbt WHERE t_Type = ? ORDER BY t_Type";

   cmd = RSDCommand (query);
   cmd.addParam( "", RSDBP_IN, Rate );
   cmd.execute();

   var ds = TRsbDataSet(cmd);

   while (ds.MoveNext())
      p = TWsFIRateType();
      p.TypeID   = ds.Type;
      p.TypeName = ds.TypeName;
      p.IsMarketPlace = ds.IsMarketPlace;

      result = p;
   end;

   return result;
END;


/*
PRIVATE MACRO TrnDeleteRateValue()
  var RetVal = 0;

  var cmd : RsdCommand;
  cmd = RsdCommand("DELETE FROM dratedef_dbt WHERE t_RateID = ?");
  cmd.addParam( "", RSDBP_IN, ParmRateID );
  RetVal = cmd.execute();

  if(RetVal == 0)
    cmd = RsdCommand("DELETE FROM dratehist_dbt WHERE t_RateID = ?");
    cmd.addParam( "", RSDBP_IN, ParmRateID );
    RetVal = cmd.execute();
  end;


  if(RetVal != 0)
    AbortTrn();
  end;

  return RetVal;
END;

MACRO FI_DeleteRateValue(RateID :integer)
  var RetVal = false;

  if(RateID <= 0)
    RunError("Не задан идентификатор ФИ");
  end;

  ParmRateID = RateID;

  RetVal = ProcessTrn(NULL,"TrnDeleteRateValue");

  return RetVal;
END;
*/

PRIVATE MACRO getErrorDesc( errCode )
  var errDesc = "";
  if( errCode != 0 )
    errDesc = "Ошибка установки курса:";

    if( errCode == 1 )
      errDesc = errDesc + " Не найдена котируемая валюта.";
    elif( errCode == 2 )
      errDesc = errDesc + " Не найдена базовая валюта.";
    elif( errCode == 3 )
      errDesc = errDesc + " Не найден вид курса для текущей валюты.";
    elif( errCode > 100 )
      errDesc = errDesc + " Ошибка Btrieve № " + errCode - 100;
    else
      errDesc = errDesc + " Описание ошибки отсутствует";
    end;
  end;

  return errDesc;
END;


MACRO FI_SaveRateHist( IsInsert : bool, sinceDate, ratehist/* : TWsFIRateHist*/, is_first ) 

  var retval = true;

  file ratedef ("ratedef.dbt") write key 0; // RATEDEF
  ClearRecord(ratedef);

  record rp( rateparm );  //RSLRATEPARM
  ClearRecord(rp);

  ratedef.RateID = ratehist.RateID;
  retval = GetEQ( ratedef );

  if(retval == false)
    RunError("Не найден курс");
  end;

  if(retval)
     rp.FI_Code      =  ratehist.QuotCurr;
     rp.OtherFI      =  ratehist.BaseCurr;

     rp.Type         =  ratedef.Type;
     
     if(ratehist.IsInverse == true)
       rp.IsInverse    = "X";
     else
       rp.IsInverse    = "";
     end;

     rp.Rate         =  ratehist.RateValue;
     rp.Scale        =  ratehist.Scale;
     rp.Point        =  ratehist.Point;
     rp.SinceDate    =  ratehist.SinceDate;

     if(ratehist.IsManualInput == true)
       rp.IsManualInput    = "X";
     else
       rp.IsManualInput    = "";
     end;     

     if(ratedef.IsRelative == true)
        rp.IsRelative = "X" ;
     else
        rp.IsRelative = "" ;
     end; 

     if(ratedef.IsDominant == true)
        rp.IsDominant =  "X";
     else
        rp.IsDominant =  "";
     end;
     
     rp.Market_Place =  ratedef.Market_Place;
     rp.Section      =  ratedef.Section;

    if(rp.SinceDate < date(1,1,2))
       rp.SinceDate = date(0,0,0);
    end;

    var errCode = УстановитьКурс( rp, sinceDate );

    if((errCode == 0) AND
       (is_first == true) AND
       (IsInsert == false) AND
       (SinceDate != ratehist.SinceDate))
     
      errCode = FI_DeleteRateHistValue( ratehist.RateID, SinceDate );
    
    end;

     if( errCode != 0 )
        RunError(getErrorDesc( errCode ));
     end;

  end;  

  return retval;
END;


MACRO FI_DeleteRateHist( ratehist/* : TWsFIRateHist*/ ) 

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var stat = FI_DeleteRateHistValue( ratehist.RateID, ratehist.SinceDate );

  if( stat != 0 )

    AddErrorMessage(@ErrorMessage);

  end;

  if( stat == 0 )

    res = true;
  
  else

    res = false;

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
END;


MACRO FI_GetCurrentSessionData()

  var p = TWsCurrentSessionData();

  p.Oper     = {oper};
  p.OperName = {Name_Oper};
  p.OperObj  = FindPersonByNumber({oper});
  p.CurDate  = {curdate};

  return p;
END;

macro FI_CheckDeleteRateDef()    
  FI_DeleteRateDef(ParmRateID, ParmRateVersion);

  AbortTrn();
end;

macro FI_CheckUpdateRateDef()

  var i = 0;
  var size = GParmRateList.size;
  var stat = 0;

  file ratedef ("ratedef.dbt") write key 0;
  file ratedefOld ("ratedef.dbt") write key 0;
  ClearRecord(ratedef);
  ClearRecord(ratedefOld);


  while(i < size)
    var rate = GParmRateList(i);
 
    if((rate.IsDelete == false) AND (rate.RateID != null) AND (rate.RateID > 0) )

      ClearRecord(ratedefOld);

      if(rate.RateID > 0)
        ratedefOld.RateID = rate.RateID;
        if(not GetEQ( ratedefOld ))
          stat = 70;
          GParmErrorMsg = "Конфликт. Документ изменен другим операционистом";
        end;
      end;

      if(stat == 0)
        Copy(ratedef, ratedefOld);
        SetRateDefValue(ratedef, rate);
        
        if(IsChangeRateDef(ratedef, ratedefOld))
          stat = FI_UpdateRateDef(ratedef, rate.Version);

          if(stat != 0)
            GParmErrorMsg = GetErrMsg();
          end;

          AbortTrn();
        end;
      end;
    end;
  end;
end;

macro FI_CheckSaveRateDef()
  var i = 0;
  var size = GParmRateList.size;
  var stat = 0;

  file ratedef ("ratedef.dbt") write key 0;
  file ratedefOld ("ratedef.dbt") write key 0;
  ClearRecord(ratedef);
  ClearRecord(ratedefOld);


  while(i < size)
    var rate = GParmRateList(i);
 
    if((rate.IsDelete == false) AND ((rate.RateID == null) OR (rate.RateID <= 0)) )
        ClearRecord(ratedef);
        SetRateDefValue(ratedef, rate);

        stat = FI_InsertRateDef(ratedef);

        if(stat != 0)
          GParmErrorMsg = GetErrMsg();
        end;
    end;

    i = i +1;
  end;

  AbortTrn();

end;

macro FI_CheckRateDefList(RateDefList) // : List<TWsFIRateDef>

  if((RateDefList != null) AND (RateDefList.size > 0))
    var i = 0, transactionReturnValue = false;

    while(i < RateDefList.size)
      if((RateDeflist[i].isDelete == true) AND (RateDeflist[i].RateID))

        ParmRateID = RateDeflist[i].RateID;
        ParmRateVersion = RateDeflist[i].Version;

        transactionReturnValue = ProcessTrn(NULL, "FI_CheckDeleteRateDef");

        if(transactionReturnValue)
          RunError("Ошибка транзакции удаления: \"" + GParmErrorMsg + "\"");
        end;
      end;

      i = i + 1;
    end;

    GParmRateList = RateDefList;

    transactionReturnValue = ProcessTrn(NULL, "FI_CheckUpdateRateDef");

    if(transactionReturnValue)
      RunError("Ошибка транзакции обновления: \"" + GParmErrorMsg + "\"");
    end;

    transactionReturnValue = ProcessTrn(NULL, "FI_CheckSaveRateDef");

    if(transactionReturnValue)
      RunError("Ошибка транзакции сохранения: \"" + GParmErrorMsg + "\"");
    end;
  end;
end;

macro CB_CurRateKind()  

  var rateKind = NULL, stat;

  GetRegistryValue( "CB\\FINTOOLS\\CBCURRATEKIND", V_INTEGER, rateKind, stat );

  return rateKind;
end;

//var list1 = FI_GetRateValues(0,true,true);
//var rv = FI_SaveRateValueList(list1);
//println("rv = ", rv);
// var list2 =FI_GetRateHistValues(2);
//FI_SaveRateHist( true, list2(0) ) 
