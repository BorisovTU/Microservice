/*
$Name:        ws_ptecupridchkres_lib.mac
$Module:      Rs-Core
$Description: Макрос для вызова сервиса "Простые сервисы. Валидация ИНН" RS-Connect
*/
/*
    Макрос для вызова сервиса "Простые сервисы. Валидация ИНН" RS-Connect
*/

import "ws_ssusage_spid.mac";
import Ptinter;
import rcw, ws_rsconnectclasses, ws_integrationrsconnect, oralib, PaymInter, likepy, BankInter, bnk_ptlib;
import XmlRpcInter, ServiceAction, "bnk_dttmfrmt.mac", "bnk_common.mac";

private macro CreateECUPRIDQuery(firstName, lastName, patronymic, PaperSeries, PaperNumber, INN, SNILS)
    var q = CreateSSASRequestSPIDJava();
    q.lastName 	= lastName;
	q.firstName = firstName;
    
	if (ValType(patronymic)!= V_UNDEF )
        q.patronymic = patronymic;
	end;
	
    q.passportSeries = PaperSeries;
	q.passportNumber = PaperNumber;
    
	if (ValType(SNILS) != V_UNDEF )
		q.SNILS = SNILS;
	end;
    
	if (ValType(INN)!= V_UNDEF)
        q.INN = INN;
    end;
    
    return q;
end;

macro PT_CheckECUPRIDSendRequest(
    Action, SenderID, RS_Connect_Url, 
    firstName, lastName, patronymic, PaperSeries, PaperNumber, INN, SNILS,
    MessageID:@string, ReturnCode:@string, ReturnText:@string, StatusCode:@string, ObjectID:@string
)
    var objectError = 0;
    var hr = false;
    var header = CreateHeaderSSASRequestJava();
    
    var HeaderMessageID = SubStr(CreateGUID(), 2, 36);    
    header.messageID = HeaderMessageID;
    header.senderID = SenderID;
    header.senderPointID = {OperDprt};
    
    var query;
    var result;

    if (Action == PTCHECKSNILSACTION_QUERY)
        query = CreateECUPRIDQuery(firstName, lastName, patronymic, PaperSeries, PaperNumber, INN, SNILS);
        result = callCheckSPID(header, query, RS_Connect_Url);
        
        hr = result.SSASResponse.result;
        StatusCode = result.statusName;
        MessageID = HeaderMessageID;

        println(result.statusCode);
        println(result.objectError);
        
        println(result.SSExtError.returnCode);
        println(result.SSExtError.returnText);
    elif (Action == PTCHECKSNILSACTION_QUERY_RESULT)
        query = CreateECUPRIDQuery(firstName, lastName, patronymic, PaperSeries, PaperNumber, INN);
        result = callGetSPID(header, ObjectID, MessageID, RS_Connect_Url);
        
        StatusCode = result.statusName;
        hr = result.SSASResponse.result;
    end;
    
    if (strlen(result.objectError))
        objectError = result.objectError;
    else
        StatusCode = result.statusCode;
        ReturnCode = result.SSExtError.returnCode;
        ReturnText = result.SSExtError.returnText;
        ObjectID = result.objectID;
        
        // результат ответа
        if ((strlen(hr)) AND ((StrUpr(hr) == "TRUE") OR (hr == "X")))
            // TRUE
            objectError = true;
        else
            // FALSE
            objectError = false;
        end;
    end;
    
    return objectError;
end;
