/*
$Name: form_res.mac
$Module: Ядро ГКБО
$Description: Макрос расчета резервов по лицевым счетам и портфелям однородных требований
*/

Import BankInter, FIInter, CTInter, rsd,
   "res_const.mac", "res_actual.mac", "res_report.mac", "res_acc.mac", "res_case.mac", "globals.mac", "res_lib.mac";

record AccOprServ("accopsrv.dbt");

/* остаток на счете резерва для резервируемого актива */
var RestReserve                 : money;
/*итоговые значения сумм резервов*/
var ReserveLoss                 : money; /* РВП  */
var ReserveLoans                : money; /* РВПС */
var ReserveOffshore             : money; /* РОФШ */
var ReserveEstimated            : money; /* ОР   */
/*значения сумм резервов на дату курса*/
var ReserveLoss_DateRate        : money; /* РВП  */
var ReserveLoans_DateRate       : money; /* РВПС */
var ReserveOffshore_DateRate    : money; /* РОФШ */
var ReserveEstimated_DateRate    : money; /* ОР */
/*значения сумм резервов на дату формирования резерва*/
var ReserveLoss_DateReserve     : money; /* РВП  */
var ReserveLoans_DateReserve    : money; /* РВПС */
var ReserveOffshore_DateReserve : money; /* РОФШ */
var ReserveEstimated_DateReserve : money; /* ОР */

var OffshoreGroup : integer;

private macro InitReserveSum()
  /* остаток на счете резерва для резервируемого актива */
  RestReserve                 = $0;
  /*итоговые значения сумм резервов*/
  ReserveLoss                 = $0;
  ReserveLoans                = $0;
  ReserveOffshore             = $0;
  ReserveEstimated            = $0;
  /*значения сумм резервов на дату курса*/
  ReserveLoss_DateRate        = $0;
  ReserveLoans_DateRate       = $0;
  ReserveOffshore_DateRate    = $0;
  ReserveEstimated_DateRate   = $0;
  /*значения сумм резервов на дату формирования резерва*/
  ReserveLoss_DateReserve     = $0;
  ReserveLoans_DateReserve    = $0;
  ReserveOffshore_DateReserve = $0;
  ReserveEstimated_DateReserve= $0;
end;

private macro SetReserveSum_DateRate()
  ReserveLoss     = money(round(ReserveLoss_DateRate,     2));
  ReserveLoans    = money(round(ReserveLoans_DateRate,    2));
  ReserveOffshore = money(round(ReserveOffshore_DateRate, 2)); 
  ReserveEstimated = money(round(ReserveEstimated_DateRate, 2));
end;

private macro SetReserveSum_DateReserve()
  ReserveLoss     = money(round(ReserveLoss_DateReserve,     2));
  ReserveLoans    = money(round(ReserveLoans_DateReserve,    2));
  ReserveOffshore = money(round(ReserveOffshore_DateReserve, 2));
  ReserveEstimated = money(round(ReserveEstimated_DateReserve, 2)); 
end;

/* расчет резервов */
private macro _CalcReserve( resObj : CalcReserve )
  /*проводим расчет для даты формирования резерва*/
  resObj.SetVariables_DateReserve();
  if( AccOprServ.CalcReserve      ) ReserveLoss_DateReserve     = ReserveLoss_DateReserve     + resObj.CalcReserveLoss()    ; end; /* расчет РВП  */
  if( AccOprServ.CalcReserveLoans ) ReserveLoans_DateReserve    = ReserveLoans_DateReserve    + resObj.CalcReserveLoans()   ; end; /* расчет РВПС */
  if( AccOprServ.CalcReserveOff   ) ReserveOffshore_DateReserve = ReserveOffshore_DateReserve + resObj.CalcReserveOffshore(); end; /* расчет РОФШ */
  if( AccOprServ.CalcEvalRes      ) ReserveEstimated_DateReserve = ReserveEstimated_DateReserve + resObj.CalcReserveEstimated(); end; /* расчет ОР */
  /*проводим расчет для даты курса*/
  resObj.SetVariables_DateRate();
  if( AccOprServ.CalcReserve      ) ReserveLoss_DateRate     = ReserveLoss_DateRate     + resObj.CalcReserveLoss()    ; end; /* расчет РВП  */
  if( AccOprServ.CalcReserveLoans ) ReserveLoans_DateRate    = ReserveLoans_DateRate    + resObj.CalcReserveLoans()   ; end; /* расчет РВПС */
  if( AccOprServ.CalcReserveOff   ) ReserveOffshore_DateRate = ReserveOffshore_DateRate + resObj.CalcReserveOffshore(); end; /* расчет РОФШ */
  if( AccOprServ.CalcEvalRes      ) ReserveEstimated_DateRate = ReserveEstimated_DateRate + resObj.CalcReserveEstimated(); end; /* расчет ОР */
  RestReserve = resObj.GetRestReserve();
end;

/* установить итоговые суммы резервов равными расчетным на дату курса или на дату резервирования */
private macro _CalcReserveTotal()
  var ReserveTotal_DateRate : money;
  ReserveTotal_DateRate = ReserveLoss_DateRate + ReserveLoans_DateRate + ReserveOffshore_DateRate;
  /*если сумма резерва расчитанная на дату курса равна сумме предыдущего резерва,
  то резервировать нечего, иначе будет формироваться резерв расчитанный на дату резервирования*/
  if(string(ReserveTotal_DateRate) == string(RestReserve))
    SetReserveSum_DateRate();
  else
    SetReserveSum_DateReserve();
  end;
end;

/* Макрофункция, вызываемая при старте процедуры формирования резерва */
macro СтартПроцедуры()
  ResAccOverdueSum( AccOprServ, AccOprServ.Date );
end;

/* Макрофункция, вызываемая при завершении процедуры формирования резерва */
macro ЗавершениеПроцедуры()
end;

/*
 * Макрофункция, вызываемая при старте формирования резерва по счету
 */
macro ОбработкаСчета( _acc, _RsvParm ) : bool

  record acc(account);
  record RsvParm("rsvprm.dbt");
  var stat : bool;
  var accResObj : CalcReserveAccount;

  var ReserveAccount : string;
  var AccountReserveKind : integer;
  var ProcentOfReserveOffshore : double;
  var RestReserveAccount            : money;
  var RestReserveSubAccount         : money;
  var RestReserveLoansSubAccount    : money;
  var RestReserveOffshoreSubAccount : money;
  /*Значения процентов резервирования и категорий качества в текущем формировании*/
  var RiskGroup : integer;
  var ReserveProcent : double;
  var ReserveProcentOffshore : double;
  var ReserveProcentEstimated : double;
  var PtRiskGroup : integer;
  var PtReserveProcent : double;
  var PtReserveProcentOffshore : double;
  var PtReserveProcentEstimated : double;
  /*Классификации резервов*/
  var ClassifReserveLoss     : string;
  var ClassifReserveLoans    : string;
  var ClassifReserveOffshore : string;
  /*Даты послених расчетов по видам резервов*/
  var LastDateCalcReserveLoss : date;
  var LastDateCalcReserveLoans : date;
  var LastDateCalcReserveOffshore : date;
  var LastDateCalcReserveEstimated : date;
  /*Значения процентов резервирования и категорий качества в предыдущем формировании*/
  var LastPtRiskGroup : integer;
  var LastPtReserveProcent : double;
  var LastPtReserveProcentOffshore : double;
  var LastPtReserveProcentEstimated : double;
  var LastRiskGroup : integer;
  var LastReserveProcent : double;
  var LastReserveProcentOffshore : double;
  var LastReserveProcentEstimated : double;
  /*Признаки изменения параметров для видов резерва*/
  var ChangedLoss     : bool;
  var ChangedLoans    : bool;
  var ChangedOffshore : bool;
  var ChangedEstimated : bool;
  var ConsiderMinPercent : bool;

  SetBuff( acc, _acc );
  SetBuff( RsvParm, _RsvParm );

  stat = true;

  ChangedLoss     = true;
  ChangedLoans    = true;
  ChangedOffshore = true;
  ChangedEstimated = true;
  ConsiderMinPercent = false;
  
  InitReserveSum();

  /*Определить вид резерва РВП или РВПС*/
  AccountReserveKind = GetAccountReserveKind(RsvParm, acc, AccOprServ.Date);
  /*Определить классификации резервов*/
  ClassifReserveLoss     = GetAccountReserveClassif(KindReserveLoss    , RsvParm.RsvClass        , AccountReserveKind);
  ClassifReserveLoans    = GetAccountReserveClassif(KindReserveLoans   , RsvParm.RsvClassLoans   , AccountReserveKind);
  ClassifReserveOffshore = GetAccountReserveClassif(KindReserveOffshore, RsvParm.RsvClassOffShore, AccountReserveKind);

  ReserveAccount = GetAccCaseReserveAccount( acc.Chapter, acc.Code_Currency, acc.Account );

  if((AccOprServ.CheckParm == "X") or ((AccOprServ.ProcessChanged == "X") and (ReserveAccount != "")))
    stat = ResAccActualize
    (
      AccOprServ
     ,acc
     ,AccOprServ.Date
     ,AccountReserveKind
     ,OffshoreGroup
     ,ClassifReserveLoss
     ,ClassifReserveLoans
     ,ClassifReserveOffshore
     ,@PtRiskGroup
     ,@PtReserveProcent
     ,@PtReserveProcentOffshore
     ,@PtReserveProcentEstimated
     ,@RiskGroup
     ,@ReserveProcent
     ,@ReserveProcentOffshore
     ,@ReserveProcentEstimated
     ,false
    );
    if(stat and (AccOprServ.ProcessChanged == "X"))
      /*Проверка изменения процента и категории для РВП*/
      if((AccOprServ.CalcReserve == "X") and (ClassifReserveLoss != ""))
        LastDateCalcReserveLoss = GetAccLastDateCalcReserveLoss(MakeAccountIDEx(acc));
        if(LastDateCalcReserveLoss != null)
          /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Последний раз РВП сформирован " + string(LastDateCalcReserveLoss));*/
          stat = ResAccActualize
          (
            AccOprServ
           ,acc
           ,LastDateCalcReserveLoss
           ,AccountReserveKind
           ,OffshoreGroup
           ,ClassifReserveLoss
           ,ClassifReserveLoans
           ,ClassifReserveOffshore
           ,@LastPtRiskGroup
           ,@LastPtReserveProcent
           ,@LastPtReserveProcentOffshore
           ,@LastPtReserveProcentEstimated
           ,@LastRiskGroup
           ,@LastReserveProcent
           ,@LastReserveProcentOffshore
           ,@LastReserveProcentEstimated
           ,true
          );
          if(    stat
             and (RiskGroup != null) 
             and (LastRiskGroup != null) 
             and (RiskGroup == LastRiskGroup) 
             and (ReserveProcent != null) 
             and (LastReserveProcent != null) 
             and (ReserveProcent == LastReserveProcent))
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры РВП не изменились");*/
            ChangedLoss = false;
          else
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры РВП изменились");*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "stat = " + string(stat));*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "RiskGroup = " + RiskGroup);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "LastRiskGroup = " + LastRiskGroup);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "ReserveProcent = " + ReserveProcent);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "LastReserveProcent = " + LastReserveProcent);*/
          end;
        end;
      else
        ChangedLoss = false;
      end;
      /*Проверка изменения процента и категории для РВПС*/
      if((AccOprServ.CalcReserveLoans == "X") and (ClassifReserveLoans != ""))
        LastDateCalcReserveLoans = GetAccLastDateCalcReserveLoans(MakeAccountIDEx(acc));
        if(LastDateCalcReserveLoans != null)
          /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Последний раз РВПС сформирован " + string(LastDateCalcReserveLoans));*/
          stat = ResAccActualize
          (
            AccOprServ
           ,acc
           ,LastDateCalcReserveLoans
           ,AccountReserveKind
           ,OffshoreGroup
           ,ClassifReserveLoss
           ,ClassifReserveLoans
           ,ClassifReserveOffshore
           ,@LastPtRiskGroup
           ,@LastPtReserveProcent
           ,@LastPtReserveProcentOffshore
           ,@LastPtReserveProcentEstimated
           ,@LastRiskGroup
           ,@LastReserveProcent
           ,@LastReserveProcentOffshore
           ,@LastReserveProcentEstimated
           ,true
          );
          if(    stat
             and (RiskGroup != null) 
             and (LastRiskGroup != null) 
             and (RiskGroup == LastRiskGroup) 
             and (ReserveProcent != null) 
             and (LastReserveProcent != null) 
             and (ReserveProcent == LastReserveProcent))
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры РВПC не изменились");*/
            ChangedLoans = false;
          else
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры РВПC изменились");*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "stat = " + string(stat));*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "RiskGroup = " + RiskGroup);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "LastRiskGroup = " + LastRiskGroup);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "ReserveProcent = " + ReserveProcent);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "LastReserveProcent = " + LastReserveProcent);*/
          end;
        end;
      else
        ChangedLoans = false;
      end;
      /*Проверка изменения процента и категории для РОФШ*/
      if((AccOprServ.CalcReserveOff == "X") and (ClassifReserveOffshore != ""))
        LastDateCalcReserveOffshore = GetAccLastDateCalcReserveOffshore(MakeAccountIDEx(acc));
        if(LastDateCalcReserveOffshore != null)
          /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Последний раз РОФШ сформирован " + string(LastDateCalcReserveOffshore));*/
          stat = ResAccActualize
          (
            AccOprServ
           ,acc
           ,LastDateCalcReserveOffshore
           ,AccountReserveKind
           ,OffshoreGroup
           ,ClassifReserveLoss
           ,ClassifReserveLoans
           ,ClassifReserveOffshore
           ,@LastPtRiskGroup
           ,@LastPtReserveProcent
           ,@LastPtReserveProcentOffshore
           ,@LastPtReserveProcentEstimated
           ,@LastRiskGroup
           ,@LastReserveProcent
           ,@LastReserveProcentOffshore
           ,@LastReserveProcentEstimated
           ,true
          );
          if(    stat
             and (ReserveProcentOffshore != null) 
             and (LastReserveProcentOffshore != null) 
             and (ReserveProcentOffshore == LastReserveProcentOffshore))
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры РОФШ не изменились");*/
            ChangedOffshore = false;
          else
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры РОФШ изменились");*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "stat = " + string(stat));*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "ReserveProcentOffshore = " + ReserveProcentOffshore);*/
            /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "LastReserveProcentOffshore = " + LastReserveProcentOffshore);*/
          end;
        end;
      else
        ChangedOffshore = false;
      end;
      /*Проверка изменения процента оценочного резерва*/
      if(AccOprServ.CalcEvalRes == "X")
        LastDateCalcReserveEstimated = GetAccLastDateCalcReserveEstimated(MakeAccountIDEx(acc));
        if(LastDateCalcReserveEstimated != null)
          stat = ResAccActualize
          (
            AccOprServ
           ,acc
           ,LastDateCalcReserveOffshore
           ,AccountReserveKind
           ,OffshoreGroup
           ,ClassifReserveLoss
           ,ClassifReserveLoans
           ,ClassifReserveOffshore
           ,@LastPtRiskGroup
           ,@LastPtReserveProcent
           ,@LastPtReserveProcentOffshore
           ,@LastPtReserveProcentEstimated
           ,@LastRiskGroup
           ,@LastReserveProcent
           ,@LastReserveProcentOffshore
           ,@LastReserveProcentEstimated
           ,true
          );
          if(    stat
             and (ReserveProcentEstimated != null) 
             and (LastReserveProcentEstimated != null) 
             and (ReserveProcentEstimated == LastReserveProcentEstimated))
            ChangedEstimated = false;
          end;
        end;
      else
        ChangedEstimated = false;
      end;
    end;
  end;

  if((not ChangedLoss) and (not ChangedLoans) and (not ChangedOffshore) and (not ChangedEstimated))
    /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры не изменились. Резерв не формируем.");*/
    DontFormReserve();
    return true;
  end;
  /*AddToLogActualize(AccOprServ, ActualizeMessage, string(acc.Account:f), "Параметры изменились. Резерв формируем.");*/

  if(stat)

    if(AccOprServ.ConsiderMinPercent == "X")
      ConsiderMinPercent = true;
    end;

    accResObj = CalcReserveAccount( acc, AccOprServ.Date
                                   ,ClassifReserveLoss    
                                   ,ClassifReserveLoans   
                                   ,ClassifReserveOffshore
                                   ,@OffshoreGroup
                                   ,PtRiskGroup
                                   ,PtReserveProcent
                                   ,PtReserveProcentOffshore
                                   ,PtReserveProcentEstimated
                                   ,AccountReserveKind
                                   ,ConsiderMinPercent
                                  );

    /* считаем резервы */
    _CalcReserve( accResObj );
    
    if((ReserveAccount != null) and ((OffshoreGroup == 2) or (OffshoreGroup == 3)) and
       (GetProcentOfReserveOffshore(acc.Chapter, acc.Code_Currency, acc.Account, AccOprServ.Date) != null))
    
      RestReserveAccount            = GetAbsAccRest( ReserveAccount, AccOprServ.Date, BalanceChapter );
      RestReserveSubAccount         = GetAbsRestSubAccount( RsvSubAccName, ReserveAccount, AccOprServ.Date );
      RestReserveLoansSubAccount    = GetAbsRestSubAccount( RsvLoansSubAccName, ReserveAccount, AccOprServ.Date );
      RestReserveOffshoreSubAccount = GetAbsRestSubAccount( RsvOffshoreSubAccName, ReserveAccount, AccOprServ.Date );

      if((RestReserveSubAccount != $0) and (RestReserveLoansSubAccount != $0))
        AddToLogFormError( AccOprServ, string(acc.Account:f), "Сформированный резерв неправильно распределен по субсчетам." );
      elif(((RestReserveSubAccount + RestReserveLoansSubAccount + RestReserveOffshoreSubAccount) != RestReserveAccount) and
           (((RestReserveSubAccount != $0) and (RestReserveOffshoreSubAccount != $0)) or
            ((RestReserveLoansSubAccount != $0) and (RestReserveOffshoreSubAccount != $0))))
        AddToLogFormError( AccOprServ, string(acc.Account:f), "Сформированный резерв неправильно распределен по субсчетам." );
      elif((RestReserveSubAccount < $0) or (RestReserveLoansSubAccount < $0) or (RestReserveOffshoreSubAccount < $0))
        AddToLogFormError( AccOprServ, string(acc.Account:f), "Сформированный резерв неправильно распределен по субсчетам." );
      end;
    end;
    _CalcReserveTotal();

  end;
 
  return true;
end;

/* Макрофункция, вызываемая при завершении формирования резерва по счету */
macro ЗавершениеОбработкиСчета( _acc, ErrNum, ErrorString )

  record acc(account);

  SetBuff( acc, _acc );

  if( (ErrNum) and (ErrorString) )
    AddToLogActualize( AccOprServ, ActualizeError, string(acc.Account:f), ErrorString );
  end;

end;

private macro GetAcCaseParmOnDate(AcCaseParm, AcCase, OnDate) : bool
  var query, rs;
  var params : TArray;
  query =         "SELECT t_riskgroup, t_reservepercent ";
  query = query + "  FROM daccasepm_dbt ";
  query = query + " WHERE t_caseid = :CaseID ";
  query = query + "   AND t_datefrom <= :DateFrom ";
  query = query + " ORDER BY t_DateFrom DESC ";
  params = makeArray(SQLParam("CaseID", AcCaseParm.CaseID)
                    ,SQLParam("DateFrom", OnDate)
                    );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    AcCaseParm.RiskGroup      = rs.value(0);
    AcCaseParm.ReservePercent = rs.value(1);
    return true;
  end;
  return false;
end;

/* Макрофункция, вызываемая при старте формирования резерва по портфелю */
macro ОбработкаПортфеля( _AcCase, _AcCaseParm, _AcCaseSubCase )
  
  var stat : bool;
  record AcCase(accase);
  record AcCaseParm(accasepm);
  record AcCaseSubCase(accasscs);

  var caseResObj : CalcReserveAccCase;
  var ReserveAccount : string;
  var query, rs;
  var params : TArray;
  var ReserveType : integer;
  /*Значения процентов резервирования и категорий качества в текущем формировании*/
  var RiskGroup      : integer;
  var ReservePercent : double;
  /*Классификации резервов*/
  var ClassifReserveLoss     : string;
  var ClassifReserveLoans    : string;
  /*Даты послених расчетов по видам резервов*/
  var LastDateCalcReserveLoss : date;
  var LastDateCalcReserveLoans : date;
  /*Признаки изменения параметров для видов резерва*/
  var ChangedLoss     : bool;
  var ChangedLoans    : bool;
  var ChangedEstimated : bool;

  SetBuff( AcCase        , _AcCase        );
  SetBuff( AcCaseParm    , _AcCaseParm    );
  SetBuff( AcCaseSubCase , _AcCaseSubCase );

  stat = true;

  ChangedLoss     = true;
  ChangedLoans    = true;
  ChangedEstimated = true;

  InitReserveSum();

  ReserveAccount = GetAccountReserveForCase(AcCase, AcCaseSubCase);

  if((AccOprServ.CheckParm == "X") or ((AccOprServ.ProcessChanged == "X") and (ReserveAccount != "")))
    stat = ResCaseActualize(AccOprServ, AcCase, AcCaseParm, AcCaseSubCase, AccOprServ.Date, false);
    if(stat and (AccOprServ.ProcessChanged == "X"))
      /*Проверка изменения процента и категории для РВП*/
      if((AccOprServ.CalcReserve == "X") and (AcCase.ReserveKind == KindReserveLoss))
        LastDateCalcReserveLoss = GetCaseLastDateCalcReserveLoss(UniID(AcCaseSubCase, 0, DOCKIND_SUBCASE));
        /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Последний раз РВП сформирован " + string(LastDateCalcReserveLoss));*/
        if(LastDateCalcReserveLoss != null)
          RiskGroup      = AcCaseParm.RiskGroup     ;
          ReservePercent = AcCaseParm.ReservePercent;
          if(GetAcCaseParmOnDate(AcCaseParm, AcCase, LastDateCalcReserveLoss))
            stat = ResCaseActualize(AccOprServ, AcCase, AcCaseParm, AcCaseSubCase, LastDateCalcReserveLoss, true);
            if(    stat
               and (RiskGroup      == AcCaseParm.RiskGroup     )
               and (ReservePercent == AcCaseParm.ReservePercent))
              ChangedLoss = false;
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Параметры РВП не изменились");*/
            else
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Параметры РВП изменились");*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "stat = " + string(stat));*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "AcCaseParm.RiskGroup = " + AcCaseParm.RiskGroup);*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "AcCaseParm.ReservePercent = " + AcCaseParm.ReservePercent);*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "RiskGroup = " + RiskGroup);*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "ReservePercent = " + ReservePercent);*/
            end;
          end;
          AcCaseParm.RiskGroup      = RiskGroup     ;
          AcCaseParm.ReservePercent = ReservePercent;
        end;
      else
        ChangedLoss = false;
      end;
      /*Проверка изменения процента и категории для РВПС*/
      if((AccOprServ.CalcReserveLoans == "X") and (AcCase.ReserveKind == KindReserveLoans))
        LastDateCalcReserveLoans = GetCaseLastDateCalcReserveLoans(UniID(AcCaseSubCase, 0, DOCKIND_SUBCASE));
        /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Последний раз РВПС сформирован " + string(LastDateCalcReserveLoans));*/
        if(LastDateCalcReserveLoans != null)
          RiskGroup      = AcCaseParm.RiskGroup     ;
          ReservePercent = AcCaseParm.ReservePercent;
          if(GetAcCaseParmOnDate(AcCaseParm, AcCase, LastDateCalcReserveLoans))
            stat = ResCaseActualize(AccOprServ, AcCase, AcCaseParm, AcCaseSubCase, LastDateCalcReserveLoans, true);
            if(    stat
               and (RiskGroup      == AcCaseParm.RiskGroup     )
               and (ReservePercent == AcCaseParm.ReservePercent))
              ChangedLoans = false;
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Параметры РВПС не изменились");*/
            else
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Параметры РВПС изменились");*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "stat = " + string(stat));*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "AcCaseParm.RiskGroup = " + AcCaseParm.RiskGroup);*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "AcCaseParm.ReservePercent = " + AcCaseParm.ReservePercent);*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "RiskGroup = " + RiskGroup);*/
              /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "ReservePercent = " + ReservePercent);*/
            end;
          end;
          AcCaseParm.RiskGroup      = RiskGroup     ;
          AcCaseParm.ReservePercent = ReservePercent;
        end;
      else
        ChangedLoans = false;
      end;

      if((AccOprServ.CalcEvalRes == "X") and (AcCaseParm.LostPersent < 0))
        ChangedEstimated = false;
      end;
    end;
  end;

  if((not ChangedLoss) and (not ChangedLoans) and (not ChangedEstimated))
    /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Параметры не изменились. Резерв не формируем.");*/
    DontFormReserve();
    return true;
  end;
  /*AddToLogActualize(AccOprServ, ActualizeMessage, AcCase.Name, "Параметры изменились. Резерв формируем.");*/

  if(stat)
  
    query =         "SELECT t_reservetype ";
    query = query + "  FROM daccassub_dbt ";
    query = query + " WHERE t_caseid = :CaseSubID ";
    query = query + "   AND t_datefrom = :DateFrom ";
    params = makeArray(SQLParam("CaseSubID", AcCaseSubCase.CaseSubID)
                      ,SQLParam("DateFrom", AcCaseParm.DateFrom)
                      );
    rs = execSQLselect(query, params, true);
    while(rs and rs.moveNext())
      ReserveType = rs.value(0);
      
      ClassifReserveLoss  = GetCaseReserveClassif(KindReserveLoss , ReserveType, AcCase);
      ClassifReserveLoans = GetCaseReserveClassif(KindReserveLoans, ReserveType, AcCase);
    
      caseResObj = CalcReserveAccCase( AcCase, AcCaseSubCase, AcCaseParm, AccOprServ.Date, ReserveType 
                                      ,ClassifReserveLoss 
                                      ,ClassifReserveLoans
                                     );
      /* считаем резервы */
      _CalcReserve( caseResObj );
    end;                         
    _CalcReserveTotal();
  
  end;
  
  return true;
end;

/* Макрофункция, вызываемая при завершении формирования резерва по портфелю */
macro ЗавершениеОбработкиПортфеля( _accase, ErrNum, ErrorString )

  record accase(accase);

  SetBuff( accase, _accase );

  if( (ErrNum) and (ErrorString) )
    AddToLogActualize( AccOprServ, ActualizeError, accase.Name, ErrorString );
  end;

end;
