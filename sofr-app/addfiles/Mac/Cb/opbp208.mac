/*
 *  Операция 208 "Требование банка".
 *  Макрос шага 20 "Проводка".
 */

import InsCarryDoc;    
import PaymInter, BankInter;
import "pmoutcom.mac"; 
import "paym_rec.mac";

MACRO ExecuteStep( doc, primdoc, DocKind, ID_Operation )
  var d = RsbAccTransaction(); // RsbAccTransactionData

  /* Заполняем структуру проводки */
  d.Chapter          = 1;
  d.Kind_Oper        = " 1";
  d.ResultCarry      = 1;
  d.Date_Carry       = Pm_paym.ValueDate;
  d.Sum              = Pm_paym.Amount;
  d.FIID             = Pm_paym.FIID;
  d.Ground           = Pm_rmprop.Ground;
  d.Number_Pack      = Pm_paym.NumberPack;
  d.Numb_Document    = Pm_rmprop.Number;
  d.Department       = Pm_paym.Department;
  d.Shifr_Oper       = Pm_rmprop.ShifrOper;
  d.AccountPayer     = Pm_paym.PayerAccount;
  d.AccountReceiver  = Pm_paym.ReceiverAccount;

  if(d.AccountPayer == "")
    MsgBox("В схеме расчетов не задан счет \"Незавершенные расчеты банка (зачисление)\"");
    return 1;
  end;

  /* Выполним фактическую проводку со счета плательщика на счет получателя */
  if( not d.Carry() )
    MsgBox("Ошибка при вставке рублевого документа");
    return 1;
  end;

  /* Внутренний платеж после проводки закрываем */
  if( not InsertPaymentStat( 0, PM_FINISHED, PMMET_DPS, 0, 0, Pm_paym.Purpose, Pm_paym.SubPurpose ) )
    MsgBox("Ошибка при вставке статуса платежа");
    return 1;
  end;

  return 0;

END;
