import  XmlRpcInter, ServiceAction;

private const to_xml_rpc_request_xslt = "ifx_to_xml_rpc_request.xsl";



   MACRO dateFormat():STRING
      var dt = Date(), tm = Time();

      var S = "", T = "", dd, mm, yy, hh, mn, ss;

      //dtm = d;


      //DtTmSplit(dtm, dt, tm);

      // дата
      if (ValType(dt) != V_UNDEF)

         DateSplit(dt, dd, mm, yy);

         // проверка на нулевую дату  
        if ((yy == 0) and (mm == 0) and (dd == 0))
           return "";
        end;

         // год
         S = S + yy + "-";

         // месяц
         if(mm < 10)
            S = S + "0" + mm + "-";
         else
            S = S + mm + "-";
         end;

         // день
         if(dd < 10)
            S = S + "0" + dd;
         else
            S = S + dd;
         end;

      end;

      // время
      if ((ValType(tm) != V_UNDEF) AND (tm != TIME(0,0,0)))

         TimeSplit(tm, hh, mn, ss);
         // часы
         if(hh < 10)
            T = T + "0" + hh + "_";
         else
           T = T + hh + "_";
         end;

         // минуты
         if(mn < 10)
            T = T + "0" + mn + "_";
         else
           T = T + mn + "_";
         end;
         // секунды
         if(ss < 10)
            T = T + "0" + ss ;
         else
           T = T + ss;
         end;

         S = S + "_" + T ;
      else
         S = S + " 00_00_00";
      end;

      return S;
   END;


MACRO CreateOfflineFilename(reqId, url, msg)

  return reqid + "_" + dateFormat() + ".xml";
END;

MACRO ProcessMDMOffline(msg)
   var result;
   // Преобразовываем сообщение из формата IFX в XML-RPC
   var xml_rpc_msg = ApplyXSLT(msg, to_xml_rpc_request_xslt);
   
   // Выполняем получившееся XML RPC сообщение
   var logId = 0;
   println(XmlRpcLocalCall(xml_rpc_msg, @logId));

   if (logId == 0)
      result = "Файл успешно обработан.";
   else
      result = "Ошибка. Номер в журнале: " + string(logId);
   end;

   SetParm(1, result);

   return logId;
END;
