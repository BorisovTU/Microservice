//-----------------------------------------------------------------------------
// Блок     : 29010 - "Обработка в БО"
// Шаг      : 40    - "Подтверждение вторым лицом"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, cbsttls, pm_setst, OprInter, lnpaym;
var PaymentObj:RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шаг
//-----------------------------------------------------------------------------
MACRO ExecuteStep( doc, paymDoc, DocKind, ID_Operation )
  
  VAR select:string = " select step.t_Oper " +
                      " from doprstep_dbt step " +
                      " where step.t_ID_Operation = :ID_Operation " +
                      "   and step.t_IsExecute = 'X' " +
                      "   and step.t_ID_Step = ( select max(t_ID_Step) from doprstep_dbt step1 "
                                               " where t_ID_Operation = :ID_Operation1 " +
                                               "   and t_IsExecute = 'X' )";
  VAR params:TArray = makeArray(SQLParam( "ID_Operation", ID_Operation ),     
                                SQLParam( "ID_Operation1", ID_Operation ));
  
  VAR rset:RsdRecordset = execSQLselect( select, params, TRUE );
  if( rset and rset.moveNext() )
    if( rset.Value(0) == {Oper} )
      msgbox( "Пользователь " + {Oper} + " не может контролировать платеж");
      return 1;
    end;
  end;
  return 0;
END;