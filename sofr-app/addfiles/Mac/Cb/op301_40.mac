/*
 *  Макрос шага "Проведение исправительного оборота" операции "Исправительный оборот" по первичному документу "Мемордер"
 */
Import BankInter, OprInter, FIInter, PaymInter, InsCarryDoc, "cortur_lib.mac";

var PaymentObj : RsbPayment;
var Date_Rate  : date;

macro ExecuteStep( doc, primdoc )
  var stat = 0;
  var ПроводкаИсправительная = RsbAccTransaction;
  var Memorial : RsbMemorialOrder = RsbMemorialOrder( PaymentObj.DocumentID );

  ПроводкаИсправительная.Chapter          = Memorial.Chapter;
  ПроводкаИсправительная.FIID             = Memorial.Code_Currency;
  ПроводкаИсправительная.Sum              = PaymentObj.PayerAmount;
  ПроводкаИсправительная.AccountPayer     = PaymentObj.PayerAccount;
  ПроводкаИсправительная.AccountReceiver  = PaymentObj.ReceiverAccount;
  ПроводкаИсправительная.Numb_Document    = PaymentObj.Number;
  ПроводкаИсправительная.Date_Carry       = PaymentObj.ValueDate;
  ПроводкаИсправительная.Ground           = PaymentObj.Ground;
  ПроводкаИсправительная.TypeDocument     = Memorial.TypeDocument;
  ПроводкаИсправительная.Number_Pack      = PaymentObj.NumberPack;
  ПроводкаИсправительная.Shifr_Oper       = PaymentObj.ShifrOper;
  ПроводкаИсправительная.Kind_Oper        = Memorial.Kind_Oper;
  ПроводкаИсправительная.Department       = PaymentObj.Department;
  ПроводкаИсправительная.UserTypeDocument = Memorial.UserTypeDocument;
  ПроводкаИсправительная.Date_Rate        = Date_Rate;

  if(index(ПроводкаИсправительная.TypeDocument, "S") > 0)
    FillMultyCurrAccTrn(ПроводкаИсправительная, DLDOC_MEMORIALORDER, Memorial.DocumentID);
  end;
 
  if( not ПроводкаИсправительная.Carry() )
    stat = 1;
    msgbox( "Ошибка при вставке проводки" );
  end;

  if((stat == 0) and (index(ПроводкаИсправительная.TypeDocument, "S") > 0))
    /*Установить тип "Сторнирован" на исправляемый документ*/
    UpdateCorrectionalDoc(ПроводкаИсправительная.TypeDocument, PaymentObj.DocKind, PaymentObj.DocumentID);
  end;

  // Статус платежа меняем на "Завершенный платеж"
  PaymentObj.PaymStatus = PM_FINISHED;
  // Изменяем дату списания со счета плательщика
  PaymentObj.PayerChargeOffDate = PaymentObj.ValueDate;

  return stat;

end;
