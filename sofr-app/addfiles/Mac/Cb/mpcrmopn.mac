/*-------------------------------------------------------------------------
          Ä¢‚Æ¨†‚®ß®‡Æ¢†≠≠†Ô °†≠™Æ¢·™†Ô ·®·‚•¨† RS-Bank v6.0.020
                 Copyright (c) R-Style Software Lab

  à¨Ô ‰†©´†        : mpcrmopn.mac

  Å®°´®Æ‚•™†       : 

  éØ®·†≠®•         : 

  è‡Æ£‡†¨¨®·‚      : Ñ„‡Ô£®≠ Ö¢£•≠®© (DEA)

  ëÆß§†≠           : 13.05.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter,  globals, library, FIInter;
          
var   DateCalculateBegin, 
      DateCalculateEnd,
      Schedkind,
      DateMin,
      OperName,
      Daily,
      OpKind,
      DocID,
      OperDate,
      contr,
      gOperDate, 
      gOper, 
      gDepartment, 
      gTypeOfAccounts, 
      gFininstrFIID, 
      gAccountMask, 
      gPartyIDClient, 
      gisbackstep,
      gDepName,
      gFininstrName,
      gFininstrCode,
      gClientName,
      ContractBoffice,
      ContractNumber,
      ContractAccount,
      OperNum,
      OperId,
      ContractID;


/* ------------------------------- */

private macro PumpBO(BO)
   var cmd, RS;
   cmd = RSDCommand( " select t_code from dllvalues_dbt where t_list = 1118 and t_element = ? " ) ; 
   cmd.addParam( "", RSDBP_IN, BO );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      ContractBoffice = Rs.code;
   end;
end;

private macro PumpDepName()
   var cmd, RS;
   if (gDepartment == -1)
      gDepName = "èÆ ¢·•¨ ‰®´®†´†¨";     
   else
      cmd = RSDCommand( "select par.t_shortname from dparty_dbt par, ddp_dep_dbt dep " +
                         "where par.t_partyid = dep.t_partyid and dep.t_code =  ? " ) ; 
      cmd.addParam( "", RSDBP_IN, gDepartment);
      cmd.execute();
      RS = TRsbDataSet(cmd);
      if (RS.movenext() )
         gDepName = Rs.shortname;
      end;
   end;
end;

private macro PumpClientName()
   var cmd, RS;
   cmd = RSDCommand( " select t_shortname from dparty_dbt where t_PartyID =  ? " ) ; 
   cmd.addParam( "", RSDBP_IN, gPartyIDClient);
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      gClientName = Rs.shortname;
   else
      gClientName = "";
   end;
end;

private macro PrintHeadOpen()
   var fininstr;
   PumpDepName();
   PumpClientName();
   fininstr = TRecHandler("fininstr.dbt");
   if (èÆ´„Á®‚Ïî®≠à≠( gFininstrFIID, fininstr ) == 0)
        gFininstrName = fininstr.rec.Name; 
        gFininstrCode = fininstr.rec.FI_Code;
   end;
   if (strlen (gTypeOfAccounts) < 2)    
        gTypeOfAccounts = "Ç·• ¢®§Î";
   end;
   if (gisbackstep == false )
      [  è‡Æ‚Æ™Æ´ ¢ÎØÆ´≠•≠®Ô ÆØ•‡†Ê®® Ø•‡¢Æ≠†Á†´Ï≠Æ£Æ ß†ØÆ´≠•≠®Ô è‡ÆÊ•≠‚≠ÎÂ §Æ£Æ¢Æ‡Æ¢ ];
   else
      [  è‡Æ‚Æ™Æ´ „§†´•≠®Ô ÆØ•‡†Ê®® Ø•‡¢Æ≠†Á†´Ï≠Æ£Æ ß†ØÆ´≠•≠®Ô è‡ÆÊ•≠‚≠ÎÂ §Æ£Æ¢Æ‡Æ¢ ]; 
   end;
   [   ];
   [ Ñ†‚† ÆØ•‡†Ê®®:    ##########](Date(gOperDate):c);
   [ éØ•‡†Ê®Æ≠®·‚:    #### #########](OperNum,OperName);
   [ î®´®†´:           ###################################### ](gDepName);
   [ Ç®§ ·Á•‚Æ¢:       ##################](gTypeOfAccounts);
   [ äÆ§ ¢†´Ó‚Î:       #### ############################ ](gFininstrCode, gFininstrName);
   [ å†·™† ´®Ê•¢ÎÂ ·Á•‚Æ¢: ####################### ](gAccountMask);
   [ ä´®•≠‚:           ###################################### ](gClientName);
   
end;

private macro PrintLine(RS, flag, AfterErr);
   var Boffice;
   if (flag)
      Boffice = RS.backoffice;
      ContractNumber = RS.number;
      ContractID = RS.contractid;         
      PumpBO(Boffice);
   end;
   ContractAccount = RS.account;
   gPartyIDClient = RS.client;  
   PumpClientName();
   if(AfterErr == true)
     [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];   
   else
     [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   end;

   if (flag)
      [≥#############################≥#########################≥######### ###################≥]
        (ContractAccount:c, gClientName:c, ContractBoffice:c, ContractNumber:c  ); 
   else 
      [≥#############################≥#########################≥                             ≥]
       (ContractAccount:c, gClientName:c );     
   end;
end;


private macro PrintErrLine(StrErr);
   var i = 0;
   array StringArray;

   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];   
   StrSplit(StrErr, StringArray, 80);
   while ( StrLen(StringArray(i) ) > 0)
     [≥#####################################################################################≥](StringArray(i)); 
     i = i + 1;
   end;
end;


private macro PrintSubHead(flag) 
   [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
   if (flag)
      [≥        ã®Ê•¢Æ© ·Á•‚         ≥        ä´®•≠‚           ≥ çÆ¨•‡ Ø‡ÆÊ•≠‚≠Æ£Æ §Æ£Æ¢Æ‡†  ≥];
   else
      [≥        ã®Ê•¢Æ© ·Á•‚         ≥        ä´®•≠‚           ≥                             ≥];
   end;
end;

private macro PrintBottom(AfterErr) 
if(AfterErr)
[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
else
[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
end;
[ ];
end;

private macro ShowTable() 
   var RS0, RS, RS1, RS2, RS3, cmd, CountRecs = 0;
   var StrErr = "";

   if (gisbackstep == false)
      cmd = RSDCommand( "select count(T_ACCOUNT) as cnt from Dprcsrvacc_tmp where t_state >= -2 and t_state <= 0 and t_department = ? "); 
      cmd.addParam( "", RSDBP_IN, gDepartment );
      cmd.execute();
      RS0 = TRsbDataSet(cmd);
      if (RS0.movenext())
         CountRecs = RS0.cnt;
      end;
      
      if (CountRecs > 0 )
              cmd = RSDCommand("select T_ACCOUNT, T_CLIENT, T_CONTRACTID, T_NUMBER, T_BACKOFFICE from Dprcsrvacc_tmp " +
                                "where t_state = 0 and t_department = ? and t_contractid is not NULL order by t_Number "); 
        cmd.addParam( "", RSDBP_IN, gDepartment );
        cmd.execute();
        RS = TRsbDataSet(cmd);
        if (RS.movenext())
              [ ëÆß§†≠≠Î• Ø‡ÆÊ•≠‚≠Î• §Æ£Æ¢Æ‡†:];
                PrintSubHead(1);
                PrintLine(RS, 1, false);
                while (RS.movenext())
                PrintLine(RS, 1, false);
              end;
            PrintBottom(false);
         end;
      
           cmd = RSDCommand( "select count(T_ACCOUNT) as cnt from Dprcsrvacc_tmp where t_state = -1 and t_department = ? " );         
         cmd.addParam( "", RSDBP_IN, gDepartment );
           cmd.execute();
           RS1 = TRsbDataSet(cmd);      
         CountRecs = 0;
         if (RS1.movenext() )
                   CountRecs = Rs1.cnt;
           end;
         
           if (CountRecs>0)
                      [ ã®Ê•¢Î• ·Á•‚† · ·Æ¢Ø†§†ÓÈ®¨® Ø†‡†¨•‚‡†¨® èÑ:];  
                 PrintSubHead(1);
            cmd = RSDCommand( "select T_ACCOUNT, T_CLIENT, T_CONTRACTID, T_NUMBER, T_BACKOFFICE from Dprcsrvacc_tmp " +
                               "where t_state = -1 and t_department = ? order by t_BackOffice, t_Number "); 
           cmd.addParam( "", RSDBP_IN, gDepartment );
            cmd.execute();
            
                   RS2 = TRsbDataSet(cmd);
            if (RS2.movenext())
               PrintLine(RS2, 1, false);
            end;
            
            while (RS2.movenext())
               PrintLine(RS2, 1, false);
                   end;
            PrintBottom(false);
         end;
         
         cmd = RSDCommand( "select T_ACCOUNT, T_CLIENT, T_CONTRACTID, T_NUMBER, T_BACKOFFICE, T_COMENT from Dprcsrvacc_tmp where t_state = -2 and t_department = ? order by t_Number"); 
         cmd.addParam( "", RSDBP_IN, gDepartment );
         cmd.execute();
         RS3 = TRsbDataSet(cmd);
         if (RS3.movenext())
            [ éË®°™® Ø‡® ·Æß§†≠®® èÑ: ];
            PrintSubHead(0);
            PrintLine(RS3, 0, false);

            StrErr = RS3.Coment;
            PrintErrLine(StrErr);

            while (RS3.movenext())
              PrintLine(RS3, 0, true);                     
              StrErr = RS3.Coment;
              PrintErrLine(StrErr);
            end;
            PrintBottom(true);
         end;                                                                                   
     
      else
         [ ];
         [ ç•‚ ´®Ê•¢ÎÂ ·Á•‚Æ¢, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â „·´Æ¢®Ô¨ ß†Ø„·™† ];           
      end;
      
   else
      cmd = RSDCommand( "select count(T_ACCOUNT) as cnt from Dprcsrvacc_tmp where t_state >= -3 and t_state <= -1 and t_department = ? "); 
      cmd.addParam( "", RSDBP_IN, gDepartment);
      cmd.execute();
      RS0 = TRsbDataSet(cmd);
      if (RS0.movenext())
         CountRecs = RS0.cnt;
      end;
      if (CountRecs > 0 )
        cmd = RSDCommand( "select T_ACCOUNT, T_CLIENT, T_CONTRACTID, T_NUMBER, T_BACKOFFICE from Dprcsrvacc_tmp where t_state = -3 and t_department = ? order by t_Number"); 
        cmd.addParam( "", RSDBP_IN,gDepartment );
        cmd.execute();
        RS = TRsbDataSet(cmd);
        if (RS.movenext())
            [ì§†´•≠≠Î• Ø‡ÆÊ•≠‚≠Î• §Æ£Æ¢Æ‡†:];
                PrintSubHead(1);
                PrintLine(RS, 1, false);
                while (RS.movenext())
                 PrintLine(RS, 1, false);
                   end;
                PrintBottom(false);
         end;

         cmd = RSDCommand( "select T_ACCOUNT, T_CLIENT, T_CONTRACTID, T_NUMBER, T_BACKOFFICE, T_COMENT from Dprcsrvacc_tmp where t_state = -2 and t_department = ? order by t_Number"); 
         cmd.addParam( "", RSDBP_IN, gDepartment );
         cmd.execute();
         RS3 = TRsbDataSet(cmd);
         if (RS3.movenext())
            [ éË®°™® Ø‡® „§†´•≠®® èÑ: ];
            PrintSubHead(1);
            PrintLine(RS3, 1, false);

            StrErr = RS3.Coment;
            PrintErrLine(StrErr);

            while (RS3.movenext())
               PrintLine(RS3, 1, true);               
               StrErr = RS3.Coment;
               PrintErrLine(StrErr);
            end;
            PrintBottom(true);
         end;

      else
         [ ];
         [ ç•‚ ´®Ê•¢ÎÂ ·Á•‚Æ¢, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â „·´Æ¢®Ô¨ ß†Ø„·™† ];           
         [ ];
      end;
   end; 
   
end;

/*****************************************************************************
               è•Á†‚Ï Ø‡Æ‚Æ™Æ´† ¨†··Æ¢Æ© Ø‡ÆÊ•§„‡Î 
                     è•‡¢Æ≠†Á†´Ï≠Æ• ß†ØÆ´≠•≠®• Ø‡ÆÊ•≠‚≠ÎÂ §Æ£Æ¢Æ‡Æ¢
******************************************************************************/
macro MpcOpenPrcMassGenReport(OperDate, Oper, Department, TypeOfAccounts, FininstrFIID, AccountMask, PartyIDClient, isbackstep)

   var  Data, RS, cmd,
        iSum = $0,
        iDays = 0,
        TotalSum = $0,
        TotalDays = 0,
         FactSum = $0,
         Summa = $0;

   gOperDate = OperDate ;
   gOper = Oper;
   gDepartment = Department;
   gTypeOfAccounts = TypeOfAccounts;
   gFininstrFIID = FininstrFIID;
   gAccountMask = AccountMask;
   gPartyIDClient = PartyIDClient;
   gisbackstep = isbackstep;

   OperNum = {oper};
   OperName = {Name_Oper};

   PrintHeadOpen();
   if (gDepartment > 0)
      ShowTable();
   else
      //cmd = RSDCommand ("select distinct t_department from dprcsrvacc_tmp where t_department is not NULL and t_department > 0 ");
      cmd = RSDCommand ("select t_code from ddp_dep_dbt where t_nodetype = 1 and t_status = 2");
      cmd.execute();
      RS = TRsbDataSet(cmd);
      while( RS.movenext())
         //gDepartment = RS.department;
         gDepartment = RS.code;
         PumpDepName();
         [ ];
         [ î®´®†´:           ###################################### ](gDepName);         
         [ ];
         ShowTable();           
      end;
   end;

end;    


