/*
 $Name: eapmdocs.mac
 $Module: ЭА
 $Description: ЭА banking
*/

import BankInter, oralib, likepy, PaymInter;

private const ED_ABED_LMA_FORMAT = 1;
private const ED_DEV_FORMAT = 0;

private macro GetBool(name: string, def: bool)
  var val, err;
  GetRegistryValue(name, V_BOOL, val, err);
  if (err)
    val = def;
  end;
  return val;
end;

macro GetPaymentParams(edKind: Integer, query: @string, Symb: @string, FormCode: @string)
  if (edKind == 1)//Платежное поручение
    query = string(" AND ((pmpaym.t_PrimDocKind = 201\n",
      "                AND EXISTS\n",
      "                       (SELECT 1\n",
      "                          FROM dpspayord_dbt pspo\n",
      "                         WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                               AND pspo.t_DocKind = 1 /*PSPOKIND_ORDER*/\n",
      "                                                     ))\n",
      "               OR pmpaym.t_PrimDocKind IN (202, 16, 27))\n",
      "              AND pmrmprop.t_ShifrOper <> '16'\n");
    Symb = "ПП";
    FormCode = " Decode(pmpaym.t_PrimDocKind, " +
               "202, rsb_common.getRegStrValue ('EA\\EXTEA\\ВЫГРУЗКА_ЭД\\PAYORDER\\PSCPCODE'), " +
               "27, rsb_common.getRegStrValue ('EA\\EXTEA\\ВЫГРУЗКА_ЭД\\PAYORDER\\BBCPCODE'), '0401060')"; 
  elif (edKind == 2)//Платежное требование
    query = string(" AND ((pmpaym.t_PrimDocKind = 201\n",
      "                AND EXISTS\n",
      "                       (SELECT 1\n",
      "                          FROM dpspayord_dbt pspo\n",
      "                         WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                               AND pspo.t_DocKind = 2 /*PSPOKIND_DEMAND*/\n",
      "                                                     )\n",
      "                AND pmrmprop.t_ShifrOper <> '16')\n",
      "               OR (pmpaym.t_PrimDocKind = 17\n",
      "                AND pmrmprop.t_ShifrOper <> '16')\n",
      "               OR (pmpaym.t_PrimDocKind = 320\n",
      "                AND pmrmprop.t_ShifrOper = '02'))\n");
    Symb = "ПТ";
    FormCode = "'0401061'";
  elif (edKind == 3)//Аккредитив
    query = string(" AND ((pmpaym.t_PrimDocKind = 201\n",
      "                AND EXISTS\n",
      "                       (SELECT 1\n",
      "                          FROM dpspayord_dbt pspo\n",
      "                         WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                               AND pspo.t_DocKind = 4 /*PSPOKIND_AKKREDITIV*/\n",
      "                                                     )\n",
      "                AND pmrmprop.t_ShifrOper <> '16')\n",
      "               OR (pmpaym.t_PrimDocKind = 320\n",
      "                AND pmrmprop.t_ShifrOper = '08'))\n");
    Symb = "ПА";
    FormCode = "'0401063'";
  elif (edKind == 4)//Платежный ордер
    query = " AND pmpaym.t_PrimDocKind IN (201, 320) AND pmrmprop.t_ShifrOper = '16' ";
    Symb = "ПО";
    FormCode = "'0401066'";
  elif (edKind == 5)//Банковский ордер
    query = " AND pmpaym.t_PrimDocKind = 286 ";
    Symb = "БО";
    FormCode = "'0401067'";
  elif (edKind == 6)//Инкассовое поручение
    query = string(" AND ( (pmpaym.t_PrimDocKind = 201\n",
      "                  AND EXISTS\n",
      "                         (SELECT 1\n",
      "                            FROM dpspayord_dbt pspo\n",
      "                           WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                                 AND pspo.t_DocKind = 3 /*PSPOKIND_REQUEST*/\n",
      "                                                       )\n",
      "                  AND pmrmprop.t_ShifrOper <> '16')\n",
      "                OR (pmpaym.t_PrimDocKind = 203\n",
      "                  AND pmrmprop.t_ShifrOper <> '16')\n",
      "                OR (pmpaym.t_PrimDocKind = 320\n",
      "                  AND pmrmprop.t_ShifrOper = '02'))\n",
      "               AND NOT EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmdemand_dbt pmd\n",
      "                            WHERE pmd.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND pmd.t_IsESID = CHR (0))\n");
    Symb = "ИП";
    FormCode = "'0401071'";
  elif (edKind == 7)//Мемориальный ордер
    query = "";
    var tmp = "";
    if (GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_MO", false))
      query = " AND (pmpaym.t_PrimDocKind in (15, 70, 74) ";
      tmp = "OR ";
    else
      query = " AND (";
    end;
    if (GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_ED111", false))
      query = query + tmp + "(pmpaym.t_PrimDocKind = 320 AND pmrmprop.t_ShifrOper = '09')";
    end;
    if (query != "")
      query = query + ") ";
    end;
    Symb = "П1";
    FormCode = "'0401108'";
  elif (edKind == 8)//Объявление на взнос наличными
    query = " AND pmpaym.t_PrimDocKind = 410 ";
    Symb = "ОВ";
    FormCode = "'0401001'";
  elif (edKind == 9)//Приходный кассовый ордер
    query = " AND pmpaym.t_PrimDocKind = 430 ";
    Symb = "ПК";
    FormCode = "'0402008'";
  elif (edKind == 10)//Расходный кассовый ордер
    query = " AND pmpaym.t_PrimDocKind = 440 ";
    Symb = "РК";
    FormCode = "'0402009'";
  elif (edKind == 19)//Исправительная выписка по лицевому счету
    query = " AND pmpaym.t_PrimDocKind in (70, 286) ";
    Symb = "ИО";
    FormCode = "''";
  elif (edKind == 20)//Входящее платежное поручение
    query = " AND pmpaym.t_PrimDocKind = 320 AND pmrmprop.t_ShifrOper = '01' ";
    Symb = "ВП";
    FormCode = "'0401060'";
  elif (edKind == 21)//Клиентский чек
    query = " AND pmpaym.t_PrimDocKind = 420 ";
    Symb = "КЧ";
    FormCode = "'0402009'";
  elif (edKind == 22)//Проводка разноски платежа
    query = "";
    Symb = "ПР";
    FormCode = "'0401108'";
  end;
end;

macro GetParentEDocID(): string
  return string ("RPAD (\n",
      "       SUBSTR (\n",
      "          NVL (rsb_common.getRegStrValue ('EA\EXTEA\SYSIDINEA'),\n",
      "               '____'),\n",
      "          1,\n",
      "          4),\n",
      "       4,\n",
      "       '_')\n",
      "    || CASE\n",
      "          WHEN pmpaym.t_PrimDocKind = 286\n",
      "          THEN\n",
      "             'БО'\n",
      "          WHEN pmpaym.t_PrimDocKind = 410\n",
      "          THEN\n",
      "             'ОВ'\n",
      "          WHEN pmpaym.t_PrimDocKind = 430\n",
      "          THEN\n",
      "             'ПК'\n",
      "          WHEN pmpaym.t_PrimDocKind = 440\n",
      "          THEN\n",
      "             'РК'\n",
      "          WHEN pmpaym.t_PrimDocKind = 420\n",
      "          THEN\n",
      "             'КЧ'\n",
      "          WHEN (pmpaym.t_PrimDocKind = 201\n",
      "                AND EXISTS\n",
      "                       (SELECT 1\n",
      "                          FROM dpspayord_dbt pspo, dpmrmprop_dbt rmpr\n",
      "                         WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                               AND rmpr.t_PaymentID =\n",
      "                                      pmpaym.t_PaymentID\n",
      "                               AND rmpr.t_ShifrOper <> '16'\n",
      "                               AND pspo.t_DocKind = 4 /*PSPOKIND_AKKREDITIV*/\n",
      "                                                     ))\n",
      "               OR (pmpaym.t_PrimDocKind = 320\n",
      "                   AND EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmrmprop_dbt rmpr\n",
      "                            WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND rmpr.t_ShifrOper = '08'))\n",
      "          THEN\n",
      "             'ПА'\n",
      "          WHEN (pmpaym.t_PrimDocKind = 201\n",
      "                AND EXISTS\n",
      "                       (SELECT 1\n",
      "                          FROM dpspayord_dbt pspo, dpmrmprop_dbt rmpr\n",
      "                         WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                               AND rmpr.t_PaymentID =\n",
      "                                      pmpaym.t_PaymentID\n",
      "                               AND rmpr.t_ShifrOper <> '16'\n",
      "                               AND pspo.t_DocKind = 1 /*PSPOKIND_ORDER*/\n",
      "                                                     ))\n",
      "               OR (pmpaym.t_PrimDocKind IN (202, 16, 27)\n",
      "                   AND EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmrmprop_dbt rmpr\n",
      "                            WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND rmpr.t_ShifrOper <> '16'))\n",
      "          THEN\n",
      "             'ПП'\n",
      "          WHEN pmpaym.t_PrimDocKind IN (201, 320)\n",
      "               AND EXISTS\n",
      "                      (SELECT 1\n",
      "                         FROM dpmrmprop_dbt rmpr\n",
      "                        WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                              AND rmpr.t_ShifrOper = '16')\n",
      "          THEN\n",
      "             'ПО'\n",
      "          WHEN (pmpaym.t_PrimDocKind = 201\n",
      "                AND EXISTS\n",
      "                       (SELECT 1\n",
      "                          FROM dpspayord_dbt pspo, dpmrmprop_dbt rmpr\n",
      "                         WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                               AND rmpr.t_PaymentID =\n",
      "                                      pmpaym.t_PaymentID\n",
      "                               AND rmpr.t_ShifrOper <> '16'\n",
      "                               AND pspo.t_DocKind = 2 /*PSPOKIND_DEMAND*/\n",
      "                                                     ))\n",
      "               OR (pmpaym.t_PrimDocKind = 17\n",
      "                   AND EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmrmprop_dbt rmpr\n",
      "                            WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND rmpr.t_ShifrOper <> '16'))\n",
      "               OR (pmpaym.t_PrimDocKind = 320\n",
      "                   AND EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmrmprop_dbt rmpr\n",
      "                            WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND rmpr.t_ShifrOper = '02'))\n",
      "          THEN\n",
      "             'ПТ'\n",
      "          WHEN ( (pmpaym.t_PrimDocKind = 201\n",
      "                  AND EXISTS\n",
      "                         (SELECT 1\n",
      "                            FROM dpspayord_dbt pspo, dpmrmprop_dbt rmpr\n",
      "                           WHERE pspo.t_OrderID = pmpaym.t_DocumentID\n",
      "                                 AND rmpr.t_PaymentID =\n",
      "                                        pmpaym.t_PaymentID\n",
      "                                 AND rmpr.t_ShifrOper <> '16'\n",
      "                                 AND pspo.t_DocKind = 3 /*PSPOKIND_REQUEST*/\n",
      "                                                       ))\n",
      "                OR (pmpaym.t_PrimDocKind = 203\n",
      "                    AND EXISTS\n",
      "                           (SELECT 1\n",
      "                              FROM dpmrmprop_dbt rmpr\n",
      "                             WHERE rmpr.t_PaymentID =\n",
      "                                      pmpaym.t_PaymentID\n",
      "                                   AND rmpr.t_ShifrOper <> '16'))\n",
      "                OR (pmpaym.t_PrimDocKind = 320\n",
      "                    AND EXISTS\n",
      "                           (SELECT 1\n",
      "                              FROM dpmrmprop_dbt rmpr\n",
      "                             WHERE rmpr.t_PaymentID =\n",
      "                                      pmpaym.t_PaymentID\n",
      "                                   AND rmpr.t_ShifrOper = '02')))\n",
      "               AND NOT EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmdemand_dbt pmd\n",
      "                            WHERE pmd.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND pmd.t_IsESID = CHR (0))\n",
      "          THEN\n",
      "             'ИП'\n",
      "          WHEN pmpaym.t_PrimDocKind IN (15, 70, 74)\n",
      "               OR (pmpaym.t_PrimDocKind = 320\n",
      "                   AND EXISTS\n",
      "                          (SELECT 1\n",
      "                             FROM dpmrmprop_dbt rmpr\n",
      "                            WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                                  AND rmpr.t_ShifrOper = '09'))\n",
      "          THEN\n",
      "             'П1'\n",
      "          WHEN pmpaym.t_PrimDocKind = 320\n",
      "               AND EXISTS\n",
      "                      (SELECT 1\n",
      "                         FROM dpmrmprop_dbt rmpr\n",
      "                        WHERE rmpr.t_PaymentID = pmpaym.t_PaymentID\n",
      "                              AND rmpr.t_ShifrOper = '01')\n",
      "          THEN\n",
      "             'ВП'\n",
      "          ELSE\n",
      "             '??'\n",
      "       END\n",
      "    || LPAD (TO_CHAR (pmdocs.t_PaymentID), 33, '0')\n");
end;

/*Отбор данных для выгрузки мемориальных ордеров на основе проводок*/
macro SelectMemord(mode : Integer, reportDate : date, DepId : Integer, edKind : Integer, additionalParm : String, uploadFormat : Integer)
  var prm, Symb, Form;
  GetPaymentParams(edKind, @prm, @Symb, @Form);
  var C_MO   = GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_MO", true),
      C_BO   = GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_BO", false),
      C_OTH  = GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_OTH", false),
      C_NOPD = GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_NOPD", true);
  var pos = 0;
  var tmp = "";
  var query = string("INSERT INTO dedoc_tmp (t_DocDate,\n",
   "                    t_depNumber,\n",
   "                    t_eDocKindID,\n",
   "                    t_eDocID,\n",
   "                    t_vspNumber,\n",
   "                    t_formCode,\n",
   "                    t_DocNumber,\n",
   "                    t_AccountID,\n",
   "                    t_ParentEDocID,\n",
   "                    t_creationDateTime,\n",
   "                    t_IsAccTrn,\n",
   "                    t_IsCashDoc,\n",
   "                    t_CreateResult,\n",
   "                    t_CreditAccount,\n",
   "                    t_CreditFIID,\n",
   "                    t_CreditSum,\n",
   "                    t_DebetAccount,\n",
   "                    t_DebetFIID,\n",
   "                    t_DebetSum)\n"
   "SELECT acctrn.t_Date_Carry,\n",
   "       acctrn.t_Department,\n",
   "       ", edKind, ",\n",
   "       RPAD (\n",
   "          SUBSTR (\n",
   "             NVL (rsb_common.getRegStrValue ('EA\\EXTEA\\SYSIDINEA'),\n",
   "                  '____'),\n",
   "             1,\n",
   "             4),\n",
   "          4,\n",
   "          '_')\n",
   "       || '", Symb, "'\n",
   "       || LPAD (TO_CHAR (acctrn.t_AcctrnID), 33, '0'),\n",
   "       acctrn.t_Branch,\n",
   "       ", Form, ",\n",
   "       acctrn.t_Numb_Document,\n",
   "       acctrn.t_AccountID_Payer,\n");
  if (not C_NOPD)
    query = query + GetParentEDocID() + ",\n";
  else
    query = query + "'',\n";
  end;
  query = query + string(
   "       TO_DATE (\n",
   "          TO_CHAR (acctrn.t_SystemDate, 'YYYYMMDD')\n",
   "          || TO_CHAR (acctrn.t_SystemTime, 'HH24MISS'),\n",
   "          'YYYYMMDDHH24MISS'),\n",
   "       'X',\n",
   "       decode(acctrn.t_shifr_oper, '03', 'X', '04', 'X', CHR(0)),\n",
   "       0,\n",
   "      acctrn.t_Account_Payer,\n"
   "      acctrn.t_FIID_Payer,\n"
   "      acctrn.t_Sum_Payer,\n"
   "      acctrn.t_Account_Receiver,\n"
   "      acctrn.t_FIID_Receiver,\n"
   "      acctrn.t_Sum_Receiver\n"
   "  FROM\n");
   if (not (C_NOPD and C_OTH and C_MO and C_BO))
     query = query + "dpmdocs_dbt pmdocs, dpmpaym_dbt pmpaym, ";
   end;
   query = query + string(
   "dacctrn_dbt acctrn, dobchaptr_dbt obchaptr\n",
   " WHERE acctrn.t_Date_Carry = ?\n");
  if (ED_ABED_LMA_FORMAT == uploadFormat)
    query = query + string(
   "       AND acctrn.t_Department = ", DepId, "\n");
  elif (ED_DEV_FORMAT == uploadFormat)
    query = query + string(
   "       AND acctrn.t_Department IN\n",
   "              (    SELECT includedDprt.t_code\n",
   "                     FROM ddp_dep_dbt includedDprt\n",
   "               CONNECT BY PRIOR includedDprt.t_code =\n",
   "                             includedDprt.t_parentCode\n",
   "                          AND includedDprt.t_eaStorageDir <> CHR (1)\n",
   "               START WITH includedDprt.t_code = 1)\n");
   pos = Index(additionalParm, "-ex_res:");
   if ((pos > 0) and (subStr(additionalParm, pos + 8) != ""))
     query = query + string("AND acctrn.t_Result_Carry NOT IN (",
         subStr(additionalParm, pos + 8), ")\n");
   end;
  end;
  if (C_NOPD and not C_OTH and not C_MO and not C_BO)
    query = query + string(
   "       AND NOT EXISTS (SELECT 1 FROM dpmdocs_dbt pmdocs WHERE\n",
   "                                pmdocs.t_AcctrnID = acctrn.t_AcctrnID)\n");
  else
   if (C_NOPD)
     tmp = "(+)";
   end;
   if (not (C_NOPD and C_OTH and C_MO and C_BO))
      query = query + string( 
     "       AND pmdocs.t_AcctrnID"+tmp+" = acctrn.t_AcctrnID\n",
     "       AND pmdocs.t_PaymentID = pmpaym.t_PaymentID"+tmp+"\n");
      if (C_OTH)
        if (C_BO and not C_MO)
          query = query + "AND pmpaym.t_DocKind"+tmp+" NOT IN (15, 70, 74)\n";
        elif (not C_BO and C_MO)
          query = query + "AND pmpaym.t_DocKind"+tmp+" <> 286\n";
        end;
      elif (C_BO and not C_MO)
        query = query + "AND pmpaym.t_DocKind"+tmp+" = 286\n";
      else
        query = query + "AND pmpaym.t_DocKind"+tmp+" IN (";
        if (C_BO)
          query = query + "286, ";
        end;
        query = query + "15, 70, 74)\n";
      end;
    end;
  end;
  query = query + string(
   "       AND acctrn.t_Chapter = obchaptr.t_Chapter\n",
   "       AND obchaptr.t_ExcludeFromFormalAcnt = CHR(0)\n",
   "       AND acctrn.t_State = 1\n");
//RunError(query + "\n" + reportDate);
  execSQL(query, makeArray(SQLParam("", reportDate)));
end;

/*Отбор данных для выгрузки проводок по уточняющим записям*/
macro SelectAcctrn(mode : Integer, reportDate : date, DepId : Integer, edKind : Integer, additionalParm : String, uploadFormat : Integer)
  var prm: string,
      Symb: string,
      Form: string;
  GetPaymentParams(edKind, @prm, @Symb, @Form);
  var query = string("INSERT INTO dedoc_tmp (t_DocDate,\n",
   "                    t_depNumber,\n",
   "                    t_eDocKindID,\n",
   "                    t_eDocID,\n",
   "                    t_vspNumber,\n",
   "                    t_formCode,\n",
   "                    t_DocNumber,\n",
   "                    t_AccountID,\n",
   "                    t_ParentEDocID,\n",
   "                    t_creationDateTime,\n",
   "                    t_IsAccTrn,\n",
   "                    t_IsCashDoc,\n",
   "                    t_CreateResult,\n",
   "                    t_CreditAccount,\n",
   "                    t_CreditFIID,\n",
   "                    t_CreditSum,\n",
   "                    t_DebetAccount,\n",
   "                    t_DebetFIID,\n",
   "                    t_DebetSum,\n",
   "                    t_NatCurDocSum)\n",
   "SELECT acctrn.t_Date_Carry,\n",
   "       acctrn.t_Department,\n",
   "       ", edKind, ",\n",
   "       RPAD (\n",
   "          SUBSTR (\n",
   "             NVL (rsb_common.getRegStrValue ('EA\\EXTEA\\SYSIDINEA'),\n",
   "                  '____'),\n",
   "             1,\n",
   "             4),\n",
   "          4,\n",
   "          '_')\n",
   "       || '", Symb, "'\n",
   "       || LPAD (TO_CHAR (acctrn.t_AcctrnID), 33, '0'),\n",
   "       acctrn.t_Branch,\n",
   "       ", Form, ",\n",
   "       acctrn.t_Numb_Document,\n",
   "       acctrn.t_AccountID_Payer,\n",
           GetParentEDocID(), ",\n",
   "       TO_DATE (\n",
   "          TO_CHAR (acctrn.t_SystemDate, 'YYYYMMDD')\n",
   "          || TO_CHAR (acctrn.t_SystemTime, 'HH24MISS'),\n",
   "          'YYYYMMDDHH24MISS'),\n",
   "       'X',\n",
   "       decode(acctrn.t_shifr_oper, '03', 'X', '04', 'X', CHR(0)),\n",
   "       0,\n",
   "       acctrn.t_Account_Receiver,\n",
   "       acctrn.t_FIID_Receiver,\n",
   "       acctrn.t_Sum_Receiver,\n",
   "       acctrn.t_Account_Payer,\n",
   "       acctrn.t_FIID_Payer,\n",
   "       acctrn.t_Sum_Payer,\n",
   "       acctrn.t_Sum_NatCur\n",
   "  FROM dpmdocs_dbt pmdocs, dacctrn_dbt acctrn, dpmpaym_dbt pmpaym\n",
   " WHERE acctrn.t_Date_Carry = ?\n");
  if (ED_ABED_LMA_FORMAT == uploadFormat)
    query = query + string(
   "       AND acctrn.t_Department = ", DepId, "\n");
  elif (ED_DEV_FORMAT == uploadFormat)
    query = query + string(
   "       AND acctrn.t_Department IN\n",
   "              (    SELECT includedDprt.t_code\n",
   "                     FROM ddp_dep_dbt includedDprt\n",
   "               CONNECT BY PRIOR includedDprt.t_code =\n",
   "                             includedDprt.t_parentCode\n",
   "                          AND includedDprt.t_eaStorageDir <> CHR (1)\n",
   "               START WITH includedDprt.t_code = 1)\n");
  end;
  query = query + string(
   "       AND pmdocs.t_AcctrnID = acctrn.t_AcctrnID\n",
   "       AND pmdocs.t_PaymentID = pmpaym.t_PaymentID\n",
   "       AND acctrn.t_State = 1\n",
   "       AND pmdocs.t_PmAddPIID <> 0\n");
//RunError(query + "\n" + reportDate);
  execSQL(query, makeArray(SQLParam("", reportDate)));
end;

/*Отбор данных для выгрузки платежей*/
macro SelectPayments(mode : Integer, reportDate : date, DepId : Integer, edKind : Integer, additionalParm : String, uploadFormat : Integer)
  var prm: string,
      Symb: string,
      Form: string;
  GetPaymentParams(edKind, @prm, @Symb, @Form);
  var query = string("INSERT INTO dedoc_tmp (t_DocDate,\n",
     "                     t_depNumber,\n",
     "                     t_eDocKindID,\n",
     "                     t_eDocID,\n",
     "                     t_vspNumber,\n",
     "                     t_formCode,\n",
     "                     t_DocNumber,\n",
     "                     t_ObjectType,\n",
     "                     t_ObjectID,\n",
     "                     t_AccountID,\n",
     "                     t_creationDateTime,\n",
     "                     t_IsAccTrn,\n",
     "                     t_IsCashDoc,\n",
     "                     t_CreateResult,\n",
     "                     t_CreditAccount,\n",
     "                     t_CreditFIID,\n",
     "                     t_CreditSum,\n",
     "                     t_DebetAccount,\n",
     "                     t_DebetFIID,\n",
     "                     t_DebetSum,\n",
     "                     t_NatCurDocSum)\n",
     " SELECT pmpaym.t_ValueDate,\n",
     "        ", DepId, ",\n",
     "        ", edKind, ",\n",
     "        RPAD (\n",
     "           SUBSTR (\n",
     "              NVL (rsb_common.getRegStrValue ('EA\\EXTEA\\SYSIDINEA'),\n",
     "                   '____'),\n",
     "              1,\n",
     "              4),\n",
     "           4,\n",
     "           '_')\n",
     "        || '", Symb, "'\n",
     "        || LPAD (TO_CHAR (pmpaym.t_PaymentID), 33, '0'),\n",
     "        pmpaym.t_OperNode,\n",
     "        ", Form, ",\n",
     "        pmrmprop.t_Number,\n",
     "        501,\n",
     "        LPAD (TO_CHAR (pmpaym.t_PaymentID), 34, '0'),\n",
     " (SELECT NVL (acnt.t_AccountID, 0)\n",
     "   FROM dacctrn_dbt acctrn\n",
     "         LEFT OUTER JOIN daccount_dbt acnt\n",
     "            ON acnt.t_AccountID = acctrn.t_AccountID_Payer\n",
     "   WHERE acctrn.t_AccTrnID =\n",
     "            (SELECT CASE\n",
     "                       WHEN pmpaym.t_DbFlag <> 'X'\n",
     "                       THEN\n",
     "                          MAX (t_AccTrnID)\n",
     "                       ELSE\n",
     "                          MIN (t_AccTrnID)\n",
     "                    END\n",
     "               FROM dpmdocs_dbt\n",
     "              WHERE dpmdocs_dbt.t_PaymentID = pmpaym.t_PaymentID)),\n",
     "        TO_DATE (\n",
     "           TO_CHAR (pmpaym.t_CreationDate, 'YYYYMMDD')\n",
     "           || TO_CHAR (pmpaym.t_CreationTime, 'HH24MISS'),\n",
     "           'YYYYMMDDHH24MISS'),\n",
     "        CHR(0),\n",
     IfThenElse(InList(edKind, 8, 9, 10, 21), "'X'", "decode(pmrmprop.t_shifroper, '03', 'X', '04', 'X', CHR(0))"),",\n",
     "        0,\n",
     " CASE\n",
     "    WHEN credit_pmaddpi.t_PmADDPiID IS NULL\n",
     "    THEN\n",
     "      acctrn.t_Account_Receiver\n",     
     "    ELSE\n",
     "       CHR (1)\n",
     " END,\n",
     " CASE\n",
     "    WHEN credit_pmaddpi.t_PmADDPiID IS NULL\n",
     "    THEN\n",
     "       acctrn.t_FIID_Receiver\n",
     "    ELSE\n",
     "       -1\n",
     " END,\n",
     " CASE\n",
     "    WHEN credit_pmaddpi.t_PmADDPiID IS NULL\n",
     "    THEN\n",
     "       acctrn.t_Sum_Receiver\n",
     "    ELSE\n",
     "       sums.t_Sum_Receiver\n",
     " END,\n",
     "  CASE\n",
     "    WHEN debit_pmaddpi.t_PmADDPiID IS NULL\n",
     "    THEN\n",
     "       acctrn.t_Account_Payer\n",
     "    ELSE\n",
     "       CHR (1)\n",
     " END,\n",
     " CASE\n",
     "    WHEN debit_pmaddpi.t_PmADDPiID IS NULL THEN acctrn.t_FIID_Payer\n",
     "    ELSE -1\n",
     " END,\n",
     " CASE\n",
     "    WHEN debit_pmaddpi.t_PmADDPiID IS NULL THEN acctrn.t_Sum_Payer\n",
     "    ELSE sums.t_Sum_Payer\n",
     " END,\n",
     " CASE\n",
     "    WHEN    credit_pmaddpi.t_pmaddpiid IS NOT NULL\n",
     "         OR debit_pmaddpi.t_pmaddpiid IS NOT NULL\n",
     "    THEN\n",
     "       sums.t_Sum_NatCur\n",
     "    ELSE\n",
     "       acctrn.t_Sum_NatCur\n",
     " END\n",
     "   FROM dpmpaym_dbt pmpaym,\n",
     "        dpmrmprop_dbt pmrmprop,\n",
     "        daccount_dbt acnt,\n",
     "        dpmdocs_dbt pmd,\n",
     "        dacctrn_dbt acctrn,\n",
     "        (    SELECT includedDprt.t_code\n",
     "               FROM ddp_dep_dbt includedDprt\n",
     "         CONNECT BY PRIOR includedDprt.t_code =\n",
     "                       includedDprt.t_parentCode\n",
     "                    AND includedDprt.t_eaStorageDir <> CHR (1)\n",
     "         START WITH includedDprt.t_code = ", DepId, ") incDprt\n,",
     " dpmaddpi_dbt  debit_pmaddpi\n,",
     " dpmaddpi_dbt  credit_pmaddpi\n,",
     " (  SELECT pmdocs.t_PaymentID t_PaymentID,\n",
     "           SUM (\n",
     "              CASE\n",
     "                 WHEN debit_pmaddpi.t_pmaddpiid IS NOT NULL\n",
     "                 THEN\n",
     "                    acctrn.t_Sum_Payer\n",
     "                 ELSE\n",
     "                    0\n",
     "              END)\n",
     "              t_Sum_Payer,\n",
     "           SUM (\n",
     "              CASE\n",
     "                 WHEN credit_pmaddpi.t_pmaddpiid IS NOT NULL\n",
     "                 THEN\n",
     "                    acctrn.t_Sum_Receiver\n",
     "                 ELSE\n",
     "                    0\n",
     "              END)\n",
     "              t_Sum_Receiver,\n",
     "           SUM (\n",
     "              CASE\n",
     "                 WHEN    credit_pmaddpi.t_pmaddpiid IS NOT NULL\n",
     "                      OR debit_pmaddpi.t_pmaddpiid IS NOT NULL\n",
     "                 THEN\n",
     "                    acctrn.t_Sum_NatCur\n",
     "                 ELSE\n",
     "                    0\n",
     "              END)\n",
     "              t_Sum_NatCur\n",
     "      FROM dacctrn_dbt acctrn\n",
     "           INNER JOIN dpmdocs_dbt pmdocs\n",
     "              ON acctrn.t_AccTrnID = pmdocs.t_AccTrnID\n",
     "           LEFT OUTER JOIN dpmaddpi_dbt debit_pmaddpi\n",
     "              ON     debit_pmaddpi.t_PmADDPiID = pmdocs.t_PmADDPIID\n",
     "                  AND debit_pmaddpi.t_DebetCredit = 0\n",
     "           LEFT OUTER JOIN dpmaddpi_dbt credit_pmaddpi\n",
     "              ON     credit_pmaddpi.t_PmADDPiID = pmdocs.t_PmADDPIID\n",
     "                 AND credit_pmaddpi.t_DebetCredit = 1\n",
     "  GROUP BY pmdocs.t_PaymentID) sums\n",
     "  WHERE pmpaym.t_ValueDate = ?\n");
  if (ED_ABED_LMA_FORMAT == uploadFormat)
    query = query + string(
     "        AND (pmpaym.t_StartDepartment = ", DepId, "\n",
     "             OR pmpaym.t_EndDepartment = ", DepId, "\n");
  elif (ED_DEV_FORMAT == uploadFormat)
    query = query + string(
     "        AND (pmpaym.t_StartDepartment IN incDprt.t_Code\n",
     "             OR pmpaym.t_EndDepartment IN incDprt.t_Code)\n");
  end;
  query = query + string( prm,
     "        AND pmpaym.t_PaymStatus = 32000                   /*PM_FINISHED*/\n",
     "        AND pmpaym.t_PaymentID = pmrmprop.t_PaymentID\n",
     "        AND acnt.t_Account(+) = pmpaym.t_PayerAccount\n",
     "        AND acnt.t_Chapter(+) = pmpaym.t_Chapter\n",
     "        AND acnt.t_Code_Currency(+) = pmpaym.t_FIID\n",
     "        AND pmd.t_PaymentID = pmpaym.t_PaymentID\n",
     "        AND acctrn.t_AccTrnID = pmd.t_AccTrnID\n",
     "        AND pmd.t_acctrnID =\n",
     "             (SELECT CASE\n",
     "                        WHEN pmpaym.t_DbFlag <> 'X'\n",
     "                        THEN\n",
     "                           MAX (t_AccTrnID)\n",
     "                        ELSE\n",
     "                           MIN (t_AccTrnID)\n",
     "                        END\n",
     "               FROM dpmdocs_dbt\n",
     "               WHERE t_PaymentID = pmpaym.t_PaymentID)\n",
     "        AND debit_pmaddpi.t_PmADDPiID(+) = pmd.t_PmADDPIID\n",
     "        AND debit_pmaddpi.t_DebetCredit(+) = 0\n",
     "        AND credit_pmaddpi.t_PmADDPiID(+) = pmd.t_PmADDPIID\n",
     "        AND credit_pmaddpi.t_DebetCredit(+) = 1\n",
     "        AND sums.t_PaymentID = pmpaym.t_PaymentID\n"
     );
  //RunError(query + "\n" + reportDate);
  execSQL(query, makeArray(SQLParam("", reportDate)));
  //var p = execSQLselect("select t_eDocID from dedoc_tmp");
  //p.MoveNext();
end;

/*Отбор данных для выгрузки исправительной выписки по лицевому счету*/
macro SelectStorn(mode : Integer, reportDate : date, DepId : Integer, edKind : Integer, additionalParm : String, uploadFormat : Integer, First: Bool)
  var prm: string,
      Symb: string,
      Form: string;
  GetPaymentParams(edKind, @prm, @Symb, @Form);
  if (First)
    Symb = "ИК";
  else
    Symb = "ИД";
  end;
  var query = string("INSERT INTO dedoc_tmp (t_DocDate,\n",
     "                     t_depNumber,\n",
     "                     t_eDocKindID,\n",
     "                     t_eDocID,\n",
     "                     t_vspNumber,\n",
     "                     t_formCode,\n",
     "                     t_DocNumber,\n",
     "                     t_ObjectType,\n",
     "                     t_ObjectID,\n",
     "                     t_AccountID,\n",
     "                     t_ParentEDocID,\n",
     "                     t_creationDateTime,\n",
     "                     t_IsAccTrn,\n",
     "                     t_IsCashDoc,\n",
     "                     t_CreateResult)\n",/*
     "                     t_CreditAccount,\n",
     "                     t_CreditFIID,\n",
     "                     t_CreditSum,\n",
     "                     t_DebetAccount,\n",
     "                     t_DebetFIID,\n",
     "                     t_DebetSum,\n",
     "                     t_NatCurDocSum)\n",*/
     " SELECT pmpaym.t_ValueDate,\n",
     "        ", DepId, ",\n",
     "        ", edKind, ",\n",
     "        RPAD (\n",
     "           SUBSTR (\n",
     "              NVL (rsb_common.getRegStrValue ('EA\\EXTEA\\SYSIDINEA'),\n",
     "                   '____'),\n",
     "              1,\n",
     "              4),\n",
     "           4,\n",
     "           '_')\n",
     "        || '", Symb, "'\n",
     "        || LPAD (TO_CHAR (pmpaym.t_PaymentID), 33, '0'),\n",
     "        pmpaym.t_OperNode,\n",
     "        ", Form, ",\n",
     "        pmrmprop.t_Number,\n",
     "        501,\n",
     "        LPAD (TO_CHAR (pmpaym.t_PaymentID), 34, '0'),\n",
     "        NVL(acnt.t_AccountID, 0),\n",
     "        RPAD (\n",
     "           SUBSTR (\n",
     "              NVL (rsb_common.getRegStrValue ('EA\\EXTEA\\SYSIDINEA'),\n",
     "                   '____'),\n",
     "              1,\n",
     "              4),\n",
     "           4,\n",
     "           '_')\n",
     "        || 'П1'\n",
     "        || LPAD (TO_CHAR (accispr.t_AcctrnID), 33, '0'),\n",
     "        TO_DATE (\n",
     "           TO_CHAR (pmpaym.t_CreationDate, 'YYYYMMDD')\n",
     "           || TO_CHAR (pmpaym.t_CreationTime, 'HH24MISS'),\n",
     "           'YYYYMMDDHH24MISS'),\n",
     "        CHR(0),\n",
     "        CHR(0),\n",
     "        0\n",/*
     "        DECODE(pmpaym.t_DbFlag, 'X', acctrn_max.t_Account_Payer, acctrn_min.t_Account_Payer),\n",
     "        DECODE(pmpaym.t_DbFlag, 'X', acctrn_max.t_Code_Currency, acctrn_min.t_Code_Currency),\n",
     "        DECODE(pmpaym.t_DbFlag, 'X', acctrn_max.t_Sum, acctrn_min.t_Sum),\n",
     "        DECODE(pmpaym.t_DbFlag, chr(0), acctrn_max.t_Account_Receiver, acctrn_min.t_Account_Receiver),\n",
     "        DECODE(pmpaym.t_DbFlag, chr(0), acctrn_max.t_Code_Currency, acctrn_min.t_Code_Currency),\n",
     "        DECODE(pmpaym.t_DbFlag, chr(0), acctrn_max.t_Sum, acctrn_min.t_Sum),\n",
     "        DECODE(pmpaym.t_DbFlag, 'X', acctrn_max.t_Sum, acctrn_min.t_Sum)\n",*/
     "   FROM dpmpaym_dbt pmpaym,\n",
     "        dpmrmprop_dbt pmrmprop,\n",
     "        dcb_doc_dbt cb_doc,\n",
     "        daccispr_dbt accispr,\n",
     "        daccount_dbt acnt,\n",
     "        (    SELECT includedDprt.t_code\n",
     "               FROM ddp_dep_dbt includedDprt\n",
     "         CONNECT BY PRIOR includedDprt.t_code =\n",
     "                       includedDprt.t_parentCode\n",
     "                    AND includedDprt.t_eaStorageDir <> CHR (1)\n",
     "         START WITH includedDprt.t_code = ", DepId, ") incDprt\n",
     "  WHERE pmpaym.t_ValueDate = ?\n");
  if (ED_ABED_LMA_FORMAT == uploadFormat)
    query = query + string(
     "        AND (pmpaym.t_StartDepartment = ", DepId, "\n",
     "             OR pmpaym.t_EndDepartment = ", DepId, ")\n");
  elif (ED_DEV_FORMAT == uploadFormat)
    query = query + string(
     "        AND (pmpaym.t_StartDepartment IN incDprt.t_Code\n",
     "             OR pmpaym.t_EndDepartment IN incDprt.t_Code)\n");
  end;
  query = query + string( prm,
     "        AND pmpaym.t_PaymStatus = 32000                   /*PM_FINISHED*/\n",
     "        AND pmpaym.t_PaymentID = pmrmprop.t_PaymentID\n",
     "        AND cb_doc.t_DocumentID(+) = pmpaym.t_PaymentID\n",
     "        AND ( (pmpaym.t_PrimDocKind = 286\n",
     "               AND pmpaym.t_TypeDocument LIKE '%S%')\n",
     "             OR cb_doc.t_TypeDocument LIKE '%S%')\n",
     "        AND accispr.t_DocumentID = LPAD(pmpaym.t_PaymentID, '0', 34)\n",
     "        AND accispr.t_DocKind = pmpaym.t_DocKind\n",
     "        AND acnt.t_Chapter(+) = pmpaym.t_Chapter\n");
  if (First)
    query = query + string( 
     "        AND acnt.t_Account(+) = pmpaym.t_PayerAccount\n",
     "        AND acnt.t_Code_Currency(+) = pmpaym.t_FIID\n");
  else
    query = query + string( 
     "        AND acnt.t_Account(+) = pmpaym.t_ReceiverAccount\n",
     "        AND acnt.t_Code_Currency(+) = pmpaym.t_PayFIID\n");
  end;
  //RunError(query + "\n" + reportDate);
  execSQL(query, makeArray(SQLParam("", reportDate)));
end;

/**
 * Формирование списка выгружаемых документов, кроме ведомости остатков
 * <Режим запуска> - первичная/повторная выгрузка
 * <Дата> - дата, за которую отбираются проводки
 * <Филиал> - идентификатор (dp_dep.Code) филиала, чьи проводки отбираются
 * <Вид ЭД> - вид ЭД
 * <Строка параметров> - пользовательская строка параметров
 * <Формат выгрузки> - АБЭД ЛМА/печатные формы ДЭВ
 * @return 0-успех, !0 - номер ошибки
 */
macro FillDocList(mode : Integer, reportDate : date, DepId : Integer, edKind : Integer, additionalParm : String, uploadFormat : Integer) : Integer
  var err = 0;
  if (edKind == 7)
    if (uploadFormat == ED_DEV_FORMAT)
      if (GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_MO", true) or 
          GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_BO", false) or 
          GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_OTH", false) or 
          GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_CARRY_NOPD", true))
        SelectMemord(mode, reportDate, DepId, edKind, additionalParm, uploadFormat);
      elif (GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_MO", false) or 
            GetBool("EA\\EXTEA\\ВЫГРУЗКА_ЭД\\MEMORDER\\INCL_ED111", false))
          SelectPayments(mode, reportDate, DepId, edKind, additionalParm, uploadFormat);
      end;
    else
      SelectMemord(mode, reportDate, DepId, edKind, additionalParm, uploadFormat);
    end;
  elif (edKind == 19)
    SelectStorn(mode, reportDate, DepId, edKind, additionalParm, uploadFormat, true);
    SelectStorn(mode, reportDate, DepId, edKind, additionalParm, uploadFormat, false);
  elif (uploadFormat == ED_DEV_FORMAT)
    if (edKind == 22)
      SelectAcctrn(mode, reportDate, DepId, edKind, additionalParm, uploadFormat);
    else
      SelectPayments(mode, reportDate, DepId, edKind, additionalParm, uploadFormat);
    end;
  end;
end;

/**
 * Установить/восстановить статус-строку
 */
private class EAMOStatusLine( str:string )
  message( str );
  macro destructor()
    message( "" );
  end;
end;

macro FillDocData(mode : Integer, edKind : Integer, additionalParm : String, uploadFormat : Integer) : Integer
  var stat:integer = 0;
  if (uploadFormat == ED_DEV_FORMAT)
    var ff = 0;
    var i = index(additionalParm, "-outff:");
    if (i > 0)
      if (StrUpr(substr(additionalParm, i + 7)) == "XLS")
        ff = 2;
      end;
    end;
    var q = execSQLselect("select t_eDocID from dedoc_tmp where t_EDocKindID = ?", makeArray(SQLParam("", edKind)));
    while (q.MoveNext())
      stat = PrintEA(true, edKind, q.value(0), ff, "Э");
      if (stat != 0)
        execSQL("UPDATE dedoc_tmp SET t_CreateResult = ? where t_EDocID = ? and t_EDocKindID = ?",
            makeArray(SQLParam("", int(stat)), SQLParam("", q.value(0)), SQLParam("", edKind)));
      else
        var tff = "txt";
        if (ff == 2) tff = "xls"; end;
        execSQL("UPDATE dedoc_tmp SET t_FileFormat = ?, t_CreateResult = 0 where t_EDocID = ? and t_EDocKindID = ?",
            makeArray(SQLParam("", tff), SQLParam("", q.value(0)), SQLParam("", edKind)));
      end;
    end;
  else
    var statline:EAMOStatusLine = EAMOStatusLine( "Формирование XML-данных мемориальных ордеров ..." );
    stat = execStoredFunc( "PMEA_MEMORDER.FillMemorderData", V_INTEGER );
    statline = NULL;
    return stat;
  end;
end;