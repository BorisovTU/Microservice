/*
$Name:         ObjParty.mac
$Module:       Главная книга
$Description:  
*/

Import CTInter, PTInter, oralib, globals;

var PartyObj;


PRIVATE MACRO GetPtKindList()

  var arr = TArray;
  var query:string =  "select T_NAME2 from dptkind_dbt ";

                              
  var rs:RsdRecordset = execSQLselect( query, null, true );
  var i = 0;

  while( rs and rs.moveNext() )
    arr[i] = string( rs.value(0) );
    i = i+1;
  end;

  return arr;
END;

PRIVATE MACRO GetServKindList()

  var arr = TArray;
  var query:string =  "select T_NAME from dservkind_dbt ";

                              
  var rs:RsdRecordset = execSQLselect( query, null, true );
  var i = 0;

  while( rs and rs.moveNext() )
    arr[i] = string( rs.value(0) );
    i = i+1;
  end;

  return arr;
END;

PRIVATE MACRO GetPtKindNyName(Name)

  var retID = 0;
  var query:string =  "select T_PARTYKIND from dptkind_dbt WHERE T_NAME2 = '" +Name+"'";

  var rs:RsdRecordset = execSQLselect( query, null, true );

  if( rs and rs.moveNext() )
    retID = ( rs.value(0) );
  end;

  return retID;
END;

PRIVATE MACRO GetServKindNyName(Name)

  var retID = 0;
  var query:string =  "select T_SERVISEKIND from dservkind_dbt WHERE T_NAME = '" +Name+"'";

  var rs:RsdRecordset = execSQLselect( query, null, true );

  if( rs and rs.moveNext() )
    retID = ( rs.value(0) );
  end;

  return retID;
END;



private class(ObjectFieldUse) PartyFieldUse(ObjType)
  InitObjectFieldUse(ObjType);

    macro checkConditionObject ( Code, Operator, strValue)
      var ret = true;
   /*
   1 Если Code = "СЭФорма":
   1.1 Если Value = "Юридическое лицо", то:
   1.1.1 Если Operator = '=', то условие верно для объекта, если party.LegalForm=1. 
   1.1.2 Если Operator = '!', то условие верно для объекта, если party.LegalForm!=1. 
   1.2 Если Value = "Физическое лицо", то:
   1.2.1 Если Operator = '=', то условие верно для объекта, если party.LegalForm=2. 
   1.2.2 Если Operator = '!', то условие верно для объекта, если party.LegalForm!=2. 
   1.3 Если условие не верно - возвращаем FALSE. Если условие выполнилось - TRUE.
   */
      if(Code == "СЭФорма")
        if(StrUpr(strValue) == "ЮРИДИЧЕСКОЕ ЛИЦО")
          if(Operator == "=")
            if(PartyObj.LegalForm == 1)
              ret = true;
            else
              ret = false;
            end;
          elif(Operator == "!")
            if(PartyObj.LegalForm != 1)
              ret = true;
            else
              ret = false;
            end;
          end;
        elif(StrUpr(strValue) == "ФИЗИЧЕСКОЕ ЛИЦО")
          if(Operator == "=")
            if(PartyObj.LegalForm == 2)
              ret = true;
            else
              ret = false;
            end;
          elif(Operator == "!")
            if(PartyObj.LegalForm != 2)
              ret = true;
            else
              ret = false;
            end;
          end;
        end;
      end;


   /*
   2 Если Code = "CЭПредпр":
   2.1 Если Value = "Да", то:
   2.1.1 Если Operator = '=', то условие верно для объекта, если persn.isEmployer='Х'. 
   2.1.2 Если Operator = '!', то условие верно для объекта, если persn.LegalForm!='Х'. 
   2.2 Если Value = "Нет", то:
   2.2.1 Если Operator = '=', то условие верно для объекта, если persn.isEmployer=chr(0). 
   2.2.2 Если Operator = '!', то условие верно для объекта, если persn.LegalForm!=chr(0). 
   2.3 Если условие не верно - возвращаем FALSE. Если условие выполнилось - TRUE.
   */

      
      if(Code == "CЭПредпр")
        if(StrUpr(strValue) == "ДА")
          if(Operator == "=")
            if((PartyObj.LegalForm == 2) AND (PartyObj.IsEmployer == true))
              ret = true;
            else
              ret = false;
            end;
          elif(Operator == "!")
            if((PartyObj.LegalForm != 2) OR (PartyObj.IsEmployer == false))
              ret = true;
            else
              ret = false;
            end;
          end;
        elif(StrUpr(strValue) == "НЕТ")
          if(Operator == "=")
            if((PartyObj.LegalForm != 2) OR (PartyObj.IsEmployer == false))
              ret = true;
            else
              ret = false;
            end;
          elif(Operator == "!")
            if((PartyObj.LegalForm == 2) AND (PartyObj.IsEmployer == true))
              ret = true;
            else
              ret = false;
            end;
          end;
        end;
      end;

   /*
   3 Если Code = "CЭНеРезидент":
   3.1 Если Value = "Да", то:
   3.1.1 Если Operator = '=', то условие верно для объекта, если party.notResident='Х'. 
   3.1.2 Если Operator = '!', то условие верно для объекта, если party.notResident!='Х'. 
   3.2 Если Value = "Нет", то:
   3.2.1 Если Operator = '=', то условие верно для объекта, если party.notResident =chr(0). 
   3.2.2 Если Operator = '!', то условие верно для объекта, если party.notResident!=chr(0). 
   3.3 Если условие не верно - возвращаем FALSE. Если условие выполнилось - TRUE.
   */

      if(Code == "CЭНеРезидент")
        if(StrUpr(strValue) == "ДА")
          if(Operator == "=")
            if(PartyObj.IsNotResident == true)
              ret = true;
            else
              ret = false;
            end;
          elif(Operator == "!")
            if(PartyObj.IsNotResident == false)
              ret = true;
            else
              ret = false;
            end;
          end;
        elif(StrUpr(strValue) == "НЕТ")
          if(Operator == "=")
            if(PartyObj.IsNotResident == false)
              ret = true;
            else
              ret = false;
            end;
          elif(Operator == "!")
            if(PartyObj.IsNotResident == true)
              ret = true;
            else
              ret = false;
            end;
          end;
        end;
      end;

   /*
   4 Если Code = "CЭРоль":
   4.1 Определяем ID роли ptkind.PartyKind по ее наименованию ptkind.Name2=Value.
   4.2 Если Operator = '=', то условие верно, если у субъекта есть данная роль - проверяем по записям partyown[]. 
   4.3 Если Operator = '!', то условие верно, если у субъекта отсутствует данная роль - проверяем по записям partyown[].  
   4.4 Если условие не выполнилось, то возвращаем FALSE. Если выполнилось - TRUE.
   */
      var PartyKind = 0;
      if(Code == "СЭРоль")
        PartyKind = GetPtKindNyName(strValue);

        if(Operator == "=")
          if(PartyObj.IsOwned(PartyKind) == true)
            ret = true;
          else
            ret = false;
          end;
        elif(Operator == "!")
          if(PartyObj.IsOwned(PartyKind) == false)
            ret = true;
          else
            ret = false;
          end;
        end;
      end;

   /*
   5 Если Code = "СЭОбслуживание":
   5.1 Определяем ID роли servkind.ServiceKind по ее наименованию servkind.Name=Value.
   5.2 Если Operator = '=', то условие верно, если у субъекта есть данный вид обслуживания в текущем филиале на текущий опердень - проверяем по записям client[]. Т.е. ищем запись, у которой ServiceKind = servkind.ServiceKind и Department = <Текущий филиал> и StartDate < <Текущий опердень> < FinishDate.
   5.3 Если Operator = '!', то условие верно, если у субъекта отсутствует данный вид обслуживания в текущем филиале на текущий опердень.  
   5.4 Если условие не выполнилось, то возвращаем FALSE. Если выполнилось - TRUE.
   */

      var ServKind = 0;
      if(Code == "СЭОбслуживание")
        ServKind = GetServKindNyName(strValue);

        if(Operator == "=")
          if(PT_CheckClientService(PartyObj.PartyID, ServKind, {curdate}, {operdprt} ) == true)
            ret = true;
          else
            ret = false;
          end;
        elif(Operator == "!")
          if(PartyObj.IsOwned(PartyKind) == false)
            ret = true;
          else
            ret = false;
          end;
        end;
      end;


      return ret;
    end;


end; /* end of class PartyFieldUse */

private var FltrPartyObj;


macro Init(ObjectType)

 var arrOpr = TArray;
 FltrPartyObj = PartyFieldUse(ObjectType);


  
 arrOpr = TArray;
 arrOpr[0] = "Юридическое лицо";
 arrOpr[1] = "Физическое лицо" ;

 FltrPartyObj.addCondition( "Форма субъекта экономики" , 
                            "СЭФорма",
                            V_STRING,
                            "=!",
                            UFF_METHOD_INPUT_LIST,
                            arrOpr,
                            NULL
 );

 arrOpr = TArray;
 arrOpr[0] = "Да" ;
 arrOpr[1] = "Нет";

 FltrPartyObj.addCondition( "Предприниматель" , 
                            "CЭПредпр",
                            V_STRING,
                            "=!",
                            UFF_METHOD_INPUT_LIST,
                            arrOpr,
                            NULL
 );


 arrOpr = TArray;
 arrOpr[0] = "Да" ;
 arrOpr[1] = "Нет";

 FltrPartyObj.addCondition( "Нерезидент" , 
                            "CЭНеРезидент",
                            V_STRING,
                            "=!",
                            UFF_METHOD_INPUT_LIST,
                            arrOpr,
                            NULL
 );



 arrOpr = GetPtKindList();


 FltrPartyObj.addCondition( "Роль" , 
                            "СЭРоль",
                            V_STRING,
                            "=!",
                            UFF_METHOD_INPUT_LIST,
                            arrOpr,
                            NULL
 );
 
 arrOpr = GetServKindList();

 FltrPartyObj.addCondition( "Вид обслуживания" , 
                            "СЭОбслуживание",
                            V_STRING,
                            "=!",
                            UFF_METHOD_INPUT_LIST,
                            arrOpr,
                            NULL
 );
 



 return FltrPartyObj;
end; 

macro PropExist(obj/* , ... string */) : bool
  var parm:variant, i:integer = 1, sub = obj, ret = obj != null;  
  while( ret AND GetParm(i, parm)  )    
    if( (valtype(parm) == V_STRING) AND (GenPropID(sub, parm) != -1) )
      sub = GenGetProp(sub, parm);
      ret = true;
    else
      ret = false;
    end;    
    i = i + 1;
  end;
  return ret;
end;

// ObjData - TWsPartyInfo
macro InitObject(ObjData) 

  if(PropExist(ObjData, "Party", "PartyId") )
    
    PartyObj = RsbParty(ObjData.Party.PartyId);
    
    if(PropExist(ObjData, "Party", "legalform") )
       PartyObj.legalform = ObjData.Party.legalform;
    end;
    if(PropExist(objData, "Party", "IsNotResident") )
       PartyObj.IsNotResident = (ObjData.Party.NotResident == "X");
    end;
    if(PropExist(ObjData, "Persn", "IsEmployer") )
       PartyObj.IsEmployer = (ObjData.Persn.IsEmployer == "X");
    end;
  end;
  
end;