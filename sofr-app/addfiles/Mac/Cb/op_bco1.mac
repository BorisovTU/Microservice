/* 
 *  Операция 203 "Требование-поручение банка".
 *  Макрос шага 1 "Проводка".
 */

import InsCarryDoc;    //InsertPaymentStat
import PaymInter;      //PaymOutChangeDPP
import "paym_rec.mac";
//import "pmoutcom.mac"; //ExecuteSingCommission

MACRO ExecuteStep( doc, primdoc, DocKind, ID_Operation )

  var PaySumPaym:moneyl, PaySumDoc:moneyl,
         SumPaym:moneyl,    SumDoc:moneyl;

  record order("memorder.dbt", "bank.def");
  record d    ("arhdoc.dbt", "bank.def");

  SetBuff(order, primdoc);
  SetBuff(d,     doc);

  /* Проверяем ДПП платежа */
  if( (Pm_debet.PaymentID == Pm_paym.PaymentID) and (Pm_debet.Group == PAYMENTS_GROUP_EXTERNAL) )
    if( not PaymOutChangeDPP(Pm_paym, Pm_debet, NULL, 0 ) )
      return 1;
    end;
  else /* Внутренний платеж после проводки закрываем */
    if( not InsertPaymentStat( 0, PM_FINISHED, PMMET_DPS, 0, 0, Pm_paym.Purpose, Pm_paym.SubPurpose ) )
      MsgBox("Ошибка при вставке статуса платежа");
      return 1;
    end;
  end;

  /* Возможно, с платежа берутся комиссии */
  /* Раз пока проводок нет, не надо и суммы рассчитывать
  if( ExecuteSingCommission( ID_Operation, NULL, DocKind, Pm_paym, Pm_debet, OUR, BEN,
                             PaySumPaym, PaySumDoc, SumPaym, SumDoc ) )
    return 1;
  end;
  */
  
  /* Проводки и т.п. */

  /* Пока не реализовано */
  
  return 0;

END;
