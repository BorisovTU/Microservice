 /*
 $Name: addpdoc.mac
 $Module: Ядро ГКБО
 $Description: Макрос формирования документа начисления процентов
 */
/* -@H------------------------------------------------------------------
*            Автоматизированная банковская система RS-Bank
*                 Библиотека интерпретируемых модулей
*                  Copyright (c) JV R-Style 1993-96
*
*   File Name        : addpdoc.mac
*
*   Description      : Макрос формирования документа начисления процентов
*
*   Respons.         : Стасевич В.
*
*   History          : Создан : 26.11.98
*   Михайлов С., 16.11.2000: теперь отсутствие категорий плательщика
*       и получателя не считается ошибкой
*
*----------------------------------------------------------------------*/
IMPORT BankInter, globals;

Record Документ( arhdoc );
record pcaddhis( pcaddhis );

FILE pcacc( pcacc );
FILE pcacnt( pcacnt );
FILE pcrestc( pcrestc );
FILE pccalc( pccalc ) key 1;
FILE pcpaygrh( pcpaygrh ) key 1;
FILE pcadd( pcaddhis ) key 2;

/* Константы */
VAR СтрокаОшибки = "";

private const ID_РЕФЕРЕНСА_ДОКУМЕНТОВ_ОПЛАТЫ_ПРОЦЕНТОВ = 125;

/*------------------------------------------------------------------------
  Процедура получения номера лицевого по номеру категории учета
--------------------------------------------------------------------------*/
MACRO НайтиСчетПоКатегории( НомерКатегории )
  pcacnt.AutoPerc = pcaddhis.AutoPerc;
  pcacnt.AcntCode = НомерКатегории;

  if(( GetGE( pcacnt ) )                      and
     ( pcacnt.AutoPerc == pcaddhis.AutoPerc ) and
     ( pcacnt.AcntCode == НомерКатегории    )     )
    return pcacnt.Account;
  else
    СтрокаОшибки = string("Не найдена запись по счету для категории учета:",НомерКатегории);
    return "";
  end;
END;

macro СравнитьДатыПериодов( ДатаОплаты, ДатаОкончанияНачисления )

   if( pcacc.FormAddByPay == 0 )
      return ДатаОплаты <= ДатаОкончанияНачисления;
   else
      return ДатаОплаты < ДатаОкончанияНачисления;
   end;
end;

/*------------------------------------------------------------------------
     Определить сумму
--------------------------------------------------------------------------*/
MACRO ОпределитьСумму( Сумма )
 VAR Сумма1 = $0, Сумма2 = $0, Дата1, Дата2, Дата, контр;

 /* ----------- Определение первой суммы -------------------- */
   pcpaygrh.AutoPerc = pcacc.AutoKey;
   pcpaygrh.PayDate  = pcaddhis.EndDate;

   if( getLE( pcpaygrh ) and
       ( pcpaygrh.AutoPerc == pcacc.AutoKey ) and
       СравнитьДатыПериодов( pcpaygrh.PayDate, pcaddhis.EndDate ) )

      Дата1 = pcpaygrh.EndDate;
   else
      Дата1 = pcacc.beginDate - 1;
   end;

   Дата2 = pcaddhis.BeginDate - 1;

   if( Дата1 > Дата2 )
      Дата = Дата1 + 1;
   else
      Дата = Дата2 + 1;
   end;

/*       Определяем сумму рассчитанных процентов за период*/
   pccalc.AutoPerc = pcacc.AutoKey;
   pccalc.PayType  = 1;
   pccalc.CalcDate = Дата;

   контр = getGE( pccalc ) and
           ( pccalc.AutoPerc == pcacc.AutoKey ) and
           ( pccalc.PayType  == 1 ) and
           ( pccalc.CalcDate <= pcaddhis.EndDate );

   Сумма1 = $0;
   while( контр )
      Сумма1 = Сумма1 + pccalc.PercSum;

      контр = next( pccalc ) and
              ( pccalc.AutoPerc == pcacc.AutoKey ) and
              ( pccalc.PayType  == 1 ) and
              ( pccalc.CalcDate <= pcaddhis.EndDate );
   end;

/*      Определяем остаток по счету процентов за дату окончания периода*/
/*      начисления*/
   pcrestc.AutoPerc = pcacc.AutoKey;
   pcrestc.Date     = pcaddhis.EndDate;

   if( not getEQ(pcrestc) )
/*      MsgBox("Нет записи остатка по счету процентов на дату окончания начисления");*/
      return FALSE;
   else
      if( pcrestc.Rest > 0 )
         Сумма2 = pcrestc.Rest;
      else
         Сумма2 = $0;
      end;
   end;

   if( Сумма1 < Сумма2 )
      Сумма = Сумма1;
   else
      Сумма = Сумма2;
   end;

   SetParm( 0, Сумма );
   return TRUE;
END;

/*----------------------------------------------------------------
  Процедура формирования исходного документа начисления
------------------------------------------------------------------*/
MACRO СделатьДокументНачисления( ИсторияНачисления )
 VAR Сумма, Счет, stat;
        var НомерДокумента, НадежностьСубъекта, ДостаточностьСуммы;

   stat = TRUE;
   setbuff( pcaddhis, ИсторияНачисления );

   pcacc.AutoKey = pcaddhis.AutoPerc;
   getEQ( pcacc );

   if( not ОпределитьСумму( Сумма ) )
      return FALSE;
   end;

   /* Заполнение общих полей */

   Документ.Chapter = 1;
   Документ.Sum     = Сумма;
   Документ.Code_Currency = pcacc.FIID;

   Документ.iApplicationKind = 0;
   Документ.ApplicationKey   = "";

   Документ.Date_Carry    = pcaddhis.AddDate;

   Документ.Shifr_Oper = "01";
   Документ.Department = {OperDprt};
   Документ.Kind_Oper  = "1";
   Документ.Number_Pack = 993;
   Документ.Ground = string("Отражение начисленных процентов по счету ", pcacc.Account," за период с ",pcaddhis.BeginDate," по ",pcaddhis.EndDate );

   GenerateReference(ID_РЕФЕРЕНСА_ДОКУМЕНТОВ_ОПЛАТЫ_ПРОЦЕНТОВ, НомерДокумента);
   Документ.Numb_Document = НомерДокумента;

   Документ.CarryAcnt = pcacc.AutoKey;

   /* В зависимости от счета процентов - заполняем плательщика и получателя */

   /*
        if  (( Index( pcacc.UserType, НаВнебалансе  ) > 0 ) and (Index( pcacc.UserType, МетодНачислений ) <= 0))
     // Начисление на внебалансе

      Документ.AutoKey = 5;

      Документ.Account_Payer    = НайтиСчетПоКатегории( НомКатСчетНаВнебалансе );
      if( СтрокаОшибки != "" )
        stat = FALSE;
      end;

      Документ.Account_Receiver = НайтиСчетПоКатегории( НомКатСчетДляКорреспонденции );
      if( СтрокаОшибки != "" )
        stat = FALSE;
      end;

   elif( Index( pcacc.UserType, КассовыйМетод ) > 0 )
     // Отражение на балансе - Кассовый метод

     if  ( pcacc.RestKind == Пассив )
       Документ.AutoKey  = 2;

       Документ.Account_Payer    = НайтиСчетПоКатегории( НомКатСчетБудПериодов );

       if( СтрокаОшибки != "" )
         stat = FALSE;
       end;

       Документ.Account_Receiver = НайтиСчетПоКатегории( НомКатСчетТребованийОбязательств );

       if( СтрокаОшибки != "" )
         stat = FALSE;
       end;

     elif( pcacc.RestKind == Актив  )
       Документ.AutoKey  = 1;

       Документ.Account_Payer    = НайтиСчетПоКатегории( НомКатСчетТребованийОбязательств );

       if( СтрокаОшибки != "" )
         stat = FALSE;
       end;

       Документ.Account_Receiver = НайтиСчетПоКатегории( НомКатСчетБудПериодов );

       if( СтрокаОшибки != "" )
         stat = FALSE;
       end;

     end;

   elif( Index( pcacc.UserType, МетодНачислений ) > 0 )
     // Отражение на балансе - Метод начисления
                Документ.AutoKey  = 1;

     if  ( pcacc.RestKind == Пассив )


       if( (Счет = НайтиСчетПоКатегории( НомКатСчетПлательщик )) == "" )
          СтрокаОшибки = "";/**/
          Документ.Account_Payer    = pcacc.PayerAccount;
       else
          Документ.Account_Payer    = Счет;
       end;

       Документ.Account_Receiver = НайтиСчетПоКатегории(НомКатСчетНачисленныхПроцентов);

       if( СтрокаОшибки != "" )
        stat = FALSE;
       end;
     elif( pcacc.RestKind == Актив  )

        // определяем надежность субъекта
        if (NOT ОпределитьНадежностьСубъекта(pcacc.AutoKey, @НадежностьСубъекта, Документ.Date_Carry))
           СтрокаОшибки = "Ошибка определения надежности субъекта: " + ppLastError;
           return FALSE;
        end;

        // если субъект надежный
        if (НадежностьСубъекта == 1)
           if  ( Index( pcacc.UserType, НаВнебалансе  ) > 0 )
              MsgBox("Надо выполнить перенос с внебаланса.");
              return FALSE;
           end;

           Документ.Account_Payer = НайтиСчетПоКатегории(НомКатСчетНачисленныхПроцентов);

          if( СтрокаОшибки != "" )
             MsgBox(СтрокаОшибки);
             return FALSE;
          end;

          if( (Счет = НайтиСчетПоКатегории( НомКатСчетПолучатель )) == "" )
             Документ.Account_Receiver = pcacc.PercReceiverAccount;
             СтрокаОшибки = "";
          else
             Документ.Account_Receiver = Счет;
          end;
       else // если субъект проблемный
          if  ( Index( pcacc.UserType, НаВнебалансе  ) <= 0 )
             MsgBox("Надо выполнить перенос на внебаланс.");
             return FALSE;
          end;

          Документ.Chapter = 3;

          Документ.Account_Payer = НайтиСчетПоКатегории(НомКатСчетНеполученныхПроцентов);

          if( СтрокаОшибки != "" )
             MsgBox("Невозможно найти счет 'Неполученных процентов'.");
             return FALSE;
          end;

          if( (Счет = НайтиСчетПоКатегории(НомКатСчетДляКорреспонденции)) == "" )
             MsgBox("Невозможно найти счет 'Для корреспонденции'.");
             return FALSE;
          else
             Документ.Account_Receiver = Счет;
          end;
        end;
      end;
   elif (pcacc.UserType == "")
      msgbox("Не указан Пользовательский Тип для начисления процентов по счёту!")
   end;
   */

   if( СтрокаОшибки != "" )
    msgbox( СтрокаОшибки );
   end;

   return stat;

END;
