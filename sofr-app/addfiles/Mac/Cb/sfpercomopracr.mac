/**                                                                                                             
 @file sfpercomopracr.mac                                                                                           
 @brief ПЗО: Шаг "Начисление" операции по УПК вида 4603
                                                                                                                
 #tag                                                                                                          
 - functional_block:Ядро ГКБО                
 - functional_block:ПЗО                                                                                                                                          
 - code_type:API 
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2024.01.26 |Жиц М.В.       |BOSS-2118           |BIQ-14887. Корректировка описания проводки начисления/оплаты по инвест. советнику                                      
 |2024.01.16 |Жиц М.В.       |DEF-59858           |BIQ-14887. Код ЕКК не указан в проводке начисления\оплаты комиссии                                      
 |2023.12.12 |Жиц М.В.       |BIQ-14887           |Реализация обработки комиссии "ИнвестСоветник"                                      
 |?          |?              |?                   |Создание                                                                                                                                                                                                                                                            
*/ 

import "sfcommon.mac", "sfacctrnbatch.mac", "sfbatch_lib.mac", "sfdefopr.mac";
import "dv_categ.mac", "sfcomcat.mac";
import "role_model.mac";//ролевая модель

record SfSrvDocRec("sfsrvdoc.dbt");

class SfAccrueOpr
  var SfAccrue = TRecHandler("sfaccrue.dbt");
  var IsValid = true;
  var DefComIndex = 0;
end;

private macro ClearTmpTable(TableName)

  var  stat = 0;
  var strSql, cmd;

  if(stat == 0)  
    strSql = " DELETE FROM " + TableName; 
     
    cmd = RsdCommand( strSql );
    cmd.execute();   
  end;

  return stat;
end;

private macro SetOprStatusAfterExtraAccrue()

  var  stat = 0;
  var strSql, cmd;

  stat = ClearTmpTable( "doprstval_tmp");

  if( stat == 0 )
    stat = SfDefOprSetOprStatus_Bilf();
  end;

  if( stat == 0 )
    stat = SfDefOprSetOprStatus_Pay();
  end;

  if(stat == 0)
    strSql = " { CALL RSI_RsbOperation.procSetOprStatusValue() } ";
    cmd = RsdCommand( strSql );
    cmd.execute();
  end;

  return stat;
end;
       
macro SfDefCalcAccrueBatch()
  var stat = 0;
  var strSql, cmd;
  stat = ClearTmpTable( "dsfaccrue_tmp");
  if( stat == 0 )
    strSql =  "INSERT INTO dsfaccrue_tmp " +
              "            (t_sfdefcomid, t_begindate, t_enddate, t_transactiondate, " +
              "             t_amount, t_ndsamount, t_isfinal, t_sfdefbegin, t_sfdefend, " +
              "             t_isfreeperiod, t_finishfeedate, t_sfdeffiidsum, t_sfcontrfiid, " +
              "             t_payrateid, t_payratedatekind, t_payratepercent) " +
              "   SELECT sfdef.t_id, sfdef.t_dateperiodbegin, sfdef.t_dateperiodend, " +
              "          ?, " +
              "          sfdef.t_sum ";

     if(not SfComNotRecalcGetRegValue())              
        strSql = strSql +  
              "  - NVL((SELECT SUM (acr.t_amount) " +
              "          FROM dsfaccrue_dbt acr " +
              "         WHERE acr.t_sfdefcomid = sfdef.t_id), 0) ";
     end;
              
     strSql = strSql +  
              "        , sfdef.t_sumnds ";

     if(not SfComNotRecalcGetRegValue())              
      strSql = strSql +                      
              "   - NVL((SELECT SUM (acr.t_ndsamount) " +
              "            FROM dsfaccrue_dbt acr " +
              "           WHERE acr.t_sfdefcomid = sfdef.t_id), 0) " ;
     end;
   
     strSql = strSql +
              "        , DECODE (?, 1, CHR (0), 'X'), " +
              "          sfdef.t_dateperiodbegin, sfdef.t_dateperiodend,  sfcomiss.t_isfreeperiod," +
              "          RSI_RSB_SERVFEE.GetFinishFeeDate (?, " +
              "                                            sfcomiss.t_dateend, " +
              "                                            sfcontr.t_dateclose, " +
              "                                            concom.t_dateend " +
              "                                           ), " +
              "          sfdef.t_fiid_sum, " +
              " DECODE( sfcomiss.t_FIID_paySum, -1, sfdef.t_FIID_Sum, sfcomiss.t_FIID_paySum), " +
              "          sfcontr.t_payrateid, sfcontr.t_payratedatekind, " +
              "          sfcontr.t_payratepercent " +
              "     FROM dsfdef_dbt sfdef, " +
              "          doprtemp_tmp opr, " +
              "          dsfcomiss_dbt sfcomiss, " +
              "          dsfcontr_dbt sfcontr, " +
              "          dsfconcom_dbt concom " +
              "    WHERE sfdef.t_feetype = ? " +
              "      AND sfdef.t_id = TO_NUMBER (opr.t_documentid) " +
              "      AND sfcomiss.t_feetype = sfdef.t_feetype " +
              "      AND sfcomiss.t_number = sfdef.t_commnumber " +
              "      AND sfcontr.t_id = sfdef.t_sfcontrid " +
              "      AND concom.t_id = sfdef.t_concomid "; 

    if(SfComNotRecalcGetRegValue())
      strSql = strSql  + " AND NOT EXISTS (SELECT 1 FROM dsfaccrue_dbt acr WHERE acr.t_sfdefcomid = sfdef.t_id) "; 
    end;

    cmd = RsdCommand( strSql );

    cmd.NullConversion = true;

    cmd.addParam( "", RSDBP_IN, SfSrvDocRec.datepay       );   
    cmd.addParam( "", RSDBP_IN, SfSrvDocRec.kind          );   
    cmd.addParam( "", RSDBP_IN, SfSrvDocRec.dateperiodend );   
    cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_PERIOD        ); 

    cmd.execute();   

    // Определить дату начала периода начисления как максимальную дату окончания периода начисления произведенного по комиссии плюс один день, 
    // но не больше даты окончания периода комиссии. Если начисления не производились, то взять дату начала периода комиссии

    strSql =  "UPDATE dsfaccrue_tmp tmp " +
              "   SET tmp.t_begindate = (SELECT MAX (acr.t_enddate) + 1 " +
              "                            FROM dsfaccrue_dbt acr " +
              "                           WHERE acr.t_sfdefcomid = tmp.t_sfdefcomid) " +
              " WHERE EXISTS (SELECT 1 " +
              "                 FROM dsfaccrue_dbt acr " +
              "                WHERE acr.t_sfdefcomid = tmp.t_sfdefcomid) ";


    cmd = RsdCommand( strSql );
    cmd.NullConversion = true;
    cmd.execute();   

    // Определить дату окончания периода начисления:
    strSql =  "UPDATE dsfaccrue_tmp " +
              "SET t_EndDate = DECODE (t_IsFreePeriod, 'X', t_FinishFeeDate, LEAST(t_FinishFeeDate, t_SfDefEnd))";

    cmd = RsdCommand( strSql );
    cmd.NullConversion = true;
    cmd.execute();   

    // Определить суммы начислений по всем УПК путем перевода сумм начислений из валюты расчета sfdef.FIID_Sum в валюту оплаты sfcontr.PayFIID
    strSql =  " UPDATE dsfaccrue_tmp "
              " SET t_PayAmount = RSI_RSB_FIInstr.FI_CalcSumTypeEx(t_Amount, t_sfdefFIIDSum, t_sfContrFIID, t_PayRateID, DECODE(t_PayRateDateKind, ?, t_TransactionDate - 1, t_TransactionDate)) * (1 + t_PayRatePercent/100.0), "
              " t_PayNDSAmount = RSI_RSB_FIInstr.FI_CalcSumTypeEx(t_NDSAmount, t_sfdefFIIDSum, t_sfContrFIID, t_PayRateID, DECODE(t_PayRateDateKind, ?, t_TransactionDate - 1, t_TransactionDate)) * (1 + t_PayRatePercent/100.0) ";
              
    cmd = RsdCommand( strSql ); 
    cmd.NullConversion = true;

    cmd.addParam( "", RSDBP_IN, SFINV_RATEDATEKIND_PAYDAY );  
    cmd.addParam( "", RSDBP_IN, SFINV_RATEDATEKIND_PAYDAY );  
    cmd.execute();
  end;

  return stat;
end;

private macro SfUpdateSfDefIsInclude()
  var stat = 0;
  var strSql, cmd, rs;
  var oprID_Operation = 0; 
  var oprID_Step      = 0; 
  var SfDefID         = 0;
  strSql =  "   SELECT opr.t_id_operation AS oprid_operation, opr.t_id_step AS oprid_step, sfdef.t_id AS sfdefid " +
            "     FROM dsfdef_dbt sfdef, " +
            "          doprtemp_tmp opr, " +
            "          dsfcomiss_dbt sfcomiss, " +
            "          dsfcontr_dbt sfcontr, " +
            "          dsfconcom_dbt concom " +
            "    WHERE sfdef.t_feetype = ? " +
            "      AND sfdef.t_id = TO_NUMBER (opr.t_documentid) " +
            "      AND sfcomiss.t_feetype = sfdef.t_feetype " +
            "      AND sfcomiss.t_number = sfdef.t_commnumber " +
            "      AND sfcontr.t_id = sfdef.t_sfcontrid " +
            "      AND concom.t_id = sfdef.t_concomid " +
            "      AND sfdef.t_IsIncluded <> 'X' " +
            " AND EXISTS (SELECT 1 FROM dsfaccrue_dbt acr WHERE acr.t_sfdefcomid = sfdef.t_id) "; 

  cmd = RsdCommand( strSql ); 
  cmd.NullConversion = true;

  cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_PERIOD ); 
  cmd.execute();   
  
  rs = RsdRecordset( cmd ); 

  var DefIDArrayInc  = TArray;

  while( rs.moveNext() )
    SfDefID         = rs.value("sfdefID");
    oprID_Operation = rs.value("oprID_Operation");
    oprID_Step      = rs.value("oprID_Step");

    var IncDocID = String(SF_FEE_TYPE_PERIOD:5)+String(SfDefID:10);
    IncDocID = StrSubst( IncDocID, " ", "0" );
    AddDocumentToStepMass(2005, IncDocID, oprID_Operation, oprID_Step); // SFDEF_SET_ISINCLUDED = 2005

    DefIDArrayInc[DefIDArrayInc.size] = SfDefID;
  end;

  if(DefIDArrayInc.size > 0)
    var updInc = RsbSQLInsert("UPDATE dsfdef_dbt SET t_IsIncluded = 'X' WHERE t_FeeType = " + SF_FEE_TYPE_PERIOD + " AND t_id = ?", 1, DefIDArrayInc.size );
    updInc.AddParam( V_INTEGER, DefIDArrayInc   );
    if(not updInc.Insert())
      stat = 1;
    end;
   end;

  return stat;
end;

macro MassExecuteStep()
  var stat:integer = 0;
//  record SfAccrue(sfaccrue);
  record SfContr(SfContr);
  record SfConcom(sfconcom);
  var oprID_Operation = 0; 
  var oprID_Step      = 0; 
  var strSql, cmd, rs;

  var CashSize = SfCashSizeGetRegValue();

  stat = SfDefCalcAccrueBatch();

  if(stat == 0) 
    var sfdefAccTrnCharger = TSfDefAccTrnDataCharger(CashSize);
    var accTrnDataArray  = TArray;
    var sfdefArray       = TArray;
    var accrueDataArray  = TArray;

    strSql =" SELECT opr.t_id_operation AS oprid_operation, opr.t_id_step AS oprid_step, " +
// УПК
            " sfdef.t_id AS sfdefid, sfdef.t_fiid_sum AS sfdeffiid_sum, sfdef.t_Status AS sfdefStatus, " +
            " sfdef.t_CommNumber AS sfdefCommNumber, sfdef.t_IsIncluded AS IsIncluded, " +
// начисление по УПК
            " sfaccrue.t_begindate AS sfaccruebegin, " +
            " sfaccrue.t_enddate AS sfaccrueend, " +
            " sfaccrue.t_transactiondate AS sfaccruetrndate, " +
/*
            " CAST(NVL(sfaccrue.t_amount, 0) AS number(32,12)) AS sfaccrueamount, " +
            " CAST(NVL(sfaccrue.t_ndsamount, 0) AS number(32,12)) AS sfaccruendsamount, " +
*/
            " CAST(NVL(base.t_commsum, 0) AS number(32,12)) AS sfaccrueamount, " +
            " CAST(NVL(base.t_ndssum, 0) AS number(32,12)) AS sfaccruendsamount, " +

            " NVL(sfaccrue.t_isfinal, chr(0)) AS sfaccruefinal, " +
// суммы начисления в валюте оплаты
/*
            " CAST(NVL(sfaccrue.t_payamount, 0) AS number(32,12)) AS sfaccruepayamount, " +
            " CAST(NVL(sfaccrue.t_payndsamount, 0) AS number(32,12)) AS sfaccruepayndsamount, " +
*/
            " CAST(NVL(base.t_commsum, 0) AS number(32,12)) AS sfaccruepayamount, " +
            " CAST(NVL(base.t_ndssum, 0) AS number(32,12)) AS sfaccruepayndsamount, " +
            " deal.t_code AS code, " +
            " deal.t_fiid AS fiid, " +
            " deal.t_id AS dealid, " +
// ДО
            " contr.t_id AS contrid, " +
            " contr.t_servkind AS contrservkind, contr.t_partyid AS contrpartyid, " +
            " contr.t_department AS contrdepartment, " +
            " contr.t_payrateid AS contrpayrateid, " +
            " contr.t_payratedatekind AS contrpayratedatekind, " +
            " contr.t_payratepercent AS contrpayratepercent, " +
            " contr.t_payfiid AS contrpayfiid, contr.t_number AS contrnumber, " +
            " contr.t_dateconc AS contrdateconc, " +
// комиссия ДО
            " concom.t_id AS concomid, " +
            " concom.t_feetype AS concomfeetype, concom.t_commnumber AS concomnumber, " +
// СПИ получателя УПК
            " sicredit.t_account AS sicreditaccount, sicredit.t_fiid AS sicreditfiid, " +
// счета по КУ +Расчеты
            " NVL (pluscalc.t_account, CHR (0)) AS pluscalcaccount, " +
            " NVL (pluscalc.t_fiid, -1) AS pluscalcfiid, " +
// счета по КУ +Расчеты, НДС
            " NVL (pluscalcnds.t_account, CHR (0)) AS pluscalcndsaccount, " +
            " NVL (pluscalcnds.t_fiid, -1) AS pluscalcndsfiid, " +
// счета по КУ -НДС начисленный
            " NVL (minusndsacr.t_account, CHR (0)) AS minusndsacraccount, " +
            " NVL (minusndsacr.t_fiid, -1) AS minusndsacrfiid " +
       " FROM doprtemp_tmp opr, " +
            " dsfdef_dbt sfdef, " +
//
            " dsfbasobj_dbt base, " +
            " ddvdeal_dbt deal, " +
//
            " dsfaccrue_tmp sfaccrue, " +
            " dsfcontr_dbt contr, " +
            " dsfconcom_dbt concom,  " +
            " dsfsi_dbt sicredit, " +
            " dsfsi_dbt pluscalc, " +
            " dsfsi_dbt pluscalcnds, " +
            " dsfsi_dbt minusndsacr " +
        " WHERE sfdef.t_feetype = ? " +
        " AND sfdef.t_id = TO_NUMBER (opr.t_documentid) " +
        " AND base.t_defcommid = sfdef.t_id  " +
        " AND base.t_baseobjecttype = ? " +
        " AND base.t_feetype = ? " +
        " AND base.t_baseobjectid = deal.t_id " +
        " AND sfaccrue.t_sfdefcomid = sfdef.t_id " +
        " AND contr.t_id = sfdef.t_sfcontrid " +
        " AND concom.t_id = sfdef.t_concomid " +
        " AND sicredit.t_objecttype = ? " +
        " AND sicredit.t_debetcredit = ? " +
        " AND sicredit.t_objectid = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
        " AND pluscalc.t_objecttype(+) = ? " +
        " AND pluscalc.t_debetcredit(+) = ? " +
        " AND pluscalc.t_objectid(+) = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
        " AND pluscalcnds.t_objecttype(+) = ? " +
        " AND pluscalcnds.t_debetcredit(+) = ? " +
        " AND pluscalcnds.t_objectid(+) = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
        " AND minusndsacr.t_objecttype(+) = ? " +
        " AND minusndsacr.t_debetcredit(+) = ? " +
        " AND minusndsacr.t_objectid(+) = LPAD (TO_CHAR (sfdef.t_id), 10, '0') ";
  
    If(StrFor(GetIdentProgram()) == "S") // ценные бумаги
       strSql =" SELECT opr.t_id_operation AS oprid_operation, opr.t_id_step AS oprid_step, " +
       // УПК
            " sfdef.t_id AS sfdefid, sfdef.t_fiid_sum AS sfdeffiid_sum, sfdef.t_Status AS sfdefStatus, " +
            " sfdef.t_CommNumber AS sfdefCommNumber, sfdef.t_IsIncluded AS IsIncluded, " +
       // начисление по УПК
            " sfaccrue.t_begindate AS sfaccruebegin, " +
            " sfaccrue.t_enddate AS sfaccrueend, " +
            " sfaccrue.t_transactiondate AS sfaccruetrndate, " +
            " CAST(NVL(sfaccrue.t_amount, 0) AS number(32,12)) AS sfaccrueamount, " +
            " CAST(NVL(sfaccrue.t_ndsamount, 0) AS number(32,12)) AS sfaccruendsamount, " +
            " NVL(sfaccrue.t_isfinal, chr(0)) AS sfaccruefinal, " +
       // суммы начисления в валюте оплаты
            " CAST(NVL(sfaccrue.t_payamount, 0) AS number(32,12)) AS sfaccruepayamount, " +
            " CAST(NVL(sfaccrue.t_payndsamount, 0) AS number(32,12)) AS sfaccruepayndsamount, " +
       // ДО
            " contr.t_id AS contrid, " +
            " contr.t_servkind AS contrservkind, contr.t_partyid AS contrpartyid, " +
            " contr.t_department AS contrdepartment, " +
            " contr.t_payrateid AS contrpayrateid, " +
            " contr.t_payratedatekind AS contrpayratedatekind, " +
            " contr.t_payratepercent AS contrpayratepercent, " +
            " contr.t_payfiid AS contrpayfiid, contr.t_number AS contrnumber, " +
            " contr.t_dateconc AS contrdateconc, " +
       // комиссия ДО
            " concom.t_id AS concomid, " +
            " concom.t_feetype AS concomfeetype, concom.t_commnumber AS concomnumber, " +
       // СПИ получателя УПК
            " sicredit.t_account AS sicreditaccount, sicredit.t_fiid AS sicreditfiid, " +
       // счета по КУ +Расчеты
            " NVL (pluscalc.t_account, CHR (0)) AS pluscalcaccount, " +
            " NVL (pluscalc.t_fiid, -1) AS pluscalcfiid, " +
       // счета по КУ +Расчеты, НДС
            " NVL (pluscalcnds.t_account, CHR (0)) AS pluscalcndsaccount, " +
            " NVL (pluscalcnds.t_fiid, -1) AS pluscalcndsfiid, " +
       // счета по КУ -НДС начисленный
            " NVL (minusndsacr.t_account, CHR (0)) AS minusndsacraccount, " +
            " NVL (minusndsacr.t_fiid, -1) AS minusndsacrfiid, " +
            " comiss.t_code AS COMISSCODE " +
       " FROM doprtemp_tmp opr, " +
            " dsfdef_dbt sfdef, " +
            " dsfaccrue_tmp sfaccrue, " +
            " dsfcontr_dbt contr, " +
            " dsfconcom_dbt concom,  " +
            " dsfsi_dbt sicredit, " +
            " dsfsi_dbt pluscalc, " +
            " dsfsi_dbt pluscalcnds, " +
            " dsfsi_dbt minusndsacr, " +
            " dsfcomiss_dbt comiss " +
       " WHERE sfdef.t_feetype = ? " +
        " AND sfdef.t_id = TO_NUMBER (opr.t_documentid) " +
        " AND sfaccrue.t_sfdefcomid = sfdef.t_id " +
        " AND contr.t_id = sfdef.t_sfcontrid " +
        " AND concom.t_id = sfdef.t_concomid " +
        " AND comiss.t_number = concom.t_commnumber " +
        " AND comiss.t_feetype = concom.t_feetype " +
        " AND sicredit.t_objecttype = ? " +
        " AND sicredit.t_debetcredit = ? " +
        " AND sicredit.t_objectid = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
        " AND pluscalc.t_objecttype(+) = ? " +
        " AND pluscalc.t_debetcredit(+) = ? " +
        " AND pluscalc.t_objectid(+) = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
        " AND pluscalcnds.t_objecttype(+) = ? " +
        " AND pluscalcnds.t_debetcredit(+) = ? " +
        " AND pluscalcnds.t_objectid(+) = LPAD (TO_CHAR (sfdef.t_id), 10, '0') " +
        " AND minusndsacr.t_objecttype(+) = ? " +
        " AND minusndsacr.t_debetcredit(+) = ? " +
        " AND minusndsacr.t_objectid(+) = LPAD (TO_CHAR (sfdef.t_id), 10, '0') ";

    end;
        
    cmd = RsdCommand( strSql ); 
    cmd.NullConversion = true;

    If(StrFor(GetIdentProgram()) == "S") // ценные бумаги
       cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_PERIOD ); 
       cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
       cmd.addParam( "", RSDBP_IN, BANK_CREDIT        );  
       cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
       cmd.addParam( "", RSDBP_IN, CALC_SFSI_KIND     );  
       cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
       cmd.addParam( "", RSDBP_IN, CALCNDS_SFSI_KIND  );  
       cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
       cmd.addParam( "", RSDBP_IN, NDSACRUAL_SFSI_KIND);  
    else
    cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_PERIOD );         
    cmd.addParam( "", RSDBP_IN, OBJTYPE_OPER_DV );
    cmd.addParam( "", RSDBP_IN, SF_FEE_TYPE_PERIOD );      
    cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
    cmd.addParam( "", RSDBP_IN, BANK_CREDIT        );  
    cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
    cmd.addParam( "", RSDBP_IN, CALC_SFSI_KIND     );  
    cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
    cmd.addParam( "", RSDBP_IN, CALCNDS_SFSI_KIND  );  
    cmd.addParam( "", RSDBP_IN, 663                ); // OBJTYPE_SFDEFCOM Вид объекта
    cmd.addParam( "", RSDBP_IN, NDSACRUAL_SFSI_KIND);  
    end;
    cmd.execute();   
    var i = 0;
    var FD;
    rs = RsdRecordset( cmd ); 
    VAR OurAcc = TRecHandler("account");
    while( rs.moveNext() )

    If(StrFor(GetIdentProgram()) == "S") // ценные бумаги
       var ReceiverAccount = rs.value("SICREDITACCOUNT");
       var pSfConCom, pSFContr;
       var SfComFixPD;
       if((StrUpr(rs.value("COMISSCODE")) == "БРОКЕРФИКС") and (GetSfContrBuf(rs.value("CONTRID"), @pSFContr)) and (GetSfConCom(rs.value("CONTRID"), rs.value("COMISSCODE"), @pSFConCom)))
         SfComFixPD = SfConComPrimDocFix( 51, pSfConCom, pSfContr, 0 );
         ReceiverAccount = MC_FindAndOpenAccount("+КВ, ц/б",
                                                 SfComFixPD,
                                                 rs.value("sfaccruetrndate"     ),
                                                 0,

                                                 MC_OPENACC_CREATE);
//       var Account47423 = GetClientAccount(rs.value("CONTRID"), 818, 0);
       end;
       if((StrUpr(rs.value("COMISSCODE")) == "ИНВЕСТСОВЕТНИК") and (GetSfContrBuf(rs.value("CONTRID"), @pSFContr)) and (GetSfConCom(rs.value("CONTRID"), rs.value("COMISSCODE"), @pSFConCom)))
         SfComFixPD = SfConComPrimDocFix( 51, pSfConCom, pSfContr, 0 );
         ReceiverAccount = MC_FindAndOpenAccount("+КВ, ц/б",
                                                 SfComFixPD,
                                                 rs.value("sfaccruetrndate"),
                                                 0,
                                                 MC_OPENACC_CREATE);
       end;

    else

    
      FD = DVFirstDocDeal(DL_DVDEAL, rs.value("dealid"));
     if( not FD.OpenAccount("+КВ, ц/б", null, null, FIROLE_COMISS_CLIENT, OurAcc, rs.value("sfaccrueend"), NATCUR) )
        return 1;
     end;
    end;

      var SumPayer    = rs.value("sfaccruePayAmount");
      var NDSSumPayer = rs.value("sfaccruePayNDSAmount");
      oprID_Operation = rs.value("oprID_Operation");
      oprID_Step      = rs.value("oprID_Step");

      //var SfDef = TRecHandler("sfdef.dbt");
      var DefOpr = SfDefOpr();
      ClearRecord(DefOpr.SfDef);
      DefOpr.SfDef.rec.ID           = rs.value("sfdefID");
      DefOpr.SfDef.rec.FIID_Sum     = rs.value("sfdefFIID_Sum");
      DefOpr.SfDef.rec.Status       = rs.value("sfdefStatus");
      DefOpr.SfDef.rec.SfContrID    = rs.value("contrid");
      DefOpr.SfDef.rec.CommNumber   = rs.value("sfdefCommNumber");
      DefOpr.SfDef.rec.IsIncluded   = rs.value("IsIncluded");
      //SfDef.rec.Sum      = rs.value("t_Sum");
      //SfDef.rec.SumNDS   = rs.value("t_SumNDS");

      DefOpr.OldStatus       = DefOpr.SfDef.rec.Status; 
      DefOpr.OldIsIncluded   = DefOpr.SfDef.rec.IsIncluded;
      DefOpr.oprID_Operation = oprID_Operation;
      DefOpr.oprID_Step      = oprID_Step;     


      var AccrueOpr = SfAccrueOpr();
      ClearRecord(AccrueOpr.SfAccrue);
      AccrueOpr.SfAccrue.rec.sfdefcomID       = DefOpr.SfDef.rec.ID;
      AccrueOpr.SfAccrue.rec.begindate        = rs.value("sfaccruebegin"       );          
      AccrueOpr.SfAccrue.rec.enddate          = rs.value("sfaccrueend"         );
      AccrueOpr.SfAccrue.rec.transactiondate  = rs.value("sfaccruetrndate"     );  
      AccrueOpr.SfAccrue.rec.amount           = rs.value("sfaccrueamount"      );            
      AccrueOpr.SfAccrue.rec.ndsamount        = rs.value("sfaccruendsamount"   );      
      AccrueOpr.SfAccrue.rec.isfinal          = rs.value("sfaccruefinal"       );            

      AccrueOpr.DefComIndex = i;
      accrueDataArray[i] = AccrueOpr;

      ClearRecord(SfContr);
      SfContr.id               = rs.value("contrid"             );
      SfContr.servkind         = rs.value("contrservkind"       );
      SfContr.partyid          = rs.value("contrpartyid"        );
      SfContr.department       = rs.value("contrdepartment"     );
      SfContr.payrateid        = rs.value("contrpayrateid"      );
      SfContr.payratedatekind  = rs.value("contrpayratedatekind");
      SfContr.payratepercent   = rs.value("contrpayratepercent" );
      SfContr.payfiid          = rs.value("contrpayfiid"        );
      SfContr.number           = rs.value("contrnumber"         );
      SfContr.dateconc         = rs.value("contrdateconc"       );

      ClearRecord(SfConcom);
      SfConcom.id         = rs.value("concomid"     );                                        
      SfConcom.feetype    = rs.value("concomfeetype");
      SfConcom.commnumber = rs.value("concomnumber" );

      if(SfSrvDocRec.Kind == 2) // SFSRVDOC_KIND_PAY = 2
        DefOpr.SfDef.rec.IsIncluded = "X";
      end;

      if(SumPayer != $0)
        var accTrnData = RsbAccTransactionData();
        var retvalGetMO = GetMainOperInGroup(159);

        accTrnData.Chapter = 1;
        If(StrFor(GetIdentProgram()) == "S") // ценные бумаги
           accTrnData.Number_Pack = 10;
           accTrnData.Oper = retvalGetMO;
        end;
        accTrnData.Date_Carry    = AccrueOpr.SfAccrue.rec.TransactionDate; // Дата проводки
        accTrnData.SumPayer     = rs.value("sfaccruePayAmount");
        accTrnData.Department   = {OperDprt};

        If(StrFor(GetIdentProgram()) == "S") // ценные бумаги
           if(StrUpr(rs.value("COMISSCODE")) == "ИНВЕСТСОВЕТНИК")
              accTrnData.Ground = "Начисление комиссии за услугу по инвест консультированию ";
              if(GetDay(date(rs.value("sfaccruebegin"))) == GetDay(date(rs.value("sfaccrueend")))  )
                accTrnData.Ground = accTrnData.Ground + "за " + string(GetDay(date(rs.value("sfaccrueend"))));
              else
                accTrnData.Ground = accTrnData.Ground + "c " + string(GetDay(date(rs.value("sfaccruebegin")))) + " по " + string(GetDay(date(rs.value("sfaccrueend"))));
              end;
              accTrnData.Ground = accTrnData.Ground + " " + string(GetNameMonthRP(date(rs.value("sfaccrueend"))))+" " + string(GetYear(date(rs.value("sfaccrueend")))) + 
                                           " по брок.дог. " + GetNameDBO(SfContr.id, SfContr.number) +" от "+ GetDateDBO(SfContr.id) + ", клиент - " + GetFIO(SfContr.partyid) + ", EKK - " + GetEKKDBO(SfContr.id);
           else
              accTrnData.Ground  = string( "Начисление ежемесячной комиссии по договору " + GetNameDBO(SfContr.id, SfContr.number) +" за "+ string(GetNameMonth(date(rs.value("sfaccrueend")))) + " " + string(GetYear(date(rs.value("sfaccrueend"))))  );
           end;
        else
        accTrnData.Ground  = string( "Оплата комиссии по сделке №" + rs.value("code") +" с "+ string(ПолучитьКодФинИн(rs.value("fiid"))) );
        end;
        if(accTrnData.SumPayer > $0)
          accTrnData.FIIDPayer       = rs.value("plusCalcFIID");
          accTrnData.AccountPayer    = rs.value("plusCalcAccount");
          accTrnData.FIIDReceiver    = rs.value("sicreditFIID");
   //       accTrnData.AccountReceiver = rs.value("sicreditAccount");
          If(StrFor(GetIdentProgram()) == "S") // ценные бумаги
             accTrnData.AccountReceiver = ReceiverAccount;
          else
         accTrnData.AccountReceiver = OurAcc.rec.account;
          end;
        else
          accTrnData.FIIDPayer       = rs.value("sicreditFIID");
          accTrnData.AccountPayer    = rs.value("sicreditAccount");
          accTrnData.FIIDReceiver    = rs.value("plusCalcFIID");
          accTrnData.AccountReceiver = rs.value("plusCalcAccount");
          accTrnData.SumPayer        = -accTrnData.SumPayer;
        end;

        sfdefAccTrnCharger.SetPoint();
        sfdefAccTrnCharger.AddDocsTrn(accTrnData, DefOpr.SfDef.rec.ID, SFDOCS_LINKKIND_COMISSACCRUE, i, oprID_Operation, oprID_Step);
                                                                               
        if(NDSSumPayer != $0)
          accTrnData = RsbAccTransactionData();

          accTrnData.Chapter      = 1;
          accTrnData.Date_Carry    = AccrueOpr.SfAccrue.rec.TransactionDate; // Дата проводки
          accTrnData.SumPayer     = NDSSumPayer;
          accTrnData.Department   = {OperDprt};
          accTrnData.Ground       = string( "НДС за услуги по договору \"", SfContr.Number, "\" от ", SfContr.DateConc:f, " за период с ", AccrueOpr.SfAccrue.rec.BeginDate:f, " по ", AccrueOpr.SfAccrue.rec.EndDate:f );

          if(accTrnData.SumPayer > $0)
            accTrnData.FIIDPayer       = rs.value("plusCalcNDSFIID");
            accTrnData.AccountPayer    = rs.value("plusCalcNDSAccount");
            accTrnData.FIIDReceiver    = rs.value("minusNDSAcrFIID");
            accTrnData.AccountReceiver = rs.value("minusNDSAcrAccount");
          else
            accTrnData.FIIDPayer       = rs.value("minusNDSAcrFIID");
            accTrnData.AccountPayer    = rs.value("minusNDSAcrAccount");
            accTrnData.FIIDReceiver    = rs.value("plusCalcNDSFIID");
            accTrnData.AccountReceiver = rs.value("plusCalcNDSAccount");
            accTrnData.SumPayer        = accTrnData.SumPayer; 
          end;

          sfdefAccTrnCharger.AddDocsTrn(accTrnData, DefOpr.SfDef.rec.ID, SFDOCS_LINKKIND_NDSACCRUE, i, oprID_Operation, oprID_Step);
        end;

        sfdefAccTrnCharger.ClearPoint();

      end;

 
      sfdefArray[i] = DefOpr;
 
      i = i + 1;
    end;


    if(stat == 0)
      sfdefAccTrnCharger.ExecuteAccrueTrnDataArray(accrueDataArray, sfdefArray, SfSrvDocRec );
    end;

    stat = SFUpdateSfDefStatusIncBatch(SF_FEE_TYPE_PERIOD, sfdefArray);

    if( (stat == 0) AND (SfSrvDocRec.Kind == 2) AND SfComNotRecalcGetRegValue()) // SFSRVDOC_KIND_PAY = 2
      stat = SfUpdateSfDefIsInclude();
    end;

  end;


  if(SfSrvDocRec.Kind == 2) // SFSRVDOC_KIND_ACCRUE = 1
    stat = SetOprStatusAfterExtraAccrue();
  end;

  return stat;
end;
