/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.10          */
/*                 Copyright (c) R-Style Software Lab 2000              */
/*                                                                      */
/*  Имя файла        : bbcpsend.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага зачисления                       */
/*                     средств по валютному платежу                     */
/*                     на корсчет                                       */
/*  Программист      : Бурак В.Ю.                                       */
/*                                                                      */
/*  Создан           : 17.01.2000                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, BankInter, PTInter, "cppmconv.mac", "pmmulti.mac", "paym_rec.mac";

/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, payorder )
  var d = RsbAccTransaction(); // RsbAccTransactionData

  /* Актуализировать проводки МФР */
  if( not CarryPlanDocuments( Pm_paym.PaymentID ) )
    MsgBox("Ошибка при помещении планируемых проводок в проведенные");
    return 1;
  end;

  if( Pm_paym.FIID == Pm_paym.PayFIID )
     /*****************************************************
     Зачисление на корсчет
     *****************************************************/
     d.Chapter          = 1;
     d.Date_Carry       = Pm_paym.ValueDate;
     d.Number_Pack      = Pm_paym.NumberPack;
     /* Из-за МФР проводки теперь делаются только по Future-счетам */
     d.AccountPayer     = Pm_paym.FuturePayerAccount;
     d.AccountReceiver  = Pm_paym.FutureReceiverAccount;
     d.Sum              = Pm_paym.Amount;
     d.Ground           = Pm_rmprop.Ground;
     d.FIID             = Pm_paym.PayFIID;
     d.Numb_Document    = Pm_rmprop.Number;
     d.Department       = Pm_paym.Department;
     d.ResultCarry      = 1;
     d.Kind_Oper        = " 1";

     if(d.AccountReceiver == "")
       msgbox("В схеме расчетов не задан счет \"Незавершенные расчеты банка (списание)\"");
       return 1;
     end;

     if(Pm_paym.PayFIID) 
       if( not d.Carry() ) 
          msgbox("Ошибка при вставке валютного документа");
          return 1;
       end;
     else  
       if( not d.Carry() )
          msgbox("Ошибка при вставке рублевого документа");
          return 1;
       end;
     end;
  else
     /*****************************************************
     Зачисление на корсчет с конверсией
     *****************************************************/

     if( ПолучитьДополнительныеСчетаПроводокКонверсии() )
       msgbox( "Ошибка при установке счетов ОВП" );
       return 1;
     end;

     d.MCMethod        = 1;
     d.FIIDPayer       = Pm_paym.FIID;
     d.FIIDReceiver    = Pm_paym.PayFIID;
     d.SumPayer        = Pm_paym.Amount;
     d.SumReceiver     = Pm_paym.PayAmount;
     /* Из-за МФР проводки теперь делаются только по Future-счетам */
     d.AccountPayer    = Pm_paym.FuturePayerAccount;
     d.AccountReceiver = Pm_paym.FutureReceiverAccount;
     d.Chapter         = 1;
     d.Ground          = Pm_rmprop.Ground;
     d.Numb_Document   = Pm_rmprop.Number;
     d.Date_Carry      = Pm_paym.ValueDate;
     d.Number_Pack     = Pm_paym.NumberPack;
     d.Department      = Pm_paym.Department;
     d.ERAccountPlus   = СчетДоходов;
     d.ERAccountMinus  = СчетРасходов;

     if(d.AccountReceiver == "")
       msgbox("В схеме расчетов не задан счет \"Незавершенные расчеты банка (списание)\"");
       return 1;
     end;

     if( not d.Carry() )
       MsgBox( "Ошибка при вставке мультивалютного документа" );
       return 1; 
     end;
  end;

  /*****************************************************
  Здесь можно вставлять дополнительные проводки для шага
  *****************************************************/

  /* Обработка сводных платежей */
  if( ProcessPayment( Pm_credit.Corschem, Pm_credit.PayFIID, Pm_paym.ValueDate, Pm_paym.Department ) )
    return 1;
  end;

  return 0;

END;
