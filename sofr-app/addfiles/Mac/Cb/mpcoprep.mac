/*-------------------------------------------------------------------------
          €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank v6.0.020
                 Copyright (c) R-Style Software Lab

  ˆ¬ï ä ©«         : mpcoprep.mac

  ¨¡«¨®â¥ª        : 

  Ž¯¨á ­¨¥         : 

  à®£à ¬¬¨áâ      : Kirakozov Michael (KMB)

  ‘®§¤ ­           : 02.02.2009
-------------------------------------------------------------------------*/
IMPORT RsbDataSet,  CTInter,  globals;
    
const RSRV_QCATEGORY_TICK    = 1, /* ª â. ª ç¥áâ¢ : ¯® á¤¥«ª¥           */
      RSRV_QCATEGORY_CONTR   = 2, /* ª â. ª ç¥áâ¢ : ¯® ª®­âà £¥­âã      */
      RSRV_QCATEGORY_PERCENT = 3; /* ª â. ª ç¥áâ¢ : ¯® ¯à®æ¥­âã à¥§¥à¢  */ 



var   DateCalculateBegin, 
      DateCalculateEnd,
      ContractID,
      ContractBoffice,
      ContractNumber,
      ContractAccount,
      OperNum,
      OperName,
      flagFirstRow;

RECORD contract( prccontract );

/* ------------------------------- */




/* „®ªã¬¥­â á¥à¢¨á­®© ®¯¥à æ¨¨ */
//record OprServDoc( dl_comm );
/* ‘âàãªâãà  á ¤ ­­ë¬¨ ® 1 áâà®ª¥ ®âç¥â . ‡ ¯®«­ï¥âáï ¢ ¬ ªà®á¥ ¢ë¯®«­¥­¨ï è £ */
//var SvOpReportLineData = TArray; 
/*à¨§­ ª, çâ® ¢ë¯®«­ï¥âáï á¥à¢¨á­ ï ®¯¥à æ¨ï*/
//var SvOpIsServiceOper = false;
/*—¨á«® ¢áâ ¢«¥­­ëå ¢ ®âç¥â § ¯¨á¥© */
//var SvOpNumInsRecord = 0; 


/* ˆ¬ï ä ©«  ¤«ï ®âç¥â®¢ á¥à¢¨á­ëå ®¯¥à æ¨© */
//private var  SvOpReportName = "mpcdlrep";
//private file SvOpReportFile() txt write;

// ®¤ª çª  ­ §¢ ­¨ï íª-®ä¨á 
PRIVATE MACRO PumpBO(BO)
   var cmd, RS;
   cmd = RSDCommand( " select t_code from dllvalues_dbt where t_list = 1118 and t_element = ? " ) ; 
   cmd.addParam( "", RSDBP_IN, BO );
   cmd.execute();
   RS = TRsbDataSet(cmd);
   if (RS.movenext() )
      ContractBoffice = Rs.code;
   end;
END;

private macro PrintHead()
   [           ###############################################]({Name_Bank});
   [           ###############################################]({OperDprt}:l);
   [      ];
   [                      ’ ¡«¨æ  ¥¦¥¤­¥¢­®£® à áç¥â  ¯à®æ¥­â®¢ ];
   [   ];
   [  „ â  ­ ç «  à áç¥â :    ##########](Date(DateCalculateBegin):c);
   [  „ â  ®ª®­ç ­¨ï à áç¥â : ##########](Date(DateCalculateEnd):c);
   [  à®æ¥­â­ë© ¤®£®¢®à:     #### ####](ContractBoffice,ContractNumber);
   [  ‹¨æ¥¢®© áç¥â:           ####################](ContractAccount);
   [   ];
   [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
   [³  ç «ì­ ï ¤ â  ³ Š®­¥ç­ ï ¤ â  ³ —¨á«® ¤­¥© ³     Žáâ â®ª     ³ ‘â ¢ª  ¢ £®¤  ³ ‘ã¬¬  ¯à®æ¥­â®¢ ³];
end;

private macro PrintBottom(Days,TotalSum)
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [³ ˆâ®£ ¯® à áç¥âã                                                                                 ³];
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [³################³###############³############³                                  #################³]
   (Date(DateCalculateBegin):c, Date(DateCalculateEnd):c, Days, TotalSum); 
   [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
   [   ];
   [  Ž¯¥à æ¨®­¨áâ:     #### #########](OperNum,OperName);
end;

private macro PrintLine(rs, Sum)
   if (flagFirstRow)
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   else
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];   
   end;
   [³################³###############³############³#################³###############³#################³]
   (Date(rs.STARTDATE):c, Date(rs.ENDDATE):c, rs.DAYSNUM, money(rs.Rest), rs.Rate:15:*,rs.Point, Sum); 
end;   

private macro PrintSubItog(TotalSumR,i,BegDate,EndDate)
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [³ à®¬¥¦ãâ®ç­ë© ¨â®£ ¯® £à ä¨ªã à áç¥â                                                            ³];
   [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
   [³################³###############³############³                                  #################³]
   (Date(BegDate):c, Date(EndDate):c, i, TotalSumR);    
   
end;


private macro CalcOnePeriod(RS,Days:@integer, Itog:@money)

   var DDate, BegDate, EndDate,
       cmd,cmd2,rs2,
       sum,
       i = 0,
       DaySum = $0,
       TotalSum = $0,
       TotalSumR = $0,
       ISum = $0,
       stat = 0;

   stat = 0;
   DDate = RS.Date;
   BegDate = RS.PeriodBeginDate;
   EndDate = RS.PeriodEndDate;

   if (EndDate > DateCalculateEnd)
      EndDate = DateCalculateEnd;
   end;
   
   //­¨ç¥£® ­¥ ­ è«¨
   if (DDate == date (0,0,0))
      stat = 1;
   end;

   if (stat == 0)
      cmd = RSDCommand( "{ ? = call RSB_PERCENT.PRC_CALCPERCENTVALUES ( ?, ?, ?, ?, 1 ) }" );
      cmd.addParam( "retval", RSDBP_OUT, V_INTEGER );
      cmd.addParam( "Sum", RSDBP_OUT, V_NUMERIC );
      cmd.addParam( "", RSDBP_IN, ContractID );
      cmd.addParam( "", RSDBP_IN, BegDate );
      cmd.addParam( "", RSDBP_IN, EndDate );
      cmd.execute();
      Sum = cmd.value( "Sum" );

      cmd2 = RSDCommand( "select T_STARTDATE,T_ENDDATE,T_DAYSNUM,T_REST,T_RATE,T_SUM,T_POINT from DPRCCALCPRCVAL_TMP" );
      cmd2.execute();

      rs2 = TRsbDataSet(cmd2);
      
      while( rs2.movenext() )
         ISum = rs2.Sum;
         
         TotalSum = TotalSum + ISum;
         DaySum = TotalSum - TotalSumR;
         DaySum = round(DaySum,2);
         TotalSumR = TotalSumR + DaySum;
         PrintLine(rs2,DaySum);
         flagFirstRow = false;
         i = i + 1;
      end;
      
      PrintSubItog(TotalSumR,i,BegDate,EndDate);
      flagFirstRow = true;
      Itog = TotalSumR;
      Days = i;
   end;

END;   


/*****************************************************************************
                    Ž¡é¨¥ ä-¨ ¤«ï ¯¥ç â¨ ®âç¥â  á¥à¢. ®¯¥à æ¨¨ 
******************************************************************************/

macro MpcDailyCalcOperReport( ContractBuf, DateCalcBegin, DateCalcEnd )

   var  Data, RS, cmd,
        ¤®«¦­®áâìˆá¯,
        iSum = $0,
        iDays = 0,
        TotalSum = $0,
        TotalDays = 0;

   
   SetBuff( contract, ContractBuf );

   DateCalculateBegin = DateCalcBegin; 
   DateCalculateEnd = DateCalcEnd;
   ContractID = contract.ContractID;
   ContractBoffice = contract.BackOffice;
   PumpBO(ContractBoffice);
   ContractNumber = contract.Number; 
   ContractAccount = contract.Account; 
   OperNum = {oper};
   OperName = {Name_Oper};

   flagFirstRow = false;  
   PrintHead();


   cmd = RSDCommand( "select T_DATE, T_PERIODBEGINDATE, T_PERIODENDDATE from DPRCCNTSCHED_DBT " +
                     "where T_CONTRACTID = ? and T_SCHEDULEKIND = 1 and T_PERIODENDDATE >= ? " +
                     "and T_PERIODBEGINDATE <= ? "+
                     "order by T_DATE" );
   cmd.addParam( "", RSDBP_IN, ContractID );
   cmd.addParam( "", RSDBP_IN, DateCalculateBegin );
   cmd.addParam( "", RSDBP_IN, DateCalculateEnd );
   cmd.execute();

   RS = TRsbDataSet(cmd);
   while( RS.movenext() )
      CalcOnePeriod(RS, @iDays, @iSum);
      TotalSum = TotalSum + iSum;
      TotalDays = TotalDays + iDays;
   end;

   PrintBottom(TotalDays,TotalSum);
   

    //ViewFile( SvOpReportFile );
 // end;
end;
END;

