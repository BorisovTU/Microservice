/*
 $Name: pdnlib.mac
 $Module: Ядро ГКБО 
 $Description: Сервисные функции видов ПДн проекта RS-Core
 */
 /*
	Сервисные функции видов ПДн проекта RS-Core
 */
import "global.mac", PtInter, "pr_party_lib.mac";

const FN_RESULT_TRUE  = 0;
const FN_RESULT_FALSE = -1;

var party, person, Kind, UserParm;
private macro PDN_KindValue()
//begin
    var result = "";
    var cmd, rs;
    var bFirst = true;
    if (Kind == PDNKINDS_FULLNAME) // Фамилия, имя, отчество
        result = party.rec.Name;
    elif (Kind == PDNKINDS_CHANGED_NAME) // Измененные ФИО и псевдонимы
        cmd = RsdCommand("SELECT T_NAME FROM DPARTYNAME_DBT WHERE T_PARTYID = ? AND T_NAMETYPEID NOT IN(1, 2)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();

        rs = RsdRecordset(cmd);
        while (rs.MoveNext())
            if (not bFirst)
                result = result +  ";";
            end;
            result = result + rs.value(0);
            bFirst = false;
        end;
    elif (Kind == PDNKINDS_GENDER) // Пол
        if (person.rec.IsMale == "X")
            result = "мужской";
        else
            result = "женский";
        end;
    elif (Kind == PDNKINDS_BIRTH) // Дата рождения
        result = String(person.rec.Born:f);
        
        if (person.rec.death != ZeroValue(V_DATE))
            result = result + "; дата смерти - " + String(person.rec.death:f);
        end;
    elif (Kind == PDNKINDS_BIRTH_PLACE) // Место рождения
        result = "место рождения: " + person.rec.birsplase + "; регион: " + person.rec.regionborn + "; район: " + person.rec.raionborn + "; населенный пункт: " + person.rec.placeborn;
    elif (Kind == PDNKINDS_CITIZENSHIP) // Гражданство
        if (strlen(party.rec.NRcountry) == 0)
            result = "лицо без гражданства";
        else
            result = party.rec.NRcountry;
        end;
        
        result = result + "; нерезидент: ";
        if (party.rec.notresident == "X")
            result = result + "да";
        else
            result = result + "нет";
        end;
        
        if (party.rec.OfshoreZone != 0)
            cmd = RsdCommand("SELECT T.T_NAME FROM DCOUNTRY_DBT T WHERE T.T_COUNTRYID = ?");
            cmd.addParam("", RSDBP_IN, party.rec.OfshoreZone);
            cmd.execute();
            rs = RsdRecordset(cmd);
            if (rs.MoveNext())
                result = result + "; резидент офшорной зоны; " + rs.value(0);
            end;
        end;
    elif (Kind == PDNKINDS_RESIDENCE_ADDR) // Адрес места жительства
        cmd = RsdCommand("SELECT T_ADRESS FROM DADRESS_DBT WHERE T_PARTYID = ? AND T_TYPE = 1");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = rs.value(0);
        end;
    elif (Kind == PDNKINDS_PLACE_ADDR) // Адрес места пребывания
        cmd = RsdCommand("SELECT T_ADRESS FROM DADRESS_DBT WHERE T_PARTYID = ? AND T_TYPE = 2");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = rs.value(0);
        end;
    elif (Kind == PDNKINDS_MAILING_ADDR) // Почтовый адрес
        cmd = RsdCommand("SELECT T_ADRESS FROM DADRESS_DBT WHERE T_PARTYID = ? AND T_TYPE = 3");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = rs.value(0);
        end;
    elif (Kind == PDNKINDS_OTHER_ADDR) // Прочий адрес
        cmd = RsdCommand("SELECT t.T_ADRESS, tp.T_NAME FROM DADRESS_DBT t, DADRTYPE_DBT tp WHERE T_PARTYID = ? AND t.T_TYPE NOT IN (1,2,3) and TP.T_TYPE = T.T_TYPE");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        
        result = "";
        while (rs.MoveNext())
            if (result != "")
                result = result + "; "
            end;
            
            if (not bFirst)
                result = result +  ";";
            end;
            result = result + rs.value(1) + ": " + rs.value(0);
        end;
    elif (Kind == PDNKINDS_TIN) // ИНН
        cmd = RsdCommand("SELECT T_CODE FROM DOBJCODE_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_CODEKIND = ? AND T_STATE <> 1 AND T_BANKDATE <= ?");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, 16);
        cmd.addParam("", RSDBP_IN, {curdate});
        cmd.execute();
        rs = RsdRecordset(cmd);
        
        if (rs.MoveNext())
            result = rs.value(0);
        end;
    elif (Kind == PDNKINDS_SNILS) // СНИЛС
        cmd = RsdCommand("SELECT T_CODE FROM DOBJCODE_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_CODEKIND = ? AND T_STATE <> 1 AND T_BANKDATE <= ?");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, 63);
        cmd.addParam("", RSDBP_IN, {curdate});
        cmd.execute();
        rs = RsdRecordset(cmd);
        
        if (rs.MoveNext())
            result = rs.value(0);
        end;
    elif (Kind == PDNKINDS_CHI_NUMBER) // Номер ОМС
        cmd = RsdCommand("SELECT T_CODE FROM DOBJCODE_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_CODEKIND = ? AND T_STATE <> 1 AND T_BANKDATE <= ?");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, 48);
        cmd.addParam("", RSDBP_IN, {curdate});
        cmd.execute();
        rs = RsdRecordset(cmd);
        
        if (rs.MoveNext())
            result = rs.value(0);
        end;
    elif (Kind == PDNKINDS_REQUISITES_DRIVER_LICENSE) // Реквизиты водительского удостоверения
        cmd = RsdCommand("SELECT T_SERIES, T_NUMBER, T_DOCDATE, T_STARTDATE, T_FINISHDATE FROM DOBJRGDOC_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_REGDOCKIND = 28 AND T_REGPARTYKIND = 47 ORDER BY T_STARTDATE DESC");
        cmd.NullConversion = true;
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = "серия: " + rs.value(0) + ", номер: " + rs.value(1);
            var dt = ZeroValue(V_DATE);
            
            if (Date(rs.value(2)) == ZeroValue(V_DATE))
                dt = Date(rs.value(3));
            else
                dt = Date(rs.value(2));
            end;
            
            if (dt != ZeroValue(V_DATE))
                result = result + ", выдано: " + String(dt:f);
                
                if (Date(rs.value(4)) != ZeroValue(V_DATE))
                    result = result + ", до " + String(Date(rs.value(4)):f);
                end;
            end;
        end;
    elif (Kind == PDNKINDS_PASSPORT) // Данные паспорта и/или иного документа, удостоверяющего личность
        cmd = RsdCommand("SELECT t2.T_NAME, t.T_PAPERSERIES, t.T_PAPERNUMBER, t.T_PAPERISSUEDDATE, t.T_PAPERISSUER, t.T_PAPERISSUERCODE FROM DPERSNIDC_DBT t, dPAPRKIND_dbt t2 WHERE t.T_PERSONID = ? AND t.T_ISMAIN = CHR(88) AND T2.T_PAPERKIND = T.T_PAPERKIND");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = rs.value(0) + ", серия: " + rs.value(1) + ", номер: " + rs.value(2) + ", выдан: " + Date(rs.value(3));
            
            if (strlen(rs.value(4)) > 0)
                result = result + ", " + rs.value(4);
            end;
            
            if (strlen(rs.value(5)) > 0)
                result = result + ", код подразделения: " + rs.value(5);
            end;
        end;
    elif (Kind == PDNKINDS_CONTACT_PHONE) // Номера контактных телефонов и факсов
        cmd = RsdCommand("SELECT T2.T_NAME,T.T_VALUE FROM DCONTACT_DBT T, DCONTACTKIND_DBT T2 WHERE T.T_PARTYID = ? AND T.T_CONTACTKIND IN (1,3) AND T.T_CONTACTKIND = T2.T_KIND");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        while (rs.MoveNext())
            if (not bFirst)
                result = result +  ";";
            end;
            result = result + rs.value(0) + ": " + rs.value(1);
            bFirst = false;
        end;
    elif (Kind == PDNKINDS_EMAIL_ADDR) // Адрес электронной почты
        cmd = RsdCommand("SELECT T2.T_NAME,T.T_VALUE FROM DCONTACT_DBT T, DCONTACTKIND_DBT T2 WHERE T.T_PARTYID = ? AND T.T_CONTACTKIND IN (5) AND T.T_CONTACTKIND = T2.T_KIND");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        while (rs.MoveNext())
            if (not bFirst)
                result = result +  ";";
            end;
            result = result + rs.value(1);
            bFirst = false;
        end;
    elif (Kind == PDNKINDS_BIOMETRIC) // Биометрические данные
        cmd = RsdCommand("SELECT 1 FROM DIMGDATA_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = LPAD(?, 10, '0') AND T_IMAGETYPE = 2");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = "имеется";
        else 
            result = "отсутствует";
        end;
    elif (Kind == PDNKINDS_SIGNATURE) // Подпись
        cmd = RsdCommand("SELECT 1 FROM DIMGDATA_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = LPAD(?, 10, '0') AND T_IMAGETYPE = 1");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.MoveNext())
            result = "имеется";
        else 
            result = "отсутствует";
        end;
    elif (Kind == PDNKINDS_WORK_EXP) // Трудовая деятельность
        result = PrintPlaceWork(party.rec.PartyID);
    end;
    
    return result;
end;

private macro UpdateBFile(bfile)
//begin
    var stat = 0;
    
    if (not bfile.update())
        stat = 1;
    end;
    
    return stat;
end;

private macro PDN_KindDeleteValue()
//begin
    var stat = 0;
    var cmd,rs;
    var adrfile;
    var PartyID = party.rec.PartyID;
    
    if (Kind == PDNKINDS_FULLNAME) // Фамилия, имя, отчество
        party.rec.Name = "полн.наименование" + party.rec.PartyID;
        party.rec.ShortName = "сокр.наименование" + party.rec.PartyID;
        person.rec.name1 = "фамилия" + party.rec.PartyID;
        person.rec.name2 = "имя" + party.rec.PartyID;
        person.rec.name3 = "отчество" + party.rec.PartyID;        
        
        if (not stat)
            stat = UpdateBFile(party);
        end;
        
        if (not stat)
            stat = UpdateBFile(person);
        end;
        //pt.Update();
        if (not stat)
            cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(110,120,320,330,340)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();
        end;
    elif (Kind == PDNKINDS_CHANGED_NAME) // Измененные ФИО и псевдонимы
        party.rec.AddName = "доп.наименование" + party.rec.PartyID;
        stat = UpdateBFile(party);
        
        if (not stat)
            cmd = RsdCommand("delete FROM DPARTYNAME_DBT WHERE T_PARTYID = ? AND T_NAMETYPEID NOT IN(1, 2)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();

            cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(130,320,330,340)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();
        end;
    elif (Kind == PDNKINDS_GENDER) // Пол
        person.rec.ismale = 1;
        
        if (not stat)
            stat = UpdateBFile(person);
        end;
        
        if (not stat)
            cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(350)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();
        end;
    elif (Kind == PDNKINDS_BIRTH) // Дата рождения
        person.rec.born = ZeroValue(V_DATE);
        person.rec.death = ZeroValue(V_DATE);
        
        if (not stat)
            stat = UpdateBFile(person);
        end;
        
        if (not stat)
            cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(410,420)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();
        end;
    elif (Kind == PDNKINDS_BIRTH_PLACE) // Место рождения
        person.rec.birsplase = "место_рождания" + party.rec.PartyID;
        person.rec.regionborn = "";
        person.rec.raionborn = "район" + party.rec.PartyID;
        person.rec.placeborn = "нас.пункт" + party.rec.PartyID;
        
        if (not stat)
            stat = UpdateBFile(person);
        end;
        
        if (not stat)
            cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(370,380,390,400)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();
        end;
    elif (Kind == PDNKINDS_CITIZENSHIP) // Гражданство
        party.rec.NRcountry = "";
        party.rec.OfshoreZone = 0;
        
        if (not stat)
            stat = UpdateBFile(party);
        end;
        
        if (not stat)
            cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(150,160,170)");
            cmd.addParam("", RSDBP_IN, party.rec.PartyID);
            cmd.execute();
        end;
    elif (Kind == PDNKINDS_RESIDENCE_ADDR) // Адрес места жительства
        adrfile = TBfile("adress.dbt","W",0);
        adrfile.rec.partyid = party.rec.PartyID;
        adrfile.rec.type = 1;
        
        if (adrfile.getEQ())
            adrfile.rec.adress = "";
            adrfile.rec.country = "";
            adrfile.rec.postindex = "";
            adrfile.rec.region = "";
            adrfile.rec.codeprovince = "";
            adrfile.rec.province = "";
            adrfile.rec.codedistrict = "";
            adrfile.rec.district = "";
            adrfile.rec.codeplace = "";
            adrfile.rec.place = "";
            adrfile.rec.codestreet = "";
            adrfile.rec.street = "";
            adrfile.rec.house = "";
            adrfile.rec.numcorps = "";
            adrfile.rec.flat = "";
            adrfile.rec.territory = "";
            adrfile.rec.branch = "";
            adrfile.rec.numsession = "";
            adrfile.rec.kladr = "";
            adrfile.rec.coderegion = "";
            adrfile.rec.okato = "";
            adrfile.rec.regionnum = "";
            adrfile.rec.CodePlan = "";
            adrfile.rec.Plan = "";
            adrfile.rec.Building = "";
            adrfile.rec.OKTMO = "";
            adrfile.rec.FIAS = "";
            adrfile.rec.FIASGUID = "";
            
            adrfile.rec.adress = "место_жительства" + party.rec.PartyID;
            
            stat = UpdateBFile(adrfile);
            
            if (not stat)
                cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(190)");
                cmd.addParam("", RSDBP_IN, party.rec.PartyID);
                cmd.execute();
            end;
        else
            stat = 1;
        end;
    elif (Kind == PDNKINDS_PLACE_ADDR) // Адрес места пребывания
        adrfile = TBfile("adress.dbt","W",0);
        adrfile.rec.partyid = party.rec.PartyID;
        adrfile.rec.type = 2;
        
        if (adrfile.getEQ())
            adrfile.rec.adress = "";
            adrfile.rec.country = "";
            adrfile.rec.postindex = "";
            adrfile.rec.region = "";
            adrfile.rec.codeprovince = "";
            adrfile.rec.province = "";
            adrfile.rec.codedistrict = "";
            adrfile.rec.district = "";
            adrfile.rec.codeplace = "";
            adrfile.rec.place = "";
            adrfile.rec.codestreet = "";
            adrfile.rec.street = "";
            adrfile.rec.house = "";
            adrfile.rec.numcorps = "";
            adrfile.rec.flat = "";
            adrfile.rec.territory = "";
            adrfile.rec.branch = "";
            adrfile.rec.numsession = "";
            adrfile.rec.kladr = "";
            adrfile.rec.coderegion = "";
            adrfile.rec.okato = "";
            adrfile.rec.regionnum = "";
            adrfile.rec.CodePlan = "";
            adrfile.rec.Plan = "";
            adrfile.rec.Building = "";
            adrfile.rec.OKTMO = "";
            adrfile.rec.FIAS = "";
            adrfile.rec.FIASGUID = "";
            
            adrfile.rec.adress = "место_пребывания" + party.rec.PartyID;
            
            stat = UpdateBFile(adrfile);
            
            if (not stat)
                cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(200)");
                cmd.addParam("", RSDBP_IN, party.rec.PartyID);
                cmd.execute();
            end;
        end;
    elif (Kind == PDNKINDS_MAILING_ADDR) // Почтовый адрес
        adrfile = TBfile("adress.dbt","W",0);
        adrfile.rec.partyid = party.rec.PartyID;
        adrfile.rec.type = 3;
        
        if (adrfile.getEQ())
            adrfile.rec.adress = "";
            adrfile.rec.country = "";
            adrfile.rec.postindex = "";
            adrfile.rec.region = "";
            adrfile.rec.codeprovince = "";
            adrfile.rec.province = "";
            adrfile.rec.codedistrict = "";
            adrfile.rec.district = "";
            adrfile.rec.codeplace = "";
            adrfile.rec.place = "";
            adrfile.rec.codestreet = "";
            adrfile.rec.street = "";
            adrfile.rec.house = "";
            adrfile.rec.numcorps = "";
            adrfile.rec.flat = "";
            adrfile.rec.territory = "";
            adrfile.rec.branch = "";
            adrfile.rec.numsession = "";
            adrfile.rec.kladr = "";
            adrfile.rec.coderegion = "";
            adrfile.rec.okato = "";
            adrfile.rec.regionnum = "";
            adrfile.rec.CodePlan = "";
            adrfile.rec.Plan = "";
            adrfile.rec.Building = "";
            adrfile.rec.OKTMO = "";
            adrfile.rec.FIAS = "";
            adrfile.rec.FIASGUID = "";
            
            adrfile.rec.adress = "почтовый_адрес" + party.rec.PartyID;
            
            stat = UpdateBFile(adrfile);
            
            if (not stat)
                cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(210)");
                cmd.addParam("", RSDBP_IN, party.rec.PartyID);
                cmd.execute();
            end;
        end;
    elif (Kind == PDNKINDS_OTHER_ADDR) // Прочий адрес
        cmd = RsdCommand("DELETE FROM DADRESS_DBT WHERE T_PARTYID = ? AND T_TYPE NOT IN (1,2,3)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
    elif (Kind == PDNKINDS_TIN) // ИНН
        cmd = RsdCommand("update DOBJCODE_DBT set T_CODE = ? WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_CODEKIND = ?");
        cmd.addParam("", RSDBP_IN, "инн" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, 16);
        cmd.execute();
    elif (Kind == PDNKINDS_SNILS) // СНИЛС
        cmd = RsdCommand("update DOBJCODE_DBT set T_CODE = ? WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_CODEKIND = ?");
        cmd.addParam("", RSDBP_IN, "снилс" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, 63);
        cmd.execute();
     elif (Kind == PDNKINDS_CHI_NUMBER) // Номер ОМС
        cmd = RsdCommand("update DOBJCODE_DBT set T_CODE = ? WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_CODEKIND = ?");
        cmd.addParam("", RSDBP_IN, "омс" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, 48);
        cmd.execute();
    elif (Kind == PDNKINDS_REQUISITES_DRIVER_LICENSE) // Реквизиты водительского удостоверения
        cmd = RsdCommand("update DOBJRGDOC_DBT set T_SERIES = ?, T_NUMBER = ?, "
        "T_DOCDATE = TO_DATE('01/01/0001', 'MM/DD/YYYY'), T_STARTDATE = TO_DATE('01/01/0001', 'MM/DD/YYYY'), T_FINISHDATE = TO_DATE('01/01/0001', 'MM/DD/YYYY'), T_BANKDATE =  TO_DATE('01/01/0001', 'MM/DD/YYYY') "
        "   WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = ? AND T_REGDOCKIND = 28 AND T_REGPARTYKIND = 47");
        cmd.addParam("", RSDBP_IN, "серия" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, "номер" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("delete from DOBJRGDOCHIST_DBT WHERE T_OBJECTID = ? AND T_OBJECTTYPE = 3 AND T_REGDOCKIND = 28 AND T_REGPARTYKIND = 47");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
    elif (Kind == PDNKINDS_PASSPORT) // Данные паспорта и/или иного документа, удостоверяющего личность
        cmd = RsdCommand("delete from DPERSNIDC_DBT WHERE T_PERSONID = ? AND T_ISMAIN <> CHR(88)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("UPDATE DPERSNIDC_DBT SET "
			"T_PAPERSERIES = ?, "
			"T_PAPERNUMBER = ?, "
			"T_PAPERISSUEDDATE = TO_DATE('01/01/0001', 'MM/DD/YYYY'), "
			"T_PAPERISSUER = CHR(1), "
			"T_PAPERISSUERCODE = CHR(1), "
			"T_VALIDTODATE = TO_DATE('01/01/0001', 'MM/DD/YYYY'), "
			"T_ISMAIN = CHR(0), "
			"T_ISNOTVALID = CHR(0), "
			"T_BRANCH = 0, "
			"T_NUMSESSION = 0 WHERE T_PERSONID = ? AND T_ISMAIN = CHR(88)");
        cmd.addParam("", RSDBP_IN, "с" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, "н" + party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("delete from DPERSNIDCHIST_DBT where T_PERSONID = ?");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
    elif (Kind == PDNKINDS_CONTACT_PHONE) // Номера контактных телефонов и факсов
        cmd = RsdCommand("delete from DCONTACT_DBT WHERE t_partyid = ? AND T_CONTACTKIND IN (1,3)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("insert into DCONTACT_DBT(t_partyid,t_addresstype,t_contactkind,t_contacttype,t_provider,t_value,t_note,t_ismain) "
            "values(?,0,1,0,CHR(1),?,CHR(1),CHR(88)) ");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, "телефон" + party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(1150)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
    elif (Kind == PDNKINDS_EMAIL_ADDR) // Адрес электронной почты
        cmd = RsdCommand("delete from DCONTACT_DBT WHERE t_partyid = ? AND T_CONTACTKIND IN (5)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("insert into DCONTACT_DBT(t_partyid,t_addresstype,t_contactkind,t_contacttype,t_provider,t_value,t_note,t_ismain) "
            "values(?,0,5,0,CHR(1),?,CHR(1),CHR(88)) ");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.addParam("", RSDBP_IN, "email" + party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(1150)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
    elif (Kind == PDNKINDS_BIOMETRIC) // Биометрические данные
        cmd = RsdCommand("SELECT t_imageid FROM DIMGDATA_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = LPAD(?, 10, '0') AND T_IMAGETYPE = 2");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        rs = RsdRecordset(cmd);
        while (rs.MoveNext())
            WEB_DeleteImage(rs.value(0));
        end;
    elif (Kind == PDNKINDS_SIGNATURE) // Биометрические данные
        cmd = RsdCommand("SELECT t_imageid FROM DIMGDATA_DBT WHERE T_OBJECTTYPE = 3 AND T_OBJECTID = LPAD(?, 10, '0') AND T_IMAGETYPE = 1");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        rs = RsdRecordset(cmd);
        while (rs.MoveNext())
            WEB_DeleteImage(rs.value(0));
        end;
    elif (Kind == PDNKINDS_WORK_EXP) // Трудовая деятельность
        cmd = RsdCommand("delete from DPERSNPLACEWORK_DBT WHERE t_partyid = ?");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
        
        cmd = RsdCommand("delete from dptprmhist_dbt where t_partyid = ? and t_paramkindid in(430)");
        cmd.addParam("", RSDBP_IN, party.rec.PartyID);
        cmd.execute();
    end;
    
    return stat;
end;

macro PDN_KindServiceFun(
    pPartyID, // Системный ID субъекта экономики - физического лица, в отношении ПДн которого вызвана функция
    pKind, // Номер вида ПДн, в отношении которого вызвана функция
    pMode, // Признак режима функции
    pUserParm,
    pOutValue
)
//begin
    party = TBfile("party.dbt", "W", 0);
    person = TBfile("persn.dbt", "W", 0);
    party.rec.PartyID = pPartyID;
    person.rec.PersonID = pPartyID;
    
    if ((not party.getEQ()) or (not person.getEQ()))
        return 2591; // Не задан субъект
    end;
    
    if (party.rec.LegalForm != 2)
        return 4298; // Не указан идентификатор субъекта - физического лица
    end;
    
    Kind = pKind;
    UserParm = pUserParm;
    
    var result;
    if (pMode == PDNKINDSSFM_VALUE)
        result = 0;
        SetParm(4, PDN_KindValue());
    else
        //result = ProcessTrn(0, "PDN_KindDeleteValue");
        result = PDN_KindDeleteValue();
    end;
    
    return result;
end;

 macro PDN_CheckProcessServiceFun(pPdnTypePartyID, pUserPrm, outEndDate, outOper, outComment)
 //begin
    var result = FN_RESULT_TRUE;
    var FinProcID;
    
    if (GetTypifiedValue("id", V_INTEGER, FinProcID, pUserPrm))
        if (FinProcID == PDNCMPLTPRCSS_DUTIES_FULFILLED)
        end;
        SetParm(2, Date());
        SetParm(3, {oper});
        SetParm(4, "Comment");
    end;
    
    return result;
 end;