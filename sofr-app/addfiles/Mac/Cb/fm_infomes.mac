/*
$Name: fm_infomes.mac
$Module: Фин. мониторинг 
$Description: Макрос печати отчета выгрузки сообщения
*/

Import "globals.mac", FMInter;


PRIVATE MACRO GetNameOper(Oper)
   FILE person ( person );
   Person.Oper = Oper;
   if ( GetEQ( Person) )
      return ( Person.Name );
   else
    return "";
   end; 

END;

macro FileApprove_InfoMes
( 
  fname :string, 
  FileSize, 
  TreatDate :date, 
  TreatTime :time, 
  Department, 
  DepName :string, 
  CtrlRes,
  OperFullName :string
)

 var strRes;

 if( CtrlRes == 0 )
   strRes = "Принят";
 end;

 if( CtrlRes == 1 )
   strRes = "Не принят: Имя файла не соответствует заданной структуре.";
 end;

 if( CtrlRes == 2 )
   strRes = "Не принят: Невозможно прочитать файл.";
 end;

 if( Department == 0 )
   DepName = "не определено";
 end;

 if( OperFullName == "" )
   OperFullName = "не определено";
 end;
  
[
  Файл:     ##########################################
  Размер:   ###############

  Дата:     ########### ##########
  Филиал:   #### #################

  Результаты контроля: ##########################################################
                       
  #############################################
 
]
 (
   fname, 
   FileSize, 
   TreatDate, 
   TreatTime, 
   Department, 
   DepName, 
   strRes,
   OperFullName 
 )
 ;         
end;

private macro GetPosFileOes(FileOES, Action, Numb_p, Date_p)
  
  rewind( FileOES );
  while( next(FileOES) )                     
    if ((FileOES.action == Action ) 
        and (FileOES.numb_p == Numb_p ) 
        and (FileOES.date_p == Date_p ) )
      return GetPos( FileOes );                           
    end;
  end;

end;


private macro GetNumErrFileOes(FileOES)
  
  var i = 0;
  rewind( FileOES );
  while( next(FileOES) )                     
    if (Trim(FileOES.ErrMsg) != "0" ) 
      i = i + 1;
    end;
  end;

  return i;
end;


/*ИС о неотправленных записях в ФСФМ*/
private macro TF_RecordsInfo_LG_Err
(
  FileOes
)
  var RowErr = GetNumErrFileOes(FileOES);

  if(RowErr > 0)

[ 
  Не включено записей: ##################   
  ┌──────────┬──────────┬──────┬────────────────────┬────────────────────┬────────────────────────────────────────────────┐
  │№ строки в│  Номер   │Валюта│      Сумма         │     Сумма (руб.)   │              Причина исключения                │
  │файле ОЭС │ операции │      │                    │                    │                                                │] 

( RowErr );

  Rewind ( FileOes );
   
  /*var RowId = 1;*/
  while( next(FileOes) )
  var inum = GetPos( FileOes );

  if(Trim(FileOes.ErrMsg) != "0")
[ ├──────────┼──────────┼──────┼────────────────────┼────────────────────┼────────────────────────────────────────────────┤ 
  │ ######## │##########│######│####################│####################│################################################│]
( inum,         /*№ строки в файле ОЭС  B1  Порядковый номер строки в файле ОЭС включенной в ТФ.*/
  FileOes.NUMB_P,  /*Номер операции        B2  Поле NUMB_P из принятого файла записи <B1>.*/
  FileOes.CURREN,  /*Валюта                B3  Поле CURREN из принятого файла записи <B1>.*/
  FileOes.SUM,     /*Сумма                 B4  Поле SUM из принятого файла записи <B1>.*/
  FileOes.SUME,     /*Сумма (руб.)         B5  Поле SUME из принятого файла записи <B1>.*/
  FileOes.ERRMSG:w
);
  end;


  /*RowId = RowId + 1;*/
  end;  

[ └──────────┴──────────┴──────┴────────────────────┴────────────────────┴────────────────────────────────────────────────┘];

  end; 
end;


/*ИС об отправленных записях в ФСФМ*/
private macro TF_RecordsInfo_LG
(
  OesFileName, /*Файл от филиала:    A1   Имя принятого файла.  fm_fileimport.Name*/
  DateImport,  /*Дата:               A2   Время и дата получения файла. fm_fileimport.DateImport*/
  TimeImport,  /*                         Время получения файла - время выполнения процедуры импорта. fm_fileimport.TimeImport*/
  DprtCode,    /*Филиал:  A3   Код (наименование) филиала, от которого получен файл. */
                                          /* определяем по полю fm_fileimport.Department*/
  DprtName,    /*  A4   Полное наименование филиала, от которого получен файл.  определяем по 
                         полю fm_fileimport.Department*/
  RowImport,   /*Количество записей: A5 Количество записей файла  fm_fileimport.RowImport*/
  NameTF,      /*Файл в ФСФМ:         A6 Имя сформированного ТФ  fm_fileimport.NameTF*/
  TF_FormDate, /* Дата:         A7 Системное время и дата окончания процедуры формирования ТФ. */
  RowExport,   /*A8 Количество записей из файла филиала, включенных в ТФ. fm_fileimport.RowExport*/
  OperName     /*A10  ФИО пользователя сформировавшего файл в ФСФМ. Текущий операционист. определяем по полю fm_fileimport.Oper*/
)

/*Имя текстового файла формируется из имени полученного от филиала файла путем замены значения 
позиции Р на "9".*/


[ 
  Протокол отправки данных в ФСФМ 
    
  Файл от филиала:    ################## 
  Дата:               ############################
  Филиал:             ##########   ##############
  Количество записей: ########## 

  Файл в ФСФМ:      ##################
  Дата:             #################
]
( OesFileName,  DateImport + " " + TimeImport, DprtCode, DprtName, RowImport, NameTF, TF_FormDate );


  if(RowExport > 0 )
[ Включено записей: ##################   
  ┌──────────┬──────────┬──────┬────────────────────┬────────────────────┐
  │№ строки в│  Номер   │Валюта│      Сумма         │     Сумма (руб.)   │
  │файле ОЭС │ операции │      │                    │                    │] 

( RowExport );
  end;
  
  file TFile ( ) dbf;
  file FileOes( ) dbf;

  var DIR_OUT_Path, DIR_IMPWORK_Path, stat;
  GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_OUT", V_STRING, DIR_OUT_Path, stat);
  if( stat != 0 ) 
    MsgBox ("Ошибка чтения настройки ФИНМОНИТОРИНГ\\DIR_OUT"); 
  end;
  
  
  if( SubStr( DIR_OUT_Path, strlen( DIR_OUT_Path )) != "\\" )
    DIR_OUT_Path = DIR_OUT_Path + "\\";
  end;
  
 
  if( not open( TFile, DIR_OUT_Path + NameTF ))
    msgbox("Настройка реестра ФИНМОНИТОРИНГ\\DIR_OUT задана неверно,|| или транспортный файл не может быть открыт!!!"); 
    return 1;
  end;

  GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_IMPWORK", V_STRING, DIR_IMPWORK_Path, stat);
  if( stat == 0 )   
    if( SubStr( DIR_IMPWORK_Path, strlen( DIR_IMPWORK_Path )) != "\\" )
      DIR_IMPWORK_Path = DIR_IMPWORK_Path + "\\";
    end;
    
    open( FileOes, DIR_IMPWORK_Path + OesFileName );    
  end;


  /*var RowId = 1;*/
  while( next(TFile) )
[ ├──────────┼──────────┼──────┼────────────────────┼────────────────────┤ 
  │ ######## │##########│######│####################│####################│]

( GetPosFileOES(FileOes, TFile.ACTION, TFile.NUMB_P, TFile.DATE_P),         /*№ строки в файле ОЭС  B1  Порядковый номер строки в файле ОЭС включенной в ТФ.*/
  TFile.NUMB_P,  /*Номер операции        B2  Поле NUMB_P из принятого файла записи <B1>.*/
  TFile.CURREN,  /*Валюта                B3  Поле CURREN из принятого файла записи <B1>.*/
  TFile.SUM,     /*Сумма                 B4  Поле SUM из принятого файла записи <B1>.*/
  TFile.SUME     /*Сумма (руб.)          B5  Поле SUME из принятого файла записи <B1>.*/
);

  /*RowId = RowId + 1;*/
  end;  

  if(RowExport > 0 )
[ └──────────┴──────────┴──────┴────────────────────┴────────────────────┘];
  end;


  TF_RecordsInfo_LG_Err(FileOes);

[
  Файл в ФСФМ сформировал: ################################## 
](GetNameOper(OperName));
end;




/*ИС о неотправленных записях в ФСФМ*/
private macro TF_RecordsInfo_RAO_Err
(
  FileOes
)
  var RowErr = GetNumErrFileOes(FileOES);

  if(RowErr > 0)

[ 
  Не включено записей: ##################   
  ┌──────────┬──────────┬────────────────────────────────────────────────┐
  │№ строки в│  Номер   │              Причина исключения                │
  │файле ОЭС │ операции │                                                │] 

( RowErr );

  Rewind ( FileOes );
   
  /*var RowId = 1;*/
  while( next(FileOes) )
  var inum = GetPos( FileOes );

  if(Trim(FileOes.ErrMsg) != "0")
[ ├──────────┼──────────┼────────────────────────────────────────────────┤ 
  │ ######## │##########│################################################│]
( inum,         /*№ строки в файле ОЭС  B1  Порядковый номер строки в файле ОЭС включенной в ТФ.*/
  FileOes.NUMB_P,  /*Номер операции        B2  Поле NUMB_P из принятого файла записи <B1>.*/
  FileOes.ERRMSG:w
);
  end;


  /*RowId = RowId + 1;*/
  end;  

[ └──────────┴──────────┴────────────────────────────────────────────────┘];

  end; 
end;

macro TF_RecordsInfo_RAO
(
  OesFileName, /*Файл от филиала:    A1   Имя принятого файла.  fm_fileimport.Name*/
  DateImport,  /*Дата:               A2   Время и дата получения файла. fm_fileimport.DateImport*/
  TimeImport,  /*                         Время получения файла - время выполнения процедуры импорта. fm_fileimport.TimeImport*/
  DprtCode,    /*Филиал:  A3   Код (наименование) филиала, от которого получен файл. */
                                          /* определяем по полю fm_fileimport.Department*/
  DprtName,    /*  A4   Полное наименование филиала, от которого получен файл.  определяем по 
                         полю fm_fileimport.Department*/
  RowImport,   /*Количество записей: A5 Количество записей файла  fm_fileimport.RowImport*/
  NameTF,      /*Файл в ФСФМ:         A6 Имя сформированного ТФ  fm_fileimport.NameTF*/
  TF_FormDate, /* Дата:         A7 Системное время и дата окончания процедуры формирования ТФ. */
  RowExport,   /*A8 Количество записей из файла филиала, включенных в ТФ. fm_fileimport.RowExport*/
  OperName,     /*A10  ФИО пользователя сформировавшего файл в ФСФМ. Текущий операционист. определяем по полю fm_fileimport.Oper*/
  Type
)

  var strType;

[ 
  Протокол отправки данных в ФСФМ 
    
  Файл от филиала:    ################## 
  Дата:               ############################
  Филиал:             ##########   ##############
  Количество записей: ########## 

  Файл в ФСФМ:      ##################
  Дата:             #################
]
( OesFileName,  DateImport + " " + TimeImport, DprtCode, DprtName, RowImport, NameTF, TF_FormDate );

 if(Type == FM_OPER_TYPE_REJ_ACC)
   strType = "ОС";
 elif (Type == FM_OPER_TYPE_REJ_OPR)
   strType = "ОО";
 end;

[ Включено записей: ##################   
  Тип операции: ####################
] 
( RowExport, strType );

  
  file TFile ( ) dbf;
  file FileOes( ) dbf;

  var DIR_OUT_Path, DIR_IMPWORK_Path, stat;
  GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_OUT", V_STRING, DIR_OUT_Path, stat);
  if( stat != 0 ) 
    MsgBox ("Ошибка чтения настройки ФИНМОНИТОРИНГ\\DIR_OUT"); 
  end;
  
  
  if( SubStr( DIR_OUT_Path, strlen( DIR_OUT_Path )) != "\\" )
    DIR_OUT_Path = DIR_OUT_Path + "\\";
  end;
  
 
  if( not open( TFile, DIR_OUT_Path + NameTF ))
    msgbox("Настройка реестра ФИНМОНИТОРИНГ\\DIR_OUT задана неверно,|| или транспортный файл не может быть открыт!!!"); 
    return 1;
  end;

  GetRegistryValue("ФИНМОНИТОРИНГ\\DIR_IMPWORK", V_STRING, DIR_IMPWORK_Path, stat);
  if( stat == 0 )   
    if( SubStr( DIR_IMPWORK_Path, strlen( DIR_IMPWORK_Path )) != "\\" )
      DIR_IMPWORK_Path = DIR_IMPWORK_Path + "\\";
    end;
    
    open( FileOes, DIR_IMPWORK_Path + OesFileName );    
  end;

   
  /*var RowId = 1;*/
  if( next(TFile) )
[ Порядковый № сообщения об отказе: ##########
]
( TFile.NUMB_P );
  end;


  TF_RecordsInfo_RAO_Err(FileOes);

[
  Файл в ФСФМ сформировал: ################################## 
](GetNameOper(OperName));
end;
     
macro TF_RecordsInfo
(
  OesFileName, /*Файл от филиала:    A1   Имя принятого файла.  fm_fileimport.Name*/
  DateImport,  /*Дата:               A2   Время и дата получения файла. fm_fileimport.DateImport*/
  DprtCode,    /*Филиал:  A3   Код (наименование) филиала, от которого получен файл. */
                                          /* определяем по полю fm_fileimport.Department*/
  DprtName,    /*  A4   Полное наименование филиала, от которого получен файл.  определяем по 
                         полю fm_fileimport.Department*/
  RowImport,   /*Количество записей: A5 Количество записей файла  fm_fileimport.RowImport*/
  NameTF,      /*Файл в ФСФМ:         A6 Имя сформированного ТФ  fm_fileimport.NameTF*/
  TF_FormDate, /* Дата:         A7 Системное время и дата окончания процедуры формирования ТФ. */
  RowExport,   /*A8 Количество записей из файла филиала, включенных в ТФ. fm_fileimport.RowExport*/
  OperName,     /*A10  ФИО пользователя сформировавшего файл в ФСФМ. Текущий операционист. определяем по полю fm_fileimport.Oper*/
  Type, 
  TimeImport  /*Время получения файла - время выполнения процедуры импорта. fm_fileimport.TimeImport*/
)

  if(Type == FM_OPER_TYPE_LEGAL)
    return TF_RecordsInfo_LG(OesFileName, DateImport, TimeImport, DprtCode, DprtName, RowImport, NameTF, TF_FormDate, RowExport, OperName );
  else 
    return TF_RecordsInfo_RAO(OesFileName, DateImport, TimeImport, DprtCode, DprtName, RowImport, NameTF, TF_FormDate, RowExport, OperName, Type);
  end;
end;

/*│║
 *┌─┬─┐ ╔═╦═╗ ╓─╥─╖╒═╤═╕
 *├─┼─┤ ╠═╬═╣ ╟─╫─╢╞═╪═╡
 *└─┴─┘ ╚═╩═╝ ╙─╨─╜╘═╧═╛
 */



