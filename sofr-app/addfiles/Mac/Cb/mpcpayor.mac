/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v.6.00.020
                 Copyright (c) R-Style Software Lab

  Имя файла        : mpcpayor.mac

  Библиотека       : RSACCOUNT

  Описание         : .

  Программист      : Kirakozov Michael (KMB)

  Создан           : 12.02.2009
-------------------------------------------------------------------------*/
import  mpcpaym,
        BankInter,
        OprInter,
        PaymInter,
        Календарь,
        RsbDataSet,
        "mpclb.mac";

//   ----------------- Оплата требованием ------------------------------

macro Prc_FormClientOrder (PayerFIID, ReceiverFIID, PayerAccount, ReceiverAccount, 
                          PayDate, PaySum, FIID, Ground, CntSchedID, CntOprDocID, PayerSettAcc, ReceiverSettAcc, flagPostDoc)

   var Payment : RsbPayment;
   var ClnPaym : object; /*RsbPSPayOrder*/;
   var Number  : string;
   var RefID;
   var DepID   :integer;
   var PayerBankID :integer;
   var ReceiverBankID :integer;

   var PmAmount = PaySum;

   if( PaySum != 0 )

      ClnPaym = GenObject( "RsbPSPayOrder", 0 );
    
      Payment = ClnPaym.Payment;

      ClnPaym.Origin  = PSPO_OR_PERCENT;
      ClnPaym.Oper    = {oper}; 
      ClnPaym.CurrentState = 0 /*PSPO_ST_DEFERRED*/;
      ClnPaym.DocKind = PSPOKIND_DEMAND;      
      ClnPaym.AcceptTerm = PSPAYDEM_TERM_WITHOUTACCEPT;
      ClnPaym.Accept     = PSPAYDEM_ST_ACCEPT;         
      ClnPaym.LaunchOper = not(flagPostDoc);
      ClnPaym.ReqSum       = PaySum;
      Payment.ShifrOper    = "02";

      if( Prc_FillPayment( Payment, PayerFIID, ReceiverFIID,  PayDate, PaySum,  FIID, flagPostDoc)) 
         return 1; 
      end;
    
      Payment.DocKind   = PS_PAYORDER;
      Payment.Purpose   = PM_PURP_POPRIMARY;
      Payment.Ground = Ground;

      if (ValType(PayerSettAcc) == V_UNDEF)
         DepID = 0;
         PayerBankID = -1;

         if(GetAccountDepartment(PayerAccount, 1, PayerFIID, @DepID) == false)
           MsgBox( "Не нейден филиал счета" );
           return 1;
         end;

         if(GetPartyDpDep(DepID, @PayerBankID) == false)
           MsgBox( "Не нейден субъект счета" );
           return 1;
         end;

         Payment.SetPayerPI(  PAYMENTS_GROUP_INTERNAL,
                           PayerBankID,
                           Payment.PayerBankCodeKind,
                           "",
                           "",
                           "",
                           PayerFIID,
                           1,
                           PayerAccount,
                           -1,
                           "",
                           "",
                           Payment.PayerCodeKind,
                           ""                              
                           );      

      else // using SPI   
         Payment.SetPayerPI(  PAYMENTS_GROUP_UNDEF,
                           PayerSettAcc.BankID,
                           PayerSettAcc.BankCodeKind,
                           PayerSettAcc.BankCode,
                           "",
                           PayerSettAcc.CorrAcc,
                           PayerSettAcc.FIID,
                           PayerSettAcc.Chapter,
                           PayerSettAcc.Account,
                           PayerSettAcc.PartyID,
                           PayerSettAcc.RecName,
                           PayerSettAcc.INN,
                           PayerSettAcc.CodeKind,
                           PayerSettAcc.Code                           
                           );      
      end;

      if (ValType(ReceiverSettAcc) == V_UNDEF)
         DepID = 0;
         ReceiverBankID = -1;

         if(GetAccountDepartment(ReceiverAccount, 1, ReceiverFIID, @DepID) == false)
           MsgBox( "Не нейден филиал счета" );
           return 1;
         end;

         if(GetPartyDpDep(DepID, @ReceiverBankID) == false)
           MsgBox( "Не нейден субъект счета" );
           return 1;
         end;

         Payment.SetReceiverPI(  PAYMENTS_GROUP_INTERNAL,
                                 ReceiverBankID,
                                 Payment.ReceiverBankCodeKind,
                                 "",
                                 "",
                                 "",
                                 ReceiverFIID,
                                 1,
                                 ReceiverAccount,
                                 -1,
                                 "",
                                 "",
                                 Payment.ReceiverCodeKind,
                                 ""                              
                                 );      

    
      else  // using SPI   
         Payment.SetReceiverPI(  PAYMENTS_GROUP_UNDEF,
                                 ReceiverSettAcc.BankID,
                                 ReceiverSettAcc.BankCodeKind,
                                 ReceiverSettAcc.BankCode,
                                 "",
                                 ReceiverSettAcc.CorrAcc,
                                 ReceiverSettAcc.FIID,
                                 ReceiverSettAcc.Chapter,
                                 ReceiverSettAcc.Account,
                                 ReceiverSettAcc.PartyID,
                                 ReceiverSettAcc.RecName,
                                 ReceiverSettAcc.INN,
                                 ReceiverSettAcc.CodeKind,
                                 ReceiverSettAcc.Code                              
                                 );      
      
      end;
      
      
      if (GetReferenceIDByType( 
                                 OBJTYPE_PSPAYORD, /*Рублевый платежный документ*/
                                 REFOBJ_SVORDER,   /*ObjectType = 500; номер требования банка к клиентам (РКО)*/
                                 RefID) != 0 )
    
         MsgBox( "Ошибка при генерации номера требования" );
         return 1;
      end;
    
      if( GenerateReference( RefID, Number ) != 0 )
         MsgBox( "Ошибка при генерации номера требования" );
         return 1;
      else
         Payment.Number = Number;
      end;
     
      PrcSetQuitLink(CntSchedID, Payment, CntOprDocID);
   end;

   return 0;
end;


//    ----------------- Оплата платежом ------------------------------

macro Prc_FormClientPaym (PayerFIID, ReceiverFIID, PayerAccount, ReceiverAccount, 
                          PayDate, PaySum, FIID, Ground, CntSchedID, CntOprDocID, PayerSettAcc, ReceiverSettAcc, flagPostDoc)

   var Payment : RsbPayment;
   var ClnPaym : object; /*RsbPSPayOrder*/;
   var Number  : string;
   var RefID;
   var DepID   :integer;
   var PayerBankID :integer;
   var ReceiverBankID :integer;

   var PmAmount = paySum;

   if( paySum != 0 )

      if( (FIID == NATCUR) AND (PayerFIID == NATCUR) AND (ReceiverFIID == NATCUR) )
         ClnPaym = GenObject( "RsbPSPayOrder", 0 );    

         ClnPaym.Origin  = PSPO_OR_PERCENT;
         ClnPaym.Oper    = {oper}; 
         ClnPaym.CurrentState  = 0 /*CP_ST_DEFERRED*/;
         ClnPaym.DocKind = PSPOKIND_ORDER;
         ClnPaym.LaunchOper = not(flagPostDoc);

         Payment = ClnPaym.Payment;      
      
         Payment.DocKind   = PS_PAYORDER;
         Payment.Purpose   = PM_PURP_POPRIMARY;         
            
      else
         
         ClnPaym = GenObject( "RsbPsCpOrder", 0 );

         ClnPaym.Origin  = PSPO_OR_PERCENT;
         ClnPaym.Oper    = {oper}; 
         ClnPaym.CurrentState  = 0 /*CP_ST_DEFERRED*/;
         ClnPaym.LaunchOper = not(flagPostDoc);

         Payment = ClnPaym.Payment;      
      
         Payment.DocKind   = PS_CPORDER;
         Payment.Purpose   = PM_PURP_POPRIMARY;
        
         Payment.OrderAmount = PaySum;
         Payment.OrderFIID   = FIID;
         
      end; 

      if (Prc_FillPayment(Payment, PayerFIID, ReceiverFIID,  PayDate, PaySum,  FIID, flagPostDoc)) 
         return 1; 
      end;

      if (ValType(PayerSettAcc) == V_UNDEF)
         DepID = 0;
         PayerBankID = -1;

         if(GetAccountDepartment(PayerAccount, 1, PayerFIID, @DepID) == false)
           MsgBox( "Не нейден филиал счета" );
           return 1;
         end;

         if(GetPartyDpDep(DepID, @PayerBankID) == false)
           MsgBox( "Не нейден субъект счета" );
           return 1;
         end;

         Payment.SetPayerPI(  PAYMENTS_GROUP_INTERNAL,
                           PayerBankID,
                           Payment.PayerBankCodeKind,
                           "",
                           "",
                           "",
                           PayerFIID,
                           1,
                           PayerAccount,
                           -1,
                           "",
                           "",
                           Payment.PayerCodeKind,
                           ""                              
                           );      

      else // using SPI   
         Payment.SetPayerPI(  PAYMENTS_GROUP_UNDEF,
                           PayerSettAcc.BankID,
                           PayerSettAcc.BankCodeKind,
                           PayerSettAcc.BankCode,
                           "",
                           PayerSettAcc.CorrAcc,
                           PayerSettAcc.FIID,
                           PayerSettAcc.Chapter,
                           PayerSettAcc.Account,
                           PayerSettAcc.PartyID,
                           PayerSettAcc.RecName,
                           PayerSettAcc.INN,
                           PayerSettAcc.CodeKind,
                           PayerSettAcc.Code                              
                           );      
      end;

      if (ValType(ReceiverSettAcc) == V_UNDEF)

         DepID = 0;
         ReceiverBankID = -1;

         if(GetAccountDepartment(ReceiverAccount, 1, ReceiverFIID, @DepID) == false)
           MsgBox( "Не нейден филиал счета" );
           return 1;
         end;

         if(GetPartyDpDep(DepID, @ReceiverBankID) == false)
           MsgBox( "Не нейден субъект счета" );
           return 1;
         end;

         Payment.SetReceiverPI(  PAYMENTS_GROUP_INTERNAL,
                                 ReceiverBankID,
                                 Payment.ReceiverBankCodeKind,
                                 "",
                                 "",
                                 "",
                                 ReceiverFIID,
                                 1,
                                 ReceiverAccount,
                                 -1,
                                 "",
                                 "",
                                 Payment.ReceiverCodeKind,
                                 ""                              
                                 );      
    
      else  // using SPI   
         Payment.SetReceiverPI(  PAYMENTS_GROUP_UNDEF,
                                 ReceiverSettAcc.BankID,
                                 ReceiverSettAcc.BankCodeKind,
                                 ReceiverSettAcc.BankCode,
                                 "",
                                 ReceiverSettAcc.CorrAcc,
                                 ReceiverSettAcc.FIID,
                                 ReceiverSettAcc.Chapter,
                                 ReceiverSettAcc.Account,
                                 ReceiverSettAcc.PartyID,
                                 ReceiverSettAcc.RecName,
                                 ReceiverSettAcc.INN,
                                 ReceiverSettAcc.CodeKind,
                                 ReceiverSettAcc.Code                       
                                 );      
      
      end;

      Payment.Ground = Ground;

      if( GetReferenceIDByType( 
          OBJTYPE_PSPAYORD, /*Рублевый платежный документ*/
          REFOBJ_SVORDER,   /*ObjectType = 500; номер требования банка к клиентам (РКО)*/
          RefID ) != 0 )
    
         MsgBox( "Ошибка при генерации номера требования" );
         return 1;
      end;
    
      if( GenerateReference( RefID, Number ) != 0 )
         MsgBox( "Ошибка при генерации номера требования" );
         return 1;
      else
         Payment.Number = Number;
      end;
   
      PrcSetQuitLink(CntSchedID, Payment, CntOprDocID);
   end;

   return 0;

end;


