/**
 * RS-Bank v.6.20
 * ¥ç âì ®à¤¥à  0402102
 * €¢â®à: ‘¬¨à­®¢
 */

import globals, PaymInter, FIInter, prpmbuff, likepy,
       prcs /*GetPaperKindName*/;

var pr_pmvaltr:TRecHandler = TRecHandler( "pmvaltr.dbt" );

/** 
 * ¥ç âì ª®«®­ª ¬¨
 * ‡ ¬¥­  £«îç­®© ¯ à¥ SetColumn + FlushColumn
 */
private macro arrSize( arr:TArray )
  return arr.size;
end;

private class TColumnPrinter

  private
  var m_Columns:TArray = TArray(),
      m_CurColumn:integer = 0;

  macro SetColumn( n:integer )
    m_CurColumn = n;
  end;

  macro Add( str:string )
    if( m_Columns.value( m_CurColumn ) == null )
      m_Columns.value( m_CurColumn ) = TArray(20);
    end;
    var col:TArray = m_Columns.value( m_CurColumn );
    col.value( col.size ) = str;
  end;

  macro FlushColumn()
    var widths:TArray = TArray,
        col:TArray;
    for( col, m_Columns )
      widths.value( widths.size ) = arrMax( map( col, @strlen ) );
    end;

    var nrows:integer = arrMax( map( m_Columns, @arrSize ) );
    var nrow:integer, ncol:integer;
    for( nrow, 0, nrows-1 )
      for( ncol, 0, m_Columns.size-1 )
        col = m_Columns.value( ncol );
        if( nrow < col.size )
          print( col.value( nrow ) );
          if( ncol < (m_Columns.size - 1) )
            print( mkstr( " ", widths.value(ncol) - strlen( col.value( nrow ) ) ) );
          end;
        elif( ncol < (m_Columns.size - 1) )
          print( mkstr( " ", widths.value(ncol) ) );
        end;
      end;
      println;
    end;
  end;

end;


/**
 * ¥ç âì § £®«®¢ª 
 */
private macro PrintHeader():bool
  [
                                                                                ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                                                                                ³    Š®¤ ä®à¬ë    ³
                                                                                ³¤®ªã¬¥­â  ¯® Š“„³
                                      ÚÄÄÄÄÄÄÄÄÄÄÄÄ¿                            ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       à¤¥à ¯® ¯¥à¥¤ ç¥ æ¥­­®áâ¥©  ü ³############³                            ³     0402102     ³
                                      ÀÄÄÄÄÄÄÄÄÄÄÄÄÙ                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
      ####################
                                                                             ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
    ¨¬¥­®¢ ­¨¥ ¡ ­ª :                                       „……’           ³   ‘ã¬¬  æ¨äà ¬¨    ³]
  ( substr( pr_pmrmprop.rec.Number, 1, 12 ):l,pr_pmrmprop.rec.Date:m:c:f );
  return true;
end;

/**
 * ¥ç âì ¨­ä®à¬ æ¨¨ ® áç¥â å ¨ áã¬¬ å ¤¥¡¥â 
 */
var IsOneRecord:integer = 0;

private macro PrintDebet( order:RsbValueTransOrder ):bool

  var p:TColumnPrinter = TColumnPrinter();
  var arrBankName:TArray = StrSplit2( {Name_Bank}, 44 ),
      i:integer = 0;
  var piList:TArray = order.PIList(PRT_Debet).AsTArray();
  if( piList.size == 0 )
    piList[0] = TRecHandler( "pmaddpi.dbt" );
    piList[0].rec.Account = pr_pmpaym.rec.PayerAccount;
    piList[0].rec.Amount  = pr_pmpaym.rec.Amount;
  end;

  if (piList.size == 1 )
    IsOneRecord = piList.size;
  end;
  
  /*  §¢ ­¨¥ ¡ ­ª  á«¥¢  */
  p.SetColumn( 0 );
  while( ( i < arrBankName.size ) and ( i < ( piList.size * 2 + 1 ) ) )
    p.Add( string( " ", arrBankName.value(i):44:l, " " ) );
    i = i + 1;
  end;

  /* ‘ç¥â  ¨ áã¬¬ë á¯à ¢  */
  p.SetColumn( 1 );
  p.Add( "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" );
  i = 0;
  while( i < piList.size )
    p.Add( string( "³áç¥â ü ", piList.value(i).rec.Account:20:l, "³", piList.value(i).rec.Amount:20:2:r, "³" ) );
    if( i < ( piList.size - 1 ) )
      p.Add( "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³");
    end;
    i = i + 1;
  end;
  p.Add( "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³");
  p.Add( "                            ³                    ³");

  /* ‚ë¢®¤ */
  p.FlushColumn();
  
  return true;

end;

/**
 * ¥ç âì ¨­ä®à¬ æ¨¨ ® áç¥â å ¨ áã¬¬ å ªà¥¤¨â 
 */
private macro PrintCredit( order:RsbValueTransOrder ):bool
  var p:TColumnPrinter = TColumnPrinter();

  var piList:TArray = order.PIList(PRT_Credit).AsTArray();
  if( piList.size == 0 )
    piList[0] = TRecHandler( "pmaddpi.dbt" );
    piList[0].rec.Account = pr_pmpaym.rec.ReceiverAccount;
    piList[0].rec.Amount  = pr_pmpaym.rec.PayAmount;
  end;
  var arrOwnerName:TArray = StrSplit2( pr_pmvaltr.rec.OwnerValues, 44 ),
      i:integer = 0;

  [Š®¬ã ¯à¨­ ¤«¥¦ â æ¥­­®áâ¨:                                Š…„ˆ’          ³                    ³];

  /* ‚« ¤¥«¥æ æ¥­­®áâ¥© á«¥¢  */
  p.SetColumn( 0 );
  
  if(Isonerecord - piList.size == 0 )
    piList.value(0).rec.Amount = "" ;
  end;
                                                            
  while( ( i < arrOwnerName.size ) and ( i < ( piList.size*2 + 1 ) ) )
    p.Add( string( " ", arrOwnerName.value(i):44:l, " " ) );
    i = i + 1;
  end;

  /* ‘ç¥â  ¨ áã¬¬ë á¯à ¢  */
  p.SetColumn( 1 );
  p.Add( "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³" );
  i = 0;
  while( i < piList.size )
    p.Add( string( "³áç¥â ü ", piList.value(i).rec.Account:20:l, "³", IfThenElse(IsOneRecord==1,"                    ",piList.value(i).rec.Amount):20:2:r, "³" ) );
    if( i < ( piList.size - 1 ) )
      p.Add( "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³");
    end;
    i = i + 1;
  end;
  p.Add( "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");

  /* ‚ë¢®¤ */
  p.FlushColumn();
  
  return true;

end;

private macro PrintValuables( order:RsbValueTransOrder ):bool
  var arrGround:TArray = StrSplit2( pr_pmrmprop.rec.Ground, 95, 74, 1 );
  [‘®¤¥à¦ ­¨¥ ®¯¥à æ¨¨: ##########################################################################]
  ( arrGround.value(0) );
  if( arrGround.size > 1 )
    for( var i:integer, 1, arrGround.size-1 )
      [###############################################################################################]
      ( arrGround.value(i):l );
    end;
  end;
  [ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»
   º            ¨¬¥­®¢ ­¨¥ æ¥­­®áâ¥©                     ³    Š®«¨ç¥áâ¢®    ³    ‘ã¬¬  (æ¨äà ¬¨) º];

  var valuables:TArray = order.ValuableList.AsTArray(),
      valuable:TRecHandler;
  for( valuable, valuables )
    [ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
     º #################################################### ³ ##########       ³####################º]
    ( valuable.rec.NameValue:l, valuable.rec.CountValue:r, valuable.rec.AmountValue:20:2:r );
    
  end;
  [ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼];

  return true;
end;

private macro PrintFooter( order:RsbValueTransOrder ):bool
  var arrSum:TArray = StrSplit2( CurToStrAlt( pr_pmpaym.rec.BaseAmount, null, null, int( GetFICode( pr_pmpaym.rec.BaseFIID, FICK_ISONUMBER ) ) ), 95, 60, 1 );
  [‘ã¬¬  ¯à®¯¨áìî á ãª § ­¨¥¬ ¢ «îâë: ############################################################]
  ( arrSum.value(0):l );
  if( arrSum.size > 1 )
    for( var i:integer, 1, arrSum.size-1 )
      [###############################################################################################]
      ( arrSum.value(i):l );
    end;
  end;
  var strRegDoc:string = GetPaperKindName( pr_pmvaltr.rec.PaperKind );
  if( strRegDoc )
    if( trim( pr_pmvaltr.rec.PaperSeries ) )
      strRegDoc = strRegDoc + " á¥à¨¨ " + trim( pr_pmvaltr.rec.PaperSeries );
    end;
    if( trim( pr_pmvaltr.rec.PaperNumber ) )
      strRegDoc = strRegDoc + " ­®¬¥à " + trim( pr_pmvaltr.rec.PaperNumber );
    end;
    if( trim( pr_pmvaltr.rec.PaperIssuer ) )
      strRegDoc = strRegDoc + ", ¢ë¤ ­ " + trim( pr_pmvaltr.rec.PaperIssuer );
    end;
    if( pr_pmvaltr.rec.PaperIssuedDate != date(0,0,0) )
      strRegDoc = strRegDoc + string( ", ", pr_pmvaltr.rec.PaperIssuedDate, " £®¤ ." );
    end;
  end;
  var arrRegDoc:TArray;
  if (pr_pmvaltr.rec.ReceiverNameValues == "")
    strRegDoc = "";
  end;
  arrRegDoc = StrSplit2( strRegDoc, 93, 47, 2 );

  [
   ãå£ «â¥àáª¨© à ¡®â­¨ª   ________________________  ___________________________________________
                                («¨ç­ ï ¯®¤¯¨áì)             (ä ¬¨«¨ï, ¨­¨æ¨ «ë)

   –¥­­®áâ¨ ¯¥à¥¤ ­ë:
   Š áá®¢ë© à ¡®â­¨ª        ________________________  ___________________________________________
                                («¨ç­ ï ¯®¤¯¨áì)             (ä ¬¨«¨ï, ¨­¨æ¨ «ë)

   Š«¨¥­â (à ¡®â­¨ª ¡ ­ª )                             #########################################
                            ________________________  ___________________________________________
                                («¨ç­ ï ¯®¤¯¨áì)             (ä ¬¨«¨ï, ¨­¨æ¨ «ë)

   à¥¤êï¢«¥­ ¤®ªã¬¥­â, ã¤®áâ®¢¥àïîé¨© «¨ç­®áâì: ###############################################
   #############################################################################################
   
   
  ]
  ( pr_pmvaltr.rec.ReceiverNameValues:l, arrRegDoc.value(0):l, arrRegDoc.value(1):l );

  return true;
end;

/**
 * ¥ç âì ®¤­®© ª®¯¨¨ ¤®ªã¬¥­â 
 */
private macro PrintOneDocument( order:RsbValueTransOrder ):bool
  var stat:bool = PrintHeader();
  if( stat )
    stat = PrintDebet( order );
  end;
  if( stat )
    stat = PrintCredit( order );
  end;
  if( stat )
    stat = PrintValuables( order );
  end;
  if( stat )
    stat = PrintFooter( order );
  end;

  return stat;
end;


macro PrintDocument( ncopy:integer ):bool
  var i:integer = 0,
      stat:bool = true,
      order:RsbValueTransOrder = RsbValueTransOrder( pr_pmpaym.rec.PaymentID );
  while( ( i < ncopy ) and stat );
    stat = PrintOneDocument( order );
    i = i + 1;
  end;
  return stat;
end;