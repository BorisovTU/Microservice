/*
$Name:             prpmori.mac 
$Module:           
$Description:      ¥ç âì ¯« â¥¦­®£® ®à¤¥à .
                   à®£à ¬¬¨áâ    : ‘¬¨à­®¢ ‘.‚. SMR PRN     
                   ‘®§¤ ­         : 11.10.02   
*/

import prpm, gnd120p, "pmlib.mac", "pmbudg_lib.mac";

macro „ â „„ŒŒƒƒƒƒ( dateInit )
  var day, mon, year;
  DateSplit(dateInit, day, mon, year );
  return StrSubst(string(day:2, ".", mon:2, ".", year:4), " ", "0");
end;

/* ¥ç âì ¯« â¥¦­®£® ®à¤¥à  ¯® 1256-“ */
MACRO PrintPayOrder1256(ncopy:integer):bool

  var payerProps   :TPartyProperties = TPartyProperties("Payer",    pr_pmpaym_part, pr_pmprop_part, pr_pmrmprop);
  var receiverProps:TPartyProperties = TPartyProperties("Receiver", pr_pmpaym_part, pr_pmprop_part, pr_pmrmprop);
  var ground       :string, 
      rest         :moneyl,
      shortSum     :string,
      shortRestSum :string,
      payKind      :string,
      pINN         :string,
      pKPP         :string,
      rINN         :string,
      rKPP         :string,
      IsBudg       :bool = IsBudgetPaym(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmpaym_part.rec.PayType);

  ARRAY SS, SG, SBP, SBR, SP, SR, UIN;
      
  payerProps.Name            = pr_pmrmprop_part.rec.PayerName;
  payerProps.INN             = pr_pmrmprop_part.rec.PayerINN;
  payerProps.Account         = pr_pmpaym_part.rec.PayerAccount;
  
  splitINN_KPP(payerProps.INN,    pINN, pKPP);
  splitINN_KPP(receiverProps.INN, rINN, rKPP);

  rest = pr_pmpaym_part.rec.PartPaymRestAmountMain;

  /* ®«ãç¨¬ áã¬¬ã ®áâ âª  ¨áå®¤­®£® ¯« â¥¦­®£® ¤®ªã¬¥­â , ¥á«¨ ®­ ¥áâì */
  
  ground = InterpretGround( pr_pmrmprop_part.rec.Ground );
  
  /* ‘ã¬¬  ¤®ªã¬¥­â  ç áâ¨ç­®© ®¯« âë à §¤¥«ï¥âáï á¨¬¢®«®¬ "=", 
       áã¬¬  ®áâ âª  ¯« â¥¦  - á¨¬¢®«®¬ "-"  */
  shortSum = String(MoneyL(pr_pmpaym_part.rec.Amount));
  StrSet(shortSum, StrBrk(shortSum, ".,"), "=");

  shortRestSum = string(rest);
  if( (rest == $0.0) or (StrBrk(shortRestSum, ".,") == 1) )
    shortRestSum = "0" + shortRestSum;
  end;
  StrSet(shortRestSum, StrBrk(shortRestSum, ".,"), "-");

  payKind = pr_pmpaym_part.rec.ContentOperation;
  payKind = GetContentOperationString(payKind, pr_pmpaym_part, true);

  strsplit( PayerProps.Name ,                       SP,  44, 44, 4 );
  strsplit( PayerProps.BankName,                    SBP, 44, 44, 3 );
  strsplit( ReceiverProps.Name,                     SR,  44, 44, 4 );
  strsplit( ReceiverProps.BankName,                 SBR, 44, 44, 3 );
  strsplit( CurToStrAlt(pr_pmpaym_part.rec.Amount, null, null, GetISOCode(pr_pmpaym_part.rec.FIID)), SS,  68, 68, 3 );
  strsplit( ground,                                 SG,  51, 51, 4 );
  strsplit( GetUIN( pr_pmrmprop.rec.Date, pr_pmrmprop.rec.UIN, pr_pmpaym.rec.PayType ), UIN, 13, 13, 2 );

  if(not pr_pmrmprop_part.rec.TaxAuthorState)
    pr_pmrmprop_part.rec.BttTICode   =
    pr_pmrmprop_part.rec.OKATOCode   =
    pr_pmrmprop_part.rec.TaxPmGround =
    pr_pmrmprop_part.rec.TaxPmPeriod =
    pr_pmrmprop_part.rec.TaxPmNumber =
    pr_pmrmprop_part.rec.TaxPmDate   =
    pr_pmrmprop_part.rec.TaxPmType   = "";
  end;

  while(ncopy != 0)
    [
                                                                           ÚÄÄÄÄÄÄÄÄÄ¿
                                                                           ³ 0401066 ³
                                                                           ÀÄÄÄÄÄÄÄÄÄÙ

                                             ##########  #############          ÚÄÄÄÄ¿
      ‹€’…†›‰ „… N ###################  ÄÄÄÄÄÄÄÄÄÄ  ÄÄÄÄÄÄÄÄÄÄÄÄÄ          ³ ## ³
                                                („ â )   (‚¨¤ ¯« â¥¦ )          ÀÄÄÄÄÙ

     ÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ‘ã¬¬    ³#############################################################################
      ¯à®¯¨áìî³#############################################################################
              ³#############################################################################
     ÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ˆ ########### ³ Š #########                      ³‘“ŒŒ€  ³#########################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
                                                           ³       ³
      ##################################################   ³       ³
      ##################################################   ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ##################################################   ³‘ç.N.  ³#########################
      ##################################################   ³       ³
      ‹€’…‹œ™ˆŠ                                           ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ##################################################   ³ ˆŠ   ³#########################
      ##################################################   ÃÄÄÄÄÄÄÄ´
      ##################################################   ³ ‘ç.N. ³#########################
      €Š ‹€’…‹œ™ˆŠ€                                     ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ##################################################   ³ ˆŠ   ³#########################
      ##################################################   ÃÄÄÄÄÄÄÄ´
      ##################################################   ³ ‘ç.N. ³#########################
      €Š ‹“—€’…‹Ÿ                                      ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ˆ ########### ³ Š #########                      ³ ‘ç.N. ³#########################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
                                                           ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄ
      ##################################################   ³‚¨¤ ¯.³####         ³ç¥à.¯«.³###
      ##################################################   ³       ³             ³        ³
      ##################################################   ÃÄÄÄÄÄÄÄ´             ÃÄÄÄÄÄÄÄÄ´
      ##################################################   ³ §.¯«.³             ³¥§.¯®«¥³
      ®«ãç â¥«ì                                           ³       ³             ³        ³
     ÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´             ³        ³
      N ç.   ³ ˜¨äà ¯« â. ³   N ¯« â.        ³  „ â  ¯« â. ³ Š®¤   ³#############³        ³
      ¯« â.  ³  ¤®ª.      ³   ¤®ª.           ³   ¤®ª.      ³       ³#############³        ³
             ³            ³                  ³             ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄ
      ###    ³  ######    ³ ###############  ³  ########## ³ ‘ã¬¬  ³ 
     ÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄ´®áâ.¯«.³ #########################
      ‘®¤¥à¦ ­¨¥ ®¯¥à æ¨¨        ################          ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄ
      #################### ³ ########### ³ ## ³ ########## ³ ############### ³ ########## ³ ##
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄ
         §­ ç¥­¨¥ ¯« â¥¦                                          ³ â¬¥âª¨ ¡ ­ª 
       ########################################################### ³ ##########



    ]
     (replace(string(pr_pmrmprop_part.rec.Date:f/*pr_pmpaym_part.rec.ValueDate:f*/), "-", "."):c, 
      GetPaymentKind(pr_pmrmprop_part.rec.PaymentKind):c, 
      pr_pmrmprop_part.rec.Number:l, pr_pmrmprop_part.rec.TaxAuthorState, SS(0):l, SS(1):l, SS(2):l,
      Str0(pINN, IsBudg), Str0(pKPP, IsBudg), pr_pmpaym_part.rec.Amount:l:f,
      SP(0):l, SP(1):l, SP(2):l, PayerProps.Account:l, SP(3):l,
      SBP(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,PayerProps.BankBIC):l,    SBP(1):l, SBP(2):l, PayerProps.BankCorrAccount:l,
      SBR(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,ReceiverProps.BankBIC):l, SBR(1):l, SBR(2):l, ReceiverProps.BankCorrAccount:l,
      Str0(rINN, IsBudg), Str0(rKPP, IsBudg), ReceiverProps.Account:l,
      SR(0):l, pr_pmrmprop_part.rec.ShifrOper:l, pr_pmrmprop_part.rec.Priority:l,
      SR(1):l, SR(2):l, SR(3):l, 
      UIN(0),
      UIN(1),
      pr_pmpaym_part.rec.PartPaymNumber:l, 
      pr_pmpaym_part.rec.PartPaymShifrMain:c, 
      pr_pmpaym_part.rec.PartPaymNumMain:c, 
      replace(string(pr_pmpaym_part.rec.PartPaymDateMain:f), "-", "."):c, 
      shortRestSum:l, payKind:l, 
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, Str0(pr_pmrmprop_part.rec.BttTICode,   IsBudg), ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, Str0(pr_pmrmprop_part.rec.OKATOCode,   IsBudg), ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, Str0(pr_pmrmprop_part.rec.TaxPmGround, IsBudg), ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, Str0(pr_pmrmprop_part.rec.TaxPmPeriod, IsBudg), ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, Str0(pr_pmrmprop_part.rec.TaxPmNumber, IsBudg), ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, Str0(pr_pmrmprop_part.rec.TaxPmDate,   IsBudg), ""),
      GetForm110Str(pr_pmrmprop),
      ground:l:w, pr_pmpaym_part.rec.PayerBankMarkDate:f );
      //SG(0):l, SG(1):l, SG(2):l, SG(3):l );

    ncopy = ncopy - 1;
  end;
  
  return TRUE;
  
END;

MACRO PrintPayOrder(ncopy:integer):bool
  var isPrintEOF:bool;               // ¥ç âì á¨¬¢®«  ®ª®­ç ­¨ï «¨áâ 
  if( not GetParm( 1, isPrintEOF ) ) // ¯® ã¬®«ç ­¨î ¯¥ç â âì ­ ¤®
    isPrintEOF = true;
  end;        
  if( pr_PrintEA )
    PrintEAHeader();
  end;
  var stat = 0;
  stat = PrintPayOrder1256(ncopy);
  if( isPrintEOF )
    PrintEOF();
  end;
  return stat;
END;