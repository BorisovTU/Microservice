import ws_rscore2ikfl_lib, ws_lib_fun;
import rsd, oralib, likepy;
import BankInter, PTInter;

private macro SQL_NVL( Val : variant, SubstVal : variant ) : variant

  var RetVal = Val;

  if( (Val == null) or (Val == nullval) )
    RetVal = SubstVal;
  end;

  return RetVal;

end;

/*
    функция инициализации объекта TWsGetBankListRequest параметрами сервиса
 */
private macro FillGetBankListRequest( Request, wsGetBankListRequest : TWsGetBankListRequest )

  var ParamN      : integer;
  var ObjectName  : string;
  ParamN     = 1;
  ObjectName = "";
  
  WS_SetAttributeValue( @wsGetBankListRequest.Position , ParamN, ObjectName, "Position" , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue( @wsGetBankListRequest.CodeBIC  , ParamN, ObjectName, "CodeBIC"  , Request, V_STRING , false, ""  , true);
  WS_SetAttributeValue( @wsGetBankListRequest.CodeSWIFT, ParamN, ObjectName, "CodeSWIFT", Request, V_STRING , false, ""  , true);
  WS_SetAttributeValue( @wsGetBankListRequest.FromRow  , ParamN, ObjectName, "FromRow"  , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue( @wsGetBankListRequest.Rows     , ParamN, ObjectName, "Rows"     , Request, V_INTEGER, false, null, true);

end;

private macro SelectCodeBIC( PartyID )

  var query = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i = 0;

  var CodeBIC : string;
      CodeBIC = "";

  query =         " SELECT t_Code        ";
  query = query + "   FROM dpartcode_dbt ";
  query = query + "  WHERE t_PartyID = ? ";
  query = query + "    AND t_CodeKind = 3";
         
  params = makeArray(SQLParam("", PartyID));
        
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    CodeBIC = rs.value(0);
  end;
 
  return CodeBIC;
end;

private macro SelectCodeSWIFT( PartyID )

  var query = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i = 0;

  var CodeSWIFT : string;
      CodeSWIFT = "";

  query =         " SELECT t_Code         ";
  query = query + "   FROM dpartcode_dbt  ";
  query = query + "  WHERE t_PartyID = ?  ";
  query = query + "    AND t_CodeKind = 6";
         
  params = makeArray(SQLParam("", PartyID));
        
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    CodeSWIFT = rs.value(0);
  end;
         
  return CodeSWIFT;
end;

private macro SelectLatName( PartyID )

  var query = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i = 0;

  var Name : string;
      Name = "";

  query =         " SELECT t_Name          ";
  query = query + "   FROM dpartyname_dbt  ";
  query = query + "  WHERE t_PartyID = ?   ";
  query = query + "    AND t_NameTypeID = 3";
         
  params = makeArray(SQLParam("", PartyID));
        
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Name = rs.value(0);
  end;
         
  return Name;
end;

private macro SelectPostAddress( PartyID )

  var query = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i = 0;

  var Adress : string;
      Adress = "";

  query =         " SELECT t_Adress     ";
  query = query + "   FROM dadress_dbt ";
  query = query + "  WHERE t_PartyID = ?";
  query = query + "    AND t_Type = 1   ";
         
  params = makeArray(SQLParam("", PartyID));
        
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Adress = rs.value(0);
  end;
         
  return Adress;
end;

private macro SelectIntAddress( PartyID )

  var query = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i = 0;

  var Adress : string;
      Adress = "";

  query =         " SELECT t_Adress     ";
  query = query + "   FROM dadress_dbt ";
  query = query + "  WHERE t_PartyID = ?";
  query = query + "    AND t_Type = 2   ";
         
  params = makeArray(SQLParam("", PartyID));
        
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Adress = rs.value(0);
  end;
         
  return Adress;
end;

private macro SelectCorrAccount_BIC_RCC( CorrAccount : @string, BIC_RCC : @string, PartyID )

  var query = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i = 0;

      CorrAccount = "";
      BIC_RCC     = "";

  query =         " SELECT t_CorAcc, t_BIC_RCC ";
  query = query + "   FROM dbankdprt_dbt       ";
  query = query + "  WHERE t_PartyID = ?       ";
         
  params = makeArray(SQLParam("", PartyID));
        
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    CorrAccount = rs.value(0);
    BIC_RCC = rs.value(1);
  end;
         
end;

/*
    Сервис GetBankList - Передать справочник банков

    Параметры:
        Request  - Параметры запроса к БД
 */
MACRO GetBankList( Request )

  var query = "";
  var wrapquery = "";
  var rs;
  var params : TArray;
      params = TArray;
  var i, j;

  var wsGetBankListRequest : TWsGetBankListRequest;
      wsGetBankListRequest = TWsGetBankListRequest;

  var newElem;
  var Response;
  var CorrAccount : string;
  var BIC_RCC     : string;

  var NotResident : string;
  var FullName    : string;
  var ShortName   : string;
  var Country     : string;

  FillGetBankListRequest( Request, @wsGetBankListRequest);

  query =         "SELECT party.t_PartyID PartyID, party.t_NotResident NotResident, party.t_Name Name, ";
  query = query + "       party.t_ShortName ShortName, party.t_NRCountry NRCountry                   ";
  query = query + "      ,ROWNUM AS rnum";
  query = query + "  FROM dparty_dbt party, dpartyown_dbt own        ";
  query = query + " WHERE own.t_PartyID = party.t_PartyID            ";
  query = query + "   AND own.t_PartyKind = 2                   ";
  if(wsGetBankListRequest.Position == 0 )
    query = query + " AND party.t_NRCountry IN (CHR(1), 'RUS')       ";
  end;
  if(wsGetBankListRequest.Position == 1 )
    query = query + " AND party.t_NRCountry NOT IN (CHR(1), 'RUS')   ";
  end;

  if(wsGetBankListRequest.CodeBIC != null )
    query = query + " AND party.t_PartyID IN ( SELECT ptc.t_PartyID FROM dpartcode_dbt ptc  ";
    query = query + "                           WHERE ptc.t_Code = ? AND ptc.t_CodeKind = 3 )";
    i = params.size;
    params[i] = SQLParam("",wsGetBankListRequest.CodeBIC);
  end;

  if(wsGetBankListRequest.CodeSWIFT != null )
    query = query + " AND party.t_PartyID IN ( SELECT ptc.t_PartyID FROM dpartcode_dbt ptc    ";
    query = query + "                           WHERE ptc.t_Code = ? AND ptc.t_CodeKind = 6 )";
    i = params.size;
    params[i] = SQLParam("",wsGetBankListRequest.CodeSWIFT);
  end;
    query = query + " ORDER BY party.t_PartyID ";  

  if(wsGetBankListRequest.FromRow == null)
    wsGetBankListRequest.FromRow = 0;
  end;

  if(wsGetBankListRequest.Rows == null)
    wsGetBankListRequest.Rows = 0;
  end;

  if((wsGetBankListRequest.FromRow >= 0) and (wsGetBankListRequest.Rows == 0))
    wrapquery = wrapquery + "SELECT t.* ";
    wrapquery = wrapquery + "  FROM ( ";
    wrapquery = wrapquery + query;
    wrapquery = wrapquery + "       ) t ";
    wrapquery = wrapquery + " WHERE t.rnum >= ?";

    i = params.size;
    params[i] = SQLParam("", wsGetBankListRequest.FromRow);
  
  elif((wsGetBankListRequest.FromRow == 0) and (wsGetBankListRequest.Rows >= 0))
    wrapquery = wrapquery + "SELECT t.* ";
    wrapquery = wrapquery + "  FROM ( ";
    wrapquery = wrapquery + query;
    wrapquery = wrapquery + "       ) t ";
    wrapquery = wrapquery + " WHERE t.rnum <= ?";

    i = params.size;
    params[i] = SQLParam("", wsGetBankListRequest.Rows);

  elif((wsGetBankListRequest.FromRow >= 0) and (wsGetBankListRequest.Rows >= 0))
    wrapquery = wrapquery + "SELECT * ";
    wrapquery = wrapquery + "  FROM (SELECT t.*, ROWNUM rnum2 ";
    wrapquery = wrapquery + "          FROM ( ";
    wrapquery = wrapquery + query;
    wrapquery = wrapquery + "               ) t ";
    wrapquery = wrapquery + "         WHERE t.rnum < ? ) ";
    wrapquery = wrapquery + "WHERE rnum2 >= ?";

    i = params.size;
    params[i] = SQLParam("", wsGetBankListRequest.FromRow + wsGetBankListRequest.Rows);
    i = params.size;
    params[i] = SQLParam("", wsGetBankListRequest.FromRow);

  else
    wrapquery = query;
  end;

  rs = execSQLselect(wrapquery, params, true);
  j = 0;
  while( rs and rs.moveNext() )
    if(j == 0)
      Response = TArray;
    end;

    if( rs.value("NotResident") == nullval ) NotResident = "";
    else                                     NotResident = rs.value("NotResident");
    end;

    if( rs.value("Name") == nullval ) FullName = "";
    else                              FullName = rs.value("Name");
    end;

    if( rs.value("ShortName") == nullval ) ShortName = "";
    else                                   ShortName = rs.value("ShortName");
    end;

    if( rs.value("NRCountry") == nullval ) Country = "";
    else                                   Country = rs.value("NRCountry");
    end;

    newElem = TWsGetBankListResponse;

    newElem.PartyID     = rs.value("PartyID");
    if( NotResident != "X" ) 
      newElem.IsResident = true;
    else
      newElem.IsResident = false;
    end;
    newElem.CodeBIC     = SelectCodeBIC( rs.value("PartyID"));
    newElem.CodeSWIFT   = SelectCodeSWIFT( rs.value("PartyID"));
    newElem.FullName    = FullName;
    newElem.ShortName   = ShortName;
    newElem.LatName     = SelectLatName( rs.value("PartyID"));
    newElem.PostAddress = SelectPostAddress( rs.value("PartyID"));
    newElem.IntAddress  = SelectIntAddress( rs.value("PartyID"));
    SelectCorrAccount_BIC_RCC(@CorrAccount, @BIC_RCC, rs.value("PartyID") );
    newElem.CorrAccount = CorrAccount;
    newElem.BIC_RCC     = BIC_RCC;
    newElem.Country     = Country;
    
    Response[j] = newElem;
    j = j + 1;

  end;

  return Response;

END;


macro GetCurrencyList(Request)
  var wsRequest = TWsGetCurrencyListRequest;
  var i, j, k;
  var query = "";
  var wrapquery = "";
  var rs;
  var params = TArray;
  var newElem;
  var Response;

  WS_SetAttributeValue(@wsRequest.FI_Kinds, 0, "Request", "FI_Kinds", Request, V_GENOBJ , false, null, true);
  WS_SetAttributeValue(@wsRequest.FromRow , 0, "Request", "FromRow" , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue(@wsRequest.Rows    , 0, "Request", "Rows"    , Request, V_INTEGER, false, null, true);

  query = query + "SELECT ";
  query = query + "  t_FIID       ";
  query = query + " ,t_FI_Code    ";
  query = query + " ,t_CCY        ";
  query = query + " ,t_ISO_Number ";
  query = query + " ,t_Name       ";
  query = query + " ,t_Definition ";
  query = query + " ,ROWNUM AS rnum";
  query = query + "  FROM dfininstr_dbt ";

  if(wsRequest.FI_Kinds != null)
    if(GenPropID(wsRequest.FI_Kinds, "size") != -1)
      i = 0;
      k = 0;
      while(i < wsRequest.FI_Kinds.size)

        if(wsRequest.FI_Kinds[i] != null)
          if(k == 0)
            query = query + " WHERE t_FI_Kind IN ( 0 ";
          end;

          query = query + " , ? ";

          j = params.size;
          params[j] = SQLParam("", wsRequest.FI_Kinds[i]);
          k = k + 1;
        end;

        i = i + 1;
      end;
      if(k > 0)
        query = query + " ) ";
      end;
    end;
  else
    query = query + " WHERE t_FI_Kind = ? ";
    
    j = params.size;
    params[j] = SQLParam("", 1);
  end;

  query = query + " ORDER BY t_FIID ";

  if(wsRequest.FromRow == null)
    wsRequest.FromRow = 0;
  end;

  if(wsRequest.Rows == null)
    wsRequest.Rows = 0;
  end;
  
  if((wsRequest.FromRow >= 0) and (wsRequest.Rows == 0))
    wrapquery = wrapquery + "SELECT t.* ";
    wrapquery = wrapquery + "  FROM ( ";
    wrapquery = wrapquery + query;
    wrapquery = wrapquery + "       ) t ";
    wrapquery = wrapquery + " WHERE t.rnum >= ?";

    j = params.size;
    params[j] = SQLParam("", wsRequest.FromRow);

  elif((wsRequest.FromRow == 0) and (wsRequest.Rows >= 0))
    wrapquery = wrapquery + "SELECT t.* ";
    wrapquery = wrapquery + "  FROM ( ";
    wrapquery = wrapquery + query;
    wrapquery = wrapquery + "       ) t ";
    wrapquery = wrapquery + " WHERE t.rnum <= ?";

    j = params.size;
    params[j] = SQLParam("", wsRequest.Rows);

  elif((wsRequest.FromRow >= 0) and (wsRequest.Rows >= 0))
    wrapquery = wrapquery + "SELECT * ";
    wrapquery = wrapquery + "  FROM (SELECT t.*, ROWNUM rnum2 ";
    wrapquery = wrapquery + "          FROM ( ";
    wrapquery = wrapquery + query;
    wrapquery = wrapquery + "               ) t ";
    wrapquery = wrapquery + "         WHERE t.rnum < ? ) ";
    wrapquery = wrapquery + "WHERE rnum2 >= ?";

    j = params.size;
    params[j] = SQLParam("", wsRequest.FromRow + wsRequest.Rows);
    j = params.size;
    params[j] = SQLParam("", wsRequest.FromRow);

  else
    wrapquery = query;
  end;

  rs = execSQLselect(wrapquery, params, true);
  j = 0;
  while(rs and rs.moveNext())
    if(j == 0)
      Response = TArray;
    end;

    newElem = TWsGetCurrencyListResponse;

    newElem.FIID          = rs.value(0);
    newElem.FI_Code       = rs.value(1);
    newElem.CCY           = rs.value(2);
    newElem.ISO_Number    = rs.value(3);
    newElem.Name          = rs.value(4);
    newElem.Definition    = rs.value(5);
    //newElem.CountryCode   = rs.value(?);
    Response[j] = newElem;
    j = j + 1;
  end;                         
  
  return Response;
  
end;

private macro _GetAddressTelephone(PartyID, Type, Address : @string, Telephone : @string)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT t_Adress, t_PhoneNumber ";
  query = query + "  FROM dadress_dbt ";
  query = query + " WHERE t_PartyID = ? ";
  query = query + "   AND t_Type = ? ";

  params = makeArray(SQLParam("", PartyID)
                    ,SQLParam("", Type)
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Address   = rs.value(0);
    Telephone = rs.value(1);
  end;
end;

private macro _GetCode(PartyID, CodeKind, Code : @string)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT t_Code ";
  query = query + "  FROM dpartcode_dbt ";
  query = query + " WHERE t_PartyID = ? ";
  query = query + "   AND t_CodeKind = ? ";

  params = makeArray(SQLParam("", PartyID)
                    ,SQLParam("", CodeKind)
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Code = rs.value(0);
  end;
end;

private macro _GetCorrAccount(PartyID, CorrAccount : @string)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT t_CorAcc ";
  query = query + "  FROM dbankdprt_dbt ";
  query = query + " WHERE t_PartyID = ? ";

  params = makeArray(SQLParam("", PartyID)
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    CorrAccount = rs.value(0);
  end;
end;

macro GetDprtList(Request)
  var wsRequest = TWsGetDprtListRequest;

  var i, j, k;
  var query = "";
  /*var wrapquery = "";*/
  var rs;
  var params = TArray;
  var newElem;
  var Response;
  var ConvertedNameMask;

  WS_SetAttributeValue(@wsRequest.Statuses         , 0, "Request", "Statuses"         , Request, V_GENOBJ , false, null, true);
  WS_SetAttributeValue(@wsRequest.DprtCode         , 0, "Request", "DprtCode"         , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue(@wsRequest.DprtPartyNameMask, 0, "Request", "DprtPartyNameMask", Request, V_STRING , false, null, true);

  query = query + "SELECT ";
  query = query + "  dp.t_Code          ";
  query = query + " ,dp.t_Name          ";
  query = query + " ,dp.t_Status        ";
  query = query + " ,dp.t_PartyID       ";
  query = query + " ,dp.t_NodeType      ";
  query = query + " ,dp.t_BranchType    ";
  query = query + " ,dp.t_OpenNodeDate  ";
  query = query + " ,dp.t_CloseNodeDate ";
  query = query + " ,dp.t_ParentCode    ";
  query = query + " ,pt.t_ShortName     ";
  query = query + " ,pt.t_Name          ";
  query = query + " ,pt.t_OKPO          ";
  query = query + "  FROM ";
  query = query + "    ddp_dep_dbt dp ";
  query = query + "   ,dparty_dbt pt ";

  query = query + " WHERE dp.t_PartyID = pt.t_PartyID(+) ";
  
  if(wsRequest.Statuses != null)
    if(GenPropID(wsRequest.Statuses, "size") != -1)
      i = 0;
      k = 0;
      while(i < wsRequest.Statuses.size)

        if(wsRequest.Statuses[i] != null)

          if(k == 0)
            query = query + " AND dp.t_Status IN ( 0 ";
          end;

          query = query + " , ? ";

          j = params.size;
          params[j] = SQLParam("", wsRequest.Statuses[i]);
          k = k + 1;
        end;

        i = i + 1;
      end;
      if(k > 0)
        query = query + " ) ";
      end;
    end;
  end;

  if(wsRequest.DprtCode == null)
    wsRequest.DprtCode = 0;
  end;

  if(wsRequest.DprtPartyNameMask == null)
    wsRequest.DprtPartyNameMask = "";
  end;
  
  if(wsRequest.DprtCode > 0)
    query = query + " AND dp.t_Code = ? ";

    j = params.size;
    params[j] = SQLParam("", wsRequest.DprtCode);
  end;

  if(wsRequest.DprtPartyNameMask != "")
    
    wsRequest.DprtPartyNameMask = StrUpr(wsRequest.DprtPartyNameMask);

    if((index(wsRequest.DprtPartyNameMask, "*") == 0) and (index(wsRequest.DprtPartyNameMask, "?") == 0))

      query = query + " AND UPPER(pt.t_ShortName) LIKE ? || '%' ";

      j = params.size;
      params[j] = SQLParam("", wsRequest.DprtPartyNameMask);

    else

      ConvertedNameMask = ConvertMaskToSQLFormat(wsRequest.DprtPartyNameMask, "UPPER(pt.t_ShortName)", bOR(CSMFL_Mask, CSMFL_Logical, CSMFL_CheckSpaceInMask) );

      query = query + " AND " + ConvertedNameMask;

    end;

  end;

  query = query + " ORDER BY dp.t_Code ";

  rs = execSQLselect(query, params, true);
  j = 0;
  while(rs and rs.moveNext())
    if(j == 0)
      Response = TArray;
    end;

    newElem = TWsGetDprtListResponse;

    newElem.DprtCode          = rs.value(0) ;
    newElem.DprtName          = rs.value(1) ;
    newElem.Status            = rs.value(2) ;
    newElem.PartyID           = rs.value(3) ;
    newElem.NodeType          = rs.value(4) ;
    newElem.BranchType        = rs.value(5) ;
    newElem.OpenNodeDate      = rs.value(6) ;
    newElem.CloseNodeDate     = rs.value(7) ;
    newElem.ParentCode        = rs.value(8) ;
    newElem.DprtPartyName     = SQL_NVL(rs.value(9) , "");
    newElem.DprtPartyFullName = SQL_NVL(rs.value(10), "");
    newElem.OKPO              = SQL_NVL(rs.value(11), "");

    _GetAddressTelephone(newElem.PartyID, PTADDR_LEGAL, @newElem.Address, @newElem.Telephone);

    _GetCode(newElem.PartyID, PTCK_BIC , @newElem.BIC );
    _GetCode(newElem.PartyID, PTCK_OGRN, @newElem.OGRN);
    _GetCode(newElem.PartyID, PTCK_INN , @newElem.INN );

    if(index(newElem.INN, "/") > 0)
      newElem.KPP = substr(newElem.INN, index(newElem.INN, "/") + 1);
      newElem.INN = substr(newElem.INN, 1, index(newElem.INN, "/") - 1);
    end;

    _GetCorrAccount(newElem.PartyID, @newElem.CorrAccount);

    /* корректировка некоторых значений */
    if( newElem.ParentCode == 0 ) newElem.ParentCode = null; end;

    Response[j] = newElem;
    j = j + 1;
  end;                         
  
  return Response;

end;

private macro _CheckPartyID(PartyID)
  var m_PartyID = -1;
  var query, rs;
  var params : TArray;
  query =         "SELECT t_PartyID ";
  query = query + "  FROM dparty_dbt ";
  query = query + " WHERE t_PartyID = :PartyID ";
  params = makeArray(SQLParam("PartyID", PartyID)
                    );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    m_PartyID = rs.value(0);
  end;                         
  return m_PartyID;
end;

private macro _GetSfContr(SfContrID, Response : @TWsClientProductElem)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT ";
  query = query + "   t_ID AS SfContrID ";
  query = query + "  ,t_Number AS SfContrNumber ";
  query = query + "  ,t_DateBegin AS DateBegin ";
  query = query + "  ,t_DateClose AS DateClose ";
  query = query + "  FROM dsfcontr_dbt ";
  query = query + " WHERE t_ID = ? ";

  params = makeArray(SQLParam("", SfContrID)
                    );

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    Response.SfContr = TWsSfContrElem;
    
    Response.SfContr.ID        = rs.value("SfContrID");
    Response.SfContr.Number    = rs.value("SfContrNumber");
    Response.SfContr.DateBegin = rs.value("DateBegin");
    Response.SfContr.DateClose = rs.value("DateClose");
  end;
end;

private macro _GetClntProdObjList(ClientProductID, Response : @TWsClientProductElem)
  var query = "";
  var rs;
  var params : TArray;
  var i;
  var newElem;

  query = query + "SELECT ";
  query = query + "  pco.t_ClntProdObjID AS ClntProdObjID ";
  query = query + " ,pco.t_BeginDate AS BeginDate ";
  query = query + " ,pco.t_EndDate AS EndDate ";
  query = query + " ,pco.t_ObjectType AS ObjectType ";
  query = query + " ,pco.t_ObjectID AS ObjectID ";
  query = query + " ,ob.t_Name AS ObjectName ";
  query = query + " ,pco.t_ObjectNumber AS ObjectNumber ";
  query = query + " ,pco.t_ParentID AS ParentID ";
  query = query + "  FROM ";
  query = query + "    dprdclientobj_dbt pco ";
  query = query + "   ,dobjects_dbt ob ";
  query = query + " WHERE pco.t_ClientProductID = ? ";
  query = query + "   AND ob.t_ObjectType = pco.t_ObjectType ";

  params = makeArray(SQLParam("", ClientProductID)
                    );

  rs = execSQLselect(query, params, true);
  
  i = 0;
  while(rs and rs.moveNext())
    if(i == 0)
      Response.Objects = TArray;
    end;

    newElem = TWsClntProdObjElem;
    
    newElem.ClntProdObjID = rs.value("ClntProdObjID");
    newElem.BeginDate     = rs.value("BeginDate");
    newElem.EndDate       = rs.value("EndDate");
    newElem.ObjectType    = rs.value("ObjectType");
    newElem.ObjectName    = rs.value("ObjectName");
    newElem.ObjectID      = rs.value("ObjectID");
    newElem.ObjectNumber  = rs.value("ObjectNumber");
    newElem.ParentID      = rs.value("ParentID");

    Response.Objects[i] = newElem;
    i = i + 1;
  end;
end;

macro GetClientProductList(Request)
  var wsRequest = TWsGetClientProductListRequest;
  var i, j, k;
  var query = "";
  var rs;
  var params = TArray;
  var newElem;
  var Response;
  var ServiceKind;
  var SfContrID;

  WS_SetAttributeValue(@wsRequest.PartyID    , 0, "Request", "PartyID"    , Request, V_INTEGER, true , null, true);
  WS_SetAttributeValue(@wsRequest.ObjectTypes, 0, "Request", "ObjectTypes", Request, V_GENOBJ , false, null, true);
  WS_SetAttributeValue(@wsRequest.Rows       , 0, "Request", "Rows"       , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue(@wsRequest.OnDate     , 0, "Request", "OnDate"     , Request, V_DATE   , false, null, true);
  WS_SetAttributeValue(@wsRequest.Oper       , 0, "Request", "Oper"       , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue(@wsRequest.Department , 0, "Request", "Department" , Request, V_INTEGER, false, null, true);
  WS_SetAttributeValue(@wsRequest.Roles      , 0, "Request", "Roles"      , Request, V_GENOBJ , false, null, true);

  query = query + "SELECT ";
  query = query + "  pc.t_ClientProductID AS ClientProductID ";
  query = query + " ,pc.t_ProductID AS ProductID ";
  query = query + " ,pp.t_Name AS ProductName ";
  query = query + " ,pp.t_ServiceKind AS ServiceKind ";
  query = query + " ,pc.t_PartyID AS PartyID ";
  //query = query + " ,pcr.t_Role AS Role ";
  query = query + " ,pp.t_ProductKindID AS ProductKindID ";
  query = query + " ,pk.t_Name AS ProductKindName ";
  query = query + " ,pc.t_DocNumber AS DocNumber ";
  query = query + " ,pc.t_Branch AS Branch ";
  query = query + " ,pc.t_BeginDate AS BeginDate ";
  query = query + " ,pc.t_EndDate AS EndDate ";
  query = query + " ,pc.t_ParentClientProductID AS ParentClientProductID ";
  query = query + " ,pc.t_ObjectType AS ObjectType ";
  query = query + " ,ob.t_Name AS ObjectName ";
  query = query + " ,pc.t_ObjectID AS ObjectID ";
  query = query + " ,pc.t_SfContrID AS SfContrID ";
  query = query + "  FROM ";
  query = query + "    dprdclient_dbt pc ";
  query = query + "   ,dprdproduct_dbt pp ";
  //query = query + "   ,dprdclntrole_dbt pcr ";
  query = query + "   ,dprdkind_dbt pk ";
  query = query + "   ,dobjects_dbt ob ";
  query = query + " WHERE pc.t_ProductID = pp.t_ProductID ";
  //query = query + "   AND pcr.t_ClientProductID = pc.t_ClientProductID ";
  //query = query + "   AND pcr.t_PartyID = pc.t_PartyID ";
  query = query + "   AND pk.t_ProductKindID = pp.t_ProductKindID ";
  query = query + "   AND ob.t_ObjectType = pc.t_ObjectType ";

  if(_CheckPartyID(wsRequest.PartyID) < 0)
    RunError("Задано некорректное значение поля: идентификатор/код субъекта", 0);
  else
    query = query + "   AND pc.t_PartyID = ? ";

    j = params.size;
    params[j] = SQLParam("", wsRequest.PartyID);
  end;
/*
  if(wsRequest.Roles != null)
    if(GenPropID(wsRequest.Roles, "size") != -1)
      i = 0;
      k = 0;
      while(i < wsRequest.Roles.size)

        if(wsRequest.Roles[i] != null)
          if(k == 0)
            query = query + " AND pcr.t_Role IN ( 0 ";
          end;

          query = query + " , ? ";

          j = params.size;
          params[j] = SQLParam("", wsRequest.Roles[i]);
          k = k + 1;
        end;

        i = i + 1;
      end;
      if(k > 0)
        query = query + " ) ";
      end;
    end;
  end;
*/
  if(wsRequest.OnDate != null)
    query = query + " AND (? BETWEEN pc.t_BeginDate AND DECODE(pc.t_EndDate, TO_DATE('01010001', 'ddmmyyyy'), TO_DATE('31129999', 'ddmmyyyy'), pc.t_EndDate)) ";

    j = params.size;
    params[j] = SQLParam("", wsRequest.OnDate);
  end;

  if(wsRequest.ObjectTypes != null)
    if(GenPropID(wsRequest.ObjectTypes, "size") != -1)
      i = 0;
      k = 0;

      query = query + " AND ( ";

      while(i < wsRequest.ObjectTypes.size)

        if(wsRequest.ObjectTypes[i] != null)
          if(k == 0)
            query = query + " pc.t_ObjectType IN ( 0 ";
          end;

          query = query + " , ? ";

          j = params.size;
          params[j] = SQLParam("", wsRequest.ObjectTypes[i]);
          k = k + 1;
        end;

        i = i + 1;
      end;
      if(k > 0)
        query = query + " ) ";
      else
        query = query + " (1 = 1) ";
      end;
    
      query = query + " ) ";
    end;
  end;
  
  if((wsRequest.Rows != null) and (wsRequest.Rows >= 0))
    query = query + " AND ROWNUM <= ?";

    j = params.size;
    params[j] = SQLParam("", wsRequest.Rows);
  end;

  query = query + " ORDER BY ";
  query = query + "   pp.t_ProductKindID ";
  if(wsRequest.OnDate != null)
    query = query + " , CASE WHEN ? BETWEEN pc.t_BeginDate AND pc.t_EndDate THEN 0 ELSE 1 END ";
    j = params.size;
    params[j] = SQLParam("", wsRequest.OnDate);
  else
    query = query + " ,pc.t_EndDate ";
  end;
  query = query + " ,pc.t_BeginDate, pc.t_ClientProductID ";

  rs = execSQLselect(query, params, true);
  j = 0;
  while(rs and rs.moveNext())
    if(j == 0)
      Response = TArray;
    end;

    newElem = TWsClientProductElem;

    newElem.ClientProductID = rs.value("ClientProductID");
    newElem.ProductID       = rs.value("ProductID");
    newElem.ProductName     = rs.value("ProductName");

    ServiceKind = rs.value("ServiceKind");
    
    if((ServiceKind == 16) or (ServiceKind == 18))
      newElem.SubsystemCode = "RS-Loans";
    elif((ServiceKind == 10))
      newElem.SubsystemCode = "RS-Retail";
    elif((ServiceKind == 2))
      newElem.SubsystemCode = "RS-Dealing";
    elif((ServiceKind == 1) or (ServiceKind == 7) or (ServiceKind == 8) or (ServiceKind == 14) or (ServiceKind == 15) or (ServiceKind == 17))
      newElem.SubsystemCode = "RS-Securities";
    elif((ServiceKind == 3) or (ServiceKind == 9))
      newElem.SubsystemCode = "RS-Banking";
    end;

    newElem.PartyID               = rs.value("PartyID");
    //newElem.Role                  = rs.value("Role");
    newElem.ProductKindID         = rs.value("ProductKindID");
    newElem.ProductKindName       = rs.value("ProductKindName");
    newElem.DocNumber             = rs.value("DocNumber");
    newElem.DprtService           = rs.value("Branch");
    newElem.DprtOpen              = rs.value("Branch");
    newElem.BeginDate             = rs.value("BeginDate");
    newElem.EndDate               = rs.value("EndDate");
    newElem.ParentClientProductID = rs.value("ParentClientProductID");
    newElem.ObjectType            = rs.value("ObjectType");
    newElem.ObjectName            = rs.value("ObjectName");
    newElem.ObjectID              = rs.value("ObjectID");

    SfContrID = rs.value("SfContrID");

    _GetSfContr(SfContrID, @newElem);

    _GetClntProdObjList(newElem.ClientProductID, @newElem);

    Response[j] = newElem;
    j = j + 1;
  end;                         
  
  return Response;
  
end;