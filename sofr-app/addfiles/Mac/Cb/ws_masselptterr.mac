/*
$Name:           ws_masselptterr.mac
$Module:         Ядро ГКБО
$Description:    Дистрибутивные функции пакетной процедуры проверки на терроризм
*/
import RSD, FMInter, PTInter, "globals.mac", "likepy.mac";

private const FMPTCHK_ALL  = 0;
private const FMPTCHK_KFM  = 1;
private const FMPTCHK_OFAC = 2;
private const TERR_PT_TYPE_LEGAL = 1;
private const TERR_PT_TYPE_PERSN = 2;
private const OBJTYPE_PARTY = 3;

private const CASH_SIZE = 10000;

private macro DeleteCheckInfo(CheckList, CheckTerr, SkipCheckedTerr, CheckAddr, SkipCheckedAddr,  AddCond, cmd, cmd2)
  var strQuery =  "";
  var strWhere = "";
  var insertParm = false;
  /*
  if(  (CheckTerr == "X") AND (SkipCheckedTerr == "") AND ((CheckList == FMPTCHK_ALL) OR (CheckList == FMPTCHK_KFM)))
    strQuery =  "delete from dfmkfmchk_dbt ";

    if( strlen(AddCond) > 0 ) 
      strQuery = strQuery + " where ";
      strQuery = strQuery + AddCond;
    end;

    cmd.CmdText = strQuery;
    cmd.execute();
  end;
  */
  if( (CheckTerr == "X") AND (SkipCheckedTerr == "") AND ((CheckList == FMPTCHK_ALL) OR (CheckList == FMPTCHK_OFAC)))
    strQuery =  "delete from dfmofacchk_dbt ";

    if( strlen(AddCond) > 0 ) 
      strQuery = strQuery + " where ";
      strQuery = strQuery + AddCond;
    end;

    cmd.CmdText = strQuery;
    cmd.execute();
  end;
  /*
  if( (CheckTerr == "X") AND (SkipCheckedTerr == "") )
    strQuery =  "delete from dfmptadrchk_dbt ";

    if( strlen(AddCond) > 0 ) 
      strQuery = strQuery + " where ";
      strQuery = strQuery + AddCond;
    end;

    cmd.CmdText = strQuery;
    cmd.execute();
  end;
  */

  if((CheckTerr == "X") AND (SkipCheckedTerr == "") AND ((CheckList == FMPTCHK_ALL) OR (CheckList == FMPTCHK_OFAC)))
    strQuery =  "delete from dfmpartychk_dbt ";

    /*if(CheckList != FMPTCHK_ALL)*/
      strWhere = strWhere + " t_checklist = :checklist ";
      cmd2.addParam( "", RSDBP_IN, FMPTCHK_OFAC);

      insertParm = true;
    /*end;*/

    if((strlen(AddCond) > 0) OR (strlen(strWhere) > 0))
      strQuery = strQuery + " where ";
    end;

    strQuery = strQuery + AddCond;

    if((strlen(AddCond) > 0) AND (strlen(strWhere) > 0))
      strQuery = strQuery + " and ";
    end;

    strQuery = strQuery + strWhere;

    cmd2.CmdText = strQuery;
    cmd2.execute();
  end;

end;

macro SelectPacketNum(taskID, execID, ConvTypeID, PacketSize, CheckParm)
  var cmd, cmd2,cmdS, rs, rs2;
  var sqlString;
  var PacketNum = 0;

  var CheckTerr = "X";
  var SkipCheckedTerr = "";
               
  var CheckAddr = "";     
  var SkipCheckedAddr = "";

  var iProp = GenPropID( CheckParm, "CheckTerr" );
  if( iProp != -1 )
    CheckTerr = IfThenElse( CheckParm.CheckTerr == 88, "X", "" );
  end;

  iProp = GenPropID( CheckParm, "SkipCheckedTerr" );
  if( iProp != -1 )
    SkipCheckedTerr = IfThenElse( CheckParm.SkipCheckedTerr == 88, "X", "" );
  end;

  iProp = GenPropID( CheckParm, "CheckAddr" );
  if( iProp != -1 )
    CheckAddr = IfThenElse( CheckParm.CheckAddr == 88, "X", "" );
  end;

  iProp = GenPropID( CheckParm, "SkipCheckedAddr" );
  if( iProp != -1 )
    SkipCheckedAddr = IfThenElse( CheckParm.SkipCheckedAddr == 88, "X", "" );
  end;



  var cnvdocCache = RsbSQLInsert("cnvdoc.dbt");

  cmd = RsdCommand();
  cmd2 = RsdCommand();
  cmdS = RsdCommand();

  cmd.NullConversion = true;
  cmd2.NullConversion = true;
  cmdS.NullConversion = true;

  var LegalForm = PTLEGF_ALL;
  var ProcValue = FM_GetTerrorPercent();

  if( CheckParm.PartyType == TERR_PT_TYPE_LEGAL ) 
    LegalForm = PTLEGF_INST;
  else 
    if( CheckParm.PartyType == TERR_PT_TYPE_PERSN ) 
      LegalForm = PTLEGF_PERSN;
    end;
  end;

  var strFrom = " FROM dparty_dbt party "; //  ", dpartyown_dbt partyown"
  var strWhere = " party.t_Locked <> 'X' ";
    
  if(CheckParm.PartyKind != 0)
    strFrom = strFrom + ", dpartyown_dbt partyown";

    if(strlen(strWhere))
        strWhere =  strWhere +" AND "; 
    end;
      strWhere = strWhere + " partyown.t_PartyID = party.t_PartyID AND partyown.t_PartyKind = :PartyKind";

    var PartyKind = CheckParm.PartyKind;
    cmd.addParam( "", RSDBP_IN,  PartyKind);
    cmdS.addParam( "", RSDBP_IN,  PartyKind);
    cmd2.addParam( "", RSDBP_IN,  PartyKind);
  end;

  if( LegalForm != PTLEGF_ALL )
    if(strlen(strWhere))
      strWhere = strWhere + " AND ";
    end;
    strWhere = strWhere + " party.t_LegalForm = :t_LegalForm";

    cmd.addParam( "", RSDBP_IN,  LegalForm);
    cmdS.addParam( "", RSDBP_IN,  LegalForm);
    cmd2.addParam( "", RSDBP_IN,  LegalForm);
  end;

  if(CheckParm.ServiceKind != 0)
    strWhere = strWhere + " AND EXISTS (SELECT 1 "                         ;
    strWhere = strWhere + "   FROM dclient_dbt  "                          ;
    strWhere = strWhere + "  WHERE t_PartyID =  party.t_PartyID"           ;
    strWhere = strWhere + "    AND t_ServiceKind = :t_ServiceKind "        ;
    strWhere = strWhere + "    AND t_StartDate <= :cdate  "                 ;
    strWhere = strWhere + "    AND (t_FinishDate = :zdate OR t_FinishDate >= :cdate2)) ";

    var ServiceKind = CheckParm.ServiceKind;
    var CurDate     = {curdate};
    var ZeroDate    = date(0,0,0);

    cmd.addParam( "", RSDBP_IN,  ServiceKind);
    cmdS.addParam( "", RSDBP_IN,  ServiceKind);
    cmd2.addParam( "", RSDBP_IN,  ServiceKind);

    cmd.addParam( "", RSDBP_IN,  CurDate);
    cmdS.addParam( "", RSDBP_IN,  CurDate);
    cmd2.addParam( "", RSDBP_IN,  CurDate);

    cmd.addParam( "", RSDBP_IN,  ZeroDate);
    cmdS.addParam( "", RSDBP_IN,  ZeroDate);
    cmd2.addParam( "", RSDBP_IN,  ZeroDate);

    cmd.addParam( "", RSDBP_IN,  CurDate);
    cmdS.addParam( "", RSDBP_IN,  CurDate);
    cmd2.addParam( "", RSDBP_IN,  CurDate);
  end;


  var CheckList = CheckParm.List;  
  if( (CheckAddr == "") AND (CheckTerr == "X") AND (SkipCheckedTerr == "X"))
    if(strlen(strWhere))
      strWhere = strWhere + " AND ";
    end;

    strWhere = strWhere + "  NOT EXISTS (SELECT 1 "                        ;
    strWhere = strWhere + "   FROM dfmpartychk_dbt "                       ;
    strWhere = strWhere + "  WHERE t_PartyID =  party.t_PartyID"           ;
    strWhere = strWhere + "    AND t_ProcValue <= :ProcValue  "            ;

    if(CheckParm.List != FMPTCHK_ALL)
      strWhere = strWhere + "    AND t_CheckList = :CheckList "            ;
    end;

    strWhere = strWhere + " ) " ;

    cmd.addParam( "", RSDBP_IN,  ProcValue);
    cmdS.addParam( "", RSDBP_IN,  ProcValue);
    cmd2.addParam( "", RSDBP_IN,  ProcValue);

    if(CheckParm.List != FMPTCHK_ALL)
      cmd.addParam( "", RSDBP_IN,  CheckList);
      cmdS.addParam( "", RSDBP_IN,  CheckList);
      cmd2.addParam( "", RSDBP_IN,  CheckList);
    end;
  end;

  if( (CheckTerr == "") AND (CheckAddr == "X") AND (SkipCheckedAddr == "X"))
    if(strlen(strWhere))
      strWhere = strWhere + " AND ";
    end;

    strWhere = strWhere + "  NOT EXISTS (SELECT 1 "                        ;
    strWhere = strWhere + "   FROM dfmptadrchk_dbt "                       ;
    strWhere = strWhere + "  WHERE t_PartyID =  party.t_PartyID"           ;
    strWhere = strWhere + " ) " ;
  end;

  if((CheckTerr == "X") AND (SkipCheckedTerr == "X") AND (CheckAddr == "X") AND (SkipCheckedAddr == "X"))
   
    if(strlen(strWhere))
      strWhere = strWhere + " AND ";
    end;

    strWhere = strWhere + "(";

    strWhere = strWhere + "  NOT EXISTS (SELECT 1 "                        ;
    strWhere = strWhere + "   FROM dfmpartychk_dbt "                       ;
    strWhere = strWhere + "  WHERE t_PartyID =  party.t_PartyID"           ;
    strWhere = strWhere + "    AND t_ProcValue <= :ProcValue  "            ;

    if(CheckParm.List != FMPTCHK_ALL)
      strWhere = strWhere + "    AND t_CheckList = :CheckList "            ;
    end;

    strWhere = strWhere + " ) " ;

    cmd.addParam( "", RSDBP_IN,  ProcValue);
    cmdS.addParam( "", RSDBP_IN,  ProcValue);
    cmd2.addParam( "", RSDBP_IN,  ProcValue);

    if(CheckParm.List != FMPTCHK_ALL)
      cmd.addParam( "", RSDBP_IN,  CheckList);
      cmdS.addParam( "", RSDBP_IN,  CheckList);
      cmd2.addParam( "", RSDBP_IN,  CheckList);
    end;

    strWhere = strWhere + " OR ";

    strWhere = strWhere + "  NOT EXISTS (SELECT 1 "                        ;
    strWhere = strWhere + "   FROM dfmptadrchk_dbt "                       ;
    strWhere = strWhere + "  WHERE t_PartyID =  party.t_PartyID"           ;
    strWhere = strWhere + " ) " ;

    strWhere = strWhere + ")";
  end;

  // Российские банки исключены из проверок на терроризм и на совпадение адреса с адресом террориста
  strWhere = strWhere + " AND NOT EXISTS (SELECT 1 FROM dbankdprt_dbt bnk, dpartyown_dbt pown WHERE bnk.t_PartyID = party.t_PartyID  ";
  strWhere = strWhere + "                 AND pown.t_PartyID = party.t_PartyID AND bnk.t_CheckData <> chr(1) AND pown.t_PartyKind = 2 )";


  var  sqlCount = "SELECT COUNT(DISTINCT(party.t_PartyID)) as CountRec ";
  sqlCount = sqlCount + strFrom;

  if(strlen(strWhere) > 0)
    sqlCount = sqlCount + " WHERE " ;
    sqlCount = sqlCount + strWhere;
  end;

  cmd.CmdText = sqlCount;

  rs = RsdRecordset(cmd);

  var CountRec = 0;
  if( rs.moveNext() )
    CountRec = rs.value("CountRec");
  end;

  if( CountRec > 0 )
    
    var AddCond = " t_PartyID in (SELECT DISTINCT party.t_PartyID ";
    AddCond = AddCond + strFrom;
    if(strlen(strWhere) > 0)
      AddCond = AddCond + " WHERE " ;
      AddCond = AddCond + strWhere;
    end;
    AddCond = AddCond + ")";

    DeleteCheckInfo(CheckParm.List, CheckTerr, SkipCheckedTerr, CheckAddr, SkipCheckedAddr, AddCond, cmd, cmd2);
    

    sqlString = "SELECT DISTINCT party.t_PartyID AS PartyID ";
    sqlString = sqlString + strFrom;

    if(strlen(strWhere) > 0)
      sqlString = sqlString + " WHERE " ;
      sqlString = sqlString + strWhere;
    end;

    sqlString = sqlString + " ORDER BY PartyID ";

    cmdS.CmdText = sqlString;
    rs2 = RsdRecordset(cmdS);

    var RowNum = 1;
    while( rs2.moveNext() )
      var PartyID = rs2.value("PartyID");

      var cnvdoc = TRecHandler("cnvdoc.dbt");
      ClearRecord( cnvdoc );

      cnvdoc.rec.TaskID     = taskID; 
      cnvdoc.rec.ExecID     = execID; 
      cnvdoc.rec.ConvTypeID = ConvTypeID;
      cnvdoc.rec.PackID     = (int(RowNum/PacketSize))+1; 
      cnvdoc.rec.ObjectType = OBJTYPE_PARTY;
      cnvdoc.rec.ObjectID   = PartyID;
      
      cnvdocCache.AddRecord( cnvdoc );
      if( (int(RowNum/CASH_SIZE)) == (double(RowNum)/double(CASH_SIZE)))
        cnvdocCache.Insert();
        cnvdocCache = RsbSQLInsert("cnvdoc.dbt");
      end;
      RowNum = RowNum + 1;

      PacketNum = cnvdoc.rec.PackID; // последний номер пачки равен числу пачек
    end;

    cnvdocCache.Insert();
  end;


  return PacketNum;
end;
