/*
    sfpaysec.mac

    ПЗО - Корректировка параметров оплаты для БОЦБ

    Оплата комиссий на шаге операции
    Формирование документов шага   
    AV 15.01.04
*/

IMPORT InsCarryDoc, PTInter, "sp_carcm.mac"; 

PRIVATE VAR dl_tick           = TBFile( "dl_tick.dbt" ); 
PRIVATE VAR sfbasobj          = TBFile( "sfbasobj.dbt", "W" );
PRIVATE VAR ReceiverAccount   = TRecHandler( "account.dbt" );

PRIVATE MACRO ПолучитьСделку( sfbasobj )

   dl_tick.Clear();
   dl_tick.KeyNum = 1;
   dl_tick.rec.BOfficeKind = sfbasobj.rec.BaseObjectType;
   dl_tick.rec.DealID    = sfbasobj.rec.BaseObjectID;
   if( dl_tick.GetEQ() == true ) 
      return true;
   end;
   return false;

END;


/*методы пересчета сумм комиссий*/
PRIVATE CONST SFCOMISS_CALCCOMISSSUMALG_CALC       =  1; /* на день расчета    */
PRIVATE CONST SFCOMISS_CALCCOMISSSUMALG_PAY        =  2; /* на день оплаты     */
PRIVATE CONST SFCOMISS_CALCCOMISSSUMALG_BEFOREPAY  =  3; /* перед днем оплаты  */

PRIVATE MACRO ПересчитатьСуммуДляКомиссии( sfcomiss, sfdefcom, Sum, ToFIID )
   var ConvDate = Date(0,0,0);
   if( ToFIID != sfdefcom.FIID_commSum ) 
      /*конвертацию выполним по дате, которую берем в зависимости от алгоритма, заданного в комиссии*/
      if( sfcomiss.CalcComissSumAlg == SFCOMISS_CALCCOMISSSUMALG_CALC )
         ConvDate = sfdefcom.dateFee;
      elif( sfcomiss.CalcComissSumAlg == SFCOMISS_CALCCOMISSSUMALG_PAY )
         ConvDate = sfdefcom.datePay;
      elif( sfcomiss.CalcComissSumAlg == SFCOMISS_CALCCOMISSSUMALG_BEFOREPAY )
         ConvDate = sfdefcom.datePay-1;
      end;         
      if( SmartConvertSum( Sum, Sum, ConvDate, sfdefcom.FIID_commSum, ToFIID, true ) == false )
         return $0;
      end;
   end;
   return Sum;
END;

PRIVATE MACRO ИнициализироватьНаименованияПортфелей( НаименованияПортфелей )
  var llval = TBFile( "llvalues.dbt" );
  var i = 0;
  while( i <= KINDPORT_UNADMITTED ) /*зануляем суммы для всех типов портфелей */ 
     llval.Clear(); 
     llval.KeyNum = 0;
     llval.rec.List     = OBJTYPE_KINDPORT;
     llval.rec.Element  = i;
     if(llval.GetEQ)
        НаименованияПортфелей[i] = llval.rec.Name;
     else 
        НаименованияПортфелей[i] = "";
     end; 
     i = i + 1;
  end; 
END;


PRIVATE MACRO ИнициализироватьЭлементМассива( СуммыКомиссий )
   
  var i = 0;

  while( i <= KINDPORT_UNADMITTED ) /*зануляем суммы для всех типов портфелей */ 
     СуммыКомиссий[i] = $0;
     i = i + 1;
  end; 
END;

private record accTax(account);
private record accTransit(account);

PRIVATE MACRO ВыполнитьУчетЗатрат( FD, CategName, ConvOutlayComm, Doc, Numb_Document, Ground, sfcomiss, sfdefcom, sicredit )

   var isTransitAcc = 0;   /* Признак использования транзитного счета */
   var CredOutlayComm = $0, FIRole; 

   if( FD.KindPortf == KINDPORT_TRADE )
      FIRole = FIROLE_BA_TP;
   elif( FD.KindPortf == KINDPORT_SALE )
      FIRole = FIROLE_BA_PPR;
   elif( FD.KindPortf == KINDPORT_PROMISSORY )
      FIRole = FIROLE_BAINPROMISSORY;
   elif( FD.KindPortf == KINDPORT_RETIRE )
      FIRole = FIROLE_BA_PUDP;
   elif( FD.KindPortf == KINDPORT_CONTR )
      FIRole = FIROLE_BAINCONTR;
   else
      FIRole = null;
   end;

   clearrecord( accTransit );

   if(SfGetCategoryAccountsByPmPaym(   sfdefcom.FeeType,
                                       sfdefcom.Id,
                                       accTax,
                                       accTransit,
                                       isTransitAcc,
                                       NULL, /*PayNDS*/
                                       NULL  /*MultyMetodID*/              
                                        ))
     msgbox("Ошибка при определении параметров взимания ПЗО");
     return false;
   end;

   if( not FD.OpenAccount( CategName, null, null, FIRole, null, sfdefcom.DatePay ) )
      return false;
   end;

   CredOutlayComm = ПересчитатьСуммуДляКомиссии( sfcomiss, sfdefcom, ConvOutlayComm, sicredit.rec.FIID );

   if( isTransitAcc == 0 )
      if( not GetAccount( 1, sicredit.rec.FIID, sicredit.rec.Account, ReceiverAccount ) ) 
         return false;
      end;
   else /*через транзитный счет*/
      copy( ReceiverAccount, accTransit );
   end;                                         

   if(not ПроводкаПоКатегориямУчета( FD, 
          CategName, ReceiverAccount, /* КатегДеб , КатегКредит*/
          sfdefcom.DatePay,      /* Дата */
          1,                     /* Глава */
          NATCUR,                /* Валюта суммы проводки */
          ConvOutlayComm,        /* Сумма проводки*/
          Doc,                   /* Документ */
          INPCARRY,              /* Result_Carry */
          "",                    /* Kind_Oper */
          Numb_Document,         /* Numb_Document */
          Ground,                /* Ground */
          0, NULL, NULL, 
          NATCUR, ReceiverAccount.rec.Code_Currency, CredOutlayComm               
         ) )
       return false;
   end;
   return true;

END;

/* пробежаться по sfbasobj и собрать сумму комиссий и сумму НДС.  */
/* если записей нет, то возвращает 1, иначе 0                     */
/* - сформировать дополнительные проводки,                        */
/* - скорректировать затраты в лотах,                             */
/* - скорректировать OutlayComm                                   */
MACRO СкорректироватьПараметрыОплатыКомиссийДляБОЦБ( Doc, sfcomiss, sfdefcom, sicredit, SumCom, SumNDS )
   
  var stat;
  var СуммыКомиссий = TArray();           /*двумерный массив сумм комиссий, относимых на затраты: по ТП, по ИП и по ПКУ в разрезе ценных бумаг*/
  var НаименованияПортфелей = TArray();   /*массив с наименованиями портфелей*/
  var ОстатокНаЛоте = $0, ПроданоСЛота = $0;
  var FD, i = 0, j = 0, MaxPFI = 0; 
  var ConvOutlayComm = $0, ExistSfBasObj = false, УчитыватьВЗатратах, err = 0;
  var OutlayComm = $0;
  var OperGroup;

  ИнициализироватьНаименованияПортфелей( НаименованияПортфелей );

  /*получим значение настройки*/ 
  if( GetRegistryValue( "SECUR\\УЧЕТ РАСПРЕДЕЛЯЕМЫХ КОМИССИЙ", V_BOOL, УчитыватьВЗатратах, err ) == V_UNDEF )
     УчитыватьВЗатратах = false;
  end;     

  SumCom = $0;
  SumNDS = $0;
  sfbasobj.KeyNum = 0;
  sfbasobj.rec.FeeType = SF_FEE_TYPE_PERIOD;
  sfbasobj.rec.DefCommID = sfdefcom.ID;
  sfbasobj.rec.BaseObjectType = 0;
  sfbasobj.rec.BaseObjectID = 0;
  stat = GetGE(sfbasobj);
  while (stat AND (sfbasobj.rec.DefCommID == sfdefcom.ID))

    ExistSfBasObj = true;

    if( sfbasobj.rec.AccountedInIncluded == 0 )

      if( ПолучитьСделку( sfbasobj ) == true )

         FD = SPFirstDoc( dl_tick );  

         OutlayComm = $0;
         SumNDS = SumNDS + sfbasobj.rec.NDSSum;                           

         OperGroup = GetOperationGroup( FD.tick.rec.DealType );

         if( (IsClientDeal(FD.tick.rec)) AND (IsREPO(OperGroup)) )
            SumCom = SumCom + sfbasobj.rec.CommSum;
         else 

               /*получим кол-во бумаг на лоте на дату оплаты комиссии*/
            if (FD.pmwrtsum.rec.Date > sfdefcom.DatePay)
               ОстатокНаЛоте = FD.dl_leg.rec.Principal;
               ПроданоСЛота = $0;
            else
               ОстатокНаЛоте  = КоличествоНаЛотеПокупкиНаКонецДня( FD.pmwrtsum.rec, sfdefcom.DatePay );
               /*получим кол-во бумаг, проданных с лота на дату оплаты комиссии*/
               ПроданоСЛота   = FD.dl_leg.rec.Principal - ОстатокНаЛоте;
            end;

            /*все продано*/
            if( ОстатокНаЛоте == $0 ) 
               OutlayComm = $0;
            elif( FD.pmwrtsum.rec.State == PM_WRTSUM_NOTFORM  )
               OutlayComm = $0;
            /*ничего не продано*/
            elif( ПроданоСЛота == $0 )
               OutlayComm = sfbasobj.rec.CommSum;
            /*что-то продано, но не все*/      
            elif( (ПроданоСЛота > $0) AND (ОстатокНаЛоте > $0) ) 
               OutlayComm = sfbasobj.rec.CommSum * (ОстатокНаЛоте / FD.dl_leg.rec.Principal);
            end;

            if( sfbasobj.Update() == false )
               return false;
            end;            

            SumCom = SumCom + sfbasobj.rec.CommSum - OutlayComm;

            if( OutlayComm > $0 )                  
                                                                                               
               if( SmartConvertSum( ConvOutlayComm, OutlayComm, sfdefcom.DatePay, FD.fininstr.rec.FaceValueFI, NATCUR, true ) == false )
                  return false;
               end;

//               if( not ОбновитьСумму( FD, DLSUM_KIND_OUTLAY, sfdefcom.DatePay, ConvOutlayComm, $0, NATCUR ) )
//                  return not SayErrorBuySale( FD.tick.rec, "Ошибка при обновлении суммы комиссии банку" ); 
//               end;

/*
               if( (FD.KindPortf == KINDPORT_REPO) OR (FD.KindPortf == KINDPORT_UNADMITTED) ) /*для Обр.Прод. и Займа */

                  if( ВыполнитьУчетЗатрат(  FD, "Затраты, договор", ConvOutlayComm,
                                        Doc, FD.tick.rec.DealCode, 
                                        "Учет комиссий отнесенных к затратам для сделки с кодом " + FD.tick.rec.DealCode, 
                                        sfcomiss, sfdefcom, sicredit ) == false )
                     return false;
                  end;


               else
*/
               if( СуммыКомиссий[FD.dl_leg.rec.PFI] == null )
                  СуммыКомиссий[FD.dl_leg.rec.PFI] = TArray();
                  ИнициализироватьЭлементМассива(СуммыКомиссий[FD.dl_leg.rec.PFI]);
                  if( FD.dl_leg.rec.PFI > MaxPFI )
                     MaxPFI = FD.dl_leg.rec.PFI;
                  end;                    
               end;

               if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_EXPENDITURES, sfdefcom.DatePay, FD ) )
                  msgbox("Ошибка при обновлении лота"); 
                  return 1;
               end;   

/*               end;*/
            end;
         end;     
      end;
    end;
    stat = next(sfbasobj);
  end;

  /*сделаем проводки по затратам, массив сумм для проводок был сформирован в разрезе - фин.инструмент и вид портфеля*/  
  /* индекс i - FIID фин.инструмента   */ 
  /* индекс j - вид портфеля           */
  i = 0; 

  while( i <= MaxPFI )

     if( СуммыКомиссий[i] != null )

        j = 0; 
        while( j <= KINDPORT_UNADMITTED ) 
           if( (СуммыКомиссий[i][j] != null) AND (СуммыКомиссий[i][j] > 0) )     
              /*создаем объект-первичный документ - фин.инструмент, в заданном портфеле, дял заданного клиента*/
              FD = SPFirstDocFI( DLDOC_ISSUE, i, i, j, sicredit.rec.PartyID );                   

              if( SmartConvertSum( ConvOutlayComm, СуммыКомиссий[i][j], sfdefcom.DatePay, FD.fininstr.rec.FaceValueFI, NATCUR, true ) == false )
                 return false;
              end;

              if( ВыполнитьУчетЗатрат(  FD, "Наш портфель ц/б", ConvOutlayComm,
                                    Doc, FD.fininstr.rec.FI_Code, 
                                    "Учет комиссий отнесенных к затратам для ценной бумаги с кодом " + FD.fininstr.rec.FI_Code 
                                    + " (" + НаименованияПортфелей[j] + ")", 
                                    sfcomiss, sfdefcom, sicredit ) == false )
                 return false;
              end;
           end;       

           j = j + 1;
        end; 
     end; 
     i = i + 1;
  end; 

  if( ExistSfBasObj )
     SetParm( 4, SumCom ); 
     SetParm( 5, SumNDS ); 
  end;
 
  return true;
END;
