/*
 $Name: d_r_pan.mac
 $Module: Ядро ГКБО 
 $Description: Списание доходов/расходов
 */
 /*
	Списание доходов/расходов
 */
import "d_r_imp.mac", "d_r_pan_lib.mac", Календарь;

macro EventPan(dlg, cmd, id, key)
  var itemsel;

  if(cmd == DLG_INIT)
    StdInit(dlg, cmd, id, key);

  elif(CMD == DLG_SETFOCUS)
    if(trim(fldname(dlg, id))    == "BalanceFrom")
      BalanceFrom =  dlg.BalanceFrom;
    elif (trim(fldname(dlg, id)) == "BalanceTo")
      BalanceTo = dlg.BalanceTo;
    elif (trim(fldname(dlg, id)) == "AccountFrom")
      AccountFrom = dlg.AccountFrom;
    elif (trim(fldname(dlg, id)) == "AccountTo")
      AccountTo = dlg.AccountTo;
    elif (trim(fldname(dlg, id)) == "Department")
      Depart = dlg.Department;
    end;

  elif(CMD == DLG_REMFOCUS)
    if((trim(fldname(dlg, id)) == "BalanceFrom") and (BalanceFrom != dlg.BalanceFrom) and (dlg.BalanceFrom != ""))
      if(not CheckBalance(dlg.BalanceFrom, true))
        return CM_CANCEL;
      end;
      dlg.AccountFrom = "";
    elif((trim(fldname(dlg, id)) == "BalanceTo") and (BalanceTo   != dlg.BalanceTo) and (dlg.BalanceTo != ""))
      if(not CheckBalance(dlg.BalanceTo, true))
        return CM_CANCEL;
      end;
      dlg.AccountTo = "";
    elif((trim(fldname(dlg, id)) == "AccountFrom") and (AccountFrom   != dlg.AccountFrom))
      if(not CheckAccount(dlg.AccountFrom, NULL, @CurrencyFrom))
        return CM_CANCEL;
      end;
    elif((trim(fldname(dlg, id)) == "AccountTo") and (AccountTo   != dlg.AccountTo))
      if(not CheckAccount(dlg.AccountTo, NULL, @CurrencyTo ))
        return CM_CANCEL;
      end;
    elif((trim(fldname(dlg, id)) == "Department") and (Depart     != dlg.Department))
      dlg.Department_Name = CheckNameDepartment(dlg.Department);
      UpdateFields(dlg);
      Depart = dlg.Department;
    end;

  elif((CMD == DLG_KEY) and (key == 32/*K_SPACE*/))
    if(trim(fldname(dlg, id)) == "LastChar1")
      if(dlg.LastChar1 == "")
        dlg.LastChar1 = "X";
        dlg.LastChar2 = "";
        DisableFields(dlg, fldindex(dlg, "IsDepSave"));
        dlg.IsDepSave = "X";
      end;
    elif(trim(fldname(dlg, id)) == "LastChar2")
      if(dlg.LastChar2 == "")
        dlg.LastChar2 = "X";
        dlg.LastChar1 = "";
        if({NumDprt} == {OperDprtNode})
          EnableFields(dlg, fldindex(dlg, "IsDepSave"));
        end;
      end;
    elif(trim(fldname(dlg, id)) == "IsDepSave")
      if(dlg.IsDepSave == "")
        dlg.IsDepSave = "X";
      else
        dlg.IsDepSave = "";
      end;
    elif(trim(fldname(dlg, id)) == "IsSPOD")
      if(dlg.IsSPOD == "")
        dlg.IsSPOD = "X";
      else
        dlg.IsSPOD = "";
      end;
    elif((({NumDprt} == {OperDprtNode}) and (ServOper)) and (trim(fldname(dlg, id)) == "Department"))
      dlg.Department      = 0;
      dlg.Department_Name = CheckNameDepartment(dlg.Department);
    elif( trim(fldname(dlg, id)) == "AccountFrom")
      dlg.AccountFrom = "";
    elif( trim(fldname(dlg, id)) == "AccountTo")
      dlg.AccountTo = "";
    elif( trim(fldname(dlg, id)) == "RestType")
      if(dlg.RestType == Входящий)
        dlg.RestType = Исходящий;
      elif(dlg.RestType == Исходящий)
        dlg.RestType = Входящий;
      end;
    end;
    UpdateFields(dlg);

  elif((CMD == DLG_KEY) and (key == 317/*K_F3*/))
    if(trim(fldname(dlg, id)) == "BalanceFrom")
      itemsel = Menu(mnuBalance, " ~Esc~ Выход  ~Enter~ Выбор", "Список балансовых счетов");
      if(itemsel >= 0)
        dlg.BalanceFrom = trim(mnuBalance(itemsel));
      end;
      if(BalanceFrom != dlg.BalanceFrom)
        dlg.AccountFrom = "";
      end;
    
    elif(trim(fldname(dlg, id)) == "BalanceTo")
      itemsel = Menu(mnuBalance, " ~Esc~ Выход  ~Enter~ Выбор", "Список балансовых счетов");
      if(itemsel >= 0)
        dlg.BalanceTo = trim(mnuBalance(itemsel));
      end;
      if(BalanceFrom != dlg.BalanceFrom)
        dlg.AccountTo = "";
      end;

    elif( trim(fldname(dlg, id)) == "AccountFrom")
      ListAccountBalDprtFrom(dlg);
      
    elif( trim(fldname(dlg, id)) == "AccountTo")
      ListAccountBalDprtTo(dlg);

    elif((trim(fldname(dlg, id)) == "Department") and (({NumDprt} == {OperDprtNode}) and (ServOper)))
      itemsel = Menu(mnuDepart, " ~Esc~ Выход  ~Enter~ Выбор", "Список филиалов");
      if(itemsel >= 0)
        dlg.Department_Name = DepartName(itemsel);
        dlg.Department      = DepartCode(itemsel);
      end;
    
    elif( trim(fldname(dlg, id)) == "Date_Carry")
      dlg.Date_Carry = GetDateByCalendar( dlg.Date_Carry );

    elif( trim(fldname(dlg, id)) == "RestDate")
      dlg.RestDate = GetDateByCalendar( dlg.RestDate );

    elif(trim(fldname(dlg, id)) == "RestType")
      itemsel = Menu(mnuRestType, " ~Esc~ Выход  ~Enter~ Выбор", "Список типов остатка");
      if(itemsel >= 0)
        dlg.RestType = trim(mnuRestType(itemsel));
      end;

    end;
    UpdateFields(dlg);

  elif(CMD == DLG_SAVE)

    if((dlg.BalanceFrom == "") AND (dlg.AccountFrom == "") )
      MsgBox("Должен быть задан счет или балансовый счет, с которого будет проводиться списание.");
      SetFocus(dlg, fldindex(dlg, "BalanceFrom"));
      return CM_CANCEL;     
    elif(not CheckBalance(dlg.BalanceFrom, true))
      SetFocus(dlg, fldindex(dlg, "BalanceFrom"));
      return CM_CANCEL;
    elif(dlg.Ground == "")
      MsgBox("Введите основание документа");
      SetFocus(dlg, fldindex(dlg, "Ground"));
      return CM_CANCEL;
    elif((dlg.BalanceTo == "") AND (dlg.AccountTo == "") )
      MsgBox("Должен быть задан счет или балансовый счет, на который будет проводиться списание.");
      SetFocus(dlg, fldindex(dlg, "BalanceTo"));
      return CM_CANCEL;     
    end;

    if(NewOper)
      Read(dr, dlg, true);
      RunOperation(ВидПДДоходыРасходы, dr, true, ВидОперацииДоходыРасходы);
    end;
  else
    return CM_DEFAULT;
  end;
end;

Опер.Oper = {oper};
getEQ( Опер );
if( Опер.CTypePerson == "У")
  msgbox("Вам запрещено вызывать эту функцию");
  exit(1);
end;

RunDialog(dpan, "EventPan");
exit (1);
