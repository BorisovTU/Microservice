/*
$Name:       operdayphase_panel.mac
$Module:    √Î‡‚Ì‡ˇ ÍÌË„‡  
$Description: —Â‚ËÒ˚ Ô‡ÌÂÎË  ‚‚Ó‰‡/ÍÓÂÍÚËÓ‚ÍË Ù‡Á˚ ÓÔÂ‡ˆËÓÌÌÓ„Ó ‰Ìˇ
*/

IMPORT BankInter;
import "cb_sql.mac", "web_scroll_lib.mac";
import "ws_dprt.mac";
import "ws_validation.mac";
import "ws_person.mac";

private var DEPARTMENT_STATUS_OPEN      = 1;  // Æ‚™‡Î‚
private var DEPARTMENT_STATUS_ACTIVE    = 2;



class TWebOperDayPhaseGridItem 
  var Phase            : integer;   
  var Name             : string ;
  var IsSystem         : bool ;
  var IsMandatory      : bool ;
  var SwitchByScheduler: bool ;
end;

class TWebOperDayPhasePanelObject 
  var Phase            : integer;   
  var Name             : string ;
  var Comment          : string ;
  var IsSystem         : bool ;
  var IsMandatory      : bool ;
  var SwitchBySheduler : bool ;
  var SwitchTime       :time ;
  var PhaseOwnerList   ; //List <TWebOpdPhaseOwnerGridItem>
  var DpParmList       ; //List <TWebPhaseDpParmGridItem>
  var OperCanSwitchTimeHead : bool ;
  var Version           : integer;   
end;

class TWebOpdPhaseOwnerGridItem  
  var Phase            : integer;   
  var Owner            ; //TWsPerson
  var DprtShortName    : string ;
end;

class TWebPhaseDpParmGridItem  
  var Department            : integer; 
  var DprtName              : string;  
  var DprtPtName            : string;  
  var Phase                 : integer;  
  var SwitchBySheduler      : bool; 
  var SwitchTime            :time ;
  var Editable              : bool ;  
  var Children            ; //List <TWebPhaseDpParmGridItem>
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro CovertBool(CurValue :bool ) : string

  if(CurValue==true)
    
	return "X";
	
  else
  
    return "";
	
  end;
  
end;


private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  
  ErrorMessage.Message  = objErr.message;
  
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro SettingParm(): bool

  var err=0;
  
  var ProcValue=false;
  
  GetRegistryValue( "COMMON\\ëÖêÇàëçõÖ èêéñÖÑìêõ\\áÄèìëä ëÖêÇàëçõï èêéñÖÑìê", V_BOOL, ProcValue, err, false, {oper} );

  if(ProcValue == true)


    if( {OperDprt} == {NumDprt})
	  
      return true;
		
    else
	  
      return false;
		
    end;
		
  end;
  
end;

macro GetDprtShortName(CodeDepart):string

  var IdParty=0; 
  var ShortnameParty="";
  
  CB_GetParentFilial(CodeDepart,IdParty);
  
  CB_GetDepartmentCodeAndName(IdParty,null,ShortnameParty);
  
  return ShortnameParty;

end;


macro Fill_PhaseDpParmGridItem(Phase)

  var innerquery  = " SELECT LEVEL,"
                    "XMLELEMENT (DpParm,"
                              " XMLELEMENT (Department, uq.t_Code), "
                              " XMLELEMENT (DprtName, uq.DprtName), "
                              " XMLELEMENT (DprtPrName, uq.PartyName), "
                              " XMLELEMENT (Phase, " + Phase +" ), "
                              " XMLELEMENT (Editable, uq.Editable), "
                              " XMLELEMENT (SwitchByScheduler, uq.SwitchBySheduler), "
                              " XMLELEMENT (SwitchTime,TO_CHAR( uq.SwitchTime,''HH24:MI:SS'')))"
                    "FROM (  " 
						"SELECT dp.t_Code,"
                               " dp.t_ParentCode, "
                               " dp.t_Name AS DprtName, "
                               " pt.t_Name AS PartyName, "
                               " DECODE (dp.t_Code,"+ {OperDprtNode}+",1 , 0) AS Editable, "
							   " DECODE (prm.t_SwitchBySheduler, ''X'', 1, 0) AS SwitchBySheduler, "	
                               " NVL(prm.t_SwitchTime,TO_DATE(''01/01/0001 10:00:00'', ''dd.mm.yyyy HH24:MI:SS'')) AS SwitchTime "
                        " FROM ddp_dep_dbt dp "
                             " INNER JOIN dparty_dbt pt ON pt.t_PartyID = dp.t_PartyID "
                             " LEFT JOIN dphases_dpparm_dbt prm ON prm.t_Department = dp.t_Code AND prm.t_Phase = " + Phase +
					  " START WITH dp.t_Code = "+ {OperDprtNode} +
					  " CONNECT BY     PRIOR dp.t_ParentCode = dp.t_Code AND dp.t_Status IN ("+DEPARTMENT_STATUS_OPEN +","+ DEPARTMENT_STATUS_ACTIVE+")	"						  							  									  
                    " UNION "
                        "SELECT dp.t_Code,"
                              "dp.t_ParentCode,"
                              "dp.t_Name AS DprtName,"
                              "pt.t_Name AS PartyName,"
                              " 1 AS Editable, "   							  
							  " DECODE (prm.t_SwitchBySheduler, ''X'', 1, 0) AS SwitchBySheduler, "	
                              " NVL(prm.t_SwitchTime,TO_DATE(''01/01/0001 10:00:00'', ''dd.mm.yyyy HH24:MI:SS'')) AS SwitchTime "
                        "FROM ddp_dep_dbt dp "
                              "INNER JOIN dparty_dbt pt ON pt.t_PartyID = dp.t_PartyID "
                              "LEFT JOIN dphases_dpparm_dbt prm ON prm.t_Department = dp.t_Code AND prm.t_Phase = " + Phase +
					    " START WITH dp.t_ParentCode = "+ {OperDprtNode} +
						" CONNECT BY     PRIOR dp.t_Code = dp.t_ParentCode  AND dp.t_Status IN ("+DEPARTMENT_STATUS_OPEN +","+ DEPARTMENT_STATUS_ACTIVE+ ")) uq "					
						" START WITH uq.t_Code = "+ {NumDprt} +
						" CONNECT BY PRIOR uq.t_Code = uq.t_ParentCode ";

  var outerquery=   " SELECT 1, "
					" XMLELEMENT(dpparm_list, " 
					"(SELECT DBMS_XMLGEN.GETXMLTYPE "
					"(DBMS_XMLGEN.NEWCONTEXTFROMHIERARCHY  ( '"+innerquery +"') )"
					" FROM DUAL)).GETCLOBVAL() XMLDOC  FROM DUAL " ;
					
  var ds = TRsbDataSet(outerquery );
  
  var result;

  if( ds.MoveNext() )
  
    result = ds.XMLDOC;
	
  else
	
	result="";
	
  end;

  return result;

end; 


macro WebCore_GetOperDayPhasePanelObj( Phase ) : TWebOperDayPhasePanelObject
  
  var ProcValue;

  var panelObj= TWebOperDayPhasePanelObject();
  
  if(Phase==0)
    
	panelObj.Phase=0;
	
	panelObj.IsSystem=false;
	
	panelObj.IsMandatory=false;
	
	panelObj.SwitchBySheduler=false;
	
	panelObj.SwitchTime=Time ( 0, 0, 0, 0 );
	
	panelObj.Version=0;
	
	panelObj.PhaseOwnerList= TArray();
	
	panelObj.DpParmList=null;
		
    panelObj.OperCanSwitchTimeHead = SettingParm();
		
     
  else
   
	var need_phases = TBFile("phases.dbt", "R", 0 );
	
    need_phases.Clear();
	
    need_phases.rec.Phase = Phase;

	if( need_phases.GetEQ())
	
	  panelObj.Phase=need_phases.rec.Phase;
	  
	  panelObj.Name=need_phases.rec.Name;
	  
	  panelObj.Comment=need_phases.rec.Comment;
	
	  panelObj.IsSystem=need_phases.rec.IsSystem;
	
	  panelObj.IsMandatory=need_phases.rec.IsMandatory;
	  
	  if(need_phases.rec.SwitchBySheduler=="X")
	
	    panelObj.SwitchBySheduler=true;
	  
	  else
	
	    panelObj.SwitchBySheduler=true;
	  
	  end;
	  
	  panelObj.SwitchBySheduler=need_phases.rec.SwitchBySheduler;

	  panelObj.SwitchTime=need_phases.rec.SwitchTime;
	
	  panelObj.Version=need_phases.rec.Version;
	
	  panelObj.PhaseOwnerList=TArray();
	
	  panelObj.DpParmList= null;
	  
      panelObj.OperCanSwitchTimeHead = SettingParm();

	end;
	
	
    var cmd, rs;	
    var query = " SELECT t.T_PHASE, t.T_OPER, pt.T_SHORTNAME, p.T_NAME personName, p.T_CODEDEPART, pt.T_NAME partyName"
              " FROM DOPDPHASEOWNER_DBT t   "
			  " INNER JOIN DPERSON_DBT p ON p.T_OPER = t.T_OPER"
			  " INNER JOIN DDP_DEP_DBT d ON d.T_CODE = t.T_DEPARTMENT"
			  " INNER JOIN DPARTY_DBT pt ON pt.T_PARTYID = d.T_PARTYID"
			  " WHERE T_PHASE = " +Phase;

    cmd = RsdCommand(query);

    rs = RsdRecordset(cmd);

    while(rs.movenext)

      var phaseOwner  = TWebOpdPhaseOwnerGridItem ();

      phaseOwner.Phase = SQL_ConvType(rs.value("T_PHASE"));
	  
	  phaseOwner.DprtShortName = SQL_ConvType(rs.value("T_SHORTNAME"));
	  
	  phaseOwner.Owner =TWsPerson();
	  
	  phaseOwner.Owner.Number=SQL_ConvType(rs.value("T_OPER"));
	  
	  phaseOwner.Owner.Name_=SQL_ConvType(rs.value("personName"));
	  
	  phaseOwner.Owner.DprtNode=SQL_ConvType(rs.value("T_CODEDEPART"));
	  
	  phaseOwner.Owner.DprtName=SQL_ConvType(rs.value("partyName"));
	  
	  panelObj.PhaseOwnerList[panelObj.PhaseOwnerList.size]= phaseOwner;
	
    end;
  
  end;

  return panelObj;
  
end;

macro WebCore_InsertOperDayPhase( PhaseParam, InitDpParmList )

  responseBuilder =WebResponseBuilder();
    
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  Record  phasesRec ("phases.dbt");
  
  Record  phases_dpparmRec ("phases_dpparm.dbt");
  
  Record  phaseownerRec ("opdphaseowner.dbt");
  
  phasesRec.Phase =PhaseParam.Phase;
  
  phasesRec.Name=PhaseParam.Name;
  
  phasesRec.Comment=PhaseParam.Comment;

  phasesRec.IsSystem=CovertBool(PhaseParam.IsSystem);
  
  phasesRec.IsMandatory=CovertBool(PhaseParam.IsMandatory);
  
  phasesRec.SwitchBySheduler=CovertBool(PhaseParam.SwitchBySheduler);
  
  phasesRec.SwitchTime=PhaseParam.SwitchTime;
  
  phasesRec.ShedulerID=0;
  
  phasesRec.Version=PhaseParam.Version;

  var opdphaseownerArray = TArray();

  var count = PhaseParam.PhaseOwnerList.size();
  
  var i =0;
  
  while (i < count)
  
    var  ownerRec  = PhaseParam.PhaseOwnerList[i];
	      
	phaseownerRec.Phase = PhaseParam.Phase;
	
	phaseownerRec.Oper = ownerRec.Owner.Number;
	
	phaseownerRec.Department = ownerRec.Owner.DprtNode;
	
	opdphaseownerArray[i]=phaseownerRec;
	
    i = i + 1;
	
  end;
  
  var phases_dpparmArray = TArray();
  
  i =0;
  
  while (i < PhaseParam.DpParmList.size())
  
    var j=0;
	
	var  dpparmRec   = PhaseParam.DpParmList[i];
	
	while (j < InitDpParmList.size())
	
      if((dpparmRec.Department ==InitDpParmList[j].Department) and (dpparmRec.Phase  ==InitDpParmList[j].Phase))
	    
	    if((dpparmRec.SwitchBySheduler!= InitDpParmList[j].SwitchBySheduler) or(dpparmRec.SwitchTime != InitDpParmList[j].SwitchTime ))
			  	  
		  phases_dpparmRec.Department = dpparmRec.Department;
		  
		  phases_dpparmRec.Phase = PhaseParam.Phase;
		  
		  phases_dpparmRec.SwitchBySheduler = dpparmRec.SwitchBySheduler;
		  
		  phases_dpparmRec.SwitchTime = dpparmRec.SwitchTime;
		  
		  phases_dpparmRec.ShedulerID = 0;
		  
		  phases_dpparmArray[phases_dpparmArray.size]=phases_dpparmRec;
		
	    end;
		
	  end;
	  
	  j = j + 1;
	  
	end;
	
    i = i + 1;
	
  end;


  var res = CB_InsertOperDayPhase(phasesRec, opdphaseownerArray,	phases_dpparmArray);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;
  
end;
  
  
  
  
macro WebCore_UpdateOperDayPhase( InitPhase, PhaseParam, InitDpParmList, InitOwnerList )  

  responseBuilder =WebResponseBuilder();
 
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  Record  phaseownerRec ("opdphaseowner.dbt");
  
  Record  phasesRec ("phases.dbt");
  
  Record  newphaseownerRec ("opdphaseowner.dbt");

  Record  phases_dpparmRec ("phases_dpparm.dbt");

  phasesRec.Phase =PhaseParam.Phase;
  
  phasesRec.Name=PhaseParam.Name;
  
  phasesRec.Comment=PhaseParam.Comment;
  
  phasesRec.IsSystem=CovertBool(PhaseParam.IsSystem);
  
  phasesRec.IsMandatory=CovertBool(PhaseParam.IsMandatory);
  
  phasesRec.SwitchBySheduler=CovertBool(PhaseParam.SwitchBySheduler);
  
  phasesRec.SwitchTime=PhaseParam.SwitchTime;
  
  phasesRec.ShedulerID=0;
  
  phasesRec.Version=PhaseParam.Version;
  
  var todelphaseownerArray = TArray();
  
  var flag = false;
  
  var i =0;

  while (i < InitOwnerList.size())
  
    var initrec   = InitOwnerList[i];
	
	var j=0;
	
	flag = false;
	
	while (j <  PhaseParam.PhaseOwnerList.size())
	
	  if((initrec.Phase  == PhaseParam.PhaseOwnerList[j].Phase) and (initrec.Owner.Number  == PhaseParam.PhaseOwnerList[j].Owner.Number))
	  
	    flag=true;
		
	  end;
	   	  
	  j = j + 1;
	  
	end;
	
	if( flag == false)
	  	
	    phaseownerRec.Phase = initrec.Phase;
		
	    phaseownerRec.Oper = initrec.Owner.Number;
		
	    phaseownerRec.Department = initrec.Owner.DprtNode;
		
	    todelphaseownerArray[todelphaseownerArray.size]=phaseownerRec;
					
	  end;
	
    i = i + 1;
	
  end;
  
  var newphaseownerArray  = TArray();
  
  i =0;
  
  while (i < PhaseParam.PhaseOwnerList.size())
  
    var  newrec    = PhaseParam.PhaseOwnerList[i];
	
	j=0;
	
	flag = false;
			
	while (j < InitOwnerList.size())
	
	  if((newrec.Phase  == InitOwnerList [j].Phase) and (newrec.Owner.Number  == InitOwnerList [j].Owner.Number))
	  
	    flag=true;
		
	  end;
	 
	  
	  j = j + 1;
	  
	end;
	 
	  if( flag == false)
		
	    newphaseownerRec.Phase = newrec.Phase;
		
	    newphaseownerRec.Oper = newrec.Owner.Number;
		
		newphaseownerRec.Department = newrec.Owner.DprtNode;
		
		newphaseownerArray[newphaseownerArray.size]=newphaseownerRec;
		
	  
	  end;
	  
    i = i + 1;
	
  end;
  
  var phases_dpparmArray = TArray();
  
  i =0;

  while (i <  PhaseParam.DpParmList.size())
  
    j=0;
	
	var  dpparmRec   = PhaseParam.DpParmList[i];
	
	while (j < InitDpParmList.size())
	
      if((dpparmRec.Department ==InitDpParmList[j].Department) and (dpparmRec.Phase  ==InitDpParmList[j].Phase))
	    
	    if((dpparmRec.SwitchBySheduler!= InitDpParmList[j].SwitchBySheduler) or(dpparmRec.SwitchTime != InitDpParmList[j].SwitchTime ))
		
		 		  
		  phases_dpparmRec.Department = dpparmRec.Department;
		  
		  phases_dpparmRec.Phase = PhaseParam.Phase;

		  phases_dpparmRec.SwitchBySheduler = CovertBool(dpparmRec.SwitchBySheduler);
		  
		  phases_dpparmRec.SwitchTime = dpparmRec.SwitchTime;
		  
		  phases_dpparmRec.ShedulerID = 0;
		  
		  phases_dpparmArray[phases_dpparmArray.size]=phases_dpparmRec;
		
	    end;
		
	  end;
	  
	  j = j + 1;
	  
	end;
	
    i = i + 1;
	
  end;

  var res = CB_UpdateOperDayPhase(InitPhase, phasesRec, todelphaseownerArray, newphaseownerArray, phases_dpparmArray);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;
 
end;



















