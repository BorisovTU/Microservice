/*
 $Name: giszhkhproc_rep.mac
 $Module: Ÿ¤à® Banking
 $Description: à®â®ª®« ¢ë¯®«­¥­¨ï ¯à®æ¥¤ãàë ¯¥à¥¤ ç¨ á¢¥¤¥­¨© ¤«ï ƒˆ‘ †Š•
*/

const   è¨¡ª    = 0,
        ¥à¢ë©   = 1,
        ®á«¥¤­¨©= 2;

import oralib, likepy, PaymInter, globals, "bnk_dirfile.mac", "bnk_dttmfrmt.mac",
       "bnk_common.mac", "SwitchOutput.mac";

private const WLD_STATUS_TYPE_PMSENDANSWER:integer = 37;

macro ClearLogPmSend
  execStoredFunc( "PM_CONNECT.ClearLogPmSend", V_UNDEF, null );
end;

macro AddRecLogPmSend(PmsendID : integer)
  var params : TArray = makeArray( SQLParam("p_PmsendID", PmsendID) );
  execStoredFunc( "PM_CONNECT.AddRecLogPmSend", V_UNDEF, params );
end;

private macro PrintHeader
  [
  âç¥â ® à¥§ã«ìâ â å ¯¥à¥¤ ç¨ ¢ RS-Connect ¨­ä®à¬ æ¨¨ ¤«ï ƒˆ‘ †Š• 
                                                                              
                                                                              
  ˆá¯®«­¨â¥«ì    #####  #
  „ â  ®âç¥â     #

  ]({oper}, {Name_Oper}, {curdate});
end;

private macro PrintHeaderCharges
  [
  âç¥â ® à¥§ã«ìâ â å ¯®«ãç¥­¨ï ®â¢¥â®¢ ¯® § ¯à®á ¬, ­ ¯à ¢«¥­­ë¬ ¢ ƒˆ‘ †Š•
                                                                              
                                                                              
  ˆá¯®«­¨â¥«ì    #####  #
  „ â  ®âç¥â     #

  ]({oper}, {Name_Oper}, {curdate});
end;

private class TTotal
  var DepType : string = "",
      DepNum : string = "",
      TotalCreate : integer = 0,
      TotalCancel : integer = 0,
      TotalError : integer = 0;
end;

private class TTable
  private var 
    CurrDep : integer = 0,
    CurrDepNumber : string = "",
    CurrVsp : integer = 0,
    CurrVspNumber : string = "",
    Totals : TArray = TArray(); // ¨â®£¨

  private macro GetRecords
    var q : string = 
      "select t.* "
      "  from ( select pm.t_StartDepartment as t_Department, "
      "                case when pm.t_OperNode = pm.t_StartDepartment then 0 " + // çâ®¡ë ¯« â¥¦¨ ä¨«¨ «  ¡ë«¨ ¢­ ç «¥,   ¯« â¥¦¨ ‚‘ ¯®â®¬
      "                     else pm.t_OperNode "
      "                end as t_VSP, "
      "                rm.t_Number, "
      "                rm.t_Date, "
      "                sd.t_Action, "
      "                pm.t_PaymentID, "
      "                pm.t_PayerAccount, "
      "                cr.t_BankCode as t_ReceiverBIC, "
      "                pm.t_ReceiverAccount, "
      "                pm.t_BaseAmount as t_Amount, "
      "                rm.t_Ground, "
      "                sd.t_ExtObjectID, "
      "                sd.t_Description "
      "             from TABLE( PM_CONNECT.GetRecordsLogPmSend() ) recs "
      "             inner join dpmsend_dbt sd on sd.t_ID = recs.t_PmSendID  AND sd.t_Action in (:WLD_ACTION_PMSEND_EXEC, :WLD_ACTION_PMSEND_ANNUL) "
      "             inner join dpmpaym_dbt pm on pm.t_PaymentID = sd.t_ObjectID "
      "             inner join dpmrmprop_dbt rm on rm.t_PaymentID = sd.t_ObjectID "
      "             inner join dpmprop_dbt cr on cr.t_PaymentID = sd.t_ObjectID and "
      "                                          cr.t_DebetCredit = :PRT_Credit "
      "       ) t  "
      "order by t.t_Department, t.t_VSP, t.t_Action, t.t_PaymentID ";

    var params : TArray = makeArray( SQLParam("WLD_ACTION_PMSEND_EXEC", WLD_ACTION_PMSEND_EXEC), 
                                     SQLParam("WLD_ACTION_PMSEND_ANNUL", WLD_ACTION_PMSEND_ANNUL),
                                     SQLParam("PRT_Credit", PRT_Credit) );
    var rs = execSQLselect(q, params);

    return rs;
  end;

  private macro GetRecordsQueries
    
    var q : string = 
    " SELECT sd.t_ID AS ID, " +
    "        rq.t_PayerINN AS PayerINN, " +
    "        rq.t_PayerName1 || ' ' || rq.t_PayerName2 || ' ' || rq.t_PayerName3 " +
    "          AS PayerName, " +
    "        rq.t_HCSDocID AS ReqPaymentID, " +
    "        rq.t_ServiceID AS ReqServiceID, " +
    "        rq.t_HCSAccount AS ReqAcc, " +
    "        Replace( TO_CHAR (rq.t_Month) || '.' || TO_CHAR (rq.t_Year), '0.0', chr(1)) AS ReqPeriod, " +
    "        sd.t_ExtObjectID AS RSConnectObject, " +
    "        sd.t_Description AS ErrDescription " +
    "  FROM TABLE (PM_CONNECT.GetRecordsLogPmSend ()) recs " +
    "      INNER JOIN dpmsend_dbt sd " +
    "           ON sd.t_ID = recs.t_PmSendID AND sd.t_Action = :WLD_ACTION_PMSEND_QUERY " +
    "      INNER JOIN dpmreqcharge_dbt rq ON sd.t_ObjectID = rq.t_ID ";

    var params : TArray = makeArray( SQLParam("WLD_ACTION_PMSEND_QUERY", WLD_ACTION_PMSEND_QUERY) );
    var rs = execSQLselect(q, params);

    return rs;
  end;

    private macro GetRecordsCharges
    
    var q : string = 
    " SELECT sd.t_ID AS ID, " +
    "        rq.t_PayerINN AS PayerINN, " +
    "        rq.t_PayerName1 || ' ' || rq.t_PayerName2 || ' ' || rq.t_PayerName3 " +
    "          AS PayerName, " +
    "        rq.t_HCSDocID AS ReqPaymentID, " +
    "        rq.t_ServiceID AS ReqServiceID, " +
    "        rq.t_HCSAccount AS ReqAcc, " +
    "        Replace( TO_CHAR (rq.t_Month) || '.' || TO_CHAR (rq.t_Year), '0.0', chr(1)) AS ReqPeriod, " +
    "        wl.t_Name AS State, " +
    "        sd.t_Description AS ErrDescription " +
    "  FROM TABLE (PM_CONNECT.GetRecordsLogPmSend ()) recs " +
    "      INNER JOIN dpmsend_dbt sd " +
    "           ON sd.t_ID = recs.t_PmSendID AND sd.t_Action = :WLD_ACTION_PMSEND_QUERY " +
    "      INNER JOIN dpmreqcharge_dbt rq ON sd.t_ObjectID = rq.t_ID "
    "      INNER JOIN dwlstatus_dbt wl ON wl.t_TypeState = :WLD_STATUS_TYPE_PMSENDANSWER AND wl.t_State = sd.t_AnswerState; ";

    var params : TArray = makeArray( SQLParam("WLD_ACTION_PMSEND_QUERY", WLD_ACTION_PMSEND_QUERY), SQLParam("WLD_STATUS_TYPE_PMSENDANSWER ", WLD_STATUS_TYPE_PMSENDANSWER ) );
    var rs = execSQLselect(q, params);

    return rs;
  end;

  // ç¥à¥¤­ ï áâà®ª  "ˆâ®£®"
  private macro StartNewTotal(DepType : string, DepNum : string)
    var NewTotal : TTotal = TTotal();
    NewTotal.DepType = DepType;
    NewTotal.DepNum = DepNum;

    Totals[ Totals.size ] = NewTotal;
  end;

  private macro PrintTotals
    [
      ˆâ®£® ¯®:
    ];

    for(var Total : TTotal, Totals)
      [          ######## ##########: á®§¤ ­® ##########,  ­­ã«¨à®¢ ­® ##########, ®è¨¡®ª ##########. ]
      (Total.DepType, Total.DepNum:r, Total.TotalCreate, Total.TotalCancel, Total.TotalError); 
    end;
  end;

  private macro FinishCurrentDep
    [ ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
    ];

    PrintTotals();
    Totals = TArray();
  end;

  private macro ChangeDep(NewDep : integer)
    if(CurrDep > 0)
      FinishCurrentDep();
    end;

    CurrDep = NewDep;
    CurrVsp = 0;

    var DepNumber : string = "", DepName : string = "";
    CB_GetDepartmentCodeAndName(CurrDep, DepNumber, null, DepName);

    [                                                                               « â¥¦¨ ¯® ®¯« â ¬ †Š“
      ”¨«¨ «   ##########   #
      ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³  N  ³   „ â    ³  ‚¨¤   ³ID ¤®ª-â  ³ ‘ç¥â ¯« â¥«ìé¨ª       ³            ®«ãç â¥«ì           ³                  ³                           ³                                    ³                                ³
      ³ ¤®ª ³  ¤®ªã¬.  ³ á¥à¢¨á ³          ³                       ÃÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´     ‘ã¬¬         ³     §­ ç¥­¨¥ ¯« â¥¦      ³         ID ®¡ê¥ªâ  RS-Connect      ³       ¯¨á ­¨¥ ®è¨¡ª¨          ³
      |     |          |        |          |                       |   ˆŠ   |          ‘ç¥â         |                  |                           |                                    |                                |
    ](DepNumber, DepName);

    StartNewTotal("ä¨«¨ «ã", DepNumber);
  end;

  private macro FinishCurrentVsp
    [ ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
    ];
  end;

  private macro ChangeVsp(NewVsp : integer)
    FinishCurrentVsp();

    CurrVsp = NewVsp;

    var VspNumber : string = "", VspName : string = "";
    CB_GetDepartmentCodeAndName(CurrVsp, VspNumber, null, VspName);

    [ ³ ‚‘ ########## ###################################################################################################################################################################################################³
    ](VspNumber, VspName);

    StartNewTotal("‚‘", VspNumber);
  end;

  private macro GetServiceKind(Action : integer) : string
    var ServiceKind : string = "";

    if(Action == WLD_ACTION_PMSEND_EXEC)
      ServiceKind = "á®§¤ ­¨¥";
    elif(Action == WLD_ACTION_PMSEND_ANNUL)
      ServiceKind = " ­­ã«¨à.";
    end;

    return ServiceKind;
  end;

private macro QueriesHeader

    [                                                                         ‡ ¯à®áë ­ ç¨á«¥­¨©

      ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³          ³                     ³                                    ³                  ³                 ³          ³             ³                               ³                                               ³
      ³ID § ¯à®á ³ ˆ/Š ¯®âà¥¡¨â¥«ï ³           ”ˆ ¯®âà¥¡¨â¥«ï          ³ ˆ¤¥­â¨ä¨ª â®à „ ³ˆ¤¥­â¨ä¨ª â®à †Š“³   …‹‘    ³¥à¨®¤ ®¯« âë³        ID ®¡ê¥ªâ  RS-Connect  ³             ¯¨á ­¨¥ ®è¨¡ª¨                   ³
    ]
end;

private macro FinishQueries

   [ ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ     
   ]

end;

private macro ChargesHeader

    [
      ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³          ³                     ³                                    ³                  ³                 ³          ³             ³                               ³                                               ³
      ³ID § ¯à®á ³ ˆ/Š ¯®âà¥¡¨â¥«ï ³           ”ˆ ¯®âà¥¡¨â¥«ï          ³ ˆ¤¥­â¨ä¨ª â®à „ ³ˆ¤¥­â¨ä¨ª â®à †Š“³   …‹‘    ³¥à¨®¤ ®¯« âë³   ¥§ã«ìâ â ¯®«ãç¥­¨ï ®â¢¥â   ³             ¯¨á ­¨¥ ®è¨¡ª¨                   ³
      ³          ³                     ³                                    ³                  ³                 ³          ³             ³                               ³                                               ³
    ]
end;

private macro FinishCharges

   [ ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ     
   ]

end;

  private macro AddToTotal(Action : integer, ExtObjectID, Error)
    var CurrentTotal : TTotal = Totals[ Totals.size - 1 ];
 
    if( (Action == WLD_ACTION_PMSEND_EXEC) and ExtObjectID )
      CurrentTotal.TotalCreate = CurrentTotal.TotalCreate + 1;
    elif( (Action == WLD_ACTION_PMSEND_ANNUL) and ExtObjectID )
      CurrentTotal.TotalCancel = CurrentTotal.TotalCancel + 1;
    end;

    if(Error)
      CurrentTotal.TotalError = CurrentTotal.TotalError + 1;
    end;
  end;

  private macro PrintRow(rs)
    [ ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
      ³#####³##########³########³##########³#######################³#########³#######################³##################³###########################³####################################³################################³
    ]
    ( rs.value("t_Number"), 
      date(rs.value("t_Date")), 
      GetServiceKind(rs.value("t_Action")),
      rs.value("t_PaymentID"),
      rs.value("t_PayerAccount"),
      rs.value("t_ReceiverBIC"),
      rs.value("t_ReceiverAccount"),
      rs.value("t_Amount"),
      rs.value("t_Ground"),
      rs.value("t_ExtObjectID"),
      rs.value("t_Description"):w
    );

    AddToTotal(rs.value("t_Action"), rs.value("t_ExtObjectID"), rs.value("t_Description"));
  end;

private macro PrintRowQuery(rs)
    [ ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
      ³##########³#####################³####################################³##################³#################³##########³#############³###############################³###############################################³
    ]
    ( rs.value("ID"), 
      rs.value("PayerINN"), 
      rs.value("PayerName"),
      rs.value("ReqPaymentID"),
      rs.value("ReqServiceID"),
      rs.value("ReqAcc"),
      rs.value("ReqPeriod"),
      rs.value("RSConnectObject"),
      rs.value("ErrDescription"):w
    );    
  end;

  private macro PrintRowCharge(rs)
    [ ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
      ³##########³#####################³####################################³##################³#################³##########³#############³###############################³###############################################³
    ]
    ( rs.value("ID"), 
      rs.value("PayerINN"), 
      rs.value("PayerName"),
      rs.value("ReqPaymentID"),
      rs.value("ReqServiceID"),
      rs.value("ReqAcc"),
      rs.value("ReqPeriod"),
      rs.value("State"),
      rs.value("ErrDescription"):w
    );    
  end;

  macro Print
    var HasRows : bool = false;

    var rs = GetRecords();

    while( rs and rs.moveNext() )
      HasRows = true;

      var rsDep : integer = rs.value("t_Department"),
          rsVsp : integer = rs.value("t_VSP");

      if( rsDep != CurrDep )
        ChangeDep( rsDep );
      end;
      if( rsVsp != CurrVsp )
        ChangeVsp( rsVsp );
      end;

      PrintRow(rs);
    end;

    if(HasRows)
      FinishCurrentDep();
    end;
  end;

  macro PrintQueries 

    var rs = GetRecordsQueries();   
    var first = true;

    while( rs and rs.moveNext() )

      if(first)
        QueriesHeader();
        first = false;
      end;

      PrintRowQuery(rs);
    end;

    if( not first )
      FinishQueries();
    end;

  end;

    macro PrintCharges 

    var rs = GetRecordsCharges();   
    var first = true;

    while( rs and rs.moveNext() )

      if(first)
        ChargesHeader();
        first = false;
      end;

      PrintRowCharge(rs);
    end;

    if( not first )
      FinishCharges();
    end;

  end;
end;



macro PrintLogPmSend(Type)
  BegAction (0, "®áâà®¥­¨¥ ®âç¥â  ® à¥§ã«ìâ â å ¯¥à¥¤ ç¨ ¨­ä®à¬ æ¨¨ ¢ RS-Connect");

  var Table : TTable = TTable();

  if( Type )
    PrintHeader();
    Table.Print();
    Table.PrintQueries();
  else
    PrintHeaderCharges();
    Table.PrintCharges();
  end;

  EndAction (0);
end;

private macro GetRepFileName : string
  macro GetDirectory : string
    var Directory : string = Bnk_GetRegistryValue
      ( "RS-CONNECT\\ƒˆ‘_†Š•\\BANKING\\REPDIR", V_STRING, 
        "..\\txtfile\\RS_Connect" );

    CreateDirectory(Directory);

    return Directory;
  end;

  macro GetFileName(Directory : string) : string
    var DDDDDD : string = YYMMDD(date()),
        ——MM‘‘ : string = TimeToStr(time(), "HHMISS");

    var FName : string = Directory + "\\GISZKH_" + DDDDDD + "_" + ——MM‘‘ + ".txt";

    return FName;
  end;

//begin
  var Directory : string = GetDirectory();
  var FName : string = GetFileName(Directory);

  // ¥á«¨ ­ §¢ ­¨¥ á®¢¯ ¤¥â á â®ç­®áâìî ¤® á¥ªã­¤ë, ¯à®¡ã¥¬ ¥é¥ à §
  while( FileExists(FName) )
    FName = GetFileName(Directory);
  end;

  return FName;
end;

private FILE RepFile() txt;

class (TSwitchOutput) TSwitchOutputGisZhkh
  InitTSwitchOutput( GetRepFileName() );

end;
