Import FIInter, "sf_libt.mac", "cb_sql.mac";

record SfAccrueRec("sfaccrue.dbt");
record SfDefComRec("sfdefcom.dbt");
record SfContrRec ("sfcontr.dbt" );

file sfcomissFile( "sfcomiss.dbt"  ) key 0;

var GProfitAccount:string;
var GLossAccount:string  ;
var GMacrotxtName = ""; 

private const RashetCatCode = "+Расчеты"; 
private const RashetCatCodeXO = "+Расчеты,ХО"; 




macro ExecuteStep( outBuff, primDoc )

  var stat = 0;
  var ProfitAmount = $0;
  var LossAmount = $0;
  var RashetAccountXO = "";
  var RashetAccount = "";
  var Ground = "", Comment = "";
  var SfComPD : SfComPrimDoc;
  

  SetBuff( SfDefComRec, primDoc );


   sfcomissFile.FeeType = SfDefComRec.FeeType;
   sfcomissFile.Number  = SfDefComRec.CommNumber;

   if( not getEQ( sfcomissFile ) )
      MsgBox("Не найдена комиссия" );
      return 1;
   end;

  Ground = "Начисление комиссии " + sfcomissFile.Code + " по договору " + SfContrRec.Number;


  SfComPD = SfComPrimDoc( 87 /*DLDOC_SFCONTRACT*/, SfContrRec );   
  RashetAccountXO = SfComPD.FindAndOpenAccount( RashetCatCodeXO, SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum );

  RashetAccount = SfComPD.FindAndOpenAccount( RashetCatCode, SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum );


  ProfitAmount = RestA(GProfitAccount,null,null,1);

  if(ProfitAmount != $0)
    stat = CountComissAsIncome(SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum, RashetAccountXO, 0/*NATCUR*/, GProfitAccount, SfAccrueRec.Amount, Ground, "З");
  else
    LossAmount = RestA(GLossAccount,null,null,1);

    if(LossAmount < 0)
      LossAmount =  -LossAmount;
    end;

    if(LossAmount >= SfAccrueRec.Amount)
       stat = CountComissAsIncome(SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum, RashetAccountXO, 0/*NATCUR*/, GLossAccount, SfAccrueRec.Amount, Ground, "З");
    else
       stat = CountComissAsIncome(SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum, RashetAccountXO, 0/*NATCUR*/, GLossAccount, LossAmount, Ground, "З");

       if(not stat)
         stat = CountComissAsIncome(SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum, RashetAccountXO, 0/*NATCUR*/, GProfitAccount, SfAccrueRec.Amount - LossAmount, Ground, "З");
       end;
    end;

  end;

  Ground = "Перенос начисленной комиссии " + sfcomissFile.Code + " по договору " + SfContrRec.Number;

  if(not stat)
    stat = CountComissAsIncome(SfAccrueRec.TransactionDate, SfDefComRec.FIID_commSum, RashetAccount, SfDefComRec.FIID_commSum, RashetAccountXO, SfAccrueRec.Amount, Ground);
  end;
    
  if((GMacrotxtName != NULL) AND (GMacrotxtName != ""))
    if (not stat)
      Comment = "";
      PrintSfPeriodBody(sfcomissFile.Code, SfDefComRec.datePeriodBegin, SfAccrueRec.Amount, SfDefComRec.FIID_commSum, RashetAccountXO, "", 0, 0, Comment, 1, GMacrotxtName);
    else
      Comment = "Ошибка создания проводки";
      PrintSfPeriodBody(sfcomissFile.Code, SfDefComRec.datePeriodBegin, SfAccrueRec.Amount, SfDefComRec.FIID_commSum, RashetAccountXO, "", 0, 0, Comment, 1, GMacrotxtName);
    end
  end;

    
  return stat; 

end;










