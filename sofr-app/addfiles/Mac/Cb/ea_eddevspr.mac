/*
$Name:           ea_eddevspr.mac
$Module:         Электронный архив
$Description:    Формирование справки о ДЭВ
*/

import "ea_lib.mac";
import RmInter;
import rsexts;
import ServiceAction;
import EAInter;
import "batchemins.mac";
import "dlwreps.mac";
import "cb_sql.mac";

class SprBuchInfo
  var Chapter;
  var DebetCredit;
  var Acc         : string;
  var NDoc        : integer;
  var sumInNatCur : Numeric;
  var FiCode      : string;
  var sumInFIID   : Numeric;
end;

class SprCashInfo
  var EDocKind;
  var DebetCredit;
  var Acc         : string;
  var NDoc        : integer;
  var sumInNatCur : Numeric;
  var FiCode      : string;
  var sumInFIID   : Numeric;
end;

var BuchArray = TArray;
var Buch_SecArray = TArray;

var CashArray = TArray;
var Cash_SecArray = TArray;

/*всего таблиц в шаблоне*/
private const TemplTableTotal = 2;
/*всего таблиц */
private var TableTotal:integer;
/*номер таблицы*/
private var TableNum:integer;

var glEAMediaRegFileDir = "";

private macro GetListFileRegis_Stg(SprDate, Arr : @TArray)

  var res = true;

  var query;
  var rs;
  var params : TArray;
  var p;
  var stat = 0;

  CaptureOutput;
[
SELECT
   T_STOREUNITLOGID,
   T_NUMBER,
   T_DEPARTMENT,
   T_STOREUNITTYPE,
   T_STOREUNITSIZE,
   T_OPERDATE,
   T_CREATEDATE,
   T_CREATETIME,
   T_COMPLETEDATE,
   T_COMPLETETIME,
   T_COMPLETEREASON,
   T_RECORDDATE,
   T_RECORDTIME,
   T_STORAGECOMPLETEDATE,
   T_PERIODBEGINDATE,
   T_PERIODENDDATE,
   T_HASHVALUE,
   T_CREATOR,
   T_RECORDER,
   T_RECEIPTOR,
   T_COMMENT
 FROM dedstunitlog_dbt edstunitlog
   WHERE edstunitlog.t_RecordDate <> to_date('01 01 0001','dd.mm.yyyy')
         AND :SprDate BETWEEN edstunitlog.t_PeriodBeginDate AND edstunitlog.t_PeriodEndDate
];
  query = StopCaptureOutput;

  params = makeArray(SQLParam("SprDate", SprDate));

  rs = execSQLselect(query, params, true);

  while(rs and rs.moveNext())
    p = TRecHandler("edstunitlog");

    p.rec.STOREUNITLOGID      = rs.value(0);
    p.rec.NUMBER              = rs.value(1);
    p.rec.DEPARTMENT          = rs.value(2);
    p.rec.STOREUNITTYPE       = rs.value(3);
    p.rec.STOREUNITSIZE       = rs.value(4);
    p.rec.OPERDATE            = rs.value(5);
    p.rec.CREATEDATE          = rs.value(6);
    p.rec.CREATETIME          = rs.value(7);
    p.rec.COMPLETEDATE        = rs.value(8);
    p.rec.COMPLETETIME        = rs.value(9);
    p.rec.COMPLETEREASON      = rs.value(10);
    p.rec.RECORDDATE          = rs.value(11);
    p.rec.RECORDTIME          = rs.value(12);
    p.rec.STORAGECOMPLETEDATE = rs.value(13);
    p.rec.PERIODBEGINDATE     = rs.value(14);
    p.rec.PERIODENDDATE       = rs.value(15);
    p.rec.HASHVALUE           = rs.value(16);
    p.rec.CREATOR             = rs.value(17);
    p.rec.RECORDER            = rs.value(18);
    p.rec.RECEIPTOR           = rs.value(19);
    p.rec.COMMENT             = rs.value(20);

    var ImageDir = "";
    var RegFileName = "";

    stat = EA_GetImageDir(p, ImageDir);

    if(stat != 0)
      res = false;
      break;
    end;

    stat = EA_GetRegistryFileName(p, RegFileName);

    if(stat != 0)
      res = false;
      break;
    end;

    if(FindPath(RegFileName, ImageDir) == ImageDir + RegFileName)

      Arr[Arr.size] = ImageDir + RegFileName;

    end;

  end;

  return res;

end;

private macro GetListFileRegis_Med(SprDate, Arr : @TArray)

  var res = true;

  Array Text;
  Array Buttons;

  var Flag = true;

  while(Flag)

    Text(0) = "Добавить ЕХ к Справке о ДЭВ?";

    Buttons(0) = " Добавить ЕХ ";
    Buttons(1) = " Сформировать Справку ";
    Buttons(2) = " Отмена ";

    var N_Button = ConfWin(Text, Buttons, 0);

    if( N_Button == 0 )

      var Flag1 = true;

      while(Flag1)

        if (SelectFolder(@glEAMediaRegFileDir, glEAMediaRegFileDir, "Выбор ЕХ для добавления к Справке о ДЭВ", true))

          if (not ExistFile(glEAMediaRegFileDir))
            msgbox("Файл реестра не найден");
          else

            var ob = TDirList (glEAMediaRegFileDir + "reg(???)?????.xml","f");

            if(ob.Count == 0)
              msgbox("Файл реестра не найден");
            else

              ob.Sort(0);

              Flag1 = false;

              var xml = CreateXMLParser();

              res = xml.load(glEAMediaRegFileDir + ob.name (0));

              if(res == true)

                var rateList = xml.getElementsByTagName("dates");

                if(rateList != null)

                  var periodbegin = rateList.item(0).getAttribute("periodbegin");
                  var periodend   = rateList.item(0).getAttribute("periodend");

                  if((periodbegin < SprDate) AND (SprDate < periodend))

                    Arr[Arr.size] = glEAMediaRegFileDir + ob.name (0);

                  else

                    Flag1 = true;

                    msgbox("На ЕХ нет ДЭВ за указанную дату Справки.");

                  end;

                end;

              end;

            end;

          end;

        else

          Flag1 = false;

        end;

      end;

    end;

    if( N_Button == 1 )

      res = true;
      Flag = false;

    end;

    if( N_Button == 2 )

      res = false;
      Flag = false;

    end;

  end;

  return res;

end;

private macro  GetListFileRegis(regFileArray : @TArray, Date, DprtID, Stg, Med)

  var res = false;

  if(Stg == true) // хранилище образов ЕХ

    var EAStorageDir = GetEAStorageDir(DprtID);

    res = GetListFileRegis_Stg(Date, @regFileArray);

  else

    if(Med == true) // носители ЕХ

      res = GetListFileRegis_Med(Date, @regFileArray);

    end;

  end;

  return res;

end;

private macro StringToDate( str )
   return date( int(substr(str,9,10)), int(substr(str,6,7)), int(substr(str,1,4)) );
end;

private macro regFileArrayToEdDevSpravka_tmp(regFileArray)

  var stat = true;

  var p;

  var devsprSqlInsert :RsbBatchEmuInsert = RsbBatchEmuInsert( "eddevspravka.tmp", 100, 100 );

  devsprSqlInsert .Clear();

  var i = 0;

  while(i < regFileArray.size)

    var xml = CreateXMLParser();

    stat = xml.load(regFileArray(i));

    if(stat == true)

      p = TRecHandler("eddevspravka.tmp");

      p.rec.storeunitnumber = xml.getElementsByTagName("storeunit").item(0).getAttribute("number");

      //var edoclist = xml.getElementsByTagName("edoc-list");
      var edoclist = xml.getElementsByTagName("edoc");

      if(edoclist != null)

        var j = 0;

        while(j < edoclist.length)

          var edoc = edoclist.item(j);

          p.rec.edoclogid      = edoc/*.item(0)*/.getAttribute("edoclogid");
          p.rec.edocid         = edoc/*.item(0)*/.getAttribute("edocid");
          p.rec.docdate        = StringToDate(edoc/*.item(0)*/.getAttribute("docdate"));
          p.rec.basicedoclogid = edoc/*.item(0)*/.getAttribute("basicdocid");
          p.rec.iscashdoc      = edoc/*.item(0)*/.getAttribute("iscashdoc");
          p.rec.isacctrn       = edoc/*.item(0)*/.getAttribute("isacctrn");

            var edockind = edoc/*.item(0)*/.getElementsByTagName("edockind");
            p.rec.edockind = edockind.item(0).getAttribute("num");

            var branch = edoc/*.item(0)*/.getElementsByTagName("branch");
            p.rec.Branch = branch.item(0).getAttribute("code");

            var account = edoc/*.item(0)*/.getElementsByTagName("account");
            p.rec.chapter = account.item(0).getAttribute("chapter");

            var devspravka = edoc/*.item(0)*/.getElementsByTagName("devspravka");

            if(devspravka.length > 0)

              p.rec.suminnatcur = devspravka.item(0).getAttribute("SumInNatcur");

                var debet = devspravka.item(0).getElementsByTagName("debet");
                p.rec.debetaccount = debet.item(0).getAttribute("account");
                p.rec.debetficode = debet.item(0).getAttribute("ficode");
                p.rec.debetsuminfiid = SQL_ConvTypeSum(debet.item(0).getAttribute("SumInFIID"));
                p.rec.debetbalanceacc = SubStr( p.rec.debetaccount, 0, 5);

                var credit = devspravka.item(0).getElementsByTagName("credit");
                p.rec.creditaccount = credit.item(0).getAttribute("account");
                p.rec.creditficode = credit.item(0).getAttribute("ficode");
                p.rec.creditsuminfiid = SQL_ConvTypeSum(credit.item(0).getAttribute("SumInFIID"));
                p.rec.creditbalanceacc = SubStr( p.rec.creditaccount, 0, 5);

            end;

          devsprSqlInsert.AddRecord( p );

          j = j + 1;

        end;

      end;

    else

      break;

    end;

    i = i + 1;

  end;

  stat = devsprSqlInsert.Transfer();

  return stat;

end;

private macro GetEdDevSpravka(Arr : @TArray)

  var query;
  var rs;
  var p;
  var params;

  CaptureOutput;
[
SELECT
  T_STOREUNITNUMBER,
  T_EDOCLOGID,
  T_EDOCKIND,
  T_EDOCID,
  T_DOCDATE,
  T_BRANCH,
  T_BASICEDOCLOGID,
  T_CHAPTER,
  T_ISCASHDOC,
  T_ISACCTRN,
  T_SUMINNATCUR,
  T_DEBETACCOUNT,
  T_DEBETFICODE,
  T_DEBETSUMINFIID,
  T_DEBETBALANCEACC,
  T_CREDITACCOUNT,
  T_CREDITFICODE,
  T_CREDITSUMINFIID,
  T_CREDITBALANCEACC
 FROM DEDDEVSPRAVKA_TMP
];
  query = StopCaptureOutput;

  params = makeArray();

  rs = execSQLselect(query, params, true);

  while(rs and rs.moveNext())

    p = TRecHandler("eddevspravka.tmp");

    p.rec.STOREUNITNUMBER  = rs.value(0);
    p.rec.EDOCLOGID        = rs.value(1);
    p.rec.EDOCKIND         = rs.value(2);
    p.rec.EDOCID           = rs.value(3);
    p.rec.DOCDATE          = rs.value(4);
    p.rec.BRANCH           = rs.value(5);
    p.rec.BASICEDOCLOGID   = rs.value(6);
    p.rec.CHAPTER          = rs.value(7);
    p.rec.ISCASHDOC        = rs.value(8);
    p.rec.ISACCTRN         = rs.value(9);
    p.rec.SUMINNATCUR      = rs.value(10);
    p.rec.DEBETACCOUNT     = rs.value(11);
    p.rec.DEBETFICODE      = rs.value(12);
    p.rec.DEBETSUMINFIID   = rs.value(13);
    p.rec.DEBETBALANCEACC  = rs.value(14);
    p.rec.CREDITACCOUNT    = rs.value(15);
    p.rec.CREDITFICODE     = rs.value(16);
    p.rec.CREDITSUMINFIID  = rs.value(17);
    p.rec.CREDITBALANCEACC = rs.value(18);

    Arr[Arr.size] = p;

  end;

end;

private macro Make_Eddevspravka_Tmp(SprDate, ChDp, RDD, Car)

  var query;
  var params;
  var p;

  CaptureOutput;
[
INSERT INTO DEDDEVSPRAVKA_TMP (
  T_STOREUNITNUMBER,
  T_EDOCLOGID,
  T_EDOCKIND,
  T_EDOCID,
  T_DOCDATE,
  T_BRANCH,
  T_BASICEDOCLOGID,
  T_CHAPTER,
  T_ISCASHDOC,
  T_ISACCTRN,
  T_SUMINNATCUR,
  T_DEBETACCOUNT,
  T_DEBETFICODE,
  T_DEBETSUMINFIID,
  T_DEBETBALANCEACC,
  T_CREDITACCOUNT,
  T_CREDITFICODE,
  T_CREDITSUMINFIID,
  T_CREDITBALANCEACC)
SELECT
       SL.T_NUMBER STOREUNITNUMBER,
       Sr.T_EDOCLOGID EDOCLOGID,
       E.T_EDOCKINDID EDOCKIND,
       E.T_EDOCID EDOCID,
       E.T_DOCDATE DOCDATE,
       E.T_BRANCH BRANCH,
       E.T_BASICEDOCLOGID BASICEDOCLOGID,
       A.T_CHAPTER CHAPTER,
       DECODE(E.T_ISCASHDOC, NULL, CHR(1), CHR(0), CHR(1),E.T_ISCASHDOC) ISCASHDOC,
       DECODE(E.T_ISACCTRN, NULL, CHR(1), CHR(0), CHR(1), E.T_ISACCTRN) ISACCTRN,
       Sr.T_NATCURDOCSUM SUMINNATCUR,
       SR.T_DEBETACCOUNT DEBETACCOUNT,
       (SELECT fi.t_fi_code
          FROM DFININSTR_DBT fi
         WHERE fi.t_fiid = SR.T_DEBETFIID)
          DEBETFICODE,
       SR.T_DEBETSUM DEBETSUMINFIID,
       SUBSTR (SR.T_DEBETACCOUNT, 1, 5) DEBETBALANCEACC,
       SR.T_CREDITACCOUNT CREDITACCOUNT,
       (SELECT fi.t_fi_code
          FROM DFININSTR_DBT fi
         WHERE fi.t_fiid = SR.T_CreditFIID)
          CREDITFICODE,
       SR.T_CREDITSUM CREDITSUMINFIID,
       SUBSTR (SR.T_CREDITACCOUNT, 1, 5) CREDITBALANCEACC
  FROM dedoc_dbt e,
       dedstunitreg_dbt sr,
       dedstunitlog_dbt sl,
       daccount_dbt a
 WHERE     E.T_EDOCLOGID = Sr.T_EDOCLOGID
       AND E.T_STOREUNITLOGID = SL.T_STOREUNITLOGID(+)
       AND E.T_ACCOUNTID = A.T_ACCOUNTID(+)
];
  query = StopCaptureOutput;

  execSQL(query);

  // 5.1

  query = " delete from DEDDEVSPRAVKA_TMP where T_DOCDATE <> TO_DATE('" + string(SprDate) + "', 'DD.MM.YYYY')";

  execSQL(query);

  // 5.2

  if(ChDp == false)

    query = " delete from DEDDEVSPRAVKA_TMP eddevspravka "
            "   where NOT (eddevspravka.t_Branch = " + string({OperDprt}) + " OR "
            "         eddevspravka.t_Branch IN "
            "          (SELECT dp_dep.t_Code "
            "            FROM ddp_dep_dbt dp_dep "
            "             START WITH dp_dep.t_Code = " + string({OperDprt}) + " "
            "             CONNECT BY dp_dep.t_ParentCode = PRIOR dp_dep.t_Code AND dp_dep.t_NodeType = 2)) ";

    execSQL(query);

  else

    query = " delete from DEDDEVSPRAVKA_TMP eddevspravka "
            "   where NOT (eddevspravka.t_Branch IN "
            "    (SELECT dp_dep.t_Code "
            "      FROM ddp_dep_dbt dp_dep "
            "       START WITH dp_dep.t_Code = " + string({OperDprt}) + " CONNECT BY dp_dep.t_ParentCode = PRIOR dp_dep.t_Code AND dp_dep. t_EAStorageDir = chr(1))) ";

    execSQL(query);

  end;

  // 5.3

  query = " delete from DEDDEVSPRAVKA_TMP where T_EDOCKIND NOT BETWEEN 1 AND 10 AND T_EDOCKIND NOT IN (23, 24)";

  execSQL(query);

  // 5.4

  var EdDevSpravkaArray  = TArray();
  var EdDevSpravkaArray_Delete  = TArray();

  GetEdDevSpravka(@EdDevSpravkaArray);

  var i = 0;
  var j = 0;

  while(i < EdDevSpravkaArray.size)

    while(j < EdDevSpravkaArray.size)

      if(EdDevSpravkaArray(i).rec.EDOCLOGID == EdDevSpravkaArray(j).rec.BASICEDOCLOGID)

        EdDevSpravkaArray_Delete[EdDevSpravkaArray_Delete.size] = EdDevSpravkaArray(i);

      end;

      j = j + 1;

    end;

    i = i + 1;

  end;

  i = 0;

  while(i < EdDevSpravkaArray_Delete.size)

    query = " delete from DEDDEVSPRAVKA_TMP where T_EDOCLOGID = " + EdDevSpravkaArray_Delete(i).rec.EDOCLOGID;

    execSQL(query);

    i = i + 1;

  end;

  // 5.5

  if(RDD == false)

    query = " delete from DEDDEVSPRAVKA_TMP where T_IsAccTrn = CHR(1) ";

    execSQL(query);

  end;

  // 5.6

  if(Car == false)

    query = " delete from DEDDEVSPRAVKA_TMP where T_IsAccTrn <> CHR(1) ";

    execSQL(query);

  end;

end;

private macro GetEx_1()
  var query;
  var rs;
  var params : TArray;
  var Ex = "";

  CaptureOutput;
[
SELECT DISTINCT t_StoreUnitNumber
  FROM deddevspravka_tmp
WHERE t_IsCashDoc = chr(1) AND t_Chapter IN (1, 3)
  ORDER BY t_StoreUnitNumber
];

  query = StopCaptureOutput;

  params = makeArray();

  rs = execSQLselect(query, params, true);
  while(rs and rs.moveNext())
    Ex = Ex + rs.value(0) + ", ";
  end;

  Ex = substr(Ex, 1, strlen(Ex)-2);

  return Ex;

end;

private macro GetEx_2()
  var query;
  var rs;
  var params : TArray;
  var Ex = "";

  CaptureOutput;
[
SELECT DISTINCT t_StoreUnitNumber
FROM deddevspravka_tmp
WHERE t_IsCashDoc = 'X'
ORDER BY t_StoreUnitNumber
];

  query = StopCaptureOutput;

  params = makeArray();

  rs = execSQLselect(query, params, true);
  while(rs and rs.moveNext())
    Ex = Ex + rs.value(0) + ", ";
  end;

  Ex = substr(Ex, 1, strlen(Ex)-2);

  return Ex;

end;

macro Spr_PrintForm_End()
  DLWREPS_PrintReportFromTagFile( SetOutput (GetTxtFileName ("tmpout")) );
  SetOutput(NULL, false);
end;

private macro Get_Buch()

  var query;
  var parms;
  var rs;

  CaptureOutput;
  [
  SELECT * FROM
  (
    SELECT t_Chapter As Chapter,
       '0 debet' As DebetCredit,
        t_DebetAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_DebetFICode, 810, chr(1), t_DebetFICode) As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 1
      AND t_IsCashDoc = chr(1)
      AND t_DebetAccount IS NOT NULL AND t_DebetAccount <> chr(1)
    GROUP BY t_Chapter, t_DebetAccount, t_DebetFICode
  UNION
    SELECT t_Chapter As Chapter,
       '0 debet'  As DebetCredit,
       t_DebetAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_DebetFICode, 810, chr(1), t_DebetFICode) As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 3
      AND t_IsCashDoc = chr(1)
      AND t_DebetAccount IS NOT NULL AND t_DebetAccount <> chr(1)
      AND t_DebetBalanceAcc NOT IN ('99999', '99998')
    GROUP BY t_Chapter, t_DebetAccount, t_DebetFICode
  UNION
    SELECT t_Chapter As Chapter,
        '1 credit' As DebetCredit,
        t_CreditAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_CreditFICode, 810, chr(0), t_CreditFICode) As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 3
      AND t_IsCashDoc = chr(1)
      AND t_CreditAccount IS NOT NULL AND t_CreditAccount <> chr(1)
      AND t_CreditBalanceAcc NOT IN ('99999', '99998')
    GROUP BY t_Chapter, t_CreditAccount, t_CreditFICode
  ) spravka
  ORDER BY spravka.Chapter, spravka.DebetCredit, spravka.Acc, spravka.FICode
  ];

  query = StopCaptureOutput;

  parms = makeArray();

  rs = execSQLselect(query, parms, true);

  var i = 0;

  while(rs and rs.moveNext())

    var p = SprBuchInfo();

    p.Chapter       = rs.value(0);
    p.DebetCredit   = rs.value(1);
    p.Acc           = rs.value(2);
    p.NDoc          = rs.value(3);
    p.sumInNatCur   = rs.value(4);
    p.FiCode        = rs.value(5);
    p.sumInFIID     = rs.value(6);

    BuchArray[BuchArray.size] = p;

    i = i + 1;

  end;

end;

private macro Get_Buch_Sec()

  var query;
  var parms;
  var rs;

  CaptureOutput;
  [
  SELECT * FROM
  (
    SELECT t_Chapter As Chapter,
        '0 debet' As DebetCredit,
        t_DebetBalanceAcc As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(1)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 1
    AND t_IsCashDoc = chr(1)
    AND t_DebetBalanceAcc IS NOT NULL AND t_DebetBalanceAcc <> chr(1)
    GROUP BY t_Chapter, t_DebetBalanceAcc
    UNION
    SELECT  t_Chapter As Chapter,
        '0 debet' As DebetCredit,
        t_DebetBalanceAcc As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_DebetFICode As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 1
    AND t_IsCashDoc = chr(1)
    AND t_DebetFICode <> 810
    AND t_DebetBalanceAcc IS NOT NULL AND t_DebetBalanceAcc <> chr(1)
    GROUP BY t_Chapter, t_DebetBalanceAcc, t_DebetFICode
  UNION
    SELECT t_Chapter As Chapter,
        '0 debet' As DebetCredit,
        t_DebetBalanceAcc As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(1)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 3
    AND t_DebetBalanceAcc NOT IN ('99999', '99998')
    AND t_IsCashDoc = chr(1)
    AND t_DebetBalanceAcc IS NOT NULL AND t_DebetBalanceAcc <> chr(1)
    GROUP BY t_Chapter, t_DebetBalanceAcc
    UNION
    SELECT  t_Chapter As Chapter,
        '0 debet' As DebetCredit,
        t_DebetBalanceAcc As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_DebetFICode As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 3
    AND t_DebetBalanceAcc NOT IN ('99999', '99998')
    AND t_IsCashDoc = chr(1)
    AND t_DebetFICode <> 810
    AND t_DebetBalanceAcc IS NOT NULL AND t_DebetBalanceAcc <> chr(1)
    GROUP BY t_Chapter, t_DebetBalanceAcc, t_DebetFICode
  UNION
    SELECT t_Chapter As Chapter,
        '1 credit' As DebetCredit,
        t_CreditAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(1)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 3
    AND t_CreditAccount NOT IN ('99999', '99998')
    AND t_IsCashDoc = chr(1)
    AND t_CreditAccount IS NOT NULL AND t_CreditAccount <> chr(1)
    GROUP BY t_Chapter, t_CreditAccount
    UNION
    SELECT  t_Chapter As Chapter,
        '0 debet' As DebetCredit,
        t_CreditAccount As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_CreditFICode As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_Chapter = 3
    AND t_CreditAccount NOT IN ('99999', '99998')
    AND t_IsCashDoc = chr(1)
    AND t_CreditFICode <> 810
    AND t_CreditAccount IS NOT NULL AND t_CreditAccount <> chr(1)
    GROUP BY t_Chapter, t_CreditAccount, t_CreditFICode
  ) spravka
  ORDER BY spravka.Chapter, spravka.DebetCredit, spravka.Acc, spravka.FICode
  ];

  query = StopCaptureOutput;

  parms = makeArray();

  rs = execSQLselect(query, parms, true);

  var i = 0;

  while(rs and rs.moveNext())

    var p = SprBuchInfo();

    p.Chapter       = rs.value(0);
    p.DebetCredit   = rs.value(1);
    p.Acc           = rs.value(2);
    p.NDoc          = rs.value(3);
    p.sumInNatCur   = rs.value(4);
    p.FiCode        = rs.value(5);
    p.sumInFIID     = rs.value(6);

    Buch_SecArray[Buch_SecArray.size] = p;

    i = i + 1;

  end;

end;

private macro Get_Cash()

  var query;
  var parms;
  var rs;

  CaptureOutput;
  [
  SELECT * FROM
  (
    SELECT '0 inorder' As EDocKind,
        '1 credit' As DebetCredit,
         t_CreditAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_CreditFICode, 810, chr(1), t_CreditFICode) As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_IsCashDoc = 'X'
    AND t_EDocKind = 9
    AND t_CreditAccount IS NOT NULL AND t_CreditAccount <> chr(1)
    GROUP BY t_CreditAccount, t_CreditFICode
  UNION
    SELECT '1 outorder' As EDocKind,
        '0 debet' As DebetCredit,
         t_DebetAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_DebetFICode, 810, chr(1), t_DebetFICode) As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_IsCashDoc = 'X'
    AND t_EDocKind = 10
    AND t_DebetAccount IS NOT NULL AND t_DebetAccount <> chr(1)
    GROUP BY t_DebetAccount, t_DebetFICode
  UNION
    SELECT '2 all' As EDocKind,
        '0 debet' As DebetCredit,
         t_DebetAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_DebetFICode, 810, chr(1), t_DebetFICode) As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_IsCashDoc = 'X'
    AND t_EDocKind = 23
    AND t_DebetBalanceAcc NOT IN ('99999', '99998')
    AND t_DebetAccount IS NOT NULL AND t_DebetAccount <> chr(1)
    GROUP BY t_DebetAccount, t_DebetFICode
  UNION
    SELECT '2 all' As EDocKind,
        '1 credit' As DebetCredit,
         t_CreditAccount As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur,
        DECODE(t_CreditFICode, 810, chr(1), t_CreditFICode) As FiCode,
        Sum(t_DebetSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_IsCashDoc = 'X'
    AND t_EDocKind = 23
    AND t_CreditBalanceAcc NOT IN ('99999', '99998')
    AND t_CreditAccount IS NOT NULL AND t_CreditAccount <> chr(1)
    GROUP BY t_CreditAccount, t_CreditFICode
  ) spravka
  ORDER BY spravka.EDocKind, spravka.DebetCredit, spravka.Acc, spravka.FICode
  ];

  query = StopCaptureOutput;

  parms = makeArray();

  rs = execSQLselect(query, parms, true);

  var i = 0;

  while(rs and rs.moveNext())

    var p = SprCashInfo();

    p.EDocKind      = rs.value(0);
    p.DebetCredit   = rs.value(1);
    p.Acc           = rs.value(2);
    p.NDoc          = rs.value(3);
    p.sumInNatCur   = rs.value(4);
    p.FiCode        = rs.value(5);
    p.sumInFIID     = rs.value(6);

    CashArray[CashArray.size] = p;

    i = i + 1;

  end;

end;

private macro Get_Cash_Sec()

  var query;
  var parms;
  var rs;

  CaptureOutput;
  [
  SELECT * FROM
  (
    SELECT  '0 inorder' As EDocKind,
        '1 credit' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(0)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind = 9
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    GROUP BY t_CreditBalanceAcc
    UNION
    SELECT  '0 inorder' As EDocKind,
        '1 credit' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_CreditFICode As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind = 9
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    AND t_CreditFICode <> 810
    GROUP BY t_CreditBalanceAcc, t_CreditFICode
  UNION
    SELECT  '1 outorder' As EDocKind,
        '0 debet' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(0)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind = 10
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    GROUP BY t_CreditBalanceAcc
    UNION
    SELECT  '1 outorder' As EDocKind,
        '0 debet' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_CreditFICode As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind = 10
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    AND t_CreditFICode <> 810
    GROUP BY t_CreditBalanceAcc, t_CreditFICode
  UNION
    SELECT  '2 all'  As EDocKind,
        '0 debet' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(0)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind NOT IN (9, 10)
    AND t_DebetBalanceAcc NOT IN ('99999', '99998')
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    GROUP BY t_CreditBalanceAcc
    UNION
    SELECT  '2 all'  As EDocKind,
        '0 debet' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_CreditFICode As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind NOT IN (9, 10)
    AND t_DebetBalanceAcc NOT IN ('99999', '99998')
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    AND t_CreditFICode <> 810
    GROUP BY t_CreditBalanceAcc, t_CreditFICode
  UNION
    SELECT  '2 all'  As EDocKind,
        '1 credit' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        count(*) As NDoc,
        Sum(t_SumInNatCur) As sumInNatCur ,
        chr(0)  As FiCode,
        0  As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind NOT IN (9, 10)
    AND t_CreditBalanceAcc NOT IN ('99999', '99998')
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    GROUP BY t_CreditBalanceAcc
    UNION
    SELECT  '2 all'  As EDocKind,
        '1 credit' As DebetCredit,
        t_CreditBalanceAcc As Acc,
        0 As NDoc,
        0 As sumInNatCur,
        t_CreditFICode As FiCode,
        Sum(t_CreditSumInFIID) As sumInFIID
    FROM deddevspravka_tmp
    WHERE t_EDocKind NOT IN (9, 10)
    AND t_CreditBalanceAcc NOT IN ('99999', '99998')
    AND t_CreditBalanceAcc IS NOT NULL AND t_CreditBalanceAcc <> chr(1)
    AND t_CreditFICode <> 810
    GROUP BY t_CreditBalanceAcc, t_CreditFICode
  ) spravka
  ORDER BY spravka.EDocKind, spravka.DebetCredit, spravka.Acc, spravka.FICode
  ];

  query = StopCaptureOutput;

  parms = makeArray();

  rs = execSQLselect(query, parms, true);

  var i = 0;

  while(rs and rs.moveNext())

    var p = SprCashInfo();

    p.EDocKind      = rs.value(0);
    p.DebetCredit   = rs.value(1);
    p.Acc           = rs.value(2);
    p.NDoc          = rs.value(3);
    p.sumInNatCur   = rs.value(4);
    p.FiCode        = rs.value(5);
    p.sumInFIID     = rs.value(6);

    Cash_SecArray[Cash_SecArray.size] = p;

    i = i + 1;

  end;

end;

macro SprMake(
              Date,
              Buch,
              Cash,
              DprtID,
              DprtName,
              DprtPartyName,
              ChDp,
              Acc,
              Sec,
              Stg,
              Med,
              NoRec,
              RDD,
              Car
             )

  var stat = true;

  var p;

  var query;
  var rs;
  var parms;

  var i = 0;

  execSQL("truncate table DEDDEVSPRAVKA_TMP");

  var regFileArray  = TArray();

  stat = GetListFileRegis( @regFileArray, Date, DprtID, Stg, Med );

  if(stat == true)

    stat = regFileArrayToEdDevSpravka_tmp(regFileArray);

  end;

  if(stat == true)

    if(NoRec == true)

      Make_Eddevspravka_Tmp(Date, ChDp, RDD, Car);

    end;

    if(Buch == true)

      if(Acc == true)

        Get_Buch();

        if(BuchArray.size != 0)

          println("EAEdDevSpr.dot");

          [~DS_sprvar];
          println("бухгалтерским");
          [~DS_date];
          println(Date);

          [~DS_bankfullname];
          println(GetDprtPartyName({OperDprtNode}));
          [~DS_bankshortname];
          println(GetDprtPartyShortName({OperDprtNode}));
          [~DS_dprtname];
          println(GetDprtName({OperDprt}));
          [~DS_dprtpartyname];
          println(GetDprtPartyName({OperDprt}));

          [~DS_ex];
          println(GetEx_1());
          
          [~DS_razdelA];
          println("");

        end;

        i = 0;

        var A_Postfix = 1;

        while(i < BuchArray.size)

          if((BuchArray(i).Chapter == 1) AND (BuchArray(i).DebetCredit == "0 debet"))

            if(A_Postfix == 1)

              [~DS_razdelA];
              println("Глава А");

            end;

            if(A_Postfix > 1)

              [~MultipleRow];
              println(1);
              println(1);

            end;

            println( "~DS_accA_" + A_Postfix );
            println(BuchArray(i).Acc);

            println( "~DS_ndocA_" + A_Postfix );
            println(BuchArray(i).NDoc);

            println( "~DS_suninnatcurA_" + A_Postfix );
            println(BuchArray(i).sumInNatCur);

            println( "~DS_ficodeA_" + A_Postfix );
            println(BuchArray(i).FiCode);

            println( "~DS_suminfiidA_" + A_Postfix );
            println(BuchArray(i).sumInFIID);

            A_Postfix = A_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(BuchArray.size != 0)

          if(A_Postfix == 1)
            [~DeleteTable];
            println("DS_accA_1");
          end;

          [~DS_razdelAA];
          println("");

          [~DeleteTable];
          println("DS_accAA_1");
        
          [~DS_razdelB];
          println("");          

        end;

        i = 0;

        while(i < BuchArray.size)

          if(BuchArray(i).Chapter == 3)

            [~DS_razdelB];
            println("Глава Б");

            break;

          end;

          i = i + 1;

        end;

        i = 0;

        var BD_Postfix = 1;

        while(i < BuchArray.size)

          if((BuchArray(i).Chapter == 3) AND (BuchArray(i).DebetCredit == "0 debet"))

            if(BD_Postfix == 1)

              [~DS_sideD];
              println("Дебет");

            end;

            if(BD_Postfix > 1)

              [~MultipleRow];
              println(2);
              println(1);
              println();
              println(2 + BD_Postfix - 1);

            end;

            println( "~DS_accBD_" + BD_Postfix );
            println(BuchArray(i).Acc);

            println( "~DS_ndocBD_" + BD_Postfix );
            println(BuchArray(i).NDoc);

            println( "~DS_suninnatcurBD_" + BD_Postfix );
            println(BuchArray(i).sumInNatCur);

            println( "~DS_ficodeBD_" + BD_Postfix );
            println(BuchArray(i).FiCode);

            println( "~DS_suminfiidBD_" + BD_Postfix );
            println(BuchArray(i).sumInFIID);

            BD_Postfix = BD_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(BuchArray.size != 0)

          if(BD_Postfix == 1)
            [~DeleteTable];
            println("DS_accBD_1");
          end;

        end;

        i = 0;

        var BK_Postfix = 1;

        while(i < BuchArray.size)

          if((BuchArray(i).Chapter == 3) AND (BuchArray(i).DebetCredit == "1 credit"))

            if(BK_Postfix == 1)

              [~DS_sideK];
              println("Кредит");

            end;

            if(BK_Postfix > 1)

              [~MultipleRow];
              println(2);
              println(1);
              println();
              println(3 + BD_Postfix - 1 + BK_Postfix - 1);

            end;

            println( "~DS_accBK_" + BK_Postfix );
            println(BuchArray(i).Acc);

            println( "~DS_ndocBK_" + BK_Postfix );
            println(BuchArray(i).NDoc);

            println( "~DS_suninnatcurBK_" + BK_Postfix );
            println(BuchArray(i).sumInNatCur);

            println( "~DS_ficodeBK_" + BK_Postfix );
            println(BuchArray(i).FiCode);

            println( "~DS_suminfiidBK_" + BK_Postfix );
            println(BuchArray(i).sumInFIID);

            BK_Postfix = BK_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(BuchArray.size != 0)

          if(BK_Postfix == 1)
            [~DeleteTable];
            println("DS_accBK_1");
          end;

          [~DS_nwrt];
          println(GetOperName({oper}));

          Spr_PrintForm_End();

        end;

      else

        if(Sec == true)

          Get_Buch_Sec();

          if(Buch_SecArray.size != 0)

            println("EAEdDevSpr.dot");

            [~DS_sprvar];
            println("бухгалтерским");
            [~DS_date];
            println(Date);

            [~DS_bankfullname];
            println(GetDprtPartyName({OperDprtNode}));
            [~DS_bankshortname];
            println(GetDprtPartyShortName({OperDprtNode}));
            [~DS_dprtname];
            println(GetDprtName({OperDprt}));
            [~DS_dprtpartyname];
            println(GetDprtPartyName({OperDprt}));

            [~DS_ex];
            println(GetEx_1());
            
            [~DS_razdelA];
            println("");            

          end;

          A_Postfix = 1;

          i = 0;

          while(i < Buch_SecArray.size)

            if((Buch_SecArray(i).Chapter == 1) AND (Buch_SecArray(i).DebetCredit == "0 debet"))

              if(A_Postfix == 1)

                [~DS_razdelA];
                println("Глава А");

              end;

              if(A_Postfix > 1)

                [~MultipleRow];
                println(1);
                println(1);

              end;

              println( "~DS_accA_" + A_Postfix );
              println(Buch_SecArray(i).Acc);

              println( "~DS_ndocA_" + A_Postfix );
              println(Buch_SecArray(i).NDoc);

              println( "~DS_suninnatcurA_" + A_Postfix );
              println(Buch_SecArray(i).sumInNatCur);

              println( "~DS_ficodeA_" + A_Postfix );
              println(Buch_SecArray(i).FiCode);

              println( "~DS_suminfiidA_" + A_Postfix );
              println(Buch_SecArray(i).sumInFIID);

              A_Postfix = A_Postfix + 1;

            end;

            i = i + 1;

          end;

          if(Buch_SecArray.size != 0)

            if(A_Postfix == 1)
              [~DeleteTable];
              println("DS_accA_1");
            end;

            [~DS_razdelAA];
            println("");

            [~DeleteTable];
            println("DS_accAA_1");
            
            [~DS_razdelB];
            println("");            

          end;

          i = 0;

          while(i < Buch_SecArray.size)

            if(Buch_SecArray(i).Chapter == 3)

              [~DS_razdelB];
              println("Глава Б");

              break;

            end;

            i = i + 1;

          end;

          BD_Postfix = 1;

          i = 0;

          while(i < Buch_SecArray.size)

            if((Buch_SecArray(i).Chapter == 3) AND (Buch_SecArray(i).DebetCredit == "0 debet"))

              if(BD_Postfix == 1)

                [~DS_sideD];
                println("Дебет");

              end;

              if(BD_Postfix > 1)

                [~MultipleRow];
                println(2);
                println(1);
                println();
                println(3 + BD_Postfix - 1);

              end;

              println( "~DS_accBD_" + BD_Postfix );
              println(Buch_SecArray(i).Acc);

              println( "~DS_ndocBD_" + BD_Postfix );
              println(Buch_SecArray(i).NDoc);

              println( "~DS_suninnatcurBD_" + BD_Postfix );
              println(Buch_SecArray(i).sumInNatCur);

              println( "~DS_ficodeBD_" + BD_Postfix );
              println(Buch_SecArray(i).FiCode);

              println( "~DS_suminfiidBD_" + BD_Postfix );
              println(Buch_SecArray(i).sumInFIID);

              BD_Postfix = BD_Postfix + 1;

            end;

            i = i + 1;

          end;

          if(Buch_SecArray.size != 0)

            if(BD_Postfix == 1)
              [~DeleteTable];
              println("DS_accBD_1");
            end;

          end;

          BK_Postfix = 1;

          i = 0;

          while(i < Buch_SecArray.size)

            if((Buch_SecArray(i).Chapter == 3) AND (Buch_SecArray(i).DebetCredit == "1 credit"))

              if(BK_Postfix == 1)

                [~DS_sideK];
                println("Кредит");

              end;

              if(BK_Postfix > 1)

                [~MultipleRow];
                println(2);
                println(1);
                println();
                println(5 + BD_Postfix - 1 + BK_Postfix - 1);

              end;

              println( "~DS_accBK_" + BK_Postfix );
              println(Buch_SecArray(i).Acc);

              println( "~DS_ndocBK_" + BK_Postfix );
              println(Buch_SecArray(i).NDoc);

              println( "~DS_suninnatcurBK_" + BK_Postfix );
              println(Buch_SecArray(i).sumInNatCur);

              println( "~DS_ficodeBK_" + BK_Postfix );
              println(Buch_SecArray(i).FiCode);

              println( "~DS_suminfiidBK_" + BK_Postfix );
              println(Buch_SecArray(i).sumInFIID);

              BK_Postfix = BK_Postfix + 1;

            end;

            i = i + 1;

          end;

          if(Buch_SecArray.size != 0)

            if(BK_Postfix == 1)
              [~DeleteTable];
              println("DS_accBK_1");
            end;

            [~DS_nwrt];
            println(GetOperName({oper}));

            Spr_PrintForm_End();

          end;

        end;

      end;

    end;

    if(Cash == true)

      if(Acc == true)

        Get_Cash();

        if(CashArray.size != 0)

          println("EAEdDevSpr.dot");

          [~DS_sprvar];
          println("кассовым");
          [~DS_date];
          println(Date);

          [~DS_bankfullname];
          println(GetDprtPartyName({OperDprtNode}));
          [~DS_bankshortname];
          println(GetDprtPartyShortName({OperDprtNode}));
          [~DS_dprtname];
          println(GetDprtName({OperDprt}));
          [~DS_dprtpartyname];
          println(GetDprtPartyName({OperDprt}));

          [~DS_ex];
          println(GetEx_2());
          
          [~DS_razdelA];
          println("");          

        end;

        A_Postfix = 1;

        i = 0;

        while(i < CashArray.size)

          if(CashArray(i).EDocKind == "0 inorder")

            if(A_Postfix == 1)

              [~DS_razdelA];
              println("Приходный кассовый ордер 0402008");

            end;

            if(A_Postfix > 1)

              [~MultipleRow];
              println(1);
              println(1);

            end;

            println( "~DS_accA_" + A_Postfix );
            println(CashArray(i).Acc);

            println( "~DS_ndocA_" + A_Postfix );
            println(CashArray(i).NDoc);

            println( "~DS_suninnatcurA_" + A_Postfix );
            println(CashArray(i).sumInNatCur);

            println( "~DS_ficodeA_" + A_Postfix );
            println(CashArray(i).FiCode);

            println( "~DS_suminfiidA_" + A_Postfix );
            println(CashArray(i).sumInFIID);

            A_Postfix = A_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(CashArray.size != 0)

          if(A_Postfix == 1)
            [~DeleteTable];
            println("DS_accA_1");
          end;
          
          [~DS_razdelAA];
          println("");

        end;

        var AA_Postfix = 1;

        i = 0;

        while(i < CashArray.size)

          if(CashArray(i).EDocKind == "1 outorder")

            if(AA_Postfix == 1)

              [~DS_razdelAA];
              println("Приходный кассовый ордер 0402009");

            end;

            if(AA_Postfix > 1)

              [~MultipleRow];
              println(2);
              println(1);

            end;

            println( "~DS_accAA_" + AA_Postfix );
            println(CashArray(i).Acc);

            println( "~DS_ndocAA_" + AA_Postfix );
            println(CashArray(i).NDoc);

            println( "~DS_suninnatcurAA_" + AA_Postfix );
            println(CashArray(i).sumInNatCur);

            println( "~DS_ficodeAA_" + AA_Postfix );
            println(CashArray(i).FiCode);

            println( "~DS_suminfiidAA_" + AA_Postfix );
            println(CashArray(i).sumInFIID);

            AA_Postfix = AA_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(CashArray.size != 0)

          if(AA_Postfix == 1)
            [~DeleteTable];
            println("DS_accAA_1");
          end;
          
          [~DS_razdelB];
          println("");          

        end;

        i = 0;

        while(i < CashArray.size)

          if(CashArray(i).EDocKind == "2 all")

            [~DS_razdelB];
            println("Ордер по передаче ценностей 0401102");

            break;

          end;

          i = i + 1;

        end;

        BD_Postfix = 1;

        i = 0;

        while(i < CashArray.size)

          if((CashArray(i).EDocKind == "2 all") AND
             (CashArray(i).DebetCredit == "0 debet"))

            if(BD_Postfix == 1)

              [~DS_sideD];
              println("Дебет");

            end;

            if(BD_Postfix > 1)

              [~MultipleRow];
              println(2);
              println(1);
              println();
              println(3 + BD_Postfix - 1);

            end;

            println( "~DS_accBD_" + BD_Postfix );
            println(CashArray(i).Acc);

            println( "~DS_ndocBD_" + BD_Postfix );
            println(CashArray(i).NDoc);

            println( "~DS_suninnatcurBD_" + BD_Postfix );
            println(CashArray(i).sumInNatCur);

            println( "~DS_ficodeBD_" + BD_Postfix );
            println(CashArray(i).FiCode);

            println( "~DS_suminfiidBD_" + BD_Postfix );
            println(CashArray(i).sumInFIID);

            BD_Postfix = BD_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(CashArray.size != 0)

          if(BD_Postfix == 1)
            [~DeleteTable];
            println("DS_accBD_1");
          end;

        end;

        BK_Postfix = 1;

        i = 0;

        while(i < CashArray.size)

          if((CashArray(i).EDocKind == "2 all") AND
             (CashArray(i).DebetCredit == "1 credit"))

            if(BK_Postfix == 1)

              [~DS_sideK];
              println("Кредит");

            end;

            if(BK_Postfix > 1)

              [~MultipleRow];
              println(2);
              println(1);
              println();
              println(5 + BD_Postfix - 1 + BK_Postfix - 1);

            end;

            println( "~DS_accBK_" + BK_Postfix );
            println(CashArray(i).Acc);

            println( "~DS_ndocBK_" + BK_Postfix );
            println(CashArray(i).NDoc);

            println( "~DS_suninnatcurBK_" + BK_Postfix );
            println(CashArray(i).sumInNatCur);

            println( "~DS_ficodeBK_" + BK_Postfix );
            println(CashArray(i).FiCode);

            println( "~DS_suminfiidBK_" + BK_Postfix );
            println(CashArray(i).sumInFIID);

            BK_Postfix = BK_Postfix + 1;

          end;

          i = i + 1;

        end;

        if(CashArray.size != 0)

          if(BK_Postfix == 1)
            [~DeleteTable];
            println("DS_accBK_1");
          end;

          [~DS_nwrt];
          println(GetOperName({oper}));

          Spr_PrintForm_End();

        end;

      else

        if(Sec == true)

          Get_Cash_Sec();

          if(Cash_SecArray.size != 0)

            println("EAEdDevSpr.dot");

            [~DS_sprvar];
            println("кассовым");
            [~DS_date];
            println(Date);

            [~DS_bankfullname];
            println(GetDprtPartyName({OperDprtNode}));
            [~DS_bankshortname];
            println(GetDprtPartyShortName({OperDprtNode}));
            [~DS_dprtname];
            println(GetDprtName({OperDprt}));
            [~DS_dprtpartyname];
            println(GetDprtPartyName({OperDprt}));

            [~DS_ex];
            println(GetEx_2());
            
            [~DS_razdelA];
            println("");            

          end;

          A_Postfix = 1;

          i = 0;

          while(i < Cash_SecArray.size)

            if(Cash_SecArray(i).EDocKind == "0 inorder")

              if(A_Postfix == 1)

                [~DS_razdelA];
                println("Приходный кассовый ордер 0402008");

              end;

              if(A_Postfix > 1)

                [~MultipleRow];
                println(1);
                println(1);

              end;

              println( "~DS_accA_" + A_Postfix );
              println(Cash_SecArray(i).Acc);

              println( "~DS_ndocA_" + A_Postfix );
              println(Cash_SecArray(i).NDoc);

              println( "~DS_suninnatcurA_" + A_Postfix );
              println(Cash_SecArray(i).sumInNatCur);

              println( "~DS_ficodeA_" + A_Postfix );
              println(Cash_SecArray(i).FiCode);

              println( "~DS_suminfiidA_" + A_Postfix );
              println(Cash_SecArray(i).sumInFIID);

              A_Postfix = A_Postfix + 1;

            end;

            i = i + 1;

          end;
          
          if(Cash_SecArray.size != 0)

            if(A_Postfix == 1)
              [~DeleteTable];
              println("DS_accA_1");
            end;
            
            [~DS_razdelAA];
            println("");            
          
          end;

          AA_Postfix = 1;

          i = 0;

          while(i < Cash_SecArray.size)

            if(Cash_SecArray(i).EDocKind == "1 outorder")

              if(AA_Postfix == 1)

                [~DS_razdelAA];
                println("Приходный кассовый ордер 0402009");

              end;

              if(AA_Postfix > 1)

                [~MultipleRow];
                println(2);
                println(1);

              end;

              println( "~DS_accAA_" + AA_Postfix );
              println(Cash_SecArray(i).Acc);

              println( "~DS_ndocAA_" + AA_Postfix );
              println(Cash_SecArray(i).NDoc);

              println( "~DS_suninnatcurAA_" + AA_Postfix );
              println(Cash_SecArray(i).sumInNatCur);

              println( "~DS_ficodeAA_" + AA_Postfix );
              println(Cash_SecArray(i).FiCode);

              println( "~DS_suminfiidAA_" + AA_Postfix );
              println(Cash_SecArray(i).sumInFIID);

              AA_Postfix = AA_Postfix + 1;

            end;

            i = i + 1;

          end;
          
          if(Cash_SecArray.size != 0)

            if(AA_Postfix == 1)
              [~DeleteTable];
              println("DS_accAA_1");
            end;
            
            [~DS_razdelB];
            println("");            
          
          end;

          i = 0;

          while(i < Cash_SecArray.size)

            if(Cash_SecArray(i).EDocKind == "2 all")

              [~DS_razdelB];
              println("Ордер по передаче ценностей 0402102");

              break;

            end;

            i = i + 1;

          end;

          BD_Postfix = 1;

          i = 0;

          while(i < Cash_SecArray.size)

            if((Cash_SecArray(i).EDocKind == "2 all") AND
               (Cash_SecArray(i).DebetCredit == "0 debet"))

              if(BD_Postfix == 1)

                [~DS_sideD];
                println("Дебет");

              end;

              if(BD_Postfix > 1)

                [~MultipleRow];
                println(2);
                println(1);
                println();
                println(3 + BD_Postfix - 1);

              end;

              println( "~DS_accBD_" + BD_Postfix );
              println(Cash_SecArray(i).Acc);

              println( "~DS_ndocBD_" + BD_Postfix );
              println(Cash_SecArray(i).NDoc);

              println( "~DS_suninnatcurBD_" + BD_Postfix );
              println(Cash_SecArray(i).sumInNatCur);

              println( "~DS_ficodeBD_" + BD_Postfix );
              println(Cash_SecArray(i).FiCode);

              println( "~DS_suminfiidBD_" + BD_Postfix );
              println(Cash_SecArray(i).sumInFIID);

              BD_Postfix = BD_Postfix + 1;

            end;

            i = i + 1;

          end;
          
          if(Cash_SecArray.size != 0)

            if(BD_Postfix == 1)
              [~DeleteTable];
              println("DS_accBD_1");
            end;
          
          end;

          BK_Postfix = 1;

          i = 0;

          while(i < Cash_SecArray.size)

            if((Cash_SecArray(i).EDocKind == "2 all") AND
               (Cash_SecArray(i).DebetCredit == "1 credit"))

              if(BK_Postfix == 1)

                [~DS_sideK];
                println("Кредит");

              end;

              if(BK_Postfix > 1)

                [~MultipleRow];
                println(2);
                println(1);
                println();
                println(5 + BD_Postfix - 1 + BK_Postfix - 1);

              end;

              println( "~DS_accBK_" + BK_Postfix );
              println(Cash_SecArray(i).Acc);

              println( "~DS_ndocBK_" + BK_Postfix );
              println(Cash_SecArray(i).NDoc);

              println( "~DS_suninnatcurBK_" + BK_Postfix );
              println(Cash_SecArray(i).sumInNatCur);

              println( "~DS_ficodeBK_" + BK_Postfix );
              println(Cash_SecArray(i).FiCode);

              println( "~DS_suminfiidBK_" + BK_Postfix );
              println(Cash_SecArray(i).sumInFIID);

              BK_Postfix = BK_Postfix + 1;

            end;

            i = i + 1;

          end;
          
          if(Cash_SecArray.size != 0)

            if(BK_Postfix == 1)
              [~DeleteTable];
              println("DS_accBK_1");
            end;

            [~DS_nwrt];
            println(GetOperName({oper}));

            Spr_PrintForm_End();
          
          end;

        end;

      end;

    end;

  end;

end;
