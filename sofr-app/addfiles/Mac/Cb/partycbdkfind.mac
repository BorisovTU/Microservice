/*
 * Пример макроса поиска субъекта в ЦБД клиентов объявленного 
 * в настройке CB/PARTY/CBDK/PERSON/MESMACROPERSON
 */

import PTInter, BankInter;

private macro DialogPartySyncQueryStep1()
  array Text;
  array Button;
  Text( 0) = "ИМИТАЦИЯ ИНТЕГРАЦИИ С ВНЕШНЕЙ ЦБД КЛИЕНТОВ";
  Text( 1) = " ";
  Text( 2) = "Дистрибутивная макрофункция partycbdkfind.mac.PartySyncQuery";
  Text( 3) = "имитирует синхронный запрос на поиск субъекта во внешней ЦБД";
  Text( 4) = "клиентов (MDM-системе).";
  Text( 5) = " ";
  Text( 6) = "Для полноценной интеграции доработайте макросы механизма";
  Text( 7) = "интеграции в соответствии с требованиями применяемой вами ЦБД";
  Text( 8) = " ";
  Text( 9) = "Для управления интеграцией с ЦБД используйте настройки реестра";
  Text(10) = "CB/PARTY/CBDK/";
  Text(11) = " ";
  Text(12) = "Подробнее об интеграции с внешней ЦБД клиентов см. документацию";
  Text(13) = "к системе RS-Bank V.6";
  Text(14) = " ";
  Text(15) = "Выберите вариант:";
  Text(16) = " ";
  Text(17) = "1. Субъект найден в ЦБД";
  Text(18) = "2. Субъект не найден в ЦБД";
  Text(19) = "3. ЦБД не отвечает";
  Text(20) = "4. Техническая ошибка ответа от ЦБД";
  Text(21) = " ";
  Button(0) = " 1 ";
  Button(1) = " 2 ";
  Button(2) = " 3 ";
  Button(3) = " 4 ";
  return confwin(Text, Button); 
end;

private macro DialogPartySyncQueryStep1_1()
  array Text;
  array Button;
  Text( 0) = "ИМИТАЦИЯ ИНТЕГРАЦИИ С ВНЕШНЕЙ ЦБД КЛИЕНТОВ";
  Text( 1) = " ";
  Text( 2) = "От внешней ЦБД клиентов (MDM-системы) условно получен ответ, что";
  Text( 3) = "клиент найден. В составе ответа содержится полный набор данных";
  Text( 4) = "клиента, который будет присвоен субъекту в справочнике субъектов";
  Text( 5) = "экономики (взамен имеющихся в системе).";
  Text( 6) = " ";
  Text( 7) = "В режиме имитации присваиваются только идентифицирующие данные,";
  Text( 8) = "использованные для поиска. Остальные данные, если они имеются у";
  Text( 9) = "субъекта, сохраняются.";
  Text(10) = " ";
  Button(0) = " Продолжить ";
  confwin(Text, Button);
  return 0;
end;

private macro DialogPartySyncQueryStep1_2()
  array Text;
  array Button;
  Text( 0) = "ИМИТАЦИЯ ИНТЕГРАЦИИ С ВНЕШНЕЙ ЦБД КЛИЕНТОВ";
  Text( 1) = " ";
  Text( 2) = "От внешней ЦБД клиентов (MDM-системы) условно получен ответ, что";
  Text( 3) = "клиент в ЦБД не найден. Сейчас пользователь получит оповещение";
  Text( 4) = "об этом и возможность продолжить начатую работу с субъектом";
  Text( 5) = "или выбрать иное действие. Если работа с субъектом будет";
  Text( 6) = "продолжена, то в ЦБД будет передан асинхронный запрос с данными";
  Text( 7) = "субъекта для его регистрации.";
  Text( 8) = " ";
  Text( 9) = "Если вводится новый субъект, то данные, которые пользователь";
  Text(10) = "ввёл в панели поиска, не потеряются: они заносятся в панель";
  Text(11) = "ввода нового субъекта.";
  Text(12) = " ";
  Button(0) = " Продолжить ";
  confwin(Text, Button);
  return "\"Клиент в ЦБД не найден\"";
end;

private macro DialogPartySyncQueryStep1_3()
  array Text;
  array Button;
  Text( 0) = "ИМИТАЦИЯ ИНТЕГРАЦИИ С ВНЕШНЕЙ ЦБД КЛИЕНТОВ";
  Text( 1) = " ";
  Text( 2) = "Внешняя ЦБД клиентов (MDM-система) условно не ответила на запрос";
  Text( 3) = "о поиске клиента в течение заданного тайм-аута. Сейчас";
  Text( 4) = "пользователь получит оповещение об этом и возможность продолжить";
  Text( 5) = "начатую работу с субъектом или выбрать иное действие. Если";
  Text( 6) = "работа с субъектом будет продолжена, то в ЦБД будет передан";
  Text( 7) = "асинхронный запрос с данными субъекта для его регистрации.";
  Text( 8) = " ";
  Text( 9) = "Если вводится новый субъект, то данные, которые пользователь";
  Text(10) = "ввёл в панели поиска, не потеряются: они заносятся в панель";
  Text(11) = "ввода нового субъекта.";
  Text(12) = " ";
  Button(0) = " Продолжить ";
  confwin(Text, Button);
  return 1;
end;

private macro DialogPartySyncQueryStep1_4()
  array Text;
  array Button;
  Text( 0) = "ИМИТАЦИЯ ИНТЕГРАЦИИ С ВНЕШНЕЙ ЦБД КЛИЕНТОВ";
  Text( 1) = " ";
  Text( 2) = "От транспортной компоненты условно получен ответ о технической";
  Text( 3) = "ошибке взаимодействия с ЦБД. Сейчас пользователь получит";
  Text( 4) = "оповещение об этом и возможность продолжить начатую работу с";
  Text( 5) = "субъектом или выбрать иное действие. Если работа с субъектом";
  Text( 6) = "будет продолжена, то в ЦБД будет передан асинхронный запрос с";
  Text( 7) = "данными субъекта для его регистрации.";
  Text( 8) = " ";
  Text( 9) = "Если вводится новый субъект, то данные, которые пользователь";
  Text(10) = "ввёл в панели поиска, не потеряются: они заносятся в панель";
  Text(11) = "ввода нового субъекта.";
  Text(12) = " ";
  Button(0) = " Продолжить ";
  confwin(Text, Button);
  return "\"Произошла техническая ошибка взаимодействия с ЦБД\"";
end;

private macro DialogPartySyncQuery()
  var Result = DialogPartySyncQueryStep1();
  
  if(Result == 0)
    Result = DialogPartySyncQueryStep1_1();
  elif(Result == 1)
    Result = DialogPartySyncQueryStep1_2();
  elif(Result == 2)
    Result = DialogPartySyncQueryStep1_3();
  elif(Result == 3)
    Result = DialogPartySyncQueryStep1_4();
  end;

  return Result;
end;

/* Функция формирования синхронного запроса
 * должна возвращать следующие коды: 
 *   0 - успешное выполнение вне зависимости найден или не найден субъект
 *   1 - тайм-аут
 *   2 - неверные значения полей
 *   3 - субъект не найден, реакция системы будет такой же как и при успешном выполнении
 * или
 *   "Описание ошибки" - вернуть строку с описанием ошибки
 */
macro PartySyncQuery(Party : RsbParty)
  /*Вернуть не 0, если ошибка*/
  return DialogPartySyncQuery();
end;

private macro DialogPartyUnsyncQuery()
  array Text;
  array Button;
  Text( 0) = "ИМИТАЦИЯ ИНТЕГРАЦИИ С ВНЕШНЕЙ ЦБД КЛИЕНТОВ";
  Text( 1) = " ";
  Text( 2) = "Дистрибутивная макрофункция partycbdkfind.mac.PartyUnsyncQuery";
  Text( 3) = "имитирует асинхронный запрос на регистрацию субъекта или";
  Text( 4) = "изменений его свойств во внешней ЦБД клиентов (MDM-системе).";
  Text( 5) = "Непосредственного ответа на запрос не ожидается. В последующем";
  Text( 6) = "транспортная компонента по инициативе реальной ЦБД должна";
  Text( 7) = "сообщить о синхронизации клиента вызовом макрофункции квитовки";
  Text( 8) = "partycbdkmatc.mac.PartyMatc, которая установит значения";
  Text( 9) = "атрибутам синхронизации и присвоит субъекту значение кода вида";
  Text(10) = "52 \"Код клиента в ЦБД\".";
  Text(11) = " ";
  Text(12) = "В режиме имитации значения атрибутам синхронизации будут условно";
  Text(13) = "установлены сейчас, см. панель \"Синхронизация с ЦБД клиентов\",";
  Text(14) = "вызываемую по [Ctrl-J] из панели субъекта. Значение кода не";
  Text(15) = "присваивается. Для поиска синхронизированных субъектов в списке";
  Text(16) = "можно воспользоваться фильтром.";
  Text(17) = " ";
  Text(18) = "Для полноценной интеграции доработайте макросы механизма";
  Text(19) = "интеграции в соответствии с требованиями применяемой вами ЦБД.";
  Text(20) = " ";
  Text(21) = "Для управления интеграцией с ЦБД используйте настройки реестра";
  Text(22) = "CB/PARTY/CBDK/";
  Text(23) = " ";
  Text(24) = "Подробнее об интеграции с внешней ЦБД клиентов см. документацию";
  Text(25) = "к системе RS-Bank V.6";
  Text(26) = " ";
  Button(0) = " Продолжить ";
  return confwin(Text, Button); 
end;

/* Функция формирования асинхронного запроса
 */
macro PartyUnsyncQuery(Party : RsbParty)
  /*Вернуть не 0, если ошибка*/
  DialogPartyUnsyncQuery();
  Party.CBDK_IsSynch    = true;
  Party.CBDK_DateUpdate = date();
  Party.CBDK_TimeUpdate = time();
  Party.Update();
  return 0;
end;
