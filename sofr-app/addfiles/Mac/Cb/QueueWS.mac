/*
$Name: QueueWS.mac
$Module: Ядро ГКБО
$Description: API RSL Web Sphere
*/

import "RequestWS.mac", "MessageWs.mac", "wsqueuemesandproc.mac";
import bankinter;
import rsd;
import "dlquery.mac";
import serviceaction; /* kva: для новой версии LoadClobData */
import "globals.mac", MesInter; /* kva: на всякий случай для трассы */
import XmlRpcInter;

// Прочитать CLOB  
/*
macro LoadClobData(id:integer)
  var dataSetLength;
  var Amount = 32000;
  var Offset = 0;
  var Data = "";
  var cmdLength = DL_RSDCommand("SELECT NVL(DBMS_LOB.GETLENGTH(t_xmltren), 0) as t_lengthClob FROM dqueue_exchange_dbt WHERE T_ID = ?");
  cmdLength.addParam(id);
  dataSetLength = cmdLength.execute();

  if(dataSetLength.moveNext())
    var lengthClob = Int(dataSetLength.lengthClob);

    while((lengthClob - Offset * Amount) > 0)
      var cmd = RSDCommand( " DECLARE  "
                           +"  v_clobData CLOB; "
                           +"  v_amount INTEGER := " + String(Amount) + "; "
                           +"  v_buffer VARCHAR2(" +String(Amount) + "); "
                           +" BEGIN "
                           +"   select t_xmltren into v_clobData FROM dqueue_exchange_dbt WHERE T_ID = ?;"
                           +"   DBMS_LOB.READ(v_clobData, v_amount, ?, v_buffer);"
                           +"   ? := v_buffer; "
                           +" END;");

      cmd.addParam("", RSDBP_IN, id );
      cmd.addParam("", RSDBP_IN, String(Offset * Amount + 1) );
      cmd.addParam("", RSDBP_OUT, V_STRING, Amount + 1);
      cmd.execute();
      Data = Data + cmd.value(1);
      Offset = Offset + 1;
    end;
  end;

  return Data;
end;
*/
/* 20191007 - kva: читаем CLOB правильно */
private macro LoadClobData(ID : integer)
  var query = "";
  var ParamXML;

  query = query + "SELECT ";
  query = query + "  t_ID, t_xmltren "; /*!!! CLOB-поле не должно быть первым*/
  query = query + "  FROM dqueue_exchange_dbt ";
  query = query + " WHERE t_ID = " + ID;
  /*!!!важно!!! инструмент требует, чтобы CLOB-поле не было первым в SELECT'е, иначе ошибка выполнения*/
  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())
    ParamXML = ds.xmltren;
  end;
  return ParamXML;
end;

macro writeQLog(QueueID, JMSMessageID, JMSCorrelationID, XMLTrEn)
   var queueName = "aq_incoming_ws";
   var direction = 1;
   var queue_type = 1;
   var async = 0;

   var reqId = XmlRpcRequestId;

   var res;

   var r = RsdCommand("{ ? = call WriteQueueLog( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) }");

   r.addParam("", RSDBP_OUT, V_INTEGER, res);

   r.addParam("", RSDBP_IN, queueName );
   r.addParam("", RSDBP_IN, direction );
   r.addParam("", RSDBP_IN, queue_type );
   r.addParam("", RSDBP_IN, async );
   r.addParam("", RSDBP_IN, XMLTrEn );
   r.addParam("", RSDBP_IN, JMSMessageID );
   r.addParam("", RSDBP_IN, JMSCorrelationID );
   r.addParam("", RSDBP_IN, reqId );

   r.addParam("", RSDBP_IN, 0 );
   r.addParam("", RSDBP_IN, "" );
   r.addParam("", RSDBP_IN, "" );

   r.execute;

   return res;

end; 

macro GetQueueMesAndProcess
(
    QueueID,          // ИД очереди
    JMSMessageID,     // ИД транспортного конверта в Web Sphere
    JMSCorrelationID, // ИД транспортного конверта в Web Sphere для ответного сообщения
    XMLTrEn           // XML транспортного конверта
)
    writeQLog(QueueID, JMSMessageID, JMSCorrelationID, XMLTrEn);
    return GetQueueMesAndProcessBody(QueueID, JMSMessageID, JMSCorrelationID, XMLTrEn);
end;


macro foGetQueueMesAndProcess(objectType, objectId, param, uuid)
  //maa130121 - попытка пофиксить ошибку с потерей идентификатора и не обработки запросов из вх. очереди
  if  (objectId == null)
     objectId = int(param);
  end;

  var cmdRep = RsdCommand("select t_queueid, t_jmsmessageid, t_jmscorrelationid, t_parentreqid " +
                         "  from dqueue_exchange_dbt " +
                         " where t_id = ?");
  cmdRep.addParam("", RSDBP_IN, objectId );
  cmdRep.execute();

  var rset = RsdRecordset( cmdRep );
  if ( rset.moveNext )
     var xmltren = LoadClobData(objectId);
/*
ToRSTrace("---!!!---TEST---!!!---");
ToRSTrace(xmltren);
*/
     var res = xmltren; // сообщения больше не кодируются в base64 SCR 278099 

/*
ToRSTrace("---!!!---TEST---!!!---");
ToRSTrace(xmltren);
*/
/*
ToRSTrace("---!!!---TEST---!!!---");
ToRSTrace(xmltren);
ToRSTrace("---!!!---TEST---!!!---");
*/
//     XMLTrEn = UTF8ToOEM(XMLTrEn); /* 20191007 - kva: чиним кодировку */ /* 20191112 - kva: чиним обратно */
/*
ToRSTrace("---!!!---TEST---!!!---");
ToRSTrace(rset.Value(0));
ToRSTrace(rset.Value(1));
ToRSTrace(rset.Value(2));
ToRSTrace(xmltren);
ToRSTrace("---!!!---TEST---!!!---");
*/
     /*return */GetQueueMesAndProcess(rset.Value(0), rset.Value(1), rset.Value(2), xmltren);

     return 0; /* 20191007 - kva: чиним возвращаемое значение */
  end; 

  return 0; /* 20191007 - kva: чиним возвращаемое значение */

end;



