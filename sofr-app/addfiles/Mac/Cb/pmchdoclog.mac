/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : pmchdoclog.mac
  Created     : 19.10.2010
  Description : ”®à¬¨à®¢ ­¨¥ ®âç¥â  ® ¬ áá®¢®¬ ¨§¬¥­¥­¨¨ à¥ª¢¨§¨â®¢
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import oralib, likepy, globals;

// ¥ç âì â ¡«¨æë ¯® ª àâ®â¥ª¥
private macro PrintTable(rs:RsdRecordset, count:@integer)

  var icount = 0;
  var CurIndexNum = rs.value("t_IndexNum");
  var IsEnd = false;

  if( rs.value("t_IndexNum") == 1 )
[  Š àâ®â¥ª  ü1]
  elif( rs.value("t_IndexNum") == 2 )
[  Š àâ®â¥ª  ü2]
  elif( rs.value("t_IndexNum") == 3 )
[  Š àâ®â¥ª  ®¦¨¤ ­¨ï à §à¥è¥­¨ï]
  end;

[  ÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
   ®¬¥à ¤®ªã¬.³„ â  ¤®ªã¬. ³   ‘ã¬¬      ³ˆŠ ¡ ­ª   ³‘ç¥â ¯« â¥«ìé¨ª        ³ ˆŠ ¡ ­ª  ³‘ç¥â ¯®«ãç â¥«ï        ³  ¥§ã«ìâ â ®¡à ¡®âª¨      
               ³            ³             ³¯« â¥«ìé¨ª ³                       ³ ¯®«ãç â¥«ï³                       ³                           
   ÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
  while( ((icount == 0) or (IsEnd = rs.moveNext())) and (CurIndexNum == rs.value("t_IndexNum")))
[  ############ ############ ############# ########### ####################### ########### ####################### ###########################]( rs.value("t_Number"):w,
                                                                                                                                                 date(rs.value("t_Date")),
                                                                                                                                                 rs.value("t_BaseAmount"),
                                                                                                                                                 rs.value("t_DbBankCode"):w,
                                                                                                                                                 rs.value("t_PayerAccount"):w:a,
                                                                                                                                                 rs.value("t_CrBankCode"):w,
                                                                                                                                                 rs.value("t_ReceiverAccount"):w,
                                                                                                                                                 IfThenElse( rs.value("t_ErrorMessage") == "", "„®ªã¬¥­â ®¡à ¡®â ­ ãá¯¥è­®", rs.value("t_ErrorMessage") ):w
                                                                                                                                               );
    icount = icount + 1;
  end;
[  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
[  ˆâ®£®: #################################

](icount:l);
  count = count + icount;
  return IsEnd;
end;

macro PM_ShowMassChDocLog( ChI1:bool, ChI2:bool, ChIWP:bool, Opers:TArray )

  var NameIndex = "";
  var i = 1;
  
  if( ChI1 )
    NameIndex = "ü1";
  end;

  if( ChI2 )
    NameIndex = NameIndex + IfThenElse( NameIndex != "", ", ü2", "ü2");
  end;
  
  if( ChIWP )
    NameIndex = NameIndex + IfThenElse( NameIndex != "", ", ®¦¨¤ ­¨ï à §à¥è¥­¨©", "®¦¨¤ ­¨ï à §à¥è¥­¨©");
  end;

[
   à®â®ª®« ¯à®æ¥¤ãàë ¨§¬¥­¥­¨ï à¥ª¢¨§¨â®¢ ¤®ªã¬¥­â®¢, ­ å®¤ïé¨åáï ¢ ª àâ®â¥ª å ##########################################

   „ â  ®âç¥â : ###################
   ˆá¯®«­¨â¥«ì: ##########################################################################################################
   „®ªã¬¥­âë ®¯¥à æ¨®­¨áâ®¢: ############################################################################################# ]( NameIndex,
                                                                                                                              {curdate},
                                                                                                                              {oper} + " "+ {Name_Oper},
                                                                                                                              IfThenElse(Opers.size > 0, Opers[0] + ",", "")
                                                                                                                            );
  while(i < Opers.size)
[                            ############################################################################################# ]( Opers[i] + IfThenElse(i == Opers.size - 1, "" , ",") );
    i = i + 1;
  end;

  var sel = "select lv.t_Name || ' ü ' || nd.t_Number || ' ®â ' || to_char(nd.t_Date, 'dd.mm.yyyy') as t_GroundChDoc, "
                   "to_char(h.t_DateFrom, 'dd.mm.yyyy') as t_DateFrom "
            "from dpminhist_tmp h, "
                 "dpmchndoc_dbt nd, "
                 "dllvalues_dbt lv "
            "where ROWNUM = 1 "
              "and nd.t_DocumentID = h.t_DocumentID "
              "and lv.t_List = 1681 "
              "and lv.t_Element = nd.t_DocumentKind ";
  var rs:RsdRecordset = RsdRecordset(sel);
  
  if( rs.moveNext() )
[  Žá­®¢ ­¨¥ ¨§¬¥­¥­¨ï à¥ª¢¨§¨â®¢: ######################################################################################
   ˆ§¬¥­¥­¨ï ¢áâã¯ îâ ¢ ¤¥©áâ¢¨¥ á ################             ] (rs.value("t_GroundChDoc"), rs.value("t_DateFrom"));
  end;
[ ];


  sel = " select rm.t_Number,                                                 "
        "        rm.t_Date,                                                   "
        "        pm.t_BaseAmount,                                             "
        "        db.t_BankCode as t_DbBankCode,                               "
        "        pm.t_PayerAccount,                                           "
        "        cr.t_BankCode as t_CrBankCode,                               "
        "        pm.t_ReceiverAccount,                                        "
        "        ods.t_ErrorMessage,                                          "
        "        case                                                         "
        "          when pm.t_PaymStatus = 2000 then                           "
        "            2                                                        "
        "          when pm.t_PaymStatus = 2100 then                           "
        "            3                                                        "
        "          else                                                       "
        "            1                                                        "
        "        end                                                          "
        "        as t_IndexNum                                                "+
        "   from doprdistaff_tmp ods,                                         "
        "        dpmpaym_dbt pm,                                              "
        "        dpmrmprop_dbt rm,                                            "
        "        dpmprop_dbt db,                                              "
        "        dpmprop_dbt cr                                               "
        "   where ods.t_ID_Step in ( select max(ods1.t_ID_Step)               "
        "                              from doprdistaff_tmp ods1              "
        "                               where ods1.t_OrderID = ods.t_OrderID) "               
        "     and pm.t_PaymentID = ods.t_OrderID                              "
        "     and rm.t_PaymentID = ods.t_OrderID                              "
        "     and db.t_PaymentID = ods.t_OrderID                              "
        "     and db.t_DebetCredit = 0                                        "
        "     and cr.t_PaymentID = ods.t_OrderID                              "
        "     and cr.t_DebetCredit = 1                                        "
        "     order by t_IndexNum                                             ";

  var cmd = RsdCommand(sel);
  cmd.NullConversion = true;
  rs = RsdRecordset( cmd );
  
  var IsPrintNextTable = true;
  var count = 0; 

  if( rs.moveNext() )
  
    while(IsPrintNextTable)
      IsPrintNextTable = PrintTable(rs, @count);
    end;

[  ˆâ®£® ®¡à ¡®â ­® ¤®ªã¬¥­â®¢: #################################](count:l);
  else
[  „®ªã¬¥­âë ­¥ ­ ©¤¥­ë ];
  end;

end;
