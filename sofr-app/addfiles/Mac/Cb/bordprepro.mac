/*
 $Name: bordprepro.mac
 $Module: Ядро Banking
 $Description: Предобработка банковского ордера
 */
//-----------------------------------------------------------------------------
// Блок     : 29058 - "Предобработка банковского ордера"
// Шаг      : 10    - "Предобработка"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, pmdefbo, pm_syscont, pmchk117, pmfm, bordchkrst, pmprepromass, pschkbnk;

var PaymentObj:RsbPayment;

MACRO ExecuteStep( doc, paymDoc, DocKind:integer, ID_Operation:integer, ID_Step:integer )
  var stat:integer = 0;

  // Обработка в БО - нет
  if( stat == 0 )
    stat = УстановитьСтатусыПлатежа( OPR_PAYM_BO_PROCESS, OPR_PAYM_ST_BO_NO );
  end;  

  if( stat != 0 )      
    msgbox("Ошибка при установке статуса платежа");
    return 1;
  end;

  // Выбор бэк-офиса
  stat = ОпределениеБэкОфиса( PaymentObj );

  if( stat == 0 ) // Системный контроль
    stat = ExecuteSysControlStep( PaymentObj );
    if( stat < 0 )
      return 1;
    elif( stat > 0 )
      return 0;
    end;
  end;
  
  if( stat == 0 ) // Проверка на причастность к терроризму
    stat = ПроверкаПричастностиТерроризму( PaymentObj );
    if( stat < 0 )
      return 1;
    elif( stat > 0 )
      return 0;
    end;
  end;
  
  if( stat == 0 ) // Проверка на банкротство
    stat = ПроверитьСтатусБанкротства( PaymentObj );
    if( stat < 0 )
      return 1;
    elif( stat > 0 )
      return 0;
    end;
  end;

  if( stat == 0 ) // Контроль по 117-И
    stat = КонтрольПо117И( PaymentObj );
    if( stat < 0 )
      return 1;
    elif( stat > 0 )
      return 0;
    end;
  end;
  
  if( stat == 0 ) // Проверка остатков по счетам
    stat = BOrd_CheckAccRest( PaymentObj, ID_Operation, ID_Step );
  end;
  
  return stat;
END;

/* -----------------------------------------------------------------------------
   Массовое выполнение шага "Предобработка банковского ордера"
   ----------------------------------------------------------------------------- */

/* -----------------------------------------------------------------------------
   Предтранзакционные действия 
   Все проверки отражаются только на временной таблице dpmprepro_tmp,
   никакие изменения в БД не делаются
   ----------------------------------------------------------------------------- */
macro PrepMassExecuteStep() 
  
  var stat:integer = execStoredFunc( "BB_BOPREPRO.MassPreprocessPrepare", V_INTEGER );

  if( not stat )
    stat = PM_MassPreproPrepare();
  end;

  if( stat )
    MemoryError( stat );
  end;

  return stat;

end;

/* -----------------------------------------------------------------------------
   Транзакционные действия 
   Всё, что напроверяли, отражается на статусах документа, платежа, операции 
   ----------------------------------------------------------------------------- */
macro MassExecuteStep()
  
  var stat:integer = execStoredFunc( "BB_BOPREPRO.MassPreprocessExecute", V_INTEGER );

  if( not stat )
    stat = PM_MassPreproExecute();
  end;

  if( stat )
    MemoryError( stat );
  end;

  return stat;

end;

/* -----------------------------------------------------------------------------
   Действия после транзакции
   Заполняем лог обработки платежей для отчета 
   ----------------------------------------------------------------------------- */
macro PostMassExecuteStep()

  var stat:integer = execStoredFunc( "PM_PREPRO.MassFillLog", V_INTEGER );

  if( stat )
    MemoryError( stat );
  end;

  return stat;

end;
