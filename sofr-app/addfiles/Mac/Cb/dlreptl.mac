/* IR 21.10.02  Перенес из векселей*/

Import osfile;

private var DLREPTL_DOT_PATH = SplitFile("./DOTFILE/"); /* Путь, где находится шаблон документа на терминале*/
/*заполняются извне для двухзвенки*/
var DLREPTL_UserTemplsDir = "";
var DLREPTL_TemplsDir = "";

/* Преобразовать путь в полный */
Import osfile;

MACRO PathToAbsolute (lpath)
    var dirn, filen, extn, slash;

    lpath = trim (lpath);
    dirn = SplitFile (lpath, filen, extn);
    lpath = MergeFile (dirn, filen, extn);

    if (SubStr (dirn, 2, 1) == ":")
        return lpath;
    end;

    slash = SplitFile ("/");
    if (SubStr (dirn, 1, 1) == slash)
        return lpath;
    end;

    return GetCWD + slash + lpath;
END;

MACRO DLREPTL_GetTxtFileDir
    var
    txtpath = GetSysDir(0),
    pos = Index (txtpath, ";");

    if (pos)
        txtpath = SubStr (txtpath, 1, pos);
    end;

    return PathToAbsolute(txtpath + "/");
END;

/* Работает только но терминале*/
MACRO DLREPTL_GetTxtFileName  (fname)
    var filen;
    SplitFile (fname, fname);
    return DLREPTL_GetTxtFileDir + fname + "." + UserNumber;
END;

MACRO DLREPTL_GetFullTxtFileName (fname)
    return PathToAbsolute( DLREPTL_GetTxtFileName (fname));
END;

MACRO DLREPTL_GetFullDotFileName (fname)
    return PathToAbsolute( DLREPTL_DOT_PATH + SplitFile("dlng") + fname);
END;

/*поискать шаблон по путям из настроек и вернуть путь, по которому он был найден
(только для двухзвенки)*/
MACRO DLREPTL_GetDotFileDir(dotfilename)
  var err = 0;
  var TemplsDir = "", GoalDir = "";
  private macro GetDir(TemplsDir, dotfilename)
    var tmpStr = "", Pos = 0;
    Pos = Index(TemplsDir, ";");
    while (Pos > 0)
      tmpStr = substr(TemplsDir, 1, Pos-1);
      TemplsDir = substr(TemplsDir, Pos+1);
      Pos = Index(TemplsDir, ";");
      if (ExistFile(tmpStr + "\\" + dotfilename))
        return tmpStr;
      end;
    end;
    if (ExistFile(TemplsDir + "\\" + dotfilename))
      return TemplsDir;
    end;
    return "";
  end;
  GoalDir = GetDir(DLREPTL_UserTemplsDir, dotfilename);
  if (GoalDir == "")
    GoalDir = GetDir(DLREPTL_TemplsDir, dotfilename);
  end;
  return GoalDir + "\\";
  
END;
MACRO DLREPTL_InitServerWork (dotfilename)
  if (ValType(dotfilename == V_STRING))
    DLREPTL_DOT_PATH = DLREPTL_GetDotFileDir(dotfilename);
  end;
  ReplaceMacro ("DLREPTL_GetTxtFileName", "GetTxtFileName"); /*На сервере доступна */
END;
