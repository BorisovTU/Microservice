import BankInter;

Отправка = 1;
file Справочник( bankdprt ) Normal key 0;
file Источник() dbf;
var TxtPath;
var err;
var DbfName;
var Строк;
var Новый;
var Код;
var МФО;

macro Найти_МФО( МФО )
  Справочник.MFO_Depart = МФО;
  Справочник.Corr_Acc = "";
  if( ( getGE( Справочник ) ) and ( Справочник.MFO_Depart == МФО ) )
    return 0;
  end;
  return 1;
end;

Строк = 0;

GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, TxtPath, err);
if (err != 0) 
  MsgBox ("Ошибка чтения настройки BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR"); 
end; 

DbfName = TxtPath + "\\uch.dbf";
if (not open (Источник, DbfName))
  MsgBox ("Ошибка при открытии файла " + DbfName);
end;

while( next( Источник ) )
  Новый = Найти_МФО( Источник.newnum );
  if( Новый )
    println( "Отсутствует ", Источник.newnum, " ", Источник.upr, " ", Источник.namep );
  else
    if( substr( Источник.Permfo, 1, 6 ) != "      " )
      Справочник.MFO_6dig = Источник.Permfo;
    end;
    Справочник.Code = Источник.upr;
    Справочник.Dispatch = Отправка;
    Код = Источник.upr;
    МФО = Справочник.MFO_Depart;
    update( Справочник );
    println( "Замена ", Справочник.MFO_Depart, "/", Справочник.Corr_Acc,
             " ", Справочник.Code, " ", Справочник.Name_Depart );
  end;
  Строк = Строк + 1;
  message( "Обработано: ", Строк );
end;
