/************************************************************************/
/*         Автоматизированная банковская система RS-Bank v6.0           */
/*                 Copyright (c) R-Style Software Lab 2005              */
/*  Имя файла        : cbsfinv.mac                                      */
/*  Описание         : Оплата ТО. Общие функции оплаты ТО               */
/*  Программист      : Чернов А.Г.                                      */
/*  Создан           : 02-11-2005                                       */
/************************************************************************/

import "globals.mac", OprInter, InsCarryDoc, PaymInter, SFInter, CurrInter, FIInter, RsbDataSet;

const SfGround = "ПЗО. Требование на оплату N ";
/*const BankNameLen = 140;*/

// Формирование строки назначения платежа для ТО
macro MakeGround(SfInv)
    var Ground;

    Ground = SfGround + SfInv.DocNumber + " от " + SfInv.InvoiceDate;
    
    if (SfInv.NDSAmount > 0)
        Ground = Ground + ", в том числе НДС " + SfInv.NDSAmount;
    else
        Ground = Ground + ", без НДС";
    end;     
    
    return Ground;                             
end;

/* Перебор всех вставленных на предыдущем шаге документов */
macro SfGetPrevDoc( sfinv, callback:@variant )
  var docs = TArray;
  var iCount = 0;
  var oprchilddoc = TrecHandler("oprchilddoc.rec");
  var stat = 1;

  docs = OprGetChildDocs();
  while( iCount < docs.Size )
    oprchilddoc = docs[iCount];
    if( (oprchilddoc.rec.dockind == DLDOC_BANKPAYMENT) or
        (oprchilddoc.rec.dockind == BBANK_CPORDER) or
        (oprchilddoc.rec.dockind == DLDOC_MEMORIALORDER) or
        (oprchilddoc.rec.dockind == DLDOC_BANKCLAIM) or 
        (oprchilddoc.rec.dockind == PS_PAYORDER) or
        (oprchilddoc.rec.dockind == PS_CPORDER) )
      stat = ExecMacro2(@callback, oprchilddoc, sfinv);
      if( stat == 0 ) /* нашли, что нужно */
        return stat;
      end;
    end;
    iCount = iCount + 1;
  end;

  return stat;
end;

/* Конвертировать сумму требования из валюты ТО в валюту оплаты */
macro SfConvertSum( sfinv )
  var err, Sum;

  if( sfinv.PayFIID == sfinv.InvoiceFIID )
    return sfinv.TotalAmount;
  end;

  if( sfinv.IsFixedRate == "X" )
    return sfinv.TotalAmount * sfinv.FixedRateValue;
  end;

  if( sfinv.PayRateDateKind == SFINV_RATEDATEKIND_DRAWN )
    if( ConvSum( Sum, sfinv.TotalAmount, sfinv.InvoiceDate, sfinv.InvoiceFIID, sfinv.PayFIID, sfinv.PayRateDateKind ) != 0 )
      Sum = 0;
    end;
    InitError();
  else
    Sum = 0;
    msgbox( "Невозможно определить курс пересчета на будущую дату" );
  end;

  return Sum * (1 + sfinv.PayRatePercent/100.0);
end;

/*
/* Заполнить параметры платежа по ТО */
macro SfFillPayment( Paym, 
                     sfinv, 
                     IsClass /* Признак заполнение класса или буферов */
                   )

  if( ValType(IsClass) == V_UNDEF )
    IsClass = true;
  end;

  if( IsClass )
    Paym.Number = sfinv.DocNumber;

    Paym.SetPayerPI( PAYMENTS_GROUP_UNDEF,
                     sfinv.PayerBankID,
                     sfinv.PayerBankCodeKind,
                     sfinv.PayerBankCode,
                     SubStr(sfinv.PayerBankName, 1, BankNameLen),
                     sfinv.PayerCorrAcc,
                     sfinv.PayFIID,
                     1/*CHAPT1*/,
                     sfinv.PayerAccount,
                     sfinv.PayerID,
                     SubStr(sfinv.PayerName, 1, BankNameLen),
                     sfinv.PayerINN,
                     sfinv.PayerCodeKind,
                     sfinv.PayerCode
                   );
    Paym.SetReceiverPI( PAYMENTS_GROUP_UNDEF,
                        sfinv.BeneBankID,
                        sfinv.BeneBankCodeKind,
                        sfinv.BeneBankCode,
                        SubStr(sfinv.BeneBankName, 1, BankNameLen),
                        "",
                        sfinv.PayFIID,
                        1/*CHAPT1*/,
                        sfinv.BeneAccount,
                        sfinv.BeneID,
                        SubStr(sfinv.BeneName, 1, BankNameLen),
                        sfinv.BeneINN,
                        sfinv.BeneCodeKind,
                        sfinv.BeneCode
                      );

     Paym.CryptoAction( string("Автоматическое_формирование_платежей") );
  else

    Paym.Payer           = sfinv.PayerID;
    Paym.PayerCodeKind   = sfinv.PayerCodeKind;
    Paym.PayerCode       = sfinv.PayerCode;
    Paym.PayerAccount    = sfinv.PayerAccount;
    Paym.PayerBankID     = sfinv.PayerBankID;

    Paym.Receiver        = sfinv.BeneID;
    Paym.ReceiverCodeKind= sfinv.BeneCodeKind;
    Paym.ReceiverCode    = sfinv.BeneCode;
    Paym.ReceiverAccount = sfinv.BeneAccount;
    Paym.ReceiverBankID  = sfinv.BeneBankID;

  end;

  if( IsClass )
    Paym.PayerAmount = SfConvertSum(sfinv);
    Paym.Ground = MakeGround(sfinv); //SfGround + sfinv.DocNumber + " от "+ sfinv.InvoiceDate;
  else
    Paym.Amount = SfConvertSum(sfinv);
  end;

  Paym.ValueDate = sfinv.InvoiceDate;

  Paym.ShifrOper   = "01";
  Paym.NumberPack  = 995;
  Paym.PaymentKind = "Э";
  Paym.Priority    = 6;
  Paym.PayDate     = sfinv.InvoiceDate;
  Paym.Date        = sfinv.InvoiceDate;
end;

/* проверить, обслуживается ли клиент в заданном филиале */
macro CheckClientDepart( PartyID, ServKind, OperDprt )
  var q, rsb;

  q = " select t_department "
    + " from dclient_dbt "
    + " where t_partyid = " + string(PartyID)
    + " and t_servicekind = " + string(ServKind) 
    + " and t_department = " + string(OperDprt)
    + " and (t_branch = " + string(OperDprt) + " or t_branch = 0) ";

  rsb = TRsbDataSet( q );
  if( rsb.MoveNext() )
    return true;
  end;

  return false;
end;
*/


