/*
$Name:        replication.mac
$Module:      Ядро ГКБО
$Description: Процедура репликации НСИ.
*/

/************************************************************************/
/*                                                                      */   
/* Репликация НСИ                                                       */
/*                                                                      */
/************************************************************************/

import ServiceAction, BankInter, globals, CTInter, PTInter, Календарь, mfo_lib, ws_fmterror;

record pan(P_RNCI ,"bank.lbr") dialog;

var nCount : integer;

var Mode; /*Режим задания интеграции с 5.50:
            0 - интеграция отключена;
            1 - интеграция включена;
            2 - включен режим имитации*/

var g_iNumPlan;

macro CallGetNamePlan(iNumPlan)
  var stat = 0;
  var error : string;
  var locale:string = "";
  GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_5.50\\SERVICE_PATH", V_STRING, locale, stat);
  
  if(stat != 0)
    /*Ошибка pежима задания пути к сервису ТК 5.50*/
    stat = 29049;
    CreateErrMsg(stat);
    DisplayError();
  else
    var mes = TXRRequest();
    mes.reqId = CreateGUID();
    mes.macroName = "ws_nameplan";
    mes.macroFunc = "CallGetNamePlan";
    mes.direction = "1";
    mes.Parm = iNumPlan;
    var inParams = TArray;
    var prm_request = RslSoapPrm;
    var prm_timeout = RslSoapPrm;
    var prm_priority = RslSoapPrm;
    prm_request.Name = "request";
    prm_request.Value = mes.GenerateMessage();
    inParams[0] = prm_request;
    prm_timeout.Name = "timeout";
    prm_timeout.Value = 0;
    inParams[1] = prm_timeout;
    prm_priority.Name = "priority";
    prm_priority.Value = 0;
    inParams[2] = prm_priority;
    var url = locale;
    var method = "XMLRPCCall";
    var outParams;
    var encoding;
    var outResponse;
    var errMsg : string;
    var obj;
    var i = 0;
    var guid = CreateGUID();
    stat = CallSimpleExtService(guid, url, method, inParams, "", "", 600, outParams, encoding, 
                                  outResponse, errMsg);
    if(stat)
      return errMsg;
    else
      // создаем MS-парсер
      var xml = CreateXMLParser();
      xml.validateOnParse = true;
      xml.async = false;
      // парсим полученный SOAP-ответ
      var res = xml.loadXML(outResponse);
      var XMLRPCCallResult = xml.getElementsByTagName("XMLRPCCallResult");
      var XMLResult = XMLRPCCallResult.item(0).text;
      stat = ConvertToRsl(XMLResult, obj);
      // проверить существование информации об ошибке в ответе сервиса
      var iprop = GenPropID(obj, "faultString"); 
      if(iprop != -1) // обращаемся к свойству, если оно существует в объекте
        //errMsg = obj.faultString;
        return obj.faultString;//println("faultString=", obj.faultString);
      end;
    end;
  end;
  return null;
end;

macro CallGetCapital(Date)
  var stat = 0;
  var error;
  var locale:string = "";
  GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_5.50\\SERVICE_PATH", V_STRING, locale, stat);
  
  if(stat != 0)
    /*Ошибка pежима задания пути к сервису ТК 5.50*/
    stat = 29049;
    CreateErrMsg(stat);
    DisplayError();
  else
    var mes = TXRRequest();
    mes.reqId = CreateGUID();
    mes.macroName = "ws_ptcapital";
    mes.macroFunc = "CallGetCapital";
    mes.direction = "1";
    mes.Parm = Date;
    var inParams = TArray;
    var prm_request = RslSoapPrm;
    var prm_timeout = RslSoapPrm;
    var prm_priority = RslSoapPrm;
    prm_request.Name = "request";
    prm_request.Value = mes.GenerateMessage();
    inParams[0] = prm_request;
    prm_timeout.Name = "timeout";
    prm_timeout.Value = 0;
    inParams[1] = prm_timeout;
    prm_priority.Name = "priority";
    prm_priority.Value = 0;
    inParams[2] = prm_priority;
    var url = locale;
    var method = "XMLRPCCall";
    var outParams;
    var encoding;
    var outResponse;
    var errMsg:string;
    var obj;
    var i = 0;
    var guid = CreateGUID();
    stat = CallSimpleExtService(guid, url, method, inParams, "", "", 60, outParams, encoding, 
                                 outResponse, errMsg);
    if(stat)
      return errMsg;
    else
      // создаем MS-парсер
      var xml = CreateXMLParser();
      xml.validateOnParse = true;
      xml.async = false;
      // парсим полученный SOAP-ответ
      var res = xml.loadXML(outResponse);
      var XMLRPCCallResult = xml.getElementsByTagName("XMLRPCCallResult");
      var XMLResult = XMLRPCCallResult.item(0).text;
      stat = ConvertToRsl(XMLResult, obj);
      // проверить существование информации об ошибке в ответе сервиса
      var iprop = GenPropID(obj, "faultString"); 
      if(iprop != -1) // обращаемся к свойству, если оно существует в объекте
        return obj.faultString;
      end;
    end;
  end;
  return null;
end;

macro CallGetTerrorList()
  var stat = 0;
  var error : string;
  var locale:string = "";
  GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_5.50\\SERVICE_PATH", V_STRING, locale, stat);
  
  if(stat != 0)
    /*Ошибка pежима задания пути к сервису ТК 5.50*/
    stat = 29049;
    CreateErrMsg(stat);
    DisplayError();
  else
    var NotEmpty = TArray; //для того, чтобы обойти ошибку, нужно передать какой-нибудь параметр
    var mes = TXRRequest();
    mes.reqId = CreateGUID();
    mes.macroName = "ws_fmterror";
    mes.macroFunc = "CallGetTerrorList";
    mes.direction = "1";
    mes.Parm = NotEmpty;
    var inParams = TArray;
    var prm_request = RslSoapPrm;
    var prm_timeout = RslSoapPrm;
    var prm_priority = RslSoapPrm;
    prm_request.Name = "request";
    prm_request.Value = mes.GenerateMessage();
    inParams[0] = prm_request;
    prm_timeout.Name = "timeout";
    prm_timeout.Value = 0;
    inParams[1] = prm_timeout;
    prm_priority.Name = "priority";
    prm_priority.Value = 0;
    inParams[2] = prm_priority;
    var url = locale;
    var method = "XMLRPCCall";
    var outParams;
    var encoding;
    var outResponse;
    var errMsg : string;
    var obj;
    var i = 0;
    var guid = CreateGUID();
    stat = CallSimpleExtService(guid, url, method, inParams, "", "", 600, outParams, encoding, 
                                  outResponse, errMsg);
    if(stat)
      return errMsg;
    else
      // создаем MS-парсер
      var xml = CreateXMLParser();
      xml.validateOnParse = true;
      xml.async = false;
      // парсим полученный SOAP-ответ
      var res = xml.loadXML(outResponse);
      var XMLRPCCallResult = xml.getElementsByTagName("XMLRPCCallResult");
      var XMLResult = XMLRPCCallResult.item(0).text;
      stat = ConvertToRsl(XMLResult, obj);
      // проверить существование информации об ошибке в ответе сервиса
      var iprop = GenPropID(obj, "faultString"); 
      if(iprop != -1) // обращаемся к свойству, если оно существует в объекте
        //errMsg = obj.faultString;
        return obj.faultString;//println("faultString=", obj.faultString);
      end;
    end;
  end;
  return null;
end;


macro GetMode()

  var stat;

  GetRegistryValue( "COMMON\\WORK_MODE\\WORK_WITH_5.50\\MODE", V_INTEGER, Mode, stat );    

  if(stat != 0)
    /*Ошибка pежима задания интеграции с 5.50*/
    stat = 29050;
    CreateErrMsg(stat);
    DisplayError();
    exit(1);   
  else
    if(Mode == 0)
      /*Репликация НСИ не предусмотрена настройками банка*/
      stat = 29051;
      CreateErrMsg(stat);
      DisplayError();
      exit(1);
    end;
    if(Mode == 2)
      msgbox("Репликация НСИ функционирует в режиме имитации");
    end;
  end;
  return Mode;

end;

private macro DialogImitationNCI(NameMac, NameDirectory)
  array Text;
  array Button;
  var retConf = 0;
  Text( 0) = "Имитация репликации НСИ для интеграции с 5.50";
  Text( 1) = " ";
  Text( 2) = "Включен режим имитации репликации НСИ для интеграции";
  Text( 3) = "с RS-Bank 5.50. Дистрибутивная макрофункция";
  Text( 4) = NameMac + " имитирует";
  Text( 5) = "синхронный запрос к сервису на запуск обновления ";
  Text( 6) = "справочника " + NameDirectory;
  Text( 7) = " ";
  Text( 8) = "Для управления интеграцией с RS-Bank 5.50 используйте";
  Text( 9) = "настройку реестра COMMON\\WORK_MODE\\ИНТЕГРАЦИЯ С 5.50";
  Text(10) = "";
  Text(11) = "Подробнее об интеграции с RS-Bank 5.50 см. документацию";
  Text(12) = "к системе RS-Bank V.6";
  Text(13) = " ";
  Text(14) = "Выберите вариант:";
  Text(15) = " ";
  Text(16) = "1. Справочник успешно реплицирован в RS-Bank 5.50.";
  Text(17) = "2. Справочник не реплицирован, возникла ошибка.";
  Text(18) = " ";
  Button(0) = " 1 ";
  Button(1) = " 2 ";
  retConf = confwin(Text, Button);
  return retConf;
end;

private macro DialogImitationNCIVar1(NameDirectory)
  array Text;
  array Button;
  var retConf = 0;
  Text( 0) = "Имитация репликации НСИ для интеграции с 5.50";
  Text( 1) = " ";
  Text( 2) = "От RS-Bank 5.50 условно получен ответ об успешной";
  Text( 3) = "репликации справочника " + NameDirectory;
  Text( 4) = " ";
  Button(0) = " Продолжить ";
  retConf = confwin(Text, Button);
  return retConf;
end;

private macro DialogImitationNCIVar2(NameDirectory)
  array Text;
  array Button;
  var retConf = 0;
  Text( 0) = "Имитация репликации НСИ для интеграции с 5.50";
  Text( 1) = " ";
  Text( 2) = "От RS-Bank 5.50 условно получен ответ о возникшей";
  Text( 3) = "ошибке репликации справочника " + NameDirectory;
  Text( 4) = " ";
  Button(0) = " Продолжить ";
  retConf = confwin(Text, Button);
  return retConf;
end;

private macro ImitationNCI(NameMac, NameDirectory)
  var error = "";
  var Result = DialogImitationNCI(NameMac, NameDirectory);
  if(Result == 0)
    Result = DialogImitationNCIVar1(NameDirectory);
    if(Result == 0)
      return null;
    end; 
  elif(Result == 1)
    Result = DialogImitationNCIVar2(NameDirectory);
    if(Result == 0)
      error = "cправочник не реплицирован"; 
      return error;
    end; 
  end;
end;


/************************************************************************/
/*  Все для работы с панелью                                            */
/************************************************************************/
macro CheckPanel(  dlg, cmd, id, key  )
var stat = true;

  return stat;

end;


macro Init(dlg_rec)
  var OnDate : date;
  var AccPlan : string;
  var Capital : string;
  var Terrorist : string;
  ClearRecord(dlg_rec);
  
  dlg_rec.DateNCI  = {curdate};
  dlg_rec.F1  = "";
  dlg_rec.F2  = "";
  dlg_rec.F3  = "";
  g_iNumPlan  = 0;

  if(IsShedulerRunning)
    if(GetCmdLineParm("OnDate", OnDate, V_DATE))
      dlg_rec.DateNCI = OnDate;
    end;
    if(GetCmdLineParm("AccPlan", AccPlan, V_STRING))
      if(trim(strupr(AccPlan)) == "YES")
        dlg_rec.F1 = "X";
        GetCmdLineParm("iNumPlan", g_iNumPlan, V_INTEGER);
      end;
    end;
    if(GetCmdLineParm("Capital", Capital, V_STRING))
      if(trim(strupr(Capital)) == "YES")
        dlg_rec.F2 = "X";
      end;
    end;
    if(GetCmdLineParm("Terrorist", Terrorist, V_STRING))
      if(trim(strupr(Terrorist)) == "YES")
        dlg_rec.F3 = "X";
      end;
    end;
  end;
end;

MACRO PanNCI(dlg, cmd, id, key)
  var itemsel;
  var NameMac = "";
  var NameDirectory = "";
  var error = "";
  var stat = 0;
  var StepCount = 0;

  if(cmd == DLG_INIT)
    Init(dlg);

    UpdateFields(dlg);

    if(IsShedulerRunning)
      PanNCI(dlg, DLG_KEY, id, 316);

      return CM_CANCEL;     
    end;
  elif(cmd == DLG_KEY) 
    if(key == 32) /*Клавиша K_SPACE*/
      if(trim(fldname(dlg, id)) == "F1")
        if(dlg.F1 == "")
          dlg.F1 = "X";
        else
          dlg.F1 = "";
        end;
      elif(trim(fldname(dlg, id)) == "F2")
        if(dlg.F2 == "")
          dlg.F2 = "X";
        else
          dlg.F2 = "";
        end;
      elif(trim(fldname(dlg, id)) == "F3")
        if(dlg.F3 == "")
          dlg.F3 = "X";
        else
          dlg.F3 = "";
        end;
      end;
    elif(key == 316)  /* Клавиша F2 */
      
      if(dlg.F1 == "X")
        StepCount = StepCount + 1;
      end;
      if(dlg.F2 == "X")
        StepCount = StepCount + 1;
      end;
      if(dlg.F3 == "X")
        StepCount = StepCount + 1;
      end;
      
      if(StepCount == 0)
        /*Не выбран справочник для репликации*/
        stat = 29048;
        CreateErrMsg(stat);
        DisplayError();
      end;

      if(stat == 0)
        InitProgress(StepCount, "~Ctrl-Brk~ Прервать", "Репликация справочника");
        nCount = 0;
     
        if((stat == 0) and (dlg.F1 == "X"))
          NameMac = "ws_nameplan.mac.CallGetNamePlan";
          NameDirectory = "План счетов";
        
          Message("Выполняется репликация справочника " + NameDirectory + ". Ждите...");
          nCount = nCount + 1; 
          if(Mode == 1)
            error = CallGetNamePlan(g_iNumPlan);
          end;
          
          if(Mode == 2)
            error = ImitationNCI(NameMac, NameDirectory);
          end;
        
          if((error != null) and (GetErrMsg() == ""))
            /*Репликация НСИ в 5.50 не выполнена. Произошла ошибка: %s*/
            stat = 29046;
            CreateErrMsg(stat, error);
            DisplayError();
          elif(GetErrMsg() != "")
            stat = 1;
          else
            UseProgress( nCount ); 
          end;
        end;

        if((stat == 0) and (dlg.F2 == "X"))
          NameMac = "ws_ptcapital.mac.CallGetCapital";
          NameDirectory = "Справочник капитала";
       
          Message("Выполняется репликация справочника " + NameDirectory + ". Ждите...");
          nCount = nCount + 1; 
          if(Mode == 1) 
            error = CallGetCapital(dlg.DateNCI);
          end;
       
          if(Mode == 2)
            error = ImitationNCI(NameMac, NameDirectory);
          end;      
        
          if((error != null) and (GetErrMsg() == ""))
            /*Репликация НСИ в 5.50 не выполнена. Произошла ошибка: %s*/
            stat = 29046;
            CreateErrMsg(stat, error);
            DisplayError();
          elif(GetErrMsg() != "")
            stat = 1;
          else
            UseProgress( nCount ); 
          end;
        end;

        if((stat == 0) and (dlg.F3 == "X"))
       
          NameMac = "ws_fmterror.mac.GetTerrorList";
          NameDirectory = "Справочник террористов";
       
          Message("Выполняется репликация справочника " + NameDirectory + ". Ждите...");
          nCount = nCount + 1; 
          if(Mode == 1) 
            error = CallGetTerrorList();
          end;
       
          if(Mode == 2)
            error = ImitationNCI(NameMac, NameDirectory);
          end;      
        
          if((error != null) and (GetErrMsg() == ""))
            /*Репликация НСИ в 5.50 не выполнена. Произошла ошибка: %s*/
            stat = 29046;
            CreateErrMsg(stat, error);
            DisplayError();
          elif(GetErrMsg() != "")
            stat = 1;
          else
            UseProgress( nCount ); 
          end;
        end;

        RemProgress();
      end;

      if(stat == 0)
        if(not IsShedulerRunning)
          /*Процедура репликации НСИ успешно выполнена*/
          stat = 29047;
          CreateErrMsg(stat, error);
          DisplayError();
        end; 
      end; 
    end;  
  else
    return CM_DEFAULT;
  end;
END;

InitError();
Mode = GetMode();
RunDialog(pan, "PanNCI");
exit(1);
