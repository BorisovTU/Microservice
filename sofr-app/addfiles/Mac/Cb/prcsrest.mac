/*
 Печатная форма "Остатки по портфелю"
*/
import BankInter, globals;
var pr_accase:TRecHandler = TRecHandler( "accase.dbt", "bank.def" );
file accasscs(accasscs) key 1;

MACRO PrintDocument(ncopy:integer):bool
 var accase = pr_accase.rec;

 var DateFrom:date = {curdate};
 var DateTo:date   = {curdate};

 if(not SelectDate(@DateFrom,@DateTo))
   exit;
 end;

 var PeriodStr:string = "";
 if(DateFrom == DateTo)
   PeriodStr = string("на дату ", DateFrom);
 else
   PeriodStr = string("за период с ", DateFrom, " по ", DateTo);
 end;

[Портфель ########## ##################################################
 Список остатков
 ####################################
 ┌──────────┬───────────┬────────────────────────────┐
 │ Дата     │Субпортфель│ Остаток                    │
 ├──────────┼───────────┼────────────────────────────┤
](accase.CaseID, accase.Name, PeriodStr);

var dateNext:date = DateFrom;
var rest:money, prevRest:money = 0;
var result:bool = true;
 var subresult:bool = true;
var existRest:bool = false;

while( (dateNext <= DateTo) and result )
  
  ClearRecord(accasscs);
  result = CalcACCASERest( pr_accase, accasscs, dateNext, rest );

  /* Печатаем строку об изменении остатка портфеля*/
  if(rest != prevRest)
    existRest = true;
[ ##########             ############################]
( dateNext, rest:f );

  accasscs.CaseID = accase.CaseID;
  subresult = getGE(accasscs);

  /* Печатаем строки об остатках субпортфелей*/
  while(subresult)
    subresult = CalcACCASERest( pr_accase, accasscs, dateNext, rest );
[ ########## ########### ############################]
( dateNext, accasscs.Number, rest:f );
    subresult = next(accasscs);
    if(subresult) subresult = (accasscs.CaseID == accase.CaseID); end;
  end;
  end;

  prevRest = rest;
  dateNext = dateNext + 1;
end;

if(not existRest)
[ ########## ############################](DateTo, prevRest:f);
end;

if(not result)
  msgbox(GetErrMsg());
  return false;
end;

return true;

END;