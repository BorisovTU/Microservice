/*
 $Name: fmreqi_msg.mac
 $Module: Финансовый мониторинг
 $Description: Предоставление информации по запросам ФСФМ РФ
*/

import BankInter, PTInter, CTInter, rsd, oralib, likepy, globals;
import serviceaction;
import FMInter;
import fmreqi_lib;

private file f_fmrequestinfo(fmrequestinfo) key 0;

private record fmrequestinfo(fmrequestinfo);

private file MessageXMLFile() txt write;

private var MessageXMLFileName;

private macro _СлужЧасть_ВерсФорм()
  MessageXMLFile.str = "<ВерсФорм>1.1</ВерсФорм>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ВерсПрог()
  MessageXMLFile.str = "<ВерсПрог>" + "RS-Bank " + _GetDBVersion() + "</ВерсПрог>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ТипИнф()
  MessageXMLFile.str = "<ТипИнф>ОТВРФМ</ТипИнф>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ДатЗапр()
  MessageXMLFile.str = "<ДатЗапр>" + _GetSchemaFormatDate(fmrequestinfo.RequestDate) + "</ДатЗапр>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_НомЗапр()
  MessageXMLFile.str = "<НомЗапр>" + fmrequestinfo.RequestNumber + "</НомЗапр>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ДатПолучЗапр()
  MessageXMLFile.str = "<ДатПолучЗапр>" + _GetSchemaFormatDate(fmrequestinfo.RequestReceiptDate) + "</ДатПолучЗапр>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ДатПоручФил()
  if(fmrequestinfo.RequestRedirectDate != date(0, 0, 0))
    MessageXMLFile.str = "<ДатПоручФил>" + _GetSchemaFormatDate(fmrequestinfo.RequestRedirectDate) + "</ДатПоручФил>";
    insert(MessageXMLFile);
  end;
end;

private macro _СлужЧасть_НомПоручФил()
  if(fmrequestinfo.RequestRedirectNumber != "")
    MessageXMLFile.str = "<НомПоручФил>" + fmrequestinfo.RequestRedirectNumber + "</НомПоручФил>";
    insert(MessageXMLFile);
  end;
end;

private macro _GetRequestInfoKindForPart91()
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT t.t_RequestInfoKind, t.t_Count, llv.t_Code                ";
  query = query + "  FROM (  SELECT fmak.t_RequestInfoKind, COUNT (*) t_Count       ";
  query = query + "            FROM dfmreqiattach_dbt fmria,                        ";
  query = query + "                 dfmreqiattachbody_dbt fmriab,                   ";
  query = query + "                 dfmattachkind_dbt fmak                          ";
  query = query + "           WHERE     fmria.t_RequestInfoID = :ID                 ";
  query = query + "                 AND fmria.t_AttachID = fmriab.t_AttachID        ";
  query = query + "                 AND fmak.t_AttachKind = fmria.t_AttachKind      ";
  query = query + "        GROUP BY fmak.t_RequestInfoKind) t,                      ";
  query = query + "       dllvalues_dbt llv                                         ";
  query = query + " WHERE llv.t_Element = t.t_RequestInfoKind AND llv.t_List = 3499 ";
  query = query + " ORDER BY llv.t_Code                                             ";

  params = makeArray(SQLParam("ID", fmrequestinfo.ID)
                     );
  rs = execSQLselect(query, params, true);

  return rs;
end;

private macro _СлужЧасть_ВидИнф()
  MessageXMLFile.str = "<ВидИнф>" + fmrequestinfo.RequestInfoKindList + "</ВидИнф>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ДатаСооб()
  MessageXMLFile.str = "<ДатаСооб>" + _GetSchemaFormatDate(fmrequestinfo.EMessageDate) + "</ДатаСооб>";
  insert(MessageXMLFile);
end;

private macro _СлужЧасть_ДатаПролонг()
  if(fmrequestinfo.ProlongRequestDate != date(0, 0, 0))
    MessageXMLFile.str = "<ДатаПролонг>" + _GetSchemaFormatDate(fmrequestinfo.ProlongRequestDate) + "</ДатаПролонг>";
    insert(MessageXMLFile);
  end;
end;

private macro _СлужЧасть_НомПролонг()
  if(fmrequestinfo.ProlongRequestNumber != "")
    MessageXMLFile.str = "<НомПролонг>" + fmrequestinfo.ProlongRequestNumber + "</НомПролонг>";
    insert(MessageXMLFile);
  end;
end;

private macro _СлужЧасть()
  MessageXMLFile.str = "<СлужЧасть>";
  insert(MessageXMLFile);

  _СлужЧасть_ВерсФорм();
  _СлужЧасть_ВерсПрог();
  _СлужЧасть_ТипИнф();
  _СлужЧасть_ДатЗапр();
  _СлужЧасть_НомЗапр();
  _СлужЧасть_ДатПолучЗапр();
  _СлужЧасть_ДатПоручФил();
  _СлужЧасть_НомПоручФил();
  _СлужЧасть_ВидИнф();
  _СлужЧасть_ДатаСооб();
  _СлужЧасть_ДатаПролонг();
  _СлужЧасть_НомПролонг();

  MessageXMLFile.str = "</СлужЧасть>";
  insert(MessageXMLFile);
end;

private macro _НаимКО()
  MessageXMLFile.str = "<НаимКО>" + fmrequestinfo.KGRKO_BankShortName + "</НаимКО>";
  insert(MessageXMLFile);
end;

private macro _РегНомКО()
  MessageXMLFile.str = "<РегНомКО>" + fmrequestinfo.KGRKO_BankNumber + "</РегНомКО>";
  insert(MessageXMLFile);
end;

private macro _НомФл()
  if(fmrequestinfo.SourceDprt != {NumDprt})
    if(string(int(fmrequestinfo.KGRKO_BankDprt)) != "")
      MessageXMLFile.str = "<НомФл>" + string(int(fmrequestinfo.KGRKO_BankDprt)) + "</НомФл>";
      insert(MessageXMLFile);
    end;
  end;
end;

private macro _БИККО()
  if(fmrequestinfo.BIC != "")
    MessageXMLFile.str = "<БИККО>" + fmrequestinfo.BIC + "</БИККО>";
    insert(MessageXMLFile);
  end;
end;

private macro _Раздел1()
  MessageXMLFile.str = "<Раздел1>";
  insert(MessageXMLFile);

  _НаимКО();
  _РегНомКО();
  _НомФл();
  _БИККО();

  MessageXMLFile.str = "</Раздел1>";
  insert(MessageXMLFile);
end;

private macro _ТипКлиент(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientType != 0))
    if((1 <= fmrequestinfo.ClientType) and (fmrequestinfo.ClientType <= 3))
      ResultPart = "<ТипКлиент>" + fmrequestinfo.ClientType + "</ТипКлиент>";
      IsExists = true;
    end;
  end;

  return ResultPart;
end;

private macro _ПризнРез(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientID != 0)) 
    if(fmrequestinfo.ClientNotResident != "X")
      ResultPart = "<ПризнРез>1</ПризнРез>";
    else
      ResultPart = "<ПризнРез>2</ПризнРез>";
    end;
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Раздел2()
  var ClientTypeStringPart:string;
  var ClientNotResidentPart:string;
  var ResultPart:string = "";
  var IsExistsClientTypeStringPart :bool;
  var IsExistsClientNotResidentPart:bool;

  ClientTypeStringPart = _ТипКлиент(@IsExistsClientTypeStringPart );
  ClientNotResidentPart = _ПризнРез(@IsExistsClientNotResidentPart);

  if (   (fmrequestinfo.IsInfoAbsent != "X") 
      or IsExistsClientTypeStringPart 
      or IsExistsClientNotResidentPart )
    ResultPart = "<Раздел2>" + 
                   ClientTypeStringPart + 
                   ClientNotResidentPart + 
                 "</Раздел2>";
  end;

  return ResultPart;
end;

private macro _НаимЮЛ(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ( (fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientYurName != ""))
    ResultPart = "<НаимЮЛ>" + fmrequestinfo.ClientYurName + "</НаимЮЛ>";
    if(fmrequestinfo.ClientYurName != "")
      IsExists = true;
    end;
  end;

  return ResultPart;
end;

private macro _ИННЮЛ(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientINN != ""))
    ResultPart = "<ИННЮЛ>" + fmrequestinfo.ClientINN + "</ИННЮЛ>";
    if(fmrequestinfo.ClientINN != "")
      IsExists = true;
    end;
  end;

  return ResultPart;
end;

private macro _ОГРНЮЛ(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientOGRN != ""))
    ResultPart = "<ОГРНЮЛ>" + fmrequestinfo.ClientOGRN + "</ОГРНЮЛ>";
    if(fmrequestinfo.ClientOGRN != "")
      IsExists = true;
    end;
  end;

  return ResultPart;
end;

private macro _ДатаРег(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;
  
  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientRegDate != date(0, 0, 0)))
    ResultPart = "<ДатаРег>" + _GetSchemaFormatDate(fmrequestinfo.ClientRegDate) + "</ДатаРег>";
    if(fmrequestinfo.ClientRegDate != date(0, 0, 0))
      IsExists = true;
    end;
  end;
  
  return ResultPart;
end;

private macro _Раздел3()
  var ClientYurNamePart:string;
  var ClientINNPart:string;
  var ClientOGRNPart:string;
  var ClientRegDatePart:string;
  var ResultPart:string = "";
  var IsExistsClientYurNamePart:bool;
  var IsExistsClientINNPart    :bool;
  var IsExistsClientOGRNPart   :bool;
  var IsExistsClientRegDatePart:bool;

  ClientYurNamePart = _НаимЮЛ (@IsExistsClientYurNamePart);
  ClientINNPart     = _ИННЮЛ  (@IsExistsClientINNPart    );
  ClientOGRNPart    = _ОГРНЮЛ (@IsExistsClientOGRNPart   );
  ClientRegDatePart = _ДатаРег(@IsExistsClientRegDatePart);
 
  if (   IsExistsClientYurNamePart 
      or IsExistsClientINNPart 
      or IsExistsClientOGRNPart 
      or IsExistsClientRegDatePart)
    ResultPart = "<Раздел3>" +
                   ClientYurNamePart +
                   ClientINNPart + 
                   ClientOGRNPart +
                   ClientRegDatePart +
                 "</Раздел3>";
  end;
  
  return ResultPart;
end;

private macro _ФИОФЛ_Фам(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Фам>" + fmrequestinfo.ClientName1 + "</Фам>";
  if(fmrequestinfo.ClientName1 != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _ФИОФЛ_Имя(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<Имя>" + fmrequestinfo.ClientName2 + "</Имя>";
  if(fmrequestinfo.ClientName2 != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _ФИОФЛ_Отч()
  var ResultPart:string = "";   

  if (fmrequestinfo.ClientName3 != "")
    ResultPart = "<Отч>" + fmrequestinfo.ClientName3 + "</Отч>";
  end;

  return ResultPart;
end;

private macro _ФИОФЛ(IsExists : @bool)
  var ClientName1Part:string;
  var ClientName2Part:string;
  var ClientName3Part:string;
  var ResultPart:string = "";  
  var IsExistsClientName1Part:bool;
  var IsExistsClientName2Part:bool;
  IsExists = false;

  ClientName1Part = _ФИОФЛ_Фам(@IsExistsClientName1Part);
  ClientName2Part = _ФИОФЛ_Имя(@IsExistsClientName2Part);
  ClientName3Part = _ФИОФЛ_Отч();
  
  if ((fmrequestinfo.IsInfoAbsent == "X") and ((not IsExistsClientName1Part) or (not IsExistsClientName2Part)) )
    IsExists = false;
  else
    ResultPart = "<ФИОФЛ>" +
                   ClientName1Part +
                   ClientName2Part +
                   ClientName3Part +
                 "</ФИОФЛ>";

    IsExists = true;
  end;

  return ResultPart;
end;

private macro _ИННФЛ(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientINN != ""))
    ResultPart = "<ИННФЛ>" + fmrequestinfo.ClientINN + "</ИННФЛ>";
    if(fmrequestinfo.ClientINN != "")
      IsExists = true;
    end;
  end;

  return ResultPart;
end;

private macro _ДатаРожд(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;
 
  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientBirthDate != date(0, 0, 0)))
    ResultPart = "<ДатаРожд>" + _GetSchemaFormatDate(fmrequestinfo.ClientBirthDate) + "</ДатаРожд>";
    if(fmrequestinfo.ClientBirthDate != date(0, 0, 0))
      IsExists = true;
    end;
  end;
  
  return ResultPart;
end;

private macro _МестоРождФЛ_КодОКСМ(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<КодОКСМ>" + fmrequestinfo.ClientBirthCountry + "</КодОКСМ>";
  if(fmrequestinfo.ClientBirthCountry != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _МестоРождФЛ_КодСубъектаПоОКАТО(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<КодСубъектаПоОКАТО>" + fmrequestinfo.ClientBirthOKATO + "</КодСубъектаПоОКАТО>";
  if(fmrequestinfo.ClientBirthOKATO != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _МестоРождФЛ_Регион(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Регион>" + fmrequestinfo.ClientBirthRayon + "</Регион>";
  if(fmrequestinfo.ClientBirthRayon != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _МестоРождФЛ_Пункт(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Пункт>" + fmrequestinfo.ClientBirthPlace + "</Пункт>";
  if(fmrequestinfo.ClientBirthPlace != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _МестоРождФЛ(IsExists : @bool)
  var ClientBirthCountryPart:string;
  var ClientBirthOKATOPart:string;
  var ClientBirthRayonPart:string;
  var ClientBirthPlacePart:string;
  var ResultPart:string = "";
  var IsExistsClientBirthCountryPart:bool;
  var IsExistsClientBirthOKATOPart  :bool;
  var IsExistsClientBirthRayonPart  :bool;
  var IsExistsClientBirthPlacePart  :bool;
  IsExists = false;

  ClientBirthCountryPart = _МестоРождФЛ_КодОКСМ           (@IsExistsClientBirthCountryPart);
  ClientBirthOKATOPart   = _МестоРождФЛ_КодСубъектаПоОКАТО(@IsExistsClientBirthOKATOPart  );
  ClientBirthRayonPart   = _МестоРождФЛ_Регион            (@IsExistsClientBirthRayonPart  );
  ClientBirthPlacePart   = _МестоРождФЛ_Пункт             (@IsExistsClientBirthPlacePart  );

  if ( (fmrequestinfo.IsInfoAbsent == "X") and ( (not IsExistsClientBirthCountryPart) or (not IsExistsClientBirthPlacePart )))
    IsExists = false;
  else
    ResultPart = "<МестоРождФЛ>" +
                   ClientBirthCountryPart +
                   ClientBirthOKATOPart +
                   ClientBirthRayonPart +
                   ClientBirthPlacePart +  
                 "</МестоРождФЛ>";

    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Раздел4()
  var FIOFLPart:string;
  var ClientINNPart:string;
  var ClientBirthDatePart:string;
  var BirthPlacePart:string;
  var ResultPart:string = "";
  var IsExistsFIOFLPart          :bool;
  var IsExistsClientINNPart      :bool;
  var IsExistsClientBirthDatePart:bool;
  var IsExistsBirthPlacePart     :bool;

  FIOFLPart           = _ФИОФЛ      (@IsExistsFIOFLPart          );
  ClientINNPart       = _ИННФЛ      (@IsExistsClientINNPart      );
  ClientBirthDatePart = _ДатаРожд   (@IsExistsClientBirthDatePart);
  BirthPlacePart      = _МестоРождФЛ(@IsExistsBirthPlacePart     );

  if (   IsExistsFIOFLPart          
      or IsExistsClientINNPart      
      or IsExistsClientBirthDatePart
      or IsExistsBirthPlacePart     )
    ResultPart = "<Раздел4>" +
                   FIOFLPart +
                   ClientINNPart + 
                   ClientBirthDatePart +
                   BirthPlacePart +
                 "</Раздел4>";
  end;

  return ResultPart;
end;

private macro _ФИОИП(IsExists : @bool)
  var FIOIP_Name1:string;
  var FIOIP_Name2:string;
  var FIOIP_Name3:string;
  var ResultPart:string = "";
  var IsExistsFIOIP_Name1:bool;
  var IsExistsFIOIP_Name2:bool;
  IsExists = false;

  FIOIP_Name1 = _ФИОФЛ_Фам(@IsExistsFIOIP_Name1);
  FIOIP_Name2 = _ФИОФЛ_Имя(@IsExistsFIOIP_Name2);
  FIOIP_Name3 = _ФИОФЛ_Отч();
  
  if ( (fmrequestinfo.IsInfoAbsent == "X") and ((not IsExistsFIOIP_Name1) or ( not IsExistsFIOIP_Name2)))
    IsExists = false;
  else
    ResultPart = "<ФИОИП>" +
                   FIOIP_Name1 +
                   FIOIP_Name2 +
                   FIOIP_Name3 +
                 "</ФИОИП>";
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _ИННИП(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientINN != ""))
    ResultPart = "<ИННИП>" + fmrequestinfo.ClientINN + "</ИННИП>";
    if(fmrequestinfo.ClientINN != "")
      IsExists = true;
    end;
  end;
 
  return ResultPart;
end;

private macro _ДатаРождИП(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.ClientBirthDate != date(0, 0, 0)))
    ResultPart = "<ДатаРождИП>" + _GetSchemaFormatDate(fmrequestinfo.ClientBirthDate) + "</ДатаРождИП>";
    if(fmrequestinfo.ClientBirthDate != date(0, 0, 0))
      IsExists = true;
    end;
  end;

  return ResultPart;
end;

private macro _МестоРождИП(IsExists : @bool)
  var ClientBirthCountryPart:string;
  var ClientBirthOKATOPart:string;
  var ClientBirthRayonPart:string;
  var ClientBirthPlacePart:string;
  var ResultPart:string = "";
  var IsExistsClientBirthCountryPart:bool;
  var IsExistsClientBirthOKATOPart  :bool;
  var IsExistsClientBirthRayonPart  :bool;
  var IsExistsClientBirthPlacePart  :bool;
  IsExists = false;

  ClientBirthCountryPart = _МестоРождФЛ_КодОКСМ           (@IsExistsClientBirthCountryPart);
  ClientBirthOKATOPart   = _МестоРождФЛ_КодСубъектаПоОКАТО(@IsExistsClientBirthOKATOPart  );
  ClientBirthRayonPart   = _МестоРождФЛ_Регион            (@IsExistsClientBirthRayonPart  );
  ClientBirthPlacePart   = _МестоРождФЛ_Пункт             (@IsExistsClientBirthPlacePart  );

  if ((fmrequestinfo.IsInfoAbsent == "X") and ( (not IsExistsClientBirthCountryPart) or ( not IsExistsClientBirthPlacePart) ) )
    IsExists = false;
  else
    ResultPart = "<МестоРождИП>" +
                   ClientBirthCountryPart +
                   ClientBirthOKATOPart +
                   ClientBirthRayonPart +
                   ClientBirthPlacePart +
                 "</МестоРождИП>";
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _Раздел5()
  var ClientFIOIPPart:string;
  var ClientINNPart:string;
  var ClientBirthDatePart:string;
  var ClientBirthPlacePart:string;
  var ResultPart:string = "";
  var IsExistsClientFIOIPPart     :bool;
  var IsExistsClientINNPart       :bool;
  var IsExistsClientBirthDatePart :bool;
  var IsExistsClientBirthPlacePart:bool;

  ClientFIOIPPart      = _ФИОИП      (@IsExistsClientFIOIPPart     );
  ClientINNPart        = _ИННИП      (@IsExistsClientINNPart       );
  ClientBirthDatePart  = _ДатаРождИП (@IsExistsClientBirthDatePart );
  ClientBirthPlacePart = _МестоРождИП(@IsExistsClientBirthPlacePart);

  if (   IsExistsClientFIOIPPart     
      or IsExistsClientINNPart       
      or IsExistsClientBirthDatePart 
      or IsExistsClientBirthPlacePart)
    ResultPart = "<Раздел5>" +
                   ClientFIOIPPart +
                   ClientINNPart +
                   ClientBirthDatePart +
                   ClientBirthPlacePart +
                 "</Раздел5>"
  end;

  return ResultPart;
end;

private macro _ДокУдЛичн(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  if ((fmrequestinfo.IsInfoAbsent != "X") or (fmrequestinfo.PaperTULFM != 0))
    ResultPart = "<ДокУдЛичн>" + fmrequestinfo.PaperTULFM + "</ДокУдЛичн>";
    if(fmrequestinfo.PaperTULFM != 0)
      IsExists = true;
    end;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн_ВидДокКод(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<ВидДокКод>" + fmrequestinfo.PaperCode + "</ВидДокКод>";
  if(fmrequestinfo.PaperCode != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн_ВидДокНаименование(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<ВидДокНаименование>" + fmrequestinfo.PaperName + "</ВидДокНаименование>";
  if(fmrequestinfo.PaperName != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн_СерияДок(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;
  
  ResultPart = "<СерияДок>" + fmrequestinfo.PaperSeries + "</СерияДок>";
  if(fmrequestinfo.PaperSeries != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн_НомДок(IsExists : @bool)
  var ResultPart:string = "";    
  IsExists = false;
  
  ResultPart = "<НомДок>" + fmrequestinfo.PaperNumber + "</НомДок>";
  if(fmrequestinfo.PaperNumber != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведДокУдЛичн_КемВыданДок(IsExists : @bool)
  var ResultPart:string = "";   
  IsExists = false;

  ResultPart = "<КемВыданДок>" + fmrequestinfo.PaperIssuer + "</КемВыданДок>";
  if(fmrequestinfo.PaperIssuer != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн_ДатВыдачиДок(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<ДатВыдачиДок>" + _GetSchemaFormatDate(fmrequestinfo.PaperIssueDate) + "</ДатВыдачиДок>";
  if(fmrequestinfo.PaperIssueDate != date(0, 0, 0))
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн_КодПодр(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;
  
  ResultPart = "<КодПодр>" + fmrequestinfo.PaperIssueCode + "</КодПодр>";
  if(fmrequestinfo.PaperIssueCode != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокУдЛичн(IsExists : @bool)
  var PaperCodePart:string;
  var PaperNamePart:string;
  var PaperSeriesPart:string;
  var PaperNumberPart:string;
  var PaperIssuerPart:string;
  var PaperIssueDatePart:string;
  var PaperIssueCodePart:string; 
  var ResultPart:string = "";
  var IsExistsPaperCodePart     :bool;
  var IsExistsPaperNamePart     :bool;
  var IsExistsPaperSeriesPart   :bool;
  var IsExistsPaperNumberPart   :bool;
  var IsExistsPaperIssuerPart   :bool;
  var IsExistsPaperIssueDatePart:bool;
  var IsExistsPaperIssueCodePart:bool; 
  IsExists = false;

  PaperCodePart      = _СведДокУдЛичн_ВидДокКод         (@IsExistsPaperCodePart     );
  PaperNamePart      = _СведДокУдЛичн_ВидДокНаименование(@IsExistsPaperNamePart     );
  PaperSeriesPart    = _СведДокУдЛичн_СерияДок          (@IsExistsPaperSeriesPart   );
  PaperNumberPart    = _СведДокУдЛичн_НомДок            (@IsExistsPaperNumberPart   );
  PaperIssuerPart    = _СведДокУдЛичн_КемВыданДок       (@IsExistsPaperIssuerPart   );
  PaperIssueDatePart = _СведДокУдЛичн_ДатВыдачиДок      (@IsExistsPaperIssueDatePart);
  PaperIssueCodePart = _СведДокУдЛичн_КодПодр           (@IsExistsPaperIssueCodePart);

  if (   (fmrequestinfo.IsInfoAbsent == "X") 
     and (
         (not IsExistsPaperCodePart)     
      or (not IsExistsPaperNamePart)     
      or (not IsExistsPaperIssuerPart)   
      or (not IsExistsPaperIssueDatePart)  
         )
     )
    IsExists = false;
  else
    ResultPart = "<СведДокУдЛичн>" +
                   PaperCodePart +
                   PaperNamePart +
                   PaperSeriesPart +
                   PaperNumberPart +
                   PaperIssuerPart +
                   PaperIssueDatePart + 
                   PaperIssueCodePart +
                 "</СведДокУдЛичн>";
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Раздел6()
  var PaperTULFMPart:string;
  var PaperSpecPart:string;
  var ResultPart:string = "";
  var IsExistsPaperTULFMPart:bool;
  var IsExistsPaperSpecPart :bool;

  PaperTULFMPart = _ДокУдЛичн    (@IsExistsPaperTULFMPart);
  PaperSpecPart  = _СведДокУдЛичн(@IsExistsPaperSpecPart );

  if (   IsExistsPaperTULFMPart 
      or IsExistsPaperSpecPart )
    ResultPart = "<Раздел6>" +
                   PaperTULFMPart +
                   PaperSpecPart +
                 "</Раздел6>";
  end;

  return ResultPart;
end;

private macro _СведДокПреб_ВидДокКод(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<ВидДокКод>" + fmrequestinfo.RightVisitDocCode + "</ВидДокКод>";
  if(fmrequestinfo.RightVisitDocCode != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокПреб_ВидДокНаименование(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<ВидДокНаименование>" + fmrequestinfo.RightVisitDocName + "</ВидДокНаименование>";
  if(fmrequestinfo.RightVisitDocName != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведДокПреб_СерияДокПреб(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<СерияДокПреб>" + fmrequestinfo.RightVisitDocSeries + "</СерияДокПреб>";
  if(fmrequestinfo.RightVisitDocSeries != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведДокПреб_НомДокПреб(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<НомДокПреб>" + fmrequestinfo.RightVisitDocNumber + "</НомДокПреб>";
  if(fmrequestinfo.RightVisitDocNumber != "")
    IsExists = true;
  end;
  
  return ResultPart;
end;

private macro _СведДокПреб_НачПравПреб(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<НачПравПреб>" + _GetSchemaFormatDate(fmrequestinfo.RightVisitDocDateStart) + "</НачПравПреб>";
  if(fmrequestinfo.RightVisitDocDateStart != date(0, 0, 0))
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведДокПреб_ОкончПравПреб(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<ОкончПравПреб>" + _GetSchemaFormatDate(fmrequestinfo.RightVisitDocDateEnd) + "</ОкончПравПреб>";
  if(fmrequestinfo.RightVisitDocDateEnd != date(0, 0, 0))
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведДокПреб(IsExists : @bool)
  var RightVisitDocCodePart:string;
  var RightVisitDocNamePart:string;
  var RightVisitDocSeriesPart:string;
  var RightVisitDocNumberPart:string;
  var RightVisitDocDateStartPart:string;
  var RightVisitDocDateEndPart:string;
  var ResultPart:string = "";
  var IsExistsRightVisitDocCodePart     :bool;
  var IsExistsRightVisitDocNamePart     :bool;
  var IsExistsRightVisitDocSeriesPart   :bool;
  var IsExistsRightVisitDocNumberPart   :bool;
  var IsExistsRightVisitDocDateStartPart:bool;
  var IsExistsRightVisitDocDateEndPart  :bool;
  IsExists = false;

  RightVisitDocCodePart      = _СведДокПреб_ВидДокКод         (@IsExistsRightVisitDocCodePart     );
  RightVisitDocNamePart      = _СведДокПреб_ВидДокНаименование(@IsExistsRightVisitDocNamePart     );
  RightVisitDocSeriesPart    = _СведДокПреб_СерияДокПреб      (@IsExistsRightVisitDocSeriesPart   );
  RightVisitDocNumberPart    = _СведДокПреб_НомДокПреб        (@IsExistsRightVisitDocNumberPart   );
  RightVisitDocDateStartPart = _СведДокПреб_НачПравПреб       (@IsExistsRightVisitDocDateStartPart);
  RightVisitDocDateEndPart   = _СведДокПреб_ОкончПравПреб     (@IsExistsRightVisitDocDateEndPart  );
  
  if( (fmrequestinfo.IsInfoAbsent == "X") 
     and (
        (not IsExistsRightVisitDocCodePart)     
     or (not IsExistsRightVisitDocNamePart)
     or (not IsExistsRightVisitDocDateStartPart)
     or (not IsExistsRightVisitDocDateEndPart)  
     )
    )
  ResultPart = "<СведДокПреб>" +
                 RightVisitDocCodePart +
                 RightVisitDocNamePart +   
                 RightVisitDocSeriesPart +               
                 RightVisitDocNumberPart +
                 RightVisitDocDateStartPart +
                 RightVisitDocDateEndPart +
               "</СведДокПреб>";
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведМигрКарт_КодМигрКарт(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<КодМигрКарт>" + fmrequestinfo.MigratoryCardCode + "</КодМигрКарт>";
  if(fmrequestinfo.MigratoryCardCode != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведМигрКарт_СерияМигрКарт(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<СерияМигрКарт>" + fmrequestinfo.MigratoryCardSeries + "</СерияМигрКарт>";
  if (fmrequestinfo.MigratoryCardSeries != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведМигрКарт_НомМигрКарт(IsExists : @bool)
  var ResultPart:string = "";  
  IsExists = false;

  ResultPart = "<НомМигрКарт>" + fmrequestinfo.MigratoryCardNumber + "</НомМигрКарт>";
  if(fmrequestinfo.MigratoryCardNumber != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведМигрКарт_ДатНачПреб(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<ДатНачПреб>" + _GetSchemaFormatDate(fmrequestinfo.MigratoryCardDateStart) + "</ДатНачПреб>";
  if(fmrequestinfo.MigratoryCardDateStart != date(0, 0, 0))
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведМигрКарт_ДатОкончПреб(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<ДатОкончПреб>" + _GetSchemaFormatDate(fmrequestinfo.MigratoryCardDateEnd) + "</ДатОкончПреб>";
  if(fmrequestinfo.MigratoryCardDateEnd != date(0, 0, 0))
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _СведМигрКарт(IsExists : @bool)
  var MigratoryCardCodePart:string;
  var MigratoryCardSeriesPart:string;
  var MigratoryCardNumberPart:string;
  var MigratoryCardDateStartPart:string;
  var MigratoryCardDateEndPart:string;
  var ResultPart:string = "";
  var IsExistsMigratoryCardCodePart     :bool;
  var IsExistsMigratoryCardSeriesPart   :bool;
  var IsExistsMigratoryCardNumberPart   :bool;
  var IsExistsMigratoryCardDateStartPart:bool;
  var IsExistsMigratoryCardDateEndPart  :bool;
  IsExists = false;

  MigratoryCardCodePart      = _СведМигрКарт_КодМигрКарт  (@IsExistsMigratoryCardCodePart     );
  MigratoryCardSeriesPart    = _СведМигрКарт_СерияМигрКарт(@IsExistsMigratoryCardSeriesPart   );
  MigratoryCardNumberPart    = _СведМигрКарт_НомМигрКарт  (@IsExistsMigratoryCardNumberPart   );
  MigratoryCardDateStartPart = _СведМигрКарт_ДатНачПреб   (@IsExistsMigratoryCardDateStartPart);
  MigratoryCardDateEndPart   = _СведМигрКарт_ДатОкончПреб (@IsExistsMigratoryCardDateEndPart  );

  if(    (    (fmrequestinfo.IsInfoAbsent == "X")
          and (   (not IsExistsMigratoryCardCodePart)     
               or (not IsExistsMigratoryCardNumberPart)   
               or (not IsExistsMigratoryCardDateStartPart)
               or (not IsExistsMigratoryCardDateEndPart)
              )
         )
    )
    IsExists = false;
  else
    ResultPart = "<СведМигрКарт>" + 
                   MigratoryCardCodePart +
                   MigratoryCardSeriesPart +
                   MigratoryCardNumberPart +
                   MigratoryCardDateStartPart +
                   MigratoryCardDateEndPart +
                 "</СведМигрКарт>";
    IsExists = true;
  end;
                 
  return ResultPart;
end;

private macro _Раздел7()
  var RightVisitDocPart:string;
  var MigratoryCardPart:string;
  var ResultPart:string = "";
  var IsExistsRightVisitDocPart:bool;
  var IsExistsMigratoryCardPart:bool;

  RightVisitDocPart = _СведДокПреб (@IsExistsRightVisitDocPart);
  MigratoryCardPart = _СведМигрКарт(@IsExistsMigratoryCardPart);

  if(   IsExistsRightVisitDocPart
     or IsExistsMigratoryCardPart)
    ResultPart = "<Раздел7>" +
                   RightVisitDocPart +
                   MigratoryCardPart +  
                 "</Раздел7>";
  end;

  return ResultPart;
end;

private macro _КодОКСМ(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<КодОКСМ>" + fmrequestinfo.FactAddrCntrISOCode + "</КодОКСМ>";
  if (fmrequestinfo.FactAddrCntrISOCode != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Индекс(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Индекс>" + fmrequestinfo.FactAddrPostIndex + "</Индекс>";
  if (fmrequestinfo.FactAddrPostIndex != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _КодСубъектаПоОКАТО(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<КодСубъектаПоОКАТО>" + fmrequestinfo.FactAddrOKATO + "</КодСубъектаПоОКАТО>";
  if (fmrequestinfo.FactAddrOKATO != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Регион(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Регион>" + fmrequestinfo.FactAddrRayon + "</Регион>";
  if (fmrequestinfo.FactAddrRayon != "")
    IsExists = true;
  end;

  return ResultPart;
  end;

private macro _Пункт(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Пункт>" + fmrequestinfo.FactAddrPlaceName + "</Пункт>";
  if (fmrequestinfo.FactAddrPlaceName != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Улица(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Улица>" + fmrequestinfo.FactAddrStreet + "</Улица>";
  if (fmrequestinfo.FactAddrStreet != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Дом(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Дом>" + fmrequestinfo.FactAddrHouse + "</Дом>";
  if (fmrequestinfo.FactAddrHouse != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _Корп(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Корп>" + fmrequestinfo.FactAddrBuilding + "</Корп>";
  if (fmrequestinfo.FactAddrBuilding != "")
    IsExists = true;
  end;

  return ResultPart;
  end;

private macro _Оф(IsExists : @bool)
  var ResultPart:string = "";
  IsExists = false;

  ResultPart = "<Оф>" + fmrequestinfo.FactAddrOffice + "</Оф>";
  if (fmrequestinfo.FactAddrOffice != "")
    IsExists = true;
  end;

  return ResultPart;
end;

private macro _АдрРег(IsExists : @bool)
  var FactAddrCntrISOCodePart:string;
  var FactAddrPostIndexPart:string;
  var FactAddrOKATOPart:string;
  var FactAddrRayonPart:string;
  var FactAddrPlaceNamePart:string;
  var FactAddrStreetPart:string;
  var FactAddrHousePart:string;
  var FactAddrBuildingPart:string;
  var FactAddrOfficePart:string;
  var ResultPart:string = "";
  var IsExistsFactAddrCntrISOCodePart:bool;
  var IsExistsFactAddrPostIndexPart  :bool;
  var IsExistsFactAddrOKATOPart      :bool;
  var IsExistsFactAddrRayonPart      :bool;
  var IsExistsFactAddrPlaceNamePart  :bool;
  var IsExistsFactAddrStreetPart     :bool;
  var IsExistsFactAddrHousePart      :bool;
  var IsExistsFactAddrBuildingPart   :bool;
  var IsExistsFactAddrOfficePart     :bool;
  IsExists = false;

  FactAddrCntrISOCodePart = _КодОКСМ           (@IsExistsFactAddrCntrISOCodePart);
  FactAddrPostIndexPart   = _Индекс            (@IsExistsFactAddrPostIndexPart  );
  FactAddrOKATOPart       = _КодСубъектаПоОКАТО(@IsExistsFactAddrOKATOPart      );
  FactAddrRayonPart       = _Регион            (@IsExistsFactAddrRayonPart      );
  FactAddrPlaceNamePart   = _Пункт             (@IsExistsFactAddrPlaceNamePart  );
  FactAddrStreetPart      = _Улица             (@IsExistsFactAddrStreetPart     );
  FactAddrHousePart       = _Дом               (@IsExistsFactAddrHousePart      );
  FactAddrBuildingPart    = _Корп              (@IsExistsFactAddrBuildingPart   );
  FactAddrOfficePart      = _Оф                (@IsExistsFactAddrOfficePart     );

  if ( (fmrequestinfo.IsInfoAbsent == "X" )
        and (    (not IsExistsFactAddrCntrISOCodePart)
              or (not IsExistsFactAddrPlaceNamePart  )
            )
     )
     IsExists = false;
  else
    ResultPart = "<АдрРег>" +
                   FactAddrCntrISOCodePart + 
                   FactAddrPostIndexPart +
                   FactAddrOKATOPart +
                   FactAddrRayonPart +
                   FactAddrPlaceNamePart +
                   FactAddrStreetPart +
                   FactAddrHousePart +
                   FactAddrBuildingPart +
                   FactAddrOfficePart +
                 "</АдрРег>";
      IsExists = true;
  end;

  return ResultPart;
end;

private macro _Раздел8()
  var FactAddrPart:string;
  var ResultPart:string = "";
  var IsExistsFactAddrPart:bool;
  
  FactAddrPart = _АдрРег(@IsExistsFactAddrPart);

  if (   (fmrequestinfo.IsInfoAbsent != "X")
      or IsExistsFactAddrPart)
    ResultPart = "<Раздел8>" + 
                   FactAddrPart + 
                 "</Раздел8>";
  end;

  return ResultPart;
end;

private macro _НалЗапрИнф()
  MessageXMLFile.str = "<НалЗапрИнф>" + string(fmrequestinfo.InfoAvailability) + "</НалЗапрИнф>";
  insert(MessageXMLFile);
end;

private macro _КодВидИнф(rs/*см. _GetRequestInfoKindForPart91*/)
  MessageXMLFile.str = "<КодВидИнф>" + rs.value(2) + "</КодВидИнф>";
  insert(MessageXMLFile);
end;

private macro _КолФайлВлож(rs/*см. _GetRequestInfoKindForPart91*/)
  MessageXMLFile.str = "<КолФайлВлож>" + string(int(rs.value(1))) + "</КолФайлВлож>";
  insert(MessageXMLFile);
end;

private macro _GetReqIAttachForPart911(Kind)
  var query = "";
  var rs;
  var params : TArray;

  query = query + "SELECT fmria.t_attachfilename, ";
  query = query + "       DBMS_LOB.getlength (fmriab.t_FmtBlobData_XXXX), ";
  query = query + "       fmria.t_AttachFileCreateDate,                   ";
  query = query + "       fmria.t_AttachFileCreateTime                    ";
  query = query + "  FROM dfmreqiattach_dbt fmria,                        ";
  query = query + "       dfmreqiattachbody_dbt fmriab,                   ";
  query = query + "       dfmattachkind_dbt fmak                          ";
  query = query + " WHERE     fmria.t_RequestInfoID = :ID                 ";
  query = query + "       AND fmria.t_AttachID = fmriab.t_AttachID        ";
  query = query + "       AND fmak.t_AttachKind = fmria.t_AttachKind      ";
  query = query + "       AND fmak.t_RequestInfoKind = :Kind              ";

  params = makeArray(SQLParam("ID", fmrequestinfo.ID)
                    ,SQLParam("Kind", Kind)
                     );
  rs = execSQLselect(query, params, true);

  return rs;
end;

private macro _ИмФайлВлож(rs/*см. _GetReqIAttachForPart911*/)
  MessageXMLFile.str = "<ИмФайлВлож>" + rs.value(0) + "</ИмФайлВлож>";
  insert(MessageXMLFile);
end;

private macro _РазмФайлВлож(rs/*см. _GetReqIAttachForPart911*/)
  MessageXMLFile.str = "<РазмФайлВлож>" + string(int(rs.value(1))) + "</РазмФайлВлож>";
  insert(MessageXMLFile);
end;

private macro _ДатФайлВлож(rs/*см. _GetReqIAttachForPart911*/)
  MessageXMLFile.str = "<ДатФайлВлож>" + _GetSchemaFormatDate(date(rs.value(2))) + "</ДатФайлВлож>";
  insert(MessageXMLFile);
end;

private macro _ВремФайлВлож(rs/*см. _GetReqIAttachForPart911*/)
  MessageXMLFile.str = "<ВремФайлВлож>" + _GetSchemaFormatTime(time(rs.value(3))) + "</ВремФайлВлож>";
  insert(MessageXMLFile);
end;

private macro _Раздел911(rs/*см. _GetReqIAttachForPart911*/)
  MessageXMLFile.str = "<Раздел911>";
  insert(MessageXMLFile);
  
  _ИмФайлВлож(rs);
  _РазмФайлВлож(rs);
  _ДатФайлВлож(rs);
  _ВремФайлВлож(rs);

  MessageXMLFile.str = "</Раздел911>";
  insert(MessageXMLFile);
end;

private macro _Раздел91()
  var rs91 = _GetRequestInfoKindForPart91();
  var rs911;

  while(rs91 and rs91.movenext())
    MessageXMLFile.str = "<Раздел91>";
    insert(MessageXMLFile);

    _КодВидИнф(rs91);
    _КолФайлВлож(rs91);
    rs911 = _GetReqIAttachForPart911(rs91.value(0));
    while(rs911 and rs911.movenext())
      _Раздел911(rs911);
    end;

    MessageXMLFile.str = "</Раздел91>";
    insert(MessageXMLFile);
  end;
end;

private macro _Раздел9()
  MessageXMLFile.str = "<Раздел9>";
  insert(MessageXMLFile);

  _НалЗапрИнф();
  _Раздел91();
  if(fmrequestinfo.Comment != "")
    MessageXMLFile.str = "<Коммент>" + fmrequestinfo.Comment + "</Коммент>";
    insert(MessageXMLFile);
  end;
  MessageXMLFile.str = "</Раздел9>";
  insert(MessageXMLFile);
end;

private macro _ОтвСотрудн()
  MessageXMLFile.str = "<ОтвСотрудн>" + fmrequestinfo.ProxyPost + "</ОтвСотрудн>";
  insert(MessageXMLFile);
end;

private macro _ФИООтвСотрудн_Фам()
  MessageXMLFile.str = "<Фам>" + fmrequestinfo.ProxyName1 + "</Фам>";
  insert(MessageXMLFile);
end;

private macro _ФИООтвСотрудн_Имя()
  MessageXMLFile.str = "<Имя>" + fmrequestinfo.ProxyName2 + "</Имя>";
  insert(MessageXMLFile);
end;

private macro _ФИООтвСотрудн_Отч()
  if(fmrequestinfo.ProxyName3 != "")
    MessageXMLFile.str = "<Отч>" + fmrequestinfo.ProxyName3 + "</Отч>";
    insert(MessageXMLFile);
  end;
end;

private macro _ФИООтвСотрудн()
  MessageXMLFile.str = "<ФИООтвСотрудн>";
  insert(MessageXMLFile);

  _ФИООтвСотрудн_Фам();
  _ФИООтвСотрудн_Имя();
  _ФИООтвСотрудн_Отч();

  MessageXMLFile.str = "</ФИООтвСотрудн>";
  insert(MessageXMLFile);
end;

private macro _ТелОтвСотрудн()
  MessageXMLFile.str = "<ТелОтвСотрудн>" + fmrequestinfo.ProxyPhone + "</ТелОтвСотрудн>";
  insert(MessageXMLFile);
end;

private macro _Раздел10()
  MessageXMLFile.str = "<Раздел10>";
  insert(MessageXMLFile);

  _ОтвСотрудн();
  _ФИООтвСотрудн();
  _ТелОтвСотрудн();

  MessageXMLFile.str = "</Раздел10>";
  insert(MessageXMLFile);
end;

private macro _ИнфЧасть()
  var IsInfoAbsentParts:string = "";  

  MessageXMLFile.str = "<ИнфЧасть>";
  insert(MessageXMLFile);

  _Раздел1();

  IsInfoAbsentParts = IsInfoAbsentParts + _Раздел2();
  if(fmrequestinfo.ClientType == 1)
    IsInfoAbsentParts = IsInfoAbsentParts + _Раздел3();
  end;
  if(fmrequestinfo.ClientType == 2)
    IsInfoAbsentParts = IsInfoAbsentParts + _Раздел4();
  end;
  if(fmrequestinfo.ClientType == 3)
    IsInfoAbsentParts = IsInfoAbsentParts + _Раздел5();
  end;
  if((fmrequestinfo.ClientNoIdent == "") and ((fmrequestinfo.ClientType == 2) or (fmrequestinfo.ClientType == 3)))
    IsInfoAbsentParts = IsInfoAbsentParts + _Раздел6();
  end;
  if((fmrequestinfo.ClientNoIdent == "") and ((2 <= fmrequestinfo.PaperTULFM) and (fmrequestinfo.PaperTULFM <= 5)))
    IsInfoAbsentParts = IsInfoAbsentParts + _Раздел7();
  end;
  if(fmrequestinfo.ClientNoIdent == "")
    IsInfoAbsentParts = IsInfoAbsentParts + _Раздел8();
  end;
  MessageXMLFile.str = IsInfoAbsentParts;
  insert(MessageXMLFile);

  _Раздел9();
  _Раздел10();
  
  MessageXMLFile.str = "</ИнфЧасть>";
  insert(MessageXMLFile);
end;

private macro _ОтветНаЗапрос()
  MessageXMLFile.str = "<ОтветНаЗапрос>";
  insert(MessageXMLFile);

  _СлужЧасть();
  _ИнфЧасть();

  MessageXMLFile.str = "</ОтветНаЗапрос>";
  insert(MessageXMLFile);
end;

private macro _CreateMessageXMLFile()
  MessageXMLFile.str = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>";
  insert(MessageXMLFile);

  _ОтветНаЗапрос();
end;

macro GetMessage(fmrqi, XMLBody : @string)
  var stat = 0;
  var tostring = "";
  
  setbuff(fmrequestinfo, fmrqi);

  MessageXMLFileName = "..\\workfile\\fmreqi_msg_" + _ПолучитьВременноеИмяФайла(null, "xml");
  
  close(MessageXMLFile);
  if(open(MessageXMLFile, MessageXMLFileName, "utf8"))
    _CreateMessageXMLFile();

    close(MessageXMLFile);
  else
    stat = 1;
  end;

  if(stat == 0)
    ReadFileToString(MessageXMLFileName, tostring);
    XMLBody = tostring;
  end;

  return stat;
end;

macro GetFileName(fmrqi, MMM_Code, RetFileName:@string)
  var stat = 0;
  var tostring = "";

  setbuff(fmrequestinfo, fmrqi);
  
  if (strlen(fmrequestinfo.ArchFileName) > 4)
    RetFileName = fmrequestinfo.ArchFileName;
  else
  // DIFM_bbbbbbbbb_GGGGMMDD_nn_MMM.arj
  RetFileName = "DIFM_";
  RetFileName = RetFileName + fmrequestinfo.BIC;
  RetFileName = RetFileName + "_";

  // GGGGMMDD - дата сообщения requestinfo.EMessageDate.
  var day, mon, year;
  var dateStr = "";   
    var db_date = GetDbDate();
    DateSplit (db_date, day, mon, year );
  dateStr = string(year:4:o)+ string(mon:2:o)+string(day:2:o);

  RetFileName = RetFileName + dateStr;

  RetFileName = RetFileName + "_";

  // nn - порядковый номер архивного файла
  var params : TArray;

  var query = "SELECT COUNT (1) FROM DFMREQUESTINFO_DBT t1 WHERE ";
  query = query + "trunc(T1.T_UNLOADSYSDATE) = ";
  query = query + "trunc (SYSDATE) AND NOT EXISTS  ";
  query = query + "(SELECT 1 FROM DFMREQUESTINFO_DBT t2 WHERE ";
  query = query + "t2.T_ARCHFILENAME = T1.T_ARCHFILENAME  AND t2.t_ID <> t1.t_ID) AND t1.t_ID <> ?";

    var cmd:RsdCommand = RsdCommand(query);
    cmd.NullConversion = true;
    cmd.AddParam("", RSDBP_IN, fmrequestinfo.ID);

    var rs = RsdRecordset(cmd);
  var NumInfo = 0;
    if (rs and rs.movenext())
    NumInfo = int(rs.value(0));
  end;

  NumInfo = NumInfo+1;

  var strNum = string(NumInfo:2:o);

  strNum = substr(strNum, strlen(strNum)-1, 2);

  RetFileName = RetFileName + strNum;

  RetFileName = RetFileName + "_";

  // MMM - признак вида архивного файла
  if(strlen(MMM_Code) > 0 )
    RetFileName = RetFileName + MMM_Code;
  else
    RetFileName = RetFileName + "000";
  end;

  // расширение имени архивного файла
  RetFileName = RetFileName + ".arj";
  end;

  return stat;
end;
