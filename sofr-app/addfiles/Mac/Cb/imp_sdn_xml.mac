/*
$Name: imp_sdn_xml.mac
$Module: ФМ
$Description: Импорт справочника лиц, участвующих в террористической деятельности
*/

Import BankInter, rsd;
Import ServiceAction;
Import mfo_lib;
Import rsexts;

file dbt_terrorist_file     ("terror.dbt"    ) write;
file dbt_terrorist_note_file("ter_note.dbt"  ) write;
file dbt_ter_aka_file       ("ter_aka.dbt"   ) write;
file fmofacchk_file         ("fmofacchk.dbt" ) write;

var DateUpdate,
    inst      ,
    individual,
    vessel    ,
    country   ,
    city      ,
    address   ,
    note      ;


const null_string = "-0-";

/* type of SDN */
const str_SDN_Type_Inst    = null_string;  /* юридическое лицо */
const str_SDN_Type_Individ = "individual"; /* физическое лицо  */
const str_SDN_Type_Vessel  = "vessel";     /* судно            */

const int_SDN_Type_Inst    = 0;   /* юридическое лицо */
const int_SDN_Type_Individ = 1;   /* физическое лицо  */
const int_SDN_Type_Vessel  = 2;   /* судно            */



private macro RunImportTERRORIST_XML( XMLText : string )
  
  var stat = true;
  var nRec, i;
  var FileContent;

  var cmd : RsdCommand;

  file sdn_file() txt;
  file alt_file() txt;
  file add_file() txt;

  if( not clone(dbt_terrorist_note_file) )
      msgbox( "Не удается создать файл " + "terrorist.dbt" )
  elif( not clone(dbt_terrorist_file) )
      msgbox( "Не удается создать файл " + "ter_note.dbt" )
  elif( not clone(dbt_ter_aka_file) )
      msgbox( "Не удается создать файл " + "ter_aka.dbt" )
  elif ( not Clone(fmofacchk_file) )
      msgbox( "Не удается создать файл " + "fmofacchk.dbt" )
  else
    stat = true;

    cmd = RsdCommand("delete from dfmpartychk_dbt where t_checklist = 2");
    cmd.execute();


    i = 0;
    //InitProgress( -1, "~Alt-Break~ Прервать", "Импорт справочника лиц, причастных к терроризму" );

  
    var xml = CreateXMLParser();  // создаем MS-парсер
    xml.loadXML(XMLText);

    FileContent = xml.xml;

    SQL_Execute("DELETE FROM DXMLTEXTSDN_TMP");

    cmd = RsdCommand("INSERT INTO DXMLTEXTSDN_TMP (T_XMLTEXT) VALUES (?)");
    cmd.AddParam("", RSDBP_IN, FileContent);
    cmd.execute();

    // DateUpdate, inst, individual, vessel, country, city, address, note
    cmd = RsdCommand("begin ? := rsi_rsb_fmsdn.Load_SDN(?,?,?,?,?,?,?,?); end;");
    cmd.addParam("ret_val", RSDBP_OUT, V_INTEGER);
    cmd.addParam("", RSDBP_IN, DateUpdate);
    cmd.addParam("", RSDBP_IN, inst);
    cmd.addParam("", RSDBP_IN, individual);
    cmd.addParam("", RSDBP_IN, vessel);
    cmd.addParam("", RSDBP_IN, country);   
    cmd.addParam("", RSDBP_IN, city);      
    cmd.addParam("", RSDBP_IN, address);
    cmd.addParam("", RSDBP_IN, note);

    SQL_Execute(cmd,"Выполняется импорт справочника лиц, причастных к терроризму. Ждите...");

    //RemProgress();

    if( stat )
      msgbox( "Импорт выполнен успешно" );
    end;
    
  end;


end;



macro ImportTERRORIST_XML( _DateUpdate,_inst, _individual, _vessel, _country, _city, _address, _note, _sdnPath )
  
  var stat;
  var nRec, i;
  var cmd : RsdCommand;
  var Retval = 0;


  file sdn_file() txt;
  file alt_file() txt;
  file add_file() txt;

  DateUpdate = _DateUpdate;

  if(_inst)
    inst       = "X";
  else
    inst       = "";
  end;

  if(_individual)
    individual = "X";
  else
    individual = "";
  end;

  if(_vessel)
    vessel     = "X";
  else
    vessel     = "";
  end;

  if(_country)
    country    = "X";
  else
    country    = "";
  end;

  if(_city)
    city       = "X";
  else
    city       = "";
  end;

  if(_address)
    address    = "X";
  else
    address    = "";
  end;

  if(_note)
    note       = "X";
  else
    note       = "";
  end;

  Array Text;
  Array Buttons;
                                                         
  Text(0) = "После импорта справочника вся информация о причастности субъектов к терроризму по справочнику OFAC/SDN List " +
            "будет потеряна. По окончанию процедуры импорта необходимо запустить процедуру проверки субъектов " +
            "на причастность к терроризму по справочнику OFAC/SDN List"; 

  Buttons(0) = " Прервать ";
  Buttons(1) = " Продолжить ";

  if(ConfWin(Text,Buttons) == 1)

    var xml = CreateXMLParser();  // создаем MS-парсер

    stat = xml.load(_sdnPath);

    if(stat)
      Retval = RunImportTERRORIST_XML( xml.xml );
    else
      RunError("Ошибка загрузки xml файла");
      Retval = 1;
    end;
  end;

  return Retval;
end;




