/*
$Name:        sfcbdrdt.mac
$Module:      ПЗО
$Description: Печать детализированного отчета отката удержанных комиссий
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style SoftLab

  File Name   : sfcbdrdt.mac 
  Created     : 18.04.2003
  Description : Печать детализированного отчета отката удержанных комиссий

└───────────────────────────────────────────────────────────────────────────*/
import SfInter; //SfGetContr
import PTInter;//ПолучитьСубъекта

record sfcontr( sfcontr );

private macro GetPartyName(PartyID)
    var party = TRecHandler("party.dbt");
    if( ПолучитьСубъекта( PartyID, party ) == 0 )
        return party.rec.ShortName;
    else
        return "<Субъект не найден>";
    end;
end;


// заголовок отчета для договора обслуживания
macro ReportHeader( ConID/*Ид договора*/, Date/*дата процедуры*/  )
    SfGetContr( ConID, sfcontr );
    println("\nУдаление комиссий по договору N ", sfcontr.Number, " за ", Date, ". Плательщик ", GetPartyName(sfcontr.PartyID), "." );
[-------------------------------------------------------------------------------------];
end;//ReportHeader

// окончание отчета для договора обслуживания
macro ReportFooter( Num /*Количество обработанных комиссий*/)
    if( Num == 0 )
        println("Нет удержанных комиссий, удовлетворяющих параметрам процедуры.");
    end;
[-------------------------------------------------------------------------------------];
println;
println;
end;//ReportHeader

const
   SF_ADD = 0,         // начислено
   SF_PAY =1 ;             // оплачено

var DefStatus = TArray;
DefStatus[SF_ADD] = "начисления";
DefStatus[SF_PAY] = "оплаты";

// строчка отчета об откате удержанной комиссии
macro ReportLine( defcom_addr/*Удержанная комиссия*/, concom_addr/*Комиссия договора*/, contr_addr/*Договор*/, stat, errMsg )
    record comiss(sfcomiss);
    record defcom(sfdef);
    record concom(sfconcom);
    record contr(sfcontr);

    SetBuff( defcom, defcom_addr );
    SetBuff( concom, concom_addr );
    SetBuff( contr, contr_addr );
    SfGetComiss( defcom.FeeType, defcom.CommNumber, comiss );

    if( stat == 0 )            
[   Удалена комиссия  "################", удержанная по договору за период с ########## по ##########.] (comiss.Code, defcom.datePeriodBegin, defcom.DatePeriodEnd );
    else
[ Не удалось удалить комиссию "################" за период с ########## по ##########.] (comiss.Code, defcom.datePeriodBegin, defcom.DatePeriodEnd );
[ по причине "##################################################################################################"]( errMsg:w ); 

    end;
end;//ReportLine

// строчка отчета об откате ТО по удержанной комиссии
macro ReportInvLine( defcom_addr/*Удержанная комиссия*/, concom_addr/*Комиссия договора*/, contr_addr/*Договор*/, sfinv_add/*ТО*/ )
    record comiss(sfcomiss);
    record defcom(sfdefcom);
    record concom(sfconcom);
    record contr(sfcontr);
    record inv(sfinv);

    SetBuff( defcom, defcom_addr );
    SetBuff( concom, concom_addr );
    SetBuff( contr, contr_addr );
    SetBuff( inv, sfinv_add );

[   Откат ТО №#.](inv.DocNumber);
end;//ReportInvLine

// Начало массовой обработки записей
macro PreScan()
end;

// Окончание массовой обработки записей
macro PostScan()
end;

