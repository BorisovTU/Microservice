import BankInter, FIInter, RSD, oralib, likepy;

macro GetSum_NatCur(Sum, DateRate, FIID_From)
  var Sum_NatCur;
  if(ConvSum(Sum_NatCur, Sum, DateRate, FIID_From, NATCUR))
    RunError( "Ошибка при конвертации суммы" );
  end;
  return Sum_NatCur;
end;

macro FillMultyCurrAccTrn(AccTrn : RsbAccTransaction, DocKind, DocumentID, ExistsExRateAccTrn : @bool)
  var sqlStr = "";
  var rs;
  var params : TArray;

  ExistsExRateAccTrn = false;

  sqlStr = sqlStr + "SELECT  ";
  sqlStr = sqlStr + "   t1.t_MethodID ";
  sqlStr = sqlStr + "  ,t1.t_Sum_NatCur ";
  sqlStr = sqlStr + "  ,t1.t_ExRateAccTrnID ";
  sqlStr = sqlStr + "  FROM dacctrn_dbt t1 ";
  sqlStr = sqlStr + " WHERE t1.t_AccTrnID IN ";
  sqlStr = sqlStr + "       ( ";
  sqlStr = sqlStr + "        SELECT t2.t_AccTrnID ";
  sqlStr = sqlStr + "          FROM daccispr_dbt t2 ";
  sqlStr = sqlStr + "         WHERE t2.t_DocKind = :DocKind ";
  sqlStr = sqlStr + "           AND t2.t_DocumentID = :DocumentID ";
  sqlStr = sqlStr + "       ) ";

  params = makeArray(SQLParam("DocKind", DocKind)
                    ,SQLParam("DocumentID", DocumentID)
                    );
  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    AccTrn.MCMethod           = rs.value(0);
    AccTrn.SumEquivalentCarry = rs.value(1);
    if(rs.value(2) > 0)
      ExistsExRateAccTrn = true;
    end;
  end;
end;

macro FillMultyCurrExRateAccTrn(ExRateAccTrn : RsbAccTransaction, DocKind, DocumentID)
  var sqlStr = "";
  var rs;
  var params : TArray;
  
  sqlStr = sqlStr + "SELECT ";
  sqlStr = sqlStr + "   t1.t_FIID_Payer ";
  sqlStr = sqlStr + "  ,t1.t_FIID_Receiver ";
  sqlStr = sqlStr + "  ,t1.t_Account_Payer ";
  sqlStr = sqlStr + "  ,t1.t_Account_Receiver ";
  sqlStr = sqlStr + "  ,t1.t_Sum_Payer ";
  sqlStr = sqlStr + "  ,t1.t_Sum_Receiver ";
  sqlStr = sqlStr + "  ,t1.t_Sum_NatCur ";
  sqlStr = sqlStr + "  FROM dacctrn_dbt t1 ";
  sqlStr = sqlStr + " WHERE t1.t_AccTrnID = ";
  sqlStr = sqlStr + "       ( ";
  sqlStr = sqlStr + "        SELECT t2.t_ExRateAccTrnID";
  sqlStr = sqlStr + "          FROM dacctrn_dbt t2 ";
  sqlStr = sqlStr + "         WHERE t2.t_AccTrnID = ";
  sqlStr = sqlStr + "               ( ";
  sqlStr = sqlStr + "                SELECT t3.t_AccTrnID ";
  sqlStr = sqlStr + "                  FROM daccispr_dbt t3 ";
  sqlStr = sqlStr + "                 WHERE t3.t_DocKind = :DocKind ";
  sqlStr = sqlStr + "                   AND t3.t_DocumentID = :DocumentID";
  sqlStr = sqlStr + "               ) ";
  sqlStr = sqlStr + "       ) ";
  
  params = makeArray(SQLParam("DocKind", DocKind)
                    ,SQLParam("DocumentID", DocumentID)
                    );
  rs = execSQLselect(sqlStr, params, true);
  if(rs and rs.moveNext())
    ExRateAccTrn.FIIDPayer          = rs.value(1);
    ExRateAccTrn.FIIDReceiver       = rs.value(0);
    ExRateAccTrn.AccountPayer       = rs.value(3);
    ExRateAccTrn.AccountReceiver    = rs.value(2);
    ExRateAccTrn.SumPayer           = rs.value(5);
    ExRateAccTrn.SumReceiver        = rs.value(4);
    ExRateAccTrn.SumEquivalentCarry = rs.value(6);
  end;
end;
