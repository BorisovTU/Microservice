 /*
 $Name: ws_getparty.mac
 $Module: Главная книга
 $Description: Макрос панели субъектов
 */

import rsd, CTInter;
import "ws_partycommon.mac";
import "addr_ref.mac";
import "ws_validation.mac";
import "ws_file.mac";
import "ws_partyclasses.mac";
import "ws_person.mac";
import "wcl_pt_access.mac";
import "ws_imgdata.mac";
import "ptfias.mac";
import "likepy.mac";
import rsbdataset, oralib;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;
PRIVATE VAR ParmPartyIdList;

PRIVATE VAR ParmObjectType;
PRIVATE VAR ParmObjectID;
PRIVATE VAR ParmCodeValueList;
PRIVATE VAR ParmObjrgdocCollection;

private var TrnFlag:bool = true;
private var gStat:integer = 0, gMessage:string = "";
private var message = "";

private var PARM_PartyId;
private var PARM_Department;
private var PARM_ErrorMessage;
private var PARM_ListKind;

private var saveFotoHex;
private var saveSignHex;



class TWsCheckSnilsResponse
  var Action;
  var UserQuestion;
  var MessageID;
  var CheckDate;
  var CheckTime;
end;


class TWsCheckECUPRIDResponse
  var Action ;
  var UserQuestion;
  var MessageID 	: string;
  var StatusCode	: string;
  var ReturnCode	: string;
  var ReturnText	: string;
  var ObjectID 		: string;
  var CheckDate		: date;
  var CheckTime		: time;
end;


/* Аналог оператора ?: в си. */
private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else
      return value_false;
   end;
end;

// **********************************************************************************

macro GetObjkcodeList( ObjectType : integer, CodeKind : integer )

  if(ObjectType == V_UNDEF)
    RunError("Не задан вид объекта");
  end;

  var cmd, rs;

  var Rec = TRecHandler("objkcode");
  var Arr = TArray;

  var query = "select * from dobjkcode_dbt where t_objecttype = " + string(ObjectType);

  if(CodeKind != NULL)
    query = query + " and t_codekind = " + string(CodeKind);
  end;

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objkcode");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

const CODEKIND_1 = 1, CODEKIND_2 = 2, CODEKIND_3 = 3, CODEKIND_4 = 4, CODEKIND_5 = 5, CODEKIND_6 = 6;

macro GetObjcodeListByPartyID( ObjectType : integer, ObjectID : integer )

  var cmd, rs, ds;

  var Rec = TRecHandler("objcode");
  var Arr = TArray;

  var query = "select * from dobjcode_dbt where t_objecttype = " + string(ObjectType) + " and t_objectid = " + string(ObjectID);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objcode");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  if( ObjectType == OBJTYPE_FININSTR )

    var query_sub;
    var ds_sub;

    // CODEKIND 1

    query = "SELECT T_FI_CODE AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TRecHandler("objcode");

      p.rec.codekind = CODEKIND_1;
      p.rec.code     = ds.CodeValue;
      p.rec.objecttype     = ObjectType;
      p.rec.autokey = -1;

      Arr[Arr.size] = p.rec;

    end;

    // CODEKIND 2

    query = "SELECT T_ISO_NUMBER AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TRecHandler("objcode");

      p.rec.codekind = CODEKIND_2;
      p.rec.code     = ds.CodeValue;
      p.rec.objecttype     = ObjectType;
      p.rec.autokey = -2;

      Arr[Arr.size] = p.rec;

    end;

    // CODEKIND 3

    query = "SELECT T_CCY AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TRecHandler("objcode");

      p.rec.codekind = CODEKIND_3;
      p.rec.code     = ds.CodeValue;
      p.rec.objecttype     = ObjectType;
      p.rec.autokey = -3;

      Arr[Arr.size] = p.rec;

    end;

    // CODEKIND 4

    query = "SELECT T_LSIN AS CodeValue FROM DAVOIRISS_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TRecHandler("objcode");

      p.rec.codekind = CODEKIND_4;
      p.rec.code     = ds.CodeValue;
      p.rec.objecttype     = ObjectType;
      p.rec.autokey = -4;

      Arr[Arr.size] = p.rec;

    end;

    // CODEKIND 5

    query = "SELECT T_ISIN AS CodeValue FROM DAVOIRISS_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TRecHandler("objcode");

      p.rec.codekind = CODEKIND_5;
      p.rec.code     = ds.CodeValue;
      p.rec.objecttype     = ObjectType;
      p.rec.autokey = -5;

      Arr[Arr.size] = p.rec;

    end;

    // CODEKIND 6

    query = "SELECT T_CODEINACCOUNT AS CodeValue FROM DFININSTR_DBT WHERE T_FIID = " + string(ObjectID);

    ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TRecHandler("objcode");

      p.rec.codekind = CODEKIND_6;
      p.rec.code     = ds.CodeValue;
      p.rec.objecttype     = ObjectType;
      p.rec.autokey = -6;

      Arr[Arr.size] = p.rec;

    end;

  end;

  return Arr;

end;

macro GetPartynameListByPartyID(PartyID : integer)

  if(PartyID == V_UNDEF)
    RunError("Не задан ид. субъекта");
  end;

  var cmd, rs;

  var Rec = TRecHandler("partyname");
  var Arr = TArray;

  var query = "select * from dpartyname_dbt where t_partyid = " + string(PartyID);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("partyname");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetOffshoreNameList(CodeLat3 : string)

  var cmd, rs;

  var Rec = TRecHandler("country");
  var Arr = TArray;

  var query = "select * from dcountry_dbt where t_codelat3 != '" + string(CodeLat3) +
              "' start with t_codelat3 = '" + string(CodeLat3) +
              "' connect by prior t_countryid = t_parentcountryid";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("country");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro CheckOffshore(CountryID)

  var result;

  var query = "select count(*) count from dcountry_dbt c , DOFSHHIST_DBT o where C.T_COUNTRYID = " + string(CountryID) +
              " and C.T_COUNTRYID = O.T_COUNTRYID ";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    if(ds.count == 0)
      result = 0;
    else
      result = 1;
    end;

  end;

  return result;

end;

macro GetObjrgdocList(ObjectType : integer, PartyID : integer, RegPartyKind  : integer, RegDocKind : integer)

  var cmd, rs;

  var Rec = TRecHandler("objrgdoc");
  var Arr = TArray;

  var query = "select * from dobjrgdoc_dbt where t_objecttype = " + string(ObjectType) + " and t_objectid = " + string(PartyID);

  if((RegDocKind != NULL) AND (RegDocKind != 0))
    query = query + " and t_regdockind = " + string(RegDocKind);
  end;

  if((RegPartyKind != NULL) AND (RegPartyKind != 0))
    query = query + " and t_regpartykind = " + string(RegPartyKind);
  end;

  PT_PrintDebug( "ws_getparty.mac.log", "GetObjrgdocList - " + query);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objrgdoc");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetObjkdocList( ObjectType : integer, RegDocKind : integer )

  if(ObjectType == V_UNDEF)
    RunError("Не задан вид объекта");
  end;

  var cmd, rs;

  var Rec = TRecHandler("objkdoc");
  var Arr = TArray;

  var query = "select * from dobjkdoc_dbt where t_objecttype = " + string(ObjectType);

  if((RegDocKind == NULL) OR (RegDocKind == 0))
    query = query + " and t_regdockind IN (SELECT t_regdockind " +
                                         " FROM dobjalreg_dbt " +
                                         " WHERE t_objecttype = " + string(ObjectType) + ") ORDER BY t_regdockind ";
  else
    query = query + " and t_regdockind = " + string(RegDocKind);
  end;

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objkdoc");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetPaprKindList(sub, listLen, paperkindlist)

  var cmd, rs;

  var paperkindlist_str = "";
  
  var i = 0;

  var Rec = TRecHandler("paprkind");
  var Arr = TArray;

  var query = "select * from dpaprkind_dbt where 1 = 1 ";
  
  if((sub != NULL) AND (sub != ""))
  
    query = query + " AND LOWER(t_name) LIKE LOWER ('%' || ? || '%') ";
  
  end;
  
  if((listLen != NULL) AND (listLen != 0) )

    query = query + " AND ROWNUM < " + string(listLen);

  end;
  
  if( (paperkindlist != NULL) AND (paperkindlist.size > 0) )
    
    while(i < paperkindlist.size)
      
      paperkindlist_str = paperkindlist_str + string(paperkindlist[i]);
      
      if(i !=  paperkindlist.size - 1)
      
        paperkindlist_str = paperkindlist_str + ", ";
        
      end;
      
      i = i + 1;
      
    end;

    query = query + " AND t_paperkind NOT IN ( " + string(paperkindlist_str) + " )";

  end;

  cmd = RsdCommand(query);
  
  cmd.NullConversion = true;
  
  if(sub != "")
  
    cmd.addParam( "", RSDBP_IN, sub );
  
  end;
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("paprkind");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetPersnIDCListByPartyID(PartyID : integer)

  var cmd, rs;

  var Rec = TRecHandler("persnidc");
  var Arr = TArray;

  var query = "select * from dpersnidc_dbt where t_personid = " + string(PartyID) + " ORDER BY t_paperkind ";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("persnidc");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetPtregionList()

  var cmd, rs;

  var Rec = TRecHandler("ptregion");
  var Arr = TArray;

  var query = "select * from dptregion_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("ptregion");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

private macro GetRecPartyByID(PartyID : integer);
  var cmd, rs;

  var Rec = TRecHandler("party");

  var query = "select * from dparty_dbt where t_partyid = " + string(PartyID);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

  end;

  return Rec;
end;

macro GetPartyByPartyID(PartyID : integer);

  return GetRecPartyByID(PartyID).rec;
end;

private macro GetRecPersnByID(PersonId : integer);
  var cmd, rs;

  var Rec = TRecHandler("persn");

  var query = "select * from dpersn_dbt where t_personid = " + string(PersonId);

  cmd = RsdCommand(query);
  
  cmd.NullConversion = true;
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

  end;

  return Rec;
end;

macro GetPartyOwnListByPartyID( PartyID : integer )

  var cmd, rs;

  var Rec = TRecHandler("partyown");
  var Arr = TArray;

  var query = "select * from dpartyown_dbt where t_partyid = " + string(PartyID);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("partyown");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetPtkindList(sub, listLen, ptkindlistexc, legalform, isemployer)

  var cmd, rs;

  var ptkindlistexc_str = "";

  var i = 0;

  var Rec = TRecHandler("ptkind");
  var Arr = TArray;

  var query = "select * from dptkind_dbt where 1 = 1";

  if((sub != NULL) AND (sub != ""))

    query = query + " AND LOWER(t_name2) LIKE LOWER ('%' || ? || '%') ";

  end;

  if((listLen != NULL) AND (listLen != 0) )

    query = query + " AND ROWNUM < " + string(listLen);

  end;

  if( (ptkindlistexc != NULL) AND (ptkindlistexc.size > 0) )

    while(i < ptkindlistexc.size)

      ptkindlistexc_str = ptkindlistexc_str + string(ptkindlistexc[i]);

      if(i !=  ptkindlistexc.size - 1)

        ptkindlistexc_str = ptkindlistexc_str + ", ";

      end;

      i = i + 1;

    end;

    query = query + " AND t_partykind NOT IN ( " + string(ptkindlistexc_str) + " )";

  end;

  if(legalform != NULL)

    if(legalform == 1)

      query = query + " AND (T_LEGALFLAG = 'X' ";

    end;

    if(legalform == 2)

      query = query + " AND (T_PERSNFLAG = 'X' ";

    end;

    if((legalform == 2) AND ((isemployer != NULL) AND (isemployer == true)))

      query = query + " OR T_INDENFLAG = 'X' ";

    end;

    query = query + " OR (T_LEGALFLAG = CHR(0) AND T_PERSNFLAG = CHR(0) AND T_INDENFLAG = CHR(0))) ";

  end;

  cmd = RsdCommand(query);

  cmd.NullConversion = true;

  if(sub != "")

    cmd.addParam( "", RSDBP_IN, sub );

  end;

  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("ptkind");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetNameAlgList()

  var cmd, rs;

  var Rec = TRecHandler("namealg");
  var Arr = TArray;

  var query = "select * from dnamealg_dbt where t_itypealg = 3420"; // Алгоритм подстановки СПИ

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("namealg");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

// macro GetPtsvdpList(PartyID : integer)

  // var cmd, rs;

  // var Rec = TRecHandler("ptsvdp");
  // var Arr = TArray;

  // var query = "select * from dptsvdp_dbt where t_partykind = 1 and t_partyid = " + string(PartyID);

  // cmd = RsdCommand(query);
  // rs = RsdRecordset(cmd);

  // while(rs.movenext)

    // _CopyRecordsetToRecHandler(rs, Rec);

    // var p = TRecHandler("ptsvdp");
    // copy(p, Rec);

    // Arr[Arr.size] = p.rec;

  // end;

  // return Arr;

// end;

// macro GetPartyFromDpList()

  // var cmd, rs;

  // var Rec = TRecHandler("party");
  // var Arr = TArray;

  // var query = "select p.* from dparty_dbt p, ddp_dep_dbt d where d.t_code = p.t_partyid";

  // cmd = RsdCommand(query);
  // rs = RsdRecordset(cmd);

  // while(rs.movenext)

    // _CopyRecordsetToRecHandler(rs, Rec);

    // var p = TRecHandler("party");
    // copy(p, Rec);

    // Arr[Arr.size] = p.rec;

  // end;

  // return Arr;

// end;

// macro GetClientList(PartyID : integer)

  // var cmd, rs;

  // var Rec = TRecHandler("client");
  // var Arr = TArray;

  // var query = "select * from dclient_dbt where t_partyid = " + string(PartyID);

  // cmd = RsdCommand(query);
  // rs = RsdRecordset(cmd);

  // while(rs.movenext)

    // _CopyRecordsetToRecHandler(rs, Rec);

    // var p = TRecHandler("client");
    // copy(p, Rec);

    // Arr[Arr.size] = p.rec;

  // end;

  // return Arr;

// end;

// macro GetSfPlanList()

  // var cmd, rs;

  // var Rec = TRecHandler("sfplan");
  // var Arr = TArray;

  // var query = "select * from dsfplan_dbt";

  // cmd = RsdCommand(query);
  // rs = RsdRecordset(cmd);

  // while(rs.movenext)

    // _CopyRecordsetToRecHandler(rs, Rec);

    // var p = TRecHandler("sfplan");
    // copy(p, Rec);

    // Arr[Arr.size] = p.rec;

  // end;

  // return Arr;

// end;

// macro GetPtDpSfPlanList(PartyID : integer)

  // var cmd, rs;

  // var Rec = TRecHandler("ptdpsfplan");
  // var Arr = TArray;

  // var query = "select * from dptdpsfplan_dbt where t_partyid = " + string(PartyID);

  // cmd = RsdCommand(query);
  // rs = RsdRecordset(cmd);

  // while(rs.movenext)

    // _CopyRecordsetToRecHandler(rs, Rec);

    // var p = TRecHandler("ptdpsfplan");
    // copy(p, Rec);

    // Arr[Arr.size] = p.rec;

  // end;

  // return Arr;

// end;


macro GetPtsvdpList1(PartyID : integer)

  var Arr = TArray;

  // var query = " select dp.t_name as filial, p.t_name as name " +
              // "  from dptsvdp_dbt pt, ddp_dep_dbt dp, dparty_dbt p " +
              // " where     pt.t_partyid = " + string(PartyID) +
              // "      and pt.t_partykind = 1 " +
              // "      and pt.t_department = dp.t_code " +
              // "      and dp.t_partyid = p.t_partyid ";

  var query = " SELECT dp.t_name AS filial, p.t_name AS name, pt.t_department AS department"
              " FROM dptsvdp_dbt pt "
              "       JOIN ddp_dep_dbt dp "
              "          ON pt.t_department = dp.t_code "
              "       JOIN dparty_dbt p "
              "          ON dp.t_partyid = p.t_partyid "
              " WHERE pt.t_partyid = " + string(PartyID) + " AND pt.t_partykind = 1";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while (ds.MoveNext())

    var p = TWSFilName();

    p.filial      = ds.filial;
    p.name        = ds.name;
    p.department  = ds.department;

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

// macro GetClientList(PartyID : integer)

  // var Arr = TArray;

  // var query = " select t.* " +
              // " from (  select sk.t_name skname, " +
              // "                cl.t_startdate startdate, " +
              // "                cl.t_finishdate finishdate, " +
              // "                sf.t_name tname, " +
              // "                max (pt.t_startdate) maxstartdate " +
              // "           from dservkind_dbt sk, " +
              // "                dclient_dbt cl, " +
              // "                dsfplan_dbt sf, " +
              // "                dptdpsfplan_dbt pt " +
              // "          where     sk.t_servisekind = cl.t_servicekind " +
              // "                and cl.t_partyid = " + string(PartyID) +
              // "                and cl.t_department = " + string(Department) +
              // "                and cl.t_branch = 0 " +
              // "                and sf.t_sfplanid = pt.t_sfplanid " +
              // "                and pt.t_servicekind = cl.t_servicekind " +
              // "                and pt.t_department = " + string(Department) +
              // "                and pt.t_partyid = " + string(PartyID) +
              // "       group by sk.t_name, " +
              // "                cl.t_startdate, " +
              // "                cl.t_finishdate, " +
              // "                sf.t_name) t " +
              // " where t.maxstartdate <= " + string({curdate});

  // var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  // while (ds.MoveNext())

    // var p = TWSSkTName();

    // p.skname        = ds.skname;
    // p.startdate     = ds.startdate;
    // p.finishdate    = ds.finishdate;
    // p.tname         = ds.tname;
    // p.maxstartdate  = ds.maxstartdate;

    // Arr[Arr.size] = p;

  // end;

  // return Arr;

// end;

macro GetClientList2(PartyID : integer)

  var Arr = TArray;

  var query = " select t.* " +
              " from ( select sk.t_name skname, " +
              "       cl.t_startdate startdate, " +
              "       cl.t_finishdate finishdate, " +
              "       sf.t_name tname, " +
              "       max (pt.t_startdate) maxstartdate, " +
              "       cl.t_department department, " +
              "       cl.t_servicekind servicekind, " +
              "       NVL(sf.t_sfplanid, 0) sfplanid " +
              "  from dclient_dbt cl " +
              "       join dservkind_dbt sk " +
              "          on sk.t_servisekind = cl.t_servicekind " +
              "       join dptdpsfplan_dbt pt " +
              "          on     cl.t_department = pt.t_department " +
              "             and pt.t_servicekind = cl.t_servicekind " +
              "             and pt.t_partyid = " + string(PartyID) +
              "       left join dsfplan_dbt sf " +
              "          on sf.t_sfplanid = pt.t_sfplanid " +
              " where cl.t_partyid = " + string(PartyID) + " and cl.t_branch = 0 " +
              " group by sk.t_name, " +
              "        cl.t_startdate, " +
              "       cl.t_finishdate, " +
              "       sf.t_name, " +
              "       cl.t_department, " +
              "       cl.t_servicekind, " +
              "       sf.t_sfplanid) t " +
              " where t.maxstartdate <= TO_DATE('" + string({curdate}) + "', 'DD-MM-YYYY')";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while (ds.MoveNext())

    var p = TWSSkTName();

    p.skname        = ds.skname;
    p.startdate     = ds.startdate;
    p.finishdate    = ds.finishdate;
    p.tname         = ds.tname;
    p.department    = ds.department;
    p.servicekind   = ds.servicekind;
    p.sfplanid      = ds.sfplanid;

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

macro GetClientList3(PartyID : integer)

  var Arr = TArray;

  var query = " select dp.t_name bname, pt.t_name name, cl.t_oper oper," +
              "        cl.t_department department, " +
              "        cl.t_servicekind servicekind, " +
              "        cl.t_branch branch " +
              " from dclient_dbt cl" +
              "      join ddp_dep_dbt dp" +
              "         on cl.t_branch = dp.t_code" +
              "      join dparty_dbt pt" +
              "         on dp.t_partyid = pt.t_partyid" +
              " where cl.t_partyid = " + string(PartyID) + " and cl.t_branch != 0";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while (ds.MoveNext())

    var p = TWSBTNameOper();

    p.bname       = ds.bname;
    p.name        = ds.name;
    p.oper        = ds.oper;
    p.department  = ds.department;
    p.servicekind = ds.servicekind;
    p.branch      = ds.branch;

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

macro GetServKindList()

  var cmd, rs;

  var Rec = TRecHandler("servkind");
  var Arr = TArray;

  var query = "select * from dservkind_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("servkind");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetSfPlanList()

  var Arr = TArray;

  var query = " select s.t_sfplanid sfplanid, s.t_num num, s.t_name name, ds.t_department department, ss.t_servisekind servisekind " +
              " from dsfplan_dbt s " +
              "     join dsfplandep_dbt ds" +
              "        on s.t_sfplanid = ds.t_sfplanid" +
              "     join dsfplanservkind_dbt ss" +
              "        on s.t_sfplanid = ss.t_sfplanid";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while (ds.MoveNext())

    var p = TWSSfPlanDS();

    p.sfplanid    = ds.sfplanid;
    p.num         = ds.num;
    p.name        = ds.name;
    p.department  = ds.department;
    p.servisekind = ds.servisekind;

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

private macro GetServiceKind(listkind)
  var result;
  var stat;

  file lst("partylst.dbt");

  lst.Listkind = listkind;

  stat = GetEQ( lst );

  if(stat)
    result = lst.servicekind
  else
    result = 0;
  end;

  return result;
end;

macro GetAdressList(PartyID : integer)

  var cmd, rs;

  var Rec = TRecHandler("adress");
  var Arr = TArray;

  var query = "select * from dadress_dbt where t_partyid = " + string(PartyID);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("adress");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetContactKind(Kind)

  var p = TWsContactKind;

  var cmd, rs;

  var query = "select * from dcontactkind_dbt where t_kind = " + string(Kind);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    p.Kind        = SQL_ConvType(rs.value("T_Kind"));
    p.Name        = SQL_ConvType(rs.value("T_Name"));
    p.Description = SQL_ConvType(rs.value("T_Description"));
    p.RegexMatch  = SQL_ConvType(rs.value("T_RegexMatch"));

  end;

  return p;

end;

macro GetContactType(Type, Kind)

  var p = TWsContactType;

  var cmd, rs;

  var query = "select * from dcontacttype_dbt where t_type = " + string(Type) + 
              " AND t_kind = " + string(Kind);
  
  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    p.Type = SQL_ConvType(rs.value("T_Type"));
    p.Kind = SQL_ConvType(rs.value("T_Kind"));
    p.Name = SQL_ConvType(rs.value("T_Name"));

  end;

  return p;

end;

macro GetAdrtype(type, LagalForm)

  var p = TRecHandler("adrtype");

  var cmd, rs;

  var query = "select * from dadrtype_dbt where t_type = " + string(type);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    _CopyRecordsetToRecHandler(rs, p);
    
    if(LagalForm == 2)
      if(p.rec.name == "Юридический")
        p.rec.name = "Место жительства";
      else
        if(p.rec.name == "Фактический")
          p.rec.name = "Место пребывания";
        end;
      end;
    end;    

  end;

  return p.rec;

end;

macro GetMobPrvdr(name)

  var p = TRecHandler("mobprvdr");

  var cmd, rs;

  var query = "select * from dmobprvdr_dbt where t_name = '" + name + "'";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    _CopyRecordsetToRecHandler(rs, p);

  end;

  return p.rec;

end;

macro GetContactList(PartyID : integer, legalform)

  var cmd, rs;

  var Arr = TArray;

  var query = "select * from dcontact_dbt where t_partyid = " + string(PartyID) + " ORDER BY t_contactkind, t_contacttype ";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var p = TWsContact;
    
    p.RecID       = SQL_ConvType(rs.value("T_RecID"));
    p.PartyID     = SQL_ConvType(rs.value("T_PartyID"));
    p.AddressType = GetAdrtype(SQL_ConvType(rs.value("T_AddressType")), legalform);
    p.ContactKind = GetContactKind(SQL_ConvType(rs.value("T_ContactKind")));
    p.ContactType = GetContactType(SQL_ConvType(rs.value("T_ContactType")), SQL_ConvType(rs.value("T_ContactKind")));
    p.Provider    = GetMobPrvdr(SQL_ConvType(rs.value("T_Provider")));
    p.ValueC      = SQL_ConvType(rs.value("T_Value"));
    p.Note        = SQL_ConvType(rs.value("T_Note"));
    p.IsMain      = SQL_ConvTypeBool(rs.value("T_IsMain"));

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

macro GetObjkrgptList(ObjectType : integer)

  var cmd, rs;

  var Rec = TRecHandler("objkrgpt");
  var Arr = TArray;

  var query = " select * from dobjkrgpt_dbt where t_regpartykind in " +
                                                                    " (select t_regpartykind " +
                                                                    " from dobjalreg_dbt " +
                                                                    " where t_objecttype = " + string(ObjectType) + " ) " +
              " order by t_regpartykind ";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objkrgpt");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetObjalptList()

  var cmd, rs;

  var Rec = TRecHandler("objalpt");
  var Arr = TArray;

  var query = "select * from dobjalpt_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objalpt");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetObjalcodList(ObjectType : integer)

  var cmd, rs;

  var Rec = TRecHandler("objalcod");
  var Arr = TArray;

  var query = "select * from dobjalcod_dbt where t_objecttype = " + string(ObjectType);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objalcod");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetObjalregList(ObjectType : integer)

  var cmd, rs;

  var Rec = TRecHandler("objalreg");
  var Arr = TArray;

  var query = "select * from dobjalreg_dbt where t_objecttype = " + string(ObjectType);

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objalreg");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetLastOpenCurDate() :  date

  var LastOpenCurDate : date;

  var query = "SELECT MAX(T_CURDATE) as LastOpenCurDate" +
              " FROM DCURDATE_DBT " +
              " WHERE T_ISCLOSED != 'X' AND T_BRANCH = " + string({OperDprt});

  PT_PrintDebug( "ws_getparty.mac.log", " - GetLastOpenCurDate query - " + query);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())
    LastOpenCurDate = ds.LastOpenCurDate;
  end;

  return LastOpenCurDate;

end;

////////////////////////////////////////////////
// Возвращает Partylst для listkind
////////////////////////////////////////////////

macro GetPartylstByListKind(listkind : integer)

  PT_PrintDebug( "ws_getparty.mac.log", " - GetPartylstByListKind - ");

  var result;
  var stat;

  file lst("partylst.dbt");
  var partylstRec = TRecHandler("partylst");

  if(listkind == NULL)
    listkind = 1;
  end;

  lst.Listkind = listkind;

  stat = GetEQ( lst );

  if(stat)
    Copy( partylstRec, lst );
    result = partylstRec.rec;
  else
    result = NULL;
  end;

  PT_PrintDebug( "ws_getparty.mac.log", "result - ", result.listkind);

  return result;

end;

private macro GetPartyKind(listkind)
  var result;
  var stat;

  file lst("partylst.dbt");

  lst.Listkind = listkind;

  stat = GetEQ( lst );

  if(stat)
    result = lst.partykind
  else
    result = 0;
  end;

  return result;
end;

private macro GetFilName()

  var filname = TWSFilName();

  var query = " SELECT dp.t_name AS filial, p.t_name AS name " +
              "  FROM ddp_dep_dbt dp JOIN dparty_dbt p ON dp.t_partyid = p.t_partyid " +
              " WHERE dp.t_code = " + string({OurBank});

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    filname.filial     = ds.filial;
    filname.name       = ds.name;
    filname.department = {OurBank};
    filname.action     = PT_CREATE;

  end;

  return filname;

end;

private macro GetSkName(ServiceKind)

  var sktname = TWSSkTName();

  var query = " SELECT t_name AS name " +
              "  FROM dservkind_dbt " +
              " WHERE t_servisekind = " + string(ServiceKind);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    sktname.skname        = ds.name;
    sktname.startdate     = {curdate};
    // sktname.finishdate
    // sktname.tname
    sktname.department    = {OperDprt};
    sktname.servicekind   = ServiceKind;
    // sktname.sfplanid
    sktname.action        = PT_CREATE;

  end;

  return sktname;

end;

macro GetIsAdmin

  var UserIsAdmin = false;

  if( {cTypePerson} == TP_ADM )
    UserIsAdmin = true;
  else
    UserIsAdmin = false;
  end;

  return UserIsAdmin;

end;

////////////////////////////////////////////////
// Возвращает PartyKName
////////////////////////////////////////////////

macro GetPartyKNameList()

  var cmd, rs;

  var partyknameRec = TRecHandler("partykname");
  var partyknameArray = TArray;

  cmd = RsdCommand("select * from dpartykname_dbt order by t_nametypeid");
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, partyknameRec);

    var p = TRecHandler("partykname");
    copy(p, partyknameRec);

    partyknameArray[partyknameArray.size] = p.rec;

  end;

  return partyknameArray;

end;

macro PreSetParty(ObjectType : integer, ListKind : integer, LegalForm : integer) : PartyInfo

  var responseBuilder = WebResponseBuilder;
  var error           = WsErrorMessage;
  var question        = WsQuestion;

  var p = PartyInfo();

  p.PtecuprIdchk = TWsPtecuprIdchk();
  p.Partylst = GetPartylstByListKind(ListKind);

  var partyown = TRecHandler("partyown");

  var PartyKind = GetPartyKind(ListKind);

  p.PartyOwnCollection = TArray;
      
  if(PartyKind != 0)

    partyown.rec.partyid = 0;
    partyown.rec.partykind = PartyKind;
    partyown.rec.superior = 0;
    partyown.rec.subkind = 0;
    partyown.rec.branch = {OperDprt};
    partyown.rec.numsession = 0;

    p.PartyOwnCollection[p.PartyOwnCollection.size] = partyown.rec;

  end;

  p.PtkindCollection = GetPtkindList();

  p.PtsvdpCollection1 = TArray;
  p.PtsvdpCollection1[p.PtsvdpCollection1.size] = GetFilName();

  var ServiceKind = GetServiceKind(ListKind);

  if(ServiceKind != 0)

    p.ClientCollection2 = TArray;
    p.ClientCollection2[p.ClientCollection2.size] = GetSkName(ServiceKind);

  end;

  p.ServKindCollection     = GetServKindList();
  p.SfPlanDSCollection     = GetSfPlanList();

  p.CodeKindCollection = GetObjkcodeList(ObjectType);

  p.ObjkrgptCollection = GetObjkrgptList(ObjectType);
  p.ObjalptCollection  = GetObjalptList();
  p.ObjkdocCollection  = GetObjkdocList(ObjectType);

  p.ObjalcodCollection = GetObjalcodList(ObjectType);
  p.ObjalregCollection = GetObjalregList(ObjectType);

  p.Party                  = TRecHandler("party").rec;
  p.Party.setaccsearchalg  = 1;
  p.Party.legalform        = LegalForm;

  p.Persn                  = TRecHandler("persn").rec;

  var res, err;

  GetRegistryValue( "COMMON\\ПЕРЕМЕННЫЕ\\СТРАНА РЕЗИДЕНТНОСТИ", V_STRING, res, err );

  if(err == 0)
    p.CountryRez       = GetCountryByCodeLat3(res);
    p.Country          = p.CountryRez;
    p.Party.nrcountry = res;
    p.OffshoreNameList = GetOffshoreNameList(p.Party.nrcountry);
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  GetRegistryValue( "CB\\PARTY\\WEB\\FOTOSIGNUSE", V_BOOL, res, err ,null, {oper});

  if(err == 0)
    p.FotoSignUse = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  p.ListKind               = ListKind;
  p.ServiceKind            = GetServiceKind(ListKind);
  p.CurDate                = {curdate};
  p.IsAdmin                = GetIsAdmin();
  p.LastOpenCurDate        = GetLastOpenCurDate();

  if(LegalForm == 2)

    p.PtregionCollection     = GetPtregionList();
    p.PaprKindCollection = GetPaprKindList();
    p.PersonIDCollection   = TArray;

  end;

  p.NameAlgCollection   = GetNameAlgList();

  p.PartyKNameCollection = GetPartyKNameList();

  p.CodeValueCollection = TArray;
  p.ObjrgdocCollection  = TArray;

  p.Foto = TWsImage();
  p.Sign = TWsImage();

  GetRegistryValue( "CB\\PARTY\\PERSCHECKCOUNTRY", V_BOOL, res, err ,null, {oper});

  if(err == 0)
    p.PersCheckCountry = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;
  
  p.Restriction_104 = CheckActionRestriction(104);
  
  GetRegistryValue( "COMMON\\REFERENCES\\MANUAL_CHANGE_CLIENT_CODE", V_BOOL, res, err ,null, {oper});

  if(err == 0)
    p.IsEnableCode1 = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;
  
  GetRegistryValue( "CB\\PARTY\\КЛАДР\\JURADDRCOUNTRY", V_INTEGER, res, err ,null, {oper});

  if(err == 0)
    p.JurAddrCountry = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;  
  
  responseBuilder.SetUserObject(p);

  return responseBuilder.Result;

end;

macro PT_GetPartyByID(ObjectType : integer, PartyID : integer, ListKind : integer)

  PT_PrintDebug( "ws_getparty.mac.log", "***PT_GetPartyByID***");

  var responseBuilder = WebResponseBuilder;
  var error           = WsErrorMessage;
  var question        = WsQuestion;

  var p = PartyInfo();

  PT_PrintDebug( "ws_getparty.mac.log", "***GetPartylstByListKind***");
  PT_PrintDebug( "ws_getparty.mac.log", "ListKind - " + ListKind);

  p.Partylst = GetPartylstByListKind(ListKind);

  if(PartyID == V_UNDEF)
    RunError("Не задан ид. субъекта");
  end;

  var RecParty = GetRecPartyByID(PartyID);

  p.Party = RecParty.rec;

  p.Persn = TRecHandler("persn").rec;

  if(p.Party.legalform == 2) // Для физ. лиц.
    p.Persn = GetRecPersnByID(PartyID).rec;

    p.Party.name      = p.Persn.name1 + " " + p.Persn.name2 + " " + p.Persn.name3;
    
    p.Party.shortname = p.Persn.name1;

    if(p.Persn.name2 != "")
      p.Party.shortname = p.Party.shortname + " " + SubStr( p.Persn.name2, 1, 1) + ".";
    end;
    
    if(p.Persn.name3 != "")
      p.Party.shortname = p.Party.shortname + " " + SubStr( p.Persn.name3, 1, 1) + ".";
    end;
	
	var BankruptStatus = 0 ; 
	
	var mes = 0;

	mes = GetPartyBankruptStatus(PartyID, date(), @BankruptStatus);
	
	if(( BankruptStatus!=0 ) AND ( mes ==0 ))
	
      var query, cmd, rs;
  

      query = 	" SELECT llvalues.T_NAME NAME	 							"+
				" FROM dllvalues_dbt llvalues								"+
				" WHERE  llvalues.T_LIST = 3564 AND llvalues.T_ELEMENT  = ?	";

      cmd = RsdCommand(query);
 
      cmd.addParam( "BankruptStatus", RSDBP_IN, BankruptStatus);

      rs = RsdRecordset(cmd);

	  if (rs.movenext)
	  
        p.BankRuptStatusName = rs.value("NAME"); 
		 	
	  end;
	
	end;
	
  end;

  p.CodeKindCollection = GetObjkcodeList(ObjectType);
  p.CodeValueCollection = GetObjcodeListByPartyID(ObjectType, PartyID);

  p.PartyOwnCollection = GetPartyOwnListByPartyID( PartyID );

  p.PtkindCollection = GetPtkindList();

  p.DateCreateForm = readNoteForObject( ObjectType, UniID(RecParty, ObjectType), 1 );  // Дата заполнения анкеты
  p.StrgPeriodForm = readNoteForObject( ObjectType, UniID(RecParty, ObjectType), 2 );  // Срок хранения анкеты
  p.DateModifyForm = readNoteForObject( ObjectType, UniID(RecParty, ObjectType), 45 ); // Дата обновления анкеты

  p.PtsvdpCollection1 = GetPtsvdpList1(PartyID);
  p.ClientCollection2 = GetClientList2(PartyID);
  p.ClientCollection3 = GetClientList3(PartyID);

  p.ServKindCollection     = GetServKindList();
  p.SfPlanDSCollection     = GetSfPlanList();

  p.AdressCollection = GetAdressList(PartyID);
  p.ContactCollection = GetContactList(PartyID, p.Party.legalform);

  p.ObjkrgptCollection = GetObjkrgptList(ObjectType);
  p.ObjalptCollection  = GetObjalptList();
  p.ObjkdocCollection  = GetObjkdocList(ObjectType);

  p.ObjalcodCollection = GetObjalcodList(ObjectType);
  p.ObjalregCollection = GetObjalregList(ObjectType);
  p.ObjrgdocCollection = GetObjrgdocList(ObjectType, PartyID);

  p.PersonIDCollection = GetPersnIDCListByPartyID(PartyID);

  p.ListKind               = ListKind;
  p.ServiceKind            = GetServiceKind(ListKind);
  p.CurDate                = {curdate};
  p.LastOpenCurDate        = GetLastOpenCurDate();
  p.IsAdmin                = GetIsAdmin();

  if(p.Party.legalform == 2)

    p.PtregionCollection = GetPtregionList();
    p.PaprKindCollection = GetPaprKindList();

  end;

  p.NameAlgCollection   = GetNameAlgList();
  
  p.PartyKNameCollection = GetPartyKNameList();
  p.PartynameCollection = GetPartynameListByPartyID(PartyID);

  var res, err;

  GetRegistryValue( "COMMON\\ПЕРЕМЕННЫЕ\\СТРАНА РЕЗИДЕНТНОСТИ", V_STRING, res, err );

  if(err == 0)
    p.CountryRez = GetCountryByCodeLat3(res);
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  GetRegistryValue( "CB\\PARTY\\WEB\\FOTOSIGNUSE", V_BOOL, res, err );

  if(err == 0)
    p.FotoSignUse = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  p.Country          = GetCountryByCodeLat3(p.Party.nrcountry);
  p.OffshoreNameList = GetOffshoreNameList(p.Party.nrcountry);

  var Foto = GetImage(ObjectType, PartyID, 2, 0);
  
  if(Foto != null)
    saveFotoHex = Foto.HexData;
  end;
  
  var Sign = GetImage(ObjectType, PartyID, 1, 0);
  
  if(Sign != null)
    saveSignHex = Sign.HexData;
  end;

  GetRegistryValue( "CB\\PARTY\\PERSCHECKCOUNTRY", V_BOOL, res, err ,null, {oper});

  if(err == 0)
    p.PersCheckCountry = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  p.Restriction_104 = CheckActionRestriction(104);

  GetRegistryValue( "CB\\PARTY\\КЛАДР\\JURADDRCOUNTRY", V_INTEGER, res, err ,null, {oper});

  if(err == 0)
    p.JurAddrCountry = res;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;    

  var PartyObj = RsbParty(PartyID);
  
  if(PartyObj != null)
  
    var CheckECUPRID = PartyObj.PartyCheckECUPRID();

	CheckECUPRID.First();
	
	if(CheckECUPRID != null)
	
	   p.PtecuprIdchk = TWsPtecuprIdchk();
	   
	   p.PtecuprIdchk.MessageID = CheckECUPRID.MessageID;
	   
	   p.PtecuprIdchk.Id  = CheckECUPRID.RecID;
		
	   p.PtecuprIdchk.PersonID  = CheckECUPRID.PersonID;
	   
	   p.PtecuprIdchk.Oper  = CheckECUPRID.Oper;
	   
	   p.PtecuprIdchk.StatusCode = CheckECUPRID.StatusCode; 
	   
	   p.PtecuprIdchk.ReturnCode = CheckECUPRID.ReturnCode; 
	   
	   p.PtecuprIdchk.ReturnText = CheckECUPRID.ReturnText; 
	   
	   p.PtecuprIdchk.ObjectID = CheckECUPRID.ObjectID; 
	   
	   p.PtecuprIdchk.CheckDate = CheckECUPRID.CheckDate;
	   
	   p.PtecuprIdchk.CheckTime = CheckECUPRID.CheckTime; 
	
	end;
  
  end;
  
  

  responseBuilder.SetUserObject(p);

  return responseBuilder.Result;

end;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  PT_PrintDebug( "ws_getparty.mac.log", "objErr.stat " + string(objErr.stat));
  PT_PrintDebug( "ws_getparty.mac.log", "objErr.message " + string(objErr.message));
  
  if(objErr.stat != 0)
    ErrorMessage.Code     = objErr.stat;
    ErrorMessage.Message  = objErr.message;
    ErrorMessage.Severity = MessageSeverity.RuntimeError;

    ResponseBuilder.AddMessage( ErrorMessage );
  end;

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro CheckDelPartyKind(PartyID, PartyKind)

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = PT_CheckClosePartyRole( PartyID, PartyKind );

  PT_PrintDebug( "ws_getparty.mac.log", "PT_CheckClosePartyRole( PartyID, PartyKind ); - " + stat);

  if( stat != 0 )

    AddErrorMessage(@ErrorMessage);

  end;

  if( stat == 0 )

    stat = CheckDelOperDprt( PartyID, PartyKind );

    PT_PrintDebug( "ws_getparty.mac.log", "CheckDelOperDprt( PartyID, PartyKind ); - " + stat);

    if( stat != 0 )

      AddErrorMessage(@ErrorMessage);

    end;

  end;

  if( stat == 0 )

    stat = CheckDelNotOperDprt( PartyID, PartyKind );

    PT_PrintDebug( "ws_getparty.mac.log", "CheckDelNotOperDprt( PartyID, PartyKind ); - " + stat);

    if( stat != 0 )

      AddErrorMessage(@ErrorMessage);

    end;

  end;

  if( stat == 0 )

    res = true;

  else

    res = false;

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro CheckDeleteClientService(partyid, servicekind, department)

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();


  var stat = PT_CheckDeleteClientService(partyid, servicekind, department);

  PT_PrintDebug( "ws_getparty.mac.log", "PT_CheckDeleteClientService - " + stat);

  if( stat != 0 )

    AddErrorMessage(@ErrorMessage);

  end;

  if( stat == 0 )

    res = true;

  else

    res = false;

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro CheckHasDoubler(MainPartyID)

  var result = true;

  var query = "select count(*) count from dparty_dbt p where p.t_mainpartyid = " + string(MainPartyID);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    if(ds.count == 0)

      var PartyOrg = RsbParty(MainPartyID);

      PartyOrg.IsHasDoubler  = false;

      result = PartyOrg.Update();

    end;

  end;

  return result;

end;

private macro SaveP(PartyInfo, Party : @RsbParty, SkipCheckPartyPapers)

  PT_PrintDebug( "ws_getparty.mac.log", "PartyInfo.Party.legalform=" + PartyInfo.Party.legalform);

  record persnidcRecord("persnidc.dbt");
  record persnRecord("persn.dbt");

  clearRecord(persnidcRecord);
  clearRecord(persnRecord);

  var d, m, y;

  var stat = true;

  // проверить существование свойства Party в объекте PartyInfo
  var iprop = GenPropID(PartyInfo, "Party");

  if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

    var wParty = GenGetProp(PartyInfo, "Party");

    // работа с объектом Party

    // Party.OwnerKind           = wParty.ownerkind;
    Party.LegalForm           = wParty.legalform;
    Party.ShortName           = wParty.shortname;
    Party.FullName            = wParty.name;
    // Party.AddName             = wParty.addname;
    Party.NRCountry           = wParty.nrcountry;
    Party.OfshoreZone         = wParty.ofshorezone;
    if(PartyInfo.Party.LegalForm == 1)
      Party.OKPO                = wParty.okpo;
      Party.SuperiorID          = wParty.superior;
    else
      Party.IsNotResident       = wParty.notresident;
    end;
    // Party.Change_Date         = wParty.change_date;
    // Party.Change_DatePrev     = wParty.change_dateprev;
    // Party.IsLocked            = wParty.locked;
    //Party.TaxInstitution      = wParty.taxinstitution;
    //Party.TaxRegDate          = wParty.taxregdate;
    // Party.SysType             = wParty.systype;
    // Party.UserType            = wParty.usertype;
    // Party.UserField1          = wParty.userfield1;
    // Party.UserField2          = wParty.userfield2;
    // Party.UserField3          = wParty.userfield3;
    // Party.UserField4          = wParty.userfield4;
    // Party.IsConsolidateRecord = wParty.consolidaterecord;
    Party.SetAccSearchAlg     = wParty.setaccsearchalg;
    Party.MainPartyID         = wParty.mainpartyid;
    Party.IsProbDoubler       = wParty.isprobdoubler;
    Party.IsDoubler           = wParty.isdoubler;
    Party.IsHasDoubler        = wParty.hasdoubler;
    Party.Notidentify         = wParty.notidentify;
  end;

  if(PartyInfo.Party.LegalForm == 2)

    // проверить существование свойства Persn в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "Persn");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wPersn = GenGetProp(PartyInfo, "Persn");

      // работа с объектом Persn

      if(wPersn.isemployer == "X")
        Party.IsEmployer  = true;
        Party.OKPO        = wParty.okpo;
      else
        Party.IsEmployer  = false;
      end;

      PT_PrintDebug( "ws_getparty.mac.log", "Party.IsEmployer=" + string(Party.IsEmployer));
      PT_PrintDebug( "ws_getparty.mac.log", "wPersn.isemployer=" + string(wPersn.isemployer));
      
      Party.LastName    = wPersn.name1;
      Party.FirstName   = wPersn.name2;
      Party.Patronymic  = wPersn.name3;
      Party.IsMale      = wPersn.ismale;
      Party.BirthDate   = wPersn.born;
      Party.DeathDate   = wPersn.death;
      Party.BirthPlace  = wPersn.birsplase;
      Party.RegionBorn  = wPersn.regionborn;
      Party.RaionBorn   = wPersn.raionborn;
      Party.PlaceBorn   = wPersn.placeborn;
      //Party.PlaceWork   = wPersn.placework;

      Party.IsStateless = wPersn.isstateless;
      Party.IsIdentSimpl = wPersn.isidentsimpl;
      
    end;

    // проверить существование свойства PersonIDCollection в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "PersonIDCollection");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wPersonIDCollection = GenGetProp(PartyInfo, "PersonIDCollection");

      // работа с объектом MainPersonID

      var i = 0;

      var PersonPaper : RsbPersonPaper;

      if(wPersonIDCollection != NULL)

        PT_PrintDebug( "ws_getparty.mac.log", "wPersonIDCollection");

        while(i < wPersonIDCollection.size)

          PT_PrintDebug( "ws_getparty.mac.log", "******************************************************************");
          PT_PrintDebug( "ws_getparty.mac.log", "ismain          - "+ wPersonIDCollection[i].ismain);
          PT_PrintDebug( "ws_getparty.mac.log", "paperkind       - "+ wPersonIDCollection[i].paperkind);
          PT_PrintDebug( "ws_getparty.mac.log", "paperseries     - "+ wPersonIDCollection[i].paperseries);
          PT_PrintDebug( "ws_getparty.mac.log", "papernumber     - "+ wPersonIDCollection[i].papernumber);
          PT_PrintDebug( "ws_getparty.mac.log", "paperissueddate - "+ wPersonIDCollection[i].paperissueddate);
          PT_PrintDebug( "ws_getparty.mac.log", "paperissuer     - "+ wPersonIDCollection[i].paperissuer);
          PT_PrintDebug( "ws_getparty.mac.log", "paperissuercode - "+ wPersonIDCollection[i].paperissuercode);
          PT_PrintDebug( "ws_getparty.mac.log", "******************************************************************");

          PersonPaper = Party.PersonPaper(wPersonIDCollection[i].paperkind);

          if((wPersonIDCollection[i].action == PT_CREATE) OR (wPersonIDCollection[i].action == PT_MODIFY))

            PersonPaper.IsMain     = wPersonIDCollection[i].ismain;
            PersonPaper.IssuedDate = wPersonIDCollection[i].paperissueddate;
            PersonPaper.Issuer     = wPersonIDCollection[i].paperissuer;
            PersonPaper.IssuerCode = wPersonIDCollection[i].paperissuercode;
            PersonPaper.Number     = wPersonIDCollection[i].papernumber;
            // PersonPaper.PaperKind  = wPersonIDCollection[i].paperkind;
            PersonPaper.Series     = wPersonIDCollection[i].paperseries;

          end;

          if(wPersonIDCollection[i].action == PT_REMOVE)

            stat = PersonPaper.Delete();

            if(stat != true)
              break;
            end;

          end;

          if((wPersonIDCollection[i].action != PT_REMOVE) AND (SkipCheckPartyPapers != true))

          persnidcRecord.personid        = wPersonIDCollection[i].personid;
          persnidcRecord.paperkind       = wPersonIDCollection[i].paperkind;
          persnidcRecord.ismain          = wPersonIDCollection[i].ismain;
          persnidcRecord.paperissueddate = wPersonIDCollection[i].paperissueddate;
          persnidcRecord.paperissuer     = wPersonIDCollection[i].paperissuer;
          persnidcRecord.paperissuercode = wPersonIDCollection[i].paperissuercode;
          persnidcRecord.papernumber     = wPersonIDCollection[i].papernumber;
          persnidcRecord.paperseries     = wPersonIDCollection[i].paperseries;
          
          persnRecord.name1       = wPersn.name1;
          persnRecord.name2       = wPersn.name2;
          persnRecord.name3       = wPersn.name3;
          persnRecord.ismale      = wPersn.ismale;
          persnRecord.born        = wPersn.born;
          persnRecord.death       = wPersn.death;
	      persnRecord.CheckDate   = wPersn.CheckDate;
	      if(wPersn.CheckTime!= null )
		  
	        persnRecord.CheckTime   = wPersn.CheckTime;
			
          end;	  
	      persnRecord.MessageID   = wPersn.MessageID;
		  
          persnRecord.birsplase   = wPersn.birsplase;
          persnRecord.regionborn  = wPersn.regionborn;
          persnRecord.raionborn   = wPersn.raionborn;
          persnRecord.placeborn   = wPersn.placeborn;
          persnRecord.placework   = wPersn.placework;

          stat = PT_CheckPartyPapers(persnidcRecord, persnRecord);
          
          if(stat != true)
              break;
          end;

          end;

          i = i + 1;

        end;

      end;

    end;

	if(stat == true)
	
	  iprop = GenPropID(PartyInfo, "PtecuprIdchk");
	  
	  
      if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

        var wPtecuprIdchk = GenGetProp(PartyInfo, "PtecuprIdchk");

        // работа с объектом 

        if(wPtecuprIdchk != NULL)
		
		  var CheckECUPRID = Party.PartyCheckECUPRID();

		  CheckECUPRID.First();	 
		  
	      CheckECUPRID.MessageID = PartyInfo.PtecuprIdchk.MessageID;
	   
	     // CheckECUPRID.RecID  = PartyInfo.PtecuprIdchk.Id;
		
	      //CheckECUPRID.PersonID  = PartyInfo.PtecuprIdchk.PersonID;
	   
	      CheckECUPRID.Oper  = PartyInfo.PtecuprIdchk.Oper;
	   
	      CheckECUPRID.StatusCode = PartyInfo.PtecuprIdchk.StatusCode; 
	   
	      CheckECUPRID.ReturnCode = PartyInfo.PtecuprIdchk.ReturnCode; 
	   
	      CheckECUPRID.ReturnText = PartyInfo.PtecuprIdchk.ReturnText; 
	   
	      CheckECUPRID.ObjectID = PartyInfo.PtecuprIdchk.ObjectID; 

		  if(PartyInfo.PtecuprIdchk.CheckDate != null)
	   
	        CheckECUPRID.CheckDate = PartyInfo.PtecuprIdchk.CheckDate;			
		  
		  end;
	   
	      if(PartyInfo.PtecuprIdchk.CheckTime != null)
		
	        CheckECUPRID.CheckTime = PartyInfo.PtecuprIdchk.CheckTime; 
		  
		  end;
	  
	    end;
		
	  end;
	
	end;
	   
	if(stat == true)
	
      Party.CheckDate   = PartyInfo.Persn.CheckDate;
	  
	  if(wPersn.CheckTime!= null )
	  
	    Party.CheckTime   = PartyInfo.Persn.CheckTime;
		
	  end;	
	  
	  Party.MessageID   = PartyInfo.Persn.MessageID;
      
	  
    end;

  end;

  if(stat == true)

  // проверить существование свойства CodeValueCollection в объекте PartyInfo
  iprop = GenPropID(PartyInfo, "CodeValueCollection");

  if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

    var wCodeValueCollection = GenGetProp(PartyInfo, "CodeValueCollection");

    // работа с объектом CodeValueCollection

    i = 0;

    var isClosed = False;

    if(wCodeValueCollection != NULL)

      PT_PrintDebug( "ws_getparty.mac.log", "wCodeValueCollection");
      PT_PrintDebug( "ws_getparty.mac.log", "wCodeValueCollection.size - "+ wCodeValueCollection.size);

      while(i < wCodeValueCollection.size)

        if(wCodeValueCollection[i].action == PT_REMOVE)

          stat = Party.Code.DeleteCode(wCodeValueCollection[i].codekind);

          if(stat != true)
            break;
          end;

        else

          if(wCodeValueCollection[i].code != NULL)

            if(wCodeValueCollection[i].action == PT_MODIFY)

              if(wCodeValueCollection[i].bankclosedate != PT_ZERODATE)

                isClosed = True;

              end;

              stat = Party.Code.SetCode(wCodeValueCollection[i].codekind, wCodeValueCollection[i].code, wCodeValueCollection[i].bankdate, wCodeValueCollection[i].bankclosedate, isClosed );

            end;

            if(wCodeValueCollection[i].action == PT_CREATE)

              stat = Party.Code.SetCode(wCodeValueCollection[i].codekind, wCodeValueCollection[i].code, wCodeValueCollection[i].bankdate, wCodeValueCollection[i].bankclosedate );

            end;

            if(stat != true)
              break;
            end;

          end;

        end;

        i = i + 1;

      end;
    end;

  end;

  end;

  if(stat == true)

    // проверить существование свойства ObjrgdocCollection в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "ObjrgdocCollection");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wObjrgdocCollection = GenGetProp(PartyInfo, "ObjrgdocCollection");

      // работа с объектом ObjrgdocCollection

      i = 0;

      var PartyRegDoc : RsbPartyRegDoc;

      if(wObjrgdocCollection != NULL)

        PT_PrintDebug( "ws_getparty.mac.log", "wObjrgdocCollection");
        PT_PrintDebug( "ws_getparty.mac.log", "wObjrgdocCollection.size - "+ wObjrgdocCollection.size);

        while(i < wObjrgdocCollection.size)

          //PartyRegDoc = Party.PartyRegDoc(7, 14);

          PT_PrintDebug( "ws_getparty.mac.log", "******************************************************************");
          PT_PrintDebug( "ws_getparty.mac.log", "regpartykind - "+ wObjrgdocCollection[i].regpartykind);
          PT_PrintDebug( "ws_getparty.mac.log", "regdockind - "+ wObjrgdocCollection[i].regdockind);
          PT_PrintDebug( "ws_getparty.mac.log", "regpartyid - "+ wObjrgdocCollection[i].regpartyid);
          PT_PrintDebug( "ws_getparty.mac.log", "regplace - "+ wObjrgdocCollection[i].regplace);
          PT_PrintDebug( "ws_getparty.mac.log", "regpartyid - "+ wObjrgdocCollection[i].regpartyid);
          PT_PrintDebug( "ws_getparty.mac.log", "series - "+ wObjrgdocCollection[i].series);
          PT_PrintDebug( "ws_getparty.mac.log", "number - "+ wObjrgdocCollection[i].number);
          PT_PrintDebug( "ws_getparty.mac.log", "docdate - "+ wObjrgdocCollection[i].docdate);
          PT_PrintDebug( "ws_getparty.mac.log", "startdate - "+ wObjrgdocCollection[i].startdate);
          PT_PrintDebug( "ws_getparty.mac.log", "finishdate - "+ wObjrgdocCollection[i].finishdate);
          PT_PrintDebug( "ws_getparty.mac.log", "ismain - "+ wObjrgdocCollection[i].ismain);
          PT_PrintDebug( "ws_getparty.mac.log", "isclosed - "+ wObjrgdocCollection[i].isclosed);
          PT_PrintDebug( "ws_getparty.mac.log", "objectid - "+ wObjrgdocCollection[i].objectid);
          PT_PrintDebug( "ws_getparty.mac.log", "******************************************************************");

          PartyRegDoc = Party.PartyRegDoc(wObjrgdocCollection[i].regpartykind, wObjrgdocCollection[i].regdockind);

          if((wObjrgdocCollection[i].action == PT_CREATE) OR (wObjrgdocCollection[i].action == PT_MODIFY))

            PartyRegDoc.RegPartyID          = wObjrgdocCollection[i].regpartyid;
            PartyRegDoc.RegPlace            = wObjrgdocCollection[i].regplace;

            PartyRegDoc.RegPartyID          = wObjrgdocCollection[i].regpartyid;
            PartyRegDoc.Series              = wObjrgdocCollection[i].series;
            PartyRegDoc.Number              = wObjrgdocCollection[i].number;
            PartyRegDoc.DocDate             = wObjrgdocCollection[i].docdate;
            //PartyRegDoc.RegNumber           = wObjrgdocCollection[i].regpartyid;
            PartyRegDoc.StartDate           = wObjrgdocCollection[i].startdate;
            PartyRegDoc.FinishDate          = wObjrgdocCollection[i].finishdate;
            PartyRegDoc.IsMain              = wObjrgdocCollection[i].ismain;
            PartyRegDoc.IsClosed            = wObjrgdocCollection[i].isclosed;
            PartyRegDoc.BankDate            = {curdate};
            PartyRegDoc.UserID              = {oper};

          end;

          if(wObjrgdocCollection[i].action == PT_REMOVE)

            stat = PartyRegDoc.Delete();

            if(stat != true)
              break;
            end;

          end;

          i = i + 1;

        end;
      end;

    end;

    if(stat == true)

    // проверить существование свойства PartyOwnCollection в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "PartyOwnCollection");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wPartyOwnCollection = GenGetProp(PartyInfo, "PartyOwnCollection");

      // работа с объектом PartyOwnCollection

      i = 0;

      if(wPartyOwnCollection != NULL)

        PT_PrintDebug( "ws_getparty.mac.log", "wPartyOwnCollection");
        PT_PrintDebug( "ws_getparty.mac.log", "wPartyOwnCollection.size - "+ wPartyOwnCollection.size);

        while(i < wPartyOwnCollection.size)

          PT_PrintDebug( "ws_getparty.mac.log", "action" + wPartyOwnCollection[i].action);

          if(wPartyOwnCollection[i].action == PT_CREATE)

            PT_PrintDebug( "ws_getparty.mac.log", "PT_CREATE");

            if(Party.AddOwn(wPartyOwnCollection[i].partykind))
              stat = true;
            else
              stat = false;
              break;
            end;
          end;

          if(wPartyOwnCollection[i].action == PT_REMOVE)

            PT_PrintDebug( "ws_getparty.mac.log", "PT_REMOVE");

            stat = Party.DeleteOwn(wPartyOwnCollection[i].partykind);

            if(stat == false)
              break;
            end;

          end;

          i = i + 1;

        end;
      end;

    end;

  end;

  end;

  // if(stat == true)

    // var PartyKind = GetPartyKind(PartyInfo.ListKind);

    // if(PartyKind != 0)

      // if(Party.AddOwn(PartyKind) == 0)
        // stat = true;
      // else
        // stat = false;
      // end;

    // end;

  // end;

  PT_PrintDebug( "ws_getparty.mac.log", "после - PartyOwnCollection - " + string(stat));

  if(stat == true)

    // проверить существование свойства DateCreateForm в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "DateCreateForm");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wDateCreateForm = GenGetProp(PartyInfo, "DateCreateForm");

      PT_PrintDebug( "ws_getparty.mac.log", "wDateCreateForm - "+ string(wDateCreateForm));

      if(wDateCreateForm != date(0,0,0))

        DateSplit( wDateCreateForm, d, m, y );

        if ( ( d == 1 ) and ( m == 1 ) and ( y == 1 ) != true )

          // работа с объектом DateCreateForm

          if(Party.PartyNote.AddNote(1,  wDateCreateForm, {curdate}) == 0)  // Дата заполнения анкеты
            stat = true;
          else
            stat = false;
          end;

        end;

      end;

    end;

  end;

  if(stat == true)

    // проверить существование свойства StrgPeriodForm в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "StrgPeriodForm");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wStrgPeriodForm = GenGetProp(PartyInfo, "StrgPeriodForm");

      if(wStrgPeriodForm != date(0,0,0))

        DateSplit( wStrgPeriodForm, d, m, y );

        if ( ( d == 1 ) and ( m == 1 ) and ( y == 1 ) != true )

          // работа с объектом StrgPeriodForm

          if(Party.PartyNote.AddNote(2,  wStrgPeriodForm, {curdate}) == 0) // Срок хранения анкеты
            stat = true;
          else
            stat = false;
          end;

        end;

      end;

    end;

  end;

  if(stat == true)

    // проверить существование свойства DateModifyForm в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "DateModifyForm");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wDateModifyForm = GenGetProp(PartyInfo, "DateModifyForm");

      if(wDateModifyForm != date(0,0,0))

        DateSplit( wDateModifyForm, d, m, y );

        if ( ( d == 1 ) and ( m == 1 ) and ( y == 1 ) != true )

          // работа с объектом DateModifyForm

          if(Party.PartyNote.AddNote(45, wDateModifyForm, {curdate}) == 0) // Дата обновления анкеты
            stat = true;
          else
            stat = false;
          end;

        end;

      end;

    end;

  end;

  if(stat == true)

    // проверить существование свойства AdressCollection в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "AdressCollection");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wAdressCollection = GenGetProp(PartyInfo, "AdressCollection");

      // работа с объектом AdressCollection

      i = 0;

      if(wAdressCollection != NULL)

        PT_PrintDebug( "ws_getparty.mac.log", "wAdressCollection");
        PT_PrintDebug( "ws_getparty.mac.log", "wAdressCollection.size - "+ wAdressCollection.size);

        while(i < wAdressCollection.size)

          var Address = Party.Address(wAdressCollection[i].type);

          PT_PrintDebug( "ws_getparty.mac.log", "type-"+ wAdressCollection[i].type);

          if(wAdressCollection[i].action != PT_REMOVE)

            Address.Address         = wAdressCollection[i].adress;
            // Address.AddressType     = wAdressCollection[i].type;
            Address.CodeDistrict    = wAdressCollection[i].codedistrict;
            Address.CodePlace       = wAdressCollection[i].codeplace;
            Address.CodePlan        = wAdressCollection[i].codeplan;                                                                    
            Address.CodeProvince    = wAdressCollection[i].codeprovince;
            Address.CodeRegion      = wAdressCollection[i].coderegion;
            Address.CodeStreet      = wAdressCollection[i].codestreet;
            Address.Country         = wAdressCollection[i].country;
            Address.District        = IIF(wAdressCollection[i].district != NULL, wAdressCollection[i].district, "");
            Address.Flat            = wAdressCollection[i].flat;
            Address.House           = wAdressCollection[i].house;
            Address.Fias            = wAdressCollection[i].fias;
            Address.NumCorps        = wAdressCollection[i].numcorps;
            Address.Building        = wAdressCollection[i].building;
            Address.Okato           = wAdressCollection[i].okato;
            Address.Oktmo           = wAdressCollection[i].oktmo;
            Address.Place           = IIF(wAdressCollection[i].place != NULL, wAdressCollection[i].place, "");
            Address.Plan            = wAdressCollection[i].plan;
            Address.PostIndex       = wAdressCollection[i].postindex;
            Address.Province        = IIF(wAdressCollection[i].province != NULL, wAdressCollection[i].province, "");
            Address.Region          = IIF(wAdressCollection[i].region != NULL, wAdressCollection[i].region, "");
            Address.RegionNumber    = wAdressCollection[i].regionnum;
            Address.Street          = wAdressCollection[i].street;
            Address.Territory       = wAdressCollection[i].territory;

            // branch
            // numsession

          else

            stat = Address.Delete();

            if(stat != true)
              break;
            end;

          end;

          i = i + 1;

        end;
      end;

    end;

  end;

  if(stat == true)
    
    var err = 0;

    // проверить существование свойства ContactCollection в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "ContactCollection");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wContactCollection = GenGetProp(PartyInfo, "ContactCollection");

      // работа с объектом ContactCollection

      i = 0;

      if(wContactCollection != NULL)

        while(i < wContactCollection.size)

          var Contact = Party.PartyContact();
          
          var ContactType = 0;
          var AddressType = 0;
          
          if(wContactCollection[i].ContactType != null)
            ContactType = wContactCollection[i].ContactType.Type;
          end;
          
          if(wContactCollection[i].AddressType != null)
            AddressType = wContactCollection[i].AddressType.type;
          end;
                    
          if(wContactCollection[i].RecID > 0)

            err = Contact.GetByRecID(wContactCollection[i].RecID);
            
            if(err != 0)
              break;
            end;
            
            if(wContactCollection[i].action != PT_REMOVE)
              
              if(
                (Contact.ContactKind != wContactCollection[i].ContactKind.Kind) OR
                (Contact.AddressType != AddressType) OR
                (Contact.ContactType != ContactType)         
              )
              
                err = Contact.Delete();

                if(err != 0)
                  break;
                end;
                
                err = Contact.Add(
                  wContactCollection[i].ContactKind.Kind,
                  AddressType,
                  ContactType,
                  wContactCollection[i].ValueC
                );
                
                if(err != 0)
                  break;
                end;

              else
                            
                err = Contact.SetValue(wContactCollection[i].ValueC);
                
                if(err != 0)
                  break;
                end;
                
              end;
              
              err = Contact.SetIsMain(wContactCollection[i].IsMain);
                
              if(err != 0)
                break;
              end;
            
              if(wContactCollection[i].Provider != null)
                Contact.Provider = wContactCollection[i].Provider.name;
              end;
              Contact.Note     = wContactCollection[i].Note;

            else

              err = Contact.Delete();

              if(err != 0)
                break;
              end;

            end;
            
          else
            
            err = Contact.Add(
              wContactCollection[i].ContactKind.Kind,
              AddressType,
              ContactType,
              wContactCollection[i].ValueC
            );
            
            if(err != 0)
              break;
            end;

            err = Contact.SetIsMain(wContactCollection[i].IsMain);
              
            if(err != 0)
              break;
            end;
          
            if(wContactCollection[i].Provider != null)
              Contact.Provider = wContactCollection[i].Provider.name;
            end;
            
            Contact.Note     = wContactCollection[i].Note;            
            
          end;

          i = i + 1;

        end;
        
      end;

    end;
      
	   
	  
    if(err == 0)
      stat = true;
    else
      stat = false;
    end;    

  end;

  return stat;

end;


private macro CountFromPTDPSFPLAN(PartyId, Department, Servicekind)

  var res = false;

  var query =  " SELECT count(sf.t_partyid) count " +
               "  FROM DPTDPSFPLAN_DBT sf " +
               " WHERE     sf.t_partyid = ? " +
               "       AND sf.t_department = ? " +
               "       AND sf.t_servicekind = ? " +
               "       AND sf.t_sfplanid > 0 ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, PartyId );
  cmd.addParam( "", RSDBP_IN, Department );
  cmd.addParam( "", RSDBP_IN, Servicekind );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  if((ds.movenext) AND (ds.count > 0))

    res = true;

  end;

  return res;

end;

private macro CountFromPTSVDP(PartyID, PartyKind)

  var res = false;

  var query =  " SELECT count(t.t_partyid) count " +
               "  FROM DPTSVDP_DBT t " +
               " WHERE     t.t_partyid = ? " +
               "       AND t.t_partykind = ? ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, PartyID );
  cmd.addParam( "", RSDBP_IN, PartyKind );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  if((ds.movenext) AND (ds.count > 0))

    res = true;

  end;

  return res;

end;

private macro TrnDeletePTSVDP()

  file client (client) key 5 write;
  file partylst (partylst) key 0 write;
  file ptsvdp ("ptsvdp.dbt") key 0 write;
  file partyown (partyown) key 0 write;

  var stat = 0;

  if(stat == 0)

    var query =  " SELECT cl.T_SERVICEKIND, cl.T_BRANCH " +
                 "  FROM dclient_dbt cl " +
                 " WHERE     cl.t_partyid = ? " +
                 "       AND cl.t_department = ? " +
                 "       AND cl.t_branch != 0 ";

    var cmd = RSDCommand(query);

    cmd.addParam( "", RSDBP_IN, PARM_PartyId );
    cmd.addParam( "", RSDBP_IN, PARM_Department );

    cmd.NullConversion = true;

    cmd.Execute();

    var ds = TRsbDataSet( cmd );

    while(ds.movenext)

      client.partyid = PARM_PartyId;
      client.department = PARM_Department;
      client.servicekind = ds.SERVICEKIND;
      client.branch = ds.BRANCH;

      stat = GetEQ(client);

      if(stat == false)
        stat = 1;
        break;
      end;

      if(stat)

        stat = Delete(client);

        if(stat == false)
          stat = 1;
          break;
        else
          stat = 0;
        end;

      end;

    end;

  end;

  if(stat == 0)

    query =  " SELECT cl.T_SERVICEKIND " +
               "  FROM dclient_dbt cl " +
               " WHERE     cl.t_partyid = ? " +
               "       AND cl.t_department = ? " +
               "       AND cl.t_branch = 0 ";

    cmd = RSDCommand(query);

    cmd.addParam( "", RSDBP_IN, PARM_PartyId );
    cmd.addParam( "", RSDBP_IN, PARM_Department );

    cmd.NullConversion = true;

    cmd.Execute();

    ds = TRsbDataSet( cmd );

    while(ds.movenext)

      if(CountFromPTDPSFPLAN(PARM_PartyId, PARM_Department, ds.SERVICEKIND) == true)

        stat = PT_DeleteClientSfPlan( PARM_PartyId, PARM_Department, ds.SERVICEKIND );

        PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_DeleteClientSfPlan - "+ string(stat));

        if(stat != 0)
          AddErrorMessage(@PARM_ErrorMessage);
          break;
        end;

      else

        stat = PT_DeleteClientService(PARM_PartyId, ds.SERVICEKIND, PARM_Department);

        PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_DeleteClientService - "+ string(stat));

        if(stat != 0)
          AddErrorMessage(@PARM_ErrorMessage);
          break;
        end;

      end;

    end;

  end;

  var PartyKind;

  if(stat == 0)

    partylst.listkind = PARM_ListKind;

      stat = GetEQ(partylst);

      if(stat)

        PartyKind = partylst.partykind;

        stat = 0;

      else

        stat = 1;

      end;

  end;

  if(stat == 0)

    var sqlString = " DELETE FROM dptsvdp_dbt WHERE t_partyid = " + PARM_PartyId + " AND t_partykind = " + PartyKind + " AND t_department = " + PARM_Department;

    cmd = RsdCommand( sqlString );
    cmd.execute();

  end;

  if(stat == 0)

    if(CountFromPTSVDP(PARM_PartyId, PartyKind) == false)

      partyown.partyid = PARM_PartyId;
      partyown.partykind = PartyKind;

      stat = GetEQ(partyown);

      if(stat)

        stat = Delete(partyown);

        if(stat == false)
          stat = 1;
        else
          stat = 0;
        end;

      else

        stat = 1;

      end;

    end;

  end;

  if(stat != 0)
    AbortTrn();
  end;

OnError( err )
   AbortTrn();
end;

macro DeletePTSVDP(ListKind, PartyId, Department)

  var res = true;

  var stat = 0;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  PARM_PartyId = PartyId;
  PARM_Department = Department;
  PARM_ErrorMessage = ErrorMessage;
  PARM_ListKind = ListKind;

  var query =  " SELECT cl.T_SERVICEKIND " +
               "  FROM dclient_dbt cl " +
               " WHERE     cl.t_partyid = ? " +
               "       AND cl.t_department = ? " +
               "       AND cl.t_branch = 0 ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, PartyId );
  cmd.addParam( "", RSDBP_IN, Department );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  while(ds.movenext)

    stat = PT_CheckDeleteClientService(PartyId, ds.SERVICEKIND, Department);

    PT_PrintDebug( "ws_getparty.mac.log", "PT_CheckDeleteClientService - " + stat);

    if( stat != 0 )

      AddErrorMessage(@ErrorMessage);
      break;

    end;

  end;

  if(stat == 0)

    if( ProcessTrn(NULL,"TrnDeletePTSVDP") != true )
      stat = 1;
    end;

  end;

  if( stat == 0 )

    res = true;

  else

    res = false;

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro MakeFileName(ObjectID, Ext)

  var day, month, year;
  var hh, mm, ss;

  DateSplit (GetDBDate(), day, month, year);
  if (day < 10)
    day = String ("0"+day);
  else
    day = String (day);
  end;
  if (month < 10)
    month = String ("0"+month);
  else
    month = String (month);
  end;

  TimeSplit (GetDBTime, hh, mm, ss);
  if (hh < 10)
    hh = String ("0"+hh);
  else
    hh = String (hh);
  end;
  if (mm < 10)
    mm = String ("0"+mm);
  else
    mm = String (mm);
  end;
  if (ss < 10)
    ss = String ("0"+ss);
  else
    ss = String (ss);
  end;
  
  var res = string(ObjectID) + "-" + year + month + day + "-" + hh + mm + ss + "." + Ext;

  return res;
  
end;

private macro AfterSaveP(PartyInfo, PartyID)

  PT_PrintDebug( "ws_getparty.mac.log", "AfterSaveP");

  file partyname (partyname) key 0 write;
  file partykname (partykname) key 0;

  file ptsvdp (ptsvdp) key 0 write;
  file client (client) key 5 write;

  var stat = true;

  var PartyKind = GetPartyKind(PartyInfo.ListKind);

  // проверить существование свойства PartynameCollection в объекте PartyInfo
  var iprop = GenPropID(PartyInfo, "PartynameCollection");

  if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

    var wPartynameCollection = GenGetProp(PartyInfo, "PartynameCollection");
    
    var i = 0;
    
    if(wPartynameCollection != NULL)

      while(i < wPartynameCollection.size)
      
        if(wPartynameCollection[i].action == PT_CREATE)
        
          stat = PartyNameAddExt(PartyID, wPartynameCollection[i].nametypeid, wPartynameCollection[i].name);
          
          if(stat == false)
            break;
          end;

        end;
        
        if((wPartynameCollection[i].action == PT_MODIFY) OR (wPartynameCollection[i].action == PT_REMOVE))

          partyname.partynameid = wPartynameCollection[i].partynameid;

          stat = GetEQ(partyname);

          if(stat == false)
            break;
          end;

          if(stat)
          
            partykname.nametypeid = partyname.nametypeid;
            
            stat = GetEQ(partykname);

            if(stat == false)
              break;
            end;
            
            if(partykname.ismult == "X")
            
              if(wPartynameCollection[i].action == PT_MODIFY)
              
                partyname.freq = wPartynameCollection[i].freq;
                partyname.name = wPartynameCollection[i].name;
                partyname.nametypeid = wPartynameCollection[i].nametypeid;
                partyname.partyid = wPartynameCollection[i].partyid;
                
                if(stat)

                  stat = Update(partyname);

                  if(stat == false)
                    break;
                  end;          

                end;
              
              end;
              
              if(wPartynameCollection[i].action == PT_REMOVE)
              
                if(stat)

                  stat = Delete(partyname);

                  if(stat == false)
                    break;
                  end;          

                end;
                
              end;
            
            else
            
              stat = PartyNameAddExt(PartyID, wPartynameCollection[i].nametypeid, wPartynameCollection[i].name);
          
              if(stat == false)
                break;
              end;
            
            end;

          end;
          
        end;

        i = i + 1;

      end;

    end;      

  end;

  // проверить существование свойства PtsvdpCollection1 в объекте PartyInfo
  iprop = GenPropID(PartyInfo, "PtsvdpCollection1");

  if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

    var wPtsvdpCollection1 = GenGetProp(PartyInfo, "PtsvdpCollection1");

    // работа с объектом PtsvdpCollection1

    i = 0;

    // проверить существование свойства ClientCollection3 в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "ClientCollection3");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wClientCollection3 = GenGetProp(PartyInfo, "ClientCollection3");

      // работа с объектом ClientCollection3

      i = 0;

      if(wClientCollection3 != NULL)

        PT_PrintDebug( "ws_getparty.mac.log", "wClientCollection3.size - "+ wClientCollection3.size);

        while(i < wClientCollection3.size)

          if((wClientCollection3[i].action == PT_CREATE) or (wClientCollection3[i].action == PT_MODIFY))

            if((wClientCollection3[i].servicekind != 0) and (wClientCollection3[i].branch != 0))

              stat = PT_BindClientWithBranch(PartyID, wClientCollection3[i].servicekind, wClientCollection3[i].branch, wClientCollection3[i].oper, null, true);

              PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_BindClientWithBranch - "+ string(stat));

              if(stat == false)
                break;
              end;

            end;

          else

            if(wClientCollection3[i].action == PT_REMOVE)

              client.partyid = PartyID;
              client.department = wClientCollection3[i].department;
              client.servicekind = wClientCollection3[i].servicekind;
              client.branch = wClientCollection3[i].branch;

              stat = GetEQ(client);

              if(stat == false)
                break;
              end;

              if(stat)

                stat = Delete(client);

                if(stat == false)
                  break;
                end;

              end;

            end;

          end;

          i = i + 1;

        end;

      end;

    end;

  end;

  if(stat == true)

    // проверить существование свойства ClientCollection2 в объекте PartyInfo
    iprop = GenPropID(PartyInfo, "ClientCollection2");

    if(iprop != -1) // обращаемся к свойству, если оно существует в объекте

      var wClientCollection2 = GenGetProp(PartyInfo, "ClientCollection2");

      // работа с объектом ClientCollection2

      i = 0;

      if(wClientCollection2 != NULL)

        PT_PrintDebug( "ws_getparty.mac.log", "wClientCollection2.size - "+ wClientCollection2.size);

        while(i < wClientCollection2.size)

          if((wClientCollection2[i].action == PT_CREATE) or (wClientCollection2[i].action == PT_MODIFY))

            if( (stat == true) and (wClientCollection2[i].servicekind != 0) )

                stat = PT_BindClientWithBranch(PartyID,
                                               wClientCollection2[i].servicekind,
                                               wClientCollection2[i].department,
                                               {oper},
                                               null,
                                               false );

                PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_BindClientWithBranch - " + string(stat) );

                if(stat == false)
                  break;
                end;

              if( (stat == true) AND (wClientCollection2[i].sfplanid != 0) )

                if( PT_BindClientWithSfPlan( PartyID,
                                                wClientCollection2[i].department,
                                                wClientCollection2[i].sfplanid,
                                                wClientCollection2[i].servicekind,
                                                wClientCollection2[i].startdate,
                                             false ) == 0 )
                  stat = true;

                else

                  stat = false;
                  break;

                end;

                PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_BindClientWithSfPlan - "+ string(stat) );

              end;

            end;

            PT_PrintDebug( "ws_getparty.mac.log", "wClientCollection2[i].finishdate - "+ wClientCollection2[i].finishdate);

            if(wClientCollection2[i].finishdate != PT_ZERODATE)

              stat = PT_CloseClientService(PartyID, wClientCollection2[i].servicekind, wClientCollection2[i].finishdate, true, wClientCollection2[i].department);

              PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_CloseClientService - " + string(stat) );

            end;

          end;

          if(wClientCollection2[i].action == PT_REMOVE)

            if(wClientCollection2[i].servicekind != 0)

              if(wClientCollection2[i].sfplanid != 0)

                stat = PT_DeleteClientSfPlan( PartyID, wClientCollection2[i].department, wClientCollection2[i].servicekind );

                if( stat == 0)
                  stat = true;
                else
                  stat = false;
                end;

                PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_DeleteClientSfPlan - "+ string(stat));

                if(stat == false)
                  break;
                end;

              else

                stat = PT_DeleteClientService(PartyID, wClientCollection2[i].servicekind, wClientCollection2[i].department);

                if( stat == 0)
                  stat = true;
                else
                  stat = false;
                end;

                PT_PrintDebug( "ws_getparty.mac.log", "stat = PT_DeleteClientService - "+ string(stat));

                if(stat == false)
                  break;
                end;

              end;

            end;

          end;

          i = i + 1;

        end;

      end;

    end;

  end;

  if(stat == true)

    if(wPtsvdpCollection1 != NULL)

      PT_PrintDebug( "ws_getparty.mac.log", "wPtsvdpCollection1.size - "+ wPtsvdpCollection1.size);

      while(i < wPtsvdpCollection1.size)

        if(wPtsvdpCollection1[i].action == PT_REMOVE)

          DeletePTSVDP(PartyInfo.ListKind, PartyID, wPtsvdpCollection1[i].department);

        end;

        i = i + 1;

      end;

    end;

  end;

  if((stat == true) AND (PartyInfo.Foto != null) AND (PartyInfo.Foto.ImageID > 0)
      AND (PartyInfo.Foto.HexData == null))
    
    stat = CloseImageExt(PartyInfo.Foto.ImageID);
    
  end;
  
  if((stat == true) AND (PartyInfo.Sign != null) AND (PartyInfo.Sign.ImageID > 0)
      AND (PartyInfo.Sign.HexData == null))
    
    stat = CloseImageExt(PartyInfo.Sign.ImageID);
    
  end;

  if(stat == true)
    
    if((PartyInfo.Foto != null) AND (PartyInfo.Foto.HexData != NULL) AND
       (PartyInfo.Foto.HexData != saveFotoHex))
  
    var RecParty = GetRecPartyByID(PartyID);

    var ObjectIDStr = UniID(RecParty, 3 /*ObjectType*/);

    var FileNameStr = "";

      if(PartyInfo.Foto.FileName == null)
    
        FileNameStr = MakeFileName(PartyID, PartyInfo.Foto.FileExt);
      
    else
    
        FileNameStr = PartyInfo.Foto.FileName;
      
    end;    
  
    stat = WEB_SaveImage(3 /*ObjectType*/, ObjectIDStr, 2 /* Foto */, PartyInfo.Foto.HexData, PartyInfo.Foto.PreviewData, FileNameStr, PartyInfo.Foto.ImgChunkID);

  end;
  
  end;
  
  if(stat == true)

    if((PartyInfo.Sign != null) AND (PartyInfo.Sign.HexData != NULL) AND
       (PartyInfo.Sign.HexData != saveSignHex))
  
    RecParty = GetRecPartyByID(PartyID);

    ObjectIDStr = UniID(RecParty, 3 /*ObjectType*/);

    FileNameStr = "";

      if(PartyInfo.Sign.FileName == null)
    
        FileNameStr = MakeFileName(PartyID, PartyInfo.Sign.FileExt);
      
    else
    
        FileNameStr = PartyInfo.Sign.FileName;
      
    end;    
  
      stat = WEB_SaveImage(3 /*ObjectType*/, ObjectIDStr, 1 /* Sign */, PartyInfo.Sign.HexData, PartyInfo.Sign.PreviewData, FileNameStr, PartyInfo.Sign.ImgChunkID);
    
    end;

  end;

  if(stat == true)

    if(PartyInfo.SuperiorSetID > 0)

      var SParty = RsbParty(PartyInfo.SuperiorSetID);

      SParty.SuperiorID = PartyID;

      stat = SParty.UpDate();

    end;

  end;

  return stat;

end;

macro InsertParty(PartyInfo)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var PartyID = 0;

  PT_PrintDebug( "ws_getparty.mac.log", "InsertParty");

  var res = True;
  var stat;

  var Party = RsbParty();

  res = SaveP(PartyInfo, @Party, false);

  PT_PrintDebug( "ws_getparty.mac.log", "SaveP(PartyInfo, @Party)" + string(res));

  if(res == True)
    res = Party.Update(True);
  end;

  PT_PrintDebug( "ws_getparty.mac.log", "Party.Update(True)" + string(res));

  if((res == True) AND (PartyInfo.Party.mainpartyid != 0))
    
    var PartyOrig = RsbParty(PartyInfo.Party.mainpartyid);
    
    PartyOrig.IsHasDoubler = "X";
    
    res = PartyOrig.Update();
    
    PartyOrig = null;
    
  end; 

  if(res == True)

    PartyID = Party.PartyID;

    var Code = Party.Code.GetCode(1);

    PT_PrintDebug( "ws_getparty.mac.log", "Party.Code.GetCode(1)" + string(Code));

    Party = NULL;

    if(Code == "")

      stat = GetCodeByParty(PartyID, @Code);

      PT_PrintDebug( "ws_getparty.mac.log", "GetCodeByParty(PartyID, @Code) = " + string(Code));

      if(stat == 0)

        Party = RsbParty(PartyID);

        res = Party.Code.SetCode(1, Code);

        if(res == true)

          PT_PrintDebug( "ws_getparty.mac.log", "res = Party.Update(True);");

          res = Party.Update(True);

          PT_PrintDebug( "ws_getparty.mac.log", "res = " + string(res));

        end;

      else

        res = false;

      end;

    end;

    Party = NULL;

  end;

  if(res == True)
    res = AfterSaveP(PartyInfo, PartyID);
  end;

  if(res != True)

    PartyID = -PartyID;

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(PartyID);

  return responseBuilder.Result;

end;

macro UpdateParty(PartyInfo, PartyId)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  PT_PrintDebug( "ws_getparty.mac.log", "UpdateParty");

  var res = True;

  var Party = RsbParty(PartyId);

  var SaveMainPartyID = 0;
  
  if((PartyInfo.Party.mainpartyid == 0) AND (Party.MainPartyID != 0))
    
    SaveMainPartyID = Party.MainPartyID;
    
  end;

  PT_PrintDebug( "ws_getparty.mac.log", "UpdateParty - SaveP");

  res = SaveP(PartyInfo, @Party, false);

  if(res == True)

    PT_PrintDebug( "ws_getparty.mac.log", "UpdateParty - Party.Update");

    res = Party.Update(True);

    PT_PrintDebug( "ws_getparty.mac.log", "UpdateParty - Party.Update - " + string(res) );

  end;

  if((res == True) AND (SaveMainPartyID != 0))

    res = CheckHasDoubler(SaveMainPartyID);

  end;
  
  if((res == True) AND (PartyInfo.Party.mainpartyid != 0))
    
    var PartyOrig = RsbParty(PartyInfo.Party.mainpartyid);
    
    PartyOrig.IsHasDoubler = "X";
    
    res = PartyOrig.Update();
    
    PartyOrig = null;
    
  end;  

  if(res == True)

    PT_PrintDebug( "ws_getparty.mac.log", "AfterSaveP(PartyInfo, PartyID)");

    Party = NULL;

    res = AfterSaveP(PartyInfo, PartyID);

  end;

  if(res != True)
    AddErrorMessage(@ErrorMessage);
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro TrnDeletePartyList()

  PT_PrintDebug( "ws_getparty.mac.log", "TrnDeletePartyList");

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var i = 0;

  if(ParmPartyIdList != NULL)

    while(i < ParmPartyIdList.size)

      PT_PrintDebug( "ws_getparty.mac.log", "ParmPartyIdList[i] " + ParmPartyIdList[i]);

      var Party = RsbParty(ParmPartyIdList[i]);

      PT_PrintDebug( "ws_getparty.mac.log", "var Party = RsbParty(ParmPartyIdList[i]);");

      var res = Party.Delete(true);

      PT_PrintDebug( "ws_getparty.mac.log", "Party.Delete(true); " + string(res));

      if(res != True)

        AddErrorMessage(@ErrorMessage);

      end;

      i = i + 1;

    end;

    PT_PrintDebug( "ws_getparty.mac.log", "ResponseBuilder.Result().ErrorMessages.size " + ResponseBuilder.Result().ErrorMessages.size);

    if(ResponseBuilder.Result().ErrorMessages.size != 0)

      AbortTrn();

    end;

  end;

end;

macro DeleteParty(PartyIDs)

  PT_PrintDebug( "ws_getparty.mac.log", "DeleteParty - " + PartyIDs[0]);

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  ParmPartyIdList = PartyIDs;

  if( ProcessTrn(NULL,"TrnDeletePartyList") != true )
    res = false;
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro TrnLockPartyList()

  PT_PrintDebug( "ws_getparty.mac.log", "TrnLockPartyList");

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var i = 0;

  if(ParmPartyIdList != NULL)

    while(i < ParmPartyIdList.size)

      PT_PrintDebug( "ws_getparty.mac.log", "ParmPartyIdList[i] " + ParmPartyIdList[i]);

      var Party = RsbParty(ParmPartyIdList[i]);

      PT_PrintDebug( "ws_getparty.mac.log", "var Party = RsbParty(ParmPartyIdList[i]);");

      var res = Party.Lock(false);

      PT_PrintDebug( "ws_getparty.mac.log", "Party.Lock(); " + string(res));

      if(res != True)

        AddErrorMessage(@ErrorMessage);

      end;

      i = i + 1;

    end;

    PT_PrintDebug( "ws_getparty.mac.log", "ResponseBuilder.Result().ErrorMessages.size " + ResponseBuilder.Result().ErrorMessages.size);

    if(ResponseBuilder.Result().ErrorMessages.size != 0)

      AbortTrn();

    end;

  end;

end;

macro LockParty(PartyIDs)

  PT_PrintDebug( "ws_getparty.mac.log", "LockParty - " + PartyIDs[0]);

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  ParmPartyIdList = PartyIDs;

  if( ProcessTrn(NULL,"TrnLockPartyList") != true )
    res = false;
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro UnLockParty(PartyID)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var Party = RsbParty(PartyID);

  var res = Party.UnLock(true);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

// ******************************* ContactsTabWidget ********************************

macro GetAdmTerrList()

  var cmd, rs;

  var Rec = TRecHandler("admterr");
  var Arr = TArray;

  var query = "select * from dadmterr_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("admterr");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

/* ***** FIAS ***** */
//
// null - параметр пропускается, когда регион не указан
// ""   - параметр меняется на эквивалент ('00'/'000'/chr(1))
private class TFiasCollectionRetriever
  
  var params = TArray;           
  var query = "";
  
  
  private macro GetFias(query, params:TArray)

    PT_PrintDebug( "ws_getparty.mac.log", "query="+ query);

    var cmd, rs;

    var Obj = TFias;
    var Arr = TArray;

    rs = execSQLSelect(query, params);

    while(rs.movenext)

      _CopyRecordsetToClassObj(rs, Obj);

      var o = TFias;

      o.FormalName  = Obj.FormalName;
      o.RegionCode  = Obj.RegionCode;
      o.AreaCode    = Obj.AreaCode;
      o.CityCode    = Obj.CityCode;
      o.PlaceCode   = Obj.PlaceCode;
      o.PlanCode    = Obj.PlanCode;
      o.StreetCode  = Obj.StreetCode;
      o.PostalCode  = Obj.PostalCode;
      o.IFNSFL      = Obj.IFNSFL;
      o.OKATO       = Obj.OKATO;
      o.OKTMO       = Obj.OKTMO;
      o.ShortName   = Obj.ShortName;

      Arr[Arr.size] = o;

    end;

    return Arr;
  end;
  
 
  private macro AddParamOrReplace(toChr : bool, fieldname : string, p : string)

    if(p == null) return; end;
 
    query = query + " AND t." + fieldname +" = ? ";
    params[params.size] = SQLParam("", IIF(toChr, " chr(1) ", p));
    
  end;
  
  macro GetCollection(lvl       : string,
                      status     : string,                          
                      shortname  : string,
                      regionCode : string,
                      areaCode   : string,                          
                      cityCode   : string,
                      placeCode  : string,
                      planCode   : string) : TArray
    


    var regIsNull =   (regionCode == null) or  (regionCode == "");
    
    var allNull   =     (regionCode == null) 
                    and (areaCode  == null) 
                    and (cityCode  == null) 
                    and (placeCode == null) 
                    and (planCode  == null);
    
    params = TArray;           
    query = "  SELECT t.*  " + 
            "    FROM das_addrobj_dbt t  " +                
            "   WHERE     1=1 ";
            
    AddParamOrReplace(false, "t_aolevel", lvl);
                
    AddParamOrReplace(regIsNull, "t_plancode",  IIF(planCode  == "", " 0000 ",  planCode));
    AddParamOrReplace(regIsNull, "t_placecode", IIF(placeCode == "", " 000 ",   placeCode));
    AddParamOrReplace(regIsNull, "t_citycode",  IIF(cityCode  == "", " 000 ",   cityCode));
    AddParamOrReplace(regIsNull, "t_areacode",  IIF(areaCode  == "", " 000 ",   areaCode));
    
    if(not allNull)
      AddParamOrReplace(regIsNull, "t_regioncode",IIF(regIsNull,       "",        regionCode));
    end;
    
    AddParamOrReplace(false, "t_shortname",  IIF(shortname  == "", null,   shortname));
    
    AddParamOrReplace(false, "t_nextid", status);
    
    query =  query + 
                "  ORDER BY t.t_regioncode,  " + 
                "         t.t_areacode,   " + 
                "         t.t_citycode,   " + 
                "         t.t_placecode,  " + 
                "         t.t_plancode,   " + 
                "         t.t_streetcode; "; 
    
    return GetFias(query, params);
    
  end;
  
  private macro GetFiasHouses(query:string, params:TArray)
    PT_PrintDebug( "ws_getparty.mac.log", "query="+ query);

    var cmd, rs;

    var Obj = TFiasHouse;
    var Arr = TArray;

    rs = execSQLSelect(query, params);

    while(rs.movenext)

      _CopyRecordsetToClassObj(rs, Obj);

      var o = TFiasHouse;

      o.postalCode  = Obj.postalCode;
      o.IFNSFL      = Obj.IFNSFL;
      o.OKATO       = Obj.OKATO;
      o.OKTMO       = Obj.OKTMO;
      o.UpdateDate  = Obj.UpdateDate;
      o.HouseNum    = Obj.HouseNum;
      o.BuildNum    = Obj.BuildNum;
      o.StrucNum    = Obj.StrucNum;
      o.Counter     = Obj.Counter;

      Arr[Arr.size] = o;

    end;

    return Arr;
  end;
   
  macro GetHouses(regionCode : string,
                  areaCode   : string,                          
                  cityCode   : string,
                  placeCode  : string,
                  planCode   : string,                          
                  streetcode  : string) : TArray
    
    params = TArray;
    query = "  SELECT t.*  " + 
            "    FROM das_house_dbt t  " + 
            "   WHERE     t.t_aoguid IN  " + 
            "                (SELECT as_addrobj.t_aoguid  " + 
            "                   FROM das_addrobj_dbt as_addrobj  " + 
            "                  WHERE     as_addrobj.t_streetcode  = ?  " + 
            "                        AND as_addrobj.t_plancode    = ?  " + 
            "                        AND as_addrobj.t_placecode   = ?  " + 
            "                        AND as_addrobj.t_citycode    = ?  " + 
            "                        AND as_addrobj.t_areacode    = ?  " + 
            "                        AND as_addrobj.t_regioncode  = ?  " + 
            "                        AND as_addrobj.t_nextid      = ?) " + 
            "         AND t.t_enddate > ?  " + 
            " ORDER BY t.t_housenum, t.t_buildnum, t.t_strucnum;  " ;
            
    params[params.size] = SQLParam("", streetCode);
    params[params.size] = SQLParam("", planCode);
    params[params.size] = SQLParam("", placeCode);
    params[params.size] = SQLParam("", cityCode);
    params[params.size] = SQLParam("", areaCode);
    params[params.size] = SQLParam("", regionCode);
    params[params.size] = SQLParam("", "");
    params[params.size] = SQLParam("", Date());
    
    return GetFiasHouses(query, params);
  end;                  
   
end; // class

// регион
macro GetFiasRegionList(shortname)

  var r = TFiasCollectionRetriever();
  return r.GetCollection(1, "", shortname);

end;

// район
macro GetFiasProvinceList( shortname, regionCode)

  var r = TFiasCollectionRetriever();
  return r.GetCollection(3, "", shortname, regionCode);
  
end;

// Город
macro GetFiasDistrictList( shortname, regionCode, AreaCode)

  var r = TFiasCollectionRetriever();
  return r.GetCollection(4, "", shortname, regionCode, AreaCode);

end;

// Нас.пункт:
macro GetFiasPlaceList( shortname, regionCode, AreaCode, CityCode)

  var r = TFiasCollectionRetriever();
  return r.GetCollection(6, "", shortname, regionCode, AreaCode, CityCode);

end;

// План. стр-ра:  Планировочная структура
macro GetFiasPlanList( shortname, regionCode, AreaCode, CityCode, PlaceCode)


  var r = TFiasCollectionRetriever();
  return r.GetCollection(65, "", shortname, regionCode, AreaCode, CityCode, PlaceCode);

end;


// Улица
macro GetFiasStreetList( shortname, regionCode, AreaCode, CityCode, PlaceCode, PlanCode)
  var r = TFiasCollectionRetriever();
  return r.GetCollection(7, "", shortname, regionCode, AreaCode, CityCode, PlaceCode, PlanCode);

end;

//Дом
macro GetFiasHouseList( regionCode, AreaCode, CityCode, PlaceCode, PlanCode, streetCode)

  var r = TFiasCollectionRetriever();
  return r.GetHouses(regionCode, AreaCode, CityCode, PlaceCode, PlanCode, streetCode);
end;

/* ***** end FIAS ***** */

macro GetRaionList()

  var cmd, rs;

  var Rec = TRecHandler("raion");
  var Arr = TArray;

  var query = "select * from draion_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("raion");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetTownList()

  var cmd, rs;

  var Rec = TRecHandler("town");
  var Arr = TArray;

  var query = "select * from dtown_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("town");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetOkatoList()

  var cmd, rs;

  var Rec = TRecHandler("objattr");
  var Arr = TArray;

  // var query = "          SELECT t_objecttype, " +
              // "                 t_groupid, " +
              // "                 t_attrid, " +
              // "                 t_parentid, " +
              // "                 t_codelist, " +
              // "                 t_numinlist, " +
              // "                 t_nameobject, " +
              // "                 t_chattr, " +
              // "                 t_longattr, " +
              // "                 t_intattr, " +
              // "                 t_name, " +
              // "                 t_fullname, " +
              // "                 t_opendate, " +
              // "                 t_closedate, " +
              // "                 t_classificator, " +
              // "                 t_corractype, " +
              // "                 t_balance, " +
              // "                 t_isobject, " +
              // "                 LEVEL " +
              // "          FROM dobjattr_dbt t " +
              // "                  START WITH (t.t_parentid = 0 AND t.t_objecttype = 3 AND t.t_groupid = 12) " +
              // "                  CONNECT BY     PRIOR t.t_objecttype = t.t_objecttype " +
              // "                             AND PRIOR t.t_groupid = t.t_groupid " +
              // "                             AND PRIOR t.t_attrid = t.t_parentid " +
              // "           ORDER SIBLINGS BY t.t_codelist, LPAD (t.t_numinlist, 35, '0')";

  var query = "          SELECT t_objecttype, " +
              "                 t_groupid, " +
              "                 t_attrid, " +
              "                 t_parentid, " +
              "                 t_codelist, " +
              "                 t_numinlist, " +
              "                 t_nameobject, " +
              "                 t_chattr, " +
              "                 t_longattr, " +
              "                 t_intattr, " +
              "                 t_name, " +
              "                 t_fullname, " +
              "                 t_opendate, " +
              "                 t_closedate, " +
              "                 t_classificator, " +
              "                 t_corractype, " +
              "                 t_balance, " +
              "                 t_isobject " +
              "          FROM dobjattr_dbt t " +
              "          WHERE t.t_parentid = 0 AND t.t_objecttype = 3 AND t.t_groupid = 12";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("objattr");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetContactTypeList()

  var cmd, rs;

  var Arr = TArray;

  var query = "select * from dcontacttype_dbt";
  
  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var p = TWsContactType;
    
    p.Type = SQL_ConvType(rs.value("T_Type"));
    p.Kind = SQL_ConvType(rs.value("T_Kind"));
    p.Name = SQL_ConvType(rs.value("T_Name"));

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

macro GetContactKindList()

  var cmd, rs;

  var Arr = TArray;

  var query = "select * from dcontactkind_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var p = TWsContactKind;
    
    p.Kind        = SQL_ConvType(rs.value("T_Kind"));
    p.Name        = SQL_ConvType(rs.value("T_Name"));
    p.Description = SQL_ConvType(rs.value("T_Description"));
    p.RegexMatch  = SQL_ConvType(rs.value("T_RegexMatch"));

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

macro GetMobPrvdrList()

  var cmd, rs;

  var Rec = TRecHandler("mobprvdr");
  var Arr = TArray;

  var query = "select * from dmobprvdr_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("mobprvdr");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetAdrtypeList(LagalForm)

  var cmd, rs;

  var Rec = TRecHandler("adrtype");
  var Arr = TArray;

  var query = "select * from dadrtype_dbt";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("adrtype");
    copy(p, Rec);

    if(LagalForm == 2)
      if(p.rec.name == "Юридический")
        p.rec.name = "Место жительства";
      else
        if(p.rec.name == "Фактический")
          p.rec.name = "Место пребывания";
        end;
      end;
    end;

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro GetContactsInfo(LagalForm)

  var p = ContactsInfo();

  var result;
  var error = 0;

  GetRegistryValue( "CB\\PARTY\\КЛАДР\\КЛАДР", V_BOOL, result, error );

  if(error == 0)
    p.IsKladrEnabled = result;
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  p.AdrType = TWsAdrType();

  var Rec = TRecHandler("adress");
  p.AdrType.adress = Rec.rec;
  p.AdrType.adress.territory = "00";

  GetRegistryValue( "COMMON\\ПЕРЕМЕННЫЕ\\СТРАНА РЕЗИДЕНТНОСТИ", V_STRING, result, error );

  if(error == 0)
    p.AdrType.adress.country = result;
    p.Country                = GetCountryByCodeLat3(result);
  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  p.AdrTypeCollection = GetAdrtypeList(LagalForm);

  p.AdmTerrCollection  = GetAdmTerrList();

  p.PtRegionCollection = TArray;
  p.RaionCollection = TArray;
  p.TownCollection = TArray;
  p.KlardRegionCollection = TArray;

  if(p.IsKladrEnabled == false)
    p.PtRegionCollection = GetPtregionList();
    p.RaionCollection = GetRaionList();
    p.TownCollection = GetTownList();
  else
    p.KlardRegionCollection = GetFiasRegionList(null);
  end;

  p.OkatoCollection = GetOkatoList();
  
  p.ContactTypeCollection = GetContactTypeList();
  p.ContactKindCollection = GetContactKindList();
  p.MobPrvdrCollection = GetMobPrvdrList();

  return p;

end;

private macro CopyAdress(obj1, obj2)

  obj1.partyid         = obj2.partyid;
  obj1.type            = obj2.type;
  obj1.adress          = obj2.adress;
  obj1.country         = obj2.country;
  obj1.postindex       = obj2.postindex;
  obj1.region          = obj2.region;
  obj1.codeprovince    = obj2.codeprovince;
  obj1.province        = obj2.province;
  obj1.codedistrict    = obj2.codedistrict;
  obj1.district        = obj2.district;
  obj1.codeplace       = obj2.codeplace;
  obj1.codeplan        = obj2.codeplan;
  obj1.place           = obj2.place;
  obj1.plan            = obj2.plan;
  obj1.codestreet      = obj2.codestreet;
  obj1.street          = obj2.street;
  obj1.house           = obj2.house;
  obj1.numcorps        = obj2.numcorps;
  obj1.building        = obj2.building;
  obj1.flat            = obj2.flat;
  obj1.territory       = obj2.territory;
  obj1.branch          = obj2.branch;
  obj1.numsession      = obj2.numsession;
  obj1.fias            = obj2.fias;
  obj1.coderegion      = obj2.coderegion;
  obj1.okato           = obj2.okato;
  obj1.oktmo           = obj2.oktmo;
  obj1.regionnum       = obj2.regionnum;

  return obj1;

end;

macro FormAdress_NComma(Adress)

  record adr(adress);

  CopyAdress(adr, Adress);


  var status_ = GetAddressUser( null, null, adr, true );

  Adress.adress = adr.adress;

  return Adress;

end;

macro FormAdress_User(Adress)


  record adr(adress);

  CopyAdress(adr, Adress);


  var  status_ = GetAddress( null, null, adr, true );

  Adress.adress = adr.adress;

  return Adress;

end;

macro FormAdress_Kladr2Adress(Adress)

  record adr(adress);

  CopyAdress(adr, Adress);

  var status_ = -100;

  if( formingKLADRQuietRec( adr, 1, 0, @status_ ) == 0 )
    CopyAdress(Adress, adr);
  else
    PT_PrintDebug( "ws_getparty.mac.log", "FormAdress_Kladr2Adress status_"+ status_);
  end;

  return Adress;

end;

macro FormAdress_Adress2Kladr(Adress)


  record adr(adress);

  CopyAdress(adr, Adress);

  var status_ = -100;

  if( formingKLADRQuietRec( adr, 0, 0, @status_ ) == 0 )
    Adress.fias  = adr.fias;
    Adress.okato = adr.okato;
    Adress.oktmo = adr.oktmo;
  else
    PT_PrintDebug( "ws_getparty.mac.log", "FormAdress_Adress2Kladr status_"+ status_);
  end;

  return Adress;

end;

macro CheckObjCode
(
  objecttype,
  objectid,
  codekind,
  code
)

  PT_PrintDebug( "ws_getparty.mac.log", "CB_CheckObjCode" );

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = CB_CheckObjCode(objecttype, objectid, codekind, code, 1);

  PT_PrintDebug( "ws_getparty.mac.log", "CB_CheckObjCode - " + stat);

  if( stat != 0 )

    AddErrorMessage(@ErrorMessage);

  end;

  if( stat == 0 )

    res = true;

  else

    res = false;

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro CheckObjCodeBeforeSave
(
  objcode
)
  var res = true;

  var Party = RsbParty(objcode.objectid);

  PT_PrintDebug( "ws_getparty.mac.log", "CheckObjCodeBeforeSave" );

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var th_objcode = TRecHandler("objcode");

  th_objcode.rec.objecttype     = objcode.objecttype;
  th_objcode.rec.codekind       = objcode.codekind;
  th_objcode.rec.objectid       = objcode.objectid;
  th_objcode.rec.code           = objcode.code;
  th_objcode.rec.state          = objcode.state;
  th_objcode.rec.bankdate       = objcode.bankdate;
  th_objcode.rec.sysdate        = objcode.sysdate;
  th_objcode.rec.systime        = objcode.systime;
  th_objcode.rec.userid         = objcode.userid;
  th_objcode.rec.branch         = objcode.branch;
  th_objcode.rec.numsession     = objcode.numsession;
  th_objcode.rec.unique         = objcode.unique;
  th_objcode.rec.autokey        = objcode.autokey;
  th_objcode.rec.bankclosedate  = objcode.bankclosedate;

  var stat = Party.Code.CheckCode(th_objcode);

  PT_PrintDebug( "ws_getparty.mac.log", "CheckObjCodeBeforeSave - " + stat);

  if( stat != 0 )

    AddErrorMessage(@ErrorMessage);

  end;

  if( stat == 0 )

    res = true;

  else

    res = false;

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro IsChangeCodeValue(codevalue1, codevalue2):bool
   var RetVal = true;

   if( (codevalue1.codekind      == codevalue2.codekind      ) AND
       (codevalue1.code          == codevalue2.code          ) AND
       (codevalue1.bankdate      == codevalue2.bankdate      ) AND
       (codevalue1.bankclosedate == codevalue2.bankclosedate ) )
     RetVal = false;
   end;

   return  RetVal;
end;

private macro SetCodeValue(codevalue, code_value)

  codevalue.objecttype    = ParmObjectType;
  codevalue.codekind      = code_value.codekind;
  codevalue.objectid      = ParmObjectID;
  codevalue.code          = code_value.code;
  codevalue.state         = IIF(code_value.bankclosedate != PT_ZERODATE, 1, 0);
  codevalue.bankdate      = code_value.bankdate;
  // codevalue.sysdate       =
  // codevalue.systime       =
  codevalue.userid        = {oper};
  // codevalue.branch        =
  // codevalue.numsession    =
  // codevalue.unique        =
  // codevalue.autokey       =
  codevalue.bankclosedate = code_value.bankclosedate;

end;

private macro TrnSaveCodeValueList()

  var codevalue    = Tbfile ("objcode", "W", 4);
  var codevalueOld = Tbfile ("objcode", "W", 4);

  codevalue.Clear();
  codevalueOld.Clear();

  VAR CodeValueList = ParmCodeValueList; // Виды ФИ
  var retval = true;

  var size = CodeValueList.size();
  var i = 0;
  var code_value;

  gStat = 0; gMessage = "";

  // Удаляем старые записи
  i = 0;
  while((i < size) AND (gStat == 0))
    code_value = CodeValueList(i);

    if(code_value.action == PT_REMOVE)
      var query = "DELETE FROM DOBJCODE_DBT WHERE T_autokey = " + code_value.autokey;
      ExecSQL(query);
    end;

    i = i +1;
  end;

  // Редактируем старые записи
  i = 0;
  while((i < size) AND (gStat == 0))
    code_value = CodeValueList(i);

    if(code_value.action == PT_MODIFY)
      codevalueOld.Clear();

      if(code_value.autokey != 0)
        codevalueOld.rec.autokey = code_value.autokey;
        if(not codevalueOld.GetEQ())
          gStat = 70;
          gMessage = "Конфликт. Документ изменен другим операционистом";
        end;
      end;

      if(gStat == 0)
        Copy(codevalue, codevalueOld);

        if(not codevalue.GetEQ())
          gStat = 70;
          gMessage = "Конфликт. Документ изменен другим операционистом";
        end;
      end;

      if(gStat == 0)
        SetCodeValue(codevalue.rec, code_value);

        if(IsChangeCodeValue(codevalue.rec, codevalueOld.rec))
          if(not codevalue.update())
            gStat = 1;
            gMessage = "Ошибка обновления записи таблицы dobjcode_dbt";
          end;
        end;
      end;
    end;

    i = i +1;
  end;

  // Вставляем новые
  i = 0;
  while((i < size) AND (gStat == 0))
    code_value = CodeValueList(i);

    if(code_value.action == PT_CREATE)

      codevalue.Clear();

      SetCodeValue(codevalue.rec, code_value);

      if(not codevalue.insert())
        gStat = 1;
        gMessage = "Ошибка вставки новой записи в таблицу dobjcode_dbt";
      end;

    end;

    i = i +1;
  end;

  if(gStat != 0 )
    retval = false;
  end;

  if((retval == false) and (TrnFlag == true))
    AbortTrn();
  end;

  return retval;

OnError( err )
  if(gMessage == "")
     gStat = -1;
     gMessage = err.message;
  end;
  if(TrnFlag == true)
     AbortTrn();
  end;
end;

macro CB_SaveListCodeValues
(
  ObjectType : integer, // Вид объекта
  ObjectID   : integer, // Ид. объекта
  CodeValues : TArray   // Массив кодов для сохранения
)
  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  TrnFlag = true;

  if(ObjectType == V_UNDEF)
    RunError("Не задан вид объекта");
  end;

  ParmObjectType    = ObjectType;
  ParmObjectID      = ObjectID;
  ParmCodeValueList = CodeValues;

  var res = ProcessTrn(NULL,"TrnSaveCodeValueList");

  if(res != true )
    AddErrorMessage(@ErrorMessage);
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
end;

macro CB_SaveListCodeValuesWOTrn
(
  ObjectType : integer, // Вид объекта
  ObjectID   : integer, // Ид. объекта
  CodeValues : TArray,  // Массив кодов для сохранения
  ErrorMsg   : @string
):integer

  var RetVal = 0;

  TrnFlag = false;

  if(ObjectType == V_UNDEF)
    RetVal   = 1;
    ErrorMsg = "Не задан вид объекта";
  elif(ObjectID == V_UNDEF)
    RetVal   = 1;
    ErrorMsg = "Не задан идентификатор объекта";
  else
    ParmObjectType    = ObjectType;
    ParmObjectID      = ObjectID;
    ParmCodeValueList = CodeValues;

    TrnSaveCodeValueList();

    RetVal = gStat;
    ErrorMsg = gMessage;
  end;

  return RetVal;
end;

// macro Test()

 // PT_PrintDebug("TEST");

// end;

// PT_PrintDebug( "ws_getparty.mac.log", "********************************");
// Test();

// var Party = RsbParty(29);

// var PersonPaper : RsbPersonPaper;

// PersonPaper = Party.PersonPaper(2);

// var stat = PersonPaper.Delete();

// PT_PrintDebug( "ws_getparty.mac.log", stat);

// stat = Party.Update();

// PT_PrintDebug( "ws_getparty.mac.log", stat);


// Import BankInter;
// CreateErrMsg (2000); // сообщение 2000 "Выпуск отчета прерван"
// var strMsg = GetErrMsg();
// println(strMsg) ;


macro CheckDp_depParent(dpcode, code)

  var flag = false;

  var query = "     SELECT d.t_code " +
              "       FROM ddp_dep_dbt d " +
              "      WHERE d.t_nodetype = 1 " +
              " START WITH d.t_code = " + string(dpcode) +
              " CONNECT BY PRIOR d.t_parentcode = d.t_code ";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    if (ds.code == code)

      flag = true;

    end;

  end;

  return flag;

end;

macro GetClientDataTree(PartyId)

  var p, p1, p2, p3, p4;

  var Arr = TArray;

  // *** 1 ***

  var query =  " SELECT p.t_name name, dp.* " +
               "  FROM dptsvdp_dbt pt, ddp_dep_dbt dp, dparty_dbt p " +
               " WHERE     pt.t_partyid = ? " +
               "       AND pt.t_partykind = 1 " +
               "       AND pt.t_department = dp.t_code(+) " +
               "       AND dp.t_partyid = p.t_partyid(+) ";

  var cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, PartyId );

  cmd.NullConversion = true;

  cmd.Execute();

  var ds = TRsbDataSet( cmd );

  while(ds.movenext)

    var pp = TRecHandler("dp_dep");

    pp.rec.code               = ds.T_CODE;
    pp.rec.parentcode         = ds.T_PARENTCODE;
    pp.rec.name               = ds.T_NAME;
    pp.rec.nodetype           = ds.T_NODETYPE;
    pp.rec.status             = ds.T_STATUS;
    pp.rec.partyid            = ds.T_PARTYID;
    pp.rec.officeid           = ds.T_OFFICEID;
    pp.rec.codekind           = ds.T_CODEKIND;
    pp.rec.opendate           = ds.T_OPENDATE;
    pp.rec.closedate          = ds.T_CLOSEDATE;
    pp.rec.opennodedate       = ds.T_OPENNODEDATE;
    pp.rec.closenodedate      = ds.T_CLOSENODEDATE;
    pp.rec.isautomated        = ds.T_ISAUTOMATED;
    pp.rec.accessmode         = ds.T_ACCESSMODE;
    pp.rec.filelevel          = ds.T_FILELEVEL;
    pp.rec.crx_usesum         = ds.T_CRX_USESUM;
    pp.rec.operdate           = ds.T_OPERDATE;
    pp.rec.sysdate            = ds.T_SYSDATE;
    pp.rec.systime            = ds.T_SYSTIME;
    pp.rec.oper               = ds.T_OPER;
    pp.rec.zonetime           = ds.T_ZONETIME;
    pp.rec.calendar           = ds.T_CALENDAR;
    pp.rec.fmregim            = ds.T_FMREGIM;
    pp.rec.fmparentcode       = ds.T_FMPARENTCODE;
    pp.rec.receiptini         = ds.T_RECEIPTINI;
    pp.rec.fmcheckbysuperior  = ds.T_FMCHECKBYSUPERIOR;
    pp.rec.branchtype         = ds.T_BRANCHTYPE;
    pp.rec.calendarparam      = ds.T_CALENDARPARAM;
    pp.rec.eastoragedir       = ds.T_EASTORAGEDIR;

    p = TWsClientDataTree();

    p.Name            = ds.name;
    p.Dp_dep          = pp.rec;

    p.Children          = TArray;

    Arr[Arr.size] = p;

  end;

  // *** 2 ***

  query =  " SELECT c.*, " +
           "       sk.*, " +
           "       pt.T_PARTYID PARTYID1, " +
           "       pt.T_DEPARTMENT DEPARTMENT1, " +
           "       pt.T_SFPLANID SFPLANID1, " +
           "       pt.T_SERVICEKIND SERVICEKIND1, " +
           "       pt.T_STARTDATE STARTDATE1, " +
           "       sf.T_SFPLANID SFPLANID2, " +
           "       sf.T_NUM NUM2, " +
           "       sf.T_NAME NAME2, " +
           "       sf.T_BEGIN BEGIN2, " +
           "       sf.T_END END2, " +
           "       sf.T_COMMENT COMMENT2, " +
           "       sf.T_HIDDEN HIDDEN2 " +
           "  FROM dclient_dbt c, " +
           "       dservkind_dbt sk, " +
           "       (SELECT * " +
           "          FROM dptdpsfplan_dbt t " +
           "         WHERE T.T_SFPLANID <> 0) pt, " +
           "       DSFPLAN_DBT sf " +
           " WHERE     c.t_partyid = ? " +
           "       AND C.T_BRANCH = 0 " +
           "       AND C.T_SERVICEKIND = SK.T_SERVISEKIND(+) " +
           "       AND c.t_partyid = PT.T_PARTYID(+) " +
           "       AND C.T_SERVICEKIND = PT.T_SERVICEKIND(+) " +
           "       AND C.T_DEPARTMENT = PT.T_DEPARTMENT(+) " +
           "       AND PT.T_SFPLANID = SF.T_SFPLANID(+) " +
           "       AND ? BETWEEN NVL ( " +
           "                                 PT.T_STARTDATE, " +
           "                                 TO_DATE ( " +
           "                                    '01010001', " +
           "                                    'DDMMYYYY')) " +
           "                          AND DECODE ( " +
           "                                 NVL ( " +
           "                                    sf.T_END, " +
           "                                    TO_DATE ( " +
           "                                       '01010001', " +
           "                                       'DDMMYYYY')), " +
           "                                 TO_DATE ( " +
           "                                    '01010001', " +
           "                                    'DDMMYYYY'), TO_DATE ( " +
           "                                                      '31129999', " +
           "                                                      'DDMMYYYY'), " +
           "                                 NVL ( " +
           "                                    sf.T_END, " +
           "                                    TO_DATE ( " +
           "                                       '01010001', " +
           "                                       'DDMMYYYY'))) ";

  cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, PartyId );
  cmd.addParam( "", RSDBP_IN, {curdate} );

  cmd.NullConversion = true;

  cmd.Execute();

  ds = TRsbDataSet( cmd );

  while(ds.movenext)

    var i = 0;

    while(i < Arr.size)

      if(Arr[i].Dp_dep.code == ds.T_DEPARTMENT)

        p1 = TRecHandler("client");

        p1.rec.partyid            = ds.T_PARTYID;
        p1.rec.servicekind        = ds.T_SERVICEKIND;
        // p1.rec.oper               = ds.T_OPER;
        p1.rec.startdate          = ds.T_STARTDATE;
        p1.rec.finishdate         = ds.T_FINISHDATE;
        p1.rec.department         = ds.T_DEPARTMENT;
        p1.rec.branch             = ds.T_BRANCH;
        p1.rec.numsession         = ds.T_NUMSESSION;
        p1.rec.reserve            = ds.T_RESERVE;

        p2 = TRecHandler("servkind");

        if(ds.T_SERVISEKIND != null)

        p2.rec.servisekind        = ds.T_SERVISEKIND;
        p2.rec.name               = ds.T_NAME;
        p2.rec.definition         = ds.T_DEFINITION;
        p2.rec.dolog              = ds.T_DOLOG;
        p2.rec.usedepartment      = ds.T_USEDEPARTMENT;
        p2.rec.contrprocessing    = ds.T_CONTRPROCESSING;
        p2.rec.bindtobranch       = ds.T_BINDTOBRANCH;
        p2.rec.showbranchclients  = ds.T_SHOWBRANCHCLIENTS;

        end;

        if(ds.PARTYID1 != NULL)

          p3 = TRecHandler("ptdpsfplan");

          p3.rec.partyid            = ds.PARTYID1;
          p3.rec.department         = ds.DEPARTMENT1;
          p3.rec.sfplanid           = ds.SFPLANID1;
          p3.rec.servicekind        = ds.SERVICEKIND1;
          p3.rec.startdate          = ds.STARTDATE1;

        end;

        if(ds.SFPLANID2 != NULL)

          p4 = TRecHandler("sfplan");

          p4.rec.sfplanid           = ds.SFPLANID2;
          p4.rec.num                = ds.NUM2;
          p4.rec.name               = ds.NAME2;
          p4.rec.begin              = ds.BEGIN2;
          //p4.rec.end                = ds.T_END;
          p4.rec.comment            = ds.COMMENT2;
          p4.rec.hidden             = ds.HIDDEN2;

        end;

        p = TWsClientDataTree();

        p.Client          = p1.rec;
        p.Servkind        = p2.rec;

        p.Name            = p.Servkind.name;

        if(ds.PARTYID1 != NULL)

          p.Ptdpsfplan      = p3.rec;

        end;

        if(ds.SFPLANID2 != NULL)

          p.Sfplan          = p4.rec;

        end;

        p.Children          = TArray;

        Arr[i].Children[Arr[i].Children.size] = p;

      end;

      i = i + 1;

    end;

  end;

  // *** 3 ***

  query =  " SELECT dp.*, " +
           "       pt.t_name name1, " +
           "       cl.T_PARTYID PARTYID1, " +
           "       cl.T_SERVICEKIND SERVICEKIND1, " +
           "       cl.T_OPER OPER1, " +
           "       cl.T_STARTDATE STARTDATE1, " +
           "       cl.T_FINISHDATE FINISHDATE1, " +
           "       cl.T_DEPARTMENT DEPARTMENT1, " +
           "       cl.T_BRANCH BRANCH1, " +
           "       cl.T_NUMSESSION NUMSESSION1, " +
           "       cl.T_RESERVE RESERVE1, " +
           "       PE.T_OPER NUMBER2, " +
           "       PE.T_NAME NAME2 " +
           "  FROM dclient_dbt cl, ddp_dep_dbt dp, dparty_dbt pt, dperson_dbt pe " +
           " WHERE     cl.t_partyid = ? " +
           "       AND cl.t_branch != 0 " +
           "       AND cl.t_branch = dp.t_code(+) " +
           "       AND dp.t_partyid = pt.t_partyid(+) " +
           "       AND CL.T_OPER = PE.T_OPER(+) ";

  cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, PartyId );

  cmd.NullConversion = true;

  cmd.Execute();

  ds = TRsbDataSet( cmd );

  while(ds.movenext)

    i = 0;

    while(i < Arr.size)

      if((Arr[i].Dp_dep.code == ds.T_PARENTCODE) OR (CheckDp_depParent(ds.T_CODE, Arr[i].Dp_dep.code)))

        var j = 0;

        while(j < Arr[i].Children.size)

          if(Arr[i].Children[j].Client.servicekind == ds.SERVICEKIND1)

            p1 = TRecHandler("dp_dep");

            p1.rec.code               = ds.T_CODE;
            p1.rec.parentcode         = ds.T_PARENTCODE;
            p1.rec.name               = ds.T_NAME;
            p1.rec.nodetype           = ds.T_NODETYPE;
            p1.rec.status             = ds.T_STATUS;
            p1.rec.partyid            = ds.T_PARTYID;
            p1.rec.officeid           = ds.T_OFFICEID;
            p1.rec.codekind           = ds.T_CODEKIND;
            p1.rec.opendate           = ds.T_OPENDATE;
            p1.rec.closedate          = ds.T_CLOSEDATE;
            p1.rec.opennodedate       = ds.T_OPENNODEDATE;
            p1.rec.closenodedate      = ds.T_CLOSENODEDATE;
            p1.rec.isautomated        = ds.T_ISAUTOMATED;
            p1.rec.accessmode         = ds.T_ACCESSMODE;
            p1.rec.filelevel          = ds.T_FILELEVEL;
            p1.rec.crx_usesum         = ds.T_CRX_USESUM;
            p1.rec.operdate           = ds.T_OPERDATE;
            p1.rec.sysdate            = ds.T_SYSDATE;
            p1.rec.systime            = ds.T_SYSTIME;
            p1.rec.oper               = ds.T_OPER;
            p1.rec.zonetime           = ds.T_ZONETIME;
            p1.rec.calendar           = ds.T_CALENDAR;
            p1.rec.fmregim            = ds.T_FMREGIM;
            p1.rec.fmparentcode       = ds.T_FMPARENTCODE;
            p1.rec.receiptini         = ds.T_RECEIPTINI;
            p1.rec.fmcheckbysuperior  = ds.T_FMCHECKBYSUPERIOR;
            p1.rec.branchtype         = ds.T_BRANCHTYPE;
            p1.rec.calendarparam      = ds.T_CALENDARPARAM;
            p1.rec.eastoragedir       = ds.T_EASTORAGEDIR;

            p2 = TRecHandler("client");

            p2.rec.partyid            = ds.PARTYID1;
            p2.rec.servicekind        = ds.SERVICEKIND1;
            p2.rec.oper               = ds.OPER1;
            p2.rec.startdate          = ds.STARTDATE1;
            p2.rec.finishdate         = ds.FINISHDATE1;
            p2.rec.department         = ds.DEPARTMENT1;
            p2.rec.branch             = ds.BRANCH1;
            p2.rec.numsession         = ds.NUMSESSION1;
            p2.rec.reserve            = ds.RESERVE1;

            p3 = TWsPerson();
            p3.Number                 = ds.NUMBER2;
            p3.Name_                  = ds.NAME2;

            if(Arr[i].Children[j].Sfplan != NULL)

              p4 = TRecHandler("sfplan");
              p4.rec.sfplanid           = Arr[i].Children[j].Sfplan.sfplanid;

            end;

            p = TWsClientDataTree();

            p.Name                    = ds.name1;
            p.Dp_dep                  = p1.rec;
            p.Client                  = p2.rec;

            if(Arr[i].Children[j].Sfplan != NULL)
              p.Sfplan                = p4.rec;
            end;

            p.Oper                    = p3;

            Arr[i].Children[j].Children[Arr[i].Children[j].Children.size] = p;

          end;

          j = j + 1;

        end;

      end;

      i = i + 1;

    end;

  end;

  return Arr;

end;

// DeletePTSVDP(9, 13, 1);

// GetClientDataTree(13);




  // var cmd, rs;

  // var Rec = TRecHandler("dp_dep");
  // var Arr = TArray;

  // var query = "select * from ddp_dep_dbt";

  // cmd = RsdCommand(query);
  // rs = RsdRecordset(cmd);

  // while(rs.movenext)

    // _CopyRecordsetToRecHandler(rs, Rec);

    // var p = TRecHandler("dp_dep");
    // copy(p, Rec);

    // Arr[Arr.size] = p.rec;

private macro SetObjrgdoc(objrgdoc, objrgdoc_)

  objrgdoc.objecttype   = objrgdoc_.objecttype;
  objrgdoc.regpartykind = objrgdoc_.regpartykind;
  objrgdoc.regdockind   = objrgdoc_.regdockind;
  objrgdoc.codekind     = objrgdoc_.codekind;
  objrgdoc.objectid     = objrgdoc_.objectid;
  objrgdoc.regpartyid   = objrgdoc_.regpartyid;
  objrgdoc.startdate    = objrgdoc_.startdate;
  objrgdoc.finishdate   = objrgdoc_.finishdate;
  objrgdoc.docdate      = objrgdoc_.docdate;
  objrgdoc.series       = objrgdoc_.series;
  objrgdoc.number       = objrgdoc_.number;
  objrgdoc.ismain       = objrgdoc_.ismain;
  objrgdoc.isclosed     = objrgdoc_.isclosed;
  objrgdoc.regplace     = objrgdoc_.regplace;
  objrgdoc.oldcode      = objrgdoc_.oldcode;
  objrgdoc.bankdate     = {curdate};
  objrgdoc.userid       = {oper};
  objrgdoc.numsession   = objrgdoc_.numsession;

end;

private macro IsChangeObjrgdoc(objrgdoc1, objrgdoc2):bool
   var RetVal = true;

   if( (objrgdoc1.objecttype   == objrgdoc2.objecttype) AND
       (objrgdoc1.regpartykind == objrgdoc2.regpartykind) AND
       (objrgdoc1.regdockind   == objrgdoc2.regdockind) AND
       (objrgdoc1.codekind     == objrgdoc2.codekind) AND
       (objrgdoc1.objectid     == objrgdoc2.objectid) AND
       (objrgdoc1.regpartyid   == objrgdoc2.regpartyid) AND
       (objrgdoc1.startdate    == objrgdoc2.startdate) AND
       (objrgdoc1.finishdate   == objrgdoc2.finishdate) AND
       (objrgdoc1.docdate      == objrgdoc2.docdate) AND
       (objrgdoc1.series       == objrgdoc2.series) AND
       (objrgdoc1.number       == objrgdoc2.number) AND
       (objrgdoc1.ismain       == objrgdoc2.ismain) AND
       (objrgdoc1.isclosed     == objrgdoc2.isclosed) AND
       (objrgdoc1.regplace     == objrgdoc2.regplace) AND
       (objrgdoc1.oldcode      == objrgdoc2.oldcode) AND
       (objrgdoc1.bankdate     == objrgdoc2.bankdate) AND
       (objrgdoc1.userid       == objrgdoc2.userid) AND
       (objrgdoc1.numsession   == objrgdoc2.numsession) )
     RetVal = false;
   end;

   return  RetVal;
end;

private macro TrnSaveObjrgdocCollection()

  var objrgdocold = Tbfile ("objrgdoc", "W", 0);
  var objrgdoc    = Tbfile ("objrgdoc", "W", 0);

  objrgdocold.Clear();
  objrgdoc.Clear();

  var ObjrgdocCollection = ParmObjrgdocCollection;
  var retval = true;

  var i = 0;

  gStat = 0; gMessage = "";

  if(ObjrgdocCollection != NULL)

    PT_PrintDebug( "ws_getparty.mac.log", "ObjrgdocCollection.size - "+ ObjrgdocCollection.size);

    while(i < ObjrgdocCollection.size)

      if(ObjrgdocCollection[i].action == PT_CREATE)

        objrgdoc.Clear();

        SetObjrgdoc(objrgdoc.rec, ObjrgdocCollection[i]);

        if(not objrgdoc.insert())
          gStat = 1;
          gMessage = "Ошибка вставки новой записи в таблицу dobjcode_dbt";
          break;
        end;

      end;

      if(ObjrgdocCollection[i].action == PT_MODIFY)

        objrgdoc.Clear();

        if(ObjrgdocCollection[i].documentid != 0)

          objrgdocold.rec.documentid = ObjrgdocCollection[i].documentid;

          if(not objrgdocold.GetEQ())
            gStat = 70;
            gMessage = "Конфликт. Документ изменен другим операционистом";
            break;
          end;

        end;

        if(gStat == 0)
          Copy(objrgdoc, objrgdocold);

          if(not objrgdoc.GetEQ())
            gStat = 70;
            gMessage = "Конфликт. Документ изменен другим операционистом";
            break;
          end;
        end;

        if(gStat == 0)
          SetObjrgdoc(objrgdoc.rec, ObjrgdocCollection[i]);

          if(IsChangeObjrgdoc(objrgdoc.rec, objrgdocold.rec))
            if(not objrgdoc.update())
              gStat = 1;
              gMessage = "Ошибка обновления записи таблицы dobjrgdoc_dbt";
              break;
            end;
          end;
        end;

      end;

      if(ObjrgdocCollection[i].action == PT_REMOVE)

        var query = "DELETE FROM DOBJRGDOC_DBT WHERE t_documentid = " + ObjrgdocCollection[i].documentid;

        if(ExecSQL(query) != true)
          break;
        end;

      end;

      i = i + 1;

    end;

  end;

  if(gStat != 0 )
    retval = false;
  end;

  if((retval == false) and (TrnFlag == true))
    AbortTrn();
  end;

  return retval;

OnError( err )
  if(gMessage == "")
     gStat = -1;
     gMessage = err.message;
  end;
  if(TrnFlag == true)
     AbortTrn();
  end;
end;

macro SaveObjrgdocCollection
(
  ObjrgdocCollection : TArray
)
  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  TrnFlag = true;

  ParmObjrgdocCollection = ObjrgdocCollection;

  var res = ProcessTrn(NULL,"TrnSaveObjrgdocCollection");

  if(res != true )
    AddErrorMessage(@ErrorMessage);
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro CheckCodesUnique(CodeValue, CodeValues)

  var res = true;

  var i = 0;

  if(CodeValue.unique == "X")

    while(i < CodeValues.size)

      if((CodeValue.codekind == CodeValues[i].codekind) AND (CodeValues[i].bankclosedate == date(0,0,0)))

        message = "Данный вид кода не имеет признака множественности значений кодов";

        res = false;

        break;

      end;

      i = i + 1;

    end;

  end;

  return res;

end;

private macro CheckCodesDates(SaveCodeValue, CodeValue, CodeValues)

  var res = true;

  var i = 0;

  while(i < CodeValues.size)

    if(SaveCodeValue.autokey != CodeValues[i].autokey)

      if( (CodeValue.codekind == CodeValues[i].codekind) AND (((CodeValues[i].bankdate == date(0,0,0)) OR (CodeValue.bankclosedate == date(0,0,0)) OR ((CodeValues[i].bankdate != date(0,0,0)) AND (CodeValues[i].bankdate <= CodeValue.bankclosedate))) AND
          ((CodeValues[i].bankclosedate == date(0,0,0)) OR (CodeValue.bankdate == date(0,0,0)) OR ((CodeValues[i].bankclosedate != date(0,0,0)) AND (CodeValue.bankdate <= CodeValues[i].bankclosedate)))) )

        message = "Имеется значение, дейсивующее на заданную или более позднюю дату ";

        res = false;

        break;

      end;

    end;

    i = i + 1;

  end;

  return res;

end;

macro CheckObjCodeBeforeSaveFromFininstr(

  SaveCodeValue,
  CodeValue,
  CodeValues : TArray

)
  var res = true;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  if((SaveCodeValue == null) OR ((SaveCodeValue != null) AND (SaveCodeValue.codekind != CodeValue.codekind)))

    res = CheckCodesUnique(CodeValue, CodeValues);

  end;

  if(res == true)

    res = CheckCodesDates(SaveCodeValue, CodeValue, CodeValues);

  end;

  ErrorMessage.Code     = 0;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro WEB_CheckOKPO(okpo)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var res = 0;

  if(okpo != "")

    res = CheckOKPO(okpo);

  end;

  if(res != 0 )
    AddErrorMessage(@ErrorMessage);
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;
macro GetObjCodeWidgetInfo(ObjectType, ObjectID)

  var p = TWsObjCodeRegWidgetInfo();

  p.CodeValueCollection = GetObjcodeListByPartyID(ObjectType, ObjectID);
  p.CodeKindCollection  = GetObjkcodeList(ObjectType);
  p.ObjalcodCollection  = GetObjalcodList(ObjectType);

  return p;

end;

macro GetObjCodeRegistrationWidgetInfo(ObjectType, ObjectID)

  var p = TWsObjCodeRegWidgetInfo();

  p.CodeValueCollection = GetObjcodeListByPartyID(ObjectType, ObjectID);
  p.CodeKindCollection  = GetObjkcodeList(ObjectType);
  p.ObjalcodCollection  = GetObjalcodList(ObjectType);
  p.ObjkrgptCollection  = GetObjkrgptList(ObjectType);
  p.ObjrgdocCollection  = GetObjrgdocList(ObjectType, ObjectID);
  p.ObjalregCollection  = GetObjalregList(ObjectType);
  p.ObjkdocCollection   = GetObjkdocList(ObjectType);
  p.ObjalptCollection   = GetObjalptList();

  return p;

end;

macro GetRegistrationObjCodeWidgetInfo(ObjectType, ObjectID)

  var p = TWsObjCodeRegWidgetInfo();

  p.CodeValueCollection = GetObjcodeListByPartyID(ObjectType, ObjectID);
  p.CodeKindCollection  = GetObjkcodeList(ObjectType);
  p.ObjalcodCollection  = GetObjalcodList(ObjectType);
  p.ObjkrgptCollection  = GetObjkrgptList(ObjectType);
  p.ObjrgdocCollection  = GetObjrgdocList(ObjectType, ObjectID);
  p.ObjalregCollection  = GetObjalregList(ObjectType);
  p.ObjkdocCollection   = GetObjkdocList(ObjectType);
  p.ObjalptCollection   = GetObjalptList();

  return p;

end;

macro IsVisibleBornPaperSeriesNumber(listkind)

  file lst("partylst.dbt");
  
  var res = false;
  
  lst.Listkind = listkind;

  var stat = GetEQ( lst );  

  if((stat == true) AND (lst.legalform != 1))
  
    res = true;
    
  else
  
    res = false;
  
  end;  

  return res;
  
end;

macro WebCore_CheckNeedIdentParty(PartyID, PartyInfo)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var res = True;
  
  var stat = 0;

  var party = null;

  if(PartyID > 0)
    
    party = RsbParty(PartyID);
    
    if(PartyInfo != null)
      
      res = SaveP(PartyInfo, @party, true);
      
    end;
    
  else
    
    if((PartyInfo != null) AND ((PartyInfo.party.PartyID > 0) OR (PartyInfo.party.legalform > 0)))
      
      party = RsbParty(PartyInfo.party.PartyID);
      
      res = SaveP(PartyInfo, @party, true);
      
    else
      
      RunError("Не задан субъект");
      
    end;
    
  end;
  
  var retval = TWsCheckNeedIdentPartyResponse();
  
  if(res == True)
    
    stat = PT_CheckNeedIndentifyParty(
      party.PartyID,        // Parm_PartyID
      party,                // Parm_Party
      null,                 // Parm_OnDate
      null,                 // Parm_Dprt
      null,                 // Parm_NeedChildService
      null,                 // Parm_ExcludeNotIdentify
      null,                 // Parm_CheckClient
      null,                 // Parm_CheckProxy
      null,                 // Parm_CheckBeneficiary
      null,                 // Parm_CheckBeneOwner
      null,                 // Parm_AlertDays
      @retval.ResultCode,   // Parm_ResultCode
      @retval.NextDate,     // Parm_NextCheckDate
      null,                 // Parm_DiagClient
      null,                 // Parm_DiagProxy
      null,                 // Parm_DiagBeneficiary
      null,                 // Parm_DiagBeneOwner 
      null                  // Parm_FormCreateDate    
    );
  
  end;
  
  if((stat != 0) OR (res != True))

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(retval);

  return ResponseBuilder.Result;  

end;

macro WebCore_PT_CheckNrcountry(PartyID, NRCountry)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var res = PT_CheckNrcountry(PartyID, NRCountry);
  
  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(res);

  return ResponseBuilder.Result;  

end;

macro WebCore_PT_HasPersnCit(PartyID)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var result;

  var query = "select count(*) count from DPERSNCIT_DBT where T_PERSONID = " + string(PartyID);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    if(ds.count == 0)
      result = 0;
    else
      result = 1;
    end;

  end;
  
  if(result != 0)

    AddErrorMessageExt(@ErrorMessage, 6007, GetErrorMsg( 6007 ));

  end;

  ResponseBuilder.SetUserObject(IIF(result == 0, True, False));

  return ResponseBuilder.Result;  

end;

macro GetCountryById(CountryId):TWsCountry
   var p;

   var query = "select * from dcountry_dbt where T_COUNTRYID = '" + string(CountryId) + "'";

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

   if (ds.MoveNext())
      p = TWsCountry();
      p.CountryId = ds.COUNTRYID;
      p.ParentId = ds.T_PARENTCOUNTRYID;
      p.Name = ds.NAME;
      p.FullName = ds.FULLNAME;
      p.CodeCyr3 = ds.CODECYR3;
      p.CodeLat3 = ds.CODELAT3;
      p.CodeLat2 = ds.CODELAT2;
      p.CodeNum = ds.CODENUM3;
   else
      return null;
   end;


   return p;
END;


macro WebCore_GetEnterCheckGridItemLiLst(PartyInfo)

  var partyid   = PartyInfo.Party.partyid;
  var legalform = PartyInfo.Party.legalform;

  var name1 = PartyInfo.Persn.name1;
  var name2 = PartyInfo.Persn.name2;
  var name3 = PartyInfo.Persn.name3;

  var birthdate = PartyInfo.Persn.born;

  var shortname = PartyInfo.Party.shortname;

  var CodeINN = "";

  var i = 0;

  while(i < PartyInfo.CodeValueCollection.size)

    if(PartyInfo.CodeValueCollection[i].codekind == 16)

      CodeINN = PartyInfo.CodeValueCollection[i].code;

    end;

    i = i + 1;

  end;

  var result = TArray();

  var stat = PT_GetSimilarForParty(
                                    partyid,
                                    legalform,
                                    name1,
                                    name2,
                                    name3,
                                    birthdate,
                                    shortname,
                                    CodeINN, true, @result);

  var Arr = TArray;

  i = 0;

  while(i < result.size)

    var party = RsbParty(result[i]);

    var p = TWsEnterCheckGridItem();

    p.Code    = party.Code.GetCode(1);
    p.Name    = party.FullName;
    p.Inn     = party.Code.GetCode(16);
    p.PartyId = party.PartyID;

    party = null;

    Arr[Arr.size] = p;

    i = i + 1;

  end;

  return Arr;

end;

macro WebCore_IsExistsOtherPartyInnCode(Party, Code)

  var res = 0;
 
  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_IsExistsOtherPartyInnCode( Party.partyid,  Party.partyid,  Party.Superior, Code );

  if(res != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(res);

  return ResponseBuilder.Result;

end;

macro WebCore_DefinePartyDoubler(PartyID, PartyInfo, EditMode, PanelMode)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = 0;

  var res = True;

  var retVal;

  var PartyObj = RsbParty(PartyID);

  if(PartyInfo != null)

    res = SaveP(PartyInfo, @PartyObj, true);

  end;

  if(res == True)

    stat = PT_DefinePartyDoubler(@PartyObj, EditMode, PanelMode);

    if(stat == 0)

      retVal = TWsDefinePartyDoubler();

      retVal.IsProbDoubler = PartyObj.IsProbDoubler;
      retVal.IsDoubler     = PartyObj.IsDoubler ;
      retVal.HasDoubler    = PartyObj.IsHasDoubler;
      retVal.MainPartyID   = PartyObj.MainPartyID;
      retVal.ParamSetID    = PartyObj.ParamSetID;

    end;

  end;

  if((res != True) OR (stat != 0))

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(retVal);

  return ResponseBuilder.Result;

end;

macro WebCore_GetDoublerItemsList(PartyID)

  var Arr = TArray;

  var query = "       SELECT pc.t_PartyID "
              "         FROM DPARTCODE_DBT pc, "
              "              (    SELECT p.t_PartyID "
              "                     FROM dparty_dbt p "
              "               START WITH p.t_MainPartyID = " + string(PartyID) +
              "               CONNECT BY PRIOR p.t_PartyID = p.t_MainPartyID) p "
              "        WHERE P.T_PARTYID = PC.T_PARTYID AND PC.T_CODEKIND = 1 "
              "     ORDER BY PC.T_CODE";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while(ds.MoveNext())

    var party = RsbParty(ds.t_PartyID);

    var p = TWsDoublerListGridItem();

    p.Code    = party.Code.GetCode(1);
    p.Name    = party.FullName;

    if(party.IsProbDoubler == true)

      p.Status  = "Предполагаемый дублер";

    end;

    if(party.IsDoubler == true)

      p.Status  = "Дублер";

    end;

    p.PartyId = ds.t_PartyID;

    party = null;

    Arr[Arr.size] = p;

  end;

  return Arr;

end;

private macro CheckMainPartyID(MainPartyID, PartyID)

  var res = true;

  var query = "       SELECT p.t_PartyID "
              "         FROM dparty_dbt p "
              "   START WITH p.t_MainPartyID = " + string(MainPartyID) +
              "   CONNECT BY PRIOR p.t_PartyID = p.t_MainPartyID ";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while(ds.MoveNext())

    if(PartyID == ds.t_PartyID)
      
      res = false;
      
    end;

  end;

  return res;

end;

macro WebCore_MarkDoubler(PartyID_Orig, PartyID)

  var res = true;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var Party_Orig = RsbParty(PartyID_Orig);
  
  var Party = RsbParty(PartyID);
  
  if((Party_Orig.MainPartyID != PartyID) AND (CheckMainPartyID(PartyID, PartyID_Orig)))

    Party.IsProbDoubler = false;

    Party.IsDoubler = true;

    if(Party.MainPartyID == 0)

      Party.MainPartyID = PartyID_Orig;
      
      Party_Orig.IsHasDoubler = true;

    end;

    res = Party.Update();

    if(res == true)

      res = Party_Orig.Update();

    end;
    
    if(res != true)

      AddErrorMessage(@ErrorMessage);

    end;
    
  else

    AddErrorMessageExt(@ErrorMessage, 0, "Нельзя пометить дублером.");
    
    res = false;

  end;
  
  Party_Orig = null;
  
  Party = null;

  ResponseBuilder.SetUserObject(res);

  return ResponseBuilder.Result;

end;

macro WebCore_MarkProbDoubler(PartyID_Orig, PartyID)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var Party = RsbParty(PartyID);
  
  var Party_Orig = RsbParty(PartyID_Orig);
  
  if((Party_Orig.MainPartyID != PartyID) AND (CheckMainPartyID(PartyID, PartyID_Orig)))

    Party.IsDoubler = false;

    Party.IsProbDoubler = true;

    if(Party.MainPartyID == 0)

      Party.MainPartyID = PartyID_Orig;
      
      Party_Orig.IsHasDoubler = true;

    end;

    var res = Party.Update();

    if(res != true)

      AddErrorMessage(@ErrorMessage);

    end;
    
  else

    AddErrorMessageExt(@ErrorMessage, 0, "Нельзя пометить предполагаемого дублера.");
    
    res = false;

  end;  
  
  Party_Orig = null;
  
  Party = null;  

  ResponseBuilder.SetUserObject(res);

  return ResponseBuilder.Result;

end;

macro WebCore_UnMarkDoubler(PartyID)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var Party = RsbParty(PartyID);

  Party.IsDoubler     = false;
  Party.IsProbDoubler = false;

  var saveMainPartyID = Party.MainPartyID;
  
  Party.MainPartyID   = 0;
  
  var res = Party.Update();

  if((res == true) AND (saveMainPartyID != 0))

    res = CheckHasDoubler(saveMainPartyID);

  end;

  if(res != true)

    AddErrorMessage(@ErrorMessage);

  end;
  
  Party = null;

  ResponseBuilder.SetUserObject(res);

  return ResponseBuilder.Result;

end;

macro WebCore_CopyPartyParm(destPartyID, sourcePartyID)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = PT_CopyPartyParm(destPartyID, sourcePartyID);

  if(stat != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(stat);

  return ResponseBuilder.Result;

end;

////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////
// Получить объект TWsPartyEx по partyid
///////////////////////////////////////////////////////////

macro GetTWsPartyExByID( partyid : integer )

  var p = null;

  if(partyid > 0)

    p = TWsPartyEx();

    var query = " SELECT PT.T_PARTYID PARTYID, "
                " PT.T_IOWNERKIND, "
                " PT.T_LEGALFORM, "
                " PT.T_SHORTNAME, "
                " PT.T_NAME, "
                " PT.T_ADDNAME, "
                " PT.T_OKPO, "
                " PT.T_NOTRESIDENT, "
                " PT.T_SUPERIOR, "
                " PT.T_CHANGE_DATE, "
                " PT.T_CHANGE_DATEPREV, "
                " PT.T_LOCKED, "
                " PT.T_TAXINSTITUTION, "
                " PT.T_TAXREGDATE, "
                " PT.T_SYSTYPE, "
                " PT.T_USERTYPE, "
                " PT.T_USERFIELD1, "
                " PT.T_USERFIELD2, "
                " PT.T_USERFIELD3, "
                " PT.T_USERFIELD4, "
                " PT.T_NRCOUNTRY, "
                " PT.T_CONSOLIDATERECORD, "
                " PT.T_SETACCSEARCHALG, "
                " PT.T_BRANCH, "
                " PT.T_NUMSESSION, "
                " PT.T_OFSHOREZONE, "
                " PT.T_MAINPARTYID, "
                " PT.T_ISPROBDOUBLER, "
                " PT.T_ISDOUBLER, "
                " PT.T_HASDOUBLER, "
                " PT.T_PARAMSETID, "
                // " PT.T_HASHVALUE, "
                " PT.T_LATNAME, "
                " PT.T_CBDK_ISSYNCH, "
                " PT.T_CBDK_DATEUPDATE, "
                " PT.T_CBDK_TIMEUPDATE, "
                " PT.T_CBDK_SYNCHINFO, "
                " PT.T_RESERVE, "
                " OC.T_CODE, PN.T_NAME PARTYNAME "
                "  FROM DPARTY_DBT PT, DPARTYNAME_DBT PN, DOBJCODE_DBT OC "
                " WHERE     PT.T_PARTYID = " + string(partyid) +
                "       AND PT.T_PARTYID = PN.T_PARTYID "
                "       AND PN.T_NAMETYPEID = 1 "
                "       AND OC.T_OBJECTTYPE = 3 "
                "       AND PT.T_PARTYID = OC.T_OBJECTID ";

    PT_PrintDebug( "ws_getparty.mac.log", "*** GetTWsPartyExByID ***");
    PT_PrintDebug( "ws_getparty.mac.log", query);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    ds.NullConversion = true;

    if (ds.MoveNext())

      p.partyid           = ds.partyid;
      p.iownerkind        = ds.iownerkind;
      p.legalform         = ds.legalform;
      p.shortname         = ds.shortname;
      p.name              = ds.name;
      p.addname           = ds.addname;
      p.okpo              = ds.okpo;
      p.notresident       = ds.notresident;
      p.superior          = ds.superior;
      p.change_date       = ds.change_date;
      p.change_dateprev   = ds.change_dateprev;
      p.locked            = ds.locked;
      p.taxinstitution    = ds.taxinstitution;
      p.taxregdate        = ds.taxregdate;
      p.systype           = ds.systype;
      p.usertype          = ds.usertype;
      p.userfield1        = ds.userfield1;
      p.userfield2        = ds.userfield2;
      p.userfield3        = ds.userfield3;
      p.userfield4        = ds.userfield4;
      p.nrcountry         = ds.nrcountry;
      p.consolidaterecord = ds.consolidaterecord;
      p.setaccsearchalg   = ds.setaccsearchalg;
      p.branch            = ds.branch;
      p.numsession        = ds.numsession;
      p.ofshorezone       = ds.ofshorezone;
      p.mainpartyid       = ds.mainpartyid;
      p.isprobdoubler     = ds.isprobdoubler;
      p.isdoubler         = ds.isdoubler;
      p.hasdoubler        = ds.hasdoubler;
      p.paramsetid        = ds.paramsetid;
      // p.hashvalue         = ds.hashvalue;
      p.latname           = ds.latname;
      p.cbdk_issynch      = ds.cbdk_issynch;
      p.cbdk_dateupdate   = ds.cbdk_dateupdate;
      p.cbdk_timeupdate   = ds.cbdk_timeupdate;
      p.cbdk_synchinfo    = ds.cbdk_synchinfo;
      p.reserve           = ds.reserve;

      p.code              = ds.code;
      p.partyname         = ds.partyname;

    end;

  end;

  return p;

end;

macro WebCore_InitPanelDoubler(PartyID, PartyInfo, MainPartyID)

  var DoublerObjPanel = TWsDoublerObjPanel();

  if(PartyInfo != null)

      DoublerObjPanel.DoublerParty = TWsPartyEx();

      DoublerObjPanel.DoublerParty.partyid           = PartyInfo.Party.partyid;
      DoublerObjPanel.DoublerParty.iownerkind        = PartyInfo.Party.iownerkind;
      DoublerObjPanel.DoublerParty.legalform         = PartyInfo.Party.legalform;
      DoublerObjPanel.DoublerParty.shortname         = PartyInfo.Party.shortname;
      DoublerObjPanel.DoublerParty.name              = PartyInfo.Party.name;
      DoublerObjPanel.DoublerParty.addname           = PartyInfo.Party.addname;
      DoublerObjPanel.DoublerParty.okpo              = PartyInfo.Party.okpo;
      DoublerObjPanel.DoublerParty.notresident       = PartyInfo.Party.notresident;
      DoublerObjPanel.DoublerParty.superior          = PartyInfo.Party.superior;
      DoublerObjPanel.DoublerParty.change_date       = PartyInfo.Party.change_date;
      DoublerObjPanel.DoublerParty.change_dateprev   = PartyInfo.Party.change_dateprev;
      DoublerObjPanel.DoublerParty.locked            = PartyInfo.Party.locked;
      DoublerObjPanel.DoublerParty.taxinstitution    = PartyInfo.Party.taxinstitution;
      DoublerObjPanel.DoublerParty.taxregdate        = PartyInfo.Party.taxregdate;
      DoublerObjPanel.DoublerParty.systype           = PartyInfo.Party.systype;
      DoublerObjPanel.DoublerParty.usertype          = PartyInfo.Party.usertype;
      DoublerObjPanel.DoublerParty.userfield1        = PartyInfo.Party.userfield1;
      DoublerObjPanel.DoublerParty.userfield2        = PartyInfo.Party.userfield2;
      DoublerObjPanel.DoublerParty.userfield3        = PartyInfo.Party.userfield3;
      DoublerObjPanel.DoublerParty.userfield4        = PartyInfo.Party.userfield4;
      DoublerObjPanel.DoublerParty.nrcountry         = PartyInfo.Party.nrcountry;
      DoublerObjPanel.DoublerParty.consolidaterecord = PartyInfo.Party.consolidaterecord;
      DoublerObjPanel.DoublerParty.setaccsearchalg   = PartyInfo.Party.setaccsearchalg;
      DoublerObjPanel.DoublerParty.branch            = PartyInfo.Party.branch;
      DoublerObjPanel.DoublerParty.numsession        = PartyInfo.Party.numsession;
      DoublerObjPanel.DoublerParty.ofshorezone       = PartyInfo.Party.ofshorezone;
      DoublerObjPanel.DoublerParty.mainpartyid       = PartyInfo.Party.mainpartyid;
      DoublerObjPanel.DoublerParty.isprobdoubler     = PartyInfo.Party.isprobdoubler;
      DoublerObjPanel.DoublerParty.isdoubler         = PartyInfo.Party.isdoubler;
      DoublerObjPanel.DoublerParty.hasdoubler        = PartyInfo.Party.hasdoubler;
      DoublerObjPanel.DoublerParty.paramsetid        = PartyInfo.Party.paramsetid;
      // p.hashvalue         = ds.hashvalue;
      DoublerObjPanel.DoublerParty.latname           = PartyInfo.Party.latname;
      DoublerObjPanel.DoublerParty.cbdk_issynch      = PartyInfo.Party.cbdk_issynch;
      DoublerObjPanel.DoublerParty.cbdk_dateupdate   = PartyInfo.Party.cbdk_dateupdate;
      DoublerObjPanel.DoublerParty.cbdk_timeupdate   = PartyInfo.Party.cbdk_timeupdate;
      DoublerObjPanel.DoublerParty.cbdk_synchinfo    = PartyInfo.Party.cbdk_synchinfo;
      DoublerObjPanel.DoublerParty.reserve           = PartyInfo.Party.reserve;

      var i = 0;

      if(PartyInfo.CodeValueCollection != null)

        while(i < PartyInfo.CodeValueCollection.size)

          if(PartyInfo.CodeValueCollection[i].codekind == 1) // Код вида 1

            DoublerObjPanel.DoublerParty.code = PartyInfo.CodeValueCollection[i].code;

          end;

          i = i + 1;

        end;

      end;

      if(PartyInfo.PartynameCollection != null)

        i = 0;

        while(i < PartyInfo.PartynameCollection.size)

          if(PartyInfo.PartynameCollection[i].nametypeid == 1) // Наименование вида 1

            DoublerObjPanel.DoublerParty.partyname = PartyInfo.PartynameCollection[i].name;

          end;

          i = i + 1;

        end;

      end;

  else

    DoublerObjPanel.DoublerParty = GetTWsPartyExByID(PartyID);

  end;

  if(MainPartyID == -1)

    DoublerObjPanel.Party = GetTWsPartyExByID(DoublerObjPanel.DoublerParty.mainpartyid);

  else

    DoublerObjPanel.Party = GetTWsPartyExByID(MainPartyID);

  end;

  return DoublerObjPanel;

end;
macro WebCore_CheckPersnIDCAllow(PaperKind, NotResident, IsStateless, Born)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = CB_CheckPersnIDCAllow(PaperKind, NotResident, IsStateless, Born);

  if(stat != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(stat);

  return ResponseBuilder.Result;

end;


private macro AddErrorMessageSnils(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro ConvertMessageBoxButtons(value)

  var result=0;
  
  if(  value==0)  result=2;  // SERVICEMSGBUTTON_YES      // RsMessageBoxButtons.Yes
  elif(value==1)  result=4;  // SERVICEMSGBUTTON_NO       // RsMessageBoxButtons.No
  elif(value==2)  result=8;  // SERVICEMSGBUTTON_CANCEL   // RsMessageBoxButtons.Cancel
  elif(value==3)  result=1;  // SERVICEMSGBUTTON_OK       // RsMessageBoxButtons.Ok
  elif(value==4)  result=16; // SERVICEMSGBUTTON_CONTINUE // RsMessageBoxButtons.Continue
  end;	
	
  return result;
  
end;

private macro ConvertMessageBoxButtonsBack(value)

  var result=0;
  
  if(  value==1)  result=3;  // RsMessageBoxButtons.Ok      // SERVICEMSGBUTTON_OK      
  elif(value==2)  result=0;  // RsMessageBoxButtons.Yes     // SERVICEMSGBUTTON_YES    
  elif(value==4)  result=1;  // RsMessageBoxButtons.No      // SERVICEMSGBUTTON_NO     
  elif(value==8)  result=2;  // RsMessageBoxButtons.Cancel  // SERVICEMSGBUTTON_CANCEL
  elif(value==16) result=4;  // RsMessageBoxButtons.Continue// SERVICEMSGBUTTON_CONTINUE
  end;	
	
  return result;
  
end;

private macro ConvertButtonsFromList(value)

  var result = 0, i = 0;
  
  while(i < value.size)  
    result = result + ConvertMessageBoxButtons(value[i]); 
    i = i + 1;  
  end;
  
  return result;
  
end;

macro WebCore_PT_CheckSnils(MessageID, CheckDate, CheckTime, LastName, FirstName, Patronymic, SNILS, BirthDate, Gender, CheckedSteps, UserConfirm):WebResponseBuilder

  var res = 0;
  
  var UserQuestion,UserQuestionBtns,UserQuestionDefault, StepId=0;
  
  var result = TWsCheckSnilsResponse();

  ResponseBuilder = WebResponseBuilder();

  var Question: WsQuestion = WsQuestion ();
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  UserConfirm = map(UserConfirm, @ConvertMessageBoxButtonsBack);
  
  res = PT_CheckSnils(MessageID, CheckDate, CheckTime, LastName, FirstName, Patronymic, SNILS, 
                      BirthDate, Gender, @UserQuestion, @UserQuestionBtns, @UserQuestionDefault, 
                      @StepId, CheckedSteps,  UserConfirm,  result.Action); 
  
  if(res > 0)

    AddErrorMessageSnils(@ErrorMessage);

  end;
  
  if(res < 0)
  
    var UserQuestionBtnsRsMessageBoxButtons = ConvertButtonsFromList(UserQuestionBtns);
    var UserQuestionDefaultRsMessageBoxButtons = ConvertMessageBoxButtons(UserQuestionDefault);
    Question.Code  = StepId ;
    Question.Message = UserQuestion ;
    Question.QuestionInfo = QuestionBoxInfo (UserQuestion , UserQuestionBtnsRsMessageBoxButtons, UserQuestionDefaultRsMessageBoxButtons);
    ResponseBuilder.AddQuestion(Question);
	
  end;
  
  if(res == 0)
  
    result.UserQuestion=UserQuestion;
	result.MessageID=MessageID;
	result.CheckDate=CheckDate;
	result.CheckTime=CheckTime;
	ResponseBuilder.SetUserObject(result);
  
  end;

  return ResponseBuilder.Result;

end;

macro getPaperKindCodeDocum( paperkind )
  var cmd, rs;
  var value = "";

  cmd = RsdCommand( "select t_codedocum from dpaprkind_dbt where t_paperkind =  ? " );
  cmd.AddParam( "paperkind", RSDBP_IN, paperkind );
  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  while ( rs.moveNext )
    value = rs.value( "t_codedocum" );
  end;

  return value;
end;

macro WebCore_PT_CheckECUPRID (LastName, FirstName, Patronymic, IsNotValid, PassportSeries, PassportNumber, INN, SNILS, CheckedSteps, UserConfirm):WebResponseBuilder
  var res = 0;
  
  var UserQuestion, UserQuestionBtns, UserQuestionDefault, StepId=0;
  
  var result = TWsCheckECUPRIDResponse();

  ResponseBuilder = WebResponseBuilder();

  result.StatusCode = ZeroValue( V_STRING );  
  result.ReturnCode = ZeroValue( V_STRING );  
  result.ReturnText = ZeroValue( V_STRING );  
  result.ObjectID   = ZeroValue( V_STRING );  
  result.MessageID  = ZeroValue( V_STRING );
  result.CheckDate  = ZeroValue( V_DATE );  
  result.CheckTime  = ZeroValue( V_TIME );

  var Question: WsQuestion = WsQuestion ();
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  UserConfirm = map(UserConfirm, @ConvertMessageBoxButtonsBack);
  
  res = PT_CheckECUPRID (LastName, FirstName, Patronymic, IsNotValid,  PassportSeries , PassportNumber , 
            INN, SNILS, @result.MessageID, @result.StatusCode, @result.ReturnCode, @result.ReturnText, 
            @result.ObjectID, @result.CheckDate, @result.CheckTime, @UserQuestion, @UserQuestionBtns, 
            @UserQuestionDefault, @StepId, CheckedSteps,  UserConfirm,  @result.Action);

  if(res > 0)

    AddErrorMessageSnils(@ErrorMessage);

  end;
  
  if(res < 0)
  
    var UserQuestionBtnsRsMessageBoxButtons = ConvertButtonsFromList(UserQuestionBtns);
    var UserQuestionDefaultRsMessageBoxButtons = ConvertMessageBoxButtons(UserQuestionDefault);
    Question.Code  = StepId;
    Question.Message = UserQuestion;
    Question.QuestionInfo = QuestionBoxInfo(UserQuestion , UserQuestionBtnsRsMessageBoxButtons, UserQuestionDefaultRsMessageBoxButtons);
    ResponseBuilder.AddQuestion(Question);
	
  end;
  
  if(res == 0)

    result.UserQuestion=UserQuestion;    // result.Action == PTCHECKSNILSACTION_SHOW_MSG. показ сообщения. Не Question.
    ResponseBuilder.SetUserObject(result);
  
  end;

  return ResponseBuilder.Result;

end;


macro WebCore_DeletePartyCheckECUPRID (PartyId):WebResponseBuilder

  var res = 0;
  
  ResponseBuilder = WebResponseBuilder();
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var PartyObj = RsbParty(PartyID);
  
  if(PartyObj != null)
  
    var CheckECUPRID = PartyObj.PartyCheckECUPRID();
	
	if(CheckECUPRID != null)
	
	  CheckECUPRID.First();
	
	  res = CheckECUPRID.Delete();
	
	end;
		
  end;
	
  
  if(res != 0)

    AddErrorMessageSnils(@ErrorMessage);

  end;
  
  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;
