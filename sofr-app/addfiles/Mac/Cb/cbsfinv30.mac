/************************************************************************/
/*         Автоматизированная банковская система RS-Bank v6.0           */
/*                 Copyright (c) R-Style Software Lab 2005              */
/*  Имя файла        : cbsfinv30.mac                                    */
/*  Описание         : Оплата ТО. Шаг вставки связки с платежом         */
/*  Программист      : Чернов А.Г.                                      */
/*  Создан           : 09-06-2005                                       */
/************************************************************************/

import OprInter, InsCarryDoc, SFInter, "cbsfinv.mac";

private macro proc( doc, sfinv )
  file pmpaym("pmpaym");
  var  stat = 1;

  /* ID платежа и первичного документа совпадают, воспользуемся этим */
  pmpaym.PaymentID = doc.rec.documentid;
  if( GetEQ(pmpaym) )
    if( SfInsertLink( pmpaym.PaymentID, sfinv.InvoiceID ) )
      stat = 0;
    end;
  end;

  return stat;
end;

macro ExecuteStep( d, sfinv )
  var stat = 1;

  record sfinv_buf("sfinv.dbt");

  setbuff( sfinv_buf, sfinv );

  /* ищем платеж, вставленный на предыдущем шаге */
  stat = SfGetPrevDoc( sfinv_buf, @proc );

  return stat;
end;
