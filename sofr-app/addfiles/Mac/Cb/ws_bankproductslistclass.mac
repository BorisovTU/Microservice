/*
$Name:        ws_bankproductslistclass.mac
$Module:      WEB - Общее
$Description: Макрос с реализаций класса для отбора банковских продуктов
*/

import "ws_bankproduct.mac";

class TWsPrdProduct
  var ProductID;
  var ProductKindID;
  var Name;
  var Branch;
  var InChildBranch;
  var ProductDocKindID;
  var OpenDate;
  var CloseDate;
  var ServiceKind;
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetStrToArray(list)

  var i = 0;

  var str = "";

  while(i < list.size)

    if( i != list.size - 1)

      str = str + list[i] + ", ";

    else

      str = str + list[i];

    end;

    i = i + 1;

  end;
  
  return str;
  
end;

////////////////////////////////////////////////////////////////////////////////////////////////////////////
// class BankProductsList
////////////////////////////////////////////////////////////////////////////////////////////////////////////

class BankProductsList()

  macro GetList(bankdate,
                branch,
                productkindid,
                productkindidlist,
                productdockindid,
                productdockindidlist,
                servicekind,
                servicekindlist, 
                filteritems,
                orderitems):TArray
        
    ResponseBuilder = WebResponseBuilder();

    var ErrorMessage : WsErrorMessage = WsErrorMessage();

    var resultlist = TArray;
    
    var cmd, rs, p;

    var query = " SELECT t.t_productid, "
                "      t.t_productkindid, "
                "      t.t_name, "
                "      t.t_branch, "
                "      t.t_inchildbranch, "
                "      t.t_productdockindid, "
                "      t.t_opendate, "
                "      t.t_closedate, "
                "      t.t_servicekind, "
                "      t.t_isdistrib "
                " FROM dprdproduct_dbt t "
                "  WHERE 1=1 ";
    
    if(productkindid != 0)
      
      query = query + " AND t.t_productkindid = ? ";
    
    end;
    
    if((productkindidlist != null) AND (productkindidlist.size != 0))
      
      query = query + " AND t.t_productkindid IN ( " + GetStrToArray(productkindidlist) + " ) ";
    
    end; 
    
    if(productdockindid != 0)
      
      query = query + " AND t.t_productdockindid = ? ";
    
    end;
    
    if((productdockindidlist != null) AND (productdockindidlist.size != 0))
      
      query = query + " AND t.t_productdockindid IN ( " + GetStrToArray(productdockindidlist) + " ) ";
    
    end; 
    
    if(servicekind != 0)
      
      query = query + " AND t.t_servicekind = ? ";
    
    end; 
    
    if((servicekindlist != null) AND (servicekindlist.size != 0))
      
      query = query + " AND t.t_servicekind IN ( " + GetStrToArray(servicekindlist) + " ) ";
    
    end;
                 
    if(bankdate != Date(0,0,0))
      
      query = query + " AND t.t_OpenDate <> ? AND t.t_OpenDate <= ? AND (t.t_CloseDate = ? OR t.t_CloseDate >= ?) ";
    
    end;     

    if(branch != 0)
      
      query = query + " AND t.t_Branch = ? OR t.t_InChildBranch = 'X' AND t.t_Branch IN "
                      "                                                                 (SELECT dp_dep.t_ParentCode "
                      "                                                                  from ddp_dep_dbt dp_dep "
                      "                                                                  start with dp_dep.t_Code = ? "
                      "                                                                  connect by dp_dep.t_Code = prior dp_dep.t_ParentCode) ";
    
    end;  
                 
    query = query + " ORDER BY t.t_productkindid, t.t_productid ";

    cmd = RsdCommand(query);
    
    if(productkindid != 0)
      cmd.addParam( "", RSDBP_IN, productkindid );
    end; 

    if(productdockindid != 0)
      cmd.addParam( "", RSDBP_IN, productdockindid );
    end; 

    if(servicekind != 0)
      cmd.addParam( "", RSDBP_IN, servicekind );
    end;
    
    if(bankdate != Date(0,0,0))
      cmd.addParam( "", RSDBP_IN, Date(0,0,0) );
      cmd.addParam( "", RSDBP_IN, bankdate );
      cmd.addParam( "", RSDBP_IN, Date(0,0,0) );
      cmd.addParam( "", RSDBP_IN, bankdate );
    end;
    
    if(branch != 0)
      cmd.addParam( "", RSDBP_IN, branch );
      cmd.addParam( "", RSDBP_IN, branch );
    end;
    
    cmd.NullConversion = true;
    
    rs = RsdRecordset(cmd);

    while(rs.movenext)

      p = TWsPrdProduct();

      p.ProductID        = SQL_ConvType(rs.value("t_productid"));
      p.ProductKindID    = SQL_ConvType(rs.value("t_productkindid"));
      p.Name             = SQL_ConvType(rs.value("t_name"));
      p.Branch           = SQL_ConvType(rs.value("t_branch"));
      p.InChildBranch    = SQL_ConvTypeBool(rs.value("t_inchildbranch"));
      p.ProductDocKindID = SQL_ConvType(rs.value("t_productdockindid"));
      p.OpenDate         = SQL_ConvType(rs.value("t_opendate"));
      p.CloseDate        = SQL_ConvType(rs.value("t_closedate"));
      p.ServiceKind      = SQL_ConvType(rs.value("t_servicekind"));

      resultlist[resultlist.size] = p;

    end;

    ResponseBuilder.SetUserObject(resultlist);

    return ResponseBuilder.Result;

  end;

  macro GetCount( bankdate,
                  branch,
                  productkindid,
                  productkindidlist,
                  productdockindid,
                  productdockindidlist,
                  servicekind,
                  servicekindlist, 
                  filteritems):integer

    var result : integer;
    
    var cmd, rs, p;

    var query = " SELECT count(1) c "
                " FROM dprdproduct_dbt t "
                "  WHERE 1=1 ";
    
    if(productkindid != 0)
      
      query = query + " AND t.t_productkindid = ? ";
    
    end;
    
    if((productkindidlist != null) AND (productkindidlist.size != 0))
      
      query = query + " AND t.t_productkindid IN ( " + GetStrToArray(productkindidlist) + " ) ";
    
    end; 
    
    if(productdockindid != 0)
      
      query = query + " AND t.t_productdockindid = ? ";
    
    end;
    
    if((productdockindidlist != null) AND (productdockindidlist.size != 0))
      
      query = query + " AND t.t_productdockindid IN ( " + GetStrToArray(productdockindidlist) + " ) ";
    
    end; 
    
    if(servicekind != 0)
      
      query = query + " AND t.t_servicekind = ? ";
    
    end; 
    
    if((servicekindlist != null) AND (servicekindlist.size != 0))
      
      query = query + " AND t.t_servicekind IN ( " + GetStrToArray(servicekindlist) + " ) ";
    
    end;
                 
    if(bankdate != Date(0,0,0))
      
      query = query + " AND t.t_OpenDate <> ? AND t.t_OpenDate <= ? AND (t.t_CloseDate = ? OR t.t_CloseDate >= ?) ";
    
    end;     

    if(branch != 0)
      
      query = query + " AND t.t_Branch = ? OR t.t_InChildBranch = 'X' AND t.t_Branch IN "
                      "                                                                 (SELECT dp_dep.t_ParentCode "
                      "                                                                  from ddp_dep_dbt dp_dep "
                      "                                                                  start with dp_dep.t_Code = ? "
                      "                                                                  connect by dp_dep.t_Code = prior dp_dep.t_ParentCode) ";
    
    end;  
                 
    cmd = RsdCommand(query);
    
    if(productkindid != 0)
      cmd.addParam( "", RSDBP_IN, productkindid );
    end; 

    if(productdockindid != 0)
      cmd.addParam( "", RSDBP_IN, productdockindid );
    end; 

    if(servicekind != 0)
      cmd.addParam( "", RSDBP_IN, servicekind );
    end;
    
    if(bankdate != Date(0,0,0))
      cmd.addParam( "", RSDBP_IN, Date(0,0,0) );
      cmd.addParam( "", RSDBP_IN, bankdate );
      cmd.addParam( "", RSDBP_IN, Date(0,0,0) );
      cmd.addParam( "", RSDBP_IN, bankdate );
    end;
    
    if(branch != 0)
      cmd.addParam( "", RSDBP_IN, branch );
      cmd.addParam( "", RSDBP_IN, branch );
    end;
    
    cmd.NullConversion = true;
    
    rs = RsdRecordset(cmd);

    if(rs.movenext)

      result = SQL_ConvType(rs.value("c"));

    end;

    return result;

  end;  

end;

/////////////////////////////////////////////////////////////////////////////////////////////////////////