/************************************************************************/
/*         €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 2009              */
/*                                                                      */
/*  ˆ¬ï ä ©«       : prpmorist.mac                                      */
/*                                                                      */
/*  ¯¨á ­¨¥       : ¥ç âì ¯« â¥¦­®£® ®à¤¥à  á® èâ ¬¯®¬                */
/*                                                                      */
/*  à®£à ¬¬¨áâ    : Š âîè¨­ €.€.                                       */
/*                                                                      */
/*  ‘®§¤ ­         : 07.05.09                                           */
/*                                                                      */
/************************************************************************/

import prpm, gnd120p, "prpmstamp.mac";

/* ¥ç âì ¯« â¥¦­®£® ®à¤¥à  ¯® 1256-“ */
MACRO PrintPayOrder1256(ncopy:integer):bool

  var payerProps   :TPartyProperties = TPartyProperties("Payer",    pr_pmpaym_part, pr_pmprop_part, pr_pmrmprop);
  var receiverProps:TPartyProperties = TPartyProperties("Receiver", pr_pmpaym_part, pr_pmprop_part, pr_pmrmprop);
  var ground       :string, 
      rest         :moneyl,
      shortSum     :string,
      shortRestSum :string,
      payKind      :string,
      pINN         :string,
      pKPP         :string,
      rINN         :string,
      rKPP         :string;

  var st:TArray=TArray();
  ARRAY SS, SG, SBP, SBR, SP, SR, UIN;
      
  payerProps.Name            = pr_pmrmprop_part.rec.PayerName;
  payerProps.INN             = pr_pmrmprop_part.rec.PayerINN;
  payerProps.Account         = pr_pmpaym_part.rec.PayerAccount;
  payerProps.BankName        = {Name_Bank} + ", " + {Post_Addr};
  payerProps.BankBIC         = {MFO_Bank};
  payerProps.BankCorrAccount = {CORAC_Bank};
  
  splitINN_KPP(payerProps.INN,    pINN, pKPP);
  splitINN_KPP(receiverProps.INN, rINN, rKPP);

  rest = IfThenElse( ( ( pr_pmpaym_prim.rec.PaymentID != 0 ) and ( pr_pmpaym_part.rec.DocKind == PS_PAYORDER ) ),
                     RsbPayment( pr_pmpaym_part.rec.PaymentID ).PartPaymRestAmountMain, $0.0 );

  /* ®«ãç¨¬ áã¬¬ã ®áâ âª  ¨áå®¤­®£® ¯« â¥¦­®£® ¤®ªã¬¥­â , ¥á«¨ ®­ ¥áâì */
  
  ground = InterpretGround( pr_pmrmprop_part.rec.Ground );
  
  /* ‘ã¬¬  ¤®ªã¬¥­â  ç áâ¨ç­®© ®¯« âë à §¤¥«ï¥âáï á¨¬¢®«®¬ "=", 
       áã¬¬  ®áâ âª  ¯« â¥¦  - á¨¬¢®«®¬ "-"  */
  shortSum = String(MoneyL(pr_pmpaym_part.rec.Amount));
  StrSet(shortSum, StrBrk(shortSum, ".,"), "=");

  shortRestSum = string(rest);
  if( (rest == $0.0) or (StrBrk(shortRestSum, ".,") == 1) )
    shortRestSum = "0" + shortRestSum;
  end;
  StrSet(shortRestSum, StrBrk(shortRestSum, ".,"), "-");
  
  if( pr_pmpaym_part.rec.PartPaymNumber == 0 )
    shortRestSum = "";
    payKind      = "";
  else
    payKind = "— áâ¨ç­ ï ®¯« â ";
  end;


  strsplit( PayerProps.Name ,                       SP,  44, 44, 4 );
  strsplit( PayerProps.BankName,                    SBP, 44, 44, 3 );
  strsplit( ReceiverProps.Name,                     SR,  44, 44, 4 );
  strsplit( ReceiverProps.BankName,                 SBR, 44, 44, 3 );
  strsplit( RubToStrAlt(pr_pmpaym_part.rec.Amount), SS,  68, 68, 3 );
  strsplit( ground,                                 SG,  51, 51, 4 );
  strsplit( GetUIN( pr_pmrmprop.rec.Date, pr_pmrmprop.rec.UIN, pr_pmpaym.rec.PayType ), UIN, 13, 13, 2 );

  st=Stamp();

  if(not pr_pmrmprop_part.rec.TaxAuthorState)
    pr_pmrmprop_part.rec.BttTICode   =
    pr_pmrmprop_part.rec.OKATOCode   =
    pr_pmrmprop_part.rec.TaxPmGround =
    pr_pmrmprop_part.rec.TaxPmPeriod =
    pr_pmrmprop_part.rec.TaxPmNumber =
    pr_pmrmprop_part.rec.TaxPmDate   =
    pr_pmrmprop_part.rec.TaxPmType   = "";
  end;

  while(ncopy != 0)
    [
                                                                           ÚÄÄÄÄÄÄÄÄÄ¿
                                                                           ³ 0401066 ³
                                                                           ÀÄÄÄÄÄÄÄÄÄÙ

                                             ##########  #############          ÚÄÄÄÄ¿
      ‹€’…†›‰ „… N ###################  ÄÄÄÄÄÄÄÄÄÄ  ÄÄÄÄÄÄÄÄÄÄÄÄÄ          ³ ## ³
                                                („ â )   (‚¨¤ ¯« â¥¦ )          ÀÄÄÄÄÙ

     ÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ‘ã¬¬    ³#############################################################################
      ¯à®¯¨áìî³#############################################################################
              ³#############################################################################
     ÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ˆ ########### ³ Š #########                      ³‘“ŒŒ€  ³#########################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
                                                           ³       ³
      ##################################################   ³       ³
      ##################################################   ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ##################################################   ³‘ç.N.  ³#########################
      ##################################################   ³       ³
      ‹€’…‹œ™ˆŠ                                           ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ##################################################   ³ ˆŠ   ³#########################
      ##################################################   ÃÄÄÄÄÄÄÄ´
      ##################################################   ³ ‘ç.N. ³#########################
      €Š ‹€’…‹œ™ˆŠ€                                     ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ##################################################   ³ ˆŠ   ³#########################
      ##################################################   ÃÄÄÄÄÄÄÄ´
      ##################################################   ³ ‘ç.N. ³#########################
      €Š ‹“—€’…‹Ÿ                                      ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ˆ ########### ³ Š #########                      ³ ‘ç.N. ³#########################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
                                                           ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄ
      ##################################################   ³‚¨¤ ¯.³####         ³ç¥à.¯«.³###
      ##################################################   ³       ³             ³        ³
      ##################################################   ÃÄÄÄÄÄÄÄ´             ÃÄÄÄÄÄÄÄÄ´
      ##################################################   ³ §.¯«.³             ³¥§.¯®«¥³
      ®«ãç â¥«ì                                           ³       ³             ³        ³
     ÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´             ³        ³
      N ç.   ³ ˜¨äà ¯« â. ³   N ¯« â.        ³  „ â  ¯« â. ³ Š®¤   ³#############³        ³
      ¯« â.  ³  ¤®ª.      ³   ¤®ª.           ³   ¤®ª.      ³       ³#############³        ³
             ³            ³                  ³             ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄ
      ###    ³  ######    ³ ###############  ³  ########## ³ ‘ã¬¬  ³ 
     ÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄ´®áâ.¯«.³ #########################
      ‘®¤¥à¦ ­¨¥ ®¯¥à æ¨¨        ################          ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄ
      #################### ³ ########### ³ ## ³ ########## ³ ############### ³ ########## ³ ##
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄ
         §­ ç¥­¨¥ ¯« â¥¦                                          ³ â¬¥âª¨ ¡ ­ª 
       ########################################################### ³ ##########################
                                                                     ##########################
                                                                     ##########################
                                                                     ##########################
                                                                     ##########################
                                                                     ##########################
                                                                     ##########################
    
    ]
     (replace(string(pr_pmrmprop_part.rec.Date:f/*pr_pmpaym_part.rec.ValueDate:f*/), "-", "."):c, 
      GetPaymentKind(pr_pmrmprop_part.rec.PaymentKind):c, 
      pr_pmrmprop_part.rec.Number:l, pr_pmrmprop_part.rec.TaxAuthorState, SS(0):l, SS(1):l, SS(2):l,
      pINN, pKPP, pr_pmpaym_part.rec.Amount:l:f,
      SP(0):l, SP(1):l, SP(2):l, PayerProps.Account:l, SP(3):l,
      SBP(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,PayerProps.BankBIC):l,    SBP(1):l, SBP(2):l, PayerProps.BankCorrAccount:l,
      SBR(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,ReceiverProps.BankBIC):l, SBR(1):l, SBR(2):l, ReceiverProps.BankCorrAccount:l,
      rINN, rKPP, ReceiverProps.Account:l,
      SR(0):l, pr_pmrmprop_part.rec.ShifrOper:l, pr_pmrmprop_part.rec.Priority:l,
      SR(1):l, SR(2):l, SR(3):l, 
      UIN(0),
      UIN(1),
      /*pr_pmpaym_part.rec.SubPurpose:l*/ pr_pmpaym_part.rec.PartPaymNumber:l,
      pr_pmrmprop_prim.rec.ShifrOper:c, 
      pr_pmrmprop_prim.rec.Number:c, 
      replace(string(pr_pmrmprop_prim.rec.Date:f), "-", "."):c, 
      shortRestSum:l, payKind:l, 
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.BttTICode,   ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.OKATOCode,   ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.TaxPmGround, ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.TaxPmPeriod, ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.TaxPmNumber, ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.TaxPmDate,   ""),
      IfThenElse(pr_pmrmprop_part.rec.TaxAuthorState, pr_pmrmprop_part.rec.TaxPmType,   ""),
      ground:l:w, st(0):c, st(1):c, st(2):c, st(3):c, st(4):c, st(5):c, st(6):c);


    ncopy = ncopy - 1;
  end;
  
  return TRUE;
  
END;

MACRO PrintPayOrder(ncopy:integer):bool
  return PrintPayOrder1256(ncopy);
END;