import  BankInter, PTInter, dlquery;;

private record pidc( persnidc );
private record address( adress );
private record objrgdoc( objrgdoc );

macro ПроверитьЮрЛицо(RsbPartyObj, Fnum)
  return true;
end;


macro ПроверитьФизЛицо(RsbPartyObj, Fnum)
  return true;
end;


macro ПроверитьУдостоверение(RsbPartyObj, idc, Fnum)
  setbuff( pidc, idc );
  return true;
end;

/**
 @brief Проверить поле адреса
 @param[in] RsbPartyObj Объект RsbParty к которому относится адрес
 @param[in] adr Адрес памяти с объектом adress
 @param[in] Fnum Номер поля в панели
 @return true если изменение разрешено
 @return false если изменение запрещено
*/
macro ПроверитьПолеАдреса(RsbPartyObj, adr, Fnum)
  setbuff( address, adr );
  var EnableCDI = false;
  var error  = 0;

  private const C_CATEGORY_CDI_BLOCKED = 175;
  private const C_CATEGORY_CDI_BLOCKED_YES = 1;

  GetRegistryValue( "РСХБ\\ИНТЕГРАЦИЯ\\ВЗАИМОДЕЙСТВИЕ С AC CDI\\АКТИВНО", V_BOOL, EnableCDI, error );
  if (EnableCDI and ((address.TYPE == 1) or (address.TYPE == 2) or (address.TYPE ==3)) )
        var IsBlockedInCDI = false;
        if (EnableCDI)
          if ( RsbPartyObj.IsOwned(PTK_BANK) or RsbPartyObj.IsOwned(PTK_MARKETPLASE) )
             IsBlockedInCDI = true;
          else 
             //IsBlockedInCDI = RsbPartyObj.Category.IsAttrPresense(C_CATEGORY_CDI_BLOCKED, C_CATEGORY_CDI_BLOCKED_YES, null, null, false, date());
             var sql_category  = " select count(*) cnt from dobjatcor_dbt objcor "+
                                 "  where objcor.t_objecttype = :objtype and objcor.t_object = lpad(:partyid,10,'0') and objcor.t_validtodate = to_date('31.12.9999','dd.mm.yyyy') "+
                                 "    and objcor.t_groupid = :groupid and objcor.t_attrid = :attrid ";
             var cmd_category = RSDCommand(sql_category);
             cmd_category.Addparam("objtype", RSDBP_IN, 3);
             cmd_category.Addparam("partyid", RSDBP_IN, String(RsbPartyObj.PartyID:o:10));
             cmd_category.Addparam("groupid", RSDBP_IN, C_CATEGORY_CDI_BLOCKED);
             cmd_category.Addparam("attrid", RSDBP_IN, C_CATEGORY_CDI_BLOCKED_YES);
             var rs_category = RSDRecordSet(cmd_category);
             if (rs_category.movenext())
                if (rs_category.value("cnt") == 1)
                   IsBlockedInCDI = true;
                end;
             end;
          end;
        end;

        var cmd, DS;
        cmd = RSDCommand( "SELECT * FROM DADRESS_DBT WHERE T_PARTYID = ? AND T_TYPE = ? ");
        
        cmd.addParam( "", RSDBP_IN, address.PARTYID );
        cmd.addParam( "", RSDBP_IN, address.TYPE );
        cmd.execute();

        DS = TRsbDataSet(cmd);
        if( DS.MoveNext() and (not IsBlockedInCDI) ) //Если адрес уже существует, редактирование запрещено
          msgbox("Редактирование адреса запрещено");
          return false;
        end;
  end;


  return true;
end;


macro ПроверитьРегДокумент(RsbPartyObj, rgdoc, Fnum)
  setbuff( objrgdoc, rgdoc );
  return true;
end;
