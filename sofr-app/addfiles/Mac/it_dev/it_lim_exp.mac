/*
$Name: it_lim_exp.mac 
$Module: Главная книга
$Description: Планировщик - Сохранение файла лимитов для выгрузки в QUIK на диск
*/
/* 
  it_lim_exp.mac 
  Планировщик - Сохранение файла лимитов для выгрузки в QUIK на диск
  ---------------------------------------------------------------------------------------------------
   Изменения:
  ---------------------------------------------------------------------------------------------------
  Дата        Автор            Jira                          Описание 
  ----------  ---------------  ---------------------------   ----------------------------------------
  17.10.2023  Зыков М.В.       BOSS-358                      BIQ-13699.2. СОФР. Этап 2 - добавление файла ограничений по срочному рынку в обработку IPS
  03.10.2022  Тютюнник С.С.    BIQ-11358                     Меняем нейминг согласно DEF-31102
  07.09.2022  Зыков М.В.       BIQ-11358                     Загрузка файла глобальных лимитов
  25.04.2022  Мелихова О.С.    BIQ-11358                     Создание
 */
import RsbDataSet; 
import cbreport_h;
import gtImMVB_DL,rsexts;
import "simpleservice.mac";

macro Clear_Dir(filepath, filemask)
  var datafilename, ilist;
  var List = TDirList(filepath + filemask + ".*", "f");
  println("Удаление файлов " + filepath + filemask + ".*");
  List.Sort(0);
  if (list.Count == 0)
    datafilename = "";
    println("Не найден файл по маске " + filepath + filemask + ".*");
  else
    ilist = 0;
    while(ilist < List.Count)
      datafilename = List.name(ilist);
      RemoveFile(filepath + datafilename);
      ilist = ilist + 1;
    end;
  end;
end;

private macro err_msg(err)
   var count = 0, str = "", i = 0;
   if (err.Err)
      if (IsEqClass ("TRsComErr", err.err))
         count = err.err.Count;
         i = 0;
         while (i < count)
            str = string(str, err.err.Message(i), " (Code = ",err.err.Code(i), ", Level = ",err.err.Level(i), ")", strfor(10));
            i = i + 1
         end;
         str = str + " " + err.Module + " " + err.Line + " " + err.Message;
      elif (valtype(err.err) == v_string)
         str = err.err + " " + err.Module + " " + err.Line + " " + err.Message;
      else
         str = err.Module + " " + err.Line + " " + err.Message;
      end;    
   else
      str = err.Module + " " + err.Line + " " + err.Message;
   end;
   return str;
end;

macro delete_file_lim_quik()
  var rs, cmd;
  
  var  v_cnt_day, errcode, err;
  GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\IT_DEV\\IT_LIM_EXP_DEL_DAY", V_INTEGER, v_cnt_day, errcode);  //глубина удаляемых дней
  if (errcode != 0 )
    v_cnt_day = 0;
  end;
  if (v_cnt_day!=0)    
    cmd = RsdCommand("begin it_lim_exp.delete_file_lim_quik(?); end;");  

    cmd.addParam("p_day_count", RSDBP_IN,v_cnt_day);
    cmd.execute();
    println("Удаление файлов глубиной "+v_cnt_day+" дней выполено успешно");
  end;
  
onerror(e)                
  errcode = err_msg(e,null);
 // msgbox(errcode);

  runerror(errcode,errcode);
  return -1;  
end;

macro chk_filegl(p_file):bool
  var v_n,v_filegltmp,v_listfiletmp;
  for (v_n, 1, 100)
    v_filegltmp = p_file+"_"+v_n ;
    v_listfiletmp = tdirlist (v_filegltmp,"f");
    if (v_listfiletmp.count == 0)
      break;
    end;
  end;
  if (not renamefile (p_file, v_filegltmp))
    return false;    
  end; 
  v_listfiletmp = tdirlist (v_filegltmp,"f");
  if (v_listfiletmp.count == 0)
    return false;    
  end;
  if (not renamefile (v_filegltmp,p_file))
    println("ошибка переименования  "+v_filegltmp+" имя файла "+p_file+" изменено !");    
    return false;    
  end; 
  v_listfiletmp = tdirlist (p_file,"f");
  if (v_listfiletmp.count == 0)
    println("ошибка переименования  "+v_filegltmp+" имя файла "+p_file+" изменено !");    
    return false;    
  end;
  return true;
end;

macro RunExp() 
  var cmd, rs,  v_id_lim, v_str_dt_file, v_err_str,err, errcode;
  var v_id_file, v_clob;
  
  var v_date : date = date; 
  var v_mon, v_day, v_year;
  var v_hour, v_min, v_sec;
  var res = SS_RESPONSE_END;

  DateSplit (v_date, v_day, v_mon, v_year );
  TimeSplit(time(),v_hour, v_min, v_sec);

  v_str_dt_file = string( v_year,  v_mon:2:o, v_day:2:o, "_", v_hour:2:o, v_min:2:o, v_sec:2:o);
  println("начало рачета "+time());                                

  var v_filemask  : string = "QuikLimit"; //Меняем нейминг согласно DEF-31102
  var v_FileName  : string = v_filemask + v_str_dt_file; 
  var v_file_lim  : string = v_FileName + ".lim";
  var v_file_done : string = v_FileName + ".done";
 
  var  v_path1, v_path2, c,v_pathgl,v_maskgl,v_n;
  
  BegAction(1, "Формирование файла лимитов. Ждите...");

  GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\IT_DEV\\IT_LIM_IMP_DIR_GLOBAL", V_STRING, v_pathGL, errcode);  //Путь к файлу глобальных лимитов
  if (errcode != 0 )
    v_pathgl =  "..\\Tmp\\"; 
  else 
    v_pathgl = v_pathgl + "\\";
  end;


  GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\IT_DEV\\IT_LIM_IMP_FILE_GLOBAL", V_STRING, v_maskGL, errcode);  //Маска файла с глобальными лимитами 
  if (errcode != 0)
    v_maskgl =  "g*.lim"; 
  else
    v_maskgl =  trim(v_maskgl); 
  end;
  var v_listfile,v_listfiletmp, v_filegl, v_filegltmp,v_streamgl,v_bstr,v_fopen ;
  v_listfile = tdirlist ((v_pathgl+v_maskgl),"f");
  if (v_listfile.count > 0)
    v_listfile.sort (2); // по дате изменения
    v_filegl = v_pathgl+v_listfile.name(0); // Последний файл
    println("Проверка файла глобальных лимитов "+v_filegl) ;

    if (not chk_filegl(v_filegl))
      println("Ошибка открытия файл глобальных лимитов "+v_filegl);  
      res = SS_RESPONSE_FATAL;  
    else 
      println("Загрузка файла глобальных лимитов "+v_filegl) ;
      v_streamgl = tstreamdoc(v_filegl,"R");
      // Очистка буфера
      cmd = RsdCommand(" begin " +
             " it_rsl_string.clear; " +
             " end;");
      cmd.execute();
      // Наполняем буфер из файла    
      v_bstr="";
      while (v_StreamGL.ReadLine())
        if (StrLen(v_bstr + v_StreamGL.str) > 32676)
          cmd = RsdCommand(" begin " +
             " it_rsl_string.append_varchar(?); " +
             " end;");
          cmd.addParam("", RSDBP_IN, v_bstr);
          cmd.execute() ;
          v_bstr="";
        end;
        v_bstr = v_bstr + v_StreamGL.str+StrFor(13)+StrFor(10);
      end;
      if (StrLen(v_bstr) > 0)
        v_bstr = SubStr(v_bstr,1,StrLen(v_bstr)-2);
        cmd = RsdCommand(" begin " +
             " it_rsl_string.append_varchar(?); " +
             " end;");
        cmd.addParam("", RSDBP_IN, v_bstr);
        cmd.execute() ;
      end;
      cmd = RsdCommand(" begin " +    
        " it_lim_exp.add_global_limit (?,?,it_rsl_string.get_clob,?);"
             " end;");
      cmd.addParam("p_file_dir", RSDBP_IN,v_pathgl);     
      cmd.addParam("p_file_name", RSDBP_IN,v_listfile.Name(0));     
      cmd.addParam("o_state", RSDBP_OUT,V_STRING);     
      cmd.execute() ;           
      println(cmd.value("o_state"));       
    end;
  else
    res = SS_RESPONSE_FATAL;
    println("Файл глобальных лимитов не найден ");    
  end;

 
 /* GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\IT_DEV\\IT_LIM_EXP_DIR_BUF", V_STRING, v_path1, errcode);  //буферная таблица
  if (errcode != 0 )
    v_path1 =  "..\\TxtFile\\"; 
  else 
    v_path1 = v_path1 + "\\";
  end;

  GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\IT_DEV\\IT_LIM_EXP_DIR_SHARE", V_STRING, v_path2, errcode);   //шара

  if (errcode != 0 )
    v_path2 =  "$\\\\10.7.44.6\\quik\\";  
  else
    v_path2 = v_path2 + "\\";
  end;


  //Удаление из каталогов ранее созданные файлы лимитов
  Clear_Dir(v_path2, v_filemask);
 */
  var v_file_keep_day_cnt;
  GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\IT_DEV\\IT_LIM_EXP_DEL_DAY", V_INTEGER, v_file_keep_day_cnt, errcode);  //количество дней удаляемых файлов
  if (errcode != 0 )
    v_file_keep_day_cnt = 0; 
  end;

 
  cmd = RsdCommand("begin ?:= it_lim_exp.execute_process(?,?,?); end;");
  
  cmd.addParam("v_id_lim", RSDBP_OUT,V_INTEGER);
  cmd.addParam("v_date", RSDBP_IN,v_date ); // {curdate});  DEF-44986
  cmd.addParam("p_file_keep_day_cnt", RSDBP_IN,v_file_keep_day_cnt);
  cmd.addParam("v_mestxt", RSDBP_OUT,V_STRING,32700);
  
  cmd.execute();
  v_id_lim = cmd.value(0);
  println(cmd.value("v_mestxt")) ;
  println();
  if (v_id_lim != 0 )
    println("Формирование данных выполнено "+time());
  else
    res = SS_RESPONSE_FATAL;
    println("Формирование данных ВЫПОЛНЕНО С ОШИБКАМИ "+time());
  end ;

 
 /*
   println("расчет готов "+time());
  cmd = RsdCommand("declare "+
                     "v_clob clob; "+
                     "v_note varchar2(4000); "+
                   "begin " +
                       " it_lim_exp.get_last_file_lim_quik(?, v_clob, ?,v_note);"+
                       " it_rsl_string.clear; "+
                       " ? := it_rsl_string.set_clob(v_clob,32767); "+
                   "end; ");
  cmd.addParam("v_date",RSDBP_IN, v_date);    
  cmd.addParam("v_id_file",RSDBP_OUT,V_INTEGER); 
  cmd.addParam("result_array_count", RSDBP_OUT, V_INTEGER);  
  cmd.execute();

  var v_result_array_count = cmd.value("result_array_count");
      v_id_file = cmd.value("v_id_file");
  var v_index = 1; 
  var v_result;                                     

  println ("выгрузка clob файла лимитов. Ждите..."+ time());
  setoutput(v_path1 + v_file_lim, true);

  while ( v_index <= v_result_array_count )
    cmd = RsdCommand(" begin " +
                     "   ? := it_rsl_string.get_varchar(?,32767); " +
                     " end;");
                           
    cmd.addParam("v_result", RSDBP_OUT, V_STRING,32768);
    cmd.addParam("p_index ", RSDBP_IN, v_index);
    cmd.execute();
    v_result = cmd.value("v_result");

    print(v_result);
    
    v_result = null;
    v_index = v_index + 1;
  end;
  SetOutput(null, true );
  println ("выгрузка clob файла лимитов окончена "+ time());

  //SAVE CLOB FILE
 var v_xml;
 
  v_xml ="<XML file_dir=\"" + v_path1+v_file_lim +"\" file_name= \"" + v_file_lim + "\" id_file=\""+v_id_file+"\" />";

  println(v_xml);
  println ("Сохранение файла лимитов в таблицу. Ждите..."+ time());
  
  EndAction();
  BegAction(1, "Сохранение файла лимитов. Ждите...");
  testevent(5000);
 
  cmd = RsdCommand("begin "+
           "? := it_lim_exp.ins_file_save(p_xml => ?);" +
         "end;");

  cmd.AddParam("v_result",RSDBP_OUT,V_INTEGER);
  cmd.AddParam("v_xml",RSDBP_IN,v_xml);

  cmd.execute();
  println ("Сохранение файла лимитов в таблицу закончено"+ time());
  println ("Копирование файла лимитов на шару "+ time());


  ///////////////////////! Первый вариант копирвоания !!!//////////////////
  if(not CopyFile(v_path1+v_file_lim, v_path2+"QuikLimit.lim"))  //Меняем нейминг при копировании согласно DEF-31102
    println("Ошибка копирования файла " + v_path1 + v_file_lim + " в " + v_path2 + "QuikLimit.lim" + " "+time());
  else
    println("Файл " +  v_path1 + v_file_lim + " скопирован в " + v_path2 + "QuikLimit.lim" + " "+time());
    RemoveFile(v_path1 + v_file_lim);
  end;  
  
  println("Создаем файл " + v_path1 + v_file_done +" "+time());

  SetOutput(v_path1 + v_file_done, true);
  println("");
 
  SetOutput(null, true);

  
  if(not CopyFile(v_path1 + v_file_done, v_path2 + "QuikLimit.done") ) //Меняем нейминг при копировании согласно DEF-31102
    println("Ошибка копирования файла " + v_path1 + v_file_done + " в " + v_path2 + "QuikLimit.done" + " "+time());
  else
    println("Файл " + v_path1 + v_file_done + " скопирован в " + v_path2 + "QuikLimit.done" + " "+time());
    // RemoveFile(ReportFileName2);
  end;
  println ("Копирование файла лимитов на шару закончено "+ time());            

 */ 

  EndAction();
  Return SsExecResult(res);

 // println("\n BEFORE quik.bat");
 // run("..\\mac.usr\\it_dev\\quik.bat");
 // println("AFTER quik.bat \n");

 // println("выгрузка готова "+time());

onerror(e)
  v_err_str = err_msg(e, null);
  msgbox(v_err_str);

  runerror(v_err_str,v_err_str);
  return -1; 
end;

//RunExp();

