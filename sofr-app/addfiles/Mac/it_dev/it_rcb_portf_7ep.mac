/*
$Name: it_rcb_portf_7ep.mac 
$Module: Главная книга
$Description: Анкета обследования брокерских компаний по портрету клиента
*/
IMPORT rslx, RsbFormsInter;
IMPORT dv_fun;

macro RunReport()
  var rslDefCon;
  var CreateDate = date();
  var CreateTime = time();
  var ReportDate :date = {CurDate};
  var day,mon,year, hour,min, sec;
  DateSplit(date(),day,mon,year);
  TimeSplit(time(),hour,min,sec);

  var FileName, FileDir;
  var resultSize,resultStr, FileID, statA, idx; 
  var obj, ob, wBook, wSheet;

  FileName = "Report_cb_7_ep_"+year+string(mon :f)+string(day :f)+"_"+hour+min+sec;
  FileDir = "..\\txtfile\\";
 
  BegAction(1, "Формирование Анкеты обследования брокерских компаний по портрету клиента. Ждите...");
  
  rslDefCon = RsdCommand("declare"+
                 " v_cl 	clob;"  +
                 " v_idFile integer;"  +
                " begin "+
	            " v_idFile := it_rcb_portf_7ep.run(to_date('01.01.2022','dd.mm.yyyy'),to_date('30.06.2022','dd.mm.yyyy'));"+
		     " select file_clob into v_cl from ITT_FILE  where id_file = v_idFile ; "+
		    " it_rsl_string.clear; "+
		    " ? := it_rsl_string.set_clob(v_cl);"+
		    " end; ");		
  rslDefCon.addParam("result_size", RSDBP_OUT,V_INTEGER);
  rslDefCon.execute();

  resultSize = rslDefCon.value("result_size");
  idx = 1;
  println("Формирование .csv файла "+time());

  setoutput(FileDir+FileName+".csv",true);
  
  while(idx <= resultSize)
    rslDefCon = RsdCommand(" begin "+
			               " ? := it_rsl_string.get_varchar(?); "+
   			               " end;" );
    rslDefCon.addParam("v_result",RSDBP_OUT,V_STRING, 32768);
    rslDefCon.addParam("p_index",RSDBP_IN,idx);
    rslDefCon.execute();
    
    resultStr = rslDefCon.value("v_result");
    print(ToANSI(resultStr,true));
    resultStr = null;
    idx = idx + 1;
  end;
  setoutput(null,true);
  println("формирование файла .csv окончено "+time());
  
  EndAction();

  msgbox("формирование файла "+FileDir+FileName+".csv окончено.")
onerror(e)
  msgbox(e.msg);
end;

RunReport();


      