//IMPORT rslx, RsbFormsInter;
IMPORT dv_fun,it_utils;

macro RunReport()
  var CreateDate = date();
  var CreateTime = time();
  var ReportDate :date = {CurDate};
  var day,mon,year, hour,min, sec, resXML,resClob, id_pack = "" , id_file,XMLNode,XMLdetail;
  var msg,idx;
  var num_part,calc_error = false ;

 
  DateSplit(date(),day,mon,year);
  TimeSplit(time(),hour,min,sec);

  var FileName, FileDir;
 
  FileDir = "..\\txtfile\\";
  
  if (not GetDate(ReportDate,"Введите дату отчета 6ЭП"))
    return;
  end;

  if (not SelectFolder(@FileDir,  FileDir+"...", "Укажите путь выгрузки отчета 6ЭП и файлов детализации ",true)) 
    return;
  end;
  FileDir=FileDir+"\\";
  InitProgress(-1,"","Формирование отчета по форме ЦБ 6-ЭП. Ждите...");

  println(time()+"  Старт расчета ");
 
  var cmd = RsdCommand(" declare v_clob clob; v_cnt integer ;"+
                       " begin it_rsl_string.clear;"+
                       " v_clob:= it_rcb_portf_by_cat.run(?);"+
                       " it_rsl_string.set_clob(v_clob);"+
                       " end;" );
  cmd.AddParam("",RSDBP_IN, ReportDate);
  cmd.execute();
  println(time()+"  Выгрузка результирующего XML");
  resClob = IT_GetClobBufer() ; 

  //resClob = "<XML id_rep_pack=\x224929704\x22 id_file_by_cat=\x224929704\x22><file_detail part=\x221\x22 id_file_detail=\x224929705\x22></file_detail><file_detail part=\x222\x22 id_file_detail=\x224929706\x22></file_detail></XML>" ;

  resXml =IT_XMLReader() ;
  if (resXml.Load(resClob))
     XMLNode = resXml.getXML().getElementsByTagName("SOFRError");
     if(XMLNode.Length ==  0)
       XMLNode = resXml.getXML().getElementsByTagName( "XML" );
       if((XMLNode != null) and (XMLNode.Length > 0))
         id_file = XMLNode.Item(0).getAttribute("id_file_by_cat");
         id_pack = XMLNode.Item(0).getAttribute("id_rep_pack");
         if(StrLen(id_file) > 0)
           println(time()+"  Импорт в Excel отчета по форме ЦБ 6-ЭП ");
           if (IT_FILE_CSVtoXLS(id_file,"it_rcb_portf_by_cat.xlsx","bodyline",@msg,FileDir))
             println(time()+ "  "+msg);
             XMLdetail = XMLNode.Item(0).getElementsByTagName("file_detail");
             if((XMLdetail != null) and (XMLdetail.Length > 0))
               RemProgress() ;
               InitProgress(int(XMLdetail.Length),"",("Формирование (по 500K строк) детализации по форме ЦБ 6-ЭП"));
               for (idx, 0, (int(XMLdetail.Length)-1))
                 id_file = XMLdetail.Item(idx).getAttribute("id_file_detail");
                 num_part = XMLdetail.Item(idx).getAttribute("part");
                 if(StrLen(id_file) > 0)
                   println(time()+"  Импорт в Excel детализации отчета часть "+num_part+"/"+string(XMLdetail.Length));
                   if ( not IT_FILE_CSVtoXLS(id_file,"it_rcb_portf_by_cat_detail.xlsx","bodyline",@msg,FileDir))
                     calc_error = true;
                   end;
                   println(time()+ "  "+msg);
                 else
                   println(time()+"  ОШИБКА ФОРМАТА XML ");
                 end;
                 useprogress ((idx+1));
               end;
             else
               println(time()+"  ОШИБКА ФОРМАТА XML ");
               calc_error = true ;
             end;
           else
             println(time()+ "  "+msg);
             calc_error = true ;
           end;
         else
           println(time()+"  ОШИБКА ФОРМАТА XML ");
           calc_error = true ;
         end;
       else
         println(time()+"  ОШИБКА ФОРМАТА XML ");
         calc_error = true ;
       end;
     else
       println(time()+"  ОШИБКА РАСЧЕТА ДАННЫХ "+ XMLNode.Item(0).Text);
       calc_error = true ;
     end;
  else
    println( time()+"  ОШИБКА ОТКРЫТИЯ РЕЗУЛЬТИРУЮЩЕГО XML");
    calc_error = true ;
  end;
  if ( not calc_error and (StrLen(id_pack) > 0) )
     println(time()+"  Удаление промежуточных расчетов");
     cmd = RsdCommand( " begin it_rcb_portf_by_cat.clear_report(?); end;" );
     cmd.AddParam("",RSDBP_IN, int(id_pack));
     cmd.execute();
  end;
  println(time()+"  Финиш");
  RemProgress() ;
end;

RunReport();
