/* Конвертация компенсации */

import deprintr,opercode,denomin;

file Dep( "depositr.dbt" ) key 1; 
file Doc( "sbdepdoc.dbt" ); /* файл документов */
file AuxInfo( "auxinfo.dbt" ) write;
file DepType( "sb_dtyp.dbt" ) key 2;
file OpType( "sb_typop.dbt" ) key 0;

record CompInfo( "auxinfo.2" );

const
  D_AR            = 8,    /* проводка в архиве      */
  D_ARC           = 9,    /* корректировка в архиве */
  D_AUDIT_STORN   = 14,   /* Сторнирование операции */
  D_AUDIT_DELETE  = 15,   /* Удаление операции      */
  D_AUDIT_CORRECT = 16,   /* Корректировка операции */
  D_DELETE        = 2;


/*---------- Коды возврата макроса --------------------------------------*/
 const  OK_RES   =  0,  /* продолжать проводку */
        SKIP_RES =  1,  /* пропустить выполнение предопределенного модуля */
        END_RES  =  2,  /* завершить проводку */
        ERR_RES  = -1,  /* аваpийно завершить проводку */

        AT_Compensation = 10;

var
  NRecs = 0,
  Branch = NumFNCash;

macro GetSums;

  Var
    found,
    CreditSum=$0, DebetSum=$0;

  CheckDenom(Dep.Referenc);
  KeyNum(doc,3);
  doc.Referenc = Dep.Referenc;
  doc.TypeOper = Зачисление_В_Пак_Режиме;
  doc.DepDate_Document = Dep.Open_Date; /* дата открытия счета */
  if(GetGE(doc))
    found=True;
    while((doc.Referenc == Dep.Referenc) AND
          (doc.TypeOper == Зачисление_В_Пак_Режиме) AND
          (found == True))
      if((doc.ApplType==AT_Compensation)
          AND (doc.KindOp != D_AR)             /* проводка в архиве      */
          AND (doc.KindOp != D_ARC)            /* корректировка в архиве */
	  AND (doc.KindOp != D_AUDIT_STORN)    /* Сторнирование операции */
	  AND (doc.KindOp != D_AUDIT_DELETE)   /* Удаление операции      */
	  AND (doc.KindOp != D_AUDIT_CORRECT)  /* Корректировка операции */
	  AND (doc.Action != D_DELETE))
        CreditSum = CreditSum+Den(doc.InSum,doc.DepDate_Document);
      end;
      if (not Next(doc))
        found=False;
      end;/* IF */
    end; /* WHILE */ 
  end; /* IF */

  doc.Referenc = Dep.Referenc;
  doc.TypeOper = Зачисление_Компенсации;
  doc.DepDate_Document = Dep.Open_Date; /* дата открытия счета */
  if(GetGE(doc))
    found=True;
    while((doc.Referenc == Dep.Referenc) AND
          (doc.TypeOper == Зачисление_Компенсации) AND
          (found == True))
        if((doc.KindOp != D_AR)             /* проводка в архиве      */
            AND (doc.KindOp != D_ARC)            /* корректировка в архиве */
  	    AND (doc.KindOp != D_AUDIT_STORN)    /* Сторнирование операции */
	    AND (doc.KindOp != D_AUDIT_DELETE)   /* Удаление операции      */
	    AND (doc.KindOp != D_AUDIT_CORRECT)  /* Корректировка операции */
	    AND (doc.Action != D_DELETE))
          CreditSum = CreditSum+Den(doc.InSum,doc.DepDate_Document);
        end;
        if (not Next(doc))
          found=False;
        end;/* IF */
      end; /* WHILE */ 
    end; /* IF */

    doc.Referenc = Dep.Referenc;
    doc.TypeOper = Выдача_Компенсации;
    doc.DepDate_Document = Dep.Open_Date; /* дата открытия счета */
    if(GetGE(doc))
      found=True;
      while((doc.Referenc == Dep.Referenc) AND
          (doc.TypeOper == Выдача_Компенсации) AND
          (found == True))
      if((doc.KindOp != D_AR)             /* проводка в архиве      */
         AND (doc.KindOp != D_ARC)            /* корректировка в архиве */
         AND (doc.KindOp != D_AUDIT_STORN)    /* Сторнирование операции */
         AND (doc.KindOp != D_AUDIT_DELETE)   /* Удаление операции      */
         AND (doc.KindOp != D_AUDIT_CORRECT)  /* Корректировка операции */
         AND (doc.Action != D_DELETE))
        DebetSum = DebetSum+Den(doc.OutSum,doc.DepDate_Document);
      end;/* IF */
      if (not Next(doc))
        found=False;
      end;/* IF */
    end; /* WHILE */
  end; /* IF */

  SetRecordAddr( CompInfo, AuxInfo, 0, 0, true );
  CompInfo.Credit = CreditSum;
  CompInfo.Debet  = DebetSum;
  CompInfo.Rest   = CreditSum - DebetSum;
  return ( CreditSum != $0 ) or ( DebetSum != $0 );
end;

macro TreatAccount

  ClearRecord( AuxInfo );
  AuxInfo.Reference = Dep.Referenc;
  AuxInfo.InfoType = 3;
  AuxInfo.FNcash = Branch;
  if ( GetSums )
    Insert( AuxInfo );
    [ ######################### ############ ################ ################# ################ ]
    (
       Dep.Account,
       Dep.Type_Account,
       CompInfo.Credit,
       CompInfo.Debet,
       CompInfo.Rest 
     );
  end;
end;

macro CheckDepType

  OpType.IsCur = 0;
  OpType.Kind = DepType.Kind;
  OpType.NumOpert = Выдача_Компенсации;
  return GetEQ( OpType );
end;

macro TreatDepType

  var
    RecFound;

  ClearRecord( Dep );
  Dep.IsCur = 0;
  Dep.FNCash = Branch;
  Dep.Open_Close = StrFor( 0 );
  Dep.Type_Account = DepType.Kind;
  RecFound = GetGE( Dep );
  while ( RecFound 
    and ( Dep.IsCur == 0 )
    and ( Dep.FNCash == Branch )
    and ( Dep.Open_Close == StrFor( 0 ) )
    and ( Dep.Type_Account == DepType.Kind ) )
    Message( "Обработано ", NRecs, " счетов" );
    TreatAccount;
    NRecs = NRecs + 1;
    RecFound = Next( Dep );
  end;
end;

  ClearRecord( DepType );
  [ ];
  [ Конвертация зачисленных компенсаций ];
  [ ];
  [--------------------------------------------------------------------------------------------];
  [ Счет                      Вид вклада   Зачислено        Списано           Остаток          ];
  [--------------------------------------------------------------------------------------------];
  while ( Next( DepType ) and ( DepType.FlagCur == 0 ) )
    if ( CheckDepType )
      TreatDepType;
    end; 
  end;
  [--------------------------------------------------------------------------------------------];
  U_RESULT = true;
end; 