/*
  RS-Retail
  Единый клиент
  Конвертация кодов пользовательских полей: копирование информации
 из ci_code.dbt (ci_code.Group = 3) в notekind.dbt (notekind.ObjectType = 8)

  Ромодин Александр Васильевич
  11.02.2003
*/                               
  import CommonInter;

  var PathRet      = ""; //Trim(GetIniString("DATABASEDIR"));
  var PathBank     = ""; //Trim(GetIniString("DISTDBFILE"));
  var NameDicRet   = Trim(PathRet  + "SBBANK.DEF");
  var NameDicBank  = Trim(PathBank + "BANK.DEF");
  var NameFileRet  = Trim(PathRet  + "ci_code.dbt");
  var NameFileBank = Trim(PathBank + "notekind.dbt");
  var FileRet, FileBank;
  var NumIns = 0,
      NumErr = 0;
  var st;

  PrintLn (" ");
  PrintLn ("                Клиенты - физические лица");
  PrintLn ("     Конвертация Клиента RS-Retail в Клиента RS-Bank 5.1");
  PrintLn (" ");
  PrintLn ("        Копирование кодов доп.информации по клиенту ");
  PrintLn (" ");
    if (ExistFile(NameFileRet,1) AND ExistFile(NameFileBank,1))
      FileRet  = Tbfile ("ci_code.dbt", "r",3,NameFileRet, NameDicRet);
      FileBank = Tbfile ("notekind.dbt","w",0,NameFileBank,NameDicBank);
      if (FileRet AND FileBank)
        FileRet.rec.UpLink  = 0;
        FileRet.rec.Group   = 3;
        FileRet.rec.Integer = 0;
        st = FileRet.GetGE();
        while ( st
           AND (FileRet.rec.UpLink == 0)
           AND (FileRet.rec.Group  == 3))
          FileBank.Clear();
          FileBank.rec.ObjectType = 8;
          FileBank.rec.NoteKind   = FileRet.rec.Integer;
          FileBank.rec.NoteType   = FileRet.rec.ValType;
          FileBank.rec.Name       = FileRet.rec.String;
          if (NOT FileBank.Insert())
            NumErr = NumErr + 1;
            PrintLn (" *** Ошибка при добавлении признака "+FileRet.rec.String+" *** ");
          else
            NumIns = NumIns + 1;
          end;
          st = FileRet.Next();
        end;
        PrintLn (" ");
        PrintLn (" Процедура завершена");
        PrintLn (" Скопировано "+String(NumIns)+" записей");
        PrintLn (" Ошибки при копировании "+String(NumErr)+" записей");
     else
        PrintLn (" !!! Ошибка при открытии файлов !!! ");
      end;
    else
      PrintLn (" !!! Нет конвертируемых файлов !!! ");
    end;
end;
