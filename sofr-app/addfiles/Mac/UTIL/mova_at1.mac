/*--------------- ˜ £  «£®à¨â¬  £àã¯¯®¢®£® ­ ç¨á«¥­¨ï----------------------
                                             19-08-97 ‡ã¡®¢ ‚.ž.

 Ž¯¨á ­¨¥: ¥à¥¢®¤ áç¥â  ¢ ®á­®¢­®¥ á®áâ®ï­¨¥ ¥á«¨ áç¥â ­ å®¤¨âáï ¢
  «ìâ¥à­ â¨¢­®¬ á®áâ®ï­¨¨ ¨ íâ® ‚’ŽŽ… ­ ç¨á«¥­¨¥ ¯¥­á¨¨.
 (‚ à¨ ­â 2 - á¯¥æ¨ «ì­® ¤«ï “äë)


 Žá­®¢ ­ ­  MOVA_ATM.MAC, à¥ «¨§ãîé¥¬ ¤àã£ãî áâà â¥£¨î

-------------------------------------------------------------------------*/
import deprintr;
/*---------- â® ­ ¬ ¯¥à¥¤ îâ ---------------------------------*/
 record ALG_DEPOSITOR("depositr.dbt");
 record ALG_SBDEPDOC ("sbdepdoc.dbt");
 record ALG_PARAM    ("sb_algop.dbt");

/*---------- Š®¤ë ¢®§¢à â  ¬ ªà®á  --------------------------------------*/
 const
  OK_RES   =  0,  /* ¯à®¤®«¦ âì ¯à®¢®¤ªã */
  SKIP_RES =  1,  /* ¯à®¯ãáâ¨âì ¢ë¯®«­¥­¨¥ ¯à¥¤®¯à¥¤¥«¥­­®£® ¬®¤ã«ï */
  END_RES  =  2,  /* § ¢¥àè¨âì ¯à®¢®¤ªã */
  ERR_RES  = -1,  /*  ¢ p¨©­® § ¢¥àè¨âì ¯à®¢®¤ªã */

  OP_2_ALT = 85,
  OP_2_DEP = 86,

  …_ŽŽ‚‹Ÿ’œ                                 =  0,
  ŽŽ‚ˆ’œ                                     =  1,
  ’ˆ_Ž…€–ˆˆ_‡€—ˆ‘‹…ˆ…                      = 73,
  …‘ˆŸ                                       =  2,
  ‘—…’_Ž’Š›’                                  =  "",
  ‘—…’_‚_Ž‘Ž‚ŽŒ_‘Ž‘’ŽŸˆˆ                    =  0,
  ‘—…’_‚_€‹œ’…€’ˆ‚ŽŒ_‘Ž‘’ŽŸˆˆ              =  1,
  Ž…€–ˆŸ_……‚Ž„€_‚_€‹œ’…€’ˆ‚Ž…_‘Ž‘’ŽŸˆ… = OP_2_ALT,
  Ž…€–ˆŸ_……‚Ž„€_‚_Ž‘Ž‚Ž…_‘Ž‘’ŽŸˆ…       = OP_2_DEP,
  FOREVER                                      = Date(1,1,9999),
  TODAY                                        = {curdate};

/*- â® ¬ë ¢®§¢à é ¥¬ - ¯® ¢®§¢à âã ‡ã¡®¢ ­ ©¤¥â íâ¨ ¯¥à¥¬¥­­ë¥
    ¯® ¨å ˆŒ…€Œ - è ¬ ­, ®¤­ ª® !    --------------------------*/

 ALG_RESULT = OK_RES;/*§ à ­¥¥ ¨­¨æ¨ «¨§¨àã¥¬ ª®¤ ¢®§¢à â */
 ALG_UPDATE = …_ŽŽ‚‹Ÿ’œ;

/***********************************************************************/
MACRO ­¥âŽ¯¥à æ¨© ç¨á«¥­¨ï (accountReferenc,startDate,endDate,account,lastDate)
 file ” ©«„®ªã¬¥­â®¢ ("sbdepdoc.dbt")key 4;
 var
   thereIsDocument;
   /*result = True;*/

   Message("à®á¬ âà¨¢ ¥¬ ¨áâ®à¨î áç¥â  "+account);
   rewind(” ©«„®ªã¬¥­â®¢);
   ” ©«„®ªã¬¥­â®¢.Referenc      = accountReferenc;
   ” ©«„®ªã¬¥­â®¢.DepDate_Document = Date(0,0,0);
   ” ©«„®ªã¬¥­â®¢.NumDayDoc     = 0;

   thereIsDocument = getGE(” ©«„®ªã¬¥­â®¢);
   while(    thereIsDocument
        AND  (” ©«„®ªã¬¥­â®¢.Referenc == accountReferenc)
        )
        if(   (” ©«„®ªã¬¥­â®¢.DepDate_Document >= startDate)
          AND (” ©«„®ªã¬¥­â®¢.DepDate_Document <= endDate)
          AND (” ©«„®ªã¬¥­â®¢.TypeOper      == ’ˆ_Ž…€–ˆˆ_‡€—ˆ‘‹…ˆ…)
          AND (” ©«„®ªã¬¥­â®¢.ApplType      == …‘ˆŸ)
          )
          Message("„«ï áç¥â  "+account
                    +" ­ ©¤¥­ ¤®ªã¬¥­â ® ®¯¥à æ¨¨ § ç¨á«¥­¨ï ¯¥­á¨¨ ");
          SetParm(5, ” ©«„®ªã¬¥­â®¢.DepDate_Document);
          return False;
        end;
        thereIsDocument = next(” ©«„®ªã¬¥­â®¢);
   end;
   Message(  "„«ï áç¥â  "+account
              +" ­¥â ¤®ªã¬¥­â®¢ ® ­ ç¨á«¥­¨¨ ¯¥­á¨¨"
              +" á "+String(startDate)+" ¯® "+String(endDate)
          );
   return True;
END;

/*--------------------------------------------------------------*/

 var
   errorCode,
   day,mon,year,
   startDate,endDate,lastDate = Date(0,0,0);

  SetOutput("NUL");  /* «®ª¨àã¥¬ ¢ë¢®¤ */

  if(ALG_DEPOSITOR.UseAlternate == ‘—…’_‚_Ž‘Ž‚ŽŒ_‘Ž‘’ŽŸˆˆ)
    ALG_RESULT = OK_RES;
    ALG_UPDATE = …_ŽŽ‚‹Ÿ’œ;
    return;
  end;
  endDate = ALG_SBDEPDOC.DepDate_Document;
  DateSplit(ALG_SBDEPDOC.DepDate_Document,day,mon,year);
  startDate = Date(1,1,year);
  if(
     (ALG_DEPOSITOR.Open_Close   == ‘—…’_Ž’Š›’)
     AND (ALG_DEPOSITOR.UseAlternate == ‘—…’_‚_€‹œ’…€’ˆ‚ŽŒ_‘Ž‘’ŽŸˆˆ)
     AND (ALG_SBDEPDOC.TypeOper      == ’ˆ_Ž…€–ˆˆ_‡€—ˆ‘‹…ˆ…)
     AND (ALG_SBDEPDOC.ApplType      == …‘ˆŸ)
     AND ( ­¥âŽ¯¥à æ¨© ç¨á«¥­¨ï (ALG_DEPOSITOR.Referenc,startDate,endDate,
              ALG_DEPOSITOR.Account,lastDate) == FALSE)
   )
    errorCode = moveAccountIntoAnotherState
                (Ž…€–ˆŸ_……‚Ž„€_‚_Ž‘Ž‚Ž…_‘Ž‘’ŽŸˆ…,
                   ALG_DEPOSITOR.Referenc,
                     lastdate,
                       FOREVER);
    MsgBox("!!!");
    if(errorCode==0)
      ALG_DEPOSITOR.UseAlternate = ‘—…’_‚_Ž‘Ž‚ŽŒ_‘Ž‘’ŽŸˆˆ;
      ALG_DEPOSITOR.NumSession   = 0;
      ALG_RESULT                 = OK_RES;
      ALG_UPDATE                 = ŽŽ‚ˆ’œ;
    else
     MsgBox("ErrorCode ="+String(errorCode));
     end;
  end;

END;
/*----------------------------------------------------------------------*/
