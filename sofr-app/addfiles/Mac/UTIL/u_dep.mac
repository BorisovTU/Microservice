/*
  RS-Retail 5.1
  Архив базы
  Очистка/восстановление файла вкладных документов (sbdepdoc)
 и связанных с ним файлов

  Васильев Дмитрий 
*/
import Unload, OperCode;
/* #####    Параметры     ##### */
const WithOutSecondDate = false; /* True - FirstCurFromDate и CurFromDate 
                                    всегда совпадают, т.е. нет периода дат,
                                    на котором при выгрузке в архив файл
                                    документов sbdepdoc не чистится */ 
/* ##### Конец параметров ##### */
file Dep        (depositr) key 7 write;
file U_Dep      (depositr) key 7 write;
file DepDoc     (sbdepdoc) key 6 write;
file U_DepDoc   (sbdepdoc) key 6 write;
file PcDRest    (pc_drest) key 0 write;
file U_PcDRest  (pc_drest) key 0 write;
file PcCalc     (pc__calc) key 0 write;
file U_PcCalc   (pc__calc) key 0 write;
file AuxInfo    (auxinfo ) key 0 write;
file U_AuxInfo  (auxinfo ) key 0 write;
file PcEstim    (pcestim ) key 0 write;
file U_PcEstim  (pcestim ) key 0 write;
file PcTax      (pc_tax  ) key 0 write;
file U_PcTax    (pc_tax  ) key 0 write;
file CashLink   (sb_casln) key 1 write;
file U_CashLink (sb_casln) key 1 write;
file ScAcc      ("scAcc.dbt",   "spcard.def") key 0 write;
file U_ScAcc    ("scAcc.dbt",   "spcard.def") key 0 write;
file ScLink     ("scLink.dbt",  "spcard.def") key 3 write;
file U_ScLink   ("scLink.dbt",  "spcard.def") key 3 write;
file ScCard     ("scCard.dbt",  "spcard.def") key 0 write;
file U_ScCard   ("scCard.dbt",  "spcard.def") key 0 write;
file ScTran     ("scTran.dbt",  "spcard.def") key 3 write;
file U_ScTran   ("scTran.dbt",  "spcard.def") key 3 write;
file RetOp      (ret_op  ) key 0 write;
file U_RetOp    (ret_op  ) key 0 write;
file OpObject   (opobject) key 0 write;
file U_OpObject (opobject) key 0 write;

file DepType    (sb_dtyp ) key 2;
file sbDepDoc   (sbdepdoc) key 1;

const
  I_Dep       =  0,
  I_DepDoc    =  2,
  I_PcDRest   =  4,
  I_PcCalc    =  6,
  I_AuxInfo   =  8,
  I_PcEstim   = 10,
  I_PcTax     = 11,  
  I_CashLink  = 13,
  I_ScAcc     = 14,
  I_ScLink    = 16,
  I_ScCard    = 17,
  I_ScTran    = 18,
  I_RetOp     = 19, 
  I_OpObject  = 20,

const
  PC_DEP = 2001,
  PC_ALT = 2002,
  PC_OVR = 2003,
  PC_SUP = 2004;

const
  RPCB_TAX_SBDEPR_RETAIL = 2;

const
  ACCOUNT_HEIR = StrFor(2);

const
  NullDate = Date(0, 0, 0),
  MaxDate  = Date(31, 12, 2099);

array
  F_To, F_From;

const
  Branch = NumFNCash;

private var
 {curdate};

var
  Unload = false,
  FromDate,
  CardFromDate,
  FirstCurFromDate,  /* Дата, до которой при выгрузке чистятся все файлы */
  CurFromDate;       /* Дата "конца" выгрузки для тек. счёта 
                        При выгрузке в архив документов из sbdepdoc
                        записи с датой в диапазоне от FirstCurFromDate
                        до CurFromDate из исходного файла не удаляются */
var
  UFN_Dep,
  UFN_DepDoc,
  UFN_PcDRest,
  UFN_PcCalc,
  UFN_AuxInfo,
  UFN_PcEstim,
  UFN_PcTax,
  UFN_CashLink,
  UFN_ScAcc,
  UFN_ScLink,
  UFN_ScCard,
  UFN_ScTran,
  UFN_RetOp,
  UFN_OpObject,

macro FindDepType

  DepType.FlagCur = F_From(I_Dep).IsCur;
  DepType.Kind    = F_From(I_Dep).Type_Account;
  return GetEQ(DepType);
end;

macro GetLastPercPay (FirstDate) 
/* 
  Последняя оплата процентов - по документам оплаты 
*/
  var FindDate = FirstDate; /* Если ничего не найдем */
  var Cont;

  ClearRecord (sbDepDoc);
  sbDepDoc.Referenc         = F_From(I_Dep).Referenc;
  sbDepDoc.TypeOper         = Зачисление_Процентов;
  sbDepDoc.DepDate_Document = {curdate};
  Cont = GetLE (sbDepDoc);
  while (Cont
   AND (sbDepDoc.Referenc == F_From(I_Dep).Referenc)
   AND (sbDepDoc.TypeOper == Зачисление_Процентов) )
    if (sbDepDoc.DepDate_Document < FirstDate)
      Cont = false; /* За пределами диапазона поиска */
    elif (sbDepDoc.TypeComplexOper == Зачисление_Процентов)
      FindDate = sbDepDoc.DepDate_Document;
      Cont = false; /* Нашли нужную дату */
    else
      Cont = Prev (sbDepDoc);
    end;
  end;
  return FindDate;
end;

macro MakeUFileNames

  UFN_Dep       = MakeUFileName(FromDate, DEPOSITR_FILENUM);
  UFN_DepDoc    = MakeUFileName(FromDate, DEPDOC_FILENUM);
  UFN_PcDRest   = MakeUFileName(FromDate, PCDREST_FILENUM);
  UFN_PcCalc    = MakeUFileName(FromDate, PCCALC_FILENUM);
  UFN_AuxInfo   = MakeUFileName(FromDate, AUXINFO_FILENUM);M);
  UFN_PcEstim   = MakeUFileName(FromDate, PCESTIM_FILENUM);
  UFN_PcTax     = MakeUFileName(FromDate, PCTAX_FILENUM);
  UFN_CashLink  = MakeUFileName(FromDate, CASHLINK_FOR_DEPDOC_FILENUM);
  UFN_ScAcc     = MakeUFileName(FromDate, SCACC_FILENUM);
  UFN_ScLink    = MakeUFileName(FromDate, SCLINK_FILENUM);
  UFN_ScCard    = MakeUFileName(FromDate, SCCARD_FILENUM);
  UFN_ScTran    = MakeUFileName(FromDate, SCTRAN_FILENUM);
  UFN_RetOp     = MakeUFileName(FromDate, RETOP_FILENUM);
  UFN_OpObject  = MakeUFileName(FromDate, OPOBJECT_FILENUM);
end;
/* *********************************************************
   Функции открытия файлов
*/

macro U_CreateFiles

  var
    Stat=true;

  if(not(Clone(U_Dep,ArchDir + UFN_Dep)
    and Clone(U_DepDoc,ArchDir + UFN_DepDoc)
    and Clone(U_PcDRest,ArchDir + UFN_PcDRest)
    and Clone(U_AuxInfo,ArchDir + UFN_AuxInfo)
    and Clone(U_PcCalc,ArchDir + UFN_PcCalc)
    and Clone(U_PcEstim,ArchDir + UFN_PcEstim)
    and Clone(U_CashLink,ArchDir + UFN_CashLink)
    and Clone(U_ScAcc,ArchDir + UFN_ScAcc)
    and Clone(U_ScLink,ArchDir + UFN_ScLink)
    and Clone(U_ScCard,ArchDir + UFN_ScCard)
    and Clone(U_ScTran,ArchDir + UFN_ScTran)
    and Clone(U_PcTax,ArchDir + UFN_PcTax)
    and Clone(U_RetOp,ArchDir + UFN_RetOp)
    and Clone(U_OpObject,ArchDir + UFN_OpObject)))
    MsgBox("Ошибка при создании транспортных файлов");
    Exit;
  end;
end;

macro U_IsOpenOneFile(IdentFile, NameOpenFile)

  var stat;

  stat = ExistFile(ArchDir + NameOpenFile);
  if (stat)
    if (NOT Open(IdentFile,ArchDir + NameOpenFile))
      MsgBox("Ошибка при открытии Btrieve-файла ",ArchDir + NameOpenFile);
      Exit();
    end;
  else
    stat = Clone(IdentFile,ArchDir + NameOpenFile);
  end;

  return stat;

end;

macro U_OpenFiles

  var stat = TRUE;

  if (stat)
    stat = U_IsOpenOneFile(U_Dep, UFN_Dep);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_DepDoc, UFN_DepDoc);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_PcDRest, UFN_PcDRest);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_AuxInfo, UFN_AuxInfo);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_PcCalc, UFN_PcCalc);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_PcEstim, UFN_PcEstim);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_CashLink, UFN_CashLink);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_ScAcc, UFN_ScAcc);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_ScLink, UFN_ScLink);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_ScCard, UFN_ScCard);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_ScTran, UFN_ScTran);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_PcTax, UFN_PcTax);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_RetOp, UFN_RetOp);
  end;
  if (stat)
    stat = U_IsOpenOneFile(U_OpObject, UFN_OpObject);
  end;

  if (NOT stat)
    U_CreateFiles();
  end;

end;

macro R_OpenFiles
                   
  if(not(Open(U_Dep, ArchDir + UFN_Dep)
   and Open(U_DepDoc, ArchDir + UFN_DepDoc)
   and Open(U_PcDRest, ArchDir + UFN_PcDRest)
   and Open(U_PcCalc, ArchDir + UFN_PcCalc)
   and Open(U_AuxInfo, ArchDir + UFN_AuxInfo)
   and Open(U_PcEstim, ArchDir + UFN_PcEstim)
   and Open(U_PcTax, ArchDir + UFN_PcTax)
   and Open(U_CashLink, ArchDir + UFN_CashLink)
   and Open(U_ScAcc, ArchDir + UFN_ScAcc)
   and Open(U_ScLink, ArchDir + UFN_ScLink)
   and Open(U_ScCard, ArchDir + UFN_ScCard)
   and Open(U_ScTran, ArchDir + UFN_ScTran)
   and Open(U_RetOp, ArchDir + UFN_RetOp)
   and Open(U_OpObject, ArchDir + UFN_OpObject)))
     MsgBox("Не открыты файлы базы архивов!");
     Exit;
   end;
end;
/* *********************************************************
   Дата чистки для конкретного счета
*/
macro CalcCardFromDate

  var
    day, mon, year, CardDate;

  DateSplit({curdate}, day, mon, year);
  if((mon >= 1) and (mon <= 3))
    CardDate = Date(1, 10, year - 1);
  elif((mon >= 4) and (mon <= 6))
    CardDate = Date(1, 1, year);
  elif((mon >= 6) and (mon <= 9))
    CardDate = Date(1, 4, year);
  else
    CardDate = Date(1, 7, year);
  end;
  return CardDate;
end;
/* *********************************************************
   Функции переноса информации 
*/
macro MoveOpObject;

  var
    RecFound, 
    Stat = true;

  ClearRecord(F_From(I_OpObject));
  F_From(I_OpObject).OpAppKind = F_To(I_RetOp).ApplicationKind;
  F_From(I_OpObject).OpAppKey = F_To(I_RetOp).ApplicationKey;
  RecFound = GetGE(F_From(I_OpObject));
  while(Stat and RecFound
    and (F_From(I_OpObject).OpAppKind == F_To(I_RetOp).ApplicationKind)
    and (F_From(I_OpObject).OpAppKey == F_To(I_RetOp).ApplicationKey))
    Stat = MoveRec(F_To(I_OpObject), F_From(I_OpObject));
    if(Stat)
      RecFound = Next(F_From(I_OpObject));
    end;
  end;
  return Stat;
end;

macro MoveRetOp

  var
    Stat = true;

  F_From(I_RetOp).ApplicationKind = F_From(I_CashLink).ApplicationKind1;
  F_From(I_RetOp).ApplicationKey = F_From(I_CashLink).ApplicationKey1;
  if(GetGE(F_From(I_RetOp)))
    Stat = MoveOpObject;
    if(Stat)
      Stat = MoveRec(F_To(I_RetOp), F_From(I_RetOp));
    end;
  end;
  return stat;
end;

macro MoveCashLink(AppKind, AppKey, MoveRetOp)

  var
    Stat = true;

  ClearRecord(F_From(I_CashLink));
  F_From(I_CashLink).ApplicationKind2 = AppKind;
  F_From(I_CashLink).ApplicationKey2 = AppKey;
  if(GetEQ(F_From(I_CashLink)))
    if(MoveRetOp)
      Stat = MoveRetOp;
    end;
    if(Stat)
      Stat = MoveRec(F_To(I_CashLink), F_From(I_CashLink));
    end;
  end;
  return Stat;
end;

macro SpecialDocument

  if((F_From(I_DepDoc).TypeComplexOper == Открытие_Наличными)
     or (F_From(I_DepDoc).TypeComplexOper == Открытие_Безналичными)
     or (F_From(I_DepDoc).TypeComplexOper == Безналичная_Конверсия)
     or (F_From(I_DepDoc).TypeComplexOper == Зачисление_Компенсации)
     or (F_From(I_DepDoc).TypeComplexOper == Выдача_Компенсации)
     or (F_From(I_DepDoc).Author == ACCOUNT_HEIR)
     or (F_From(I_DepDoc).YesSbook != "X"))
    return true;
  end;
  return false;
end;

macro MoveDepDoc

  var 
    RecFound,
    Stat = true;
  var NoDel = false;

  F_From(I_DepDoc).Referenc = F_From(I_Dep).Referenc;
  F_From(I_DepDoc).Date_Document = CurFromDate;
  F_From(I_DepDoc).NumDayDoc = 32767;
  RecFound = GetLE(F_From(I_DepDoc));
  while(RecFound and Stat and (F_From(I_DepDoc).Referenc == F_From(I_Dep).Referenc))
    if((F_From(I_DepDoc).DepDate_Document < CurFromDate) and not SpecialDocument)
      Stat = MoveCashLink(F_From(I_DepDoc).iApplicationKind, F_From(I_DepDoc).ApplicationKey, True);
      if(Stat)
        if (F_From(I_DepDoc).Date_Document > FirstCurFromDate)
          NoDel = true;
        else
          NoDel = false;
        end;
        Stat = MoveRec(F_To(I_DepDoc), F_From(I_DepDoc), true, NoDel);
      end;
    end;
    if(Stat)
      RecFound = Prev(F_From(I_DepDoc));
    end;
  end;
  return Stat;  
end;

macro MovePcDRest(fileNum)

  var 
    RecFound,
    ObjectType = PC_DEP,
    Stat = true;

  while(ObjectType <= PC_SUP)
    ClearRecord(F_From(fileNum));
    F_From(fileNum).Referenc = F_From(I_Dep).Referenc;
    F_From(fileNum).Type_Object = ObjectType;
    F_From(fileNum).Date_Rest   = NullDate;
    RecFound = GetGE(F_From(fileNum));
    while(RecFound and Stat 
      and (F_From(fileNum).Referenc == F_From(I_Dep).Referenc)
      and (F_From(fileNum).Type_Object == ObjectType))
      if(F_From(fileNum).Date_Rest < CurFromDate)
        Stat = MoveRec(F_To(fileNum), F_From(fileNum));
      end;
      if(Stat)
        RecFound = Next(F_From(fileNum));
      end;
    end;
    ObjectType = ObjectType + 1;
  end;
  return Stat;  
end;

macro MovePcCalc(fileNum)

  var 
    RecFound,
    Stat = true;

  ClearRecord(F_From(fileNum));
  F_From(fileNum).Referenc = F_From(I_Dep).Referenc;
  RecFound = GetGE(F_From(fileNum));
  while(RecFound and Stat and (F_From(fileNum).Referenc == F_From(I_Dep).Referenc))
    if(F_From(fileNum).BeginDate < CurFromDate)
      Stat = MoveRec(F_To(fileNum), F_From(fileNum));
    end;
    if(Stat)
      RecFound = Next(F_From(fileNum));
    end;
  end;
  return Stat;  
end;

macro MoveAuxInfo(fileNum)

  var 
    RecFound,
    Stat = true;

  ClearRecord(F_From(fileNum));
  F_From(fileNum).Reference = F_From(I_Dep).Referenc;
  RecFound = GetGE(F_From(fileNum));
  while(RecFound and Stat and (F_From(fileNum).Reference == F_From(I_Dep).Referenc))
    if(F_From(fileNum).Date < CurFromDate)
      Stat = MoveRec(F_To(fileNum), F_From(fileNum));
    end;
    if(Stat)
      RecFound = Next(F_From(fileNum));
    end;
  end;
  return Stat;  
end;

macro MovePcTax(fileNum)

  var
    RecFound,
    Stat = true;

  ClearRecord(F_From(fileNum));
  F_From(fileNum).CodeModule = RPCB_TAX_SBDEPR_RETAIL;
  F_From(fileNum).ObjectTax = String(F_From(I_Dep).Referenc);
  RecFound = GetGE(F_From(fileNum));
  while(Stat and RecFound
    and (F_From(fileNum).CodeModule == RPCB_TAX_SBDEPR_RETAIL)
    and (F_From(fileNum).ObjectTax == String(F_From(I_Dep).Referenc)))
    if(F_From(fileNum).DateTaxPay < CurFromDate)
      Stat = MoveRec(F_To(fileNum), F_From(fileNum));
    end;
    if(Stat)
      RecFound = Next(F_From(fileNum));
    end; 
  end;
  return Stat;
end;

macro MovePcEstim(fileNum)

  var 
    RecFound,
    Stat = true;

  ClearRecord(F_From(fileNum));
  F_From(fileNum).Referenc = F_From(I_Dep).Referenc;
  RecFound = GetGE(F_From(fileNum));
  while(RecFound and Stat and (F_From(fileNum).Referenc == F_From(I_Dep).Referenc))
    if(F_From(fileNum).DateOperat < CurFromDate)
      Stat = MoveRec(F_To(fileNum), F_From(fileNum));
    end;
    if(Stat)
      RecFound = Next(F_From(fileNum));
    end;
  end;
  return Stat;  
end;

macro MoveScCard

  var
    Stat;

  F_From(I_ScCard).FNCash = F_From(I_ScLink).FNCash;
  F_From(I_ScCard).cardRef = F_From(I_ScLink).cardRef;
  Stat = GetEQ(F_From(I_ScCard));
  if(Stat)
    Stat = MoveRec(F_To(I_ScCard), F_From(I_ScCard));
  end;
  return Stat;
end;

macro MoveScTran

  var
    RecFound,
    Stat = true;

  ClearRecord(F_From(I_ScTran));
  F_From(I_ScTran).FNCash = F_From(I_ScLink).FNCash;
  F_From(I_ScTran).accCardLinkRef = F_From(I_ScLink).accCardLinkRef;
  RecFound = GetGE(F_From(I_ScTran));
  while(RecFound and Stat
    and (F_From(I_ScTran).FNCash == F_From(I_ScLink).FNCash)
    and (F_From(I_ScTran).accCardLinkRef == F_From(I_ScLink).accCardLinkRef))
    Stat = MoveRec(F_To(I_ScTran), F_From(I_ScTran));
    if(Stat) 
      RecFound = Next(F_From(I_ScTran));
    end;
  end;
  return Stat;
end;

macro MoveScLink

  var
    RecFound,
    Stat = true;

  ClearRecord(F_From(I_ScLink));
  F_From(I_ScLink).cardAccRef = F_From(I_ScAcc).Referenc;
  RecFound = GetEQ(F_From(I_ScLink));
  while(Stat and RecFound
    and (F_From(I_ScLink).cardAccRef == F_From(I_ScAcc).Referenc))
    Stat = MoveScCard;
    if ( Stat )
      Stat = MoveScTran;
    end;
    if(Stat)
      Stat = MoveRec(F_To(I_ScLink), F_From(I_ScLink));
    end;
    if(Stat)
      RecFound = Next(F_From(I_ScLink));
    end;
  end;
  return Stat;
end;

macro MoveScAcc

  var
    Stat = true;

  F_From(I_ScAcc).Referenc = F_From(I_Dep).Referenc;
  if(GetEQ(F_From(I_ScAcc)))
    Stat = MoveScLink;
    if(Stat)
      Stat = MoveRec(F_To(I_ScAcc), F_From(I_ScAcc));
    end;
  end;
  return Stat;
end;

/* ****************************************************** */

macro SpecialType

  if((DepType.Kind == "Целев. дети")
      or (DepType.Kind == "Обменный")
      or (DepType.Kind == "СПЕЦИАЛЬНЫЙ"))
    return true;
  end;
  return false;
end;

macro GetCurFromDate (FirstDate)

  var FindDate = FirstDate;
  var ObDepType = 2001;
 
  if (Index(DepType.UserTypeAccount, "К") == 0) /* Не карточные счета */
    if ( (DepType.FormContr != 0)            /* Договор (либо Срочный) */
     AND (F_From(I_Dep).UseAlternate == 0) ) /* в незавершенном состоянии */
      if (F_From(I_Dep).Prol_DateDep != NullDate)
        FindDate = F_From(I_Dep).Prol_DateDep - 1;
      else
        FindDate = F_From(I_Dep).Open_Date;
      end;
    else  /* Не договор (т.е. типа "До востребования") либо завершенный
             депозит, лежащий на условиях "До востребования" (на альтернативе).
             Придется смотреть график оплаты процентов */
      FindDate = GetLastPercPay (FirstDate); /* Последняя оплата процентов -
                                                по документам оплаты */
      if ( (DepType.FormContr != 0)                  /* Договор завершен недавно */
       AND (F_From(I_Dep).Prol_DateDep != NullDate)
       AND (FindDate < F_From(I_Dep).Prol_DateDep) ) /* По альтернативному графику расчетов не было */
        FindDate = F_From(I_Dep).Prol_DateDep - 1;
      end;
    end;
  end;
  return FindDate;
end;

/* ****************************************************** */

macro T_Move
/*
  Транзакция переноса одного счета
*/
  var Stat = true;

      if(Index(DepType.UserTypeAccount, "К") != 0) /* Карточные счета */
        FirstCurFromDate = CardFromDate;
      end;
      if(((DepType.FormContr == 20) or (DepType.FormContr == 30))
         and (F_From(I_Dep).Prol_DateDep != NullDate))
        FirstCurFromDate = F_From(I_Dep).Prol_DateDep - 1;
        if(FirstCurFromDate > FromDate)
          FirstCurFromDate = FromDate;
        elif ( (FirstCurFromDate < FromDate)
         AND   (F_From(I_Dep).UseAlternate != 0) ) /* Завершенный депозит- аналогично До востребования */
          FirstCurFromDate = FromDate;
        end;
      end;
      if(not Unload)
        FirstCurFromDate = MaxDate;
        CurFromDate      = FirstCurFromDate;
      elif (WithOutSecondDate)
        CurFromDate = FirstCurFromDate;
      else
        CurFromDate = GetCurFromDate (FirstCurFromDate);
        if (CurFromDate < FirstCurFromDate)
          CurFromDate = FirstCurFromDate;
        end;
      end;
      Stat = MoveDepDoc;
      if(Stat and NumRecs)
        F_From(I_Dep).Limit_Date = CurFromDate;
        F_From(I_Dep).ArhFlag = StrFor(1);
        Stat = Update(F_From(I_Dep));
      end;
      if(Stat)
        Stat = MovePcDRest(I_PcDRest);
      end;
      if(Stat)
        Stat = MovePcCalc(I_PcCalc);
      end;
      if(Stat)
        Stat = MoveAuxInfo(I_AuxInfo);
      end;
      if(Stat)
        Stat = MovePcTax(I_PcTax);
      end;
      if(Stat)
        if(F_From(I_Dep).Open_Close and (F_From(I_Dep).Close_Date < FirstCurFromDate))
          Stat = MovePcEstim(I_PcEstim);
          if(Stat)
            Stat = MoveScAcc;
          end;
          if(Stat)
            Stat = MoveRec(F_To(I_Dep), F_From(I_Dep));
          end;
        else
          if(Unload)
            Copy(F_To(I_Dep), F_From(I_Dep));
            Stat = Insert(F_To(I_Dep));
          end;
        end;
      end;


  if(not Stat)
    AbortTrn;
  end;
end;

/* *********************************************************
   #########################################################
   Организация переноса данных.
   Цикл по счетам.
   Перенос данных по каждому счету
   #########################################################
*/
macro TreatAccs

  var
    Stat = true, found;

  FirstCurFromDate = FromDate;
  CurFromDate      = FromDate;
  CardFromDate = CalcCardFromDate;
  ClearRecord(F_From(I_Dep));
  F_From(I_Dep).FNCash = Branch;
  found = GetGE(F_From(I_Dep));
  while(found and Stat and (F_From(I_Dep).FNCash == Branch))
    if((F_From(I_Dep).Open_Date <= FromDate) and FindDepType and not SpecialType)
      Stat = ProcessTrn(1, "T_Move",
                               Dep, U_Dep,
                               DepDoc, U_DepDoc,
                               PcDRest, U_PcDRest,
                               PcCalc, U_PcCalc,
                               AuxInfo, U_AuxInfo,
                               PcEstim, U_PcEstim,
                               PcTax, U_PcTax,
                               CashLink, U_CashLink,
                               ScAcc, U_ScAcc,
                               ScLink, U_ScLink,
                               ScCard, U_ScCard,
                               ScTran, U_ScTran,
                               RetOp, U_RetOp,
                               OpObject, U_OpObject);
      if (NOT Stat)
/*        MsgBox ("Ошибка при обработке счета "+F_From(I_Dep).Account); */
        [ #]("Ошибка при обработке счета "+F_From(I_Dep).Account);
        Stat = True; /* Для обработки следующего счета */
      end;
    end;
    found = Next(F_From(I_Dep));
  end; /* Конец цикла по счетам (depositr.dbt) */
  return Stat;
end;

/* *********************************************************
   #########################################################
   Точка входа: Копирование данных в Архив
   #########################################################
********************************************************* */
macro UnloadFile(UDate)

  var
    Stat = true;
  if(FindUnloadHistory("sbdepdoc.dbt"))
    if(UDate - UnloadHistory.Date < 365) /* ??????????????????? */
      return Stat;
    end;
  end;
  FromDate = UDate;
  Unload = true;
  MakeUFileNames; 
  U_OpenFiles;
  F_From(I_Dep) = Dep;
  F_To(I_Dep) = U_Dep;
  F_From(I_DepDoc) = DepDoc;
  F_To(I_DepDoc) = U_DepDoc;
  F_From(I_PcDRest) = PcDRest;
  F_To(I_PcDRest) = U_PcDRest;
  F_From(I_PcCalc) = PcCalc;
  F_To(I_PcCalc) = U_PcCalc;
  F_From(I_AuxInfo) = AuxInfo;
  F_To(I_AuxInfo) = U_AuxInfo;
  F_From(I_PcEstim) = PcEstim;
  F_To(I_PcEstim) = U_PcEstim;
  F_From(I_PcTax) = PcTax;
  F_To(I_PcTax) = U_PcTax;
  F_From(I_CashLink) = CashLink;
  F_To(I_CashLink) = U_CashLink;
  F_From(I_ScAcc) = ScAcc;
  F_To(I_ScAcc) = U_ScAcc;
  F_From(I_ScLink) = ScLink;
  F_To(I_ScLink) = U_ScLink;
  F_From(I_ScCard) = ScCard;
  F_To(I_ScCard) = U_ScCard;
  F_From(I_ScTran) = ScTran;
  F_To(I_ScTran) = U_ScTran;
  F_From(I_RetOp) = RetOp;
  F_To(I_RetOp) = U_RetOp;
  F_From(I_OpObject) = OpObject;
  F_To(I_OpObject) = U_OpObject;

  if(FindUnloadHistory("depositr.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      return Stat;
    end;
  else
    Stat = InsertUnloadHistory("depositr.dbt", FromDate);
  end;
  if(FindUnloadHistory("sbdepdoc.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      return Stat;
    end;
  else
    Stat = InsertUnloadHistory("sbdepdoc.dbt", FromDate);
  end;
  if(FindUnloadHistory("sb_drest.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("sb_drest.dbt", FromDate);
  end;
  if(FindUnloadHistory("pc__calc.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("pc__calc.dbt", FromDate);
  end;
  if(FindUnloadHistory("auxinfo.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("auxinfo.dbt", FromDate);
  end;
  if(FindUnloadHistory("pcestim.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("pcestim.dbt", FromDate);
  end;
  if(FindUnloadHistory("pc_tax.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("pc_tax.dbt", FromDate);
  end;
  if(FindUnloadHistory("sb_casln.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("sb_casln.dbt", FromDate);
  end;
  if(FindUnloadHistory("scAcc.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("scAcc.dbt", FromDate);
  end;
  if(FindUnloadHistory("scLink.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("scLink.dbt", FromDate);
  end;
  if(FindUnloadHistory("scCard.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("scCard.dbt", FromDate);
  end;
  if(FindUnloadHistory("scTran.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("scTran.dbt", FromDate);
  end;
  if(FindUnloadHistory("ret_op.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("ret_op.dbt", FromDate);
  end;
  if(FindUnloadHistory("opobject.dbt", FromDate))
    if(UnloadHistory.NormallyFinished == "X")
      Stat = UpdateUnloadHistory(false);
    end;
  else
    Stat = InsertUnloadHistory("opobject.dbt", FromDate);
  end;
  if(Stat)
    Stat = TreatAccs;
  end;
  if(Stat)
    Stat = FindUnloadHistory("depositr.dbt", FromDate);
    if(Stat)
      if((NRecords(U_Dep) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_Dep);
        DelFile(ArchDir + UFN_Dep);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("sbdepdoc.dbt", FromDate);
    if(Stat)
      if((NRecords(U_DepDoc) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_DepDoc);
        DelFile(ArchDir + UFN_DepDoc);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("sb_drest.dbt", FromDate);
    if(Stat)
      if((NRecords(U_PcDRest) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_PcDRest);
        DelFile(ArchDir + UFN_PcDRest);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("pc__calc.dbt", FromDate);
    if(Stat)
      if((NRecords(U_PcCalc) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_PcCalc);
        DelFile(ArchDir + UFN_PcCalc);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("auxinfo.dbt", FromDate);
    if(Stat)
      if((NRecords(U_AuxInfo) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_AuxInfo);
        DelFile(ArchDir + UFN_AuxInfo);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("pcestim.dbt", FromDate);
    if(Stat)
      if((NRecords(U_PcEstim) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_PcEstim);
        DelFile(ArchDir + UFN_PcEstim);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("pc_tax.dbt", FromDate);
    if(Stat)
      if((NRecords(U_PcTax) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_PcTax);
        DelFile(ArchDir + UFN_PcTax);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("sb_casln.dbt", FromDate);
    if(Stat)
      if((NRecords(U_CashLink) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_CashLink);
        DelFile(ArchDir + UFN_CashLink);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scAcc.dbt", FromDate);
    if(Stat)
      if((NRecords(U_ScAcc) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_ScAcc);
        DelFile(ArchDir + UFN_ScAcc);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scLink.dbt", FromDate);
    if(Stat)
      if((NRecords(U_ScLink) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_ScLink);
        DelFile(ArchDir + UFN_ScLink);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scCard.dbt", FromDate);
    if(Stat)
      if((NRecords(U_ScCard) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_ScCard);
        DelFile(ArchDir + UFN_ScCard);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scTran.dbt", FromDate);
    if(Stat)
      if((NRecords(U_ScTran) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_ScTran);
        DelFile(ArchDir + UFN_ScTran);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("ret_op.dbt", FromDate);
    if(Stat)
      if((NRecords(U_RetOp) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_RetOp);
        DelFile(ArchDir + UFN_RetOp);
      end;
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("opobject.dbt", FromDate);
    if(Stat)
      if((NRecords(U_OpObject) > 0) or (not FileCreated))
        Stat = UpdateUnloadHistory(true);
      else
        Stat = DeleteUnloadHistory(true);
        Close(U_OpObject);
        DelFile(ArchDir + UFN_OpObject);
      end;
    end;
  end;
  return stat;
end;
/* *********************************************************
   #########################################################
   Точка входа: Восстановление данных из Архива
   #########################################################
********************************************************* */
macro RestoreFile(UDate)

  var
    Stat = true;

  FromDate = UDate;
  MakeUFileNames; 
  R_OpenFiles;

  F_From(I_Dep) = U_Dep;
  F_To(I_Dep) = Dep;
  F_From(I_DepDoc) = U_DepDoc;
  F_To(I_DepDoc) = DepDoc;
  F_From(I_PcDRest) = U_PcDRest;
  F_To(I_PcDRest) = PcDRest;
  F_From(I_PcCalc) = U_PcCalc;
  F_To(I_PcCalc) = PcCalc;
  F_From(I_AuxInfo) = U_AuxInfo;
  F_To(I_AuxInfo) = AuxInfo;
  F_From(I_PcEstim) = U_PcEstim;
  F_To(I_PcEstim) = PcEstim;
  F_From(I_PcTax) = U_PcTax;
  F_To(I_PcTax) = PcTax;
  F_From(I_CashLink) = U_CashLink;
  F_To(I_CashLink) = CashLink;
  F_From(I_ScAcc) = U_ScAcc;
  F_To(I_ScAcc) = ScAcc;
  F_From(I_ScLink) = U_ScLink;
  F_To(I_ScLink) = ScLink;
  F_From(I_ScCard) = U_ScCard;
  F_To(I_ScCard) = ScCard;
  F_From(I_ScTran) = U_ScTran;
  F_To(I_ScTran) = ScTran;
  F_From(I_RetOp) = U_RetOp;
  F_To(I_RetOp) = RetOp;
  F_From(I_OpObject) = U_OpObject;
  F_To(I_OpObject) = OpObject;

  if(FindUnloadHistory("sbdepdoc.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  else
    return Stat;
  end;
  if(FindUnloadHistory("depositr.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("sb_drest.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("pc__calc.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("auxinfo.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("pcestim.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("pc_tax.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("sb_casln.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("scAcc.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("scLink.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("scCard.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("scTran.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("ret_op.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(FindUnloadHistory("opobject.dbt", FromDate))
    Stat = UpdateUnloadHistory(false);
  end;
  if(Stat)
    Stat = TreatAccs;
  end;
  if(Stat)
    Stat = FindUnloadHistory("sbdepdoc.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_DepDoc);
      DelFile(ArchDir + UFN_DepDoc);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("depositr.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_Dep);
      DelFile(ArchDir + UFN_Dep);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("sb_drest.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_PcDRest);
      DelFile(ArchDir + UFN_PcDRest);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("pc__calc.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_PcCalc);
      DelFile(ArchDir + UFN_PcCalc);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("auxinfo.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_AuxInfo);
      DelFile(ArchDir + UFN_AuxInfo);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("pcestim.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_PcEstim);
      DelFile(ArchDir + UFN_PcEstim);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("pc_tax.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_PcTax);
      DelFile(ArchDir + UFN_PcTax);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("sb_casln.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_CashLink);
      DelFile(ArchDir + UFN_CashLink);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scAcc.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_ScAcc);
      DelFile(ArchDir + UFN_ScAcc);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scLink.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_ScLink);
      DelFile(ArchDir + UFN_ScLink);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scCard.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_ScCard);
      DelFile(ArchDir + UFN_ScCard);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("scTran.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_ScTran);
      DelFile(ArchDir + UFN_ScTran);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("ret_op.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_RetOp);
      DelFile(ArchDir + UFN_RetOp);
    end;
  end;
  if(Stat)
    Stat = FindUnloadHistory("opobject.dbt", FromDate);
    if(Stat)
      Stat = DeleteUnloadHistory(true);
      Close(U_OpObject);
      DelFile(ArchDir + UFN_OpObject);
    end;
  end;
  return stat;
end;
