import deprintr, alg_vars;

file depositr ("depositr.dbt") key 8;
file depclnt  ("depclnt.dbt")       ;
file sb_dtyp  ("sb_dtyp.dbt")  key 2;
file sbtrast  ("sbtrast.dbt")       ;
file pc__calc ("pc__calc.dbt")      ;

record doc     ("sbdepdoc.dbt");
record percdoc ("sbdepdoc.2");
record KNFdoc  ("sbdepdoc.11");

macro GetDogNum (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (depositr);
   Rewind (Depositr);
   depositr.Referenc = doc.Referenc;
   stat = GetEQ (depositr);
   if (stat)
      Res = depositr.SvodAccount;
   else
      Res = 0;
   end;
   Return Res;
end;

macro GetDogDate (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (depositr);
   Rewind (Depositr);
   depositr.Referenc = doc.Referenc;
   stat = GetEQ (depositr);
   if (stat)
      Res = depositr.Open_Date;
   else
      Res = 0;
   end;
   Return Res;
end; 

macro GetBalAcc (docAddr)
 var Res;
   SetBuff (doc, docAddr);
   if (DefDepBalAccount (doc.Type_Account, doc.Code_Currency, doc.FlagRezid, "{Бал.счет вида}", Res) != 0)
      Res = 0;
   end;
   Return Res;
end; 

macro GetNameCln (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (depclnt);
   Rewind (depclnt);
   depclnt.CodClient = doc.CodClient;
   stat = GetEQ (depclnt);
   if (stat)
      Res = depclnt.Sname + " " + substr (depclnt.Name, 1, 1) + "." + substr (depclnt.Pname, 1, 1) + ".";
   else
      Res = 0;
   end;
   Return Res;
end; 

macro GetPaspCln (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (depclnt);
   Rewind (depclnt);
   depclnt.CodClient = doc.CodClient;
   stat = GetEQ (depclnt);
   if (stat)
      Res = depclnt.PersIDSer + " " + depclnt.PersIDNum + " " + depclnt.PersIDExtra;
   else
      Res = 0;
   end;
   Return Res;
end; 

macro GetNameOwner (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (depositr);
   Rewind (Depositr);
   depositr.Referenc = doc.Referenc;
   stat = GetEQ (depositr);
   if (stat)
      ClearRecord (depclnt);
      Rewind (depclnt);
      depclnt.CodClient = depositr.CodClient;
      stat = GetEQ (depclnt);
      if (stat)
         Res = depclnt.Sname + " " + substr (depclnt.Name, 1, 1) + "." + substr (depclnt.Pname, 1, 1) + ".";
      else
         Res = 0;
      end;
   else
      Res = 0;
   end;
   Return Res;
end; 

macro GetPaspOwner (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (depositr);
   Rewind (Depositr);
   depositr.Referenc = doc.Referenc;
   stat = GetEQ (depositr);
   if (stat)
      ClearRecord (depclnt);
      Rewind (depclnt);
      depclnt.CodClient = depositr.CodClient;
      stat = GetEQ (depclnt);
      if (stat)
         Res = depclnt.PersIDSer + " " + depclnt.PersIDNum + " " + depclnt.PersIDExtra;
      else
         Res = 0;
      end;
   else
      Res = 0;
   end;
   Return Res;
end; 

macro GetKNF (docAddr)
   SetBuff (KNFdoc, docAddr);
   Return KNFdoc.KNFCode;
end; 

macro GetTrustDate (docAddr)
 var stat, Res;
   SetBuff (doc, docAddr);
   ClearRecord (sbtrast);
   Rewind (sbtrast);
   sbtrast.Referenc  = doc.Referenc;
   sbtrast.VidDoc    = 0;
   sbtrast.CodClient = doc.CodClient;

   stat = GetEQ (sbtrast);
   if (stat)
      Res = sbtrast.DateOpen;
   else
      Res = "";
   end;
   Return Res;
end; 

macro GetPercRate (docAddr)
   SetBuff (doc, docAddr);
   Return PercRateAL (doc.Referenc, doc.ObjectPerc, doc.Date_Document);
end;

macro GetPercDate (docAddr)
 var stat = 1, Res;
   SetBuff (percdoc, docAddr);
   pc__calc.Referenc   = percdoc.Referenc;             
   pc__calc.ObjectType = percdoc.ObjectPerc;           
   pc__calc.TypeRecord = 1;                            
   if (percdoc.ObjectPerc == 2001)                     
      pc__calc.EndDate = percdoc.GlobDatePay;          
   elif (percdoc.ObjectPerc == 2002)                   
      pc__calc.EndDate = percdoc.AltDatePay;           
   else                                                
      stat = 0;                                        
   end;                                                
                                                                                                   
   if (stat)                                 
      stat = GetEQ (pc__calc);               
      if (stat)                              
         Res = pc__calc.BeginDate;           
      end;                                   
   end;                                      

   Return Res;
end;

macro GetVirtPercDate (docAddr)
 file fpercdoc ("sbdepdoc.dbt") key 1;

 var stat = 1, DateBeginPerc, DateLastVirtPerc, Res;
   SetBuff (percdoc, docAddr);
   pc__calc.Referenc   = percdoc.Referenc;
   pc__calc.ObjectType = percdoc.ObjectPerc;
   pc__calc.TypeRecord = 1;
   if (percdoc.ObjectPerc == 2001)
      pc__calc.EndDate = percdoc.GlobDatePay;
   elif (percdoc.ObjectPerc == 2002)
      pc__calc.EndDate = percdoc.AltDatePay;
   else
      stat = 0;
   end;

   if (stat)
      stat = GetEQ (pc__calc);
      if (stat)
         DateBeginPerc = pc__calc.BeginDate;
      end;
   end;

   fpercdoc.Referenc = percdoc.Referenc;
   fpercdoc.TypeOper = 39;
   if (percdoc.ObjectPerc == 2001)
      fpercdoc.DepDate_Document = percdoc.GlobDatePay;
   elif (percdoc.ObjectPerc == 2002)
      fpercdoc.DepDate_Document = percdoc.AltDatePay;
   else
      stat = 0;
   end;
   
   if (stat)
      stat = GetLE (fpercdoc);
      if (stat)
         DateLastVirtPerc = fpercdoc.DepDate_Document;
      end;
   end;

   if (DateLastVirtPerc > DateBeginPerc)
      Res = DateLastVirtPerc;
   else
      Res = DateBeginPerc;
   end;

   Return Res;
end;