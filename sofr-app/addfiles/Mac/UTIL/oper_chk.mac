/**************************************************************************** 
   RS-Retail 1.0                 (ëÅÖêÅÄçä)
   Subsystem:   îàãàÄã éíÑÖãÖçàü
                ~~~~~~~~~~~~~~~~
   Description: å†™‡ÆØ‡ÆÊ•§„‡† ·¢•‡™® Æ./§. ‰.24 ® Ø‡®´Æ¶•≠®Ô ‰.25
                §´Ô Æ§≠Æ© °‡®£†§Î (·¨•≠Î)
   ------------------------------------------------------------------------
   1998(c)R-Style SoftWare Lab.
****************************************************************************/

import deprintr;

file nb_data ("nb_data.dbt")  key 3;
file casval  ("sb_casvl.dbt") key 1;	
                            
const ÇõÇéÑàíú_ÇëÖ = FALSE;          /* <---- è†‡†¨•‚‡ ≠†·‚‡†®¢†•¨Î© ÇÄåà */
                                     /* ÇÆß¨Æ¶≠Î• ß≠†Á•≠®Ô - TRUE, FALSE  */
const FNcash  = NumFNcash();

var {curdate};                   /* Ñ†‚† ¢ÎØ„·™† Æ‚ÁÒ‚† */

var TotDiff1 = $0L, TotDiff2 = $0L;
var   val_name = "";
array tail;

/***********************************************************************\
|  1998(c) Copyright R-Style SoftWare Lab.                              |
|          Unauthorised duplication in any form prohibited              |
\***********************************************************************/  
macro print_header(brigade)

 [                                            ë¢•‡™† Æ/§ ‰.24 ® Ø‡®´Æ¶•≠®Ô ‰.25 ß† ########## £.                           
                                                                   ·¨•≠† ¸ ##### 
 ]                   
 ({curdate}, brigade);
[⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
 ≥                             ≥ à·ÂÆ§. Æ·‚†‚Æ™ ß† Ø‡•§.§•≠Ï ≥à·ÂÆ§ÔÈ®© Æ·‚†‚Æ™ ß† ‚•™.§•≠Ï≥       ê†·ÂÆ¶§•≠®Ô      ≥
 ≥  ç†®¨•≠Æ¢†≠®• Ê•≠≠Æ·‚®      √ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥                             ≥ØÆ §†≠≠.°„Â£.≥ØÆ §†≠≠.‰®´®†´†≥ØÆ §†≠≠.‰®´®†´†≥  ‡†·ÁÒ‚≠Î©  ≥ß† Ø‡•§.§•≠Ï≥ß† ‚•™.§•≠Ï≥ 
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ¥ 
 ];

end;



/***********************************************************************\
|  1998(c) Copyright R-Style SoftWare Lab.                              |
|          Unauthorised duplication in any form prohibited              |
\***********************************************************************/  
macro print_bottom

[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒŸ];
/*     ç• °„§•¨ ·™´†§Î¢†‚Ï Ë‚„™® ® ‡„°´®!!!
[                                                                                           ############ ########### ]
(TotDiff1:z, TotDiff2:z);                                     /*ÇÎ¢•·‚® àíéÉé*/
*/
end;



/***********************************************************************\
|  1998(c) Copyright R-Style SoftWare Lab.                              |
|          Unauthorised duplication in any form prohibited              |
\***********************************************************************/  
macro PrintTail
                 
  var i=1;
  while(i < asize(tail))
[≥#############################≥             ≥               ≥               ≥             ≥            ≥           ≥]
    (tail(i):29); 
     tail(i) = "";
    i=i+1;
  end;  

end;


/***********************************************************************\
|  1998(c) Copyright R-Style SoftWare Lab.                              |
|          Unauthorised duplication in any form prohibited              |
\***********************************************************************/  
macro CheckNBData(brigade)

  var CurRestOnPrevDate = $0L, PrevRestOnDate = $0L, 
      CurRestOnDate = $0L,     CalcRest = $0L;
  var rec_found, line = "";

  ReWind(nb_data);
  ClearRecord(nb_data);
  nb_data.FNCash = FNCash;
  nb_data.RefValue = casval.RefValue;
  nb_data.Brigade = brigade;
  nb_data.Date = {curdate};
  rec_found = GetLE(nb_data);
  while( rec_found and (nb_data.FNCash == FNCash)
                   and (nb_data.RefValue == casval.RefValue)
                   and (nb_data.Brigade == brigade)
       )
    if(nb_data.Date == {curdate})
       CurRestOnDate = nb_data.CurRest;
       PrevRestOnDate = nb_data.PrevRest;
       CalcRest = nb_data.PrevRest - nb_data.IncasCol + nb_data.AdvCol - 
                  nb_data.DebCol + nb_data.KredCol; 
    elif(nb_data.Date < {curdate})
       CurRestOnPrevDate = nb_data.CurRest;
    end; 
    
    if(nb_data.Date == {curdate})
      rec_found = Prev(nb_data); 
    else 
      rec_found = FALSE;
    end;

  end;
  
  if( ÇõÇéÑàíú_ÇëÖ  or
     ( (CurRestOnPrevDate != PrevRestOnDate) or (CurRestOnDate != CalcRest) )
    )
    /* ë‰Æ‡¨®‡Æ¢†‚Ï ·‚‡Æ™„ Æ‚ÁÒ‚† */
    val_name = String(casval.NameValue);
    if(StrLen(val_name) > 29) 
       StrSplit(val_name, tail, 29, 29);
    else
       tail(0) = val_name;
    end;
    line = "≥" + String(tail(0):29) + "≥" + 
                  String(CurRestOnPrevDate:13:r:z) + "≥" +
                  String(PrevRestOnDate:15:r:z) + "≥" +
                  String(CurRestOnDate:15:r:z) + "≥" +
                  String(CalcRest:13:r:z) + "≥" +
                  String((CurRestOnPrevDate - PrevRestOnDate):12:r:z) + "≥" +
                  String((CurRestOnDate - CalcRest):11:r:z) + "≥";
    TotDiff1 = TotDiff1 + (CurRestOnPrevDate - PrevRestOnDate);
    TotDiff2 = TotDiff2 + (CurRestOnDate - CalcRest);
  end;

  return line;

end;


/***********************************************************************\
|  1998(c) Copyright R-Style SoftWare Lab.                              |
|          Unauthorised duplication in any form prohibited              |
\***********************************************************************/  
macro TreatCashValues(brigade)

  var rec_found, line, header_printed = FALSE;

  casval.TypeValue = 0;
  casval.CodIntValue = 0;
  rec_found = getGE(casval);
  while( rec_found ) 
    line = CheckNBData(brigade);
    if(line != "")
      if( not header_printed )
        print_header(brigade);
        header_printed = TRUE;
      end;
      [#](line);
      PrintTail();
    end;
    rec_found = Next(casval);
  end;                       

  if(header_printed)
    print_bottom();
  else
    [ ê†·ÂÆ¶§•≠®© ≠• Æ°≠†‡„¶•≠Æ! ];
  end;

end;


/***********************************************************************\
|  1998(c) Copyright R-Style SoftWare Lab.                              |
|          Unauthorised duplication in any form prohibited              |
\***********************************************************************/  
macro main()

   var brigade;                               /* çÆ¨•‡ ·¨•≠Î */

   GetInt(brigade, "Ç¢•§®‚• ≠Æ¨•‡ ·¨•≠Î:", 2);
   TreatCashValues(brigade);

   return 0;

end;




  main();
  End.
