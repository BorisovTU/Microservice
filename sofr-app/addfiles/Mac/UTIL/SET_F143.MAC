/**************************************************************************

  R-Style SoftLab.

  RS-Retail.

  Установка макроса выпуска ф.143 на шаги операций по видам вкладов

***************************************************************************/

file dt ( sb_dtyp  ) key 2;        /* Виды вкладов */
file op ( sb_typop ) key 0;        /* Операции по видам вкладов */
file st ( sb_algop ) key 0 write;  /* Шаги операций по видам вкладов */
file sc ( sb_algop ) key 0 write;  /* Шаги операций для составных шагов */

var statDT, statOP, statST, statSC;

var ErrCode, ErrText;

var sIsCur = "";

/***************************************************************************/
/*                         Сделать составной шаг                           */
/***************************************************************************/
macro MakeComplexStep( pModuleNumber, pNameAlg )

  var vNumOpert   = op.NumOpert * 1000 + 402;
  var vNumStepAlg = 1;

  ReWind( sc );

  /* Цикл добавления нового составного шага для поиска свободного NumStepAlg */
  while ( vNumStepAlg < 32000 )
    ClearRecord( sc );
    sc.IsCur        = op.IsCur;
    sc.Kind         = op.Kind;
    sc.NumOpert     = vNumOpert;
    sc.NumStepAlg   = vNumStepAlg;
    sc.czNameAlg    = pNameAlg;
    sc.ModuleNumber = pModuleNumber;
    sc.FlagExe      = "X";
    sc.TypPanel     = 5;

    if ( Insert( sc ) )
      if ( pModuleNumber == 3312 )
        if ( op.IsCur == 0 )
          sIsCur = "(Руб.)";
        else
          sIsCur = "(Вал.)";
        end;
        println( "Макрос ф.143 установлен: \"" + op.Kind + "\" " + sIsCur +
                 " операция = ", op.NumOpert );
      end;
      vNumStepAlg = 32001;  /* Закончить цикл */
    else
      vNumStepAlg = vNumStepAlg + 1;
    end;
  end;

end;

/***************************************************************************/
/* Установка макроса выпуска ф.143 на шаги операции по одному виду вкладов */
/***************************************************************************/
macro SetOperatStep( pNumOpert )

  ReWind( st );
  ClearRecord( st );
  st.IsCur      = op.IsCur;
  st.Kind       = op.Kind;
  st.NumOpert   = op.NumOpert;
  st.NumStepAlg = 0;  /* шаг "Печать доп.ордеров" */
  statST = GetGE( st );

  while ( statST                       AND
          ( st.IsCur    == op.IsCur )  AND
          ( st.Kind     == op.Kind )   AND
          ( st.NumOpert == op.NumOpert ) )

    if ( st.NumStepAlg == 402 )
      statST = FALSE;
    else
      statST = Next( st );
    end;
  end;

  if ( ( st.IsCur      == op.IsCur )     AND
       ( st.Kind       == op.Kind )      AND
       ( st.NumOpert   == op.NumOpert )  AND
       ( st.NumStepAlg == 402 ) )
    /* Шаг операции уже есть */
    if ( ( ( st.ModuleNumber == 0 )  OR  ( st.FlagExe != "X" ) )  AND
         ( st.IsComplex != "X" ) )
      st.czNameAlg    = "Печать доп. ордеров";
      st.ModuleNumber = 3312;  /* Точка входа form_143.mac */
      st.FlagExe      = "X";
      st.TypPanel     = 5;
      if ( Update( st ) )
        if ( op.IsCur == 0 )
          sIsCur = "(Руб.)";
        else
          sIsCur = "(Вал.)";
        end;
        println( "Макрос ф.143 установлен: \"" + op.Kind + "\" " + sIsCur +
                 " операция = ", op.NumOpert );
      else
        if ( op.IsCur == 0 )
          sIsCur = "(Руб.)";
        else
          sIsCur = "(Вал.)";
        end;
        println( "Error Update: \"" + op.Kind + "\" " + sIsCur +
                 " операция = ", op.NumOpert );
      end;
    else
      if ( st.IsComplex == "X" )  /* Уже составной шаг */
        MakeComplexStep( 3312, "Печать ф.143" );
      else                       /* Не составной шаг */
        MakeComplexStep( st.ModuleNumber, st.czNameAlg );
        st.ModuleNumber = 0;
        st.FlagExe      = "X";
        st.TypPanel     = 1;
        st.IsComplex    = "X";
        if ( Update( st ) )
          if ( op.IsCur == 0 )
            sIsCur = "(Руб.)";
          else
            sIsCur = "(Вал.)";
          end;
          println( "Макрос ф.143 установлен: \"" + op.Kind + "\" " + sIsCur +
                   " операция = ", op.NumOpert );
        else
          if ( op.IsCur == 0 )
            sIsCur = "(Руб.)";
          else
            sIsCur = "(Вал.)";
          end;
          println( "Error Update: \"" + op.Kind + "\" " + sIsCur +
                   " операция = ", op.NumOpert );
        end;
        MakeComplexStep( 3312, "Печать ф.143" );
      end;
    end;
  else
    /* Шага операции нет */

    ClearRecord( st );
    st.IsCur        = op.IsCur;
    st.Kind         = op.Kind;
    st.NumOpert     = op.NumOpert;
    st.NumStepAlg   = 402;  /* шаг "Печать доп.ордеров" */
    st.czNameAlg    = "Печать доп. ордеров";
    st.ModuleNumber = 3312;  /* Точка входа form_143.mac */
    st.FlagExe      = "X";
    st.TypPanel     = 5;
    if ( Insert( st ) )
      if ( op.IsCur == 0 )
        sIsCur = "(Руб.)";
      else
        sIsCur = "(Вал.)";
      end;
      println( "Макрос ф.143 установлен: \"" + op.Kind + "\" " + sIsCur +
               " операция = ", op.NumOpert );
    else
      ErrCode = Status( ErrText );
      if ( ErrCode == 5 )
        if ( Update( st ) )
          if ( op.IsCur == 0 )
            sIsCur = "(Руб.)";
          else
            sIsCur = "(Вал.)";
          end;
          println( "Макрос ф.143 установлен: \"" + op.Kind + "\" " + sIsCur +
                   " операция = ", op.NumOpert );
        else
          ErrCode = Status( ErrText );
          if ( op.IsCur == 0 )
            sIsCur = "(Руб.)";
          else
            sIsCur = "(Вал.)";
          end;
          println( "Error Update: \"" + op.Kind + "\" " + sIsCur +
                   " операция = ", op.NumOpert, " = ", ErrText );
        end;
      else
        if ( op.IsCur == 0 )
          sIsCur = "(Руб.)";
        else
          sIsCur = "(Вал.)";
        end;
        println( "Error Insert: \"" + op.Kind + "\" " + sIsCur +
                 " операция = ", op.NumOpert, " = ", ErrText );
      end;
    end;
  end;

end;

/**********************************************************************/
/*                         Основная процедура                         */
/**********************************************************************/

 ReWind( dt );
 ClearRecord( dt );
 dt.FlagCur = 0;
 statDT = GetGE( dt );

 /* Цикл по видам вкладов */
 while ( statDT )

   if ( dt.FlagCur == 0 )
     sIsCur = "рублевых";
   else
     sIsCur = "валютных";
   end;

   Message( "  Вид " + sIsCur + " вкладов: \"" + dt.Kind + "\"" );

   if ( Index( dt.UserTypeAccount, "Щ" ) <= 0 )  /* Счет не специальный */

     ReWind( op );

     ClearRecord( op );
     op.IsCur    = dt.FlagCur;
     op.Kind     = dt.Kind;
     op.NumOpert = 63;  /* Списание по поручению */
     if ( GetEQ( op ) )
       SetOperatStep();
     end;

     ClearRecord( op );
     op.IsCur    = dt.FlagCur;
     op.Kind     = dt.Kind;
     op.NumOpert = 64;  /* Списание по коммунальному платежу */
     if ( GetEQ( op ) )
       SetOperatStep();
     end;

     ClearRecord( op );
     op.IsCur    = dt.FlagCur;
     op.Kind     = dt.Kind;
     op.NumOpert = 67;  /* Списание в "чужой" филиал */
     if ( GetEQ( op ) )
       SetOperatStep();
     end;

   end;

   statDT = Next( dt );
 end;

end;
