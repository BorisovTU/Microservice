import deprintr;
private file Dep( "depositr.dbt" ) key 7;
private file Doc( "sbdepdoc.dbt" ) key 6;
private const FNCash = NumFNCash();
private const NullDate = date( 0, 0, 0 );
var LimDate;
array Branches;
macro ListDep
//  file listfdep( listfdep );
  var dpDepList = TdpDepList;
  array AFNCash;
  array ANBranch;
  array MenuName;
  var i = 0;
  AFNCash(0) = -1;
  ANBranch(0) = "По всем";
  MenuName(0) = " " + SubStr(ANBranch(0) + MkStr(" ",12),1,12) + " ";
  dpDepList.SetFilter(dpDepList.getFilialID(NumFNCash()));
  while (dpDepList.next())
    i = i + 1;
    AFNCash(i) = dpDepList.rec.Code;
    ANBranch(i) = dpDepList.rec.Name;
    MenuName(i) = " " + SubStr(dpDepList.rec.Name + MkStr(" ",12),1,12) + "   " + /*listfdep.Name +*/ " ";
  end;
  i = Menu(MenuName,NULL,"Выберите филиал");
  if (i >= 0)
    if (AFNCash(i) > -1)
      Branches(0) = AFNCash(i);
    else
      dpDepList.rewind();
      i = 0;
      while (dpDepList.next())
        Branches(i) = dpDepList.rec.Code;
        i = i + 1;
      end;
    end;
  else
    Exit(1);
  end;
end;
macro FindDoc
var found;
   ClearRecord( Doc );
   Doc.Referenc = Dep.Referenc;
   found = getGE( Doc );
   if( found and ( LimDate == Dep.Open_Date ) )
      return true;
   end;
   while( found )
      if( Doc.DepDate_Document > LimDate )
         return true;
      end;
      found = next( Doc );
   end;
   return false;
end;
var j = 0, RecFound;
ListDep;
OpenDepFiles;
while ( j < ASize( Branches ) )
  KeyNum( Dep, 7 );
  ClearRecord( Dep );
  Dep.FNCash = Branches( j );
  RecFound = GetGE( Dep );
  while( RecFound and( Dep.FNCash == Branches( j ) ) )
    if( Dep.Open_Close == "" )
      if( Dep.Limit_Date > NullDate )
        LimDate = Dep.Limit_Date;
      else
        LimDate = Dep.Open_Date;
      end;
      if( findDoc() )
        message( " Обрабатывается счет: ", Dep.Account );
        message( "" );
      end;
    end;
    RecFound = Next( Dep );
  end;
  j = j + 1;
end;
CloseDepFiles;
end.
