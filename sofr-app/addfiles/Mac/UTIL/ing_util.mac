
/*
**  Полезные функции для слитков драгметаллов
**
*/

import RD_Comm;

private file IngRate( "ing_rate.dbt" );
private file CIMisc( "ci_misc.dbt" ) key 0;

private macro FindCIMisc( Type, Issue )

  CIMisc.Type = Type;
  CIMisc.IssueID = Issue;
  return GetEQ( CIMisc );
end;

macro GetIngotCBRate( Type, Issue, Date )

  var
    Rate = 0; 

  if ( not FindCIMisc( Type, Issue ) )
    MsgBox( "Не найден вид слитков" );
    Exit( 1 );
  end;

  CurrCode = 0;

  if ( CIMisc.HasOwnRate ) 
    KeyNum( IngRate, 1 );
    IngRate.Type = CIMisc.Type;
    IngRate.Issue = CIMisc.IssueID;
    IngRate.Date = Date;
    IngRate.Time = Time( 23, 59, 59 );
    if ( GetLE( IngRate )
      and ( IngRate.Type == CIMisc.Type )
      and ( IngRate.Issue == CIMisc.IssueID ) )
      Rate = IngRate.CBRate;
      CurrCode = IngRate.CurrCode; 
    end;
  end; 

  if ( Rate == 0 )
    KeyNum( IngRate, 2 );
    IngRate.HallmarkRef = CIMisc.HallmarkRef;
    IngRate.Date = Date;
    IngRate.Time = Time( 23, 59, 59 );
    if ( GetLE( IngRate )
      and ( IngRate.HallmarkRef == CIMisc.HallmarkRef ) )
      Rate = IngRate.CBRate;
      CurrCode = IngRate.CurrCode; 
    end;
  end;

  if ( Rate == 0 )
    MsgBox( "Не задан курс слитка" );
    Exit( 1 );
  end;

  if ( CurrCode != 0 )
    Curr.Code_Currency = CurrCode;
    GetCBRate;
    Rate = Cur2Rub( Rate );
  end;

  return Rate;
end;

