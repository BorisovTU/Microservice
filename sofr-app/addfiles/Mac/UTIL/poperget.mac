// *********************************************************
// RS-Bank V.6
// RS-Retail
// Заготовка макроса для выполнения пользовательской процедуры
// "Списание фиксированной суммы"
//
// При необходимости соответствующая операция описывается 
// в списке операций нужного вида вклада, к этой
// операции приписывается данный макрос
// ---------------------------------------------------------
// Задайте сумму списания - константу GetSum
// ---------------------------------------------------------
//
// Ромодин Александр Васильевич
// 14.07.2006
// *********************************************************
import DeprIntr,alg_vars;
// *********************************************************
// Пользователь вводит суммы списания
private const GetSum = $100;
// *********************************************************
private const С_Панелью  = 0;
private const UseMaxDate = 1;
private const NoPrint    = 1;
// *********************************************************


private record tmpDoc          ("sbdepdoc.dbt");

private const FNcash     = NumFNcash     ();
private const RealFNcash = NumRealFNcash ();

private const OP_GETCON      = 62; // Списание
private const OP_GETCNCOMISS =  7; // Безналичная комиссия
private const ACCOUTN_HEIR   =  0; // Владелец счета

// ---------------------------------------------------------
  private var stat;

  ALG_RESULT = OK_RES;
    
  ClearRecord(tmpDoc);
  tmpDoc.Referenc         = ALG_DEPOSITOR.Referenc;
  tmpDoc.IsCur            = ALG_DEPOSITOR.IsCur;
  tmpDoc.FNCash           = FNCash;
  tmpDoc.RealFNCash       = RealFNCash;
  tmpDoc.Account          = ALG_DEPOSITOR.Account;
  tmpDoc.Oper             = {oper};
  tmpDoc.Type_Account     = ALG_DEPOSITOR.Type_Account;
  tmpDoc.Code_Currency    = ALG_DEPOSITOR.Code_Currency;
  tmpDoc.CodClient        = ALG_DEPOSITOR.CodClient;
  tmpDoc.Date_Document    = {curdate};
  tmpDoc.DepDate_Document = {curdate};
  tmpDoc.ApplType         = OP_GETCNCOMISS;
  tmpDoc.OutSum           = GetSum;
  tmpDoc.TypeComplexOper  = OP_GETCON;
  tmpDoc.TypeOper         = OP_GETCON;
  tmpDoc.IsControl        = StrFor(1); /* Признак главного документа */
  tmpDoc.Author           = ACCOUTN_HEIR;

  ClearRecord(ALG_OPERPRM);
  ALG_OPERPRM.Account           = ALG_DEPOSITOR.Account;
  ALG_OPERPRM.Type_Account      = ALG_DEPOSITOR.Type_Account;
  ALG_OPERPRM.Code_Currency     = ALG_DEPOSITOR.Code_Currency;
  ALG_OPERPRM.Type_Oper         = OP_GETCON;
  ALG_OPERPRM.Show_Panel        = С_Панелью;
  ALG_OPERPRM.UseMaxDate        = UseMaxDate;
  ALG_OPERPRM.NoPrint           = NoPrint;
  ALG_OPERPRM.TypeComplexOper   = OP_GETCON;
  ALG_OPERPRM.DocumentAuthor    = CodeFor(tmpDoc.Author);

  stat = Выполнение_Операции(ALG_OPERPRM,tmpDoc);

  if (stat != 0)
    MsgBox ("Операция завершилась с ошибкой ",stat);
  end;
end;
