/*
   Макрос формирования проверочных записей для автоматизированных филиалов.

   ВНИМАНИЕ!!!
   Если в параметрах подразделения указано "Неавтоматизированный филиал"
   его счета не будут обработаны!

   All Rights Reserved
*/

import deprintr, issrvdoc;

file lnk(sb_casln) key 1 write;
file dep(depositr) key 9999 write;
file doc(sbdepdoc) key 6;

array bra;

macro automated( fncash )

var i = 0;

while( i < asize( bra ) )
   if( bra( i ) == fncash )
      return true;
   end;
   i = i + 1;
end;
   return false;
end;

macro linked( void )

lnk.applicationKind2 = doc.iApplicationKind;
lnk.applicationKey2 = doc.applicationKey;
lnk.refValue2 = 0;
if( getEQ( lnk ) )
   return true;
end;
   return false;   
end;

/* Точка входа */

var i = 0, j = 0, u = 0, tot = nRecords( doc ), stat, branch = -1;
var IsStatic = false;  /* Если обрабатывать только неподвижные и объединенные - 
                          True, если обрабатывать все - False
                       */
var dpDepList = TdpDepList;

if( getint( branch, "Введите номер филиала (-1 - все): ", 2 ) and ( branch != -1 ) )
  bra( i ) = branch;
  i = 1;
else
  dpDepList.SetFilter(dpDepList.getFilialID(NumFNCash()));
  while( dpDepList.next() )
     if( dpDepList.rec.IsAutomated )
        bra( i ) = dpDepList.rec.Code;
        i = i + 1;
     end;
  end;
end;
if( not i )
   println( "Нет автоматизированных филиалов!" );
   return true;
end;     
message( "" );
i = 0;
rewind( dep );
while( next( dep ) )
   if( ( ( not IsStatic        ) and 
         ( dep.open_close == "" ) and 
         automated( dep.fncash ) 
       ) or 
       ( IsStatic and ( dep.open_close == "" ) and automated( dep.fncash ) and 
         (
           ( dep.SvodAccount  != ""             ) or 
           ( dep.Type_Account == "Неподвижный " ) or
           ( dep.Type_Account == "Объединенный" )
         )
       )   
     )
      doc.referenc = dep.referenc;
      doc.date_document = date( 31, 12, 9999 );
      doc.numdaydoc = 32767;
      stat = getLE( doc );
      while( stat and ( doc.referenc == dep.referenc ) )
         
         if( stat )
            i = i + 1;
            j = j + 1;
            if( j >= 50 )
              message( "Обрабатываем SBDEPDOC.DBT: всего ", tot:8, " уже ", i:8 );
              j = 0;
            end;
            stat = prev( doc );
         end;
      end;
   end;
   message ("Обрабатывается счет ", dep.Account);
end;
println( "Обработано ", i:8, " записей" );
if( u )
  println( "Несвязанных записей ", u:8 );
end;
return true;
end.
