/**************************************************************************\
*  ---------------------                                                   *
*  R-Style Software Lab.                                                   *
*  ---------------------                                                   *
*  RS-Retail                                                               *
*                                                                          *
*  Налично-кассовые операции                                               *
*  Переводы БЛИЦ с использование БД ИНФОБАНК                               *
*  Формирование отчета по сверке данных                                    *
*  Мишин А.Н.                                                              *
*  ...04.2009                                                              *
\**************************************************************************/
import  BP_Const, BP_connect;

var opr            = TBFile ( "person.dbt", "r", 0 );
private var cmd: Object;
private var q: string;
private var rs;          


var ReportFNCash   = -1;    /* По какому подразделению выпустить отчет */
var i;
var icount;
array MenuName;
array AFNCash;
array ANBranch;
array ANBank;
array AKNP;
var VidOpert = "Тест";
var BankName = "Тест";
var Terr     = 0;
var sOper    = "";
var NameBranch;
var tIs_cur;
var tiknp;
var DateReport;


/* Массив подразделений, учавствующих в отчете */
array FNCashArray;

/* Панель редактирования */
record Panel( "BP_CHECK", "BP.lbr" ) dialog;
const ne_BegDate    = 0, /* Начальная дата */
      ne_EndDate    = 1, /* Конечная дата  */
      ne_NameBranch = 2; /* Номер филиала  */

macro PrintHeard /* Печать шапки */
  [                       ПРОТОКОЛ СВЕРКИ ПО ПЕРЕВОДАМ ПО СИСТЕМЕ БЛИЦ];
  [                       ПО #########################################]
  (VidOpert);
  [                       за ##########г.]
  (DateReport);
  [ ];
  [  Подразделение: ########################################################]
  (BankName);
  [  Дата, время формирования отчета: ########## #########] (date, time);
  [  Исполнитель:  ##############################################] (sOper);
end;

macro PrintHeadr1
 If (Terr == 1)
  [ ];
  [ ];
  [Обнаружены расхождения:];
  [--------------------------------------------------------------------------];
  [|Контрольный |    Наименование   | Значение в   | Значение в    |  Номер |];
  [|номер пере- |     параметра     | ИНФОБАНК     | RS-Retail     | докумен|];
  [|вода        |                   |              |               |   та   |];
  [|------------|-------------------|--------------|---------------|--------|];
 End;
end;

macro PrintLine(p_knp,ppar,pib,prs,pnd);
  [| ########## | ################# | ############ | ############# | ###### |]
  (p_knp,ppar,pib,prs,pnd);

End;

macro ListDep  /* Выбор подразделения */

  i = Menu(MenuName,NULL,"Выбор подразделения");

  if (i >= 0)
    ReportFNCash     = AFNCash(i);
    Panel.NameBranch = ANBranch(i);
    BankName         = ANBank(i);
  end;

end;

/* Поиск в массиве КНП */
macro TestKNP(tKNP)
 var ii;
 ii = 0;
 While (Not (ii > tiknp))
  If (Aknp(ii) == tKNP) Return True End;
  ii = ii + 1;
 End;
 Return False;
End;

macro PrintReport
  var d;
  var m;
  var y;
  DateSplit(DateReport,d,m,y);

  Department = GetCodeBr(ReportFNCash); /* Код подразделения для ИНФОБАНК */
  ClearRecord(rec);

  Rec = RsdRecordset("DSN="+sconnect(sqlname),"SELECT  i_Bank FROM t_BankMain  WHERE s_Code = '"+Department+"'");

  If (Not Rec.MoveNext())
    println("Ошибка! Код подразделения "+Department+" отсутствует в справочнике АС ИНФОБАНК!");
    return;
    Else
    BankCode   = Rec.Fld("i_Bank").Value;  /* Код Банка в ИНФОБАНК */
  End;  

  VidOpert = "ПРИНЯТЫМ ПЕРЕВОДАМ";
  PrintHeard;

 /* Выборка из БД ИНФОБАНК по принятым переводам*/
  ClearRecord(rec);
  tiknp    = 0;


  Rec = RsdRecordset("DSN="+sconnect(sqlname),String("SELECT s_CheckCode as KNP,dt_petitiondate as dateoper,",
    " (SELECT s_name FROM t_mopetitionstate WHERE id = i_MOPetitionState AND b_del = 0) AS Status",
   "  from t_mopetition a",
   " Where dt_petitiondate = '",string(m),"/",string(d),"/",string(y),
    "' and b_del = 0 and i_owner = '"+BankCode+"' and i_mopetitiontype = 1 order by s_CheckCode"),RSDVAL_CLIENT, RSDVAL_STATIC );

  Terr = 0;
  While (Rec.MoveNext())  /* Сверка записи из ИНФОБАНК */
  /* Получение данных по переводу в RS-Retail */

   q = String("select count(*) as count FROM dpay_doc_dbt",
              " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
/*              " and T_ISCUR         = "+string(tIs_cur),  */ /* режим валюты */
              " and T_GROUPOPERT    = "+string(CO_PRIHOD),  /* прочие приходные */
              " and ((T_NUMOPERT    = "+string(SendBlic),")",
              " or   (T_NUMOPERT    = "+string(SendIBlicRUR),")",
              " or   (T_NUMOPERT    = "+string(SendIBlicUSD),")",
              " or   (T_NUMOPERT    = "+string(SendIBlicEUR),"))",
              " and T_DATE_DOCUMENT = "+sqlDateToStr(Rec.Fld("DateOper").Value), /* дата документа */
              " and T_ACTION        = 0",                              /* состояние документа */
              " and T_SOCIALNUMBER  = '"+Rec.Fld("KNP").Value+"'");                       /* номер перевода */
   cmd = RsdCommand(q);
   rs = RsdRecordSet(cmd); 
   rs.MoveNext();                
   If ((rs.Fld("count").Value) == 0)
   /* Нет перевода в RS-Retail */
    Terr        = Terr + 1;
    PrintHeadr1;
    PrintLine(Rec.Fld("KNP").Value,"Наличие в БД",tooem(Rec.Fld("Status").Value),"Отсутствует","");
    Else
   /* сравнение данных по переводy */
    tiknp       = tiknp + 1;
    Aknp(tiknp) = Rec.Fld("KNP").Value;
    q = String("select * FROM dpay_doc_dbt",
              " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
/*              " and T_ISCUR         = "+string(tIs_cur),  */ /* режим валюты */
              " and T_DATE_DOCUMENT = "+sqlDateToStr(Rec.Fld("DateOper").Value), /* дата документа */
              " and T_SOCIALNUMBER  = '"+Rec.Fld("KNP").Value+"'");                       /* номер перевода */
    cmd = RsdCommand(q);
    rs = RsdRecordSet(cmd); 
    While (rs.MoveNext()) /* Просмотр документов по переводу в RS-Retail */
    
    End; /* While RS-Retail*/               
   End;  /* If */
  End;   /* While ИНФОБАНК */

  /* Проверка наличия переводов из Rs-Retail в ИНФОБАНК по массиву переводов*/ 


  q = String("select * FROM dpay_doc_dbt",
            " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
            " and T_GROUPOPERT    = "+string(CO_PRIHOD),  /* прочие приходные */
            " and ((T_NUMOPERT    = "+string(SendBlic),")",
            " or   (T_NUMOPERT    = "+string(SendIBlicRUR),")",
            " or   (T_NUMOPERT    = "+string(SendIBlicUSD),")",
            " or   (T_NUMOPERT    = "+string(SendIBlicEUR),"))",
            " and T_ACTION        = 0",                          /* состояние документа */
            " and T_DATE_DOCUMENT = "+sqlDateToStr(DateReport)); /* дата документа */

  cmd = RsdCommand(q);
  rs = RsdRecordSet(cmd); 
  While (rs.MoveNext()) /* Просмотр документов по переводу в RS-Retail */
    If (Not (TestKNP(rs.Fld("T_SOCIALNUMBER").Value)))  /* Нет перевода в ИНФОБАНК */
      Terr        = Terr + 1;
      PrintHeadr1;
      PrintLine(Rs.Fld("T_SOCIALNUMBER").Value,"Наличие в БД","Отсутствует","Присутствует"); 
      tiknp       = tiknp + 1;
      Aknp(tiknp) = Rs.Fld("T_SOCIALNUMBER").Value;
    End; 
  End; /* While RS-Retail*/               

  If (Terr == 0)
    [  Расхождений не обнаружено!];
    [ ];
   else 
    [--------------------------------------------------------------------------];
    [ ];
  End;

/*****************************************************************************/
/*  Выплаченные переводы                                                     */
/*****************************************************************************/
  VidOpert = "ВЫПЛАЧЕННЫМ ПЕРЕВОДАМ";
  PrintHeard;

 /* Выборка из БД ИНФОБАНК по выплаченным переводам*/
  ClearRecord(rec);
  tiknp    = 0;

  Rec = RsdRecordset("DSN="+sconnect(sqlname),String("SELECT s_CheckCode as KNP,dt_petitiondate as dateoper,",
    " (SELECT s_name FROM t_mopetitionstate WHERE id = i_MOPetitionState AND b_del = 0) AS Status",
   "  from t_mopetition a",
   " Where dt_petitiondate = '",string(m),"/",string(d),"/",string(y),
    "' and b_del = 0 and i_owner = '"+BankCode+"' and i_mopetitiontype = 2 order by s_CheckCode"),RSDVAL_CLIENT, RSDVAL_STATIC );




  Terr = 0;
  While (Rec.MoveNext())  /* Сверка записи из ИНФОБАНК */
  /* Получение данных по переводу в RS-Retail */

   q = String("select count(*) as count FROM dpay_doc_dbt",
              " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
/*              " and T_ISCUR         = "+string(tIs_cur),  */ /* режим валюты */
              " and T_GROUPOPERT    = "+string(CO_RASHOD),  /* прочие расходные */
              " and ((T_NUMOPERT    = "+string(RecpBlic),")",
              " or   (T_NUMOPERT    = "+string(RecpIBlicRUR),")",
              " or   (T_NUMOPERT    = "+string(RecpIBlicUSD),")",
              " or   (T_NUMOPERT    = "+string(RecpIBlicEUR),"))",
              " and T_DATE_DOCUMENT = "+sqlDateToStr(Rec.Fld("DateOper").Value), /* дата документа */
              " and T_ACTION        = 0",                              /* состояние документа */
              " and T_SOCIALNUMBER  = '"+Rec.Fld("KNP").Value+"'");                       /* номер перевода */
   cmd = RsdCommand(q);
   rs = RsdRecordSet(cmd); 
   rs.MoveNext();                
   If ((rs.Fld("count").Value) == 0)
   /* Нет перевода в RS-Retail */
    Terr        = Terr + 1;
    PrintHeadr1;
    PrintLine(Rec.Fld("KNP").Value,"Наличие в БД",tooem(Rec.Fld("Status").Value),"Отсутствует","");
    Else
   /* сравнение данных по переводy */
    tiknp       = tiknp + 1;
    Aknp(tiknp) = Rec.Fld("KNP").Value;
    q = String("select * FROM dpay_doc_dbt",
              " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
/*              " and T_ISCUR         = "+string(tIs_cur), */  /* режим валюты */
              " and T_DATE_DOCUMENT = "+sqlDateToStr(Rec.Fld("DateOper").Value), /* дата документа */
              " and T_SOCIALNUMBER  = '"+Rec.Fld("KNP").Value+"'");                       /* номер перевода */
    cmd = RsdCommand(q);
    rs = RsdRecordSet(cmd); 
    While (rs.MoveNext()) /* Просмотр документов по первеоду в RS-Retail */
    
    End; /* While RS-Retail*/               
   End;  /* If */
  End;   /* While ИНФОБАНК */
  /* Проверка наличия переводов из Rs-Retail в ИНФОБАНК по массиву переводов*/
  q = String("select * FROM dpay_doc_dbt",
            " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
            " and T_GROUPOPERT    = "+string(CO_RASHOD),  /* прочие расходные */
            " and ((T_NUMOPERT    = "+string(RecpBlic),")",
            " or   (T_NUMOPERT    = "+string(RecpIBlicRUR),")",
            " or   (T_NUMOPERT    = "+string(RecpIBlicUSD),")",
            " or   (T_NUMOPERT    = "+string(RecpIBlicEUR),"))",
            " and T_ACTION        = 0",                          /* состояние документа */
            " and T_DATE_DOCUMENT = "+sqlDateToStr(DateReport)); /* дата документа */

  cmd = RsdCommand(q);
  rs = RsdRecordSet(cmd); 
  While (rs.MoveNext()) /* Просмотр документов по первеоду в RS-Retail */
    If (Not (TestKNP(rs.Fld("T_SOCIALNUMBER").Value)))  /* Нет перевода в ИНФОБАНК */
      Terr        = Terr + 1;
      PrintHeadr1;
      PrintLine(Rs.Fld("T_SOCIALNUMBER").Value,"Наличие в БД","Отсутствует","Присутствует");
      tiknp       = tiknp + 1;
      Aknp(tiknp) = Rs.Fld("T_SOCIALNUMBER").Value;
    End; 
  End; /* While RS-Retail*/               

  If (Terr == 0)
    [  Расхождений не обнаружено!];
    [ ];
   else 
    [--------------------------------------------------------------------------];
    [ ];
  End;


/*****************************************************************************/
/*  Возвращенные переводы                                                     */
/*****************************************************************************/
  VidOpert = "ВОЗВРАЩЕННЫМ ПЕРЕВОДАМ";
  PrintHeard;

 /* Выборка из БД ИНФОБАНК по возвращенным переводам*/
  ClearRecord(rec);
  tiknp    = 0;

  Rec = RsdRecordset("DSN="+sconnect(sqlname),String("SELECT s_CheckCode as KNP,dt_petitiondate as dateoper,",
    " (SELECT s_name FROM t_mopetitionstate WHERE id = i_MOPetitionState AND b_del = 0) AS Status",
   "  from t_mopetition a",
   " Where dt_petitiondate = '",string(m),"/",string(d),"/",string(y),
    "' and b_del = 0 and i_owner = '"+BankCode+"' and i_mopetitiontype = 3 order by s_CheckCode"),RSDVAL_CLIENT, RSDVAL_STATIC );



  Terr = 0;
  While (Rec.MoveNext())  /* Сверка записи из ИНФОБАНК */
  /* Получение данных по переводу в RS-Retail */

   q = String("select count(*) as count FROM dpay_doc_dbt",
              " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
/*              " and T_ISCUR         = "+string(tIs_cur), */  /* режим валюты */
              " and T_GROUPOPERT    = "+string(CO_RASHOD),  /* прочие расходные */
              " and ((T_NUMOPERT    = "+string(ReturnBlic),")",
              " or   (T_NUMOPERT    = "+string(ReturnIBlicRUR),")",
              " or   (T_NUMOPERT    = "+string(ReturnIBlicUSD),")",
              " or   (T_NUMOPERT    = "+string(ReturnIBlicEUR),"))",
              " and T_DATE_DOCUMENT = "+sqlDateToStr(Rec.Fld("DateOper").Value), /* дата документа */
              " and T_ACTION        = 0",                              /* состояние документа */
              " and T_SOCIALNUMBER  = '"+Rec.Fld("KNP").Value+"'");    /* номер перевода */

   cmd = RsdCommand(q);
   rs = RsdRecordSet(cmd); 
   rs.MoveNext();                
   If ((rs.Fld("count").Value) == 0)
   /* Нет перевода в RS-Retail */
    Terr        = Terr + 1;
    PrintHeadr1;
    PrintLine(Rec.Fld("KNP").Value,"Наличие в БД",tooem(Rec.Fld("Status").Value),"Отсутствует","");
    Else
   /* сравнение данных по переводy */
    tiknp       = tiknp + 1;
    Aknp(tiknp) = Rec.Fld("KNP").Value;
    q = String("select * FROM dpay_doc_dbt",
              " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
/*              " and T_ISCUR         = "+string(tIs_cur), */  /* режим валюты */
              " and T_DATE_DOCUMENT = "+sqlDateToStr(Rec.Fld("DateOper").Value), /* дата документа */
              " and T_SOCIALNUMBER  = '"+Rec.Fld("KNP").Value+"'");                       /* номер перевода */
    cmd = RsdCommand(q);
    rs = RsdRecordSet(cmd); 
    While (rs.MoveNext()) /* Просмотр документов по переводу в RS-Retail */
    
    End; /* While RS-Retail*/               
   End;  /* If */
  End;   /* While ИНФОБАНК */
  /* Проверка наличия переводов из Rs-Retail в ИНФОБАНК по массиву переводов*/
  q = String("select * FROM dpay_doc_dbt",
            " Where T_FNCASH      = "+String(ReportFNCash),  /* подразделение */
            " and T_GROUPOPERT    = "+string(CO_RASHOD),  /* прочие расходные */
            " and ((T_NUMOPERT    = "+string(ReturnBlic),")",
            " or   (T_NUMOPERT    = "+string(ReturnIBlicRUR),")",
            " or   (T_NUMOPERT    = "+string(ReturnIBlicUSD),")",
            " or   (T_NUMOPERT    = "+string(ReturnIBlicEUR),"))",
            " and T_ACTION        = 0",                          /* состояние документа */
            " and T_DATE_DOCUMENT = "+sqlDateToStr(DateReport)); /* дата документа */

  cmd = RsdCommand(q);
  rs = RsdRecordSet(cmd); 
  While (rs.MoveNext()) /* Просмотр документов по переводу в RS-Retail */
    If (Not (TestKNP(rs.Fld("T_SOCIALNUMBER").Value)))  /* Нет перевода в ИНФОБАНК */
      Terr        = Terr + 1;
      PrintHeadr1;
      PrintLine(Rs.Fld("T_SOCIALNUMBER").Value,"Наличие в БД","Отсутствует","Присутствует");
      tiknp       = tiknp + 1;
      Aknp(tiknp) = Rs.Fld("T_SOCIALNUMBER").Value;
    End; 
  End; /* While RS-Retail*/               

  If (Terr == 0)
    [  Расхождений не обнаружено!];
    [ ];
   else 
    [--------------------------------------------------------------------------];
    [ ];
  End;
End;

macro DlgHndlr( IP, cmd, id, key )

  var stat = CM_DEFAULT;
  var i;

  /* ==================== Обработчик клавиатуры ===================== */
  if (cmd == DLG_KEY)
    /* Esc ----------------------------------------------------- */
    if (key == 27)
      ;
    /* F3 ------------------------------------------------------ */
    elif (key == 317)
      if (id == ne_NameBranch)
        ListDep();
      end;
    /* F9 ------------------------------------------------------ */
    elif (key == 323)
      stat = CM_IGNORE;
    /* F7 ------------------------------------------------------ */
    elif (key == 321)
      stat = CM_SAVE;
    end;
  /* ========================== Сохранение ========================== */
  elif (cmd == DLG_SAVE)
    if( Panel.BegDate > Panel.EndDate )
       msgbox( "Дата начала периода не может быть больше даты конца!" );
       return CM_CANCEL;
    end;
  end;

  return stat;

end;

macro InitFields

  Panel.EndDate   = {curdate};
  Panel.BegDate   = {curdate};
  i               = FNCash;
  listfdep.FNCash = FNCash;
  ReportFNCash    = FNCash;
  if( not getEQ( listfdep ) )
    exit( 1 );
  else
    Panel.NameBranch = listfdep.NameBranch;
    BankName         = listfdep.NameBranch+" "+listfdep.Desc;
    NameBranch       = listfdep.NameBranch;
  end;


end;

macro getnameoper /* Чтение записи Операциониста */

  opr.Clear();
  opr.rec.Oper = {Oper};
  if ( opr.GetEQ() )
    sOper = opr.rec.Name;
    else
    sOper = "???";
  end;

End;

macro printrep /* печать отчета по параметрам */

    If  (ReportFNCash > 0)
       DateReport       = Panel.BegDate;
       While (Not (DateReport > Panel.EndDate))
         PrintReport;
         [ ];
         [ ];
         DateReport     = DateReport + 1;
       End;
      else
      i  = 1;
      while (not (i > icount))
       ReportFNCash     = AFNCash(i);
       BankName         = ANBranch(i)+" "+ANBank(i);
       NameBranch       = ANBranch(i);
       DateReport       = Panel.BegDate;
       While (Not (DateReport > Panel.EndDate))
         PrintReport;
         [ ];
         [ ];
         DateReport     = DateReport + 1;
       End;
       i = i+1;
      End;
    End;

End;

macro PrintAll  /*Запуск отчета с выбором параметров */

  getnameoper;
  
  /* Определение дат отчета при инициализации */
  InitFields;

  /* Формирование меню подразделений */
  i             = 0;
  AFNCash(0)    = -1;
  ANBranch(0)   = "По всем";
  ANBank(0)     = "";
  MenuName(0)   = " " + SubStr(ANBranch(0) + MkStr(" ",12),1,12) + " ";
  ReWind(listfdep);
  while (Next(listfdep))
    i = i + 1;
    AFNCash(i)  = listfdep.FNCash;
    ANBranch(i) = listfdep.NameBranch;
    ANBank(i)   = listfdep.Desc;
    MenuName(i) = " " + SubStr(listfdep.NameBranch + MkStr(" ",12),1,12) + "   " + listfdep.Desc + " ";
  end;
  icount        = i;

  /* Выполнение отчета */
  if( RunDialog( Panel,"DlgHndlr" ) )
    PrintRep;
    Rec.Close();
    Clearstructs;
    else
    [Вы отказались от формирования отчета!];
  end;

End;

macro PrintDay  /*Запуск отчета без выбора параметров */

  getnameoper;
  
  /* Определение дат отчета при инициализации */
  InitFields;

  printrep;

End;