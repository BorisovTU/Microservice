
/* Конвертация файла вкладчиков с разбиением документа по полям */

import deprintr;

file DepClnt( "depclnt.dbt" ) write;
file DepClntO( "depclnt.dbt", "sbbank.old" );

const
  Spin = "|/-\\|";

var
  NRecs = 0;

macro ShowProgress
  
  var
    N;
     
  NRecs = NRecs + 1;
  N = NRecs / 30; 
  Message( " " + SubStr( Spin, 1 + N - Int( N / 5 ) * 5, 1 ) +
    " Обработано " + NRecs + " записей" );
end;

macro CopyClnt

  ClearRecord( DepClnt );
  DepClnt.CodClient	 = DepClntO.CodClient;
  DepClnt.Sname 	 = DepClntO.Sname;
  DepClnt.Name		 = DepClntO.Name;
  DepClnt.Pname		 = DepClntO.Pname;
  DepClnt.Borndate	 = DepClntO.Borndate;
  DepClnt.Adress	 = DepClntO.Adress;
  DepClnt.Grouptype	 = DepClntO.Grouptype;
  DepClnt.Groupauthor	 = DepClntO.Groupauthor;
  DepClnt.Groupwill	 = DepClntO.Groupwill;
  DepClnt.Adress2	 = DepClntO.Adress2;
  DepClnt.NumSession	 = DepClntO.NumSession;
  DepClnt.UserField1	 = DepClntO.UserField1;
  DepClnt.UserField2	 = DepClntO.UserField2;
  DepClnt.UserField3	 = DepClntO.UserField3;
  DepClnt.UserField4	 = DepClntO.UserField4;
  DepClnt.Kategor	 = DepClntO.Kategor;
  DepClnt.FNcash	 = DepClntO.FNcash;
  DepClnt.Citizenship	 = DepClntO.Citizenship;
  DepClnt.SocialNumber	 = DepClntO.SocialNumber;
  DepClnt.RegistrDate	 = DepClntO.RegistrDate;
  DepClnt.Action	 = DepClntO.Action;
  DepClnt.IsLiterate	 = DepClntO.IsLiterate;
  DepClnt.TakeIncomTax	 = DepClntO.TakeIncomTax;
  DepClnt.PersIDType	 = DepClntO.PersIDType;
  DepClnt.SpecialAccess	 = DepClntO.SpecialAccess;
  if ( DepClntO.PersIDType == 0 )
    return SplitPersIDStr( DepClntO.DocIdMan, DepClnt );  
  else
    DepClnt.PersIDExtra = DepClntO.DocIdMan;
    return false;
  end;
end;

  if ( not Open( DepClntO, "depclnt.old" ) )
    MsgBox( "Файл не открыт: depclnt.old" );
    Exit( -1 );
  end;

  PrintLn( "Вкладчики, для которых не было выполнено разбиение" );

  [ ];
  [ Код      ФИО                                      Код док. Информация о документе                                        ];
  [ ];
  Rewind( DepClntO );
  while ( Next( DepClntO ) )
    if ( not CopyClnt )
      [ ######## ######################################## ######## ############################################################# ]
      (
        DepClntO.CodClient,
        String( DepClntO.Sname + " " + DepClntO.Name + " " + DepClntO.Pname ):w,
        DepClntO.PersIDType,
        DepClntO.DocIdMan
      );
    end;
    if ( not Insert( DepClnt ) )
      MsgBox( "Ошибка вставки записи " + Status );
      Exit( -1 );
    end;
    ShowProgress;
  end;
end;