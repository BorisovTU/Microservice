/*
$Name:             doctor_eoy.mac
$Module:           RS-Retail
$Description:      Подготовка базы данных текущего филиала к квартальной капитализации.
*/

/***********************************************************************************\
*  ---------------------------------------------------------------------------------*
*  Северный банк СБ РФ                                                              *
*  ---------------------------------------------------------------------------------*
*  RS-Retail  v.6.00.004  (doctor_eoy.mac)                                          *
*                                                                                   *
*  Обслуживание физ. лиц.                                                           * 
*                                                                                   *
*  Подготовка базы данных текущего филиала к квартальной капитализации.             *
*  (написан по мотивам скриптов Архангельского ОСБ № 8637 )                         *
*                                                                                   *
*  Идея(с) ОВиСРС  Северного банка СБ РФ  (Бобрешов С.Л., Катин И.Н.)               *
*                                                                                   *
*   21.03.2008  - создан .                                                          *
*   14.04.2008 Катин И.Н. параметеризированы sql - запросы.                         *
\***********************************************************************************/

import DeprIntr, sqlconv, rsd, cb_sql;

private var NumKvartal = 0;
private var {curdate};
private var Branch     = NumFncash();


private macro Наименование_ВСП(Br)

 var sqllfd, cmdlfd, rsmlfd;
 var NameVsp = "";  

   cmdlfd = RsdCommand(" select T_NameBranch, T_Desc from dlistfdep_dbt " + 
                       " where T_Fncash = ? " );                  

   
   cmdlfd.addParam("Fncash",  RSDBP_IN);  
   cmdlfd.Param("Fncash").value = Br; 

   cmdlfd.execute;
   rsmlfd = RsdRecordset( cmdlfd );

   if( rsmlfd.moveNext )
      NameVsp = " № " + rsmlfd.value("T_NameBranch") + ", " + rsmlfd.value("T_Desc");
   end;

    return NameVsp;

end;


private macro Найдем_ISO( inCode_Currency )

 var sqlcur, cmdcur, rsmcur;
 var sISO = "???";

 cmdcur = RsdCommand(" SELECT Trim(t_Short_Name) as t_Short_Name " +
                     " FROM  dcurrency_dbt " +
                     " WHERE t_Code_Currency = ? ");

 cmdcur.addParam("Codeсur",  RSDBP_IN);  
 cmdcur.Param("Codeсur").value = inCode_Currency; 

                     
 cmdcur.execute;
 rsmcur = RsdRecordset(cmdcur);

 if(rsmcur.MoveNext)
    sISO = rsmcur.value("t_Short_Name");
 end;

 return  sISO;

end;


private macro Выбор_квартала()
 
 array kvartal;
 var выбор;
 var mm;

    kvartal(0) = " 1 квартал ( с 1 января по 31 марта) ";
    kvartal(1) = " 2 квартал ( с 1 апреля по 30 июня ) ";
    kvartal(2) = " 3 квартал ( с 1 июля   по 30 октября) ";
    kvartal(3) = " 4 квартал ( с 1 ноября по 31 декабря) ";

    выбор = menu( kvartal, "Выберите квартал, который вы собираетесь закрыть: " );

    NumKvartal = выбор + 1;
    // Выполним защиту от ...
    DateSplit({curdate},NULL,mm,NULL);
    
    if((mm >= 1) AND (mm <= 3) AND (NumKvartal != 1))
      Msgbox("Системная дата не соответсвует дате выбранного квартала : ",NumKvartal );
      exit(1);
    elif((mm >= 4) AND (mm <= 6) AND (NumKvartal != 2))
      Msgbox("Системная дата не соответсвует дате выбранного квартала : ",NumKvartal );
      exit(1);
    elif((mm >= 7) AND (mm <= 9) AND (NumKvartal != 3))
      Msgbox("Системная дата не соответсвует дате выбранного квартала : ",NumKvartal );
      exit(1);
    elif((mm >= 10) AND (mm <= 12) AND (NumKvartal != 4))
      Msgbox("Системная дата не соответсвует дате выбранного квартала : ",NumKvartal );
      exit(1);
    end;


end;


private macro Проверка_БД()

 var sqlprov, cmdprov, rsmprov;
 var FlagOsb   = FALSE;
 var DataKvart = Date(00,00,0000);
 var YYYY;
 var n = 1;

 DateSplit({curdate},NULL,NULL,YYYY);


   // Заполним дату
 if(NumKvartal == 1)
    DataKvart =  Date(31,03,YYYY);
 elif(NumKvartal == 2)
    DataKvart =  Date(30,06,YYYY);
 elif(NumKvartal == 3)
    DataKvart =  Date(30,09,YYYY);
 elif(NumKvartal == 4)
    DataKvart =  Date(31,12,YYYY);
 else
  Msgbox("Не определен квартал для обработки. Дальнейшее выполнение остановлено...");
  exit(1);
 end;


     // Шапочку напечатаем
 [ ];
 [ ];
 [              ПРОТОКОЛ  ПРОВЕРКИ  БД  НА  НАЛИЧИЕ  РАСХОЖДЕНИЙ  В  ДАННЫХ  ОСНОВНЫХ  ТАБЛИЦ  СЧЕТА  КЛИЕНТА                            ]; 
 [ ];
 [                                         на дату : #############################################                                       ]
 ({curdate}:m:l);
 [ ];
 [        Наименование филиала банка: #######################################################                                            ]
 (Наименование_ВСП(Branch):l);
 [ ];
 [+=======+===+======================+============+=====+===============+===============+===============+===============+===============+];
 [|   №   |FN |    Номер   счета     | Вид вклада | Iso | Остаток счета | Остаток счета | Остаток счета | Проценты к опл| Проценты к опл|];
 [|  п/п  |фил|       клиента        |(кор.назван)| код | ddepositr_dbt | dsbdepdoc_dbt | dpc_drest_dbt | dsbdepdoc_dbt | dpc__calc_dbt |];
 [+=======+===+======================+============+=====+===============+===============+===============+===============+===============+];

 Message("Ждите... Идет выборка данных в БД филиала...");


/* Formatted on 2008/03/10 14:20 (Formatter Plus v4.8.6) */
 cmdprov = RsdCommand(" SELECT   * " +
          " FROM (SELECT fordep.t_fncash, fordep.t_referenc, fordep.t_iscur, fordep.t_code_currency, " +
          "       fordep.t_account, fordep.t_type_account, fordep.t_number, " +
          "       fordep.t_sum_rest, fordep.t_typeobject, " +
          "       fordep.t_usertypeaccount, " +
          "       quart8637.restondate (fordep.t_referenc, ? " +  
          "                          ) t_sbd_rest, " +
          "       quart8637.restprocondate (fordep.t_referenc, ? " + 
          "                                ) t_sbd_perc, " +
          "       quart8637.procforpay (fordep.t_referenc, ? " + 
          "                            ) t_perc_for_pay, " +
          "       quart8637.restfrom_pc_drest " +
          "                         (fordep.t_referenc, " +
          "                          fordep.t_typeobject, ? " + 
          "                         ) t_rest_from_pc_drest " +
          "  FROM (SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, "  +
          "               dep.t_account, dep.t_type_account, dep.t_number, "   +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END "  + 
          "               ) t_typeobject " + 
          "          FROM ddepositr_dbt dep "  +
          "            WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 0 " +
          "           AND (    dep.t_type_account != 'Целев. дети' " +
          "                AND dep.t_type_account != 'Целевой на д' " +
          "               ) " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      dep.t_type_account, ? " + 
          "                                     ) = 3 " +
          "        UNION " +
          "        SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, " +
          "               dep.t_account, dep.t_type_account, dep.t_number, " +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END " + 
          "               ) t_typeobject " +
          "          FROM ddepositr_dbt dep, dpc_apltp_dbt apl " +
          "          WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 1 " +
          "           AND apl.t_type = dep.t_type_account " +
          "           AND apl.t_iscur = dep.t_iscur " +
          "           AND apl.t_appltype = 2002 " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      apl.t_aptype, ? " + 
          "                                     ) = 3) fordep) " +
          " WHERE t_sum_rest != t_rest_from_pc_drest " +
          "   OR t_sbd_perc != t_perc_for_pay " +
          "   OR (t_perc_for_pay < 0) " +
          "   OR t_sbd_rest != ROUND (t_sbd_rest, 2) " +
          "   OR t_sum_rest != ROUND (t_sum_rest, 2) " +
          "   OR t_sbd_perc != ROUND (t_sbd_perc, 2) " +
          "   OR t_perc_for_pay != ROUND (t_perc_for_pay, 2) " +
          "   OR t_rest_from_pc_drest != ROUND (t_rest_from_pc_drest, 2) " +
          "   ORDER BY t_code_currency, t_type_account, t_number ");

   cmdprov.addParam("DataKv1",  RSDBP_IN);  
   cmdprov.Param("DataKv1").value = DataKvart; 

   cmdprov.addParam("DataKv2",  RSDBP_IN);  
   cmdprov.Param("DataKv2").value = DataKvart; 

   cmdprov.addParam("DataKv3",  RSDBP_IN);  
   cmdprov.Param("DataKv3").value = DataKvart; 

   cmdprov.addParam("DataKv4",  RSDBP_IN);  
   cmdprov.Param("DataKv4").value = DataKvart; 

   cmdprov.addParam("fncash1",  RSDBP_IN);  
   cmdprov.Param("fncash1").value = Branch; 

   cmdprov.addParam("DataKv5",  RSDBP_IN);  
   cmdprov.Param("DataKv5").value = DataKvart; 

   cmdprov.addParam("fncash2",  RSDBP_IN);  
   cmdprov.Param("fncash2").value = Branch; 

   cmdprov.addParam("DataKv6",  RSDBP_IN);  
   cmdprov.Param("DataKv6").value = DataKvart; 
       
   cmdprov.execute;
   rsmprov = RsdRecordset(cmdprov);
   while( rsmprov.moveNext )
  
    Message(" Ждите... Идет выборка счетов с ошибками ...");

   [|#######|###|######################|############|#####|###############|###############|###############|###############|###############|]
   (n:c,rsmprov.value("T_FnCash"):c,rsmprov.value("T_Account"),rsmprov.value("T_Type_Account"), Найдем_ISO(rsmprov.value("T_Code_Currency")):c,
    rsmprov.value("T_Sum_Rest"):r, rsmprov.value("T_Sbd_Rest"):r,rsmprov.value("T_Rest_From_pc_drest"):r,
    rsmprov.value("T_Sbd_Perc"):r, rsmprov.value("T_Perc_For_Pay"):r);

   [+-------+---+----------------------+------------+-----+---------------+---------------+---------------+---------------+---------------+];

     n = n + 1;
   end;

end;

private macro Подготовка_детских() 

 var sqldep, cmddep, rsmdep;
 var sqldel, cmddel;
 var startdate = Date(00,00,0000);
 var enddate   = Date(00,00,0000);
 var YYYY;

   DateSplit({curdate},NULL,NULL,YYYY);

     // Заполним даты
   if(NumKvartal == 1)
      startdate =  Date(01,04,YYYY);
      enddate   =  Date(30,06,YYYY);
   elif(NumKvartal == 2)
      startdate =  Date(01,06,YYYY);
      enddate   =  Date(30,09,YYYY);
   elif(NumKvartal == 3)
      startdate =  Date(01,10,YYYY);
      enddate   =  Date(31,12,YYYY);
   elif(NumKvartal == 4)
      startdate =  Date(01,01,YYYY + 1);
      enddate   =  Date(31,03,YYYY + 1);
   else
    Msgbox("Не определен квартал для обработки. Дальнейшее выполнение остановлено...");
    exit(1);
   end;

   cmddep = RsdCommand(" SELECT /*+ index(DDEPOSITR_DBT DDEPOSITR_DBT_IDX6)*/ t_referenc " + 
            " from ddepositr_dbt " +
            " where t_iscur >= 0 " + // все валюты
            " and t_fncash = ? "   + //  ВСП
            " and t_type_account IN ('Целев. дети', 'Целевой на д') " + //для валюты-свой 
            " and t_usealternate = 1 " + // счета в альтернативе
            " and t_open_close <> 'З'"); // счета не закрыты


   cmddep.addParam("fncash",  RSDBP_IN);  
   cmddep.Param("fncash").value = Branch; 

   cmddep.execute;
   rsmdep = RsdRecordset(cmddep);
   while( rsmdep.moveNext )

    Message(" Ждите... Идет корректировка детских видов вкладов ...");

    cmddel = RsdCommand(" delete from dpc__calc_dbt " + 
                        " where t_referenc = ? " + 
                        " and t_objecttype = 2002 " +
                        " and t_typerecord = 1 " +
                        " and t_enddate    = ? " + 
                        " and t_begindate  = ? ");

   cmddel.addParam("referenc",  RSDBP_IN);  
   cmddel.Param("referenc").value = rsmdep.value("t_referenc"); 

   cmddel.addParam("enddate",  RSDBP_IN);  
   cmddel.Param("enddate").value = enddate; 

   cmddel.addParam("begindate",  RSDBP_IN);  
   cmddel.Param("begindate").value = startdate; 

   cmddel.Execute;



   end;

end;

private macro Лечение_счетов()

 var sqldep, cmddep, rsmdep;
 var sqlupd, cmdupd;
 var startdate = Date(00,00,0000);
 var datequart = Date(00,00,0000);
 var YYYY;

   DateSplit({curdate},NULL,NULL,YYYY);
   // Заполним дату
 if(NumKvartal == 1)
    startdate =  Date(01,01,YYYY);
    datequart =  Date(31,03,YYYY);
 elif(NumKvartal == 2)
    startdate =  Date(01,04,YYYY);
    datequart =  Date(30,06,YYYY);
 elif(NumKvartal == 3)
    startdate =  Date(01,07,YYYY);
    datequart =  Date(30,09,YYYY);
 elif(NumKvartal == 4)
    startdate =  Date(01,10,YYYY);
    datequart =  Date(31,12,YYYY);
 else
  Msgbox("Не определен квартал для обработки. Дальнейшее выполнение остановлено...");
  exit(1);
 end;

/* Formatted on 2008/03/10 14:20 (Formatter Plus v4.8.6) */
 cmddep = RsdCommand(" SELECT   t_referenc " +
          " FROM (SELECT fordep.t_fncash, fordep.t_referenc, fordep.t_iscur, fordep.t_code_currency, " +
          "       fordep.t_account, fordep.t_type_account, fordep.t_number, " +
          "       fordep.t_sum_rest, fordep.t_typeobject, " +
          "       fordep.t_usertypeaccount, " +
          "       quart8637.restondate (fordep.t_referenc, ? " +  
          "                          ) t_sbd_rest, " +
          "       quart8637.restprocondate (fordep.t_referenc, ? " + 
          "                                ) t_sbd_perc, " +
          "       quart8637.procforpay (fordep.t_referenc, ? " + 
          "                            ) t_perc_for_pay, " +
          "       quart8637.restfrom_pc_drest " +
          "                         (fordep.t_referenc, " +
          "                          fordep.t_typeobject, ? " + 
          "                         ) t_rest_from_pc_drest " +
          "  FROM (SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, "  +
          "               dep.t_account, dep.t_type_account, dep.t_number, "   +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END "  + 
          "               ) t_typeobject " + 
          "          FROM ddepositr_dbt dep "  +
          "            WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 0 " +
          "           AND (    dep.t_type_account != 'Целев. дети' " +
          "                AND dep.t_type_account != 'Целевой на д' " +
          "               ) " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      dep.t_type_account, ? " + 
          "                                     ) = 3 " +
          "        UNION " +
          "        SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, " +
          "               dep.t_account, dep.t_type_account, dep.t_number, " +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END " + 
          "               ) t_typeobject " +
          "          FROM ddepositr_dbt dep, dpc_apltp_dbt apl " +
          "          WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 1 " +
          "           AND apl.t_type = dep.t_type_account " +
          "           AND apl.t_iscur = dep.t_iscur " +
          "           AND apl.t_appltype = 2002 " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      apl.t_aptype, ? " + 
          "                                     ) = 3) fordep) " +
          " WHERE t_sbd_rest != ROUND (t_sbd_rest, 2) " +
          "   OR t_sum_rest != ROUND (t_sum_rest, 2) " +
          "   OR t_sbd_perc != ROUND (t_sbd_perc, 2) " +
          "   OR t_perc_for_pay != ROUND (t_perc_for_pay, 2) " +
          "   OR t_rest_from_pc_drest != ROUND (t_rest_from_pc_drest, 2) ");

   cmddep.addParam("DataKv1",  RSDBP_IN);  
   cmddep.Param("DataKv1").value = datequart; 

   cmddep.addParam("DataKv2",  RSDBP_IN);  
   cmddep.Param("DataKv2").value = datequart; 

   cmddep.addParam("DataKv3",  RSDBP_IN);  
   cmddep.Param("DataKv3").value = datequart; 

   cmddep.addParam("DataKv4",  RSDBP_IN);  
   cmddep.Param("DataKv4").value = datequart; 

   cmddep.addParam("fncash1",  RSDBP_IN);  
   cmddep.Param("fncash1").value = Branch; 

   cmddep.addParam("DataKv5",  RSDBP_IN);  
   cmddep.Param("DataKv5").value = datequart; 

   cmddep.addParam("fncash2",  RSDBP_IN);  
   cmddep.Param("fncash2").value = Branch; 

   cmddep.addParam("DataKv6",  RSDBP_IN);  
   cmddep.Param("DataKv6").value = datequart; 
       

   
   cmddep.execute;
   rsmdep = RsdRecordset(cmddep);
   while( rsmdep.moveNext )

   Message(" Ждите... Идет округление сумм до двух знаков после запятой в основных таблицах счетов ...");
   cmdupd = RsdCommand(" UPDATE dsbdepdoc_dbt " +
                       " SET t_insum = ROUND (t_insum, 2), " +
                       " t_outsum = ROUND (t_outsum, 2), " + 
                       " t_rest = ROUND (t_rest, 2), " +
                       " t_percrest = ROUND (t_percrest, 2) " +
                       " WHERE t_referenc = ? " + 
                       " AND t_date_document >= ? ");

   cmdupd.addParam("referenc",  RSDBP_IN);  
   cmdupd.Param("referenc").value = rsmdep.value("t_referenc"); 

   cmdupd.addParam("date",  RSDBP_IN);  
   cmdupd.Param("date").value = startdate; 
    
   cmdupd.Execute;

   cmdupd = RsdCommand(" UPDATE dpcestim_dbt " +
                       " SET t_summaprogn = ROUND (t_summaprogn, 2), " +
                       " t_summacalc = ROUND (t_summacalc, 2), " +
                       " t_summapay_rest = ROUND (t_summapay_rest, 2), " +
                       " t_summapay_in = ROUND (t_summapay_in, 2), " +
                       " t_summapay_out = ROUND (t_summapay_out, 2) " +
                       " WHERE t_referenc = ? " + 
                       " AND t_dateoperat >= ? " );


   cmdupd.addParam("referenc",  RSDBP_IN);  
   cmdupd.Param("referenc").value = rsmdep.value("t_referenc"); 

   cmdupd.addParam("date",  RSDBP_IN);  
   cmdupd.Param("date").value = startdate; 

   cmdupd.Execute;

   cmdupd = RsdCommand(" UPDATE dpc__calc_dbt " +
                       " SET t_sumcalc = ROUND (t_sumcalc, 2), " +
                       " t_sumpay = ROUND (t_sumpay, 2), " +
                       " t_sumforpay = ROUND (t_sumforpay, 2) " +
                       " WHERE t_referenc = ? " + 
                       " AND t_begindate >= ? ");



   cmdupd.addParam("referenc",  RSDBP_IN);  
   cmdupd.Param("referenc").value = rsmdep.value("t_referenc"); 

   cmdupd.addParam("date",  RSDBP_IN);  
   cmdupd.Param("date").value = startdate; 

   cmdupd.Execute;

   cmdupd = RsdCommand(" UPDATE dpc_drest_dbt " +
                       " SET t_rest = ROUND (t_rest, 2) " +
                       " WHERE t_referenc = ? " + 
                       " AND t_date_rest >= ? " );




   cmdupd.addParam("referenc",  RSDBP_IN);  
   cmdupd.Param("referenc").value = rsmdep.value("t_referenc"); 

   cmdupd.addParam("date",  RSDBP_IN);  
   cmdupd.Param("date").value = startdate; 

   cmdupd.Execute;
   
   end;

end;

private macro Лечение_остатков()

 
 var sqldep, cmddep, rsmdep;
 var sqlupd, cmdupd;
 var startdate = Date(00,00,0000);
 var datequart = Date(00,00,0000);
 var YYYY;

   DateSplit({curdate},NULL,NULL,YYYY);
   // Заполним дату
 if(NumKvartal == 1)
    startdate =  Date(01,01,YYYY);
    datequart =  Date(31,03,YYYY);
 elif(NumKvartal == 2)
    startdate =  Date(01,04,YYYY);
    datequart =  Date(30,06,YYYY);
 elif(NumKvartal == 3)
    startdate =  Date(01,07,YYYY);
    datequart =  Date(30,09,YYYY);
 elif(NumKvartal == 4)
    startdate =  Date(01,10,YYYY);
    datequart =  Date(31,12,YYYY);
 else
  Msgbox("Не определен квартал для обработки. Дальнейшее выполнение остановлено...");
  exit(1);
 end;

/* Formatted on 2008/03/10 14:20 (Formatter Plus v4.8.6) */
 cmddep = RsdCommand(" SELECT   * " +
          " FROM (SELECT fordep.t_fncash, fordep.t_referenc, fordep.t_iscur, fordep.t_code_currency, " +
          "       fordep.t_account, fordep.t_type_account, fordep.t_number, " +
          "       fordep.t_sum_rest, fordep.t_typeobject, " +
          "       fordep.t_usertypeaccount, " +
          "       quart8637.restondate (fordep.t_referenc, ? " +  
          "                          ) t_sbd_rest, " +
          "       quart8637.restprocondate (fordep.t_referenc, ? " + 
          "                                ) t_sbd_perc, " +
          "       quart8637.procforpay (fordep.t_referenc, ? " + 
          "                            ) t_perc_for_pay, " +
          "       quart8637.restfrom_pc_drest " +
          "                         (fordep.t_referenc, " +
          "                          fordep.t_typeobject, ? " + 
          "                         ) t_rest_from_pc_drest " +
          "  FROM (SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, "  +
          "               dep.t_account, dep.t_type_account, dep.t_number, "   +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END "  + 
          "               ) t_typeobject " + 
          "          FROM ddepositr_dbt dep "  +
          "            WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 0 " +
          "           AND (    dep.t_type_account != 'Целев. дети' " +
          "                AND dep.t_type_account != 'Целевой на д' " +
          "               ) " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      dep.t_type_account, ? " + 
          "                                     ) = 3 " +
          "        UNION " +
          "        SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, " +
          "               dep.t_account, dep.t_type_account, dep.t_number, " +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END " + 
          "               ) t_typeobject " +
          "          FROM ddepositr_dbt dep, dpc_apltp_dbt apl " +
          "          WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 1 " +
          "           AND apl.t_type = dep.t_type_account " +
          "           AND apl.t_iscur = dep.t_iscur " +
          "           AND apl.t_appltype = 2002 " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      apl.t_aptype, ? " + 
          "                                     ) = 3) fordep) " +
          " WHERE t_sum_rest != t_rest_from_pc_drest ");
 
   cmddep.addParam("DataKv1",  RSDBP_IN);  
   cmddep.Param("DataKv1").value = datequart; 

   cmddep.addParam("DataKv2",  RSDBP_IN);  
   cmddep.Param("DataKv2").value = datequart; 

   cmddep.addParam("DataKv3",  RSDBP_IN);  
   cmddep.Param("DataKv3").value = datequart; 

   cmddep.addParam("DataKv4",  RSDBP_IN);  
   cmddep.Param("DataKv4").value = datequart; 

   cmddep.addParam("fncash1",  RSDBP_IN);  
   cmddep.Param("fncash1").value = Branch; 

   cmddep.addParam("DataKv5",  RSDBP_IN);  
   cmddep.Param("DataKv5").value = datequart; 

   cmddep.addParam("fncash2",  RSDBP_IN);  
   cmddep.Param("fncash2").value = Branch; 

   cmddep.addParam("DataKv6",  RSDBP_IN);  
   cmddep.Param("DataKv6").value = datequart; 
       

   cmddep.execute;
   rsmdep = RsdRecordset(cmddep);
   while( rsmdep.moveNext )

    Message(" Ждите... Идет корректировка остатков для расчета процентов (dpc_drest_dbt) ...");
   cmdupd = RsdCommand(" UPDATE dpc_drest_dbt " +
                       " SET t_rest = ? " + 
                       " WHERE t_referenc = ? " + 
                       " AND t_date_rest = " + 
                       " (SELECT NVL (MAX(pc.t_date_rest), ? ) " +
                       " FROM dpc_drest_dbt pc " +
                       " WHERE pc.t_referenc = ? " + 
                       " AND pc.t_type_object = ? ) "); 



   cmdupd.addParam("rest",  RSDBP_IN);  
   cmdupd.Param("rest").value = rsmdep.value("t_sum_rest"); 

   cmdupd.addParam("referenc",  RSDBP_IN);  
   cmdupd.Param("referenc").value = rsmdep.value("t_referenc"); 

   cmdupd.addParam("date",  RSDBP_IN);  
   cmdupd.Param("date").value = datequart; 

   cmdupd.addParam("referenc1",  RSDBP_IN);  
   cmdupd.Param("referenc1").value = rsmdep.value("t_referenc"); 

   cmdupd.addParam("object",  RSDBP_IN);  
   cmdupd.Param("object").value = rsmdep.value("t_typeobject"); 

   cmdupd.Execute;

   end;

end;

private macro Лечение_процентов()
 var sqldep, cmddep, rsmdep;
 var sqldoc, cmddoc, rsmdoc;
 var sqlupd, cmdupd;
 var startdate = Date(00,00,0000);
 var datequart = Date(00,00,0000);
 var YYYY;

   DateSplit({curdate},NULL,NULL,YYYY);
   // Заполним дату
 if(NumKvartal == 1)
    startdate =  Date(01,01,YYYY);
    datequart =  Date(31,03,YYYY);
 elif(NumKvartal == 2)
    startdate =  Date(01,04,YYYY);
    datequart =  Date(30,06,YYYY);
 elif(NumKvartal == 3)
    startdate =  Date(01,07,YYYY);
    datequart =  Date(30,09,YYYY);
 elif(NumKvartal == 4)
    startdate =  Date(01,10,YYYY);
    datequart =  Date(31,12,YYYY);
 else
  Msgbox("Не определен квартал для обработки. Дальнейшее выполнение остановлено...");
  exit(1);
 end;

/* Formatted on 2008/03/10 14:20 (Formatter Plus v4.8.6) */
 cmddep = RsdCommand(" SELECT   * " +
          " FROM (SELECT fordep.t_fncash, fordep.t_referenc, fordep.t_iscur, fordep.t_code_currency, " +
          "       fordep.t_account, fordep.t_type_account, fordep.t_number, " +
          "       fordep.t_sum_rest, fordep.t_typeobject, " +
          "       fordep.t_usertypeaccount, " +
          "       quart8637.restondate (fordep.t_referenc, ? " +  
          "                          ) t_sbd_rest, " +
          "       quart8637.restprocondate (fordep.t_referenc, ? " + 
          "                                ) t_sbd_perc, " +
          "       quart8637.procforpay (fordep.t_referenc, ? " + 
          "                            ) t_perc_for_pay, " +
          "       quart8637.restfrom_pc_drest " +
          "                         (fordep.t_referenc, " +
          "                          fordep.t_typeobject, ? " + 
          "                         ) t_rest_from_pc_drest " +
          "  FROM (SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, "  +
          "               dep.t_account, dep.t_type_account, dep.t_number, "   +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END "  + 
          "               ) t_typeobject " + 
          "          FROM ddepositr_dbt dep "  +
          "            WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 0 " +
          "           AND (    dep.t_type_account != 'Целев. дети' " +
          "                AND dep.t_type_account != 'Целевой на д' " +
          "               ) " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      dep.t_type_account, ? " + 
          "                                     ) = 3 " +
          "        UNION " +
          "        SELECT dep.t_fncash, dep.t_referenc, dep.t_iscur, dep.t_code_currency, " +
          "               dep.t_account, dep.t_type_account, dep.t_number, " +
          "               dep.t_usertypeaccount, dep.t_sum_rest, " +
          "               (CASE dep.t_usealternate " +
          "                   WHEN 0 " +
          "                      THEN 2001 " +
          "                   ELSE 2002 " +
          "                END " + 
          "               ) t_typeobject " +
          "          FROM ddepositr_dbt dep, dpc_apltp_dbt apl " +
          "          WHERE dep.t_fncash = ? "  + 
          "           AND dep.t_iscur >= 0 " +
          "           AND dep.t_open_close != 'З' " +
          "           AND dep.t_usealternate = 1 " +
          "           AND apl.t_type = dep.t_type_account " +
          "           AND apl.t_iscur = dep.t_iscur " +
          "           AND apl.t_appltype = 2002 " +
          "           AND quart8637.isquartproc (dep.t_iscur, " +
          "                                      apl.t_aptype, ? " + 
          "                                     ) = 3) fordep) " +
          " WHERE t_sbd_perc != t_perc_for_pay OR (t_perc_for_pay < 0) " );
 
   cmddep.addParam("DataKv1",  RSDBP_IN);  
   cmddep.Param("DataKv1").value = datequart; 

   cmddep.addParam("DataKv2",  RSDBP_IN);  
   cmddep.Param("DataKv2").value = datequart; 

   cmddep.addParam("DataKv3",  RSDBP_IN);  
   cmddep.Param("DataKv3").value = datequart; 

   cmddep.addParam("DataKv4",  RSDBP_IN);  
   cmddep.Param("DataKv4").value = datequart; 

   cmddep.addParam("fncash1",  RSDBP_IN);  
   cmddep.Param("fncash1").value = Branch; 

   cmddep.addParam("DataKv5",  RSDBP_IN);  
   cmddep.Param("DataKv5").value = datequart; 

   cmddep.addParam("fncash2",  RSDBP_IN);  
   cmddep.Param("fncash2").value = Branch; 

   cmddep.addParam("DataKv6",  RSDBP_IN);  
   cmddep.Param("DataKv6").value = datequart; 

   cmddep.execute;
   rsmdep = RsdRecordset(cmddep);

   while( rsmdep.moveNext )


   Message(" Ждите... Идет корректировка расчитанных процентов в истории операций...");

      cmddoc = RsdCommand(" SELECT t_date_document, t_numdaydoc " +
                          " FROM (SELECT   /*+ index_combine(DSBDEPDOC_DBT DSBDEPDOC_DBT_IDX6)*/ " +
                          "           t_date_document, t_numdaydoc " +
                          "      FROM dsbdepdoc_dbt " +
                          "     WHERE t_referenc = ? " + 
                          "       AND t_date_document <= ? " + 
                          "       AND t_kindop NOT IN (8, 9, 14, 15, 16) " +
                          "       AND t_typeoper NOT IN (38, 39) " +
                          "       AND ASCII (t_flagstorn) = 0 " +
                          "       AND t_action NOT IN (2, 11) " +
                          "  ORDER BY t_date_document DESC, t_numdaydoc DESC) " +
                          "  WHERE ROWNUM = 1 ");


      
      cmddoc.addParam("referenc",  RSDBP_IN);  
      cmddoc.Param("referenc").value = rsmdep.value("t_referenc"); 

      cmddoc.addParam("Data",  RSDBP_IN);  
      cmddoc.Param("Data").value = datequart; 
  
      
      cmddoc.execute;
      rsmdoc = RsdRecordset(cmddoc);
      while( rsmdoc.moveNext )


        cmdupd = RsdCommand(" UPDATE dsbdepdoc_dbt " +
                            "  SET t_percrest = ? " + 
                            " WHERE t_referenc = ? " + 
                            "   AND t_date_document = ? " + 
                            "   AND t_numdaydoc = ? ");

        cmdupd.addParam("percrest",  RSDBP_IN);  
        cmdupd.Param("percrest").value = rsmdep.value("t_perc_for_pay"); 

        cmdupd.addParam("referenc",  RSDBP_IN);  
        cmdupd.Param("referenc").value = rsmdep.value("t_referenc"); 

        cmdupd.addParam("date",  RSDBP_IN);  
        cmdupd.Param("date").value = SQL_ConvTypeDate(rsmdoc.value("t_date_document")); 

        cmdupd.addParam("numdaydoc",  RSDBP_IN);  
        cmdupd.Param("numdaydoc").value = rsmdoc.value("t_numdaydoc"); 

  
        cmdupd.Execute;
      
      end;

   end;

end;

    array aMenu;
    var MMenu;
    array bMenu;
    var DMenu;

    aMenu (00) = " 1 - ПРОВЕРКА счетов БД текущего ВСП ";
    aMenu (01) = " 2 - КОРРЕКТИРОВКА счетов БД текущего ВСП ";

    MMenu = menu (aMenu, "Выберите вариант:     ~ENTER~- выбор       ~ESC~-отказаться        Переход вниз/вверх стрелками ","    Варианты  запуска программы :  ",null,null,0);
    
    if (MMenu == 0) 
       Выбор_квартала();
       Проверка_БД();
    elif (MMenu == 1) 
       if(not(Gettrue(FALSE,("Режим предназначен для корректировки БД к квартальной капитализации ! |Продолжим работу ? "))))
         exit(1);
       end;
       Выбор_квартала();
       Подготовка_детских(); 
       Лечение_счетов();
       Лечение_остатков();
       Лечение_процентов();
       
       Msgbox(" Коррекировка БД успешно завершена. |", "Запустите проверочный отчет еще раз. |",
              "(Отрицательные проценты в истории правятся 35 операцией по счету)");
       exit (1);
    else
       Msgbox(" Отказались от запуска программы... Esc - выход. ");
       exit (1);
    end;


END;

