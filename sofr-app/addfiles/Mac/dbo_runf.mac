import activex, or_rep_h, globals, "spserv.mac";

/*Загрузка*/
macro Loading(errmsg:@string)

  var InputDir, FullNameFile, FileName, ExtName, DirName;
  var Sheet, SheetNum, i, fcol = 1, frow = 1, row;
  var result = tarray(), iresult;
  var action = 0;
  var protocol, fi;
  var AttrID, error;
  var errcnt = 0;
  var rparm = TRecHandler("rateparm");

  /*По всем проставить */

  macro insattr2(id)
        if (SQL_ExecuteAndGetRs(" select 1 from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_object = lpad("+id+", 34,'0')").movenext())
            SQL_Execute(" delete from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_object = lpad("+id+", 34,'0')");
        end;
        if (SQL_ExecuteAndGetRs(" select 1 from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_attrid = 2  and t_object = lpad("+id+", 34,'0')").movenext())
           println("Уже есть аттрибут Двухфакторная");
        elif (SQL_ExecuteAndGetRs(" select 1 from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_general = chr(88) and t_object = lpad("+id+", 34,'0')").movenext())
           sql_execute(
            "Insert into DOBJATCOR_DBT " +
            "   (T_OBJECTTYPE, T_GROUPID, T_ATTRID, T_OBJECT, T_GENERAL, T_VALIDFROMDATE, T_OPER, T_VALIDTODATE, T_SYSDATE, T_SYSTIME, T_ISAUTO, T_ID) " +
            " Values " +
            "   (207, 170, 2, lpad("+id+", 34,'0'), chr(0), TO_DATE('10/23/2019', 'MM/DD/YYYY'), 1, TO_DATE('12/31/9999 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), sysdate, sysdate,chr(0), 0); " );
        else
           sql_execute(
            "Insert into DOBJATCOR_DBT " +
            "   (T_OBJECTTYPE, T_GROUPID, T_ATTRID, T_OBJECT, T_GENERAL, T_VALIDFROMDATE, T_OPER, T_VALIDTODATE, T_SYSDATE, T_SYSTIME, T_ISAUTO, T_ID) " +
            " Values " +
            "   (207, 170, 2, lpad("+id+", 34,'0'), chr(88), TO_DATE('10/23/2019', 'MM/DD/YYYY'), 1, TO_DATE('12/31/9999 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), sysdate, sysdate,chr(0), 0); " );

        end;
     return true;
  onerror();
     return false;
  end;

  macro insattr1(id)
        if (SQL_ExecuteAndGetRs(" select 1 from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_attrid = 2 and t_object = lpad("+id+", 34,'0')").movenext())
            SQL_Execute(" delete from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_object = lpad("+id+", 34,'0')");
        end;

        if (SQL_ExecuteAndGetRs(" select 1 from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_attrid = 1  and t_object = lpad("+id+", 34,'0')").movenext())
           println("Уже есть аттрибут СКП ЭП");
        elif (SQL_ExecuteAndGetRs(" select 1 from dobjatcor_dbt where t_objecttype = 207 and t_groupid = 170 and t_general = chr(88) and t_object = lpad("+id+", 34,'0')").movenext())
           sql_execute(
            "Insert into DOBJATCOR_DBT " +
            "   (T_OBJECTTYPE, T_GROUPID, T_ATTRID, T_OBJECT, T_GENERAL, T_VALIDFROMDATE, T_OPER, T_VALIDTODATE, T_SYSDATE, T_SYSTIME, T_ISAUTO, T_ID) " +
            " Values " +
            "   (207, 170, 1, lpad("+id+", 34,'0'), chr(0), TO_DATE('10/23/2019', 'MM/DD/YYYY'), 1, TO_DATE('12/31/9999 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), sysdate, sysdate,chr(0), 0); " );
        else
           sql_execute(
            "Insert into DOBJATCOR_DBT " +
            "   (T_OBJECTTYPE, T_GROUPID, T_ATTRID, T_OBJECT, T_GENERAL, T_VALIDFROMDATE, T_OPER, T_VALIDTODATE, T_SYSDATE, T_SYSTIME, T_ISAUTO, T_ID) " +
            " Values " +
            "   (207, 170, 1, lpad("+id+", 34,'0'), chr(88), TO_DATE('10/23/2019', 'MM/DD/YYYY'), 1, TO_DATE('12/31/9999 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), sysdate, sysdate,chr(0), 0); " );

        end;

        sql_execute(" update ddlcontr_dbt set t_usequik = chr(88) where t_dlcontrid = " + id);

     return true;
  onerror();
     return false;
  end;



  macro do1()
     var Dt = TRsbDataSet(" select d.t_dlcontrid from ddlcontr_dbt d, dsfcontr_dbt s, dparty_dbt p where d.t_sfcontrid = s.t_id and S.T_DATECLOSE = to_date('01010001','ddmmyyyy') and p.t_partyid = S.T_PARTYID and P.T_LEGALFORM = 2");
     var  i = 0, b = 0;
     while (Dt.movenext())
        if (insattr2(dt.dlcontrid))
           i = i + 1;
        else
           b = b + 1;
        end;

     end;
     Println("Вставка двухфакторной авторизации по всем ФЛ");
     Println("Успешно " + i + "; Ошибок: " + b);
     Println();
  end;

  macro do(number, code)
     var Dt = TRsbDataSet(" select t_objectid id from dobjcode_dbt where t_codekind = 1 and t_objecttype = 207 and t_code = '"+trim(code)+"'");
     var  i = 0, b = 0;
     if (Dt.movenext())
        if ( insattr1(dt.id))
//           println("Error: ошибка вставки " + number + "   " + code);
        else
           println("Error: ошибка вставки " + number + "   " + code);
        end;
     else
        println("Error: не удалось найти " + number + "   " + code);
     end;
  end;
  /**/
  macro getdir()
      return  "..\\Import\\";
  end;



  InputDir = getdir();

  /*Выбираем файл для обработки*/
  if(not SelectFile(FullNameFile, InputDir + "*.xls*", "Выберите файл для загрузки", 0, true))
    errmsg = "Отказ от загрузки";
    return false;
  end;
  splitfile(FullNameFile, FileName, ExtName);
  FileName = FileName + ExtName;
  DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

  /*Открываем файл*/

  action = 1;
  if(not OpenExcelFile(FileName, false, true, DirName))
    errmsg = "Ошибка открытия файла \"" + FullNameFile + "\"";
//    EndAction(1);
    return false;
  end;


  BegAction(2000, "Вставляем двухфакторную по всем");
  do1();
  endaction;
  BegAction(1, "Обработка файла \"" + FullNameFile + "\". Ждите...");

  /*Ищем лист BACKOFFICE/ДЛЯ БЭК-ОФИСА*/
  i = 1;
  while(i <= ExcelApplication.Sheets.Count)
    if((strupr(ExcelApplication.Sheets(i).Name) == "DATA"))
      break;
    end;
    i = i + 1;
  end;
  if(i > ExcelApplication.Sheets.Count)
    errmsg = "В файле \"" + FullNameFile + "\" не найден лист \"Data\"";
    EndAction(1);
    return false;
  end;
  Sheet = ExcelApplication.Sheets(i);

  /*Ищем первую колонку*/
  while((valtype(Sheet.Cells(1, fcol).value) == V_UNDEF) and (fcol <= 10))
    fcol = fcol + 1;
  end;
  if(valtype(Sheet.Cells(1, fcol).value) == V_UNDEF)
    errmsg = "Не найдено значимое поле в первой строке файла \"" + FullNameFile + "\"";
    EndAction(1);
    return false;
  end;

  /*Ищем первую строку*/
  while(frow <= 10)
    if((valtype(Sheet.Cells(frow, fcol).value) != V_UNDEF) and 
       (strupr(Sheet.Cells(frow, fcol).value) == "НОМЕР ДОГОВОРА"))
      break;
    end;
    frow = frow + 1;
  end;
  if((valtype(Sheet.Cells(frow, fcol).value) == V_UNDEF) or 
     (strupr(Sheet.Cells(frow, fcol).value) != "НОМЕР ДОГОВОРА"))
    errmsg = "Не найдены строки с результатами в файла \"" + FullNameFile + "\"";
    EndAction(1);
    return false;
  end;

  /*Читаем строки до тех пор, пока есть источник*/
  row = frow+1;
  while(true)
    if(valtype(Sheet.Cells(row, fcol).value) == V_UNDEF)
      break;
    end;
   // println(row + "	" + Sheet.Cells(row, fcol).value);
    do(Sheet.Cells(row, fcol).value,Sheet.Cells(row, fcol+1).value,Sheet.Cells(row, fcol+2).value,Sheet.Cells(row, fcol+3).value);

    row = row+1;
  end;

  /*Закрываем файл*/
  ExcelApplication.DisplayALerts = false;
  ExcelApplication.ActiveWorkbook.Close;
  EndAction(1);
  action = 0;
  /*Возвращаем результат*/
  if(errcnt == 0)
    return true;
  else
    return false;
  end;
OnError(er)                                                                       
  errmsg = "Исключение: " + er.module + " " + er.line + " " + er.message;
  if(action == 1)
    EndAction(1);
  elif(action == 2)
    RemProgress();
  end;
  return false;
end;


/*Точка входа*/
var errmsg = "";
if(not Loading(@errmsg))
  if(strlen(errmsg) > 0)
    msgboxex(errmsg);
  else
    msgboxex("загружены с ошибками");
  end;
else
  msgboxex("успешно загружены");
end;
//exit(1);
