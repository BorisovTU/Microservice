//А.Киселев 08.11.2018 Синхронизация данных СОФР 7.1.3, 7.2.9
import "usr_table_int.mac",
       "secur_prc_msg_transform.mac",
       "RequestWS.mac",
       "uws_exchng_log.mac",
       "openaccount_req.mac",
       "addAccountingEntries_Req.mac",
       "approveaccountingentries_req.mac",
       "GetCurrencyRate.mac",
       "loadRUData.mac";

private class (с_init_obj_param) c_prm_proc_contrBO_result(p_str_param)
   var RecId       : integer = 0
      ,ObjectType  : integer = 0
      ,ProcessType : integer; /* (1) Тип курсов валют/учетных цен на ДМ */

   Initс_init_obj_param(p_str_param);
end;

private class (c_usr_tbl_base) c_usr_tbl_uTableProcessEvent()
   private class gen_uTableProcessEvent()
      var T_RECID :integer,
          T_TIMESTAMP :date,
          T_OBJECTTYPE :integer,
          T_OBJECTID :integer,
          T_TYPE :integer,
          T_STATUS :integer,
          T_NOTE :string,
          T_MESSAGEID :integer,
          T_RESULTCODE :string,
          T_RESULTTEXT :string;
   end;

   private macro init_table_obj()
      new_val_obj = gen_uTableProcessEvent();
      where_val_obj = gen_uTableProcessEvent();
   end;

   Initc_usr_tbl_base("uTableProcessEvent_dbt");

   init_table_obj();
end;


//класс вызываемых параметров ProcessEvent
private class TParamProcessAcc( StrParam :string )
var RecId :integer = 0,
    ObjectType :integer = 0,
    AccountId :integer = 0,
    ProcessType :integer = 0,
    ProcessStatus :integer = 0;

private var StrSeparator :string = ";";

 private macro InitParam( StrParam :string )
 var StrDigit :string = "0123456789",
     StrParamBuf :string = "",
     i :integer = 0,
     StrPos :integer = 0;

  if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
   i = 1;
   while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

    if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
     StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);

    end;
    i = i + 1;

   end;

   i = 0;
   while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
    StrPos = Index( StrParamBuf, StrSeparator );
    if( StrPos > 1 )
     this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
     StrParamBuf = Substr(StrParamBuf, StrPos + 1);
    elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
     this[i] = int(StrParamBuf);
     StrParamBuf = "";
    end;
    i = i + 1;

   end;

  end;

 onError(err)

  RecId = 0;
  ObjectType = 0;
  ProcessStatus = 0;


 end;

 InitParam( StrParam );

end;



//класс вызываемых параметров ProcessEvent
private class TParamProcessEntry( StrParam :string )
var RecId :integer = 0,
    ObjectType :integer = 0,
    AcctrnId :integer = 0,
    ProcessType :integer = 0,
    ProcessStatus :integer = 0;

private var StrSeparator :string = ";";

 private macro InitParam( StrParam :string )
 var StrDigit :string = "0123456789",
     StrParamBuf :string = "",
     i :integer = 0,
     StrPos :integer = 0;

  if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
   i = 1;
   while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

    if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
     StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);

    end;
    i = i + 1;

   end;

   i = 0;
   while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
    StrPos = Index( StrParamBuf, StrSeparator );
    if( StrPos > 1 )
     this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
     StrParamBuf = Substr(StrParamBuf, StrPos + 1);
    elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
     this[i] = int(StrParamBuf);
     StrParamBuf = "";
    end;
    i = i + 1;

   end;

  end;

 onError(err)

  RecId = 0;
  ObjectType = 0;
  ProcessStatus = 0;


 end;

 InitParam( StrParam );

end;


//класс вызываемых параметров ProcessEvent
private class TParamProcessSlowEvent( StrParam :string )
var RecId :integer = 0,
    ObjectType :integer = 0,
    ProcessType :integer = 0,
    ProcessStatus :integer = 0;

private var StrSeparator :string = ";";

 private macro InitParam( StrParam :string )
 var StrDigit :string = "0123456789",
     StrParamBuf :string = "",
     i :integer = 0,
     StrPos :integer = 0;

  if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
   i = 1;
   while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

    if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
     StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);

    end;
    i = i + 1;

   end;

   i = 0;
   while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
    StrPos = Index( StrParamBuf, StrSeparator );
    if( StrPos > 1 )
     this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
     StrParamBuf = Substr(StrParamBuf, StrPos + 1);
    elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
     this[i] = int(StrParamBuf);
     StrParamBuf = "";
    end;
    i = i + 1;

   end;

  end;

 onError(err)

  RecId = 0;
  ObjectType = 0;
  ProcessStatus = 0;


 end;

 InitParam( StrParam );

end;



//Передача из СОФР данных по счетам бух. учета
macro ws_SOFR_OpenAccount( Str_Param )
var res :object,
    ParamProcess :TParamProcessAcc,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    errortext :string = "",
    RequestText,
    v_transformator,
    v_answer,
    v_logger_obj,
    v_log_id;

 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;

 ParamProcess = Null;
 ProcessEventTbl = Null;
 res = Null;
 ParamProcess = TParamProcessAcc( Str_Param + ";2"); //установить статусы 2

 res = SOFR_OpenAccount_Req( ParamProcess.accountId );

 if( Valtype(res.OpenAccountsRequestMsg.OpenAccountsRequest.AccountParams.AccountId.ObjectId) != V_UNDEF) //исключаем вероятность, что пока задание болталось в очереди, счет из account_dbt удалили

  v_transformator = c_secur_msg_converter();
  RequestText = v_transformator.m_secur_external_req(res);
  v_logger_obj = uws_exchng_logger(null,
                                   null,
                                   XmlRpcRequestId(),
                                   "ws_SOFR_OpenAccount",
                                   modulename(),
                                   ParamProcess.RecId,
                                   RequestText);
  v_log_id = v_logger_obj.get_log_id();

  v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                "",                // ИД сообщения.
                                "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                false,/*true,*/    // Признак синхронной обработки. Если не указан, = False
                                "0000",            /*1,*/ // Подразделение системы-назначения.
                                4,                 // ИД типа данных
                                RequestText,       // Бизнес данные в виде XML.
                                ParamProcess.RecId // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                );
 // v_logger_obj.add_response(v_answer);
 end;

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

 //установка статуса в uTableProcessEvent_dbt
 ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
 ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
 ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
 ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
 if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
  state = 1;
 end;
 ParamProcess = Null;
 ProcessEventTbl = Null;
 res = Null;
 //установка статуса в uTableProcessEvent_dbt

 return state;

onError(err)
 ParamProcess = Null;
 ProcessEventTbl = Null;
 res = Null;
 state = 1;
 return state;

end;
//Передача из СОФР данных по счетам бух. учета




//Передача из СОФР данных по проводкам
macro ws_SOFR_addAccountingEntries( Str_Param )
var res_obj :object,
    trn :object,
    ParamProcess :TParamProcessEntry,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    errortext :string = "",
    RequestText,
    v_transformator,
    v_answer,
    v_logger_obj,
    v_log_id,
    ObjTypeId :integer = 0, // ИД типа данных справочник объектов SOFR
    FlPaym :bool = false,
    FlSyncAsync :bool = true;
 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;

 ParamProcess = Null;
 ProcessEventTbl = Null;
 res_obj = Null;
 ParamProcess = TParamProcessEntry( Str_Param + ";2"); //установить статусы 2
 if( ParamProcess.ObjectType == 501) //платеж
  FlPaym = true;
 else
  FlPaym = false;
 end;


 if( ParamProcess.ProcessType == 3 ) //удаление проводки
  res_obj = ApproveAccountingEntries_Req ( ParamProcess.AcctrnId );
  ObjTypeId = 8;
  FlSyncAsync = false;
 else
  res_obj = addAccountingEntriesReq( ParamProcess.AcctrnId, FlPaym );//создание проводки/изменение проводки
  ObjTypeId = 5;
/*  FlSyncAsync = true;*/
  FlSyncAsync = false;
 end;

 //исключаем вероятность, что пока задание болталось в очереди, счет из acctrn_dbt удалили
 if( (ParamProcess.ProcessType != 3) and (isEqClass("TArray", res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList)) and
   ( res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList.Size > 0 ) or
     (ParamProcess.ProcessType == 3) and (isEqClass("CApproveEntry", res_obj.ApproveAccountingEntriesRequestMsg.ApproveAccountingEntriesRequest.ApproveEntry)) ) 
  v_transformator = c_secur_msg_converter();
  RequestText = v_transformator.m_secur_external_req(res_obj);
  v_logger_obj = uws_exchng_logger(null,
                                   null,
                                   XmlRpcRequestId(),
                                   "ws_SOFR_addAccountingEntries",
                                   modulename(),
                                   ParamProcess.RecId,
                                   RequestText);
  v_log_id = v_logger_obj.get_log_id();
  v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                "",                // ИД сообщения.
                                "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                FlSyncAsync,       // Признак синхронной обработки. Если не указан, = False
                                "0000",            /*1,*/ // Подразделение системы-назначения.
                                ObjTypeId,         // ИД типа данных
                                RequestText,       // Бизнес данные в виде XML.
                                ParamProcess.RecId // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                );
 // v_logger_obj.add_response(v_answer);
 end;

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

 //установка статуса в uTableProcessEvent_dbt
 ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
 ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
 ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
 ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
 if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
  state = 1;
 end;
 ParamProcess = Null;
 ProcessEventTbl = Null;
 res_obj = Null;
 //установка статуса в uTableProcessEvent_dbt

 return state;

onError(err)
 ParamProcess = Null;
 ProcessEventTbl = Null;
 res_obj = Null;
 state = 1;
 return state;

end;




//Загрузка Данных из Ru-Data
macro ws_SOFR_LoadRuData( Str_Param )
var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    ParamProcess :TParamProcessSlowEvent,
    state :integer = 0;

 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;

 if( SOFR_LoadRuData ) //выполнение функций загрузки RuData
  ParamProcess = Null;
  ProcessEventTbl = Null;
  ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
  //установка статуса в uTableProcessEvent_dbt
  ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
  ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
  ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
  ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
  if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
   state = 1;
  end;
  ParamProcess = Null;
  ProcessEventTbl = Null;
  //установка статуса в uTableProcessEvent_dbt

 end;
 return state;

onError(err)
 ParamProcess = Null;
 ProcessEventTbl = Null;
 state = 1;
 return state;

end;


/*-------------------------------------------------------------------*/
/* Передача из СОФР запроса на получение курсов валют и драгметаллов */
/*-------------------------------------------------------------------*/
macro ws_SOFR_GetCurrencyRate( Str_Param )
   var v_req_obj : object,
       v_resp_obj,
       ParamProcess,
       ProcessEventTbl : c_usr_tbl_uTableProcessEvent,
       state : integer = 0,
       errortext : string = "",
       RequestText,
       ResponseText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id,
       v_save_processor;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_req_obj = Null;
   ParamProcess = c_prm_proc_cur_rate(Str_Param + ";2"); //установить статусы 2

   v_req_obj = c_GetCurrencyRate_req(ParamProcess);

   v_transformator = c_secur_msg_converter();
   RequestText = v_transformator.m_secur_external_req(v_req_obj);
   v_logger_obj = uws_exchng_logger(null,
                                    null,
                                    XmlRpcRequestId(),
                                    "ws_SOFR_GetCurrencyRate",
                                    modulename(),
                                    ParamProcess.RecId,
                                    RequestText);
   v_log_id = v_logger_obj.get_log_id();

   v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                 "",                // ИД сообщения.
                                 "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                 false,             // Признак синхронной обработки. Если не указан, = False
                                 "0000",            /*1,*/ // Подразделение системы-назначения.
                                 7,                 // ИД типа данных
                                 RequestText,       // Бизнес данные в виде XML.
                                 ParamProcess.RecId // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                 );
   v_logger_obj.add_response(v_answer.resulttext);

   if(not v_transformator.m_make_pure_msg_from_ifx(v_answer.resulttext))
      RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
   end;

   v_resp_obj = c_adp_GetCurrencyRateResponse(v_transformator.get_pure_msg());
   /* Сохранение полученных курсов в БД - begin */
   if(v_resp_obj.IsResult)
      v_save_processor = c_save_rate_currency(v_req_obj, v_resp_obj);
   end;
   /* Сохранение полученных курсов в БД - end */

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   //установка статуса в uTableProcessEvent_dbt
/*
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
*/
   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_req_obj = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_req_obj = Null;
   state = 1;
   return state;

end; /* macro ws_SOFR_GetCurrencyRate() */


/*
/*----------------------------------------------*/
/* Обновление статуса записи в заданной таблице */
/*----------------------------------------------*/
/* Актуально для следующих таблиц:              */
/*    - utableprocessevent_dbt                  */
/*    - utableprocessout_dbt                    */
/*    - utableprocessin_dbt                     */
/*----------------------------------------------*/
macro m_upd_status_table(p_recid, p_table_name, p_status)
   var v_ret = true;
   var v_sql, v_cmd;

   v_sql = string("UPDATE ", p_table_name, " ");
   v_sql = v_sql + "  SET t_status = :p_status ";
   v_sql = v_sql + "WHERE t_recid = :p_recid ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_status", RSDBP_IN, p_status);
   v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
   v_cmd.execute();

   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   return v_ret;

onError(err)
   v_ret = false;
   return v_ret;
end;
*/


/*-----------------------------------------------------*/
/* Обновление статуса записей в utableprocessevent_dbt */
/*-----------------------------------------------------*/
macro m_upd_event_table_status(p_objectid, p_objecttype, p_status_old, p_status_new)
   var v_ret = 0;
   var v_sql, v_cmd;

   v_sql =         "DECLARE ";
   v_sql = v_sql + "    v_obj_id   NUMBER(10) := :p_objectid; ";
   v_sql = v_sql + "    v_obj_type NUMBER(10) := :p_objecttype; ";
   v_sql = v_sql + "    v_stat_old NUMBER(10) := :p_status_old; ";
   v_sql = v_sql + "    v_ret NUMBER(5) := 0; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "    BEGIN ";
   v_sql = v_sql + "        SELECT t_objectid, t_objecttype ";
   v_sql = v_sql + "          INTO v_obj_id, v_obj_type ";
   v_sql = v_sql + "          FROM utableprocessevent_dbt ";
   v_sql = v_sql + "         WHERE t_objecttype = v_obj_type ";
   v_sql = v_sql + "           AND t_objectid = v_obj_id ";
   v_sql = v_sql + "           AND t_status = v_stat_old ";
   v_sql = v_sql + "           AND ROWNUM = 1; ";

   v_sql = v_sql + "        UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "           SET t_status = :p_stat_new ";
   v_sql = v_sql + "         WHERE t_objecttype = v_obj_type ";
   v_sql = v_sql + "           AND t_objectid = v_obj_id ";
   v_sql = v_sql + "           AND t_status = v_stat_old; ";
   v_sql = v_sql + "        COMMIT; ";

   v_sql = v_sql + "    EXCEPTION ";
   v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
   v_sql = v_sql + "        THEN ";
   v_sql = v_sql + "            v_ret := 1; "; /* Не найдено записи с заданным t_recid */
   v_sql = v_sql + "        WHEN OTHERS ";
   v_sql = v_sql + "        THEN ";
   v_sql = v_sql + "            v_ret := 2; "; /* Не удалось обновить запись */
   v_sql = v_sql + "            ROLLBACK; ";
   v_sql = v_sql + "    END; ";

   v_sql = v_sql + "    :p_result := v_ret; ";
   v_sql = v_sql + "END; ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_objectid", RSDBP_IN, p_objectid);
   v_cmd.addParam("p_objecttype", RSDBP_IN, p_objecttype);
   v_cmd.addParam("p_status_old", RSDBP_IN, p_status_old);
   v_cmd.addParam("p_stat_new", RSDBP_IN, p_status_new);
   v_cmd.addParam("p_result", RSDBP_OUT, V_INTEGER);
   v_cmd.execute();

   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   return v_ret;

onError(err)
   v_ret = 3; /* Непредвиденная ошибка */
   return v_ret;
end; /* macro m_upd_event_table_status() */


macro ws_SOFR_ContractBOTransfer_in(p_recid)
   const C_SOFR_CONTRBO = 9;
   const C_STATUS_PROC = 3;
   const C_STATUS_NEW_OK = 4;
   const C_STATUS_NEW_ERR = 5;
   const C_STATUS_EVNT_PRC = 2;

   var v_ret = 0;
   var v_sql, v_cmd, v_rs;
   var v_stat;

   v_sql =         "SELECT contractid, contractnumber, resulttext, ";
   v_sql = v_sql + "       DECODE(resultcode, chr(0), '0', chr(1), '0', '', '0', resultcode) AS res_code ";
   v_sql = v_sql + "  FROM sofr_contractboresult tbl_res ";
   v_sql = v_sql + " WHERE EXISTS(SELECT t_recid ";
   v_sql = v_sql + "                FROM utableprocessin_dbt ";
   v_sql = v_sql + "               WHERE t_recid = :p_recid ";
   v_sql = v_sql + "                 AND t_objecttype = :p_objecttype ";
   v_sql = v_sql + "                 AND t_status = :p_status_p) ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
   v_cmd.addParam("p_objecttype", RSDBP_IN, C_SOFR_CONTRBO);
   v_cmd.addParam("p_status_p", RSDBP_IN, C_STATUS_PROC);

   v_rs = RSDRecordSet(v_cmd);
   while(v_rs.movenext())
      if(v_rs.value("res_code") == "0")
         v_stat = m_upd_event_table_status(v_rs.value("contractid"), C_SOFR_CONTRBO, C_STATUS_EVNT_PRC, C_STATUS_NEW_OK);

      else
         v_stat = m_upd_event_table_status(v_rs.value("contractid"), C_SOFR_CONTRBO, C_STATUS_EVNT_PRC, C_STATUS_NEW_ERR);
         /* !!! - TODO: отправка писем с ошибками из Диасофта */
      end;
      /* !!! - TODO: отправка писем с ошибками */
      if(v_stat == 1)
         /* Запись не найдена среди выгруженных */
      elif(v_stat == 2)
         /* Не удалось обновить запись */
      elif(v_stat == 3)
         /* Непредвиденная ошибка */
      end;
   end;

   v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   if(not m_upd_table_proc_in_status(p_recid, C_STATUS_NEW_OK))
      v_stat = 1;
   end;

   return v_ret;

onError(err)
   v_stat = 1;
   return v_stat;
end; /* macro ws_SOFR_ContractBOTransfer_in() */


/*--------------------------------------------------------------------------*/
/* Формирование информации о договорах брокерского обслуживания для Диасофт */
/*--------------------------------------------------------------------------*/
macro ws_SOFR_ContractBOTransfer(Str_Param)
   const C_SOFR_CONTRBO = 9;
   const C_EVENT_STAT_NEW = 1;
   const C_EVENT_STAT_PRC = 2;
   const C_PROC_OUT_ARCH = 4;
   const C_PROC_OUT_ERR = 5;
   const C_TRANSFER_MODULE = "RSHB_TableIns_CntrBO";
   const C_TRANSFER_FUNC = "m_prep_cntrBO_to_transfer";

   var v_state = 0;
   var v_aux_cntr;
   var v_sql, v_cmd, v_rs;
   var v_objid_list = TArray;
   var v_recid_list = TArray;
   var v_recid_prms;
   var v_proc_param;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   if(v_proc_param.ProcessType > 0)
      /* Выборка id договоров */
      v_sql =         "SELECT tbl_evnt.t_recid, tbl_evnt.t_timestamp, tbl_evnt.t_objecttype, ";
      v_sql = v_sql + "       tbl_evnt.t_objectid, tbl_evnt.t_status ";
      v_sql = v_sql + "  FROM utableprocessevent_dbt tbl_evnt ";
      /* На всякий случай проверяем еще раз есть ли не завершенные потоки выгрузки */
      v_sql = v_sql + " WHERE NOT EXISTS (SELECT tbl_out.t_recid ";
      v_sql = v_sql + "                     FROM utableprocessout_dbt tbl_out ";
      v_sql = v_sql + "                    WHERE tbl_out.t_objecttype = :p_objecttype_o ";
      v_sql = v_sql + "                      AND tbl_out.t_status NOT IN (:p_status_o1, :p_status_o2)) ";
      v_sql = v_sql + "   AND tbl_evnt.t_objecttype = :p_objecttype_e ";
      v_sql = v_sql + "   AND tbl_evnt.t_status = :p_status_e ";
      v_sql = v_sql + " ORDER BY tbl_evnt.t_recid ASC "; /* Для выборки максимального и минимального значения */

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_objecttype_o", RSDBP_IN, C_SOFR_CONTRBO);
      v_cmd.addParam("p_status_o1", RSDBP_IN, C_PROC_OUT_ARCH);
      v_cmd.addParam("p_status_o2", RSDBP_IN, C_PROC_OUT_ERR);
      v_cmd.addParam("p_objecttype_e", RSDBP_IN, C_SOFR_CONTRBO);
      v_cmd.addParam("p_status_e", RSDBP_IN, C_EVENT_STAT_NEW);

      v_rs = RSDRecordSet(v_cmd);
      while(v_rs.movenext())
         v_recid_list.value(v_recid_list.size) = v_rs.value("t_recid");

         v_objid_list.value(v_objid_list.size) = v_rs.value("t_objectid");
      end;

      v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

      /* Формирование информации для выгрузки в Диасофт */
      if(v_objid_list.size > 0)
         /* Чтобы не перегружать макрос импортами */
         ExecMacroFile(C_TRANSFER_MODULE, C_TRANSFER_FUNC, v_objid_list);

         v_aux_cntr = 0;
         v_recid_prms = string(v_recid_list.value(v_aux_cntr));
         v_aux_cntr = v_aux_cntr + 1;

         while(v_aux_cntr < v_recid_list.size)
            v_recid_prms = string(v_recid_prms, ",", v_recid_list.value(v_aux_cntr));
            v_aux_cntr = v_aux_cntr + 1;
         end;

         /* Изменение статусов и создание исходящего потока выгрузки */
         v_sql =         "BEGIN ";
         /* Вставляем запись в utableprocessout_dbt сразу с t_status = 2 */
         v_sql = v_sql + "    INSERT INTO utableprocessout_dbt ";
         v_sql = v_sql + "                (t_objecttype, t_timestamp, t_status) ";
         v_sql = v_sql + "         VALUES (:p_objecttype_o, sysdate, :p_status_o); ";
         /* Обновляем статусы событий */
         v_sql = v_sql + "    UPDATE utableprocessevent_dbt ";
         v_sql = v_sql + "       SET t_status = :p_status_e ";
         v_sql = v_sql + "     WHERE t_recid IN (" + v_recid_prms + "); ";
         v_sql = v_sql + "EXCEPTION ";
         v_sql = v_sql + "    WHEN OTHERS ";
         v_sql = v_sql + "    THEN ";
         v_sql = v_sql + "        ROLLBACK; ";
         v_sql = v_sql + "END; ";

         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_objecttype_o", RSDBP_IN, C_SOFR_CONTRBO);
         v_cmd.addParam("p_status_o", RSDBP_IN, C_EVENT_STAT_PRC);
         v_cmd.addParam("p_status_e", RSDBP_IN, C_EVENT_STAT_PRC);
         v_cmd.execute();
      end;
   else
      v_state = ws_SOFR_ContractBOTransfer_in(v_proc_param.RecId);
   end;

   return v_state;

onError(err)
   v_state = 1;
   return v_state;
end; /* macro ws_SOFR_ContractBOTransfer() */


macro ws_SOFR_DEPOAccRevise(Str_Param)
   const C_SOFR_DEPORevise = 11;
   const C_STATUS_PROC = 3;
   const C_STATUS_ARCH = 4;
   const C_STATUS_ERR = 5;

   var v_state = 0;
   var v_result;
   var v_proc_param;
   var v_sql, v_cmd, v_rs;
   var v_sql_upd, v_cmd_upd, v_rs_upd;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   /* Объект используется один и тот же */
   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessin_dbt ";
   v_sql = v_sql + " WHERE t_recid = :p_recid ";
   v_sql = v_sql + "   AND t_objecttype = :p_objecttype ";
   v_sql = v_sql + "   AND t_status = :p_status ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, v_proc_param.RecId);
   v_cmd.addParam("p_objecttype", RSDBP_IN, C_SOFR_DEPORevise);
   v_cmd.addParam("p_status", RSDBP_IN, C_STATUS_PROC);

   v_rs = RSDRecordSet(v_cmd);
   if(v_rs.movenext())
       
      ExecMacroFile("depo_verification_DIAS.mac", "chekdata");
      /*v_result = */

      v_sql_upd =             "UPDATE utbaleprocessin_dbt ";
      v_sql_upd = v_sql_upd + "   SET t_status = :p_status_new ";
      v_sql_upd = v_sql_upd + " WHERE t_recid = :p_recid ";

      v_cmd_upd = RSDCommand(v_sql_upd);
      /*if(v_result ==)*/
      v_cmd_upd.addParam("p_status_new", RSDBP_IN, C_STATUS_ARCH);
      /* В ФТ используется только статус 4 */
      /*
      else
      v_cmd_upd.addParam("p_status_new", RSDBP_IN, C_STATUS_ERR);
      end;
      */
      v_cmd_upd.addParam("p_recid", RSDBP_IN, v_proc_param.RecId);

      v_cmd_upd.execute();

      v_cmd_upd.close(); v_cmd_upd = NULL; v_sql_upd = NULL;
   end;

   v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   return v_state;

onError(err)
   v_state = 1;
   return v_state;
end; /* macro ws_SOFR_DEPOAccRevise() */
