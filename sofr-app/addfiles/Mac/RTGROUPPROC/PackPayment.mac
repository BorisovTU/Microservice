/*
$Name:             PackPayment.mac
$Module:           Унивесальный фронт-офис
$Description:      DML-оплата безналичных платежей
*/
/*****************************************************/
/*  Быстрая пакетная оплата                          */
/*  Процедура пакетной оплаты безналичных платежей   */
/*****************************************************/

import deprintr, rsd, MassDMLProcBase, ic_comdata;


class(MassDMLProcBase) 
   PackPayment( pListTransfer, pPaymentId, pTypeAccount, pOrderNum )

  private const kind_ListTransfer = 1,
                kind_PaymentId    = 2;

  private var ListTransfer,
              PaymentId,
              ProcKind = 0;  

  private var ModeEndOfYear = GetCurrentMode;
  private var isForPFR;

  
  /*____________142833 - SAN - Removal of the relative paths__________*/
  //var nr = "..\\TXTFILE\\PackPayment." + {CNum};
  var nr = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", false ) + "\\PackPayment_" + pOrderNum + "." + {CNum};
  /*___________/142833 - 14/07/09_____________________________________*/

  private const PackCarryDpi_TransAcc = GetRegVal("RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\ГРУППОВЫЕ_ПРОЦЕДУРЫ\\БЕЗНАЛИЧНЫЕ_ПЛАТЕЖИ\\ПРОВОДКА_ЧЕРЕЗ_ТРАНЗИТНЫЙ");


//---------------------------
  macro SetVariables

    CheckTaxCalc(true);

  end; // SetVariables


  private macro getTempParty(docRs:RsdRecordSet, fieldName:string, rs:RsdRecordSet)
    var is_null;
    var id = docRs.value(fieldName, is_null);
    if (is_null or (id == 0))
      return false;
    end;
    
    var cmd = RsdCommand(
        "select * " +
        "from dtemporaryparty_dbt " +
        "where t_TempPartyId = ? ");

    cmd.addParam("PartyId", RSDBP_IN, id);
    cmd.execute();
    rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    setParm(3, rs);
    return rs.moveNext();
  end;


  macro getPMDSelectStr
    if ((ListTransfer > 0) and (PaymentId == 0))
      return  "select eoy.*, cntr.t_businesid, cntr.t_account_busines, cntr.t_businesbankid, " +
                     "nvl(rsu_rtlglobals.GetOperBrigade, 0) OperBrigade, cntr.t_namebusines, " +
                     "payf.t_FNCash ReceiverBranch, cntr.t_NumberTaxPayer, cntr.t_CorAcc_Busines, " +
                     "cntr.t_CodeKindBankBusines, cntr.t_MFO_Busines " +
                "from deoytemp_tmp eoy, dtrn_payf_dbt payf, dtrn_cntr_dbt cntr " +
               "where nvl (eoy.t_errorcode, 0) = 0 " +
                 "and eoy.t_listtransfer = payf.t_autokey " +
                 "and payf.t_numbercontract = cntr.t_numbercontract ";
    end;   

    if (PaymentId > 0)
      return  "select eoy.*, doc.t_PayerPartyID, doc.t_PayerTempPartyID, doc.t_PayerName, " +
                     "doc.t_PayerAccount, doc.t_PayerBankPartyID, doc.t_DebitCurrCode, " +
                     "doc.t_PayerBankTempPartyID, " +
                     "nvl(rsu_rtlglobals.GetOperBrigade, 0) OperBrigade, doc.t_DebitAccount " +
                "from deoytemp_tmp eoy, dRtIncomeDoc_dbt income, dRtdocument_dbt doc " +
               "where nvl (eoy.t_errorcode, 0) = 0 " +
                 "and income.t_IncomePaymentID = " + string(PaymentId) + 
                " and doc.t_DocumentId = income.t_DocumentId ";
    end;
    
    return  "select eoy.*, " +
                   "nvl(rsu_rtlglobals.GetOperBrigade, 0) OperBrigade " +
              "from deoytemp_tmp eoy " +
             "where nvl (eoy.t_errorcode, 0) = 0 ";
  end;


  macro addDocValues(rs: RsdRecordSet)
    var res = true;
    var is_null;
    var id;
    var rs2;
    var codeKind;

    if (PaymentId > 0)
      if (res) res = StoreValue("doc:ВнешнийПлатеж", true); end;
      if (res) res = StoreValue("doc:ИДВходящегоПлатежа", string(PaymentId)); end;
      if (res) res = StoreValue("doc:БезналичныеПлатежи", true); end;
    end;
    
    if (ListTransfer > 0)
      if (res) res = StoreValue("doc:БезналичныеПлатежи", true); end;
    end;
    
    if (PackCarryDpi_TransAcc)
      if (res) res = StoreValue("doc:БНП_ЧерезТранзитный", true); end;
    end;
    
    if (res) res = StoreValue("doc:Название@БанкНаш", GetBankName()); end;

    if ((ListTransfer > 0) and (PaymentId == 0))
      if (res /*and (rs.value("t_businesid") != 0)*/) res = StoreValue("doc:Клиент@Плат", rs.value("t_businesid")); end;   
      if (res) res = StoreValue("doc:Название@Плат", rs.value("t_namebusines")); end;
      if (res) res = StoreValue("doc:ИНН@Плат", rs.value("t_NumberTaxPayer")); end;

      if (res) res = StoreValue("doc:Счет@Плат", rs.value("t_account_busines")); end;

      if (  (rs.value("t_account_busines") == "") and (rs.value("t_businesbankid") == {OurBank}))
        if (res) res = StoreValue("doc:Счет@Плат", rs.value("t_CorAcc_Busines")); end;
      end;
      
      if (res) res = StoreValue("doc:Банк@Плат", rs.value("t_businesbankid")); end;
      if (res) res = StoreValue("doc:ВидКодаБанка@БанкПлат", rs.value("t_CodeKindBankBusines")); end;
      if (res) res = StoreValue("doc:КодБанка@БанкПлат", rs.value("t_MFO_Busines")); end;
      if (res) res = StoreValue("doc:Подразделение@Получ", rs.value("ReceiverBranch")); end;
    end;

    if (PaymentId > 0)
      id = rs.value("t_PayerPartyID", is_null);
      if (not is_null)
        if (res) res = StoreValue("doc:Клиент@Плат", id); end;
      end;

      if ((not is_null) and (id > 0))
        if (res) res = StoreValue("doc:ИНН@Плат", getPartyINN(id)); end;
      elif (getTempParty(rs, "t_PayerTempPartyID", rs2))
        if (res) res = StoreValue("doc:ИНН@Плат", rs2.value("t_INN")); end;
      end;

      if (res) res = StoreValue("doc:Название@Плат", rs.value("t_PayerName")); end;
      if (res) 
        if ((rs.value("t_PayerAccount") != null) and (rs.value("t_PayerAccount") != ""))
          res = StoreValue("doc:Счет@Плат", rs.value("t_PayerAccount")); 
        else
          res = StoreValue("doc:Счет@Плат", rs.value("t_DebitAccount")); 
        end;
      end;

      id = rs.value("t_PayerBankPartyID", is_null);
      if (not is_null)
        if (res) res = StoreValue("doc:Банк@Плат", id); end;
      end;

      if ((not is_null) and (id > 0))
        if (rs.value("t_DebitCurrCode") == 0)
          codeKind = 3;
        else
          codeKind = 6;
        end;

        if (res) res = StoreValue("doc:ВидКодаБанка@БанкПлат", codeKind); end;
        if (res) res = StoreValue("doc:КодБанка@БанкПлат", findPartyCode(id, codeKind)); end;
      elif (getTempParty(rs, "t_PayerBankTempPartyID", rs2))
        if (res) res = StoreValue("doc:ВидКодаБанка@БанкПлат", rs2.value("t_BankCodeKind")); end;
        if (res) res = StoreValue("doc:КодБанка@БанкПлат", rs2.value("t_BankCode")); end;
      end;
    end;

    if (res) res = StoreValue("doc:Сумма@Прод", rs.value("t_insum")); end;
    if (res) res = StoreValue("doc:Валюта@Прод", rs.value("t_code_currency")); end;
    if (res) res = StoreValue("doc:Клиент@Получ", rs.value("t_codclient")); end;
    if (res) res = StoreValue("doc:Клиент@Вып", rs.value("t_codclient")); end;
    
    if (rs.value("t_flagrezid"))
      if (res) res = StoreValue("doc:Нерезидент@Получ", true); end;
      if (res) res = StoreValue("doc:Нерезидент@Вып", true); end;
    end;

    if (res) res = StoreValue("doc:ИдСчетаВклада@Получ", rs.value("t_referenc")); end;
    if (res) res = StoreValue("doc:СчетВклада@Получ", rs.value("t_account")); end;
    if (res) res = StoreValue("doc:ВидВклада@Получ", rs.value("t_Type_Account")); end;
    if (res) res = StoreValue("doc:ГруппаНумерации@Получ", rs.value("t_GroupNumberID")); end;
    if (res) res = StoreValue("doc:НомерСмены", int(rs.value("OperBrigade"))); end;
    if (res) res = StoreValue("doc:НомерПачки", rs.value("t_npack")); end;
    if (res) res = StoreValue("doc:ОснованиеПервичного", rs.value("t_ground")); end;
    if (res) res = StoreValue("doc:ОчередностьПлатежа", 0); end;
    if (res) res = StoreValue("doc:ОчередностьПлатежаПрочее", 0); end;
    if (res) res = StoreValue("doc:РеестрВОО", 0); end;
    if (res) res = StoreValue("doc:КонтрРаботник", 0); end;
    return res;
  end; // addDocValues

  private macro ProcessTrnDoc
    var cmd;
    var query: string = "merge into dtrn_doc_dbt trn " +
                            "using deoytemp_tmp eoy " +
                                "on (nvl (eoy.t_trn_autokey, 0) <> 0 and eoy.t_trn_autokey = trn.t_autokey) " +
                            "when matched then update " +
                                "set trn.t_status = 'X',  " +
                                    "trn.t_iapplicationkind = eoy.t_iapplicationkind, " +
                                    "trn.t_applicationkey = eoy.t_applicationkey,  " +
                                    "trn.t_date_document = eoy.t_depdate_document,  " +
                                    "trn.t_numsession = 0";
    if ( isForPFR )
      query = query + ", trn.t_PayCode = 'З1'";
    end;
    cmd = RsdCommand(query);
    cmd.execute;
    PrintTime("dtrn_doc_tmp");
  
  end; //ProcessTrnDoc

  private macro ProcessTrnPayf(PayedSum)
    var cmd;
    
    cmd = RsdCommand(
       "update dtrn_payf_dbt " +
          "set t_globalsumfactfilial = t_globalsumfactfilial + ? " +
        "where t_autokey = ? " );
    cmd.addParam("PayedSum", RSDBP_IN, PayedSum);
    cmd.addParam("listTransfer", RSDBP_IN, ListTransfer);
    cmd.execute;
    PrintTime("dtrn_payf_tmp");

  end; // ProcessTrnPayf

  private macro ProcessTrnPayM(PayedSum)
    var cmd;
    
    if  ( ProcKind == kind_ListTransfer )
      cmd = RsdCommand(
         "update dtrn_paym_dbt " +
            "set t_globalsumfact = t_globalsumfact + ? " +
          "where (t_applicationkey, t_iapplicationkind ) = " +
                "(select t_paymappkey, t_paymappkind from dtrn_payf_dbt where t_autokey = ?)");
      cmd.addParam("PayedSum", RSDBP_IN, PayedSum);
      cmd.addParam("listTransfer", RSDBP_IN, ListTransfer);
    elif( ProcKind == kind_PaymentId )
      cmd = RsdCommand(
         "update dtrn_paym_dbt " +
            "set t_globalsumfact = t_globalsumfact + ? " +
          "where t_paymentid = ? ");
      cmd.addParam("PayedSum", RSDBP_IN, PayedSum);
      cmd.addParam("PaymentId", RSDBP_IN, PaymentId);
    end;
    cmd.execute;
    PrintTime("dtrn_paym_tmp");
  end; // ProcessTrnPayM

  private macro ProcessBankTables(paymSum, trnSum)
    var processStateNew = 0;
    var cmd_rtpmdata;
    var cmd_pmrepses;

    if ( paymSum == trnSum )
      processStateNew = 50;
    else 
      processStateNew = 20;
    end;

    cmd_rtpmdata = RsdCommand(
       "update drtincomedoc_dbt " +
          "set t_processstate = ? " +
        "where t_incomepaymentid = ? " );
    cmd_rtpmdata.addParam("status",    RSDBP_IN, processStateNew);
    cmd_rtpmdata.addParam("PaymentId", RSDBP_IN, PaymentId);
    cmd_rtpmdata.execute;

    cmd_pmrepses = RsdCommand(
       "update dpmrepses_dbt " +
          "set t_session = 0 " +
        "where t_paymentid = ? " );
    cmd_pmrepses.addParam("PaymentId", RSDBP_IN, PaymentId);
    cmd_pmrepses.execute;

    PrintTime("bank table");
  end; // ProcessBankTables

  private macro ProcessPaymentTables
    var cmd_data, rs_data;
    //var processState;
    var paymSum, trnSum;

    if (( ProcKind == kind_PaymentId ) and ( ListTransfer == 0 ))
      cmd_data = RsdCommand( 
         "select nvl((select distinct t_listtransfer " +
                       "from dtrn_doc_dbt " +
                      "where t_paymentid = ? " +
                        "and t_fncash = ? ), 0) listtransfer "
           "from dual " );
      cmd_data.addParam("PaymentId0", RSDBP_IN, PaymentId);
      cmd_data.addParam("FNcash", RSDBP_IN, FNcash);
      cmd_data.execute;

      rs_data = RsdRecordSet( cmd_data );
      if ( rs_data.moveNext )
        ListTransfer = rs_data.value("listtransfer");
      end;
    end;

    ProcessTrnDoc;

    if  ( ProcKind == kind_ListTransfer )
      cmd_data = RsdCommand( 
         "select " +
                // "0 processstate, " +
                //"nvl((select t_globalsumfilial " +
                //       "from dtrn_payf_dbt " +
                //      "where t_autokey = ?), 0) payfsum, " +
                //"nvl((select paym.t_globalsumbusines " +
                //       "from dtrn_paym_dbt paym " +
                //      "where (paym.t_applicationkey, paym.t_iapplicationkind ) = " +
                //            "(select t_paymappkey, t_paymappkind " +
                //               "from dtrn_payf_dbt " +
                //              "where t_autokey = ?)), 0) paymsum, " +
                "0 paymsum,"
                "nvl((select sum(t_sum) " +
                       "from dtrn_doc_dbt " +
                      "where t_listtransfer = ?  " +
                        "and t_iapplicationkind <> 0), 0) trnsum " +
                // "(select nvl(sum(t_insum), 0) " +
                //    "from deoytemp_tmp eoy " +
                //   "where t_uniquereferenc is not null) payedsum "  +
           "from dual " );
      cmd_data.addParam("ListTransfer0", RSDBP_IN, ListTransfer);
      //cmd_data.addParam("ListTransfer1", RSDBP_IN, ListTransfer);
      //cmd_data.addParam("ListTransfer2", RSDBP_IN, ListTransfer);
    elif( ProcKind == kind_PaymentId )
      cmd_data = RsdCommand( 
         "select "+ 
                // "nvl((select t_processstate " +
                //       "from drtincomedoc_dbt " +
                //      "where t_incomepaymentid = ? ), 0) processstate, " +
                //"nvl((select t_globalsumfilial " +
                //       "from dtrn_payf_dbt " +:
                //      "where t_autokey = ?), 0) payfsum," +
                "nvl((select doc.t_creditamount " +
                       "from drtdocument_dbt doc, drtincomedoc_dbt income " +
                      "where t_incomepaymentid = ? " +
                        "and doc.t_documentid = income.t_documentid ), 0) paymsum, " +
                "nvl((select sum(t_sum) " +
                       "from dtrn_doc_dbt " +
                      "where t_paymentid = ?  " +
                        "and t_iapplicationkind <> 0), 0) trnsum " +
                // "(select nvl(sum(t_insum), 0) " +
                //    "from deoytemp_tmp eoy " +
                //   "where t_uniquereferenc is not null) payedsum "  +
           "from dual " );
      cmd_data.addParam("PaymentId0", RSDBP_IN, PaymentId);
      //cmd_data.addParam("ListTransfer0", RSDBP_IN, ListTransfer);
      //cmd_data.addParam("PaymentId1", RSDBP_IN, string(PaymentId));
      cmd_data.addParam("PaymentId2", RSDBP_IN, PaymentId);
    else
      runError("Неизвестное значение переменной, определяющей тип платежа");
    end;

    cmd_data.execute;

    rs_data = RsdRecordSet( cmd_data );
    if ( rs_data.moveNext )
      //processstate = int(rs_data.value("processstate"));
      //payfSum = rs_data.value("payfSum");
      paymSum = rs_data.value("paymSum");
      trnSum = rs_data.value("trnSum");
      //payedSum = rs_data.value("payedSum");
    else
      runError("Не найдено значения сумм");
    end;

    ProcessTrnPayf(trnSum);
    ProcessTrnPaym(trnSum);

    if( ProcKind == kind_PaymentId )
      ProcessBankTables(paymSum, trnSum);
    end;

  end; // ProcessPaymentTables

  private macro blockTable
    var cmd_block;
    var str_block = 
           "select     * " +
                 "from ddepositr_dbt depos " +
                "where depos.t_referenc in ( " +
                         "select trn.t_referenc " +
                           "from dtrn_doc_dbt trn " +
                          "where trn.t_typeoper = 73 ";
    if(   ProcKind == kind_ListTransfer )
      str_block = str_block + "and trn.t_listtransfer = ? ";
    elif( ProcKind == kind_PaymentId )
      str_block = str_block + "and t_paymentid = ? ";
    end;
    str_block = str_block + "and trn.t_status = chr (0) " +
                            "and trn.t_reasonnocarry = 0) " +
                  "and depos.t_type_account = ? " +
                  "and depos.t_sum_rest >= 0 " +
                  "and depos.t_numsuspendeddocs = 0 " +
                  "and depos.t_open_close = chr (0) " +
                  "and (select count (*) " +
                         "from dpc__calc_dbt " +
                        "where t_referenc = depos.t_referenc " +
                          "and t_objecttype = RSU_RTLDEPOSIT.getobjecttype (depos.t_usealternate) " +
                          "and t_typerecord = 1 " +
                          "and t_enddate >= RSU_RTLGLOBALS.getcurdate) = 1 " +
                  "and not exists ( " +
                         "select 1 " +
                           "from dsbdepdoc_dbt depdoc " +
                          "where depdoc.t_referenc = depos.t_referenc " +
                            "and depdoc.t_date_document > RSU_RTLGLOBALS.getcurdate) " +
           "for update ";
    cmd_block = RsdCommand( str_block );
    if(   ProcKind == kind_ListTransfer )
      cmd_block.addParam("listTransfer", RSDBP_IN );   cmd_block.value("listTransfer")  = ListTransfer;
    elif( ProcKind == kind_PaymentId )
      cmd_block.addParam("PaymentId",    RSDBP_IN );   cmd_block.value("PaymentId")     = PaymentId;
    end;
    cmd_block.addParam( "TypeAccount",   RSDBP_IN );   cmd_block.value( "TypeAccount" ) = TypeAccount;
    cmd_block.execute;
  end;


  private macro PresetTemporaryTable
    var cmd;
    var str;
    var countInsertedRecord = 0;
 
    str = 
       "insert into deoytemp_tmp " +
                   "(t_referenc, t_uniquereferenc, t_numdaydoc, t_type_account, t_fncash, t_account, " +
                    "t_date_document, t_iscur, t_code_currency, t_oper, t_appltype, t_ndoc, t_npack, " +
                    "t_kindop, t_insum, t_outsum, t_rest, t_percoprsum, t_percrest, t_percrestnotround, " +
                    "t_depositsum, t_flagrezid, t_iapplicationkind, t_applicationkey, t_listtransfer, " +
                    "t_codclient, t_typeoper, t_typecomplexoper, t_objectperc, t_depdate_document, " +
                    "t_brigade, t_ground, t_unionpart, t_mode, t_flags, t_realfncash, " +
                    "t_currentperioddate, t_nextperioddate, t_pcestimnumdaydoc, t_trn_autokey, t_taxsumpay, " +
                    "t_taxsumpayrur, t_taxpercratedep, t_taxapplicationkey, t_taxsumnextperiod, t_errorcode, " +
                    "t_iheadapplicationkind, t_headapplicationkey, t_GroupNumberID, t_NeedInfoForExtSys, t_ifrs_type) " +
          "select primalydepos.t_referenc, primalydepos.t_referenc, intermediatequery.numdaydepdoc, " +
                 "primalydepos.t_type_account, primalydepos.t_fncash, primalydepos.t_account, " +
                 "rsu_rtlglobals.getcurdate, primalydepos.t_iscur, primalydepos.t_code_currency, rsu_rtlglobals.getoper, " +
                 "primalytrndoc.t_appltype, primalytrndoc.t_ndoc, primalytrndoc.t_npack, 5, " +
                 "primalytrndoc.t_sum, 0, intermediatequery.prevrest + primalytrndoc.t_sum, " +
                 "rsu_rtlcommon.allmath_roundsum (intermediatequery.percsum - intermediatequery.sumcalc, " +
                                        "rsu_rtlcommon.get_all_math_round_unchange " +
                                       "), " +
                 "rsu_rtlcommon.allmath_roundsum (intermediatequery.percsum, rsu_rtlcommon.get_all_math_round_unchange), " +
                 "intermediatequery.percsum, primalytrndoc.t_sum, intermediatequery.isresident, 1, " +
                 "intermediatequery.applicationkey, ";
    if(   ProcKind == kind_ListTransfer )
      str = str +
                 "PrimalyTrnDoc.t_listtransfer, ";
    elif( ProcKind == kind_PaymentId )
      str = str +
                 "PrimalyTrnDoc.t_paymentid, ";
    end;

    str = str + 
                 "primalydepos.t_codclient, " +
                 "primalytrndoc.t_typeoper, primalytrndoc.t_typeoper, intermediatequery.objtype, " +
                 "case primalytrndoc.t_date_document " +
                    "when rsu_rtlglobals.getnulldate " +
                       "then rsu_rtlglobals.getcurdate " +
                    "else primalytrndoc.t_date_document " +
                 "end, " +
                 "rsu_rtlglobals.getoperbrigade, primalytrndoc.t_ground, " +
                 "rpad ('0', ? * 2, '0'), " + 
                 "?, ";        // Mode

    if(   ProcKind == kind_ListTransfer )
      str = str + 
                 "-2147483648 + 16384, "; // BIT_FLAG_UNCASH + BIT_FLAG_FORM_210_245
    elif( ProcKind == kind_PaymentId )
      str = str +
                 "268435456 + 16384, ";   // BIT_FLAG_EXTPAYM + BIT_FLAG_FORM_210_245
    end;
    str = str +    
                 "rsu_rtlglobals.getrealfncash, intermediatequery.nextperioddate, " +
                 "intermediatequery.nextperioddate, intermediatequery.numdaypcestimdoc, " +
                 "primalytrndoc.t_autokey, 0, 0, intermediatequery.rate, taxapplicationkey, 0, 0, " +
                 "1, intermediatequery.applicationkey, " +
                 "abs(to_number(primalydepos.t_GroupNumb)) GroupNumberID, (SELECT DECODE (count(*), 1, 'X', CHR (0)) " +
                 " FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 and T_OBJECTTYPE = 1 and " +
                 " T_OBJECTREF = to_char(primalydepos.t_referenc)) NeedInfoForExtSys, intermediatequery.ifrs_type " +
            "from ( select initialquery.autokey, initialquery.referenc, initialquery.prevrest, " +
                         "initialquery.objtype, " +
                         "(select nvl (max (t_numdaydoc), 0) + 10 " +
                            "from dsbdepdoc_dbt " +
                           "where t_referenc = initialquery.referenc " +
                             "and t_date_document = rsu_rtlglobals.getcurdate) numdaydepdoc, " +
                         "(select nvl (max (t_numdaydoc), 0) + 10 " +
                            "from dpcestim_dbt pcestim " +
                           "where pcestim.t_referenc = initialquery.referenc " +
                             "and pcestim.t_dateoperat = rsu_rtlglobals.getcurdate) numdaypcestimdoc, " +
                         "(select decode (t_notresident, chr (0), chr (0), 'X', chr (1)) " +
                            "from dparty_dbt " +
                           "where t_partyid = initialquery.codclient) isresident, " +
                         "rsu_rtlcommon.createapplickey_dangerous (rsu_rtlglobals.getfncash, " +
                                                         "rsu_rtlglobals.getcnum, " +
                                                         "rownum * 2 + rsu_rtlglobals.gettransactionnumber, " +
                                                         "rsu_rtlcommon.get_sb_deposit " +
                                                        ") applicationkey, " +
                         "rsu_rtlcommon.createapplickey_dangerous (rsu_rtlglobals.getfncash, " +
                                                         "rsu_rtlglobals.getcnum, " +
                                                         "rownum * 2 + 1 + rsu_rtlglobals.gettransactionnumber, " +
                                                         "rsu_rtlcommon.get_sb_deposit " +
                                                        ") taxapplicationkey, " +
                         "calc.t_sumcalcnotround, initialquery.sumoperation, calc.t_sumcalc sumcalc, " +
                         "calc.t_enddate nextperioddate, " +
                         "rsu_rtlpercent.onlycalcpercentbyoperation " +
                                         "(initialquery.prevdate, " +
                                          "initialquery.prevrest, " +
                                          "calc.t_enddate, " +
                                          "calc.t_sumcalcnotround, " +
                                          "rsu_rtlglobals.getcurdate, " +
                                          "initialquery.sumoperation, " +
                                          "rsu_rtlpercent.getpercrateforaccountsimple (initialquery.referenc, " +
                                                                            "initialquery.objtype, " +
                                                                            "rsu_rtlglobals.getcurdate, " +
                                                                            "initialquery.prevrest " +
                                                                           ") " +
                                         ") percsum, " +
                         "rsu_rtlpercent.getpercrateforaccountsimple (initialquery.referenc, " +
                                                           "initialquery.objtype, " +
                                                           "rsu_rtlglobals.getcurdate, " +
                                                           "initialquery.prevrest " +
                                                          ") rate, " +
                         "0 ifrs_type " +
                    "from ( select trn.t_autokey autokey, depos.t_referenc referenc, " +
                                 "depos.t_codclient codclient, trn.t_sum sumoperation, " +
                                 "(select orderedpcdrest.t_rest " +
                                    "from (select   t_referenc, t_type_object, t_rest " +
                                              "from dpc_drest_dbt " +
                                          "order by t_referenc desc, t_date_rest desc) orderedpcdrest " +
                                   "where orderedpcdrest.t_referenc = depos.t_referenc " +
                                     "and orderedpcdrest.t_type_object = " +
                                                                  "rsu_rtldeposit.getobjecttype (depos.t_usealternate) " +
                                     "and rownum = 1) prevrest, " +
                                 "(select orderedpcdrest.t_date_rest " +
                                    "from (select   t_referenc, t_type_object, t_date_rest " +
                                              "from dpc_drest_dbt " +
                                          "order by t_referenc desc, t_date_rest desc) orderedpcdrest " +
                                   "where orderedpcdrest.t_referenc = depos.t_referenc " +
                                     "and orderedpcdrest.t_type_object = " +
                                                                  "rsu_rtldeposit.getobjecttype (depos.t_usealternate) " +
                                     "and rownum = 1) prevdate, " +
                                 "rsu_rtldeposit.getobjecttype (depos.t_usealternate) objtype " +
                             "from ( ";
    if(   ProcKind == kind_ListTransfer )
      str = str +  
                                   "select trn.t_autokey autokey " +
                                     "from (select   t_referenc, min (t_autokey) autokey " +
                                               "from dtrn_doc_dbt " +
                                              "where t_listtransfer = ?  " + //--------->
                                                    "and t_status = chr (0) " +
                                           "group by t_referenc) t, " +
                                          "dtrn_doc_dbt trn, " +
                                          "dtrn_payf_dbt payf " +
                                    "where t.autokey = trn.t_autokey " +
                                      "and trn.t_listtransfer = payf.t_autokey " +
                                      "and (   trn.t_signchecklist != chr (0) " +
                                           "or payf.t_signcheckfilial != chr (0) ) ";
    elif( ProcKind == kind_PaymentId )
      str = str +
                                   "select trn.t_autokey autokey " +
                                     "from (select   t_referenc, min(t_autokey) autokey " +
                                               "from dtrn_doc_dbt " +
                                              "where t_paymentid = ? " +
                                                "and t_status = chr(0) " +
                                           "group by t_referenc) t, dtrn_doc_dbt trn " +
                                    "where t.autokey = trn.t_autokey ";
      if ( isForPFR )
        str = str + "and nvl(trn.t_PayCode,chr(1)) = chr(1) ";
      end;
    end;
    str = str +  
                               ") trn_key, " +
                                 "dtrn_doc_dbt trn, " +
                                 "ddepositr_dbt depos " +
                           "where trn_key.autokey = trn.t_autokey " +
                             "and trn.t_referenc = depos.t_referenc " +
                             "and trn.t_status = chr (0) " +
                             "and trn.t_reasonnocarry = 0 " +
//По проекту это условие должно быть, но при его наличии не проводятся документы из пункта договора по группам счетов
//                             "and trn.t_sum = trn.t_sumcheck " +
                             "and depos.t_type_account = ? " +
                             "and trn.t_typeoper = 73 " +
//                             "and depos.t_sum_rest >= 0 " +
                             "and depos.t_numsuspendeddocs = 0 " +
                             "and depos.t_usertypeaccount not like '%Т%' " +
                             "and depos.t_usertypeaccount not like '%Д%' " +
                             "and not (depos.t_usertypeaccount like '%О%' and depos.t_usertypeaccount not like '%К%') " +
                             "and (   (    depos.t_usertypeaccount like '%К%' " +
                                      "and not (    rsu_rtlglobals.getcardslimitoverrundate <> rsu_rtlglobals.getnulldate " +
                                               "and depos.t_open_date >= rsu_rtlglobals.getcardslimitoverrundate " +
                                              ") " +
                                     ") " +
                                  "or (    (depos.t_usertypeaccount not like '%К%') " +
                                      "and not (    rsu_rtlglobals.getdepacclimitoverrundate <> rsu_rtlglobals.getnulldate " +
                                               "and depos.t_open_date >= rsu_rtlglobals.getdepacclimitoverrundate " +
                                              ") " +
                                     ") " +
                                 ") " +
                             "and depos.t_open_close = chr (0)             " +
                             ") initialquery, " +
                         "dpc__calc_dbt calc " +
                   "where calc.t_referenc = initialquery.referenc " +
                     "and calc.t_objecttype = initialquery.objtype " +
                     "and calc.t_typerecord = 1 " +
                     "and calc.t_enddate >= rsu_rtlglobals.getcurdate " +
                     "and prevdate is not null " +
                     "and prevrest is not null " +
                     "and (select count (*) " +
                            "from dpc__calc_dbt " +
                           "where t_referenc = initialquery.referenc " +
                             "and t_objecttype = initialquery.objtype " +
                             "and t_typerecord = 1 " +
                             "and t_enddate >= rsu_rtlglobals.getcurdate) = 1 " +
                     "and not exists ( " +
                            "select 1 " +
                              "from ddpindebt_dbt dp " +
                             "where dp.t_branch = rsu_rtlglobals.getfncash " +
                               "and dp.t_reference = initialquery.referenc " +
                               "and dp.t_state = 1 " +
                               "and dp.t_action not in (2, 11)) " + 
                               ") intermediatequery, " +
                 "ddepositr_dbt primalydepos, " +
                 "dtrn_doc_dbt primalytrndoc " +
           "where primalydepos.t_referenc = intermediatequery.referenc " +
             "and primalytrndoc.t_autokey = intermediatequery.autokey " +
             "and not exists ( " +
                    "select 1 " +
                      "from dsbdepdoc_dbt " +
                     "where t_referenc = primalydepos.t_referenc " +
                       "and t_date_document > case primalytrndoc.t_date_document " +
                                                 "when rsu_rtlglobals.getnulldate " +
                                                    "then rsu_rtlglobals.getcurdate " +
                                                 "else primalytrndoc.t_date_document " +
                                              "end ) "; 

    cmd = RsdCommand( str );
    cmd.addParam("FieldLenght",    RSDBP_IN );   cmd.value("FieldLenght")  = FieldLenght;
    cmd.addParam("mode",           RSDBP_IN );   cmd.value("mode")         = ModeEndOfYear;
    if(   ProcKind == kind_ListTransfer )
      cmd.addParam("listTransfer", RSDBP_IN );   cmd.value("listTransfer") = ListTransfer;
    elif( ProcKind == kind_PaymentId )
      cmd.addParam("PaymentId",    RSDBP_IN );   cmd.value("PaymentId")    = PaymentId;
    end;
    cmd.addParam("TypeAccount",    RSDBP_IN );   cmd.value("TypeAccount")  = TypeAccount;    

    cmd.execute;
    PrintTime("deoytemp_tmp");

    if (NeedTaxCalc)
      DeleteUnsupportedRecords(false);
    end;

    countInsertedRecord = DefineTransactionNumber;

    FillSubAccountFieldsInTemporaryTable;
    FillPcEstimFieldsInTemporaryTableSP;


    // Если надо погасить овердрафты
    if ( Mode == MODE_KREDIT )
      PaymentOverdraft;

      RsdCommand( "begin rsu_rtlcard.recalcsumineoy(); end;" ).execute();
      PrintTime("rsu_rtlcard.recalcsumineoy()");
      DeleteErrorRecord;
    end;

    if (NeedTaxCalc)
      FillTaxFieldsInTemporaryTable();
    end;

    return defineCountRecordInTable("deoytemp_tmp");;

  end; // PresetTemporaryTable

//---------------------------
  macro ProcessAll

   if (PaymentId > 0)
    var cmd = RsdCommand("select cntr.t_isForPFR, paym.t_PartCount, paym.t_PartTotalCount, paym.t_PaymentId " +
                             "from dRTIncomeDoc_dbt indoc inner join dRTDocument_dbt rtdoc using(t_DocumentId) "+
                                                         "inner join dTrn_Paym_dbt paym on (paym.t_NumberContract = indoc.t_TrnContractNumber and " +
                                                                                           "paym.t_Num_PayMessage = rtdoc.t_DocumentNumber and " +
                                                                                           "paym.t_PaymentId = cast(indoc.t_IncomePaymentId as number(10))) " +
                                  "inner join dTrn_Cntr_dbt cntr using (t_NumberContract) " +
                                 "where indoc.t_IncomeDocType = 30 and " +
                                       "indoc.t_TrnContractNumber <> chr(1) and " +
                                       "indoc.t_IncomePaymentId = ?");
    cmd.addParam("",RsdBp_In,string(PaymentId));
    cmd.NullConversion=true;
    cmd.execute();
    var rs = RsdRecordSet(cmd);
    if ( not rs.moveNext() )
      runError(Errmessage(16514),16514);
    end;

    if ( isForPFR=rs.value("t_isForPFR") )
      if ( rs.value("t_PartCount") != rs.value("t_PartTotalCount") )
        runError(ErrMessage(21346),21346);
      elif ( not rs.value("t_PaymentId") )
        runError(Errmessage(21347),21347);
      end;
    end;
   end;

    Predetermine;
    SetVariables;

    blockTable;
    if ( PresetTemporaryTable == 0 )
      println("Прерываем обработку, так как временная таблица пуста");      
      return;
    end;

    if( not createPMD )
      runError("Ошибка при формировании РДД");
    end;

    ProcessSbDepDoc(FillSbDepDocPayment);
    ProcessDepositrForSeveralDocs;  //ProcessDepositr;

    UpdatePcCalcForSeveralDocs;

    ProcessPcDRestForSeveralDocs; //ProcessPcDRest;
    ProcessRetOp;
    ProcessOpObject;

    ProcessPcEstimForSeveralDocs;

    ProcessEdRef;

    ProcessScCrdDoc;

    ProcessPaymentTables;

    if (NeedTaxCalc)
      ProcessPcTax(FillPcTaxCalc);
      UpdatePcCalcForTax(FillPcTaxCalcForSeveralOperation);
    end;

    InterDesk_EndDocBunch;

    PrintTime("Перед транзакцией");
    
//    RunError("Рано нам пока ишшо вставлять все в базу....");

    OnError ( e )

      PrintErrorMessage(e);
      InterDesk_EndDocBunch;
      AbortTrn();

  end; // ProcessAll

//---------------------------
// Начало
//---------------------------

  SetOutput( nr, true );
  PrintTime("begin");
  RTsessionActionMess( "Вклады:Списк.зач.DML" );

  macroName = "PackPayment.mac";

  ListTransfer  = pListTransfer;
  PaymentId     = pPaymentId; 
  TypeAccount   = pTypeAccount;
  OrderNum      = pOrderNum;

  ClearTempTable;
  EndDate       = {curdate};
  Mode          = MODE_KREDIT;
  ProcType      = Proc_PackPut;

  LoopInTrn(true);
  if   ( ListTransfer != 0 )
    ProcKind = kind_ListTransfer;
    ProcessTrn( 0, R2M(this, "ProcessAll") );
  elif ( PaymentId != 0 )
    ProcKind = kind_PaymentId;
    ListTransfer = 0;
    ProcessTrn( 0, R2M(this, "ProcessAll") );
  else 
    RunError("Неверно заданы входные параметры!");    
  end;

  PrintTime("End");
  // RTsessionActionEnd();

  SetOutput( nr, false );
end; // class PayScTran


macro start( pListTransfer, 
             pPaymentId, 
             pTypeAccount,
             pOrderNum 
           )

  TimeControl = false;

  PackPayment( pListTransfer, 
               pPaymentId, 
               pTypeAccount,
               pOrderNum );

end;
