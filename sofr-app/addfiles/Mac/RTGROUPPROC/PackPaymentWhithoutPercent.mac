/*
$Name:           PackPaymentWhithoutPercent.mac
$Module:         RETAIL
$Description:    DML оплата пакетных зачислений видов вкладов для которых не расчитываются проценты
*/

import deprintr, rsd, PackPayment, ic_comdata;


class(PackPayment) 
   PackPaymentWhithoutPercent( pListTransfer, pPaymentId, pTypeAccount, pOrderNum )

  private macro PresetTemporaryTable
    var cmd;
    var str;
    var countInsertedRecord = 0;
 
    str = 
       "insert into deoytemp_tmp " +
                   "(t_referenc, t_uniquereferenc, t_numdaydoc, t_type_account, t_fncash, t_account, " +
                    "t_date_document, t_iscur, t_code_currency, t_oper, t_appltype, t_ndoc, t_npack, " +
                    "t_kindop, t_insum, t_outsum, t_rest, " +
                    "t_depositsum, t_flagrezid, t_iapplicationkind, t_applicationkey, t_listtransfer, " +
                    "t_codclient, t_typeoper, t_typecomplexoper, t_objectperc, t_depdate_document, " +
                    "t_brigade, t_ground, t_unionpart, t_mode, t_flags, t_realfncash, " +
                    "t_trn_autokey, t_errorcode, " +
                    "t_iheadapplicationkind, t_headapplicationkey, t_GroupNumberID, t_NeedInfoForExtSys, t_ifrs_type) " +
          "select primalydepos.t_referenc, primalydepos.t_referenc, intermediatequery.numdaydepdoc, " +
                 "primalydepos.t_type_account, primalydepos.t_fncash, primalydepos.t_account, " +
                 "rsu_rtlglobals.getcurdate, primalydepos.t_iscur, primalydepos.t_code_currency, rsu_rtlglobals.getoper, " +
                 "primalytrndoc.t_appltype, primalytrndoc.t_ndoc, primalytrndoc.t_npack, 5, " +
                 "primalytrndoc.t_sum, 0, intermediatequery.prevrest + primalytrndoc.t_sum, " +
                 "primalytrndoc.t_sum, intermediatequery.isresident, 1, " +
                 "intermediatequery.applicationkey, ";
    if(   ProcKind == kind_ListTransfer )
      str = str +
                 "PrimalyTrnDoc.t_listtransfer, ";
    elif( ProcKind == kind_PaymentId )
      str = str +
                 "PrimalyTrnDoc.t_paymentid, ";
    end;

    str = str + 
                 "primalydepos.t_codclient, " +
                 "primalytrndoc.t_typeoper, primalytrndoc.t_typeoper, intermediatequery.objtype, " +
                 "case primalytrndoc.t_date_document " +
                    "when rsu_rtlglobals.getnulldate " +
                       "then rsu_rtlglobals.getcurdate " +
                    "else primalytrndoc.t_date_document " +
                 "end, " +
                 "rsu_rtlglobals.getoperbrigade, primalytrndoc.t_ground, " +
                 "rpad ('0', ? * 2, '0'), " + 
                 "?, ";        // Mode

    if(   ProcKind == kind_ListTransfer )
      str = str + 
                 "-2147483648 + 16384, "; // BIT_FLAG_UNCASH + BIT_FLAG_FORM_210_245
    elif( ProcKind == kind_PaymentId )
      str = str +
                 "268435456 + 16384, ";   // BIT_FLAG_EXTPAYM + BIT_FLAG_FORM_210_245
    end;
    str = str +    
                 "rsu_rtlglobals.getrealfncash, " +
                 "primalytrndoc.t_autokey, 0, " +
                 "1, intermediatequery.applicationkey, " +
                 "abs(to_number(primalydepos.t_GroupNumb)) GroupNumberID, (SELECT DECODE (count(*), 1, 'X', CHR (0)) " +
                 " FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 and T_OBJECTTYPE = 1 and " +
                 " T_OBJECTREF = to_char(primalydepos.t_referenc)) NeedInfoForExtSys, intermediatequery.ifrs_type " +
            "from ( select initialquery.autokey, initialquery.referenc, initialquery.prevrest, " +
                         "initialquery.objtype, " +
                         "(select nvl (max (t_numdaydoc), 0) + 10 " +
                            "from dsbdepdoc_dbt " +
                           "where t_referenc = initialquery.referenc " +
                             "and t_date_document = rsu_rtlglobals.getcurdate) numdaydepdoc, " +
                         "(select decode (t_notresident, chr (0), chr (0), 'X', chr (1)) " +
                            "from dparty_dbt " +
                           "where t_partyid = initialquery.codclient) isresident, " +
                         "rsu_rtlcommon.createapplickey_dangerous (rsu_rtlglobals.getfncash, " +
                                                         "rsu_rtlglobals.getcnum, " +
                                                         "rownum * 2 + rsu_rtlglobals.gettransactionnumber, " +
                                                         "rsu_rtlcommon.get_sb_deposit " +
                                                        ") applicationkey, " +
                                          "initialquery.sumoperation, " +
                         "0 ifrs_type " +
                    "from ( select trn.t_autokey autokey, depos.t_referenc referenc, " +
                                 "depos.t_codclient codclient, trn.t_sum sumoperation, " +
                                 "(select orderedpcdrest.t_rest " +
                                    "from (select   t_referenc, t_type_object, t_rest " +
                                              "from dpc_drest_dbt " +
                                          "order by t_referenc desc, t_date_rest desc) orderedpcdrest " +
                                   "where orderedpcdrest.t_referenc = depos.t_referenc " +
                                     "and orderedpcdrest.t_type_object = " +
                                                                  "rsu_rtldeposit.getobjecttype (depos.t_usealternate) " +
                                     "and rownum = 1) prevrest, " +
                                 "(select orderedpcdrest.t_date_rest " +
                                    "from (select   t_referenc, t_type_object, t_date_rest " +
                                              "from dpc_drest_dbt " +
                                          "order by t_referenc desc, t_date_rest desc) orderedpcdrest " +
                                   "where orderedpcdrest.t_referenc = depos.t_referenc " +
                                     "and orderedpcdrest.t_type_object = " +
                                                                  "rsu_rtldeposit.getobjecttype (depos.t_usealternate) " +
                                     "and rownum = 1) prevdate, " +
                                 "rsu_rtldeposit.getobjecttype (depos.t_usealternate) objtype " +
                             "from ( ";
    if(   ProcKind == kind_ListTransfer )
      str = str +  
                                   "select trn.t_autokey autokey " +
                                     "from (select   t_referenc, min (t_autokey) autokey " +
                                               "from dtrn_doc_dbt " +
                                              "where t_listtransfer = ?  " + //--------->
                                                    "and t_status = chr (0) " +
                                           "group by t_referenc) t, " +
                                          "dtrn_doc_dbt trn, " +
                                          "dtrn_payf_dbt payf " +
                                    "where t.autokey = trn.t_autokey " +
                                      "and trn.t_listtransfer = payf.t_autokey " +
                                      "and (   trn.t_signchecklist != chr (0) " +
                                           "or payf.t_signcheckfilial != chr (0) ) ";
    elif( ProcKind == kind_PaymentId )
      str = str +
                                   "select trn.t_autokey autokey " +
                                     "from (select   t_referenc, min(t_autokey) autokey " +
                                               "from dtrn_doc_dbt " +
                                              "where t_paymentid = ? " +
                                                "and t_status = chr(0) " +
                                           "group by t_referenc) t, dtrn_doc_dbt trn " +
                                    "where t.autokey = trn.t_autokey ";
      if ( isForPFR )
        str = str + "and nvl(trn.t_PayCode,chr(1)) = chr(1) ";
      end;
    end;
    str = str +  
                               ") trn_key, " +
                                 "dtrn_doc_dbt trn, " +
                                 "ddepositr_dbt depos " +
                           "where trn_key.autokey = trn.t_autokey " +
                             "and trn.t_referenc = depos.t_referenc " +
                             "and trn.t_status = chr (0) " +
                             "and trn.t_reasonnocarry = 0 " +
//По проекту это условие должно быть, но при его наличии не проводятся документы из пункта договора по группам счетов
//                             "and trn.t_sum = trn.t_sumcheck " +
                             "and depos.t_type_account = ? " +
                             "and trn.t_typeoper = 73 " +
//                             "and depos.t_sum_rest >= 0 " +
                             "and depos.t_numsuspendeddocs = 0 " +
                             "and depos.t_usertypeaccount not like '%Т%' " +
                             "and depos.t_usertypeaccount not like '%Д%' " +
                             "and not (depos.t_usertypeaccount like '%О%' and depos.t_usertypeaccount not like '%К%') " +
                             "and (   (    depos.t_usertypeaccount like '%К%' " +
                                      "and not (    rsu_rtlglobals.getcardslimitoverrundate <> rsu_rtlglobals.getnulldate " +
                                               "and depos.t_open_date >= rsu_rtlglobals.getcardslimitoverrundate " +
                                              ") " +
                                     ") " +
                                  "or (    (depos.t_usertypeaccount not like '%К%') " +
                                      "and not (    rsu_rtlglobals.getdepacclimitoverrundate <> rsu_rtlglobals.getnulldate " +
                                               "and depos.t_open_date >= rsu_rtlglobals.getdepacclimitoverrundate " +
                                              ") " +
                                     ") " +
                                 ") " +
                             "and depos.t_open_close = chr (0) " +
                             "and (select sum (abs (pc_alg.t_stratcalc)) " +
                                    "from dpc_alg_dbt pc_alg " +
                                   "where pc_alg.t_flagcur = depos.t_iscur " +
                                     "and pc_alg.t_referenc = depos.t_type_account " +
                                     "and pc_alg.t_objecttype = 1003 " +
                                  "group by t_referenc, t_flagcur ) = 0 " +
                             ") initialquery " +
                   "where prevdate is not null " +
                     "and prevrest is not null " +
                     "and not exists ( " +
                            "select 1 " +
                              "from ddpindebt_dbt dp " +
                             "where dp.t_branch = rsu_rtlglobals.getfncash " +
                               "and dp.t_reference = initialquery.referenc " +
                               "and dp.t_state = 1 " +
                               "and dp.t_action not in (2, 11)) " + 
                               ") intermediatequery, " +
                 "ddepositr_dbt primalydepos, " +
                 "dtrn_doc_dbt primalytrndoc " +
           "where primalydepos.t_referenc = intermediatequery.referenc " +
             "and primalytrndoc.t_autokey = intermediatequery.autokey " +
             "and not exists ( " +
                    "select 1 " +
                      "from dsbdepdoc_dbt " +
                     "where t_referenc = primalydepos.t_referenc " +
                       "and t_date_document > case primalytrndoc.t_date_document " +
                                                 "when rsu_rtlglobals.getnulldate " +
                                                    "then rsu_rtlglobals.getcurdate " +
                                                 "else primalytrndoc.t_date_document " +
                                              "end ) "; 

    cmd = RsdCommand( str );
    cmd.addParam("FieldLenght",    RSDBP_IN );   cmd.value("FieldLenght")  = FieldLenght;
    cmd.addParam("mode",           RSDBP_IN );   cmd.value("mode")         = ModeEndOfYear;
    if(   ProcKind == kind_ListTransfer )
      cmd.addParam("listTransfer", RSDBP_IN );   cmd.value("listTransfer") = ListTransfer;
    elif( ProcKind == kind_PaymentId )
      cmd.addParam("PaymentId",    RSDBP_IN );   cmd.value("PaymentId")    = PaymentId;
    end;
    cmd.addParam("TypeAccount",    RSDBP_IN );   cmd.value("TypeAccount")  = TypeAccount;    

    cmd.execute;
    PrintTime("deoytemp_tmp");

    if (NeedTaxCalc)
      DeleteUnsupportedRecords(false);
    end;

    countInsertedRecord = DefineTransactionNumber;

    FillSubAccountFieldsInTemporaryTable;
    //FillPcEstimFieldsInTemporaryTableSP;

    // Если надо погасить овердрафты
    if ( Mode == MODE_KREDIT )
      PaymentOverdraft;

      RsdCommand( "begin rsu_rtlcard.RecalcSumInEoyWhithoutPercent(); end;" ).execute();
      PrintTime("rsu_rtlcard.recalcsumineoy()");
      DeleteErrorRecord;
    end;

    return defineCountRecordInTable("deoytemp_tmp");;

  end; // PresetTemporaryTable

//---------------------------
  macro ProcessAll
   if (PaymentId > 0) 
    var cmd = RsdCommand("select cntr.t_isForPFR, paym.t_PartCount, paym.t_PartTotalCount, paym.t_PaymentId " +
                             "from dRTIncomeDoc_dbt indoc inner join dRTDocument_dbt rtdoc using(t_DocumentId) "+
                                                         "inner join dTrn_Paym_dbt paym on (paym.t_NumberContract = indoc.t_TrnContractNumber and " +
                                                                                           "paym.t_Num_PayMessage = rtdoc.t_DocumentNumber and " +
                                                                                           "paym.t_PaymentId = cast(indoc.t_IncomePaymentId as number(10))) " +
                                  "inner join dTrn_Cntr_dbt cntr using (t_NumberContract) " +
                                 "where indoc.t_IncomeDocType = 30 and " +
                                       "indoc.t_TrnContractNumber <> chr(1) and " +
                                       "indoc.t_IncomePaymentId = ?");
    cmd.addParam("",RsdBp_In,string(PaymentId));
    cmd.NullConversion=true;
    cmd.execute();
    var rs = RsdRecordSet(cmd);
    if ( not rs.moveNext() )
      runError(Errmessage(16514),16514);
    end;

    if ( isForPFR=rs.value("t_isForPFR") )
      if ( rs.value("t_PartCount") != rs.value("t_PartTotalCount") )
        runError(ErrMessage(21346),21346);
      elif ( not rs.value("t_PaymentId") )
        runError(ErrMessage(21347),21347);
      end;
    end;
   end;

    Predetermine;
    SetVariables;

    blockTable;
    if ( PresetTemporaryTable == 0 )
      println("Прерываем обработку, так как временная таблица пуста");      
      return;
    end;

    if( not createPMD )
      runError("Ошибка при формировании РДД");
    end;

    ProcessSbDepDoc(FillSbDepDocPayment);
    ProcessDepositrForSeveralDocs;

    ProcessPcDRestForSeveralDocs;
    ProcessRetOp;
    ProcessOpObject;

    ProcessEdRef;

    ProcessScCrdDoc;

    ProcessTrnDoc;
    if  ( ProcKind == kind_ListTransfer )
      ProcessTrnPayf;
    elif( ProcKind == kind_PaymentId )
      ProcessBankTables;
    end;

    InterDesk_EndDocBunch;

    PrintTime("Перед транзакцией");
    
    OnError ( e )

      PrintErrorMessage(e);
      InterDesk_EndDocBunch;
      AbortTrn();

  end; // ProcessAll

//---------------------------
// Начало
//---------------------------

  SetOutput( nr, true );
  PrintTime("begin");
  RTsessionActionMess( "Вклады:Списк.зач.DML" );

  macroName = "PackPayment.mac";

  ListTransfer  = pListTransfer;
  PaymentId     = pPaymentId; 
  TypeAccount   = pTypeAccount;
  OrderNum      = pOrderNum;

  ClearTempTable;
  EndDate       = {curdate};
  Mode          = MODE_KREDIT;
  ProcType      = Proc_PackPut;

  LoopInTrn(true);
  if   ( ListTransfer != 0 )
    ProcKind = kind_ListTransfer;
    ProcessTrn( 0, R2M(this, "ProcessAll") );
  elif ( PaymentId    != 0 )
    ProcKind = kind_PaymentId;
    ProcessTrn( 0, R2M(this, "ProcessAll") );
  else 
    RunError("Неверно заданы входные параметры!");    
  end;

  PrintTime("End");
  // RTsessionActionEnd();

  SetOutput( nr, false );
end; // class PackPaymentWhithoutPercent


private macro start( pListTransfer, 
                     pPaymentId, 
                     pTypeAccount,
                     pOrderNum 
                   )

  TimeControl = false;

  PackPaymentWhithoutPercent( pListTransfer, 
                              pPaymentId, 
                              pTypeAccount,
                              pOrderNum );

end;
