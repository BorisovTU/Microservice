/*
$Name:               MassDMLProcBase.mac
$Module:             RS-Retail
$Description:        Системные функции для ускоренных групповых зачислений
*/
/*****************************************************/
/*  Быстрый расчет процентов                         */
/*  Базовый класс                                    */
/*****************************************************/

import deprintr, commoninter, rsd, SetRtGlobVar, globals, office;
import Календарь;
import SbCrdInter;


var {CNum},
    {DepFNCash};

var FNCash      = NumFNCash,
    FlagCur     = NumFlagCur,
    OperBrigade = GetOperBrigade,
    TrnNumber   = GetTransactionNumber;

const TrnNumber_atInsertTemporaryTable = 0,
      TrnNumber_atUpdateSubAccountPart = 1,
      TrnNumber_atCreateDocsOverdraft  = 2;

const FillMainScrdDoc = 0,
      FillAddScrdDoc  = 1,
      FillTaxScrdDoc  = 2;

const FillSbDepDocPerc    = 0,
      FillSbDepDocTran    = 1,
      FillSbDepDocAdd     = 2,
      FillSbDepDocTax     = 3,
      FillSbDepDocPayment = 4;   

const FillEdRefPerc = 0,
      FillEdRefTran = 1,
      FillEdRefAdd  = 2,
      FillEdRefTax  = 3;

const FillPcTaxPay                     = 0,
      FillPcTaxCalc                    = 1,
      FillPcTaxCalcForOperation        = 2,
      FillPcTaxCalcForSeveralOperation = 3;

const FillRetOpPerc = 0,
      FillRetOpTran = 1;

const Usually      = 0,
      OnlyForLoans = 1;

const Proc_None = 0,
      Proc_Eoy = 1,
      Proc_PutPerc = 2,
      Proc_PackPut = 3,
      Proc_PayScTran = 4,
      Proc_LoansDutyPay = 5;

// Режимы работы с транзакциями
const MODE_KREDIT        = 1,
      MODE_WITHOUT_OVER  = 2,
      MODE_WITH_OVER     = 3,
      MODE_LOANS_ACCOUNT = 5,
      MODE_LOANS_CARD    = 6;

file bm ("sbbank.msg")   key 0;


var TimeControl = false;

macro PrintTime( str )
  if ( TimeControl )
    [############################     #] ( str, time );
  end;
end; //PrintTime

  // Выводим сообщение об ошибке
  macro PrintErrorMessage( e )
    var i = 0;
    println ( e.Message ); 
    while ( i < RslDefEnv.ErrorCount )
      println ( " Системная ошибка - " + RslDefEnv.Error(i).descr );
      i = i + 1;
    end;
    //AbortTrn();
  end; // PrintErrorMessage

  // Выведем сообщение об ошибке из Java
  macro getPMDError
    var ErrStat = 0;
    var ErrMes = "";
    ErrStat = GetErrorMessage(ErrMes);
    println(ErrStat, ": ", ErrMes);
  end;

  // Выведем сообщение об ошибке из пакета
  macro getPMDErrorFromPackage
    var cmd, rs;
    cmd = RsdCommand("select rsi_rtldeposit.get_pmd_text_error err from dual");
    cmd.execute;
    rs = RsdRecordSet(cmd);
    if (rs.moveNext)
      println(rs.value("err"));
    end;
  end;

  // Выведем сообщение об ошибке из пакета
  macro getPMDErrorUserProcFromPackage
    var cmd, rs;
    cmd = RsdCommand("select rsu_rtlcard.get_textError_getUserProcAddSP err from dual");
    cmd.execute;
    rs = RsdRecordSet(cmd);
    if (rs.moveNext)
      println(rs.value("err"));
    end;
  end;


  // Операция проводится из группы зачисления
  macro isGZMode
    var flagGZ = false;
    var curMode = GetCurrentMode( );

    if ( GetBitFlag( curMode, 2 ) != 0 ) // MODE_GZ
      flagGZ = true;
    end;

    return flagGZ;
  end;

private macro putGroupStorageValue(name:string, type:string, val:string)
  var cmd = RsdCommand("begin rsi_rtlbook.putStorageValue(?, ?, ?); end;");
  cmd.addParam("name", RSDBP_IN, name);
  cmd.addParam("type", RSDBP_IN, type);
  cmd.addParam("val", RSDBP_IN, val);
  cmd.execute();
end;


private macro putGroupStorageDate(name:string, val:date)
  putGroupStorageValue(name, "FT_DATE", string(val:f));
end;


private macro initGroupStorage()
  var cmd = RsdCommand("begin rsi_rtlbook.clearStorage(); end;");
  cmd.execute();

  var d = GetNextDateAfterDays({curdate}, {DepFNCash}, CALENDAR_SERVICE_BANK, CALENDAR_BALANCE_YES, 0);
  putGroupStorageDate("ДатаВыполненияРабочая", d);

  d = GetNextDateAfterDays({curdate}, {DepFNCash}, null, CALENDAR_BALANCE_YES, 0);
  putGroupStorageDate("ДатаВыполненияБаланс", d);

  d = GetNextDateAfterDays({curdate}, {DepFNCash}, CALENDAR_SERVICE_BANK, CALENDAR_BALANCE_YES, 1);
  putGroupStorageDate("ДатаВыполненияПлюсОдинРабочая", d);

  d = GetNextDateAfterDays({curdate}, {DepFNCash}, null, CALENDAR_BALANCE_YES, 1);
  putGroupStorageDate("ДатаВыполненияПлюсОдинБаланс", d);
end;


//---------------------------
// Базовый класс
//---------------------------
class MassDMLProcBase

private var
  macroName,

  TypeAccount, 
  TypeAccountExe,
  OrderNum,
  ObjectType,

  CodeCurrency,
  
  NumDayInYear,
  NumDayInNextPeriod,
  EndDate,
  NextEndDate,
  Rate,
  Ground,  

  ActiveFmtStruct,
  BeginOffset, 
  FieldLenght;

private var 
  NeedTaxCalc,
  PcTaxBlobSize;

private var 
  Mode;
private var 
  ProcType;

//---------------------------
// Формирум строку сообщения по коду ошибки ошибки
  macro ErrMsg( code )
    var str;
    bm.Number = code;
    if ( GetEQ( bm ) )
      str = bm.Contents;
    else
      str = "Ошибка " + String(code);
    end;
    return str;
  end; // ErrMsg

//---------------------------
  private macro ReadFmtStruct(name)
    var cmd;

    if (ActiveFmtStruct != name)
      cmd = RsdCommand("begin rsb_struct.readstruct(?); end;");
      cmd.addParam("name", RSDBP_IN, name);
      cmd.execute();
      ActiveFmtStruct = name;
    end;
  end; // ReadFmtStruct

// Выполняем предварительные действия 
  private macro Predetermine

    [---------------------------------------------------------------------------];
    if ( TypeAccount != null )
      [Вид вклада счета:                 ##############] (TypeAccount);
      [Вид вклада для расчета процентов: ##############] (TypeAccountExe);
      [Код валюты: #]( CodeCurrency );
    else
      [Имя макроса:                      ##############] (macroName);
    end;

    [Подразделение:                    ##############] (FNCash);

    // Выставляем глобализмы системы
    SetRtGlobalVariables;
    SetGroupProcDB;

    // Определяем переменные для формирования RAW-полей
    var cmd_fmt, cmd_date;
    var rs_fmt;
  
    cmd_fmt = RsdCommand(
       "select (select t_offset " +
                 "from fmt_fields " +
                "where t_fmtid = (select t_id " +
                                   "from fmt_names " +
                                  "where lower (t_name) = 'dsbdepdoc_2') " +
                  "and lower (t_name) = 't_globperc') beginoffset, " +
              "(select t_size " +
                 "from fmt_fields " +
                "where t_fmtid = (select t_id " +
                                   "from fmt_names " +
                                  "where lower (t_name) = 'dsbdepdoc_dbt') " +
                  "and lower (t_name) = 't_unionpart') fieldlenght " +
         "from dual " );
    cmd_fmt.execute;
    rs_fmt = RsdRecordSet( cmd_fmt );
    if ( rs_fmt.MoveNext )
      BeginOffset = int(rs_fmt.value("BeginOffset"));
      FieldLenght = int(rs_fmt.value("FieldLenght"));
      if ( (BeginOffset == 0) or (FieldLenght == 0 ) )
        RunError("Не получается определить данные из fmt");  
        return;
      end;  
    end;

    ReadFmtStruct("dsbdepdoc_2");

    cmd_date = RsdCommand("begin rsu_rtlpercent.setOperationDate( ? ); end;");
    cmd_date.AddParam("OperationDate", RSDBP_IN );
    cmd_date.Value("OperationDate") = EndDate;

    cmd_date.execute;
    [Дата операции ##########](EndDate);

  end; // Predetermine

//---------------------------
  macro setObjectType
    var cmd_ot;

    cmd_ot = RsdCommand("begin rsu_rtlpercent.setObjectType( ? ); end;");
    
    cmd_ot.AddParam("ObjectType", RSDBP_IN );
    cmd_ot.Value("ObjectType") = ObjectType;

    cmd_ot.execute;
    [Условия расчета ####](ObjectType);
  end; // setObjectType

//---------------------------
  macro setRate( rate )
    var cmd;

    cmd = RsdCommand("begin rsu_rtlpercent.set_eoy_rate( ? ); end;");
    cmd.addParam("rate", RSDBP_IN ); cmd.value("rate") = rate;

    cmd.execute;
  end;

//---------------------------
// Определяем процентную ставку 
  macro DefineRate

    var cmdGetRate,cmdGetRate1;
    var rsGetRate;
    var RateGroup;                        
//  Группа ставок для условия расчета
    cmdGetRate = RsdCommand(
      " select * from ( " +
      "  select t_rategroup rategroup" +
      "  from dpc_alg_dbt " +
      "  where t_flagcur = ? " +
      "    and t_referenc = ? " +
      "    and t_objecttype = 1003 " +
      "    and t_begdate <= ? " +
      "  order by t_begdate DESC " +
      " ) where rownum = 1 ");

    cmdGetRate.addParam( "FlagCur",        RSDBP_IN );
    cmdGetRate.value(    "FlagCur" )        = FlagCur;
    cmdGetRate.addParam( "TypeAccountExe", RSDBP_IN );
    cmdGetRate.value(    "TypeAccountExe" ) = TypeAccountExe;
    cmdGetRate.addParam( "DateBegPer",     RSDBP_IN );
    cmdGetRate.value(    "DateBegPer" )     = EndDate + 1;

    cmdGetRate.execute;

    rsGetRate = RsdRecordset( cmdGetRate );

    if ( rsGetRate.moveNext )
      RateGroup = rsGetRate.value( "rategroup" );
    else 
      RunError(ErrMsg(3649));
    end;
//  Процентная ставка для группы ставок
    cmdGetRate1 = RsdCommand("begin ? := rsu_rtlpercent.getratefordeptype(?, ?, ?, 0, 0, ? ); end;"); 

    cmdGetRate1.addParam( "RetVal",     RSDBP_RETVAL, V_INTEGER );
    cmdGetRate1.addParam( "RateGroup",  RSDBP_IN );
    cmdGetRate1.value(    "RateGroup" )  = RateGroup;
    cmdGetRate1.addParam( "FlagCur",    RSDBP_IN );
    cmdGetRate1.value(    "FlagCur" )    = FlagCur;
    cmdGetRate1.addParam( "DateBegPer", RSDBP_IN );
    cmdGetRate1.value(    "DateBegPer" ) = EndDate + 1;
    cmdGetRate1.addParam( "Rate",       RSDBP_OUT, V_DOUBLE );
   
    cmdGetRate1.execute;
  
    if ( cmdGetRate1.value("RetVal") != 1 )
      RunError(ErrMsg(3649));
    end;
    Rate = cmdGetRate1.value( "Rate" );
    setRate(Rate);

  end; // DefineRate

//---------------------------
  private macro GetPcTaxBlobSize
    var cmd, rs;

    cmd = RsdCommand( "select sum(t_size) from fmt_fields "
                      "where t_fmtid = ( "
                      "  select t_id from fmt_names "
                      "  where t_name = ? "
                      ") ");
                      
    cmd.addParam("name", RSDBP_IN, "dpc_tax_2");
    cmd.execute();

    rs = RsdRecordset(cmd);
    if (not rs.MoveNext())
      RunError("Ошибка при чтении параметров структуры dpc_tax_2");
    else    
      PcTaxBlobSize = Int(rs.value(0));
    end;
  end;
  
  // необходимость расчета налога
  private macro CheckTaxCalc(check_for_std_percents)
    var cmd, rs;

    if (check_for_std_percents == null)
      check_for_std_percents = false;
    end;

    cmd = RsdCommand( "select t_NeedCalcTaxForCard from dsb_dtyp_dbt "
                      "where t_FlagCur = rsu_rtlglobals.GetFlagCur "
                      "  and t_Kind = ? ");
    
    cmd.addParam("kind", RSDBP_IN, TypeAccount);
    cmd.execute();

    rs = RsdRecordset(cmd);
    if (not rs.MoveNext())
      RunError("Ошибка при чтении параметров вида вклада " + TypeAccount);
    else    
      if (rs.value(0) != "")
        NeedTaxCalc = true;
      else
        NeedTaxCalc = false;
      end;
    end;

    // если причисление %% осуществляется стандартной процедурой, то налог считать не надо
    if (NeedTaxCalc and check_for_std_percents)
      cmd = RsdCommand( "select t_mac_name from dwrk_grpr_dbt "
                        "where t_flagcur = rsu_rtlglobals.GetFlagCur "
                        "  and t_kind = ? "
                        "  and t_grprid = ? ");
      
      cmd.addParam("kind", RSDBP_IN, TypeAccount);
      cmd.addParam("grprid", RSDBP_IN, Proc_PutPerc);
      cmd.execute();

      rs = RsdRecordset(cmd);
      if (not rs.MoveNext())
        NeedTaxCalc = false;
      end;
    end;

    if (NeedTaxCalc)
      GetPcTaxBlobSize();
    end;
  end; // CheckTaxCalc

//---------------------------
// Почистим таблицу
  macro ClearTempTable
    RsdCommand("truncate table deoytemp_tmp").execute;
    RsdCommand("truncate table dsinglecardacc_tmp").execute;
    RsdCommand("truncate table ddmlloans_tmp").execute;
  end;


//---------------------------
// 
  macro CalcPayEstim( RecalcDate )

    initGroupStorage();

    var stat;
    var cmd;
    var mode = 0;

    if ( isGZMode )
      mode = 4; // MODE_GZ
    end;

    cmd = RsdCommand( "begin ? := rsu_rtldeposit.CalcPayEstimForRSL( ?, ?, 88, 0, 1, ? ); end;" );

    cmd.AddParam( "RetVal", RSDBP_RETVAL, V_INTEGER );
    cmd.addParam( "TypeAccount", RSDBP_IN );
    cmd.addParam( "OperationDate", RSDBP_IN );
    cmd.addParam( "Mode", RSDBP_IN );

    cmd.value( "TypeAccount" ) = TypeAccount;
    cmd.value( "OperationDate" ) = {curdate}; //RecalcDate;
    cmd.value( "Mode" ) = mode;

    cmd.execute;

    stat = cmd.value( "RetVal" ); 
    if ( stat != 0 )   
      RunError("Не удалось причислить накопленные проценты. Код ошибки " + stat );
    end;


  end;


  macro CalcPayEstimOnlyForEoy( RecalcDate )
    var stat;
    var cmd, cmd_eoy;
    var mode = 0;

    if ( isGZMode )
      mode = 4; // MODE_GZ
    end;

    initGroupStorage();

    // Причислим накопленные только для списка документов подлежащих обработке
    cmd = RsdCommand( "begin ? := rsu_rtldeposit.CalcEstimPcFromEoy( ? ); end;" );

    cmd.AddParam( "RetVal", RSDBP_RETVAL, V_INTEGER );
    cmd.addParam( "Mode", RSDBP_IN );

    cmd.value( "Mode" ) = mode;

    cmd.execute;

    stat = cmd.value( "RetVal" ); 
    if ( stat != 0 )   
      if (stat == 21077)
        getPMDErrorFromPackage;
      end;
      RunError("Не удалось причислить накопленные проценты. Код ошибки " + stat );
    end;

    // Заполним временную таблицу необходимыми данными
    cmd_eoy = RsdCommand(
       "update deoytemp_tmp eoy " +
          "set (t_pcestimrest, t_unionpart) = " +
                 "(select pcestimrest, " +
                         "rsb_struct.putmoney ('t_SummaEstim', " +
                                              "t_unionpart, " +
                                              "pcestimrest, " +
                                              "? " +
                                             ") " +
                    "from (select eoy_temp.t_autokey autokey, eoy_temp.t_unionpart, " +
                                 "(select pcestim.t_summapay_rest " +
                                    "from (select   t_referenc, t_summapay_rest " +
                                              "from dpcestim_dbt " +
                                             "where t_action not in (2, 11) " +
                                          "order by t_dateoperat desc) pcestim " +
                                   "where t_referenc = eoy_temp.t_referenc " +
                                     "and rownum = 1) pcestimrest " +
                            "from deoytemp_tmp eoy_temp " +
                           "where not exists ( " +
                                    "select 1 " +
                                      "from dpcestim_dbt " +
                                     "where t_referenc = eoy_temp.t_referenc " +
                                       "and t_dateoperat > eoy_temp.t_nextperioddate " +
                                       "and t_action not in (2, 11))) " +
                   "where autokey = eoy.t_autokey) " );

    cmd_eoy.addParam("BeginOffset", RSDBP_IN ); 
    cmd_eoy.value("BeginOffset") = - BeginOffset;

    cmd_eoy.execute;

    cmd = RsdCommand( "begin ? := rsu_rtlglobals.GetTransactionNum; end;" );
    cmd.AddParam( "RetVal", RSDBP_RETVAL, V_INTEGER );
    cmd.execute; 

    if ( cmd.value( "RetVal" ) > 0 )
      TrnNumber = cmd.value( "RetVal" );
      SetTransactionNumber( TrnNumber );
    else
      println("Не удалось получить TrnNumber, могут возникнуть ошибки дублирования");
    end;

  end; // CalcPayEstimOnlyForEoy


//---------------------------
// Переопределяем TransactionNumber
  macro DefineTransactionNumber( parm, realInsertedRecs )

    var cmd, cmd_TransactionNumber;
    var rs_TransactionNumber;
    var countInsertedRecord:integer;
    var tableName = "";
    var str = "";

    if ( parm == null ) parm = TrnNumber_atInsertTemporaryTable; end;

    if ( ValType( realInsertedRecs ) != V_INTEGER ) 
      realInsertedRecs = 0;
    end;

    if ( parm == TrnNumber_atCreateDocsOverdraft )
      tableName = "ddmlloans_tmp ";
    else
      tableName = "deoytemp_tmp ";
    end;

    str = "select count(*) c from " + tableName + " "; 

    if ( parm == TrnNumber_atUpdateSubAccountPart )
      str = str + "where t_addref is not null ";
    end;

    cmd_TransactionNumber = RsdCommand( str );
    cmd_TransactionNumber.execute;

    rs_TransactionNumber = RsdRecordSet( cmd_TransactionNumber );
    if ( rs_TransactionNumber.moveNext )
      if  ( ( parm == TrnNumber_atInsertTemporaryTable ) or 
            ( parm == TrnNumber_atCreateDocsOverdraft  ) 
          )
        countInsertedRecord = rs_TransactionNumber.value("c"); 

        if ( realInsertedRecs > countInsertedRecord )
          TrnNumber = TrnNumber + realInsertedRecs * 2 + 2;
        else
          TrnNumber = TrnNumber + countInsertedRecord * 2 + 2;
        end;

        SetTransactionNumber( TrnNumber );
        //println(gettransactionnumber);
        [Количество документов вставленных во временную таблицу #############  #####](tableName, rs_TransactionNumber.value("c"):4:0 );   
      elif ( parm == TrnNumber_atUpdateSubAccountPart )
        [Количество документов обновленных для формирования записи на субсчете карты #####](rs_TransactionNumber.value("c"):4:0 );   
      end;
      [TransactionNumber: #] ( TrnNumber:4:0 );
    end;  

    return countInsertedRecord;
  end; // DefineCNum

  macro defineCountRecordInTable( name )
    var RecordCount = 0;
    if ( ( name != NULL ) and ( name != "" ) )
      var str = "select count(*) c from " + name; 
      var cmd = RsdCommand( str );
      cmd.execute;
      var rs = RsdRecordSet( cmd );
      if ( rs.moveNext )
        RecordCount = int(rs.value("c"));
      end;
    end;

  println( "Количество записей в таблице '" + name + "' = " + String( RecordCount ) );
  return RecordCount;

  onError( e )
    return 0;
  end;


//---------------------------
// удалить записи, попавшие в выборку, но не поддерживаемые текущей реализацией
  macro DeleteUnsupportedRecords(checkTax)
    var cmdStr =
        "delete from deoytemp_tmp eoy " +
        "where exists ( " +
        "    select 1 " +
        "    from dobjatcor_dbt oac ";
    
    if (checkTax)
      cmdStr = cmdStr +
        "      , dsb_dtyp_dbt t ";
    end;
    
    // Владелец счёта не должен иметь категории "плательщик НДФЛ"
    cmdStr = cmdStr +
        "    where oac.t_ObjectType = 3 " +
        "      and oac.t_Object = ltrim(to_char(eoy.t_CodClient, '0000000000')) " +
        "      and oac.t_GroupId = 42 ";

    if (checkTax)
      cmdStr = cmdStr +
        "      and t.t_FlagCur = eoy.t_IsCur  " +
        "      and t.t_Kind = eoy.t_Type_Account " +
        "      and t.t_NeedCalcTaxForCard <> chr(0) ";
    end;
    
    cmdStr = cmdStr +
        ")";

    var cmd = RsdCommand(cmdStr);
    cmd.execute();
  end;

//---------------------------
// Удаляем записи, в которых произошла ошибка при расчете процентов
  macro DeleteErrorRecord( cur_mode, errorText )

    var findErrors = false;
    var cmd_errors, cmd_delete;
    var rs_errors;
    var queryStr = 
         "select eoy.t_referenc, eoy.t_fncash, eoy.t_listtransfer, " +
                "eoy.t_depdate_document, " +
                  "nvl(eoy.t_insum, 0) " +
                "- nvl(eoy.t_outsum, 0) " +
                "+ nvl(eoy.t_addinsum, 0) " +
                "- nvl(eoy.t_addoutsum, 0) sumoperation, ";

    var deleteStr = "";
    if ( errorText == null )
      errorText = "";
    end;

    if (( cur_mode == 0 ) or ( cur_mode == null ))
      queryStr = queryStr +
                "case eoy.t_errorcode " +
                  "when 24 " +
                      "then 'овердрафт для первой записи' " +
                  "when 25 " +
                      "then 'овердрафт для не первой записи' " +
                  "when 28 " +
                      "then 'есть данные в налоговой карточке при отключенной настройке у ВВ' " +
                  "when 30 " +
                      "then 'не нашлось карточной части' " +
                  "when 45 " +
                      "then '45: не вставилась запись в depdoc ' " +
                   "else to_char(eoy.t_errorcode) " +
                "end || ': ' || '" + errorText + "'errorcode " +
           "from deoytemp_tmp eoy " +
          "where nvl( eoy.t_errorcode, 0 ) <> 0 ";

      deleteStr = 
         "delete      deoytemp_tmp " +
               "where nvl (t_errorcode, 0) <> 0 ";
    elif ( cur_mode == 1 ) // Loans - удалим все записи, которые пытался обрабатывать лоанс
      queryStr = queryStr +
                "l.t_errorcode || ': ' || l.t_errorcodetext || ': ' || '" + errorText + "' errorcode " +
           "from deoytemp_tmp eoy, ddmlloans_tmp l " +
          "where eoy.t_creditcontractid = l.t_creditcontractid ";

      deleteStr = 
         "delete      deoytemp_tmp eoy " +
               "where eoy.t_creditcontractid in (select l.t_creditcontractid " +
                                                  "from ddmlloans_tmp l) ";
    elif ( cur_mode == 2 ) // Loans - удалим ошибочные записи, которые лоанс не смог обработать
      queryStr = queryStr +
                "l.t_errorcode || ': ' || l.t_errorcodetext || " +
                "case nvl( l.t_loansoperationid, 0) when 0 then '  Не передан код операции' else '' end errorcode "
           "from deoytemp_tmp eoy, ddmlloans_tmp l " +
          "where eoy.t_creditcontractid = l.t_creditcontractid " +
            "and ( (l.t_errorcode > 0 or nvl( l.t_loansoperationid, 0) = 0 ) " +
              "and l.t_errorcode <> 7 ) "; // Расчитана нулевая сумма

      deleteStr = 
         "delete      deoytemp_tmp eoy " +
               "where eoy.t_creditcontractid in (select l.t_creditcontractid " +
                                                  "from ddmlloans_tmp l " +
                                                 "where ( ( l.t_errorcode > 0 " +
                                                    "or nvl( l.t_loansoperationid, 0) = 0 ) " +
                                                        "and l.t_errorcode <> 7 ) ) ";
    elif ( cur_mode == 3 )
      queryStr = queryStr +
                "case eoy.t_errorcode " +
                  "when 23 " +
                      "then 'не прошло проверки на простоту записи' " +
                   "else to_char(eoy.t_errorcode) " +
                "end errorcode "
           "from deoytemp_tmp eoy " +
          "where nvl( eoy.t_errorcode, 0 ) not in ( -1, 0 ) ";

      deleteStr = 
         "delete      deoytemp_tmp " +
               "where nvl (t_errorcode, 0) not in ( -1, 0 ) ";
    end;

    cmd_errors = RsdCommand( queryStr );
    cmd_errors.execute;

    rs_errors = RsdRecordSet( cmd_errors );

    while ( rs_errors.moveNext )
      if ( not findErrors )
        findErrors = true;
        [  ];
        [           Отчет о ошибках при пост обработке временной таблицы            ];
        [  ];
        [  ссылка на счет│№подразд│№транзакции │ дата опер. │ сумма операции  │  причина    ];
        [  ──────────────┼────────┼────────────┼────────────┼─────────────────┼───────────────────────────────];

      end;

      [  ############# │########│############│############│#################│###################################################################### ]
        (rs_errors.value("t_referenc"), rs_errors.value("t_fncash"), 
         rs_errors.value("t_listtransfer"), 
         date(rs_errors.value("t_depdate_document")),
         rs_errors.value("sumoperation"),
         rs_errors.value("errorcode") );
    end;

    if ( findErrors )
      [  ──────────────┴────────┴────────────┴────────────┴─────────────────┴───────────────────────────────];
      [  Указанные записи будут исключены из списка документов к ускоренной обработке ];
      [  Будет произведена попытка провести эти документы штатными средствами  ];
      [  ];

      cmd_delete = RsdCommand( deleteStr );
      cmd_delete.execute;
    end;  

  end; // DeleteErrorRecord

  macro checkInsertInSbdepdoc
    var cmd = RsdCommand(
       "UPDATE deoytemp_tmp eoy " +
          "SET t_errorcode = 45 " +
        "WHERE NOT EXISTS " +
                     "(SELECT 1 " +
                        "FROM dsbdepdoc_dbt depdoc " +
                       "WHERE     depdoc.t_iapplicationkind = eoy.t_iapplicationkind " +
                             "AND depdoc.t_applicationkey = eoy.t_applicationkey " +
                             "AND depdoc.t_listtransfer = eoy.t_listtransfer) "
      ).execute;
      DeleteErrorRecord;
  end; //checkInsertInSbdepdoc

  private macro pause(val)
    if (val == null )
      val = 20000;
    end;
    println("время начала паузы:    ", time);
    sleep(val); 
    println("время окончания паузы: ", time);
  end; // pause
  /***************************************/
  /* Функции обработки вкладных таблиц   */  
  /***************************************/

  private macro ProcessSbDepDoc( parm )
    var cmd_depdoc;
    var cmd_SbCasln;

    if ( parm == null ) parm = FillSbDepDocPerc; end;

    var str = "insert into dsbdepdoc_dbt " +
                          "(t_referenc, t_type_account, t_fncash, t_account, t_date_document, " +
                           "t_iscur, t_code_currency, t_oper, t_viddoc, t_ndoc, t_npack, " +
                           "t_percrest, t_ardate, t_flagstorn, t_flagrezid, t_yessbook, " +
                           "t_yesform, t_iapplicationkind, t_listtransfer, t_codclient, " +
                           "t_notconfirm, t_typecomplexoper, t_codcashier, t_author, " +
                           "t_numsession, t_action, t_objectperc, " +
                           "t_depdate_document, t_brigade, t_flagnoncarry, t_ground, " +
                           "t_ardatepccalc, t_mode, t_source, " +
                           "t_ordercount, t_flags, t_knfcode, t_realfncash, t_issuspended, " +
                           "t_flags2, t_numdaydoc, t_appltype, t_kindop, t_insum, t_outsum, " +
                           "t_rest, t_percoprsum, t_applicationkey, t_typeoper, t_iscontrol, " +
                           "t_unionpart) " +
                 "select t_referenc, t_type_account, t_fncash, t_account, t_date_document, " +
                        "t_iscur, t_code_currency, t_oper, 0, t_ndoc, t_npack, t_percrest, " +
                        "rsu_rtlglobals.getnulldate, chr(0), t_flagrezid, 'X', chr(0), " +
                        "t_iapplicationkind, t_listtransfer, t_codclient, chr(0), " +
                        "t_typecomplexoper, 0, chr(0), 0, 0, t_objectperc, " +
                        "t_depdate_document, t_brigade, chr(0), t_ground, " +
                        "rsu_rtlglobals.getnulldate, t_mode, 0, 0, t_flags, 0, " +
                        "t_realfncash, chr(0), ";


    if  ( ( parm == FillSbDepDocPerc ) or ( parm == FillSbDepDocPayment ) )
      str = str + "16, t_numdaydoc, t_appltype, t_kindop, " +
                  "t_insum, t_outsum, t_rest, " +
                  "t_percoprsum, t_applicationkey, t_typeoper, 'X', t_unionpart ";
    elif ( parm == FillSbDepDocTran )
      str = str + "17, t_numdaydoc, t_appltype, t_kindop, " +
                  "t_insum, t_outsum, t_rest - nvl(t_addinsum, 0) + nvl(t_addoutsum, 0), " +
                  "t_percoprsum, t_applicationkey, t_typeoper, 'X', t_unionpart ";
    elif ( parm == FillSbDepDocAdd  ) 
      str = str + "17, t_numdaydoc + 10, t_addsuboper, t_kindop, " +
                  "t_addinsum, t_addoutsum, t_rest, " +
                  "case when ( t_insum = 0 and t_outsum = 0 ) then t_percoprsum else 0 end, " +
		  "case when ( t_insum = 0 and t_outsum = 0 ) then t_applicationkey else t_addapplicationkey end, " +
		  "t_addtypeoper, " +
		  "case when ( t_insum = 0 and t_outsum = 0 ) then 'X' else chr(0) end, " +
            		  "t_unionpart ";
    elif ( parm == FillSbDepDocTax  )
      str = str + "16, t_numdaydoc + 10, 14, case when t_TaxSumPay > 0 then 3 else 5 end, " +
                  "case when t_TaxSumPay < 0 then -t_TaxSumPay else 0 end, " +
                  "case when t_TaxSumPay > 0 then t_TaxSumPay else 0 end, t_rest - t_TaxSumPay, " +
                  "0, t_TaxApplicationKey, case when t_TaxSumPay > 0 then 62 else 71 end, chr(0), " +
                  "rsb_struct.putMoney(case t_ObjectPerc when 2001 then 't_GlobTax' else 't_AltTax' end, " +
                    "rsb_struct.putDate(case t_ObjectPerc when 2001 then 't_DateEndPeriodCalc2001' else 't_DateEndPeriodCalc2002' end, " +
                      "rsb_struct.putMoney('t_SumTaxRUR', " +
                        "rsb_struct.putMoney('t_SumTaxRUR_Start', " +
                          "rsb_struct.putMoney('t_SumTax_Start', " +
                            "rpad('0', ? * 2, '0'), " +
                          "t_TaxSumPay, -BeginOffset), " +
                        "t_TaxSumPayRUR, -BeginOffset), " +
                      "t_TaxSumPayRUR, -BeginOffset), " +
                    "case when t_TaxSumPay > 0 then t_DepDate_Document else t_Date_Document end, -BeginOffset), " +
                  "t_TaxSumPay, -BeginOffset) ";
    end; 

    if ( parm != FillSbDepDocTax )
      str = str + "from deoytemp_tmp ";
    else
      str = str + "from (select eoy.*, ? as BeginOffset from deoytemp_tmp eoy) ";
    end;

    if   ( parm == FillSbDepDocPerc )
    elif ( parm == FillSbDepDocTran )
      str = str + "where nvl(t_insum, 0) <> 0 or nvl(t_outsum, 0) <> 0 ";
    elif ( parm == FillSbDepDocAdd  ) 
      str = str + "where nvl(t_addinsum, 0) <> 0 or nvl(t_addoutsum, 0) <> 0 ";
    elif ( parm == FillSbDepDocTax  )
      str = str + "where t_TaxSumPay <> 0 and t_uniquereferenc is not null ";
    end; 

    cmd_depdoc = RsdCommand( str );

    if ( parm == FillSbDepDocTax  )
      ReadFmtStruct("dsbdepdoc_8");
      cmd_depdoc.addParam("FieldLenght", RSDBP_IN );
      cmd_depdoc.value("FieldLenght") = FieldLenght;
      cmd_depdoc.addParam("BeginOffset", RSDBP_IN ); 
      cmd_depdoc.value("BeginOffset") = BeginOffset;
    end;

    cmd_depdoc.execute;
    PrintTime("dsbdepdoc_dbt");
    ReadFmtStruct("dsbdepdoc_2");


    if   ( ( parm == FillSbDepDocPerc ) or ( parm == FillSbDepDocPayment ) )
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc, " +
                      "eoy.t_iapplicationkind, eoy.t_applicationkey, 0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy ";
    elif ( parm == FillSbDepDocTran )
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc, " +
                      "eoy.t_iapplicationkind, eoy.t_applicationkey, 0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy "
                "where nvl(t_insum, 0) <> 0 or nvl(t_outsum, 0) <> 0 ";
    elif ( parm == FillSbDepDocAdd  ) 
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc + 10, " +
                      "eoy.t_iapplicationkind, " +
                      "case when ( t_insum = 0 and t_outsum = 0 ) then t_applicationkey else t_addapplicationkey end, " 
                      "0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy " +
                "where nvl(t_addinsum, 0) <> 0 or nvl(t_addoutsum, 0) <> 0 ";
    elif ( parm == FillSbDepDocTax  )
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iapplicationkind, eoy.t_applicationkey, 40, " +
                      "eoy.t_iapplicationkind, eoy.t_TaxApplicationKey, 0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy " +
                "where t_TaxSumPay <> 0 ";
    end; 

    cmd_SbCasln = RsdCommand( str );
    cmd_SbCasln.execute;
    PrintTime("dsb_cashln_dbt");

    if ( ( parm == FillSbDepDocPerc    ) or 
         ( parm == FillSbDepDocTran    ) or 
         ( parm == FillSbDepDocPayment ) 
       )
      RsdCommand( 
       "insert into dsb_casln_dbt " +
                   "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, t_applicationkind2, " +
                    "t_applicationkey2, t_refvalue2, t_fncash, t_numsession) " +
       "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.numdaydoc + 10, 50, " +
              "l.t_loansoperationid, 0, eoy.fncash, 0 " +
         "from (select distinct t_iheadapplicationkind, t_headapplicationkey, t_creditcontractid, " +
                               "max (t_fncash) fncash, max (t_numdaydoc) numdaydoc " +
                          "from deoytemp_tmp " +
                         "where t_typeoper in (92, 93) " +
                      "group by t_iheadapplicationkind, t_headapplicationkey, t_creditcontractid) eoy, " +
              "ddmlloans_tmp l " +
        "where l.t_creditcontractid = eoy.t_creditcontractid " +
          "and l.t_errorcode = 0 " ).execute;
    end;

  end; // ProcessSbDepDoc

//---------------------------
  private macro ProcessDepositr
    // Только для процедур, где во временной таблице по одной записи к счету( для процентов и завершения квартала ).
    var cmd_depositr;

    cmd_depositr = RsdCommand(
       "merge into ddepositr_dbt depos " +
          "using (select t_uniquereferenc, t_insum, t_outsum, " +
                        "t_rest, nvl (t_taxsumpay, 0) taxsumpay, rsu_rtlglobals.getcurdate " +
                   "from deoytemp_tmp ) eoy " +
          "on (depos.t_referenc = eoy.t_uniquereferenc) " +
          "when matched then " +
             "update " +
                "set depos.t_sum_in = eoy.t_insum,  " +
                    "depos.t_sum_out = eoy.t_outsum, " +
                    "depos.t_sum_rest = eoy.t_rest - eoy.taxsumpay, " +
                    "depos.t_final_date = rsu_rtlglobals.getcurdate " );

    cmd_depositr.execute;
    PrintTime("ddepositr_dbt");

  end; // ProcessDepositr


  // Обновление депозитора с учетом того, что может быть несколько записей дял счета
  private macro ProcessDepositrForSeveralDocs
    var cmd_depositr;

    cmd_depositr = RsdCommand(
       "merge into ddepositr_dbt depos " +
          "using (select eoy_sum.t_referenc, eoy_sum.insum eoy_sumin, " +
                        "eoy_sum.outsum eoy_sumout, eoy_sum.ddd eoy_finaldate, " +
                        "(select t_rest " +
                           "from (select   t_referenc, t_rest " +
                                     "from deoytemp_tmp " +
                                 "order by t_depdate_document desc, t_numdaydoc desc) " +
                          "where t_referenc = eoy_date.t_referenc and rownum = 1) - t_taxsumpay s " + // Если был налог, то вычтем его из общей суммы, потому как более он нигде не вычтется. Наверное.
                   "from (select   t_referenc, max (t_depdate_document) ddd " +
                             "from deoytemp_tmp " +
                         "group by t_referenc) eoy_date, " +
                        "(select   t_referenc, t_depdate_document ddd, " +
                                  "sum (nvl(t_insum, 0)) + sum (nvl(t_addinsum,0)) insum, " +
                                  "sum (nvl(t_outsum,0)) + sum (nvl(t_addoutsum,0)) outsum, " +
                                  "sum(nvl(t_taxsumpay,0)) t_taxsumpay " +
                             "from deoytemp_tmp " +
                         "group by t_referenc, t_depdate_document) eoy_sum " +
                  "where eoy_date.t_referenc = eoy_sum.t_referenc " +
                    "and eoy_date.ddd = eoy_sum.ddd) eoy " +
          "on (eoy.t_referenc = depos.t_referenc) " +
          "when matched then " +
             "update " +
                "set t_sum_in = eoy.eoy_sumin, " +
                    "t_sum_out = eoy.eoy_sumout, " +
                    "t_final_date = eoy.eoy_finaldate, " + 
                    "t_sum_rest = eoy.s " );

    cmd_depositr.execute;
    PrintTime("ddepositr_dbt");

  end; // ProcessDepositrForSeveralDocs
//---------------------------
  private macro ProcessPcCalc
    var cmd_PcCalcUpdate, cmd_PcCalcInsert;

    // Обновим запись за текущий период
    cmd_PcCalcUpdate = RsdCommand( 
       "update (select calc.t_sumpay sumpay, calc.t_sumforpay sumforpay, " +
                      "calc.t_sumpayall sumpayall, calc.t_numsession numsession " +
                 "from deoytemp_tmp eoy, dpc__calc_dbt calc " +
                "where calc.t_referenc = eoy.t_uniquereferenc " +
                  "and calc.t_objecttype in (eoy.t_objectperc, 2003) " +
                  "and calc.t_typerecord = 1 " +
                  "and calc.t_enddate = eoy.t_depdate_document) " +
          "set sumpay = sumpay + sumforpay, " +
              "sumforpay = 0, " +
              "sumpayall = sumpayall + sumforpay, " +
              "numsession = 0 " );

    cmd_PcCalcUpdate.execute;
    PrintTime("dpc__calc_dbt обновление");

    // Вставим запись на следующий период
    cmd_PcCalcInsert = RsdCommand(
       "insert into dpc__calc_dbt " +
                   "(t_referenc, t_objecttype, t_typerecord, t_begindate, t_enddate, " +
                    "t_sumcalc, t_sumcalcnotround, t_sumpay, t_sumforpay, t_sumpayall, " +
                    "t_fncash, t_numsession, t_taxsumcalc, t_taxsumpay, t_action, " +
                    "t_taxsumforpay, t_sumcalcdelta, t_taxsumforpayrur, t_SumForPayNotRound) " +
          "select eoy.t_referenc, eoy.t_objectperc, 1, eoy.t_depdate_document + 1, " +
                 "eoy.t_nextperioddate, eoy.t_percrest, eoy.t_percrestnotround, 0, " +
                 "eoy.t_percrest, calc.t_sumpayall, calc.t_fncash, 0, 0, 0, 0, calc.t_taxsumforpay, 0, " +
                 "calc.t_taxsumforpayrur, eoy.t_percrest " +
            "from deoytemp_tmp eoy, dpc__calc_dbt calc " +
           "where calc.t_referenc = eoy.t_uniquereferenc " +
             "and calc.t_objecttype = eoy.t_objectperc " +
             "and calc.t_typerecord = 1 " +
             "and calc.t_enddate = eoy.t_depdate_document " /*+
          "union " +
          "select eoy.t_referenc, 2003, 1, eoy.t_depdate_document + 1, " +
                 "eoy.t_nextperioddate, 0, 0, 0, 0, 0, calc.t_fncash, 0, 0, 0, 0, 0, " +
                 "0, 0, chr (1) " +
            "from deoytemp_tmp eoy, dpc__calc_dbt calc " +
           "where calc.t_referenc = eoy.t_uniquereferenc " +
             "and calc.t_objecttype = 2003 " +
             "and calc.t_typerecord = 1 " +
             "and calc.t_enddate = eoy.t_depdate_document " */ );

    cmd_PcCalcInsert.execute;
    PrintTime("dpc__calc_dbt вставка");

  end; // ProcessPcCalc

  private macro UpdatePcCalcForSeveralDocs(parm)
    var cmd_PcCalcUpdate;
    var NameFieldDate = "t_date_document";
    if ( parm == null ) 
      parm = Usually;
    end;
    if ( parm == OnlyForLoans )
      NameFieldDate = "t_nextperioddate";
    end;
    var str = 
       "merge into dpc__calc_dbt maincalc " +
          "using (select eoy_select.t_referenc, eoy_select.t_objectperc, " +
                        "eoy_select.t_depdate_document, eoy_select.t_percrest, " +
                        "eoy_select.t_percrestnotround, eoy_group.percoprsum " +
                   "from deoytemp_tmp eoy_select, " +
                        "(select   t_referenc, max ( " + NameFieldDate + " ) date_document, " +
                                  "max (t_numdaydoc) numdaydoc, " +
                                  "sum (t_percoprsum) percoprsum " +
                             "from deoytemp_tmp ";
    if ( parm == OnlyForLoans )
      str = str +
                            "where t_typeoper = 92 ";
    end;
      str = str +

                         "group by t_referenc) eoy_group " +
                  "where eoy_select.t_referenc = eoy_group.t_referenc " +
                    "and eoy_select." + NameFieldDate  + " = eoy_group.date_document " +
                    "and eoy_select.t_numdaydoc = eoy_group.numdaydoc) eoy " +
          "on (    maincalc.t_referenc = eoy.t_referenc " +
              "and maincalc.t_objecttype = eoy.t_objectperc " +
              "and maincalc.t_typerecord = 1 " +
              "and maincalc.t_enddate >= eoy.t_depdate_document) " +
          "when matched then " +
             "update " +
                "set t_sumcalc = eoy.t_percrest, " +
                    "t_sumcalcnotround = eoy.t_percrestnotround, " +
                    "t_sumforpay = maincalc.t_sumforpay + eoy.percoprsum, " +
                    "t_numsession = 0 ";

    cmd_PcCalcUpdate = RsdCommand( str );
    cmd_PcCalcUpdate.execute;
    PrintTime("dpc__calc_dbt обновление");

  end; // ProcessPcCalcForSeveralDocs

  private macro UpdatePcCalcForTax(parm)
    var str;
    
    if (parm == FillPcTaxPay)
      str = 
        "update (select calc.t_TaxSumPay TaxSumPay, calc.t_TaxSumForPay TaxSumForPay, " +
                       "calc.t_TaxSumForPayRUR TaxSumForPayRUR, " +
                       "eoy.t_TaxSumPay addSum, " +
                       "eoy.t_TaxSumPayRUR addSumRUR " +
                  "from deoytemp_tmp eoy, dpc__calc_dbt calc " +
                 "where calc.t_Referenc = eoy.t_UniqueReferenc " +
                   "and calc.t_objecttype = eoy.t_ObjectPerc " +
                   "and calc.t_typerecord = rsu_rtlpercent.get_rtpc_pf_calc_done " +
                   "and calc.t_enddate = eoy.t_depdate_document " +
                   "and eoy.t_TaxSumPay <> 0)  " +
           "set TaxSumPay = TaxSumPay + addSum, " +
               "TaxSumForPay = TaxSumForPay - addSum, " +
               "TaxSumForPayRUR = TaxSumForPayRUR - addSumRUR ";
    elif (parm == FillPcTaxCalc)
      str = 
        "update (select calc.t_TaxSumCalc TaxSumCalc, calc.t_TaxSumForPay TaxSumForPay, " +
                       "calc.t_TaxSumForPayRUR TaxSumForPayRUR, " +
                       "eoy.t_TaxSumNextPeriod TaxSumNextPeriod, " +
                       "eoy.t_TaxSumPay TaxSumPay, " +
                       "eoy.t_TaxSumCalcRUR - eoy.t_TaxSumPayRUR addSumRUR " +
                  "from deoytemp_tmp eoy, dpc__calc_dbt calc " +
                 "where calc.t_Referenc = eoy.t_UniqueReferenc " +
                   "and calc.t_objecttype = eoy.t_ObjectPerc " +
                   "and calc.t_typerecord = rsu_rtlpercent.get_rtpc_pf_calc_done " +
                   "and calc.t_enddate = eoy.t_NextPeriodDate " +
                   "and eoy.t_TaxSumNextPeriod <> 0)  " +
           "set TaxSumCalc = TaxSumNextPeriod, " +
               "TaxSumForPay = TaxSumForPay + TaxSumNextPeriod - TaxSumPay, " +
               "TaxSumForPayRUR = TaxSumForPayRUR + addSumRUR ";
    elif (parm == FillPcTaxCalcForOperation)
      str = 
        "update (select calc.t_TaxSumCalc TaxSumCalc, calc.t_TaxSumForPay TaxSumForPay, " +
                       "calc.t_TaxSumForPayRUR TaxSumForPayRUR, " +
                       "eoy.t_TaxSumNextPeriod TaxSumNextPeriod, " +
                       "eoy.t_TaxSumCalcRUR TaxSumCalcRUR " +
                  "from deoytemp_tmp eoy, dpc__calc_dbt calc " +
                 "where calc.t_Referenc = eoy.t_UniqueReferenc " +
                   "and calc.t_objecttype = eoy.t_ObjectPerc " +
                   "and calc.t_typerecord = rsu_rtlpercent.get_rtpc_pf_calc_done " +
                   "and calc.t_enddate = eoy.t_NextPeriodDate " +
                   "and eoy.t_TaxSumNextPeriod <> 0)  " +
           "set TaxSumCalc = TaxSumCalc + TaxSumNextPeriod, " +
               "TaxSumForPay = TaxSumForPay + TaxSumNextPeriod, " +
               "TaxSumForPayRUR = TaxSumForPayRUR + TaxSumCalcRUR ";
    elif (parm == FillPcTaxCalcForSeveralOperation)
      str = 
        "merge into dpc__calc_dbt calc " +
           "using (select   t_referenc referenc, t_objectperc objectperc, " +
                           "t_nextperioddate nextperioddate, " +
                           "sum (nvl (t_taxsumnextperiod, 0)) taxsumnextperiod, " +
                           "sum (nvl (t_taxsumcalcrur, 0)) taxsumcalcrur " +
                      "from deoytemp_tmp " +
                     "where t_taxsumnextperiod <> 0 " +
                       "and t_taxsumnextperiod is not null " +
                       "and t_taxsumcalcrur is not null " +
                  "group by t_referenc, t_objectperc, t_nextperioddate) eoy " +
           "on (    calc.t_referenc = eoy.referenc " +
               "and calc.t_objecttype = eoy.objectperc " +
               "and calc.t_typerecord = 1 " +
               "and calc.t_enddate = eoy.nextperioddate) " +
           "when matched then " +
              "update " +
                 "set calc.t_taxsumcalc = calc.t_taxsumcalc + eoy.taxsumnextperiod, " +
                     "calc.t_taxsumforpay = calc.t_taxsumforpay + eoy.taxsumnextperiod, " +
                     "calc.t_taxsumforpayrur = calc.t_taxsumforpayrur + eoy.taxsumcalcrur ";
    end;
       
    var cmd = RsdCommand(str);
    cmd.execute();
    PrintTime("dpc__calc_dbt обновление");
  end; // UpdatePcCalcForTax

//---------------------------
  private macro ProcessPcDRest
    var cmd_PcDRest;

    // Обновляем если есть и вставляем новые записи если их нет в dpc_drest_dbt
    cmd_PcDRest = RsdCommand(
       "merge into dpc_drest_dbt pc_drest " +
          "using (select t_uniquereferenc, t_objectperc, t_rest - nvl(t_TaxSumPay, 0) as Rest, t_fncash, " +
                        "t_depdate_document " +
                   "from deoytemp_tmp) eoy " +
          "on (    pc_drest.t_referenc = eoy.t_uniquereferenc  " +
              "and pc_drest.t_type_object = eoy.t_objectperc " +
              "and pc_drest.t_date_rest = eoy.t_depdate_document) " +
          "when matched then " +
             "update " +
                "set pc_drest.t_rest = eoy.Rest " +
          "when not matched then " +
             "insert(pc_drest.t_referenc, pc_drest.t_date_rest, " +
                    "pc_drest.t_type_object, pc_drest.t_rest, pc_drest.t_fncash, " +
                    "pc_drest.t_numsession, pc_drest.t_action, pc_drest.t_reservrest) " +
             "values(eoy.t_uniquereferenc, eoy.t_depdate_document, eoy.t_objectperc, " +
                    "eoy.Rest, eoy.t_fncash, 0, 0, chr(1)) " );

    cmd_PcDRest.execute;
    PrintTime("dpc_drest_dbt");

  end; // ProcessPcDRest


  private macro ProcessPcDRestForSeveralDocs
    var cmd_PcDRest;

    cmd_PcDRest = RsdCommand(
       "merge into dpc_drest_dbt pc_drest " +
          "using (select eoy_last.t_referenc, eoy_last.t_depdate_document, " +
                        "eoy_last.t_objectperc, eoy_con.t_fncash, eoy_con.t_rest - nvl(eoy_con.t_taxsumpay,0) t_rest, " + // Если просто проценты - то вычтем налог, если все остальное, то налог нулевой, а все остальное уже персчиталось
                "eoy_con.t_numdaydoc " +
                   "from (select   t_referenc, t_depdate_document, t_objectperc, " +
                                  "max(t_numdaydoc) numdaydoc " +
                             "from deoytemp_tmp  " +
                         "group by t_referenc, t_depdate_document, t_objectperc) eoy_last, " +
                        "deoytemp_tmp eoy_con " +
                  "where eoy_con.t_referenc = eoy_last.t_referenc " +
                    "and eoy_con.t_depdate_document = eoy_last.t_depdate_document " +
                    "and eoy_con.t_numdaydoc = eoy_last.numdaydoc) eoy " +
          "on (    pc_drest.t_referenc = eoy.t_referenc " +
              "and pc_drest.t_type_object = eoy.t_objectperc " +
              "and pc_drest.t_date_rest = eoy.t_depdate_document) " +
          "when matched then " +
             "update " +
                "set pc_drest.t_rest = eoy.t_rest " +
          "when not matched then " +
             "insert(pc_drest.t_referenc, pc_drest.t_date_rest, " +
                    "pc_drest.t_type_object, pc_drest.t_rest, pc_drest.t_fncash, " +
                    "pc_drest.t_numsession, pc_drest.t_action, pc_drest.t_reservrest) " +
             "values(eoy.t_referenc, eoy.t_depdate_document, eoy.t_objectperc, " +
                    "eoy.t_rest, eoy.t_fncash, 0, 0, chr(1)) " );

    cmd_PcDRest.execute;
    PrintTime("dpc_drest_dbt");

  end; // ProcessPcDRestForSeveralDocs

//---------------------------

  private macro ProcessRetOp( parm )
    var cmd_RetOp;
    var gpIslink, gpAppKind, gpAppKey, gpNDoc:integer;
    var cntRetOp:integer = 0;
    var str, str_from;
    var rs, cmd_cRetOp, cmd_linkRetOp;
    var flags = 0;
    if ( getEoyProcRunning )
      flags = 512;
    end;

    if ( isGZMode )
      SetBitFlag( flags, 1, 1 ); // ROF_MODE_GZ
    end;

    // Поле t_fioclient не заполняем специально, так как операции проводимые DML-ю 
    // в фин мониторинг попасть не должны, а тратить время на лишнее соединение с 
    // немаленьким dpersn_dbt в оптимизированной процедуре не стоит.

    str = 
       "insert into dret_op_dbt " +
                   "(t_branch, t_iscur, t_applicationkind, t_applicationkey, t_date, " +
                    "t_operation, t_subop, t_objectref, t_state, t_sessionnum, " +
                    "t_numunconfcashdocs, t_cashier, t_brigade, t_tokenid, t_oper, " +
                    "t_onlineotherbranch, t_codcur, t_bankproduct, t_flags, t_control, " +
                    "t_notincludeinopert, t_codclient, t_fioclient, " +
                    "t_fmOpid_Online, t_extra) " +
          "select eoy.t_realfncash, eoy.t_iscur, eoy.t_iapplicationkind, " +
                 "eoy.t_applicationkey, eoy.t_date_document, eoy.t_typeoper, " +
                 "eoy.t_appltype, eoy.t_type_account, rsu_rtlcommon.get_ost_confirmed, 0, 0, " +
                 "eoy.t_oper, eoy.t_brigade, 0, eoy.t_oper, chr(0), " +
                 "eoy.t_code_currency, rsu_rtlcommon.get_retprod_depositr, eoy.t_flags + ? , " +
                 "eoy.t_oper, chr(0), eoy.t_codclient, chr(1), 0," +
                 "rpad('0', " +
                        "(select t_size " +
                           "from fmt_fields " +
                          "where t_fmtid = (select t_id " +
                                             "from fmt_names " +
                                            "where t_name = 'dret_op_dbt') " +
                            "and lower(t_name) = 't_extra') * 2, '0' ) ";

    if ( parm == FillRetOpTran )
      str_from = 
            "from (select   t_referenc, t_iheadapplicationkind, t_headapplicationkey, sum (t_errorcode) " +
                      "from deoytemp_tmp " +
                  "group by t_referenc, t_iheadapplicationkind, t_headapplicationkey) head_eoy, " +
                 "deoytemp_tmp eoy " +
           "where head_eoy.t_iheadapplicationkind = eoy.t_iapplicationkind " +
             "and head_eoy.t_headapplicationkey = eoy.t_applicationkey ";
    else
      str_from = 
            "from deoytemp_tmp eoy ";
    end;
    str = str + str_from;  

    cmd_RetOp = RsdCommand( str );
    cmd_RetOp.addParam("flags", RSDBP_IN ); cmd_RetOp.value("flags") = flags;
    cmd_RetOp.execute;

    /* Привязка операций к выполняемой групповой процедуре */
    GetGroupProc(gpIslink, gpNDoc, gpAppKind, gpAppKey);

    if ( gpIslink )

      cmd_cRetOp = RsdCommand( "select count(*) from deoytemp_tmp" );
      cmd_cRetOp.execute;
      rs = RsdRecordset(cmd_cRetOp);
      if( rs.moveNext )
        cntRetOp = rs.value(0);
      end;

      if ( cntRetOp > 0 )

        str = 
           "insert into dsb_casln_dbt " +
                       "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                        "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                        "t_numsession) " +
                 "select ?, ?, " + 
                     "((select nvl(max(csln.t_numlinkdoc), 0) " +
                         "from dsb_casln_dbt csln " +
                        "where csln.t_applicationkind1=? " +
                          "and csln.t_applicationkey1=?) + rownum), " + 
                     "eoy.t_iapplicationkind, eoy.t_applicationkey, -999, eoy.t_realfncash, 0 ";
        str = str + str_from;
        cmd_linkRetOp = RsdCommand( str );

        cmd_linkRetOp.addParam("ApplKind1", RsdBp_in);  cmd_linkRetOp.value("ApplKind1") = gpAppKind;     
        cmd_linkRetOp.addParam("ApplKey1",  RsdBp_in);  cmd_linkRetOp.value("ApplKey1" ) = gpAppKey;       
        cmd_linkRetOp.addParam("ApplKind",  RsdBp_in);  cmd_linkRetOp.value("ApplKind" ) = gpAppKind;      
        cmd_linkRetOp.addParam("ApplKey",   RsdBp_in);  cmd_linkRetOp.value("ApplKey"  ) = gpAppKey;        
        cmd_linkRetOp.execute;

        // Может быть некорректно, так как в можут существовать еще например 38 операция, которая уже привязалась, 
        // а может и не существовать, так что найдем последний номер "наверняка"
        //gpNDoc = gpNDoc + cntRetOp;
        var cmd_gpNDoc = RsdCommand( 
                             "select nvl (max (csln.t_numlinkdoc), 0) c " +
                               "from dsb_casln_dbt csln " +
                              "where csln.t_applicationkind1 = ? " +
                                "and csln.t_applicationkey1 = ? " );
        cmd_gpNDoc.addParam("ApplKind", RsdBp_in); cmd_gpNDoc.value("ApplKind") = gpAppKind;
        cmd_gpNDoc.addParam("ApplKey",  RsdBp_in); cmd_gpNDoc.value("ApplKey")  = gpAppKey;
        cmd_gpNDoc.execute;

        var rs_gpNDoc = RsdRecordSet( cmd_gpNDoc );
        if ( rs_gpNDoc.moveNext )
          gpNDoc = gpNDoc + rs_gpNDoc.value("c");
        else
          gpNDoc = gpNDoc + cntRetOp;
        end; 

        SetGroupProc_NDoc(gpNDoc);
      end;
    end;

    PrintTime("dret_op_dbt");

    str = "insert into dopobject_dbt " +
                   "(t_branch, t_date, t_opappkind, t_opappkey, t_objecttype, " +
                    "t_objectref, t_sessionnum, t_number, t_iscur ) " +
          "select eoy.t_fncash, eoy.t_date_document, eoy.t_iapplicationkind, " +
                 "eoy.t_applicationkey, 11002, chr(0), " +
                 "0, " +
                 "0, " +
                 "eoy.t_iscur ";
    str = str + str_from;  
    if ( parm == FillRetOpTran )
      str = str + " and eoy.t_NeedInfoForExtSys = 'X' ";
    else
      str = str + " where eoy.t_NeedInfoForExtSys = 'X' ";
    end;
    var cmd_OpObject = RsdCommand(str);
    cmd_OpObject.execute;
    PrintTime("dopobject_dbt");

  end; // ProcessRetOp


//---------------------------
  private macro ProcessOpObject
    var cmd_OpObject;

    cmd_OpObject = RsdCommand( 
       "insert into dopobject_dbt " +
                   "(t_branch, t_date, t_opappkind, t_opappkey, t_objecttype, " +
                    "t_objectref, t_sessionnum, t_number, t_iscur, " +
                    "t_reserved) " +
          "select eoy.t_fncash, eoy.t_date_document, eoy.t_iapplicationkind, " +
                 "eoy.t_applicationkey, rsu_rtlcommon.get_sb_deposit, to_char(eoy.t_referenc), " +
                 "0, " +
                 "(select nvl(max(opobj.t_number), 0) + 1 " +
                    "from dopobject_dbt opobj " +
                   "where opobj.t_iscur = eoy.t_iscur " +
                     "and opobj.t_branch = eoy.t_fncash " +
                     "and opobj.t_objecttype = rsu_rtlpercent.get_rtpc_pf_calc_done " +
                     "and opobj.t_date = eoy.t_date_document " +
                     "and opobj.t_objectref = to_char(eoy.t_referenc)), " +
                 "eoy.t_iscur, chr(1) " +
            "from deoytemp_tmp eoy " );
    cmd_OpObject.execute;
    PrintTime("dopobject_dbt");

  end; // ProcessOpObject

//---------------------------
  private macro ProcessPcEstim
    var cmd_PcEstim;

    cmd_PcEstim = RsdCommand(
       "insert into dpcestim_dbt " +
                   "(t_fncash, t_referenc, t_dateoperat, t_numdaydoc, t_dateendperiod, " +
                    "t_summaprogn, t_datelastcalc, t_summacalc, t_datelastpay, " +
                    "t_summapay_rest, t_summapay_97, t_summapay_in, t_summapay_out, " +
                    "t_typeoper, t_appltype, t_typecomplexoper, t_depdate_document, " +
                    "t_docapplicationkind, t_docapplicationkey, t_numsession, " +
                    "t_action, t_mode) " +
          "select eoy_rest.fncash, eoy_all.referenc, eoy_rest.date_document, " +
                 "eoy_all.ndd, eoy_rest.NextPeriodDate, eoy_rest.percrest, " +
                 "eoy_rest.depdate_document, 0, eoy_rest.depdate_document, " +
                 "case eoy_all.typeoper " +
                    "when rsu_rtldeposit.get_op_putpr " +
                       "then rest " +
                    "else 0 " +
                 "end, 0, 0, case eoy_all.typeoper " +
                    "when rsu_rtldeposit.get_op_putpr " +
                       "then 0 " +
                    "else rest " +
                 "end, eoy_all.typeoper, 0, rsu_rtldeposit.get_op_putpr, " +
                 "eoy_rest.depdate_document, eoy_rest.applkind, eoy_rest.applkey, 0, " +
                 "0, eoy_rest.m " +
            "from (select eoy.t_referenc referenc, " +
                         "(select nvl(max(t_numdaydoc), 0) + 10 " +
                            "from dpcestim_dbt pcestim " +
                           "where pcestim.t_referenc = eoy.t_referenc " +
                             "and pcestim.t_dateoperat = eoy.t_date_document) ndd, " +
                         "rsu_rtldeposit.get_op_putpr TypeOper " +
                    "from deoytemp_tmp eoy " +
                   "where eoy.t_typeoper = 72 "
                  "union all " +
                  "select eoy.t_referenc referenc, " +
                         "(select nvl(max(t_numdaydoc), 0) + 20 " +
                            "from dpcestim_dbt pcestim " +
                           "where pcestim.t_referenc = eoy.t_referenc " +
                             "and pcestim.t_dateoperat = eoy.t_date_document) ndd, " +
                         "rsu_rtldeposit.get_op_getpces TypeOper " +
                    "from deoytemp_tmp eoy " + 
                   "where eoy.t_typeoper = 72 " + 
                 ") eoy_all, " +
                 "(select eoy_r.t_referenc referenc, eoy_r.t_fncash fncash, " +
                         "eoy_r.t_date_document date_document, " +
                         "eoy_r.t_depdate_document depdate_document, " +
                         "eoy_r.t_iapplicationkind applkind, " +
                         "eoy_r.t_applicationkey applkey, eoy_r.t_mode m, " +
                         "eoy_r.t_percrest percrest, eoy_r.t_pcestimrest rest, " +
                         "eoy_r.t_NextPeriodDate NextPeriodDate " +
                    "from deoytemp_tmp eoy_r " + 
                   "where eoy_r.t_typeoper = 72 ) eoy_rest " +
           "where eoy_all.referenc = eoy_rest.referenc " );

    cmd_PcEstim.execute;
    PrintTime("dpcestim_dbt");

  end; // ProcessPcEstim

  private macro ProcessPcEstimForSeveralDocs
    var cmd_PcEstim;

    cmd_PcEstim = RsdCommand(
       "insert into dpcestim_dbt " +
                   "(t_fncash, t_referenc, t_dateoperat, t_numdaydoc, t_dateendperiod, " +
                    "t_summaprogn, t_datelastcalc, t_summacalc, t_datelastpay, " +
                    "t_summapay_rest, t_summapay_97, t_summapay_in, t_summapay_out, " +
                    "t_typeoper, t_appltype, t_typecomplexoper, t_depdate_document, " +
                    "t_docapplicationkind, t_docapplicationkey, t_numsession, " +
                    "t_action, t_mode) " +
          "select eoy.t_fncash, eoy.t_referenc, eoy.t_date_document, " +
                 "eoy.t_pcestimnumdaydoc, est.t_dateendperiod, eoy.t_percrest, " +
                 "eoy.t_depdate_document, eoy.t_pcestimrest, est.t_datelastpay, " +
                 "est.t_summapay_rest, 0, 0, 0, eoy.t_typeoper, eoy.t_appltype, " +
                 "eoy.t_typecomplexoper, eoy.t_depdate_document, " +
                 "eoy.t_iapplicationkind, eoy.t_applicationkey, 0, 0, eoy.t_mode " +
            "from dpcestim_dbt est, " +
                 "(select   est_ndd.t_referenc, est_ndd.t_dateoperat, " +
                           "max(est_ndd.t_numdaydoc) numdaydoc " +
                      "from dpcestim_dbt est_ndd, " +
                           "(select   t_referenc, max(t_dateoperat) dateoperat " +
                                "from dpcestim_dbt " +
                               "where t_referenc in(select t_referenc " +
                                                     "from deoytemp_tmp) " +
                            "group by t_referenc) est_d " +
                     "where est_d.t_referenc = est_ndd.t_referenc " +
                       "and est_d.dateoperat = est_ndd.t_dateoperat " +
                  "group by est_ndd.t_referenc, est_ndd.t_dateoperat) est_key, " +
                 "deoytemp_tmp eoy " +
           "where est.t_referenc = est_key.t_referenc " +
             "and est.t_dateoperat = est_key.t_dateoperat " +
             "and est.t_numdaydoc = est_key.numdaydoc " +
             "and eoy.t_referenc = est_key.t_referenc " +
             "and eoy.t_pcestimrest is not null " +
             "and eoy.t_typeoper not in ( 72 ) " // Для процентов по другому
    );

    cmd_PcEstim.execute;
    PrintTime("dpcestim_dbt");

  end; // ProcessPcEstimForSeveralDocs  


  // #174289
  private macro ProcessPcEstimForSeveralDocs_2
    var cmd_PcEstim;

    cmd_PcEstim = RsdCommand(
       "insert into dpcestim_dbt " +
                   "(t_fncash, t_referenc, t_dateoperat, t_numdaydoc, t_dateendperiod, " +
                    "t_summaprogn, t_datelastcalc, t_summacalc, t_datelastpay, " +
                    "t_summapay_rest, t_summapay_97, t_summapay_in, t_summapay_out, " +
                    "t_typeoper, t_appltype, t_typecomplexoper, t_depdate_document, " +
                    "t_docapplicationkind, t_docapplicationkey, t_numsession, " +
                    "t_action, t_mode) " +
          "select eoy.t_fncash, eoy.t_referenc, eoy.t_date_document, eoy.t_pcestimnumdaydoc, " +
                 "est.t_dateendperiod, eoy.t_percrest, eoy.t_depdate_document, eoy.t_pcestimrest, " +
                 "est.t_datelastpay, est.t_summapay_rest, 0, 0, 0, eoy.t_typeoper, eoy.t_appltype, " +
                 "eoy.t_typecomplexoper, eoy.t_depdate_document, eoy.t_iapplicationkind, eoy.t_applicationkey, " +
                 "0, 0, eoy.t_mode " +
            "from (select eoy_2.*, " +
                         "(select t_numdaydoc " +
                            "from (select   est.t_referenc, est.t_numdaydoc, est.t_dateoperat " +
                                      "from dpcestim_dbt est " +
                                  "order by t_numdaydoc desc) pcestim " +
                           "where t_referenc = eoy_2.t_referenc " +
                             "and t_dateoperat = eoy_2.pcestim_dateoperat " +
                             "and rownum = 1) pcestim_numdaydoc " +
                    "from (select eoy_1.*, " +
                                 "(select t_dateoperat " +
                                    "from (select   est.t_referenc, est.t_dateoperat " +
                                              "from dpcestim_dbt est " +
                                          "order by t_dateoperat desc) pcestim " +
                                   "where t_referenc = eoy_1.t_referenc and rownum = 1) pcestim_dateoperat " +
                            "from deoytemp_tmp eoy_1) eoy_2) eoy, " +
                 "dpcestim_dbt est " +
           "where est.t_referenc = eoy.t_referenc " +
             "and est.t_dateoperat = eoy.pcestim_dateoperat " +
             "and est.t_numdaydoc = eoy.pcestim_numdaydoc " +
             "and eoy.t_pcestimrest is not null " +
             "and eoy.t_typeoper not in (72) " 
    );

    cmd_PcEstim.execute;
    PrintTime("dpcestim_dbt");

  end; // ProcessPcEstimForSeveralDocs_2



//---------------------------
  private macro ProcessEdRef( parm )
    var cmd_EdRef;

    if ( parm == null ) parm = FillEdRefPerc; end;

    var str = "insert into drsbedref_tmp " +
                          "(t_iscur, t_signrec, t_acctype, t_accnumber, t_knfcode, t_errcode, " +
                           "t_code_currency, t_applicationkind, t_resrved, t_autokey, " +
                           "t_operation, t_applicationkey) " +
                 "select t_iscur, rsu_rtlglobals.get_signorder, t_type_account, t_referenc, 0, 0, " +
                        "t_code_currency, t_iapplicationkind, chr(0), 0, ";

    if   (( parm == FillEdRefPerc )  or 
          ( parm == FillEdRefTran )) 
      str = str + "t_typeoper, t_applicationkey ";
    elif ( parm == FillEdRefAdd )
      str = str + "t_addtypeoper, t_addapplicationkey ";
    elif ( parm == FillEdRefTax )
      str = str + "case when t_TaxSumPay > 0 then 62 else 71 end, t_TaxApplicationKey ";
    end;

    str = str + "from deoytemp_tmp ";

    if   ( parm == FillEdRefPerc )  
    elif ( parm == FillEdRefTran )
      str = str + "where nvl(t_insum, 0) <> 0 or nvl(t_outsum, 0) <> 0 ";
    elif ( parm == FillEdRefAdd )
      str = str + "where nvl(t_addinsum, 0) <> 0 or nvl(t_addoutsum, 0) <> 0 ";
    elif ( parm == FillEdRefTax )
      str = str + "where t_TaxSumPay <> 0";
    end;
    
    cmd_EdRef = RsdCommand( str );
    cmd_EdRef.execute;
    PrintTime("drsbedref_dbt");

  end; // ProcessEdRef

//---------------------------
  private macro ProcessPcTax(parm)
    var str;

    ReadFmtStruct("dpc_tax_2");
    
    if (parm == FillPcTaxPay)
      str = 
        "merge into dpc_tax_dbt tax " +
        "using (select * from deoytemp_tmp where t_TaxSumPay <> 0 and t_uniquereferenc is not null) eoy " +
        "on (tax.t_CodeModule = 2 and " +
            "tax.t_ObjectTax = to_char(eoy.t_Referenc) and " +
            "tax.t_ObjectTax_Add = eoy.t_Code_Currency and " +
            "tax.t_DateTaxPay = eoy.t_DepDate_Document and " +
            "(tax.t_ApplicationKind, tax.t_ApplicationKey) = ( " +
              "select tax2.t_ApplicationKind, tax2.t_ApplicationKey from ( " +
                "select * from dpc_tax_dbt " +
                "order by t_CodeModule desc, t_ObjectTax desc, t_ObjectTax_Add desc,  " +
                  "t_DateTaxPay desc, t_ApplicationKind desc, t_ApplicationKey desc " +
              ") tax2 " +
              "where tax2.t_CodeModule = tax.t_CodeModule and " +
                    "tax2.t_ObjectTax = tax.t_ObjectTax and " +
                    "tax2.t_ObjectTax_Add = tax.t_ObjectTax_Add and " +
                    "tax2.t_DateTaxPay = tax.t_DateTaxPay and " +
                    "rownum = 1  " +
            ") " +
        ") " +
        "when matched then update set " +
            "tax.t_SummaTaxPay = eoy.t_TaxSumPay, " +
            "tax.t_NumSession = 0, " +
            "tax.t_SummaTaxPayRUR = eoy.t_TaxSumPayRUR " +
        "when not matched then insert ( " +
            "t_CodeModule, t_IdentClient, t_ObjectTax, t_ObjectTax_Add, " +
            "t_Year_InAll, t_FNCash, t_NumSession, t_ApplicationKind, t_Reserve,  " +
            "t_SummaTaxCalc, t_DateTaxPay, t_SummaTaxPay,  " +
            "t_SummaTaxCalcRUR, t_SummaTaxPayRUR, " +
            "t_ApplicationKey, t_FmtBlobData_XXXX " +
          ") " +
          "values ( " +
            "2, eoy.t_CodClient, eoy.t_Referenc, eoy.t_Code_Currency, " +
            "0, eoy.t_FNCash, 0, eoy.t_iApplicationKind, chr(1), " +
            "0, eoy.t_DepDate_Document, eoy.t_TaxSumPay,  " +
            "0, eoy.t_TaxSumPayRUR, " +
            "eoy.t_TaxApplicationKey,  " +
            "rsb_struct.PutInt('t_ObjectType',  " +
              "rsb_struct.PutDate('t_Date_Document',  " +
                "rpad('0', ? * 2, '0'), " +
              "eoy.t_DepDate_Document),  " +
            "eoy.t_ObjectPerc) " +
          ") ";
    elif (parm == FillPcTaxCalc)
      str = 
        "insert into dpc_tax_dbt (  " +
            "t_CodeModule, t_IdentClient, t_ObjectTax, t_ObjectTax_Add,  " +
            "t_Year_InAll, t_FNCash, t_NumSession, t_ApplicationKind, t_Reserve,   " +
            "t_SummaTaxCalc, t_DateTaxPay, t_SummaTaxPay,   " +
            "t_SummaTaxCalcRUR, t_SummaTaxPayRUR,  " +
            "t_ApplicationKey, t_FmtBlobData_XXXX  " +
        ")  " +
        "select 2, eoy.t_CodClient, eoy.t_Referenc, eoy.t_Code_Currency,  " +
            "0, eoy.t_FNCash, 0, eoy.t_iApplicationKind, chr(1),  " +
            "eoy.t_TaxSumNextPeriod, eoy.t_currentperioddate,  " +
            "0, eoy.t_TaxSumCalcRUR, 0, eoy.t_ApplicationKey,  " +
            "rsb_struct.PutInt('t_ObjectType',   " +
              "rsb_struct.PutDate('t_Date_Document',   " +
                "rsb_struct.PutInt('t_NumDayDoc',   " +
                  "rsb_struct.PutMoney('t_SummaDepositr',   " +
                    "rsb_struct.PutDouble('t_RatePercentDepositr',   " +
                      "rsb_struct.PutMoney('t_SumPercent',   " +
                        "rsb_struct.PutDouble('t_RateReFin',   " +
                          "rsb_struct.PutMoney('t_SumReFin',   " +
                            "rsb_struct.PutDate('t_BeginConstDate',   " +
                              "rsb_struct.PutDate('t_EndConstDate',   " +
                                "rsb_struct.PutInt('t_NumDayConstRate',   " +
                                  "rsb_struct.PutDouble('t_TaxRate',   " +
                                    "rsb_struct.PutInt('t_ProgressRate',   " +
                                      "rsb_struct.PutMoney('t_Income',   " +
                                        "rsb_struct.PutMoney('t_IncomeRUR',   " +
                                          "rpad('0', ? * 2, '0'),  " +
                                        "eoy.t_TaxExchRateCB * (eoy.t_TaxPercSumDep - eoy.t_TaxPercSumReFin)),   " +
                                      "eoy.t_TaxPercSumDep - eoy.t_TaxPercSumReFin),   " +
                                    "0),   " +
                                  "eoy.t_TaxRate),   " +
                                "eoy.t_currentperioddate - eoy.t_TaxBeginDate + 1),   " +
                              "eoy.t_currentperioddate),   " +
                            "eoy.t_TaxBeginDate),   " +
                          "eoy.t_TaxPercSumReFin),   " +
                        "eoy.t_TaxPercRateReFin),   " +
                      "eoy.t_TaxPercSumDep),   " +
                    "eoy.t_TaxPercRateDep),   " +
                  "eoy.t_depositsum),   " +
                "eoy.t_NumDayDoc),   " +
              "eoy.t_DepDate_Document),   " +
            "eoy.t_ObjectPerc) " +
        "from deoytemp_tmp eoy " +
        "where t_TaxSumNextPeriod <> 0 ";

    end;

    var cmd = RsdCommand(str);
    cmd.addParam("bsize", RSDBP_IN, PcTaxBlobSize);
    cmd.execute();
    PrintTime("dpc_tax_dbt");

    ReadFmtStruct("dsbdepdoc_2");
  end; // ProcessPcTax

//---------------------------
  macro FillSubAccountFieldsInTemporaryTable
    var cmd;
    cmd = RsdCommand(
           "insert into dsinglecardacc_tmp " +
                       "(t_acccardlinkref, t_accardfncash, t_acreferenc, t_accardref, t_creditcntid, t_cardid) " +
              "select   max (ln.t_acccardlinkref) acccardlinkref, ln.t_fncash accardfncash, " +
                       "ln.t_cardaccref acreferenc, max (ln.t_cardref) accardref, " +
                       "max (ctr.t_creditcntrid) creditcntid,  max(crd.t_cardref) " +
                  "from dsclink_dbt ln, " +
                       "dsccard_dbt crd, " +
                       "drtcardcontract_dbt ctr, " +
                       "dcardproduct_dbt cp, " +
                       "deoytemp_tmp innereoy " +
                 "where crd.t_fncash = ln.t_fncash " +
                   "and crd.t_cardref = ln.t_cardref " +
                   "and crd.t_cardopenclose = chr (0) " +
                   "and crd.t_currentcntrcard = 'X' " +
                   "and ctr.t_branch = crd.t_fncash " +
                   "and ctr.t_id = crd.t_contractid " +
                   "and ctr.t_maincardcntrid = 0 " +
                   "and cp.t_cardproductid = ctr.t_cardproductid " +
                   "and cp.t_fundsource <> 4 " +
                   "and innereoy.t_referenc = ln.t_cardaccref " +
              "group by ln.t_cardaccref, ln.t_fncash " +
                "having count (*) = 1 " );
    cmd.execute;

    cmd = RsdCommand(
           "update deoytemp_tmp maineoy " +
              "set (t_addref, t_addref2, t_isubapplicationkind, t_subapplicationkey1, t_subapplicationkey2, " +
                   "t_subrest, t_subnumdaydoc, t_errorcode, t_creditcontractid, t_cardid ) = " +
                     "(select cardpart.t_acccardlinkref, 0, rsu_rtlcommon.get_sb_card_subaccdoc appkind, " +
                             "eoy.t_applicationkey, eoy.t_taxapplicationkey, " +
                               "nvl ((select t_rest " +
                                       "from (select   t_rest, t_fncash, t_acccardlinkref " +
                                                 "from dsccrddoc_dbt " +
                                                "where t_action not in (2, 11) " +
                                             "order by t_date desc, t_numdaydoc desc) " +
                                      "where t_fncash = eoy.t_fncash " +
                                        "and t_acccardlinkref = cardpart.t_acccardlinkref " +
                                        "and rownum = 1), " +
                                    "0 " +
                                   ") " +
                             "- nvl (eoy.t_outsum, 0) " +
                             "+ nvl (eoy.t_insum, 0) rest, " +
                             "(select nvl (max (t_numdaydoc), 0) + 10 " +
                                "from dsccrddoc_dbt " +
                               "where t_fncash = eoy.t_fncash " +
                                 "and t_acccardlinkref = cardpart.t_acccardlinkref " +
                                 "and t_date = eoy.t_date_document) numdaydoc, " +
                             "0,  " +
                             "cardpart.t_creditcntid, " +
                             "cardpart.t_cardid " +
                        "from deoytemp_tmp eoy, ddepositr_dbt depos, dsinglecardacc_tmp cardpart " +
                       "where eoy.t_referenc = depos.t_referenc " +
                         "and eoy.t_referenc = cardpart.t_acreferenc " +
                         "and instr (depos.t_usertypeaccount, 'К') <> 0 " +
                         "and eoy.t_autokey = maineoy.t_autokey) " );

    cmd.execute;
    PrintTime("update for sub account");

    RsdCommand("update deoytemp_tmp " +
                  "set t_errorcode = 30 " +
                "where t_addref is null " +
                  "and t_referenc in (select eoy.t_referenc " +
                                       "from deoytemp_tmp eoy, ddepositr_dbt depos " +
                                      "where eoy.t_referenc = depos.t_referenc " +
                                        "and instr (depos.t_usertypeaccount, 'К') <> 0) ").execute;

    DeleteErrorRecord;

    DefineTransactionNumber( TrnNumber_atUpdateSubAccountPart );

  end; // FillSubAccountFieldsInTemporaryTable

//---------------------------
  macro FillTaxFieldsInTemporaryTable( CheckTypeAccount )
    var str, cmd;

    if ( CheckTypeAccount == null ) CheckTypeAccount = false;  end;
        
    str = "update deoytemp_tmp main_eoy " +
          "set (t_TaxBeginDate, t_TaxPercRateReFin, t_TaxExchRateCB, t_TaxPercSumDep, " +
               "t_TaxPercSumReFin, t_TaxRate, t_TaxSumNextPeriod, t_TaxSumCalcRUR) = ( " +
            "select TaxBeginDate, TaxPercRateReFin, TaxExchRateCB, TaxPercSumDep, " +
              "TaxPercSumReFin, TaxRate, TaxSumNextPeriod, " +
              "TaxExchRateCB * TaxSumNextPeriod as TaxSumCalcRUR " +
            "from (    " +
                "select Referenc, AutoKey, CurrCode, TaxBeginDate, TaxExchRateCB, " +
                "cb.t_Rate * decode(t_qpart_m, 0, 1, t_qpart_m) / decode(t_qpart_n, 0, 1, t_qpart_n)  as TaxPercRateReFin, " +
                "rsu_rtlpercent.RoundedCalcPercBetwDates(TaxBeginDate, DateCalc, Rest, TaxPercRateDep) as TaxPercSumDep, " +
                "rsu_rtlpercent.RoundedCalcPercBetwDates(TaxBeginDate, DateCalc, Rest, cb.t_Rate * decode(t_qpart_m, 0, 1, t_qpart_m) / decode(t_qpart_n, 0, 1, t_qpart_n)) as TaxPercSumReFin, " +
                "case FlagRezid when chr(0) then cb.t_TaxRate  " +
                     "else cb.t_TaxRateForEigh end as TaxRate,  " +
                "rsu_rtlcommon.AllMath_RoundSum((rsu_rtlpercent.CalcPercentsBetweenDates(TaxBeginDate, DateCalc, Rest, TaxPercRateDep) - " +
                  "rsu_rtlpercent.CalcPercentsBetweenDates(TaxBeginDate, DateCalc, Rest, cb.t_Rate * decode(t_qpart_m, 0, 1, t_qpart_m) / decode(t_qpart_n, 0, 1, t_qpart_n))) * (  " +
                    "case FlagRezid when chr(0) then cb.t_TaxRate else cb.t_TaxRateForEigh end) / 100, 2 ) as TaxSumNextPeriod " +
              "from ( " +
                  "select Referenc, AutoKey, CurrCode, TaxPercRateDep, DateCalc, Rest, TaxExchRateCB, FlagRezid, " +
                  "case when TaxBeginDate1 <= DepDate_Document then DepDate_Document + 1 " +
                       "else TaxBeginDate1 end as TaxBeginDate " +
                "from ( " +
                    "select Referenc, t_autokey as AutoKey, t_Code_Currency as CurrCode, " +
                    "t_TaxPercRateDep as TaxPercRateDep, t_DepDate_Document as DepDate_Document, " +
                    "DateCalc, t_depositsum as Rest, TaxExchRateCB, t_FlagRezid as FlagRezid, " +
                    "case when t_TaxPercRateDep > RateReFin1 then StartDate " +
                         "when DateFirstExceed is not null then ( " +
                           "rsu_rtlcommon.getDateByOffset(DateFirstExceed, 4, 3) + 1 " +
                         ") " +
                         "else null end as TaxBeginDate1 " +
                  "from ( " +
                    "select rec.*, " +
                      "( select t_Rate * qpart_m / qpart_n  from ( " +
                          "select t_EffectiveDate, t_Rate, t_FIID, " +
                                 "decode(t_qpart_m, 0, 1, t_qpart_m) qpart_m, " +
                                 "decode(t_qpart_n, 0, 1, t_qpart_n) qpart_n " +
                            "from dcbrfrate_dbt " +
                          "order by t_EffectiveDate desc " +
                        ")  " +
                        "where t_EffectiveDate <= rec.StartDate " +
                          "and t_FIID = rec.FIID " +
                          "and rownum = 1 " +
                      ") as RateReFin1, " +
                      "( select t_EffectiveDate from (  " +
                          "select t_EffectiveDate, t_Rate, t_FIID  " +
                          "from dcbrfrate_dbt " +
                          "order by t_EffectiveDate " +
                        ") " +
                        "where t_EffectiveDate > rec.StartDate " +
                          "and t_Rate < rec.t_TaxPercRateDep " +
                          "and t_FIID = rec.FIID " +
                          "and rownum = 1 " +
                      ") as DateFirstExceed, " +
                      "case when rec.t_Code_Currency = 0 then 1 " +
                           "else ( " +
                            "select exch.t_CBRate from ( " +
                              "select r.t_CBRate, r.t_Curr_Ref, ch.t_StartDate, lfd.t_FnCash " +
                              "from dratechng_dbt ch, dcur_rate_dbt r, dlistfdep_dbt lfd " +
                              "where r.t_Change_Ref = ch.t_Id " +
                                "and ch.t_Branch = " + string(Office.BranchForRate) +
                                     "and r.t_Kind_Ref = 1 " +
                              "order by ch.t_StartDate desc, ch.t_StartTime desc " +
                            ") exch " +
                            "where exch.t_Curr_Ref = rec.t_Code_Currency " +
                              "and exch.t_StartDate <= rec.DateCalc  " +
                              "and exch.t_FNCash = rec.t_FNCash " +
                              "and rownum = 1 " +
                          ") end as TaxExchRateCB " +
                    "from (    " +
                      "select d.t_Referenc as Referenc, " +
                        "case when t_Prol_DateDep <> '01-jan-0001' then t_Prol_DateDep " +
                             "when t_Start_DateDep <> '01-jan-0001' then t_Start_DateDep " +
                             "else t_Open_Date end as StartDate, " +
                        "eoy.t_currentperioddate as DateCalc, "
                        "eoy.*, " +
                        "fininstr.t_FIID as FIID " +
                      "from ddepositr_dbt d, deoytemp_tmp eoy, dcurrency_dbt curr, dfininstr_dbt fininstr " +
                     "where eoy.t_Referenc = d.t_Referenc " +
                       "and curr.t_Code_Currency = d.t_Code_Currency " +
                       "and fininstr.t_CodeInAccount = curr.t_ExternalCode ";
    if ( CheckTypeAccount )
      str = str +      "and (select t_NeedCalcTaxForCard from dsb_dtyp_dbt where t_FlagCur = d.t_iscur and t_Kind = d.t_type_account ) <> chr(0) ";
      str = str +      "and exists (select 1 from dwrk_grpr_dbt where t_flagcur = d.t_iscur and t_kind = d.t_type_account and t_grprid = " + string(Proc_PutPerc) + " ) ";
    end;
    str = str +
                    ") rec " +
                  ") " +
                ") " +
              "), " +
              "dcbrfrate_dbt cb, dcurrency_dbt curr, dfininstr_dbt fininstr " +
              "where curr.t_Code_Currency = CurrCode " +
                "and fininstr.t_CodeInAccount = curr.t_ExternalCode " + 
                "and TaxBeginDate is not null " +
                "and TaxBeginDate <= DateCalc " +
                "and cb.t_FIID = fininstr.t_FIID " +
                "and cb.t_EffectiveDate = ( " +
                  "select max(t_EffectiveDate) from dcbrfrate_dbt cbm " +
                  "where cbm.t_FIID = fininstr.t_FIID " +
                    "and cbm.t_EffectiveDate <= TaxBeginDate " +
                ") " +
            ") select_qry " +
            "where select_qry.AutoKey = main_eoy.t_autokey " +
          ") ";

    cmd = RsdCommand( str );

    cmd.addParam("offs1", RSDBP_IN, BeginOffset );
    cmd.addParam("offs2", RSDBP_IN, BeginOffset );
    cmd.execute;
    PrintTime("update for tax");
  end; // FillTaxFieldsInTemporaryTable

  macro FillTaxFieldsInTemporaryTableSP
    var cmd;

    cmd = RsdCommand("begin rsu_rtlpercent.FillPcTaxFieldsInEoy(); end;");
    cmd.execute;
    PrintTime("rsu_rtlpercent.FillPcTaxFieldsInEoy()");

    DeleteErrorRecord;
   
  end; // FillTaxFieldsInTemporaryTableSP

  macro FillPcEstimFieldsInTemporaryTableSP
    var cmd;

    cmd = RsdCommand( "begin rsu_rtlpercent.FillPcEstimFieldsInEoy(); end;" );
    cmd.execute;
    PrintTime("rsu_rtlpercent.FillPcEstimFieldsInEoy()");

    DeleteErrorRecord;

  end; // FillPcEstimFieldsInTemporaryTable
//---------------------------
  private macro ProcessScCrdDoc( parm )
    var cmd_ScCrdDoc;
    var cmd_SbCasln;

    if ( parm == null ) parm = FillMainScrdDoc; end;

    var str = "insert into dsccrddoc_dbt " +
                          "(t_applicationkind, t_fncash, t_acccardlinkref, t_addcardref, " +
                           "t_date, t_currcode, t_oper, t_numcomplexoper, t_authref, " +
                           "t_ground, t_action, t_numsession, t_depdocappkind, " +
                           "t_depdocappkey, t_applicationkey, t_numdaydoc, t_numoper, " +
                           "t_numsuboper, t_insum, t_outsum, t_rest) " +
                 "select eoy.t_isubapplicationkind, eoy.t_fncash, eoy.t_addref, " +
                        "eoy.t_addref2, eoy.t_date_document, eoy.t_code_currency, eoy.t_oper, " +
                        "eoy.t_typecomplexoper, eoy.t_listtransfer, eoy.t_ground, " +
                        "0, 0, eoy.t_iapplicationkind, eoy.t_applicationkey, ";

    if   ( parm == FillMainScrdDoc )
      str = str + "eoy.t_subapplicationkey1, eoy.t_subnumdaydoc, eoy.t_typeoper, " +
                  "eoy.t_appltype, eoy.t_insum, eoy.t_outsum, " +
                  "nvl(eoy.t_subrest, 0) - nvl(eoy.t_addinsum, 0) + nvl(eoy.t_addoutsum, 0) ";
    elif ( parm == FillAddScrdDoc ) 
      str = str + "eoy.t_subapplicationkey2, eoy.t_subnumdaydoc + 10, eoy.t_addtypeoper, " +
                  "eoy.t_addsuboper, eoy.t_addinsum, eoy.t_addoutsum, " +
                  "nvl(eoy.t_subrest, 0) ";
    elif ( parm == FillTaxScrdDoc )
      str = str + "eoy.t_taxapplicationkey, eoy.t_subnumdaydoc + 10, " +
                  "case when t_taxsumpay > 0 then 62 else 71 end, 14, " +
                  "case when t_taxsumpay < 0 then -t_taxsumpay else 0 end, " +
                  "case when t_taxsumpay > 0 then t_taxsumpay  else 0 end, " +
                  "nvl (eoy.t_subrest, 0) - t_taxsumpay ";
    end;

    str = str + "from deoytemp_tmp eoy where t_addref is not null ";

    if   ( parm == FillMainScrdDoc )
      str = str + "and ( eoy.t_insum <> 0 or eoy.t_outsum <> 0 ) ";
    elif ( parm == FillAddScrdDoc ) 
      str = str + "and ( eoy.t_addinsum <> 0 or eoy.t_addoutsum <> 0 ) ";
    elif ( parm == FillTaxScrdDoc ) 
      str = str + "and t_taxsumpay <> 0 ";
    end;

    cmd_ScCrdDoc = RsdCommand( str );
    cmd_ScCrdDoc.execute;
    PrintTime("dsccrddoc_dbt");


    if   ( parm == FillMainScrdDoc )
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc + 20, " +
                      "eoy.t_isubapplicationkind, eoy.t_subapplicationkey1, 0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy " +
                "where t_addref is not null " +
                  "and ( eoy.t_insum <> 0 or eoy.t_outsum <> 0 ) ";
   elif ( parm == FillAddScrdDoc ) 
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc + 30, " +
                      "eoy.t_isubapplicationkind, eoy.t_subapplicationkey2, 0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy " +
                "where t_addref is not null " +
                  "and ( eoy.t_addinsum <> 0 or eoy.t_addoutsum <> 0 ) ";
   elif ( parm == FillTaxScrdDoc )
      str = "insert into dsb_casln_dbt " +
                        "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, " +
                         "t_applicationkind2, t_applicationkey2, t_refvalue2, t_fncash, " +
                         "t_numsession) " +
               "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc + 60, " +
                      "eoy.t_isubapplicationkind, eoy.t_taxapplicationkey, 0, eoy.t_fncash, 0 " +
                 "from deoytemp_tmp eoy " +
                "where t_addref is not null " +
                  "and t_taxsumpay <> 0 ";
   end;

   cmd_SbCasln = RsdCommand( str );

    cmd_SbCasln.execute;
    PrintTime("dsb_cashln_dbt");

  end; // ProcessScCrdDoc

//---------------------------
  macro PresetTemporaryTable
  end;

//---------------------------
  macro PresetTemporaryTableForAllCurrency
    var countInsertedRecord = 0;
    var cmdGetCurrency, rsGetCurrency;

    if ( FlagCur == 0 )    
      countInsertedRecord = PresetTemporaryTable;
    else
      cmdGetCurrency = RsdCommand( 
          "select t_code_currency cur " +
          "from dcurrency_dbt " +
          "where t_code_currency not in (0, -1) " +
            "and t_materialref = 0 " + 
            "and t_crdifrrate <> chr(0) " );
      rsGetCurrency = RsdRecordSet( cmdGetCurrency );
      while ( rsGetCurrency.moveNext )
        CodeCurrency = rsGetCurrency.value( "cur" );
        countInsertedRecord = countInsertedRecord + PresetTemporaryTable;
      end;
    end;

    return countInsertedRecord;
  end;


  /***************************************/
  /*          Работа с Loans             */  
  /*     Возникновение овердрафта        */  
  /***************************************/

  macro PresetLoansTemporaryTable
   var cmd = RsdCommand(
       "insert into ddmlloans_tmp " +
                   "(t_creditcontractid, t_sum, t_reportdate, t_isocodecurrency, t_loansoperationid, " +
                    "t_errorcode, t_errorcodetext) " +
          "select creditcontractid, loanssum, reportdate, " +
                 "(select case " +
                            "when t_externalcode = '810' " +
                               "then '643' " +
                            "else t_externalcode " +
                         "end " +
                    "from dcurrency_dbt " +
                   "where t_code_currency = codecurrency) isocodecurrency,  " +
                   "0, -1, chr (1) " +
            "from (select   eoy.t_creditcontractid creditcontractid, max (eoy.t_reportdate) reportdate, " +
                           "max (eoy.t_code_currency) codecurrency, " +
                             "max (eoy.t_subrest) " +
                           "- sum (nvl (eoy.t_outsum, 0)) " +
                           "- sum (nvl (eoy.t_addoutsum, 0)) loanssum " +
                      "from deoytemp_tmp eoy " +
                  "group by t_creditcontractid) " +
           "where loanssum < 0 " ); 
    cmd.execute;

    return DefineTransactionNumber( TrnNumber_atCreateDocsOverdraft );

  end; // PresetLoansTemporaryTable

  macro InsertCreditRecords
    var errorText = "";
    RsdCommand(
      "insert into deoytemp_tmp " +
                  "(t_referenc, t_numdaydoc, t_type_account, t_fncash, t_account, t_date_document, t_iscur, " +
                   "t_code_currency, t_oper, t_appltype, t_kindop, t_ndoc, t_npack, t_flagrezid, " +
                   "t_codclient, t_typecomplexoper, t_objectperc, t_depdate_document, t_brigade, " +
                   "t_unionpart, t_mode, t_flags, t_realfncash, t_pcestimnumdaydoc, t_addref, " +
                   "t_addref2, t_subrest, t_subnumdaydoc, t_errorcode, t_reportdate, t_creditcontractid, " +
                   "t_typeoper, t_iapplicationkind, t_applicationkey, t_ground, t_insum, t_outsum, t_rest, " +
                   "t_percoprsum, t_percrest, t_percrestnotround, t_depositsum, t_listtransfer, t_addinsum, " +
                   "t_addoutsum, t_taxpercratedep, t_isubapplicationkind, t_subapplicationkey1 ) " +
         "select eoy.t_referenc, eoy.t_numdaydoc - 10, eoy.t_type_account, eoy.t_fncash, eoy.t_account, " +
                "eoy.t_date_document, eoy.t_iscur, eoy.t_code_currency, eoy.t_oper, 0, " +
                "eoy.t_kindop, eoy.t_ndoc, eoy.t_npack, eoy.t_flagrezid, eoy.t_codclient, " +
                "eoy.t_typecomplexoper, eoy.t_objectperc, eoy.t_depdate_document, eoy.t_brigade, " +
                "eoy.t_unionpart, eoy.t_mode, eoy.t_flags, eoy.t_realfncash, " +
                "eoy.t_pcestimnumdaydoc, eoy.t_addref, eoy.t_addref2, eoy.t_subrest, eoy.t_subnumdaydoc, " +
                "eoy.t_errorcode, eoy.t_reportdate, eoy.t_creditcontractid, " +
                "93, rsu_rtlcommon.get_sb_depsc, " +
                "rsu_rtlcommon.createapplickey_dangerous (eoy.t_fncash, " +
                                                "rsu_rtlglobals.getcnum, " +
                                                "rownum + rsu_rtlglobals.gettransactionnumber, " +
                                                "rsu_rtlcommon.get_sb_depsc " +
                                               ") applicationkey, " +
                "'Кредитование счета ' || eoy.t_account,  " +
                "-l.t_sum,  " +
                "0, eoy.t_rest, 0, 0, 0, 0, 0, 0, 0, " +
                "eoy.t_TaxPercRateDep, 610, " +
                "rsu_rtlcommon.createapplickey_dangerous (eoy.t_fncash, " +
                                                "rsu_rtlglobals.getcnum, " +
                                                "rownum + rsu_rtlglobals.gettransactionnumber, " +
                                                "rsu_rtlcommon.get_sb_depsc " +
                                               ") " +
            "from deoytemp_tmp eoy, " +
                "ddmlloans_tmp l, " +
                "(select   t_creditcontractid, min (t_autokey) autokey " +
                     "from deoytemp_tmp " +
                    "where t_creditcontractid in (select t_creditcontractid " +
                                                   "from ddmlloans_tmp " +
                                                  "where t_errorcode = 0) " +
                 "group by t_creditcontractid) queryonetran " +
          "where eoy.t_autokey = queryonetran.autokey  " +
            "and eoy.t_creditcontractid = l.t_creditcontractid " ).execute;

  end;

  // Вызов операций возникновени овердрафта
  macro CreateOverdraft
    var errorText = "";

    // Пометим неподходящие для проводки записи
    RsdCommand(
       "update deoytemp_tmp " +
          "set t_errorcode = 23 " +
        "where t_referenc in ( " +
                 "select eoy.t_referenc " +
                   "from deoytemp_tmp eoy, " +
                        "dsccard_dbt crd, " +
                        "drtcardcontract_dbt ctr, " +
                        "dcardproduct_dbt cp, " +
                        "dscacc_dbt scacc " +
                  "where crd.t_fncash = eoy.t_fncash " +
                    "and crd.t_cardref = eoy.t_cardid " +
                    "and ctr.t_branch = crd.t_fncash " +
                    "and ctr.t_id = crd.t_contractid " +
                    "and cp.t_cardproductid = ctr.t_cardproductid " +
                    "and scacc.t_referenc = eoy.t_referenc " +
                    "and (   cp.t_fundsource = 4 " +                      // ВИС <> КРЕДИТ
                         "or scacc.t_referenc_insur <> 0 " +
                         "or scacc.t_referenc_add <> 0 " +
                         "or scacc.t_hasopencredcntr <> chr(0) " +
                         "or exists ( " +
                               "select 1 " +
                                 "from ddpindebt_dbt dp " +
                                "where dp.t_branch = crd.t_fncash " +
                                  "and dp.t_cardref = crd.t_cardref " +
                                  "and dp.t_state = 1 " +
                                  "and dp.t_action not in (2, 11)) " +
                        ")) ").execute;
    deleteErrorRecord(3);

    // Если есть данные для лоанса - запускам их обработку
    if ( PresetLoansTemporaryTable > 0 )
      PrintTime("Перед вызовом loans");
      if ( ВозникновениеОвердрафта( EndDate, errorText ) )
        // Все хорошо ;)
        PrintTime("Удаляем ошибки");
        DeleteErrorRecord( 2 );  // Только вдруг какие-то записи не обработались, удалим их.
        PrintTime("Формируем записи кредитования");
        InsertCreditRecords;
      else
        // Ошибка
        PrintTime("Удаляем ошибки");
        DeleteErrorRecord( 1, errorText );
        RunError(errorText);
      end;
      PrintTime("После обработки loans");

    end;

  end; //CreateOverdraft

  /***************************************/
  /*          Работа с Loans             */  
  /*       Погашение овердрафта          */  
  /***************************************/

  macro PresetLoansTemporaryTableForPayment
   var cmd;
   var str = 
       "insert into ddmlloans_tmp " +
                   "(t_creditcontractid, t_sum, t_isocodecurrency, t_loansoperationid, t_errorcode, " +
                    "t_errorcodetext) " +
          "select creditcontractid, loanssum, " +
                 "(select case " +
                            "when t_externalcode = '810' " +
                               "then '643' " +
                            "else t_externalcode " +
                         "end " +
                    "from dcurrency_dbt " +
                   "where t_code_currency = codecurrency) isocodecurrency, 0, -1, chr (1) " +
            "from (select   eoy.t_creditcontractid creditcontractid, max (eoy.t_code_currency) codecurrency, ";
   if ( ProcType == Proc_PayScTran )
     // Для транзакций остаток субсчета реально существующий
     str = str + 
                           "max (eoy.t_subrest) + sum (eoy.t_depositsum) loanssum ";
   else
     // Для всего остального остаток субсчета уже измененный на сумму операции
     str = str + 
                           "max (eoy.t_subrest) loanssum ";
   end;
   str = str +
                      "from deoytemp_tmp eoy " +
                     "where nvl (eoy.t_creditcontractid, 0) <> 0 and nvl (eoy.t_addref, 0) <> 0 " +
                  "group by t_creditcontractid) " +
           "where loanssum > 0 ";
    cmd = RsdCommand( str );
    cmd.execute;

    return DefineTransactionNumber( TrnNumber_atCreateDocsOverdraft );
  end;


  // Вызов операций погашения овердрафта
  macro PaymentOverdraft
    var errorText = "";

    // Пометим неподходящие для проводки записи
    RsdCommand(
       "update deoytemp_tmp " +
          "set t_errorcode = 23 " +
        "where t_referenc in ( " +
                 "select eoy.t_referenc " +
                   "from deoytemp_tmp eoy, dsccard_dbt crd, drtcardcontract_dbt ctr, dcardproduct_dbt cp " +
                  "where crd.t_fncash = eoy.t_fncash " +
                    "and crd.t_cardref = eoy.t_cardid " +
                    "and ctr.t_branch = crd.t_fncash " +
                    "and ctr.t_id = crd.t_contractid " +
                    "and cp.t_cardproductid = ctr.t_cardproductid " +
                    "and (   cp.t_fundsource = 4 " +                                         // ВИС <> КРЕДИТ 
                         "or exists ( " +
                               "select 1 " +
                                 "from ddpindebt_dbt dp " +
                                "where dp.t_branch = crd.t_fncash " +
                                  "and dp.t_cardref = crd.t_cardref " +
                                  "and dp.t_state = 1 " +
                                  "and dp.t_action not in (2, 11)) " +
                         "or exists ( " +
                               "select 1 " +
                                 "from ddpindebt_dbt dp " +
                                "where dp.t_branch = eoy.t_fncash " +
                                  "and dp.t_reference = eoy.t_referenc " +
                                  "and dp.t_state = 1 " +
                                  "and dp.t_action not in (2, 11)) " +
                        ")) ").execute;
    deleteErrorRecord(3);

    // Если есть данные для лоанса - запускам их обработку
    if ( PresetLoansTemporaryTableForPayment > 0 ) 
      PrintTime("Перед вызовом loans");
      if ( ПогашениеОвердрафта( EndDate, errorText ) )
        // Все хорошо ;)

        PrintTime("Удаляем ошибки");
        DeleteErrorRecord( 2 );  // Только вдруг какие-то записи не обработались, удалим их.
        PrintTime("Формируем записи кредитования");
        RsdCommand( "begin rsu_rtlcard.EoyFormPosting(); end;" ).execute;

        Rsdcommand("update deoytemp_tmp set t_errorcode = 0 where t_errorcode = 7 ").execute;
      else
        // Ошибка
        PrintTime("Удаляем ошибки");
        DeleteErrorRecord( 1, errorText );
        RunError(errorText);
      end;
      PrintTime("После обработки loans");

    end;

end; //PaymentOverdraft


macro RecalcPercentsFor92Operation

end; // RecalcPercentsFor92Operation


  /***************************************/
  /*                 РДД                 */  
  /*       Формирование документов       */  
  /***************************************/

  macro findBusinesID( autokey, businesId, account_busines, BusinesBankId) 
    var cmdFind, rsFind;
    cmdFind = RsdCommand(
            "select cntr.t_businesid, cntr.t_account_busines, cntr.t_businesbankid " +
              "from deoytemp_tmp eoy, dtrn_payf_dbt payf, dtrn_cntr_dbt cntr " +
             "where eoy.t_autokey = ? " +
               "and eoy.t_listtransfer = payf.t_autokey " +
               "and payf.t_numbercontract = cntr.t_numbercontract " );
    cmdFind.addParam("autokey", RSDBP_IN, autokey);
    cmdFind.execute;

    rsFind = RsdRecordSet( cmdFind );
    if( rsFind.moveNext )
      businesid       = rsFind.value("t_businesid");
      account_busines = rsFind.value("t_account_busines");
      BusinesBankId   = rsFind.value("t_businesbankid");

      setparm(2, businesid);
      setparm(3, account_busines);
      setparm(4, BusinesBankId);

      return true;
    end;

    return false;
  end;

  // Инициализация переменных для документа
  macro addDocValues(rs: RsdRecordSet)
    runError("Не определена функция инициализации переменных для класса-потомка");
  end;

  macro getPMDSelectStr
    return "select eoy.* from deoytemp_tmp eoy where nvl (eoy.t_errorcode, 0) = 0";
  end;

  // Создать РДД для всей временной таблицы
  macro createPMD
    var stat = 0;

    var cmd, rs;
    var cmd_upd;

    var p_iscur         : integer;
    var p_type_account  : string; 
    var p_typeoper      : integer;
    var p_appltype      : integer;
    var p_account       : string;
    var p_appKind       : integer;
    var p_appKey        : string;

    var autokey;

    cmd_upd = RsdCommand( 
            "update deoytemp_tmp " +
               "set t_errorcode = ? " + 
             "where t_autokey = ? " );
    cmd_upd.addParam("stat", RSDBP_IN);
    cmd_upd.addParam("autokey", RSDBP_IN);


    cmd = RsdCommand( getPMDSelectStr );
    cmd.NullConversion = true;
    cmd.execute;
    PrintTime("Начинаем формировать РДД");
    rs = RsdRecordset(cmd);
    while( rs.moveNext )

      ClearAssocStorage;
      
      p_iscur         = rs.value("t_iscur");
      p_type_account  = rs.value("t_type_account");
      p_typeoper      = rs.value("t_typeoper");
      p_appltype      = rs.value("t_appltype");
      p_account       = rs.value("t_account");
      p_appKind       = rs.value("t_iheadapplicationkind");
      p_appKey        = rs.value("t_headapplicationkey");

      if( addDocValues(rs) )
        stat = Dep_FindTemplateAndCreateDocs(p_iscur, p_type_account, p_typeoper, p_appltype, p_account, p_appKind, p_appKey);

        if( stat != 0 )
          println("Ошибка при формировании РДД. Статус ошибки: " + stat + "  Счет№ " + p_account );
          getPMDError;
          return false;
        end;
      end;

    end;

    PrintTime("Закончили формировать РДД");
    return true;
  end;



end; // class MassDMLProcBase


