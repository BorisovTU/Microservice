/*
$Name:           LoansDutyPay.mac
$Module:         RETAIL
$Description:    Пакетное погашение со счетов Ритейла
*/

/*****************************************************/
/*  Пакетное погашение со счетов Ритейла             */
/*****************************************************/

import deprintr, rsd, MassDMLProcBase;

var nr = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", false ) + "\\LoansDutyPay." + {CNum};

class(MassDMLProcBase) 
    LoansDutyPay( )


//---------------------------

  macro PresetTempTableForAccount
    RsdCommand( 
       "insert into deoytemp_tmp " +
                   "(t_referenc, t_depositsum, t_outsum, t_iapplicationkind, t_applicationkey, t_ground, " +
                    "t_errorcode, t_taxapplicationkey, t_addref, t_creditnumber, t_objecttypeid, " +
                    "t_objectnumber, t_NeedInfoForExtSys) " +
          "select ret.t_referenc, ret_sum.t_paysum, ret_sum.t_paysum, 110, " +
                 "RSU_RTLCOMMON.createapplickey_dangerous (ret.t_branch, " +
                                                 "RSU_RTLGLOBALS.getcnum, " +
                                                 "rownum * 2 + RSU_RTLGLOBALS.gettransactionnumber, " +
                                                 "RSU_RTLCOMMON.get_sb_deposit " +
                                                ") applicationkey, " +
                 "duty.t_dutystagename, -2, " +
                 "RSU_RTLCOMMON.createapplickey_dangerous (ret.t_branch, " +
                                                 "RSU_RTLGLOBALS.getcnum, " +
                                                 "rownum * 2 + RSU_RTLGLOBALS.gettransactionnumber + 1, " +
                                                 "RSU_RTLCOMMON.get_sb_deposit " +
                                                ") taxapplicationkey, " +
                 "ret.t_referenc, ret.t_creditnumber, ret.t_objecttypeid, ret.t_objectnumber, " +
                 "(SELECT DECODE (count(*), 1, 'X', CHR (0)) FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 and T_OBJECTTYPE = 1 and " +
                 "T_OBJECTREF = to_char(ret.t_referenc)) NeedInfoForExtSys " +
            "from ddmlretail_tmp ret, ddmlretailsum_tmp ret_sum, ddutstage_dbt duty " +
           "where ret.t_referenc is not null " +
             "and ret.t_creditnumber = ret_sum.t_creditnumber " +
             "and ret.t_objecttypeid = ret_sum.t_objecttypeid " +
             "and ret.t_objectnumber = ret_sum.t_objectnumber " +
             "and ret_sum.t_dutystage = duty.t_dutystageid " 
              ).execute;

    PrintTime("PresetTempTableForAccount");
    return DefineTransactionNumber;
  end; // PresetTempTableForAccount

  macro PresetTempTableForCard
    RsdCommand( 
       "insert into deoytemp_tmp " +
                   "(t_referenc, t_depositsum, t_outsum, t_iapplicationkind, t_applicationkey, t_ground, " +
                    "t_errorcode, t_isubapplicationkind, t_subapplicationkey1, t_addref, t_addref2, " +
                    "t_subrest, t_subnumdaydoc, t_creditcontractid, t_taxapplicationkey, t_creditnumber, " +
                    "t_objecttypeid, t_objectnumber, t_cardid, t_NeedInfoForExtSys, t_ifrs_type) " +
          "select initialquery.referenc, ret_sum.t_paysum, ret_sum.t_paysum, 110, " +
                 "RSU_RTLCOMMON.createapplickey_dangerous (initialquery.fncash, " +
                                                 "RSU_RTLGLOBALS.getcnum, " +
                                                 "rownum * 3 + RSU_RTLGLOBALS.gettransactionnumber, " +
                                                 "RSU_RTLCOMMON.get_sb_deposit " +
                                                ") applicationkey, " +
                 "duty.t_dutystagename, -2, 610, " +
                 "RSU_RTLCOMMON.createapplickey_dangerous (initialquery.fncash, " +
                                                 "RSU_RTLGLOBALS.getcnum, " +
                                                 "rownum * 3 + RSU_RTLGLOBALS.gettransactionnumber + 1, " +
                                                 "RSU_RTLCOMMON.get_sb_deposit " +
                                                ") applicationkey, " +
                 "initialquery.addref, initialquery.addref2, " +
                 "nvl ((select orderedcrddoc.t_rest " +
                         "from (select   t_fncash, t_acccardlinkref, t_rest " +
                                   "from dsccrddoc_dbt " +
                                  "where t_action not in (2, 11) " +
                               "order by t_date desc, t_numdaydoc desc) orderedcrddoc " +
                        "where orderedcrddoc.t_fncash = initialquery.fncash " +
                          "and orderedcrddoc.t_acccardlinkref = initialquery.addref " +
                          "and rownum = 1), " +
                      "0 " +
                     ") subaccrest, " +
                 "(select nvl (max (t_numdaydoc), 0) + 20 " +
                    "from dsccrddoc_dbt " +
                   "where t_fncash = initialquery.fncash " +
                     "and t_acccardlinkref = initialquery.addref " +
                     "and t_date = RSU_RTLGLOBALS.getcurdate) numdaysubaccdoc, " +
                 "initialquery.t_retailkarta, " +
                 "RSU_RTLCOMMON.createapplickey_dangerous (initialquery.fncash, " +
                                                 "RSU_RTLGLOBALS.getcnum, " +
                                                 "rownum * 3 + RSU_RTLGLOBALS.gettransactionnumber + 2, " +
                                                 "RSU_RTLCOMMON.get_sb_deposit " +
                                                ") taxapplicationkey, " +
                 "initialquery.t_creditnumber, initialquery.t_objecttypeid, initialquery.t_objectnumber, initialquery.t_cardref, " +
                 "(SELECT DECODE (count(*), 1, 'X', CHR (0)) FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 and T_OBJECTTYPE = 1 and " +
                 "T_OBJECTREF = to_char(initialquery.referenc)) NeedInfoForExtSys, " +
                 "0 ifrs_type " +
            "from (select ret.t_branch fncash, ret.t_creditnumber, ret.t_objecttypeid, ret.t_objectnumber, " +
                         "link.t_cardaccref referenc, ret.t_retailkarta, card.t_cardref, " +
                         "case " +
                            "when link.t_mainsubacclinkref <> 0 " +
                               "then link.t_mainsubacclinkref " +
                            "else link.t_acccardlinkref " +
                         "end addref, " +
                         "case " +
                            "when link.t_mainsubacclinkref <> 0 " +
                               "then link.t_cardref " +
                            "else 0 " +
                         "end addref2 " +
                    "from ddmlretail_tmp ret, " + 
                         "dsccard_dbt card, " + 
                         "dsclink_dbt link, " + 
                         "dscacc_dbt scacc, " +
                         "v_sccompcodif codif_card, " +
                         "v_sccompcodif codif_lnk, " +
                         "v_sccompcodif codif_acc " +
                   "where ret.t_retailkarta is not null " +
                     "and card.t_contractid = ret.t_retailkarta " +
                     "and card.t_fncash = ret.t_branch " +
                     "and link.t_cardref = card.t_cardref " +
                     "and link.t_fncash = card.t_fncash " +
                     "and scacc.t_referenc = link.t_cardaccref  " +
                     // Состояние карточки 
                     "and codif_card.t_codcode = card.t_cardstatecode " +
                     "and codif_card.t_psref in (0, card.t_psref) " +
                     "and codif_card.t_codtype = 6 " +
                     "and not (    codif_card.t_val = RSU_RTLCARD.get_card_tcl " +
                              "and RSU_RTLGLOBALS.getcurdate > card.t_cardmaturitydate " +
                             ") " +
                     "and codif_card.t_val in " +
                            "(RSU_RTLCARD.get_card_offpc, " +
                             "RSU_RTLCARD.get_card_rec, " +
                             "RSU_RTLCARD.get_card_ok, " +
                             "RSU_RTLCARD.get_card_notactive, " +
                             "RSU_RTLCARD.get_card_tcl " +
                            ") " +
                     // Состояние связи 
                     "and codif_lnk.t_codcode = link.t_acccardlinkstate " +
                     "and codif_lnk.t_psref in (0, card.t_psref) " +
                     "and codif_lnk.t_codtype = 9 " +
                     "and codif_lnk.t_val = RSU_RTLCARD.get_acccardlink_ok " +
                     // Состояние карточного счета " 
                     "and codif_acc.t_codcode = scacc.t_cardaccstatecode " +
                     "and codif_acc.t_psref in (0, card.t_psref) " +
                     "and codif_acc.t_codtype = 2 " +
                     "and codif_acc.t_val = RSU_RTLCARD.get_cardacc_ok) initialquery, " +
                 "ddmlretailsum_tmp ret_sum, " +
                 "ddutstage_dbt duty " +
           "where initialquery.t_creditnumber = ret_sum.t_creditnumber " +
             "and initialquery.t_objecttypeid = ret_sum.t_objecttypeid " +
             "and initialquery.t_objectnumber = ret_sum.t_objectnumber " +
             "and ret_sum.t_dutystage = duty.t_dutystageid " 
              ).execute;

    PrintTime("PresetTempTableForCard");
    return DefineTransactionNumber;
  end; // PresetTempTableForCard

  macro UpdateTempTable
    var rs, cmd;

    cmd = RsdCommand(
        "update (select eoy.t_errorcode eoy_errorcode, eoy.t_referenc eoy_referenc, " +
                       "eoy.t_type_account eoy_type_account, depos.t_type_account depos_type_account, " +
                       "eoy.t_numdaydoc eoy_numdaydoc, eoy.t_fncash eoy_fncash, depos.t_fncash depos_fncash, " +
                       "eoy.t_account eoy_account, depos.t_account depos_account, " +
                       "eoy.t_date_document eoy_date_document, eoy.t_iscur eoy_iscur, " +
                       "depos.t_iscur depos_iscur, eoy.t_code_currency eoy_code_currency, " +
                       "depos.t_code_currency depos_code_currency, eoy.t_oper eoy_oper, " +
                       "eoy.t_appltype eoy_appltype, eoy.t_ndoc eoy_ndoc, eoy.t_npack eoy_npack, " +
                       "eoy.t_kindop eoy_kindop, eoy.t_insum eoy_insum, eoy.t_outsum eoy_outsum, " +
                       "eoy.t_rest eoy_rest, eoy.t_objectperc eoy_objectperc, " +
                       "case depos.t_usealternate " +
                          "when 0 " +
                             "then 2001 " +
                          "else 2002 " +
                       "end depos_objectperc, eoy.t_flagrezid eoy_flagrezid, " +
                       "eoy.t_listtransfer eoy_listtransfer, eoy.t_codclient eoy_codclient, " +
                       "depos.t_codclient depos_codclient, eoy.t_typeoper eoy_typeoper, " +
                       "eoy.t_typecomplexoper eoy_typecomplexoper, " +
                       "eoy.t_depdate_document eoy_depdate_document, eoy.t_brigade eoy_brigade, " +
                       "eoy.t_unionpart eoy_unionpart, eoy.t_mode eoy_mode, " +
                       "eoy.t_flags eoy_flags, eoy.t_realfncash eoy_realfncash, " +
                       "eoy.t_pcestimnumdaydoc eoy_pcestimnumdaydoc, " +
                       "eoy.t_currentperioddate eoy_currentperioddate, " +
                       "eoy.t_nextperioddate eoy_nextperioddate, eoy.t_taxsumpayrur eoy_taxsumpayrur, " +
                       "eoy.t_taxsumpay eoy_taxsumpay, eoy.t_taxsumnextperiod eoy_taxsumnextperiod, " +
                       "eoy.t_needinfoforextsys eoy_needinfoforextsys " +
                  "from deoytemp_tmp eoy  " +
                    "left outer join ddepositr_dbt depos " +
                       "on eoy.t_referenc = depos.t_referenc " +
                 "where depos.t_open_close = chr (0) " +
                   "and depos.t_sum_rest - eoy.t_depositsum >= 0 " +
                   "and depos.t_open_date <= rsu_rtlpercent.getoperationdate " +
                   "and depos.t_numsuspendeddocs = 0 " +
                   "and not (depos.t_usertypeaccount like '%О%' and depos.t_usertypeaccount not like '%К%') " +
                   "and exists ( " +
                          "select 1 " +
                            "from dwrk_grpr_dbt wg " +
                           "where wg.t_flagcur = depos.t_iscur " +
                             "and wg.t_kind = depos.t_type_account " +
                             "and wg.t_grprid = 5 " +
                             "and lower (wg.t_mac_name) = lower ( ? )) " + // <----
                  "and (select count (*) " +
                         "from dpc__calc_dbt " +
                        "where t_referenc = depos.t_referenc " +
                          "and t_objecttype = case depos.t_usealternate " +
                                               "when 0 " +
                                                  "then 2001 " +
                                               "else 2002 " +
                                            "end " +
                          "and t_typerecord = RSU_RTLPERCENT.get_rtpc_pf_calc_done " +
                          "and t_enddate >= rsu_rtlpercent.getoperationdate) = 1 " +
                  "and not exists ( " +
                         "select 1 " +
                           "from dsbdepdoc_dbt " +
                           "where t_referenc = depos.t_referenc " +
                            "and t_date_document > rsu_rtlpercent.getoperationdate) " +
                 ")"  
           "set eoy_errorcode = -1, " +
               "eoy_type_account = depos_type_account, " +
               "eoy_numdaydoc = (select nvl (max (t_numdaydoc), 0) + 20 " +
                                  "from dsbdepdoc_dbt " +
                                 "where t_referenc = eoy_referenc and t_date_document = RSU_RTLGLOBALS.getcurdate), " +
               "eoy_fncash = depos_fncash, " +
               "eoy_account = depos_account, " +
               "eoy_date_document = RSU_RTLGLOBALS.getcurdate, " +
               "eoy_iscur = depos_iscur, " +
               "eoy_code_currency = depos_code_currency, " +
               "eoy_oper = RSU_RTLGLOBALS.getoper, " +
               "eoy_appltype = 0, " +
               "eoy_ndoc = 0, " +
               "eoy_npack = 0, " +
               "eoy_kindop = 3, " +
               "eoy_insum = 0, " +
               "eoy_rest = " +
                  "(select orderedpcdrest.t_rest " +
                     "from (select   t_referenc, t_type_object, t_rest " +
                               "from dpc_drest_dbt " +
                           "order by t_referenc desc, t_date_rest desc) orderedpcdrest " +
                    "where orderedpcdrest.t_referenc = eoy_referenc " +
                      "and orderedpcdrest.t_type_object = depos_objectperc " +
                      "and rownum = 1), " +
               "eoy_flagrezid = (select decode (t_notresident, chr (0), chr (0), 'X', chr (1)) " +
                                  "from dparty_dbt " +
                                 "where t_partyid = depos_codclient), " +
               "eoy_listtransfer = 0, " +
               "eoy_codclient = depos_codclient, " +
               "eoy_typeoper = 92, " +
               "eoy_typecomplexoper = 92, " +
               "eoy_objectperc = depos_objectperc, " +
               "eoy_depdate_document = rsu_rtlpercent.getoperationdate, " +
               "eoy_brigade = RSU_RTLGLOBALS.getoperbrigade, " +
               "eoy_unionpart = rpad ('0', ? * 2, '0'), " +                 // <----
               "eoy_mode = 0, " +
               "eoy_flags = 0, " +
               "eoy_realfncash = RSU_RTLGLOBALS.getrealfncash, " +
               "eoy_pcestimnumdaydoc = " +
                    "(select nvl (max (t_numdaydoc), 0) + 20 " +
                       "from dpcestim_dbt pcestim " +
                      "where pcestim.t_referenc = eoy_referenc and pcestim.t_dateoperat = RSU_RTLGLOBALS.getcurdate), " +
               "eoy_currentperioddate = RSU_RTLGLOBALS.getnulldate, " +
               "eoy_nextperioddate = RSU_RTLGLOBALS.getnulldate, " +
               "eoy_taxsumpayrur = 0, " +
               "eoy_taxsumpay = 0, " +
               "eoy_taxsumnextperiod = 0, " +
               "eoy_needinfoforextsys = (SELECT DECODE (count(*), 1, 'X', CHR (0)) FROM dopobject_dbt " +
                                        " WHERE T_OPAPPKIND = 11001 and T_OBJECTTYPE = 1 and T_OBJECTREF = to_char(eoy_referenc)) " );

    cmd.addParam("macroName",   RSDBP_IN );   cmd.value("macroName")   = macroName;
    cmd.addParam("FieldLenght", RSDBP_IN );   cmd.value("FieldLenght") = FieldLenght;
    cmd.execute;

    RsdCommand( "delete      deoytemp_tmp " +
                      "where t_referenc in ( " +
                               "select eoy.t_referenc " +
                                 "from deoytemp_tmp eoy, " +
                                      "dsccard_dbt crd, " +
                                      "drtcardcontract_dbt ctr, " +
                                      "dcardproduct_dbt cp " +
                                "where crd.t_fncash = eoy.t_fncash " +
                                  "and crd.t_cardref = eoy.t_cardid " +
                                  "and ctr.t_branch = crd.t_fncash " +
                                  "and ctr.t_id = crd.t_contractid " +
                                  "and cp.t_cardproductid = ctr.t_cardproductid " +
                                  "and (cp.t_fundsource = 4 " +      // ВИС = КРЕДИТ 
                                       "or eoy.t_rest <> eoy.t_subrest)) ").execute;


    PrintTime("UpdateTempTable");
  end; //UpdateTempTable
  
  macro MarkLoansTable

    RsdCommand(
       "merge into ddmlretail_tmp ret " +
          "using (select   min (t_iheadapplicationkind) iak, min (t_headapplicationkey) ak, " +
                          "sum (t_errorcode) errorcode, t_creditnumber, t_objecttypeid, t_objectnumber " +
                     "from deoytemp_tmp " +
                 "group by t_creditnumber, t_objecttypeid, t_objectnumber) eoy " +
          "on (    ret.t_creditnumber = eoy.t_creditnumber " +
              "and ret.t_objecttypeid = eoy.t_objecttypeid " +
              "and ret.t_objectnumber = eoy.t_objectnumber) " +
          "when matched then " +
             "update " +
                "set ret.t_applicationkind = eoy.iak, ret.t_applicationkey = eoy.ak, " +
                    "ret.t_errorcode = eoy.errorcode " 
              ).execute;
    PrintTime("MarkLoansTable");
  end; //MarkLoansTable


  macro CreateRetailOperation( pDate )

    var stat = 0;

    var cmd_mode, rs_mode;
    var count_card, count_account;

    EndDate = pDate;
    Predetermine;

    count_card    = 0; 
    count_account = 0;
    cmd_mode = RsdCommand ( 
//            "select sum (nvl(t_referenc, 0)) account, sum (nvl(t_retailkarta, 0)) card  " +
//              "from ddmlretail_tmp " 
       "select (select count (nvl (t_referenc, 0)) " +
                 "from ddmlretail_tmp " +
                "where nvl (t_referenc, 0) <> 0) account,  " +
              "(select count (nvl (t_retailkarta, 0)) " +
                 "from ddmlretail_tmp " +
                "where nvl (t_retailkarta, 0) <> 0) card " +
         "from dual " );
    cmd_mode.execute;
   
    rs_mode = RsdRecordSet( cmd_mode );
    if ( rs_mode.moveNext )
      count_card    = rs_mode.value("card"); 
      count_account = rs_mode.value("account");

      if   ( ( count_card  > 0 ) and ( count_account == 0 ) )
        mode = MODE_LOANS_CARD;
        PresetTempTableForCard; 
      elif ( ( count_card == 0 ) and ( count_account > 0 ) ) 
        mode = MODE_LOANS_ACCOUNT;
        PresetTempTableForAccount;
      else
        stat = 117;
      end;      

    end;

    if ( stat == 0 )
      UpdateTempTable;
      DeleteErrorRecord( 3 );

      RsdCommand( "begin RSU_RTLCARD.PackPayScTran( 1 ); end;" ).execute;
      PrintTime("RSU_RTLCARD.PackPayScTran()");
      DeleteErrorRecord;

      FillTaxFieldsInTemporaryTable(true);

      ProcessSbDepDoc( FillSbDepDocTran );
      ProcessDepositrForSeveralDocs;
      UpdatePcCalcForSeveralDocs;
      ProcessPcDRestForSeveralDocs;
      ProcessRetOp( FillRetOpTran );
      ProcessOpObject;
      ProcessPcEstimForSeveralDocs;

      if (  mode == MODE_LOANS_CARD )
        ProcessScCrdDoc( FillMainScrdDoc );
      end;

      ProcessPcTax( FillPcTaxCalc );
      UpdatePcCalcForTax( FillPcTaxCalcForSeveralOperation );

      MarkLoansTable;

    end;

    return stat;
    onError( e )
      PrintErrorMessage( e );
      stat = e.code;
      AbortTrn(); // ??? перенесено из PrintErrorMessage; следует убрать, если транзакции нет
      return stat;
  end; //CreateRetailOperation


//---------------------------
// Начало класса 
//---------------------------
  PrintTime("begin");
  macroName = "LoansDutyPay.mac";

end; // class LoansDutyPay


macro CreateRetailOperation( pDate )
  var stat = 0;

  var p = LoansDutyPay();
  stat = p.CreateRetailOperation( pDate );

  SetOutput( nr, false );

  return stat;
end;


macro AttachLoansOperationToCashLink
  RsdCommand( 
       "insert into dsb_casln_dbt " +
                   "(t_applicationkind1, t_applicationkey1, t_numlinkdoc, t_applicationkind2, " +
                    "t_applicationkey2, t_refvalue2, t_fncash, t_numsession) " +
          "select eoy.t_iheadapplicationkind, eoy.t_headapplicationkey, eoy.t_numdaydoc + 10, 50, " +
                 "ret.t_credoperid, 0, eoy.t_fncash, 0 " +
            "from (select   t_referenc, t_iheadapplicationkind, t_headapplicationkey " +
                      "from deoytemp_tmp " +
                  "group by t_referenc, t_iheadapplicationkind, t_headapplicationkey) head_eoy, " +
                 "deoytemp_tmp eoy, " +
                 "ddmlretail_tmp ret " +
           "where head_eoy.t_iheadapplicationkind = eoy.t_iapplicationkind " +
             "and head_eoy.t_headapplicationkey = eoy.t_applicationkey " +
             "and ret.t_creditnumber = eoy.t_creditnumber " +
             "and ret.t_objecttypeid = eoy.t_objecttypeid " +
             "and ret.t_objectnumber = eoy.t_objectnumber " ).execute;
    SetOutput( nr, false );
    return 0;
  onError( e )
    PrintErrorMessage( e );
    SetOutput( nr, false );
    AbortTrn(); // ??? перенесено из PrintErrorMessage; следует убрать, если транзакции нет
    return e.code;
end;


//---------------------------
// Начало 
//---------------------------

TimeControl = true;
SetOutput( nr, true );

