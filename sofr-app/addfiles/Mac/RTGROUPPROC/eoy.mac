/*
$Name:           eoy.mac
$Module:         RETAIL
$Description:    DML оплата процентов при завершении периоода
*/
/* Быстрый расчет процентов, процедура завершения периода, для вкладов типа "ДО ВОСТРЕБ." */

import deprintr, rsd, SetRtGlobVar, MassDMLProcBase;


class(MassDMLProcBase) 
   eoy( 
        pTypeAccount,  // Тип счета подлежащего обработке.
        pTypeAccountExe,
        pOrderNum,
        pObjectType,
        pDate         // Дата конца периода. Обязательно.
      )

  var  nr = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", false ) + "\\OnEndOfDay." + {CNum};   //"..\\TXTFILE\\OnEndOfDay." + {CNum}

  macro addDocValues(rs: RsdRecordSet)
    var res = true;
    var flagRezid;
    if (rs.value("t_flagrezid") == "X") 
      flagRezid = true;
    else
      flagRezid = false;
    end;

    if (res) res = StoreValue("doc:ИдСчетаВклада@ППроц",    rs.value("t_referenc"));      end;
    if (res) res = StoreValue("doc:Клиент@ППроц",           rs.value("t_codclient"));     end;
    if (res) res = StoreValue("doc:Нерезидент@ППроц",       flagRezid);                   end;
    if (res) res = StoreValue("doc:Валюта@ППроц",           rs.value("t_code_currency")); end;
    if (res) res = StoreValue("doc:СчетВклада@ППроц",       rs.value("t_account"));       end;
    if (res) res = StoreValue("doc:Подразделение@ППроц",    rs.value("t_fncash"));        end;
    if (res) res = StoreValue("doc:Сумма@ППроц",            rs.value("t_insum"));         end;

    if (res) res = StoreValue("doc:ИдСчетаВклада@ПричПроц", rs.value("t_referenc"));      end;
    if (res) res = StoreValue("doc:Клиент@ПричПроц",        rs.value("t_codclient"));     end;
    if (res) res = StoreValue("doc:Нерезидент@ПричПроц",    flagRezid);                   end;
    if (res) res = StoreValue("doc:Валюта@ПричПроц",        rs.value("t_code_currency")); end;
    if (res) res = StoreValue("doc:СчетВклада@ПричПроц",    rs.value("t_account"));       end;
    if (res) res = StoreValue("doc:Подразделение@ПричПроц", rs.value("t_fncash"));        end;
    if (res) res = StoreValue("doc:Сумма@ПричПроц",         rs.value("t_insum"));         end;

//    if (res) res = StoreValue("doc:Сумма@НДФЛ",             rs.value("t_taxsumpay"));     end;

    if (res) res = StoreValue("doc:Клиент@Вып",             rs.value("t_codclient"));     end;
    if (res) res = StoreValue("doc:Подразделение@Получ",    rs.value("t_fncash"));        end;

    return res;
  end; // addDocValues

//---------------------------
  private macro SetVariables
    var d, m, y;
    DateSplit( EndDate, d, m, y );

    var cmd;

    setObjectType;

    Ground = "Проценты за " + ((m - 1) / 3 + 1) + "-й квартал " + y + " года";

    // Проверим дату конца периода и определим следующую
    if ( m == 3 ) 
      NextEndDate = Date( 30, 06, y );
    elif ( m == 6 )   
      NextEndDate = Date( 30, 09, y );
    elif ( m == 9 )  
      NextEndDate = Date( 31, 12, y );
    elif ( m == 12 )  
      y = y + 1;
      NextEndDate = Date( 31, 03, y );
    else 
      RunError("Неверная дата конца периода");  
    end;

    // Посчитаем количество дней
    NumDayInYear = 365;
    if ( ( (mod( y, 4 ) == 0) and (mod( y, 100 ) != 0) ) or ( mod( y, 400 ) == 0 ) )
      NumDayInYear  = 366;
    end;

    NumDayInNextPeriod = NextEndDate - EndDate; 

    cmd = RsdCommand("begin RSU_RTLPERCENT.setParametersForEndOfYear( ?, ?, ? ); end;");
    cmd.addParam("dayInYear",      RSDBP_IN ); cmd.value("dayInYear")      = NumDayInYear;
    cmd.addParam("dayInPeriod",    RSDBP_IN ); cmd.value("dayInPeriod")    = NumDayInNextPeriod;
    cmd.addParam("dateNextPeriod", RSDBP_IN ); cmd.value("dateNextPeriod") = NextEndDate;
    
    cmd.execute;

  end; // SetVariables


private macro blockTable
  var cmd_block;
  var str_block = 
         "select     * " +
               "from ddepositr_dbt depos " +
              "where depos.t_iscur = RSU_RTLGLOBALS.getflagcur " +
                "and depos.t_fncash = RSU_RTLGLOBALS.getfncash " +
                "and depos.t_open_close = chr (0) " +
                "and depos.t_type_account = ? " +
                "and depos.t_sum_rest > 0 " +
                "and depos.t_iscur = ? " +
                "and depos.t_numsuspendeddocs = 0 " +
                "and not exists ( " +
                       "select t_referenc " +
                         "from dpc__calc_dbt " +
                        "where t_referenc = depos.t_referenc " +
                          "and t_enddate = RSU_RTLPERCENT.get_eoy_nextenddate " +
                          "and t_objecttype = RSU_RTLPERCENT.getobjecttype " +
                          "and t_typerecord = RSU_RTLPERCENT.get_rtpc_pf_calc_done) " +
         "for update ";
  cmd_block = RsdCommand( str_block );
  cmd_block.addParam( "TypeAccount", RSDBP_IN ); cmd_block.value( "TypeAccount" ) = TypeAccount;
  cmd_block.addParam( "FlagCur",     RSDBP_IN ); cmd_block.value( "FlagCur" )     = FlagCur;
  cmd_block.execute;

end;


//---------------------------
  private macro PresetTemporaryTable

    var cmd;
    var countInsertedRecord = 0;

    DefineRate;
                              
    PrintTime("deoytemp_tmp begin");
    cmd = RsdCommand(
       "insert into deoytemp_tmp " +
                   "(t_referenc, t_numdaydoc, t_type_account, t_fncash, t_account, t_date_document, t_iscur, " +
                    "t_code_currency, t_oper, t_appltype, t_ndoc, t_npack, t_kindop, t_insum, t_outsum, " +
                    "t_rest, t_percoprsum, t_percrest, t_percrestnotround, t_flagrezid, t_iapplicationkind, " +
                    "t_applicationkey, t_listtransfer, t_codclient, t_typeoper, t_typecomplexoper, " +
                    "t_objectperc, t_depdate_document, t_brigade, t_ground, t_unionpart, t_mode, " +
                    "t_flags, t_realfncash, t_pcestimrest, t_nextperioddate, t_uniquereferenc, " +
                    "t_depositsum, t_iheadapplicationkind, t_headapplicationkey, t_pcestimnumdaydoc, t_ifrs_type) " +
          "select d.t_referenc, intermediatequery.numdaydoc, d.t_type_account, rsu_rtlglobals.getfncash, " +
                 "d.t_account, rsu_rtlglobals.getcurdate, rsu_rtlglobals.getflagcur, d.t_code_currency, " +
                 "rsu_rtlglobals.getoper, 0, 0, 0, 6, intermediatequery.insum, 0, " +
                 "intermediatequery.prevrest + intermediatequery.insum, " +
                 "rsu_rtlcommon.allmath_roundsum (  (intermediatequery.prevrest + intermediatequery.insum) " +
                                                 "* rsu_rtlpercent.get_eoy_rate " +
                                                 "* rsu_rtlpercent.get_eoy_dayinnextperiod " +
                                                 "/ rsu_rtlpercent.get_eoy_dayinyear " +
                                                 "/ 100, " +
                                                 "2 " +
                                                "), " +                     // Остаток * ПС * КДП / КДГ / 100 
                 "rsu_rtlcommon.allmath_roundsum (  (intermediatequery.prevrest + intermediatequery.insum) " +
                                                 "* rsu_rtlpercent.get_eoy_rate " +
                                                 "* rsu_rtlpercent.get_eoy_dayinnextperiod " +
                                                 "/ rsu_rtlpercent.get_eoy_dayinyear " +
                                                 "/ 100, " +
                                                 "2 " +
                                                "), " +
                   "(intermediatequery.prevrest + intermediatequery.insum) " +
                 "* rsu_rtlpercent.get_eoy_rate " +
                 "* rsu_rtlpercent.get_eoy_dayinnextperiod " +
                 "/ rsu_rtlpercent.get_eoy_dayinyear " +
                 "/ 100, " +
                 "intermediatequery.isresident, 1, intermediatequery.applicationkey, 0, d.t_codclient, 72, " +
                 "72, rsu_rtlpercent.getobjecttype, rsu_rtlpercent.getoperationdate, " +                // ДКЗП 
                 "rsu_rtlglobals.getoperbrigade, " + 
                 "?, " + // ground
                 "rsb_struct.putlong('t_ReferencPartner', " +
                     "rsb_struct.putmoney('t_SummaEstim', " +
                         "rsb_struct.putdate('t_DopDateCalc', " +
                             "rsb_struct.putdate('t_OverDateCalc', " +
                                 "rsb_struct.putdate('t_AltDateCalc', " +
                                     "rsb_struct.putdate('t_GlobDateCalc', " +
                                         "rsb_struct.putmoney('t_GlobPercCalc', " +
                                             "rsb_struct.putdate('t_DopDatePay', " +
                                                 "rsb_struct.putdate('t_OverDatePay', " +
                                                     "rsb_struct.putdate('t_AltDatePay', " +
                                                         "rsb_struct.putdate('t_GlobDatePay', " +
                                                             "rsb_struct.putmoney('t_GlobPerc', " +
                                                                 "rsb_struct.putmoney('t_AltPerc', " +
                                                                     "rsb_struct.putmoney('t_OverPerc', " +
                                                                         "rpad ('0', ? * 2, '0'), " +
                                                                         "intermediatequery.percoversumforpay, -intermediatequery.beginoffset), " +
                                                                     "case " +
                                                                        "when rsu_rtlpercent.getobjecttype = 2001 " +
                                                                           "then 0 " +
                                                                        "when rsu_rtlpercent.getobjecttype = 2002 " +
                                                                           "then intermediatequery.percsumforpay " +
                                                                        "else 0 " +
                                                                     "end, -intermediatequery.beginoffset), " +
                                                                 "case " +
                                                                    "when rsu_rtlpercent.getobjecttype = 2001 " +
                                                                       "then intermediatequery.percsumforpay " +
                                                                    "when rsu_rtlpercent.getobjecttype = 2002 " +
                                                                       "then 0 " +
                                                                    "else 0 " +
                                                                 "end, -intermediatequery.beginoffset), " +
                                                             "rsu_rtlpercent.getoperationdate, -intermediatequery.beginoffset), " + // ДКЗП 
                                                         "rsu_rtlpercent.getoperationdate, -intermediatequery.beginoffset), " +    // ДКЗП 
                                                     "rsu_rtlglobals.getnulldate, -intermediatequery.beginoffset), " +
                                                 "rsu_rtlglobals.getnulldate, -intermediatequery.beginoffset), " +
                                             "rsu_rtlcommon.allmath_roundsum " +
                                                                 "(  (  intermediatequery.prevrest " +
                                                                     "+ intermediatequery.insum " +
                                                                    ") " +
                                                                  "* rsu_rtlpercent.get_eoy_rate " +
                                                                  "* rsu_rtlpercent.get_eoy_dayinnextperiod " +
                                                                  "/ rsu_rtlpercent.get_eoy_dayinyear " +
                                                                  "/ 100, " +
                                                                  "2 " +
                                                                 "), -intermediatequery.beginoffset), " +
                                         "rsu_rtlpercent.get_eoy_nextenddate, -intermediatequery.beginoffset), " + // ДКСП 
                                     "rsu_rtlpercent.get_eoy_nextenddate, -intermediatequery.beginoffset), " + // ДКСП 
                                 "rsu_rtlglobals.getnulldate, -intermediatequery.beginoffset), " +
                             "rsu_rtlglobals.getnulldate, -intermediatequery.beginoffset), " +
                         "intermediatequery.pcestimrest, -intermediatequery.beginoffset), " +
                     "d.t_referenc, -intermediatequery.beginoffset),  " +
                 "1,  " +
                 "16384, rsu_rtlglobals.getfncash, pcestimrest, rsu_rtlpercent.get_eoy_nextenddate, " +
                 "d.t_referenc, " +
                 "intermediatequery.insum, 1, intermediatequery.applicationkey, intermediatequery.psestimndd, " +
                 "0 ifrs_type " +
            "from ( select depos.t_referenc, " +
                         "(select nvl (max (t_numdaydoc), 0) + 100 " +
                            "from dsbdepdoc_dbt " +
                           "where t_referenc = depos.t_referenc " +
                             "and t_date_document = rsu_rtlglobals.getcurdate) numdaydoc, " +
                         "pccalc_cur.t_sumforpay percsumforpay, " +
                         "nvl (pccalc_over.t_sumforpay, 0) percoversumforpay, " +
                         "pccalc_cur.t_sumforpay + nvl (pccalc_over.t_sumforpay, 0) insum, " +
                         "nvl ((select pc_drest.t_rest " +
                                 "from (select   t_referenc, t_rest " +
                                           "from dpc_drest_dbt " +
                                          "where t_date_rest <= rsu_rtlpercent.getoperationdate " +
                                            "and t_type_object = rsu_rtlpercent.getobjecttype " +
                                       "order by t_referenc desc, t_date_rest desc) pc_drest " +
                                "where t_referenc = depos.t_referenc and rownum = 1), " +
                              "0 " +
                             ") prevrest, " +
                         "nvl ((select pcestim.t_summapay_rest " +
                                 "from (select   t_referenc, t_summapay_rest " +
                                           "from dpcestim_dbt " +
                                          "where t_dateoperat <= rsu_rtlpercent.getoperationdate " +
                                            "and t_action not in (2, 11) " +
                                       "order by t_dateoperat desc) pcestim " +
                                "where t_referenc = depos.t_referenc and rownum = 1), " +
                              "0 " +
                             ") pcestimrest, " +
                         "nvl( (select nvl(max(t_numdaydoc), 0) + 10  " +
                                 "from dpcestim_dbt pcestim  " +
                                "where pcestim.t_referenc = depos.t_referenc  " +
                                  "and pcestim.t_dateoperat = rsu_rtlglobals.getcurdate), 0 ) psestimndd, " +
                         "(select decode (t_notresident, chr (0), chr (0), 'X', chr (1)) " +
                            "from dparty_dbt " +
                           "where t_partyid = depos.t_codclient) isresident, " +
                         "rsu_rtlcommon.createapplickey_dangerous " +
                                                      "(rsu_rtlglobals.getfncash, " +
                                                       "rsu_rtlglobals.getcnum, " +
                                                       "rownum + rsu_rtlglobals.gettransactionnumber, " +
                                                       "1 " +
                                                      ") applicationkey, " +
                         "? beginoffset " +
                    "from ddepositr_dbt depos, dpc__calc_dbt pccalc_cur , dpc__calc_dbt pccalc_over " +
                   "where depos.t_iscur = rsu_rtlglobals.getflagcur " +
                     "and depos.t_fncash = rsu_rtlglobals.getfncash " +
                     "and depos.t_open_close = chr (0) " +
                     "and depos.t_type_account = ? " + // TypeAccount
                     // код валюты 
                     "and depos.t_code_currency = ? " + 
                     // отсекаем недопроведенные
                     "and depos.t_numsuspendeddocs = 0 " +
                     "and depos.t_usertypeaccount not like '%Т%' " +
                     "and depos.t_usertypeaccount not like '%Д%' " +
                     "and not (depos.t_usertypeaccount like '%О%' and depos.t_usertypeaccount not like '%К%') " +
                     // Проверка в графике оплат процентов 
                     // Есть записи за текущий период 
                     "and depos.t_referenc = pccalc_cur.t_referenc " +
                     "and pccalc_cur.t_enddate = rsu_rtlpercent.getoperationdate " +                    // ДКЗП 
                     "and pccalc_cur.t_objecttype = rsu_rtlpercent.getobjecttype " +
                     "and pccalc_cur.t_typerecord = 1 " +
                     // график процентов для 2003 условий 
                     "and pccalc_over.t_referenc(+) = depos.t_referenc " +
                     "and pccalc_over.t_enddate(+) = rsu_rtlpercent.getoperationdate " +                // ДКЗП 
                     "and pccalc_over.t_objecttype(+) = 2003 " +
                     "and pccalc_over.t_typerecord(+) = 1 " +
                     "and (   (    depos.t_usertypeaccount like '%К%' " +
                              "and not (    rsu_rtlglobals.getcardslimitoverrundate <> rsu_rtlglobals.getnulldate " +
                                       "and depos.t_open_date >= rsu_rtlglobals.getcardslimitoverrundate " +
                                      ") " +
                             ") " +
                          "or (    (depos.t_usertypeaccount not like '%К%') " +
                              "and not (    rsu_rtlglobals.getdepacclimitoverrundate <> rsu_rtlglobals.getnulldate " +
                                       "and depos.t_open_date >= rsu_rtlglobals.getdepacclimitoverrundate " +
                                      ") " +
                             ") " +
                         ") " +
                     // Нет записи за след период 
                     "and not exists ( " +
                            "select t_referenc " +
                              "from dpc__calc_dbt " +
                             "where t_referenc = depos.t_referenc " +
                               "and t_enddate = rsu_rtlpercent.get_eoy_nextenddate " +                  // ДКСП 
                               "and t_objecttype = rsu_rtlpercent.getobjecttype " +
                               "and t_typerecord = 1) " + 
                     "and not exists ( " +
                            "select 1 " +
                              "from ddpindebt_dbt dp " +
                             "where dp.t_branch = rsu_rtlglobals.getfncash " +
                               "and dp.t_reference = depos.t_referenc " +
                               "and dp.t_state = 1 " +
                               "and dp.t_action not in (2, 11)) " + 
                  ") intermediatequery, " +
                 "ddepositr_dbt d " +
           "where d.t_referenc = intermediatequery.t_referenc " +
             "and intermediatequery.insum >= 0 " +
             "and intermediatequery.prevrest >= 0 " );

    cmd.addParam("Ground",       RSDBP_IN );     cmd.value("Ground")       = Ground;
    cmd.addParam("FieldLenght",  RSDBP_IN );     cmd.value("FieldLenght")  = FieldLenght;
    cmd.addParam("BeginOffset",  RSDBP_IN );     cmd.value("BeginOffset")  = BeginOffset;
    cmd.addParam("TypeAccount",  RSDBP_IN );     cmd.value("TypeAccount")  = TypeAccount;
    cmd.addParam("CodeCurrency", RSDBP_IN );     cmd.value("CodeCurrency") = CodeCurrency;

    cmd.execute;
    PrintTime("deoytemp_tmp end");

    DeleteUnsupportedRecords(true);

    countInsertedRecord = DefineTransactionNumber( TrnNumber_atInsertTemporaryTable );

    FillSubAccountFieldsInTemporaryTable( TrnNumber_atInsertTemporaryTable );

    // Если надо погасить овердрафты
    if ( mode == MODE_KREDIT )
      PaymentOverdraft;

      RsdCommand( "begin rsu_rtlcard.recalcsumineoy(); end;" ).execute();
      PrintTime("rsu_rtlcard.recalcsumineoy()");
      DeleteErrorRecord;
    end;

    return defineCountRecordInTable("deoytemp_tmp");
  end; // PresetTemporaryTable


//---------------------------
  macro ProcessAll

    Predetermine;
    SetVariables;

    blockTable;
    if ( PresetTemporaryTableForAllCurrency == 0 )
      println("Прерываем обработку, так как временная таблица пуста");      
      return;
    end;

    if( not createPMD )
      runError("Ошибка при формировании РДД");
    end;

    ProcessSbDepDoc;
    ProcessDepositrForSeveralDocs;
    ProcessPcCalc;
    ProcessPcDRestForSeveralDocs;
    ProcessRetOp(FillRetOpTran);
    ProcessOpObject;
    ProcessPcEstimForSeveralDocs;
    ProcessEdRef;
    ProcessScCrdDoc;
    UpdatePcCalcForSeveralDocs(OnlyForLoans);

    PrintTime("Перед транзикцией");
    InterDesk_EndDocBunch;
    
//    RunError("Рано нам пока ишшо вставлять все в базу....");

    OnError ( e )
      PrintErrorMessage(e);
      InterDesk_EndDocBunch;
      AbortTrn();
  end; // ProcessAll


//---------------------------
// Начало
//---------------------------
  PrintTime("begin");
  SetOutput( nr, true );


  TypeAccount    = pTypeAccount;
  TypeAccountExe = pTypeAccountExe;
  OrderNum       = pOrderNum;
  ObjectType     = pObjectType;
  EndDate        = pDate;

  CodeCurrency = 0;
  FNCash       = NumFNCash;

  mode         = MODE_KREDIT;
  ProcType     = Proc_Eoy;

  ClearTempTable;
  
  LoopInTrn(true);
  ProcessTrn( 0, R2M(this, "ProcessAll") );

  PrintTime("end");

end;

macro start(  pTypeAccount,  // Тип счета подлежащего обработке.
              pTypeAccountExe,
              pOrderNum, 
              pObjectType,
              pDate         // Дата конца периода. Обязательно.
           )

  TimeControl = false;
  eoy ( pTypeAccount, pTypeAccountExe, 0, pObjectType, pDate );

end;



