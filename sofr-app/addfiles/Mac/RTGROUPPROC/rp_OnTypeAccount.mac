/*
$Name:         rp_OnTypeAccount.mac
$Module:       Обслуживание физ лиц
$Description:  DML причисление процентов для вкладов с условиями расчета "по виду вклада"
*/

import deprintr, rsd, MassDMLProcBase;
import Календарь;


class(MassDMLProcBase) 
   rp_OnTypeAccount( pTypeAccount,         // Тип счета подлежащего обработке.
                     pTypeAccountExe,
                     pOrderNum,
                     pObjectType,
                     pDate 
                   )
private var  DateBeginPeriod;


/*____________142833 - SAN - Removal of the relative paths__________*/
var nr = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", false ) + "\\OnTypeAccount." + {CNum}; //"..\TXTFILE\OnTypeAccount." + {CNum};
/*___________/142833 - 14/07/09_____________________________________*/



private var DayCalc, GrafCalc;



  macro addDocValues(rs: RsdRecordSet)
    var res = true;
    var flagRezid;
    if (rs.value("t_flagrezid") == "X") 
      flagRezid = true;
    else
      flagRezid = false;
    end;

    if (res) res = StoreValue("doc:ИдСчетаВклада@ППроц",      rs.value("t_referenc"));      end;
    if (res) res = StoreValue("doc:Клиент@ППроц",             rs.value("t_codclient"));     end;
    if (res) res = StoreValue("doc:Нерезидент@ППроц",         flagRezid);                   end;
    if (res) res = StoreValue("doc:Валюта@ППроц",             rs.value("t_code_currency")); end;
    if (res) res = StoreValue("doc:СчетВклада@ППроц",         rs.value("t_account"));       end;
    if (res) res = StoreValue("doc:Подразделение@ППроц",      rs.value("t_fncash"));        end;
    if (res) res = StoreValue("doc:Сумма@ППроц",              rs.value("t_insum"));         end;
    if (res) res = StoreValue("doc:ВидВклада@ППроц",          rs.value("t_Type_Account"));  end;
    if (res) res = StoreValue("doc:ГруппаНумерации@ППроц",    rs.value("t_GroupNumberID")); end;

    if (res) res = StoreValue("doc:ИдСчетаВклада@ПричПроц",   rs.value("t_referenc"));      end;
    if (res) res = StoreValue("doc:Клиент@ПричПроц",          rs.value("t_codclient"));     end;
    if (res) res = StoreValue("doc:Нерезидент@ПричПроц",      flagRezid);                   end;
    if (res) res = StoreValue("doc:Валюта@ПричПроц",          rs.value("t_code_currency")); end;
    if (res) res = StoreValue("doc:СчетВклада@ПричПроц",      rs.value("t_account"));       end;
    if (res) res = StoreValue("doc:Подразделение@ПричПроц",   rs.value("t_fncash"));        end;
    if (res) res = StoreValue("doc:Сумма@ПричПроц",           rs.value("t_insum"));         end;
    if (res) res = StoreValue("doc:ВидВклада@ПричПроц",       rs.value("t_Type_Account"));  end;
    if (res) res = StoreValue("doc:ГруппаНумерации@ПричПроц", rs.value("t_GroupNumberID")); end;

    if (res) res = StoreValue("doc:Сумма@НДФЛ",               rs.value("t_taxsumpay"));     end;

    if (res) res = StoreValue("doc:Клиент@Вып",               rs.value("t_codclient"));     end;
    if (res) res = StoreValue("doc:Подразделение@Получ",      rs.value("t_fncash"));        end;

    if (res) res = StoreValue("doc:ОснованиеПервичного",      rs.value("t_ground"));        end;

    if (res) res = StoreValue("doc:ОчередностьПлатежа",       0);                           end;
    
    if (res) 
      res = StoreValue("doc:ДатаОперации", date(rs.value("t_depdate_document"))); 
    end;
    if (res) 
      res = StoreValue("doc:ДатаОперацииРабочая", 
                   GetNextDateAfterDays( date(rs.value("t_depdate_document")), 
                                         int(rs.value("t_fncash")),
                                         CALENDAR_SERVICE_BANK, 
                                         CALENDAR_BALANCE_YES, 
					 0 )); 
    end;
    if (res) 
      res = StoreValue("doc:ДатаОперацииБаланс", 
                   GetNextDateAfterDays( date(rs.value("t_depdate_document")), 
                                         int(rs.value("t_fncash")), 
                                         null, 
                                         CALENDAR_BALANCE_YES, 
                                         0 )); 
    end;
    return res;
  end; // addDocValues




//---------------------------
  private macro SetVariables
    
    var stat = 0;
    var cmd_graf, cmd_date;

    setObjectType;

    Ground = "Причисление процентов на " + string(EndDate);

    // Определим дату конца периода
    cmd_graf = RsdCommand( "begin ? := RSU_RTLPERCENT.FindRtPcAlg( ?, ?, ?, ? ); end;" );

    cmd_graf.AddParam( "RetVal", RSDBP_RETVAL, V_INTEGER );
    cmd_graf.AddParam("TypeAccount", RSDBP_IN );
    cmd_graf.AddParam("InDate", RSDBP_IN );
    cmd_graf.AddParam("DayCalc", RSDBP_OUT, V_INTEGER );
    cmd_graf.AddParam("GrafCalc", RSDBP_OUT, V_INTEGER );

    cmd_graf.value("TypeAccount") = TypeAccountExe;
    cmd_graf.value("InDate") = EndDate;

    cmd_graf.execute;

    stat = cmd_graf.value( "RetVal" ); 
    DayCalc = cmd_graf.value("DayCalc");
    GrafCalc = cmd_graf.value("GrafCalc"); 
    if ( stat != 0 )   
      RunError("Не удается определить параметры расчета процентов");
    end;

    [График расчета ##] (GrafCalc);

    cmd_date = RsdCommand("begin ? := rsu_rtlpercent.rp_FindDateBeginPeriod_ota( ?, ?, ? ); end;" );
    cmd_date.AddParam( "RetVal", RSDBP_RETVAL, V_DATE );
    cmd_date.AddParam("InDate", RSDBP_IN );
    cmd_date.AddParam("DayCalc", RSDBP_IN );
    cmd_date.AddParam("GrafCalc", RSDBP_IN );

    cmd_date.value("InDate") = EndDate;
    cmd_date.value("DayCalc") = DayCalc; 
    cmd_date.value("GrafCalc") = GrafCalc; 

    cmd_date.execute;

    DateBeginPeriod = cmd_date.value( "RetVal" ) ; 
//    if ( RecalcEndDate == Date(1,1,1) )
//      RunError("Не удается определить дату конца периода");
//    end;
                            
    CheckTaxCalc();

  end; // SetVariables


  private macro blockTable
    var cmd_block;
    var str_block = 
       "select     * " +
             "from ddepositr_dbt depos " +
            "where depos.t_fncash = rsu_rtlglobals.getfncash " +
              "and depos.t_iscur = rsu_rtlglobals.getflagcur " +
              "and depos.t_type_account = ? " +
              "and depos.t_open_close = chr (0) " +
              "and depos.t_numsuspendeddocs = 0 " +
              "and depos.t_sum_rest >= 0 " +
              "and depos.t_usealternate = rsu_rtlpercent.valueforusealternativefield " +
              "and not exists ( " +
                     "select 1 " +
                       "from dsb_congt_dbt " +
                      "where t_referencacc = depos.t_referenc " +
                        "and t_gettype = rsu_rtldeposit.get_get_linkdepaccount " +
                        "and t_partaccount = rsu_rtldeposit.get_linkdepacc_perc " +
                        "and t_action not in (2, 11)) " +
              "and not exists ( " +
                     "select 1 " +
                       "from dpc__calc_dbt " +
                      "where t_referenc = depos.t_referenc " +
                        "and t_objecttype = rsu_rtlpercent.getobjecttype " +
                        "and t_typerecord = rsu_rtlpercent.get_rtpc_pf_calc_done " +
                        "and t_enddate > rsu_rtlpercent.getoperationdate) " +
       "for update ";
    cmd_block = RsdCommand( str_block );
    cmd_block.addParam( "TypeAccount", RSDBP_IN );  cmd_block.value( "TypeAccount" ) = TypeAccount;
    cmd_block.execute;

  end;

//---------------------------
  private macro PresetTemporaryTable

    var countInsertedRecord = 0;
    var cmdCountEoy, rsCountEoy;
    var countEoyRecs = 0;
    var flagOper72 = true;
    var reg_error = 0;
    var cmd;

    GetRegistryValue( "RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\ПРОЦЕНТЫ\\ПРИЧИСЛЕНИЕ_РАНЬШЕ_ПОСЛЕДНЕГО", V_BOOL, flagOper72, reg_error );
    if ( reg_error )
      flagOper72 = true;
    end;

    cmd = RsdCommand( 
       "insert into deoytemp_tmp " +
                   "(t_referenc, t_numdaydoc, t_type_account, t_fncash, t_account, t_date_document, t_iscur, " +
                    "t_code_currency, t_oper, t_appltype, t_ndoc, t_npack, t_kindop, t_insum, t_outsum, " +
                    "t_rest, t_percoprsum, t_percrest, t_percrestnotround, t_flagrezid, t_iapplicationkind, " +
                    "t_applicationkey, t_listtransfer, t_codclient, t_typeoper, t_typecomplexoper, " +
                    "t_objectperc, t_depdate_document, t_brigade, t_ground, t_unionpart, t_mode, " +
                    "t_flags, t_realfncash, t_nextperioddate, t_uniquereferenc, t_taxsumpay, t_taxsumpayrur, " +
                    "t_taxpercratedep, t_taxapplicationkey, t_taxsumnextperiod, t_currentperioddate, " +
                    "t_depositsum, t_iheadapplicationkind, t_headapplicationkey, t_pcestimnumdaydoc, " + 
                    "t_GroupNumberID, t_NeedInfoForExtSys, t_ifrs_type) " +
          "select referenc, numdaydoc, typeaccount, rsu_rtlglobals.getfncash, acc, " +
                 "rsu_rtlglobals.getcurdate, rsu_rtlglobals.getflagcur, codecurrency, " +
                 "rsu_rtlglobals.getoper, 0, 0, 0, 6, sumforpay + oversumforpay, 0, prevrest + sumforpay, " +
                 "rsu_rtlpercent.roundedcalcpercbetwdates (enddate + 1, " +
                                                          "nextenddate, " +
                                                          "prevrest + sumforpay - rsu_rtlcommon.allmath_roundsum (taxsumpay / 100, 2) * 100, " +
                                                          "rate " +
                                                         "), " +
                 "rsu_rtlpercent.roundedcalcpercbetwdates (enddate + 1, " +
                                                          "nextenddate, " +
                                                          "prevrest + sumforpay - rsu_rtlcommon.allmath_roundsum (taxsumpay / 100, 2) * 100, " +
                                                          "rate " +
                                                         "), " +
                 "rsu_rtlpercent.calcpercentsbetweendates (enddate + 1, " +
                                                          "nextenddate, " +
                                                          "prevrest + sumforpay - rsu_rtlcommon.allmath_roundsum (taxsumpay / 100, 2) * 100, " +
                                                          "rate " +
                                                         "), " +
                 "isresident, 1, applicationkey, 0, codclient, 72, 72, rsu_rtlpercent.getobjecttype, " +
                 "enddate, rsu_rtlglobals.getoperbrigade, " + 
                 "?, " + // ground
                 "rsb_struct.putlong('t_ReferencPartner', " +
                     "rsb_struct.putdate('t_DopDateCalc', " +
                         "rsb_struct.putdate('t_OverDateCalc', " +
                             "rsb_struct.putdate(case rsu_rtlpercent.getobjecttype " +
                                                  "when 2001 " +
                                                     "then 't_AltDateCalc' " +
                                                  "when 2002 " +
                                                     "then 't_GlobDateCalc' " +
                                                  "end, " +
                                 "rsb_struct.putdate(case rsu_rtlpercent.getobjecttype " +
                                                       "when 2001 " +
                                                          "then 't_GlobDateCalc' " +
                                                       "when 2002 " +
                                                          "then 't_AltDateCalc' " +
                                                       "end, " +
                                     "rsb_struct.putmoney(case rsu_rtlpercent.getobjecttype " +
                                                            "when 2001 " +
                                                               "then 't_GlobPercCalc' " +
                                                            "when 2002 " +
                                                               "then 't_AltPercCalc' " +
                                                            "end, " +
                                         "rsb_struct.putdate('t_DopDatePay', " +
                                             "rsb_struct.putdate('t_OverDatePay', " +
                                                 "rsb_struct.putdate('t_AltDatePay', " +
                                                     "rsb_struct.putdate('t_GlobDatePay', " +
                                                         "rsb_struct.putmoney(case rsu_rtlpercent.getobjecttype " +
                                                                                "when 2001 " +
                                                                                   "then 't_GlobPerc' " +
                                                                                "when 2002 " +
                                                                                   "then 't_AltPerc' " +
                                                                                "end, " +
                                                                       "rsb_struct.putmoney ('t_OverPerc', " +
                                                                                            "rpad ('0', ? * 2, '0'), " +
                                                                                            "oversumforpay, -beginoffset ), " +
                                                                       "sumforpay, -beginoffset ), " +
                                                         "enddate, -beginoffset ), " +
                                                     "enddate, -beginoffset ), " +
                                                 "rsu_rtlglobals.getnulldate, -beginoffset ), " +
                                             "rsu_rtlglobals.getnulldate, -beginoffset ), " +
                                         "rsu_rtlpercent.roundedcalcpercbetwdates (enddate + 1, " +
                                                                                  "nextenddate, " +
                                                                                  "prevrest + sumforpay, " +
                                                                                  "rate " +
                                                                                 "), -beginoffset ), " +
                                     "nextenddate, -beginoffset ), " +
                                 "rsu_rtlglobals.getnulldate, -beginoffset ), " +
                             "rsu_rtlglobals.getnulldate, -beginoffset ), " +
                         "rsu_rtlglobals.getnulldate, -beginoffset ), " +
                     "referenc, -beginoffset ), " +
                 "0, " +
                 "16384, rsu_rtlglobals.getfncash, nextenddate, referenc, taxsumpayrounded, " +
                 "rsu_rtlcommon.allmath_roundsum (taxsumpayrur / 100, 2) * 100, rate, taxapplicationkey, 0, " +
                 "nextenddate, prevrest + sumforpay + oversumforpay - taxsumpayrounded, " +
                 "1, applicationkey, psestimndd, GroupNumberID, " + 
                 "(SELECT DECODE (count(*), 1, 'X', CHR (0)) " +
                   " FROM dopobject_dbt " + 
                   "WHERE T_OPAPPKIND = 11001 and T_OBJECTTYPE = 1 and  T_OBJECTREF = to_char(referenc)) NeedInfoForExtSys, " +
                 "0 ifrs_type " +
            "from (select intermediatequery.*, primarypccalc.t_enddate enddate, " +
                         "primarypccalc.t_sumforpay sumforpay, nvl (overpccalc.t_sumforpay, " +
                                                                   "0) oversumforpay, " +
                         "primarydepos.t_codclient codclient, primarydepos.t_code_currency codecurrency, " +
                         "primarydepos.t_account acc, primarydepos.t_type_account typeaccount, " +
                         "(select nvl (max (t_numdaydoc), 0) + 10 " +
                            "from dsbdepdoc_dbt " +
                           "where t_referenc = intermediatequery.referenc " +
                             "and t_date_document = rsu_rtlglobals.getcurdate) numdaydoc, " +
                         "(select nvl(max(t_numdaydoc), 0) + 20 " +
                            "from dpcestim_dbt pcestim " +
                           "where pcestim.t_referenc = intermediatequery.referenc " +
                             "and pcestim.t_dateoperat = rsu_rtlglobals.getcurdate) psestimndd, " +
                         "rsu_rtlcommon.createapplickey_dangerous " +
                                                      "(rsu_rtlglobals.getfncash, " +
                                                       "rsu_rtlglobals.getcnum, " +
                                                       "rownum * 2 + rsu_rtlglobals.gettransactionnumber, " +
                                                       "1 " +
                                                      ") applicationkey, " +
                         "rsu_rtlcommon.createapplickey_dangerous " +
                                                   "(rsu_rtlglobals.getfncash, " +
                                                    "rsu_rtlglobals.getcnum, " +
                                                    "rownum * 2 + 1 + rsu_rtlglobals.gettransactionnumber, " +
                                                    "1 " +
                                                   ") taxapplicationkey, " +
                         "(select decode (t_notresident, chr (0), chr (0), 'X', chr (1)) " +
                            "from dparty_dbt " +
                           "where t_partyid = primarydepos.t_codclient) isresident, " +
                         "rsu_rtlpercent.getpercrateforaccountsimple (intermediatequery.referenc, " +
                                                                     "rsu_rtlpercent.getobjecttype, " +
                                                                     "intermediatequery.pccalcenddate, " +
                                                                     "intermediatequery.prevrest " +
                                                                    ") rate, " +
                         "? beginoffset, primarypccalc.t_taxsumforpay taxsumpay, " +
                         "primarypccalc.t_taxsumforpayrur taxsumpayrur, " +
                         "case rsu_rtlglobals.getflagcur " +
                            "when 0 " +
                               "then   rsu_rtlcommon.allmath_roundsum " +
                                                         "(primarypccalc.t_taxsumforpay / 100, " +
                                                          "2 " +
                                                         ") " +
                                    "* 100 " +
                            "else rsu_rtlcommon.convsum " +
                                      "(  rsu_rtlcommon.allmath_roundsum (  primarypccalc.t_taxsumforpayrur " +
                                                                         "/ 100, " +
                                                                         "2 " +
                                                                        ") " +
                                       "* 100, " +
                                       "0, " +
                                       "primarydepos.t_code_currency, " +
                                       "intermediatequery.pccalcenddate, " +
                                       "1, " +
                                       "rsu_rtlglobals.getfncash " +
                                      ") " +
                         "end taxsumpayrounded, " +
                         "abs(to_number(primarydepos.t_GroupNumb)) GroupNumberID " +
                    "from (select initialquery.referenc, initialquery.pccalcenddate, " +
                                 "rsu_rtlpercent.rp_finddateendperiod_ota " +
                                                                "(initialquery.pccalcenddate, " +
                                                                 "initialquery.depositrenddate, " +
                                                                 "?, " +
                                                                 "? " +
                                                                ") nextenddate, " +
                                 "(select pc_drest.t_rest " +
                                    "from (select   t_referenc, t_rest " +
                                              "from dpc_drest_dbt " +
                                             "where     /*t_date_rest <= InitialQuery.PcCalcEndDate " +
                                                   "and*/ t_type_object = rsu_rtlpercent.getobjecttype " +
                                          "order by t_referenc desc, t_date_rest desc) pc_drest " +
                                   "where t_referenc = initialquery.referenc and rownum = 1) prevrest " +
                            "from (select depos.t_referenc referenc, depos.t_end_datedep depositrenddate, " +
                                         "(select pccalc.t_enddate " +
                                            "from (select   t_referenc, t_enddate " +
                                                      "from dpc__calc_dbt " +
                                                     "where t_objecttype = rsu_rtlpercent.getobjecttype " +
                                                       "and t_enddate <= rsu_rtlpercent.getoperationdate " +
                                                  "order by t_referenc desc, t_enddate desc) pccalc " +
                                           "where t_referenc = depos.t_referenc and rownum = 1) " +
                                                                                             "pccalcenddate " +
                                    "from ddepositr_dbt depos " +
                                   "where depos.t_fncash = rsu_rtlglobals.getfncash " +
                                     "and depos.t_iscur = rsu_rtlglobals.getflagcur " +
                                     "and depos.t_type_account = ? " +
                                     "and depos.t_open_close = chr (0) " +
                                     "and depos.t_numsuspendeddocs = 0 " +
                                     "and depos.t_sum_rest >= 0 " +
                                     "and depos.t_usertypeaccount not like '%Т%' " +
                                     "and depos.t_usertypeaccount not like '%Д%' " +
                                     "and not (depos.t_usertypeaccount like '%О%' and depos.t_usertypeaccount not like '%К%') " +
                                     "and (   (    depos.t_usertypeaccount like '%К%' " +
                                              "and not (    rsu_rtlglobals.getcardslimitoverrundate <> " +
                                                                                 "rsu_rtlglobals.getnulldate " +
                                                       "and depos.t_open_date >= " +
                                                                    "rsu_rtlglobals.getcardslimitoverrundate " +
                                                      ") " +
                                             ") " +
                                          "or (    (depos.t_usertypeaccount not like '%К%') " +
                                              "and not (    rsu_rtlglobals.getdepacclimitoverrundate <> " +
                                                                                 "rsu_rtlglobals.getnulldate " +
                                                       "and depos.t_open_date >= " +
                                                                   "rsu_rtlglobals.getdepacclimitoverrundate " +
                                                      ") " +
                                             ") " +
                                         ") " +
                                     "and depos.t_usealternate = rsu_rtlpercent.valueforusealternativefield " +
                                        ") initialquery) intermediatequery, " +
                         "ddepositr_dbt primarydepos, " +
                         "dpc__calc_dbt primarypccalc, " +
                         "dpc__calc_dbt overpccalc " +
                   "where primarydepos.t_referenc = intermediatequery.referenc " +
                     "and intermediatequery.pccalcenddate is not null " +
                     "and primarydepos.t_referenc = primarypccalc.t_referenc " +
                     "and primarypccalc.t_enddate = intermediatequery.pccalcenddate " +
                     "and primarypccalc.t_objecttype = rsu_rtlpercent.getobjecttype " +
                     "and primarypccalc.t_typerecord = 1 " +
                     "and overpccalc.t_referenc(+) = intermediatequery.referenc " +
                     "and overpccalc.t_enddate(+) = intermediatequery.pccalcenddate " +
                     "and overpccalc.t_objecttype(+) = 2003 " +
                     "and overpccalc.t_typerecord(+) = 1 " +
                     "and intermediatequery.nextenddate > rsu_rtlpercent.getoperationdate " +
                     ") " );

    cmd.addParam("Ground",      RSDBP_IN );   cmd.value("Ground")      = Ground;
    cmd.addParam("FieldLenght", RSDBP_IN );   cmd.value("FieldLenght") = FieldLenght;
    cmd.addParam("BeginOffset", RSDBP_IN );   cmd.value("BeginOffset") = BeginOffset;

    cmd.addParam("DayCalc",     RSDBP_IN );   cmd.value("DayCalc")     = DayCalc;
    cmd.addParam("GrafCalc",    RSDBP_IN );   cmd.value("GrafCalc")    = GrafCalc;

    cmd.addParam("TypeAccount", RSDBP_IN );   cmd.value("TypeAccount") = TypeAccount;    

    PrintTime("deoytemp_tmp begin");
    cmd.execute;
    PrintTime("deoytemp_tmp end");

    // Подсчитаем количество записей до удаления, чтобы не было потом дублирования
    cmdCountEoy = RsdCommand( "select count(*) from deoytemp_tmp" );

    cmdCountEoy.execute;
    rsCountEoy = RsdRecordset( cmdCountEoy ); 

    if ( rsCountEoy.moveNext( ) )
      countEoyRecs = Int( rsCountEoy.value( 0 ) );
    end;


    if (NeedTaxCalc)
      DeleteUnsupportedRecords(false);
    end;

    if ( flagOper72 )
      RsdCommand("update deoytemp_tmp eoy " +
                   "set t_errorcode = 29 " +
                  "where exists " +
                           "(select 1 " +
                              "from dpc__calc_dbt " +
                             "where t_referenc = eoy.t_referenc " +
                               "and t_enddate = eoy.t_nextperioddate " +
                               "and t_objecttype = rsu_rtlpercent.getobjecttype " +
                               "and t_typerecord = 1) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dpc_drest_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_date_rest > eoy.t_nextperioddate " +
                                "and t_type_object = rsu_rtlpercent.getobjecttype) " +
                     "or  exists " +
                            "(select 1 " +
                               "from ddpindebt_dbt dp " +
                              "where dp.t_branch = rsu_rtlglobals.getfncash " +
                                "and dp.t_reference = eoy.t_referenc " +
                                "and dp.t_state = 1 " +
                                "and dp.t_action not in (2, 11)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dpcestim_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_dateoperat > eoy.t_nextperioddate " +
                                "and t_action not in (2, 11)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dsb_congt_dbt " +
                              "where t_referencacc = eoy.t_referenc " +
                                "and t_gettype = rsu_rtldeposit.get_get_linkdepaccount " +
                                "and t_partaccount = rsu_rtldeposit.get_linkdepacc_perc " +
                                "and t_action not in (2, 11)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dpc__calc_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_objecttype = rsu_rtlpercent.getobjecttype " +
                                "and t_typerecord = 1 " +
                                "and t_enddate > rsu_rtlpercent.getoperationdate) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dsbdepdoc_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and (t_date_document > rsu_rtlpercent.getoperationdate " +
                                  "or  t_depdate_document > rsu_rtlglobals.getcurdate)) " +
                     "or exists " +
                           "(select 1 " +
                              "from dobjatcor_dbt oac " +
                             "where oac.t_objecttype = 3 " + // субъект экономики
                               "and oac.t_object = ltrim(to_char (eoy.t_codclient, '0000000000')) " +
                               "and oac.t_groupid = 42 ) " +  // Является плательщиком НДФЛ
                     "or eoy.t_insum < 0 "
                    ).execute;
    else
      RsdCommand("update deoytemp_tmp eoy " +
                   "set t_errorcode = 29 " +
                  "where exists " +
                           "(select 1 " +
                              "from dpc__calc_dbt " +
                             "where t_referenc = eoy.t_referenc " +
                               "and t_enddate = eoy.t_nextperioddate " +
                               "and t_objecttype = rsu_rtlpercent.getobjecttype " +
                               "and t_typerecord = 1) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dpc_drest_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_date_rest > eoy.t_nextperioddate " +
                                "and t_type_object = rsu_rtlpercent.getobjecttype) " +
                     "or  exists " +
                            "(select 1 " +
                               "from ddpindebt_dbt dp " +
                              "where dp.t_branch = rsu_rtlglobals.getfncash " +
                                "and dp.t_reference = eoy.t_referenc " +
                                "and dp.t_state = 1 " +
                                "and dp.t_action not in (2, 11)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dpcestim_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_dateoperat > eoy.t_nextperioddate " +
                                "and t_action not in (2, 11)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dsb_congt_dbt " +
                              "where t_referencacc = eoy.t_referenc " +
                                "and t_gettype = rsu_rtldeposit.get_get_linkdepaccount " +
                                "and t_partaccount = rsu_rtldeposit.get_linkdepacc_perc " +
                                "and t_action not in (2, 11)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dpc__calc_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_objecttype = rsu_rtlpercent.getobjecttype " +
                                "and t_typerecord = 1 " +
                                "and t_enddate > rsu_rtlpercent.getoperationdate) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dsbdepdoc_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and (t_date_document > rsu_rtlpercent.getoperationdate " +
                                  "or  t_depdate_document > rsu_rtlglobals.getcurdate)) " +
                     "or  exists " +
                            "(select 1 " +
                               "from dsbdepdoc_dbt " +
                              "where t_referenc = eoy.t_referenc " +
                                "and t_depdate_document > rsu_rtlpercent.getoperationdate " +
                                "and t_TypeOper = 72 " +
                                "and ( t_ApplType = 0 or t_ApplType = 1 ) " +
                                "and t_FlagStorn = chr(0) " +
                                "and t_Action <> 2 " +
                                "and t_Action <> 11) " +
                     "or exists " +
                           "(select 1 " +
                              "from dobjatcor_dbt oac " +
                             "where oac.t_objecttype = 3 " + // субъект экономики
                               "and oac.t_object = ltrim(to_char (eoy.t_codclient, '0000000000')) " +
                               "and oac.t_groupid = 42 ) " +  // Является плательщиком НДФЛ
                     "or eoy.t_insum < 0 "
                    ).execute;
    end;
    DeleteErrorRecord;

    countInsertedRecord = DefineTransactionNumber( null, countEoyRecs );

    CalcPayEstimOnlyForEoy( DateBeginPeriod - 1 );

    FillSubAccountFieldsInTemporaryTable;

    // Если надо погасить овердрафты
    if ( mode == MODE_KREDIT )
      PaymentOverdraft;

      RsdCommand( "begin rsu_rtlcard.recalcsumineoy(); end;" ).execute();
      PrintTime("rsu_rtlcard.recalcsumineoy()");
      DeleteErrorRecord;
    end;

    if (NeedTaxCalc)
      FillTaxFieldsInTemporaryTable();
    else
      // #175945
      // Если выключн флаг начиснять налог, но есть данные в налоговой карточке - то сбрасываем на штатную обработку
      RsdCommand("update deoytemp_tmp " +
                    "set t_errorcode = 28 " +
                  "where nvl (t_taxsumpay, 0) <> 0 ").execute;
      DeleteErrorRecord;
    end;

    return defineCountRecordInTable("deoytemp_tmp");;
  end; // PresetTemporaryTable


//---------------------------
  macro ProcessAll

    Predetermine;
    SetVariables;

    // Причислим проценты по 39П. Иначе может все разъехаться...
    // Перенесео внутрь формирования временной таблицы
    // CalcPayEstim( DateBeginPeriod - 1 );

    blockTable;
    // Здесь не надо учитывать валютность, так как для каждого счета мы индивидуально ищем процентную ставку
    if ( PresetTemporaryTable == 0 )
      println("Прерываем обработку, так как временная таблица пуста");      
      return;
    end;

    if( not createPMD )
      runError("Ошибка при формировании РДД");
    end;

    ProcessSbDepDoc;

    ProcessDepositrForSeveralDocs;
    ProcessPcCalc;
    ProcessPcDRestForSeveralDocs;
    ProcessRetOp(FillRetOpTran);
    ProcessOpObject;
    ProcessPcEstim;
    ProcessPcEstimForSeveralDocs;
    ProcessEdRef;

    ProcessScCrdDoc;

    if (NeedTaxCalc)
      ProcessPcTax(FillPcTaxPay);
      ProcessSbDepDoc(FillSbDepDocTax);
      UpdatePcCalcForTax(FillPcTaxPay);
      ProcessEdRef(FillEdRefTax);
      ProcessScCrdDoc(FillTaxScrdDoc);

      ProcessPcTax(FillPcTaxCalc);
      UpdatePcCalcForTax(FillPcTaxCalc);
    end;

    UpdatePcCalcForSeveralDocs(OnlyForLoans);

    InterDesk_EndDocBunch;

    PrintTime("Перед транзакцией");
    
//    RunError("Рано нам пока ишшо вставлять все в базу....");

    OnError ( e )

      PrintErrorMessage(e);
      InterDesk_EndDocBunch;
      AbortTrn();

  end; // ProcessAll


//---------------------------
  // Начало
//---------------------------


  SetOutput( nr, true );
  PrintTime("begin");
  // RTsessionActionMess( "Вклады:Прич.проц.DML" );

  TypeAccount    = pTypeAccount;
  TypeAccountExe = pTypeAccountExe;
  OrderNum       = pOrderNum;
  ObjectType     = pObjectType;
  EndDate        = pDate;

  CodeCurrency   = 0;
  FNCash         = NumFNCash;

  mode      = MODE_KREDIT;
  ProcType  = Proc_PutPerc;

  ClearTempTable;

  LoopInTrn(true);
  ProcessTrn( 0, R2M(this, "ProcessAll") );

  // RTsessionActionEnd();
  PrintTime("End");

end;




macro start(  pTypeAccount,  // Тип счета подлежащего обработке.
              pTypeAccountExe,
              pOrderNum,
              pObjectType, 
              pDate         // Дата конца периода. Обязательно.
           )

  TimeControl = false;
  rp_OnTypeAccount( pTypeAccount, pTypeAccountExe, pOrderNum, pObjectType, pDate );

end;


