/*¨é¥â ¯à®¢®¤ª¨ ¯® ¤®£®¢®àã ¯®á«¥ 19/11/2021 ¯® áç¥â ¬ 11 ¨ 21 ¨ § ¬¥­ï¥â áç¥â  ¢ ¯à®¢®¤ª å ­  á®®â¢¥âáâ¢ãîé¨¥ 17 ¨  27*/
/* ­¥ª®àà¥ªâ­ë¥ áç¥â  11 ¨ 21 § ªàë¢ ¥â ®¯¥à¤ â®© § ¯ãáª  ¯à®æ¥¤ãàë*/


import bankinter, cb_sql, dlcontrfunc;
//var num = "®¬¥à áã¡¤®£®¢®à ";
//GetString(num,"‚¢¥¤¨â¥ ­®¬¥à ¤®£®¢®à ");

const _log = false;//¢ë¢®¤¨âì ¢ «®£ ­®¬¥à  ¨§¬¥­¥­­ëå ¯à®¢®¤®ª
const _test = false;// false - ¨§¬¥­ïâì ¯à®¢®¤ª¨ ¨ § ªàë¢ âì áç¥â , true - â¥áâ®¢ë© à¥¦¨¬ - ­¥ ¨§¬¥­ïâì ¯à®¢®¤ª¨
const _rownum = -1;//ª®«¨ç¥áâ¢® ¤®£®¢®à®¢ ª®â®àë¥ á«¥¤ã¥â ¨§¬¥­¨âì. -1 - ¨§¬¥­¨âì ¢á¥
const _number = "";// "" - ¯® ¢á¥¬ ¤®£®¢®à ¬ á ãç¥â®¬ _rownum      63-15656489_ä  ‘ã¬¨­
//const _number = "63-15656489_ä";// "" - ¯® ¢á¥¬ ¤®£®¢®à ¬ á ãç¥â®¬ _rownum      63-15656489_ä  ‘ã¬¨­


var dt, dt1, dt2, trn, err = 0, fd, flag = true, count=0, countp = 0 , count1 = 0 , stat, error, cmd, fiid, deb,cred;
record InnAcc27( account );
record InnAcc17( account );


var sql1 = 
"select * from dsfcontr_dbt  sfcontr \n" +
"where  \n" +
"RSB_SECUR.GetGeneralMainObjAttr (659,LPAD (sfcontr.t_ID, 10, '0'),102, to_date('31122999','ddmmyyyy')) = 1 \n" +
"and t_dateclose = to_date('01010001','ddmmyyyy') and exists (select 1 from dmcaccdoc_dbt where t_catid = 347 and t_chapter = 21 and t_iscommon = chr(88) and  t_templnum = 1 and t_activatedate >= to_date('19112021','ddmmyyyy') and t_clientcontrid = sfcontr.t_id ) \n";
//" and t_id = 4588 " + 
if (_number != "")
   sql1=sql1+" and t_id = (select t_id from dsfcontr_dbt where t_number = '"+_number+"') ";
end;
if (_rownum != -1)
   sql1 = sql1+" and rownum <= "+_rownum;
end;

BegAction();
var n = sql_getnrecs(sql1);
EndAction;
if (n == 0 )
   println("‘ç¥â®¢ ¨ ¯à®¢®¤®ª ¤«ï ª®àà¥ªâ¨à®¢ª¨ ­¥ ­ ©¤¥­®");
end;
initprogress(n,"Ž¡à ¡®âª  ¤®£®¢®à®¢","Ž¡à ¡®âª  ¤®£®¢®à®¢");
Dt1 = TrsbDataSet(sql1);

while (Dt1.movenext())
    println ("-------------------------  " + dt1.number+ "  ---------------------------");
    var sql =  "select o.t_kind_operation, o.t_id_operation, o.t_dockind, o.t_documentid, t.*, (select distinct t_clientcontrid from dmcaccdoc_dbt where t_account = T.T_ACCOUNT_PAYER and t_chapter = 21) contrid  from dacctrn_dbt t " + 
    "   left join doprdocs_dbt d on D.T_ACCTRNID = T.T_ACCTRNID left join doproper_Dbt o on o.t_id_operation = d.t_id_operation where t_state = 1 and t_account_payer in ( \n" +
    "select t_account from dmcaccdoc_dbt where t_chapter = 21 and t_catid in ( 347, 349) and t_iscommon = chr(88) and t_activatedate >= to_date('19112021','ddmmyyyy') and t_templnum = 1  \n" +
    "and t_clientcontrid = "+string(Dt1.id)+" group by t_account  \n" +
    ") \n" +
    "and t_date_carry > to_date('19112021','ddmmyyyy') order by t_fiid_payer \n" ;
    if (sql_getnrecs(sql) == 0)
//       msgbox("¥ ­ ©¤¥­® ¯à®¢®¤®ª ¯® áâ àë¬ áç¥â ¬ ¯® ¤®£®¢®àã \"" + num +"\"");
       println("	¥ ­ ©¤¥­® ¯à®¢®¤®ª ¯® ­¥¢¥à­ë¬ áç¥â ¬");// ¯® ¤®£®¢®àã \"" + Dt1.number +"\"");
    else 

       dt = trsbdataset( sql);

       initprogress(sql_getnrecs(sql),"Ž¡­®¢«¥­¨¥ ¯à®¢®¤®ª","Ž¡­®¢«¥­¨¥ ¯à®¢®¤®ª");
       count = 0;
       countp = 0;
       flag = true;
       fiid = -1;
       while (dt.movenext())
          if (flag)
            if(_log)
               [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ ];
               [³®¬¥à         ³‘ç¥â  ¤®. „â Šâ                              ³‘ç¥â  ¯®á«¥. „â Šâ                           ³ ];
               [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ];
            end;
            FD = DL_SubContrFD(dt.ContrID);
            flag = false;
          end;
          trn = null;
          err = 0;
         // fd = null;
          trn = rsbacctransaction();

          if (dt.t_kind_operation == 2030)
             dt2 = trsbdataset("select * from DDL_ACC_DBT where t_dockind = 159 and t_id = " + string(dt.documentid));
             if (dt2.movenext())
                println("  ¥áâì ®¯¥à æ¨ï Ž‚“ ®â " + sql_convtypedate(dt2.date) + " ª®¤ " + dt2.code);
             else
                println("  ¥áâì ®¯¥à æ¨ï Ž‚“");
             end;
          else

          err = trn.find(dt.acctrnid);
          if (err == 0 )
             if (fiid != dt.fiid_payer)
                fiid = dt.fiid_payer;
                ClearRecord(InnAcc17);
                if(false == FD.OpenAccount( "„‘ Š«¨¥­â , ‚“", NULL, NULL, InnAcc17, {curdate}, dt.fiid_payer ))
                   println("	Žè¨¡ª  ¯à¨ ®âªàëâ¨¨ áç¥â  ¯® ª â¥£®à¨¨ „‘ Š«¨¥­â , ‚“");
                   err = 1;
                end;

                if(not err)
                   ClearRecord(InnAcc27);

                   if(false == FD.OpenAccount( "„‘,  áç. á ª«¨¥­â®¬, ‚“", NULL, NULL, InnAcc27, {curdate}, dt.fiid_payer ))
                     msgbox("	Žè¨¡ª  ¯à¨ ®âªàëâ¨¨ áç¥â  ¯® ª â¥£®à¨¨ „‘,  áç. á ª«¨¥­â®¬, ‚“");
                     err = 1;
                   end;
                end;
             end;
             if ((substr(trn.accountpayer,2,1) == "1") and  (substr(trn.accountreceiver,2,1) == "1"))
             if (substr(trn.accountpayer,1,2) == "11")
                deb     = innacc17.account;
             elif (substr(trn.accountpayer,1,2) == "21")
                deb     = innacc27.account;
             end;
             if (substr(trn.accountreceiver,1,2) == "11")
                cred     = innacc17.account;
             elif (substr(trn.accountreceiver,1,2) == "21")
                cred     = innacc27.account;
             end;
             if(_log)
               [³##############³##################### >> ####################³##################### >> ####################³](trn.numb_document, trn.accountpayer, trn.accountreceiver, deb, cred);             
             end;
             trn.accountpayer = deb;
             trn.accountreceiver = cred;

             if (not _test)
                if (not  trn.update())
                   println("	Žè¨¡ª  ¨§¬¥­¥­¨ï ¯à®¢®¤ª¨: "+geterrmsg());
                   else
                      countp = countp + 1;
                   end;
                end;
             end;
          end;
          end;
          useprogress(count = count + 1);
       end;
       if(_log)
          [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ ];
       end;
       println("        ‘ª®àà¥ªâ¨à®¢ ­® " +countp+ " ¯à®¢®¤®ª");
       remprogress;
    end;

    if (not _test)
    /*close acc*/
    sql = " select t_account, t_currency, t_chapter from dmcaccdoc_dbt where t_chapter = 21 and t_activatedate > to_date('19112021','ddmmyyyy') and t_disablingdate = to_date('01010001','ddmmyyyy') and t_templnum = 1  \n" +
          "and t_clientcontrid = "+string(Dt1.id)+" group by t_account , t_currency, t_chapter ";
    Dt = TRsbDataSet(sql);
    while (Dt.movenext())
       stat=CB_CloseAccount(dt.chapter, dt.currency, dt.account, {curdate} , error);
       if (error == "‹¨æ¥¢®© áç¥â ã¦¥ § ªàëâ") stat = 0; end;

       if (stat)
          println ("	Err closing acc: " + error +" : " + geterrmsg());
       else
          cmd = RSDCommand(
                        "     UPDATE dmcaccdoc_dbt " +
                        "        SET t_iscommon = chr(0), t_disablingdate = ? " + 
                        "    WHERE t_clientcontrid = ? AND t_catid in ( 347, 349) AND t_chapter = 21 and t_currency = ? and t_account = ? ;" );
          cmd.addParam("", RSDBP_IN, {curdate});
          cmd.addParam("", RSDBP_IN, dt1.id);
          cmd.addParam("", RSDBP_IN, dt.currency);
          cmd.addParam("", RSDBP_IN, dt.account);
          cmd.Execute();
          println("	‘ç¥â " +dt.account+ " ãá¯¥è­® § ªàëâ");
       end;
     end;
     end;
    /*>>*/

    useprogress(count1=count1+1);
end;
