/*
$Name: lnsFns.mac
$Module: Кредитование
$Description: API для получения данных для ФНС
*/

import RsbDataSet;

// Функции получения данных по счетам
// Param - Cтрока параметров, содержащая xml-элемент 
// ErrMsg_ - текст ошибки, не обязательный параметр
// Возвращает 0 - если нет ошибки
MACRO GetESAccount(Param, ErrMsg_:@string) : integer
   VAR stat  : integer = 0; 
   VAR ErrMsg: string  = "";
   VAR RSDcmd;

   RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNS.p_ChunkOpen; END;");
   RSDcmd.execute(); RSDcmd = NULL;

   IF (StrLen(Param) > 32000)
      FOR (VAR C, 0, INT(StrLen(Param) / 32000))
         RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNS.p_AddChunk(?); END;");
         RSDcmd.addParam("Param", RSDBP_IN, SUBSTR(Param, 1+(C*32000), 32000));
         RSDcmd.execute(); RSDcmd = NULL;
      END;
   ELSE
      RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNS.p_AddChunk(?); END;");
      RSDcmd.addParam("Param", RSDBP_IN, Param);
      RSDcmd.execute(); RSDcmd = NULL;
   END;

   RSDcmd = NULL;
   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_Loans_FNS.GetESAccount(RSO_Loans_FNS.p_chunk, ?); end;");
   RSDcmd.AddParam("stat",   RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("ErrMsg", RSDBP_OUT, V_STRING);
   RSDcmd.execute();
  
   stat = RSDcmd.value("stat", NULL, V_INTEGER);
   ErrMsg = RSDcmd.value("ErrMsg", NULL, V_STRING); 

   RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNS.p_ChunkClose(); END;");
   RSDcmd.execute();

   IF (ValType(ErrMsg_) != V_UNDEF)
      ErrMsg_ = ErrMsg;   
   END;      
       
   RETURN stat; 
END;

// функции получения данных об остатках по счетам
// Param - Cтрока параметров, содержащая xml-элемент 
// ErrMsg_ - текст ошибки, не обязательный параметр
// Возвращает 0 - если нет ошибки
MACRO GetESAccRest(Param:string, ErrMsg_:@string) : integer
   VAR stat : integer = 0; 
   VAR ErrMsg : string = "";
  
   VAR RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_Loans_FNS.GetESAccRest(?, ?); end;");
   RSDcmd.AddParam("stat",    RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("Param",   RSDBP_IN, Param);
   RSDcmd.addParam("ErrMsg",  RSDBP_OUT, V_STRING);
   RSDcmd.execute();
   
   stat = RSDcmd.value("stat", NULL, V_INTEGER);
   ErrMsg = RSDcmd.value("ErrMsg", NULL, V_STRING); 
   
   IF (ValType(ErrMsg_) != V_UNDEF)
      ErrMsg_ = ErrMsg;   
   END;      
       
   RETURN stat; 
END;

// Функции получения данных об операциях по счетам
// Param - Cтрока параметров, содержащая xml-элемент 
// ErrMsg_ - текст ошибки, не обязательный параметр
// Возвращает 0 - если нет ошибки
MACRO GetESAccTrn(Param:string, ErrMsg_:@string) : integer
   VAR stat : integer = 0; 
   VAR ErrMsg : string = "";
  
   VAR RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_Loans_FNS.GetESAccTrn(?, ?); end;");
   RSDcmd.AddParam("stat",    RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("Param",   RSDBP_IN, Param);
   RSDcmd.addParam("ErrMsg",  RSDBP_OUT, V_STRING);
   RSDcmd.execute();
   
   stat = RSDcmd.value("stat", NULL, V_INTEGER);
   ErrMsg = RSDcmd.value("ErrMsg", NULL, V_STRING); 
   
   IF (ValType(ErrMsg_) != V_UNDEF)
      ErrMsg_ = ErrMsg;   
   END;      
       
   RETURN stat; 
END;


