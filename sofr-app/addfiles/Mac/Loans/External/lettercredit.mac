/*
$Name: lettercredit.mac
$Module: Кредитование
$Description: API для работы с аккредитивом
*/

import Frc_sum;

//CreditID - ID кредитного договора
//PaySum - Сумма платежа
//CurCode - Код валюты
//Department - департамент
//DutyID - ID СО, не обязательный параметр. Если не важен, то можно передать 0
//ErrorMsg - сообщение об ошибке, не обязательный параметр.
//Возвращает 0 - если нет ошибки.
//PRJ_001643   Учет сделки по аккредитиву в Кредитовании#3 пункт 3
MACRO CheckPayCredit(CreditID: integer,PaySum : Money,CurCode : integer, Department : integer,DutyID : integer, ErrorMsg_:@string) : integer
    VAR stat: integer = 0;
    record crd     ("credit_c.dbt");
    record duty ("duty_crd.dbt");
    var ErrorMsg:string = ErrorMsg_;
    var temp;
    if (Loans_FindCrdContract(CreditID, crd)== false)   //1
        stat = 1;
        ErrorMsg = "Кредитный договор не найден"
    end;
    if ((stat == 0) and ((crd.RegDate>{curdate} )or(crd.CloseDate != date(0,0,0))))    //2
        stat = 5;
        ErrorMsg = "Выдача кредита не может быть произведена, т.к. договор не является открытым в заданную дату";
    end;
    if ((stat == 0) and (crd.CurCode != CurCode ))  //3
        stat = 2; 
        ErrorMsg = "Валюта выплаты по аккредитиву не совпадает с валютой договора";     
    end;
    if ((stat == 0) and (crd.FNCash != Department ))  //4
        stat = 3;
        ErrorMsg = "Филиал договора не совпадает с филиалом аккредитива";   
    end;
    if (stat == 0)  
        if (crd.PayType == cf_nonrep ) //5
            if ((crd.creditsum < PaySum) or (ExistsOperation(crd.Crd_kind,crd.CreditNumber,CS_PAY)==1))   //5.1
                stat = 4;
                ErrorMsg = " Суммы кредита/ лимита недостаточно для перечисления покрытия по аккредитиву ";
            end;
        else
            if ((ValType(DutyID) == V_UNDEF)or(DutyID == 0))    //5.2
                stat = 7;
                ErrorMsg = "Не передан номер срочного обязательства";
            else
                if(Loans_FindDuty(DutyID, duty)==false) //5.2.1
                    stat = 8;
                    ErrorMsg = "Не найдено срочное обязательство";
                else
                  if ((ExistsOperation(LO_DUTY,DutyID,CS_CLDUTY)==1)or(duty.DutyFirstDate >{curdate})) //5.2.1.2
                    stat = 9;
                    ErrorMsg = " Выдача кредита не может быть произведена, т.к. срочное обязательство не является открытым в заданную дату"; 
                  end;
                  if ((stat == 0) and (ОстатокРегистра( crd.Crd_kind,crd.CreditNumber, TDR_AVAILABLELIMIT, {curdate} )< PaySum)
                                       or ((duty.dutysum - ОстатокРегистра( LO_DUTY, DutyID, TDR_MAINREST, {curdate} ))< PaySum))//5.2.1.2.1
                    stat = 6;
                    ErrorMsg = " Суммы кредита/ лимита недостаточно для перечисления покрытия по аккредитиву ";
                  end;
                end;            
            end;
        end;
    end;
    if (ValType(ErrorMsg_) != V_UNDEF)
        ErrorMsg_ = ErrorMsg;   
    END;
    RETURN stat;    //6
END;
/*
//CreditID - ID кредитного договора
//PaySum - Сумма платежа
//DutyID - ID СО, не обязательный параметр. Если не важен, то можно передать 0
//ErrorMsg - сообщение об ошибке, не обязательный параметр.
//Возвращает 0 - если нет ошибки.
//PRJ_001643   Учет сделки по аккредитиву в Кредитовании#3 пункт 4
MACRO PayLetterCredit(CreditID: integer,PaySum : Money,DutyID : integer, ErrorMsg_:@string) : integer
    VAR stat: integer = 0;
    var ErrorMsg:string = ErrorMsg_;
    var DutyID_:integer;
    var rs = NULL;
    var TypeOperNumber = -1;
    var PayAcc:string = "";
    record crd     ("credit_c.dbt");
    
    if (ValType(DutyID) == V_UNDEF)
        DutyID_ = 0;
    else
        DutyID_ = DutyID;
    END;
    
    if (Loans_FindCrdContract(CreditID, crd)== false)   //1
        stat = 1;
        ErrorMsg = "Кредитный договор не найден"
    end;    
    if (stat == 0)
        rs = LnGetRecordSet("select igsetacc.t_account"+
                            " from DIGSETACC_DBT  igsetacc, digcrdacc_dbt igcrdacc" +
                            " where" +
                            " igsetacc.T_SETTACCID  = igcrdacc.t_setaccid" +
                            " and igcrdacc.t_typeaccid = 1" 
                            " and igcrdacc.t_creditnumber = " + CreditID +
                            " and igcrdacc.t_usepriority = 1");
        IF (rs == NULL)  RETURN 0;    END;
        IF (rs.MoveNext())
            PayAcc = rs.value(0);
        else 
            stat = 2;
            ErrorMsg = "Не найден счет СПИ";
        END;
    END;
    if (stat == 0)
        TypeOperNumber = GetTypeDefOpr(LO_CREDIT,CreditID,CS_PAY,1);
    END;
    
    if ((stat == 0)and (TypeOperNumber!=-1))
    var ObjectID;
    var ObjectNum;
    if (DutyID_ == 0)
        ObjectID = lo_credit;
        ObjectNum = CreditID;
    else
        ObjectID = lo_duty;
        ObjectNum = DutyID_;    
    end;
        var operationID = MakeOperation(ObjectNum, ObjectID, TypeOperNumber, crd.CurCode, {curdate}, 0, PayAcc, "",PaySum);
        if (operationID == 0)
            if(GetMO_ErrorID != 0)
                stat = GetMO_ErrorID;
                ErrorMsg = GetMO_LoansError;
            else
                ErrorMsg = "Во время выполнения операции по кредитному договору произошла непредвиденная ошибка!";
                stat = 18212;
            end;
        end;
	end;
    
    if (ValType(ErrorMsg_) != V_UNDEF)
        ErrorMsg_ = ErrorMsg;   
    END;
    RETURN stat;    
END;
*/