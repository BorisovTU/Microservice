/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : PercAdvB.mac
 Description : макрос разноски пакетной операции причисления %

 Programmer  : Manushkina E.V.
 2008-06-23  : Создан
-----------------------------------------------------------------------------------*/

import "percsum.mac", "total.mac";

private var payment_tmp = tbfile ("payment.tmp", "rw", 0);

// формирование номера объекта в скроллинге отобранных ДД (вызывается в make)
macro NameObject (buff)

   record Credit("credit_c.dbt", "loans.def");
   record Duty("duty_crd.dbt", "loans.def");
   record payment ("payment.tmp");

   SetBuff(payment, buff);

   if ((payment.ObjID == LO_CREDIT) OR
       (payment.ObjID == LO_KARTA)  OR
       (payment.ObjID == LO_GUARANTEE) OR
       (payment.ObjID == LO_OVERDRAFT) OR
       (payment.ObjID == LO_DEPOSIT)) 
      if (Loans_FindCrdContract(payment.ObjN, Credit))
         if(payment.ObjID == LO_CREDIT)
            return "КД № "+Credit.UsCreditNumber;
         elif(payment.ObjID == LO_KARTA)
            return "БК № "+Credit.UsCreditNumber;
         elif(payment.ObjID == LO_GUARANTEE)
            return "БГ № "+Credit.UsCreditNumber;
         elif(payment.ObjID == LO_OVERDRAFT)
            return "ОВ № " + Credit.UsCreditNumber;
         elif (payment.ObjID == LO_DEPOSIT)
            return "ДД № " + Credit.UsCreditNumber;
         end;
      end;
   elif (payment.ObjID == LO_DUTY)
      if (Loans_FindDuty(payment.ObjN, Duty))
         if (Loans_FindCrdContract(Duty.CreditNumber_Ref, Credit))
            return "КД №" + Credit.UsCreditNumber + ", СО №" + Duty.UserNumber; /*String(Duty.UserNumber);*/
         end;
      end;
   end;
   return "";
end;

// заполнение файла dpayment_tmp
macro FillFileGroup (
   OpType    : integer,
   OpDate    : date,
   CalcDate  : date,
   OpCurr    : integer,
   FNCash    : integer,
   SMAString : string
)
   var RSDcmd = RsdCommand(RslDefCon, "begin Loansfillpayment.RSO_FillPayForBatchPercAdvOp (?,?,?,?,?,?); end;");
    
   BegAction (1, "Формирование списка задолженности. Ждите, это может занять несколько минут.", false);

   RSDcmd.addParam ("OpType",    RSDBP_IN); RSDcmd.value("OpType")    = OpType;
   RSDcmd.addParam ("OpDate",    RSDBP_IN); RSDcmd.value("OpDate")    = OpDate;
   RSDcmd.addParam ("CalcDate",  RSDBP_IN); RSDcmd.value("CalcDate")  = CalcDate;
   RSDcmd.addParam ("OpCurr",    RSDBP_IN); RSDcmd.value("OpCurr")    = OpCurr;
   RSDcmd.addParam ("FNCash",    RSDBP_IN); RSDcmd.value("FNCash")    = FNCash;
   RSDcmd.addParam ("SMAString", RSDBP_IN); RSDcmd.value("SMAString") = SMAString;
   RSDcmd.execute();

   EndAction (1);
end;

// засчет видов задолженности
macro CalcPercentGroup (OpDate:date)
   CalcGroupPercent(OpDate, OpDate, 0);
end;

macro FillFileGroupOther (OpDate:date, CalcDate:date)
   /*payment_tmp.rewind;
   WHILE (payment_tmp.next)
       payment_tmp.rec.EndDate = CalcDate;
       payment_tmp.update;
   END;*/
end;
