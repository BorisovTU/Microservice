/*
$Name:         fcdepemp.mac
$Module:       Кредитование
$Description:  Макрос расчета данных для представления ORMLNSCOSTDEPEMP (RS-VOX) 
*/

IMPORT total; 

// Типы ПСВ
const MAIN_PSV = 0;   // основной ПСВ 
const ADD_PSV_1 = 1;  // дополнительный ПСВ_1
const ADD_PSV_2 = 2;  // дополнительный ПСВ_2
const ADD_PSV_3 = 3;  // дополнительный ПСВ_3

record calcgpay ("lgpayop.dbt",  "loans.def"); 
file   График ("plan_pay.tmp", "loans.def") write; 
record Договор ("credit_c.dbt", "loans.def");
record Обязательство ("duty_crd.dbt", "loans.def"); 
record rlcusrate("lcusrate.dbt", "loans.def");

private VAR  planpay_tmp  = TBFile ("planpay.tmp",  "w", 1, "planpay.tmp",  "loans.def");

// ДЕПОЗИТЫ: график выплаты/причисления %%
MACRO CalcGraphDepPerc (ObjType, ObjNum, GraphTreeID, Trff_SpVarID, RateVal, BegDate, EndDate:date)       
   VAR BegDateCalcPerc : date    = date (0,0,0); // дата начала расчета поцентов
   VAR lcusreg  = TRecHandler("lcusreg.dbt");
   const LRSDBP_IN_OUT = 3; // Замена отсутствующему RSDBP_IN_OUT
   VAR RSDcmd = null, RSDcmd2 = null;
   VAR RoundOffError: NUMERIC = $0.0;        
   VAR RateID:integer = 0;
   VAR stat = 0;              
   VAR lastentrynotbeforevalue:string = ""; 
   VAR lastentrynotlatervalue:string = "";
   VAR PercentSum : numeric = $0.0;     
   VAR daymonth = 0; // по числам месяца 
   VAR day, mon, year; 
   VAR retval = 0;  

   LnSqlExec("DELETE FROM DGRAPHKINDPARM_TMP");
   LnSqlExec("DELETE FROM DGRAPHTREEPARM_TMP");
   LnSqlExec("DELETE FROM DGRAPHOBJECT_TMP");

   VAR GraphObjID  = CRSDCommand ("SELECT GOBJ.T_ID "
                                    "FROM DGRAPHOBJECT_dbt gobj "
                                    "JOIN DGRAPHTREEPARM_dbt gtree ON ( GTREE.T_GRAPHOBJECT_ID_REF =  GOBJ.T_ID) "
                                   "WHERE GTREE.T_ID = ?",
                            "GraphTreeID",  GraphTreeID,                                                           
                            V_INTEGER);   

   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN ? := RSI_LOANSGRAPHKIND.FillTable(?); END;");
   RSDcmd1.addParam("rv",           RSDBP_OUT, retval); 
   RSDcmd1.addParam("GraphObjID",   RSDBP_IN); RSDcmd1.value("GraphObjID") = GraphObjID;   
   RSDcmd1.execute(); 

   VAR gKindParm = CRSDCommand ("SELECT * FROM DGRAPHKINDPARM_TMP WHERE T_GRAPHTREEPARM_ID_REF = ?",
                                "GraphTreeID",  GraphTreeID,                             
                                V_GENOBJ  );

   IF(gKindParm.MoveNext() == 0) // параметры не найдены
      stat = 1;
   END;

   IF (gKindParm.Value("T_LASTENTRYNOTBEFOREFLAG") == "X")        
      lastentrynotbeforevalue = gKindParm.Value("T_LASTTENTRYNOTBEFOREVALUE");
   ELSE        
      lastentrynotbeforevalue = EndDate;
   END;

   IF (gKindParm.Value("T_LASTENTRYNOTLATERFLAG") == "X")        
      lastentrynotlatervalue = gKindParm.Value("T_LASTENTRYNOTLATERVALUE");
   ELSE        
      lastentrynotlatervalue = EndDate;
   END;

   RSDcmd2 = RsdCommand(RslDefCon, "UPDATE DGRAPHKINDPARM_TMP "
                                      "SET T_FIRSTENTRYNOTBEFOREFLAG = CHR(0), " // отключим ограничение "Первая запись"
                                          "T_FIRSTENTRYNOTLATERFLAG = CHR(0), "  // отключим ограничение "Первая запись
                                          "T_LASTENTRYNOTBEFOREFLAG = 'X', "  // включим ограничение "Последняя запись(не ранее)", чтобы с помощью ограничения задать дату окончания графика
                                          "T_LASTTENTRYNOTBEFOREVALUE = ?, "  
                                          "T_LASTENTRYNOTLATERFLAG = 'X', "  // включим ограничение "Последняя запись(не позднее)", чтобы с помощью ограничения задать дату окончания графика
                                          "T_LASTENTRYNOTLATERVALUE = ? "                                                                                    
                                    "WHERE T_GRAPHTREEPARM_ID_REF = ?");      
   RSDcmd2.addParam("lastentrynotbeforevalue", RSDBP_IN, lastentrynotbeforevalue); 
   RSDcmd2.addParam("lastentrynotlatervalue",  RSDBP_IN, lastentrynotlatervalue);      
   RSDcmd2.addParam("GraphTreeID",             RSDBP_IN, GraphTreeID);  
   RSDcmd2.execute(); 

   LnSqlExec("DELETE FROM dplan_pay_tmp"); 
   LnSqlExec("DELETE FROM DLGPAYOP_TMP");  
   LnSqlExec("DELETE FROM DPLANLINK_TMP");  
       
   // Обнулим контекст графика      
   LnSqlExec("BEGIN LoansFillpayment.Clear_ContextGraph; END;");      
                    
   VAR RSDcmd10 = RsdCommand(RslDefCon, "BEGIN LoansFillpayment.PUT_ContextGraph(NULL, ?, ?); END;");      
   RSDcmd10.addParam("RateVal",      RSDBP_IN, RateVal);
   RSDcmd10.addParam("Trff_SpVarID", RSDBP_IN, Trff_SpVarID);  
   RSDcmd10.execute();

   VAR RSDcmd4 = RsdCommand(RslDefCon, "BEGIN ?:= RSI_LOANSGRAPHKIND.CalcPlanPay(?, ?, ?, ?, ?, ?); END;");
      RSDcmd4.addParam("retval", RSDBP_OUT, stat); 
      RSDcmd4.addParam("ObjID",           RSDBP_IN, ObjType);
      RSDcmd4.addParam("ObjN",            RSDBP_IN, ObjNum);
      RSDcmd4.addParam("GraphKindIdRef",  RSDBP_IN, GraphTreeID);
      RSDcmd4.addParam("OperDate",        RSDBP_IN, BegDate);
      RSDcmd4.addParam("ContextB",        RSDBP_IN, 0);
      RSDcmd4.addParam("ContextType",     RSDBP_IN, 0);
      RSDcmd4.execute();

   // Обнулим контекст графика      
   LnSqlExec("BEGIN LoansFillpayment.Clear_ContextGraph; END;");
END; 

/*
Процедура заполняет данные DCOSTDEPEMP_TMP для объекта ORMLNSCOSTDEPEMP (RS-VOX)
Входные параметры:
  BegDate  -  Дата начала отчетного периода
  EndDate  -  Дата окончания отчетного периода
  StrCond  -  Условия      */
MACRO FillCostDepEmp(BeginDate:date, EndDate:date, ObjN:INTEGER)
  var qCrd: object = null;
  VAR ratevalDP:double = 0;  // значение ставки тарифа "Проценты по депозиту"
  VAR dateCalcPSV:date;      // дата расчета ПСВ
  VAR dateBegGraph:date;     // дата начала периода, для которого рассчитывается график
  VAR dateEndGraph:date;     // дата окончания периода, для которого рассчитывается график
  VAR D:money = 0;           // Сумма депозита 
  VAR DurDepDay = 0;         // Срок депозита в днях   
  VAR TypeGraph = 0;         // Вид графика (график выплат или причислений) 
  VAR GraphTreeID:integer = 0;    // ID графика
 
  LnSqlExec("delete from DCOSTDEPEMP_TMP");

  // Зададим значения глобальной переменной "Дата начала отчетного периода" для возможности использования их в функциях спецпеременных
  VAR RSDbd = RsdCommand (RslDefCon, "BEGIN RSI_SpVariable_Func.BeginDateRep := ?; END;");
      RSDbd.addParam ("BeginDateRep",  RSDBP_IN);    RSDbd.value ("BeginDateRep")  = BeginDate; 
      RSDbd.execute (); 
 
  // Зададим значения глобальной переменной "Дата окончания отчетного периода" для возможности использования их в функциях спецпеременных 
  VAR RSDed = RsdCommand (RslDefCon, "BEGIN RSI_SpVariable_Func.EndDateRep := ?; END;");
      RSDed.addParam ("EndDateRep",  RSDBP_IN);    RSDed.value ("EndDateRep")  = EndDate; 
      RSDed.execute ();   
  
  qCrd = CRSDCommand (" SELECT C.* " 
                            "FROM DCREDIT_C_DBT C, dpersn_dbt psn, DFININSTR_DBT fi "
                           "WHERE C.T_CRD_KIND = 28 "  // LO_DEPOSIT
                             "AND (C.T_CREDITNUMBER = ? OR 0 = ?) "  // LO_DEPOSIT 
                             "AND C.T_CURCODE = FI.T_FIID "      
                             "AND FI.T_CCY IN ('RUB', 'USD', 'EUR') "         
                             "AND PSN.T_PERSONID = C.T_CLIENTID_REF "
                             "AND PSN.T_ISEMPLOYER = 'X' "
                             "AND EXISTS  "
                                       "(SELECT 1  "
                                          "FROM VCRE_CRDOP_DBT "
                                         "WHERE T_OBJECTTYPEID_REF = C.T_CRD_KIND "
                                           "AND T_OBJECTID_REF = C.T_CREDITNUMBER "
                                           "AND T_SYSTEMOPERATIONID IN (59, 26, 29) " // CS_DEPO_PROL, CS_NEWCRD, CS_RATE
                                           "AND T_CREDOPERDATE BETWEEN ?  AND ?) ",
                            "ObjN1",  ObjN,
                            "ObjN2",  ObjN,
                            "BegDate", BeginDate, 
                            "EndDate", EndDate, 
                            V_GENOBJ   );

   WHILE (qCrd.MoveNext())
    // Расчет основного ПСВ (MAIN_PSV) 
    ClearRecord(calcgpay);
    ClearRecord(Договор); 

    Loans_FindCrdContract(qCrd.Value("T_CREDITNUMBER"), Договор);

    VAR qParmDep = CRSDCommand ("SELECT * FROM DPARMDEPO_DBT WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ? ",
                             "ObjID",  qCrd.Value("T_CRD_KIND"),
                             "ObjN",   qCrd.Value("T_CREDITNUMBER"),
                             V_GENOBJ  );

    IF(qParmDep.MoveNext() == 0)
      CONTINUE;
    END;
        
    dateCalcPSV = CRSDCommand("SELECT MAX(T_CREDOPERDATE) "
                                 "FROM VCRE_CRDOP_DBT "
                                "WHERE T_OBJECTTYPEID_REF =  ?  "
                                  "AND T_OBJECTID_REF  = ? "          
                                  "AND T_SYSTEMOPERATIONID IN (26, 29, 59) "  // loansConst.CS_NEWCRD, loansConst.CS_RATE, loansConst.CS_DEPO_PROL                                
                                  "AND T_CREDOPERDATE BETWEEN ?  AND ?",                                        
                          "CRD_KIND",     qCrd.Value("T_CRD_KIND") ,
                          "CREDITNUMBER", qCrd.Value("T_CREDITNUMBER"),
                          "BeginDate",    BeginDate,
                          "EndDate",      EndDate,
            V_DATE);
    
    dateBegGraph = dateCalcPSV;
    
    IF(qParmDep.Value("T_ADDPERCENT") == "X")
       TypeGraph = 7; // график причисления (GR_CHARGEABILITY)
    ELSE       
       TypeGraph = 6; // график выплат (GR_PAYMENTS)
    END;
    
    GraphTreeID = CRSDCommand ("SELECT GTREE.T_ID "
                                 "FROM DGRAPHOBJECT_DBT gobj "
                                  "JOIN DGRAPHTREEPARM_DBT gtree ON (GTREE.T_GRAPHOBJECT_ID_REF = GOBJ.T_ID) "                             
                                 "WHERE GOBJ.T_OBJECTID = ? "
                                   "AND GOBJ.T_OBJECTNUMBER =  ? "  
                                   "AND GTREE.T_GRAPHKIND_ID_REF = ? ",
                             "ObjID",  qCrd.Value("T_CRD_KIND"),
                             "ObjN",   qCrd.Value("T_CREDITNUMBER"),
                             "TypeGraph", TypeGraph, 
                             V_INTEGER);

    // Ищем значение ставки тарифа <Проценты по депозиту> за дату расчета ПСВ    
    VAR RSDRate = RsdCommand (RslDefCon, "BEGIN ?:= RSI_Loans_TrffAlg.GetTrffRate(?,?,?,?,?,?); END;");
    RSDRate.addParam("RetVal",      RSDBP_RETVAL, V_NUMERIC); 
    RSDRate.addParam ("ObjId",     RSDBP_IN);      RSDRate.value ("ObjId")       = qCrd.Value("T_CRD_KIND");
    RSDRate.addParam ("ObjN",      RSDBP_IN);      RSDRate.value ("ObjN")        = qCrd.Value("T_CREDITNUMBER");
    RSDRate.addParam ("TrffType",   RSDBP_IN);     RSDRate.value ("TrffType")    = TRU_DEPOPERC;
    RSDRate.addParam ("CalcDate",   RSDBP_IN);     RSDRate.value ("CalcDate")    = dateCalcPSV;
    RSDRate.addParam ("TrffValID", RSDBP_IN);      RSDRate.value ("TrffValID")   = 0;
    RSDRate.addParam ("ContextType",   RSDBP_IN);  RSDRate.value ("ContextType") = 0; 
    RSDRate.execute ();

    ratevalDP = RSDRate.value ("RetVal");
    
    // Получим сумму депозита D для основного ПСВ
    VAR RSDcmdD = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcD(?, ?, ?, ?); end;");
    RSDcmdD.addParam("RetVal",      RSDBP_RETVAL, V_MONEY); 
    RSDcmdD.addParam ("ObjId",     RSDBP_IN);    RSDcmdD.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
    RSDcmdD.addParam ("ObjN",      RSDBP_IN);    RSDcmdD.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
    RSDcmdD.addParam ("TypePSV",   RSDBP_IN);    RSDcmdD.value ("TypePSV")   = MAIN_PSV;
    RSDcmdD.addParam ("CalcDate",   RSDBP_IN);    RSDcmdD.value ("CalcDate") = dateCalcPSV;
    RSDcmdD.execute ();

    D = SQL_NVL(RSDcmdD.value ("RetVal"), V_MONEY); 

    IF((Договор.PayType == CF_DEPOSIT) OR (Договор.PayType == CF_DEPOREPLEN))
      calcgpay.PERC_PlanLastDate = Договор.ReturnDate;
    ELSE
      calcgpay.PERC_PlanLastDate = DateAfterCalenMonths(dateBegGraph, 12); 
    END;
    
    dateEndGraph = qCrd.Value("T_RETURNDATE");
    CalcGraphDepPerc(LO_DEPOSIT, qCrd.Value("T_CREDITNUMBER"), GraphTreeID, 170, ratevalDP, dateBegGraph, qCrd.Value("T_RETURNDATE"));      

    VAR RSDcmd = RsdCommand (RslDefCon, "begin LoansVox.InsertRecCostDepEmp(?, ?, ?, ?, ?); end;");
    RSDcmd.addParam ("ObjId",     RSDBP_IN);    RSDcmd.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
    RSDcmd.addParam ("ObjN",      RSDBP_IN);    RSDcmd.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
    RSDcmd.addParam ("TypePSV",   RSDBP_IN);    RSDcmd.value ("TypePSV")   = MAIN_PSV;
    RSDcmd.addParam ("BeginDate", RSDBP_IN);    RSDcmd.value ("BeginDate") = BeginDate;
    RSDcmd.addParam ("EndDate",   RSDBP_IN);    RSDcmd.value ("EndDate")   = EndDate;
    RSDcmd.execute ();

    //********************************************************************************************************************
    // Определим, сложная ли ставка тарифа "Процент по депозиту"   
    VAR rateTypeDP:integer = 0;   // 1-простая, 2-плавающая, 3-сложная
    rateTypeDP = CRSDCommand("SELECT DECODE (TRFV.T_ISCONDITIONAL,  'X', 3, "
                                     "DECODE(TRFV.T_ISFLOATINGRATE, 'X', 2, 1))  "                
                             "FROM DTRFFVALUE_DBT trfv, DLCHISTRY_DBT lch , DLCUSRATE_DBT lcr "
                            "WHERE LCR.T_OBJECTID_REF = ? "
                              "AND LCR.T_CREDOBJID_REF = ? "
                              "AND LCR.T_TYPERATEID_REF = 24 "  // TRU_DEPOPERC
                              "AND LCR.T_RATEID_REF = LCH.T_RATEID_REF "
                              "AND LCH.T_RATEDATE = (SELECT MAX(T_RATEDATE) "
                                                      "FROM DLCHISTRY_DBT "
                                                     "WHERE T_RATEID_REF = LCH.T_RATEID_REF "
                                                       "AND T_RATEDATE <= ?) "                                                 
                              "AND TRFV.T_TYPEPARENT = 1 "
                              "AND TRFV.T_PARENTID = LCH.T_ID "
                              "AND ROWNUM = 1 "
                            "ORDER BY LCH.T_CREDOPERID_REF ASC ",                                        
                        "CRD_KIND",     qCrd.Value("T_CRD_KIND") ,
                        "CREDITNUMBER", qCrd.Value("T_CREDITNUMBER"),
                        "DATECALCPSV",  dateCalcPSV,
            V_INTEGER);

    VAR TrfDependSum:integer = 0; // Флаг зависимости сложной тарифа "Процент по депозиту" от суммы 
    IF(rateTypeDP == 3) // сложная ставка        
      TrfDependSum = CRSDCommand("SELECT DECODE(COUNT(1), 0, 0, 1) "
                                   "FROM DLCHRTPRM_DBT lhprm, dtrffvalue_dbt trfv,  DLCHISTRY_DBT lch, DLCUSRATE_DBT lcr "
                                  "WHERE lhprm.T_TRFFVALUEID = trfv.T_TRFFVALUEID "
                                    "AND LHPRM.T_TYPECONDITION = 3 "  // тип условия "Сумма"    
                                    "AND trfv.T_TYPEPARENT = 1 "
                                    "AND trfv.T_PARENTID = LCH.T_ID "
                                    "AND LCH.T_RATEDATE = (SELECT MAX(T_RATEDATE) "
                                                            "FROM DLCHISTRY_DBT "
                                                           "WHERE T_RATEID_REF = LCH.T_RATEID_REF "
                                                             "AND T_RATEDATE <= TO_DATE( '28.02.2020', 'DD.MM.YYYY' )) "
                                    "AND LCH.T_RATEID_REF = LCR.T_RATEID_REF "
                                    "AND LCR.T_OBJECTID_REF = ? "
                                    "AND LCR.T_CREDOBJID_REF = ? "
                                    "AND LCR.T_TYPERATEID_REF = 24 ", // TRU_DEPOPERC                                        
                        "CRD_KIND",     qCrd.Value("T_CRD_KIND") ,
                        "CREDITNUMBER", qCrd.Value("T_CREDITNUMBER"),
                        "DATECALCPSV",  dateCalcPSV,
            V_INTEGER);
    END;    

    // Расчет дополнительного ПСВ типа ADD_PSV_1
    IF((qCrd.Value("T_PAYTYPE") == CF_DEPOREPLEN) AND (rateTypeDP == 3) AND (TrfDependSum == 1))
       // Получим сумму депозита D1 для ПСВ_1
       VAR RSDcmdD1 = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcD(?, ?, ?, ?); end;");
       RSDcmdD1.addParam ("RetVal",    RSDBP_RETVAL, V_MONEY); 
       RSDcmdD1.addParam ("ObjId",     RSDBP_IN);    RSDcmdD1.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDcmdD1.addParam ("ObjN",      RSDBP_IN);    RSDcmdD1.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDcmdD1.addParam ("TypePSV",   RSDBP_IN);    RSDcmdD1.value ("TypePSV")   = ADD_PSV_1;
       RSDcmdD1.addParam ("CalcDate",  RSDBP_IN);    RSDcmdD1.value ("CalcDate")  = dateCalcPSV; 
       RSDcmdD1.execute ();

       VAR D1 = SQL_NVL(RSDcmdD1.value ("RetVal"), V_MONEY);  // Срок депозита для ПСВ_1

       // Получим срок депозита
       VAR RSDDur1 = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcDm(?, ?, ?, ?); end;");
       RSDDur1.addParam("RetVal",     RSDBP_RETVAL, V_INTEGER); 
       RSDDur1.addParam ("ObjId",     RSDBP_IN);    RSDDur1.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDDur1.addParam ("ObjN",      RSDBP_IN);    RSDDur1.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDDur1.addParam ("TypePSV",   RSDBP_IN);    RSDDur1.value ("TypePSV")   = ADD_PSV_1;
       RSDDur1.addParam ("CalcDm",    RSDBP_IN);    RSDDur1.value ("CalcDm")    = dateCalcPSV;        
       RSDDur1.execute ();

       VAR DurDepDay1 = SQL_NVL(RSDDur1.value ("RetVal"), V_INTEGER);        

       VAR RSDRate1 = RsdCommand (RslDefCon, "BEGIN ?:= LoansVox.GetTrffValPSVDur(?,?,?,?); END;");
       RSDRate1.addParam("RetVal",         RSDBP_RETVAL, V_NUMERIC); 
       RSDRate1.addParam ("ObjId",         RSDBP_IN);    RSDRate1.value ("ObjId")       = qCrd.Value("T_CRD_KIND");
       RSDRate1.addParam ("ObjN",          RSDBP_IN);    RSDRate1.value ("ObjN")        = qCrd.Value("T_CREDITNUMBER");
       RSDRate1.addParam ("CalcDate",      RSDBP_IN);    RSDRate1.value ("CalcDate")    = dateCalcPSV;
       RSDRate1.addParam ("DurDep",        RSDBP_IN);    RSDRate1.value ("DurDep")      = DurDepDay1; 
       RSDRate1.execute ();
    
       ratevalDP = RSDRate1.value ("RetVal");
       
       dateEndGraph = qCrd.Value("T_RETURNDATE");
       CalcGraphDepPerc(LO_DEPOSIT, qCrd.Value("T_CREDITNUMBER"), 172, D1, ratevalDP, dateBegGraph, dateEndGraph);
           
       VAR RSDcmd1 = RsdCommand (RslDefCon, "begin LoansVox.InsertRecCostDepEmp(?, ?, ?, ?, ?); end;");
       RSDcmd1.addParam ("ObjId",     RSDBP_IN);    RSDcmd1.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDcmd1.addParam ("ObjN",      RSDBP_IN);    RSDcmd1.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDcmd1.addParam ("TypePSV",   RSDBP_IN);     RSDcmd1.value ("TypePSV")  = ADD_PSV_1;
       RSDcmd1.addParam ("BeginDate", RSDBP_IN);    RSDcmd1.value ("BeginDate") = BeginDate;
       RSDcmd1.addParam ("EndDate",   RSDBP_IN);    RSDcmd1.value ("EndDate")   = EndDate; 
       RSDcmd1.execute ();
    END;

    //******************************************************************************************************************* 
    VAR TrfDependDur:integer = 0; // Флаг зависимости сложной тарифа "Процент по депозиту" от срока 
    IF(rateTypeDP == 3) // сложная ставка        
      TrfDependDur = CRSDCommand("SELECT DECODE(COUNT(1), 0, 0, 1) "
                                   "FROM DLCHRTPRM_DBT lhprm, dtrffvalue_dbt trfv,  DLCHISTRY_DBT lch, DLCUSRATE_DBT lcr "
                                  "WHERE lhprm.T_TRFFVALUEID = trfv.T_TRFFVALUEID "
                                    "AND LHPRM.T_TYPECONDITION = 1 "  // тип условия "Срок"    
                                    "AND trfv.T_TYPEPARENT = 1 "
                                    "AND trfv.T_PARENTID = LCH.T_ID "
                                    "AND LCH.T_RATEDATE = (SELECT MAX(T_RATEDATE) "
                                                            "FROM DLCHISTRY_DBT "
                                                           "WHERE T_RATEID_REF = LCH.T_RATEID_REF "
                                                             "AND T_RATEDATE <= TO_DATE( '28.02.2020', 'DD.MM.YYYY' )) "
                                    "AND LCH.T_RATEID_REF = LCR.T_RATEID_REF "
                                    "AND LCR.T_OBJECTID_REF = ? "
                                    "AND LCR.T_CREDOBJID_REF = ? "
                                    "AND LCR.T_TYPERATEID_REF = 24 ", // TRU_DEPOPERC                                        
                        "CRD_KIND",     qCrd.Value("T_CRD_KIND") ,
                        "CREDITNUMBER", qCrd.Value("T_CREDITNUMBER"),
                        "DATECALCPSV",  dateCalcPSV,
            V_INTEGER);
    END; 

    // Расчет дополнительного ПСВ типа ADD_PSV_2 
    IF((qCrd.Value("T_PAYTYPE") == CF_DEPOPOSTERESTANTE) AND (rateTypeDP == 3) AND (TrfDependDur = 1))
       // Получим сумму депозита D2 для ПСВ_2
       VAR RSDcmdD2 = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcD(?, ?, ?, ?); end;");
       RSDcmdD2.addParam ("RetVal",    RSDBP_RETVAL, V_MONEY); 
       RSDcmdD2.addParam ("ObjId",     RSDBP_IN);    RSDcmdD2.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDcmdD2.addParam ("ObjN",      RSDBP_IN);    RSDcmdD2.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDcmdD2.addParam ("TypePSV",   RSDBP_IN);    RSDcmdD2.value ("TypePSV")   = ADD_PSV_2;
       RSDcmdD2.addParam ("CalcDate",  RSDBP_IN);    RSDcmdD2.value ("CalcDate")  = dateCalcPSV;
       RSDcmdD2.execute ();

       VAR D2 = SQL_NVL(RSDcmdD2.value ("RetVal"), V_MONEY);  // Срок депозита для ПСВ_2

       // Получим срок депозита
       VAR RSDDur2 = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcDm(?, ?, ?, ?); end;");
       RSDDur2.addParam("RetVal",     RSDBP_RETVAL, V_INTEGER); 
       RSDDur2.addParam ("ObjId",     RSDBP_IN);    RSDDur2.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDDur2.addParam ("ObjN",      RSDBP_IN);    RSDDur2.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDDur2.addParam ("TypePSV",   RSDBP_IN);    RSDDur2.value ("TypePSV")   = ADD_PSV_2;
       RSDDur2.addParam ("CalcDm",   RSDBP_IN);     RSDDur2.value ("CalcDm")    = dateCalcPSV; 
       RSDDur2.execute ();

       VAR DurDepDay2 = SQL_NVL(RSDDur2.value ("RetVal"), V_INTEGER);       

       VAR RSDRate2 = RsdCommand (RslDefCon, "BEGIN ?:= RSI_Loans_TrffAlg.GetTrffValPSVMax(?,?,?); END;");
       RSDRate2.addParam("RetVal",         RSDBP_RETVAL, V_NUMERIC); 
       RSDRate2.addParam ("ObjId",         RSDBP_IN);    RSDRate2.value ("ObjId")       = qCrd.Value("T_CRD_KIND");
       RSDRate2.addParam ("ObjN",          RSDBP_IN);    RSDRate2.value ("ObjN")        = qCrd.Value("T_CREDITNUMBER");
       RSDRate2.addParam ("CalcDate",      RSDBP_IN);    RSDRate2.value ("CalcDate")    = dateCalcPSV;
       RSDRate2.execute ();
    
       ratevalDP = RSDRate2.value ("RetVal");
       
       dateEndGraph = dateBegGraph + DurDepDay2;
       CalcGraphDepPerc(LO_DEPOSIT, qCrd.Value("T_CREDITNUMBER"), 0, 170, ratevalDP, dateBegGraph, dateEndGraph) ;
           
       VAR RSDcmd2 = RsdCommand (RslDefCon, "begin LoansVox.InsertRecCostDepEmp(?, ?, ?, ?, ?); end;");
       RSDcmd2.addParam ("ObjId",     RSDBP_IN);    RSDcmd2.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDcmd2.addParam ("ObjN",      RSDBP_IN);    RSDcmd2.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDcmd2.addParam ("TypePSV",   RSDBP_IN);    RSDcmd2.value ("TypePSV")   = ADD_PSV_2;      
       RSDcmd2.addParam ("BeginDate", RSDBP_IN);    RSDcmd2.value ("BeginDate") = BeginDate;
       RSDcmd2.addParam ("EndDate",   RSDBP_IN);    RSDcmd2.value ("EndDate")   = EndDate; 
       RSDcmd2.execute ();     
    END;

   //**********************************************************************************************************************
    VAR existRateDPA:integer = 0;  // задана ли по договору ставка "Проценты при досрочном расторжении договора" 
    existRateDPA = CRSDCommand("SELECT 1 "                
                             "FROM DTRFFVALUE_DBT trfv, DLCHISTRY_DBT lch , DLCUSRATE_DBT lcr "
                            "WHERE LCR.T_OBJECTID_REF = ? "
                              "AND LCR.T_CREDOBJID_REF = ? "
                              "AND LCR.T_TYPERATEID_REF = 26 "  // TRU_DEPOPERCADV
                              "AND LCR.T_RATEID_REF = LCH.T_RATEID_REF "
                              "AND LCH.T_RATEDATE = (SELECT MAX(T_RATEDATE) "
                                                      "FROM DLCHISTRY_DBT "
                                                     "WHERE T_RATEID_REF = LCH.T_RATEID_REF "
                                                       "AND T_RATEDATE <= ?) "                                                 
                              "AND TRFV.T_TYPEPARENT = 1 "
                              "AND TRFV.T_PARENTID = LCH.T_ID "
                              "AND ROWNUM = 1 "
                            "ORDER BY LCH.T_CREDOPERID_REF ASC ",                                        
                        "CRD_KIND",     qCrd.Value("T_CRD_KIND") ,
                        "CREDITNUMBER", qCrd.Value("T_CREDITNUMBER"),
                        "DATECALCPSV",  dateCalcPSV,
            V_INTEGER);
    
   
    IF(((qCrd.Value("T_PAYTYPE") == CF_DEPOSIT) OR (qCrd.Value("T_PAYTYPE") == CF_DEPOREPLEN)) AND (existRateDPA == 1))    
       // Ищем значение ставки тарифа <Проценты по депозиту> за дату расчета 
       VAR RSDRate3 = RsdCommand (RslDefCon, "BEGIN ?:= RSI_Loans_TrffAlg.GetTrffRate(?,?,?,?,?,?); END;");
       RSDRate3.addParam("RetVal",       RSDBP_RETVAL, V_NUMERIC); 
       RSDRate3.addParam ("ObjId",       RSDBP_IN);    RSDRate3.value ("ObjId")      = qCrd.Value("T_CRD_KIND");
       RSDRate3.addParam ("ObjN",        RSDBP_IN);    RSDRate3.value ("ObjN")       = qCrd.Value("T_CREDITNUMBER");
       RSDRate3.addParam ("TrffType",    RSDBP_IN);    RSDRate3.value ("TrffType")    = TRU_DEPOPERC;
       RSDRate3.addParam ("CalcDate",    RSDBP_IN);    RSDRate3.value ("CalcDate")    = dateCalcPSV;
       RSDRate3.addParam ("TrffValID",   RSDBP_IN);    RSDRate3.value ("TrffValID")   = 0;
       RSDRate3.addParam ("ContextType", RSDBP_IN);    RSDRate3.value ("ContextType") = 0; 
       RSDRate3.execute ();

       ratevalDP = RSDRate3.value ("RetVal"); 
              
       VAR Dur3:integer = CRSDCommand("SELECT T_RETURNDATE - T_REGDATE "
                                        "FROM DCREDIT_C_DBT "
                                       "WHERE T_CREDITNUMBER = ? ",                                        
                                     "CREDITNUMBER", qCrd.Value("T_CREDITNUMBER"), V_INTEGER);
              
       // Заполняем коллекцию значений тарифа "Проценты при досрочном расторжении
       VAR RSDRtDPA = RsdCommand (RslDefCon, "begin LoansVox.AllTrffValPSVDur(?, ?, ?, ?); end;");
       RSDRtDPA.addParam ("ObjId",    RSDBP_IN);   RSDRtDPA.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
       RSDRtDPA.addParam ("ObjN",     RSDBP_IN);   RSDRtDPA.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
       RSDRtDPA.addParam ("CalcDate", RSDBP_IN);   RSDRtDPA.value ("CalcDate")  = dateCalcPSV;
       RSDRtDPA.addParam ("DurDer", RSDBP_IN);     RSDRtDPA.value ("DurDer")    = Dur3;

       RSDRtDPA.execute ();  

       VAR rateValDPA = 0; // -- значение ставки  тарифа <Проценты при досрочном расторжении депозиту> 
       VAR Indx = 1;
       VAR statDPA = 0; 
       WHILE (statDPA == 0)        
         // Получим значение тарифа для "Проценты при досрочном расторжении депозиту"
         VAR RSDRateDPA = RsdCommand (RslDefCon, "begin ? :=  LoansVox.GetTrffValPSVfromGlArr(?, ?); end;");
         RSDRateDPA.addParam ("stat",       RSDBP_RETVAL, V_INTEGER);
         RSDRateDPA.addParam ("Indx",       RSDBP_IN);    RSDRateDPA.value ("Indx") = Indx;  
         RSDRateDPA.addParam ("rateValDPA", RSDBP_OUT,    V_NUMERIC);         
         RSDRateDPA.execute (); 

         // Получим сумму депозита D3
         VAR RSDcmdD3 = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcD(?, ?, ?, ?); end;");
         RSDcmdD3.addParam ("RetVal",    RSDBP_RETVAL, V_MONEY); 
         RSDcmdD3.addParam ("ObjId",     RSDBP_IN);    RSDcmdD3.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
         RSDcmdD3.addParam ("ObjN",      RSDBP_IN);    RSDcmdD3.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
         RSDcmdD3.addParam ("TypePSV",   RSDBP_IN);    RSDcmdD3.value ("TypePSV")   = ADD_PSV_3;
         RSDcmdD3.addParam ("CalcDate",  RSDBP_IN);    RSDcmdD3.value ("CalcDate")  = dateCalcPSV; 
         RSDcmdD3.execute ();

         VAR D3 = SQL_NVL(RSDcmdD3.value ("RetVal"), V_MONEY);  // Срок депозита для ПСВ_3          
       
         statDPA = SQL_NVL(RSDRateDPA.value ("stat"), V_INTEGER);
         IF(statDPA == 0)
             rateValDPA = SQL_NVL(RSDRateDPA.value ("rateValDPA"), V_NUMERIC);
           
           IF(rateValDPA >= (2*rateValDP/3.0)) 
              VAR RSDtf3 = RsdCommand (RslDefCon, "BEGIN RSI_SpVariable_Func.TrffValPSV := ?; END;");
              RSDtf3.addParam ("TrffValPSV",  RSDBP_IN);   RSDtf3.value ("TrffValPSV")  = rateValDPA; 
              RSDtf3.execute ();

              // Получим срок депозита
              VAR RSDDur3 = RsdCommand (RslDefCon, "begin ? := LoansVox.CalcDm(?, ?, ?, ?); end;");
              RSDDur3.addParam("RetVal",     RSDBP_RETVAL, V_INTEGER); 
              RSDDur3.addParam ("ObjId",     RSDBP_IN);    RSDDur3.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
              RSDDur3.addParam ("ObjN",      RSDBP_IN);    RSDDur3.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
              RSDDur3.addParam ("TypePSV",   RSDBP_IN);    RSDDur3.value ("TypePSV")   = ADD_PSV_3;
              RSDDur3.addParam ("CalcDm",   RSDBP_IN);     RSDDur3.value ("CalcDm")    = dateCalcPSV;  
              RSDDur3.execute ();

              VAR DurDepDay3 = SQL_NVL(RSDDur3.value ("RetVal"), V_INTEGER);              
       
              dateEndGraph = dateBegGraph + DurDepDay3;            
              CalcGraphDepPerc(LO_DEPOSIT, qCrd.Value("T_CREDITNUMBER"), 0, 170, ratevalDPA, dateBegGraph, dateEndGraph);

              VAR RSDcmd3 = RsdCommand (RslDefCon, "begin LoansVox.InsertRecCostDepEmp(?, ?, ?, ?, ?); end;");
              RSDcmd3.addParam ("ObjId",     RSDBP_IN);    RSDcmd3.value ("ObjId")     = qCrd.Value("T_CRD_KIND");
              RSDcmd3.addParam ("ObjN",      RSDBP_IN);    RSDcmd3.value ("ObjN")      = qCrd.Value("T_CREDITNUMBER");
              RSDcmd3.addParam ("TypePSV",   RSDBP_IN);    RSDcmd3.value ("TypePSV")   = ADD_PSV_3;              
              RSDcmd3.addParam ("BeginDate", RSDBP_IN);    RSDcmd3.value ("BeginDate") = BeginDate;
              RSDcmd3.addParam ("EndDate",   RSDBP_IN);    RSDcmd3.value ("EndDate")   = EndDate; 
              RSDcmd3.execute ();  
           END; 
         ELSE
           BREAK;
         END;         
         Indx = Indx + 1;
      END; 
    END;                  
  END;
END;  

