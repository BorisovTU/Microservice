IMPORT "total.mac", "macperc.mac", RsbDataSet;

private VAR  payment_tmp = TBFile ("payment.tmp", "r", 0);

VAR Sum:moneyl;

MACRO FillFile(DutyType: integer, ObjID: integer, ObjN: integer, OpDate: date, CalcEndDate: date, PaymentID: integer)
    VAR RSDcmd = RsdCommand(RslDefCon, "begin Loansfillpayment.fillpaymentfordepopayop(?,?,?,?,?,?); end;");
    VAR _PaymentID : integer = 0;
    var rs = null;
    var RSDcmd1 = null;

    //Если не задан PaymentID
    IF (ValType(PaymentID) == V_INTEGER)
      _PaymentID = PaymentID;
    END;
   
    RSDcmd.addParam("typeop",   RSDBP_IN);
    RSDcmd.value("typeop") = DutyType;
    RSDcmd.addParam("objid",    RSDBP_IN);
    RSDcmd.value("objid") = ObjID;
    RSDcmd.addParam("objn",     RSDBP_IN);
    RSDcmd.value("objn") = ObjN;
    RSDcmd.addParam("opdate",   RSDBP_IN);
    RSDcmd.value("opdate") = OpDate;
    RSDcmd.addParam("calcdate", RSDBP_IN);
    RSDcmd.value("calcdate") = CalcEndDate;
    RSDcmd.addParam("paymentid", RSDBP_IN);
    RSDcmd.value("paymentid") = _PaymentID;

    RSDcmd.execute();

    //Удаляем группы задолженностей без видов
    RSDcmd1 = RsdCommand(RslDefCon,"DELETE FROM DPAYMENT_TMP PM WHERE PM.T_PARENTID = ?" +
                                 " AND PM.T_Reference NOT IN (SELECT T_PARENTID FROM DPAYMENT_TMP PM2 WHERE PM2.T_PARENTID != ?" +
                                 " AND t_ObjID = ? and t_ObjN = ?)");
    RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(0) = 0;
    RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(1) = 0;
    RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(2) = ObjID;
    RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(3) = ObjN;
    rs  = RsdRecordset(RSDcmd1);
    RSDcmd1.execute;
END;


MACRO CalcAllSum(ObjN, PaymentID)
   VAR _PaymentID : integer = 0;
   var rs = null;
   var RSDcmd = null;
   //Если не задан PaymentID
   IF (ValType(PaymentID) == V_INTEGER)
      _PaymentID = PaymentID;
   END;

   RSDcmd = RsdCommand(RslDefCon,"SELECT Sum(t_PaySum) from dpayment_tmp where t_ParentID != ?" +
                                 " AND t_PaymentID_Ref = ?" +
                                 " AND t_ObjID = ?" +
                                 " AND t_ObjN = ?");
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = 0;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = _PaymentID;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(2) = LO_DEPOSIT;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(3) = ObjN;
   rs  = RsdRecordset(RSDcmd);
   RSDcmd.execute;
  
   if ((rs != null) and (rs.MoveNext()) and (rs.value(0, null, V_MONEY) != null))
      return rs.value(0, null, V_MONEY);
   end;
   return money(0);
END;

MACRO ReCalcSum(ObjN, PaymentID)
   VAR _PaymentID : integer = 0;
   var rs = null;
   var RSDcmd = null;
   var RSDcmd1 = null;
   var RSDcmd2 = null;

   //Если не задан PaymentID
   IF (ValType(PaymentID) == V_INTEGER)
      _PaymentID = PaymentID;
   END;

   RSDcmd = RsdCommand(RslDefCon,"update dpayment_tmp a set t_PaySum = " +
                                 " (Select SUM(t_PaySum) from DPAYMENT_TMP b where b.t_ParentID = a.t_Reference " +
                                                                                 " and (b.t_ObjID = a.t_ObjID)" +
                                                                                 " and (b.t_ObjN  = a.t_ObjN)" +
                                                                                 " and t_PaymentID_Ref = ?" +
                                                                                 " and t_ObjID = ?" +
                                                                                 " and t_ObjN = ?)" +
                                  " WHERE t_ParentID = ?" +
                                  " AND   t_PaymentID_Ref = ?" +
                                  " AND   t_ObjID = ?" +
                                  " AND   t_ObjN = ?");
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = _PaymentID;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = LO_DEPOSIT;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(2) = ObjN;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(3) = 0;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(4) = _PaymentID;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(5) = LO_DEPOSIT;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(6) = ObjN;
   rs  = RsdRecordset(RSDcmd);
   RSDcmd.execute;
   
   rs = null;
   
   RSDcmd1 = RsdCommand(RslDefCon,"update dpayment_tmp a set t_Sum = " +
                                  " (Select SUM(t_Sum) from DPAYMENT_TMP b where b.t_ParentID = a.t_Reference " +
                                                                                  " and (b.t_ObjID = a.t_ObjID)" +
                                                                                  " and (b.t_ObjN  = a.t_ObjN)" +
                                                                                  " and t_PaymentID_Ref = ?" +
                                                                                  " and t_ObjID = ?" +
                                                                                  " and t_ObjN = ?)" +
                                   " WHERE t_ParentID = ?" +
                                   " AND   t_PaymentID_Ref = ?" +
                                   " AND   t_ObjID = ?" +
                                   " AND   t_ObjN = ?");
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(0) = _PaymentID;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(1) = LO_DEPOSIT;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(2) = ObjN;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(3) = 0;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(4) = _PaymentID;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(5) = LO_DEPOSIT;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(6) = ObjN;
   rs  = RsdRecordset(RSDcmd1);
   RSDcmd1.execute;
   
   rs = null;
   
   RSDcmd2 = RsdCommand(RslDefCon,"update dpayment_tmp a set t_RestNoPay = " +
                                  " (Select SUM(t_RestNoPay) from DPAYMENT_TMP b where b.t_ParentID = a.t_Reference " +
                                                                                  " and (b.t_ObjID = a.t_ObjID)" +
                                                                                  " and (b.t_ObjN  = a.t_ObjN)" +
                                                                                  " and t_PaymentID_Ref = ?" +
                                                                                  " and t_ObjID = ?" +
                                                                                  " and t_ObjN = ?)" +
                                   " WHERE t_ParentID = ?" +
                                   " AND   t_PaymentID_Ref = ?" +
                                   " AND   t_ObjID = ?" +
                                   " AND   t_ObjN = ?");
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(0) = _PaymentID;
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(1) = LO_DEPOSIT;
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(2) = ObjN;
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(3) = 0;
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(4) = _PaymentID;
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(5) = LO_DEPOSIT;
   RSDcmd2.addParam("", RSDBP_IN); RSDcmd2.value(6) = ObjN;
   rs  = RsdRecordset(RSDcmd2);
   RSDcmd2.execute;
END;

/* Расчет сумм */
MACRO CalcPercent(OpDate:date, ObjN: integer, PaymentID: integer, Anticipatory: integer)
/*Anticipatory принимает значения 0 и 1. 1, когда в панели операции установлен флаг "Досрочное расторжение договора"*/
   VAR RSDcmd : object = null;
   VAR RSDcmd1 : object = null;
   VAR RSDcmd2 : object = null;
   VAR rs = null;
   VAR rs1 = null;
   VAR _PaymentID : integer = 0;

   //Если не задан PaymentID
   IF (ValType(PaymentID) == V_INTEGER)
      _PaymentID = PaymentID;
   END;

   RSDcmd1 = RsdCommand(RslDefCon,"update dpayment_tmp set T_SUM = ?, T_PAYSUM = ?, T_RESTNOPAY = ?" +
                                  " WHERE t_PaymentID_Ref = ?" +
                                  " AND   t_ObjID = ?" +
                                  " AND   t_ObjN = ?");
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(0) = money(0);
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(1) = money(0);
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(2) = money(0);
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(3) = _PaymentID;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(4) = LO_DEPOSIT;
   RSDcmd1.addParam("", RSDBP_IN); RSDcmd1.value(5) = ObjN;
   rs1  = RsdRecordset(RSDcmd1);
   RSDcmd1.execute;

   RSDcmd = RsdCommand(RslDefCon,"select * from dpayment_tmp where" +
                                 " t_ParentID != ?" +
                                 " AND t_IsOperation != 'X'"
                                 " AND t_PaymentID_Ref = ?" +
                                 " AND t_ObjID = ?" +
                                 " AND t_ObjN = ?");
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = 0;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = _PaymentID;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(2) = LO_DEPOSIT;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(3) = ObjN;
   rs  = RsdRecordset(RSDcmd);
   RSDcmd.execute;

   if (rs != null)
      RSDcmd2 = RsdCommand(RslDefCon, "begin Loansfillpayment.debtscalculation(?,?,?,?,?,?); end;");
      RSDcmd2.addParam("objid",    RSDBP_IN);
      RSDcmd2.addParam("objn",     RSDBP_IN);
      RSDcmd2.addParam("parentid",   RSDBP_IN);
      RSDcmd2.addParam("REFERENCE",   RSDBP_IN);
      RSDcmd2.addParam("opdate", RSDBP_IN);
      RSDcmd2.addParam("Anticipatory", RSDBP_IN);

      WHILE (rs.MoveNext)
         RSDcmd2.value("objid") = rs.value("t_ObjID",         false, V_INTEGER);
         RSDcmd2.value("objn") = rs.value("t_ObjN",           false, V_INTEGER);
         RSDcmd2.value("parentid") = rs.value("t_ParentID",   false, V_INTEGER);
         RSDcmd2.value("REFERENCE") = rs.value("t_Reference", false, V_INTEGER);
         RSDcmd2.value("opdate") = OpDate;
         RSDcmd2.value("Anticipatory") = Anticipatory;
         RSDcmd2.execute();
      END;
      RSDcmd2 = null;
   END;

   ReCalcSum(ObjN, _PaymentID);
end;

// 144992 временное решение
// проверки перед запуском выплаты по депозиту
macro CheckFlagPercent
(
   ObjK : integer,
   ObjN : integer,
   Anticipatory : integer
)
   var RSDcmd = null;
   var rs = null;
   var AddPercent : integer = 0;
   var ReturnPercent : integer = 0;

   RSDcmd = RsdCommand (RslDefCon,
      " SELECT t_AddPercent, t_ReturnPercent FROM dparmdepo_dbt" +
      " WHERE t_ObjectTypeID = ?" +
      " AND t_ObjectNumber = ?"
   );
   RSDcmd.addParam ("", RSDBP_IN); RSDcmd.value(0) = ObjK;
   RSDcmd.addParam ("", RSDBP_IN); RSDcmd.value(1) = ObjN;

   rs = RsdRecordset (RSDcmd);
   RSDcmd.execute();
   if ((rs != null) and (rs.MoveNext()))
      if (rs.value ("t_AddPercent", null, V_STRING) == "X")
         AddPercent = 1;
      end;

      if (rs.value ("t_ReturnPercent", null, V_STRING) == "X")
         ReturnPercent = 1;
      end;
   else
      return 1;
   end;

   if ((Anticipatory == 1) and
       (AddPercent == 1) and
       (ReturnPercent == 1))
      msgbox ("Операция не может быть выполнена для договора, по которому предусмотрено причисление % и возврат клиентом излишне выплаченных процентов!");
      return 1;
   end;

   return 0;
end;

MACRO CheckDepoPay
(
   OpDate       : date,
   ObjN         : integer,
   Sum          : moneyl,
   Anticipatory : integer, // (флаг) Досрочное расторжение договора (установлен = 1, сброшен=0)
   PaymentID    : integer
)
   record rcredit("credit_c.dbt", "loans.def");

   var _PaymentID : integer = 0;
   

   // если не задан PaymentID
   IF (ValType(PaymentID) == V_INTEGER)
      _PaymentID = PaymentID;
   END;

   if (not Loans_FindCrdContract(ObjN, rcredit))
      return 1;
   end;

   // временное решение 144992
   if (CheckFlagPercent (LO_DEPOSIT, ObjN, Anticipatory) == 1)
      return 1;
   end;

   return 0;
END;

MACRO UpdateDates(NewDate: date, Reference: integer, ObjN: integer, PaymentID: integer)
   VAR _PaymentID : integer = 0,
       rs = null,
       RSDcmd = null;

   //Если не задан PaymentID
   IF (ValType(PaymentID) == V_INTEGER)
      _PaymentID = PaymentID;
   END;

   RSDcmd = RsdCommand(RslDefCon,"update dpayment_tmp set t_EndDate = ?" +
                                 " WHERE t_ParentID = ?" +
                                 " AND   t_PaymentID_Ref = ?" +
                                 " AND   T_CREDITNUMBER_REF = ?" +
                                 " AND   t_ObjID = ?" +
                                 " AND   t_ObjN = ?");
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = NewDate;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = Reference;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(2) = _PaymentID;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(3) = ObjN;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(4) = LO_DEPOSIT;
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(5) = ObjN;
   rs  = RsdRecordset(RSDcmd);
   RSDcmd.execute;
END;
