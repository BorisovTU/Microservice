/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ProlPay.mac
 Description : макрос разноски в пакетной пролонгации депозитов

 Programmer  : Manushkina E.V.
 2008.04.28  : Создан
-----------------------------------------------------------------------------------*/

import "percsum.mac", "total.mac";

private var  payment_tmp = TBFile ("payment.tmp", "rw", 0);

macro NameObject (buff)
   record Credit ("credit_c.dbt", "loans.def");
   record Duty ("duty_crd.dbt", "loans.def");
   record payment ("payment.tmp");

   SetBuff(payment, buff);

   if ((payment.ObjID == LO_CREDIT) or
       (payment.ObjID == LO_KARTA)  OR
       (payment.ObjID == LO_GUARANTEE) OR
       (payment.ObjID == LO_OVERDRAFT) OR
       (payment.ObjID == LO_DEPOSIT)
      )
      if (Loans_FindCrdContract (payment.ObjN, Credit))
         if (payment.ObjID == LO_CREDIT)
            return "КД № " + Credit.UsCreditNumber;
         elif (payment.ObjID == LO_KARTA)
            return "БК № " + Credit.UsCreditNumber;
         elif (payment.ObjID == LO_GUARANTEE)
            return "БГ № " + Credit.UsCreditNumber;
         elif (payment.ObjID == LO_OVERDRAFT)
            return "ОВ № " + Credit.UsCreditNumber;
         elif (payment.ObjID == LO_DEPOSIT)
            return "ДД № " + Credit.UsCreditNumber;
         end;
      end;
   elif (payment.ObjID == LO_DUTY
      )
      if (Loans_FindDuty(payment.ObjN, Duty))
         if (Loans_FindCrdContract(Duty.CreditNumber_Ref, Credit))
            return "КД №" + Credit.UsCreditNumber + ", СО №" + Duty.UserNumber;
         end;
      end;
   end;

   return "";
end;

macro FillFileGroup (
   OpType    : integer,
   OpDate    : date,
   OpCurr    : integer,
   FNCash    : integer,
   SMAString : string
)
   var RSDcmd = RsdCommand (RslDefCon, "begin LoansFillPayment.RSO_FillPaymForBatchProlDepo (?,?,?,?,?); end;");

   BegAction (1, "Формирование списка задолженности. Ждите, это может занять несколько минут.", false);

   RSDcmd.addParam ("OpType",    RSDBP_IN); RSDcmd.value ("OpType")    = OpType;
   RSDcmd.addParam ("OpDate",    RSDBP_IN); RSDcmd.value ("OpDate")    = OpDate;
   RSDcmd.addParam ("OpCurr",    RSDBP_IN); RSDcmd.value ("OpCurr")    = OpCurr;
   RSDcmd.addParam ("FNCash",    RSDBP_IN); RSDcmd.value ("FNCash")    = FNCash;
   RSDcmd.addParam ("SMAString", RSDBP_IN); RSDcmd.value ("SMAString") = SMAString;

   RSDcmd.execute ();

   EndAction (1);
end;

macro CalcPercentGroup (OpDate:date)
   var RSDcmd;

   CalcGroupPercent(OpDate, OpDate, 0);
end;

macro FillFileGroupOther (OpDate:date, CalcDate:date)
   /*payment_tmp.rewind;
   WHILE (payment_tmp.next)
      payment_tmp.rec.EndDate = CalcDate;
      payment_tmp.update;
   END;*/
end;
