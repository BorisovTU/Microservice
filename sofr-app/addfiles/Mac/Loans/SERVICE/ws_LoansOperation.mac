/*
$Name: ws_LoansOperation.mac
$Module: Кредитование
$Description: Сервисы для работы с операциями Loans
*/

import "total.mac", SbCrdInter, "rsbus_structs.mac";
import FIInter;
import RsbDataSet;
import ws_ufo_classes;
import rsbus_credit_get;
import "ws_datafilter.mac";
import "FillPaymentReport.mac", rsexts, ws_file;
import "ws_lns_CommonLib.mac";
import "ws_report", "ws_validation.mac";

MACRO LoansRunError( err, stat:integer )
  RunError(err, stat );
END;

CLASS CCreditContr
   VAR Id             : Integer;
   VAR CreditType     : Integer;
   VAR Number         : String;
   VAR RegDate        : Date;
   VAR Sum            : Money;
   VAR Curcode        : Integer;
   VAR Code           : String;
   VAR Crd_kind       : Integer;

   MACRO Construct()
      id             = 0;
      creditType     = 0;
      number         = 0;
      regDate        = date(0,0,0);
      sum            = 0.0;
      Curcode        = 0;
      Code           = 0;
   END;

   this.Construct();
END;

CLASS CCreditType
   VAR Id   : integer;
   VAR Name : string;
   VAR Type : string;
   VAR Code : string;

   MACRO Construct()
      Id = 0;
      Name = "";
      Type = "";
      Code = "";
   END;
   
   this.construct();
END;

//разноска
CLASS TWsCountry
   VAR Id:integer;
   VAR ParentId:integer;
   VAR Text:string;
   VAR Children;
END;
//разноска
CLASS TWsMessage
   VAR MsgID:integer;
   VAR MsgText:string;
END;

//-------------------ЕОК-------------------
//Копируем из временных таблиц в постоянную
//17.09.2013 PDS
MACRO SetTemparyData(HashCode: integer)
   VAR   RSDcmd = RsdCommand(RslDefCon, "begin LoansKernel.SetTemparyData(?); END;");
   RSDcmd.addParam("HashCode", RSDBP_IN); RSDcmd.value("HashCode") = HashCode;
   RSDcmd.execute();
OnError(err)
   RETURN -1;
END;

//-------------------ЕОК-------------------
//Копируем из постоянной во временные
//Так же устанавливается контекст операции
//17.09.2013 PDS
MACRO GetTemparyData(HashCode: integer)
   VAR   RSDcmd = RsdCommand(RslDefCon, "begin LoansKernel.GetTemparyData(?); END;");
   RSDcmd.addParam("HashCode", RSDBP_IN); RSDcmd.value("HashCode") = HashCode;
   RSDcmd.execute();
END;

MACRO FillPaymentCalc
      (
       ObjID ,
       ObjN ,
       TypeOperID ,
       OpDate,
       CalcDate,
       HashCode,
       ReCalc,
       PaySum
      )

   MACRO getFillPayment
      VAR stat: integer = 0;
     
      LnSQLExec("delete from dpayment_tmp");
     
      VAR  RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansFillpayment.fillpaymentforalloper (?,?,?,?,?,?);  END;");
      RSDcmd.AddParam("stat", RSDBP_RETVAL, V_INTEGER);
      RSDcmd.addParam("TypeOperID", RSDBP_IN); RSDcmd.value ("TypeOperID")  = TypeOperID;
      RSDcmd.addParam("objid",      RSDBP_IN); RSDcmd.value ("objid")       = ObjID;
      RSDcmd.addParam("objn",       RSDBP_IN); RSDcmd.value ("objn")        = ObjN;
      RSDcmd.addParam("opdate",     RSDBP_IN); RSDcmd.value ("opdate")      = opdate;
      RSDcmd.addParam("gldate",     RSDBP_IN); RSDcmd.value ("gldate")      = Calcdate;
      RSDcmd.addParam("ContextType",RSDBP_IN); RSDcmd.value ("ContextType")  = 1 ;/* TODO: добавить константу в интер CN_GenParamOperations*/
      RSDcmd.execute();
      stat = RSDcmd.value ("stat");
      RETURN stat;
   END;

   MACRO ReCalcPayment
      VAR stat: integer = 0;
      VAR igdefoprid, prcdefoprid;
      VAR  RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansFillpayment.fillpaymentcalc (?,?,?,?,?,0,1,?);  END;");
      RSDcmd.AddParam("stat", RSDBP_RETVAL, V_INTEGER);
      RSDcmd.addParam("objid",      RSDBP_IN); RSDcmd.value ("objid")       = ObjID;
      RSDcmd.addParam("objn",       RSDBP_IN); RSDcmd.value ("objn")        = ObjN;
      RSDcmd.addParam("TypeOperID", RSDBP_IN); RSDcmd.value ("TypeOperID")  = TypeOperID;
      RSDcmd.addParam("opdate",     RSDBP_IN); RSDcmd.value ("opdate")      = opdate;
      RSDcmd.addParam("gldate",     RSDBP_IN); RSDcmd.value ("gldate")      = calcdate;
      RSDcmd.addParam("ContextType",RSDBP_IN); RSDcmd.value ("ContextType")  = 1 ;/* TODO: добавить константу в интер CN_GenParamOperations*/
      RSDcmd.execute();
      stat = RSDcmd.value ("stat");
      RETURN stat;
   END;

   MACRO ParseSum
      VAR stat: integer = 0;
      VAR igdefoprid, prcdefoprid;
      VAR  RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansFillpayment.fillpaymentcalcressum (?,?,?,?,1,?,?);  END;");
      RSDcmd.AddParam("stat", RSDBP_RETVAL, V_INTEGER);
      RSDcmd.addParam("TypeOperID", RSDBP_IN); RSDcmd.value ("TypeOperID")  = TypeOperID;
      RSDcmd.addParam("objid",      RSDBP_IN); RSDcmd.value ("objid")       = ObjID;
      RSDcmd.addParam("objn",       RSDBP_IN); RSDcmd.value ("objn")        = ObjN;
      RSDcmd.addParam("opdate",     RSDBP_IN); RSDcmd.value ("opdate")      = opdate;
      RSDcmd.addParam("PaySum",     RSDBP_IN); RSDcmd.value ("PaySum")      = PaySum;
      RSDcmd.addParam("ContextType",RSDBP_IN); RSDcmd.value ("ContextType")  = 1 ;/* TODO: добавить константу в интер CN_GenParamOperations*/
      RSDcmd.execute();
      stat = RSDcmd.value ("stat");
      LnSQLExec( "UPDATE dpayment_tmp UP "+
             " SET (UP.t_sum,UP.T_UPP_SUM,UP.T_RPP_SUM,UP.T_CCP_SUM,UP.t_paysum,UP.t_restnopay,UP.t_nds) = "+
             " (SELECT SUM (t_sum),SUM (T_UPP_SUM),SUM (T_RPP_SUM),SUM (T_CCP_SUM),SUM (t_paysum), "+
             " SUM(t_restnopay), SUM(t_nds) FROM dpayment_tmp WHERE     t_objid = UP.t_objid AND t_objn = UP.t_objn AND t_parentid = UP.t_reference and t_FlagExcFromTotal != 'X') "+
             " WHERE UP.t_parentid = 0 AND t_objid != -1");
      RETURN stat;
   END;

   VAR stat:integer = 0;

   IF ((ValType(HashCode) == V_UNDEF) OR (ValType(ObjID) == V_UNDEF) OR (ValType(ObjN) == V_UNDEF) OR (ValType(TypeOperID) == V_UNDEF) OR (ValType(OpDate) == V_UNDEF) OR (ValType(CalcDate) == V_UNDEF))
     LoansRunError("Ключевой параметр сервиса не задан!", 8);
     RETURN 8;
   END;

   //определяем режим работы сервиса
   IF ((ValType(ReCalc) == V_UNDEF) OR (ReCalc == False))
      //первичное построение
      stat = getFillPayment;
      IF (stat != 0)
         LoansRunError( "Fillpayment", stat);
      END;
   ELSE
      //Перерасчет
      IF (PaySum >0)
         //разнос платежа
         stat = ParseSum; 
      ELSE
         //перерасчет с новым идатами
         stat = ReCalcPayment;
      END;
      
      IF (stat != 0)
         LoansRunError( "Fillpayment", stat);
      END; 
   END;

   SetTemparyData(HashCode);
   OnError RunError;
/*
   IF (SetTemparyData(HashCode) == 0)
      RETURN stat;
   ELSE 
      LoansRunError(0, -1);
      RETURN -1;
   END;*/
END;

//-------------------------------ЕОК--------------------------------------------
//   Сервис источник данных для разноски и по совместительству строит разноску:)
//
//18.09.2013 PDS
MACRO GetPaymentList(ObjId, ObjN, OpDate, CarryDate, CalcDate, TypeOperID, HashCode, recalc, PaySum)
   MACRO  GetXML()
      VAR query;

      LnSQLExec("UPDATE DPAYMENT_TMP SET T_FIRSTREGID = NULL");

      LnSQLExec("UPDATE DPAYMENT_TMP pm1 SET pm1.T_FIRSTREGID = " +
                " ( " +
                "   SELECT pm2.T_ID FROM DPAYMENT_TMP pm2 WHERE " +
                         " pm2.T_OBJID = -1 " +
                     " AND pm2.T_OBJN  = -1 " +
                     " AND PM2.T_REFERENCE = pm1.T_REFERENCE  " +
                " ) " +
                " WHERE " +
                      " pm1.T_PARENTID = 0 " +
                  " AND pm1.T_OBJID <> -1 " +
                  " AND pm1.T_OBJN  <> -1 ");

      LnSQLExec("UPDATE DPAYMENT_TMP pm1 SET pm1.T_FIRSTREGID = " +
                " ( " +
                  " SELECT pm2.T_ID FROM DPAYMENT_TMP pm2 WHERE " +
                         " pm2.T_OBJID = pm1.T_OBJID " +
                     " AND pm2.T_OBJN  = pm1.T_OBJN " +
                     " AND pm2.T_REFERENCE = pm1.T_PARENTID " +
                     " AND pm2.T_PARENTID  = 0 " +
                " ) WHERE " +
                  " pm1.T_PARENTID > 0 " +
              " AND pm1.T_OBJID    > 0 " +
              " AND pm1.T_OBJN     > 0");
      query = 
"SELECT DBMS_XMLGEN.NEWCONTEXTFROMHIERARCHY ('select level,  XMLElement(  "+
"  FILLPAYMENT,  "                      
"XMLElement(PARENTID, T_PARENTID),  "
"XMLElement(DUTYSTAGE,T_REFERENCE),  "
"XMLElement(STRNAME ,case when T_STRNAME = chr(1) then NULL else T_STRNAME end ),  "
"XMLElement(BEGDATE ,to_char(NVL(T_BEGDATE,to_date(''01.01.0001'')),''dd.mm.YYYY'') ),  "
"XMLElement(ENDDATE ,to_char( NVL( T_ENDDATE,to_date(''01.01.0001'')),''dd.mm.YYYY'')),  "
"XMLElement(CALCSUM ,trim(to_char(T_SUM,''999999999999990D99''))),  "
"XMLElement(PAYSUM  , trim(to_char(T_PAYSUM,''999999999999990D99''))),  "
"XMLElement(RESTNOPAY , trim(to_char(T_RESTNOPAY,''999999999999990D99''))),  "
"XMLElement(NDS , trim(to_char(T_NDS,''999999999999990D99''))))  "
"  FROM   (select * from "
"(SELECT T_ID, T_FIRSTREGID, T_PARENTID as T_PARENTID,T_REFERENCE*60000 as T_REFERENCE, T_STRNAME as T_STRNAME, " + 
        "T_BEGDATE as T_BEGDATE, T_ENDDATE as T_ENDDATE,T_SUM as T_SUM,T_PAYSUM as T_PAYSUM,T_RESTNOPAY as T_RESTNOPAY,NVL(T_NDS, 0) as T_NDS " +
       " from dpayment_tmp where t_parentid = 0) par "
"UNION " + 
" SELECT * from " +
"(SELECT T_ID, T_FIRSTREGID, T_PARENTID*60000 as T_PARENTID , T_REFERENCE as T_REFERENCE, T_STRNAME as T_STRNAME, T_BEGDATE as T_BEGDATE, " + 
       " T_ENDDATE as T_ENDDATE,T_SUM as T_SUM,T_PAYSUM as T_PAYSUM,T_RESTNOPAY as T_RESTNOPAY,NVL(T_NDS, 0) as T_NDS " + 
       " from dpayment_tmp  where t_parentid != 0) ref) " 
"START WITH T_FIRSTREGID IS NULL CONNECT BY PRIOR T_ID = T_FIRSTREGID') AS XMLDOC FROM DUAL ";
  
      VAR ds = TRsbDataSet(query);

      IF (ds.MoveNext())
           VAR q = "SELECT 1, XMLELEMENT (FILLPAYMENT_LIST,(SELECT DBMS_XMLGEN.GETXMLTYPE ("+int(ds.XMLDOC)+") FROM DUAL)).GETCLOBVAL () as XMLDOC FROM DUAL";
		   VAR cmd = RsdCommand(RslDefCon, q);
		   cmd.execute();
		   VAR rs  = TRsbDataSet (q);
		   rs.MoveNext();

		   cmd = RsdCommand(RslDefCon, "BEGIN dbms_xmlgen.closeContext(?); END;");
		   cmd.addParam("p1", RSDBP_IN); cmd.Value("p1") = int(ds.XMLDOC);
		   cmd.execute();
         RETURN rs.XMLDOC;
      END;

      RETURN "";
   END;

   MACRO setContextOperation(TypeOperID, CredOperID)
      VAR  RSDcmd = RsdCommand(RslDefCon, "begin  LoansFillpayment.put_OperationContext (?,?,?,?,?,?,?,?,?);  END;");
      RSDcmd.addParam("TypeOperID",        RSDBP_IN); RSDcmd.value ("TypeOperID")    = TypeOperID;
      RSDcmd.addParam("systemoperationid", RSDBP_IN); RSDcmd.value ("systemoperationid")  = 0;
      RSDcmd.addParam("opdate",            RSDBP_IN); RSDcmd.value ("opdate")        = opdate;
      RSDcmd.addParam("gldate",            RSDBP_IN); RSDcmd.value ("gldate")        = calcdate;
      RSDcmd.addParam("carrydate",         RSDBP_IN); RSDcmd.value ("carrydate")     = opdate;
      RSDcmd.addParam("opersum",           RSDBP_IN); RSDcmd.value ("opersum")       = 0;
      RSDcmd.addParam("SPOD",              RSDBP_IN); RSDcmd.value ("SPOD")          = " ";
      RSDcmd.addParam("Anticipatory",      RSDBP_IN); RSDcmd.value ("Anticipatory")  = " ";
      RSDcmd.addParam("CalcPerc",          RSDBP_IN); RSDcmd.value ("CalcPerc")      = " " ;/* TODO: добавить константу в интер CN_GenParamOperations*/
      RSDcmd.addParam("RiskGroup",         RSDBP_IN); RSDcmd.value ("RiskGroup")     = 0;
      RSDcmd.addParam("CredOperID",        RSDBP_IN); RSDcmd.value ("CredOperID")    = CredOperID;
      RSDcmd.execute();
   END;

   VAR CredOperID: integer;
   VAR result    : STRING;
   record typeopBuff("type_op") btr;
   VAR ResponseBuilder = WebResponseBuilder();
   IF (ValType(HashCode) == V_UNDEF) 
     LoansRunError("Ключевой параметр сервиса не задан!", 8);
     RETURN 8;
   END;
   LNSQLExec("DELETE FROM DPAYMENT_TMP" );
   LNSQLExec("DELETE FROM DPERCPAY_TMP" );
   IF (recalc ==  0)  // при первом расчете убиваем сохраненные данные, т.к. там могут быть результаты разноса суммы
      LNSQLExec("DELETE FROM DLOANS_TEMPARY_DBT WHERE T_HASH = " + HashCode);
   END;

   GetTemparyData(HashCode);

   VAR RS =
   CRSDCommand("SELECT cop1.T_CREDOPERID, cop1.T_CREDOPERDATE FROM DCRD_OP_DBT cop1 WHERE " +
                    " cop1.T_STAGEID_REF <> ? " +
                " AND cop1.T_CREDOPERID =  " +
   "(SELECT MAX(cop2.T_CREDOPERID) FROM DCRD_OP_DBT cop2 WHERE " +
          " cop2.T_SYSTEMOPERATIONID = ? " +
      " AND cop2.T_ISDELETED = ? " + 
      " AND cop2.T_OBJECTID_REF = ? " + 
      " AND cop2.T_OBJECTTYPEID_REF = ?)",
             "p1", CF_COMPLIT,
             "p2", CS_DUTY,
             "p3", 0,
             "p4", ObjN,
             "p5", ObjID,
             V_GENOBJ);
   IF (RS.MoveNext())
      OpDate     = RS.Value("T_CREDOPERDATE", NULL, V_DATE);
      CredOperID = RS.Value("T_CREDOPERID",   NULL, V_INTEGER);

      LnSQLExec("INSERT INTO DPAYMENT_TMP" +
      "( T_ISOPERATION, T_OBJID, T_OBJN, " +
       "T_REGID, T_CURCODE, T_BEGDATE, " +
       "T_ENDDATE, T_SUM, T_PAYSUM, " +
       "T_RESTNOPAY, T_DOCDUTYID_REF, T_PARENTID, " +
       "T_REFERENCE, T_RATEID, T_SYSTEMOPERATIONID, " +
       "T_CREDITNUMBER_REF, T_PAYMENTID_REF, T_PAYDATE, " +
       "T_FIRSTREGID, T_FIRSTRATEID, T_TYPEOPERNUMBER, " +
       "T_UPP_SUM, T_RPP_SUM, T_CCP_SUM, " +
       "T_STRNAME, T_OPTNOPID, T_ID, " +
       "T_FLAGEXCFROMTOTAL, T_NDS" +
      ")" +
      "SELECT CHR(0), T_OBJECTTYPEID_REF, T_OBJECTNUMBER_REF,  "+
      " 0, 0, MAX(T_CALCBEGDATE),  "+
      " MAX(T_CALCENDDATE), SUM(T_CLAIMSUM), SUM(T_ACTUALAMOUNT),  "+
      " SUM(T_UNDERPAYSUM), 0, 0,  "+
      " T_PARENTID, 0, T_SYSTEMOPERATIONID_REF,  "+
      " T_CREDITNUMBER, 0, TO_DATE('01.01.0001', 'dd.mm.yyyy'),  "+
      " 0, 0, T_TYPEOPERNUMBER_REF,  "+
      " SUM(T_UPP_SUM), SUM(T_RPP_SUM), SUM(T_CCP_SUM),  "+
      " MAX(gr.T_NAME), 0, 0,  "+
      " CHR(0), T_NDS FROM DPLANFACT_DBT pf, DGRPDEBTS_DBT gr "+
      " WHERE T_CREDOPERID_REF = " + CredOperID + " AND gr.T_NUMBER = pf.T_PARENTID "+
      " GROUP BY T_OBJECTTYPEID_REF, T_OBJECTNUMBER_REF, T_CREDITNUMBER,  "+
        " pf.T_PARENTID, T_TYPEOPERNUMBER_REF, T_SYSTEMOPERATIONID_REF" +
      " UNION ALL" +
      " SELECT CHR(0), T_OBJECTTYPEID_REF, T_OBJECTNUMBER_REF, " +
        " 0, 0, T_CALCBEGDATE, " +
        " T_CALCENDDATE, T_CLAIMSUM, T_ACTUALAMOUNT, " +
        " T_UNDERPAYSUM, 0, T_PARENTID, " +
        " T_DUTYSTAGEID_REF, 0, T_SYSTEMOPERATIONID_REF, " +
        " T_CREDITNUMBER, 0, TO_DATE('01.01.0001', 'dd.mm.yyyy'), " +
        " 0, 0, T_TYPEOPERNUMBER_REF, " +
        " T_UPP_SUM, T_RPP_SUM, T_CCP_SUM, " +
        " ds.T_SHORTNAME, 0, 0, " +
        " CHR(0), T_NDS FROM DPLANFACT_DBT pf, DDUTSTAGE_DBT ds WHERE T_CREDOPERID_REF = " + CredOperID + " AND DS.T_DUTYSTAGEID = pf.T_DUTYSTAGEID_REF");
      result =  GetXML;
   ELSE
      IF (recalc == 0)
         IF ( LnSelectValue("SELECT COUNT(T_ID) FROM DPAYMENT_TMP",V_INTEGER)>0)
              result =  GetXML;
         ELSE
            // Здесь нам нужен ID операции, поэтому ищем его
            IF (Loans_FindTypeOp(0, TypeOperID, TypeOpBuff) != true)
               RETURN "";
            END;
            setContextOperation(TypeOpBuff.TypeOperID);
            FillPaymentCalc(objID ,ObjN , TypeOpBuff.TypeOperID, opdate,calcdate,HashCode,0 ) ;
            result =  GetXML;
         END;
      ELSE
         IF (Loans_FindTypeOp(0, TypeOperID, TypeOpBuff)!= true)
            RETURN "";
         END;
         setContextOperation(TypeOpBuff.TypeOperID);
         FillPaymentCalc(objID ,ObjN , TypeOpBuff.TypeOperID, opdate,calcdate,HashCode,recalc,PaySum ) ;
         result =  GetXML;
      END;
   END;

   ResponseBuilder.SetUserObject(result);
   return ResponseBuilder.Result;
   
   OnError(err)
       if ((ValType(err.err) == V_INTEGER) and (err.err>18000)) 
           var errMesDS = TRsbDataSet("select t_contents from dbank_msg where t_number = " + err.err);
           if (errMesDS.MoveNext) ResponseBuilder.AddErrorEx( err.Code, MessageSeverity.RuntimeError, errMesDS.contents ); end;
       else
           ResponseBuilder.AddErrorEx( err.Code, MessageSeverity.RuntimeError, err.Message );
       end;
       return ResponseBuilder.Result;
END;

MACRO RunOperation(ObjectID, ObjectN, hashCode, Account, OpDate_, TypeOperID_, PaySum_, CredOperID_, CurCode_)
   VAR TypeOperID;
   VAR OpDate;
   VAR result:TWsMessage;
   VAR AccountStr =""; 
   VAR PaySum: money = $0;
   VAR CurCode = 0;
   record typeopBuff("type_op") btr;
   record creditBuff ("credit_c.dbt");
   VAR CredOperID: integer = 0;

   LNSQLExec("delete from dpayment_tmp" );
   LNSQLExec("delete from dpercpay_tmp" );

   GetTemparyData(HashCode);
   IF (ValType(CredOperID_) == V_INTEGER) 
      CredOperID = CredOperID_;
   END;

   IF (ValType(PaySum_) == V_MONEY)
      PaySum = PaySum_;
   END;
   
   IF (ValType(CurCode_) == V_INTEGER)
      CurCode = CurCode_;
    END;

   IF (CurCode == ALLFININSTR)
       CurCode = ExecMacro2("GetCrdCnrt",ObjectID, ObjectN).Curcode;
   END;

   IF ((ValType(Account) == V_STRING))
      AccountStr = Account;
   END;

   IF ((ValType(TypeOperID_) == V_INTEGER) AND (ValType(OpDate_) == V_DATE))
      OpDate     = OpDate_;
      TypeOperID = TypeOperID_;
   ELSE
      VAR  RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansFillPayment.OperationContext.TYPEOPERID; ? := LoansFillPayment.OperationContext.OPERDATE; END;");
      RSDcmd.AddParam("TypeOperID", RSDBP_OUT, V_INTEGER);
      RSDcmd.AddParam("opDate", RSDBP_OUT, V_DATE);
      RSDcmd.execute();
      TypeOperID = RSDcmd.Value (0);
      opDate     = RSDcmd.Value (1);
   END;

   /* write trace */
   LnSQLExec("SELECT '" + ObjectID   + "' AS ObjectID,  " + ValType(ObjectID)   + ","+
                    "'" + ObjectN    + "' AS ObjectN,   " + ValType(ObjectN)    + ","+
                    "'" + hashCode   + "' AS hashCode,  " + ValType(hashCode)   + ","+
                    "'" + AccountStr + "' AS Account,   " + ValType(AccountStr) + ","+
                    "'" + OpDate     + "' AS OpDate,    " + ValType(OpDate_)    + ","+
                    "'" + TypeOperID + "' AS TypeOperID," + ValType(TypeOperID_)+ ","+
                    "'" + PaySum     + "' AS PaySum,    " + ValType(PaySum_)    + ","+
                    "'" + CredOperID + "' AS CredOperID," + ValType(CredOperID) + ","+
                    "'" + CurCode    + "' AS CurCode,   " + ValType(CurCode_)   + " FROM DUAL");
   /* write trace */

   result.MsgText = "Выполнение операции. Операция выполнена успешно!";
   IF (CredOperID == 0)
      IF (Loans_FindTypeOp(0, TypeOperID, TypeOpBuff) != true)
         result.MsgText = "Выполнение операции. Не найдена операция " + TypeOperID;
         result.MsgID = -1;
         RETURN result;
      END;
   
      IF (TypeOpBuff.SystTypeOp_Ref == CS_PAY)
         result.MsgID = MakeOperation(ObjectN, ObjectID, TypeOpBuff.TypeOperNumber, CurCode, OpDate, 0, AccountStr, "", PaySum);
      ELIF (TypeOpBuff.SystTypeOp_Ref == CS_DUTY) 
         result.MsgID = MakeOperation(ObjectN, ObjectID, TypeOpBuff.TypeOperNumber, CurCode, OpDate, 1, AccountStr, "", 0);
      ELIF ((TypeOpBuff.SystTypeOp_Ref == CS_CLCRD) or 
            (TypeOpBuff.SystTypeOp_Ref == CS_CLOSEDRAFTCONTR) or
            (TypeOpBuff.SystTypeOp_Ref == CS_CLDUTY) or
            (TypeOpBuff.SystTypeOp_Ref == CS_OPDUTY))  
         result.MsgID = MakeOperation(ObjectN, ObjectID, TypeOpBuff.TypeOperNumber, CurCode, OpDate, 1, "", "", 0);
      ELIF (TypeOpBuff.SystTypeOp_Ref == CS_NEWCRD)
         result.MsgID = MakeOperation(ObjectN, ObjectID, TypeOpBuff.TypeOperNumber, CurCode, OpDate, 0, "", "", 0);
      ELIF (TypeOpBuff.SystTypeOp_Ref == CS_CHANGE_SUM)
         result.MsgID = MakeOperation(ObjectN, ObjectID, TypeOpBuff.TypeOperNumber, CurCode, OpDate, 1, "", "", PaySum);
      ELIF (TypeOpBuff.SystTypeOp_Ref == CS_OPENACC)
         result.MsgID = MakeOperation(ObjectN, ObjectID, OP_ACC, CurCode, OpDate, ObjectN, 1);
      ELIF (TypeOpBuff.SystTypeOp_Ref == CS_OPCRD)
         var credit = TBFile ("credit_c.dbt", "r", 0, "credit_c.dbt", "loans.def");
         credit.rec.CreditNumber = ObjectN;
         credit.rec.Crd_Kind = ObjectID;
         var stat = credit.GetEQ();
         if (stat)
            copy(creditBuff, credit);
            result.MsgID = MakeOperation(ObjectN, ObjectID, TypeOpBuff.TypeOperNumber, CurCode, OpDate, creditBuff);
         else
            result.MsgID = -1;
            result.MsgText = "Договор не найден!";
            return result;
         end;

      //ELIF (TypeOpBuff.SystTypeOp_Ref == 94/*Константы еще нет*/)
      //   result.MsgID = -1; /*Операция "Открытие черновика договора из закрытого" не реализована в этой версии системы*/ 
      //   result.MsgText = "Операция \"Открытие черновика договора из закрытого\" не реализована в этой версии системы";
      //   return result;
      ELSE
            result.MsgID = -2;
            result.MsgText = "Ограничение реализации: функциональность не реализована в этой версии системы.";
            return result;
      END;
   ELSE
      result.MsgID = ExecLoansOperation(CredOperID, OpDate);

      IF (result.MsgID != 0)
         result.MsgID = -1 * result.MsgID;
      ELSE
         result.MsgID = CredOperID;
      END;
   END;

   LnSQLExec("SELECT " + result.MsgID + " FROM DUAL");

   IF (result.MsgID<=0)
      result.MsgText = GetMO_LoansError;
      result.MsgID = -1*GetMO_ErrorID;
   ELSE
      // Операция выполнена успешно - можно очистить все данные по данному договору 
      LNSQLExec("delete from dloans_tempary_dbt where t_hash = "+ hashCode);

      VAR Stage = CRSDCommand("SELECT COP.T_STAGEID_REF, op.T_STAGENAME FROM DCRD_OP_DBT cop, DOP_STAGE_DBT op WHERE "+
                              " COP.T_CREDOPERID = ? AND COP.T_STAGEID_REF = op.T_STAGEID",
                              "p1", result.MsgID,
                               V_GENOBJ);
      IF (Stage.MoveNext() AND (Stage.Value(0) != CF_COMPLIT))
         result.MsgText = "Выполнение операции. Операция выполнена до стадии " + Stage.Value(1);
      END;
   END; 
   RETURN result;
OnError(err)
   result.MsgID = -1 * Err.Code;
   result.MsgText = Err.Message;
   RETURN result;
END;

MACRO GetCrdCnrtList(clientid : integer)
   VAR query = " SELECT t_creditnumber as id, t_credittypeid_ref as typecrd, t_uscreditnumber as crnumber, t_regdate as regdate, "
              " t_creditsum as sum, t_curcode as curcode, t_crd_kind as crd_kind "
              " FROM dcredit_c_dbt "
              " WHERE ";
   VAR CreditContr;
  
   query = query + " t_clientid_ref = " + string(clientid);
   
   println("*** GetCreditList ***");
   println(query);              

   VAR cmd = RsdCommand( query );
   VAR rs = rsdRecordSet( cmd );
   VAR result = TArray();

   rs.Command.NullConversion = true;

   WHILE (rs.moveNext())
      CreditContr = CCreditContr();
      CreditContr .Id              = rs.value("id");
      CreditContr .CreditType      = rs.value("typecrd");
      CreditContr .Number          = rs.value("crnumber");
      CreditContr .RegDate         = rs.value("regdate");
      CreditContr .Sum             = money(rs.value("sum"));
      CreditContr .Curcode        = rs.value("curcode");
      CreditContr .Code= LnSelectValue("select f.T_CCY from dfininstr_dbt f where f.t_fiid = " + string(CreditContr.Curcode), V_STRING);
      CreditContr .Crd_kind       = rs.value("crd_kind");
      result.value(result.Size) = CreditContr;
   END;
  
   RETURN result;
END;

MACRO GetTypeList(LObjectType: integer, LegalType: integer, CurDate: date, TypeCreditId: integer, CurCode: integer)
   VAR query = " SELECT t.T_CREDITTYPEID as id, t.T_CREDITTYPENAME as name, t.T_TYPEOVERDRAFT as overdraft, c.T_SHORT_NAME as curname "
              " FROM dtype_crd_dbt t"
              " INNER JOIN dcurrency_dbt c"
              " ON t.t_curcode = c.t_code_currency"
              " WHERE";
   VAR CreditType;
  
   query = query + " t.t_typedebtor = " + string(LegalType);
   query = query + " AND t.t_objecttypeid = " + string(LObjectType);
   query = query + " AND :CurDate BETWEEN t.t_begdate AND t.t_enddate";
   
   if (TypeCreditId > 0) query = query + " AND t.t_credittypeid = " + string(TypeCreditId); END;
   if (CurCode > 0) query = query + " AND t.t_curcode = " + string(CurCode); END;             

   VAR cmd = RsdCommand( query );
   cmd.addParam("CurDate", RSDBP_IN, CurDate);
   VAR rs = rsdRecordSet( cmd );
   VAR result = TArray();
   VAR pos = 0;   

   rs.Command.NullConversion = true;

   WHILE (rs.moveNext())
      CreditType = CCreditType();
      CreditType .Id     = rs.value("id");
      CreditType .Name   = rs.value("name");
      CreditType .Type   = rs.value("overdraft");
      CreditType .Code   = rs.value("curname");
      result.value(pos) = CreditType;
      pos = pos + 1;
   END;
  
   RETURN result;
END;

// 3.11  Сервис источника данных для виджета СПИ
// ObjectID     - Вид объекта
// ObjectNumber - Номер объекта
// TypeAcc      - ID счета другой подсистемы
MACRO getAccountExtData
      (
       ObjectID     : integer , 
       ObjectNumber : integer, 
       TypeAcc      : integer
      )
   //
   VAR CreditNumber: integer = 0,
       IgCrdAccID  : integer = 0;

   RECORD duty_crd("DUTY_CRD.DBT");
   RECORD credit_c("CREDIT_C.DBT");

   VAR IGSETACC = TBFile ("IGSETACC.DBT", "R", 0);

   IF ((ObjectID == LO_DUTY) OR (ObjectID == LO_BANKGUARANTEE))
      IF (Loans_FindDuty(ObjectNumber, duty_crd) AND Loans_FindCrdContract(duty_crd.CreditNumber_Ref, credit_c))
         CreditNumber = credit_c.CreditNumber;
      END;
   ELSE
      IF (Loans_FindCrdContract(ObjectNumber, credit_c))
         CreditNumber = credit_c.CreditNumber;
      END;
   END;

   IgCrdAccID = CRSDCommand("SELECT MIN (igc.t_setaccid) KEEP (DENSE_RANK FIRST ORDER BY MAX (igc.t_usepriority) ASC) "+
                            " FROM digcrdacc_dbt igc " +
                           " WHERE igc.t_creditnumber = ? " + 
                             " AND igc.t_typeaccid    = ? " +
                             " AND igc.T_USEPRIORITY  >= ? " +
                           " GROUP BY igc.t_setaccid",
                           "p1", CreditNumber,
                           "p2", TypeAcc,
                           "p3", 0,
                           V_INTEGER);

   IGSETACC.CLEAR();
   IGSETACC.rec.SetTAccID = IgCrdAccID;
   IGSETACC.GetEQ();
   RETURN TSetAccountEx(TypeAcc, IGSETACC.rec.ACCOUNT, 
                                 IGSETACC.rec.FIID,  
                                 IGSETACC.rec.PARTYID, 
                                 IGSETACC.rec.INN, 
                                 IGSETACC.rec.RECNAME, 
                                 IGSETACC.rec.OPERDPRT, 
                           TBank(IGSETACC.rec.BANKID, IGSETACC.rec.BANKCODEKIND, IGSETACC.rec.BANKCODE, IGSETACC.rec.BankName), 
                           TBank(IGSETACC.rec.BankCorrID, IGSETACC.rec.BankCorrCodeKind, IGSETACC.rec.BankCorrCode,  IGSETACC.rec.BankCorrName),
                                 IGSETACC.rec.Description,
                                 GetSPIAccountRest(ObjectID, ObjectNumber, IGSETACC.rec.SetTAccID),
                                 IGSETACC.rec.Chapter);
END;


// 3.9   Сервис получения параметров вида операции
// Назначение: Возвращает параметры использования СПИ по номеру операции. В дальнейшем возможно расширение возвращаемых параметров
MACRO getTypeOp(TypeOpID     : integer, 
                TypeOpNumber : integer,
                ObjectID     : integer , 
                ObjectNumber : integer)
   CLASS CTypeOp
      VAR ErrID        : integer;
      VAR MsgText      : string;
      VAR TypeOpID     : integer;
      VAR TypeOpNumber : integer;
      VAR TypeOpName   : string;
      VAR TypeAcc      : integer;
      VAR IsExec       : integer;
      VAR CredOperID   : integer;
      VAR SetAccountEx : TSetAccountEx;
   END;

   RECORD type_op ("type_op.dbt");
   VAR TypeOp: CTypeOp;
   
   TypeOp.errID = 0;
   TypeOp.MsgText = "";

   IF   ((ValType(TypeOpNumber) == V_INTEGER) AND (TypeOpNumber > 0))
      IF (NOT Loans_FindTypeOp(TypeOpNumber, 0, type_op))
         TypeOp.errID = 1;
         TypeOp.MsgText = "Не найдена операция " + TypeOpNumber;

         RETURN TypeOp;
      END;
   ELIF ((ValType(TypeOpID) == V_INTEGER) AND (TypeOpID > 0))
      IF (NOT Loans_FindTypeOp(0, TypeOpID, type_op))
         TypeOp.errID = 1;
         TypeOp.MsgText = "Не найдена операция " + TypeOpID;

         RETURN TypeOp;
      END;
   ELSE
      TypeOp.errID = 1;
      TypeOp.MsgText = "Не задана операция";

      RETURN TypeOp;
   END;

   // Найдем последнюю НЕ ВЫПОЛНЕННУЮ операцию
   VAR CredOperID = 
   CRSDCommand ("SELECT T_CredOperID FROM DCRD_OP_DBT WHERE T_CREDOPERID = LoansKernel.lastopid(?, ?, ?) AND T_STAGEID_REF <> ?",
                         "p1", ObjectID,
                         "p2", ObjectNumber,
                         "p3", type_op.SystTypeOp_Ref,
                         "p4", CF_COMPLIT,
                         V_INTEGER);


   // Определим возможность выполнения
   VAR cmd = RsdCommand(RslDefCon, "BEGIN ? := LoansOperation.RSI_CheckStagePostOp (?, ?, ?, ?, ?); END;");

   cmd.addParam( "retval", RSDBP_RETVAL, V_INTEGER );

   cmd.addParam("CredOperID",     RSDBP_IN); cmd.Value("CredOperID")     = CredOperID;
   cmd.addParam("OperTypeNumber", RSDBP_IN); cmd.Value("OperTypeNumber") = type_op.TypeOperNumber;
   cmd.addParam("StageID",        RSDBP_IN); cmd.Value("StageID")        = 0;
   cmd.addParam("IsDel",          RSDBP_IN); cmd.Value("IsDel")          = "";
   cmd.addParam("Reverse",        RSDBP_IN); cmd.Value("Reverse")        = 0;

   cmd.execute();

   IF (cmd.value(0) == 0)
      TypeOp.errID = 1;
      TypeOp.MsgText = "Вашей должности запрещено выполнять операцию!";

      RETURN TypeOp;
   END;

   TypeOp.TypeOpID     = type_op.TypeOperID;
   TypeOp.TypeOpNumber = type_op.TypeOperNumber;
   TypeOp.TypeOpName   = type_op.TypeOperName;
   TypeOp.CredOperID   = CredOperID;

   IF (type_op.IsIgTypeAccID == "X")
      TypeOp.TypeAcc   = type_op.TypeAccID;

      TypeOp.SetAccountEx = getAccountExtData
                            (
                             ObjectID, 
                             ObjectNumber, 
                             TypeOp.TypeAcc
                            );
   ELSE
      TypeOp.TypeAcc   = 0;
   END;

   IF (type_op.IsExecOperation == "X")
      TypeOp.IsExec    = 1;
   ELSE
      TypeOp.IsExec    = 0;
   END;

   RETURN TypeOp;
END;

// 3.14 Сервис источника данных для операции <Выдача>
// ObjectID     - Вид объекта
// ObjectNumber - Номер объекта
// OpDate       - дата расчета
MACRO getPayOpData(ObjectID: integer, ObjectNumber: integer, OpDate: date, CredOperID: integer)
   CLASS CLnsPayOpWidget
      VAR OpDate: date;
      VAR paySum: money;
      VAR CurCode: integer;
      VAR CurName: string;
   END;

   RECORD credit ("credit_c.dbt");
   RECORD duty_crd ("duty_crd.dbt");

   VAR LnsPayOpWidget: CLnsPayOpWidget;

   LnsPayOpWidget.PaySum = $0;
   LnsPayOpWidget.OpDate = OpDate;

   IF (CredOperID)
      VAR RS =
      CRSDCommand("SELECT T_CREDOPERDATE, T_PAYSUM FROM DLPAYOP_DBT pay_op, DCRD_OP_DBT cop  WHERE " +
                        " cop.T_CREDOPERID = ? "
                    " AND pay_op.T_CREDOPERID_REF = cop.T_CREDOPERID ",
                  "p1", CredOperID,
                  V_GENOBJ);

      IF (RS.MoveNext())
         LnsPayOpWidget.PaySum = RS.Value("T_PAYSUM",         NULL, V_MONEY);
         LnsPayOpWidget.OpDate = RS.Value("T_CREDOPERDATE",   NULL, V_DATE);
      END;
   ELSE
      IF (ObjectID == LO_DUTY)
         IF (Loans_FindDuty(ObjectNumber, duty_crd))
            LnsPayOpWidget.PaySum = duty_crd.DutySum;
         END;
      ELSE
         IF (Loans_FindCrdContract(ObjectNumber, Credit))
            LnsPayOpWidget.PaySum = Credit.CreditSum;
             LnsPayOpWidget.CurCode = Credit.CurCode;
             LnsPayOpWidget.CurName = LnSelectValue("select f.T_CCY from dfininstr_dbt f where f.t_fiid = " + string(Credit.CurCode), V_STRING);
         END;
      END;
   END;

   RETURN LnsPayOpWidget;
END;

CLASS CAccList
   VAR TypeAccount : String;
   VAR Account     : CLnsMaskedAccount;
   VAR Rest        : Money;
   VAR ClientName  : String;

   VAR Bank        : TBank;
   VAR BankCorr    : TBank;

   MACRO Construct()
      TypeAccount = "";
      Account     = CLnsMaskedAccount();
      Rest        = $0;
      ClientName  = "";
   END;

   this.Construct();
END;

MACRO GetAccountList(ObjN: integer, TypeAcc: integer)
   VAR RS = CRSDCommand(" SELECT T_NAME, T_ACCOUNT, ig.T_CHAPTER chapter, T_RECNAME, T_BANKID, T_BANKCODEKIND, T_BANKCODE, T_BANKNAME, T_BANKCORRID, T_BANKCORRCODEKIND, T_BANKCORRCODE, T_BANKCORRNAME " +
                        " , T_SETACCID " +
                        " FROM DIGSETACC_DBT ig, DIGCRDACC_DBT ic, DIGTYPACC_DBT it WHERE " +
                                  " ig.T_SETTACCID = ic.T_SETACCID " +
                              " AND ic.T_TYPEACCID = IT.T_TYPEACCID " +
                              " AND ic.T_TYPEACCID = ? " +
                              " AND ic.T_CREDITNUMBER = ? " + 
                              " ORDER BY IC.T_USEPRIORITY",
                           "p1", TypeAcc,
                           "p2", ObjN,
                           V_GENOBJ);
   VAR AccList; VAR result = TArray();
   WHILE (RS.moveNext())
      AccList = CAccList();
      AccList.TypeAccount = rs.value("T_NAME");
      AccList.Account.Account = rs.value("T_ACCOUNT");
      AccList.Account.Chapter = rs.value("chapter");
      AccList.Rest        = BankAccRest(rs.value("T_SETACCID"), ObjN);
      AccList.ClientName  = rs.value("T_RECNAME");

      AccList.Bank        = TBank(rs.value("T_BANKID"),     rs.value("T_BANKCODEKIND"),     SQL_NVL(rs.value("T_BANKCODE"), V_STRING),     SQL_NVL(rs.value("T_BANKNAME"), V_STRING));
      AccList.BankCorr    = TBank(rs.value("T_BANKCORRID"), rs.value("T_BANKCORRCODEKIND"), SQL_NVL(rs.value("T_BANKCORRCODE"), V_STRING), SQL_NVL(rs.value("T_BANKCORRNAME"), V_STRING));

      result.value(result.Size) = AccList;
   END;
  
   RETURN result;
END;

CLASS CLnsDocument 
   VAR DocAccID        : integer;
   VAR AccDebit        : CLnsMaskedAccount;
   VAR AccCredit       : CLnsMaskedAccount;
   VAR CarrySum        : money;
   VAR CarrySumCredit  : money;
   VAR CurShortNameDeb : string;
   VAR CurShortNameCred: string;
   VAR Kurs            : money;
   VAR State           : string;
   VAR isPrint         : bool;
END;

MACRO getlistDocOp(CredOpID: integer)
   VAR rs = CRSDCommand("SELECT * FROM DDOC_ACC_DBT WHERE T_CREDOPERID_REF = ? AND T_ISDELETED = ? ORDER BY T_DOCACCID",
                        "p1", CredOpID,
                        "p2", 0,
                       V_GENOBJ);
   VAR DocOp = NULL; VAR result = TArray();
   rs.NullConversion = True;
   WHILE (rs AND rs.MoveNext())
      DocOp = CLnsDocument();
      DocOp.DocAccID          = RS.Value("T_DOCACCID",       0, V_INTEGER);
      DocOp.AccDebit.Account  = RS.Value("T_DEBIT",          0, V_STRING);
      DocOp.AccCredit.Account = RS.Value("T_CREDIT",         0, V_STRING);
      DocOp.AccDebit.Chapter  = DocOp.AccCredit.Chapter = RS.Value("T_CHAPTER", 0, V_STRING);
      DocOp.CarrySum          = RS.Value("T_CARRYSUM",       0, V_MONEY);
      DocOp.CarrySumCredit    = RS.Value("T_CARRYSUMCREDIT", 0, V_MONEY);
      DocOp.CurShortNameDeb   = FindShortName(RS.Value("T_CURCODE",       0, V_INTEGER));
      DocOp.CurShortNameCred  = FindShortName(RS.Value("T_CURCODECREDIT", 0, V_INTEGER));
      DocOp.Kurs              = 0;
      IF (DocOp.CarrySumCredit != 0)
         DocOp.Kurs = DocOp.CarrySum/DocOp.CarrySumCredit;
      END;

      DocOp.State            = GetNameAlg(1015, RS.Value("T_STATE", 0, V_INTEGER));
      DocOp.isPrint          = false;

      result.value(result.Size) = DocOp;
   END;

   RETURN result;
END;

CLASS CLnsChangeRegistry 
   VAR RegName          : string    = "";
   VAR SumChange        : money     = Money(0);
   VAR DateChange       : DateTime;
   VAR ObjectTypeName   : string    = "";
   VAR ObjectNumber     : string    = "";
END;

MACRO GetOpChangeRegistry(CredOperID: integer)
  VAR result = TArray(), obj = CLnsChangeRegistry(); 
  VAR rs = TRsbDataSet(" SELECT * FROM dcrd_op_dbt WHERE t_CredOperID = " + CredOperID);
  VAR mainTable = "", opID = CredOperID, queryStr = "";

   if (rs.MoveNext)
       if (rs.OperationType == "И")
           mainTable = "drlt_chsum_dbt";
           opID = rs.CorrectOperation;
      elif (rs.OperationType == "С")
           mainTable = "drlt_chsum_dbt";
           opID = CredOperID;
       else
           mainTable = "dlchsumrg_dbt";
           opID = CredOperID;
       END;

       queryStr = "select ttt.t_Name, t.t_Sum, t.t_Date, tttt.t_ShortName, LoansUserFunction.getusobjnum(tt.t_ObjectTypeID, tt.t_ObjectNumber) as t_objnum ";
       queryStr = queryStr + " from " + mainTable + " t, dlcusreg_dbt tt, dspr_reg_dbt ttt,";
       queryStr = queryStr + " dlobject_dbt tttt where t.t_CredOperID_Ref = " + opID;
       queryStr = queryStr + " and t.t_UsRegID_Ref = tt.t_ID and tt.t_RegID = ttt.t_RegID";
       queryStr = queryStr + " and tttt.t_ObjectID = tt.t_ObjectTypeID";
       queryStr = queryStr + " and (";
       queryStr = queryStr + "      (tt.t_ObjectTypeID <> 6) or";
       queryStr = queryStr + "      (";
       queryStr = queryStr + "       (tt.t_ObjectTypeID = 6) and";
       queryStr = queryStr + "       (tt.t_ObjectNumber not in (select duty.t_DutyID from dduty_crd_dbt duty where duty.t_Systtype = 1))";
       queryStr = queryStr + "      )";
       queryStr = queryStr + "     )";

       VAR mainRs = TRsbDataSet(queryStr);   
       while (mainRs.moveNext)
           obj = CLnsChangeRegistry();

           obj.RegName        = mainRs.Name;
           obj.SumChange      = mainRs.Sum;
           obj.DateChange     = mainRs.Date;
           obj.ObjectTypeName = mainRs.ShortName;
           obj.ObjectNumber   = mainRs.objnum;
       
           result.value(result.Size) = obj;
      END;
   END;

   RETURN result;
END;

CLASS CLnsStageOp 
    VAR Date      : DateTime;
    VAR Time      : DateTime;
    VAR Oper      : integer  = 0;
    VAR StageName : string   = "";
    VAR StageID   : integer  = 0;
END;

MACRO GetOpStage(CredOperID: integer)
   VAR result = TArray(), obj = NULL; 
   VAR rsCommon = TRsbDataSet("select lcs.t_date, lcs.t_syscarrytime, lcs.t_oper, " +
                             "ops.t_StageName, ops.t_StageID from dcopstage_dbt lcs, dop_stage_dbt ops " +
                             "where lcs.t_CredOperID_Ref = " + CredOperID + 
                             " and lcs.t_StageID_ref = ops.t_StageID");
   WHILE (rsCommon.MoveNext)
      obj = CLnsStageOp();

      obj.Date       = rsCommon.date;
      obj.Time       = DtTm(date(rsCommon.date), time(rsCommon.syscarrytime));
      obj.Oper       = rsCommon.oper;
      obj.StageName  = rsCommon.StageName;
      obj.StageID    = rsCommon.StageID;

      result.value(result.Size) = obj;
   END;

   return result;
END;

CLASS CLnsParmOperUNI 
   VAR OpType : string   = "";
   VAR OpName : string   = "";
   VAR OpDate : DateTime;
   VAR OpSum  : money    = Money(0);
   VAR FI_ISO : string   = "";
END;

MACRO GetParmOperUNI(CredOperID: integer)
   VAR result = CLnsParmOperUNI();
 
   VAR rsCommon = TRsbDataSet("select cop.t_operationtype, top.t_typeopername, cop.t_credoperdate from dcrd_op_dbt cop, dtype_op_dbt top " +
                              "where cop.t_credoperid = " + CredOperID + " and top.t_typeopernumber = cop.t_opertypenumber_ref");
   IF (rsCommon.MoveNext)
      result.OpType = rsCommon.operationtype;
      result.OpName = rsCommon.typeopername;
      result.OpDate = rsCommon.credoperdate;
   END;

   VAR   RSDcmd = RsdCommand(RslDefCon, "BEGIN loansuserfunction.GetOperationInfo ( ?,?,?,?,? ); END;");
   RSDcmd.addParam("p1", RSDBP_IN); RSDcmd.Value ("p1") = CredOperID;
   RSDcmd.addParam("p2", RSDBP_OUT, V_INTEGER);
   RSDcmd.addParam("p3", RSDBP_OUT, V_STRING);
   RSDcmd.addParam("p4", RSDBP_OUT, V_STRING);
   RSDcmd.addParam("p5", RSDBP_OUT, V_STRING);
   RSDcmd.execute();
   result.FI_ISO  = FindShortName(RSDcmd.Value ("p2"));

   VAR rsSum = CRSDCommand("select NVL(SUM( " +
                            "               case  " +
                            "                 when doc.t_curcode = ? then doc.t_carrysum " +
                            "                 when doc.t_curcodecredit = ? then doc.t_carrysumcredit " +
                            "                 else 0  " +
                            "               end " +
                            "              ), 0) as sumOp " +
                            "from ddoc_acc_dbt doc,  dstep_op_dbt step where doc.t_credoperid_ref = " + CredOperID + 
                            " and doc.t_isdeleted = 0 " + 
                            "and step.t_ForOperSum = 'X' and doc.t_stepid = step.t_stepid",
                            "p1", RSDcmd.Value ("p2"),
                            "p2", RSDcmd.Value ("p2"),
                            V_MONEY);
   result.OpSum   = rsSum;

   RETURN result;
END;

CLASS CGetHistrOper
   VAR CredOperID : integer  = 0;
   VAR SystemOperationID : integer  = 0;
   VAR TypeOperationID: integer = 0;
   VAR TypeOp     : string   = 0;
   VAR NameOp     : string   = "";
   VAR CarrySum   : Money    = Money(0);
   VAR CurCode    : string   = "";
   VAR Stage      : string   = "";
   VAR StageID    : integer  = 0;
   VAR OpDate     : DateTime;
   VAR OpTime     : DateTime;
   VAR Oper       : string   = "";
   VAR TypeObj    : string   = "";
   VAR TypeObjFull: string   = "";
   VAR ObjN       : string   = "";
   VAR Flag       : string   = "";
END;

private macro GetSqlHOFilterCondition(FilterConditionItems)
    var fp = FilterParser( FilterConditionItems );
    fp.AddFieldCondition( 0, null, "CASE t.t_OperationType WHEN 'С' THEN 0 WHEN 'И' THEN 1 WHEN 'К' THEN 2 WHEN 'Ч' THEN 3 ELSE 4 END");
    fp.AddFieldCondition( 5, "t", "t_CredOperDate");
    fp.AddFieldCondition( 6, "t", "t_Oper");
    fp.AddFieldCondition( 7, null, "CASE tt.t_ShortName WHEN 'КД' THEN 0 WHEN 'БК' THEN 1 WHEN 'СО' THEN 2 ELSE 3 END");
    return fp.GetFullSQLCondition();
end;

private macro GetSqlParmFilterCondition(FilterConditionItems)
    
    var findex = 0;
    var vindex = 0;
    var FiIDs = Tarray;
    var Values = TArray;
    while (findex < FilterConditionItems.size())
        if (FilterConditionItems(findex).id == 3)
            while (vindex < FilterConditionItems(findex).Value.size())
                Values = FilterConditionItems(findex).Value;
                FiIDs(FiIDs.size()) = Values(vindex).fiid;
                vindex = vindex + 1;
            end;
            FilterConditionItems(findex).Value = FiIDs;
            FilterConditionItems(findex).ValueType = 8; // указываем, что это теперь целое число, а не объект фининструмента
        end;
        findex = findex + 1;
    end;

    var fp = FilterParser( FilterConditionItems );
    var SqlString = "", OpNameItem = NULL, StageItem = NULL;
    fp.AddFieldCondition( 2, "pt", "opSum");
    fp.AddFieldCondition( 3, "pt", "curCode");
    fp.AddFieldCondition( 4, "pt", "stageID");
    fp.AddFieldCondition( 8, "pt", "objN");
    SqlString = fp.GetFullSQLCondition();
    
    OpNameItem = lns_GetFilterConditionItem(1, FilterConditionItems);
    if (OpNameItem != NULL)
        SqlString = SqlString + " and " + GetFilterStringSQLCondition(OpNameItem, "pt.opName", true, false);
    end;
    
    return SqlString;
end;

private macro GetHistrOperQuery(ObjectID: integer,
                                ObjectNumber: integer,
                                filterConditionItems)
   VAR queryStr = ""; 
   queryStr = queryStr + "select cast(t.t_credoperid as number(32,12)) as t_credoperid1, t.*, tt.t_ShortName, tt.t_ObjectName ";                  
   queryStr = queryStr + "from dcrd_op_dbt t, dlobject_dbt tt where ";
   queryStr = queryStr + "(t.t_IsDeleted = 0) ";
   queryStr = queryStr + "and (tt.t_ObjectID = t.t_ObjectTypeID_ref) ";
   IF ((ObjectID == LO_CREDIT) or
       (ObjectID == LO_KARTA) or
       (ObjectID == LO_OVERDRAFT))
       queryStr = queryStr + " and ((t.t_CreditNumber_Ref = " + ObjectNumber + " and t.t_ObjectTypeID_Ref in (" +ObjectID + ", 6))";
       queryStr = queryStr + " or (t.t_ObjectTypeID_Ref = 4 and t.t_ObjectID_Ref in (select t_EnsContractID_Ref from dens_crd_dbt where t_CreditNumber_Ref = " + ObjectNumber + "))";
       queryStr = queryStr + " or (t.t_CreditNumber_Ref = " + ObjectNumber + " and t.t_ObjectTypeID_Ref = 20 and t.t_OperTypeNumber_Ref = 67))";
   ELIF (ObjectID == LO_DEPOSIT)
       queryStr = queryStr + "and ((t.t_OBJECTTYPEID_REF = " + ObjectID + " and t.t_OBJECTID_REF = " + ObjectNumber + ")";
       queryStr = queryStr + " or (t.t_CreditNumber_Ref = " + ObjectNumber + " and t.t_ObjectTypeID_Ref = 20 and t.t_OperTypeNumber_Ref = 67))";
   ELIF ((ObjectID == LO_CLAIM) or 
         (ObjectID == LO_DUTY))
       queryStr = queryStr + "and (t.t_OBJECTTYPEID_REF = " + ObjectID + " and t.t_OBJECTID_REF = " + ObjectNumber + ")"; 
   END;
   
   if (FilterConditionItems != null) /* начальная фильтация */
      var sqlFilterCondition = GetSqlHOFilterCondition(filterConditionItems);
      
      if(sqlFilterCondition != "")
         queryStr = queryStr + "AND" + sqlFilterCondition;
      end;
   end;

    return queryStr;
END;

MACRO GetHistrOper(pagesize : integer,
                   pagenum  : integer,
                   ObjectID: integer,
                   ObjectNumber: integer,
                   orderitems,
                   filterConditionItems)
   VAR result = TArray(), obj = CGetHistrOper(); 
   VAR ParmOper = NULL, StageOper = NULL; 
   VAR queryStr = GetHistrOperQuery(ObjectID, ObjectNumber, filterConditionItems);

   queryStr = "select rownum as rnum, t.* from (" + queryStr;

   VAR stat = 0, OrderBy = 0;
   GetRegistryValue("RS-LOANS\\СОРТИРОВКА_ОПЕРАЦИЙ", V_INTEGER, OrderBy, stat);
   IF (OrderBy) 
       queryStr = queryStr + "order by t.t_CredOperDate asc, t.t_CredOperID asc";
   ELSE
       queryStr = queryStr + "order by t.t_CredOperDate desc, t.t_CredOperID desc";
   END;

   queryStr = queryStr + ") t";

   IF (pagesize > 0)
       queryStr = "select * from (" + queryStr + " ) where rnum between " + (pagenum*pagesize + 1) + " and " + ((pagenum + 1)*pagesize)
   END;

   VAR rs = TRsbDataSet(queryStr);
   
   if (FilterConditionItems != null) /* окончательная фильтация */
       var sqlFilterCondition = GetSqlParmFilterCondition(filterConditionItems);
   end;
   
   WHILE (rs.moveNext)
      obj = CGetHistrOper();

      ParmOper  = GetParmOperUNI(rs.CredOperID1);
      StageOper = GetOpStage(rs.CredOperID1);

      VAR   RSDcmd = RsdCommand(RslDefCon, "BEGIN loansuserfunction.GetOperationInfo ( ?,?,?,?,? ); END;");
      RSDcmd.addParam("p1", RSDBP_IN); RSDcmd.Value ("p1") = rs.CredOperID1;
      RSDcmd.addParam("p2", RSDBP_OUT, V_INTEGER);
      RSDcmd.addParam("p3", RSDBP_OUT, V_STRING);
      RSDcmd.addParam("p4", RSDBP_OUT, V_STRING);
      RSDcmd.addParam("p5", RSDBP_OUT, V_STRING);
      RSDcmd.execute();
      
      var flag = crsdcommand("select C.T_FLAG from dsyst_op_dbt c where T_SYSTEMOPERATIONID = :p0", ":p0", rs.SystemOperationID, V_STRING);

      obj.CredOperID = rs.CredOperID1;
      obj.SystemOperationID = rs.SystemOperationID;
      obj.TypeOperationID   = rs.OperTypeNumber_Ref;
      obj.TypeOp     = ParmOper.OpType;
      obj.NameOp     = ParmOper.OpName;
      obj.CarrySum   = ParmOper.OpSum;
      obj.CurCode    = ParmOper.FI_ISO;
      obj.Stage      = StageOper[StageOper.size - 1].StageName;
      obj.StageID    = StageOper[StageOper.size - 1].StageID;
      obj.OpDate     = ParmOper.OpDate;
      obj.OpTime     = StageOper[StageOper.size - 1].Time;
      obj.Oper       = rs.Oper;
      obj.TypeObj    = rs.ShortName;
      obj.TypeObjFull= rs.ObjectName;     
      obj.ObjN       = SQL_NVL(RSDcmd.Value ("p5"), V_STRING);
      obj.Flag       = flag;

      var approp = true; 
      if (FilterConditionItems != null) /* окончательная фильтация */
        if(sqlFilterCondition != "")
            var ParmFilterQuery = "select 1 from (select "+ 
                                    "'"+ obj.NameOp+ "' as opName, "+ 
                                    obj.CarrySum+ " as opSum, "+
                                    "(select t_fiid from dfininstr_dbt where t_ccy = '"+ obj.CurCode+"') as curCode, "+
                                    obj.StageID + " as stageID, "+
                                    "'"+ obj.ObjN+ "' as objN from dual) pt where "+
                                    sqlFilterCondition;

            if ( not(TRsbDataSet(ParmFilterQuery).moveNext()) )
                approp = false;
            end;
        end;
      end;

      if ( approp )
        result.value(result.Size) = obj;
      end;
      
   END;

   RETURN result;
END;

// Скроллинг "Все операции"
CLASS CLnsOperItem()
    VAR CredOperID: integer = 0;
    VAR SystemOperationID: integer = 0;
    VAR TypeOperationID: integer = 0;
    VAR LnsObjID: integer = 0;
    VAR LnsObjN: integer = 0;
    VAR TypeOp: string = "";
    VAR NameOp: string = "";
    VAR CarrySum: Money = $0;
    VAR CurCode: string = "";
    VAR Stage: string = "";
    VAR StageID: integer = 0;
    VAR OpDate: DateTime = Date(0,0,0);
    VAR OpTime: DateTime = Date(0,0,0);
    VAR Oper: string = "";
    VAR TypeObj: string = "";
    VAR TypeObjFull: string = "";
    VAR ObjN: string = "";
    VAR ClientName: string = "";
    VAR ClientID: integer = 0;
    VAR ClientObjN: string = "";
END;

MACRO GetAllOperPostQuery(FilterConditionItems)
    var FilterString = "";
    var fp = FilterParser( FilterConditionItems );
    var findex = 0;
    var vindex = 0;
    var FiIDs = Tarray;
    var Values = TArray;
    if ( FilterConditionItems != null)
    	while (findex < FilterConditionItems.size())
        	if (FilterConditionItems(findex).id == 6)
            	while (vindex < FilterConditionItems(findex).Value.size())
                	Values = FilterConditionItems(findex).Value;
                	FiIDs(FiIDs.size()) = Values(vindex).fiid;
                	vindex = vindex + 1;
            	end;
            	FilterConditionItems(findex).Value = FiIDs;
            	FilterConditionItems(findex).ValueType = 8; // указываем, что это теперь целое число, а не объект фининструмента
        	end;
        	findex = findex + 1;
    	end;
        
    	var OpNameItem = NULL, StageItem = NULL;
        fp.AddFieldCondition( 3, "pt", "objN");
    	fp.AddFieldCondition( 5, "pt", "opSum");
    	fp.AddFieldCondition( 6, "pt", "curCode");
        fp.AddFieldCondition( 7, "pt", "stageID");
        FilterString = fp.GetFullSQLCondition();
        OpNameItem = lns_GetFilterConditionItem(4, FilterConditionItems);
    	if (OpNameItem != NULL)
        	FilterString = FilterString + " and " + GetFilterStringSQLCondition(OpNameItem, "pt.opName", true, false);
    	end;
    else
        FilterString = "";
    end;
    return FilterString;
END;

MACRO GetAllOperQuery(ListType, FilterConditionItems)
    var FilterString = "";
    if (FilterConditionItems != null)   
	var fp = FilterParser( FilterConditionItems );    
    	fp.AddFieldCondition( 1, null, "CASE t.t_OperationType WHEN 'С' THEN 0 WHEN 'И' THEN 1 WHEN 'К' THEN 2 WHEN 'Ч' THEN 3 ELSE 4 END");
    	fp.AddFieldCondition( 2, "tt", "t_objectid ");
    	fp.AddFieldCondition( 8, "t", "t_CredOperDate");
    	fp.AddFieldCondition( 9, "t", "t_CreditNumber_ref");
    	fp.AddFieldCondition( 10, "t", "t_Oper");
	    
    	FilterString = fp.GetFullSQLCondition();

    else
        FilterString = "";
    end;


    var queryStr = "";
    queryStr = queryStr + "select t.*, tt.t_ShortName, tt.t_ObjectName, prd.t_docnumber ";                  
    queryStr = queryStr + "from dcrd_op_dbt t, dlobject_dbt tt, dprdclient_dbt prd where ";
    queryStr = queryStr + "(t.t_IsDeleted = 0) ";
    queryStr = queryStr + "and (tt.t_ObjectID = t.t_ObjectTypeID_ref) and (CAST(t.t_objectid_ref AS VARCHAR(40)) = prd.t_objectid(+)) ";
    if (FilterString != "")
    	queryStr = queryStr + "and " + FilterString;
    end;
    
    if (ListType == 1) // операции с документами
        queryStr = "select T.* from (" + queryStr + ") T, DDOC_ACC_DBT DOC";
        queryStr = queryStr + " WHERE T.T_CREDOPERID = DOC.T_CREDOPERID_REF";
    elif (ListType == 2) // Операции к выполнению 
        queryStr = queryStr + " AND T.T_STAGEID_REF != " + CF_COMPLIT;
        queryStr = queryStr + " AND LOANSOPERATION.RSI_CheckStagePostOp (T.T_CREDOPERID, T.T_OPERTYPENUMBER_REF, 0, T.T_ISDELETED, 0) != 0 ";
    elif (ListType == 3) // Неподтверженные перации
        queryStr = queryStr + " AND T.T_STAGEID_REF != 0 AND T.T_STAGEID_REF != " + CF_COMPLIT;
        queryStr = queryStr + " AND LOANSOPERATION.RSI_CheckStagePostOp (T.T_CREDOPERID, T.T_OPERTYPENUMBER_REF, 0, T.T_ISDELETED, 0) != 1 ";
    else
        ; //не добавляем никаких условий. (все операции)
    end;
    
    return queryStr;
END;

MACRO GetAllOper(  listType : integer,
                   pagesize : integer,
                   pagenum  : integer,
                   orderitems,
                   filterConditionItems)
    VAR result = TArray(),
        obj = null,
        ParmOper = null,
        StageOper = null,
        queryStr = GetAllOperQuery(listType, filterConditionItems),
        sqlFilterCondition = GetAllOperPostQuery(FilterConditionItems);
    queryStr = "select rownum as rnum, t.* from (" + queryStr;

    VAR stat = 0, OrderBy = 0;
    GetRegistryValue("RS-LOANS\\СОРТИРОВКА_ОПЕРАЦИЙ", V_INTEGER, OrderBy, stat);
    IF (OrderBy) 
        queryStr = queryStr + " order by t.t_CredOperDate asc, t.t_CredOperID asc";
    ELSE
        queryStr = queryStr + " order by t.t_CredOperDate desc, t.t_CredOperID desc";
    END;

    queryStr = queryStr + ") t";

    IF (pagesize > 0)
        queryStr = "select * from (" + queryStr + " ) where rnum between " + (pagenum*pagesize + 1) + " and " + ((pagenum + 1)*pagesize)
    END;

    VAR rs = RsdRecordset(queryStr);
    WHILE (rs.moveNext)
        obj = CLnsOperItem();

        ParmOper  = GetParmOperUNI(rs.value("t_credoperid", NULL, V_INTEGER));
        StageOper = GetOpStage(rs.value("t_credoperid", NULL, V_INTEGER));

        VAR   RSDcmd = RsdCommand(RslDefCon, "BEGIN loansuserfunction.GetOperationInfo ( ?,?,?,?,? ); END;");
        RSDcmd.addParam("p1", RSDBP_IN); RSDcmd.Value ("p1") = rs.value("t_credoperid", NULL, V_INTEGER);
        RSDcmd.addParam("p2", RSDBP_OUT, V_INTEGER);
        RSDcmd.addParam("p3", RSDBP_OUT, V_STRING);
        RSDcmd.addParam("p4", RSDBP_OUT, V_STRING);
        RSDcmd.addParam("p5", RSDBP_OUT, V_STRING);
        RSDcmd.execute();
        obj.CredOperID = rs.value("t_credoperid", NULL, V_INTEGER);
        obj.SystemOperationID = rs.value("t_SystemOperationID", NULL, V_INTEGER);
        obj.TypeOperationID   = rs.value("t_OperTypeNumber_Ref", NULL, V_INTEGER);
        obj.LnsObjID   = rs.value("t_ObjectTypeID_Ref", NULL, V_INTEGER);
        obj.LnsObjN    = rs.value("t_ObjectID_Ref", NULL, V_INTEGER);
        obj.TypeOp     = ParmOper.OpType;
        obj.NameOp     = ParmOper.OpName;
        obj.CarrySum   = ParmOper.OpSum;
        obj.CurCode    = ParmOper.FI_ISO;
        obj.Stage      = StageOper[StageOper.size - 1].StageName;
        obj.StageID    = StageOper[StageOper.size - 1].StageID;
        obj.OpDate     = ParmOper.OpDate;
        obj.OpTime     = StageOper[StageOper.size - 1].Time;
        obj.Oper       = rs.value("t_Oper", NULL, V_INTEGER);
        obj.TypeObj    = rs.value("t_ShortName", NULL, V_STRING);
        obj.TypeObjFull= rs.value("t_ObjectName", NULL, V_STRING);    
        obj.ObjN       = SQL_NVL(RSDcmd.Value ("p5"), V_STRING);
        if ((obj.LnsObjID == 1) and (ValType(rs.value("t_docnumber")) == V_STRING))
            obj.ClientObjN = rs.value("t_docnumber", null, V_STRING); 
        else 
            obj.ClientObjN = "";
        end;
        var approp = true;
        
        if (FilterConditionItems != null) /* окончательная фильтация */
            if(sqlFilterCondition != "")
                var ParmFilterQuery = "select 1 from (select "+ 
                                        "'"+ obj.NameOp+ "' as opName, "+ 
                                        obj.CarrySum+ " as opSum, "+
                                        "(select t_fiid from dfininstr_dbt where t_ccy = '"+ obj.CurCode+"') as curCode, "+
                                        obj.StageID+ " as stageID, "+
                                        "'"+ obj.ObjN+ "' as objN from dual) pt where "+
                                        sqlFilterCondition;

                if ( not(TRsbDataSet(ParmFilterQuery).moveNext()) )
                    approp = false;
                end;
            end;
        end;

        if ( approp )
            result.value(result.Size) = obj;
        end;
    end; 
    return result;
END;

MACRO GetAllOperCount(listType, filterConditionItems)
    VAR queryStr = "select count(1) as cnt from (" + GetAllOperQuery(listType, filterConditionItems) + ")";
   VAR rs = TRsbDataSet(queryStr);
   rs.moveNext();
   RETURN int(rs.cnt);
END;

MACRO LnsRunOperation(CredOperID : integer)
   VAR result:TWsMessage;

   result.MsgID   = ExecLoansOperation(CredOperID, {curdate});
   result.MsgText = GetMO_LoansError();

   RETURN  result;
END;

MACRO LnsRunListOperation(ListCredOperID)
    var index:integer= 0,
        result:TWsMessage,
        ResponseBuilder = WebResponseBuilder();
    while (index < ListCredOperID.Size)
        result = LnsRunOperation(ListCredOperID(index));
        if (result.MsgID > 0)
            ResponseBuilder.AddErrorEx( result.MsgID, MessageSeverity.RuntimeError, result.MsgText );
        else
            ResponseBuilder.AddErrorEx( result.MsgID, MessageSeverity.RuntimeError, "Операция выполнена успешно." );
        end;
        index = index + 1;
    end;
    return ResponseBuilder.Result;
END;

MACRO Lns_ClearResponsOperHistory(CredOperID : integer)
    var query, rsRec, objID : integer = 0, objTypeID: integer = 0;
    var queryDel: string = "", result : TWsMessage, stat : bool;
    
    result = TWsMessage();
    result.MsgText = "";
    result.MsgID = 0;
   
    query = "SELECT OP.T_OBJECTID_REF, OP.T_OBJECTTYPEID_REF" + 
           " FROM DCRD_OP_DBT OP" +
           " WHERE OP.T_CREDOPERID = " + CredOperID;
                 
    rsRec = RsdRecordset(query);

    while (rsRec.MoveNext)        
        objID = rsRec.fld(0).value; 
        objTypeID = rsRec.fld(1).value; 
    end;                 
   
    if (objTypeID == LO_CLAIM)  
        queryDel = "DELETE FROM DOPER_CRD_DBT O" +
                   " WHERE O.T_OBJECTID = " + objID + " AND O.T_OBJECTTYPEID_REF = " + objTypeID;
                   
        stat = LnSqlExec(queryDel, false);
        result = TWsMessage();
        result.MsgText = "";
        result.MsgID = 0;
        if (stat == false)
            result.MsgID = 1;
            result.MsgText = "Ошибка удаления истории ответственных пользователей.";
        end;                   
    end;        
   
    return result;
END;

MACRO LnsBackOutOperation(CredOperID : integer, operationMode : integer)
   VAR result:TWsMessage;

   result.MsgID = 0;
   result.MsgText = "";

   IF (NOT DeleteOperation(CredOperID, -1, date(0,0,0), operationMode))
      result.MsgID   = GetMO_ErrorID();
      result.MsgText = GetMO_LoansError();
   ELSE
      result = Lns_ClearResponsOperHistory(CredOperID);
   END;

   RETURN result;
END;

MACRO LnsBackOutListOperation(ListCredOperID, OpenContractBackOutMode)
    var index:integer= 0,
        result:TWsMessage,
        ResponseBuilder = WebResponseBuilder();
    while (index < ListCredOperID.Size)
        if (ListCredOperID(index) == 26)
            result = LnsBackOutOperation(ListCredOperID(index), OpenContractBackOutMode);
        else
            result = LnsBackOutOperation(ListCredOperID(index), 0);
        end;
        if (result.MsgID > 0)
            ResponseBuilder.AddErrorEx( result.MsgID, MessageSeverity.RuntimeError, result.MsgText );
        else
            ResponseBuilder.AddErrorEx( result.MsgID, MessageSeverity.RuntimeError, "Удаление выполнено успешно" );
        end;
        index = index + 1;
    end;
    return ResponseBuilder.Result;
END;

MACRO GetCrdCnrt(ObjectID: integer,
                  ObjectNumber: integer)
   VAR query = " SELECT t_creditnumber as id, t_credittypeid_ref as typecrd, t_uscreditnumber as crnumber, t_regdate as regdate, "
              " t_creditsum as sum, t_curcode as curcode, t_crd_kind as crd_kind "
              " FROM dcredit_c_dbt "
              " WHERE t_creditnumber = " + string(ObjectNumber);
   
   VAR rs = rsdRecordSet( query );
   VAR CreditContr = CCreditContr();

   IF (rs.MoveNext)
       CreditContr .Id              = rs.value("id");
       CreditContr .CreditType      = rs.value("typecrd");
       CreditContr .Number          = rs.value("crnumber");
       CreditContr .RegDate         = rs.value("regdate");
       CreditContr .Sum             = money(rs.value("sum"));
       CreditContr .Curcode        = rs.value("curcode");
       CreditContr .Code= LnSelectValue("select f.T_CCY from dfininstr_dbt f where f.t_fiid = " + string(CreditContr.Curcode), V_STRING);
       CreditContr .Crd_kind       = rs.value("crd_kind");
   END;
     
   RETURN CreditContr;
END;

MACRO getRestSumClntProd(ObjectID:integer, ObjectNumber: integer)
   VAR obj = TWsRestProdObj ();

   IF (ObjectID == LO_CREDIT)
       obj.Sum = GetAllRegRest(ObjectID, ObjectNumber, TDR_MAINREST, date(31,12,9999)) + 
                  GetAllRegRest(ObjectID, ObjectNumber, TDR_EXPREST,  date(31,12,9999)) + 
                  GetAllRegRest(ObjectID, ObjectNumber, TDR_LIM,      date(31,12,9999));
       obj.CurrCode = GetCrdCnrt(ObjectID, ObjectNumber).Code;
   ELSE
       obj.Sum = 0;
       obj.CurrCode = "";
   END;
   
   RETURN obj;
END;

MACRO getCreditCurCode(CreditID:integer)
   var cmd, rs;
   var result: object;
   var res ="";

   cmd = RsdCommand( "select iso.t_isocode from disocur_dbt iso,dfininstr_dbt fii,dcredit_c_dbt crd where iso.t_numbercode = fii.t_iso_number AND fii.t_fiid = crd.t_curcode AND t_creditnumber =   ?" );
   cmd.addParam( "t_creditnumber", RSDBP_IN );
   cmd.value( "t_creditnumber" ) = CreditId;

   cmd.execute();
   rs = RsdRecordset( cmd );

   IF ( rs.moveNext )
      res =  rs.value(0);
   ELSE
      res  = "???";
   END;
   return res;
END;

MACRO GetOpCountDocs(CrdOpID)
  VAR  list = getlistDocOp(CrdOpID);                  
  RETURN list.size;
END;

PRIVATE MACRO ReadFromFile(FileName: string)
    var result = "";
    FILE TextFile() txt;
    var executionStatus: Integer = 0;
    var errorMessage: String = "";
    if (NOT open(TextFile, FileName))
        executionStatus = status(errorMessage);
        runError("Ошибка при создании файла|" + FileName + "|(" + executionStatus + ") " + errorMessage);
    end;
    while(Next(TextFile)) 
        result = result + TextFile.str + "\r\n";
    end;
    close(textFile);
    return result;
END;

MACRO PrintPaymentsList(objid: integer, objN: integer, typeop: integer, dateop: date, crdopid :integer, SessionID: string)
    var TxtDir = "", err = 0, indSP = 2, NameFile = "", FullPath = "";
    GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, TxtDir, Err);
    if (Err != 0) return null; end;

    // Относительный путь
    IF (SubStr(TxtDir, 1, 1) == ".")
       // Уберем каталог OBJ из пути
       WHILE (indSP > 1)
          FullPath = SubStr(GetCurDir(), 1, indSP-1);
          indSP = Index(GetCurDir(), "\\", indSP) + 1;
       END;
       // Теперь, по идее, у нас каталог абсолютный
       FullPath = FullPath + SubStr(TxtDir, Index(TxtDir, "\\")+1);
    ELSE
       // Абсолютный путь
       FullPath = TxtDir;
    END;
    NameFile = FullPath + "\\PaymentsListReport_" + SessionID + ".txt";
    SetOutput(NameFile, false);
    FillPayment_Report(objid, objN, typeop, 0, dateop, crdopid);
    SetOutput(Null, true);
    var ReportString = ReadFromFile(NameFile);
    return CreateFileContainer(NameFile, false, OEMToUTF8(ReportString));
END;

CLASS LnsObjType
    VAR ID : integer = 0;
    VAR Name : string = "";
    VAR ShortName : string = "";
END;

MACRO GetLoansObjectTypes()
    VAR queryStr = "";
    VAR result = TArray();
    VAR obj = LnsObjType();
    
    queryStr = "SELECT T_OBJECTID, T_OBJECTNAME, T_SHORTNAME FROM DLOBJECT_DBT WHERE T_TYPEOBJECT > 0";
    
    VAR rs = TRsbDataSet(queryStr);
    
    WHILE (rs.MoveNext)
        obj = LnsObjType();
        
        obj.ID        = rs.ObjectId;
        obj.Name      = rs.ObjectName;
        obj.ShortName = rs.ShortName;
        
        result.value(result.size) = obj;
    END;
    
    return result;
END;

MACRO GetLoansObjectTypesCount()
    VAR queryStr = "";
    
    queryStr = "SELECT count(*) cnt FROM DLOBJECT_DBT WHERE T_TYPEOBJECT > 0";
    
    VAR rs = TRsbDataSet(queryStr);
    
    if (rs.MoveNext)
        return int(rs.cnt);
    END;
    
    return 0;
END;

CLASS CLnsStageFltr
    VAR ID : integer = 0;
    VAR Name : string = "";
END;

MACRO GetStagesList()
    VAR queryStr = "";
    VAR result = TArray();
    VAR obj = CLnsStageFltr();
    
    queryStr = "SELECT T_STAGEID, T_STAGENAME FROM DOP_STAGE_DBT";
    
    VAR rs = TRsbDataSet(queryStr);
    
    WHILE (rs.MoveNext)
        obj = CLnsStageFltr();
        
        obj.ID        = rs.StageID;
        obj.Name      = rs.Stagename;
        
        result.value(result.size) = obj;
    END;
    
    return result;
END;

MACRO GetStagesCount()
    VAR queryStr = "";
    
    queryStr = "SELECT count(*) cnt FROM DOP_STAGE_DBT";
    
    VAR rs = TRsbDataSet(queryStr);
    
    if (rs.MoveNext)
        return int(rs.cnt);
    END;
    
    return 0;
END;

MACRO GetAvailableLimit(ObjN, OpDate, SysOp, TypeOpNumber, rest)
    var AvailableLimit = RunStoredFunc("LOANSKERNEL.calcavailablelimit", 
                                        V_MONEY, 
                                        NULL, 
                                        OpDate,
                                        SysOp,
                                        TypeOpNumber,
                                        rest,
                                        ObjN
                                        );
    return AvailableLimit;
END;

PRIVATE CONST    
    BEG_DATE_COL_INDEX   = 1,
    END_DATE_COL_INDEX   = 2,
    CALC_SUM_COL_INDEX   = 3,
    NDS_COL_INDEX        = 4,
    PAY_SUM_COL_INDEX    = 5,
    RESTNO_PAY_COL_INDEX = 6;
    
//Получает видимость столбцов разноски
MACRO GetColumnsVisibility(SystOperID)
    VAR queryStr = "";
    VAR res = TArray();
   
    queryStr = "SELECT T_BEGCDATE as BegDate, T_FINCDATE as EndDate, T_SUM as CalcSum, ";
    queryStr = queryStr + " T_NDS as NDS, T_PAYSUM as PaySum, T_RESTNOPAY as RestnoPay FROM DSYST_OP_DBT sop";
    queryStr = queryStr + " where sop.T_SYSTEMOPERATIONID = " + SystOperID;
    
    VAR rs = TRsbDataSet(queryStr);
    
    if (rs.MoveNext)
        res[0] = true;
        if (rs.BegDate == "X")   res[BEG_DATE_COL_INDEX]=true;   else res[BEG_DATE_COL_INDEX]=false;   end;
        if (rs.EndDate == "X")   res[END_DATE_COL_INDEX]=true;   else res[END_DATE_COL_INDEX]=false;   end;
        if (rs.CalcSum == "X")   res[CALC_SUM_COL_INDEX]=true;   else res[CALC_SUM_COL_INDEX]=false;   end;
        if (rs.NDS == "X")       res[NDS_COL_INDEX]=true;        else res[NDS_COL_INDEX]=false;        end;
        if (rs.PaySum == "X")    res[PAY_SUM_COL_INDEX]=true;    else res[PAY_SUM_COL_INDEX]=false;    end;
        if (rs.RestnoPay == "X") res[RESTNO_PAY_COL_INDEX]=true; else res[RESTNO_PAY_COL_INDEX]=false; end;
    END;
    
    return res;
END;

MACRO GetFillPayment(CredoperID : integer)
    var qStr = "";
    var result = "";
    var ResponseBuilder = WebResponseBuilder();
    qStr = "SELECT T1.T_OBJECTTYPEID_REF AS OBJID, T1.T_OBJECTID_REF AS OBJN, T1.T_CREDOPERDATE AS OPDATE, T1.T_CARRYDATE AS CARRYDATE, T2.T_TENDDATE AS CALCDATE, T3.T_TYPEOPERID AS TYPEOPERID, T1.T_SYSTEMOPERATIONID AS SYSTOPERID";
    qStr = qstr + " FROM DCRD_OP_DBT T1, DCRD_OP_PARM_DBT T2, DTYPE_OP_DBT T3";
    qStr = qstr + " WHERE T1.T_CREDOPERID = T2.T_CREDOPERID_REF AND T1.T_OPERTYPENUMBER_REF = T3.T_TYPEOPERNUMBER "; 
    qStr = qstr + " AND T1.T_SYSTEMOPERATIONID = T3.T_SYSTTYPEOP_REF AND T1.T_CREDOPERID = " + CredoperID;

    var rs = TRsbDataSet(qStr);
    
    if(rs.MoveNext)
        
        LNSQLExec("DELETE FROM DPAYMENT_TMP" );
        
        var dayOfYear = LnSelectValue ("select to_char(RSBSESSIONDATA.CURDATE, 'DDD') FROM DUAL", V_INTEGER);
        var HashCode = {oper} * dayOfYear * rs.ObjN * rs.TypeOperID;
        
        LNSQLExec("DELETE FROM DLOANS_TEMPARY_DBT WHERE T_HASH = " + HashCode);
        GetTemparyData(HashCode);
        
        var rsd = CRSDCommand("SELECT cop1.T_CREDOPERID, cop1.T_CREDOPERDATE FROM DCRD_OP_DBT cop1 WHERE " +
                              " cop1.T_STAGEID_REF = ? " +
                              " AND cop1.T_CREDOPERID =  " +
                              "(SELECT MAX(cop2.T_CREDOPERID) FROM DCRD_OP_DBT cop2 WHERE " +
                              " cop2.T_SYSTEMOPERATIONID = ? " +
                              " AND cop2.T_ISDELETED = ? " + 
                              " AND cop2.T_OBJECTID_REF = ? " + 
                              " AND cop2.T_OBJECTTYPEID_REF = ?)",
                              "p1", CF_COMPLIT,
                              "p2", rs.SYSTOPERID,
                              "p3", 0,
                              "p4", rs.ObjN,
                              "p5", rs.objid,
                              V_GENOBJ);
        
        if (rsd.MoveNext())
            LnSQLExec("INSERT INTO DPAYMENT_TMP" +
                            "( T_ISOPERATION, T_OBJID, T_OBJN, " +
                            "T_REGID, T_CURCODE, T_BEGDATE, " +
                            "T_ENDDATE, T_SUM, T_PAYSUM, " +
                            "T_RESTNOPAY, T_DOCDUTYID_REF, T_PARENTID, " +
                            "T_REFERENCE, T_RATEID, T_SYSTEMOPERATIONID, " +
                            "T_CREDITNUMBER_REF, T_PAYMENTID_REF, T_PAYDATE, " +
                            "T_FIRSTREGID, T_FIRSTRATEID, T_TYPEOPERNUMBER, " +
                            "T_UPP_SUM, T_RPP_SUM, T_CCP_SUM, " +
                            "T_STRNAME, T_OPTNOPID, T_ID, " +
                            "T_FLAGEXCFROMTOTAL, T_NDS" +
                            ")" +
                            "SELECT CHR(0), T_OBJECTTYPEID_REF, T_OBJECTNUMBER_REF,  "+
                            " 0, 0, MAX(T_CALCBEGDATE),  "+
                            " MAX(T_CALCENDDATE), SUM(T_CLAIMSUM), SUM(T_ACTUALAMOUNT),  "+
                            " SUM(T_UNDERPAYSUM), 0, 0,  "+
                            " T_PARENTID, 0, T_SYSTEMOPERATIONID_REF,  "+
                            " T_CREDITNUMBER, 0, TO_DATE('01.01.0001', 'dd.mm.yyyy'),  "+
                            " 0, 0, T_TYPEOPERNUMBER_REF,  "+
                            " SUM(T_UPP_SUM), SUM(T_RPP_SUM), SUM(T_CCP_SUM),  "+
                            " MAX(gr.T_NAME), 0, 0,  "+
                            " CHR(0), T_NDS FROM DPLANFACT_DBT pf, DGRPDEBTS_DBT gr "+
                            " WHERE T_CREDOPERID_REF = " + CredOperID + " AND gr.T_NUMBER = pf.T_PARENTID "+
                            " GROUP BY T_OBJECTTYPEID_REF, T_OBJECTNUMBER_REF, T_CREDITNUMBER,  "+
                            " pf.T_PARENTID, T_TYPEOPERNUMBER_REF, T_SYSTEMOPERATIONID_REF, T_NDS" +
                            " UNION ALL" +
                                " SELECT CHR(0), T_OBJECTTYPEID_REF, T_OBJECTNUMBER_REF, " +
                                " 0, 0, T_CALCBEGDATE, " +
                                " T_CALCENDDATE, T_CLAIMSUM, T_ACTUALAMOUNT, " +
                                " T_UNDERPAYSUM, 0, T_PARENTID, " +
                                " T_DUTYSTAGEID_REF, 0, T_SYSTEMOPERATIONID_REF, " +
                                " T_CREDITNUMBER, 0, TO_DATE('01.01.0001', 'dd.mm.yyyy'), " +
                                " 0, 0, T_TYPEOPERNUMBER_REF, " +
                                " T_UPP_SUM, T_RPP_SUM, T_CCP_SUM, " +
                                " ds.T_SHORTNAME, 0, 0, " +
                                " CHR(0), T_NDS FROM DPLANFACT_DBT pf, DDUTSTAGE_DBT ds WHERE T_CREDOPERID_REF = " + CredOperID + " AND DS.T_DUTYSTAGEID = pf.T_DUTYSTAGEID_REF");
                      
            SetTemparyData(HashCode);
            
            LnSQLExec("UPDATE DPAYMENT_TMP SET T_FIRSTREGID = NULL");
            
            LnSQLExec("UPDATE DPAYMENT_TMP pm1 SET pm1.T_FIRSTREGID = " +
                " ( " +
                "   SELECT pm2.T_ID FROM DPAYMENT_TMP pm2 WHERE " +
                         " pm2.T_OBJID = -1 " +
                     " AND pm2.T_OBJN  = -1 " +
                     " AND PM2.T_REFERENCE = pm1.T_REFERENCE  " +
                " ) " +
                " WHERE " +
                      " pm1.T_PARENTID = 0 " +
                  " AND pm1.T_OBJID <> -1 " +
                  " AND pm1.T_OBJN  <> -1 ");
            
            LnSQLExec("UPDATE DPAYMENT_TMP pm1 SET pm1.T_FIRSTREGID = " +
                " ( " +
                  " SELECT pm2.T_ID FROM DPAYMENT_TMP pm2 WHERE " +
                         " pm2.T_OBJID = pm1.T_OBJID " +
                     " AND pm2.T_OBJN  = pm1.T_OBJN " +
                     " AND pm2.T_REFERENCE = pm1.T_PARENTID " +
                     " AND pm2.T_PARENTID  = 0 " +
                " ) WHERE " +
                  " pm1.T_PARENTID > 0 " +
              " AND pm1.T_OBJID    > 0 " +
              " AND pm1.T_OBJN     > 0");
            
            var query = 
                    "SELECT DBMS_XMLGEN.NEWCONTEXTFROMHIERARCHY ('select level,  XMLElement(  "+
                    "  FILLPAYMENT,  "                      
                    "XMLElement(PARENTID, T_PARENTID),  "
                    "XMLElement(DUTYSTAGE,T_REFERENCE),  "
                    "XMLElement(STRNAME ,case when T_STRNAME = chr(1) then NULL else T_STRNAME end ),  "
                    "XMLElement(BEGDATE ,to_char(NVL(T_BEGDATE,to_date(''01.01.0001'')),''dd.mm.YYYY'') ),  "
                    "XMLElement(ENDDATE ,to_char( NVL( T_ENDDATE,to_date(''01.01.0001'')),''dd.mm.YYYY'')),  "
                    "XMLElement(CALCSUM ,trim(to_char(T_SUM,''999999999999990D99''))),  "
                    "XMLElement(PAYSUM  , trim(to_char(T_PAYSUM,''999999999999990D99''))),  "
                    "XMLElement(RESTNOPAY , trim(to_char(T_RESTNOPAY,''999999999999990D99''))),  "
                    "XMLElement(NDS , trim(to_char(T_NDS,''999999999999990D99''))))  "
                    "  FROM   (select * from "
                    "(SELECT T_ID, T_FIRSTREGID, T_PARENTID as T_PARENTID,T_REFERENCE*60000 as T_REFERENCE, T_STRNAME as T_STRNAME, " + 
                    "T_BEGDATE as T_BEGDATE, T_ENDDATE as T_ENDDATE,T_SUM as T_SUM,T_PAYSUM as T_PAYSUM,T_RESTNOPAY as T_RESTNOPAY,NVL(T_NDS, 0) as T_NDS " +
                    " from dpayment_tmp where t_parentid = 0) par "
                    "UNION " + 
                    " SELECT * from " +
                    "(SELECT T_ID, T_FIRSTREGID, T_PARENTID*60000 as T_PARENTID , T_REFERENCE as T_REFERENCE, T_STRNAME as T_STRNAME, T_BEGDATE as T_BEGDATE, " + 
                           " T_ENDDATE as T_ENDDATE,T_SUM as T_SUM,T_PAYSUM as T_PAYSUM,T_RESTNOPAY as T_RESTNOPAY,NVL(T_NDS, 0) as T_NDS " + 
                           " from dpayment_tmp  where t_parentid != 0) ref) " 
                    "START WITH T_FIRSTREGID IS NULL CONNECT BY PRIOR T_ID = T_FIRSTREGID') AS XMLDOC FROM DUAL ";
            
            var ds = TRsbDataSet(query);
            
            if (ds.MoveNext())
                var q = "SELECT 1, XMLELEMENT (FILLPAYMENT_LIST,(SELECT DBMS_XMLGEN.GETXMLTYPE ("+int(ds.XMLDOC)+") FROM DUAL)).GETCLOBVAL () as XMLDOC FROM DUAL";
                var cmd = RsdCommand(RslDefCon, q);
                cmd.execute();
                rs  = TRsbDataSet (q);
                rs.MoveNext();

                cmd = RsdCommand(RslDefCon, "BEGIN dbms_xmlgen.closeContext(?); END;");
                cmd.addParam("p1", RSDBP_IN); cmd.Value("p1") = int(ds.XMLDOC);
                cmd.execute();
                
                result = rs.XMLDOC;
            end;
        end;
    end;
    
    ResponseBuilder.SetUserObject(result);
    return ResponseBuilder.Result;
END;

MACRO GetCalcOperDate(CredoperID)
    var calcOperDate = LnSelectValue ("SELECT DECODE (T1.T_TENDDATE, NULL, T2.T_CREDOPERDATE, T1.T_TENDDATE) FROM DCRD_OP_PARM_DBT T1, DCRD_OP_DBT T2 WHERE T1.T_CREDOPERID_REF(+) = T2.T_CREDOPERID AND T2.T_CREDOPERID = " + CredoperID, V_DATE);
    return calcOperDate;
END;

//Печать разноски по ID операции
MACRO PrintFillPayment(CredoperID, SessionID)
    var qStr = "";
    qStr = "SELECT T1.T_OBJECTTYPEID_REF AS OBJID, T1.T_OBJECTID_REF AS OBJN, T1.T_CREDOPERDATE AS OPDATE, T1.T_CARRYDATE AS CARRYDATE, T2.T_TENDDATE AS CALCDATE, T3.T_TYPEOPERID AS TYPEOPERID, T1.T_SYSTEMOPERATIONID AS SYSTOPERID";
    qStr = qstr + " FROM DCRD_OP_DBT T1, DCRD_OP_PARM_DBT T2, DTYPE_OP_DBT T3";
    qStr = qstr + " WHERE T1.T_CREDOPERID = T2.T_CREDOPERID_REF AND T1.T_OPERTYPENUMBER_REF = T3.T_TYPEOPERNUMBER "; 
    qStr = qstr + " AND T1.T_SYSTEMOPERATIONID = T3.T_SYSTTYPEOP_REF AND T1.T_CREDOPERID = " + CredoperID;
    
    var rs = TRsbDataSet(qStr);
   
    if(rs.MoveNext)
        return PrintPaymentsList(rs.OBJID, rs.OBJN, rs.TYPEOPERID, rs.OPDATE, CredoperID, SessionID);
    end;
END;
