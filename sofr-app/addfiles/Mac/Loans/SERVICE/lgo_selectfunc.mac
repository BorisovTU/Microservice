/*
$Name:             lgo_selectfunc.mac
$Module:           Кредитование
$Description:      Макрос отбора договоров и разбиение их по пачкам
*/

IMPORT RsbDataSet, SbCrdInter, total,
       "lgo_opstruct.mac", "lgo_func.mac";

// Общая функция отбора договоров
macro SelectFunConveerCredit(_taskID, _execID, _conveyerID, _packetSize, _Params)
   VAR 
      retVal = 0,
      idx    = 0,
      cnt    = 0,
      BriefCaseID = 0,
      YesnoUserType = 0,
      rs       = NULL,
      ZeroRest = 0;

   IF (_Params.InitStruct.SelectDataForOp)
      LgoSqlExec("delete from dset_tcr_tmp");

      // Если параметра нет, возьмем все ВК
      IF (ValType(_Params.CreditKind)     == V_UNDEF)
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag) select t_credittypeid, 'X' From DTYPE_CRD_DBT WHERE t_credittypeid > 999");
      ELSE
         WHILE (idx < _Params.CreditKind.size)
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag) values (" + _Params.CreditKind[idx] + ", 'X')");
            idx = idx + 1;
         END;

         // ВК задан по умолчанию
         IF ((_Params.CreditKind.size == 1) AND (_Params.CreditKind[0] == 0))
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag) select t_credittypeid, 'X' From DTYPE_CRD_DBT WHERE t_credittypeid > 999");
         END;
      END;

      IF (GenPropID(_Params, "BriefCaseID") != -1)
         BriefCaseID = _Params.BriefCaseID;
      END;

      IF (GenPropID(_Params, "YesnoUsertype") != -1)
         YesnoUserType = _Params.YesnoUserType;
      END;

      IF (GenPropID(_Params, "ZeroRest") != -1)
         ZeroRest = _Params.ZeroRest;
      END;

      retVal = LgoRunStoredFunc("RSO_LoansRsBus.FillWSConveerCredit", V_INTEGER, NULL, _taskID, _execID, _conveyerID, _packetSize,
                                _Params.CurCode, _Params.UserCreditKind, _Params.OperDate, _Params.FNCash, BriefCaseID, YesnoUserType, 1, 0, ZeroRest);
      IF (ValType(retVal) != V_INTEGER)
          retVal = 0;
      END;

      LgoSqlExec("SELECT " + retVal + " AS CNT FROM DUAL");
   ELSE
      cnt = -1 * GetCNum();
      LgoSqlExec("DELETE FROM DCNVDOC_DBT WHERE T_TASKID = ? AND T_EXECID = ? AND T_CONVTYPEID = ?", _taskID, _execID, _conveyerID);
      LgoSqlExec("update dcnvdoc_dbt set t_TaskID = ?, t_ExecID = ?, t_ConvTypeID = ? where t_ExecID = ?", _taskID, _execID, _conveyerID, cnt);
      rs = TRsbDataSet("select Nvl(max(t_PackID), 0) as cntPack from dcnvdoc_dbt where t_ExecID = " + _execID + " and t_ConvTypeID = " + _conveyerID);
      rs.moveNext();
      retVal = Int(rs.cntPack);
      if (retVal == 0)
          retVal = 1;//даже если пакетов нет, то все равно толкнем дальше, т.к. таблицы конвейера м.б. не заполнены
      end;
   END;

   return retVal;
END;

// Общая функция отбора портфелей
macro SelectFunConveerCaseRVPS(_taskID, _execID, _conveyerID, _packetSize, _Params)
   VAR
      retVal = 0, idxCase = 0,
      idx    = 0,
      cnt    = 0,
      BriefCaseID = 0,
      rs     = NULL,
      privWHERE : string = "";

   IF (_Params.InitStruct.SelectDataForOp)
      IF (GenPropID(_Params, "BriefCaseID") != -1)
         BriefCaseID = _Params.BriefCaseID;
      END;

      LgoSqlExec("delete from dset_tcr_tmp");

      idxCase    = 0;
      WHILE (idxCase < _Params.CreditKind.size)
         IF (ValType(_Params.CreditKind[idxCase]) == V_INTEGER)
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag2) values (" + _Params.CreditKind[idxCase] + ", 'X')");
         END;
         idxCase = idxCase + 1;
      END;
      GetObjectRestriction(privWHERE, 52, {Oper}, "cr", 0,"lbrfcase.dbt");

      retVal = LgoRunStoredFunc("RSO_LoansRsBus.FillWSRVPS", V_INTEGER, NULL, _taskID, _execID, _conveyerID, _packetSize,
                                _Params.FNCash, BriefCaseID, privWHERE);
      IF (ValType(retVal) != V_INTEGER)
          retVal = 0;
      END;

      LgoSqlExec("SELECT " + retVal + " AS CNT FROM DUAL");
   ELSE
      cnt = -1 * GetCNum();
      LgoSqlExec("DELETE FROM DCNVDOC_DBT WHERE T_TASKID = ? AND T_EXECID = ? AND T_CONVTYPEID = ?", _taskID, _execID, _conveyerID);
      LgoSqlExec("update dcnvdoc_dbt set t_TaskID = ?, t_ExecID = ?, t_ConvTypeID = ? where t_ExecID = ?", _taskID, _execID, _conveyerID, cnt);
      rs = TRsbDataSet("select Nvl(max(t_PackID), 0) as cntPack from dcnvdoc_dbt where t_ExecID = " + _execID + " and t_ConvTypeID = " + _conveyerID);
      rs.moveNext();
      retVal = Int(rs.cntPack);
   END;

   return retVal;
END;

// Общая функция отбора портфелей
macro SelectFunConveerCase(_taskID, _execID, _conveyerID, _packetSize, _Params)
   VAR
      retVal = 0,
      idx    = 0,
      cnt    = 0,
      BriefCaseID = 0,
      rs     = NULL;

   IF (_Params.InitStruct.SelectDataForOp)
      IF (GenPropID(_Params, "BriefCaseID") != -1)
         BriefCaseID = _Params.BriefCaseID;
      END;

      retVal = LgoRunStoredFunc("RSO_LoansRsBus.FillWSConveerCase", V_INTEGER, NULL, _taskID, _execID, _conveyerID, _packetSize,
                                _Params.CurCode, _Params.OperDate, _Params.FNCash, BriefCaseID);
      IF (ValType(retVal) != V_INTEGER)
          retVal = 0;
      END;

      LgoSqlExec("SELECT " + retVal + " AS CNT FROM DUAL");
   ELSE
      cnt = -1 * GetCNum();
      LgoSqlExec("DELETE FROM DCNVDOC_DBT WHERE T_TASKID = ? AND T_EXECID = ? AND T_CONVTYPEID = ?", _taskID, _execID, _conveyerID);
      LgoSqlExec("update dcnvdoc_dbt set t_TaskID = ?, t_ExecID = ?, t_ConvTypeID = ? where t_ExecID = ?", _taskID, _execID, _conveyerID, cnt);
      rs = TRsbDataSet("select Nvl(max(t_PackID), 0) as cntPack from dcnvdoc_dbt where t_ExecID = " + _execID + " and t_ConvTypeID = " + _conveyerID);
      rs.moveNext();
      retVal = Int(rs.cntPack);
   END;

   return retVal;
END;

// функция отбора договоров для РВПС по договорам
macro SelectFunConveerCreditRVPS(_taskID, _execID, _conveyerID, _packetSize, _Params)
   VAR 
      retVal = 0,
      idx    = 0,
      cnt    = 0,
      BriefCaseID = 0,
      rs     = NULL,
      stat   = 0,
      withCase = 0,
      CessID  = 0;

   IF (_Params.InitStruct.SelectDataForOp)
      LgoSqlExec("delete from dset_tcr_tmp");
      
      // Если параметра нет, возьмем все ВК
      IF (ValType(_Params.CreditKind)     == V_UNDEF)
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag) select t_credittypeid, 'X' From DTYPE_CRD_DBT WHERE t_credittypeid > 999");
      ELSE
         WHILE (idx < _Params.CreditKind.size)
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag) values (" + _Params.CreditKind[idx] + ", 'X')");
            idx = idx + 1;
         END;

         // ВК задан по умолчанию
         IF ((_Params.CreditKind.size == 1) AND (_Params.CreditKind[0] == 0))
            LgoSqlExec("insert into dset_tcr_tmp(t_credittypeid_ref, t_setflag) select t_credittypeid, 'X' From DTYPE_CRD_DBT WHERE t_credittypeid > 999");
         END;
      END;

      IF (GenPropID(_Params, "BriefCaseID") != -1)
         BriefCaseID = _Params.BriefCaseID;
      END;

      IF (GenPropID(_Params, "CessID") != -1)
         CessID = _Params.CessID;
      END;

      GetRegistryValue("RS-LOANS\\РЕЗЕРВ_ПО_ПОРТФЕЛЮ", V_BOOL, withCase, stat);

      if (withCase)
          withCase = 0;
      else
          withCase = 1;
      end;

      retVal = LgoRunStoredFunc("RSO_LoansRsBus.FillWSConveerCredit", V_INTEGER, NULL, _taskID, _execID, _conveyerID, _packetSize, 
                                _Params.CurCode, _Params.UserCreditKind, _Params.OperDate, _Params.FNCash, BriefCaseID, 0, withCase, CessID);
      IF (ValType(retVal) != V_INTEGER)
          retVal = 0;
      END;

      LgoSqlExec("SELECT " + retVal + " AS CNT FROM DUAL");
   ELSE
      cnt = -1 * GetCNum();

      LgoSqlExec("DELETE FROM DCNVDOC_DBT WHERE T_TASKID = ? AND T_EXECID = ? AND T_CONVTYPEID = ?", _taskID, _execID, _conveyerID);
      LgoSqlExec("UPDATE DCNVDOC_DBT SET T_TASKID = ?, T_EXECID = ?, T_CONVTYPEID = ? WHERE T_EXECID = ?", _taskID, _execID, _conveyerID, cnt);
      rs = TRsbDataSet("select Nvl(max(t_PackID), 0) as cntPack from dcnvdoc_dbt where t_ExecID = " + _execID + " and t_ConvTypeID = " + _conveyerID);
      rs.moveNext();
      retVal = Int(rs.cntPack);
   END;

   return retVal;
END;

// Общая функция отбора портфелей для конвейера "Обработка портфелей"
macro SelectFunSimpleCase(_taskID, _execID, _conveyerID, _packetSize, _Params)
   VAR retVal = 0;

   retVal = LgoRunStoredFunc("RSO_LoansRsBus.FillWSimpleCase", V_INTEGER, NULL, _taskID, _execID, _conveyerID, _packetSize, _Params.BriefCaseID);
   IF (ValType(retVal) != V_INTEGER)
      retVal = 0;
   END;
   return retVal;
END;


// Функция отбора объектов для выгрузки Кредитной Истории
MACRO SelectFunConveerBki(_taskID, _execID, _conveyerID, _packetSize, _Params)

   IF (_Params.ByGroup)
      RunError("Формирование КИ по группе БКИ не реализовано в текущий версии системы");
      IF (_Params.BkiGroup == 0)
         RunError("Не указана группа БКИ");
      END;
   ELSE
      IF (_Params.BkiID == 0)
         RunError("Не указано БКИ");
      END;
      
      IF (_Params.PathForming == "") //todo сразу проверять корректность пути
         RunError("Не задан путь для сформированных файлов");
      END;
   END;
   
   IF (_Params.SendKind == 0)
      RunError("Не указан вид передачи");
   END;
   
   IF (_Params.CreditKind.size == 0)
      RunError("Не указаны виды кредита");
   END;

   CONST SelectionMacroFunc = "ОтборОбъектовДляКонвейернойОбработки";
   
   var BkiMacroFile = CRSDCommand("select t_macroforming from dlbki_dbt where t_bkiid = :bkiid", "bkiid",  _Params.Bkiid, V_STRING);
   
   BegAction(2000, "Идет отбор договоров...", TRUE);
   var retVal = ExecMacroFile(BkiMacroFile, SelectionMacroFunc, _taskID, _execID, _conveyerID, _packetSize, _Params);
   EndAction;
   
   IF (retVal == null)
      RunError("Макропроцедура отбора объектов " + SelectionMacroFunc + " в макросе " + BkiMacroFile + " не найдена");
   END;
   
   return retVal;
END;