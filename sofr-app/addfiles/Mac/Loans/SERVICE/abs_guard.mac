/*
$Name:             abs_guard.mac
$Module:           Кредитование
$Description:      Банковские гарантии. Взаимодествие с RsConnect
*/
/*
Created: 25.06.2018
Author:  CIS
*/

IMPORT ws_party, ws_partyclasses;

PRIVATE CONST MODIFY = "MODIFY_ALL";
PRIVATE CONST ADD    = "ADD";

 //Банковские реквизиты
class RSCReq_BankRekv
  var BIK       :String = ""; // БИК Банка
  var BankName  :String = ""; // Наименование банка
  var BankAcc   :String = ""; // Номер коррсчета банка
  var BankCity  :String = ""; // Город Банка
  var ClientAcc :String = ""; // Номер счета
end;

// Должностное лицо
class RSCReq_Stuff
  var PostType :String = ""; // Тип должности
  var PostName :String = ""; // Наименование должности
  var DateIn  = Date(0,0,0); // Дата назначения
  var DateOut = Date(0,0,0); // Срок полномочий
  var ClientID :String = ""; // ИД клиента в БД АС
end;

// Собственник
class RSCReq_Founder 
  var CapitalPrc :Money = 0;   // Доля
  var ClientID   :String = ""; // ИД клиента в БД АС
end;

//Параметры организации/ИП
class RSCReq_Legal
  var Jurisdiction :String = "";        // Юрисдикция. Код страны по общероссийскому классификатору стран (символьный). По умолчанию = RUS
  var ShortName    :String = "";        // Краткое наименование
  var KPP          :String = "";        // КПП
  var OKPO         :String = "";        // ОКПО
  var OKTMO        :String = "";        // ОКТМО
  var OKATO        :String = "";        // ОКАТО
  var OKOPF        :String = "";        // ОКОПФ
  var OKOGU        :String = "";        // ОКОГУ
  var PFR          :String = "";        // ПФР
  var FSS          :String = "";        // ФСС
  var OGRN         :String = "";        // ОГРН/ОРГНИП
  var OGRNDate     =Date(0,0,0);        // Дата постановки на учет
  var SertRegSer   :String = "";        // Свидетельство о регистрации серия
  var SertRegNum   :String = "";        // Свидетельство о регистрации номер
  var NalogCod     :String = "";        // Код налоговой инспекции
  var NalogName    :String = "";        // Наименование налоговой инспекции
  var NalogRegion  :String = "";        // Код региона регистрации
  var OKFS         :String = "";        // Код по Справочнику
  var OKVEDMain    :String = "";        // Основной ОКВЭД
  var OKVEDAdd     :String = "";        // Дополнительные коды ОКВЭД
  var PaymentField = RSCReq_BankRekv(); // Банковские реквизиты
  var StuffList    = TArray();          // type: RSCReq_Stuff   Массив!!! Должностные лица
  var FounderList  = TArray();          // Массив!!! Собственники
end;

// ФИО ФЛ
class RSCReq_FIO 
  var Surname    :String = ""; // Фамилия 
  var FirstName  :String = ""; // Имя
  var Patronymic :String = ""; // Отчество (при наличии)
end;

// Удостоверение личности ФЛ
class RSCReq_IDoc 
  var TypeDoc    :String = ""; // Тип ДУЛ. Код по справочнику ДУЛ в АС
  var SerDoc     :String = ""; // Серия
  var NumDoc     :String = ""; // Номер
  var DateDoc    =Date(0,0,0); // Дата выдачи документа
  var Issuer     :String = ""; // Наименование организации, выдавшей документ. 
  var IssuerCode :String = ""; // Код подразделения организации, выдавшей документ. 
end;

// Параметры физ.лица
class RSCReq_Physical
  var FIO        = RSCReq_FIO();  // ФИО ФЛ
  var BirthDate  = Date(0,0,0);   // Дата рождения ФЛ
  var BirthPlace :String = "";    // Место рождения
  var IDoc       = RSCReq_IDoc(); // Удостоверение личности ФЛ
end;

// Описание адреса
class RSCReq_Address
  var AddressType   :Integer = 0; // Тип адреса
  var PostCode      :String = ""; // Почтовый индекс
  var RegionCode    :String = ""; // Код региона по справочнику Административных единиц
  var RegionName    :String = ""; // Наименование региона
  var District      :String = ""; // Наименование района
  var City          :String = ""; // Наименование города
  var Settlement    :String = ""; // Наименование населенного пункта
  var Street        :String = ""; // Наименование улицы
  var House         :String = ""; // Номер дома
  var Building      :String = ""; // Корпус/строение
  var Apartment     :String = ""; // Квартира
  var AddressString :String = ""; // Текстовая строка с адресом 
end;

// Контакты
class RSCReq_Contact 
  var Type  :Integer;     // Тип контакта:1 - телефон 2 - e-mail 3 - сайт 4 - факс
  var Value :String = ""; // Значение
end;

// класс для сервиса регистрации субъекта
class RSCReq_Party
  var ReqID    :String = "";           // Уникальный идентификатор запроса в RS-Connect
  var SenderID :String = "";           // Идентификатор (код) Абонента, кому адресован запрос
  var ObjectID :String = "";           // ИД внутреннего учетного объекта в RS-Connect. 
  var Type     :String = "";           // Значения: 1=ЮЛ 2=ФЛ 3=ИП
  var FullName :String = "";           // Краткое Наименование ЮЛ или заполняется как конкатенация отдельных реквизитов <Фамилия>, <Имя>, <Отчество>, соединенных через <Пробел> для ФЛ (если заданы раздельно)
  var INN      :String = "";           // ИНН или код иностранной организации
  var Legal       = RSCReq_Legal();    // Параметры организации/ИП
  var Physical    = RSCReq_Physical(); // Параметры физ.лица
  var AddressList = TArray();          // Список адресов
  var ContactList = TArray();          // Контакты
end;

class RSCReq_CreatePartyResponse
  var ReqID      :String = ""; // Уникальный идентификатор запроса в RS-Connect
  var SenderID   :String = ""; // Идентификатор (код) Абонента, кому адресован запрос
  var ResultCode :String = ""; // Код результата - по справочнику
  var ResultText :String = ""; // Пояснительный текст к результатам обработки
  var ClientID   :String = ""; // ИД клиента
end;

//Гарнтия
class RSCReq_Tender
  var AddressHTTP :String = "";   // Ссылка на сайт
  var Name        :String = "";   // Название конкурса
  var Law         :String = "";   // ФЗ
  var DateEnd     =Date(0, 0, 0); // Дата определения победителя
  var Number      :String = "";   // Номер реестровый
  var Notice      :String = "";   // Номер извещения
  var Code        :String = "";   // Идентификационный код закупки
  var Lot         :String = "";   // Номер лота 
  var IsAdvance   :String = "";   // Признак авансирования:
  var AmountStart :Money = $0;    // Начальная цена контракта
  var AmountRest  :Money = $0;    // Фактическая цена контракта
end;

// Класс сервиса регистрации гарантии
class RSCReq_Guard
  var ReqID       :String = "";   // Уникальный идентификатор запроса в RS-Connect
  var SenderID    :String = "";   // Идентификатор (код) Абонента, кому адресован запрос
  var ObjectID    :String = "";   // ИД внутреннего учетного объекта в RS-Connect. 
  var ExternalID  :String = "";   // ИД БГ во внешней системе
  var Type        :String = "";   // Тип БГ. Справочник
  var Number      :String = "";   // Номер БГ
  var DateBegin   =Date(0,0,0);   // Дата начала действия БГ
  var DateEnd     =Date(0,0,0);   // Дата окончания действия БГ
  var Currency    :String = "";   // Символьный код валюты по общероссийскому классификатору валют. По умолчанию = RUB
  var Amount      :Money = $0;    // Сумма БГ
  var AmountTax   :Money = $0;    // Сумма комиссии
  var PaymentNum  :String = "";   // Номер платежного поручения по комиссии
  var PaymentDate =Date(0,0,0);   // Дата платежного поручения по комиссии
  var Principal   :String = "";   // ИД Субъекта в БД АБС
  var Beneficiary :String = "";   // ИД Субъекта в БД АБС
  var Tender = RSCReq_Tender();   // Описание тендера
end;

class RSCReq_CreateGuardResponse
  var ReqID       :String = ""; // Уникальный идентификатор запроса в RS-Connect
  var SenderID    :String = ""; // Идентификатор (код) Абонента, кому адресован запрос
  var ResultCode  :String = ""; // Код результата - по справочнику
  var ResultText  :String = ""; // Пояснительный текст к результатам обработки
  var GuaranteeID :String = ""; // ИД созданной БГ в АБС
end;

// Парсим данные по объектам:
PRIVATE MACRO GetPersnParamFromRequest(REQUEST): TWsPersn  // Атрибуты физического лица.
    var PersnParam = TWsPersn();
    /**  Заполнение PersnParam  **/
    if (REQUEST.Physical != null)
        if (REQUEST.Physical.FIO != null)
            PersnParam.LastName   =  REQUEST.Physical.FIO.Surname;    // string;  Фамилия.
            PersnParam.FirstName  =  REQUEST.Physical.FIO.FirstName;  // string;  Имя
            PersnParam.Patronymic =  REQUEST.Physical.FIO.Patronymic; // string;  Отчество
        end;
        PersnParam.Action             = ADD;  // string;  Действие.
        PersnParam.BirthDate          = REQUEST.Physical.BirthDate;   // date;    Дата рождения
        PersnParam.BirthPlace         = REQUEST.Physical.BirthPlace;  // string;  Место рождения
        // PersnParam.Male               =   // integer; Пол.
        // PersnParam.Ethnos             =   // string;  Национальность
        // PersnParam.IsEmployer         =   // bool;    Признак частного предпринимателя.
        // PersnParam.OKPO               =   // string;  ОКПО
        // PersnParam.LicenceNumber      =   // string;  Номер лицензии для част. предприн-ля
        // PersnParam.LicenceDate        =   // date;    Дата выдачи лицензии
        // PersnParam.RegionBorn         =   // string;  Код региона места рождения.
        // PersnParam.RaionBorn          =   // string;  Район места рождения
        // PersnParam.PlaceBorn          =   // string;  Населенный пункт места рождения
        // PersnParam.PlaceWork          =   // string;  Место работы и должность
        PersnParam.DeathDate          = Date(0,0,0);  // date;    Дата смерти (окончания обслуживания)
        PersnParam.IsGroupAuthor      = false;  // bool;    Признак наличия генеральной доверенности. По умолчанию false.
        PersnParam.IsGroupwil         = false;  // bool;    Признак наличия группового завещания. По умолчанию false.
        PersnParam.PensCardNumber     = "";  // string;  Номер пенсионного удостоверения
        PersnParam.PensCardDate       = Date(0,0,0);  // date;    Дата выдачи пенсионного удостоверения
        // PersnParam.IsNotResident      =   // bool;    Признак нерезидентности.
        // PersnParam.NRCountry          =   // string;  Код страны нерезидента
        // PersnParam.IsOffshoreResident =   // bool;    Признак резидента оффшорной зоны.
        // PersnParam.SectionPeople      =   // integer; Категория населения.
        // PersnParam.IsLiterate         =   // bool;    Признак неграмотности. По умолчанию false.
        // PersnParam.IsSpecialAccess    =   // bool;    Признак специального доступа к клиенту. По умолчанию false.
        // PersnParam.IsInterRelated     =   // bool;    Признак взаимосвязанного клиента. По умолчанию false.
        // PersnParam.TaxInstitution     =   // integer; Налоговая инспекция
        // PersnParam.TaxRegDate         =   // date;    Дата регистрации в налог.инспекции
        // PersnParam.SetAccSearchAlg    =   // integer; Алгоритм поиска СПИ: Брать или не брать СПИ из СПИ субъекта.
        // PersnParam.UserField1         =   // string;  Поле пользователя 1
        // PersnParam.UserField2         =   // string;  Поле пользователя 2
        // PersnParam.UserField3         =   // string;  Поле пользователя 3
        // PersnParam.UserField4         =   // string;  Поле пользователя 4
        // PersnParam.SysType            =   // string;  Системные 
        // PersnParam.UserType           =   // string;  Пользовательские типы
        // PersnParam.lawSubject         =   // string;  Cубъект права
        PersnParam.IsLocked           = false;  // integer; Признак закрытого субъекта
    end;
    return PersnParam;
END;

PRIVATE MACRO GetInstParamFromRequest(REQUEST): TWsInst   // Атрибуты юридического лица.
    var InstParam = TWsInst();
    /**  заполнение InstParam  **/
    if (REQUEST.Legal != NULL)
        InstParam.ShortName          = REQUEST.Legal.ShortName;   // string;  Сокращенное наименование
        // InstParam.FullName           =    // string;  Наименование.
        InstParam.Action             = ADD;   // string;  Действие.
        // InstParam.IsNotResident      =    // bool;    Признак нерезидентности.
        // InstParam.NRCountry          =    // string;  Код страны нерезидента
        // InstParam.IsOffshoreResident =    // bool;    Признак резидента оффшорной зоны.
        // InstParam.SuperiorID         =    // integer; Идентификатор вышестоящей или объемлющей организации
        // InstParam.TaxInstitution     =    // integer; Налоговая инспекция
        // InstParam.TaxRegDate         =    // date;    Дата регистрации в налог.инспекции
        // InstParam.SetAccSearchAlg    =    // integer; Алгоритм поиска СПИ: Брать или не брать СПИ из СПИ субъекта.
        InstParam.OKPO               = REQUEST.Legal.OKPO;   // string;  ОКПО
        // InstParam.UserField1         =    // string;  Поле пользователя 1.
        // InstParam.UserField2         =    // string;  Поле пользователя 2.
        // InstParam.UserField3         =    // string;  Поле пользователя 3.
        // InstParam.UserField4         =    // string;  Поле пользователя 4.
        // InstParam.SysType            =    // string;  Системные 
        // InstParam.UserType           =    // string;  Пользовательские типы
        // InstParam.lawSubject         =    // string;  Cубъект права
        InstParam.IsLocked           = 0;   // integer; Признак закрытого субъекта
    end;
    return InstParam; 
END;

PRIVATE MACRO GetClientParamFromRequest(REQUEST): TWsClient // Параметры клиента вида обслуживания.
    var ClientParam = TWsClient();
    /**  Заполнение ClientParam  **/
    ClientParam.ServKind         = 61;         // integer; Вид обслуживания
    ClientParam.Department       = {OperDprt}; // integer; Филиал, в котором обслуживается клиент. 
    ClientParam.StartDate        = {curdate};  // date;    Дата начала обслуживания.
    ClientParam.FinishDate       = NULL;       // date;    Дата окончания обслуживания.
    ClientParam.OperNum          = {Oper};     // integer; Номер операциониста
    ClientParam.OperName         = {Name_Oper};// string;  ФИО операциониста
    ClientParam.Action           = ADD;        // string;  Действие с видом обслуживания субъекта
    return ClientParam;
END;

PRIVATE MACRO GetCodesFromRequest(REQUEST): TArray    // Коды субъекта (массив структур TWsPartyCode).
    var Codes = TArray();
    /**  Заполнение Codes  **/
    if (REQUEST.Legal != NULL) 
        var CodeItem = TWsPartyCode();
        CodeItem.CodeKind = 27;                      // integer; Вид кода субъекта экономики 27 - ОГРН
        CodeItem.Code     = REQUEST.Legal.OGRN;      // string;  Код
        CodeItem.FromDate = REQUEST.Legal.OGRNDate;  // date;    Дата начала действия.
        CodeItem.Action   = ADD;                     // string;  Действие с кодом субъекта
        Codes[Codes.Size] = CodeItem;
    end;
    return Codes;
END;

PRIVATE MACRO GetAdressesFromRequest(REQUEST): TArray    // Адреса субъекта (массив структур TWsAdres).
    var Adresses = TArray();
    /** Заполнение Adresses **/
    if (REQUEST.AddressList != null)
        for (var address, REQUEST.AddressList)
            var addressItem = TWsAdres();
            addressItem.Type         = address.AddressType;   // TArray; Тип адреса.
            addressItem.Action       = ADD;                // string; Действие
            // addressItem.Country      =    // string; Код страны
            // addressItem.Territory    =    // string; Код территории
            addressItem.PostIndex    = address.PostCode;      // string; Индекс
            addressItem.CodeRegion   = address.RegionCode;    // string; Адм.-тер. единица региона
            addressItem.Region       = address.RegionName;    // string; Регион
            // addressItem.RegionNumber =    // string; Числовой код региона
            // addressItem.CodeProvince =    // string; Адм-тер. единица области
            // addressItem.Province     =    // string; Область
            // addressItem.CodeDistrict =    // string; Адм.-тер. единица района
            addressItem.District     = address.District;      // string; Район
            // addressItem.CodePlace    =    // string; Адм.-тер. единица населенного пункта
            addressItem.Place        = address.Settlement;    // string; Населенный пункт
            // addressItem.CodeStreet   =    // string; Адм.-тер. единица улицы
            addressItem.Street       = address.Street;        // string; Улица
            addressItem.House        = address.House;         // string; Дом
            addressItem.NumCorps     = address.Building;      // string; Корпус
            addressItem.Flat         = address.Apartment;     // string; Квртира
            addressItem.Adress       = address.AddressString; // string; Почтовый адрес
            // addressItem.Kladr        =    // string; Код КЛАДР
            // addressItem.Okato        =    // string; Код ОКАТО
            Adresses[Adresses.Size] = addressItem;
        end;
    end;
    return Adresses;
END;

PRIVATE MACRO GetContactsFromRequest(REQUEST): TArray    // Контакты субъекта (массив структур TWsContactInfo).
    var Contacts = TArray();
    /** Заполнение Contacts **/
    if (REQUEST.ContactList != null)
        for (var contact, REQUEST.ContactList)
            var contactItem = TWsContactInfo();
            contactItem.Kind            = Contact.Type;    // integer; Вид контакта
            // contactItem.Category        =    // integer; Характер контакта
            contactItem.Value           = Contact.Value;   // string;  Значение контакта
            // contactItem.AdresType       =    // integer; Тип адреса. В RS-Bank'е контактная информация хранится вместе с адресом субъекта.
            contactItem.Action          = ADD;          // string;  Действие
            // contactItem.PhoneNumber2    =    // string;  Дополнительный телефонный номер
            // contactItem.MobileProvider  =    // string;  Наименование мобильного оператора
            // contactItem.RS_Mail_Country =    // integer; Страна RS-Mail
            // contactItem.RS_Mail_Region  =    // integer; Регион RS-Mail
            // contactItem.RS_Mail_Node    =    // integer; Узел RS-Mail
            Contacts[Contacts.Size] = contactItem;
        end;
    end;
    return Contacts;
END;

PRIVATE MACRO GetPersnPapersFromRequest(REQUEST): TArray    // Документы, удостоверяющие личность личность (массив структур TWsPaper).
    var PersnPapers = TArray();
    /** заполнение PersnPapers **/
    if ((REQUEST.Physical != NULL) and (REQUEST.Physical.IDoc != null))
        var persnPaperItem = TWsPaper();
        persnPaperItem.Kind         = REQUEST.Physical.IDoc.TypeDoc;     // string; Код вида документа по справочнику "Виды документов, удостоверяющих личность налогоплательщика"
        persnPaperItem.Action       = ADD;                               // string; Действие.
        persnPaperItem.Series       = REQUEST.Physical.IDoc.SerDoc;      // string; Серия
        persnPaperItem.Number       = REQUEST.Physical.IDoc.NumDoc;      // string; Номер
        persnPaperItem.IssuedDate   = REQUEST.Physical.IDoc.DateDoc;     // date;   Дата выдачи документа
        persnPaperItem.Issuer       = REQUEST.Physical.IDoc.Issuer;      // string; Наименование организации, выдавшей документ
        persnPaperItem.IssuerCode   = REQUEST.Physical.IDoc.IssuerCode;  // string; Код подразделения, выдавшего документ
        persnPaperItem.IsMain       = True;                              // bool;   Признак основного документа.
        // persnPaperItem.CountryLat2  =   // string; Двухбуквенный код страны, выдавшей ДУЛ
        // persnPaperItem.ValidToDate  =   // date;   Дата окончания действия документа
        PersnPapers[PersnPapers.Size] = persnPaperItem;
    end;
    return PersnPapers;
END;

PRIVATE MACRO GetRegDocsFromRequest(REQUEST): TArray    // Регистрационные документы (массив структур TWsRegDoc).
    var RegDocs = TArray();
    /** Заполнене RegDocs **/
    // Пока без регистрационных документов
    /*if (REQUEST.Legal != NULL)
        var RegDocItem = TWsRegDoc();
        RegDocItem.RegDocKind   =   // string; Вид регистрационного документа
        RegDocItem.RegPartyKind =   // string; Вид регистрационного органа
        RegDocItem.Action       = ADD;  // string; Действие.
        RegDocItem.RegDocNumber = REQUEST.Legal.OGRN; // string; Регистрационный номер
        RegDocItem.Series       = REQUEST.Legal.SertRegSer;  // string; Серия регистрационного документа
        RegDocItem.Number       = REQUEST.Legal.SertRegNum;  // string; Номер регистрационного документа
        RegDocItem.DocDate      = REQUEST.Legal.OGRNDate;  // date;   Дата регистрационного документа.
        RegDocItem.StartDate    =   // date;   Дата начала действия документа
        RegDocItem.FinishDate   =   // date;   Дата окончания действия документа
        RegDocItem.RegPlace     = REQUEST.Legal.  // string; Место регистрации
        RegDocItem.IsMain       = true;  // bool;   Признак "Основной регистрационный документ".
        RegDocItem.IsClosed     = false;  // bool;   Признак "Регистрация недействительна".
        RegDocs[RegDocs.Size] = RegDocItem;
    end;*/
    return RegDocs;
END;

PRIVATE MACRO GetPartyNotesFromRequest(REQUEST): TArray    // Примечания субъекта (массив структур TWsNote).
    var PartyNotes = TArray();

    return PartyNotes;
END;

PRIVATE MACRO GetPersnNotesFromRequest(REQUEST): TArray    // Примечания физ. лица (массив структур TWsNote).
    var PersnNotes = TArray();

    return PersnNotes;
END;

PRIVATE MACRO GetSettAccsFromRequest(REQUEST): TArray    // СПИ субъекта (массив структур TWsSettAcc).
    var SettAccs = TArray();
    /** заполнение SettAccs **/
    if ((REQUEST.Legal != NULL) and (REQUEST.Legal.PaymentField != NULL))
        var SettAccsItem = TWsSettAcc();
        SettAccsItem.Action	          = ADD;                                  // String;  Действие над СПИ
        SettAccsItem.Order	          = 1;                                    // Integer; Порядок сортировки
        // SettAccsItem.Description	      =    // String;  Описание СПИ
        // SettAccsItem.FICode	          =    // String;  Код валюты счета.
        // SettAccsItem.Chapter	          =    // Integer; Номер главы счета
        SettAccsItem.Account	      = REQUEST.Legal.PaymentField.ClientAcc; // String;  Номер счета
        // SettAccsItem.FIKind	          =    // Integer; Вид ФИ
        SettAccsItem.BankCodeKind	  = 3;                                    // Integer; Вид кода банка 3 - БИК ЦБ РФ
        SettAccsItem.BankCode	      = REQUEST.Legal.PaymentField.BIK;       // String;  Код банка
        // SettAccsItem.BankCorrCodeKind  =    // Integer; Вид кода банка корреспондента
        // SettAccsItem.BankCorrCode      =    // String;  Код банка корреспондента
        SettAccsItem.CorrAcc	      = REQUEST.Legal.PaymentField.BankAcc;   // String;  Корр. Счет
        // SettAccsItem.ShortName	      =    // String;  Код СПИ
        // SettAccsItem.NoAccept	      =    // Bool;    Признак <Без акцепта>
        SettAccs[SettAccs.Size] = SettAccsItem;
    end;
    return SettAccs;
END;



PRIVATE MACRO InsertPartyFromConnect(REQUEST): integer // partyID
    var result = 0;
    var PersnParam  = GetPersnParamFromRequest(REQUEST) ;  // Атрибуты физического лица.
    var InstParam   = GetInstParamFromRequest(REQUEST) ;   // Атрибуты юридического лица.
    var ClientParam = GetClientParamFromRequest(REQUEST) ; // Параметры клиента вида обслуживания.
    var Codes       = GetCodesFromRequest(REQUEST) ;       // Коды субъекта (массив структур TWsPartyCode).
    var Adresses    = GetAdressesFromRequest(REQUEST) ;    // Адреса субъекта (массив структур TWsAdres).
    var Contacts    = GetContactsFromRequest(REQUEST) ;    // Контакты субъекта (массив структур TWsContactInfo).
    var PersnPapers = GetPersnPapersFromRequest(REQUEST) ; // Документы, удостоверяющие личность личность (массив структур TWsPaper).
    var RegDocs     = GetRegDocsFromRequest(REQUEST) ;     // Регистрационные документы (массив структур TWsRegDoc).
    var PartyNotes  = GetPartyNotesFromRequest(REQUEST) ;  // Примечания субъекта (массив структур TWsNote).
    var PersnNotes  = GetPersnNotesFromRequest(REQUEST) ;  // Примечания физ. лица (массив структур TWsNote).
    var SettAccs    = GetSettAccsFromRequest(REQUEST) ;    // СПИ субъекта (массив структур TWsSettAcc).
    result = InsertParty(PersnParam, InstParam, ClientParam, Codes, Adresses, Contacts, PersnPapers, RegDocs, PartyNotes, PersnNotes, SettAccs);
    return result;
END;

// Поиск субьекта в системе.
PRIVATE MACRO FindRequestedParty(REQUEST): integer // PartyID
    var PartyID = 0;
    // тут поискать субъекта: вдруг уже существует.

    // доработать после аналитической проработки
    return PartyID;
END;

PRIVATE MACRO InsertGuaranteeFromConnect(REQUEST): integer // GuaranteeID
    var GuaranteeID: integer = 0;
    // добавляем заявку на гарантию

    // доработать после аналитической проработки
    return GuaranteeID;
END;

/**
Прием субъекта от RsConnect
REQUEST: RSCEBBGParty
*/
MACRO CreateParty(REQUEST)
    var result = RSCReq_CreatePartyResponse();
    var PartyID = FindRequestedParty(REQUEST);
    if (PartyID == 0) // ничего не нашли, значит нужно добавить нового субъекта
        PartyID = InsertPartyFromConnect(REQUEST);
    end;
    result.ReqID      = REQUEST.ReqID;    //Уникальный идентификатор запроса в RS-Connect
    result.SenderID   = REQUEST.SenderID; //Идентификатор (код) Абонента, кому адресован запрос
    result.ResultCode = 0;                //Код результата - по справочнику  (0 - всё хорошо)
    result.ResultText = "";               //Пояснительный текст к результатам обработки
    result.ClientID   = PartyID;          //ИД клиента
    return result;
END;

/** 
Прием гарантии от RsConnect
REQUEST: RSCEBBGGuarantee
*/
MACRO CreateGuarantee(REQUEST)
    var result = RSCReq_CreateGuardResponse();
    var GuaranteeID = InsertGuaranteeFromConnect(REQUEST);
    result.ReqID       = REQUEST.ReqID;    //Уникальный идентификатор запроса в RS-Connect
    result.SenderID    = REQUEST.SenderID; //Идентификатор (код) Абонента, кому адресован запрос
    result.ResultCode  = 0;                //Код результата - по справочнику (0 - всё хорошо)
    result.ResultText  = "";               //Пояснительный текст к результатам обработки
    result.GuaranteeID = GuaranteeID;      //ИД созданной БГ в АБС
    return result; 
END;