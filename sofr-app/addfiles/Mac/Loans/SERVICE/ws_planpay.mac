/*
$Name:             ws_planpay.mac
$Module:           Кредитование
$Description:      Пакетное формирование ГП
*/
/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ws_planpay.mac
 Description : Макрос пакетного перерасчета графика

 Programmer  : TFS
 12.10.12    : Создан
------------------------------------------------------------------------------*/

IMPORT SbCrdInter, "lgo_opstruct.mac", "lgo_const.mac", "lgo_func.mac", total;

macro OperationPlanPay(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
   PRIVATE VAR ErrManager : CErrManager;
   VAR BatchOperID = 1, errid = 0, errtxt = "", R = 0;

   // ==> Если запись есть, значит пачка уже обработана, выход
   VAR cnt = 
   CRSDCommand("SELECT COUNT(1) FROM DCNVPACK_BATCHOP_DBT WHERE T_EXECID = ? AND  T_CONVTYPEID = ? AND T_PACKID = ? AND T_OPERATIONID = ?",
              "p1", _execID, 
              "p2", _conveyerID, 
              "p3", _packetID, 
              "p4", _operationID,
              V_INTEGER);
   IF (cnt > 0)
      LgoSqlExec("UPDATE DCNVPACK_DBT SET T_STATE = T_STATE + 1 WHERE T_TASKID = ? AND T_EXECID = ? AND T_PACKID = ? AND T_CONVTYPEID = ?",
                 _taskID, _execID, _packetID, _conveyerID);
      RETURN 0;
   END;
   // <==

   IF (NOT OpenLoansCommonFiles())
      LgoSqlExec("UPDATE DCNVPACK_DBT SET T_STATE = T_STATE + 1 WHERE T_TASKID = ? AND T_EXECID = ? AND T_PACKID = ? AND T_CONVTYPEID = ?",
             _taskID, 
             _execID, 
             _packetID, 
             _conveyerID);

      LoansError("Ошибка открытия файлов");
      RETURN FALSE;
   END;

   LgoSqlExec("TRUNCATE TABLE DDOC_ACC_TMP");
   LgoSqlExec("TRUNCATE TABLE DLCHSUMRG_TMP"); 
   LgoSqlExec("TRUNCATE TABLE DLNSERROR_TMP");
   LgoSqlExec("TRUNCATE TABLE DPERCPAY_TMP");
   LgoSqlExec("TRUNCATE TABLE DPERCRANG_TMP");
   LgoSqlExec("TRUNCATE TABLE DPAYMENT_TMP");
   LgoSqlExec("TRUNCATE TABLE DLGPAYOP_TMP");
   LgoSqlExec("TRUNCATE TABLE DPLANMAC_TMP");
   LgoSqlExec("TRUNCATE TABLE DPLAN_PAY_TMP");

   R =
   RunStoredFunc("RSO_LoansPlanPay.FillFileGroupRecalcGPay", V_INTEGER, NULL, _TaskID,
                                                                              _ExecID,
                                                                              _ConveyerID,
                                                                              _PacketID,
                                                                              _Params.OperDate);

   // Отладочная информация, нужно знать какая ошибка или операция сформировались
   LgoSqlExec("SELECT " + R + " AS FillFileGroupRecalcGPay FROM DUAL");
   IF (R == 0)
      BatchOperID = СформироватьПакетнуюОперацию(_Params.OperType, 
                                                 _Params.OperDate, 
                                                 _Params.OperDate, 
                                                 _ExecID, 
                                                 _ConveyerID, 
                                                 _PacketID, 
                                                 _OperationID);
   END;

   // Отладочная информация, нужно знать какая ошибка или операция сформировались
   LgoSqlExec("SELECT " + BatchOperID + " AS BatchOperID FROM DUAL");
   //

   LgoSqlExec("TRUNCATE TABLE DDOC_ACC_TMP");
   LgoSqlExec("TRUNCATE TABLE DLCHSUMRG_TMP"); 
   LgoSqlExec("TRUNCATE TABLE DLNSERROR_TMP");
   LgoSqlExec("TRUNCATE TABLE DPERCPAY_TMP");
   LgoSqlExec("TRUNCATE TABLE DPERCRANG_TMP");
   LgoSqlExec("TRUNCATE TABLE DLGPAYOP_TMP");
   LgoSqlExec("TRUNCATE TABLE DPLANMAC_TMP");
   LgoSqlExec("TRUNCATE TABLE DPLAN_PAY_TMP");

   CloseLoansCommonFiles();

   IF ((BatchOperID <= 0) AND (R > 0))
      errid = GetMO_ErrorID();
      
      // SCR 198708
      IF (errid == 18765)
         RETURN 0;
      END;

      IF (errid <= 0)
         errid = 18644;
      END;

      errtxt = GetMO_LoansError();

      IF (Trim(errtxt) == "")
         errtxt = "Ошибка выполнения операции";
      END;

      RunError(errtxt, errid);
   END;

   LgoSqlExec("UPDATE DCNVPACK_DBT SET T_STATE = T_STATE + 1 WHERE T_TASKID = ? AND T_EXECID = ? AND T_PACKID = ? AND T_CONVTYPEID = ?",
             _taskID, 
             _execID, 
             _packetID, 
             _conveyerID);

   RETURN 0;
   //сюда попадем, если было выброшено исключение.
   OnError(err)
      LgoSqlExec("UPDATE DCNVPACK_DBT SET T_STATE = T_STATE + 1 WHERE T_TASKID = ? AND T_EXECID = ? AND T_PACKID = ? AND T_CONVTYPEID = ?",
                _taskID, 
                _execID, 
                _packetID, 
                _conveyerID);

      IF (ValType(err.Err) == V_INTEGER)
         RunError(err.Err, err.Message);
      ELSE
         RunError(18644, "Ошибка выполнения операции");
      END;
      RETURN 1;
END;