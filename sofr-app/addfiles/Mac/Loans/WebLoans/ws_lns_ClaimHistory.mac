/*
$Name: ws_lns_ClaimHistory.mac
$Module: WebLoans
$Description: История КЗ
*/

import LnsClaimRouteCore, ws_validation;
IMPORT RsbDataSet, "ws_datafilter.mac";

CLASS CLnsClaimHistoryItem()
    VAR Num     : integer  = 0;           // Номер по порядку
    VAR ID      : integer  = 0;           // Идентификатор шага
    VAR ClaimID : integer  = 0;           // Идентификатор заявки
    VAR StepID  : string   = "";          // Идентфикатор шага в машруте
    VAR StepName: string   = "";          // Название шага
    VAR StepDate: DateTime = Date(0,0,0); // Дата выполнения
    VAR User    : integer  = 0;           // Идентификатор пользователя, выполнивший шаг
    VAR UserName: string   = "";          // Имя пользователя, выполнившего шаг
    VAR ClaimStatus: string = "";         // Статус заявки
    VAR ClaimStage: string = "";          // Стадия заявки
    VAR UIParm  : string   = "";          // Параметры интерфейса
    VAR StepParm: string   = "";          // Параметры шага
END;

PRIVATE MACRO GetAnswerNumberCondition(
  condition:Integer
 ,value
 ,type:Integer
):String
    var strSQLCond:String = " 1 = 1 "; 
   
    if ((ValType(value) != V_UNDEF) and (value.Size > 0))
        if ((ValType(value[0]) == V_STRING) and (condition == FilterCondition_Equal))
            strSQLCond = "DBMS_LOB.INSTR(LOWER(CH.T_STEPPARM), '<lnscommontype:lnsvalueobject>'||chr(13)||chr(10)||" + 
                         "'<lnscommontype:lnsvalueobject.value>'||chr(13)||chr(10)||" + 
                         "'<system:string>" + StrLwr(value[0]) + "</system:string>'||chr(13)||chr(10)||" + 
                         "'</lnscommontype:lnsvalueobject.value>'||chr(13)||chr(10)||" + 
                         "'<lnscommontype:lnsvalueobject.valuename>'||chr(13)||chr(10)||" + 
                         "'<system:string>answernumber</system:string>'||chr(13)||chr(10)||" + 
                         "'</lnscommontype:lnsvalueobject.valuename>') > 0";
        elif ((ValType(value[0]) == V_STRING) and (condition == FilterCondition_Include))
            strSQLCond = "((" +
                         "DBMS_LOB.INSTR(LOWER(CH.T_STEPPARM), '" + StrLwr(value[0]) +  "') >= (DBMS_LOB.INSTR(LOWER(CH.T_STEPPARM),  '<lnscommontype:lnsvalueobject>'||chr(13)||chr(10)||" + 
                                                                                                                                     "'<lnscommontype:lnsvalueobject.value>'||chr(13)||chr(10)||" + 
                                                                                                                                     "'<system:string>') + " + 
                                                                                               "LENGTH('<lnscommontype:lnsvalueobject>'||chr(13)||chr(10)||" + 
                                                                                                      "'<lnscommontype:lnsvalueobject.value>'||chr(13)||chr(10)||" + 
                                                                                                      "'<system:string>')) " +
                           ")" + 
                           "and (DBMS_LOB.INSTR(LOWER(CH.T_STEPPARM), '" + StrLwr(value[0]) +  "') < DBMS_LOB.INSTR(LOWER(CH.T_STEPPARM), '</system:string>'||chr(13)||chr(10)||" + 
                                                                                                                                         "'</lnscommontype:lnsvalueobject.value>'||chr(13)||chr(10)||" + 
                                                                                                                                         "'<lnscommontype:lnsvalueobject.valuename>'||chr(13)||chr(10)||" + 
                                                                                                                                         "'<system:string>answernumber</system:string>'||chr(13)||chr(10)||" + 
                                                                                                                                         "'</lnscommontype:lnsvalueobject.valuename>')))";
        end;
    end;

    return strSQLCond;
END;

PRIVATE MACRO GetAnswerDateCondition(
  condition:Integer
 ,value    
 ,type:Integer
):String
    var strSQLCond:String = " 1 = 1 ";
    if ((ValType(value) != V_UNDEF) and (value.Size >= 0))
        if ((ValType(value[0]) == V_DATE) and (condition == FilterCondition_Equal))
            strSQLCond = "DBMS_LOB.INSTR(CH.T_STEPPARM, '<LnsCommonType:LnsValueObject>'||chr(13)||chr(10)||" + 
                                     "'<LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                     "'<System:String>" + StrSubst(String(value[0]), " ", "0") + "</System:String>'||chr(13)||chr(10)||" + 
                                     "'</LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                     "'<LnsCommonType:LnsValueObject.ValueName>'||chr(13)||chr(10)||" + 
                                     "'<System:String>AnswerDate</System:String>'||chr(13)||chr(10)||" + 
                                     "'</LnsCommonType:LnsValueObject.ValueName>') > 0";
        elif (condition == FilterCondition_CurrentDate)
            strSQLCond = "DBMS_LOB.INSTR(CH.T_STEPPARM, '<LnsCommonType:LnsValueObject>'||chr(13)||chr(10)||" + 
                                     "'<LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                     "'<System:String>" + StrSubst(String({curdate}), " ", "0") + "</System:String>'||chr(13)||chr(10)||" + 
                                     "'</LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                     "'<LnsCommonType:LnsValueObject.ValueName>'||chr(13)||chr(10)||" + 
                                     "'<System:String>AnswerDate</System:String>'||chr(13)||chr(10)||" + 
                                     "'</LnsCommonType:LnsValueObject.ValueName>') > 0";
        elif ((ValType(value[0]) == V_DATE) and (condition == FilterCondition_From))
            strSQLCond = "(TO_DATE(DBMS_LOB.SUBSTR(CH.T_STEPPARM," +   
                                "10," +                                     
                                "DBMS_LOB.INSTR(CH.T_STEPPARM,'</System:String>'||chr(13)||chr(10)||" + 
                                                        "'</LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                                        "'<LnsCommonType:LnsValueObject.ValueName>'||chr(13)||chr(10)||" + 
                                                        "'<System:String>AnswerDate</System:String>'||chr(13)||chr(10)||" + 
                                                        "'</LnsCommonType:LnsValueObject.ValueName>') - 10" +       
                                ")" +              
                         ", 'DD.MM.YYYY') >= TO_DATE('" + StrSubst(String(value[0]), " ", "0") + "', 'DD.MM.YYYY')" + 
                         ")";   
        elif ((ValType(value[0]) == V_DATE) and (condition == FilterCondition_To))
            strSQLCond = "(TO_DATE(DBMS_LOB.SUBSTR(CH.T_STEPPARM," +   
                                "10," +                                     
                                "DBMS_LOB.INSTR(CH.T_STEPPARM,'</System:String>'||chr(13)||chr(10)||" + 
                                                        "'</LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                                        "'<LnsCommonType:LnsValueObject.ValueName>'||chr(13)||chr(10)||" + 
                                                        "'<System:String>AnswerDate</System:String>'||chr(13)||chr(10)||" + 
                                                        "'</LnsCommonType:LnsValueObject.ValueName>') - 10" +       
                                ")" +              
                         ", 'DD.MM.YYYY') <= TO_DATE('" + StrSubst(String(value[0]), " ", "0") + "', 'DD.MM.YYYY')" + 
                         ")";  
        elif ((ValType(value[0]) == V_DATE) and (ValType(value[1]) == V_DATE) and (condition == FilterCondition_Between))
            strSQLCond = "((TO_DATE(DBMS_LOB.SUBSTR(CH.T_STEPPARM," +   
                                                   "10," +                                     
                                                   "DBMS_LOB.INSTR(CH.T_STEPPARM,'</System:String>'||chr(13)||chr(10)||" + 
                                                                                "'</LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                                                                "'<LnsCommonType:LnsValueObject.ValueName>'||chr(13)||chr(10)||" + 
                                                                                "'<System:String>AnswerDate</System:String>'||chr(13)||chr(10)||" + 
                                                                                "'</LnsCommonType:LnsValueObject.ValueName>') - 10" +       
                                                   ")" +              
                                    ", 'DD.MM.YYYY') >= TO_DATE('" + StrSubst(String(value[0]), " ", "0") + "', 'DD.MM.YYYY')" + 
                           ")" + 
                           "and" + 
                          "(TO_DATE(DBMS_LOB.SUBSTR(CH.T_STEPPARM," +   
                                                   "10," +                                     
                                                   "DBMS_LOB.INSTR(CH.T_STEPPARM,'</System:String>'||chr(13)||chr(10)||" + 
                                                                                "'</LnsCommonType:LnsValueObject.Value>'||chr(13)||chr(10)||" + 
                                                                                "'<LnsCommonType:LnsValueObject.ValueName>'||chr(13)||chr(10)||" + 
                                                                                "'<System:String>AnswerDate</System:String>'||chr(13)||chr(10)||" + 
                                                                                "'</LnsCommonType:LnsValueObject.ValueName>') - 10" +       
                                                    ")" +              
                                    ", 'DD.MM.YYYY') <= TO_DATE('" + StrSubst(String(value[1]), " ", "0") + "', 'DD.MM.YYYY')" + 
                           ")" +     
                          ")";
        end;
    end;

    return strSQLCond;
END;

PRIVATE MACRO GetClaimStatusCondition(
  condition:Integer
 ,value
 ,type:Integer
):String
    var strSQLCond:String = "";       
    
    if ((ValType(value) != V_UNDEF) and (value.Size > 0))
        strSQLCond = " cst.T_ID ";
        var i:integer = 0;
        while (i < value.Size)
            if ((ValType(value[i].ID) == V_INTEGER) and (condition == FilterCondition_Equal))
                if (i > 0)
                    strSQLCond = strSQLCond + ", " + value[i].ID;                
                else    
                    strSQLCond = strSQLCond + " IN (" + value[i].ID;
                end;
                            
            end;                  
            i = i + 1;
        end;
        strSQLCond = strSQLCond + ")";
    else
        strSQLCond = " 1 = 1 ";
    end;

    return strSQLCond;
END;

PRIVATE MACRO GetUserCondition(
  condition:Integer
 ,value
 ,type:Integer
):String
    var strSQLCond:String = "";       
    
    if ((ValType(value) != V_UNDEF) and (value.Size > 0))
        strSQLCond = " ch.T_USER ";
        var i:integer = 0;
        while (i < value.Size)
            if ((ValType(value[i]) == V_INTEGER) and (condition == FilterCondition_Equal))
                if (i > 0)
                    strSQLCond = strSQLCond + ", " + value[i];                
                else    
                    strSQLCond = strSQLCond + " IN (" + value[i];
                end;
                            
            end;                  
            i = i + 1;
        end;
        strSQLCond = strSQLCond + ")";
    else
        strSQLCond = " 1 = 1 ";
    end;

    return strSQLCond;
END;

MACRO GetWhere(FilterItems)

    var fp = FilterParser( FilterItems );
    fp.AddFieldCondition( 0, "ch", "T_STEPNAME");
    fp.AddUserFieldCondition( 1, @GetAnswerNumberCondition);
    fp.AddUserFieldCondition( 2, @GetAnswerDateCondition);
    fp.AddUserFieldCondition( 3, @GetClaimStatusCondition);
    fp.AddUserFieldCondition( 4, @GetUserCondition);
    return fp.GetFullSQLCondition();  
END;

MACRO lns_GetClaimHistoryList(ClaimID, FilterConditionItems)

    var Num = 0;
    var result = TArray();
    var item = null;
    VAR filter  = "";
    var qStr = "SELECT ch.*, p.t_name as t_UserName, " +
               "csg.t_name as t_StageName, cst.t_name as t_statusName " +
               "FROM dlclaimhistory_dbt ch, dperson_dbt p,  dlclaimstage_dbt csg, dlclaimstatus_dbt cst " + 
               "WHERE p.t_oper = ch.t_user AND " +
               "csg.t_id = ch.t_claimstage AND cst.t_id = ch.t_claimstatus AND " +
               "ch.t_claimid = " + ClaimID;

    filter = GetWhere(FilterConditionItems);
    
    if (filter != "")
        qStr = qStr + " AND " + filter;
    end; 
              
    qStr = qStr + " ORDER BY ch.t_id";
    var rs = TRsbDataSet(qStr);
    while(rs.MoveNext)
        Num = Num + 1;
        item = CLnsClaimHistoryItem();
        
        item.Num      = Num;
        item.ID       = rs.ID;
        item.ClaimID  = rs.ClaimID;
        item.StepID   = rs.StepID;
        item.StepName = rs.StepName;
        item.StepDate = rs.StepDate;
        item.User     = rs.User;
        item.UserName = rs.UserName;
        item.ClaimStatus = rs.StatusName;
        item.ClaimStage = rs.StageName;
        item.UIParm   = rs.UIParm;
        item.StepParm = rs.StepParm;

        result[result.size] = item;
    end;
    return result;
END;




