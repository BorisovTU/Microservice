/*
$Name: ws_lns_IdentClient.mac
$Module: WebLoans
$Description: Сервис идентификации клиента
*/

IMPORT BankInter, RsbDataSet;

PRIVATE CONST
    CLIENTFINDMODE_UNDEF   = 0,
    CLIENTFINDMODE_ONLYFIZ = 1,
    CLIENTFINDMODE_ONLYJUR = 2,
    CLIENTFINDMODE_FIZJUR  = 3;

MACRO lns_GetIdentPermission(oper)
  var 
      retVal = CLIENTFINDMODE_UNDEF;

    retVal = CLIENTFINDMODE_FIZJUR;

    return retVal;
END;

MACRO lns_GetLegalFormDefault(oper)
  var
      retVal = 0, err,
      qStr = "", rs = NULL;

    GetRegistryValue ("RS-LOANS\\WEB\\IDENTCLIENT_LEGALFORM_DEFAULT", V_INTEGER, retVal, err);

    if ((retVal != 1)and(retVal != 2))
        retVal = 2;

        qStr = "select t.* from ";
        qStr = qStr + "( ";
        qStr = qStr + "  (select 2 as t_LegalForm from dual where exists(SELECT 1 FROM dacsoprole_dbt t WHERE t_oper = " + String(oper) + " and t_roleID in (7, 9)) ";
        qStr = qStr + "  union  ";
        qStr = qStr + "  select 1 as t_LegalForm from dual where exists(SELECT 1 FROM dacsoprole_dbt t WHERE t_oper = " + String(oper) + " and t_roleID in (8, 10))) ";
        qStr = qStr + "  order by t_LegalForm desc ";
        qStr = qStr + ") t   ";
        qStr = qStr + "where rownum = 1 ";

        rs = TRsbDataSet(qStr);
        if (rs.MoveNext())
            retVal = Int(rs.LegalForm);
        end;
    end;

    return retVal;
END;

MACRO lns_SetLegalFormDefault(oper, LegalForm)
    SetRegistryValue("RS-LOANS\\WEB\\IDENTCLIENT_LEGALFORM_DEFAULT", Int(LegalForm), oper);
    return 0;
END;

MACRO lns_CheckClient(oper, ClientID)
    var qStr = "";
    var rs = NULL;
    var 
        retVal = 0;

    qStr = "select t_LegalForm from dparty_dbt where t_PartyID = " + String(ClientID);
    rs = TRsbDataSet(qStr);
    if (rs.MoveNext())
        retVal = rs.LegalForm;
    end;

    return retVal;
END;

PRIVATE CLASS CLnsClientInfo()
    var ClientID = 0;
    var LegalForm = 0;
    var IsEmployer = false;
END;

MACRO lns_GetClientInfo(ClientID)
    var qStr = "";
    var rs = NULL;
    var 
        retVal = NULL;

    qStr = "select ";
    qStr = qStr + " party.t_PartyID, ";
    qStr = qStr + " party.t_LegalForm, ";
    qStr = qStr + " NVL(persn.t_IsEmployer, chr(0)) as t_IsEmployer ";
    qStr = qStr + " from dparty_dbt party, dpersn_dbt persn ";
    qStr = qStr + " where party.t_PartyID = " + String(ClientID);
    qStr = qStr + " and persn.t_PersonID(+) = party.t_PartyID ";

    rs = TRsbDataSet(qStr);
    if (rs.MoveNext())
        retVal = CLnsClientInfo();
        retVal.ClientID = rs.PartyID;
        retVal.LegalForm = rs.LegalForm;
        if (rs.IsEmployer == "X") retVal.IsEmployer = true; end;
    end;

    return retVal;
END;