/*
$Name: ws_lns_RegChartWindow.mac
$Module: WebLoans
$Description: Сервис получения информации по графикам
*/
IMPORT "ws_lns_Registers.mac";

PRIVATE MACRO MakeWindowTitle(RegName)
  var
      retVal = "История изменения остатков по регистру";

    if ((ValType(RegName) == V_STRING)and(RegName != ""))
        retVal = retVal + ": " + RegName;
    end;

    RETURN retVal;
END;

MACRO lns_RegChartWindow(MacroParms)
  var
      RegName = lns_getregname(MacroParms[0].Value),
      RegCurCode = lns_getregcurcode(MacroParms[0].Value),
      Title = MakeWindowTitle(RegName),
      Data = lns_reghistory(MacroParms[0].Value),
      SvData = lns_regsvhistory(MacroParms[0].Value),
      ObjID = int(MacroParms[1].Value.ObjID),
      idx = 0,
      str = 
"<RsControls:RsFloatingWindow " +
"    xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
"    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
"    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
"    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
"    xmlns:DVC='clr-namespace:System.Windows.Controls.DataVisualization.Charting;assembly=System.Windows.Controls.DataVisualization.Toolkit' " +
"    xmlns:RsControls='clr-namespace:RsControls;assembly=RsControls' " +
"    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk'" +
"    xmlns:MEICore='clr-namespace:Microsoft.Expression.Interactivity.Core;assembly=Microsoft.Expression.Interactions' " +
"    xmlns:SWI='clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity' " +
"    xmlns:Converter='clr-namespace:DataProvider.ViewModel.Helpers;assembly=DataProvider' " +
"    xmlns:LnsConverter='clr-namespace:Loans.LoansCommon.Helpers;assembly=LoansCommon' " +
"    xmlns:LnsCustomTypes='clr-namespace:Loans.LoansCommon.CustomTypes;assembly=LoansCommon' " +
"    xmlns:LnsCommonType='clr-namespace:Loans.LoansCommon.DataModel;assembly=LoansCommon' " +
"    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
"    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " +
"    xmlns:RsTools='clr-namespace:RsTools;assembly=RsTools' " +
"    xmlns:RsToolsUtils='clr-namespace:RsTools.Utils.MultiBinding;assembly=RsTools' " +
"    mc:Ignorable='d' " +
"    d:DesignHeight='300' d:DesignWidth='400' " +
"    x:Name='rootElement' " +
"    HelpPath='HelpRSBankWeb.html?lnsRegistersTab_Graph.htm' " +
"    Title='" + Title + "'";

    if (ObjID == LO_CREDIT)
        str = str + "    IsToolbarVisible='True'";
    else
        str = str + "    IsToolbarVisible='False'";
    end;
    
str = str +
"    >" +
"    <RsControls:RsFloatingWindow.Resources>" +
"        <LnsConverter:MoneyToDoubleConverter x:Key='MoneyToDoubleConverter'/>" +
"        <LnsConverter:LnsValueListConverter x:Key='LnsValueListConverter'/>" +
"        <LnsConverter:StringToIntConverter x:Key='StringToIntConverter'/>" +
"        <System:Int32 x:Key='restDate_field'>" + string(1) + "</System:Int32>" +
"        <LnsCommonType:LnsValueObject x:Key='ChartData'>" +
"            <LnsCommonType:LnsValueObject.Value>" +
"                <LnsCustomTypes:LnsValueList>" +
"                    <LnsCommonType:LnsValueObject ValueName='RegHist'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <LnsCustomTypes:LnsValueList>";
    if (Data.size > 0)
        while (idx < Data.size)
            str = str +
"                                <LnsCommonType:LnsValueObject>" +
"                                    <LnsCommonType:LnsValueObject.Value>" +
"                                        <LnsCustomTypes:LnsValueList>" +
"                                            <LnsCommonType:LnsValueObject ValueName='PeriodNum'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <System:Int32>" + String(idx) + "</System:Int32>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='restDate'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <System:String>" + String(Data[idx].restDate:f) + "</System:String>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='regDebt'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(Data[idx].regDebt) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='regCred'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(Data[idx].regCred) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='regRest'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(Data[idx].regRest) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                        </LnsCustomTypes:LnsValueList>" +
"                                    </LnsCommonType:LnsValueObject.Value>" +
"                                </LnsCommonType:LnsValueObject>";
            idx = idx + 1;
        end;
    end;
    idx = 0;
        str = str +
"                            </LnsCustomTypes:LnsValueList>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +

"                    <LnsCommonType:LnsValueObject ValueName='RegSvHist'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <LnsCustomTypes:LnsValueList>";
    if (SvData.size > 0)
        while (idx < SvData.size)
            str = str +
"                                <LnsCommonType:LnsValueObject>" +
"                                    <LnsCommonType:LnsValueObject.Value>" +
"                                        <LnsCustomTypes:LnsValueList>" +
"                                            <LnsCommonType:LnsValueObject ValueName='PeriodNum'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <System:Int32>" + String(idx) + "</System:Int32>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='restDate'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <System:String>" + String(SvData[idx].restDate:f) + "</System:String>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='regDebt'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(SvData[idx].regDebt) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='regCred'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(SvData[idx].regCred) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='regRest'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(SvData[idx].regRest) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                        </LnsCustomTypes:LnsValueList>" +
"                                    </LnsCommonType:LnsValueObject.Value>" +
"                                </LnsCommonType:LnsValueObject>";
            idx = idx + 1;
        end;
    end;
        str = str +
"                            </LnsCustomTypes:LnsValueList>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='RegName'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <System:String>" + String(RegName) + "</System:String>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                </LnsCustomTypes:LnsValueList>" +
"            </LnsCommonType:LnsValueObject.Value>" +
"        </LnsCommonType:LnsValueObject>" +
"    </RsControls:RsFloatingWindow.Resources>" +
"    <Grid x:Name='LayoutRoot'>" +
"        <Grid.RowDefinitions>" +
"            <RowDefinition Height='Auto' />" +
"            <RowDefinition Height='*' />" +
"            <RowDefinition Height='*' />" +
"        </Grid.RowDefinitions>" +

"        <RsControls:RsWindowToolbar x:Name='WindowToolbar'>" +
"            <RsControls:RsToolbarComboBox Name='RegComboBox'" +
"                                          IsEnabled='True'" +
"                                          MinWidth='230'" +
"                                          SelectedIndex='0'>" +
"                <SWI:Interaction.Triggers>" +
"                    <MEICore:DataTrigger Binding='{Binding Path=SelectedIndex, ElementName=RegComboBox }' Value='0'>" +
"                        <MEICore:ChangePropertyAction TargetName='RegDataGrid' PropertyName='ItemsSource' Value='{Binding Path=Value[0].Value, Source={StaticResource ChartData}}'/>" +
"                        <MEICore:ChangePropertyAction TargetName='ChartLine'   PropertyName='ItemsSource' Value='{Binding Path=Value[0].Value, Source={StaticResource ChartData}}'/>" +
"                    </MEICore:DataTrigger>" +
"                    <MEICore:DataTrigger Binding='{Binding Path=SelectedIndex, ElementName=RegComboBox }' Value='1'>" +
"                        <MEICore:ChangePropertyAction TargetName='RegDataGrid' PropertyName='ItemsSource' Value='{Binding Path=Value[1].Value, Source={StaticResource ChartData}}'/>" +
"                        <MEICore:ChangePropertyAction TargetName='ChartLine'   PropertyName='ItemsSource' Value='{Binding Path=Value[1].Value, Source={StaticResource ChartData}}'/>" +
"                    </MEICore:DataTrigger>" +
"                </SWI:Interaction.Triggers>" +

"                <RsControls:RsComboBox.Items>" +
"                    <ComboBoxItem x:Name='ComboObjRegItem' Content='История остатков по объекту'/>" +
"                    <ComboBoxItem x:Name='ComboAllRegItem' Content='История сводных остатков'/>" +
"                </RsControls:RsComboBox.Items>" +
"            </RsControls:RsToolbarComboBox>" +
"        </RsControls:RsWindowToolbar>" +
"        <RsControls:RsDataGrid x:Name='RegDataGrid'" + 
"                               d:LayoutOverrides='Height'" +
"                               Grid.Row='1' " +
"                               ItemsSource='{Binding Path=Value[0].Value, Source={StaticResource ChartData}}'" +
"                               AutoGenerateColumns='False'" +
"                               IsToolsPanelVisible='True'" +
"                               IsExcelExportButtonVisible='True' " +
"                               AreRowGroupHeadersFrozen='False'>" +
"            <RsControls:RsDataGrid.Columns>" +
"                <sdk:DataGridTextColumn Header='Дата'    Binding='{Binding Value[1].Value}' x:Name='col_RegDate' />" +
"                <sdk:DataGridTextColumn Header='Приход'  Binding='{Binding Value[2].Value}' x:Name='col_RegDebt' />" +
"                <sdk:DataGridTextColumn Header='Расход'  Binding='{Binding Value[3].Value}' x:Name='col_RegCred' />" +
"                <sdk:DataGridTextColumn Header='Остаток' Binding='{Binding Value[4].Value}' x:Name='col_RegRest' />" +
"            </RsControls:RsDataGrid.Columns>" +
"        </RsControls:RsDataGrid>" +
"        <RsControls:RsChart IsPrintButtonVisible='True' IsScalingEnabled='True' Grid.Row='2'>" +
"            <RsControls:RsChart.Axes>" +
"                <DVC:LinearAxis Orientation='Y' Title='Сумма, " + RegCurCode + "' ShowGridLines='True' Minimum='0'/>" +
"                <DVC:LinearAxis Orientation='X' Interval='1' Title='Дата'>" +
"                    <DVC:LinearAxis.AxisLabelStyle>" +
"                        <Style TargetType='DVC:NumericAxisLabel'>" +
"                            <Setter Property='Template'>" +
"                                <Setter.Value>" +
"                                    <ControlTemplate TargetType='toolkit:NumericAxisLabel'>" +
"                                        <toolkit:LayoutTransformer  HorizontalAlignment='Left' VerticalAlignment='Center'>" +
"                                            <toolkit:LayoutTransformer.LayoutTransform>" +
"                                                <RotateTransform Angle='-90'/>" +
"                                            </toolkit:LayoutTransformer.LayoutTransform>" +
"                                            <TextBlock Margin = '0, 0, 0, 6' Text='{RsToolsUtils:MultiBinding Source1={Binding Value, Source={StaticResource ChartData}}," +
"                                                                                        Source2={Binding Path=SelectedIndex, ElementName=RegComboBox }," +
"                                                                                        Source3={Binding FormattedContent, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource StringToIntConverter}}," +
"                                                                                        Source4={Binding Source={StaticResource restDate_field}}," +
"                                                                                        Converter={StaticResource LnsValueListConverter}}' />" +
"                                        </toolkit:LayoutTransformer>" +
"                                    </ControlTemplate>" +
"                                </Setter.Value>" +
"                            </Setter>" +
"                        </Style>" +
"                    </DVC:LinearAxis.AxisLabelStyle>" +
"                </DVC:LinearAxis>" +
"            </RsControls:RsChart.Axes>" +
"            <DVC:AreaSeries x:Name='ChartLine' " +  
"                            ItemsSource='{Binding Value[0].Value, Source={StaticResource ChartData}}' " + 
"                            Title='{Binding Value[2].Value, Source={StaticResource ChartData}}' " +
"                            IndependentValueBinding='{Binding Value[0].Value}' " +
"                            DependentValueBinding='{Binding Value[4].Value, Converter={StaticResource MoneyToDoubleConverter}}'/>" +
"        </RsControls:RsChart>" +
"    </Grid>" +
"</RsControls:RsFloatingWindow>";
    return str;
END;

