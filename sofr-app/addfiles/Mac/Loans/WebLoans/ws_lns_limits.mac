/*
$Name: ws_lns_limits.mac
$Module: WebLoans
$Description: Сервис получения информации по лимитам
*/
IMPORT SbCrdInter, RsbDataSet;
IMPORT "total.mac", globals;

CLASS CLnsLimitsItem()
    var date: DateTime;
    var value = money(0);
END;

MACRO lns_getLimitHistory(objID, objN, payTypeID: integer)
    var result = TArray();
    var item = null;
    var rs = NULL;
    var payType = 0;
    
    if (payTypeID == NULL)
        payType = crsdcommand("select C.T_PAYTYPE from dcredit_c_dbt c where T_CRD_KIND = :p0 AND T_CREDITNUMBER = :p1", ":p0", objID, ":p1", objN,  V_INTEGER);
        
        if(payType == CF_CRLINNEW)
            payTypeID = 25; //Лимит задолженности
        elif((payType == CF_CRLIN) or (payType == CF_CRLINNO))
            payTypeID = 26; //Лимит выдачи
        else 
            return;
        end;
    end;

    rs = TRsbDataSet("SELECT T_DATE, T_REST FROM DCHLIMHIS_DBT WHERE T_CREDITNUMBER_REF = " + objN + " AND T_TYPE = " + payTypeID + ";");
    while (rs.moveNext())
        item = CLnsLimitsItem();
        item.date = rs.date;
        item.value = rs.rest;
        result[result.size] = item;
    end;

    return result;
END;