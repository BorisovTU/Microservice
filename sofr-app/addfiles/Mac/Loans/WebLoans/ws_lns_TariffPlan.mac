/*
$Name: ws_lns_TariffPlan.mac
$Module: WebLoans
$Description: Сервис подбора тарифных планов
*/
IMPORT SbCrdInter, RsbDataSet, globals, total, Календарь;

CLASS CLnsTariffPlan
    VAR ID = 0;
    VAR Name = "";
    VAR WithCond = false;
END;

CLASS CLnsTPCond
    VAR ID = 0;
    VAR Name = "";
    VAR Value = "";
    VAR SumFrom = "";
    VAR SumTo = "";
    VAR Period = "";
END;

CLASS CLnsPlanCond
    VAR Plan = CLnsTariffPlan();
    VAR Cond = CLnsTPCond();
END;

MACRO GetTariffPlan(objID:integer, objN: integer)
   var qstr, rs;
   var result = CLnsPlanCond();
   if (objID == LO_CLAIM)
       qstr = "select cl.t_tplantcrid tpflag, cl.t_condid condflag, ltp.t_trffplanid tpid, ltp.t_trffplanname tpname, ltp.t_flagtpwconditions tpcondflag, tc.* ";
       qstr = qstr + "from dtplan_tcr_dbt tp, dltrffplan_dbt ltp, dcond_tplan_dbt tc, dclaim_dbt cl ";
       qstr = qstr + "where cl.t_tplantcrid = tp.t_tplantcrid (+) and ";
       qStr = qstr + "cl.t_condid = tc.t_condid (+) and ";
       qStr = qstr + "ltp.t_trffplanid = tp. t_trffplanid and ";
       qStr = qStr + "cl.T_CLAIMID = " + objN;       
   else   
   qstr = "select cr.t_tplantcrid tpflag, cr.t_condid condflag, ltp.t_trffplanid tpid, ltp.t_trffplanname tpname, ltp.t_flagtpwconditions tpcondflag, tc.* ";
   qstr = qstr + "from dtplan_tcr_dbt tp, dltrffplan_dbt ltp, dcond_tplan_dbt tc, dcredit_c_dbt cr ";
   qstr = qstr + "where cr.t_tplantcrid = tp.t_tplantcrid (+) and ";
   qStr = qstr + "cr.t_condid = tc.t_condid (+) and ";
   qStr = qstr + "ltp.t_trffplanid = tp. t_trffplanid and ";
   qStr = qStr + "cr.t_creditnumber = " + objN;
   end;
   rs = TRsbDataSet( qstr );

   IF ( rs.moveNext )
      if (rs.tpflag > 0)
        result.Plan.ID = rs.tpid;
        result.Plan.Name = rs.tpname;
        if (rs.tpcondflag == "X")
            result.Plan.WithCond = true;
        else
            result.Plan.WithCond = false;
        end;
        if (rs.condflag > 0)
            result.Cond.ID = rs.t_condid;
            result.Cond.Name = rs.t_condname;
            result.Cond.Value = "";
            if (rs.t_flagsumfrom == "X")
                result.Cond.SumFrom = string(rs.t_sumfrom);
            else
                result.Cond.SumFrom = "не определено";
            end;
            if (rs.t_flagSumTo == "X")
                result.Cond.SumTo = string(rs.t_sumto);
            else
                result.Cond.SumTo = "не определено";
            end;
            if (rs.t_flagmcperiod == "X")
                result.Cond.Period = string(rs.t_mcperiod);
            else
                result.Cond.Period = "не определено";
            end;
        end;
      end;
   END;
   
   return result;
END;
   
MACRO GetTPList(CreditType: integer)
   VAR qstr= "", result = TArray(), obj = NULL; 
   qstr = "select tp.t_tplantcrid tpid, ltp.t_trffplanname tpname, ltp.t_flagtpwconditions tpcondflag ";
   qstr = qstr + "from dtplan_tcr_dbt tp, dltrffplan_dbt ltp ";
   qstr = qstr + "where tp.t_credittypeid = " + CreditType + " AND ";
   qStr = qstr + "ltp.t_trffplanid = tp.t_trffplanid ";
   
   VAR rs = TRsbDataSet(qstr);
   WHILE (rs.MoveNext)
      obj = CLnsTariffPlan();

      obj.ID         = rs.tpid;
      obj.Name       = rs.tpname;
      if (rs.tpcondflag == "X")
        obj.WithCond = true;
      else
        obj.WithCond = false;
      end;

      result.value(result.Size) = obj;
   END;

   return result;
END;

MACRO GetTPCount(CreditType:integer)
   VAR qstr= "", result = 0, obj = NULL; 
   qstr = "select count(*) cnt ";
   qstr = qstr + "from dtplan_tcr_dbt tp, dltrffplan_dbt ltp ";
   qstr = qstr + "where tp.t_credittypeid= " + CreditType + " AND ";
   qStr = qstr + "ltp.t_trffplanid = tp.t_trffplanid ";
   
   VAR rs = TRsbDataSet(qstr);
   if (rs.MoveNext)
      result = int(rs.cnt);
   END;

   return result;
END;

MACRO GetTPCondList(TPid:integer)
   VAR qstr= "", result = TArray(), obj = NULL; 
   qstr = "select tc.*, MC.T_NAME ";
   qstr = qstr + "from dcond_tplan_dbt tc, dmcperiod_dbt mc ";
   qstr = qstr + "where MC.T_ID(+) = TC.T_MCPERIOD AND tc.t_planid = " + TPid;
   VAR rs = TRsbDataSet(qstr);
   WHILE (rs.MoveNext)
        obj = CLnsTPCond();

        obj.ID = rs.t_condid;
        obj.Name = rs.t_condname;
        obj.Value = GetTrffRateStr(LO_CONDTARIFFPLAN, rs.t_condid, 1, {curdate});
        if (rs.t_flagsumfrom == "X")
            obj.SumFrom = string(rs.t_sumfrom);
        else
            obj.SumFrom = "не определено";
        end;
        if (rs.t_flagSumTo == "X")
            obj.SumTo = string(rs.t_sumto);
        else
            obj.SumTo = "не определено";
        end;
        if (rs.t_flagmcperiod == "X")
            obj.Period = string(rs.t_name);
        else
            obj.Period = "не определено";
        end;

        result.value(result.Size) = obj;
   END;

   return result;
END;

MACRO GetTPCondCount(TPid:integer)
   VAR qstr= "", result = 0; 
   qstr = "select count(*) cnt ";
   qstr = qstr + "from dcond_tplan_dbt tc ";
   qstr = qstr + "where tc.t_planid = " + TPid;
   
   VAR rs = TRsbDataSet(qstr);
   if (rs.MoveNext)
      result=int(rs.cnt);
   END;

   return result;
END;

MACRO GetTariffPlanByID(PlanID)
    var result = CLnsTariffPlan();
    var qstr= "select tp.t_tplantcrid tpid, ltp.t_trffplanname tpname, ltp.t_flagtpwconditions tpcondflag " +
              "from dtplan_tcr_dbt tp, dltrffplan_dbt ltp " +
              "where tp.t_tplantcrid = " + PlanID + " AND " +
              "ltp.t_trffplanid = tp.t_trffplanid ";
    
    var rs = TRsbDataSet(qstr);
    if (rs.MoveNext)
        result.ID         = rs.tpid;
        result.Name       = rs.tpname;
        if (rs.tpcondflag == "X")
            result.WithCond = true;
        else
            result.WithCond = false;
        end;
    end;
    return result;
END;

MACRO GetCondByID(CondID)
    var result = CLnsTPCond();
    var qstr= "select tc.*, MC.T_NAME " +
              "from dcond_tplan_dbt tc, dmcperiod_dbt mc " + 
              "where MC.T_ID(+) = TC.T_MCPERIOD AND tc.t_condid = " + CondID;
    var rs = TRsbDataSet(qstr);
    if (rs.MoveNext)
        result.ID = rs.t_condid;
        result.Name = rs.t_condname;
        result.Value = GetTrffRateStr(LO_CONDTARIFFPLAN, rs.t_condid, 1, {curdate});                                               
        if (rs.t_flagsumfrom == "X")
            result.SumFrom = string(rs.t_sumfrom);
        else
            result.SumFrom = "не определено";
        end;
        if (rs.t_flagSumTo == "X")
            result.SumTo = string(rs.t_sumto);
        else
            result.SumTo = "не определено";
        end;
        if (rs.t_flagmcperiod == "X")
            result.Period = string(rs.t_name);
        else
            result.Period = "не определено";
        end;
    end;
    return result;
END;


MACRO Lns_GetPlanID(CreditTypeID, CurCode, ClientID, crdkind, operdate)
    var result = 0;
    var qStr = "SELECT * FROM dtype_crd_dbt WHERE t_credittypeid = " + CreditTypeID;
    var rs = TRsbDataSet(qStr);
    if (rs.MoveNext())
        if ((rs.FlagUseTrffPlan == "X") and (rs.FlagAutoSelectTP == "X"))
            if (rs.FunctionTP != "")
                result = RunStoredFunc(rs.FunctionTP, V_INTEGER, null, CreditTypeID, CurCode, ClientID, crdkind, operdate);
            end;
        end;
    end;
    return result;
END;

MACRO Lns_GetCondID(tplantcrid, creditsum, begdate, enddate)
    var result = 0;
    var CalcFunc = "rsi_loanstariff.autogettplancondition"; // дистрибутивная функция подбора услови ТП
    var qStr = "SELECT * FROM dtplan_tcr_dbt WHERE t_tplantcrid = " + tplantcrid;
    var rs = TRsbDataSet(qStr);
    if (rs.MoveNext())
        if (rs.FlagUserDefFuncCalc == "X")
            CalcFunc = rs.UserDefFuncCalc;
        end;
        result = RunStoredFunc(CalcFunc, V_INTEGER, null, tplantcrid, creditsum, begdate, enddate);
    end;
    return result;    
END;


MACRO Lns_GetPercRate(ClientID, CreditTypeID, crdkind, creditsum, curcode, begdate, duration, typeduration)
    var tplanid = Lns_GetPlanID(CreditTypeID, curcode, ClientID, crdkind, {curdate});
    var enddate = date(0,0,0);
    if (typeduration == 0) // мес
        enddate = DateAfterCalenMonths(begdate, duration);
    else  // дней
        enddate = DateAfterCalenDays(begdate, duration);
    end;
    var condid = Lns_GetCondID(tplanid, creditsum, begdate, enddate);
    var perc = ПолучитьСтавкуТарифа(LO_CONDTARIFFPLAN, condid, TRU_CRD , {curdate});
    return Double(perc);
END;