/*
$Name: ws_lns_CreditType.mac
$Module: WebLoans
$Description: Сервис источника данных для листалки "Вид кредита"
*/
IMPORT RsbDataSet, total, likepy;

PRIVATE CLASS CLnsCreditType
  var CreditTypeId:integer     = 0,
      CreditTypeNumber:integer = 0,
      Name:string              = "",
      CurCode:integer          = 0,
      Currency:string          = "",
      PayType:integer          = 0,
      PayTypeName:string       = "",
      Duration:integer         = 0,
      DurationType:integer     = 0,
      DurationTypeName:string  = "",
      Limit:string             = "",
      WithTariffPlan:bool      = false,
      IsStateSupport:bool      = false,
      IsAutoFindRoute          = false,
      DefaultProcessID         = "",
      IsClientOwnFunds: bool   = false,
      Specific                 = "";
END;

MACRO lns_CreditTypeList(LObjectType: integer, 
                         ActionDate: date, 
                         LegalType: integer, 
                         TypeCreditId: integer, 
                         CurCode: integer, 
                         WithoutProductType: bool,
                         ProductType: integer,
                         ClientCategory: integer)
   VAR result = TArray(), obj = NULL;
   VAR rs = NULL;
   VAR query = "select distinct" +
               " typecrd.t_CreditTypeId," +
               " typecrd.t_CreditTypeNumber," +
               " typecrd.t_CreditTypeName," +
               " typecrd.t_CurCode," +
               " typecrd.t_IsStateSupport," +
               " typecrd.t_IsClntOwnFunds," + 
               " fi.t_ccy," +
               " typecrd.t_TypeOverdraft," +
               " llval.t_Name," +
               " typecrd.t_Duration," +
               " typecrd.t_TypeDuration," +
               " alg.t_szNameAlg," +
               " lim.t_MaxValue, " +
               " typecrd.t_FlagUseTrffPlan, " +
               " typecrd.T_ISAUTOFINDROUTE, " +
               " typecrd.T_ISDEFROUTE, " + 
               " route.T_PROCESSID, " + 
               " TYPECRD.T_SPECIFIC " + 
               " from dtype_crd_dbt typecrd, dlclaimroute_dbt route, dfininstr_dbt fi, dllvalues_dbt llval, dnamealg_dbt alg, dlnsobject_attr_dbt clcat, " +
               " (select p.* from dhist_lim_dbt p, (select max(t_date) mdate, t_objectnumber_ref from dhist_lim_dbt where t_date <= " + SQLDate(ActionDate) +
               " group by  t_objectnumber_ref) pp where p.t_objectnumber_ref = pp.t_objectnumber_ref and P.T_DATE = pp.mdate) lim" +
               " where" +
               " typecrd.T_ROUTEID_DEFAULT = route.T_ID(+) " + 
               " and fi.t_FIID = typecrd.t_CurCode" +
               " and llval.t_List = 1403 and llval.t_Element = typecrd.t_TypeOverdraft" +
               " and alg.t_iTypeAlg = 987 and alg.t_iNumberAlg = typecrd.t_TypeDuration" +
               " and lim.t_ObjectNumber_ref(+) = typecrd.t_CreditTypeID" +
               " and typecrd.t_CreditTypeID >= 1000" +
               " and typecrd.t_BankProduct = 'X'";
    if (LegalType > 0)               
        query = query +  " and typecrd.t_TypeDebtor in (" + string(LegalType) + ", 0)";
    end;    
    query = query + " and typecrd.t_Crd_Kind = " + string(LObjectType) +
               " and typecrd.t_State = 'О'" +
               " and (typecrd.t_BegDate = to_date ('01.01.0001', 'dd.mm.yyyy') or " + SQLDate(ActionDate) + " >= typecrd.t_BegDate" + ")" +
               " and (typecrd.t_EndDate = to_date ('01.01.0001', 'dd.mm.yyyy') or " + SQLDate(ActionDate) + " <= typecrd.t_EndDate" + ")" +
               " and clcat.t_objn(+) = typecrd.t_CreditTypeId AND clcat.t_objid(+) = 7" + 
               " and clcat.t_objecttype(+) = 3 and clcat.t_groupid(+) = 81 ";

    if (TypeCreditId > 0) query = query + " and typecrd.t_ObjectTypeID = " + string(TypeCreditId); end;
    if (CurCode > -1) query = query + " and typecrd.t_CurCode = " + string(CurCode); end;             
    if (WithoutProductType) 
        query = query + " and (typecrd.t_producttype in (0, " +  ProductType + ") " +
                              "OR typecrd.t_producttype is NULL) "; 
    else
        if (ProductType > 0)
            query = query + " and (typecrd.t_producttype = " + ProductType + ") ";
        end;
    end;

    if (ClientCategory > 0)
        query = query + " and clcat.t_attrid = " + string(ClientCategory);
    end;

    query = query + " order by typecrd.t_CreditTypeId";
  
    rs = TRsbDataSet(query);

    WHILE (rs.moveNext())
        obj = CLnsCreditType();

        obj.CreditTypeId     = rs.CreditTypeId;
        obj.CreditTypeNumber = rs.CreditTypeNumber;
        obj.Name             = rs.CreditTypeName;
        obj.CurCode          = rs.CurCode;
        obj.Currency         = rs.ccy;
        obj.PayType          = rs.TypeOverdraft;
        obj.PayTypeName      = rs.Name;
        obj.Duration         = rs.Duration;
        obj.DurationType     = rs.TypeDuration;
        obj.DurationTypeName = rs.szNameAlg;
        obj.Limit            = rs.MaxValue;
        obj.WithTariffPlan   = rs.FlagUseTrffPlan;
        obj.Specific         = rs.Specific;
        obj.IsClientOwnFunds = (rs.IsClntOwnFunds == "X");
        obj.IsAutoFindRoute  = (rs.IsAutoFindRoute == "X");
        obj.IsStateSupport   = (rs.IsStateSupport == "X");
        if (rs.IsDefRoute == "X")
            obj.DefaultProcessID = rs.PROCESSID;
        end;
        result[result.size] = obj;
    END;
  
    RETURN result;
END;

MACRO lns_GetCreditTypeByID(TypeCreditId: integer)
   VAR result = CLnsCreditType();
   VAR rs = NULL;

   VAR query = "select" +
                " typecrd.t_CreditTypeId," +
                " typecrd.t_CreditTypeNumber," +
                " typecrd.t_CreditTypeName," +
                " typecrd.t_CurCode," +
                " typecrd.t_IsStateSupport," +
                " typecrd.t_IsClntOwnFunds," + 
                " fi.t_ccy," +
                " typecrd.t_TypeOverdraft," +
                " llval.t_Name," +
                " typecrd.t_Duration," +
                " typecrd.t_TypeDuration," +
                " alg.t_szNameAlg," +
                " lim.t_MaxValue," +
                " typecrd.t_FlagUseTrffPlan, " +
                " typecrd.T_ISAUTOFINDROUTE, " +
                " typecrd.T_ISDEFROUTE, " + 
                " route.T_PROCESSID, " +   
                " TYPECRD.T_SPECIFIC " +                 
                " from dtype_crd_dbt typecrd, dlclaimroute_dbt route, dfininstr_dbt fi, dllvalues_dbt llval, dnamealg_dbt alg," +
                " (select p.* from dhist_lim_dbt p, (select max(t_date) mdate, t_objectnumber_ref from dhist_lim_dbt where t_date <= " + SQLDate({curdate}) +
                " group by  t_objectnumber_ref) pp where p.t_objectnumber_ref = pp.t_objectnumber_ref and P.T_DATE = pp.mdate) lim" +
                " where" +
                " typecrd.T_ROUTEID_DEFAULT = route.T_ID(+) " + 
                " and fi.t_FIID = typecrd.t_CurCode" +
                " and llval.t_List = 1403 and llval.t_Element = typecrd.t_TypeOverdraft" +
                " and alg.t_iTypeAlg = 987 and alg.t_iNumberAlg = typecrd.t_TypeDuration" +
                " and lim.t_ObjectNumber_ref(+) = typecrd.t_CreditTypeID" +
                " and typecrd.t_CreditTypeID = " + TypeCreditId;

    rs = TRsbDataSet(query);
    if (rs.moveNext())
        result.CreditTypeId     = rs.CreditTypeId;
        result.CreditTypeNumber = rs.CreditTypeNumber;
        result.Name             = rs.CreditTypeName;
        result.CurCode          = rs.CurCode;
        result.Currency         = rs.ccy;
        result.PayType          = rs.TypeOverdraft;
        result.PayTypeName      = rs.Name;
        result.Duration         = rs.Duration;
        result.DurationType     = rs.TypeDuration;
        result.DurationTypeName = rs.szNameAlg;
        result.Limit            = rs.MaxValue;
        result.WithTariffPlan   = rs.FlagUseTrffPlan;
        result.Specific         = rs.Specific;
        result.IsClientOwnFunds = (rs.IsClntOwnFunds == "X");
        result.IsAutoFindRoute  = (rs.IsAutoFindRoute == "X");
        result.IsStateSupport   = (rs.IsStateSupport == "X");
        if (rs.IsDefRoute == "X")
            result.DefaultProcessID = rs.PROCESSID;
        end;        
    end;
  
    RETURN result;
END;


MACRO lns_CreditTypeByIDList(TypeCreditIdList)
   VAR result = TArray();
   VAR rs = NULL;
   VAR item = null;
   if ((TypeCreditIdList != null) and (TypeCreditIdList.Size > 0))
        VAR query = "select" +
                    " typecrd.t_CreditTypeId," +
                    " typecrd.t_CreditTypeNumber," +
                    " typecrd.t_CreditTypeName," +
                    " typecrd.t_CurCode," +
                    " typecrd.t_IsStateSupport," +
                    " typecrd.t_IsClntOwnFunds," +
                    " fi.t_ccy," +
                    " typecrd.t_TypeOverdraft," +
                    " llval.t_Name," +
                    " typecrd.t_Duration," +
                    " typecrd.t_TypeDuration," +
                    " alg.t_szNameAlg," +
                    " lim.t_MaxValue," +
                    " typecrd.t_FlagUseTrffPlan, " +
                    " typecrd.T_ISAUTOFINDROUTE, " +
                    " typecrd.T_ISDEFROUTE, " + 
                    " route.T_PROCESSID, " +   
                    " TYPECRD.T_SPECIFIC " +                     
                    " from dtype_crd_dbt typecrd, dlclaimroute_dbt route, dfininstr_dbt fi, dllvalues_dbt llval, dnamealg_dbt alg," +
                    " (select p.* from dhist_lim_dbt p, (select max(t_date) mdate, t_objectnumber_ref from dhist_lim_dbt where t_date <= " + SQLDate({curdate}) +
                    " group by  t_objectnumber_ref) pp where p.t_objectnumber_ref = pp.t_objectnumber_ref and P.T_DATE = pp.mdate) lim" +
                    " where" +
                    " typecrd.T_ROUTEID_DEFAULT = route.T_ID(+) " + 
                    " and fi.t_FIID = typecrd.t_CurCode" +
                    " and llval.t_List = 1403 and llval.t_Element = typecrd.t_TypeOverdraft" +
                    " and alg.t_iTypeAlg = 987 and alg.t_iNumberAlg = typecrd.t_TypeDuration" +
                    " and lim.t_ObjectNumber_ref(+) = typecrd.t_CreditTypeID" +
                    " and typecrd.t_CreditTypeID in ( " + join(TypeCreditIdList, ",") + ")";

        rs = TRsbDataSet(query);
        while (rs.moveNext())
            item = CLnsCreditType();
            item.CreditTypeId     = rs.CreditTypeId;
            item.CreditTypeNumber = rs.CreditTypeNumber;
            item.Name             = rs.CreditTypeName;
            item.CurCode          = rs.CurCode;
            item.Currency         = rs.ccy;
            item.PayType          = rs.TypeOverdraft;
            item.PayTypeName      = rs.Name;
            item.Duration         = rs.Duration;
            item.DurationType     = rs.TypeDuration;
            item.DurationTypeName = rs.szNameAlg;
            item.Limit            = rs.MaxValue;
            item.WithTariffPlan   = rs.FlagUseTrffPlan;
            item.Specific         = rs.Specific;
            item.IsClientOwnFunds = (rs.IsClntOwnFunds == "X");
            item.IsAutoFindRoute  = (rs.IsAutoFindRoute == "X");
            item.IsStateSupport   = (rs.IsStateSupport == "X");
            if (rs.IsDefRoute == "X")
                item.DefaultProcessID = rs.PROCESSID;
            end;        

            result[result.size] = item;
        end;
    end;
    RETURN result;
END;
