/*
$Name: ws_lns_CreditWindow.mac
$Module: WebLoans
$Description: Сервис получения информации по КД
*/
IMPORT SbCrdInter, RsbDataSet, globals, total, ws_lns_PurposeForCB;

CLASS CLnsCreditItem()
    var CrIsDraft = false;       //черновик?
    var CrNumber = 0;            //номер кредита
    var CrUsNumber = "";         //пользовательский номер кредита
    var CrCreditType = "";       //вид кредита
    var CrPayType = "";          //тип выдачи
    var CrGS = "";               //генеральное соглашение
    var CrTarifPlFlag = "";      //флаг использования тарифного плана
    var CrTarifPl = "";          //тарифный план
    var CrУсловиеТарифа = "";    //условие тарифа
    var CrUsCreditType = "";     //пользовательский вид кредита
    var CrIndTarif = false;      //флаг индивидуальной тарификации
    var CrFilial = "";           //филиал договора
    var CrDyration = 0;          //срок договора в мес
    var CrCpecific = "";         //целевое назначение
    var CrReqType = "";          //тип запрашиваемого кредита
    var MORTAGEREGDATE = "";     //дата регистрации ипотеки
    var CrSumm = 0;              //сумма КД
    var CrCur = 0;               //валюта КД
    var CrTotalLimit = 0;        //доступный лимит
    var CrEnsLimit = 0;          //лимит, ограниченный обеспечением
    var CrExpLimit = 0;          //лимит выдачи
    var CrIndLimit = 0;          //лимит задолженности
    var CrUseEnsLimit = false;   //признак использования ограничения лимита обеспечением
    var CrRest = 0;              //остаток основного долга
    var CrPSK = 0;               //ПСК
    var CrRes = false;           //факт реструктуризации
    var CrPrivil = false;        //льготный кредит
    var CrAnnuit = false;        //аннуитетынй ГП
    var CrFlagOB = false;        //учёт % на внебалансе
    var CrInd = false;           //индивидуальная классификация
    var CrKKS = "";              //ККС
    var CrCaseType = TArray();   //тип портфеля
    var CrCase = TArray();     //имя портфеля
    var CrNote = "";             //примечание КД
    var CrAcceptance = false;       //признак формирования требования по оплате с акцептом
    var CrAcceptanceDay = "";    //срок акцепта в днях
    var CrRetailAcc = "";        //счёт для погашения
    var PartyName = "";          //наименование\имя заёмщика
    var PartyLegalForm = "";     //юр. статус заёмщика
    var PartyIP = false;         //индивидуальный предприниматель
    var AsIP = false;            //признак того, что договор открыт на ИП
    var PartyBankOfficer = false;//соотрудник банка
    var PurposeForCB = "";       // Цели кредитования для ЦБ
    var ClaimID = 0;
    var ClaimNumStr = "";
    var ClaimVisibility = "Collapsed";    
END;

MACRO getClaimID(CrdNum)
    var result:integer = 0;
    var qStr = "", rs = NULL;
    
    qStr = "SELECT MAX(LINK_CLAIM.CLAIMID_1) AS CLAIMID" + 
           " FROM (SELECT CL.T_CLAIMID AS CLAIMID_1" +
                  " FROM DCLAIM_DBT CL" + 
                  " WHERE CL.T_CREDITNUMBER_REF = " + CrdNum +
                  " UNION ALL" +  
                  " SELECT -10 AS CLAIMID_1" + 
                  " FROM DUAL" + 
                  " ) LINK_CLAIM";
    rs = TRsbDataSet(qStr);
    if  (rs.moveNext())
        result = rs.ClaimID;
    end;

    return result;
END;

MACRO getClaimNumberStr(ClaimID)
    var result = "";
    var qStr = "", rs = NULL;
    
    qStr = "SELECT CL.T_CLAIMNUMBER AS CLAIMNUMSTR" + 
            " FROM DCLAIM_DBT CL" +
            " WHERE CL.T_CLAIMID = " + ClaimID;
    rs = TRsbDataSet(qStr);
    if  (rs.moveNext())
        result = rs.ClaimNumStr;
    end;

    return result;
END;

MACRO getClaimVisibility(CreditNumber)
    var result:string = "Collapsed";
    var qStr = "", rs = NULL;
    
    qStr = "SELECT COUNT(*) AS CNT" + 
           " FROM DCLAIM_DBT CL" + 
           " WHERE CL.T_CREDITNUMBER_REF = " + CreditNumber;
    rs = TRsbDataSet(qStr);
    if  (rs.moveNext())
        if (rs.Cnt > 0)
            result = "Visible";
        end;
    end;

    return result;
END;


MACRO lns_GetCreditData(ObjID, ObjN)
    var result = CLnsCreditItem();
    var Credit = null;
    var Party = null;
    var Case = null;
/*данные по КД*/    
    Credit = crsdcommand("select crd.*, to_char(crd.t_MORTAGEREGDATE, 'dd.mm.yyyy') MORTAGEREGDATE, to_char(crd.T_REGDATE, 'dd.mm.yyyy') REGDATE, to_char(crd.T_RETURNDATE, 'dd.mm.yyyy') RETURNDATE, tcrd.*, cl.t_islimitation CRUSEENSLIMIT from dcredit_c_dbt crd, dtype_crd_dbt tcrd, dparmdemandline_dbt cl WHERE tcrd.T_CREDITTYPEID = (select T_CREDITTYPEID_REF from dcredit_c_dbt where t_creditnumber = crd.t_creditnumber) AND crd.t_creditnumber = :p0 AND cl.t_objecttypeid = :p1 AND cl.t_objectnumber = :p0 ", ":p0", ObjN, ":p1", ObjID, V_GENOBJ);

    if (Credit.MoveNext())
       result.CrNumber = Credit.value("t_creditnumber");
       result.CrUsNumber = Credit.value("t_uscreditnumber");
       result.CrCreditType = Credit.value("T_CREDITTYPENAME");

       if (Credit.value("T_TYPEOVERDRAFT") == 1)
          result.CrPayType = "Разовый";
       elif (Credit.value("T_TYPEOVERDRAFT") == 2)
          result.CrPayType = "Частями";
       elif (Credit.value("T_TYPEOVERDRAFT") == 3)
          result.CrPayType = "Лимит выдачи+задолженности";
       elif (Credit.value("T_TYPEOVERDRAFT") == 4)
          result.CrPayType = "Невозобновляемая КЛ";
       elif (Credit.value("T_TYPEOVERDRAFT") == 5)
          result.CrPayType = "Под лимит задолженности";
       elif (Credit.value("T_TYPEOVERDRAFT") == 6)
          result.CrPayType = "До востребования";
       elif (Credit.value("T_TYPEOVERDRAFT") == 7)
          result.CrPayType = "До наступления условия";
       end;

       result.CrUsCreditType = Credit.value("T_USERTYPE");
       result.CrFilial = string(Credit.value("T_FNCASH")) + "/" + string(Credit.value("T_BRANCH"));

       if (Credit.value("T_BRANCH")!= 0)
          result.CrFilial = result.CrFilial + "/" + Credit.value("T_BRANCH");
       end;

       if (Credit.value("T_TYPEDURATION") == 0)
          result.CrDyration = string(Credit.value("T_DURATION")) + " мес. c " + string(Credit.value("REGDATE")) + " по " + string(Credit.value("RETURNDATE"));
       elif((Credit.value("T_TYPEDURATION") == 1))
          result.CrDyration = string(Credit.value("T_DURATION")) + " д. c " + string(Credit.value("REGDATE")) + " по " + string(Credit.value("RETURNDATE"));
       end;

       result.CrCpecific = Credit.value("T_SPECIFIC");
       result.CrSumm = Money(Credit.value("T_CREDITSUM"));
       result.CrCur = crsdcommand("select T_CCY from dfininstr_dbt where T_FIID = :p0", ":p0", Credit.value("T_CURCODE"), V_STRING);

       if (Credit.value("T_PRIVILEGEFLAG") == "X")
          result.CrPrivil = true;
       end;

       result.MORTAGEREGDATE = string(Credit.value("MORTAGEREGDATE"));

       if (Credit.value("T_ANNUIT") == "X")
          result.CrAnnuit = true;
       end;

       if (Credit.value("T_FLAGOB") == 1)
           result.CrFlagOB = true;
       end;

       if (Credit.value("T_CREDITSTATE") == "Ч")
           result.CrIsDraft = true;
       end;

       if (Credit.value("T_INDIV_TRFF") == "X")
          result.CrIndTarif = true;
       end;

       if (Credit.value("T_INDCLASSIFICATION") == "X")
          result.CrInd = true;
       end;

       result.CrTarifPlFlag = Credit.value("T_FLAGUSETRFFPLAN");
       result.CrTarifPl = crsdcommand("select NVL(T_TRFFPLANNAME, 0) from dltrffplan_dbt tp, DTPLAN_TCR_DBT tcr where tp.T_TRFFPLANID = tcr.T_TRFFPLANID AND tcr.T_TPLANTCRID = :p0", ":p0", Credit.value("T_TPLANTCRID"), V_STRING);
       result.CrУсловиеТарифа = crsdcommand("select NVL(T_CONDNAME, 0) from dcond_tplan_dbt where T_CONDID = :p0", ":p0", Credit.value("T_CONDID"), V_STRING);
       result.CrReqType = crsdcommand("select NVL(T_NAME, 0) from dlreqcrdtype_dbt where T_REQCRDTYPEID = :p0", ":p0", Credit.value("T_REQCRDTYPEID"), V_STRING);
       result.CrAnnuit = string(Credit.value("T_USERFIELD1")) + " " + string(Credit.value("T_USERFIELD2"));

       if (Credit.value("T_Acceptance") == "X")
          result.CrAcceptance = true;
       end;

       result.CrAcceptanceDay = Credit.value("T_AcceptanceDay");
       result.CrRetailAcc = crsdcommand("select NVL(T_ACCOUNT, 0) from digsetacc_dbt where T_SETTACCID = :p0", ":p0", Credit.value("T_RETAILACCPAY_REF"), V_STRING);
       
       result.CrNote = StrSubst((Credit.value("T_USERFIELD1") + " " + Credit.value("T_USERFIELD2")), strfor(1), "");
       
    end;

    result.PurposeForCB = GetPurposeStrByObjID(ObjID, ObjN);
    result.ClaimID        = getClaimID(Int(ObjN));
    result.ClaimNumStr    = getClaimNumberStr(result.ClaimID);
    result.ClaimVisibility = getClaimVisibility(Int(ObjN));        

    result.CrTotalLimit = crsdcommand("select loanskernel.getregrest_date(LOANSKERNEL.getusregid_forobject(:p0, :p1, :p2), :p3) from dual", ":p0", ObjID,":p1", ObjN,":p2", TDR_AVAILABLELIMIT,":p3", {curdate}, V_MONEY);
    result.CrEnsLimit = crsdcommand("select round(loanskernel.calcnlo(:p0, :p1), 2) from dual", ":p0", ObjN, ":p1", {curdate}, V_MONEY); 
    if (Credit.Value("CrUseEnsLimit") == "X") 
        result.CrUseEnsLimit = true;
    end;
    result.CrExpLimit = crsdcommand("select loanskernel.getregrest_date(LOANSKERNEL.getusregid_forobject(:p0, :p1, :p2), :p3) from dual", ":p0", ObjID,":p1", ObjN,":p2", TDR_LIMPAY ,":p3", {curdate}, V_MONEY);
    result.CrIndLimit = crsdcommand("select loanskernel.getregrest_date(LOANSKERNEL.getusregid_forobject(:p0, :p1, :p2), :p3) from dual", ":p0", ObjID,":p1", ObjN,":p2", TDR_LIMDUTY,":p3", {curdate}, V_MONEY);
    result.CrRest = crsdcommand("select LOANSKERNEL.GetRegRestWithSO(:p0, :p1, :p2, :p3) + " +
                                     "LOANSKERNEL.GetRegRestWithSO(:p4, :p5, :p6, :p7) + " +
                                     "LOANSKERNEL.GetRegRestWithSO(:p8, :p9, :p10, :p11) " +
		              	  "from dual", 
				  ":p0", TDR_MAINREST, ":p1", ObjID, ":p2",  ObjN, ":p3",  {curdate}, 
                              ":p4", TDR_EXPREST,  ":p5", ObjID, ":p6",  ObjN, ":p7",  {curdate}, 
                              ":p8", TDR_LIM,      ":p9", ObjID, ":p10", ObjN, ":p11", {curdate}, V_MONEY);

    result.CrPSK = crsdcommand("select * from (SELECT T_CALCRATE FROM dlhistry_xirr_dbt WHERE T_OBJECTID = :p0 AND T_OBJECTNUMBER = :p1 and T_CALCDATE <= :p2 ORDER BY T_CALCDATE DESC) where rownum = 1", ":p0", ObjID, ":p1", ObjN, ":p2", {curdate}, V_DOUBLE); 
    result.CrKKS = crsdcommand("select to_char(T_NUMBERRISKGROUP)||' ('||to_char(T_NAMERISKGROUP)||')' from driskgr_dbt where T_NUMBERRISKGROUP = (select * from (SELECT T_IRISKGROUP FROM dcrdrghb_dbt WHERE T_OBJECTTYPEID = :p0 AND T_OBJECTNUMBER = :p1 and T_DATE <= :p2 ORDER BY T_DATE DESC) where rownum = 1)", ":p0", ObjID, ":p1", ObjN, ":p2", {curdate}, V_STRING); 
    Case = crsdcommand("select T_BRIEFCASENAME, t_USERNUMBER, t_type from dlbrfcase_dbt where T_BRIEFCASEID IN (select T_PARENTID from dcrdlink_dbt where T_OBJECTTYPEID = :p0 and T_OBJECTNUMBER = :p1 and T_TYPEPARENT = :p2) order by T_TYPE desc", ":p0", ObjID, ":p1", ObjN, ":p2", lo_case, V_GENOBJ);
    
    var i = 0;
    while (case.movenext())
       result.CrCase[i] = Trim(String(Case.value("T_BRIEFCASENAME")));
       if (result.CrCase[i] == StrFor(1))
       result.CrCase[i] = Trim(String(Case.value("t_USERNUMBER")));
       end;
       result.CrCaseType[i] = Case.value("t_type");
       i = i + 1;
    end;

    result.CrRes = crsdcommand("select count(1) from dcrd_op_dbt where T_OBJECTTYPEID_REF = :p0 and T_OBJECTID_REF = :p1 and T_SYSTEMOPERATIONID = 92 and T_STAGEID_REF = 99 and T_ISDELETED = 0", ":p0", ObjID, ":p1", ObjN, V_BOOL);
    result.CrGS = crsdcommand("select t_uscreditnumber from dcredit_c_dbt where t_creditnumber = (select T_GENERALAGREEMENT_REF from dcredit_c_dbt where t_creditnumber = :p0)", ":p0", ObjN, V_STRING);

/*данные по субъекту*/    
    Party = crsdcommand("select pr.T_NAME, pr.T_LEGALFORM, per.T_ISEMPLOYER from dparty_dbt pr, dpersn_dbt per where per.T_PERSONID(+) = pr.T_PARTYID and pr.T_PARTYID = (select T_CLIENTID_REF from dcredit_c_dbt where t_creditnumber = :p0)", ":p0", ObjN, V_GENOBJ);

    if (Party.MoveNext())
       result.PartyName = Party.value("T_NAME");

       if (Party.value("T_LEGALFORM") == 1)
          result.PartyLegalForm = "Юридическое лицо";
       elif (Party.value("T_LEGALFORM") == 2)
          result.PartyLegalForm = "Физическое лицо";
       end;

       if (Party.value("T_ISEMPLOYER") == "X")
	   result.PartyIP = true;
       end;

    end;
    
    if (
            (Credit.value("T_LegalForm") == 2) and 
            (Credit.value("T_TypeDebtor") == 1)
       )
        result.AsIP = true;
    end;

    result.PartyBankOfficer = crsdcommand("SELECT count(1) FROM dofficer_dbt WHERE t_partyid = :p0 AND t_personid = (select T_CLIENTID_REF from dcredit_c_dbt where t_creditnumber = :p1)", ":p0", {ourbank}, ":p1", ObjN, V_BOOL);

    return result;
END;


PRIVATE MACRO MakeWindowTitle(ObjN)
  var
      retVal = "";

    if (ObjN != NULL)
        retVal = "Параметры КД № " + crsdcommand("select t_uscreditnumber from dcredit_c_dbt where t_creditnumber = :p0", ";p0", ObjN, V_STRING);
    end;

    RETURN retVal;
END;

MACRO lns_CreditWindow(MacroParms)
    var ObjID = MacroParms[0].Value.ObjID,
        ObjN = MacroParms[0].Value.ObjN;
    
    if (MacroParms[0].Value.ObjID == LO_CLAIM)
        ObjN = LnSelectValue ("SELECT T.T_CREDITNUMBER_REF FROM DCLAIM_DBT T WHERE T.T_CLAIMID = " + ObjN, V_INTEGER);
        ObjID = LO_CREDIT;
    end;
    
    var char1 = strfor(1);
    var
        Title = MakeWindowTitle(ObjN),
        Data = lns_GetCreditData(ObjID, ObjN),
        str = 

"<RsControls:RsFloatingWindow " +                                                                    
"    xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
"    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
"    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
"    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
"    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk' " +
"    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " +
"    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
"    xmlns:RsControls='clr-namespace:RsControls;assembly=RsControls' " +  
"    xmlns:MEICore='clr-namespace:Microsoft.Expression.Interactivity.Core;assembly=Microsoft.Expression.Interactions' " +
"    xmlns:SWI='clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity' " +   
"    mc:Ignorable='d'" +
"    x:Name='rootElement'" +
"    Title='" + Title + "'" +
">" +
"    <Grid Margin='5,0,0,0'  Background='#FFFDFDFD'> " +   
"        <ScrollViewer  ScrollViewer.VerticalScrollBarVisibility='Auto' ScrollViewer.HorizontalScrollBarVisibility='Auto'> " +
"                <Grid> " +
"                    <Grid.RowDefinitions> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='5'/> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='5'/> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='5'/> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='*'/> " +
"                    </Grid.RowDefinitions> " +
"                    <toolkit:Expander x:Name='Expander1' IsExpanded='True'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Заемщик по договору' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " +
"                            <TextBlock Text='Наименование:' Grid.Row='0' /> " +
"                            <TextBlock Text='" + data.PartyName + "' Grid.Column='2' /> " ;
if (data.PartyIP)
   str = str +
"                            <TextBlock Text='Статус заемщика:' Grid.Row='2' /> ";
    if (data.AsIP)
       str = str +
    "                            <TextBlock Text='Индивидуальный предприниматель' Grid.Row='2' Grid.Column='2' /> " ;
    else
       str = str +
    "                            <TextBlock Text='Физическое лицо' Grid.Row='2' Grid.Column='2' /> " ;
    end;
else;
   str = str +
"                            <TextBlock Text='Тип заемщика:' Grid.Row='2' /> " +
"                            <TextBlock Text='" + data.PartyLegalForm + "' Grid.Row='2' Grid.Column='2'  /> " ;
end;

if (data.PartyLegalForm != "Юридическое лицо")
   str = str +
"                            <CheckBox Content='Признак сотрудника' IsChecked='" + string(data.PartyBankOfficer) + "'  Grid.Row='4' Grid.ColumnSpan='3' IsEnabled='False' Margin='0,5,0,0'/> " ;
end;
   str = str +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                    <toolkit:Expander x:Name='Expander2' IsExpanded='True' Grid.Row='2' d:IsLocked='True'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Банковский продукт' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " +
"                            <TextBlock Text='Вид кредита по договору:'  Grid.Row='0'/> " +
"                            <TextBlock Text='" + string(data.CrCreditType) + "' Grid.Row='0' Grid.Column='2' /> " +
"                            <TextBlock Text='Тип выдачи по договору:'  Grid.Row='2'/> " +
"                            <TextBlock Text='" + string(data.CrPayType) + "'  Grid.Row='2' Grid.Column='2' /> " ;
if (data.CrTarifPlFlag == "X")
   str = str +
"                            <TextBlock Text='Тарифный план продукта:'  Grid.Row='4' /> " +
"                            <TextBlock Text='" + string(data.CrTarifPl) + "' Grid.Row='4' Grid.Column='2' /> " +
"                            <TextBlock Text='Условие тарифного плана:'   Grid.Row='6' /> " +
"                            <TextBlock Text='" + string(data.CrУсловиеТарифа) + "' Grid.Row='6' Grid.Column='2' /> " ;
end;
if ((strlen(string(data.CrUsCreditType)) > 0) and (string(data.CrUsCreditType) != char1))
   str = str +
"                            <TextBlock Text='Пользовательский вид:'  Grid.Row='8' /> " +
"                            <TextBlock Text='" + string(data.CrUsCreditType) + "'  Grid.Row='8' Grid.Column='2' /> " ;
end;
   str = str +
"                            <CheckBox Content='Индивидуальная тарификация' IsChecked='" + string(data.CrIndTarif) + "'  IsEnabled='False' Grid.Row='10' Grid.ColumnSpan='3' /> " +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                    <toolkit:Expander x:Name='Expander3'  IsExpanded='True' Grid.Row='4'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Основные параметры договора' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " +
"                            <TextBlock Text='Филиал/подразделение ТС:'  Grid.Row='0'/> " +
"                            <TextBlock Text='" + string(data.CrFilial) + "' Grid.Row='0' Grid.Column='2' /> " + 
"                            <TextBlock Text='Номер заявки на кредит:'  Grid.Row='2' Visibility='" + string(data.ClaimVisibility)+ "'/>" + 
"                            <StackPanel  Orientation='Horizontal' Grid.Row='2' Grid.Column='2' Visibility='" + string(data.ClaimVisibility)+ "'>" +             
"                                <TextBlock Text='" + string(data.ClaimNumStr) + "'  Grid.Row='2' Margin='0,0,12,0'/>" + 
"                                <HyperlinkButton Grid.Column='1' Content='Просмотр заявки' Name='HyperlinkButtonClaimPrm' HorizontalAlignment='Right' />" +   
"                            </StackPanel>";
if (strlen(string(data.CrGS)) > 0)
   str = str +
"                            <TextBlock Text='Номер ген. соглашения:' Grid.Row='4'/> " +
"                            <TextBlock Text='" + string(data.CrGS) + "' Grid.Row='4' Grid.Column='2'/> " ;
end;
   str = str +
"                            <TextBlock Text='Номер договора:' Grid.Row='6'/> " +
"                            <TextBlock Text='" + string(data.CrUsNumber) + "' Grid.Row='6' Grid.Column='2'/> " +
"                            <TextBlock Text='Срок договора:'   Grid.Row='8'/> " +
"                            <TextBlock Text='" + string(data.CrDyration) + "' Grid.Row='8' Grid.Column='3' /> " ;
if ((strlen(string(data.CrCpecific)) > 0) and (string(data.CrCpecific) != char1))
   str = str +
"                            <TextBlock Text='Целевое назначение:'  Grid.Row='10' /> " +
"                            <TextBlock Text='" + string(data.CrCpecific) + "'  Grid.Row='10' Grid.Column='2' /> " ;
end;
if ((data.CrReqType != "0") and (strlen(string(data.CrReqType)) > 0))
   str = str +
"                            <TextBlock Text='Тип кредита:'  Grid.Row='12' /> " +
"                            <TextBlock Text='" + string(data.CrReqType) + "'  Grid.Row='12' Grid.Column='2' /> " ;
end;
if (strlen(string(data.PurposeForCB)) > 0)
   str = str +
"                            <TextBlock Text='Цели кредита для ЦБ:'  Grid.Row='14' /> " +
"                            <TextBlock Text='" + string(data.PurposeForCB) + "'  Grid.Row='14' Grid.Column='2' /> " ;
end;
if (data.MORTAGEREGDATE != "01.01.0001")
   str = str +
"                            <TextBlock Text='Дата регистрации ипотеки:'  Grid.Column='0'  Grid.Row='16'/> " +
"                            <TextBlock Text='" + string(data.MORTAGEREGDATE) + "'  Grid.Row='16' Grid.Column='2' /> " ;
end;

if (data.CrPayType != "Под лимит задолженности")
   str = str +
"                            <TextBlock Text='Сумма кредита:'  Grid.Row='18' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='18' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.CrSumm) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.CrCur) + "' /> " +
"                            </StackPanel> " ;
end;

if ((data.CrPayType == "Лимит выдачи+задолженности") or 
    (data.CrPayType == "Невозобновляемая КЛ") or
    (data.CrPayType == "Под лимит задолженности"))
   str = str +
"                            <TextBlock Text='Доступный лимит:' Margin='0,0,6,0' Grid.Row='20'/> " +
"                            <StackPanel  Orientation='Horizontal' Grid.Row='20' Grid.Column='2'  > " +
"                                <TextBlock Text='" + string(data.CrTotalLimit) + "'   Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.CrCur) + "' Margin='0,0,12,0'/> " +
"                                <HyperlinkButton Grid.Column='1' Content='Свернуть' Name='HyperlinkButtonCollapsed'  HorizontalAlignment='Right'> " +
"                                   <SWI:Interaction.Triggers> " +
"                                       <SWI:EventTrigger EventName='Click' SourceName='HyperlinkButtonCollapsed'> " +
"                                            <MEICore:ChangePropertyAction TargetName='CollapsedGrid' PropertyName='Visibility'> " +
"                                               <MEICore:ChangePropertyAction.Value>" +
"                                                   <Visibility>Collapsed</Visibility>" +
"                                               </MEICore:ChangePropertyAction.Value>" +
"                                            </MEICore:ChangePropertyAction> " +
"                                            <MEICore:ChangePropertyAction TargetName='HyperlinkButtonDetails' PropertyName='Visibility'> " +
"                                               <MEICore:ChangePropertyAction.Value>" +
"                                                   <Visibility>Visible</Visibility>" +
"                                               </MEICore:ChangePropertyAction.Value>" +
"                                            </MEICore:ChangePropertyAction> " +
"                                            <MEICore:ChangePropertyAction TargetName='HyperlinkButtonCollapsed' PropertyName='Visibility'> " +
"                                               <MEICore:ChangePropertyAction.Value>" +
"                                                   <Visibility>Collapsed</Visibility>" +
"                                               </MEICore:ChangePropertyAction.Value>" +
"                                            </MEICore:ChangePropertyAction> " +
"                                        </SWI:EventTrigger> " +
"                                    </SWI:Interaction.Triggers> " +  
"                                </HyperlinkButton>" +
"                                <HyperlinkButton Grid.Column='1' Content='Подробнее' Name='HyperlinkButtonDetails'  HorizontalAlignment='Right' Visibility='Collapsed'> " +
"                                   <SWI:Interaction.Triggers> " +
"                                       <SWI:EventTrigger EventName='Click' SourceName='HyperlinkButtonDetails'> " +
"                                            <MEICore:ChangePropertyAction TargetName='CollapsedGrid' PropertyName='Visibility'> " +
"                                               <MEICore:ChangePropertyAction.Value>" +
"                                                   <Visibility>Visible</Visibility>" +
"                                               </MEICore:ChangePropertyAction.Value>" +
"                                            </MEICore:ChangePropertyAction> " +
"                                            <MEICore:ChangePropertyAction TargetName='HyperlinkButtonCollapsed' PropertyName='Visibility'> " +
"                                               <MEICore:ChangePropertyAction.Value>" +
"                                                   <Visibility>Visible</Visibility>" +
"                                               </MEICore:ChangePropertyAction.Value>" +
"                                            </MEICore:ChangePropertyAction> " +
"                                            <MEICore:ChangePropertyAction TargetName='HyperlinkButtonDetails' PropertyName='Visibility'> " +
"                                               <MEICore:ChangePropertyAction.Value>" +
"                                                   <Visibility>Collapsed</Visibility>" +
"                                               </MEICore:ChangePropertyAction.Value>" +
"                                            </MEICore:ChangePropertyAction> " +
"                                        </SWI:EventTrigger> " +
"                                    </SWI:Interaction.Triggers> " +  
"                                </HyperlinkButton>" +
"                            </StackPanel> " +
"                            <Grid x:Name='CollapsedGrid' Grid.Row='22' Grid.ColumnSpan='3' Margin='0,0,0,5' > " +
"                                <Border Grid.ColumnSpan='2' BorderThickness='1' BorderBrush='#FFD4D4D4' Padding='10,5'> " +
"                                    <Grid> " +
"                                        <Grid.ColumnDefinitions> " +
"                                            <ColumnDefinition Width='Auto'/> " +
"                                            <ColumnDefinition Width='6'/> " +
"                                            <ColumnDefinition Width='*'/> " +
"                                        </Grid.ColumnDefinitions> ";
    if (data.CrUseEnsLimit)
    str = str + 
    "                                        <Grid.RowDefinitions> " +
    "                                            <RowDefinition Height='Auto'/> " +
    "                                            <RowDefinition Height='5'/> " +
    "                                            <RowDefinition Height='Auto'/> " +
    "                                            <RowDefinition Height='5'/> " +
    "                                            <RowDefinition Height='Auto'/> " +
    "                                            <RowDefinition Height='*'/> " +
    "                                        </Grid.RowDefinitions> " +
    "                                        <TextBlock Text='Ограничение лимита обеспечением:'/> " +
    "                                        <StackPanel  Orientation='Horizontal' Grid.Column='2'> " +
    "                                            <TextBlock Text='" + string(data.CrEnsLimit) + "' Margin='0,0,6,0'/> " +
    "                                            <TextBlock Text='" + string(data.CrCur) + "'/> " +
    "                                        </StackPanel> "
    else
    str = str+ 
    "                                        <Grid.RowDefinitions> " +
    "                                            <RowDefinition Height='Auto'/> " +
    "                                            <RowDefinition Height='5'/> " +
    "                                            <RowDefinition Height='Auto'/> " +
    "                                            <RowDefinition Height='*'/> " +
    "                                        </Grid.RowDefinitions> ";
    end;
str = str+
"                                        <TextBlock Text='Неиспользованный лимит выдачи:'  Grid.Row='2'/> " +
"                                        <StackPanel  Orientation='Horizontal'  Grid.Row='2' Grid.Column='2'  > " +
"                                            <TextBlock Text='" + string(data.CrExpLimit) + "'   Margin='0,0,6,0'/> " +
"                                            <TextBlock Text='" + string(data.CrCur) + "'/> " +
"                                        </StackPanel> " +
"                                        <TextBlock Text='Неиспользованный лимит задолженности:'  Grid.Row='4'/> " +
"                                        <StackPanel  Orientation='Horizontal'  Grid.Row='4' Grid.Column='2' > " +
"                                            <TextBlock Text='" + string(data.CrIndLimit) + "'   Margin='0,0,6,0'/> " +
"                                            <TextBlock Text='" + string(data.CrCur) + "'/> " +
"                                        </StackPanel> " +
"                                    </Grid> " +
"                                </Border> " +
"                            </Grid> " ;
end;
   str = str +
"                            <TextBlock Text='Остаток задолженности:' Grid.Row='24' /> " +
"                            <StackPanel  Orientation='Horizontal' Grid.Row='24' Grid.Column='2'  > " +
"                                <TextBlock Text='" + string(data.CrRest) + "'   Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.CrCur) + "'/> " +
"                            </StackPanel> " ;

if(data.PartyLegalForm == "Физическое лицо" and not(data.PartyIP))
   str = str +
"                            <TextBlock Text='Полная стоимость кредита:' Grid.Row='26' Margin='0,5,0,0' /> " +
"                            <StackPanel  Orientation='Horizontal' Grid.Row='26' Grid.Column='2' Margin='0,5,0,0' > " +
"                                <TextBlock Text='" + string(data.CrPSK) + "' Margin='0,0,6,0'/> " +
"                                <TextBlock Text='% годовых' /> " +
"                                <HyperlinkButton Grid.Column='1' Content='Расчет ПСК' Margin='12,0,6,0' HorizontalAlignment='Right' ToolTipService.ToolTip='Нажмите для вызова истории расчета ПСК (Ctrl+X)'/> " +
"                            </StackPanel> " ;
end;
   str = str +
"                            <CheckBox Content='Кредит реструктурирован' IsChecked='" + string(data.CrRes) + "'  IsEnabled='False' Grid.Row='28' Grid.ColumnSpan='3' /> " +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                    <toolkit:Expander x:Name='Expander4' IsExpanded='True' Grid.Row='6'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Дополнительные параметры' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " ;
if(data.PartyLegalForm == "Физическое лицо" and not(data.PartyIP))
   str = str +
"                            <CheckBox Content='Льготный кредит' IsChecked='" + string(data.CrPrivil) + "'  IsEnabled='False' Grid.Row='0' Grid.ColumnSpan='3'  /> " ;
end;
if (data.CrAnnuit)
   str = str +
"                            <CheckBox Content='Аннуитетный платеж' IsChecked='true'  IsEnabled='False' Grid.Row='2' Grid.ColumnSpan='3' /> " ;
else
   str = str +
"                            <CheckBox Content='Аннуитетный платеж' IsChecked='false'  IsEnabled='False' Grid.Row='2' Grid.ColumnSpan='3' /> " ;
end;
   str = str +
"                            <CheckBox Content='Учет процентов на внебалансе' IsChecked='" + string(data.CrFlagOB) + "'  IsEnabled='False' Grid.Row='4' Grid.ColumnSpan='3' /> " +
"                            <CheckBox Content='Индивидуальная классификация' IsChecked='" + string(data.CrInd) + "'  IsEnabled='False' Grid.Row='6' Grid.ColumnSpan='3' /> " ;
if ((not(data.CrIsDraft)) and (not(data.CrInd)))
   str = str +
"                            <StackPanel Grid.Row='8' Orientation='Horizontal'  > " +
"                                <TextBlock Text='Категория качества ссуды:' Margin='0,0,6,0' /> " +
"                                <TextBlock   Text='" + string(data.CrKKS) + "'  Grid.Row='8' Grid.Column='2' /> " +
"                            </StackPanel> " ;

    if (data.CrCase.Size)
      str = str +
"                            <RsControls:GroupBox  Header='Портфель' Grid.Row='10' d:LayoutOverrides='Height' Margin='0,5,0,0' Grid.Column='0' Grid.ColumnSpan='3'  > " +
"                                <StackPanel> " +
"                                    <Grid> " +
"                                        <Grid.ColumnDefinitions> " +
"                                            <ColumnDefinition Width='Auto'/> " +
"                                            <ColumnDefinition Width='*'/> " +
"                                        </Grid.ColumnDefinitions> " +
"                                        <Grid.RowDefinitions> " +
"                                            <RowDefinition Height='Auto'/>  " +
"                                            <RowDefinition Height='*'/> ";
        if (data.CrCase.Size > 1)
            str = str +
"                                            <RowDefinition Height='Auto'/>  " +
"                                            <RowDefinition Height='*'/> " +
"                                        </Grid.RowDefinitions> " +
"                                        <TextBlock Text='Ссуд: '  Grid.Row='2' /> " +
"                                        <TextBlock Text='" + string(data.CrCase[0]) + "'  Grid.Row='2' Grid.Column='2'/> " +
"                                        <TextBlock Text='Условных обязательств: '  Grid.Row='4' /> " +
"                                        <TextBlock Text='" + string(data.CrCase[1]) + "'  Grid.Row='4' Grid.Column='2'/> ";
        else
            str = str +
"                                        </Grid.RowDefinitions> ";

            if (data.CrCaseType[0] == 0)
                       str = str +
"                                        <TextBlock Text='Условных обязательств: '  Grid.Row='2' /> ";
            else
                       str = str +
"                                        <TextBlock Text='Ссуд: '  Grid.Row='2' /> ";   
            end;
        end;
        str = str +
"                                        <TextBlock Text='" + string(data.CrCase[0]) + "'  Grid.Row='2' Grid.Column='2'/> " +
"                                    </Grid> " +
"                                </StackPanel> " +
"                            </RsControls:GroupBox> " ;
    end;
end;

if (((data.PartyLegalForm == "Юридическое лицо") or (data.PartyIP)) and ((data.CrAcceptanceDay != 0) or (strlen(string(data.CrRetailAcc)) > 1) or (data.CrAcceptance)))
   str = str +
"                            <RsControls:GroupBox  Header='Требование по оплате' Grid.Row='12' d:LayoutOverrides='Height' Margin='0,0,0,5' Grid.Column='0' Grid.ColumnSpan='3'  > " +
"                                <StackPanel> " +
"                                    <Grid> " +
"                                        <Grid.RowDefinitions> " +
"                                            <RowDefinition Height='Auto'/> " +
"                                            <RowDefinition Height='*'/> " +
"                                        </Grid.RowDefinitions> " +
"                                        <Grid> " +
"                                            <Grid.ColumnDefinitions> " +
"                                                <ColumnDefinition Width='Auto'/> " +
"                                                <ColumnDefinition Width='6'/> " +
"                                                <ColumnDefinition Width='*'/> " +
"                                            </Grid.ColumnDefinitions> " +
"                                            <Grid.RowDefinitions> " +
"                                                <RowDefinition Height='Auto'/> " +
"                                                <RowDefinition Height='5'/> " +
"                                                <RowDefinition Height='Auto'/> " +
"                                                <RowDefinition Height='*'/> " +
"                                            </Grid.RowDefinitions> " ;
    if (data.CrAcceptance)
       str = str +
"                                            <TextBlock Text='Акцепт:' /> " +
"                                            <StackPanel Orientation='Horizontal' Grid.Column='2'> " +
"                                                <TextBlock Text='" + string(data.CrAcceptanceDay) + "' Margin='0,0,6,0'   /> " +
"                                                <TextBlock Text='дней' /> " +
"                                            </StackPanel> " ;
    else
       str = str +
"                                            <TextBlock Text='Без акцепта' /> " ;
    end;
   str = str +
"                                            <TextBlock Text='Счет:'  Grid.Row='2'/> " +
"                                            <TextBlock Text='" + string(data.CrRetailAcc) + "'  Grid.Row='2' Grid.Column='2'/> " +
"                                        </Grid> " +
"                                    </Grid> " +
"                                </StackPanel> " +
"                            </RsControls:GroupBox> " ;
end;   

if (strlen(string(data.CrNote)) > 1)
   str = str +
"                            <StackPanel Grid.Row='14'  Orientation='Horizontal'  > " +
"                                <TextBlock Text='Примечание:' Margin='0,0,6,0'  /> " +
"                                <TextBlock   Text='" + string(data.CrNote) + "'   /> " +
"                            </StackPanel> " ;
end;
   str = str +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                </Grid> " +
"        </ScrollViewer> " +
"    </Grid> " +
"</RsControls:RsFloatingWindow> " ;

    return str;
END;
