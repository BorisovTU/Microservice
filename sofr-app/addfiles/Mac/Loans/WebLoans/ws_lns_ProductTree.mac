/*
$Name: ws_lns_ProductTree.mac
$Module: WebLoans
$Description: Сервис загрузки объектов Loans
*/
IMPORT SbCrdInter, RsbDataSet, BankInter, globals;


PRIVATE CONST
    TREE_ONLYWEBCLAIM = 1, 
    TREE_ALLCLAIM = 2;

PRIVATE CONST
    CONFIG_SELECTSEARCHED = true,
    CONFIG_SEARCHED_BGCOLOR = "#AB616B",
    CONFIG_SEARCHED_FGCOLOR = "White";

PRIVATE CONST
    POINT_OBJECT_CLAIM = 1,
    POINT_CLAIMSTAGE = 2,
    POINT_CLAIM = 3,
    POINT_OBJECT_CREDIT = 4,
    POINT_TYPECRD = 5,
    POINT_CREDIT = 6,
    POINT_DUTY = 7,
    POINT_STATUS_OPENCONTRACT = 8,
    POINT_OPENCONTRACT_TYPECRD = 9,
    POINT_OPENCONTRACT_CREDIT = 10,
    POINT_OPENCONTRACT_DUTY = 11,
    POINT_STATUS_CLOSECONTRACT = 12,
    POINT_CLOSECONTRACT_TYPECRD = 13,
    POINT_CLOSECONTRACT_CREDIT = 14,
    POINT_CLOSECONTRACT_DUTY = 15,
    POINT_STATUS_OPENDRAFT = 16,
    POINT_OPENDRAFT_TYPECRD = 17,
    POINT_OPENDRAFT_CREDIT = 18,
    POINT_OPENDRAFT_DUTY = 19,
    POINT_STATUS_CLOSEDRAFT = 20,
    POINT_CLOSEDRAFT_TYPECRD = 21,
    POINT_CLOSEDRAFT_CREDIT = 22,
    POINT_CLOSEDRAFT_DUTY = 23,
    POINT_OBJECT_KARTA    = 24,
    POINT_TYPECRD_KARTA   = 25,
    POINT_KARTA           = 26,
    POINT_DUTY_KARTA      = 27,
    POINT_OBJECT_CLAIMGUARANTEE = 28,
    POINT_CLAIMSTAGEGUARANTEE = 29,
    POINT_CLAIMGUARANTEE = 30;

PRIVATE CLASS CLnsProductTreeItem
    var ObjID    = 0;
    var ObjN     = 0;
    var Name     = "";
    var UsNumber = "";
    var PointID  = 0;
    var FastFilter = 0;
    var ExpandLevel = 0;
    var Images = TArray();
    var Childs = NULL;
END;

PRIVATE CLASS ClnsTreeItemIcon(_icon, _tooltip)
  var Icon = _Icon;
  var ToolTip = _toolTip;
END;
       
PRIVATE MACRO lns_MergeArray(/*arr1, arr2 ... */)
  var idx = 0,
      resArr = NULL, parmArr = NULL,
      en = NULL;

    while (GetParm(idx, parmArr))
        if (resArr == NULL)
            resArr = TArray(parmArr);
        elif (parmArr != NULL)
            en = parmArr.createEnum;
            while (en.next)
                resArr.value(resArr.size) = en.item
            end;
        end;

        idx = idx + 1;
    end;

    return resArr;
END;

// Дерево кредитных договоров для дерева 1 типа
PRIVATE MACRO lns_GetCreditTree_TreeType1(ClientID)
    var qStr:string = "",
        rs = NULL,
        i = 0,
        restriction_str = "",
        Arr = TArray();
        
    var p1, p2, p3, p4;
    
    var TypeCrd, Credit, Duty, Status;
    qStr = " SELECT tcrd.t_credittypeid, tcrd.t_credittypename, " +
           "        credit.t_creditnumber, credit.t_uscreditnumber, credit.t_creditstate, " +
           "        duty.t_dutyid, duty.t_usernumber, duty.t_dutystate, " +
           "        decode(duty.t_dutystate, 'О', 1, 2) t_dutystateid, " +
           "        decode(credit.t_clientid_ref, debtor.t_partyid_ref, 'Заемщик', 'Созаемщик') t_rolename, " +
           "        decode(credit.t_clientid_ref, debtor.t_partyid_ref, 6, 7) t_roleid, " +
           "        case credit.t_creditstate " +
           "            when 'О' then 'Открытые договоры'  " +
           "            when 'З' then 'Закрытые договоры' " +
           "            when 'Ч' then 'Открытые черновики'  " +
           "            when 'Д' then 'Закрытые черновики' " +
           "        end as t_StatusName, " + 
           "        case credit.t_creditstate  " +
           "            when 'О' then 2  " +
           "            when 'З' then 4 " +
           "            when 'Ч' then 1  " +
           "            when 'Д' then 3  " +
           "        end as t_StatusID,    " + 
           "        tcrd.t_State as t_TcrdState," +
           "        case tcrd.t_State  " +
           "            when 'О' then 1  " +
           "            when 'З' then 2 " +
           "            else 3 " +
           "        end as t_TcrdStateID    " +
           " FROM dcredit_c_dbt credit, dduty_crd_dbt duty,  " +
           "      dtype_crd_dbt tcrd,   dlothdeb_dbt debtor " +
           " WHERE duty.t_creditnumber_ref(+) = credit.t_creditnumber " +
           "       and credit.t_credittypeid_ref = tcrd.t_credittypeid " +
           "       and debtor.t_objectnumber_ref = credit.t_creditnumber " +
           "       and debtor.t_objecttypeid_ref = 1 " +
           "       and debtor.t_partyid_ref = " + ClientID;

    if (GetObjectRestriction(restriction_str, 36, {oper}, "credit"))
        qStr = qStr + " AND " + restriction_str;
    end;

    qStr = qStr + " ORDER BY ";

    qStr = qStr + " t_TcrdStateID  ASC, ";
    qStr = qStr + " tcrd.t_credittypeid  ASC, ";
    qStr = qStr + " t_StatusID  ASC, ";
    qStr = qStr + " t_roleid  ASC, ";
    qStr = qStr + " credit.t_creditnumber ASC, ";
    qStr = qStr + " t_dutystateid ASC, ";
    qStr = qStr + " duty.t_dutyid ASC ";

    rs = TRsbDataSet(qStr);
    while (rs.moveNext)
        if (i == 0)
            p1 = CLnsProductTreeItem();
            p1.Name = "Кредитный договор";
            p1.PointID = POINT_OBJECT_CREDIT;
            p1.ExpandLevel = 28;
            p1.Childs = TArray;
            Arr[Arr.size] = p1;            
        end;
        if (TypeCrd != rs.credittypeid)
            p2 = CLnsProductTreeItem();
            p2.Name = rs.credittypename;
            if (Int(rs.TcrdStateID) == 2)
                p2.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            p2.PointID = POINT_TYPECRD;
            p2.ExpandLevel = 24;
            p2.Childs         = TArray;
            p1.Childs[p1.Childs.Size] = p2;
        end;

        if (Credit != rs.creditnumber)
            p3 = CLnsProductTreeItem();
            p3.ObjID          = LO_CREDIT;
            p3.ObjN           = Int(rs.CreditNumber);
            p3.Name           = "Кредитный договор " + rs.uscreditnumber;
            p3.UsNumber       = rs.uscreditnumber;
            if ((rs.CreditState == "З") or (rs.CreditState == "Д"))
                p3.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            if ((rs.CreditState == "Ч") or (rs.CreditState == "Д"))
                p3.Images[2] = ClnsTreeItemIcon("/Resources/Images/icon105_16.png", "Черновик");
            end;
            if (rs.roleid == 6)
                p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon101_16.png", rs.rolename);
            elif (rs.roleid == 7)
                p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon102_16.png", rs.rolename);
            end;
            p3.PointID = POINT_CREDIT;
            if (rs.creditstate == "О")
                p3.FastFilter = 10;
            elif (rs.creditstate == "З")
                p3.FastFilter = 18;
            elif (rs.creditstate == "Ч")
                p3.FastFilter = 9;
            elif (rs.creditstate == "Д")
                p3.FastFilter = 17;
            end;
            p3.ExpandLevel = 16;
            p3.Childs       = TArray;
            p2.Childs[p2.Childs.size] = p3;
        end;

        if ((Duty != rs.t_dutyid) AND (rs.t_dutyid != NULL))
            p4 = CLnsProductTreeItem();
            p4.ObjID          = LO_DUTY;
            p4.ObjN           = Int(rs.dutyid);
            p4.Name           = "Срочное обязательство " + rs.usernumber;
            if (rs.DutyState == "З")
                p4.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            p4.PointID = POINT_DUTY;
            p4.FastFilter = 1;
            p4.ExpandLevel = 0;
            p4.Childs       = TArray;
            p3.Childs[p3.Childs.size] = p4;
        end;

        i = i + 1;

        TypeCrd = rs.credittypeid;
        Credit = rs.creditnumber;
        Duty = rs.dutyid;
        Status = rs.creditstate;
    end;

    return Arr;
END;

// Дерево договоров банковских карт для дерева 1 типа
PRIVATE MACRO lns_GetKartaTree_TreeType1(ClientID)
    var qStr:string = "",
        rs = NULL,
        i = 0,
        restriction_str = "",
        Arr = TArray();
     
    var p1, p2, p3, p4;
    
    var TypeCrd, Credit, Duty, Status;
    qStr = " SELECT tcrd.t_credittypeid, tcrd.t_credittypename, " +
           "        credit.t_creditnumber, credit.t_uscreditnumber, credit.t_creditstate, " +
           "        duty.t_dutyid, duty.t_usernumber, duty.t_dutystate, " +
           "        decode(duty.t_dutystate, 'О', 1, 2) t_dutystateid, " +
           "        decode(credit.t_clientid_ref, debtor.t_partyid_ref, 'Заемщик', 'Созаемщик') t_rolename, " +
           "        decode(credit.t_clientid_ref, debtor.t_partyid_ref, 6, 7) t_roleid, " +
           "        case credit.t_creditstate " +
           "            when 'О' then 'Открытые договоры'  " +
           "            when 'З' then 'Закрытые договоры' " +
           "            when 'Ч' then 'Открытые черновики'  " +
           "            when 'Д' then 'Закрытые черновики' " +
           "        end as t_StatusName, " + 
           "        case credit.t_creditstate  " +
           "            when 'О' then 2  " +
           "            when 'З' then 4 " +
           "            when 'Ч' then 1  " +
           "            when 'Д' then 3  " +
           "        end as t_StatusID,    " + 
           "        tcrd.t_State as t_TcrdState," + 
           "        case tcrd.t_State  " +
           "            when 'О' then 1  " +
           "            when 'З' then 2 " +
           "            else 3 " +
           "        end as t_TcrdStateID    " +
           " FROM dcredit_c_dbt credit, dduty_crd_dbt duty,  " +
           "      dtype_crd_dbt tcrd,   dlothdeb_dbt debtor " +
           " WHERE duty.t_creditnumber_ref(+) = credit.t_creditnumber " +
           "       and credit.t_credittypeid_ref = tcrd.t_credittypeid " +
           "       and debtor.t_objectnumber_ref = credit.t_creditnumber " +
           "       and debtor.t_objecttypeid_ref = 8  " +
           "       and debtor.t_partyid_ref = " + ClientID;

    if (GetObjectRestriction(restriction_str, 36, {oper}, "credit"))
        qStr = qStr + " AND " + restriction_str;
    end;

    qStr = qStr + " ORDER BY ";

    qStr = qStr + " t_TcrdStateID  ASC, ";
    qStr = qStr + " tcrd.t_credittypeid  ASC, ";
        qStr = qStr + " t_StatusID  ASC, ";
    qStr = qStr + " t_roleid  ASC, ";
    qStr = qStr + " credit.t_creditnumber ASC, ";
    qStr = qStr + " t_dutystateid ASC, ";
    qStr = qStr + " duty.t_dutyid ASC ";

    rs = TRsbDataSet(qStr);
    while (rs.moveNext)
        if (i == 0)
            p1 = CLnsProductTreeItem();
            p1.Name = "Кредит по карте";
            p1.PointID = POINT_OBJECT_KARTA;
            p1.ExpandLevel = 28;
            p1.Childs = TArray;
            Arr[Arr.size] = p1;                            
        end;
        if (TypeCrd != rs.credittypeid)
            p2 = CLnsProductTreeItem();
            p2.Name           = rs.credittypename;
            if (Int(rs.TcrdStateID) == 2)
                p2.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            p2.PointID = POINT_TYPECRD_KARTA;
            p2.ExpandLevel = 24;
            p2.Childs         = TArray;
            p1.Childs[p1.Childs.Size] = p2;
        end;

        if (Credit != rs.creditnumber)
            p3 = CLnsProductTreeItem();
            p3.ObjID          = LO_KARTA;
//            p3.ObjID          = LO_CREDIT;
            p3.ObjN           = Int(rs.CreditNumber);
            p3.Name           = "Кредитный договор " + rs.uscreditnumber;
            p3.UsNumber       = rs.uscreditnumber;
            if ((rs.CreditState == "З") or (rs.CreditState == "Д"))
                p3.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            if ((rs.CreditState == "Ч") or (rs.CreditState == "Д"))
                p3.Images[2] = ClnsTreeItemIcon("/Resources/Images/icon105_16.png", "Черновик");
            end;
            if (rs.roleid == 6)
                p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon101_16.png", rs.rolename);
            elif (rs.roleid == 7)
                p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon102_16.png", rs.rolename);
            end;
            p3.PointID = POINT_KARTA;
            if (rs.creditstate == "О")
                p3.FastFilter = 10;
            elif (rs.creditstate == "З")
                p3.FastFilter = 18;
            elif (rs.creditstate == "Ч")
                p3.FastFilter = 9;
            elif (rs.creditstate == "Д")
                p3.FastFilter = 17;
            end;
            p3.ExpandLevel = 16;
            p3.Childs       = TArray;
            p2.Childs[p2.Childs.size] = p3;
        end;

        if ((Duty != rs.t_dutyid) AND (rs.t_dutyid != NULL))
            p4 = CLnsProductTreeItem();
            p4.ObjID          = LO_DUTY;
            p4.ObjN           = Int(rs.dutyid);
            p4.Name           = "Срочное обязательство " + rs.usernumber;
            if (rs.DutyState == "З")
                p4.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            p4.PointID = POINT_DUTY_KARTA;
            p4.FastFilter = 1;
            p4.ExpandLevel = 0;
            p4.Childs       = TArray;
            p3.Childs[p3.Childs.size] = p4;
        end;

        i = i + 1;

        TypeCrd = rs.credittypeid;
        Credit = rs.creditnumber;
        Duty = rs.dutyid;
        Status = rs.creditstate;
    end;

    return Arr;

END;

// Дерево кредитных договоров и договоров банковских карт для дерева 2 типа
PRIVATE MACRO lns_GetCreditAndKartaTree_TreeType2(ClientID)
    var qStr:string = "",
        rs = NULL,
        i = 0,
        restriction_str = "",
        Arr = TArray();
   
    var p1, p2, p3, p4;
    
    var TypeCrd, Credit, Duty, Status;
    qStr = " SELECT tcrd.t_credittypeid, tcrd.t_credittypename, " +
           "        credit.t_creditnumber, credit.t_uscreditnumber, credit.t_creditstate, " +
           "        duty.t_dutyid, duty.t_usernumber, duty.t_dutystate, " +
           "        decode(duty.t_dutystate, 'О', 1, 2) t_dutystateid, " +
           "        decode(credit.t_clientid_ref, debtor.t_partyid_ref, 'Заемщик', 'Созаемщик') t_rolename, " +
           "        decode(credit.t_clientid_ref, debtor.t_partyid_ref, 6, 7) t_roleid, " +
           "        case credit.t_creditstate " +
           "            when 'О' then 'Открытые договоры'  " +
           "            when 'З' then 'Закрытые договоры' " +
           "            when 'Ч' then 'Открытые черновики'  " +
           "            when 'Д' then 'Закрытые черновики' " +
           "        end as t_StatusName, " + 
           "        case credit.t_creditstate  " +
           "            when 'О' then 1  " +
           "            when 'З' then 2 " +
           "            when 'Ч' then 3  " +
           "            when 'Д' then 4  " +
           "        end as t_StatusID,    " + 
           "        tcrd.t_State as t_TcrdState," + 
           "        case tcrd.t_State  " +
           "            when 'О' then 1  " +
           "            when 'З' then 2 " +
           "            else 3 " +
           "        end as t_TcrdStateID,    " +
           "        debtor.t_objecttypeid_ref as obj_type  " +
           " FROM dcredit_c_dbt credit, dduty_crd_dbt duty,  " +
           "      dtype_crd_dbt tcrd,   dlothdeb_dbt debtor " +
           " WHERE duty.t_creditnumber_ref(+) = credit.t_creditnumber " +
           "       and credit.t_credittypeid_ref = tcrd.t_credittypeid " +
           "       and debtor.t_objectnumber_ref = credit.t_creditnumber " +
           "       and (debtor.t_objecttypeid_ref = 1 or debtor.t_objecttypeid_ref = 8) " +
           "       and debtor.t_partyid_ref = " + ClientID;

    if (GetObjectRestriction(restriction_str, 36, {oper}, "credit"))
        qStr = qStr + " AND " + restriction_str;
    end;

    qStr = qStr + " ORDER BY ";

    qStr = qStr + " t_StatusID  ASC, ";
    qStr = qStr + " t_TcrdStateID  ASC, ";
    qStr = qStr + " tcrd.t_credittypeid  ASC, ";
    qStr = qStr + " t_roleid  ASC, ";
    qStr = qStr + " credit.t_creditnumber ASC, ";
    qStr = qStr + " t_dutystateid ASC, ";
    qStr = qStr + " duty.t_dutyid ASC ";

    rs = TRsbDataSet(qStr);
    while (rs.moveNext)
            if (Status != rs.creditstate)
                p1 = CLnsProductTreeItem();
                p1.Name = rs.StatusName;
                if (rs.creditstate == "О")
                    p1.PointID = POINT_STATUS_OPENCONTRACT;
                elif (rs.creditstate == "З")
                    p1.PointID = POINT_STATUS_CLOSECONTRACT;
                elif (rs.creditstate == "Ч")
                    p1.PointID = POINT_STATUS_OPENDRAFT;
                elif (rs.creditstate == "Д")
                    p1.PointID = POINT_STATUS_CLOSEDRAFT;
                end;
                p1.ExpandLevel = 28;
                p1.Childs = TArray;
                Arr[Arr.size] = p1;
            end;
        
        if  ((TypeCrd != rs.credittypeid) or (Status != rs.creditstate))
            p2 = CLnsProductTreeItem();
            p2.Name           = rs.credittypename;
            if (Int(rs.TcrdStateID) == 2)
                p2.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
                if (rs.creditstate == "О")
                    p2.PointID = POINT_OPENCONTRACT_TYPECRD;
                elif (rs.creditstate == "З")
                    p2.PointID = POINT_CLOSECONTRACT_TYPECRD;
                elif (rs.creditstate == "Ч")
                    p2.PointID = POINT_OPENDRAFT_TYPECRD;
                elif (rs.creditstate == "Д")
                    p2.PointID = POINT_CLOSEDRAFT_TYPECRD;
                end;
            p2.ExpandLevel = 24;
            p2.Childs         = TArray;
            p1.Childs[p1.Childs.Size] = p2;
        end;

        if (Credit != rs.creditnumber)
            p3 = CLnsProductTreeItem();
            //p3.ObjID          = LO_CREDIT;
            p3.ObjID          = Int(rs.obj_type);
            p3.ObjN           = Int(rs.CreditNumber);
            p3.Name           = "Кредитный договор " + rs.uscreditnumber;
            p3.UsNumber       = rs.uscreditnumber;
            if ((rs.CreditState == "З") or (rs.CreditState == "Д"))
                p3.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
            if ((rs.CreditState == "Ч") or (rs.CreditState == "Д"))
                p3.Images[2] = ClnsTreeItemIcon("/Resources/Images/icon105_16.png", "Черновик");
            end;
            if (rs.roleid == 6)
                p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon101_16.png", rs.rolename);
            elif (rs.roleid == 7)
                p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon102_16.png", rs.rolename);
            end;
                if (rs.creditstate == "О")
                    p3.PointID = POINT_OPENCONTRACT_CREDIT;
                p3.FastFilter = 10;
                elif (rs.creditstate == "З")
                    p3.PointID = POINT_CLOSECONTRACT_CREDIT;
                p3.FastFilter = 18;
                elif (rs.creditstate == "Ч")
                    p3.PointID = POINT_OPENDRAFT_CREDIT;
                p3.FastFilter = 9;
                elif (rs.creditstate == "Д")
                    p3.PointID = POINT_CLOSEDRAFT_CREDIT;
                p3.FastFilter = 17;
            end;
            p3.ExpandLevel = 16;
            p3.Childs       = TArray;
            p2.Childs[p2.Childs.size] = p3;
        end;

        if ((Duty != rs.t_dutyid) AND (rs.t_dutyid != NULL))
            p4 = CLnsProductTreeItem();
            p4.ObjID          = LO_DUTY;
            p4.ObjN           = Int(rs.dutyid);
            p4.Name           = "Срочное обязательство " + rs.usernumber;
            if (rs.DutyState == "З")
                p4.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            end;
                if (rs.creditstate == "О")
                    p4.PointID = POINT_OPENCONTRACT_DUTY;
                elif (rs.creditstate == "З")
                    p4.PointID = POINT_CLOSECONTRACT_DUTY;
                elif (rs.creditstate == "Ч")
                    p4.PointID = POINT_OPENDRAFT_DUTY;
                elif (rs.creditstate == "Д")
                    p4.PointID = POINT_CLOSEDRAFT_DUTY;
                end;
            p4.FastFilter = 1;
            p4.ExpandLevel = 0;
            p4.Childs       = TArray;
            p3.Childs[p3.Childs.size] = p4;
        end;

        i = i + 1;

        TypeCrd = rs.credittypeid;
        Credit = rs.creditnumber;
        Duty = rs.dutyid;
        Status = rs.creditstate;
    end;

    return Arr;
END;

// дерево старых заявок
PRIVATE MACRO lns_GetOldClaimTree(ClientID)
    var qStr = "",
    rs = null,
    restriction_str = "",
    result = TArray(),
    p2, p3;
    var i = 0;

    var regVal = "", stat = 0, OldClaimDate = Date(0,0,0);
    GetRegistryValue("RS-LOANS\\WEB\\ДЕРЕВО_ПРОДУКТОВ_КЛИЕНТА\\ДАТА АРХИВА ЗАЯВОК", V_STRING, regVal, stat);
    if (stat == 0) OldClaimDate = Date(regVal); else OldClaimDate = Date(0,0,0); end;

    qStr = "select cl.t_claimid, " +
                  "cl.t_claimnumber, " +
                  "typecrd.t_CreditTypeName as t_TypeCredit, " +
                  "cl.t_CreditNumber_Ref " +
           "from dclaim_dbt cl, " + 
           "     dtype_crd_dbt typecrd " +
           "WHERE cl.t_loanerid_ref = " + ClientID +
           " and cl.t_credittypeid_ref = typecrd.t_CreditTypeID " + 
           " and cl.t_moduletype = " + LNS_MT_WEBCREDIT + // Заявка вебовская
           " and cl.t_claimkind = " + CREDIT_CLAIM +      // Заявка на кредит, а не на гарантию, овердрафт или что-то другое
           " and CL.T_GIVINGDATE < TO_DATE('" + StrSubst(String(OldClaimDate:f), " ", "0") + "', 'DD.MM.YYYY')";

    if (GetObjectRestriction(restriction_str, 55, {oper}, "cl"))
        qStr = qStr + " AND " + restriction_str;
    end;

    qStr = qStr + " order by cl.t_claimid asc ";
                  
    rs = TRsbDataSet(qStr);
    while (rs.MoveNext)
        if (i == 0)
            p2 = CLnsProductTreeItem();
            p2.Name = "Зарегистрированные до " + String(OldClaimDate:f);
            p2.PointID = POINT_CLAIMSTAGE;
            p2.ExpandLevel = 2;
            p2.Childs = TArray();
            result[result.size] = p2;
        end;

        
        p3 = CLnsProductTreeItem();
        p3.Name = "Заявка №" + rs.ClaimNumber + " - " + rs.TypeCredit;
        p3.ObjID = LO_CLAIM;
        p3.ObjN = Int(rs.ClaimID);
        p3.PointID = POINT_CLAIM;
        if (Int(rs.CreditNumber_Ref) > 0)
            // p3.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
            p3.FastFilter = 20;
        else
            p3.FastFilter = 12;
        end;
        p3.ExpandLevel = 0;
        p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon101_16.png", "Заемщик");
        p3.Childs = TArray();
        p2.Childs[p2.Childs.Size] = p3;

        i = i + 1;
    end;

    return result; 
END;


// Дерево заявок       
PRIVATE MACRO lns_GetNewClaimTree(ClientID, fncash, territorialstruct)
    var qStr = "",
        rs = null,
        restriction_str = "",
        result = TArray(),
        p1, p2, p3;
    var StageID, ClaimID;
    var i = 0;
    qStr = "select cl.t_claimid, " +
                  "cl.t_claimnumber, " +
                  "stage.t_id as t_stageid, " + 
                  "stage.t_name as t_stagename, " +
                  "typecrd.t_CreditTypeName as t_TypeCredit, " +
                  "cl.t_CreditNumber_Ref " +
           "from dclaim_dbt cl, " + 
           "     dlclaimstage_dbt stage, " + 
           "     dtype_crd_dbt typecrd " +
           "where stage.t_id = cl.t_stageid "
           " and t_claimkind = 0"
           " and cl.t_loanerid_ref = " + ClientID +
           " and cl.t_credittypeid_ref = typecrd.t_CreditTypeID " + 
           " and cl.t_moduletype = " + LNS_MT_WEBCREDIT + 
           " and cl.t_claimkind = " + CREDIT_CLAIM;

    if (GetObjectRestriction(restriction_str, 55, {oper}, "cl"))
        qStr = qStr + " AND " + restriction_str;
    end;

    qStr = qStr + " order by stage.t_id asc, cl.t_claimid asc ";
                  
    rs = TRsbDataSet(qStr);

    while (rs.MoveNext)
        if (StageID != rs.StageID)
            p2 = CLnsProductTreeItem();
            p2.Name = rs.StageName;
            p2.PointID = POINT_CLAIMSTAGE;
            p2.ExpandLevel = 2;
            p2.Childs = TArray();
            result[result.size] = p2;
        end;
        if (ClaimID != rs.ClaimID)
            p3 = CLnsProductTreeItem();
            p3.Name = "Заявка №" + rs.ClaimNumber + " - " + rs.TypeCredit;
            p3.ObjID = LO_CLAIM;
            p3.ObjN = Int(rs.ClaimID);
            p3.PointID = POINT_CLAIM;
            if (Int(rs.CreditNumber_Ref) > 0)
                // p3.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
                p3.FastFilter = 20;
            else
                p3.FastFilter = 12;
            end;
            p3.ExpandLevel = 0;
            p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon101_16.png", "Заемщик");
            p3.Childs = TArray();
            p2.Childs[p2.Childs.Size] = p3;
        end;
        
        StageID = rs.stageid;
        ClaimID = rs.claimid;
        i = i + 1;
    end;

    return result;  
END;

PRIVATE MACRO lns_GetClaimTree(ClientID, fncash, territorialstruct)
    var p1;
    var result = TArray();
    var NewClaims = TArray();
    var OldClaims = TArray();
    var regVal = 1, stat = 0, ClaimTreeMode = 1;
    GetRegistryValue("RS-LOANS\\WEB\\ДЕРЕВО_ПРОДУКТОВ_КЛИЕНТА\\СПИСОК ЗАЯВОК", V_INTEGER, regVal, stat);
    if (stat == 0) ClaimTreeMode = regVal; else ClaimTreeMode = 1; end;

    NewClaims = lns_GetNewClaimTree(ClientID, fncash, territorialstruct);
    if (ClaimTreeMode == TREE_ALLCLAIM)
        OldClaims = lns_GetOldClaimTree(ClientID);
    end;
    if ((NewClaims and (NewClaims.Size > 0)) or (OldClaims and (OldClaims.Size > 0)))
        p1 = CLnsProductTreeItem();
        p1.Name = "Заявки на кредит";
        p1.PointID = POINT_OBJECT_CLAIM;
        p1.ExpandLevel = 3;
        p1.Childs = lns_MergeArray(OldClaims, NewClaims);
        result[result.size] = p1;
    end;
    return result;
END;

// Дерево заявок       
PRIVATE MACRO lns_GetClaimGuaranteeTree(ClientID, fncash, territorialstruct)
    var qStr = "",
        rs = null,
        restriction_str = "",
        result = TArray(),
        p1, p2, p3;
    var StageID, ClaimID;
    var i = 0;


    qStr = "select cl.t_claimid, " +
                  "cl.t_claimnumber, " +
                  "stage.t_id as t_stageid, " + 
                  "stage.t_name as t_stagename, " +
                  "typecrd.t_CreditTypeName as t_TypeCredit, " +
                  "cl.t_CreditNumber_Ref " +
           "from dclaim_dbt cl, " + 
           "     dlclaimstage_dbt stage, " + 
           "     dtype_crd_dbt typecrd " +
           "where stage.t_id = cl.t_stageid "
           " and t_claimkind = 3"
           " and cl.t_loanerid_ref = " + ClientID +
           " and cl.t_credittypeid_ref = typecrd.t_CreditTypeID " + 
           " and cl.t_moduletype = " + LNS_MT_WEBCREDIT + 
           " and cl.t_claimkind = " + GUARANTEE_CLAIM;


    qStr = qStr + " order by stage.t_id asc, cl.t_claimid asc ";
                  
    rs = TRsbDataSet(qStr);
    while (rs.MoveNext)
        if (i == 0)
            p1 = CLnsProductTreeItem();
            p1.Name = "Заявки на получение гарантии";
            p1.PointID = POINT_OBJECT_CLAIMGUARANTEE;
            p1.ExpandLevel = 3;
            p1.Childs = TArray();
            result[result.size] = p1;
        end;
        if (StageID != rs.StageID)
            p2 = CLnsProductTreeItem();
            p2.Name = rs.StageName;
            p2.PointID = POINT_CLAIMSTAGEGUARANTEE;
            p2.ExpandLevel = 2;
            p2.Childs = TArray();
            p1.Childs[p1.Childs.size] = p2;
        end;
        if (ClaimID != rs.ClaimID)
            p3 = CLnsProductTreeItem();
            p3.Name = "Заявка №" + rs.ClaimNumber + " - " + rs.TypeCredit;
            p3.ObjID = LO_CLAIM;
            p3.ObjN = Int(rs.ClaimID);
            p3.PointID = POINT_CLAIMGUARANTEE;
            if (Int(rs.CreditNumber_Ref) > 0)
                // p3.Images[1] = ClnsTreeItemIcon("/Resources/Images/icon11_16.png", "Закрыт");
                p3.FastFilter = 20;
            else
                p3.FastFilter = 12;
            end;
            p3.ExpandLevel = 0;
            p3.Images[0] = ClnsTreeItemIcon("/Resources/Images/icon101_16.png", "Заемщик");
            p3.Childs = TArray();
            p2.Childs[p2.Childs.Size] = p3;
        end;
        
        StageID = rs.stageid;
        ClaimID = rs.claimid;
        i = i + 1;
    end;

    return result;  
END;
       
PRIVATE MACRO lns_GetClientProductsTree(ClientID, TreeType)
    if (TreeType == 1)
        return lns_MergeArray(
                              lns_GetClaimGuaranteeTree(ClientID),
                              lns_GetClaimTree(ClientID), 
                              lns_GetCreditTree_TreeType1(ClientID),
                              lns_GetKartaTree_TreeType1(ClientID)
                             );    
    elif (TreeType == 2)
    return lns_MergeArray(
                          lns_GetClaimGuaranteeTree(ClientID),
                          lns_GetClaimTree(ClientID), 
                              lns_GetCreditAndKartaTree_TreeType2(ClientID)
                         );
    end;
END;

PRIVATE MACRO TextSearchSelectableControl(Color)
  var
      retVal = "";

    if (CONFIG_SELECTSEARCHED)
retVal =
"<LnsWebControls:HighlightingTextBlock Text='{StaticResource PointName}' Foreground='" + Color + "' HighlightText='{Binding Path=StringFilter, ElementName=LayoutRoot}' HighlightBrush='" + CONFIG_SEARCHED_FGCOLOR + "' HighlightBackground='" + CONFIG_SEARCHED_BGCOLOR + "'/>";
    else
        retVal =
"<TextBlock Text='{StaticResource PointName}' Foreground='" + Color + "' VerticalAlignment='Center' />";
    end;

    return retVal;
END;

PRIVATE MACRO GetIsChildSelected(tree, level)
  var
      retVal = "", idx = 0;

    if ((tree.Childs == NULL)or(tree.Childs.size == 0))
            retVal = retVal +
"<System:Boolean>False</System:Boolean>";
    else
        retVal = retVal +
"<RsToolsUtils:MultiBinding> " +
"    <RsToolsUtils:MultiBinding.Converter> " +
"        <LnsMC:MultiConverter> " +
"            <LnsMC:MultyConverterItem Mode='MultiValueConverter' > " +
"                <LnsMC:MultyConverterItem.Converter> " +
"                    <LnsConvert:HasNullConverter> " +
"                        <LnsMC:MultyConverterItem ConverterParameter='{x:Null}'> " +
"                            <LnsMC:MultyConverterItem.Converter> " +
"                                <LnsConverter:SetValueConverter /> " +
"                            </LnsMC:MultyConverterItem.Converter> " +
"                        </LnsMC:MultyConverterItem> " +
"                    </LnsConvert:HasNullConverter> " +
"                </LnsMC:MultyConverterItem.Converter> " +
"            </LnsMC:MultyConverterItem> " +
"            <LnsMC:MultyConverterItem> " +
"                <LnsMC:MultyConverterItem.Converter> " +
"                    <LnsConvert:HasNullConverter Reverse='True'> " +
"                        <LnsMC:MultyConverterItem Converter='{StaticResource MultiBindingBooleanORConverter}' Mode='MultiValueConverter'/> " +
"                    </LnsConvert:HasNullConverter> " +
"                </LnsMC:MultyConverterItem.Converter> " +
"             </LnsMC:MultyConverterItem> " +
"        </LnsMC:MultiConverter> " +
"    </RsToolsUtils:MultiBinding.Converter> " +
"    <RsToolsUtils:MultiBinding.Bindings> " +
"        <RsToolsUtils:BindingCollection> ";
        while (idx < tree.Childs.size)
            retVal = retVal + 
"            <Binding Path='IsSelected' ElementName='" + level + "_" + String(idx) + "'/>" +
"            <Binding Path='IsChildSelected_" + level + "_" + String(idx) + "' ElementName='" + level + "_" + String(idx) + "'/>";
            idx = idx + 1;
        end;
        retVal = retVal + 
"        </RsToolsUtils:BindingCollection> " +
"    </RsToolsUtils:MultiBinding.Bindings> " +
"</RsToolsUtils:MultiBinding> ";
    end;

    return retVal;
END;

PRIVATE MACRO GetVisibility(tree, level)
  var
      retVal = "", idx = 0;

    if (tree.ObjID == 0)
        retVal = retVal + 
"<RsToolsUtils:MultiBinding Converter='{StaticResource MultiBindingVisibilityORConverter}'> " +
"    <RsToolsUtils:MultiBinding.Bindings> " +
"        <RsToolsUtils:BindingCollection> ";
        idx = 0;
        while (idx < tree.Childs.size)
            retVal = retVal + 
"            <Binding Path='Visibility' ElementName='" + level + "_" + String(idx) + "'/>";
            idx = idx + 1;
        end;
        retVal = retVal + 
"        </RsToolsUtils:BindingCollection> " +
"    </RsToolsUtils:MultiBinding.Bindings> " +
"</RsToolsUtils:MultiBinding> ";
    elif ((tree.ObjID == LO_CLAIM)or(tree.ObjID == LO_CREDIT)or(tree.ObjID == LO_KARTA))
        retVal = retVal +
"<RsToolsUtils:MultiBinding Converter='{StaticResource MultiBindingVisibilityANDConverter}'> " +
"    <RsToolsUtils:MultiBinding.Bindings> " +
"        <RsToolsUtils:BindingCollection> " +
"            <Binding Path='FastFilter' ElementName='LayoutRoot'> " +
"                <Binding.Converter> " +
"                    <LnsMC:MultiConverter> " +
"                        <LnsMC:MultyConverterItem Converter='{StaticResource BitANDConverter}'> " +
"                            <LnsMC:MultyConverterItem.ConverterParameter> " +
"                                <System:Int32>" + String(tree.FastFilter) + "</System:Int32> " +
"                            </LnsMC:MultyConverterItem.ConverterParameter> " +
"                        </LnsMC:MultyConverterItem> " +
"                        <LnsMC:MultyConverterItem Converter='{StaticResource BitXORConverter}'> " +
"                            <LnsMC:MultyConverterItem.ConverterParameter> " +
"                                <System:Int32>" + String(tree.FastFilter) + "</System:Int32> " +
"                            </LnsMC:MultyConverterItem.ConverterParameter> " +
"                        </LnsMC:MultyConverterItem> " +
"                        <LnsMC:MultyConverterItem Converter='{StaticResource IntToBoolConverterNeg}' /> " +
"                        <LnsMC:MultyConverterItem Converter='{StaticResource BoolToVisibilityConverter}' /> " +
"                    </LnsMC:MultiConverter> " +
"                </Binding.Converter> " +
"            </Binding> " +
"            <Binding Path='StringFilter' ElementName='LayoutRoot'> " +
"                <Binding.Converter> " +
"                    <LnsMC:MultiConverter> " +
"                        <LnsMC:MultyConverterItem ConverterParameter='DEFAULTVALUE'> " +
"                            <LnsMC:MultyConverterItem.Converter> " +
"                                <LnsConvert:StringConverter Value='{StaticResource PointName}' /> " +
"                            </LnsMC:MultyConverterItem.Converter> " +
"                        </LnsMC:MultyConverterItem> " +
"                        <LnsMC:MultyConverterItem ConverterParameter='CONTAINS'> " +
"                            <LnsMC:MultyConverterItem.Converter> " +
"                                <LnsConvert:StringConverter IsReverse='True' Value='{StaticResource PointName}' /> " +
"                            </LnsMC:MultyConverterItem.Converter> " +
"                        </LnsMC:MultyConverterItem> " +
"                        <LnsMC:MultyConverterItem Converter='{StaticResource BoolToVisibilityConverter}' /> " +
"                    </LnsMC:MultiConverter> " +
"                </Binding.Converter> " +
"            </Binding> " +
"        </RsToolsUtils:BindingCollection> " +
"    </RsToolsUtils:MultiBinding.Bindings> " +
"</RsToolsUtils:MultiBinding> ";
        elif (tree.ObjID == LO_DUTY)
            retVal = retVal +
"Visible";
        else
            retVal = retVal +
"Collapsed";
        end;

    return retVal;
END;

PRIVATE MACRO SerializeProductTree(tree, TreeType, prev_level)
  var
      retVal = "",
      level = "",
      idx = 0, idy = 0,
      arrEnum = NULL;

    while (idx < tree.size)
        level = prev_level + "_" + String(idx);
        retVal = retVal +

"<Controls:TreeViewItem x:Name = '" + level + "' IsExpanded='True'>" +
"    <Controls:TreeViewItem.Resources>" +
"        <System:String x:Key='PointName'>" + tree[idx].Name + "</System:String>" +
"    </Controls:TreeViewItem.Resources>" +
"    <Controls:TreeViewItem.Header>" +
"        <ContentControl>" +
"            <StackPanel Orientation='Horizontal'>";
        arrEnum = tree[idx].Images.createEnum;
        while (arrEnum.next)
            if (arrEnum.item != NULL)
                retVal = retVal + 
"                <Image Source='" + arrEnum.item.Icon + "' Margin='0,0,6,0' ToolTipService.ToolTip='" + arrEnum.item.ToolTip + "'/>";
            end;
        end;
        if (tree[idx].PointID == POINT_OBJECT_CLAIM)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF047D80' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLAIMSTAGE)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF047D80' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLAIM)
            retVal = retVal + 
            TextSearchSelectableControl("#FF21A7AB");
        elif (tree[idx].PointID == POINT_OBJECT_CLAIMGUARANTEE)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF047FFF' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLAIMSTAGEGUARANTEE)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF047FFF' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLAIMGUARANTEE)
            retVal = retVal + 
            TextSearchSelectableControl("#FF21AFFF");
        elif (tree[idx].PointID == POINT_OBJECT_CREDIT)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF001280' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_OBJECT_KARTA)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF0A6F00' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_TYPECRD)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF001280' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_TYPECRD_KARTA)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF0A6F00' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CREDIT)
            retVal = retVal + 
            TextSearchSelectableControl("#FF004280");
        elif (tree[idx].PointID == POINT_KARTA)
            retVal = retVal + 
            TextSearchSelectableControl("#FF006F3F");        
        elif (tree[idx].PointID == POINT_DUTY)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF0781B4' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_DUTY_KARTA)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF059F5C' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_STATUS_OPENCONTRACT)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF001280' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_OPENCONTRACT_TYPECRD)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF001280' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_OPENCONTRACT_CREDIT)
            retVal = retVal + 
            TextSearchSelectableControl("#FF004280");
        elif (tree[idx].PointID == POINT_OPENCONTRACT_DUTY)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF0781B4' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_STATUS_CLOSECONTRACT)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF0A6F00' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLOSECONTRACT_TYPECRD)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF0A6F00' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLOSECONTRACT_CREDIT)
            retVal = retVal + 
            TextSearchSelectableControl("#FF006F3F");
        elif (tree[idx].PointID == POINT_CLOSECONTRACT_DUTY)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF059F5C' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_STATUS_OPENDRAFT)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF6F0061' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_OPENDRAFT_TYPECRD)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF6F0061' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_OPENDRAFT_CREDIT)
            retVal = retVal + 
            TextSearchSelectableControl("#FF971284");
        elif (tree[idx].PointID == POINT_OPENDRAFT_DUTY)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FFC11CDE' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_STATUS_CLOSEDRAFT)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF705D03' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLOSEDRAFT_TYPECRD)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FF705D03' VerticalAlignment='Center' />";
        elif (tree[idx].PointID == POINT_CLOSEDRAFT_CREDIT)
            retVal = retVal + 
            TextSearchSelectableControl("#FF7A6806");
        elif (tree[idx].PointID == POINT_CLOSEDRAFT_DUTY)
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' Foreground='#FFAF901D' VerticalAlignment='Center' />";
        else
            retVal = retVal + 
"                <TextBlock Text='{StaticResource PointName}' VerticalAlignment='Center' />";
        end;
        retVal = retVal +
"            </StackPanel>" +
"        </ContentControl>" +
"    </Controls:TreeViewItem.Header>" +
"    <Controls:TreeViewItem.Visibility> " +
        GetVisibility(tree[idx], level) +
"    </Controls:TreeViewItem.Visibility>";

        if ((tree[idx].Childs != NULL)and(tree[idx].Childs.size > 0))
            retVal = retVal + SerializeProductTree(tree[idx].Childs, TreeType, level);
        end;

        retVal = retVal + 
"    <SWI:Interaction.Behaviors>";
        
        if ((tree[idx].ObjID == LO_CREDIT)or(tree[idx].ObjID == LO_KARTA)) 
            retVal = retVal + 
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='PointName_" + level + "' Binding='" + tree[idx].UsNumber + "'/>";
        end;

        retVal = retVal + 
"                <LnsBehaviors:RegisterDependencyProperty PropertyName='LnsObjID_" + level + "'>" +
"                    <LnsBehaviors:RegisterDependencyProperty.Binding>";
        if (tree[idx].ObjID > 0)
            retVal = retVal +
"                        <LnsCommonType:CLnsObjID ObjID='" + String(tree[idx].ObjID) +"' ObjN='" + String(tree[idx].ObjN) + "'/> ";
        end;
        retVal = retVal +
"                    </LnsBehaviors:RegisterDependencyProperty.Binding>" +
"                </LnsBehaviors:RegisterDependencyProperty>" +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='IsChildSelected_" + level + "'>" +
"            <LnsBehaviors:RegisterDependencyProperty.Binding>" +
    GetIsChildSelected(tree[idx], level) +
"            </LnsBehaviors:RegisterDependencyProperty.Binding>" +
"        </LnsBehaviors:RegisterDependencyProperty> " +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='ExpandLevel_" + level + "' />" +
"    </SWI:Interaction.Behaviors>" +
"    <SWI:Interaction.Triggers>" +
"        <MEICore:DataTrigger>"
"            <MEICore:DataTrigger.Binding>" + 
"                <Binding Path='SelectedItem.Name' ElementName='ProductTree' ConverterParameter='EQUAL'>" +
"                    <Binding.Converter> " +
"                        <LnsConvert:StringConverter Value='" + level + "' /> " +
"                    </Binding.Converter> " +
"                </Binding>" +
"            </MEICore:DataTrigger.Binding>" +
"            <MEICore:DataTrigger.Value> " +
"                <System:Boolean>True</System:Boolean>" +
"            </MEICore:DataTrigger.Value> " +
"            <LnsActions:SetBinding PropertyName='LnsObjID' TargetObject='{Binding ElementName=LayoutRoot}' Binding='{Binding LnsObjID_" + level + ", ElementName=" + level + "}' />" +
"        </MEICore:DataTrigger>";
    if ((tree[idx].Childs != NULL)and(tree[idx].Childs.size > 0))
        retVal = retVal +
"        <MEICore:DataTrigger Binding='{Binding IsChildSelected_" + level + ", ElementName=" + level + "}'>"
"            <MEICore:DataTrigger.Value> " +
"                <System:Boolean>True</System:Boolean>" +
"            </MEICore:DataTrigger.Value> " +
"            <MEICore:ChangePropertyAction PropertyName='IsExpanded' TargetName='" + level + "'>" +
"                <MEICore:ChangePropertyAction.Value>" +
"                    <System:Boolean>True</System:Boolean>" +
"                </MEICore:ChangePropertyAction.Value>" +
"            </MEICore:ChangePropertyAction>" +
"        </MEICore:DataTrigger>" +
"        <MEICore:DataTrigger Binding='{Binding Value, Source={StaticResource ChildSelectedInited}}'>"
"            <MEICore:DataTrigger.Value> " +
"                <System:Boolean>True</System:Boolean>" +
"            </MEICore:DataTrigger.Value> " +
"            <LnsActions:SetBinding PropertyName='ExpandLevel_" + level + "' Binding='{Binding ExpandLevel, ElementName=LayoutRoot}' />" +
"        </MEICore:DataTrigger>" +
"        <MEICore:PropertyChangedTrigger Binding='{Binding ExpandLevel_" + level + ", ElementName=" + level + "}'>" +
"            <SWI:Interaction.Behaviors>" +
"                <MEICore:ConditionBehavior>" +
"                    <MEICore:ConditionalExpression>" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding IsChildSelected_" + level + ", ElementName=" + level + "}' Operator='Equal'>" +
"                            <MEICore:ComparisonCondition.RightOperand>" +
"                                <System:Boolean>False</System:Boolean>" +
"                            </MEICore:ComparisonCondition.RightOperand>" +
"                        </MEICore:ComparisonCondition>" +
"                    </MEICore:ConditionalExpression>" +
"                </MEICore:ConditionBehavior>" +
"            </SWI:Interaction.Behaviors>" +
"            <MEICore:ChangePropertyAction PropertyName='IsExpanded' TargetName='" + level + "'>" +
"                <MEICore:ChangePropertyAction.Value>" +
"                    <Binding Path='ExpandLevel_" + level + "' ElementName='" + level + "'> " +
"                        <Binding.Converter> " +
"                            <LnsMC:MultiConverter> " +
"                                <LnsMC:MultyConverterItem Converter='{StaticResource BitANDConverter}'> " +
"                                    <LnsMC:MultyConverterItem.ConverterParameter> " +
"                                        <System:Int32>" + String(tree[idx].ExpandLevel) + "</System:Int32> " +
"                                    </LnsMC:MultyConverterItem.ConverterParameter> " +
"                                </LnsMC:MultyConverterItem> " +
"                                <LnsMC:MultyConverterItem Converter='{StaticResource IntToBoolConverter}' /> " +
"                            </LnsMC:MultiConverter> " +
"                        </Binding.Converter> " +
"                    </Binding> " +
"                </MEICore:ChangePropertyAction.Value>" +
"            </MEICore:ChangePropertyAction>" +
"        </MEICore:PropertyChangedTrigger>";
    end;
    if (tree[idx].ObjID > 0)
        retVal = retVal +
"        <MEICore:PropertyChangedTrigger Binding='{Binding Positioning, ElementName=ProductTree}'>"
"            <SWI:Interaction.Behaviors>" +
"                <MEICore:ConditionBehavior>" +
"                    <MEICore:ConditionalExpression>" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding Positioning[0].Value, ElementName=ProductTree}' Operator='Equal' RightOperand='1' />" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding LnsObjID_" + level + ".ObjID, ElementName=" + level + "}' Operator='Equal' RightOperand='{Binding Positioning[1].Value, ElementName=ProductTree}' />" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding LnsObjID_" + level + ".ObjN, ElementName=" + level + "}' Operator='Equal' RightOperand='{Binding Positioning[2].Value, ElementName=ProductTree}' />" +
"                    </MEICore:ConditionalExpression>" +
"                </MEICore:ConditionBehavior>" +
"            </SWI:Interaction.Behaviors>" +
"            <MEICore:ChangePropertyAction PropertyName='IsSelected' TargetName='" + level + "'>" +
"                <MEICore:ChangePropertyAction.Value>" +
"                    <System:Boolean>True</System:Boolean>" +
"                </MEICore:ChangePropertyAction.Value>" +
"            </MEICore:ChangePropertyAction>" +
"        </MEICore:PropertyChangedTrigger>" +
"        <MEICore:PropertyChangedTrigger Binding='{Binding Positioning, ElementName=ProductTree}'>" +
"            <SWI:Interaction.Behaviors>" +
"                <MEICore:ConditionBehavior>" +
"                    <MEICore:ConditionalExpression>" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding Positioning[0].Value, ElementName=ProductTree}' Operator='Equal' RightOperand='2' />" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding LnsObjID_" + level + ".ObjID, ElementName=" + level + "}' Operator='Equal' RightOperand='{Binding Positioning[1].Value, ElementName=ProductTree}' />" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding PointName_" + level + ", ElementName=" + level + "}' Operator='Equal' RightOperand='{Binding Positioning[2].Value, ElementName=ProductTree}' />" +
"                    </MEICore:ConditionalExpression>" +
"                </MEICore:ConditionBehavior>" +
"            </SWI:Interaction.Behaviors>" +
"            <MEICore:ChangePropertyAction PropertyName='IsSelected' TargetName='" + level + "'>" +
"                <MEICore:ChangePropertyAction.Value>" +
"                    <System:Boolean>True</System:Boolean>" +
"                </MEICore:ChangePropertyAction.Value>" +
"            </MEICore:ChangePropertyAction>" +
"        </MEICore:PropertyChangedTrigger>";
    end;
    retVal = retVal +
"    </SWI:Interaction.Triggers>" +
"</Controls:TreeViewItem>";

        idx = idx + 1;
    end;

    return retVal;
END;

// ClientID, TreeType, [SelectedItem]
MACRO lns_GetProductsTree(MacroParms)
  var 
      idx = 0,
      TreeType = MacroParms[1].Value,
      SelectedItem = NULL,
      tree = NULL,
      retVal = "";

    if (TreeType == NULL)
        TreeType = 1;
        GetRegistryValue ("RS-LOANS\\WEB\\ДЕРЕВО_ПРОДУКТОВ_КЛИЕНТА\\ВАРИАНТ_СПИСКА", V_INTEGER, TreeType, NULL);
    end;

    tree = CLnsProductTreeItem();
    tree.Childs = lns_GetClientProductsTree(MacroParms[0].Value, TreeType);

    if (MacroParms.size > 2)
        SelectedItem = MacroParms[2].Value
    end;

    if ((tree.Childs == NULL) or (tree.Childs.size == 0))
        retVal = 
"<TextBlock xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' TextWrapping='Wrap' Text='По заданным параметрам поиска не найдено ни одного продукта клиента!' Margin='5,5,5,5'/>";
    else
        retVal = retVal +
"<Grid x:Name='LayoutRoot'"
"    xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
"    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
"    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
"    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
"    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk' " +
"    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " + 
"    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
"    xmlns:Controls='clr-namespace:System.Windows.Controls;assembly=System.Windows.Controls' " +
"    xmlns:MEICore='clr-namespace:Microsoft.Expression.Interactivity.Core;assembly=Microsoft.Expression.Interactions' " +
"    xmlns:SWI='clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity' " +
"    xmlns:LnsWebControls='clr-namespace:Loans.LoansWebTools.Controls;assembly=LoansWebTools' " +
"    xmlns:LnsActions='clr-namespace:Loans.LoansWebTools.Actions;assembly=LoansWebTools' " +
"    xmlns:LnsBehaviors='clr-namespace:Loans.LoansWebTools.Behaviors;assembly=LoansWebTools' " +
"    xmlns:LnsMarkupExtensions='clr-namespace:Loans.LoansWebTools.MarkupExtensions;assembly=LoansWebTools' " +
"    xmlns:LnsClasses='clr-namespace:Loans.LoansWebTools.Classes;assembly=LoansWebTools' " +
"    xmlns:LnsMC='clr-namespace:Loans.LoansWebTools.Classes.MultiConverter;assembly=LoansWebTools' " +
"    xmlns:LnsInteractivity='clr-namespace:LoansWebTools.Classes.Interactivity;assembly=LoansWebTools' " +
"    xmlns:LnsConvert='clr-namespace:Loans.LoansWebTools.Converters;assembly=LoansWebTools' " +
"    xmlns:SysWin='clr-namespace:System.Windows;assembly=System.Windows' " +
"    xmlns:RsToolsUtils='clr-namespace:RsTools.Utils.MultiBinding;assembly=RsTools' " +
"    xmlns:Converter='clr-namespace:DataProvider.ViewModel.Helpers;assembly=DataProvider' " +
"    xmlns:LnsConverter='clr-namespace:Loans.LoansCommon.Helpers;assembly=LoansCommon' " +
"    xmlns:LnsCustomTypes='clr-namespace:Loans.LoansCommon.CustomTypes;assembly=LoansCommon' " +
"    xmlns:LnsCommonType='clr-namespace:Loans.LoansCommon.DataModel;assembly=LoansCommon' " +
"    xmlns:LnsCommon='clr-namespace:Loans.LoansCommon;assembly=LoansCommon' " +
">" +
"    <Grid.Resources>"+
"        <LnsConverter:MultiBindingVisibilityORConverter x:Key='MultiBindingVisibilityORConverter' /> " +
"        <LnsConverter:MultiBindingVisibilityANDConverter x:Key='MultiBindingVisibilityANDConverter' /> " +
"        <LnsConverter:MultiBindingBooleanORConverter x:Key='MultiBindingBooleanORConverter' /> " +
"        <LnsConverter:MultiBindingBooleanANDConverter x:Key='MultiBindingBooleanANDConverter' /> " +
"        <LnsConverter:BitANDConverter x:Key='BitANDConverter' /> " +
"        <LnsConverter:BitXORConverter x:Key='BitXORConverter' /> " +
"        <LnsConverter:IntToBoolConverter x:Key='IntToBoolConverter' /> " +
"        <LnsConverter:IntToBoolConverterNeg x:Key='IntToBoolConverterNeg' /> " +
"        <LnsConverter:SetValueConverter x:Key='SetValueConverter' /> " +
"        <Converter:BoolToVisibilityConverter x:Key='BoolToVisibilityConverter' /> " +
"        <Converter:BooleanNotConverter x:Key='BooleanNotConverter' /> " +
"        <LnsCommonType:LnsValueObject x:Key='ChildSelectedInited'>" +
"            <LnsCommonType:LnsValueObject.Value>" +
"                <System:Boolean>False</System:Boolean>" +
"            </LnsCommonType:LnsValueObject.Value>" +
"        </LnsCommonType:LnsValueObject>" +
"    </Grid.Resources>"+
"    <Grid x:Name='TreeSearchLabel' Visibility='Collapsed' Margin='5,5,5,5'>" +
"        <TextBlock Text='По заданным параметрам поиска не найдено ни одного продукта клиента!' Visibility='{Binding Value, Source={StaticResource ChildSelectedInited}, Converter={StaticResource BoolToVisibilityConverter}}'>" +
"            <SWI:Interaction.Triggers>" +
"                <MEICore:DataTrigger Binding='{Binding Visibility, ElementName=ProductTree}' Value='{LnsMarkupExtensions:Static Path=Visibility.Visible}'>" +
"                    <MEICore:ChangePropertyAction PropertyName='Visibility' TargetObject='{Binding ElementName=TreeSearchLabel}' Value='{LnsMarkupExtensions:Static Path=Visibility.Collapsed}'/>" +
"                </MEICore:DataTrigger>" +
"                <MEICore:DataTrigger Binding='{Binding Visibility, ElementName=ProductTree}' Value='{LnsMarkupExtensions:Static Path=Visibility.Collapsed}'>" +
"                    <MEICore:ChangePropertyAction PropertyName='Visibility' TargetObject='{Binding ElementName=TreeSearchLabel}' Value='{LnsMarkupExtensions:Static Path=Visibility.Visible}'/>" +
"                </MEICore:DataTrigger>" +
"            </SWI:Interaction.Triggers>" +
"        </TextBlock>" +
"    </Grid>"
"    <sdk:TreeView x:Name='ProductTree'>" +
"        <sdk:TreeView.Visibility>" +
    GetVisibility(tree, "tvi") +
"        </sdk:TreeView.Visibility>" +
    SerializeProductTree(tree.Childs, TreeType, "tvi") +
"    <SWI:Interaction.Behaviors> " +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='IsChildSelected'>" +
"            <LnsBehaviors:RegisterDependencyProperty.Binding>" +
    GetIsChildSelected(tree, "tvi") +
"            </LnsBehaviors:RegisterDependencyProperty.Binding> " +
"        </LnsBehaviors:RegisterDependencyProperty> " +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='Positioning' DefaultValue='{x:Null}'/>"
"    </SWI:Interaction.Behaviors>" +
"    </sdk:TreeView> " +
"    <SWI:Interaction.Behaviors> " +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='FastFilter'>" + //0 - скрыть все, 1 - черновики, 2 - договора, 4 - заявки, 8 - действующие, 16 - закрытые. Возможны битовые комбинации
"            <LnsBehaviors:RegisterDependencyProperty.DefaultValue> " +
"                <System:Int32>2147483647</System:Int32> "
"            </LnsBehaviors:RegisterDependencyProperty.DefaultValue> " +
"        </LnsBehaviors:RegisterDependencyProperty> " +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='StringFilter' DefaultValue='{x:Null}'/>"
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='ExpandLevel'>" + //0 - свернуть все, 1 - стадии заявки, 2 - заявка, 4 - ВК, 8 - КД, 16 - СО. Возможны битовые комбинации
"            <LnsBehaviors:RegisterDependencyProperty.DefaultValue> " +
"                <System:Int32>0</System:Int32> " +
"            </LnsBehaviors:RegisterDependencyProperty.DefaultValue> " +
"        </LnsBehaviors:RegisterDependencyProperty> " +
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='LnsObjID' DefaultValue='{x:Null}'/>"
"        <LnsBehaviors:RegisterDependencyProperty PropertyName='Positioning' DefaultValue='{x:Null}'>";
    if (SelectedItem != null)
        retVal = retVal +
"            <LnsBehaviors:RegisterDependencyProperty.Binding> " +
"                <LnsCustomTypes:LnsValueList>" +
"                    <LnsCommonType:LnsValueObject Value='1' />" +
"                    <LnsCommonType:LnsValueObject Value='" + String(SelectedItem.ObjID) + "' />" +
"                    <LnsCommonType:LnsValueObject Value='" + String(SelectedItem.ObjN) + "' />" +
"                </LnsCustomTypes:LnsValueList>" +
"            </LnsBehaviors:RegisterDependencyProperty.Binding> ";
    end;
    retVal = retVal +
"        </LnsBehaviors:RegisterDependencyProperty> " +
"    </SWI:Interaction.Behaviors>" +
"    <SWI:Interaction.Triggers>" +
"        <MEICore:PropertyChangedTrigger Binding='{Binding IsChildSelected, ElementName=ProductTree}'>" +
"            <SWI:Interaction.Behaviors>" +
"                <MEICore:ConditionBehavior>" +
"                    <MEICore:ConditionalExpression>" +
"                        <MEICore:ComparisonCondition LeftOperand='{Binding Value, Source={StaticResource ChildSelectedInited}}' Operator='Equal'>" +
"                            <MEICore:ComparisonCondition.RightOperand>" +
"                                <System:Boolean>False</System:Boolean>" +
"                            </MEICore:ComparisonCondition.RightOperand>" +
"                        </MEICore:ComparisonCondition>" +
"                    </MEICore:ConditionalExpression>" +
"                </MEICore:ConditionBehavior>" +
"            </SWI:Interaction.Behaviors>" +
"            <MEICore:ChangePropertyAction PropertyName='Value' TargetObject='{StaticResource ChildSelectedInited}'>" +
"                <MEICore:ChangePropertyAction.Value>" +
"                    <System:Boolean>True</System:Boolean>" +
"                </MEICore:ChangePropertyAction.Value>" +
"            </MEICore:ChangePropertyAction>" +
"            <LnsActions:SetBinding PropertyName='Positioning' TargetObject='{Binding ElementName=ProductTree}' Binding='{Binding Positioning, ElementName=LayoutRoot}' />" +
"        </MEICore:PropertyChangedTrigger>" +
"        <MEICore:DataTrigger Binding='{Binding SelectedItem, ElementName=ProductTree}' Value='{x:Null}'>" +
"            <LnsActions:SetBinding PropertyName='LnsObjID' Binding='{x:Null}' />" +
"        </MEICore:DataTrigger>" +
"    </SWI:Interaction.Triggers>" +
"</Grid>";
    end;

    return retVal;
END;

