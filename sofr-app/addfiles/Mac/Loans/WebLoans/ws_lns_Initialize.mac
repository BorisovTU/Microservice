/*
$Name: ws_lns_Initialize.mac
$Module: Кредитование
$Description: Инициализация  глобализмов Loans
*/

import BankInter, globals;

PRIVATE CONST TYPEOBJ_CREDITPARM = 968; // Вид объекта - параметры кредитного договора

PRIVATE CONST PRIV_MANAGE_CLAIM = 55;  // Управлять  заявками
PRIVATE CONST PRIV_INS_CREDIT   = 38;  // Вводить кредитный договор
PRIVATE CONST PRIV_CREDITPARM   = 37;  // Изменять параметры кредитного договора
PRIVATE CONST PRIV_DRAFTPARM    = 192; // Изменять параметры черновика КД


CLASS CLnsRegistryParm
    VAR ShowRegTabItemInEO   : bool;
    VAR ShowRegTabItemInWL   : bool;
    VAR ShowStageTabItemInEO : bool;
    VAR ShowStageTabItemInWL : bool;
    VAR AllowListSelect      : bool;
    VAR ProductTreeMode      : Integer;
    VAR ClaimTreeMode        : Integer;
    VAR ClaimTreeDate        : Date;
    VAR IsNBKI               : bool;
    VAR IsCRE                : bool;
END;

CLASS CLnsAccessParm
    var AllowInsCredit: bool;
    var AllowCreditFields = null;
    var AllowDraftFields = null;
    var AllowClaimFields = null;
END;

CLASS CLnsLicenseParm
END;

CLASS LoansGlobals                 // Глобализмы WebLoans
    var Registry = CLnsRegistryParm(); // параметры реестра
    var Access = CLnsAccessParm();     // параметры доступа
    var License = CLnsLicenseParm();   // лицензии
END;

MACRO GetRegistryParm()
    VAR result = CLnsRegistryParm();
    VAR regVal = true;
    VAR stat = 0;
    GetRegistryValue("COMMON\\ЕДИНОЕ ОКНО\\ИСТОРИЯ ОПЕРАЦИЙ_RS-LOANS\\ВКЛАДКА_РЕГИСТРЫ", V_BOOL, regVal, stat);
    if (stat == 0) result.ShowRegTabItemInEO = regVal; else result.ShowRegTabItemInEO = true; end;
    
    GetRegistryValue("RS-LOANS\\WEB\\ИСТОРИЯ_ОПЕРАЦИЙ\\ВКЛАДКА_РЕГИСТРЫ", V_BOOL, regVal, stat);
    if (stat == 0) result.ShowRegTabItemInWL = regVal; else result.ShowRegTabItemInWL = true; end;
    
    GetRegistryValue("COMMON\\ЕДИНОЕ ОКНО\\ИСТОРИЯ ОПЕРАЦИЙ_RS-LOANS\\ВКЛАДКА_СТАДИИ", V_BOOL, regVal, stat);
    if (stat == 0) result.ShowStageTabItemInEO = regVal; else result.ShowStageTabItemInEO = true; end;
    
    GetRegistryValue("RS-LOANS\\WEB\\ИСТОРИЯ_ОПЕРАЦИЙ\\ВКЛАДКА_СТАДИИ", V_BOOL, regVal, stat);
    if (stat == 0) result.ShowStageTabItemInWL = regVal; else result.ShowStageTabItemInWL = true; end;

    GetRegistryValue("RS-LOANS\\WEB\\ИДЕНТИФИКАЦИЯ КЛИЕНТА\\ВЫБОР ИЗ СПИСКА", V_BOOL, regVal, stat);
    if (stat == 0) result.AllowListSelect = regVal; else result.AllowListSelect = false; end;

    GetRegistryValue("RS-LOANS\\WEB\\ДЕРЕВО_ПРОДУКТОВ_КЛИЕНТА\\ВАРИАНТ_СПИСКА", V_INTEGER, regVal, stat);
    if (stat == 0) result.ProductTreeMode = regVal; else result.ProductTreeMode = 1; end;
    
    GetRegistryValue("RS-LOANS\\WEB\\ДЕРЕВО_ПРОДУКТОВ_КЛИЕНТА\\СПИСОК ЗАЯВОК", V_INTEGER, regVal, stat);
    if (stat == 0) result.ClaimTreeMode = regVal; else result.ClaimTreeMode = 1; end;
    
    GetRegistryValue("RS-LOANS\\WEB\\ДЕРЕВО_ПРОДУКТОВ_КЛИЕНТА\\ДАТА АРХИВА ЗАЯВОК", V_STRING, regVal, stat);
    if (stat == 0) result.ClaimTreeDate = Date(regVal); else result.ProductTreeMode = Date(0,0,0); end;

    GetRegistryValue("RS-LOANS\\ИСПОЛЬЗОВАНИЕ_ФУНКЦИОНАЛЬНОСТИ\\НБКИ", V_BOOL, regVal, stat);
    if (stat == 0) result.IsNBKI = regVal; else result.IsNBKI = false; end;

    GetRegistryValue("RS-LOANS\\ИСПОЛЬЗОВАНИЕ_ФУНКЦИОНАЛЬНОСТИ\\CRE", V_BOOL, regVal, stat);
    if (stat == 0) result.IsCRE = regVal; else result.IsCRE = false; end;

    return result;
END;

MACRO lns_GetAccessParm()
    var result = CLnsAccessParm();
    result.AllowInsCredit = (0 == ACS_CheckAccessForObject(PRIV_INS_CREDIT));
    result.AllowCreditFields = ACS_GetCompositRestriction(PRIV_CREDITPARM, TYPEOBJ_CREDITPARM, {oper});
    result.AllowDraftFields = ACS_GetCompositRestriction(PRIV_DRAFTPARM,  TYPEOBJ_CREDITPARM, {oper});
    return result;
END;

MACRO lns_GetLoansGlobals()
    var result = LoansGlobals();
    result.Registry = GetRegistryParm();
    result.Access = lns_GetAccessParm();
    // result.License информацию о лицензии пока не передаем.
    return result;
END;
