/*
$Name: ws_lns_Report.mac
$Module: WebLoans
$Description: Сервис источника данных для отчетов
*/
IMPORT SbCrdInter, RsbDataSet, RSD;
IMPORT "total.mac", "ws_file.mac", "ws_common.mac", "ws_report.mac", "lnsreportcore.mac";

PRIVATE CLASS CLnsReportItem
    var Name     = "";
    var Template = NULL;
    var Childs   = NULL;
END;

MACRO lns_GetReportsList(ObjID, ObjN, SysOpID)
   var
       result = TArray(),
       item = NULL, child = NULL,
       qStr = "", rs = NULL;

    if ((SysOpID != NULL)and(SysOpID > 0))
        if(ObjID == LO_CLAIM)
            qstr = " select * from dlobject_dbt lo, dlrobjtml_dbt lrobjtml, dLrSprTml_dbt tml, dclaim_dbt c ";
            qstr = qstr + " where  ";
            qstr = qstr + " (c.t_ClaimID = " + String(ObjN) + ") ";
            qstr = qstr + " and ((lo.t_ParentID = " + String(ObjID) + " and lo.t_Referens = c.t_CreditTypeID_Ref) or (lo.t_ObjectID = " + String(ObjID) + ")) ";
            qstr = qstr + " and (lrobjtml.t_ObjectID = lo.t_ObjectID) ";
            qstr = qstr + " and (lrobjtml.t_systemoperationid = " + SysOpID + ") ";
            qstr = qstr + " and (tml.t_TemplateID = lrobjtml.t_TemplateID) and (tml.t_IsVisible = 'X') and (tml.t_IsUseInWeb = 'X') ";
            qstr = qstr + " and (tml.t_TypeDebtor in (0, c.t_TypeDebtor)) ";
            qstr = qstr + " order by lrobjtml.t_Number";

            rs = TRsbDataSet(qStr);
            while (rs.moveNext())
                item = CLnsReportItem();
                item.Name   = rs.TmlName;
                item.Childs = NULL;

                item.Template = CLnsReportTemplate();
                item.Template.TemplateID = rs.TemplateID;
                item.Template.ObjID      = ObjID;
                item.Template.ObjN       = ObjN;
                item.Template.SysOpID    = SysOpID;

                result[result.size] = item;
            end;
        elif(ObjID == LO_CREDIT)
            qstr = " select * from dlobject_dbt lo, dlrobjtml_dbt lrobjtml, dLrSprTml_dbt tml, dcredit_c_dbt c ";
            qstr = qstr + " where  ";
            qstr = qstr + " ((c.t_Crd_Kind = " + String(ObjID) + ")and(c.t_CreditNumber = " + String(ObjN) + ")) ";
            qstr = qstr + " and ((lo.t_ParentID = " + String(ObjID) + " and lo.t_Referens = c.t_CreditTypeID_Ref) or (lo.t_ObjectID = " + String(ObjID) + ")) ";
            qstr = qstr + " and (lrobjtml.t_ObjectID = lo.t_ObjectID) ";
            qstr = qstr + " and (lrobjtml.t_systemoperationid = " + SysOpID + ") ";
            qstr = qstr + " and (tml.t_TemplateID = lrobjtml.t_TemplateID) and (tml.t_IsVisible = 'X') and (tml.t_IsUseInWeb = 'X') ";
            qstr = qstr + " and (tml.t_TypeDebtor in (0, c.t_TypeDebtor)) ";
            qstr = qstr + " order by lrobjtml.t_Number";

            rs = TRsbDataSet(qStr);
            while (rs.moveNext())
                item = CLnsReportItem();
                item.Name   = rs.TmlName;
                item.Childs = NULL;

                item.Template = CLnsReportTemplate();
                item.Template.TemplateID = rs.TemplateID;
                item.Template.ObjID      = ObjID;
                item.Template.ObjN       = ObjN;
                item.Template.SysOpID    = SysOpID;

                result[result.size] = item;
            end;
        else
            result = NULL;
        end;
    elif(ObjID == LO_CLAIM)
        item = CLnsReportItem();
        item.Name = "Заявка";
        item.Childs = TArray();            

        qstr = " select * from dlobject_dbt lo, dlrobjtml_dbt lrobjtml, dLrSprTml_dbt tml, dclaim_dbt c ";
        qstr = qstr + " where  ";
        qstr = qstr + " (c.t_ClaimID = " + String(ObjN) + ") ";
        qstr = qstr + " and ((lo.t_ParentID = " + String(ObjID) + " and lo.t_Referens = c.t_CreditTypeID_Ref) or (lo.t_ObjectID = " + String(ObjID) + ")) ";
        qstr = qstr + " and (lrobjtml.t_ObjectID = lo.t_ObjectID) ";
        qstr = qstr + " and (lrobjtml.t_systemoperationid = 0) ";
        qstr = qstr + " and (tml.t_TemplateID = lrobjtml.t_TemplateID) and (tml.t_IsVisible = 'X') and (tml.t_IsUseInWeb = 'X') ";
        qstr = qstr + " and (tml.t_TypeDebtor in (0, c.t_TypeDebtor)) ";
        qstr = qstr + " order by lrobjtml.t_Number";

        rs = TRsbDataSet(qStr);
        while (rs.moveNext())
            child = CLnsReportItem();
            child.Name   = rs.TmlName;
            child.Childs = NULL;

            child.Template = CLnsReportTemplate();
            child.Template.TemplateID = rs.TemplateID;
            child.Template.ObjID      = ObjID;
            child.Template.ObjN       = ObjN;
            child.Template.SysOpID    = 0;

            item.Childs[item.Childs.size] = child;
        end;

        if (item.Childs.size > 0)
            result[result.size] = item;
        end;
    elif(ObjID == LO_CREDIT)
        item = CLnsReportItem();
        item.Name = "Кредитный договор";
        item.Childs = TArray();            

        qstr = " select * from dlobject_dbt lo, dlrobjtml_dbt lrobjtml, dLrSprTml_dbt tml, dcredit_c_dbt c ";
        qstr = qstr + " where  ";
        qstr = qstr + " ((c.t_Crd_Kind = " + String(ObjID) + ")and(c.t_CreditNumber = " + String(ObjN) + ")) ";
        qstr = qstr + " and (c.t_CreditState not in ('З', 'Д')) ";
        qstr = qstr + " and ((lo.t_ParentID = " + String(ObjID) + " and lo.t_Referens = c.t_CreditTypeID_Ref) or (lo.t_ObjectID = " + String(ObjID) + ")) ";
        qstr = qstr + " and (lrobjtml.t_ObjectID = lo.t_ObjectID) ";
        qstr = qstr + " and (lrobjtml.t_systemoperationid = 0) ";
        qstr = qstr + " and (tml.t_TemplateID = lrobjtml.t_TemplateID) and (tml.t_IsVisible = 'X') and (tml.t_IsUseInWeb = 'X') ";
        qstr = qstr + " and (tml.t_TypeDebtor in (0, c.t_TypeDebtor)) ";
        qstr = qstr + " order by lrobjtml.t_Number";

        rs = TRsbDataSet(qStr);
        while (rs.moveNext())
            child = CLnsReportItem();
            child.Name   = rs.TmlName;
            child.Childs = NULL;

            child.Template = CLnsReportTemplate();
            child.Template.TemplateID = rs.TemplateID;
            child.Template.ObjID      = ObjID;
            child.Template.ObjN       = ObjN;
            child.Template.SysOpID    = 0;

            item.Childs[item.Childs.size] = child;
        end;

        if (item.Childs.size > 0)
            result[result.size] = item;
        end;
    else
        result = NULL;
    end;

    return result;
END;

MACRO lns_PrintReport(TemplateParm)
  var
      ResponseBuilder = WebResponseBuilder(),
      rep = NULL, msg = "";


    ReplaceMacro("MsgBox", "LnsReportMsgBox");
    ReplaceMacro("MsgBoxEx", "LnsReportMsgBox");
    rep = LnsPrintReportForTemplate(TemplateParm);
    ReplaceMacro("MsgBox", NULL);
    ReplaceMacro("MsgBoxEx", NULL);

    if (rep.UISession != NULL)
        rep.UISession.UISessionParm = NULL;
    end;

    ResponseBuilder.SetUserObject(rep);
    return ResponseBuilder.Result;
    
    OnError(err)
        if (trim(err.Message) != "")
            ResponseBuilder.AddErrorEx(err.Code, MessageSeverity.RuntimeError, trim(err.Message));
        end;
        return ResponseBuilder.Result;
END;