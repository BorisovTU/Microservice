/*
$Name: ws_lns_GraphChartWindow.mac
$Module: WebLoans
$Description: Сервис получения информации по графикам
*/
IMPORT "ws_lns_CommonLib.mac", "ws_lns_Graph.mac";

PRIVATE MACRO MakeWindowTitle(SimpleObjectData)
  var
      retVal = "";

    if (SimpleObjectData != NULL)
        retVal = "График погашения по: ";
        if ((SimpleObjectData == "Ч")OR(SimpleObjectData == "Д"))
            retVal = retVal + SimpleObjectData.StateName + " " + SimpleObjectData.ShortName
        else
            retVal = retVal + SimpleObjectData.Name;
        end;
        retVal = retVal + " №" + SimpleObjectData.Number;
    end;

    RETURN retVal;
END;

MACRO lns_GraphChartWindow(MacroParms)
  var
      SimpleObjectData = lns_GetSimpleObjectData(MacroParms[0].Value.ObjID, MacroParms[0].Value.ObjN),
      Title = MakeWindowTitle(SimpleObjectData),
      Data = lns_GetSchedData(MacroParms[0].Value.ObjID, MacroParms[0].Value.ObjN),
      idx = 0,
      str = 
"<RsControls:RsFloatingWindow " +
"    xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
"    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
"    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
"    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
"    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk' " +
"    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " +
"    xmlns:RsControls='clr-namespace:RsControls;assembly=RsControls' " +
"    xmlns:DVC='clr-namespace:System.Windows.Controls.DataVisualization.Charting;assembly=System.Windows.Controls.DataVisualization.Toolkit' " +
"    xmlns:Converter='clr-namespace:DataProvider.ViewModel.Helpers;assembly=DataProvider' " +
"    xmlns:LnsConverter='clr-namespace:Loans.LoansCommon.Helpers;assembly=LoansCommon' " +
"    xmlns:RsToolsUtils='clr-namespace:RsTools.Utils.MultiBinding;assembly=RsTools' " +
"    xmlns:RsTools='clr-namespace:RsTools;assembly=RsTools' " +
"    xmlns:LnsCustomTypes='clr-namespace:Loans.LoansCommon.CustomTypes;assembly=LoansCommon' " +
"    xmlns:LnsCommonType='clr-namespace:Loans.LoansCommon.DataModel;assembly=LoansCommon' " +
"    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
"    mc:Ignorable='d'" +
"    d:DesignHeight='400' d:DesignWidth='600'" +
"    x:Name='rootElement'" +
"    HelpPath='HelpRSBankWeb.html?lnsGraphTab_Diagram.htm'" +
"    Title='" + Title + "'" +
">" +
"    <RsControls:RsFloatingWindow.Resources>" +
"        <Converter:MoneyConverter x:Key='MoneyConverter'/>" +
"        <Converter:DateTimeToStringConverter x:Key='DateTimeToStringConverter'/>" +
"        <Converter:BoolToVisibilityConverter x:Key='BoolToVisibilityConverter'/>" +
"        <LnsConverter:MoneyToDoubleConverter x:Key='MoneyToDoubleConverter'/>" +
"        <LnsConverter:StringToIntConverter x:Key='StringToIntConverter'/>" +
"        <LnsConverter:LnsValueListConverter x:Key='LnsValueListConverter'/>" +
"        <System:Int32 x:Key='PayDate_field'>" + String(1) + "</System:Int32>" +
"        <LnsCommonType:LnsValueObject x:Key='ChartData'>" +
"            <LnsCommonType:LnsValueObject.Value>" +
"                <LnsCustomTypes:LnsValueList>" +
"                    <LnsCommonType:LnsValueObject ValueName='CurCode'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <System:String>" + String(Data.CurCode) + "</System:String>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='Duration'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <System:String>" + String(Data.Duration) + "</System:String>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='TariffRate'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <System:Double>" + String(Data.TariffRate) + "</System:Double>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='SchedType'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <System:String>" + String(Data.SchedType) + "</System:String>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='IsAnnuity'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <System:Boolean>" + String(Data.IsAnnuity) + "</System:Boolean>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='PieSeries'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <LnsCustomTypes:LnsValueList>" +
"                                <LnsCommonType:LnsValueObject ValueName='Сумма кредита'>" +
"                                    <LnsCommonType:LnsValueObject.Value>" +
"                                        <RsTools:Money>" + String(Data.SumRest) + "</RsTools:Money>" +
"                                    </LnsCommonType:LnsValueObject.Value>" +
"                                </LnsCommonType:LnsValueObject>" +
"                                <LnsCommonType:LnsValueObject ValueName='Сумма переплаты'>" +
"                                    <LnsCommonType:LnsValueObject.Value>" +
"                                        <RsTools:Money>" + String(Data.SumPerc) + "</RsTools:Money>" +
"                                    </LnsCommonType:LnsValueObject.Value>" +
"                                </LnsCommonType:LnsValueObject>" +
"                            </LnsCustomTypes:LnsValueList>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='SumTotal'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <RsTools:Money>" + String(Data.SumTotal) + "</RsTools:Money>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                    <LnsCommonType:LnsValueObject ValueName='PaySched'>" +
"                        <LnsCommonType:LnsValueObject.Value>";
    if (Data.PaySched.size > 0)
        str = str +
"                            <LnsCustomTypes:LnsValueList>";
        while (idx < Data.PaySched.size)
            str = str +
"                                <LnsCommonType:LnsValueObject>" +
"                                    <LnsCommonType:LnsValueObject.Value>" +
"                                        <LnsCustomTypes:LnsValueList>" +
"                                            <LnsCommonType:LnsValueObject ValueName='PeriodNum'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <System:Int32>" + String(idx) + "</System:Int32>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='PayDate'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <System:String>" + String(Data.PaySched[idx].PayDate:f) + "</System:String>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='SumRest'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(Data.PaySched[idx].SumRest) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='SumPerc'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(Data.PaySched[idx].SumPerc) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                            <LnsCommonType:LnsValueObject ValueName='SumTotal'>" +
"                                                <LnsCommonType:LnsValueObject.Value>" +
"                                                    <RsTools:Money>" + String(Data.PaySched[idx].SumTotal) + "</RsTools:Money>" +
"                                                </LnsCommonType:LnsValueObject.Value>" +
"                                            </LnsCommonType:LnsValueObject>" +
"                                        </LnsCustomTypes:LnsValueList>" +
"                                    </LnsCommonType:LnsValueObject.Value>" +
"                                </LnsCommonType:LnsValueObject>";
            idx = idx + 1;
        end;

        str = str +
"                            </LnsCustomTypes:LnsValueList>";
    end;
        str = str +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
"                </LnsCustomTypes:LnsValueList>" +
"            </LnsCommonType:LnsValueObject.Value>" +
"        </LnsCommonType:LnsValueObject>" +
"        <System:Int32 x:Key='PaySched_lastID'>" + String(idx-1) + "</System:Int32>" +
"   	<toolkit:ResourceDictionaryCollection x:Key='Palette_Loans'>" +
"					<!-- Голубой -->" +
"					<ResourceDictionary>" +
"						<SolidColorBrush x:Key='Background' Color='#FF4198AF' />" +
"						<Style x:Key='DataPointStyle' TargetType='Control'>" +
"							<Setter Property='Background' Value='{StaticResource Background}'/>" +
"						</Style>" +
"						<Style x:Key='DataShapeStyle' TargetType='Shape'>" +
"							<Setter Property='Stroke' Value='{StaticResource Background}'/>" +
"							<Setter Property='StrokeThickness' Value='2'/>" +
"							<Setter Property='StrokeMiterLimit' Value='1'/>" +
"							<Setter Property='Fill' Value='{StaticResource Background}'/>" +
"						</Style>" +
"					</ResourceDictionary>" +
"					<!-- Оранжевый -->" +
"					<ResourceDictionary>" +
"						<SolidColorBrush x:Key='Background' Color='#FFDB843D' />" +
"						<Style x:Key='DataPointStyle' TargetType='Control'>" +
"							<Setter Property='Background' Value='{StaticResource Background}'/>" +
"						</Style>" +
"						<Style x:Key='DataShapeStyle' TargetType='Shape'>" +
"							<Setter Property='Stroke' Value='{StaticResource Background}'/>" +
"							<Setter Property='StrokeThickness' Value='2'/>" +
"							<Setter Property='StrokeMiterLimit' Value='1'/>" +
"							<Setter Property='Fill' Value='{StaticResource Background}'/>" +
"						</Style>" +
"					</ResourceDictionary>" +
"	</toolkit:ResourceDictionaryCollection>" +
"    </RsControls:RsFloatingWindow.Resources>" +
"    <ScrollViewer VerticalScrollBarVisibility='Auto' HorizontalScrollBarVisibility='Auto' Padding='10'>" +
"        <Grid x:Name='LayoutRoot' Background='#FFFDFBFB'>" +
"                <Grid.RowDefinitions>" +
"                    <RowDefinition Height='Auto'/>" +
"                    <RowDefinition Height='5'/>" +
"                    <RowDefinition Height='Auto'/>" +
"                </Grid.RowDefinitions>" +
"            <Grid Grid.Row='0'>" +
"                <Grid.ColumnDefinitions>" +
"                    <ColumnDefinition Width='Auto'/>" +
"                    <ColumnDefinition Width='6'/>" +
"                    <ColumnDefinition Width='Auto'/>" +
"                </Grid.ColumnDefinitions>" +
"                <RsControls:GroupBox Header='Параметры графика погашения' Grid.Row='0' Grid.Column='0' d:LayoutOverrides='Height' Margin='0'>" +
"                    <Grid>" +
"                        <Grid.ColumnDefinitions>" +
"                            <ColumnDefinition Width='Auto'/>" +
"                            <ColumnDefinition Width='6'/>" +
"                            <ColumnDefinition Width='*'/>" +
"                        </Grid.ColumnDefinitions>" +
"                        <Grid.RowDefinitions>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='Auto'/>" +
"                            <RowDefinition Height='*'/>" +
"                        </Grid.RowDefinitions>" +
"                        <TextBlock Text='Сумма кредита:' Grid.Row='0' Margin='0,0,0,0'/>" +
"                        <Grid Grid.Row='0' Grid.Column='2' Margin='0,0,0,0'>" +
"                            <Grid.ColumnDefinitions>" +
"                                <ColumnDefinition Width='Auto'/>" +
"                                <ColumnDefinition Width='5'/>" +
"                                <ColumnDefinition Width='*'/>" +
"                            </Grid.ColumnDefinitions>" +
"                            <TextBlock Text='{Binding Value[5].Value[0].Value, Source={StaticResource ChartData}, Converter={StaticResource MoneyConverter}, ConverterParameter=C2}' />" +
"                            <TextBlock Text='{Binding Value[0].Value, Source={StaticResource ChartData}}' Grid.Column='2' />" +
"                        </Grid>" +
"                        <TextBlock Text='Срок кредита:' Grid.Row='1' Margin='0,5,0,0'/>" +
"                        <TextBlock Text='{Binding Value[1].Value, Source={StaticResource ChartData}}' Grid.Row='1' Grid.Column='2' Margin='0,5,0,0'/>" +
"                        <TextBlock Text='Процентная ставка:' Grid.Row='2' Margin='0,5,0,0'/>" +
"                        <Grid Grid.Row='2' Grid.Column='2' Margin='0,5,0,0'>" +
"                            <Grid.ColumnDefinitions>" +
"                                <ColumnDefinition Width='Auto'/>" +
"                                <ColumnDefinition Width='*'/>" +
"                            </Grid.ColumnDefinitions>" +
"                            <TextBlock Text='{Binding Value[2].Value, Source={StaticResource ChartData}}' />" +
"                            <TextBlock Text='%' Grid.Column='2' />" +
"                        </Grid>" +
"                        <TextBlock Text='График погашения:' Grid.Row='3' Margin='0,5,0,0'/>" +					
"                        <TextBlock Text='{Binding Value[3].Value, Source={StaticResource ChartData}}' Grid.Row='3' Grid.Column='2' Margin='0,5,0,0'/>" +
"                        <TextBlock Text='Ежемесячный платеж:' Visibility='{Binding Value[4].Value, Source={StaticResource ChartData}, Converter={StaticResource BoolToVisibilityConverter}}' Grid.Row='4' Margin='0,5,0,0'/>" +
"                        <Grid Grid.Row='4' Grid.Column='2' Visibility='{Binding Value[4].Value, Source={StaticResource ChartData}, Converter={StaticResource BoolToVisibilityConverter}}' Margin='0,5,0,0'>" +
"                            <Grid.ColumnDefinitions>" +
"                                <ColumnDefinition Width='Auto'/>" +
"                                <ColumnDefinition Width='5'/>" +
"                                <ColumnDefinition Width='*'/>" +
"                            </Grid.ColumnDefinitions>" +
"                            <TextBlock Text='{Binding Value[7].Value[0].Value[4].Value, Source={StaticResource ChartData}, Converter={StaticResource MoneyConverter}, ConverterParameter=C2}' />" +
"                            <TextBlock Text='{Binding Value[0].Value, Source={StaticResource ChartData}}' Grid.Column='2' />" +
"                        </Grid>" +
"                        <TextBlock Text='Начало выплат:' Grid.Row='5' Margin='0,5,0,0'/>" +
"                        <TextBlock Text='{Binding Value[7].Value[0].Value[1].Value, Source={StaticResource ChartData}}' Grid.Row='5' Grid.Column='2' Margin='0,5,0,0' />" +
"                        <TextBlock Text='Окончание выплат:' Grid.Row='6' Margin='0,5,0,0'/>" +
"                        <TextBlock Grid.Row='6' Grid.Column='2' Margin='0,5,0,0' " +
"                                   Text='{RsToolsUtils:MultiBinding Source1={Binding Value[7].Value, Source={StaticResource ChartData}}," +
"                                                                    Source2={Binding Source={StaticResource PaySched_lastID}}," +
"                                                                    Source3={Binding Source={StaticResource PayDate_field}}," +
"                                                                    Converter={StaticResource LnsValueListConverter}}' />" +
"                        <TextBlock Text='Общая сумма выплат:' Grid.Row='7' Margin='0,5,0,0'/>" +					
"                        <Grid Grid.Row='7' Grid.Column='2' Margin='0,5,0,0'>" +
"                            <Grid.ColumnDefinitions>" +
"                                <ColumnDefinition Width='Auto'/>" +
"                                <ColumnDefinition Width='5'/>" +
"                                <ColumnDefinition Width='*'/>" +
"                            </Grid.ColumnDefinitions>" +
"                            <TextBlock Text='{Binding Value[6].Value, Source={StaticResource ChartData}, Converter={StaticResource MoneyConverter}, ConverterParameter=C2}' />" +
"                            <TextBlock Text='{Binding Value[0].Value, Source={StaticResource ChartData}}' Grid.Column='2' />" +
"                        </Grid>" +
"                        <TextBlock Text='Общая сумма переплаты:' Grid.Row='8' Margin='0,5,0,0'/>" +					
"                        <Grid Grid.Row='8' Grid.Column='2' Margin='0,5,0,0'>" +
"                            <Grid.ColumnDefinitions>" +
"                                <ColumnDefinition Width='Auto'/>" +
"                                <ColumnDefinition Width='5'/>" +
"                                <ColumnDefinition Width='*'/>" +
"                            </Grid.ColumnDefinitions>" +
"                            <TextBlock Text='{Binding Value[5].Value[1].Value, Source={StaticResource ChartData}, Converter={StaticResource MoneyConverter}, ConverterParameter=C2}' />" +
"                            <TextBlock Text='{Binding Value[0].Value, Source={StaticResource ChartData}}' Grid.Column='2' />" +
"                        </Grid>" +
"                    </Grid>" +
"                </RsControls:GroupBox>" +
"                <RsControls:RsChart Grid.Row='0' Grid.Column='2' x:Name='PieChart' MinWidth='400' Title='Соотношение переплаты и суммы кредита' " +
"                                    d:LayoutOverrides='Height' Margin='0'" +
"                                Palette='{StaticResource Palette_Loans}'>" +
"                    <DVC:PieSeries ItemsSource='{Binding Value[5].Value, Source={StaticResource ChartData}}'" +
"                                   IndependentValueBinding='{Binding Path=ValueName}'" +
"                                   DependentValueBinding='{Binding Path=Value, Converter={StaticResource MoneyToDoubleConverter}}'/>" +
"                </RsControls:RsChart>" +
"            </Grid>" +
"            <RsControls:RsChart IsPrintButtonVisible='True' " +
"                                IsScalingEnabled='True' " +
"                                Title='График погашения основного долга и процентов' " +
"                                Grid.Row='2' " +
"                                Grid.ColumnSpan='3' " +
"                                Margin='0' " +
"                                MinHeight='400'" +
"                                Palette='{StaticResource Palette_Loans}'>" +
"                <DVC:StackedColumnSeries x:Name='StackChart'>" +
"                    <DVC:StackedColumnSeries.DependentAxis>" +
"                        <DVC:LinearAxis Orientation='Y' Minimum='0'/>" +
"                    </DVC:StackedColumnSeries.DependentAxis>" +
"                  <DVC:StackedColumnSeries.IndependentAxis>" +
"                      <DVC:LinearAxis Orientation='X' Interval='1'>" +
"                          <DVC:LinearAxis.AxisLabelStyle>" +
"                              <Style TargetType='DVC:NumericAxisLabel'>" +
"                                  <Setter Property='Template'>" +
"                                      <Setter.Value>" +
"                                          <ControlTemplate TargetType='toolkit:NumericAxisLabel'>" +
"                                              <toolkit:LayoutTransformer HorizontalAlignment='Left' VerticalAlignment='Center'>" +
"                                                  <toolkit:LayoutTransformer.LayoutTransform>" +
"                                                      <RotateTransform Angle='-90'/>" +
"                                                  </toolkit:LayoutTransformer.LayoutTransform>" +
"                                                  <TextBlock Text='{RsToolsUtils:MultiBinding Source1={Binding Value[7].Value, Source={StaticResource ChartData}}," +
"                                                                                              Source2={Binding FormattedContent, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource StringToIntConverter}}," +
"                                                                                              Source3={Binding Source={StaticResource PayDate_field}}," +
"                                                                                              Converter={StaticResource LnsValueListConverter}}' />" +
"                                              </toolkit:LayoutTransformer>" +
"                                          </ControlTemplate>" +
"                                      </Setter.Value>" +
"                                  </Setter>" +
"                              </Style>" +
"                          </DVC:LinearAxis.AxisLabelStyle>" +
"                      </DVC:LinearAxis>" +
"                  </DVC:StackedColumnSeries.IndependentAxis>" +
"                  <DVC:SeriesDefinition Title='Погашение ОД, " + String(Data.CurCode) + "' " +
"                                        ItemsSource='{Binding Value[7].Value, Source={StaticResource ChartData}}' " +
"                                        IndependentValueBinding='{Binding Value[0].Value}' " +
"                                        DependentValueBinding='{Binding Value[2].Value}' />" +
"                  <DVC:SeriesDefinition Title='Сумма срочных %%, " + String(Data.CurCode) + "' " +
"                                        ItemsSource='{Binding Value[7].Value, Source={StaticResource ChartData}}' " +
"                                        IndependentValueBinding='{Binding Value[0].Value}' " +
"                                        DependentValueBinding='{Binding Value[3].Value}' />" +
"                </DVC:StackedColumnSeries>" +
"            </RsControls:RsChart>" +
"        </Grid>" +
"    </ScrollViewer>" +
"</RsControls:RsFloatingWindow>";

    return str;
END;
