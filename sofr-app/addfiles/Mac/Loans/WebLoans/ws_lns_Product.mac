/*
$Name: ws_lns_Product.mac
$Module: WebLoans
$Description: Сервис источника данных рабочей области по продукту
*/
IMPORT SbCrdInter, RsbDataSet, total, ws_lns_CommonLib;
IMPORT "ws_lns_tariff.mac", "ws_lns_Graph.mac", "ws_lns_Account.mac", "ws_lns_CrdContract.mac",
       "ws_lns_Card.mac",
       "ws_lns_Registers.mac", "ws_lns_ActionsTree.mac", "ws_lns_Report.mac", "ws_lns_Duty.mac", 
       "ws_lns_UserFields.mac", "ws_lns_Claim.mac", "ws_lns_limits.mac", "ws_lns_ClaimGuarantee.mac";

PRIVATE CONST
    CONTENT_INDEX_CONTRACT     = 1,
    CONTENT_INDEX_TARIFFS      = 2,
    CONTENT_INDEX_GRAPHS       = 3,
    CONTENT_INDEX_ACCOUNTS     = 4,
    CONTENT_INDEX_REGISTERS    = 5,
    CONTENT_INDEX_REPORTS      = 6,
    CONTENT_INDEX_DUTY         = 7,
    CONTENT_INDEX_DUTYACCOUNTS = 8,
    CONTENT_INDEX_USERFIELDS   = 9,
    CONTENT_INDEX_LIMITS       = 10,
    CONTENT_INDEX_CLAIM        = 11,
    CONTENT_INDEX_ENS          = 12,
    CONTENT_INDEX_OLDCLAIM     = 13,
    CONTENT_INDEX_CLAIMGRAPHS  = 14,
    CONTENT_INDEX_CLAIMGUARANTEE  = 15;

CLASS CLnsProductItem
    var Name         = "";
    var ContentIndex = 0;
    var GroupAction  = 0;
END;

PRIVATE MACRO FillItem(Name, ContentIndex, GroupAction)
    var item = CLnsProductItem();
    item.Name = Name;
    item.ContentIndex = ContentIndex;
    item.GroupAction = GroupAction;
    return item;
END;

PRIVATE MACRO ContractItem()
    return FillItem("Договор", CONTENT_INDEX_CONTRACT, CONTENT_INDEX_CONTRACT);
END;
PRIVATE MACRO TariffsItem()
    return FillItem("Тарифы", CONTENT_INDEX_TARIFFS, CONTENT_INDEX_TARIFFS);
END;
PRIVATE MACRO GraphsItem()
    return FillItem("Графики", CONTENT_INDEX_GRAPHS, CONTENT_INDEX_GRAPHS);
END;
PRIVATE MACRO AccountsItem()
    return FillItem("Счета", CONTENT_INDEX_ACCOUNTS, CONTENT_INDEX_ACCOUNTS);
END;
PRIVATE MACRO RegistersItem()
    return FillItem("Регистры", CONTENT_INDEX_REGISTERS, CONTENT_INDEX_REGISTERS);
END;
PRIVATE MACRO ReportsItem()
    return FillItem("Печать", CONTENT_INDEX_REPORTS, CONTENT_INDEX_REPORTS);
END;
PRIVATE MACRO DutyItem()
    return FillItem("Обязательство", CONTENT_INDEX_DUTY, CONTENT_INDEX_DUTY);
END;
PRIVATE MACRO DutyAccountsItem()
    return FillItem("Счета", CONTENT_INDEX_DUTYACCOUNTS, CONTENT_INDEX_DUTYACCOUNTS);
END;
PRIVATE MACRO UserFieldsItem(mode)
    if (mode == 0)
        return FillItem("Пользовательские поля", CONTENT_INDEX_USERFIELDS, 0);
    else
        return FillItem("Доп. данные", CONTENT_INDEX_USERFIELDS, 0);
    end;
END;
PRIVATE MACRO LimitsItem()
    return FillItem("Лимиты", CONTENT_INDEX_LIMITS, CONTENT_INDEX_LIMITS);
END;
PRIVATE MACRO ClaimItem()
    return FillItem("Заявка", CONTENT_INDEX_CLAIM, 1);
END;
PRIVATE MACRO ClaimGuaranteeItem()
    return FillItem("Заявка", CONTENT_INDEX_CLAIMGUARANTEE, 1);
END;
PRIVATE MACRO EnsItem()
    return FillItem("Обеспечение", CONTENT_INDEX_ENS, CONTENT_INDEX_ENS);
END;
PRIVATE MACRO OldClaimItem()
    return FillItem("Заявка", CONTENT_INDEX_OLDCLAIM, 0);
END;
PRIVATE MACRO ClaimGraphsItem()
    return FillItem("График", CONTENT_INDEX_CLAIMGRAPHS, CONTENT_INDEX_CLAIMGRAPHS);
END;


MACRO lns_GetItemSource(ObjID, ObjN)
    var result = TArray();
    var item = NULL;
    var rs = NULL;
    var CrdState = "";
    var DutyState = "";
    var qStr = "";
    if ((ObjID == LO_CREDIT) or (ObjID == LO_KARTA))
        
        qStr = "select * from dcredit_c_dbt credit ";
        qStr  = qStr + "where  credit.t_CreditNumber = " + ObjN + " and credit.t_Crd_Kind = "+ ObjID;
        rs = TRsbDataSet(qStr);
        if (rs.moveNext())
            CrdState = String(rs.CreditState);

            result[result.size] = ContractItem();
            result[result.size] = TariffsItem();

            result[result.size] = GraphsItem();
            
            result[result.size] = AccountsItem();

            if (CrdState == "О")
                result[result.size] = RegistersItem();
                result[result.size] = ReportsItem();
            elif (CrdState == "З")
                result[result.size] = RegistersItem();
            elif (CrdState == "Ч")
                result[result.size] = ReportsItem();
            else
                ;
            end;
            
            if ((rs.PayType == CF_CRLIN) or (rs.PayType == CF_CRLINNEW) or (rs.PayType == CF_CRLINNO))
                result[result.size] = LimitsItem();
            end;
                
            result[result.size] = UserFieldsItem();
        end;
    elif (ObjID == LO_DUTY) // срочное обязательство
        DutyState = LnSelectValue("select t_dutystate from dduty_crd_dbt where t_dutyid = " + ObjN, V_STRING, 0);
        result[result.size] = DutyItem();
        result[result.size] = TariffsItem();
        if (DutyState == "О")
            result[result.size] = GraphsItem();
        end;
        result[result.size] = DutyAccountsItem();
        result[result.size] = RegistersItem();
    elif (ObjID == LO_CLAIM) // заявка
        if (GetClaimType(ObjN) == LNS_MT_WEBCREDIT)
            if (LnSelectValue("select t_claimKind from dclaim_dbt where t_claimid = " + ObjN, V_INTEGER, 0) == 3)
                result[result.size] = ClaimGuaranteeItem();
                result[result.size] = TariffsItem();
                //result[result.size] = ClaimGraphsItem();
                result[result.size] = EnsItem();
                result[result.size] = ReportsItem();
                result[result.size] = UserFieldsItem(1);
            else
                result[result.size] = ClaimItem();
                result[result.size] = TariffsItem();
                result[result.size] = ClaimGraphsItem();
                result[result.size] = EnsItem();
                result[result.size] = ReportsItem();
                result[result.size] = UserFieldsItem(1);
            end;
        else
            result[result.size] = OldClaimItem();
            result[result.size] = TariffsItem();
            result[result.size] = ReportsItem();
            result[result.size] = UserFieldsItem(1);
        end;
    end;

    return result;
END;

// получение объектов

CLASS LnsObject
  var
      ObjID = 0,
      ObjN  = 0;
END;

CLASS LnsObject_LO_CREDIT
    var LnsObjID       = LnsObject(),
        Credit_c       = NULL,
        viewPrm        = NULL,
        tariffs        = NULL,
        DefaultGraph   =   -2, // -2 - список графиков по объекту
        graph          = NULL,
        accounts       = NULL,
        spiaccounts    = NULL,
        resaccounts    = NULL,
        registers      = NULL,
        reports        = NULL,
        Actions        = NULL,
        userfields     = NULL,
        limits         = NULL;
END;

CLASS LnsObject_LO_KARTA
    var LnsObjID       = LnsObject(),
        Credit_c       = NULL,
        viewPrm        = NULL,
        tariffs        = NULL,
        DefaultGraph=   -2, // -2 - список графиков по объекту
        graph          = NULL,
        accounts       = NULL,
        spiaccounts    = NULL,
        resaccounts    = NULL,
        registers      = NULL,
        reports        = NULL,
        Actions        = NULL,
        userfields     = NULL,
        limits         = NULL;
END;

CLASS LnsObject_LO_DUTY
    var LnsObjID    = LnsObject(),
        DutyViewPrm = NULL,
        tariffs     = NULL,
        DefaultGraph=   -2, // -2 - список графиков по объекту
        graph       = NULL,
        accounts    = NULL,
        registers   = NULL,
        Actions     = NULL;
END;

CLASS LnsObject_LO_CLAIM
    var LnsObjID     = LnsObject(),
        ClaimViewPrm = NULL,
        ClaimEditPrm = NULL,
        tariffs      = NULL,
        reports      = NULL,
        userfields   = NULL,
        ClaimGuaranteeViewPrm = NULL,
        ClaimGuaranteeEditPrm = NULL;
END;

MACRO lns_getLO_CREDIT(ObjN, ClientID)
  var
    LnsObject = LnsObject_LO_CREDIT();

    LnsObject.LnsObjID.ObjID = LO_CREDIT;
    LnsObject.LnsObjID.ObjN  = ObjN;
    LnsObject.Credit_c       = lns_GetCredit_c(ObjN);
    LnsObject.viewPrm        = lns_GetViewPrm(ObjN, ClientID);
    LnsObject.tariffs        = lns_usratelist(LO_CREDIT, ObjN);
    LnsObject.DefaultGraph   = lns_GetDefaultGraphID(LO_CREDIT, ObjN);
    //LnsObject.graph          = ws_lns_GetCompleteGraphList(LO_CREDIT, ObjN);
    LnsObject.accounts       = lns_AccountList(LO_CREDIT, ObjN, NULL);
    LnsObject.spiaccounts    = lns_SPIAccountList(LO_CREDIT, ObjN);
    LnsObject.resaccounts    = lns_ResAccountList(LO_CREDIT, ObjN, NULL);
    LnsObject.registers      = lns_regrestlist(LO_CREDIT, ObjN, NULL);
    LnsObject.reports        = lns_GetReportsList(LO_CREDIT, ObjN, 0);
    LnsObject.Actions        = lns_GetActionsTree(LO_CREDIT, ObjN);
    LnsObject.userfields     = lns_getuflist(LO_CREDIT, ObjN);
    LnsObject.limits         = lns_getLimitHistory(LO_CREDIT, ObjN, NULL);

    return LnsObject;
END;

MACRO lns_getLO_KARTA(ObjN, ClientID)
  var
    LnsObject = LnsObject_LO_KARTA();
    LnsObject.LnsObjID.ObjID = LO_KARTA;
    LnsObject.LnsObjID.ObjN  = ObjN;
    LnsObject.Credit_c       = lns_GetCredit_c_Card(ObjN);

    LnsObject.viewPrm        = lns_GetViewPrmCard(ObjN, ClientID);

     LnsObject.tariffs        = lns_usratelist(LO_KARTA, ObjN);
     LnsObject.DefaultGraph   = lns_GetDefaultGraphID(LO_CREDIT, ObjN);
     //LnsObject.graph          = ws_lns_GetCompleteGraphList(LO_KARTA, ObjN);
     LnsObject.accounts       = lns_AccountList(LO_KARTA, ObjN, NULL);
     LnsObject.spiaccounts    = lns_SPIAccountList(LO_KARTA, ObjN);
     LnsObject.resaccounts    = lns_ResAccountList(LO_KARTA, ObjN, NULL);
     LnsObject.registers      = lns_regrestlist(LO_KARTA, ObjN, NULL);
     LnsObject.reports        = lns_GetReportsList(LO_KARTA, ObjN, 0);    
     LnsObject.Actions        = lns_GetActionsTree(LO_KARTA, ObjN);
     LnsObject.userfields     = lns_getuflist(LO_KARTA, ObjN);
     LnsObject.limits         = lns_getLimitHistory(LO_KARTA, ObjN, NULL);
    
    return LnsObject;
END;

MACRO lns_getLO_DUTY(ObjN)
    var LnsObject = LnsObject_LO_DUTY();
    LnsObject.LnsObjID.ObjID = LO_DUTY;
    LnsObject.LnsObjID.ObjN  = ObjN;
    LnsObject.DutyViewPrm    = lns_GetDutyViewPrm(ObjN);
    LnsObject.tariffs        = lns_usratelist(LO_DUTY, ObjN);
    LnsObject.DefaultGraph   = lns_GetDefaultGraphID(LO_DUTY, ObjN);
    //LnsObject.graph          = ws_lns_GetCompleteGraphList(LO_DUTY, ObjN);
    LnsObject.accounts       = lns_AccountList(LO_DUTY, ObjN, NULL);
    LnsObject.registers      = lns_regrestlist(LO_DUTY, ObjN, NULL);
    LnsObject.Actions        = lns_GetActionsTree(LO_DUTY, ObjN);
    return LnsObject;
END;

MACRO lns_getLO_CLAIM(ObjN)
    var LnsObject = LnsObject_LO_CLAIM();
    LnsObject.LnsObjID.ObjID = LO_CLAIM;
    LnsObject.LnsObjID.ObjN  = ObjN;
    LnsObject.ClaimViewPrm   = lns_GetClaimViewPrm(ObjN);
    LnsObject.ClaimEditPrm   = lns_GetClaimEditPrm(ObjN);
    LnsObject.tariffs        = lns_usratelist(LO_CLAIM, ObjN);
    LnsObject.reports        = lns_GetReportsList(LO_CLAIM, ObjN, 0);
    LnsObject.userfields     = lns_getuflist(LO_CLAIM, ObjN);
    LnsObject.ClaimGuaranteeViewPrm = lns_GetClaimGuaranteeViewPrm(ObjN);
    LnsObject.ClaimGuaranteeEditPrm = lns_GetClaimGuaranteeEditPrm(ObjN);

    return LnsObject;
END;