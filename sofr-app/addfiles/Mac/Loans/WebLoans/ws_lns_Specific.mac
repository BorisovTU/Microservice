/*
$Name: ws_lns_Specific.mac
$Module: WebLoans
$Description: Сервис источника данных для листалки "Целевое назначение"
*/
IMPORT RsbDataSet, total, likepy;

PRIVATE CLASS CLnsSpecific
  var SpecificID:integer   = 0,
      Name:string          = "",
      Code:string          = "",
      Flag:string          = "",
      TypeDebtor:integer   = 0,
      RegDateFlag:string   = "";
END;

MACRO lns_GetSpecificList(TypeDebtor: integer, ReqCrdType: integer)
   VAR result = TArray(), obj = NULL;
   VAR rs = NULL;

   VAR query = "select distinct spec.t_SpecificID, spec.t_Name, spec.t_Code, spec.t_Flag, spec.t_TypeDebtor, spec.t_RegDateFlag ";
       query = query + "from dspec_crd_dbt spec, dlreq_spec_crd_dbt reqspec where ";
       query = query + "spec.t_typedebtor in (0, " + TypeDebtor + ") and ";
       query = query + "spec.t_flag <> 'X' and ";
       query = query + "SPEC.T_SPECIFICID = REQSPEC.T_SPECIFICID ";  
       if (ReqCrdType != 0)
            query = query + "and REQSPEC.T_REQCRDTYPEID = " + ReqCrdType;
       end;

    rs = TRsbDataSet(query);

    WHILE (rs.moveNext())
        obj = CLnsSpecific();

        obj.SpecificID  = rs.SpecificID;
        obj.Name        = rs.Name;
        obj.Code        = rs.Code;
        obj.Flag        = rs.Flag;
        obj.TypeDebtor  = rs.TypeDebtor;
        obj.RegDateFlag = rs.RegDateFlag;
        
        result[result.size] = obj;
    END;
  
    RETURN result;
END;

MACRO lns_GetSpecificListByStr(specific)
    VAR result = TArray(), obj = NULL;
    VAR rs = NULL;
    VAR query = "select distinct spec.t_SpecificID, spec.t_Name, spec.t_Code, spec.t_Flag, spec.t_TypeDebtor, spec.t_RegDateFlag " +
                "from dspec_crd_dbt spec where spec.t_flag <> 'X' ";

    if (strlen(specific) > 0)
	    var i = 0;
        var s = "";
        while (i < strlen(specific))
            s = s + "'" + substr(specific, i + 1, 1) + "'";
            if (i != strlen(specific) - 1)
            s = s + ", ";
            end;
            i = i + 1;
        end;	 
        query = query + "and t_code in (" + s + ")";
        
        rs = TRsbDataSet(query);

        while (rs.moveNext())
            obj = CLnsSpecific();

            obj.SpecificID  = rs.SpecificID;
            obj.Name        = rs.Name;
            obj.Code        = rs.Code;
            obj.Flag        = rs.Flag;
            obj.TypeDebtor  = rs.TypeDebtor;
            obj.RegDateFlag = rs.RegDateFlag;
            
            result[result.size] = obj;
        end;
    end;
    return result;
END;

MACRO GetSpecificNameByStr(specific)
    var result = "";
    var specArr = StrSplit2(specific, 1);
    if (specArr.size == 0)
        result = "";
    elif (specArr.size == 1)
        result = LnSelectValue("select t_Name from dspec_crd_dbt where t_code='" + specArr[0] + "'", V_STRING);
    else
        result = join(specArr, ", ");
    end;
    return result;
END;