/*
$Name: ws_lns_OperLimit.mac
$Module: WebLoans
$Description: Сервис для виджета операции "Изменение лимита"
*/
IMPORT SbCrdInter, RsbDataSet;
IMPORT "total.mac", globals, ws_LoansOperation, ws_lns_CrdContract;

MACRO lns_GetAvailableLimit(ObjN, OpDate, SysOp, TypeOP)
    var Contract = lns_GetCredit_c(ObjN);
    record typeopBuff("type_op") btr;
    IF (Loans_FindTypeOp(0, TypeOP, TypeOpBuff) != true)
         RunError("Операция не найдена");
    END;
    var AvailableLimit = GetAvailableLimit(ObjN, OpDate, SysOp, TypeOpBuff.TypeOperNumber, Contract.CreditSum);
    return AvailableLimit;
END;

MACRO lns_RunChLimOperation(ObjN, TypeOperID, OpDate, Limit, AvailableLimit, Curcode)
    var result: TWsMessage;
    record typeopBuff("type_op") btr;
    
    IF (Loans_FindTypeOp(0, TypeOperID, TypeOpBuff) != true)
         result.MsgText = "Выполнение операции. Не найдена операция " + TypeOperID;
         result.MsgID = -1;
         return result;
    END;
    
    result.MsgText = "Выполнение операции. Операция выполнена успешно.";
    result.MsgID = MakeOperation(ObjN, LO_CREDIT, TypeOpBuff.TypeOperNumber, Curcode, OpDate, 0, 0, 0, Limit, AvailableLimit);
    IF (result.MsgID == 0)
      result.MsgText = GetMO_LoansError;
      result.MsgID = GetMO_ErrorID;
    END;
    return result;
END;
