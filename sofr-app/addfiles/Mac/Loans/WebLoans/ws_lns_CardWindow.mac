/*
$Name: ws_lns_CardWindow.mac
$Module: WebLoans
$Description: Сервис получения информации по БК
*/
IMPORT SbCrdInter, RsbDataSet, globals, total, ws_lns_PurposeForCB;

VAR cardStat = "";

CLASS CLnsCardItem()
    var BkIsDraft = false;          //черновик?
    
    var BkPartyName = "";           //наименование\имя заёмщика
    var BkPartyLegalForm = "";      //юр. статус заёмщика

    var BkCreditType = "";          //вид кредита
    var BkPayType = "";             //тип выдачи
    var BkTarifPlFlag = "";         //флаг использования тарифного плана
    var BkTarifPl = "";             //тарифный план
    var BkУсловиеТарифа = "";       //условие тарифа
    var BkUsCreditType = "";        //пользовательский вид кредита
    var BkIndTarif = false;         //флаг индивидуальной тарификации
    
    var BkFilial = "";              //филиал договора
    var BkGS = "";                  //генеральное соглашение    
    var BkNumber = 0;               //номер кредита
    var BkUsNumber = "";            //пользовательский номер кредита
    var BkDyration = 0;             //срок договора в мес
    var BkAccountKarta = "";        //Карточный счет
    var BkAvailableCardBalance = 0; //Доступный остаток по карте
    var BkReturnDate = "";          //Дата закрытия карты
    var BkDebtLimit = 0;            //сумма лимита
    var BkExceedLimit = 0;          //превышение лимита
    var BkSumDebt = 0;              //остаток задолженности
    var BkMinInstallment = 0;       //минимальная сумма рассрочки
    var BkRepDay = 0;               //Дата отчета(ежемесячно)
    var BkDutyDay = 0;              //Срок пограшения       
    var BkCur = 0;                  //валюта БК
    var BkPSK = 0;                  //ПСК
    
    var BkInd = false;              //индивидуальная классификация
    var BkKKS = "";                 //ККС
    var BkCaseType = TArray();      //тип портфеля
    var BkCase = TArray();          //имя портфеля
    var BkNote = "";                //примечание БК
END;

MACRO lns_GetCardData(ObjID, ObjN)
    var result = CLnsCardItem();
    var Card = null;
    var Party = null;
    var Case = null;
    /*данные по БК*/    
    Card = crsdcommand("select crd.*, to_char(crd.T_RETURNDATE, 'dd.mm.yyyy') RETURNDATE, tcrd.* from dcredit_c_dbt crd, dtype_crd_dbt tcrd WHERE tcrd.T_CREDITTYPEID = (select T_CREDITTYPEID_REF from dcredit_c_dbt where t_creditnumber = crd.t_creditnumber) AND crd.t_creditnumber = :p0 ", ":p0", ObjN, V_GENOBJ);

    if (Card.MoveNext())
       result.BkNumber = Card.value("t_creditnumber");
       result.BkUsNumber = Card.value("t_uscreditnumber");
       result.BkCreditType = Card.value("T_CREDITTYPENAME");

       if (Int(Card.value("T_PAYTYPE")) == 10)
        result.BkPayType = "Расчетная карта";
       elif (Int(Card.value("T_PAYTYPE")) == 11)
        result.BkPayType = "Кредитная карта";
       end;
       
       result.BkUsCreditType = Card.value("T_USERTYPE");
       result.BkFilial = string(Card.value("T_FNCASH")) + "/" + string(Card.value("T_BRANCH"));

       if (Card.value("T_BRANCH")!= 0)
          result.BkFilial = result.BkFilial + "/" + Card.value("T_BRANCH");
       end;

       if (Card.value("T_TYPEDURATION") == 0)     
          result.BkDyration = string(Card.value("T_DURATION")) + " мес. c " + StrSubst(string(date(Card.value("T_REGDATE"))), " ", "0" ) + " по " + StrSubst(string(date(Card.value("T_RETURNDATE"))), " ", "0" );
       elif((Card.value("T_TYPEDURATION") == 1))
          result.BkDyration = string(Card.value("T_DURATION")) + " д. c " + StrSubst(string(date(Card.value("T_REGDATE"))), " ", "0" ) + " по " + StrSubst(string(date(Card.value("T_RETURNDATE"))), " ", "0" );
       end;

       result.BkCur = crsdcommand("select T_CCY from dfininstr_dbt where T_FIID = :p0", ":p0", Card.value("T_CURCODE"), V_STRING);

       if (Card.value("T_CREDITSTATE") == "Ч")
           result.BkIsDraft = true;           
       end;
       
       cardStat = string(Card.value("T_CREDITSTATE"));

       if (Card.value("T_INDIV_TRFF") == "X")
          result.BkIndTarif = true;
       end;

       if (Card.value("T_INDCLASSIFICATION") == "X")
          result.BkInd = true;
       end;

       result.BkTarifPlFlag = Card.value("T_FLAGUSETRFFPLAN");
       result.BkTarifPl = crsdcommand("select NVL(T_TRFFPLANNAME, 0) from dltrffplan_dbt tp, DTPLAN_TCR_DBT tcr where tp.T_TRFFPLANID = tcr.T_TRFFPLANID AND tcr.T_TPLANTCRID = :p0", ":p0", Card.value("T_TPLANTCRID"), V_STRING);
       result.BkУсловиеТарифа = crsdcommand("select NVL(T_CONDNAME, 0) from dcond_tplan_dbt where T_CONDID = :p0", ":p0", Card.value("T_CONDID"), V_STRING);      
       result.BkNote = StrSubst((Card.value("T_USERFIELD1") + " " + Card.value("T_USERFIELD2")), strfor(1), "");   
       
       result.BkAccountKarta = string(Card.value("T_ACCOUNTKARTA"));    //Карточный счет
       result.BkReturnDate = Date(Card.value("T_RETURNDATE"));          //Дата закрытия карты
       result.BkMinInstallment = Money(Card.value("T_MININSTALLMENT")); //минимальная сумма рассрочки
       result.BkRepDay = Int(Card.value("T_REPDAY"));                   //Дата отчета(ежемесячно)
       result.BkDutyDay = Int(Card.value("T_DUTYDAY"));                 //Срок пограшения       
    end;

    result.BkPSK = crsdcommand("select * from (SELECT T_CALCRATE FROM dlhistry_xirr_dbt WHERE T_OBJECTID = :p0 AND T_OBJECTNUMBER = :p1 and T_CALCDATE <= :p2 ORDER BY T_CALCDATE DESC) where rownum = 1", ":p0", ObjID, ":p1", ObjN, ":p2", {curdate}, V_DOUBLE); 
    result.BkKKS = crsdcommand("select to_char(T_NUMBERRISKGROUP)||' ('||to_char(T_NAMERISKGROUP)||')' from driskgr_dbt where T_NUMBERRISKGROUP = (select * from (SELECT T_IRISKGROUP FROM dcrdrghb_dbt WHERE T_OBJECTTYPEID = :p0 AND T_OBJECTNUMBER = :p1 and T_DATE <= :p2 ORDER BY T_DATE DESC) where rownum = 1)", ":p0", ObjID, ":p1", ObjN, ":p2", {curdate}, V_STRING); 
    Case = crsdcommand("select T_BRIEFCASENAME, t_USERNUMBER, t_type from dlbrfcase_dbt where T_BRIEFCASEID IN (select T_PARENTID from dcrdlink_dbt where T_OBJECTTYPEID = :p0 and T_OBJECTNUMBER = :p1 and T_TYPEPARENT = :p2) order by T_TYPE desc", ":p0", ObjID, ":p1", ObjN, ":p2", lo_case, V_GENOBJ);
    
    var i = 0;
    while (case.movenext())
       result.BkCase[i] = Trim(String(Case.value("T_BRIEFCASENAME")));
       if (result.BkCase[i] == StrFor(1))
       result.BkCase[i] = Trim(String(Case.value("t_USERNUMBER")));
       end;
       result.BkCaseType[i] = Case.value("t_type");
       i = i + 1;
    end;

    result.BkGS = crsdcommand("select t_uscreditnumber from dcredit_c_dbt where t_creditnumber = (select T_GENERALAGREEMENT_REF from dcredit_c_dbt where t_creditnumber = :p0)", ":p0", ObjN, V_STRING);

/*данные по субъекту*/    
    Party = crsdcommand("select pr.T_NAME, pr.T_LEGALFORM, per.T_ISEMPLOYER from dparty_dbt pr, dpersn_dbt per where per.T_PERSONID(+) = pr.T_PARTYID and pr.T_PARTYID = (select T_CLIENTID_REF from dcredit_c_dbt where t_creditnumber = :p0)", ":p0", ObjN, V_GENOBJ);

    if (Party.MoveNext())
       result.BkPartyName = Party.value("T_NAME");
    end;
      
    result.BkAvailableCardBalance = 0; //Доступный остаток по карте    
    result.BkDebtLimit = crsdcommand("select loanskernel.getregrest_date(LOANSKERNEL.getusregid_forobject(:p0, :p1, :p2), :p3) from dual", ":p0", ObjID,":p1", ObjN,":p2", TDR_LIMDUTY ,":p3", {curdate}, V_MONEY); //сумма лимита    
    result.BkExceedLimit = crsdcommand("select loanskernel.getregrest_date(LOANSKERNEL.getusregid_forobject(:p0, :p1, :p2), :p3) from dual", ":p0", ObjID,":p1", ObjN,":p2", TDR_LIM ,":p3", {curdate}, V_MONEY);   //превышение лимита
    result.BkSumDebt = crsdcommand("select LOANSKERNEL.GetRegRestWithSO(:p0, :p1, :p2, :p3) + " +
                                          "LOANSKERNEL.GetRegRestWithSO(:p4, :p5, :p6, :p7) + " +
                                          "LOANSKERNEL.GetRegRestWithSO(:p8, :p9, :p10, :p11) " +
		              	           "from dual", 
				                   ":p0", TDR_MAINREST, ":p1", ObjID, ":p2",  ObjN, ":p3",  {curdate}, 
                                   ":p4", TDR_EXPREST,  ":p5", ObjID, ":p6",  ObjN, ":p7",  {curdate}, 
                                   ":p8", TDR_LIM,      ":p9", ObjID, ":p10", ObjN, ":p11", {curdate}, V_MONEY); //остаток задолженности
    return result;
END;


PRIVATE MACRO MakeWindowTitle(ObjN)
  var
      retVal = "";

    if (ObjN != NULL)
        retVal = "Параметры БК № " + crsdcommand("select t_uscreditnumber from dcredit_c_dbt where t_creditnumber = :p0", ";p0", ObjN, V_STRING);
    end;

    RETURN retVal;
END;

MACRO lns_CardWindow(MacroParms)
    var ObjID = MacroParms[0].Value.ObjID,
        ObjN = MacroParms[0].Value.ObjN;
       
    var char1 = strfor(1);
    var
        Title = MakeWindowTitle(ObjN),
        Data = lns_GetCardData(ObjID, ObjN);
    var str = 

"<RsControls:RsFloatingWindow " +                                                                    
"    xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
"    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
"    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
"    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
"    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk' " +
"    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " +
"    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
"    xmlns:RsControls='clr-namespace:RsControls;assembly=RsControls' " +  
"    xmlns:MEICore='clr-namespace:Microsoft.Expression.Interactivity.Core;assembly=Microsoft.Expression.Interactions' " +
"    xmlns:SWI='clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity' " +   
"    mc:Ignorable='d'" +
"    x:Name='rootElement'" +
"    Title='" + Title + "'" +
">" +
"    <Grid Margin='5,0,0,0'  Background='#FFFDFDFD'> " +   
"        <ScrollViewer  ScrollViewer.VerticalScrollBarVisibility='Auto' ScrollViewer.HorizontalScrollBarVisibility='Auto'> " +
"                <Grid> " +
"                    <Grid.RowDefinitions> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='5'/> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='5'/> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='5'/> " +
"                        <RowDefinition Height='Auto'/> " +
"                        <RowDefinition Height='*'/> " +
"                    </Grid.RowDefinitions> " +
"                    <toolkit:Expander x:Name='Expander1' IsExpanded='True'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Заемщик по договору' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " +
"                            <TextBlock Text='ФИО:' Grid.Row='0' /> " +
"                            <TextBlock Text='" + data.BkPartyName + "' Grid.Column='2' /> " ;
   str = str +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                    <toolkit:Expander x:Name='Expander2' IsExpanded='True' Grid.Row='2' d:IsLocked='True'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Банковский продукт' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " +
"                            <TextBlock Text='Вид кредита по договору:'  Grid.Row='0'/> " +
"                            <TextBlock Text='" + string(data.BkCreditType) + "' Grid.Row='0' Grid.Column='2' /> " +
"                            <TextBlock Text='Тип выдачи по договору:'  Grid.Row='2'/> " +
"                            <TextBlock Text='" + string(data.BkPayType) + "'  Grid.Row='2' Grid.Column='2' /> " ;
if (data.BkTarifPlFlag == "X")
   str = str +
"                            <TextBlock Text='Тарифный план продукта:'  Grid.Row='4' /> " +
"                            <TextBlock Text='" + string(data.BkTarifPl) + "' Grid.Row='4' Grid.Column='2' /> " +
"                            <TextBlock Text='Условие тарифного плана:'   Grid.Row='6' /> " +
"                            <TextBlock Text='" + string(data.BkУсловиеТарифа) + "' Grid.Row='6' Grid.Column='2' /> " ;
end;
if ((strlen(string(data.BkUsCreditType)) > 0) and (string(data.BkUsCreditType) != char1))
   str = str +
"                            <TextBlock Text='Пользовательский вид:'  Grid.Row='8' /> " +
"                            <TextBlock Text='" + string(data.BkUsCreditType) + "'  Grid.Row='8' Grid.Column='2' /> " ;
end;
   str = str +
"                            <CheckBox Content='Индивидуальная тарификация' IsChecked='" + string(data.BkIndTarif) + "'  IsEnabled='False' Grid.Row='10' Grid.ColumnSpan='3' /> " +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                    <toolkit:Expander x:Name='Expander3'  IsExpanded='True' Grid.Row='4'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Основные параметры договора' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " +
"                            <TextBlock Text='Филиал/подразделение ТС:'  Grid.Row='0'/> " +
"                            <TextBlock Text='" + string(data.BkFilial) + "' Grid.Row='0' Grid.Column='2' /> "; 
if (strlen(string(data.BkGS)) > 0)
   str = str +
"                            <TextBlock Text='Номер ген. соглашения:' Grid.Row='2'/> " +
"                            <TextBlock Text='" + string(data.CrGS) + "' Grid.Row='2' Grid.Column='2'/> " ;
end;
   str = str +
"                            <TextBlock Text='Номер договора:' Grid.Row='4'/> " +
"                            <TextBlock Text='" + string(data.BkUsNumber) + "' Grid.Row='4' Grid.Column='2'/> " +
"                            <TextBlock Text='Срок договора:'   Grid.Row='6'/> " +
"                            <TextBlock Text='" + string(data.BkDyration) + "' Grid.Row='6' Grid.Column='2' /> " ;
   str = str +
"                            <TextBlock Text='Карточный счет:'  Grid.Row='8' /> " +
"                            <TextBlock Text='" + string(data.BkAccountKarta) + "'  Grid.Row='8' Grid.Column='2' /> " ;
//end;
if (data.BkIsDraft == false)
   str = str +
"                            <TextBlock Text='Доступный остаток по карте:'  Grid.Row='10' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='10' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkAvailableCardBalance) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.BkCur) + "' /> " +
"                            </StackPanel> " ;

end;
if (((cardStat == "З") or (cardStat == "Д")) and (data.BkReturnDate >= {curdate})) 
   str = str +
"                            <TextBlock Text='Дата закрытия карты:'  Grid.Row='12' /> " +
"                            <TextBlock Text='" + string(data.BkReturnDate) + "'  Grid.Row='12' Grid.Column='2' /> " ;
end;
   str = str +
"                            <TextBlock Text='Сумма лимита:'  Grid.Column='0'  Grid.Row='14'/> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='14' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkDebtLimit) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.BkCur) + "' /> " +
"                            </StackPanel> " ;

if (data.BkExceedLimit > 0)
   str = str +
"                            <TextBlock Text='Превышение лимита:'  Grid.Row='16' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='16' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkExceedLimit) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.BkCur) + "' /> " +
"                            </StackPanel> " ;
end;

if (data.BkIsDraft == false)
   str = str +
"                            <TextBlock Text='Остаток задолженности:'  Grid.Row='18' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='18' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkSumDebt) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.BkCur) + "' /> " +
"                            </StackPanel> " ;
end;

if ((data.BkMinInstallment > 0) and (data.BkPayType != 10)) //Значение в поле > 0 и Тип выдачи по договору != <Расчетная карта>.
   str = str +
"                            <TextBlock Text='Минимальная сумма рассрочки:'  Grid.Row='20' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='20' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkMinInstallment) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='" + string(data.BkCur) + "' /> " +
"                            </StackPanel> " ;
end;

if (data.BkRepDay > 0)
   str = str +
"                            <TextBlock Text='Дата отчета (ежемесячно):'  Grid.Row='22' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='22' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkRepDay) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='числа' /> " +
"                            </StackPanel> " ;
end;

if (data.BkDutyDay > 0)
   str = str +
"                            <TextBlock Text='Срок погашения:'  Grid.Row='24' /> " +
"                            <StackPanel   Orientation='Horizontal' Grid.Row='24' Grid.Column='3'> " +
"                                <TextBlock Text='" + string(data.BkDutyDay) + "'    Margin='0,0,6,0'/> " +
"                                <TextBlock Text='дн.' /> " +
"                            </StackPanel> " ;
end;
   str = str +
"                            <TextBlock Text='Полная стоимость кредита:' Grid.Row='26' Margin='0,5,0,0' /> " +
"                            <StackPanel  Orientation='Horizontal' Grid.Row='26' Grid.Column='2' Margin='0,5,0,0' > " +
"                                <TextBlock Text='" + string(data.BkPSK) + "' Margin='0,0,6,0'/> " +
"                                <TextBlock Text='% годовых' /> " +
"                                <HyperlinkButton Name='PSKHypBtn' Grid.Column='1' Content='Расчет ПСК' Margin='12,0,6,0' HorizontalAlignment='Right' ToolTipService.ToolTip='Нажмите для вызова истории расчета ПСК (Ctrl+X)'/> " +
"                            </StackPanel> " ;
   str = str +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                    <toolkit:Expander x:Name='Expander4' IsExpanded='True' Grid.Row='6'> " +
"                        <toolkit:Expander.Header> " +
"                            <TextBlock Text='Дополнительные параметры' Grid.Column='0' FontWeight='Bold'/> " +
"                        </toolkit:Expander.Header> " +
"                        <Grid> " +
"                            <Grid.ColumnDefinitions> " +
"                                <ColumnDefinition Width='Auto'/> " +
"                                <ColumnDefinition Width='6'/> " +
"                                <ColumnDefinition Width='*'/> " +
"                            </Grid.ColumnDefinitions> " +
"                            <Grid.RowDefinitions> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='0'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='5'/> " +
"                                <RowDefinition Height='Auto'/> " +
"                                <RowDefinition Height='*'/> " +
"                            </Grid.RowDefinitions> " ;
"                            <CheckBox Content='Индивидуальная классификация' IsChecked='" + string(data.BkInd) + "'  IsEnabled='False' Grid.Row='0' Grid.ColumnSpan='3' /> " ;
if (data.BkIsDraft == false)
   str = str +
"                            <StackPanel Grid.Row='2' Orientation='Horizontal'  > " +
"                                <TextBlock Text='Категория качества ссуды:' Margin='0,0,6,0' /> " +
"                                <TextBlock   Text='" + string(data.BkKKS) + "'  Grid.Row='2' Grid.Column='2' /> " +
"                            </StackPanel> ";

if ((data.BkCase.Size > 0) and (data.BkIsDraft == false))
      str = str +
"                            <RsControls:GroupBox  Header='Портфель' Grid.Row='4' d:LayoutOverrides='Height' Margin='0,5,0,0' Grid.Column='0' Grid.ColumnSpan='3'  > " +
"                                <StackPanel> " +
"                                    <Grid> " +
"                                        <Grid.ColumnDefinitions> " +
"                                            <ColumnDefinition Width='Auto'/> " +
"                                            <ColumnDefinition Width='*'/> " +
"                                        </Grid.ColumnDefinitions> " +
"                                        <Grid.RowDefinitions> " +
"                                            <RowDefinition Height='Auto'/>  " +
"                                            <RowDefinition Height='*'/> ";
        if (data.BkCase.Size > 1)
            str = str +
"                                            <RowDefinition Height='Auto'/>  " +
"                                            <RowDefinition Height='*'/> " +
"                                        </Grid.RowDefinitions> " +
"                                        <TextBlock Text='Ссуд: '  Grid.Row='2' /> " +
"                                        <TextBlock Text='" + string(data.BkCase[0]) + "'  Grid.Row='2' Grid.Column='2'/> " +
"                                        <TextBlock Text='Условных обязательств: '  Grid.Row='4' /> " +
"                                        <TextBlock Text='" + string(data.BkCase[1]) + "'  Grid.Row='4' Grid.Column='2'/> ";
        else
            str = str +
"                                        </Grid.RowDefinitions> ";

            if (data.BkCaseType[0] == 0)
                       str = str +
"                                        <TextBlock Text='Условных обязательств: '  Grid.Row='2' /> ";
            else
                       str = str +
"                                        <TextBlock Text='Ссуд: '  Grid.Row='2' /> ";   
            end;
        end;
        str = str +
"                                        <TextBlock Text='" + string(data.BkCase[0]) + "'  Grid.Row='2' Grid.Column='2'/> " +
"                                    </Grid> " +
"                                </StackPanel> " +
"                            </RsControls:GroupBox> " ;
    end;
end;

if (strlen(string(data.BkNote)) > 1)
   str = str +
"                            <StackPanel Grid.Row='6'  Orientation='Horizontal'  > " +
"                                <TextBlock Text='Примечание:' Margin='0,0,6,0'  /> " +
"                                <TextBlock Text='" + string(data.BkNote) + "'   /> " +
"                            </StackPanel> " ;
end;
   str = str +
"                        </Grid> " +
"                    </toolkit:Expander> " +
"                </Grid> " +
"        </ScrollViewer> " +
"    </Grid> " +
"</RsControls:RsFloatingWindow> " ;
    return str;
END;
