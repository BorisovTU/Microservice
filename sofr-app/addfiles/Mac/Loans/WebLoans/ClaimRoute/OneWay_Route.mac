/*
$Name: OneWay_Route.mac
$Module: WebLoans
$Description: Дистрибутивный маршрут заявок.
*/

// Шаг андеррайтинга вынесен в отдельный макрос из-за нагруженности интерфейса.

import wf_commonUtils, Globals, RSD, serviceaction, ws_lns_CrdContract, ws_lns_Claim, SbCrdInter;

CLASS StepAnswer
    var AnswerNumber: string = "";
    var AnswerDate: date = date(0,0,0);
    var Sum: Money = $0;
    var CurCode: String = "";
    var Answer: Integer = -1;
    var AnswerText: string = "";
    var RejReason: integer = "";
    var Note: string = "";
END;

PRIVATE MACRO OpenCreditFromClaim(OpDate, ClaimID, CreditState)
    var CreditPrm = lns_InitContractByClaimID(ClaimID);
        CreditPrm.Credit.CreditState = CreditState;
    var res = lns_OpenCrdFromClaim(Opdate, ClaimID, CreditPrm);
    if (res.MsgID > 0)
        RunError(res.MsgText);
    end;
END;

MACRO GetStepAnswerFromXML(XMLResult: string)
    var result = StepAnswer();
    var RslLnsObj = null;
    var RslLnsObjValue = null;
    var i = 0;
    XMLResult = "<methodResponse xmlns=\"http://www.softlab.ru/xml-rpc/schema\" " + 
                "xmlns:n0=\"http://www.softlab.ru/xml-rpc/schema\" " +
                "n0:reqId=\"{D6237739-84A6-481B-A23D-0F3E6B5C4B83}\" n0:logicalId=\"\"><params><param><value>" +
                XMLResult + "</value></param></params></methodResponse>";
    ConvertToRsl(XmlResult, RslLnsObj);
    if (RslLnsObj != null) // LnsValueObject
        RslLnsObjValue = RslLnsObj.Value; 
        if (RslLnsObjValue != null) // LnsValueList
            while (i < RslLnsObjValue.Size)
                if (RslLnsObjValue[i].ValueName == "AnswerNumber")
                    result.AnswerNumber = RslLnsObjValue[i].Value;
                elif (RslLnsObjValue[i].ValueName == "AnswerDate")
                    result.AnswerDate = RslLnsObjValue[i].Value;
                elif (RslLnsObjValue[i].ValueName == "Answer")
                    result.Answer = RslLnsObjValue[i].Value;
                elif (RslLnsObjValue[i].ValueName == "AnswerText")
                    result.AnswerText = RslLnsObjValue[i].Value;    
                elif (RslLnsObjValue[i].ValueName == "RejReason")
                    result.RejReason = RslLnsObjValue[i].Value;
                elif (RslLnsObjValue[i].ValueName == "Note")
                    result.Note = RslLnsObjValue[i].Value;
                end;
                i = i + 1;
            end;
        end;
    end;
    return result;
END;

MACRO GenerateWidget(ClaimID: integer, WidgetXAML:string)   
    var GeneratedNumber = ""; // Доработать! Сгенерить номер
    var retVal: string =
    " <Grid xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
    "    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
    "    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
    "    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
    "    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk' " +
    "    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " +
    "    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
    "    xmlns:RsControls='clr-namespace:RsControls;assembly=RsControls' " +
    "    xmlns:RsTools='clr-namespace:RsTools;assembly=RsTools' " +
    "    xmlns:MEICore='clr-namespace:Microsoft.Expression.Interactivity.Core;assembly=Microsoft.Expression.Interactions' " +
    "    xmlns:SWI='clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity' " +
    "    xmlns:LnsDDListers='clr-namespace:Loans.LnsDataDirectory.Listers;assembly=WebLoans' " +
    "    xmlns:LnsCustomTypes='clr-namespace:Loans.LoansCommon.CustomTypes;assembly=LoansCommon' " +
    "    xmlns:LnsCommonType='clr-namespace:Loans.LoansCommon.DataModel;assembly=LoansCommon' " +
    "    xmlns:LnsConverter='clr-namespace:Loans.LoansCommon.Helpers;assembly=LoansCommon' " +
    "    xmlns:Converter='clr-namespace:DataProvider.ViewModel.Helpers;assembly=DataProvider' " +
    "    xmlns:UIBasic='clr-namespace:UIBasic;assembly=UIBasic'>" +
    "    <Grid.Resources>" +
    "        <Converter:BoolToVisibilityConverter x:Key='BoolToVisibilityConverter'/>" +
    "        <LnsCommonType:LnsValueObject x:Key='PanelParmData'>" +
    "            <LnsCommonType:LnsValueObject.Value>" +
    "                <LnsCustomTypes:LnsValueList>" +
    "                    <LnsCommonType:LnsValueObject ValueName='AnswerNumber'>" +
    "                        <LnsCommonType:LnsValueObject.Value>" +
    "                            <System:String>" + String(GeneratedNumber) + "</System:String>"
    "                        </LnsCommonType:LnsValueObject.Value>" +
    "                    </LnsCommonType:LnsValueObject>" +
    "                    <LnsCommonType:LnsValueObject ValueName='AnswerDate'>" +
    "                        <LnsCommonType:LnsValueObject.Value>" +
    "                            <System:String>" + String({curdate}:f) + "</System:String>"+ // нельзя прямо так задать дату. Поэтому используем строку.
    "                        </LnsCommonType:LnsValueObject.Value>" +
    "                    </LnsCommonType:LnsValueObject>" +
    "                    <LnsCommonType:LnsValueObject ValueName='Answer'>" +
    "                        <LnsCommonType:LnsValueObject.Value>" +
    "                            <System:Int32>0</System:Int32>" +
    "                        </LnsCommonType:LnsValueObject.Value>" +
    "                    </LnsCommonType:LnsValueObject>" +
    "                    <LnsCommonType:LnsValueObject ValueName='AnswerText'>" +
    "                        <LnsCommonType:LnsValueObject.Value>" +
    "                            <System:String></System:String>" +
    "                        </LnsCommonType:LnsValueObject.Value>" +
    "                    </LnsCommonType:LnsValueObject>" +
    "                    <LnsCommonType:LnsValueObject ValueName='RejReason'>" +
    "                        <LnsCommonType:LnsValueObject.Value>" +
    "                            <System:Int32>0</System:Int32>" +
    "                        </LnsCommonType:LnsValueObject.Value>" +
    "                    </LnsCommonType:LnsValueObject>" +
    "                    <LnsCommonType:LnsValueObject ValueName='Note'>" +
    "                        <LnsCommonType:LnsValueObject.Value>" +
    "                            <System:String></System:String>" +
    "                        </LnsCommonType:LnsValueObject.Value>" +
    "                    </LnsCommonType:LnsValueObject>" +
    "                </LnsCustomTypes:LnsValueList>" +
    "            </LnsCommonType:LnsValueObject.Value>" +
    "        </LnsCommonType:LnsValueObject>" +
    "        <LnsCommonType:LnsValueObject x:Key='RejReasonVisibility'>" +
    "           <LnsCommonType:LnsValueObject.Value>" +
    "              <System:Boolean>False</System:Boolean>" + 
    "           </LnsCommonType:LnsValueObject.Value>" +
    "        </LnsCommonType:LnsValueObject>" +     
    "    </Grid.Resources>" +
    WidgetXAML +
    "</Grid>";
    return retVal;
END;


//====================== Проверка с СБ=======================\\
MACRO LnsSecurityCheck_Interface(paramStr: string)
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var StepWidgetXAML: string = 
    "<Grid> " +
    "    <Grid.ColumnDefinitions> " +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='12'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='*'/>" +
    "    </Grid.ColumnDefinitions>" +          
    "    <Grid.RowDefinitions>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='*'/>" +
    "    </Grid.RowDefinitions>" +
    "    <sdk:Label Content='Номер заключения:' Grid.Row='0' />" +
    "    <RsControls:RsTextBox Grid.Row='0' Grid.Column='2' MinWidth='140' " + 
    "                          Text='{Binding Path=Value[0].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +
    "    <sdk:Label Content='Дата заключения:' Grid.Row='0' Grid.Column='4'/>" +
    "    <RsControls:RsDatePicker Grid.Row='0' Grid.Column='6' " +
    "                             IsCalendarButtonVisible='True' IsTabStop='True' HorizontalAlignment='Stretch' " + 
    "                             Text='{Binding Path=Value[1].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'/> " +
    "    <sdk:Label Content='Заключение:' Grid.Row='4' Grid.Column='0' />" +
    "    <RsControls:RsComboBox x:Name='AnswerComboBox' Grid.Row='4' Grid.Column='2' Grid.ColumnSpan='1' MinWidth='175' " + 
    "                           SelectedIndex='{Binding Path=Value[2].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'> " +
    "        <SWI:Interaction.Triggers>" +
    "            <MEICore:DataTrigger Binding='{Binding Path=SelectedIndex, ElementName=AnswerComboBox }' Value='0'>" +
    "                <MEICore:ChangePropertyAction TargetObject='{StaticResource RejReasonVisibility}' PropertyName='Value'>" +
    "                    <MEICore:ChangePropertyAction.Value>" +
    "                        <System:Boolean>False</System:Boolean>" +  
    "                    </MEICore:ChangePropertyAction.Value>" + 
    "                </MEICore:ChangePropertyAction>" + 
    "            </MEICore:DataTrigger>" +
    "            <MEICore:DataTrigger Binding='{Binding Path=SelectedIndex, ElementName=AnswerComboBox }' Value='1'>" +
    "                <MEICore:ChangePropertyAction TargetObject='{StaticResource RejReasonVisibility}' PropertyName='Value'>" +
    "                    <MEICore:ChangePropertyAction.Value>" +
    "                        <System:Boolean>True</System:Boolean>" +  
    "                    </MEICore:ChangePropertyAction.Value>" + 
    "                </MEICore:ChangePropertyAction>" + 
    "            </MEICore:DataTrigger>" +
    "            <MEICore:DataTrigger Binding='{Binding Path=SelectedIndex, ElementName=AnswerComboBox }' Value='2'>" +
    "                <MEICore:ChangePropertyAction TargetObject='{StaticResource RejReasonVisibility}' PropertyName='Value'>" +
    "                    <MEICore:ChangePropertyAction.Value>" +
    "                        <System:Boolean>False</System:Boolean>" +  
    "                    </MEICore:ChangePropertyAction.Value>" + 
    "                </MEICore:ChangePropertyAction>" + 
    "            </MEICore:DataTrigger>" +
    "        </SWI:Interaction.Triggers>" +
    "        <RsControls:RsComboBox.Items> " +
    "            <ComboBoxItem Content='Положительное'/> " +
    "            <ComboBoxItem Content='Отрицательное'/> " +
    "            <ComboBoxItem Content='Доработать'/> " +
    "        </RsControls:RsComboBox.Items> " +
    "    </RsControls:RsComboBox> " +
    "   <sdk:Label Content='Текст заключения:' Grid.Row='6' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='6' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[3].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +                    
    "   <sdk:Label Content='Основание отказа:' Grid.Row='8' Grid.Column='0' Margin='0,0,0,5' " + 
    "              Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +
    "   <LnsDDListers:CLnsRejReasonListControl Grid.Row='8'  Margin='0,0,0,5' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' " + 
    "                                          LnsRejReasonID='{Binding Path=Value[4].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' " +     
    "                                          Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +    
    "   <sdk:Label Content='Примечание:' Grid.Row='10' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='10' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[5].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +
    "</Grid>";
    var outParams = handleResult(0);
    outParams.set("XAMLUI", GenerateWidget(ClaimID, StepWidgetXAML));
    return outParams.toString;
END;

MACRO LnsSecurityCheck_Execute(paramStr : String)
    var inParams = TParameters(paramStr);
    var LnsClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    var AnswerXMLObject = inParams.get("result");
    var AnswerObject = GetStepAnswerFromXML(AnswerXMLObject);
    var result = AnswerObject.Answer;
    /*
    0 = "Положительное";
    1 = "Отрицательное";
    2 = "Доработать";
    */
    if (result == 0)
        ClaimStatus = 1;
        ClaimStage = 3;
    elif (result == 1)
        ClaimStatus = 3;
        ClaimStage = 5;
        ClaimReject(LnsClaimID, AnswerObject.RejReason, AnswerObject.Note);
    elif (result == 2)
        ClaimStatus = 4;
        ClaimStage = 3;
    end;
    var outParams = handleResult(0);
    outParams.set("ClaimStatus", ClaimStatus);
    outParams.set("ClientStatus", ClientStatus);
    outParams.set("ClaimStage", ClaimStage);
    return outParams.toString;    
END;


//================доработка после проверки СБ================\\
MACRO ReworkForSecurity_Interface(paramStr: string)
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var StepWidgetXAML = 
    "<Grid> " +
    "    <Grid.ColumnDefinitions> " +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='12'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='*'/>" +
    "    </Grid.ColumnDefinitions>" +          
    "    <Grid.RowDefinitions>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='*'/>" +
    "    </Grid.RowDefinitions>" +
    "    <sdk:Label Content='Номер заключения:' Grid.Row='0' />" +
    "    <RsControls:RsTextBox Grid.Row='0' Grid.Column='2' MinWidth='140' " + 
    "                          Text='{Binding Path=Value[0].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +
    "    <sdk:Label Content='Дата заключения:' Grid.Row='0' Grid.Column='4'/>" +
    "    <RsControls:RsDatePicker Grid.Row='0' Grid.Column='6' " +
    "                             IsCalendarButtonVisible='True' IsTabStop='True' HorizontalAlignment='Stretch' " + 
    "                             Text='{Binding Path=Value[1].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'/> " +
    "    <sdk:Label Content='Заключение:' Grid.Row='4' Grid.Column='0' />" +
    "    <RsControls:RsComboBox x:Name='AnswerComboBox' Grid.Row='4' Grid.Column='2' Grid.ColumnSpan='1' MinWidth='175' " + 
    "                           SelectedIndex='{Binding Path=Value[2].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'> " +    
    "        <RsControls:RsComboBox.Items> " +
    "            <ComboBoxItem Content='Доработка выполнена'/> " +
    "            <ComboBoxItem Content='Отказ клиента'/> " +
    "        </RsControls:RsComboBox.Items> " +
    "    </RsControls:RsComboBox> " +
    "   <sdk:Label Content='Текст заключения:' Grid.Row='6' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='6' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[3].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +                        
    "   <sdk:Label Content='Основание отказа:' Grid.Row='8' Grid.Column='0' Margin='0,0,0,5' " + 
    "              Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +
    "   <LnsDDListers:CLnsRejReasonListControl Grid.Row='8'  Margin='0,0,0,5' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' " + 
    "                                          LnsRejReasonID='{Binding Path=Value[4].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' " +     
    "                                          Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +    
    "   <sdk:Label Content='Примечание:' Grid.Row='10' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='10' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[5].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +    
    "</Grid>";
    var outParams = handleResult(0);
    outParams.set("XAMLUI", GenerateWidget(ClaimID, StepWidgetXAML));
    return outParams.toString;
END;

MACRO ReworkForSecurity_Execute(paramStr : String)
    var inParams = TParameters(paramStr);
    var LnsClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    var AnswerXMLObject = inParams.get("result");
    var result = GetStepAnswerFromXML(AnswerXMLObject).Answer;
    /*
    0 = "Доработка выполнена";
    1 = "Отказ клиента";
    */
    if (result == 0)
        ClaimStatus = 1;
        ClaimStage = 3;
    elif (result == 1)
        ClaimStatus = 7;
        ClaimStage = 4;
    end;
    var outParams = handleResult(0);
    outParams.set("ClaimStatus", ClaimStatus);
    outParams.set("ClientStatus", ClientStatus);
    outParams.set("ClaimStage", ClaimStage);
    return outParams.toString;    
END;

//==============Доработка для андеррайтера===========\\
MACRO ReworkForUnderwriter_Interface(paramStr: string)
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var StepWidgetXAML = 
    "<Grid> " +
    "    <Grid.ColumnDefinitions> " +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='12'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='*'/>" +
    "    </Grid.ColumnDefinitions>" +          
    "    <Grid.RowDefinitions>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='*'/>" +
    "    </Grid.RowDefinitions>" +
    "    <sdk:Label Content='Номер заключения:' Grid.Row='0' />" +
    "    <RsControls:RsTextBox Grid.Row='0' Grid.Column='2' MinWidth='140' " + 
    "                          Text='{Binding Path=Value[0].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +
    "    <sdk:Label Content='Дата заключения:' Grid.Row='0' Grid.Column='4'/>" +
    "    <RsControls:RsDatePicker Grid.Row='0' Grid.Column='6' " +
    "                             IsCalendarButtonVisible='True' IsTabStop='True' HorizontalAlignment='Stretch' " + 
    "                             Text='{Binding Path=Value[1].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'/> " +
    "    <sdk:Label Content='Заключение:' Grid.Row='4' Grid.Column='0' />" +
    "    <RsControls:RsComboBox x:Name='AnswerComboBox' Grid.Row='4' Grid.Column='2' Grid.ColumnSpan='1' MinWidth='175' " + 
    "                           SelectedIndex='{Binding Path=Value[2].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'> " +    
    "        <RsControls:RsComboBox.Items> " +
    "            <ComboBoxItem Content='Доработка выполнена'/> " +
    "            <ComboBoxItem Content='Отказ клиента'/> " +
    "        </RsControls:RsComboBox.Items> " +
    "    </RsControls:RsComboBox> " +
    "   <sdk:Label Content='Текст заключения:' Grid.Row='6' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='6' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[3].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +                        
    "   <sdk:Label Content='Основание отказа:' Grid.Row='8' Grid.Column='0' Margin='0,0,0,5' " + 
    "              Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +
    "   <LnsDDListers:CLnsRejReasonListControl Grid.Row='8'  Margin='0,0,0,5' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' " + 
    "                                          LnsRejReasonID='{Binding Path=Value[4].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' " +     
    "                                          Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +    
    "   <sdk:Label Content='Примечание:' Grid.Row='10' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='10' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[5].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +    
    "</Grid>";
    var outParams = handleResult(0);
    outParams.set("XAMLUI", GenerateWidget(ClaimID, StepWidgetXAML));
    return outParams.toString;
END;

MACRO ReworkForUnderwriter_Execute(paramStr : String)
    var inParams = TParameters(paramStr);
    var LnsClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    var AnswerXMLObject = inParams.get("result");
    var result = GetStepAnswerFromXML(AnswerXMLObject).Answer;
    /*
    0 = "Доработка выполнена";
    1 = "Отказ клиента";
    */
    if (result == 0)
        ClaimStatus = 1;
        ClaimStage = 3;
    elif (result == 1)
        ClaimStatus = 7;
        ClaimStage = 4;
    end;
    var outParams = handleResult(0);
    outParams.set("ClaimStatus", ClaimStatus);
    outParams.set("ClientStatus", ClientStatus);
    outParams.set("ClaimStage", ClaimStage);
    return outParams.toString;    
END;

//==============Решение клиента======================\\
MACRO ClientSolution_Interface(paramStr: string)
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var StepWidgetXAML = 
    "<Grid> " +
    "    <Grid.ColumnDefinitions> " +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='12'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='*'/>" +
    "    </Grid.ColumnDefinitions>" +          
    "    <Grid.RowDefinitions>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='*'/>" +
    "    </Grid.RowDefinitions>" +
    "    <sdk:Label Content='Номер заключения:' Grid.Row='0' />" +
    "    <RsControls:RsTextBox Grid.Row='0' Grid.Column='2' MinWidth='140' " + 
    "                          Text='{Binding Path=Value[0].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +
    "    <sdk:Label Content='Дата заключения:' Grid.Row='0' Grid.Column='4'/>" +
    "    <RsControls:RsDatePicker Grid.Row='0' Grid.Column='6' " +
    "                             IsCalendarButtonVisible='True' IsTabStop='True' HorizontalAlignment='Stretch' " + 
    "                             Text='{Binding Path=Value[1].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'/> " +
    "    <sdk:Label Content='Заключение:' Grid.Row='4' Grid.Column='0' />" +
    "    <RsControls:RsComboBox x:Name='AnswerComboBox' Grid.Row='4' Grid.Column='2' Grid.ColumnSpan='1' MinWidth='175' " + 
    "                           SelectedIndex='{Binding Path=Value[2].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'> " +    
    "        <RsControls:RsComboBox.Items> " +
    "            <ComboBoxItem Content='Согласие клиента'/> " +
    "            <ComboBoxItem Content='Отказ клиента'/> " +
    "        </RsControls:RsComboBox.Items> " +
    "    </RsControls:RsComboBox> " +
    "   <sdk:Label Content='Текст заключения:' Grid.Row='6' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='6' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[3].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +       
    "   <sdk:Label Content='Основание отказа:' Grid.Row='8' Grid.Column='0' Margin='0,0,0,5' " + 
    "              Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +
    "   <LnsDDListers:CLnsRejReasonListControl Grid.Row='8'  Margin='0,0,0,5' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' " + 
    "                                          LnsRejReasonID='{Binding Path=Value[4].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' " +     
    "                                          Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +    
    "   <sdk:Label Content='Примечание:' Grid.Row='10' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='10' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[5].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +    
    "</Grid>";
    var outParams = handleResult(0);
    outParams.set("XAMLUI", GenerateWidget(ClaimID, StepWidgetXAML));
    return outParams.toString;
END;

MACRO ClientSolution_Execute(paramStr : String)
    var inParams = TParameters(paramStr);
    var LnsClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    var AnswerXMLObject = inParams.get("result");
    var result = GetStepAnswerFromXML(AnswerXMLObject).Answer;
    /*
    0 = "Согласие клиента";
    1 = "Отказ клиента";
    */
    if (result == 0)
        ClientStatus = 2;
        ClaimStage = 6;
    elif (result == 1)
        ClaimStatus = 7;
        ClaimStage = 4;
    end;
    var outParams = handleResult(0);
    outParams.set("ClaimStatus", ClaimStatus);
    outParams.set("ClientStatus", ClientStatus);
    outParams.set("ClaimStage", ClaimStage);
    return outParams.toString;    
END;

//==================Оформление продукта======================\\
MACRO OpenContract_Interface(paramStr: string)
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var StepWidgetXAML =
    "<Grid> " +
    "    <Grid.ColumnDefinitions> " +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='12'/>" +
    "        <ColumnDefinition Width='Auto'/>" +
    "        <ColumnDefinition Width='6'/>" +
    "        <ColumnDefinition Width='*'/>" +
    "    </Grid.ColumnDefinitions>" +          
    "    <Grid.RowDefinitions>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='5'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='0'/>" +
    "        <RowDefinition Height='Auto'/>" +
    "        <RowDefinition Height='*'/>" +
    "    </Grid.RowDefinitions>" +
    "    <sdk:Label Content='Номер заключения:' Grid.Row='0' />" +
    "    <RsControls:RsTextBox Grid.Row='0' Grid.Column='2' MinWidth='140' " + 
    "                          Text='{Binding Path=Value[0].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +
    "    <sdk:Label Content='Дата заключения:' Grid.Row='0' Grid.Column='4'/>" +
    "    <RsControls:RsDatePicker Grid.Row='0' Grid.Column='6' " +
    "                             IsCalendarButtonVisible='True' IsTabStop='True' HorizontalAlignment='Stretch' " + 
    "                             Text='{Binding Path=Value[1].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'/> " +
    "    <sdk:Label Content='Оформить продукт:' Grid.Row='4' Grid.Column='0' />" +
    "    <RsControls:RsComboBox x:Name='AnswerComboBox' Grid.Row='4' Grid.Column='2' Grid.ColumnSpan='1' MinWidth='175' " + 
    "                           SelectedIndex='{Binding Path=Value[2].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}'> " +    
    "        <RsControls:RsComboBox.Items> ";
  
if (LnSelectValue("select t_claimKind from dclaim_dbt where t_claimid = " + ClaimID, V_INTEGER, 0) == 3)
StepWidgetXAML = StepWidgetXAML +
    "            <ComboBoxItem Content='Договор гарантии'/> " +
    "            <ComboBoxItem Content='Черновик ДГ'/> ";
else
StepWidgetXAML = StepWidgetXAML +
    "            <ComboBoxItem Content='Кредитный договор'/> " +
    "            <ComboBoxItem Content='Черновик КД'/> ";
end;
  
StepWidgetXAML = StepWidgetXAML +
    "            <ComboBoxItem Content='Генеральное соглашение'/> " +
    "        </RsControls:RsComboBox.Items> " +
    "    </RsControls:RsComboBox> " +
    "   <sdk:Label Content='Текст заключения:' Grid.Row='6' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='6' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[3].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +          
    "   <sdk:Label Content='Основание отказа:' Grid.Row='8' Grid.Column='0' Margin='0,0,0,5' " + 
    "              Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +
    "   <LnsDDListers:CLnsRejReasonListControl Grid.Row='8'  Margin='0,0,0,5' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' " + 
    "                                          LnsRejReasonID='{Binding Path=Value[4].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' " +     
    "                                          Visibility='{Binding Path=Value, Source={StaticResource RejReasonVisibility}, Converter={StaticResource BoolToVisibilityConverter}}' />" +    
    "   <sdk:Label Content='Примечание:' Grid.Row='10' Grid.Column='0' />" +
    "   <RsControls:RsTextBox Grid.Row='10' Grid.Column='2' Grid.ColumnSpan='5' MinWidth='175' VerticalContentAlignment='Stretch' " + 
    "                         Text='{Binding Path=Value[5].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' />" +    
    "</Grid>";
    var outParams = handleResult(0);
    outParams.set("XAMLUI", GenerateWidget(ClaimID, StepWidgetXAML));
    return outParams.toString;
END;

MACRO OpenContract_Execute(paramStr : String)
    var inParams = TParameters(paramStr);
    var LnsClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    var AnswerXMLObject = inParams.get("result");
    var result = GetStepAnswerFromXML(AnswerXMLObject).Answer;

if (LnSelectValue("select t_claimKind from dclaim_dbt where t_claimid = " + LnsClaimID, V_INTEGER, 0) == 3)
    if (result == 0)
        ClaimStatus = 8;
        ClaimStage = 7;
    elif (result == 1)
        ClaimStatus = 9; // черновик
        ClaimStage = 7;
    elif (result == 2)
        ClaimStatus = 10; // генеральное соглашение
        ClaimStage = 7;
    end;
else
    if (result == 0)
        OpenCreditFromClaim({curdate}, LnsClaimID, CF_OPEN);
        ClaimStatus = 8; // договор
        ClaimStage = 7;
    elif (result == 1)
        OpenCreditFromClaim({curdate}, LnsClaimID, CF_OPENDRAFT);
        ClaimStatus = 9; // черновик
        ClaimStage = 7;
    elif (result == 2)
        ClaimStatus = 10; // генеральное соглашение
        ClaimStage = 7;
    end;
end;
    var outParams = handleResult(0);
    outParams.set("ClaimStatus", ClaimStatus);
    outParams.set("ClientStatus", ClientStatus);
    outParams.set("ClaimStage", ClaimStage);
    return outParams.toString;
END;

//==============Установка стадии-статуса заявки=============\\
macro SetStatus_Execute(paramStr : String) // Интерфейса для шага установки статуса - нет.
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    
    var stat = 0;
    var qStr = "";
    var rs = null;
    
    qStr = "update dclaim_dbt set t_claimstate=?, t_stageid=? where t_claimid=?";
    rs =  RSDCommand(qStr);
    rs.AddParam("p_claimstate", RSDBP_IN, ClaimStatus);
    rs.AddParam("p_stageid",    RSDBP_IN, ClaimStage);
    rs.AddParam("p_claimid",    RSDBP_IN, ClaimID);

    rs.execute;

    return stat;
end;

//==============Автоматическая проверка заявки=============\\
macro AutoCheck_Execute(paramStr : String) // Интерфейса для шага автоматической проверки - нет.
    var inParams = TParameters(paramStr);
    var ClaimID = inParams.get("LnsClaimID");
    var ClaimStatus = inParams.get("ClaimStatus");
    var ClientStatus = inParams.get("ClientStatus");
    var ClaimStage = inParams.get("ClaimStage");
    ClaimStatus = 1; // Установить статус 1 ("В рассмотрении")
    ClaimStage = 3;  // Установить стадию 3 ("В рассмотрении")
    
                     // Если нужно отклонить, устанавливаем ClaimStatus = 3 ("Отклонена")
                     //                                     ClaimStage = 5 ("ОТклоненные") 
                     // И вызываем ClaimReject чтоб записать параметры отклонения
    var outParams = handleResult(0);
    outParams.set("ClaimStatus", ClaimStatus);
    outParams.set("ClientStatus", ClientStatus);
    outParams.set("ClaimStage", ClaimStage);
    return outParams.toString;   
end;
