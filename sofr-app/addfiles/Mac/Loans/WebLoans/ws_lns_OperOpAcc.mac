/*
$Name: ws_lns_OperOpAcc.mac
$Module: WebLoans
$Description: Сервис для виджета операции "Открытие счетов"
*/
IMPORT SbCrdInter, RsbDataSet, ws_LoansOperation;

CLASS CLnsOpenAccItem()
    VAR ObjID: integer = 0;
    VAR ObjN: integer = 0;
    VAR AccCategID: integer = 0;
    VAR AccCategName: integer = 0;
    VAR Chapter: string = "";
    VAR AccountNumber: string = "";
    VAR CurCode: integer = 0;
    VAR CurName: string = "";
    VAR Status: string = "";
    VAR ODBAccountNumber: string = "";
    VAR ODBCurCode: integer = 0;
    VAR ODBCurName: string = "";
    VAR ODBStatus: string = "";
    VAR AccKind: string = "";
END;

MACRO lns_getOpenAccList(ObjID, ObjN, OpDate)
    var result = TArray();
    var item = null;
    var qStr = "";
    var rs = NULL;
    
    //доработать - включить сюда функцию заполнения временной таблицы DACC_MAC_TMP
    
    qStr = "SELECT " +
           "acc.t_AccCategID, " +
           "acc.t_chapter, " +
           "acc.t_AccountNumber, " +
           "acc.t_CurCode, " +
           "acc.t_Status, " +
           "acc.t_AccountNumberODB, " +
           "acc.t_CurCodeODB, " +
           "acc.t_Open_Close, " +
           "acc.t_Kind_Account, " +
           "tacc.t_nametypeaccount, " +
           "fi.t_ccy, " +
           "fiodb.t_ccy as t_ccyodb" +
           "FROM DACC_MAC_TMP acc, DTACCRED_DBT tacc, DFININSTR_DBT fi, DFININSTR_DBT fiodb " +
           "WHERE tacc.t_typeacccred = acc.t_AccCategID " +
           "AND fi.t_fiid = acc.t_CurCode " + 
           "AND fiodb.t_fiid = acc.t_CurCodeODB " +
           "AND acc.t_objecttypeid = " + ObjID +
           " AND acc.t_objectnumber = " + ObjN;
    rs = TRsbDataSet(qStr);
    while (rs.MoveNext())
        item = CLnsOpenAccItem();
        
        item.ObjID           = ObjID;
        item.ObjN            = ObjN;
        item.AccCategID      = int(rs.AccCategID);
        item.AccCategName    = int(rs.nametypeaccount);
        item.Chapter         = string(rs.Chapter);
        item.AccountNumber   = string(rs.AccountNumber);
        item.CurCode         = int(rs.CurCode);
        item.CurName         = string(rs.ccy);
        item.Status          = string(rs.Status);
        item.ODBAccountNumber= string(rs.AccountNumberODB);
        item.ODBCurCode      = int(rs.CurCodeODB);
        item.ODBCurName      = string(rs.ccyodb);
        item.ODBStatus       = string(rs.Open_Close);
        item.AccKind         = string(rs.Kind_Account);
        
        result[result.size] = item;
    end;

    return result;
END;

