/*
$Name: ws_lns_Card.mac
$Module: WebLoans
$Description: Сервис источника данных для получения информации по БК
*/
IMPORT SbCrdInter, RsbDataSet, globals, Календарь, PTInter;
IMPORT "total.mac", "ws_lns_TariffPlan.mac";
IMPORT "ws_loansoperation.mac", "ws_lns_CommonLib.mac", "xirr.mac";
IMPORT "fmt_lib.mac", "DCREDIT_C_DBT.mac", "DCLAIM_DBT.mac", "ws_lns_PurposeForCB.mac", "ws_lns_Specific.mac", "ws_lns_UserCreditType.mac", "ws_lns_CrdContract";

CLASS CLnsCardViewPrm()
    var ContractStatus = "";
    var IsEmployer = false;
    var PayType = 0;
    var LoanerName = "";
    var LoanerStatus = "";
    var ClientStatus = "";
    var GANumber = "";
    var UsNumber = "";
    var Duration = 0;
    var TypeDuration = "";
    var RegDate = NULL;
    var ReturnDate = NULL;
    var TypeCredit = "";
    var PayTypeName = "";
    var CurCode = "";
    var SumCredit = NULL;
    var AvailableLimit = NULL;
    var DebtLimit = NULL;
    var SumDebt = NULL;
    var TotalCost = "";
    var UserTypeCredit = "";
    var Specific = "";
    var MortageRegDate = NULL;
    var ReqCrdType = "";
    var PurposeForCB = "";
    var Comment = "";
    var TariffPlan = "";
    var TariffPlanCond = "";
    var IsAnnuity = true;
    var WithTariffPlan = false;
    var RegViewMode = 1;
    var LnsObjID = CLnsObjID();
    var TotalCostDetailVisibility = true;
    var IsNewDutyEnabled = true;
    var ClaimID = 0;
    var ClaimNumStr = "";
    var IsClaimVisible = false;
    var AccountKarta = "";              //Карточный счет
    var AvailableCardBalance = NULL;    //Доступный остаток по карте
    var MinInstallment = NULL;          //Минимальная сумма рассрочки
    var RepDay = 0;                     //Дата отчета(ежемесячно)
    var DutyDay = 0;                    //Срок пограшения
    var ExceedLimit = NULL;             //Превышение лимита
END;

MACRO lns_GetViewPrmCard(ObjN, ClientID)
    var result = CLnsCardViewPrm();
    var qStr = "";
    var rs = NULL;
    var precision: integer = 0, ErrCode;
    
    if (GetRegistryValue ("RS-LOANS\\ПСК\\ТОЧНОСТЬ_РЕЗУЛЬТАТОВ", V_INTEGER, precision, ErrCode) != V_INTEGER)
        RunError(ErrCode);
    end;
    if (precision > 28)
        precision = 28;
    end;
    SetDefPrec (precision);
    
    qStr =  qStr + "select ";
    qStr =  qStr + "credit.t_creditstate as t_ContractStatus, ";
    qStr =  qStr + "decode(NVL(persn.t_IsEmployer, chr(0)), 'X', 'X', decode(credit.t_LegalForm, credit.t_TypeDebtor, chr(0), 'X')) AS t_IsEmployer, ";
    qStr =  qStr + "credit.t_PayType as t_PayType, ";
    qStr =  qStr + "credit.t_TypeDebtor as t_TypeDebtor, ";
    qStr =  qStr + "credit.t_ClientID_Ref as t_ClientID, ";
    qStr =  qStr + "case credit.t_TypeDebtor ";
    qStr =  qStr + "when 1 then 'Индивидуальный предприниматель' ";
    qStr =  qStr + "when 2 then 'Физическое лицо' ";
    qStr =  qStr + "end as t_ClientStatus, ";
    qStr =  qStr + "credit.t_UsCreditNumber as t_UsNumber, ";
    qStr =  qStr + "genagr.t_UsCreditNumber as t_GANumber, ";
    qStr =  qStr + "credit.t_Duration as t_Duration, ";
    qStr =  qStr + "namealg.t_szNameAlg as t_TypeDuration, ";
    qStr =  qStr + "credit.t_RegDate as t_RegDate, ";
    qStr =  qStr + "credit.t_ReturnDate as t_ReturnDate, ";
    qStr =  qStr + "typecrd.t_CreditTypeName as t_TypeCredit, ";
    qStr =  qStr + "LLVALUES.T_NAME AS PAYTYPENAME, ";
    qStr =  qStr + "fininstr.t_Ccy as t_CurCode, ";
    qStr =  qStr + "credit.t_CreditSum as t_SumCredit, ";
    qStr =  qStr + "credit.t_UserType as t_UserTypeCredit, ";
    qStr =  qStr + "credit.t_Specific as t_Specific, ";
    qStr =  qStr + "credit.t_MortageRegDate as t_MortageRegDate, ";
    qStr =  qStr + "credit.t_UserField1 as t_Comment, ";
    qStr =  qStr + "credit.t_Annuit as t_Annuit, ";
    qStr =  qStr + "HXIRR.T_calcRATE as t_TotalCost, ";
    qStr =  qStr + "reqcrdtype.t_Name as t_ReqCrdName, ";
    qStr =  qStr + "credit.t_paytype as payType, ";
    qStr =  qStr + "(SELECT count(*) from dcrd_op_dbt op where op.t_creditnumber_ref = credit.t_CreditNumber AND op.t_IsDeleted = 0 AND op.t_systemoperationid = "+CS_PAY+") as paycnt, ";
    qStr =  qStr + "(SELECT count(*) from dduty_crd_dbt duty where duty.t_creditnumber_ref=credit.t_creditnumber) as dutycount, ";
    qStr =  qStr + "credit.t_tplantcrid as TPid, ";
    qStr =  qStr + "credit.t_paytype as payType, ";
    qStr =  qStr + "(SELECT count(*) from dcrd_op_dbt op where op.t_creditnumber_ref = credit.t_CreditNumber AND op.t_IsDeleted = 0 AND op.t_systemoperationid = "+CS_PAY+") as paycnt, ";
    qStr =  qStr + "(SELECT count(*) from dduty_crd_dbt duty where duty.t_creditnumber_ref=credit.t_creditnumber) as dutycount, ";
    qStr =  qStr + "(SELECT MAX(LINK_CLAIM.CLAIMID_1) FROM (SELECT CL.T_CLAIMID AS CLAIMID_1"; 
                                            qStr =  qStr + " FROM DCLAIM_DBT CL"; 
                                            qStr =  qStr + " WHERE CL.T_CREDITNUMBER_REF = " + ObjN;
                                            qStr =  qStr + " UNION ALL";
                                            qStr =  qStr + " SELECT -100 AS CLAIMID_1";
                                            qStr =  qStr + " FROM DUAL";
                                            qStr =  qStr + " ) LINK_CLAIM) AS CLAIMID, ";    
    qStr =  qStr + " CREDIT.T_ACCOUNTKARTA AS ACCOUNTKARTA, ";  
    qStr =  qStr + " CREDIT.T_MININSTALLMENT AS MININSTALLMENT, "; 
    qStr =  qStr + " CREDIT.T_REPDAY AS REPDAY, "; 
    qStr =  qStr + " CREDIT.T_DUTYDAY AS DUTYDAY ";             
    qStr =  qStr + "from dcredit_c_dbt credit, ";
    qStr =  qStr + "dcredit_c_dbt genagr, ";
    qStr =  qStr + "dtype_crd_dbt typecrd, ";
    qStr =  qStr + "dnamealg_dbt namealg, ";
    qStr =  qStr + "dfininstr_dbt fininstr, ";
    qStr =  qStr + "DLLVALUES_DBT LLVALUES, ";
    qStr =  qStr + "dpersn_dbt persn, ";
    qStr =  qStr + "dlreqcrdtype_dbt reqcrdtype, ";
    qStr =  qStr + "(SELECT max(T_CALCDATE) as t_Calcdate, t_objectid, t_objectnumber, t_calcrate from dlhistry_xirr_dbt where T_CALCDATE <= "; 
    qStr =  qStr + SQLDate({curdate}) + " group by t_objectid, t_objectnumber, t_calcrate)  hxirr ";
    qStr =  qStr + "where  credit.t_CreditNumber = " + ObjN + " and credit.t_Crd_Kind = 8";
    qStr =  qStr + " and typecrd.t_CreditTypeID = credit.t_CreditTypeID_Ref ";
    qStr =  qStr + "and (namealg.t_iNumberAlg = credit.t_TypeDuration and namealg.t_iTypeAlg = 987) ";
    qStr =  qStr + "and fininstr.t_FIID = credit.t_CurCode ";
    qStr =  qStr + "and (LLVALUES.T_ELEMENT = CREDIT.T_PAYTYPE and LLVALUES.T_LIST = 1403) ";
    qStr =  qStr + "and persn.t_PersonID(+) = credit.t_ClientID_Ref ";
    qStr =  qStr + "and HXIRR.T_OBJECTNUMBER(+) = CREDIT.T_CREDITNUMBER ";
    qStr =  qStr + "and HXIRR.T_OBJECTID(+) = credit.t_Crd_Kind ";
    qStr =  qStr + "and reqcrdtype.T_REQCRDTYPEID(+) = credit.T_REQCRDTYPEID ";
    qStr =  qStr + "and genagr.T_CREDITNUMBER(+) = credit.T_GENERALAGREEMENT_REF ";
    rs = TRsbDataSet(qStr);
    if  (rs.moveNext())
        result.ContractStatus = String(rs.ContractStatus);
        result.IsEmployer = false;
        if (String(rs.IsEmployer) == "X")
            result.IsEmployer = true;
        end;
        result.PayType = Int(rs.PayType);
        result.ClientStatus = String(rs.ClientStatus);
        result.UsNumber = String(rs.UsNumber);
        result.Duration = Int(rs.Duration);
        result.TypeDuration = String(rs.TypeDuration);
        result.RegDate = Date(rs.RegDate);
        result.ReturnDate = Date(rs.ReturnDate);
        result.TypeCredit = String(rs.TypeCredit);
        result.PayTypeName = String(rs.PayTypeName);
        result.CurCode = String(rs.CurCode);
        result.SumCredit = Money(rs.SumCredit);
        
        if (result.PayType == CF_CRLIN)
            result.AvailableLimit = ОстатокРегистра(1, ObjN, TDR_AVAILABLELIMIT, {curdate});
            result.DebtLimit = ОстатокРегистра(1, ObjN, TCLTR_LIMDUTY, {curdate});
        elif (result.PayType == CF_CRLINNO)
            result.AvailableLimit = ОстатокРегистра(1, ObjN, TDR_AVAILABLELIMIT, {curdate});
        elif (result.PayType == CF_CRLINNEW)
            result.AvailableLimit = ОстатокРегистра(1, ObjN, TDR_AVAILABLELIMIT, {curdate});
            result.DebtLimit = ОстатокРегистра(1, ObjN, TCLTR_LIMDUTY, {curdate});
            result.SumCredit = NULL; //сумма скрыта
        else // тип выдачи - не КЛ
            result.AvailableLimit = NULL;
            result.DebtLimit = NULL;
            if (lns_CrdHasDuty(ObjN) == false) // Не открыто ни одного СО.
                result.RegViewMode = 0;
            end;
        end;
        result.ExceedLimit = ОстатокРегистра(1, ObjN, TDR_LIM, {curdate});    
        result.SumDebt = Money(GetAllRegRest(LO_CREDIT, ObjN, TDR_MAINREST, date(31,12,9999)) + 
                               GetAllRegRest(LO_CREDIT, ObjN, TDR_EXPREST,  date(31,12,9999)) + 
                               GetAllRegRest(LO_CREDIT, ObjN, TDR_LIM,      date(31,12,9999)));
        
        if (int(rs.TypeDebtor) == 2) // ПСК выводим только для физиков.
            if (rs.TotalCost == null)
                result.TotalCost = "Не рассчитана ";
            else
                result.TotalCost = string(double(rs.TotalCost)) + "% годовых ";
            end;
        else
            result.TotalCost = "";
        end;

        result.UserTypeCredit = GetUserCreditTypeNameByStr(String(rs.UserTypeCredit));
        result.Specific = GetSpecificNameByStr(String(rs.Specific));

        if (rs.ReqCrdName == null)
            result.ReqCrdType = "";
        else
            result.ReqCrdType = String(rs.ReqCrdName);
        end;
        if (rs.GANumber == null)
            result.GANumber = "";
        else
            result.GANumber = rs.GANumber;
        end;
        result.MortageRegDate = Date(rs.MortageRegDate);
        result.Comment = String(rs.Comment);
        if (rs.t_Annuit == "X")
            result.IsAnnuity = true;
        else
            result.IsAnnuity = false;
        end;

        if ((ClientID != NULL) and (ClientID != 0))
            if (ClientID != Int(rs.ClientID))
                result.LoanerName = LnSelectValue("SELECT t_name from dparty_dbt where t_partyid = " + Int(rs.ClientID), V_STRING, 0);
                result.LoanerStatus = String(rs.ClientStatus);
                result.ClientStatus = "";
            else
                result.LoanerName = "";
                result.LoanerStatus = ""; 
            end;
        end;
        
        if (rs.TPid > 0)
            result.WithTariffPlan = true;
        else
            result.WithTariffPlan = false;
        end;
        
        if ( 
                ( (int(rs.dutycount) > 0) and //если есть СО и тип "Разовый" или "До востребования"
                    ( (rs.payType == CF_NONREP) or (rs.payType == CF_POSTERESTANTE) )
                )
            or
                ( (rs.payType == CF_NONREP) and (int(rs.paycnt)>0) ) //или разовый и была выдача
            or
                ( (rs.payType == CF_POSTERESTANTE) and (int(rs.paycnt)==0) )//или до востребования и выдачи не было
           )
                result.IsNewDutyEnabled = false; //запретить вводить новые СО
        end;
        
        result.LnsObjID.ObjID = LO_CREDIT;
        result.LnsObjID.ObjN = ObjN;

        if (int(rs.TypeDebtor) == 1) result.TotalCostDetailVisibility = false; end;  //Если договор ЮЛ
        if ((result.ContractStatus == "З") or (result.ContractStatus == "Д"))        //либо закрыт и без рассчитанной истории ПСК
            if (rs.TotalCost == null) result.TotalCostDetailVisibility = false; end; //метку "Расчет ПСК" не выводим
        end;
              
        result.PurposeForCB = GetPurposeStrByObjID(LO_CREDIT, ObjN);
 
        result.AccountKarta = String(rs.ACCOUNTKARTA);
        result.MinInstallment = Money(rs.MININSTALLMENT); 
        result.RepDay = Int(rs.REPDAY);
        result.DutyDay = Int(rs.DUTYDAY);
        
        
    end;

    return result;
END;

MACRO lns_GetCredit_c_Card(ObjN)
    var qStr = "";
    var rs = NULL;
    var result = DCREDIT_C_DBT();

    qStr =  qStr + "select * ";
    qStr =  qStr + "from dcredit_c_dbt t where ";
    qStr =  qStr + "t.t_CreditNumber = " + ObjN + " and t.t_Crd_Kind = 8"; 

    rs = RsdRecordset(qStr);
    if (rs.MoveNext())
        result = GetObjectFromRecordset("DCREDIT_C_DBT", rs);
    end;

    return result;
END;


