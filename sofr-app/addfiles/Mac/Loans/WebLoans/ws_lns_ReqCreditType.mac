/*
$Name: ws_lns_ReqCreditType.mac
$Module: WebLoans
$Description: Сервис источника данных для листалки "тип Кредита"
*/
IMPORT RsbDataSet, "total.mac";

PRIVATE CLASS CLnsReqCreditType
  var ReqCrdTypeID:integer     = 0,
      Name:string              = "";
END;

MACRO lns_ReqCreditTypeList(specific)
    VAR result = TArray(), obj = NULL;
    VAR rs = NULL;
    VAR query = "select DISTINCT REQTYPE.T_REQCRDTYPEID, REQTYPE.T_NAME " + 
                "from dlreqcrdtype_dbt reqtype, dlreq_spec_crd_dbt reqspec, dspec_crd_dbt spec " +
                "where REQTYPE.T_REQCRDTYPEID = REQSPEC.T_REQCRDTYPEID and " +
                "REQSPEC.T_SPECIFICID = SPEC.T_SPECIFICID ";
    if (strlen(specific) > 0)
    	 var i = 0;
         var s = "";
         while (i < strlen(specific))
             s = s + "'" + substr(specific, i + 1, 1) + "'";
             if (i != strlen(specific) - 1)
                s = s + ", ";
             end;
             i = i + 1;
         end;	 
        query = query + "and SPEC.T_CODE in (" + s + ")";
    else
        query = query + "and REQTYPE.T_REQCRDTYPEID in (201, 202, 203, 204, 301, 302, 303, 304, 305, 306, " + 
                        "401, 402, 403, 404, 405, 406, 407, 408, 999) ";
    end;
    query = query + " ORDER BY REQTYPE.T_REQCRDTYPEID";          
               
    rs = TRsbDataSet(query);
    
    WHILE (rs.moveNext())
        obj = CLnsReqCreditType();
        obj.ReqCrdTypeID     = rs.ReqCrdTypeID;
        obj.Name             = rs.Name;
        result[result.size] = obj;
    END;
  
    RETURN result;
END;

MACRO lns_ReqCreditTypeByID(ReqTypeCreditId: integer)
    VAR result = CLnsReqCreditType();
    VAR rs = NULL;
    VAR query = "select * from dlreqcrdtype_dbt where t_reqcrdtypeid = " + ReqTypeCreditId;
    rs = TRsbDataSet(query);
    
    if (rs.moveNext())
        result.ReqCrdTypeID     = rs.ReqCrdTypeID;
        result.Name             = rs.Name;
    end;
  
    RETURN result;

END;
