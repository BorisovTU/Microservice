/*===============================================================================
Отлагательное Условие Плата за открытие КЛ
KOE
22.05.07
=================================================================================*/

import SbCrdInter, "total.mac";

/*В случае успеха возвращается 1*/
macro CheckDilaCond (ObjType, ObjNum, DilaCondID, OperDate)
    var rs = null;
    var RSDcmd = null;
    
    /*Анализировать суммы в графах "Начислить" и "Недоплаты" по виду задолженности "Комиссия за открытый лимит КЛ"
      таблицы разноски операций погашения. Условие выполнено, если  сумма в графе "Начислить" > 0 и сумма в графе "Недоплаты" = 0*/
    RSDcmd = RsdCommand(RslDefCon,"SELECT Count(*) FROM dplanfact_dbt WHERE t_CredOperDate <= ?" +
                                  " AND t_CreditNumber = ?" +
                                  " AND t_SystemOperationID_Ref = ?" +
                                  " AND t_DutyStageID_Ref = ?" + 
                                  " AND t_ActualAmount > ?" +
                                  " AND t_UnderPaySum = ?");
    RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = OperDate;
    RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = ObjNum;
    RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(2) = CS_DUTY;
    RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(3) = DS_CREDLINEOPENLIMITKOMISS;
    RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(4) = 0;
    RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(5) = 0;
    rs  = RsdRecordset(RSDcmd);
    RSDcmd.execute;
     
    if ((rs != null) and (rs.MoveNext()) and (rs.value(0, null, V_INTEGER) != null) and (rs.value(0, null, V_INTEGER) != 0))
        return 1;
    end;
    
    return 0;
end;
