/*
$Name: rsbus_credit.mac
$Module: Кредитование
$Description: реализация сервиса изменения параметров Кредитного договора
*/
/*--------------------------------------------------------------------------------------
              
Filename    : rsbus_credit.mac                                              
Description : реализация сервиса изменения параметров Кредитного договора 
            : Создан
Programmer  :
20.12.12    : Изменен
Programmer  : Shershnev Victor
--------------------------------------------------------------------------------------*/

import TOTAL,rsd,"rsbus_structs.mac","rsbus_check","rsbus_checkusr.mac", RSBUS_SYNCHCREDITDDATA, RSBUS_SYNCHACCCRD;
//номер сервиса согласно списоку сервисов описананых в rsbus_checkusr.mac. Отпределяется в функции вызова сервиса.
private var NumServ:integer; 
// Флаг, отключающий проверку переданных данных
private const SKIP_TCreditContr_CHECK = false;

private const SET_CHAR = "X", 
              UNSET_CHAR = " ",
              CF_PAY = 2;

private var LoansAccount:TArray = TArray();
private var OpDate:date, BusCredit:TCreditContr, CrdNumber:integer = 0;
private var ErrManager:CErrManager;
private var parm;
private var SynchAccFlag = 0, SynchCrdFlag = 0;
private record creditBuff ("credit_c.dbt");
var change_flag:bool;


private class TChangeCreditData
   var DutyRest:money;     //Остаток основного долга на дату operDate
   if (getparm(1, parm) AND (ValType(parm) == V_MONEY))
      DutyRest = parm;
   end;
end;


macro ReadObjInTCreditContr(BusObg)
   var i:integer,j:integer;
   var Tar:TTariff;
   var TarHist:TTarHist;
   var TarPlanFlag;
   var ProcName;
   var TarTypeCrd;
   
   BusCredit.creditType        = BusObg.creditType;
   BusCredit.client            = BusObg.client;
   BusCredit.number            = BusObg.number;
   BusCredit.regDate           = BusObg.regDate;
   BusCredit.returnDate        = BusObg.returnDate;
   BusCredit.territorialStruct = BusObg.territorialStruct;
   BusCredit.groupNum          = BusObg.groupNum;
   if(BusCredit.groupNum == NULL)
      BusCredit.groupNum = 0;
   end;
   BusCredit.userType          = BusObg.userType;
   if(BusCredit.userType == NULL)
     BusCredit.userType = "";
   end;
   BusCredit.privilege         = BusObg.privilege;
   BusCredit.specific          = BusObg.specific;
   if(BusCredit.specific == NULL)
     BusCredit.specific = "";                                                                    
   end;
   BusCredit.sum               = BusObg.sum;
   BusCredit.currency          = BusObg.currency;
   if(BusCredit.currency == NULL)
      BusCredit.currency = 0;
   end;
   BusCredit.repDate           = BusObg.repDate;
   BusCredit.beforeDutyIsInd   = BusObg.beforeDutyIsInd;
   BusCredit.fineCondIsInd     = BusObg.fineCondIsInd;
   BusCredit.annuit            = BusObg.annuit;
   BusCredit.indClassification = BusObg   .indClassification;
   BusCredit.userField1        = BusObg.userField1;
   if((BusCredit.userField1 == NULL) OR (Trim(BusCredit.userField1) == 0))
      BusCredit.userField1 = "";   
   end;

   BusCredit.userField2        = BusObg.userField2;
   if((BusCredit.userField2 == NULL) OR (Trim(BusCredit.userField2) == 0))
      BusCredit.userField2 = "";   
   end;

   if (not BusObg.TarPlan)
        BusObg.TarPlan=0;
   end;

   if (BusObg.TarPlan != 0)
      BusCredit.TarPlan = BusObg.TarPlan;
   else
      TarPlanFlag = CRsdCommand ("SELECT t_flagusetrffplan FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", BusObg.creditType,
                                           V_INTEGER);
     if (TarPlanFlag>0)
         var TarAvto = CRsdCommand ("SELECT t_flagautoselecttp FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", BusObg.creditType,
                                      V_INTEGER);
        if (TarAvto==0)
            RunError("Тарифный план задан неверно", 18743 )
        end;

        ProcName = CRsdCommand ("SELECT t_functiontp FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", BusObg.creditType,
                                           V_STRING);
        if (ProcName== StrFor(1) )
           RunError("Невозможно подобрать тарифный план", 18746);
        end;
        if (ProcName== "" )
           RunError("Невозможно подобрать тарифный план", 18746);
        end;

       var rs, RSDCmd;
       RSDCmd = RsdCommand(RslDefCon, " SELECT tcr.*,FIN.T_ISO_NUMBER curcode FROM dtype_crd_dbt tcr,dfininstr_dbt fin "+
                               "  WHERE     tcr.t_credittypeid = ? AND tcr.t_state = ? "+
                               "  AND tcr.t_crd_kind = ? AND tcr.t_typeoverdraft = ? AND TCR.T_CURCODE = FIN.T_FIID");

       RSDcmd.addParam ("CrdT",     RSDBP_IN); RSDcmd.value ("CrdT") = BusObg.creditType;
       RSDcmd.addParam ("state",    RSDBP_IN); RSDcmd.value ("state") = CF_OPEN;
       RSDcmd.addParam ("crd_kind", RSDBP_IN); RSDcmd.value ("crd_kind") = LO_CREDIT;
       RSDcmd.addParam ("TOv", RSDBP_IN);      RSDcmd.value ("TOv") = 1;

       rs = RsdRecordset(RSDcmd);

       if(rs.MoveNext)
          if(BusCredit.currency ==0)
             BusCredit.currency = rs.Value("curcode", null, V_STRING);
          end;
          if(BusCredit.currency != rs.Value("curcode", null, V_STRING))
             RunError("Валюта не соответствует виду кредитного договора", 18524);
          end;
       else
          RunError("Некорректный вид кредита", 18502);
        end;
 
       var curcode =  CRsdCommand ("SELECT T_FIID FROM dfininstr_dbt WHERE T_ISO_NUMBER = ? ",
                                     "p1", BusCredit.currency,
                                      V_INTEGER);


         
   var  cmd = RsdCommand(RslDefCon, "begin ? :="+ProcName+"( ?,?,?,?,? ); end;" );
   cmd.addParam( "retval", RSDBP_RETVAL, V_INTEGER );
   cmd.AddParam("", NULL, BusObg.creditType);
   cmd.AddParam("", NULL, curcode);
   cmd.AddParam("", NULL, BusObg.client);
   cmd.AddParam("", NULL, LO_CREDIT);
   cmd.AddParam("", NULL, BusObg.regDate);
   
   cmd.execute();
   var res = cmd.value(0);
   if (res > 0)
      TarTypeCrd = CRsdCommand ("SELECT T_TRFFPLANID FROM DTPLAN_TCR_DBT WHERE T_TPLANTCRID = ? ",
                                     "p1", res,
                                      V_INTEGER);
      BusObg.TarPlan = TarTypeCrd;
      BusCredit.TarPlan = BusObg.TarPlan;
   else
      RunError("Невозможно подобрать тарифный план", 18746);
   end;

      end;
   end;

   if (not BusObg.CondTarPlan)
        BusObg.CondTarPlan=0;
   end;

   if (BusObg.CondTarPlan != 0)
      BusCredit.CondTarPlan = BusObg.CondTarPlan;
   else 
      var TPLANTCRID = CRsdCommand ("SELECT T_TPLANTCRID FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", BusCredit.creditType,
                                           "p2", BusCredit.TarPlan,
                                           V_INTEGER);

      var res2;
      var TarPlanCond = CRsdCommand ("SELECT t_flagtpwconditions FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", BusCredit.creditType,
                                           "p2", BusCredit.TarPlan,
                                           V_STRING);


      if ((TarPlanCond == SET_CHAR ))     
      
         var TypeProc = CRsdCommand ("SELECT t_FlagDistribFuncCalc  FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ? ",
                                           "p1", BusCredit.creditType,
                                           "p2", BusCredit.TarPlan,
                                           V_STRING);

         if(TypeProc == SET_CHAR) //Если указана дистрибутивная функция
            var  cmd2 = RsdCommand(RslDefCon, "begin ? :=RSI_LoansTariff.autogettplancondition( ?,?,?,? ); end;" );
            cmd2.addParam( "retval", RSDBP_RETVAL, V_INTEGER );
            cmd2.AddParam("", NULL, TPLANTCRID);
            cmd2.AddParam("", NULL, BusCredit.sum);
            cmd2.AddParam("", NULL, BusCredit.regDate );
            cmd2.AddParam("", NULL, BusCredit.returnDate);
   
            cmd2.execute();
            res2 = cmd2.value(0);
         end;

         if(TypeProc == UNSET_CHAR)
            var UserProc = CRsdCommand ("SELECT t_UserDefFuncCalc  FROM dtplan_tcr_dbt WHERE T_TPLANTCRID = ?  ",
                                           "p1", TPLANTCRID,//BusCredit.TarPlan,
                                            V_STRING);
            var  cmd3 = RsdCommand(RslDefCon, "begin ? :="+UserProc+ "( ?,?,?,? ); end;" );
            cmd3.addParam( "retval", RSDBP_RETVAL, V_INTEGER );
            cmd3.AddParam("", NULL, TPLANTCRID);
            cmd3.AddParam("", NULL, BusCredit.sum);
            cmd3.AddParam("", NULL, BusCredit.regDate );
            cmd3.AddParam("", NULL, BusCredit.returnDate);
   
      cmd3.execute();
      res2 = cmd3.value(0);

       end;

   if (res2 > 0)
      BusObg.CondTarPlan = res2;
      BusCredit.CondTarPlan = BusObg.CondTarPlan;
   else
      RunError("Невозможно подобрать условие тарифной сетки", 18747);
   end;

   end;
 
   end;
       BusCredit.TarPlan = BusObg.TarPlan;
       BusCredit.CondTarPlan = BusObg.CondTarPlan;

  ///Если передан массив
  BusCredit.tariff.size = 0;
  if ((BusObg.tariff != NULL) AND (BusObg.tariff[0] != NULL))
     for(i, 0, BusObg.tariff.size - 1, 1)
         Tar = TTariff();
         Tar.type = BusObg.tariff[i].type;
         Tar.hist.size = 0;
       if ((BusObg.tariff[i].hist != NULL) AND (BusObg.tariff[i].hist[0] != NULL))
           for(j, 0, BusObg.tariff[i].hist.size - 1, 1)
              TarHist = TTarHist();
              TarHist.date       = BusObg.tariff[i].hist[j].date;
              TarHist.calendar   = BusObg.tariff[i].hist[j].calendar;
              TarHist.valueBase  = BusObg.tariff[i].hist[j].valueBase;
              if(TarHist.valueBase == NULL)
                  TarHist.valueBase = 1;
              end;

              TarHist.dayInMonth = BusObg.tariff[i].hist[j].dayInMonth;
              if(TarHist.dayInMonth == NULL)
                  TarHist.dayInMonth = 0;
              end;

              TarHist.isFormulaValue = BusObg.tariff[i].hist[j].isFormulaValue;
              TarHist.value = BusObg.tariff[i].hist[j].value;
              Tar.hist[Tar.hist.size] = TarHist;
            end;
         end;

         BusCredit.tariff[BusCredit.tariff.size] = Tar;
      end;
   end;
 end;

macro ReadObjUpTCreditContr(BusObg)
   var i:integer,j:integer;
   var Tar:TTariff;
   var TarHist:TTarHist;
   var TarPlanFlag;
   var ProcName;
   var TarTypeCrd;

   
   BusCredit.id                = BusObg.id;

   BusCredit.number            = BusObg.number;

   BusCredit.returnDate        = BusObg.returnDate;

   BusCredit.RegDate           = date(0,0,0);

   if(BusCredit.returnDate == NULL)
      BusCredit.returnDate = date(0,0,0);
   end;


   BusCredit.territorialStruct = BusObg.territorialStruct;

   BusCredit.groupNum          = BusObg.groupNum;
   if(BusCredit.groupNum == NULL)
      BusCredit.groupNum = 0;
   end;
   BusCredit.userType          = BusObg.userType;
   if(BusCredit.userType == NULL)
     BusCredit.userType = "";
   end;
   BusCredit.privilege         = BusObg.privilege;

   BusCredit.specific          = BusObg.specific;
   if(BusCredit.specific == NULL)
     BusCredit.specific = "";
   end;
   BusCredit.sum               = BusObg.sum;

   BusCredit.repDate           = BusObg.repDate;

   BusCredit.beforeDutyIsInd   = BusObg.beforeDutyIsInd;

   BusCredit.fineCondIsInd     = BusObg.fineCondIsInd;

   BusCredit.indClassification = BusObg.indClassification;


   BusCredit.userField1        = BusObg.userField1;
   if((BusCredit.userField1 == NULL) OR (Trim(BusCredit.userField1) == 0))
      BusCredit.userField1 = "";   
   end;

   BusCredit.userField2        = BusObg.userField2;
   if((BusCredit.userField2 == NULL) OR (Trim(BusCredit.userField2) == 0))
      BusCredit.userField2 = "";   
   end;

   if (not BusObg.TarPlan)
        BusObg.TarPlan=0;
   end;

   if (BusObg.TarPlan != 0)
      BusCredit.TarPlan = BusObg.TarPlan;
   else
      
  FindCrd(@BusCredit.ID, BusCredit.Number, creditBuff); 
   //  Loans_FindCrdContract(BusCredit.id, creditBuff);
     // BusObg.creditType = creditBuff.CREDITTYPEID_REF;

      TarPlanFlag = CRsdCommand ("SELECT t_flagusetrffplan FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", creditBuff.CREDITTYPEID_REF,
                                           V_INTEGER);
      if (TarPlanFlag>0)
         ProcName = CRsdCommand ("SELECT t_functiontp FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", creditBuff.CREDITTYPEID_REF,
                                           V_STRING);

         
         var  cmd = RsdCommand(RslDefCon, "begin ? :="+ProcName+"( ?,?,?,?,? ); end;" );
         cmd.addParam( "retval", RSDBP_RETVAL, V_INTEGER );
         cmd.AddParam("", NULL, creditBuff.CREDITTYPEID_REF);
         cmd.AddParam("", NULL, creditBuff.curcode);
         cmd.AddParam("", NULL, creditBuff.clientid_ref);
         cmd.AddParam("", NULL, LO_CREDIT);
         cmd.AddParam("", NULL, creditBuff.regDate);
   
         cmd.execute();
         var res = cmd.value(0);
         if (res > 0)
            TarTypeCrd = CRsdCommand ("SELECT T_TRFFPLANID FROM DTPLAN_TCR_DBT WHERE T_TPLANTCRID = ? ",
                                     "p1", res,
                                      V_INTEGER);
            BusObg.TarPlan = TarTypeCrd;
            BusCredit.TarPlan = BusObg.TarPlan;
      else
         RunError("Невозможно подобрать тарифный план", 18746);
      end;

      end;
   end;

   if (not BusObg.CondTarPlan)
        BusObg.CondTarPlan=0;
   end;

   if (BusObg.CondTarPlan != 0)
      BusCredit.CondTarPlan = BusObg.CondTarPlan;
   else
     // Loans_FindCrdContract(BusCredit.id, creditBuff);
     FindCrd(@BusCredit.ID, BusCredit.Number, creditBuff);
     // BusCredit.creditType = creditBuff.CREDITTYPEID_REF; 
      var TPLANTCRID = CRsdCommand ("SELECT T_TPLANTCRID FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", creditBuff.CREDITTYPEID_REF,
                                           "p2", BusCredit.TarPlan,
                                           V_INTEGER);

     
      var res2;
      var TarPlanCond = CRsdCommand ("SELECT t_flagtpwconditions FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", creditBuff.CREDITTYPEID_REF,
                                           "p2", BusCredit.TarPlan,
                                           V_STRING);


      if ((TarPlanCond == SET_CHAR ))     
         var TypeProc = CRsdCommand ("SELECT t_FlagDistribFuncCalc  FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ? ",
                                           "p1", creditBuff.CREDITTYPEID_REF,
                                           "p2", BusCredit.TarPlan,
                                           V_STRING);
         BusCredit.regDate = BusObg.regDate;

         if(TypeProc == SET_CHAR) //Если указана дистрибутивная функция
            var  cmd2 = RsdCommand(RslDefCon, "begin ? :=RSI_LoansTariff.autogettplancondition( ?,?,?,? ); end;" );
            cmd2.addParam( "retval", RSDBP_RETVAL, V_INTEGER );
            cmd2.AddParam("", NULL, TPLANTCRID);
            cmd2.AddParam("", NULL, creditBuff.creditsum);
            cmd2.AddParam("", NULL, creditBuff.regDate );
            cmd2.AddParam("", NULL, BusCredit.returnDate);
   
            cmd2.execute();
            res2 = cmd2.value(0);
         end;

         if(TypeProc == UNSET_CHAR)
            var UserProc = CRsdCommand ("SELECT t_UserDefFuncCalc  FROM dtplan_tcr_dbt WHERE T_TPLANTCRID = ?  ",
                                           "p1", TPLANTCRID,//BusCredit.TarPlan,
                                            V_STRING);
            var  cmd3 = RsdCommand(RslDefCon, "begin ? :="+UserProc+ "( ?,?,?,? ); end;" );
            cmd3.addParam( "retval", RSDBP_RETVAL, V_INTEGER );
            cmd3.AddParam("", NULL, TPLANTCRID);
            cmd3.AddParam("", NULL, creditBuff.creditsum);
            cmd3.AddParam("", NULL, creditBuff.regDate );
            cmd3.AddParam("", NULL, BusCredit.returnDate);
   
      cmd3.execute();
      res2 = cmd3.value(0);

       end;

   if (res2 > 0)
      BusObg.CondTarPlan = res2;
      BusCredit.CondTarPlan = BusObg.CondTarPlan;
   else
      RunError("Невозможно подобрать условие тарифной сетки", 18747);
   end;

   end;
 
   end;
       BusCredit.TarPlan = BusObg.TarPlan;
       BusCredit.CondTarPlan = BusObg.CondTarPlan;

  ///Если передан массив
  BusCredit.tariff.size = 0;
  if ((BusObg.tariff != NULL) AND (BusObg.tariff[0] != NULL))
     for(i, 0, BusObg.tariff.size - 1, 1)
         Tar = TTariff();
         Tar.type = BusObg.tariff[i].type;
         Tar.hist.size = 0;
       if ((BusObg.tariff[i].hist != NULL) AND (BusObg.tariff[i].hist[0] != NULL))
           for(j, 0, BusObg.tariff[i].hist.size - 1, 1)
              TarHist = TTarHist();
              TarHist.date       = BusObg.tariff[i].hist[j].date;
              TarHist.calendar   = BusObg.tariff[i].hist[j].calendar;
              TarHist.valueBase  = BusObg.tariff[i].hist[j].valueBase;
              if(TarHist.valueBase == NULL)
                  TarHist.valueBase = 1;
              end;

              TarHist.dayInMonth = BusObg.tariff[i].hist[j].dayInMonth;
              if(TarHist.dayInMonth == NULL)
                  TarHist.dayInMonth = 0;
              end;

              TarHist.isFormulaValue = BusObg.tariff[i].hist[j].isFormulaValue;
              TarHist.value = BusObg.tariff[i].hist[j].value;
              Tar.hist[Tar.hist.size] = TarHist;
            end;
         end;

         BusCredit.tariff[BusCredit.tariff.size] = Tar;
      end;
   end;


end;

macro ReadBusObj(BusTLoansAccount:TArray)
   var i:integer;
   var AccRec:TLoansAccount;

   LoansAccount.size = 0;
   if ((BusTLoansAccount.size>0) AND(BusTLoansAccount != NULL) AND (BusTLoansAccount[0] != NULL))
      for(i, 0, BusTLoansAccount.size - 1, 1)
         AccRec = TLoansAccount();

         AccRec.AccCategID       = BusTLoansAccount[i].AccCategID;
         //Если категория не передана, заполним ее поумолчанию
         if((BusTLoansAccount[i].AccCategID == NULL) OR (BusTLoansAccount[i].AccCategID == 0))
            AccRec.AccCategID       = CRD_ACC;
         end;
         
        
         AccRec.AccountNumber    = BusTLoansAccount[i].AccountNumber;
         if (Trim(BusTLoansAccount[i].CurCode))
            AccRec.CurCode          = BusTLoansAccount[i].CurCode;
         else
            AccRec.CurCode          = ПолучитьКодФинИн(creditBuff.CurCode,  0, FICK_ISONUMBER);
         end;                                      
         // Если счет ОДБ не передан, заполним его по счету Лоанса
         if(Trim(BusTLoansAccount[i].ODBAccountNumber) == "")
            AccRec.ODBAccountNumber = AccRec.AccountNumber;
            AccRec.ODBCurCode       = AccRec.CurCode;
         else
           AccRec.ODBAccountNumber = BusTLoansAccount[i].ODBAccountNumber;
           AccRec.ODBCurCode       = BusTLoansAccount[i].ODBCurCode;
         end;    
         if (Trim(AccRec.ODBCurCode)=="")
            AccRec.ODBCurCode      = AccRec.CurCode;
         end;
         LoansAccount[i] = AccRec;
      end;
   end;   
end;

private macro CheckTCreditContr(operdate:date, BusCrd:TCreditContr, mode)
// 1 - Вставка/Открытие КД
// 0 -  Изменение
   var rs, RSDCmd;
   var count:integer, RateTypeID:integer, AlgTypeID:integer, ParentFilial:integer;                                                                                                          
   var i:integer, j:integer;
   if(mode==NULL)
       mode=1;
   end;
   ///////////////////////////////////////////////////////////////////////////////
   //Проверки для Вставки договора
   if(mode==1)
       var reqParam:string;
       if ((not (reqParam = "regDate"))OR(BusCrd.regDate == NULL)OR(not (reqParam = "ReturnDate"))OR(BusCrd.ReturnDate == NULL)OR(not (reqParam = "CreditNumber"))OR(BusCrd.Number == NULL))
          RunError("Не передан обязательный параметр: "+reqParam, 18703);
       end;
       BusCrd.client = CRsdCommand ("SELECT t_partyid FROM dparty_dbt WHERE t_partyid = ? AND t_legalform = ?",
            "p1", BusCrd.client,
            "p2", 2,  // Физ. лицо
             V_INTEGER);
       if(BusCrd.client == 0)
            RunError("Клиент не зарегистрирован", 18501);   
       end;
    
       RSDCmd = RsdCommand(RslDefCon, " SELECT tcr.*,FIN.T_ISO_NUMBER curcode FROM dtype_crd_dbt tcr,dfininstr_dbt fin "+
                               "  WHERE     tcr.t_credittypeid = ? AND tcr.t_state = ? "+
                               "  AND tcr.t_crd_kind = ? AND tcr.t_typeoverdraft = ? AND TCR.T_CURCODE = FIN.T_FIID");

       RSDcmd.addParam ("CrdT",     RSDBP_IN); RSDcmd.value ("CrdT") = BusCrd.creditType;
       RSDcmd.addParam ("state",    RSDBP_IN); RSDcmd.value ("state") = CF_OPEN;
       RSDcmd.addParam ("crd_kind", RSDBP_IN); RSDcmd.value ("crd_kind") = LO_CREDIT;
       RSDcmd.addParam ("TOv", RSDBP_IN);      RSDcmd.value ("TOv") = 1;

       rs = RsdRecordset(RSDcmd);

       if(rs.MoveNext)
          if((operdate < rs.Value("t_BegDate", null, V_DATE))OR(BusCrd.regDate < rs.Value("t_BegDate", null, V_DATE)))
             RunError("Нельзя открыть договор раньше начала предоставления вида кредита", 18504);
        end;
          if(BusCredit.currency ==0)
             BusCredit.currency = rs.Value("curcode", null, V_STRING);
          end;
          if(BusCredit.currency != rs.Value("curcode", null, V_STRING))
             RunError("Валюта не соответствует виду кредитного договора", 18524);
          end;
       else
          RunError("Некорректный вид кредита", 18502);
       end;
       if(BusCrd.regDate > BusCrd.returnDate)
          RunError("Дата начала действия договора превышает дату окончания действия", 18505);
       end;

       if((BusCrd.sum == NULL) OR (BusCrd.sum == 0))
          RunError("Сумма не задана", 18511);
       end;
   else
   // Изменение КД
       if((BusCrd.returnDate != date(0,0,0))AND(BusCrd.ReturnDate < operdate))
          RunError("Дата окончания договора должна быть позже даты операции",18620);
       end;

       if (LoansAccount.size>0)
          CheckLoansAccount(LoansAccount);
       end;
     //сумма
       if (BusCrd.sum)
          var isPayed = CRSDCommand("SELECT 1 FROM dcrd_op_dbt t, dtype_op_dbt d WHERE d.t_systtypeop_ref = ? AND t.t_opertypenumber_ref = d.t_typeopernumber AND t.t_creditnumber_ref = ? AND t.t_objecttypeid_ref = ? AND t.t_isdeleted = 0", 
                               "p1", CF_PAY, "p2", BusCredit.ID, "p3", LO_CREDIT, V_INTEGER);
          if (isPayed)
             RunError("Выдача кредита уже выполнена. Изменение суммы недоступно", 18621);
          end;
       end;
   end;
   ///////////////////////////////////////////////////////////////////////////////////////////////
   //---------------общий функционал
   if(operdate > {curdate})
      RunError("Дата операции превышает текущий опердень", 18503);
   end;



   if(BusCrd.territorialStruct != NULL) 
      BusCrd.territorialStruct = CRsdCommand ("SELECT t_code FROM ddp_dep_dbt WHERE t_code = ? AND t_status = ?",
                               "p1", BusCrd.territorialStruct,
                               "p2", 2,  // DEPARTMENT_STATUS_ACTIVE - Узел ТС открыт
                               V_INTEGER);
      if(BusCrd.territorialStruct == 0)
         RunError("Некорректное подразделение ТС", 18506);
      end;

      ParentFilial = CRsdCommand ("SELECT t_code "+
                                  "  FROM (    SELECT level Lev, t_code, MIN (level) OVER () minL "+
                                  "              FROM ddp_dep_dbt "+
                                  "             WHERE t_nodetype = ? "+
                                  "        START WITH t_code = ? "+
                                  "        CONNECT BY t_code = PRIOR t_parentcode) "+
                                  " WHERE Lev = minL",
                        "p1", 1,  // DEPARTMENT_TYPE_FILIAL - Филиал
                        "p2", BusCrd.territorialStruct,
                        V_INTEGER);
      if(ParentFilial != {OperDprt})
         RunError("Подразделение ТС не принадлежит текущему филиалу", 18507);
      end;      
   end;

   if((BusCrd.groupNum != NULL) AND (BusCrd.groupNum != 0))
      BusCrd.groupNum = CRsdCommand ("SELECT t_groupid FROM dacsgroup_dbt WHERE t_groupid = ?",
                         "p1", BusCrd.groupNum,
                                         V_INTEGER);
      if(BusCrd.groupNum == 0)
         RunError("Группа бухгалтеров задана неверно", 18508);
      end;
   end;

   if( Trim(BusCrd.userType) != "")
      count = CRsdCommand ("SELECT COUNT(*) FROM dtypeac_dbt "+
                           " WHERE REGEXP_LIKE (UPPER(t_type_account), ?) "+
                           "   AND t_inumtype = ?",
                      "p1", "(["+StrUpr(Trim(BusCrd.userType))+"])",
                           "p2", 101,                      // Пользовательские ВК
                           V_INTEGER);
      if(count != StrLen(Trim(BusCrd.userType)))
         RunError("Пользовательские виды кредитов заданы неверно", 18509);
      end;
   end;
   
   if( Trim(BusCrd.specific) != "")
      count = CRsdCommand ("SELECT COUNT(*) FROM dspec_crd_dbt WHERE REGEXP_LIKE (t_code, ? ) ",
                                 "p1", "(["+Trim(BusCrd.specific)+"])",
                                 V_INTEGER);
      if(count != StrLen(Trim(BusCrd.specific)))
         RunError("Целевое назначение кредита задано неверно", 18510);
      end;
   end;
 
   //Проверка по тарифам
   var  TarPlanCond;
   var  TarPlanFlag;
   

   if (BusCrd.creditType)
      TarPlanFlag = CRsdCommand ("SELECT t_flagusetrffplan FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", BusCrd.creditType,
                                      V_INTEGER);
   else
     Loans_FindCrdContract(BusCredit.id, creditBuff);
     if (creditBuff.CREDITTYPEID_REF >0) 
     TarPlanFlag = CRsdCommand ("SELECT t_flagusetrffplan FROM dtype_crd_dbt WHERE t_credittypeid = ? ",
                                     "p1", creditBuff.CREDITTYPEID_REF,
                                   V_INTEGER);
      BusCrd.creditType = creditBuff.CREDITTYPEID_REF;
     end;
       
   end;
    var TPLANTCRID = CRsdCommand ("SELECT T_TPLANTCRID FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", BusCredit.creditType,
                                           "p2", BusCredit.TarPlan,
                                           V_INTEGER);

 
   if((BusCrd.TarPlan > 0) AND (TarPlanFlag == 0))
      RunError("Недопустимое использование тарифного плана", 18741);
   end;

   if ((BusCrd.TarPlan == 0) AND (BusCrd.CondTarPlan > 0 ))
       RunError("Недопустимое использование тарифного плана", 18742);
   end;

   if ((BusCrd.CondTarPlan > 0))
        TarPlanCond = CRsdCommand ("SELECT t_flagtpwconditions FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", BusCrd.creditType,
                                           "p2", BusCrd.TarPlan,
                                           V_STRING);
        if ((TarPlanCond == UNSET_CHAR ))               
            RunError("Недопустимое использование условия тарифного плана", 18742);
        end;
   end;
  //TPLANTCRID = 
    if((BusCrd.TarPlan > 0))
          TarPlanCond = CRsdCommand ("SELECT T_CREDITTYPEID FROM dtplan_tcr_dbt WHERE T_TRFFPLANID = ? AND T_TPLANTCRID = ?",
                                           "p1", BusCrd.TarPlan,
                                           "p2", TPLANTCRID,
                                           V_INTEGER);
     if (BusCrd.creditType)                   
          if(TarPlanCond != BusCrd.creditType)
             RunError("Тарифный план задан неверно", 18743);
          end;
       else
          if(TarPlanCond != creditBuff.CREDITTYPEID_REF)
             RunError("Тарифный план задан неверно", 18743);
          end;
       end;
   end; 
    
 
   if ((BusCrd.CondTarPlan > 0))
       TarPlanCond = CRsdCommand ("SELECT t_condid FROM DCOND_TPLAN_DBT WHERE t_planid = ?  AND t_condid = ?",
                                      "p1", TPLANTCRID,
                                      "p2", BusCrd.CondTarPlan,
                                      V_INTEGER);  
       if (TarPlanCond!=BusCrd.CondTarPlan)
          RunError("Условие тарифной сетки задано неверно", 18744);
       end;
   end;                              
 
////////Проверяем переданный массив
  for(i, 0, BusCrd.tariff.size - 1, 1)
       for(j, 0, BusCrd.tariff.size - 1, 1)
           if(i != j)
              if(BusCrd.tariff[i].type == BusCrd.tariff[j].type)
                 RunError("Дублируются виды тарифов", 18523);
              end;
           end;
        end;
  end;
   
  for(i, 0, BusCrd.tariff.size - 1, 1)
      RateTypeID = CRsdCommand ("SELECT t_typerateid FROM dtrff_obj_dbt WHERE T_OBJECTTYPEID = ? AND T_TYPERATEID  = ?",
                                     "p1", LO_CREDIT,
                                     "p2", BusCrd.tariff[i].type,              
                                      V_INTEGER);

      if(RateTypeID == 0)
         RunError("Вид тарифа №"+ BusCrd.tariff[i].type +" недопустим для объекта \"Кредитный договор\" ", 18514);
      end;
  end;
   
   for(i, 0, BusCrd.tariff.size - 1, 1)
     for(j, 0, BusCrd.tariff[i].hist.size - 1, 1)
       var type  = CRsdCommand ("SELECT TP.T_TYPE FROM dlctypuse_dbt tp WHERE TP.T_TYPERATEID  = ?",
                                           "p1", BusCrd.tariff[i].type,
                                           V_INTEGER);
      
       if (type == 1)
         if((BusCrd.tariff[i].hist[j].calendar == NULL) OR (BusCrd.tariff[i].hist[j].calendar < 1) OR (BusCrd.tariff[i].hist[j].calendar > 4))
            RunError("Тип базы календаря тарифа задан неверно", 18518);
         end;
         if((BusCrd.tariff[i].hist[j].DayInMonth != NULL))
            var rsDays, RSDCmdDays;
            RSDCmdDays = RsdCommand(RslDefCon, " SELECT * FROM dlctypuse_dbt "+
                                               "  WHERE T_TYPERATEID = ? ");
            RSDCmdDays.addParam ("TYPERATEID",     RSDBP_IN); RSDCmdDays.value ("TYPERATEID") = BusCrd.tariff[i].type;

            rsDays = RsdRecordset(RSDCmdDays);
      
          if(rsDays.MoveNext)
             var flagfixnumdays = rsDays.Value("T_FLAGFIXNUMDAYS", null, V_STRING);
             var dayinmon = rsDays.Value("T_DAYINMON", null, V_INTEGER);
          else
             RunError("Недопустимое количество дней в месяце", 18745);
          end;

          if((BusCrd.tariff[i].hist[j].DayInMonth ==0) and (flagfixnumdays ==SET_CHAR))
              RunError("Недопустимое количество дней в месяце", 18745);
          end;

      end;
      end;

     end;
  end;

   return true;
end;

//macro InsertTariff(ObjID:integer, ObjN:integer,  CalcDate:date, ObjID_OUT:integer, ObjN_OUT:integer, Tarr:TTariff)
macro InsertTariff(ObjID:integer, ObjN:integer,  CalcDate:date, ObjID_OUT:integer, ObjN_OUT:integer, Tarriff:Tarray)
   var TarCredit = TArray(0), i:integer, j:integer;
   var Tarr:TTariff;
      

   i = 0;      
   while(i < Tarriff.size)
      j = 0;
      while(j < Tarriff[i].hist.size)
         TarCredit[TarCredit.Size] = Tarriff[i].type;

         TarCredit[TarCredit.Size] = date(0,0,0);
         if(Tarriff[0].hist[0].date != NULL)
            TarCredit[TarCredit.Size - 1] = Tarriff[i].hist[j].date;
         end;

     
         TarCredit[TarCredit.Size] = 4;
         if(Tarriff[i].hist[j].calendar != NULL)
            TarCredit[TarCredit.Size - 1] = Tarriff[i].hist[j].calendar;
         end;

         TarCredit[TarCredit.Size] = 1;
         if(Tarriff[i].hist[j].valueBase != NULL)
            TarCredit[TarCredit.Size - 1] = Tarriff[i].hist[j].valueBase;
         end;

         TarCredit[TarCredit.Size] = 0;
         if(Tarriff[i].hist[j].dayInMonth != NULL)
            TarCredit[TarCredit.Size - 1] = Tarriff[i].hist[j].dayInMonth;
         end;

         IF (Tarriff[i].hist[j].isFormulaValue == true)   
            TarCredit[TarCredit.Size] = string(SET_CHAR);
         ELSE
            TarCredit[TarCredit.Size] = string(UNSET_CHAR);
         END;

         TarCredit[TarCredit.Size] = string(0);
         if(Tarriff[i].hist[j].VALUE != NULL)
            //if (Tarr.hist[i].isFormulaValue==false)
            //TarCredit[TarCredit.Size - 1] =double(Tarr.hist[i].VALUE);

           //else
             TarCredit[TarCredit.Size - 1] =string(Tarriff[i].hist[j].VALUE);
           //end;

         end;
      
      j = j + 1;
      end;
      i = i + 1;
   end;

   var opid = MakeOperation(ObjN, ObjID, CF_RATE, 0, CalcDate,TarCredit);
   if(opid== 0)
      RunError("Ошибка при установке тарифов :|" + GetMO_LoansError(), 18748);
   end;

   return true;

end;

macro InsertCreditContractTRN()
   var rs, RSDCmd;
   var crdop:integer=0, i:integer;

   creditBuff.CreditNumber = 0;
   creditBuff.DURATION     = BusCredit.RETURNDATE - BusCredit.REGDATE;
   creditBuff.TYPEDURATION = 1;

   creditBuff.TERRITORIALSTRUCT = {OperDprtNode};   
   if((BusCredit.territorialStruct != NULL) AND (BusCredit.territorialStruct != 0))
      creditBuff.TERRITORIALSTRUCT = BusCredit.territorialStruct;
   end;

   creditBuff.PAYTYPE     = CF_NONREP; // Разовый
   creditBuff.CRD_KIND    = LO_CREDIT;
   creditBuff.FNCASH      = {OperDprt};
   creditBuff.CREDITSTATE = CF_OPEN;
   creditBuff.LEGALFORM   = 2;    // Физ лицо
   creditBuff.TypeDebtor  = 2;   // Физ лицо
   creditBuff.FlagOB      = SET_CHAR;
   if((BusCredit.groupNum!=0)AND(BusCredit.groupNum!=NULL))
       creditBuff.GroupNum    = BusCredit.groupNum;
   end;
   if((BusCredit.UserType!=0)AND(BusCredit.UserType!=NULL))
       creditBuff.UserType    = BusCredit.userType;
   end;
   if((BusCredit.Specific!=0)AND(BusCredit.Specific!=NULL))
       creditBuff.Specific    = BusCredit.Specific;
   end;

   creditBuff.USCREDITNUMBER   = BusCredit.number;
   creditBuff.REGDATE          = BusCredit.REGDATE;
   creditBuff.RETURNDATE       = BusCredit.RETURNDATE;

   creditBuff.RepDate          = date(0,0,0);
   if((BusCredit.RepDate != NULL) AND (BusCredit.RepDate != date(0,0,0)))
      creditBuff.RepDate       = BusCredit.RepDate;
   end;

   creditBuff.CREDITSUM        = BusCredit.SUM;
   creditBuff.CREDITTYPEID_REF = BusCredit.creditType;
   creditBuff.ClientID_Ref     = BusCredit.client;
   
   creditBuff.PrivilegeFlag    = UNSET_CHAR;
   if((BusCredit.privilege!= NULL) AND (BusCredit.privilege))
      creditBuff.PrivilegeFlag    = SET_CHAR;
   end;
   
   creditBuff.BeforeDuty = 0;
   if((BusCredit.beforeDutyIsInd != NULL) AND (BusCredit.beforeDutyIsInd))
      creditBuff.BeforeDuty = 1;   
   end;

   creditBuff.FineCond = 0;
   if((BusCredit.fineCondIsInd != NULL) AND (BusCredit.fineCondIsInd))
      creditBuff.FineCond = 1
   end;

   if((BusCredit.ANNUIT != NULL) AND (BusCredit.ANNUIT))
      creditBuff.ANNUIT = SET_CHAR;
   end;

   if((BusCredit.indClassification != NULL) AND (BusCredit.indClassification))
      creditBuff.indClassification = SET_CHAR;
   end;

   creditBuff.UserField1 = BusCredit.UserField1;
   creditBuff.UserField2 = BusCredit.UserField2;

   creditBuff.CURCODE =ПолучитьКодФинИн(string( BusCredit.currency),  0, FICK_ISONUMBER);
   var TPLANTCRID = CRsdCommand ("SELECT T_TPLANTCRID FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", BusCredit.creditType,
                                           "p2", BusCredit.TarPlan,
                                           V_INTEGER);

   creditBuff.TPlanTcrId = TPLANTCRID; //Тарифный план
   creditBuff.CondId =  BusCredit.CondTarPlan;//Условие тарифного плана
   RSDCmd = RsdCommand(RslDefCon, " SELECT * FROM dtype_crd_dbt WHERE t_credittypeid = ?");
   RSDcmd.addParam ("", RSDBP_IN); RSDcmd.value ("") = BusCredit.creditType;

   rs = RsdRecordset(RSDcmd);
   // Выполняем операцию "открытие договора"
     crdop = MakeOperation(0, 0, CF_OPCRD, 0, OpDate, creditBuff);
     if(crdop == 0)
        RunError("Ошибка в операции открытия кредитного договора:|" + GetMO_LoansError(), 18519);
        return 0;
     end;

   creditBuff.creditnumber = CRsdCommand ("SELECT t_creditnumber_ref FROM dcrd_op_dbt WHERE t_credoperid = ?",
                                 "p1", crdop,
                                  V_INTEGER);

   var opid;
   if  (BusCredit.tariff.size == 0)
       if (not creditBuff.CondId) //Если тарифный план без условия
          opid = MakeOperation(creditBuff.creditnumber, LO_CREDIT, CF_RATE, 0, OpDate,0,creditBuff.TPlanTcrId,40);

       else 
         opid = MakeOperation(creditBuff.creditnumber, LO_CREDIT, CF_RATE, 0, OpDate,0,creditBuff.CondId,39);

       end;
   else ///если передан массив
      if(NOT InsertTariff(LO_CREDIT, creditBuff.creditnumber,  OpDate, BusCredit.creditType, LO_TYPECREDIT,  BusCredit.tariff))
          return false;
      end;

  
   end;

   if(opid == 0)
      RunError("Ошибка при установке тарифов:|" + GetMO_LoansError(), 18748);
      return 0;
   end;
 

   CrdNumber = creditBuff.creditnumber;

   if (CrdNumber > 0)
     return true;
   else
     return false;
   end;

    //сюда попадем, если было выброшено исключение.
   OnError(err)
      if(ValType(err.Err) == V_INTEGER)
         ErrManager.SetError(err.Err, err.Message);
      else
         ErrManager.SetError(err.Code, err.Message);
      end;

    
end;

macro InsertCreditContract( operdate:date, BusCrd)    
   NumServ = NumServ_InsertCreditContract;
   var i:integer;
   var stat:bool = false;

   OpDate = operdate;
   if((OpDate == NULL) OR (OpDate == date(0,0,0)))
      OpDate = {curdate};    
   end;

   // Прочитаем данные, пришедшие из ТК
   ReadObjInTCreditContr(BusCrd);
   
   // Если нужно, то проверим
   if(NOT SKIP_TCreditContr_CHECK)
      if(NOT CheckTCreditContr(OpDate,BusCredit, 1))
         return 0;
      end;
   end;
  
   // Если нужно, то проверим пользовательской функцией
   if(NOT skip_user_chec.InsertCreditContract)
      if(NOT InsertCreditContractUserCheck(NumServ,OpDate,BusCredit))
         return 0;
      end;
   end;

   // запустим транзакцию
   if(RtTrn("InsertCreditContractTRN"))
      SynchCreditdData(creditBuff);
      return CrdNumber;
   end;
   
   // Если в транзакции возникла ошибка, выбросим ее в ТК
   if (ErrManager.GetErrCode() != 0) 
      ErrManager.RunErr();
   end;
    
   return 0;

end;

macro UpdateCreditContractTRN()
   var  credit = TBfile("credit_c.dbt", "W", 0,"credit_c.dbt", "loans.def");
   var  acc    = TBfile("acc_crd.dbt",  "r", 1,"acc_crd.dbt",  "loans.def");
   var  accODB = TBfile("SB_acc.dbt",   "r", 1,"SB_acc.dbt",   "loans.def");
   var rs, RSDCmd;
   var ObjN,ObjID,CrdType:integer;
   record cat_type ("cat_type.dbt", "loans.def");
   var crdop:integer=0, i:integer;
   var perfOp:integer;
   var indCls:string;
   var AccN="",AccNODB="";
   var acc_mac = TArray(0);

   file   prty ("party.dbt", "bank.def");
   file   prsn ("persn.dbt", "bank.def");         
   
   prty.partyid = credit.Rec.clientid_ref;
   if(GetEQ(prty))
      prsn.personid = credit.Rec.clientid_ref;
      if(NOT GetEQ(prsn))
         RunError("Клиент не зарегистрирован", 18501);
      end;
   end;

   var MO_acc:integer =0;
   perfOp=0;//Ключ показывает, что было выполение операций по изменению срока иди суммы
   credit.Rewind();

   if(BusCredit.id != NULL) 
      credit.Rec.creditnumber = BusCredit.ID; 
   else
      credit.keynum=7;
      credit.Rec.UsCreditNumber = BusCredit.number; 
      credit.Rec.FNCASH = {OperDprt}; 
      credit.Rec.CRD_Kind = LO_CREDIT; 
   end;
   if(NOT credit.GetEQ())
      RunError("Кредитный договор не зарегистрирован", 18541);
   end;

   ObjN    = credit.Rec.creditnumber;
   ObjID   = credit.rec.crd_kind;
   CrdType = credit.Rec.credittypeid_ref;
   if(BusCredit.returndate !=date(0,0,0))
   //пролонгация или сокращение
      //Подготавливаем счета
      for(i, 0,  LoansAccount.size - 1, 1)
            // Поиск выполняется с учетом предположения, что счет открывается по категории, настроенной для конкретного вида объекта!
         if(NOT Loans_FindCatType(1, 0, CrdType, LoansAccount[i].AccCategID, -1, LO_CREDIT, cat_type))
            if(NOT Loans_FindCatType(1, 0, CrdType, LoansAccount[i].AccCategID, LoansAccount[i].CurCode, LO_CREDIT, cat_type))
               if(NOT Loans_FindCatType(1, 0, CrdType, LoansAccount[i].AccCategID, LoansAccount[i].CurCode, 0, cat_type))
                  if(NOT Loans_FindCatType(1, 0, CrdType, LoansAccount[i].AccCategID, -1, 0, cat_type))
                     RunError("Для вида кредита не настроена Категория учета №"+LoansAccount[i].AccCategID+" ", 18563);
                  end;
               end;
            end;
         end;

         acc.keynum=1;
         acc.rec.objectNumber = ObjN;  
         acc.rec.objectid = ObjID;
         acc.rec.creditaccounttype = LoansAccount[i].AccCategID;
         acc.rec.curcode = credit.Rec.CurCode;
         if (acc.getGE())
            accN=acc.rec.Accountnumber_ref;
            accODB.rec.accountID = acc.rec.accid;
            if (accODB.getEQ())
               accNODB=accODB.rec.ODBAccount;
            end;
         end;  
         if (LoansAccount[i].AccountNumber != AccN)
            acc_mac[acc_mac.size]  = cat_type.AccCategID;                           //    CatTypeID_Ref
            acc_mac[acc_mac.size]  = LoansAccount[i].AccCategID;                    //    AccCategID 
            acc_mac[acc_mac.size]  = int(LoansAccount[i].CurCode);               //    CurCode 
            acc_mac[acc_mac.size]  = cat_type.Chapter;                              //    Chapter
            acc_mac[acc_mac.size]  = cat_type.AccountType;                          //    AccountType  
            acc_mac[acc_mac.size]  = cat_type.SysType;                              //    SysType      
            acc_mac[acc_mac.size]  = cat_type.NotRest;                              //    Status       
            acc_mac[acc_mac.size]  = int(LoansAccount[i].ODBCurCode);               //    CurCodeODB   
            acc_mac[acc_mac.size]  = "O";                                          //    StatusODB
            acc_mac[acc_mac.size]  = LoansAccount[i].AccountNumber;                 //    AccountNumber  
            acc_mac[acc_mac.size]  = AccN;                                          //    OldAccountNumber
            acc_mac[acc_mac.size]  = LoansAccount[i].ODBAccountNumber;              //    AccountNumberODB
            acc_mac[acc_mac.size]  = accNODB;                                       //    OldODBAccountNumber     
            MO_acc=1;
         end;
      end;
      if((BusCredit.ReturnDate > credit.rec.ReturnDate) AND (credit.rec.CreditState == CF_OPEN))
         if(0 == ( SynchAccFlag = MakeOperation(credit.rec.creditnumber, LO_CREDIT, CF_PROL, credit.rec.CURCODE, OpDate, acc_mac, MO_acc, BusCredit.returndate) ))
             RunError("Ошибка в операции пролонгация срока договора:|" + GetMO_LoansError(), 18625);
         end;
      end;
      if((BusCredit.ReturnDate < credit.rec.ReturnDate) AND (credit.rec.CreditState == CF_OPEN))
        // if (0 == ( SynchAccFlag = MakeOperation(credit.rec.creditnumber, LO_CREDIT, CF_SHORT, credit.rec.CURCODE, OpDate, acc_mac, MO_acc, BusCredit.returndate) ))
           if (0 == ( SynchAccFlag = MakeOperation(credit.rec.creditnumber, LO_CREDIT, CF_SHORT, credit.rec.CURCODE, OpDate, acc_mac, MO_acc, BusCredit.returndate) ))

            RunError("Ошибка в операции сокращение срока договора:|" + GetMO_LoansError(), 18624);
         end;      
      end;
      perfOp=1;
   end;
   credit.Update();
   if((BusCredit.sum!=NULL) AND (BusCredit.sum!=credit.rec.CreditSum) AND (credit.rec.CreditState == CF_OPEN))
   //изменяем сумму
      MakeOperation(credit.rec.creditnumber, LO_CREDIT, CF_CHANGE_SUM, 0, OpDate, 0, 0,0,BusCredit.SUM);
      if(GETMO_ErrorID)
         RunError("Ошибка в операции изменения суммы договора:|" + GetMO_LoansError(), 18626);
      end;
      perfOp=1;
   end;
   
   if(PerfOp==1)
   //обновим credit
      credit.GetDirect(credit.GetPos);
   end;
    
  Loans_FindCrdContract(BusCredit.id, creditBuff);
   change_flag=false;

   //Обновим полученные не NULL параметры
   if((BusCredit.territorialStruct != NULL) AND (BusCredit.territorialStruct != creditBuff.TERRITORIALSTRUCT))
      creditBuff.TERRITORIALSTRUCT = BusCredit.territorialStruct;
      change_flag=true;
   end;

   if((BusCredit.groupNum!=credit.rec.GroupNum)AND(BusCredit.groupNum!=NULL))
   creditBuff.GroupNum    = BusCredit.groupNum;
   change_flag=true; 
   end;
   if((BusCredit.UserType!=credit.rec.UserType)AND(BusCredit.UserType!=NULL))
   creditBuff.UserType    = BusCredit.userType;
   change_flag=true;
   end;
   if (BusCredit.privilege != NULL)
      if (BusCredit.privilege)
         creditBuff.PRIVILEGEFLAG =  SET_CHAR;
        // change_flag=true;
      else
         creditBuff.PRIVILEGEFLAG =  UNSET_CHAR;
        // change_flag=true;
      end;
   end;
   if((BusCredit.Specific!= credit.rec.Specific)AND(BusCredit.Specific!=NULL))
      creditBuff.Specific    = BusCredit.Specific;
      change_flag=true;
   end;
   if((BusCredit.RepDate != NULL) AND (BusCredit.RepDate != credit.rec.RepDate ))
      creditBuff.RepDate       = BusCredit.RepDate;
      change_flag=true;
   end;

   if((BusCredit.beforeDutyIsInd != NULL) AND (BusCredit.beforeDutyIsInd!=credit.rec.BeforeDuty))
      if(BusCredit.beforeDutyIsInd) 
         creditBuff.BeforeDuty = 1;
         change_flag=true;
      else
         creditBuff.BeforeDuty = 0; 
         change_flag=true;
      end;
   end;

   if((BusCredit.fineCondIsInd != NULL) AND (BusCredit.fineCondIsInd!=credit.rec.FineCond))
      if(BusCredit.fineCondIsInd) 
        creditBuff.FineCond = 1;
        change_flag=true;
      else
        creditBuff.FineCond = 0;
        change_flag=true; 
      end;
   end;

   if(BusCredit.indClassification) 
      indCls = SET_CHAR;
     // change_flag=true;
   else
      indCls = UNSET_CHAR;
    //  change_flag=true; 
   end;
   if((BusCredit.indClassification != NULL) AND (indCls!=credit.rec.indClassification))
      creditBuff.indClassification = indCls;
      change_flag=true;
   end;
   if((BusCredit.UserField1 != NULL) AND (BusCredit.UserField1 != credit.rec.UserField1 ))
      creditBuff.UserField1       = BusCredit.UserField1;
      change_flag=true;
   end;
   
   if((BusCredit.UserField2 != NULL) AND (BusCredit.UserField2 != credit.rec.UserField2 ))
      creditBuff.UserField2       = BusCredit.UserField2;
      change_flag=true;
   end;
  // credit.Update();

   if (credit.rec.CreditState == CF_OPENDRAFT)
      if ((BusCredit.returnDate != NULL) AND (BusCredit.returnDate !=credit.rec.returnDate))
         credit.rec.returnDate = BusCredit.returnDate;
         credit.rec.DURATION = BusCredit.RETURNDATE - BusCredit.REGDATE;
         credit.rec.TYPEDURATION = CF_DAY; 
      end;

      if ((BusCredit.sum != NULL) AND (BusCredit.sum != credit.rec.CreditSum))
         credit.rec.CreditSum = BusCredit.sum;
      end;

      credit.Update();
   end;

   if (change_flag)
   UpdateCrdTrn(creditBuff); //Вызываем функцию обновления вместо прямого аптейда таблицы
   end;
 
   var BankProductID = CRSDCommand ("SELECT T_BANKPRODUCTID FROM dtype_crd_dbt WHERE T_CREDITTYPEID = ?",    
                                     "CreditTypeId", creditBuff.credittypeid_ref, V_INTEGER);
   IF (BankProductID > 0)
     IF(ОбновитьИнформациюПоПродукту(creditBuff, OpDate) == FALSE)
       RunError("Ошибка обновления банковского продукта");     
     END;
   END;
   

   //Обновим данные по тарифам
   var TPLANTCRID = CRsdCommand ("SELECT T_TPLANTCRID FROM dtplan_tcr_dbt WHERE T_CREDITTYPEID  = ? AND T_TRFFPLANID = ?",
                                           "p1", creditBuff.CREDITTYPEID_REF,
                                           "p2", BusCredit.TarPlan,
                                           V_INTEGER);

   creditBuff.TPlanTcrId = TPLANTCRID; //Тарифный план

   creditBuff.CondId =  BusCredit.CondTarPlan;//Условие тарифного плана

   var opid;
   if(BusCredit.tariff.size == 0)
       if ((not creditBuff.CondId) and (creditBuff.TPlanTcrId)) //Если тарифный план без условия
          opid = MakeOperation(creditBuff.creditnumber, LO_CREDIT, CF_RATE, 0, OpDate,0,creditBuff.TPlanTcrId,40);
       else 
          opid = MakeOperation(creditBuff.creditnumber, LO_CREDIT, CF_RATE, 0, OpDate,0,creditBuff.CondId,39);
       end;
   else ///если передан массив

 //if(NOT InsertTariff(LO_CREDIT, creditBuff.creditnumber,  OpDate, BusCredit.creditType, LO_TYPECREDIT,  BusCredit.tariff))
        if(NOT InsertTariff(LO_CREDIT, creditBuff.creditnumber,  OpDate, BusCredit.creditType, LO_TYPECREDIT,  BusCredit.tariff))
               return false;
        end;
               
   end;
   if(opid == 0)
      RunError("Ошибка при установке тарифов:|" + GetMO_LoansError(), 18748);
      return 0;
   end;

     return true;
   //сюда попадем, если было выброшено исключение.
   OnError(err)
      if(ValType(err.Err) == V_INTEGER)
         ErrManager.SetError(err.Err, err.Message);
      else 
         ErrManager.SetError(err.Code, err.message);
      end;
end;

macro UpdateCreditContract( operdate:date, Acc, BusCrd)    
   NumServ = NumServ_UpdateCreditContract;
   var i:integer;
   var stat:bool = false;
   var creditid:integer;
   var ObjN:integer, CrdType:integer;

   OpDate = operdate;
   if((OpDate == NULL) OR (OpDate == date(0,0,0)))
      OpDate = {curdate};    
   end;

   // Прочитаем данные, пришедшие из ТК
   ReadObjUpTCreditContr(BusCrd);
   FindCrd(@BusCredit.ID, BusCredit.Number, creditBuff); 
   if(ACC!=NULL)
      ReadBusObj(Acc);
   end;

   // Если нужно, то проверим
   if(NOT SKIP_TCreditContr_CHECK)
      if(NOT CheckTCreditContr(OpDate,BusCredit,0))
         return 0;
      end;
   end;
   
   // Если нужно, то проверим пользовательской функцией
   if(NOT skip_user_chec.UpdateCreditContract)
      if(NOT UpdateCreditContractUserCheck(NumServ,OpDate,BusCredit))
         return 0;
      end;
   end;
   
   // запустим транзакцию
   if (RtTrn("UpDateCreditContractTRN"))
      Loans_FindCrdContract(BusCredit.ID, creditBuff);
      if (SynchAccFlag)
         SynchAccCrdData(creditBuff, null, SynchAccFlag, CS_PROL,0);
      end;
      SynchCreditdData(creditBuff);
      var DutyRest = ОстатокРегистра(LO_CREDIT, BusCredit.ID, TDR_MAINREST, opDate);          
      return TChangeCreditData(DutyRest);
   end;
   // Если в транзакции возникла ошибка, выбросим ее в ТК
   if (ErrManager.GetErrCode() != 0) 
      ErrManager.RunErr();
   end;
end;




 