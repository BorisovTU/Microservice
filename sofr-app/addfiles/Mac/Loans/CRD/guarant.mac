/*
$Name:             guarant.mac
$Module:           Кредитование
$Description:      Гарантия
*/
import ActiveX, total, replib, dlwreps, replib;

private record guar       ("credit_c.dbt", "loans.def");
private record cur_credit ("credit_c", "loans.def");
private file   currency   ("fininstr.dbt", "bank.def");
private const  TemplateName = "guarant.dot";

macro RunReport(CreditBuf)

      var axerr:object = null, ФИОПринципал, ФИОБенефициар, ExtCurCode, rub, kop;
      
      SetBuff(guar, CreditBuf);

      if (not depclnt.GetRecord(guar.ClientID_Ref))
          RunError ("Не найден принципал в справочнике клиентов");
      end;

      ФИОПринципал = depclnt.ConvertFIOFull();
                                      
      if (not depclnt.GetRecord(guar.Beneficiary))
          RunError ("Не найден бенефициар в справочнике клиентов");
      end;

      ФИОБенефициар = depclnt.ConvertFIOFull();

      /* Код валюты 810 - рубли, 840 - USD и т.д.*/
      currency.FIID = guar.CurCode;         
      if(getEQ(currency))                       
          ExtCurCode = currency.ISO_Number;
      end;                                      

      SetOutput (GetTxtFileName("dogguar_rep"));
      
      println(TemplateName); //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа
      
      /* № договора */
      [~CrdNum];
      println (guar.UsCreditNumber);
      /* Дата начала договора */
      [~RegDate];
      println (DateToStringFull (guar.RegDate));
      /* Дата окончания договора */
      [~ReturnDate];
      println (DateToStringFull (guar.ReturnDate));
      /* Сумма договора */
      [~Sum];
      println (string(guar.CreditSum));
      /* Сумма прописью договора */
      [~StrSum];
      println (CurToStrAlt (guar.CreditSum, rub, kop, ExtCurCode));
      /* Дата окончания договора */
      AddFormField (DateToStringFull (guar.ReturnDate));
      
      var tag = SetOutput (NULL, false);
      return tag;

      onError(axerr)
         SetOutput(NULL, false);
         RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Гарантия сформирована.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;