/*===============================================================================
Отлагательное Условие Ограничение лимита обеспечением
KOE
22.05.07
=================================================================================*/
import SbCrdInter;

var enscon  = TBFile    ("enscontr.dbt","r", 1);
var ens_crd = TBFile    ("ens_crd.dbt", "r", 0);


/*В случае успеха возвращается 1*/
macro CheckDilaCond (ObjType, ObjNum, DilaCondID, OperDate)
    /*Анализировать наличие операции "Принятие обеспечения на внебаланс" для обеспечения, отмеченного как основное.*/
    /*Обеспечение*/
    if(ObjType != LO_CREDIT)
        return 0;
    end;

    ens_crd.AddFilter("t_CreditNumber_Ref = " + ObjNum);
    ens_crd.rewind;
    if(ens_crd.nRecords > 0)
       while(ens_crd.next)
           enscon.AddFilter("t_EnsContractID = " + ens_crd.rec.EnsContractID_Ref + " and t_EnsCategory = " + EC_PRIMARY);
           enscon.rewind;

           while(enscon.next)
               if(NOT ExistsOperation(LO_ENSCONTR, enscon.rec.EnsContractID, CS_ENS))
                   ens_crd.DropFilter;
                   enscon.DropFilter;
                   return 0;
               else
                   ens_crd.DropFilter;
                   enscon.DropFilter;
                   return 1;
               end;
           end;
           enscon.DropFilter;
       end;
    end;
    ens_crd.DropFilter;
    return 0;
end;
