/*
$Name:             nbki.mac                                              
$Module:           Кредитование
$Description:      НБКИ
*/
/*
  Version: 2.0R 31.10.2005

  RS-Loans

  ПЕРЕДАЧА КРЕДИТНОЙ ИСТОРИИ В НБКИ

  Programmer: TFS
  Date      : 01.02.06
 */

IMPORT GLOBALS, TOTAL, "dutysum.mac", cryptdlm, likepy, "bkilib.mac";

PRIVATE CONST ВЕРСИЯ             = "4.0R";
PRIVATE CONST ДАТА_ОПУБЛИКОВАНИЯ = date(01,07,2015);

PRIVATE VAR party    = TBFile ("party.dbt",    "r", 0);
PRIVATE VAR persn    = TBFile ("persn.dbt",    "r", 0);

PRIVATE VAR lcourti  = TBFile ("lcourti.dbt",  "r", 1);
PRIVATE VAR duty_crd = TBFile ("duty_crd.dbt", "r", 1);
PRIVATE VAR type_crd = TBFile ("type_crd.dbt", "r", 0);

RECORD credit_rec ("credit_c.dbt"); // Текущий буфер договора
RECORD claim_rec  ("claim.dbt");    // Текущий буфер заявки

// Временные файлы передачи КИ
PRIVATE VAR lbki_201 = TBFile ("lbki_201.tmp", "w", 1);
PRIVATE VAR lbki_202 = TBFile ("lbki_202.tmp", "w", 0);
PRIVATE VAR lbki_203 = TBFile ("lbki_203.tmp", "w", 0);
PRIVATE VAR lbki_302 = TBFile ("lbki_302.tmp", "w", 1);
PRIVATE VAR lbki_304 = TBFile ("lbki_304.tmp", "w", 0);
PRIVATE VAR lbki_401 = TBFile ("lbki_401.tmp", "w", 0);
PRIVATE VAR lbki_phone = TBFile ("lbki_phone.tmp", "w", 0);
PRIVATE VAR lbki_402 = TBFile ("lbki_402.tmp", "w", 0);
PRIVATE VAR lbki_404 = TBFile ("lbki_404.tmp", "w", 0);
PRIVATE VAR lbki_407 = TBFile ("lbki_407.tmp", "w", 0);

PRIVATE VAR COUNT        : integer = 0,
            demo_mode    : bool    = false, // режим проверки, без записи в ТФ
            НОМЗАПР      : integer = 1;     // Порядковый номер сообщения в файле

PRIVATE VAR СЕГМЕНТ_ID = 0, //
            СЕГМЕНТ_NA = 0, // Сегмент Имени
            СЕГМЕНТ_BU = 0, // Сегмент Предприятия
            СЕГМЕНТ_AD = 0, // Сегмент Адреса
            СЕГМЕНТ_PN = 0, // Сегмент Телефона
            СЕГМЕНТ_TR = 0, // Сегмент Сделка
            СЕГМЕНТ_LE = 0, // Сегмент Юридический Статус
            СЕГМЕНТ_BK = 0, // Сегмент Банкротство
            СЕГМЕНТ_CL = 0, // Сегмент Дополнительные залоги
            СЕГМЕНТ_GR = 0, // Сегмент Дополнительные поручители
            СЕГМЕНТ_BG = 0; // Сегмент банковские гарантии

PRIVATE VAR GetBlock_201 = FALSE, // ID записи с сегментом 201
            Adress1_401 = "", // ID записи с сегментом 201
            Adress2_401 = ""; // ID записи с сегментом 201

PRIVATE VAR Regim_Rejected: BOOL = FALSE;  // Режим недостающей информации;

PRIVATE VAR IDEnsContrGR : TArray = TArray();

// Транспортный файл
PRIVATE FILE fMainTXT () WRITE TXT;   // КИ

VAR nbki_tmp = TBFile("nbki.tmp", "w", 0);

// Проверка на разрешенные символы и значения
PRIVATE MACRO allowed(Block: string, Segments: string, Value)
   VAR BL = StrUpr(TRIM(Block)),
       SG = StrUpr(TRIM(Segments));

   IF (BL == "IP")
      IF (SG == "8")
         IF (Value == 1)

            RETURN Value;
         END;

         RETURN "";
      END;
   END;
  
   RETURN Value;  
END;

//зависисоть суммы от ACCOUNT_RATING
MACRO CHECK_MONEY(ACCOUNT_RATING : STRING, TEMP_MONEY : MONEY)
    VAR TEMP : MONEY  = TEMP_MONEY;
    IF ((ACCOUNT_RATING == "12") OR (ACCOUNT_RATING == "13") OR (ACCOUNT_RATING == "14"))
        TEMP = $0;
    END;
    RETURN TEMP;
END; 

MACRO InsertSpezialValue(Val)
   IF (Regim_Rejected)
      IF   (ValType(Val) == V_INTEGER)
         IF (Trim(string(Val)) == "")
            RETURN int(-9);
         ELSE
            RETURN Val;
         END;
      ELIF (ValType(Val) == V_STRING)
         IF (Trim(string(Val)) == "")
            RETURN string("UNKNOWN");
         ELSE
            RETURN Val;
         END;
      ELIF (ValType(Val) == V_DATE)
         IF ((Val == date(0,0,0)))
            RETURN date(09,09,2999);
         ELSE
            RETURN Val;
         END;
      ELSE
         RETURN "";
      END;
   ELSE
      RETURN Val;
   END;
END;

MACRO ПроверитьДанные(BkiID, TFID, ReportDate)
   VAR cmd = RsdCommand(RslDefCon, "BEGIN RSO_LOANS_NBKI.CheckAndReject(?, ?, ?); END;");
   cmd.addParam("BkiID", RSDBP_IN); cmd.Value("BkiID") = BkiID;
   cmd.addParam("TFID",  RSDBP_IN); cmd.Value("TFID")  = TFID;
   cmd.addParam("RepD",  RSDBP_IN); cmd.Value("RepD")  = ReportDate;
   cmd.execute();
END;

////////////////////////////////////////////////////////////////////////////////
// Код клиента
MACRO GetPartCode(CodeKind: integer)
   // Ошибка
   VAR partcode: string = "";

   partcode = CRSDCommand("SELECT pc.T_CODE FROM DPARTCODE_DBT pc WHERE " +
                                " pc.T_PARTYID  = ? " +
                            " AND pc.T_CODEKIND = ? " +
                            " AND pc.T_STATE    = ? " ,
                          "PARTYID",  ClientID,
                          "CODEKIND", CodeKind,
                          "STATE",    0,
                          V_STRING);

   RETURN partcode;
END;

MACRO CreateDocID(DocID:string, len:integer)
   IF (StrLen(DocID) > len)
      RETURN SubStr(DocID, 1, len);
   ELIF (StrLen(DocID) == len)
      RETURN DocID;
   ELSE
      WHILE (StrLen(DocID) < len)
         DocID = "0"+DocID;
      END;
      RETURN DocID;
   END;
END;

MACRO GetProperty(UsFieldID:integer, bObjectType:integer, D:@date)
   VAR DocID:string = CreateDocID(String(ClientID), 10);

   //Функция возвращает последним параметром дату начала действия примечания
   PRIVATE MACRO ln_readNoteForObject(bObjectType, DocID, UsFieldID, NoteDate:@date)
      VAR result;
      VAR notetext = TBFile ("notetext.dbt", "r", 0);

      IF ((ValType(NoteDate) == V_UNDEF) or (NoteDate == date(0,0,0)))
         result = readNoteForObject(bObjectType, DocID, UsFieldID);
      ELSE
         result = readNoteForObject(bObjectType, DocID, UsFieldID, NoteDate);
      END;

      NoteDate = 
      CRsdCommand("SELECT MAX(T_DATE) FROM DNOTETEXT_DBT WHERE " + 
                        " T_OBJECTTYPE = ? " +
                    " AND T_DOCUMENTID = ? " +
                    " AND T_NOTEKIND   = ? ",
                  "p1", bObjectType,
                  "p2", DocID,
                  "p3", UsFieldID,
                  V_DATE);

      RETURN result;
   END;

   IF (ValType(D) == V_UNDEF)
      D = date(0,0,0);
   END;

   IF (ValType(bObjectType) == V_UNDEF)
      IF (TypeClient == PTLEGF_INST) // Примечания для юр.лиц
         RETURN ln_readNoteForObject(3, DocID, UsFieldID, @D);
      ELSE // Примечания для физ.лиц
         RETURN ln_readNoteForObject(8, DocID, UsFieldID, @D);
      END;
   ELSE
      RETURN ln_readNoteForObject(bObjectType, DocID, UsFieldID, @D);
   END;

   RETURN 0;
END;

////////////////////////////////////////////////////////////////////////////////
// Поиск блока
// 1. BlockID: integer, 
// 2. CreditNumber: integer, 
// 3. TFID: integer, 
// 4. OtherDebtorNum: integer, 
// 5. i, 
// 6. _ObjectTypeID, 
// 7. _ObjectNumber
MACRO GetBlock(BlockID: integer, TFID: integer, OtherDebtorNum: integer, _ObjectTypeID, _ObjectNumber)

   IF   (BlockID == 201)
      lbki_201.rec.TFID_Ref              = TFID;
      lbki_201.rec.ObjectTypeID          = _ObjectTypeID;
      lbki_201.rec.ObjectNumber          = _ObjectNumber;

      lbki_201.AddFilter("T_OBJECTTYPEID   = " + _ObjectTypeID + 
                    " AND T_OBJECTNUMBER   = " + _ObjectNumber + 
                    " AND T_TFID_REF       = " + TFID         +
                    " AND T_OTHERDEBTORNUM = " + OtherDebtorNum +
                    " AND T_PARTYID_REF    = " + ClientID);

      IF((NOT lbki_201.getEQ())                          OR
         (lbki_201.rec.TFID_Ref         != TFID)         OR
         (lbki_201.rec.ObjectTypeID     != _ObjectTypeID) OR
         (lbki_201.rec.ObjectNumber     != _ObjectNumber) OR
         (lbki_201.rec.OtherDebtorNum   != OtherDebtorNum) OR
         (lbki_201.rec.PARTYID_REF      != ClientID))
         lbki_201.DropFilter();
         
         RETURN FALSE;
      END;
      lbki_201.DropFilter();
   ELIF (BlockID == 302)
      lbki_302.rec.TFID_REF              = TFID;
      lbki_302.rec.ObjectTypeID          = _ObjectTypeID;
      lbki_302.rec.ObjectNumber          = _ObjectNumber;

      lbki_302.AddFilter("T_OBJECTTYPEID   = " + _ObjectTypeID + 
                    " AND T_OBJECTNUMBER   = " + _ObjectNumber + 
                    " AND T_TFID_REF       = " + TFID           +
                    " AND T_OTHERDEBTORNUM = " + OtherDebtorNum +
                    " AND T_PARTYID_REF    = " + ClientID);

      IF((NOT lbki_302.getEQ())                          OR
         (lbki_302.rec.TFID_Ref         != TFID)         OR
         (lbki_302.rec.ObjectTypeID     != _ObjectTypeID) OR
         (lbki_302.rec.ObjectNumber     != _ObjectNumber) OR
         (lbki_302.rec.OtherDebtorNum   != OtherDebtorNum) OR
         (lbki_302.rec.PARTYID_REF      != ClientID))
         lbki_302.DropFilter();

         RETURN FALSE;
      END;
      lbki_302.DropFilter();
   ELIF (BlockID == 304)
      lbki_304.rec.TFID_Ref              = TFID;
      lbki_304.rec.CreditNumber_Ref      = _ObjectNumber;
      lbki_304.rec.OtherDebtorNum        = OtherDebtorNum;
      lbki_304.rec.PARTYID_REF           = ClientID;
      IF((NOT lbki_304.getEQ())                          OR
         (lbki_304.rec.TFID_Ref         != TFID)         OR
         (lbki_304.rec.CreditNumber_Ref != _ObjectNumber) OR
         (lbki_304.rec.OtherDebtorNum   != OtherDebtorNum) OR
         (lbki_304.rec.PARTYID_REF      != ClientID))
         RETURN FALSE;
      END;
   END;

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// Функция сравнивает строки, если они совпадают, то исходная строка зануляется.
PRIVATE MACRO StrCmp(Value_1, Value_2, is_change)

   // Строки...
   IF ((ValType(Value_1) == V_STRING) AND (ValType(Value_2) == V_STRING))
      // ... состоящие из пробелов или символов CHR(1)
      // Приводим к общему знаменателю.
      IF ((StrLen (Trim(Value_1)) == 1) OR (CodeFor(Trim(Value_1)) <= 1))
         Value_1 = "";
      END;

      IF ((StrLen (Trim(Value_2)) == 1) OR (CodeFor(Trim(Value_2)) <= 1))
         Value_2 = "";
      END;
   END;

   // Даты...
   IF ((ValType(Value_1) == V_DATE) AND (ValType(Value_2) == V_DATE))
      // Бывают в формате 0.0.0 или 1.1.1
      IF (Int(Value_1) <= 1) Value_1 = date(0,0,0); END;
      IF (Int(Value_2) <= 1) Value_2 = date(0,0,0); END;
   END;

   // Изменения в блоке были
   IF (Value_1 != Value_2)
      SetParm(2, TRUE);
   END;
END;

////////////////////////////////////////////////////////////////////////////////
// Функция проверряет значение формата и переданных данных

PRIVATE MACRO GetStreetCode( Street:String )
   VAR SreCode : INTEGER;

   Street = StrUpr(TRIM(StrSubst(Street, ".", "")));

   IF   ((Street == StrUpr("ал"))      OR (Street == StrUpr("аллея")))      RETURN 01;
   ELIF ((Street == StrUpr("б-р"))     OR (Street == StrUpr("Бульвар")))    RETURN 02;
   ELIF ((Street == StrUpr("въезд"))   OR (Street == StrUpr("Въезд")))      RETURN 03;
   ELIF ((Street == StrUpr("дор"))     OR (Street == StrUpr("Дорога")))     RETURN 04;
   ELIF ((Street == StrUpr("ззд"))     OR (Street == StrUpr("Заезд")))      RETURN 05;
   ELIF ((Street == StrUpr("казарма")) OR (Street == StrUpr("Казарма")))    RETURN 06;
   ELIF ((Street == StrUpr("кв-л"))    OR (Street == StrUpr("Квартал")))    RETURN 07;
   ELIF ((Street == StrUpr("км"))      OR (Street == StrUpr("Километр")))   RETURN 08;
   ELIF ((Street == StrUpr("кольцо"))  OR (Street == StrUpr("Кольцо")))     RETURN 09;
   ELIF ((Street == StrUpr("лн"))      OR (Street == StrUpr("Линия")))      RETURN 10;
   ELIF ((Street == StrUpr("м"))       OR (Street == StrUpr("Местечко")))   RETURN 11;
   ELIF ((Street == StrUpr("мкр"))     OR (Street == StrUpr("Микрорайон"))) RETURN 12;
   ELIF ((Street == StrUpr("наб"))     OR (Street == StrUpr("Набережная"))) RETURN 13;
   ELIF ((Street == StrUpr("парк"))    OR (Street == StrUpr("Парк")))       RETURN 14;
   ELIF ((Street == StrUpr("пер"))     OR (Street == StrUpr("Переулок")))   RETURN 15;
   ELIF ((Street == StrUpr("пер-д"))   OR (Street == StrUpr("Переезд")))    RETURN 16;
   ELIF ((Street == StrUpr("пл"))      OR (Street == StrUpr("Площадь")))    RETURN 17;
   ELIF ((Street == StrUpr("пл-ка"))   OR (Street == StrUpr("Площадка")))   RETURN 18;
   ELIF ((Street == StrUpr("пр-кт"))   OR (Street == StrUpr("Проспект")))   RETURN 19;
   ELIF ((Street == StrUpr("пр-д"))    OR (Street == StrUpr("Проезд")))     RETURN 20;
   ELIF ((Street == StrUpr("пр-к"))    OR (Street == StrUpr("Просек")))     RETURN 21;
   ELIF ((Street == StrUpr("пр-лок"))  OR (Street == StrUpr("Проселок")))   RETURN 22;
   ELIF ((Street == StrUpr("проул"))   OR (Street == StrUpr("Проулок")))    RETURN 23;
   ELIF ((Street == StrUpr("стр"))     OR (Street == StrUpr("Строение")))   RETURN 24;
   ELIF ((Street == StrUpr("тер"))     OR (Street == StrUpr("Территория"))) RETURN 25;
   ELIF ((Street == StrUpr("тракт"))   OR (Street == StrUpr("Тракт")))      RETURN 26;
   ELIF ((Street == StrUpr("туп"))     OR (Street == StrUpr("Тупик")))      RETURN 27;
   ELIF ((Street == StrUpr("ул"))      OR (Street == StrUpr("Улица")))      RETURN 28;
   ELIF ((Street == StrUpr("уч-к"))    OR (Street == StrUpr("Участок")))    RETURN 29;
   ELIF ((Street == StrUpr("ш"))       OR (Street == StrUpr("Шоссе")))      RETURN 30;
   END;
   
   InsErrorMessage("Не найден код типа улицы: "+Street);
   RETURN 0;
END;

////////////////////////////////////////////////////////////////////////////////
// Судебная информация
PRIVATE MACRO GetCourtiInfo(KindIfn: integer, DateInf: date)
   VAR stat: BOOL = false, RS = NULL;

   RS = CRSDCommand(
   "SELECT * FROM DLCOURTI_DBT l1 WHERE l1.T_ID = " +
   "(" +
     " SELECT MAX(l2.T_ID) FROM DLCOURTI_DBT l2 WHERE " +
            " l2.T_CREDITNUMBER_REF = ? " +
        " AND l2.T_KINDINF = ? " +
   ")",
   "p1", ObjectNumber,
   "p2", KindIfn,
   V_GENOBJ);

   IF (RS.MoveNext())
      lcourti.rec.ID               = SQL_NVL(RS.Value("T_ID"),               V_INTEGER);
      lcourti.rec.CREDITNUMBER_REF = SQL_NVL(RS.Value("T_CREDITNUMBER_REF"), V_INTEGER);
      lcourti.rec.DATE             = SQL_NVL(RS.Value("T_DATE"),             V_DATE);
      lcourti.rec.KINDINF          = SQL_NVL(RS.Value("T_KINDINF"),          V_INTEGER);
      lcourti.rec.NOTE             = SQL_NVL(RS.Value("T_NOTE"),             V_STRING);
      lcourti.rec.SUITNUMBER       = SQL_NVL(RS.Value("T_SUITNUMBER"),       V_STRING);
      lcourti.rec.COURTNAME        = SQL_NVL(RS.Value("T_COURTNAME"),        V_STRING);
      lcourti.rec.CHANGEDATE       = SQL_NVL(RS.Value("T_CHANGEDATE"),       V_DATE);

      stat = TRUE;
   END;

   RETURN stat;
END;

////////////////////////////////////////////////////////////////////////////////
// В пакетной процедуре обновим информацию в блоках
//
PRIVATE MACRO UpdateBlock(CreditNumber: integer, TFID: integer, _ObjectTypeID: integer, _ObjectNumber: integer)
   // Физ лица
   CRSDCommand("UPDATE DLBKI_201_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DLBKI_202_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DLBKI_203_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DLBKI_302_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DLBKI_401_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DLBKI_PHONE_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);

   IF (CreditNumber > 0)
      CRSDCommand("UPDATE DLBKI_301_TMP SET T_TFID_REF = ? WHERE T_CREDITNUMBER_REF = ?", "TFID", TFID, "CREDITNUMBER", CreditNumber, V_GENOBJ);
      CRSDCommand("UPDATE DLBKI_304_TMP SET T_TFID_REF = ? WHERE T_CREDITNUMBER_REF = ?", "TFID", TFID, "CREDITNUMBER", CreditNumber, V_GENOBJ);
      CRSDCommand("UPDATE DLBKI_402_TMP SET T_TFID_REF = ? WHERE T_CREDITNUMBER_REF = ?", "TFID", TFID, "CREDITNUMBER", CreditNumber, V_GENOBJ);
      CRSDCommand("UPDATE DLBKI_404_TMP SET T_TFID_REF = ? WHERE T_CREDITNUMBER_REF = ?", "TFID", TFID, "CREDITNUMBER", CreditNumber, V_GENOBJ);
      CRSDCommand("UPDATE DLBKI_406_TMP SET T_TFID_REF = ? WHERE T_CREDITNUMBER_REF = ?", "TFID", TFID, "CREDITNUMBER", CreditNumber, V_GENOBJ);
      CRSDCommand("UPDATE DLBKI_407_TMP SET T_TFID_REF = ? WHERE T_CREDITNUMBER_REF = ?", "TFID", TFID, "CREDITNUMBER", CreditNumber, V_GENOBJ);
   END;
   
   CRSDCommand("UPDATE DNBKI_TR_CRD_TMP SET T_TFID = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DNBKI_TR_ENS_TMP SET T_TFID = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);
   CRSDCommand("UPDATE DLBKI_301_TMP SET T_TFID_REF = ? WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?", "TFID", TFID, "OT", _ObjectTypeID, "ON", _ObjectNumber, V_GENOBJ);

   IF (_ObjectTypeID == LO_CLAIM)
      CRSDCommand("UPDATE DNBKI_IP_CLAIM_TMP    SET T_TFID = ? WHERE T_CLAIMID = ?", "TFID", TFID, "ON", _ObjectNumber, V_GENOBJ);
   END;

   IF (_ObjectTypeID == LO_ENSCONTR)
      CRSDCommand("UPDATE DNBKI_IP_ENSCONTR_TMP SET T_TFID = ? WHERE T_ENSCONTRACTID = ?", "TFID", TFID, "ON", _ObjectNumber, V_GENOBJ);
   END;

   RETURN TRUE;
END;

// Запись во временный файл.
MACRO InsertToFile()
   IF (demo_mode)
      RETURN TRUE;
   END;

   // Если есть ошибка, то записи в файл не производим.
   IF (GENERAL_FAILURE)
      RETURN FALSE;
   END;

   nbki_tmp.rec.RowNum = 0;
   IF (nbki_tmp.GetGE())
       nbki_tmp.Prev();

       WHILE (nbki_tmp.Next())
          Insert(fMainTXT, string(nbki_tmp.rec.Text) + "\n", strlen(string(nbki_tmp.rec.Text) + 1))
       END;

       LnSQLExec("DELETE FROM DNBKI_TMP");
   END;

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// Записать строку в ТФ
//
// SegmentName - Имя сегмента
// FieldName   - Имя поля
//
// Type    - Тип значения
// Size    - Размер
// Value   - Значение
// Param   - Обязательный параметр
// NewLine - Переход на новую линию
PRIVATE MACRO InsertString(SegmentName: string,
                           FieldName  : string,
                           Type       : string,
                           Size       : integer,
                           Value      : variant,
                           Param      : string,
                           NewLine    : bool)
   VAR day : integer = 0,
       mon : integer = 0,
       year: integer = 0,
       temp: string  ="",
       mast_be: bool = FALSE; // Признак обязательного присутствия сегмента

   IF ((SegmentName == "TUTDF") OR
       (SegmentName ==  "TRLR") OR
       (SegmentName ==    "ID") OR
       (SegmentName ==    "NA") OR
       (SegmentName ==    "BU") OR
       (SegmentName ==    "AD") OR
       (SegmentName ==    "PN") OR
       (SegmentName ==    "TR") OR
       (SegmentName ==    "LE") OR
       (SegmentName ==    "BK"))
      mast_be = TRUE;
   END;

   // Не задан обязательный параметр!
   IF (Param == "О") // Обязательный параметр
      IF ((ValType(Value) == V_UNDEF) OR (Trim(string(Value)) == ""))
         InsErrorMessage("Сегмент: '" + SegmentName + "'. Не заполнено поле: '" + FieldName + "'");

         IF (mast_be)
            RETURN FALSE;
         END;
      END;
   END;

   // Целые числа от 0..9
   IF   (Type == "N")
      // Это не число
      IF ((ValType(Value) != V_INTEGER) AND (Param == "О"))
         InsErrorMessage("Сегмент: '" + SegmentName + "'. Не заполнено поле: '" + FieldName + "'");
         RETURN FALSE;
      END;
      
      IF (Trim(string(Value)) != "")
         Value = string(Value:0:0:r);
      END;
      
      // SCR 234754
      IF ((string(Value) == "0") AND (Param == "Н"))
         Value = "";
      END;
      
   // Знаковые целые положительные числа + 0..9
   ELIF (Type == "S")

      IF ((ValType(Value) == V_INTEGER) OR
          (ValType(Value) == V_DOUBLE)  OR
          (ValType(Value) == V_DOUBLEL) OR
          (ValType(Value) == V_MONEY)   OR
          (ValType(Value) == V_DECIMAL) OR
          (ValType(Value) == V_NUMERIC))
            Value = string(ROUND(Value):0:0:r);

         IF (Value < 0)
            InsErrorMessage("Сегмент: '" + SegmentName + "'. Поле '" + FieldName + "' содержит отрицательное значение:" + Value);
            RETURN FALSE;
         END;
      ELSE
         IF (Param == "О")
            InsErrorMessage("Сегмент: '" + SegmentName + "'. Не заполнено поле: '" + FieldName + "'");
            RETURN FALSE;
         ELSE
            Value = "";
         END;
      END;

      // SCR 234754
      IF ((string(Value) == "0") AND (Param == "Н"))
         Value = "";
      END;

      // 2.25r
      IF (Value > $9999999999)
         Value = string(9999999999:0:0:r);
      END;

      IF ((ValType(Value) == V_STRING) AND (Size > 1))
         Value = SubStr(Value, 1, Size);
      END;

   // Строка
   // ЗАГЛАВНЫЕ БУКВЫ: АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ
   //                  ABCDEFGHIJKLMNOPQRSTUVWYZ
   ELIF (Type == "A")
      // Это не строка
      IF ((ValType(Value) != V_STRING)  AND (Param == "О"))
         InsErrorMessage("Сегмент: '" + SegmentName + "'. Не заполнено поле: '" + FieldName + "'");
         RETURN FALSE;
      END;

      Value = StrUpr(string(Value));
      IF ((ValType(Value) == V_STRING) AND (Size > 1))
         Value = SubStr(Value, 1, Size);
      END;

   // Дата
   // Формат: ГГГГММДД
   ELIF (Type == "D")
      IF ((Param == "О") AND
         (
          (ValType(Value) != V_DATE) OR
          (Value <= date(1,1,1900))
         ))
         InsErrorMessage("Сегмент: '" + SegmentName + "'. Не заполнено поле: '" + FieldName + "'");
         RETURN FALSE;
      END;

      IF (Trim(string(Value)) != "")
         DateSplit(Value, DAY, MON, YEAR);

         temp = "0000";
         StrSet(temp, 5 - StrLen(string(YEAR)), string(YEAR)); Value = temp;

         temp = "00";
         StrSet(temp, 3 - StrLen(string(MON)),  string(MON));  Value = Value + temp;

         temp = "00";
         StrSet(temp, 3 - StrLen(string(DAY)),  string(DAY));  Value = Value + temp;
      END;

      // SCR 234754
      IF (string(Value) == "00010101")
         Value = "";
      END;

   // Буквенно-цифровые данные
   // а..я; А..Я; a..z; A..Z; 0..9
   ELIF (Type == "AN")
      IF ((ValType(Value) == V_STRING) AND (Size > 1))
         Value = SubStr(Value, 1, Size);
      END;

   // Любые символы
   ELIF (Type == "P")
      IF ((ValType(Value) == V_STRING) AND (Size > 1))
         Value = SubStr(Value, 1, Size);
      END;

   // Буквенные данные, включая: точка, пробел, запятая, апостроф, тире
   ELIF (Type == "C")
      IF ((ValType(Value) == V_STRING) AND (Size > 1))
         Value = SubStr(Value, 1, Size);
      END;

   END;

   // В режиме проверки не записываем данные в ТФ
   IF (demo_mode)
      RETURN TRUE;
   END;

   // Убираем символы табуляци и переходы на новую строку
   IF ((SegmentName != "AD") AND (FieldName != "3. Строка адреса"))
      Value = StrSubst(string(Value), "\t", " ");
   END;

   Value = StrSubst(string(Value), "\n", " ");

   /* SCR 234754
   IF (strlen(string(Value)) == 0)
      Value = string(" ");
   END;
   */

   // Для наглядности, не забывать комментить
   // Value = SegmentName+"."+FieldName+":"+Value+"\n";
   //

   nbki_tmp.rec.Text = nbki_tmp.rec.Text + string(Value);
   // Запись сегмента
   IF ((ValType(NewLine) == V_BOOL) AND (NewLine == TRUE))
      nbki_tmp.rec.RowNum = 0;

      nbki_tmp.Insert();
      nbki_tmp.Clear ();
   ELSE
      nbki_tmp.rec.Text = nbki_tmp.rec.Text + "\t";
   END;

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// Блок данных с алфавитными данными физического лица. ИНН и номером страхового свидетельства.
// Сегмент имени (NA)
MACRO СформироватьБлок_201(TFID: integer)

   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_201", 
                 V_INTEGER, 0,
                 TFID);
END;

////////////////////////////////////////////////////////////////////////////////
// Блок данных с информацией о документе, удостоверяющим личность физического лица.
// КИ. Документ, удост. личность. Блок 202
// PERSNIDC.DBT
MACRO СформироватьБлок_202(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)

   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_202", 
                 V_INTEGER, 0,
                 _ObjectTypeID, 
                 _ObjectNumber,
                 TFID, 
                 OtherDebtorNum, 
                 ClientID);

END;

////////////////////////////////////////////////////////////////////////////////
// Блок данных с информацией о государственной регистрации ПБЮЛ.
// КИ. Регистрация ПБЮЛ 203
MACRO СформироватьБлок_203(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_203", 
                 V_INTEGER, 0,
                 _ObjectTypeID, 
                 _ObjectNumber,
                 TFID, 
                 OtherDebtorNum, 
                 ClientID);
END;

////////////////////////////////////////////////////////////////////////////////
// Блок с информацией о наименованиях юридического лица.
// КИ. Наименование ЮЛ. Блок 301
MACRO СформироватьБлок_301(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_301", 
                 V_INTEGER, 0,
                 _ObjectTypeID, 
                 _ObjectNumber,
                 TFID, 
                 OtherDebtorNum, 
                 ClientID);
END;

////////////////////////////////////////////////////////////////////////////////
// Блок данных с информацией о регистрационных реквизитах юридического лица.
// КИ. Реквизиты ЮЛ. Блок 302
MACRO СформироватьБлок_302(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, RS)
   VAR Code: string;

   // Категории субъекта экономики
   MACRO GetCode(PartyID: integer, ObjectType: integer, GroupID: integer)
      VAR Code: string = "0000000000";

      StrSet(Code, 11 - StrLen(string(PartyID)), string(PartyID));

      Code =
      CRSDCommand("SELECT objattr.T_NAMEOBJECT FROM DOBJATTR_DBT objattr, DOBJATCOR_DBT objatc1 WHERE " +
                        " objattr.T_OBJECTTYPE = ? " +
                    " AND objattr.T_GROUPID    = ? " +
                    " AND objatc1.T_OBJECT     = ? " +
                    " AND objattr.T_ATTRID     = objatc1.T_ATTRID     " +
                    " AND objattr.T_OBJECTTYPE = objatc1.T_OBJECTTYPE " +
                    " AND objattr.T_GROUPID    = objatc1.T_GROUPID    " +
                    " AND objatc1.T_GENERAL    = ?  "               +
                    " AND objatc1.T_VALIDFROMDATE = " +
                     " (SELECT MAX(T_VALIDFROMDATE) FROM DOBJATCOR_DBT objatc2 WHERE " +
                                 " objatc2.T_OBJECTTYPE = objatc1.T_OBJECTTYPE " +
                             " AND objatc2.T_GROUPID    = objatc1.T_GROUPID " +
                             " AND objatc2.T_OBJECT     = objatc1.T_OBJECT  " +
                             " AND objatc2.T_GENERAL    = objatc1.T_GENERAL " +
                             " AND objatc2.T_VALIDFROMDATE <= ? " +
                     " ) ",
                  "OBJECTTYPE",    ObjectType,
                  "GROUPID",       GroupID,
                  "OBJECT",        Code,
                  "GENERAL",       "X",
                  "VALIDFROMDATE", {curdate},
                  V_STRING);
      RETURN Code;
   END;

   lbki_302.Clear();

   VAR CreditNumber = 0;
   IF ((_ObjectTypeID != LO_CLAIM) AND (_ObjectTypeID != LO_ENSCONTR))
      CreditNumber = _ObjectNumber;
   END;

   IF (Client_NotResident)
      IF (TypeClient == PTLEGF_INST)
         lbki_302.rec.OGRN = GetPartCode(33); // для 35 - иностранный государственный регистрационный номер
         lbki_302.rec.INN = GetPartCode(62);  // для 82 - иностранный ИНН
      ELSE     
         Code = GetPartCode(16);
         IF (Trim(Code) != "")
            IF (Index(Code, "/") != 0)
               lbki_302.rec.KPP        = SubStr(Code, Index(Code, "/")+1, Strlen(Code));          // КПП
            END;
         END;

         lbki_302.rec.OGRN = 
         lbki_302.rec.INN  = CRSDCommand(
          "SELECT RPAD(SUBSTR(T_CODE, 1, 20), 20, '0') "+
          " FROM "+
          " ("+
           " SELECT REPLACE(TRANSLATE(T_CODE, "+
           " CHR(34)||CHR(39)||CHR(63)||'!@#$%^&*()№;%:*()`-=[]\;,./~_+{}|<>qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNMЁЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮёйцукенгшщзхъфывапролджэячсмитьбю',"+
           " CHR(1)), "+
           " CHR(1)) AS T_CODE FROM DPARTCODE_DBT WHERE"+
                   " T_PARTYID  = ? "+
               " AND T_CODEKIND = 33 "+
           ")", 
           "p1", ClientID,     
          V_STRING);
      END;
   ELSE
      lbki_302.rec.OGRN             = GetPartCode(27); // ОГРН
      Code = GetPartCode(16);
      IF (Trim(Code) != "")
         IF (Index(Code, "/") != 0)
            lbki_302.rec.INN        = SubStr(Code, 1,                  Index(Code, "/") - 1);  // ИНН
            lbki_302.rec.KPP        = SubStr(Code, Index(Code, "/")+1, Strlen(Code));          // КПП
         ELSE
            lbki_302.rec.INN        = Code;
         END;
      END;
   END;

   lbki_302.rec.CreditNumber_Ref = CreditNumber;    // Идентификатор договора, к которому относится КИ
   lbki_302.rec.TFID_Ref         = TFID;            // Идентификатор ТФ, в котором была передана КИ
   lbki_302.rec.OtherDebtorNum   = SQL_NVL(RS.Value("T_OTHERDEBTORNUM"), V_INTEGER);  // Номер заемщика
   lbki_302.rec.PARTYID_REF      = ClientID;
   lbki_302.rec.ObjectTypeID     = _ObjectTypeID;
   lbki_302.rec.ObjectNumber     = _ObjectNumber;

   lbki_302.rec.OKPO = SQL_NVL(RS.Value("T_OKPO"), V_STRING); // Код ОКПО

   // Общесоюзный классификатор отраслей народного хозяйства
   lbki_302.rec.OKONH   = GetCode(ClientID, 3, 7);

   // Общий классификатор видов экономической деятельности
   lbki_302.rec.OKVED   = GetCode(ClientID, 3, 16);

   // Общероссийский классификатор объектов административно-территориального деления
   lbki_302.rec.OKATO   = GetCode(ClientID, 3, 12);

   // Общероссийский классификатор форм собственности
   lbki_302.rec.OKFS    = GetCode(ClientID, 3, 27);

   // Общероссийский классификатор организационно - правовых форм
   lbki_302.rec.OKOPF   = GetCode(ClientID, 3, 28); // magic Cifre: Гл Кгнига Спровочник обьектов системы: 
                                                    // Субьект экономии это 3 а 28 - это строка с ОКПФ!

   IF ({RSL_TOOLS_VERSION} >= 4049)
      lbki_302.rec.RegDate = CRSDCommand("SELECT NVL(MIN(obj.T_STARTDATE), TO_DATE('01.01.01', 'dd.mm.yyyy')) FROM DOBJRGDOC_DBT obj WHERE " +
                                                   " obj.T_OBJECTTYPE = ? " +
                                               " AND obj.T_OBJECTID   = ? ",
                                         "OBJECTTYPE", 3,
                                         "OBJECTID",   ClientID,
                                         V_DATE);
   ELSE
      lbki_302.rec.RegDate = CRSDCommand("SELECT NVL(MIN(par.T_REGDATESTART, TO_DATE('01.01.01', 'dd.mm.yyyy')) FROM DPARTYREG_DBT par WHERE " +
                                                    "par.T_PARTYID = ? ",
                                         "PARTYID", ClientID,
                                         V_DATE);
   END;

   lbki_302.rec.Series = CRSDCommand("SELECT OBJ.T_SERIES FROM DOBJRGDOC_DBT obj "                +
                                      "where OBJ.T_DOCUMENTID = (select OBJ1.T_DOCUMENTID "       +
                                                              "from DOBJRGDOC_DBT obj1 "          +
                                                              "where obj1.T_OBJECTTYPE = ? "      +
                                                              " AND obj1.T_OBJECTID   = ? "       +
                                                " AND obj1.T_ISCLOSED <> chr(88)"   +
                                                   " AND OBJ1.T_REGDOCKIND = 2) "      +
                                        "OR OBJ.T_DOCUMENTID = (select OBJ1.T_DOCUMENTID"         +                              
                                                               " from DOBJRGDOC_DBT obj1"          + 
                                                               " where obj1.T_OBJECTTYPE = ? "     +
                                                " AND obj1.T_OBJECTID = ?"         + 
                                                " and OBJ1.T_ISCLOSED <> chr(88)"  +
                                                " AND OBJ1.T_REGDOCKIND = 4)",                                                
                                         "OBJECTTYPE1", 3,
                                         "OBJECTID1",   ClientID,
                                         "OBJECTTYPE2", 3,
                                         "OBJECTID2",   ClientID,                             
                                         V_STRING);
   lbki_302.rec.ISSUEAUTHORITY = CRSDCommand("SELECT PARTY.T_NAME FROM DOBJRGDOC_DBT obj LEFT OUTER JOIN DPARTY_DBT party " +
                                             " ON PARTY.T_PARTYID = OBJ.T_REGPARTYID " +
                                   " where OBJ.T_DOCUMENTID = (select OBJ1.T_DOCUMENTID " +
                                                             " from DOBJRGDOC_DBT obj1 " +
                                                                        " WHERE  obj1.T_OBJECTTYPE = ? " +
                                                                        "   AND obj1.T_OBJECTID   = ? " +
                                                      "   AND OBJ1.T_ISCLOSED <> chr(88)" +
                                                             "   AND OBJ1.T_REGDOCKIND = 2) " +
                                              " OR OBJ.T_DOCUMENTID = (select OBJ1.T_DOCUMENTID" + 
                                                                        " from DOBJRGDOC_DBT obj1" + 
                                                                        " WHERE  obj1.T_OBJECTTYPE = ?" + 
                                                                           " AND obj1.T_OBJECTID   = ?" + 
                                                         " AND OBJ1.T_ISCLOSED <> chr(88)" +
                                                                           " AND OBJ1.T_REGDOCKIND = 4)",                                                      
                                         "OBJECTTYPE1", 3,
                                         "OBJECTID1",   ClientID,
                                         "OBJECTTYPE2", 3,
                                         "OBJECTID2",   ClientID,                             
                                         V_STRING);
   lbki_302.Insert();

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// КИ. Банкротство. Блок 304
// Блок данных с информацией о процедуре банкротства юридического лица.
MACRO СформироватьБлок_304(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR Text: string = "", SndDate = {curdate};

   IF ((_ObjectTypeID == LO_ENSCONTR) OR (_ObjectTypeID == LO_CLAIM))  
      RETURN TRUE;
   END;

   // Информация, официально полученная из гос. органов.
   Text = GetProperty(44, 3, SndDate);
   IF (Text != "")
      CRSDCommand("INSERT INTO DLBKI_304_TMP (T_CREDITNUMBER_REF, T_TFID_REF, T_OTHERDEBTORNUM, T_TEXT, T_DATE, T_PARTYID_REF) " +
                 " SELECT ?, ?, ?, T_TEXT, T_VALIDTODATE, ? FROM DNOTETEXT_DBT WHERE " +
                        " T_OBJECTTYPE  = ? " +
                    " AND T_DOCUMENTID  = ? " +
                    " AND T_NOTEKIND    = ? " +
                    " AND T_DATE       <= ? " +
                    " AND T_TIME = ( " +
                    "  SELECT MAX (T_TIME) FROM DNOTETEXT_DBT WHERE T_OBJECTTYPE  = ? " +
                    "   AND T_DOCUMENTID = ?  AND (T_NOTEKIND = ?) " + 
                    "   AND T_DATE       <= ? " +
                    "   AND T_DATE = ( " +
                    "    SELECT MAX (T_DATE) FROM DNOTETEXT_DBT WHERE T_OBJECTTYPE  = ? " +
                    "    AND T_DOCUMENTID = ?  AND (T_NOTEKIND = ?) " + 
                    "    AND T_DATE       <= ? ))",
                   "CREDITNUMBER",   _ObjectNumber,
                   "TFID",           TFID,
                   "OTHERDEBTORNUM", OtherDebtorNum,
                   "PARTYID",        ClientID,
                   "OBJECTTYPE",     3,
                   "DOCUMENTID",     CreateDocID(ClientID, 10),
                   "NOTEKIND",       44,
                   "DATENOTE",       {curdate},
                   "OBJECTTYPE2",    3,
                   "DOCUMENTID2",    CreateDocID(ClientID, 10),
                   "NOTEKIND2",      44,
                   "DATENOTE2",      {curdate},
                   "OBJECTTYPE3",    3,
                   "DOCUMENTID3",    CreateDocID(ClientID, 10),
                   "NOTEKIND3",      44,
                   "DATENOTE3",      {curdate},
                  V_GENOBJ);
   END;
   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// КИ. Блок данных с информацией по телефонам
MACRO СформироватьБлок_Phone(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR RSDcmd = null;
   VAR CreditNumber = 0;
   IF ((_ObjectTypeID != LO_CLAIM) AND (_ObjectTypeID != LO_ENSCONTR))
      CreditNumber = _ObjectNumber; 
   END;   
   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LOANS_NBKI.FillPhoneNBKI(?,?,?,?,?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("CREDITNUMBER_REF",  RSDBP_IN); RSDcmd.value("CREDITNUMBER_REF") = CreditNumber;
   RSDcmd.addParam("TFID_REF",  RSDBP_IN); RSDcmd.value("TFID_REF") = TFID;
   RSDcmd.addParam("PARTYID_REF",  RSDBP_IN); RSDcmd.value("PARTYID_REF") = ClientID;
   RSDcmd.addParam("OBJECTTYPEID",  RSDBP_IN); RSDcmd.value("OBJECTTYPEID") = _ObjectTypeID;
   RSDcmd.addParam("OBJECTNUMBER",  RSDBP_IN); RSDcmd.value("OBJECTNUMBER") = _ObjectNumber;
   RSDcmd.execute(); 
END;

////////////////////////////////////////////////////////////////////////////////
// КИ. Блок данных с информацией по адресам 401
MACRO СформироватьБлок_401(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)

   VAR CodePlace    : string = "",
       CodeStreet   : string = "",
       NameRegion   : string = "",
       AdressCity   : string = "",
       StreetType   : string = "",
       Street       : string = "",
       TypeDebtor   : integer = 0,
       RegionName   : string = "",
       KLADR_VAL    : BOOL   = FALSE,
       ErrCode,
       RS     = NULL,
   RS_KLADR  = NULL;
           
   RS_KLADR = CRSDCommand("select RSB_COMMON.GETREGFLAGVALUE ('CB\\PARTY\\КЛАДР\\КЛАДР', RsbSessionData.oper) " + 
              "as FLAG_KLADR from dual", V_STRING);   

   IF (RS_KLADR == "X")
      RS = CRSDCommand("SELECT adr.T_CODEPLACE,   " +
                       " adr.T_CODEREGION,  " +
                       " adr.T_CODEDISTRICT," +
                       " adr.T_PLACE,       " +
                       " adr.T_REGION,      " +
                       " adr.T_POSTINDEX,   " +
                       " adr.T_PROVINCE,    " +
                       " adr.T_DISTRICT,    " +
                       " adr.T_CODESTREET,  " +
                       " adr.T_STREET,      " +
                       " adr.T_HOUSE,       " +
                       " adr.T_NUMCORPS,    " +
                       " adr.T_FLAT,        " +
                       " adr.T_TYPE,        " +
                       " RSO_LNS_CRE.getLocation(adr.T_REGION, adr.T_DISTRICT, adr.T_PLACE) AS A_LOCATION, "
                       " CASE " +
                       " WHEN NVL(TRIM(adr.T_REGION),     CHR(1)) = CHR(1) OR " +
                            " NVL(TRIM(adr.T_CODEREGION), CHR(1)) = CHR(1) THEN " +
                            " CHR(1) " +
                       " ELSE CASE WHEN NVL(TRIM(adr.T_REGIONNUM), CHR(1)) <> CHR(1) THEN NVL(TRIM(adr.T_REGIONNUM), CHR(1)) ELSE " +
        " (SELECT SUBSTR(kf.T_REGIONCODE, 1, 2) " + 
                    "FROM DAS_ADDROBJ_DBT kf WHERE " +
                                      " TRIM(kf.T_SHORTNAME)  LIKE TRIM(adr.T_CODEREGION) || '%' " +
                                  " AND TRIM(kf.T_FORMALNAME) LIKE TRIM(adr.T_REGION)     || '%' " +
                                  " AND ROWNUM = 1     " +
                 ") " +
                      " END END AS A_CODEREGION, " +
             "(SELECT c.T_CODELAT2 FROM DCOUNTRY_DBT c WHERE c.T_CODELAT3 = adr.T_COUNTRY AND ROWNUM = 1) AS A_COUNTRY " +
                 " FROM DADRESS_DBT adr WHERE " +
                       " adr.T_PARTYID = ? " +
                       " ORDER BY T_TYPE",
                 "PARTYID", ClientID,
                 V_GENOBJ);
   ELSE
      RS = CRSDCommand("SELECT adr.T_CODEPLACE,   " +
                             " adr.T_CODEREGION,  " +
                             " adr.T_CODEDISTRICT," +
                             " adr.T_PLACE,       " +
                             " adr.T_REGION,      " +
                             " adr.T_POSTINDEX,   " +
                             " adr.T_PROVINCE,    " +
                             " adr.T_DISTRICT,    " +
                             " adr.T_CODESTREET,  " +
                             " adr.T_STREET,      " +
                             " adr.T_HOUSE,       " +
                             " adr.T_NUMCORPS,    " +
                             " adr.T_FLAT,        " +
                             " adr.T_TYPE,        " +
                             " RSO_LNS_CRE.getLocation(adr.T_REGION, adr.T_DISTRICT, adr.T_PLACE) AS A_LOCATION, "
           " (SELECT pt.T_CODEREGION FROM DPTREGION_DBT pt WHERE pt.T_NAMEREGION = adr.T_REGION) AS A_CODEREGION, " +
           " (SELECT c.T_CODELAT2 FROM DCOUNTRY_DBT c WHERE c.T_CODELAT3 = adr.T_COUNTRY AND ROWNUM = ?) AS A_COUNTRY " +
                    " FROM DADRESS_DBT adr WHERE " +
                          " adr.T_PARTYID = ? " +
                          " ORDER BY T_TYPE",
                    "RN",           1,
                    "PARTYID", ClientID,
                    V_GENOBJ);
   END;

   WHILE (RS.MoveNext())
      CodePlace    = SQL_NVL(RS.Value("T_CODEPLACE"),  V_STRING);
      CodeStreet   = SQL_NVL(RS.Value("T_CODESTREET"), V_STRING);
      // 4 - Регион
      RegionName   = SQL_NVL(RS.Value("A_CODEREGION"), V_STRING);
      AdressCity = "";

      lbki_401.Clear();

      VAR CreditNumber = 0;
      IF ((_ObjectTypeID != LO_CLAIM) AND (_ObjectTypeID != LO_ENSCONTR))
         CreditNumber = _ObjectNumber; 
      END;

      lbki_401.rec.CreditNumber_Ref = CreditNumber;   // Идентификатор договора, к которому относится КИ
      lbki_401.rec.TFID_Ref         = TFID;           // Идентификатор ТФ, в котором была передана КИ
      lbki_401.rec.OtherDebtorNum   = OtherDebtorNum; // Номер заемщика
      lbki_401.rec.PARTYID_REF      = ClientID;
      lbki_401.rec.OBJECTTYPEID     = _ObjectTypeID;
      lbki_401.rec.OBJECTNUMBER     = _ObjectNumber;
      
      IF (Client_NotResident == TRUE)
        lbki_401.rec.POSTALCODE = "";
      ELSE
      lbki_401.rec.POSTALCODE       = Trim(SQL_NVL(Trim(RS.Value("T_POSTINDEX")), V_STRING));
      END;
      lbki_401.rec.HOUSENUMBER      = Trim(SQL_NVL(Trim(RS.Value("T_HOUSE")), V_STRING));
      lbki_401.rec.BLOCK            = Trim(SQL_NVL(Trim(RS.Value("T_NUMCORPS")), V_STRING));
      lbki_401.rec.APARTMENT        = Trim(SQL_NVL(Trim(RS.Value("T_FLAT")), V_STRING));

      //  5 - Город
        IF (Trim(SQL_NVL(RS.Value("T_DISTRICT"), V_STRING)) != "")
         AdressCity = InsertSpezialValue(Trim(SQL_NVL(RS.Value("T_CODEDISTRICT"), V_STRING) + " " + SQL_NVL(RS.Value("T_DISTRICT"), V_STRING))) +"\t";

      //  6 - Населенный пункт
      ELSE// (Trim(SQL_NVL(RS.Value("T_PLACE"), V_STRING)) != "")
           AdressCity = InsertSpezialValue(Trim(SQL_NVL(RS.Value("T_CODEPLACE"), V_STRING) + " " + SQL_NVL(RS.Value("T_PLACE"), V_STRING))) +"\t"; 

      END;

      IF  ((SQL_NVL(RS.Value("A_LOCATION"), V_STRING) != ""))
         AdressCity =   SQL_NVL(RS.Value("T_REGION"), V_STRING) +"\t";

      END;

      IF (Trim(SQL_NVL(RS.Value("T_STREET"), V_STRING)) != "")
         StreetType = GetStreetCode(SQL_NVL(RS.Value("T_CODESTREET"), V_STRING));
         Street     = InsertSpezialValue(Trim(SQL_NVL(Trim(RS.Value("T_STREET")),   V_STRING)));

      ELSE
         StreetType = "";
         Street     = AdressCity;            

      END;

      lbki_401.rec.LOCATION  = Trim(AdressCity);
      lbki_401.rec.STREET    = Trim(Street); 
      lbki_401.rec.REGION    = Trim(RegionName);
      lbki_401.rec.AREA      = "";                                                     // Область
      lbki_401.rec.DISTRICT  = Trim(SQL_NVL(Trim(RS.Value("T_PROVINCE")),  V_STRING)); // Район
      lbki_401.rec.StreetType= StreetType;
      lbki_401.rec.Country   = Trim(SQL_NVL(Trim(RS.Value("A_COUNTRY")),   V_STRING));

      // Адрес
      lbki_401.rec.Adress = //  1 - Индекс
                    /*Trim(SQL_NVL(Trim(RS.Value("T_POSTINDEX")), V_STRING))*/
                    lbki_401.rec.POSTALCODE    + "\t" +

                         //  2 - Код страны
                    Trim(SQL_NVL(Trim(RS.Value("A_COUNTRY")),   V_STRING))    + "\t" +

                         //  3 - Регион
                    Trim( RegionName )                                        + "\t" +
                                                                                "\t" +
                         //  5 - Наименование района
                    Trim(SQL_NVL(Trim(RS.Value("T_PROVINCE")),  V_STRING))    + "\t" +

                         //  6 - Населенный пункт
                    Trim(AdressCity)                                          + "\t" +

                         //  7 - Код типа улицы
                    StreetType                                                + "\t" +

                         //  8 - Название улицы
                    Trim(Street)                                              + "\t" +

                         //  9 - Дом
                    Trim(SQL_NVL(Trim(RS.Value("T_HOUSE")),     V_STRING))    + "\t" +

                         // 11 - Корпус
                    Trim(SQL_NVL(Trim(RS.Value("T_NUMCORPS")),  V_STRING))    + "\t" +

                         // 10 - Номер строения
                                                                                "\t" +

                         // 12 - Квартира
                    Trim(SQL_NVL(Trim(RS.Value("T_FLAT")),      V_STRING));

           // ЮРИДИЧЕСКИЙ
      IF   (SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 1)
         IF   (TypeClient != PTLEGF_INST)
            lbki_401.rec.TypeAdress = 1; // Адрес регистрации
         ELIF (TypeClient == PTLEGF_INST)
            lbki_401.rec.TypeAdress = 3; // Юридический
         END;
           // ФАКТИЧЕСКИЙ
      ELIF (SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 2)
         IF   (TypeClient != PTLEGF_INST)
            lbki_401.rec.TypeAdress = 2; // Фактический
         ELIF (TypeClient == PTLEGF_INST)
            lbki_401.rec.TypeAdress = 4; // Для Юридического лица
         END;
      END;
      
      IF (lbki_401.rec.TypeAdress != 0)
         lbki_401.Insert();
      END;
   END;

   RETURN TRUE;
END;

// Блок данных с информацией о закрытии договора.
// Информация о закрытии договора 404
MACRO СформироватьБлок_404(CreditNumber: integer, TFID: integer)
   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_404", V_INTEGER, 0, CreditNumber, TFID, ReportDate);
   
   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// Блок данных с информацией о фактах рассмотрения судом споров по договору,
//    о содержании результативных частей судебных решений и иная информация,
//    официально полученная из государственных органов.
// Судебная информация. Блок LE
MACRO СформироватьБлок_LE(CreditNumber: integer, TFID: integer)
   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_LE", V_INTEGER, 0, CreditNumber, TFID, ReportDate);

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// Блок 407
// Возникновение и погашение просроченной задолженности по ОД и %%
MACRO СформироватьБлок_407(CreditNumber: integer, TFID: integer)
   VAR OperDate : date    = date(0,0,0);

   OperDate = A_REPORTDATE + 1; // Со следующей даты
   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_407", V_INTEGER, 0, CreditNumber, TFID, OperDate, ReportDate);

   RETURN TRUE;
END;

MACRO СформироватьБлок_СделкаДляДО(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, ReportDate: date)
   VAR OperDate : date    = date(0,0,0);

   OperDate = A_REPORTDATE + 1; // Со следующей даты

   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_TradeForDO", V_INTEGER, 0, _ObjectTypeID, _ObjectNumber, TFID, ReportDate, OperDate);

   RETURN TRUE;
END;

// Блок информационная часть по Заявке
MACRO СформироватьБлок_ИнформационнаяЧастьПоЗаявке(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer)

   var RegDate;
   IF (ReportDate < date(01,03,2015))
      RETURN;
   END;

   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_IPForClaim", V_INTEGER, 0, _ObjectTypeID, _ObjectNumber, TFID, ReportDate);

   RETURN TRUE;
END;

MACRO СформироватьБлок_ИнформационнаяЧастьПоПоручительсву(_ObjectTypeID, _ObjectNumber, TFID, ReportDate);
   RunStoredFunc("RSO_LOANS_NBKI.CreateBlock_IPForEnscontr", V_INTEGER, 0, _ObjectTypeID, _ObjectNumber, TFID, ReportDate);

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
//                                                                            //
//  СЕГМЕНТЫ                                                                  //
//                                                                            //
////////////////////////////////////////////////////////////////////////////////
//  Сегмент заголовока TUTDF
MACRO СЕГМЕНТ_ЗАГОЛОВКА()
   VAR STAT                : BOOL = FALSE,
       save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE;

   GENERAL_FAILURE = FALSE;

   nbki_tmp.Clear();

   InsertString ("TUTDF", "1. Название сегмента",
                     "A",  5, "TUTDF",                    "О", FALSE);

   InsertString ("TUTDF", "2. Версия",
                     "P",  6, ВЕРСИЯ,                     "О");

   InsertString ("TUTDF", "3. Дата опубликования версии",
                     "D",  8, ДАТА_ОПУБЛИКОВАНИЯ,         "О");

   InsertString ("TUTDF", "4. Код участника",
                    "AN", 12, lbki.rec.SourceID,          "О");

   InsertString ("TUTDF", "5. Идентификация цикла",
                     "P",  8, "",                         "Н");

   InsertString ("TUTDF", "6. Дата состовления",
                     "D",  8, ReportDate,                 "О");

   InsertString ("TUTDF", "7. Код авторизации",
                    "AN",  8, lbki.rec.AuthorizationCode, "О");

   InsertString ("TUTDF", "8. Данные участника",
                     "P", 80, "",                         "Н", TRUE);

   STAT = InsertToFile();
   nbki_tmp.Clear();

   IF (NOT GENERAL_FAILURE)
       GENERAL_FAILURE = save_GENERAL_FAILURE;
       STAT            = TRUE;
   END;

   RETURN STAT;
END;

MACRO Number_Doc (type, _ObjectTypeID, _ObjectNumber, BankDocKind: integer, LoansDocKind: integer, ClientID: integer)
   IF (type == 1)
      RETURN CRSDCommand( "SELECT * FROM " +
                          "( " +
                          "SELECT TRIM(REPLACE(T_NUMBER, CHR(1), ' ')) AS T_NUMBER FROM DLBKI_202_DBT lb, DLDEVBKI_DBT ld WHERE  " +
                                " ld.T_OBJECTTYPEID = ? " +
                            " AND ld.T_OBJECTNUMBER = ? " +
                            " AND LD.T_BKIID_REF    = ? " +
                            " AND LD.T_RESULT       = '+' " +
                            " AND ld.T_TFID_REF     = lb.T_TFID_REF " +
                            " AND lb.T_OBJECTTYPEID = ld.T_OBJECTTYPEID " +
                            " AND lb.T_OBJECTNUMBER = ld.T_OBJECTNUMBER " +
                            " AND lb.T_CODEKIND     = ? " +
                            " AND lb.T_PARTYID_REF  = ? " +
                         " ORDER BY lb.T_TFID_REF DESC " +
                         " ) " +
                         " WHERE ROWNUM = ? ", 
                            "p0", _ObjectTypeID, 
                            "p1", _ObjectNumber,
                            "p2", lbki.rec.BkiID,
                            "p3", BankDocKind,
                            "p4", ClientID,
                            "p5", 1,
                            V_STRING)
   ELSE
      RETURN CRSDCommand ("SELECT DECODE ( ? , " + 
                                            " ?, (SELECT l.T_NUMBER " +
                                            "        FROM DLBKI_203_DBT l " +
                                            "       WHERE l.T_DOCKIND      = ? " + 
                                            "         AND l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? AND l.T_PARTYID_REF = ? " + 
                                            "         AND l.T_TFID_REF = TFID_REF_TEMP.tm), " +
                                            " ?, (SELECT T_NUMBER " +
                                            "        FROM DLBKI_203_DBT l " +
                                            "       WHERE l.T_DOCKIND      = ? " +
                                            "         AND l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? AND l.T_PARTYID_REF = ? " +
                                            "         AND l.T_TFID_REF = TFID_REF_TEMP.tm), " +
                                            " ?, (SELECT T_OGRN " +
                                            "        FROM DLBKI_302_DBT l " +
                                            "       WHERE l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? AND l.T_PARTYID_REF = ? " +
                                            "         AND l.T_TFID_REF = TFID_REF_TEMP.tm), " +
                                            " ?, (SELECT T_OGRN " +
                                            "        FROM DLBKI_302_DBT l " + 
                                            "       WHERE l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? AND l.T_PARTYID_REF = ? " +
                                            "         AND l.T_TFID_REF = TFID_REF_TEMP.tm), " + 
                                            " ?, (SELECT T_INN " + 
                                            "        FROM DLBKI_302_DBT l " + 
                                            "       WHERE l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? AND l.T_PARTYID_REF = ? " + 
                                            "         AND l.T_TFID_REF = TFID_REF_TEMP.tm), " +
                                            " ?, (SELECT T_ACCESSCODE " + 
                                            "        FROM DLBKICONT_DBT l " + 
                                            "       WHERE l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? AND l.T_BKIID_REF = ? ) " + 
                                                       "  ) AS full_number " + 
                             "FROM (SELECT MAX (T_TFID_REF) tm FROM dldevbki_dbt WHERE " +
                                   " T_OBJECTTYPEID = ? " + 
                               " AND T_OBJECTNUMBER = ? " +
                               " AND T_BKIID_REF    = ? " +
                               " AND T_RESULT     = '+' " +
                               " AND T_TFID_REF     < ? " + 
                                 " ) tfid_ref_temp ", 
                             "p1", LoansDocKind,
                             "p2", 31,
                             "p3", BankDocKind,
                             "p4", _ObjectTypeID, "p42", _ObjectNumber,   "c1", ClientID,
                             "p5", 32,
                             "p6", BankDocKind,
                             "p7", _ObjectTypeID, "p72", _ObjectNumber,   "c2", ClientID,
                             "p8", 33,
                             "p10", _ObjectTypeID, "p102", _ObjectNumber, "c3", ClientID,
                             "p11", 34,  // ОГРН
                             "p12", _ObjectTypeID, "p112", _ObjectNumber, "c4", ClientID,
                             "p13", 81,  // ИНН
                             "p14", _ObjectTypeID, "p114", _ObjectNumber, "c5", ClientID,
                             "p15", 98,
                             "p16", _ObjectTypeID, "p116", _ObjectNumber,
                             "p17", lbki.rec.BkiID,
                             "p18", _ObjectTypeID, "p118", _ObjectNumber,
                             "p19", lbki.rec.BkiID,
                             "p20", ltr_file.rec.tfid,
                              V_STRING);
   END;
END;

////////////////////////////////////////////////////////////////////////////////
// ID
// Обязателен для физ/юр лица.
// Номер договора, ID транспортного файла, ID созаемщика
MACRO СЕГМЕНТ_ИДЕНТИФИКАЦИИ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR DocKind          : INTEGER = 0,
       STAT                : BOOL = FALSE,
       save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE,
       RS202 = NULL, RS203 = NULL,
       found = FALSE;

   MACRO Запись(DocKind: integer, CodeDocum: string)
      VAR НАИМЕНОВАНИ_СЕГМЕНТА : string = "",
          ИДДОГ                : string = "",
          НомерДокумента       : string = "",
          СерияДокумента       : string = "",
          ФлагОбязСерии        : string = "О",
          ФлагОбязНомер        : string = "О",
          КогдаВыдан           : date   = date(0,0,0),
          КемВыдан             : string = "";

      СЕГМЕНТ_ID = СЕГМЕНТ_ID + 1;

      IF (Trim(CodeDocum) != "")
         ErrMes = ". Документ: " + CodeDocum;
      END;

      // 1.
      IF (СЕГМЕНТ_ID < 10)
         НАИМЕНОВАНИ_СЕГМЕНТА = "ID0" + string(СЕГМЕНТ_ID);
      ELSE
         НАИМЕНОВАНИ_СЕГМЕНТА = "ID"  + string(СЕГМЕНТ_ID);
      END;

      IF ( (DocKind == 98) AND (StrLen(AccessCode) == 0 ) ) //130890
         СЕГМЕНТ_ID = СЕГМЕНТ_ID - 1;
         RETURN FALSE;
      END;

      InsertString("ID", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,            "О", FALSE);

      InsertString("ID", "2. Тип ID",
                    "N",  2, DocKind,                         "О");

      IF ((DocKind == 01) OR (DocKind == 02) OR
          (DocKind == 21) OR (DocKind == 22))
         ФлагОбязСерии  = "О";
         СерияДокумента = lbki_202.rec.Series;

      ELIF (DocKind == 31)
         СерияДокумента = lbki_203.rec.Series;

      ELSE
         ФлагОбязСерии = "Н";
         СерияДокумента = "";
         IF(((DocKind > 02) AND (DocKind < 08)) OR 
            ((DocKind > 08) AND (DocKind < 11)) OR
            ((DocKind > 11) AND (DocKind < 16)) OR 
            (DocKind == 21) OR (DocKind == 22) OR 
            (DocKind == 26) OR (DocKind == 27))                
            
            IF (lbki_202.rec.Series)
               СерияДокумента = lbki_202.rec.Series;
            END;         
         ELIF ((DocKind == 17) OR (DocKind == 28) OR (DocKind == 30))                 
            IF (lbki_203.rec.Series)
               СерияДокумента = lbki_203.rec.Series;
            END;                   
         END;         
      END;

      IF   ((DocKind >= 0) AND (DocKind <= 27))
         НомерДокумента = lbki_202.rec.Number;

      ELIF ((DocKind == 31) OR (DocKind == 32))
         НомерДокумента = lbki_203.rec.Number;

      ELIF ((DocKind == 34) OR (DocKind == 33) OR (DocKind == 35))
         НомерДокумента = lbki_302.rec.OGRN;

         IF (DocKind == 33)
            СерияДокумента = ""; // SCR 249288 lbki_203.rec.Series;  
            КогдаВыдан     = lbki_203.rec.Date;
            КемВыдан       = lbki_203.rec.ISSUEAUTHORITY;
       
         ELIF ((DocKind == 34) OR (DocKind == 35))
            IF (DocKind == 35)
               СерияДокумента = lbki_302.rec.Series;
            ELSE
               СерияДокумента = "";
            END;

            КогдаВыдан     = lbki_302.rec.RegDate;
            КемВыдан       = lbki_302.rec.ISSUEAUTHORITY;
         END;
      ELIF ((DocKind == 81) OR (DocKind == 82))
         СерияДокумента = "";
         НомерДокумента = lbki_302.rec.INN;

      ELIF (DocKind == 97)
         ФлагОбязСерии = "Н";
         ФлагОбязНомер = "Н";

      ELIF (DocKind == 98)

         // Длина кода должна быть не менее 4 символов и не более 15 символов
         IF ((StrLen(AccessCode) < 4) OR (StrLen(AccessCode) > 15))
            InsErrorMessage("Код субъекта КИ не соответствует формату");//#166525 

            НомерДокумента = ""; 
            ФлагОбязНомер = "О";
            GENERAL_FAILURE = TRUE;
            RETURN FALSE;
         ELSE
            НомерДокумента = AccessCode;
            ФлагОбязНомер = "Н";

         END;
      END;
      
      IF (CheckDocumentFormat(DocKind, НомерДокумента, СерияДокумента, "ID","4. Номер документа" , "3. Номер серии ", ФлагОбязСерии, ФлагОбязНомер))
          InsertString("ID", "3. Номер серии",
                       "P", 20, СерияДокумента,   ФлагОбязСерии);

          InsertString("ID", "4. Номер документа",
                       "AN", 20, НомерДокумента,  ФлагОбязНомер);
      END;

      IF (DocKind < 28)
         IF (Regim_Rejected)
            InsertString("ID", "5. Когда выдан",
                          "D",  8, InsertSpezialValue(lbki_202.rec.Date), "О");

            IF ((TypeClient != PTLEGF_INST) AND NOT (lbki_202.rec.Date > lbki_201.rec.Born))
               InsErrorMessage("Неверное значение обязательного поля");
            END;

            InsertString("ID", "6. Кем выдан",
                          "P", 510, InsertSpezialValue(lbki_202.rec.Organization),   "О");
         ELSE
            InsertString("ID", "5. Когда выдан",
                         "D",  8, lbki_202.rec.Date,            "О");

            IF ((TypeClient != PTLEGF_INST) AND NOT (lbki_202.rec.Date > lbki_201.rec.Born))
               InsErrorMessage("Неверное значение обязательного поля");
            END;

            InsertString("ID", "6. Кем выдан",
                         "P", 510, lbki_202.rec.Organization,   "О");
         END;
      ELSE
         InsertString("ID", "5. Когда выдан",
                       "D",  8, КогдаВыдан,           "Н");

         InsertString("ID", "6. Кем выдан",
                       "P", 510, КемВыдан,            "Н");
      END;

      InsertString("ID", "7. Где выдан",
                    "C", 510, "",                     "Н");

      InsertString("ID", "8. Старый номер документа",
                   "AN", 20, "",                      "Н", TRUE);

      COUNT = COUNT + 1;

      RETURN TRUE;
   END;

   MACRO ЗаписьИзмененияДокумента(BankDocKind: integer, LoansDocKind: integer)

   VAR alt_number_bool     : BOOL = false,
       alt_number          = "",
       new_number          = "",
       НомерДокумента       : string = "",
       СерияДокумента       : string = "",
       ФлагОбязСерии        : string = "О",
       ФлагОбязНомер        : string = "О",
       OldDoc,
       НАИМЕНОВАНИ_СЕГМЕНТА= "";
       
      IF  ((LoansDocKind >= 0) AND (LoansDocKind <= 27))
         new_number = lbki_202.rec.Number;
         alt_number = Number_Doc (1, _ObjectTypeID, _ObjectNumber, BankDocKind, LoansDocKind, ClientID);
      ELIF ((LoansDocKind == 31) OR (LoansDocKind == 32))
         new_number = lbki_203.rec.Number;
         alt_number = Number_Doc (2, _ObjectTypeID, _ObjectNumber, BankDocKind, LoansDocKind, ClientID);
      ELIF ((LoansDocKind == 34) OR (LoansDocKind == 33) OR (LoansDocKind == 35))
         new_number = lbki_302.rec.OGRN;
         alt_number = Number_Doc (2, _ObjectTypeID, _ObjectNumber, BankDocKind, LoansDocKind, ClientID);
      ELIF ((LoansDocKind == 81) OR (LoansDocKind == 82)) 
         new_number = lbki_302.rec.INN;
         alt_number = Number_Doc (2, _ObjectTypeID, _ObjectNumber, BankDocKind, LoansDocKind, ClientID);
      ELIF (LoansDocKind == 98)
         new_number = AccessCode;
         alt_number = Number_Doc (2, _ObjectTypeID, _ObjectNumber, BankDocKind, LoansDocKind, ClientID);
      END;

      alt_number = TRIM(alt_number);
      new_number = TRIM(new_number);

      IF ((alt_number != new_number) AND ( alt_number != ""))

         СЕГМЕНТ_ID = СЕГМЕНТ_ID + 1;
         IF (СЕГМЕНТ_ID < 10)
            НАИМЕНОВАНИ_СЕГМЕНТА = "ID0" + string(СЕГМЕНТ_ID);
         ELSE
            НАИМЕНОВАНИ_СЕГМЕНТА = "ID"  + string(СЕГМЕНТ_ID);
         END;

         OldDoc = CRSDCommand("SELECT LB.* FROM DLBKI_202_DBT LB, DLDEVBKI_DBT LD WHERE " +
                                    " LD.T_OBJECTTYPEID = ? " +
                                " AND LD.T_OBJECTNUMBER = ? " +
                                " AND LD.T_BKIID_REF    = ? " +
                                " AND LB.T_CODEKIND     = ? " +
                                " AND LB.T_PARTYID_REF  = ? " +
                                " AND LD.T_RESULT       = '+'"+
                                " AND LD.T_TFID_REF     = LB.T_TFID_REF " +
                                " AND LB.T_OBJECTTYPEID = LD.T_OBJECTTYPEID " +
                                " AND LB.T_OBJECTNUMBER = LD.T_OBJECTNUMBER " +
                                " AND LENGTH(TRIM(t_Organization)) > 1 " +
                                " AND t_Date <> TO_DATE('01.01.0001', 'dd.mm.yyyy') " +
                                " ORDER BY LB.T_TFID_REF DESC",
                              "o1", _ObjectTypeID, 
                              "o2", _ObjectNumber, 
                              "o3", lbki.rec.BkiID, 
                              "o4", BankDocKind, 
                              "o5", ClientID, 
                              V_GENOBJ);
         IF (OldDoc.MoveNext())
            InsertString("ID", "1. Наименование сегмента",
                         "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,            "О", FALSE);

            // ТУТ НАЧИНЮТСЯ ВСЕ ДАННЫЕ ИЗ ПОСТОЯННЫХ ТАБЛИЦ!
            // так как последняя выгрузка была успешной то вставляем предыдущие записи без проверок
            // TFS. Последняя выгрузка успешная ? Это утопия.
            InsertString("ID", "2. Тип ID",
                          "N",  2, OldDoc.Value("t_codekind"), "О");

            СерияДокумента = OldDoc.Value("t_Series");     ФлагОбязСерии = "Н";
            НомерДокумента = OldDoc.Value("t_Number");     ФлагОбязНомер = "Н";

            InsertString("ID", "3. Номер серии",
                         "P", 20, СерияДокумента,   ФлагОбязСерии);
            InsertString("ID", "4. Номер документа",
                         "AN", 20, НомерДокумента,  ФлагОбязНомер);
            InsertString("ID", "5. Когда выдан",
                          "D",  8, InsertSpezialValue(SQL_NVL(OldDoc.Value("t_Date"),V_DATE)), "О");
            InsertString("ID", "6. Кем выдан",
                          "P", 510, InsertSpezialValue(SQL_NVL(OldDoc.Value("t_Organization"),V_STRING)),   "О");
            InsertString("ID", "7. Где выдан",
                          "C", 510, "", "Н");
            InsertString("ID", "8. Старый номер документа",
                         "AN", 20, "", "Н", TRUE);

            COUNT = COUNT + 1;         
         END;
      END;

      RETURN TRUE;
   END;

   MACRO ReadRS202(flagBreak : BOOL, RS202)

      WHILE (RS202.MoveNext())
         lbki_202.rec.CREDITNUMBER_REF = SQL_NVL(RS202.Value("T_CREDITNUMBER_REF"), V_INTEGER);
         lbki_202.rec.TFID_REF         = SQL_NVL(RS202.Value("T_TFID_REF"),         V_INTEGER);
         lbki_202.rec.OTHERDEBTORNUM   = SQL_NVL(RS202.Value("T_OTHERDEBTORNUM"),   V_INTEGER);
         lbki_202.rec.COUNTRY          = SQL_NVL(RS202.Value("T_COUNTRY"),          V_STRING);
         lbki_202.rec.CODEKIND         = SQL_NVL(RS202.Value("T_CODEKIND"),         V_INTEGER);
         lbki_202.rec.SERIES           = SQL_NVL(RS202.Value("T_SERIES"),           V_STRING);
         lbki_202.rec.NUMBER           = SQL_NVL(RS202.Value("T_NUMBER"),           V_STRING);
         lbki_202.rec.DATE             = SQL_NVL(RS202.Value("T_DATE"),             V_DATE);
         lbki_202.rec.CODEDEPARTMENT   = SQL_NVL(RS202.Value("T_CODEDEPARTMENT"),   V_STRING);
         lbki_202.rec.ORGANIZATION     = SQL_NVL(RS202.Value("T_ORGANIZATION"),     V_STRING);
         lbki_202.rec.PARTYID_REF      = SQL_NVL(RS202.Value("T_PARTYID_REF"),      V_INTEGER);
         lbki_202.rec.OBJECTTYPEID     = SQL_NVL(RS202.Value("T_OBJECTTYPEID"),     V_INTEGER);
         lbki_202.rec.OBJECTNUMBER     = SQL_NVL(RS202.Value("T_OBJECTNUMBER"),     V_INTEGER);

         DocKind = lbki_202.rec.CodeKind;

         // ID обязательно от 01..27
         IF ((DocKind > 0) AND (DocKind < 28))
            Запись(DocKind, CRSDCommand("SELECT p.T_NAME FROM DPAPRKIND_DBT p WHERE " +
                                              " p.T_CODEDOCUM = LPAD(?, ?, ?)",
                                        "CODEDOCUM", lbki_202.rec.CodeKind,
                                        "CODELEN",   2,
                                        "CODECOD",   "0",
                                        V_STRING));
            ЗаписьИзмененияДокумента(lbki_202.rec.CodeKind, DocKind);            
            IF (flagBreak == true)
               Break;
            END;
         END;
      END;
   END; 

   GENERAL_FAILURE = FALSE;
   ErrMes          = "";

   // Тип ID
   // Для физ. лица.
   IF (
       (TypeClient == PTLEGF_PERSN) 
       OR
       (TypeClient == PTLEGF_PBUL) //  TFS. v 2.20. И ПБЮЛ
      )
      //  TFS. v 2.20. Начало ==>
      // Это обязательный сегмент
      IF (NOT GetBlock_201)
         RETURN FALSE;
      END;

      var NotCODEKIND = 0;
      RS202 = CRSDCommand(
      "with DLBKI_202 as (SELECT LBKI_202.*,  " +
         "   case  T_CODEKIND "  +  
         "       when 21 then  0 " +
         "       else  999 " +
         "   end as T_Prior " +
         "    FROM DLBKI_202_TMP LBKI_202 WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ? " +
                    " AND T_OTHERDEBTORNUM = ? " +
                    " AND T_TFID_REF       = ? " +
                    " AND T_PARTYID_REF    = ? )" +
                    " select * " +
                    " from DLBKI_202 " +
                    " order by  T_Prior",
                   "p0", _ObjectTypeID,
                   "p1", _ObjectNumber,
                   "p2", OtherDebtorNum,
                   "p3", TFID,
                   "p4", ClientID,
                   V_GENOBJ);
       ReadRS202(true,@RS202);           

      RS203 = CRSDCommand(
      "WITH DLBKI_203 as (SELECT LBKI_203.*,  " +
         "   CASE T_DOCKIND "  +  
         "       WHEN 30 THEN 0 " +
         "       WHEN 97 THEN 22 " +
         "       ELSE 999 " +
         "   END as T_Prior " +   
     " FROM DLBKI_203_TMP LBKI_203 WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ? " +
                    " AND T_OTHERDEBTORNUM = ? " +
                    " AND T_TFID_REF       = ? " +
                    " AND T_PARTYID_REF    = ? )"
                    " SELECT * " +
                    " FROM DLBKI_203 " +
                    " ORDER BY T_PRIOR", 
                   "p0", _ObjectTypeID,
                   "p1", _ObjectNumber,
                   "p2", OtherDebtorNum,
                   "p3", TFID,
                   "p4", ClientID, V_GENOBJ);
      
      found = FALSE;
      WHILE (RS203.MoveNext())
         lbki_203.rec.CREDITNUMBER_REF = SQL_NVL(RS203.Value("T_CREDITNUMBER_REF"), V_INTEGER);
         lbki_203.rec.TFID_REF         = SQL_NVL(RS203.Value("T_TFID_REF"),         V_INTEGER);
         lbki_203.rec.OTHERDEBTORNUM   = SQL_NVL(RS203.Value("T_OTHERDEBTORNUM"),   V_INTEGER);
         lbki_203.rec.DOCKIND          = SQL_NVL(RS203.Value("T_DOCKIND"),          V_INTEGER);
         lbki_203.rec.SERIES           = SQL_NVL(RS203.Value("T_SERIES"),           V_STRING);
         lbki_203.rec.NUMBER           = SQL_NVL(RS203.Value("T_NUMBER"),           V_STRING);
         lbki_203.rec.DATE             = SQL_NVL(RS203.Value("T_DATE"),             V_DATE);
         lbki_203.rec.ORGANREG         = SQL_NVL(RS203.Value("T_ORGANREG"),         V_STRING);
         lbki_203.rec.OGRN             = SQL_NVL(RS203.Value("T_OGRN"),             V_STRING);
         lbki_203.rec.PARTYID_REF      = SQL_NVL(RS203.Value("T_PARTYID_REF"),      V_INTEGER);
         lbki_203.rec.OBJECTTYPEID     = SQL_NVL(RS203.Value("T_OBJECTTYPEID"),     V_INTEGER);
         lbki_203.rec.OBJECTNUMBER     = SQL_NVL(RS203.Value("T_OBJECTNUMBER"),     V_INTEGER);
         lbki_203.rec.ISSUEAUTHORITY   = SQL_NVL(RS203.Value("T_ISSUEAUTHORITY"),   V_STRING);
         IF (GetULDocKind(lbki_203.rec.DocKind) > 0)
            Запись(GetULDocKind(lbki_203.rec.DocKind), 
                   CRSDCommand("SELECT T_NAME FROM DOBJKDOC_DBT WHERE " +
                               " T_OBJECTTYPE = ? AND T_REGDOCKIND = ?",
                               "p1", 3,
                               "p2", lbki_203.rec.DocKind,
                                V_STRING));
            ЗаписьИзмененияДокумента(lbki_203.rec.DocKind, GetULDocKind(lbki_203.rec.DocKind));
            found = TRUE;
         END;
      END;

      ReadRS202(false,@RS202);
      
      IF (TypeClient == PTLEGF_PBUL)
         IF (GetBlock(302, TFID, OtherDebtorNum, _ObjectTypeID, _ObjectNumber))

            // ID обязательно 33
            IF (Trim(lbki_302.rec.OGRN) != "")
               Запись(33, "ОГРН");

               ЗаписьИзмененияДокумента(33, 33);
            ELSE
               ErrMes = "";
               InsErrorMessage("Сегмент ID. Отсутствуют данные о регистрации ПБЮЛ");
            END;

            IF (Trim(lbki_302.rec.INN) != "")
               Запись(81, "ИНН");

               ЗаписьИзмененияДокумента(16, 81);
            END;
         ELSE
            ErrMes = "";
            InsErrorMessage("Сегмент ID. Отсутствуют данные о регистрации ПБЮЛ");
         END;
      END;

   // ЮР. Лицо
   ELIF  (TypeClient == PTLEGF_INST)
      // Информация подкачивается из таблиц LBKI_203.DBT
      IF (GetBlock(302, TFID, OtherDebtorNum, _ObjectTypeID, _ObjectNumber))
         IF (Client_NotResident)
             //35 и 82
             Запись(35, "Рег.номер в стране регистрации");
             ЗаписьИзмененияДокумента(35, 35);

             Запись(82, "Иностранный ИНН");
             ЗаписьИзмененияДокумента(82, 82);
         ELSE
             // ID обязательно 34 и 81
             Запись(34, "ОГРН");
             ЗаписьИзмененияДокумента(34, 34);

             Запись(81, "ИНН");
             ЗаписьИзмененияДокумента(16, 81);
         END; //IF (Client_NotResident)

      ELSE
         ErrMes = "";
         InsErrorMessage("Сегмент ID. Не задан ИНН");
      END;
   END;

   // Обязательно ID = 98
   Запись(98, "Код субъекта КИ");
   ЗаписьИзмененияДокумента(98, 98);

   IF (NOT GENERAL_FAILURE)
       STAT            = TRUE;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   ErrMes = "";
   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
// NA
// Блок 201
MACRO СЕГМЕНТ_ИМЕНИ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА : STRING,
       STAT                 : BOOL = FALSE,
       save_GENERAL_FAILURE : BOOL = GENERAL_FAILURE;
   var year_reg: integer;
   var year_rog: integer;

   // Это обязательный сегмент
   IF (NOT GetBlock_201)
      RETURN FALSE;
   END;

   GENERAL_FAILURE = FALSE;

   СЕГМЕНТ_NA = СЕГМЕНТ_NA + 1;
   IF (СЕГМЕНТ_NA < 10)
      НАИМЕНОВАНИ_СЕГМЕНТА = "NA0" + СЕГМЕНТ_NA;
   ELSE
      НАИМЕНОВАНИ_СЕГМЕНТА = "NA"  + СЕГМЕНТ_NA;
   END;

   InsertString("NA", "1. Наименование сегмента",
                "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                         "О", FALSE);

   InsertString("NA", "2. Фамилия",
                 "C", 60, lbki_201.rec.Name1,                           "О");

   IF (Regim_Rejected)
      InsertString("NA", "3. Отчество",
                    "P", 60, InsertSpezialValue(lbki_201.rec.Name3),    "Н");
   ELSE
      InsertString("NA", "3. Отчество",
                    "C", 60, lbki_201.rec.Name3,                        "Н");
   END;
   InsertString("NA", "4. Имя",
                 "C", 60, lbki_201.rec.Name2,                           "О");

   InsertString("NA", "5. Пол",
                 "S",  1, "", "Н");

   IF (Regim_Rejected)
      InsertString("NA", "6. Дата рождения",
                    "D",  8, InsertSpezialValue(lbki_201.rec.Born),     "О");

      IF ((_ObjectTypeID != LO_CLAIM) AND (_ObjectTypeID != LO_ENSCONTR))
         DateSplit(credit_c.rec.RegDate, null, null, year_reg);
         DateSplit(lbki_201.rec.Born, null, null, year_rog);
      
         IF ((TypeClient != PTLEGF_INST) AND
            (
             ((year_reg - year_rog) < 14) 
             OR // 154458
             ((year_reg - year_rog) > 110)
            ))
            InsErrorMessage("Неверное значение обязательного поля");
         END;
      END;
      
      InsertString("NA", "7. Место рождения",
                   "P", 1020, InsertSpezialValue(lbki_201.rec.BirsPlace),"О");
   ELSE
      InsertString("NA", "6. Дата рождения",
                    "D",  8, lbki_201.rec.Born,     "О");
      IF ((_ObjectTypeID != LO_CLAIM) AND (_ObjectTypeID != LO_ENSCONTR))
         DateSplit(credit_c.rec.RegDate, null, null, year_reg);
         DateSplit(lbki_201.rec.Born, null, null, year_rog);
      
         IF (
             (TypeClient != PTLEGF_INST) AND
             (
              ((year_reg - year_rog) < 14) 
              OR // 154458
              ((year_reg - year_rog) > 110)
             )
            )
             InsErrorMessage("Неверное значение обязательного поля");
         END;
      END;
      InsertString("NA", "7. Место рождения",
                    "P", 1020, lbki_201.rec.BirsPlace,"О");
   END;

   InsertString("NA", "8. Гражданство",
                 "S",  1, "", "Н");

   InsertString("NA", "9. Семейное положение",
                 "N",  1, "",                       "Н");

   InsertString("NA", "10. Количество иждивенцев",
                 "N",   2, "",                      "Н");

   InsertString("NA", "11. Примечания",
                 "N",   1, "",                      "Н");

   InsertString("NA", "12. Фамилия до изменения",
                 "C",  60, "",                      "Н");

   InsertString("NA", "13. Имя до изменения",
                 "C",  60, "",                      "Н", TRUE);

   COUNT = COUNT + 1;

   IF (NOT GENERAL_FAILURE)
      STAT            = TRUE;
      GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
// Сегмент BU
// Блоки: 301, 302
MACRO СЕГМЕНТ_ПРЕДПРИЯТИЯ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING,
       STAT                : BOOL = FALSE,
       save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE;

   // Это обязательный сегмент
   IF ((NOT GetBlock(302, TFID, OtherDebtorNum, _ObjectTypeID, _ObjectNumber)))
      RETURN FALSE;
   END;

   VAR lbki_301 = CRSDCommand("SELECT T_FULLNAME, T_SHORTNAME FROM DLBKI_301_TMP WHERE " + 
                               " T_OBJECTTYPEID   = ? " +
                           " AND T_OBJECTNUMBER   = ? " +
                           " AND T_TFID_REF       = ? " +
                           " AND T_OTHERDEBTORNUM = ? " +
                           " AND T_PARTYID_REF    = ? ",
                           "p1",  _ObjectTypeID,
                           "p2",  _ObjectNumber,
                           "p3",  TFID,
                           "p4",  OtherDebtorNum,
                           "p5",  ClientID,
                           V_GENOBJ);
   IF (NOT lbki_301.MoveNext())
      RETURN FALSE;
   END;

   GENERAL_FAILURE = FALSE;

   СЕГМЕНТ_BU = СЕГМЕНТ_BU + 1;
   IF (СЕГМЕНТ_BU < 10)
      НАИМЕНОВАНИ_СЕГМЕНТА = "BU0" + СЕГМЕНТ_BU;
   ELSE
      НАИМЕНОВАНИ_СЕГМЕНТА = "BU"  + СЕГМЕНТ_BU;
   END;

   InsertString("BU", "1. Наименование сегмента",
                "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,    "О", FALSE);

   InsertString("BU", "2. Название предприятия",
                 "P", 1020, SQL_NVL(lbki_301.VALUE("T_FULLNAME"), V_STRING),  "О");

   InsertString("BU", "3. Дата регистрации",
                 "D",  8, date(0,0,0),    "Н");

   InsertString("BU", "4. Статус предприятия",
                 "N",  1, 0,                       "Н");

   InsertString("BU", "5. Дата определения статуса",
                 "D",  8, date(0,0,0),             "Н");

   InsertString("BU", "6. ОКПО",
                 "N", 10, lbki_302.rec.okpo,       "Н");

   InsertString("BU", "7. ОКОНХ",
                 "N",  5, lbki_302.rec.okonh,      "Н");

   InsertString("BU", "8. ОКВЭД",
                 "P",  8, lbki_302.rec.okved,      "Н");

   InsertString("BU", "9. ОКАТО",
                 "N", 11, lbki_302.rec.okato,      "Н");

   InsertString("BU", "10. ОКОГУ",
                 "N",   7, "",                     "Н");

   InsertString("BU", "11. ОКФС",
                 "N",   2, lbki_302.rec.okfs,      "Н");

   InsertString("BU", "12. ОКОПФ",
                 "N",   5, lbki_302.rec.okopf,     "Н");

   InsertString("BU", "13. Код причины постановки на учет (КПП)",
                 "N",   9, lbki_302.rec.kpp,       "Н");

   InsertString("BU", "14. Годовой оборот",
                 "N",    1, "",                    "Н");

   InsertString("BU", "15. Количество служащих",
                 "N",   5, "",                     "Н");

   InsertString("BU", "16. Количество директоров/владельцев",
                 "N",   3, "",                     "Н");

   InsertString("BU", "17. Сокращенное наименование предприятия",
                 "P", 255, SQL_NVL(lbki_301.VALUE("T_SHORTNAME"), V_STRING), "Н");

   InsertString("BU", "18. Название предприятия до изменения",
                 "C", 1020, "",                     "Н");

   InsertString("BU", "19. ОКПО до изменения",
                 "N",   8, "",                     "Н");

   InsertString("BU", "20. ОКАТО до изменения",
                 "N",  11, "",                     "Н");

   InsertString("BU", "21. Код ККП до изменения",
                 "N",   9, "",                     "Н");

   InsertString("BU", "22. Сокращенное наименование предприятия до изменения",
                 "P", 255, "",                     "Н");

   InsertString("BU", "23. Фирменное наименование предприятия",
                 "P", 255, "",                     "Н");

   InsertString("BU", "24. Наименование на одном из языков РФ",
                 "P", 1020, "",                     "Н");

   InsertString("BU", "25. Наименование на иностранном языке",
                 "P", 1020, "",                     "Н", TRUE);

   COUNT = COUNT + 1;

   IF (NOT GENERAL_FAILURE)
       STAT            = TRUE;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
// AD
// Блок 401
MACRO СЕГМЕНТ_АДРЕСА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       STAT                : BOOL = FALSE,
       save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE, type1 = 0, type2 = 0,
   segments = TArray;

   MACRO Запись()
      СЕГМЕНТ_AD = СЕГМЕНТ_AD + 1;
      IF (СЕГМЕНТ_AD < 10)
         НАИМЕНОВАНИ_СЕГМЕНТА = "AD0" + СЕГМЕНТ_AD;
      ELSE
         НАИМЕНОВАНИ_СЕГМЕНТА = "AD"  + СЕГМЕНТ_AD;
      END;
      InsertString("AD", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,    "О", FALSE);

      IF (TypeClient != PTLEGF_INST)
         IF   (lbki_401.rec.TypeAdress == 1)
            InsertString("AD", "2. Тип адреса",
                          "N",  1, 1,                 "О");
         ELIF (lbki_401.rec.TypeAdress == 2)
            InsertString("AD", "2. Тип адреса",
                          "N",  1, 2,                 "О");
         END;
      ELSE
         IF   (lbki_401.rec.TypeAdress == 3)
            InsertString("AD", "2. Тип адреса",
                          "N",  1, 3,                 "Н");
         ELIF (lbki_401.rec.TypeAdress == 4)
            InsertString("AD", "2. Тип адреса",
                          "N",  1, 4,                 "О");
         END;
      END;

      segments = split(lbki_401.rec.Adress, "\t" );
      IF (trim(segments[5]) == "") 
           InsErrorMessage("Сегмент: AD. Не заполнено поле: 'Местоположение'");
      END;
      IF (trim(segments[7]) == "") 
           InsErrorMessage("Сегмент: AD. Не заполнено поле: 'Улица'");
      END;

      InsertString("AD", "3. Строка адреса",
                   "AN",  200, lbki_401.rec.Adress,   "О");

      InsertString("AD", "15. Статус",
                    "N",  1, "",                      "Н");

      InsertString("AD", "16. Дата прописки",
                    "D",  8, "",                      "Н", TRUE);

      COUNT = COUNT + 1;

      RETURN TRUE;
   END;

   // 1 - Юридический
   // 2 - Фактический

   GENERAL_FAILURE = TRUE; // Если не будет ни одного поля Адреса - ЭТО ОШИБКА!

   IF (TypeClient != PTLEGF_INST)
      type1 = 1;       // Адрес прописки
      type2 = 2;       // Фактический адрес
   ELSE
      type1 = 4;       // Фактический для юриков
      type2 = 3;       // Юридеческий
   END;

   IF (TypeClient != PTLEGF_INST)
      IF (Adress1_401 != "-1")
         lbki_401.rec.TypeAdress = 1;
         lbki_401.rec.Adress     = Adress1_401;
         Запись();

         IF (Adress2_401 != "-1")
            lbki_401.rec.TypeAdress = 2;
            lbki_401.rec.Adress     = Adress2_401;
            Запись();

            GENERAL_FAILURE = FALSE;
         END;
      END;
   ELSE
      IF (Adress1_401 != "-1")
         lbki_401.rec.TypeAdress = 4;
         lbki_401.rec.Adress     = Adress1_401;
         Запись();

         IF (Adress2_401 != "-1")
            lbki_401.rec.TypeAdress = 3;
            lbki_401.rec.Adress     = Adress2_401;
            Запись();
         END;
         GENERAL_FAILURE = FALSE; // Достаточно одного фактичского
      END;
   END;

   IF (NOT GENERAL_FAILURE)
      STAT            = TRUE;
      GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;
////////////////////////////////////////////////////////////////////////////////
// PN
// Блок Phone
MACRO СЕГМЕНТ_ТЕЛЕФОНА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)

  MACRO InsertPhoneSegment (SegNum: integer, PNumber: string, TypeP: integer)
     VAR SegName : string = "";
     
     IF (SegNum < 10)
        SegName = "PN0" + SegNum;
     ELSE
        SegName = "PN"  + SegNum;
     END;
     
     InsertString("PN", "1. Наименование сегмента",
                     "AN",  4, SegName,   "О", FALSE);

     IF (StrLen(PNumber) <= 15)
        InsertString("PN", "2. Номер",
                           "P", 15, PNumber, "О");
     ELSE
        InsErrorMessage("Сегмент: 'PN'. Неверный формат обязательного поля: '2. Номер'"); // TypeClient == PTLEGF_INST AND TypeP == 1
     END;

     InsertString("PN", "3. Тип",
                        "N",  1, TypeP,                      "О", TRUE);
   END;

   VAR RS = NULL,
       TypePhone           : integer = 5,
       PhoneNum            : string  = "",
       FieldName           : string  = "",
       FieldName1          : string  = "",
       НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       save_GENERAL_FAILURE: BOOL   = GENERAL_FAILURE;

   // Это обязательный сегмент!
   lbki_phone.Clear();

   // Для юрика обязательно наличие рабочего телефона
   IF (TypeClient == PTLEGF_INST)
      IF (CRSDCommand("SELECT COUNT(*) FROM DLBKI_PHONE_TMP l WHERE "
                            " l.T_TFID_REF         = ? " +
                        " AND l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? " +
                        " AND Length(l.T_CONTACT_VALUE)> ? " +
                        " AND l.T_CONTACTTYPE in (?) ",
                      "TFID",           TFID,
                      "ObjectTypeID",   _ObjectTypeID,
                      "ObjectNumber",   _ObjectNumber,
                      "CONTACT_VALUE",  1,
                      "CONTACTTYPE",    1,
                      V_INTEGER) == 0)
         InsErrorMessage("Для юридического лица не задан рабочий телефон");
         RETURN FALSE;
      END;
   END;

   RS =
   CRSDCommand("SELECT * FROM DLBKI_PHONE_TMP l WHERE "
                            " l.T_TFID_REF         = ? " +
                        " AND l.T_OBJECTTYPEID = ? AND l.T_OBJECTNUMBER = ? ",
                      "TFID",           TFID,
                      "ObjectTypeID",   _ObjectTypeID,
                      "ObjectNumber",   _ObjectNumber,
                      V_GENOBJ);

   WHILE (RS.MoveNext())

      var phone_len: integer = 0;
      var phone_str: integer = 0;

      СЕГМЕНТ_PN = СЕГМЕНТ_PN + 1;

      FieldName = "T_CONTACT_VALUE";
      FieldName1 = "T_CONTACTTYPE";
      phone_len = StrLen(Trim(string(RS.Value(FieldName))));
      phone_str = StrLen(string(RS.Value(FieldName)));
      IF (((phone_len > 1) AND (phone_str <= 15)) OR
          ((phone_len > 1) AND (TypeClient == PTLEGF_INST)))
         PhoneNum = RS.Value(FieldName);
         TypePhone = RS.Value(FieldName1);      
         
         InsertPhoneSegment (СЕГМЕНТ_PN, PhoneNum, TypePhone);
         COUNT = COUNT + 1;
      END;
      
   END;

   GENERAL_FAILURE = save_GENERAL_FAILURE; // Не критично

   RETURN TRUE;
END;

// 6.7   Сегмент <Дополнительные залоги> (CL)
// Данный сегмент используется только для передачи информации о дополнительных залогах. 
//    Данные по основному (или единственному) залогу передаются в сегменте Сделка (TR);
// Сегмент может передаваться только вместе с сегментом Сделка (TR) и находиться в записи до него;
// По заемщику - сегмент обязателен только при наличии второго, третьего и т.д. залога;
// По поручителю - сегмент не передается до даты начала выполнения им обязательств заемщика, 
//    после наступления этой даты - обязательно при наличии второго, третьего и т.д. залога;
// По принципалу - сегмент не передается.
MACRO СЕГМЕНТ_ЗАЛОГИ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "";
   VAR save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE;

   IF (_ObjectTypeID == LO_GUARANTEE)
      RETURN TRUE;
   END;

   VAR RS = CRSDCommand(
   "SELECT * FROM DNBKI_TR_CRD_TMP tr WHERE " +
         " tr.T_SEGNAME      = ? " +
     " AND tr.T_OBJECTTYPEID = ? " +
     " AND tr.T_OBJECTNUMBER = ? ",
   "SegName",     "CL",
   "ObjectTypeID", _ObjectTypeID,
   "ObjectNumber", _ObjectNumber,
   V_GENOBJ);

   GENERAL_FAILURE = FALSE;

   WHILE (RS.MoveNext())
      СЕГМЕНТ_CL = СЕГМЕНТ_CL + 1;
      IF (СЕГМЕНТ_CL < 10)
         НАИМЕНОВАНИ_СЕГМЕНТА = "CL0" + СЕГМЕНТ_CL;
      ELSE
         НАИМЕНОВАНИ_СЕГМЕНТА = "CL"  + СЕГМЕНТ_CL;
      END;

      InsertString("CL", "1. Наименование сегмента        ", 
                   "AN", 4, НАИМЕНОВАНИ_СЕГМЕНТА,                                 "О", FALSE);

      InsertString("CL", "2. Идентификатор залога         ", 
                   "P", 35, SQL_NVL(RS.Value("T_ENSOBJECTID"),        V_INTEGER), "О");

      InsertString("CL", "3. Код залога                   ", 
                   "A",  2, string(SQL_NVL(RS.Value("T_COLLATERAL_CODE"), V_INTEGER):2:0:o), "О");

      InsertString("CL", "4. Оценочная стоимость залога   ", 
                   "S", 10, SQL_NVL(RS.Value("T_COLLATERAL_VALUE"),     V_MONEY), "О");

      InsertString("CL", "5. Дата оценки стоимости залога ", 
                   "D",  8, SQL_NVL(RS.Value("T_COLLATERAL_DATE"),       V_DATE), "О");

      InsertString("CL", "6. Срок действия договора залога", 
                   "D",  8, SQL_NVL(RS.Value("T_COLLATERAL_EXPIRATION"), V_DATE), "О");
                   
      InsertString("CL", "7. Код валюты", 
                   "A",  3, SQL_NVL(RS.Value("T_CCY"), V_STRING), "У", TRUE);

      COUNT = COUNT + 1;
   END;

   GENERAL_FAILURE = save_GENERAL_FAILURE; // Не критично
   RETURN TRUE;
END;

// 6.9   Сегмент <Дополнительные банковские гарантии> (BG)
// Данный сегмент используется только для передачи данных о дополнительных банковских гарантиях по кредиту. 
//    Данные по основной (или единственной) банковской гарантии передаются в сегменте Сделка (TR);
// Сегмент может передаваться только вместе с сегментом Сделка (TR) и находиться в записи до него;
// По заемщику - сегмент обязателен только при наличии второй, третьей и т.д. банковской гарантии;
// По поручителю - сегмент не передается до даты начала выполнения им обязательств заемщика, 
//    после наступления этой даты - обязательно при наличии второй, третьей и т.д. банковской гарантии;
// По принципалу - сегмент не передается, все данные должны быть переданы в сегменте Сделка (TR).
MACRO СЕГМЕНТ_ГАРАНТИИ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "";
   VAR save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE;

   IF (_ObjectTypeID == LO_GUARANTEE)
      RETURN TRUE;
   END;

   VAR RS = CRSDCommand(
   "SELECT * FROM DNBKI_TR_CRD_TMP tr WHERE " +
         " tr.T_SEGNAME      = ? " +
     " AND tr.T_OBJECTTYPEID = ? " +
     " AND tr.T_OBJECTNUMBER = ? " +
   "ORDER BY tr.T_GUARANTEE_SUM DESC, tr.T_ENSGUARANTEE ASC",
   "SegName",     "BG",
   "ObjectTypeID", _ObjectTypeID,
   "ObjectNumber", _ObjectNumber,
   V_GENOBJ);

   GENERAL_FAILURE = FALSE;
   
   WHILE (RS.MoveNext())
      СЕГМЕНТ_BG = СЕГМЕНТ_BG + 1;
      IF (СЕГМЕНТ_BG < 10)
         НАИМЕНОВАНИ_СЕГМЕНТА = "BG0" + СЕГМЕНТ_BG;
      ELSE
         НАИМЕНОВАНИ_СЕГМЕНТА = "BG"  + СЕГМЕНТ_BG;
      END;

      InsertString("BG", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА, "О", FALSE);

      InsertString("BG", "2. Идентификатор банковской гарантии",
                    "P", 35, SQL_NVL(RS.Value("T_ENSGUARANTEE"),   V_INTEGER), "О");

      InsertString("BG", "3. Объем обязательства, обеспечиваемого банковской гарантией",
                    "A",  1, SQL_NVL(RS.Value("T_VOLUME_OF_DEBT"),  V_STRING), "О");

      InsertString("BG", "4. Сумма банковской гарантии",
                    "S", 10, SQL_NVL(RS.Value("T_GUARANTEE_SUM"),  V_NUMERIC), "у");

      InsertString("BG", "5. Срок банковской гарантии",
                    "D",  8, SQL_NVL(RS.Value("T_GUARANTEE_TERM"),    V_DATE), "О");

      InsertString("BG", "6. Иные случаи прекращения банковской гарантии",
                    "P",  200, "", "Н");
                    
      InsertString("BG", "7. Код валюты",
                    "A", 3, SQL_NVL(RS.Value("T_CCY"),  V_STRING), "у", TRUE);                  

      COUNT = COUNT + 1;
   END;

   GENERAL_FAILURE = save_GENERAL_FAILURE; // Не критично
   RETURN TRUE;
END;

// 6.8   Сегмент <Дополнительные поручители> (GR)
// Данный сегмент используется только для передачи данных о дополнительных поручителях по кредиту. 
//    Данные по основному (или единственному) поручителю передаются в сегменте Сделка (TR);
// Сегмент может передаваться только вместе с сегментом Сделка (TR) и находиться в записи до него;
// По заемщику - сегмент обязателен только при наличии второго, третьего и т.д. поручителя;
// По поручителю - сегмент не передается, все данные должны быть переданы в сегменте Сделка (TR);
// По принципалу - сегмент не передается.
MACRO СЕГМЕНТ_ПОРУЧИТЕЛЬСТВА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "";
   VAR save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE;

   IF (_ObjectTypeID == LO_GUARANTEE)
      RETURN TRUE;
   END;

   VAR RS = CRSDCommand(
   "SELECT * FROM DNBKI_TR_CRD_TMP tr WHERE " +
         " tr.T_SEGNAME      = ? " +
     " AND tr.T_OBJECTTYPEID = ? " +
     " AND tr.T_OBJECTNUMBER = ? ",
   "SegName",     "GR",
   "ObjectTypeID", _ObjectTypeID,
   "ObjectNumber", _ObjectNumber,
   V_GENOBJ);

   GENERAL_FAILURE = FALSE;
   
   WHILE (RS.MoveNext())
      СЕГМЕНТ_GR = СЕГМЕНТ_GR + 1;
      IF (СЕГМЕНТ_GR < 10)
         НАИМЕНОВАНИ_СЕГМЕНТА = "GR0" + СЕГМЕНТ_GR;
      ELSE
         НАИМЕНОВАНИ_СЕГМЕНТА = "GR"  + СЕГМЕНТ_GR;
      END;

      // Список ДО блока GR
      IDEnsContrGR(IDEnsContrGR.Size) = SQL_NVL(RS.Value("T_ENSVOUCHER"),  V_INTEGER);

      InsertString("GR", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА, "О", FALSE);

      InsertString("GR", "2. Идентификатор поручительства",
                    "P", 35, SQL_NVL(RS.Value("T_ENSVOUCHER"),  V_INTEGER), "О");

      InsertString("GR", "3. Объем обязательства, обеспечиваемого поручительством",
                    "A",  1, SQL_NVL(RS.Value("T_VOLUME_OF_DEBT"), V_STRING), "О");

      InsertString("GR", "4. Сумма поручительства",
                    "S", 10, SQL_NVL(RS.Value("T_GUARANTEE_SUM"), V_NUMERIC), "О");

      InsertString("GR", "5. Срок поручительства", 
                    "D",  8, SQL_NVL(RS.Value("T_GUARANTEE_TERM"),   V_DATE), "О");

      InsertString("GR", "6. Код валюты", 
                    "A",  3, SQL_NVL(RS.Value("T_CCY"),   V_STRING), "У", TRUE);                    

      COUNT = COUNT + 1;
   END;

   GENERAL_FAILURE = save_GENERAL_FAILURE; // Не критично
   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
MACRO СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR save_COUNT = COUNT; // Сохраним кол-во успешно сформированных сегментов

   СЕГМЕНТ_ID = 0; СЕГМЕНТ_NA = 0; СЕГМЕНТ_BU = 0;
   СЕГМЕНТ_AD = 0; СЕГМЕНТ_PN = 0; СЕГМЕНТ_TR = 1;
   СЕГМЕНТ_LE = 0; СЕГМЕНТ_BK = 0; СЕГМЕНТ_CL = 0;
   СЕГМЕНТ_GR = 0; СЕГМЕНТ_BG = 0;

   // Сегмент ID
   IF (NOT СЕГМЕНТ_ИДЕНТИФИКАЦИИ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID))
      InsErrorMessage("Ошибка формирования сегмента ID");
      COUNT = save_COUNT;
   END;

   // Физик
   IF (TypeClient != PTLEGF_INST)
       // Сегмент NA
      IF (NOT СЕГМЕНТ_ИМЕНИ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
         InsErrorMessage("Ошибка формирования сегмента NA");
         COUNT = save_COUNT;
      END;
   // Юрик
   ELSE

      // Сегмент BU
      IF (NOT СЕГМЕНТ_ПРЕДПРИЯТИЯ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID))
         InsErrorMessage("Ошибка формирования сегмента BU");
         COUNT = save_COUNT;
      END;
   END;

   // Сегмент AD
   IF (NOT СЕГМЕНТ_АДРЕСА(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      InsErrorMessage("Ошибка формирования сегмента AD");
      COUNT = save_COUNT;
   END;

   // Сегмент PN
   IF ((NOT СЕГМЕНТ_ТЕЛЕФОНА(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum)) AND (TypeClient == PTLEGF_INST))
      InsErrorMessage("Ошибка формирования сегмента PN");
      COUNT = save_COUNT;
   END;

   // Дополнительные залоги
   IF (NOT СЕГМЕНТ_ЗАЛОГИ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      InsErrorMessage("Ошибка формирования сегмента CL");
      COUNT = save_COUNT;
   END;

   // Дополнительные банковские гарантии
   IF (NOT СЕГМЕНТ_ГАРАНТИИ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      InsErrorMessage("Ошибка формирования сегмента BG");
      COUNT = save_COUNT;
   END;

   // Дополнительные поручительства
   IF (NOT СЕГМЕНТ_ПОРУЧИТЕЛЬСТВА(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      InsErrorMessage("Ошибка формирования сегмента PN");
      COUNT = save_COUNT;
   END;

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// TR для Поручителя
MACRO СЕГМЕНТ_СДЕЛКА_ДО(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       STAT                : BOOL   = FALSE,
       FIRSTREC            : BOOL   = FALSE,
       Money               : MONEY  = $0,
       bigMoney            : MONEY  = $9999999999,
       save_GENERAL_FAILURE: BOOL   = GENERAL_FAILURE,
       RS = NULL;

   VAR LegalForm = -1;
   VAR year_reg:          integer;
   VAR year_rog:          integer;
   VAR DateAccountState_tmp: date;
   VAR LastDate_temp:        date;
   VAR Necessary: BOOL;
   VAR ACCOUNT_RATING : STRING = "";

   RS = CRSDCommand(
   "SELECT tr.*, CASE NVL(ens.T_DATEOBLIGATION, TO_DATE('01.01.0001', 'dd.mm.yyyy')) "+
               " WHEN TO_DATE('01.01.0001', 'dd.mm.yyyy') THEN TO_DATE('31.12.9999', 'dd.mm.yyyy') "+
               " ELSE ens.T_DATEOBLIGATION "+
               "  END AS T_DATEOBLIGATION " +
   " FROM DNBKI_TR_ENS_TMP tr LEFT JOIN DENS_CRD_DBT ens ON (TR.T_OBJECTNUMBER = ENS.T_ENSCONTRACTID_REF AND TR.T_CREDITNUMBER = ENS.T_CREDITNUMBER_REF ) " +
   " WHERE " +
      " tr.T_OBJECTTYPEID = ? " +
  " AND tr.T_OBJECTNUMBER = ? " +
  " ORDER BY tr.T_CREDITNUMBER, tr.T_REPORTDATE",
                    "ObjectTypeID", _ObjectTypeID,
                    "ObjectNumber", _ObjectNumber,
                     V_GENOBJ);

   GENERAL_FAILURE = FALSE;

   VAR FoundGR = FALSE;
   IF (IDEnsContrGR.Size() > 0)
      FOR (VAR I, 0, IDEnsContrGR.Size() - 1)
         IF (_ObjectNumber == IDEnsContrGR(I))
            FoundGR = TRUE;
         END;
      END;
   END;

   WHILE (RS.MoveNext())
      IF (LegalForm == -1)
         LegalForm = CRSDCommand("SELECT T_LEGALFORM FROM DCREDIT_C_DBT WHERE T_CREDITNUMBER = ?",
                                 "p1", RS.Value("T_CREDITNUMBER"),
                                 V_INTEGER);
      END;

      IF (SQL_NVL(RS.Value("T_DATEOBLIGATION"), V_DATE) <= SQL_NVL(RS.Value("T_REPORTDATE"), V_DATE))
          Necessary = TRUE;
      ELSE
          Necessary = FALSE;
      END;

      FIRSTREC = TRUE;

      СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

      НАИМЕНОВАНИ_СЕГМЕНТА = "TR01";

      InsertString("TR", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                                         "Н", FALSE);

      InsertString("TR", "2. Код участника",
                   "AN", 12, lbki.rec.SourceID,                                            "Н");

      InsertString("TR", "3. Номер счета",
                    "P", 35, SQL_NVL(RS.Value("T_USCREDITNUMBER"), V_STRING),              "Н");

      IF (Necessary)
      InsertString("TR", "4. Тип счета",                                           
                    "AN",  2, string(SQL_NVL(RS.Value("T_TYPECREDIT"), V_INTEGER):2:0:o),  "О");
      ELSE
      InsertString("TR", "4. Тип счета",                                           
                    "S",  2, "",                                                           "Н");
      END;

      InsertString("TR", "5. Отношение к счету",                                   
                    "N",  1, SQL_Nvl(RS.Value("T_TYPECLIENT"), V_INTEGER),                 "Н");


      InsertString("TR", "6. Дата открытия",
                    "D",  8, SQL_Nvl(RS.Value("T_DATE_ACCOUNT_OPENED"), V_DATE),           "О");
      IF (Necessary)
      InsertString("TR", "7. Дата последней выплаты", 
                    "D",  8, SQL_Nvl(RS.Value("T_DATE_OF_LAST_PAYMENT"), V_DATE),          "О");

      ACCOUNT_RATING = SQL_Nvl(RS.Value("T_ACCOUNT_RATING"), V_STRING);
      InsertString("TR", "8. Состояние счета",                                           
                    "A",  2, ACCOUNT_RATING,              "О");
      
      InsertString("TR", "9. Дата состояния счета",
                    "D",  8, SQL_NVL(RS.Value("T_DATE_ACCOUNT_RATING"), V_DATE),           
                           mandatory((ACCOUNT_RATING == "14")
                                      OR
                                     (ACCOUNT_RATING == "70")));
      ELSE
      InsertString("TR", "7. Дата последней выплаты", 
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "8. Состояние счета",                                           
                    "S",  2, "",                                                           "Н");
      
      InsertString("TR", "9. Дата состояния счета",
                    "S",  2, "",                                                           "Н");
      END;
      
      InsertString("TR", "10. Дата составления отчета",
                    "D",  8, SQL_NVL(RS.Value("T_REPORTDATE"), V_DATE),                    "Н");

      IF (Necessary)
         InsertString("TR", "11. Лимит кредита/Исходная сумма кредита",
                       "S", 10, MAX(SQL_NVL(RS.Value("T_CREDIT_LIMIT"), V_MONEY), 0),      "О");
         
         InsertString("TR", "12. Баланс",
                       "S", 10, SQL_NVL(RS.Value("T_BALANCE"), V_MONEY),                   "О");
         
         InsertString("TR", "13. Просрочка",
                       "S", 10, CHECK_MONEY(ACCOUNT_RATING,SQL_NVL(RS.Value("T_PAST_DUE"), V_MONEY)),                  "О");
         
         InsertString("TR", "14. Следующий платеж",
                       "S", 10, CHECK_MONEY(ACCOUNT_RATING,SQL_NVL(RS.Value("T_NEXT_PAYMENT"), V_MONEY)),              "Н");
         
         InsertString("TR", "15. Частота выплат",
                       "N",  1, SQL_NVL(RS.Value("T_CREDIT_PAYMENT_FREQUENCY"), V_INTEGER),"Н");
         
         InsertString("TR", "16. Своевременность платежей",
                      "AN",  1, SQL_NVL(RS.Value("T_MONITORING_OF_PAYMENT"), V_STRING),    "О");
         
         InsertString("TR", "17. Код валюты",
                       "A",  3, SQL_NVL(RS.Value("T_CURRENCY_CODE"), V_STRING),            "Н");
         
         InsertString("TR", "18. Код залога",
                       "A",  2, string(SQL_NVL(RS.Value("T_COLLATERAL_CODE"), V_INTEGER):2:0:o), "Н");
         
         InsertString("TR", "19. Дата окончания срока договора",
                       "D",  8, SQL_NVL(RS.Value("T_DATE_OF_CONTRACT_TERMINATION"), V_DATE),"Н");
         
         InsertString("TR", "20. Дата финального платежа",
                       "D",  8, SQL_NVL(RS.Value("T_DATE_PAYMENT_DUE"), V_DATE),           "О");
         
         InsertString("TR", "21. Дата финальной выплаты процентов",
                       "D",  8, SQL_NVL(RS.Value("T_DATE_INTEREST_PAYMENT_DUE"), V_DATE),  "О");
         
         InsertString("TR", "22. Частота выплат процентов",
                       "N",  1, SQL_NVL(RS.Value("T_INTEREST_PAYMENT_FREQUENCY"), V_INTEGER),"Н");
      ELSE
         InsertString("TR", "11. Лимит кредита/Исходная сумма кредита",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "12. Баланс",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "13. Просрочка",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "14. Следующий платеж",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "15. Частота выплат",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "16. Своевременность платежей",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "17. Код валюты",
                       "A",  3, SQL_NVL(RS.Value("T_CURRENCY_CODE"), V_STRING),            "Н");
         
         InsertString("TR", "18. Код залога",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "19. Дата окончания срока договора",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "20. Дата финального платежа",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "21. Дата финальной выплаты процентов",
                       "S",  2, "",                                                        "Н");
         
         InsertString("TR", "22. Частота выплат процентов",
                       "S",  2, "",                                                        "Н");
      END;
      InsertString("TR", "23. Старый код участника",
                   "AN", 12, "",                                                           "Н");
      
      InsertString("TR", "24. Старый номер счета",
                    "P", 35, "",                                                           "Н");

      InsertString("TR", "25. Текущая задолженность",
                    "S", 10, CHECK_MONEY(ACCOUNT_RATING,SQL_NVL(RS.Value("T_AMOUNT_OUTSTANDING"), V_MONEY)), "О");

      InsertString("TR", "26. Флаг о наличии поручителя",
                    "A",   1,  "",                                                         "Н");

      IF (Necessary)
      InsertString("TR", "27. Объем обязательства, обеспечиваемого поручительством",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "28. Сумма поручительства",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "29. Срок поручительства",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "30. Флаг о наличии банковской гарантии",
                    "A",  1,  SQL_NVL(RS.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING),   "О");

      InsertString("TR", "31. Объем обязательства, обеспечиваемого банковской гарантией",
                    "A",  1,  SQL_NVL(RS.Value("T_VOLUME_OF_SECURED"), V_STRING),          
                   mandatory(SQL_NVL(RS.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING) == "B"));

      InsertString("TR", "32. Сумма банковской гарантии",
                    "S",  10, SQL_NVL(RS.Value("T_BANK_GUARANTEE_SUM"), V_NUMERIC),        
                   mandatory(SQL_NVL(RS.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING) == "B"));

      InsertString("TR", "33. Срок банковской гарантии",
                    "D",  8,  SQL_NVL(RS.Value("T_BANK_GUARANTEE_TERM"), V_DATE),          
                   mandatory(SQL_NVL(RS.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING) == "B"));

      InsertString("TR", "34. Оценочная стоимость залога",
                    "S",  10, SQL_NVL(RS.Value("T_COLLATERAL_VALUE"), V_NUMERIC),          "У");

      InsertString("TR", "35. Дата оценки стоимости залога",
                    "D",   8, SQL_NVL(RS.Value("T_COLLATERAL_DATE"), V_DATE),              "У");

      InsertString("TR", "36. Срок действия договора залога",
                    "D",   8, SQL_NVL(RS.Value("T_COLLATERAL_EXPIRATION"), V_DATE),        "У");

      InsertString("TR", "37. Полная стоимость кредита",
                    "A",  10, SQL_NVL(RS.Value("T_OVERALL_VALUE_OF_CREDIT"), V_STRING),    mandatory(LegalForm == 2));
      ELSE
      IF (FoundGR == FALSE)
      InsertString("TR", "27. Объем обязательства, обеспечиваемого поручительством",
                    "A",  1, SQL_NVL(RS.Value("T_VOLUME_OF_DEBT"), V_STRING),              "О");

      InsertString("TR", "28. Сумма поручительства",
                    "S",  10, SQL_NVL(RS.Value("T_GUARANTEE_SUM"), V_NUMERIC),             "О");

      InsertString("TR", "29. Срок поручительства",
                    "D",  8,  SQL_NVL(RS.Value("T_GUARANTEE_TERM"), V_DATE),               "О");
      ELSE
      InsertString("TR", "27. Объем обязательства, обеспечиваемого поручительством",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "28. Сумма поручительства",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "29. Срок поручительства",
                    "S",  2, "",                                                           "Н");
      END;
      InsertString("TR", "30. Флаг о наличии банковской гарантии",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "31. Объем обязательства, обеспечиваемого банковской гарантией",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "32. Сумма банковской гарантии",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "33. Срок банковской гарантии",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "34. Оценочная стоимость залога",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "35. Дата оценки стоимости залога",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "36. Срок действия договора залога",
                    "S",  2, "",                                                           "Н");

      InsertString("TR", "37. Полная стоимость кредита",
                    "S",  2, "",                                                           "Н");
      END;

      InsertString("TR", "38. Наименование приобретателя права требования", 
                    "P",2520, SQL_NVL(RS.Value("T_RIGHT_OF_CLAIM_NAMES"), V_STRING),       
                            mandatory(SQL_Nvl(RS.Value("T_ACCOUNT_RATING"), V_STRING) == "14"));

      InsertString("TR", "39. Идентификационные данные приобретателя права требования", 
                    "P", 738, SQL_NVL(RS.Value("T_RIGHT_OF_CLAIM_REGISTRATION"), V_STRING), 
                            mandatory(SQL_Nvl(RS.Value("T_ACCOUNT_RATING"), V_STRING) == "14"));

      // Перевел тип поля на "P" потому что в базе это строка. Преобразование к INT в ХП
      InsertString("TR", "40. ИНН приобретателя права требования", 
                     "P", 12,  SQL_NVL(RS.Value("T_RIGHT_OF_CLAIM_TAXPAYER"), V_STRING),
                            mandatory(SQL_Nvl(RS.Value("T_ACCOUNT_RATING"), V_STRING) == "14"));

      // Перевел тип поля на "P" потому что в базе это строка. Преобразование к INT в ХП
      IF (SQL_NVL(RS.Value("T_RIGHT_OF_CLAIM_SOCIAL"), V_STRING) == "-=none=-")
         InsertString("TR", "41. СНИЛС приобретателя права требования", 
                       "P", 15,  "", "О");

      ELSE
         InsertString("TR", "41. СНИЛС приобретателя права требования", 
                       "P", 15,  SQL_NVL(RS.Value("T_RIGHT_OF_CLAIM_SOCIAL"), V_STRING),
                         mandatory((SQL_Nvl(RS.Value("T_ACCOUNT_RATING"), V_STRING) == "14")
                                   AND
                                   (TRIM(SQL_NVL(RS.Value("T_RIGHT_OF_CLAIM_SOCIAL"), V_STRING)) != "")
                                  )
                                  );
      END;

      IF (Necessary)
         InsertString("TR", "42. Дата фактического исполнения обязательств в полном объеме",
                       "D", 8, SQL_NVL(RS.Value("T_FULFILLMENT_DATE"), V_DATE), "У", TRUE);
      ELSE
         InsertString("TR", "42. Дата фактического исполнения обязательств в полном объеме",
                       "S", 8, "", "У", TRUE);
      END;

      COUNT = COUNT + 1;
   END;

   IF (NOT GENERAL_FAILURE)
       STAT            = FIRSTREC;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;

MACRO СЕГМЕНТ_СДЕЛКА_ДГ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       STAT                : BOOL   = FALSE,
       FIRSTREC            : BOOL   = FALSE,
       Money               : MONEY  = $0,
       bigMoney            : MONEY  = $9999999999,
       save_GENERAL_FAILURE: BOOL   = GENERAL_FAILURE;

   GENERAL_FAILURE = FALSE;

   IF (_ObjectTypeID != LO_GUARANTEE)
      RETURN TRUE;
   END;

   // НОВЫЕ ПОЛЯ ==>
   VAR RS =
      CRSDCommand("SELECT * FROM DNBKI_TR_CRD_TMP crd WHERE " + 
                        " T_SEGNAME = ? AND T_CREDITNUMBER = ? AND T_CLIENTID = ?  AND T_REPDATE = ?",
                  "p0", "TR",
                  "p2", _ObjectNumber,
                  "p3", credit_c.rec.ClientID_Ref,
                  "p4", ReportDate,
                  V_GENOBJ);

   WHILE (RS.MoveNext())
      FIRSTREC = TRUE;

      СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

      НАИМЕНОВАНИ_СЕГМЕНТА = "TR01";

      InsertString("TR", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                                       "О", FALSE);

      InsertString("TR", "2. Код участника",
                   "AN", 12, lbki.rec.SourceID,                                          "О");

      InsertString("TR", "3. Номер счета",
                    "P", 35, SQL_NVL(RS.Value("T_ACCOUNTNUMBER"), V_STRING),             "О");

      InsertString("TR", "4. Тип счета",
                    "P",  2, "",                                                         "Н");

      InsertString("TR", "5. Отношение к счету",
                    "N",  1, 6,                                                          "О");

      InsertString("TR", "6. Дата открытия",
                    "P",  8, "",                                                         "Н");

      InsertString("TR", "7. Дата последней выплаты", 
                    "P",  8, "",                                                         "Н");
      
      InsertString("TR", "8. Состояние счета",
                    "A",  2, "",                                                         "Н");

      InsertString("TR", "9. Дата состояния счета",
                    "P",  8, "",                                                         "Н");

      InsertString("TR", "10. Дата составления отчета",
                    "D",  8, ReportDate,                                                 "О");

      InsertString("TR", "11. Лимит кредита/Исходная сумма кредита",
                    "P", 10, "",                                                         "Н");
   
      InsertString("TR", "12. Баланс",
                    "P", 10, "",                                                         "Н");

      InsertString("TR", "13. Просрочка",
                    "P", 10, "",                                                         "Н");

      InsertString("TR", "14. Следующий платеж",
                    "P", 10, "",                                                         "Н");
   
      InsertString("TR", "15. Частота выплат",
                    "P",  1, "",                                                         "Н");
   
      InsertString("TR", "16. Своевременность платежей",
                   "AN",  1, "",                                                         "Н");
      
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_CCY"), V_STRING)))
         InsErrorMessage("17. Код валюты. Код RUR запрещен к передаче!");
      ELSE
         InsertString("TR", "17. Код валюты",
                      "A",  3, SQL_NVL(RS.Value("T_CCY"), V_STRING),                     "Н");
      END;
      
      InsertString("TR", "18. Код залога",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "19. Дата окончания срока договора",
                    "P",  1, "",                                                         "Н");
      
      InsertString("TR", "20. Дата финального платежа",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "21. Дата финальной выплаты процентов",
                    "P",  1, "",                                                         "Н");
      
      InsertString("TR", "22. Частота выплат процентов",
                    "P",  1, "",                                                         "Н");
      
      InsertString("TR", "23. Старый код участника",
                    "P",  1, "",                                                         "Н");
      
      InsertString("TR", "24. Старый номер счета",
                    "P",  1, "",                                                         "Н");
      
      InsertString("TR", "25. Текущая задолженность",
                    "P",  1, "",                                                         "Н");
      
      InsertString("TR", "26. Флаг о наличии поручителя",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "27. Объем обязательства, обеспечиваемого поручительством",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "28. Сумма поручительства",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "29. Срок поручительства",
                    "P",   8,  "",                                                       "Н");

      InsertString("TR", "30. Флаг о наличии банковской гарантии",
                    "A",   1,  "",                                                       "Н");

      InsertString("TR", "31. Объем обязательства, обеспечиваемого банковской гарантией",
                    "A",   1,  SQL_NVL(RS.Value("T_VOLUME_OF_SECURED"), V_STRING),       "У");

      InsertString("TR", "32. Сумма банковской гарантии",
                    "S",  10,  SQL_NVL(RS.Value("T_BANK_GUARANTEE_SUM"), V_NUMERIC),     "У");

      InsertString("TR", "33. Срок банковской гарантии",
                    "D",   8,  SQL_NVL(RS.Value("T_BANK_GUARANTEE_TERM"), V_DATE),       "У");

      InsertString("TR", "34. Оценочная стоимость залога",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "35. Дата оценки стоимости залога",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "36. Срок действия договора залога",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "37. Полная стоимость кредита",
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "38. Наименование приобретателя права требования", 
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "39. Идентификационные данные приобретателя права требования", 
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "40. ИНН приобретателя права требования", 
                    "P",  1, "",                                                         "Н");

      InsertString("TR", "41. СНИЛС приобретателя права требования", 
                    "P", 15, "",                                                         "Н");

      InsertString("TR", "42. Дата фактического исполнения обязательств в полном объеме",
                    "S",  8, "",                                                         "У", TRUE);

      COUNT = COUNT + 1;
   END;

   IF (NOT GENERAL_FAILURE)
       STAT            = FIRSTREC;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
// TR
// Блоки: 402, 407, 404
MACRO СЕГМЕНТ_СДЕЛКА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       STAT                : BOOL   = FALSE,
       FIRSTREC            : BOOL   = FALSE,
       Money               : MONEY  = $0,
       bigMoney            : MONEY  = $9999999999,
       save_GENERAL_FAILURE: BOOL   = GENERAL_FAILURE,
       RS = NULL,
       RS_TR = NULL;

   VAR year_reg:          integer;
   VAR year_rog:          integer;
   VAR DateOpened_tmp:       date;
   VAR DateAccountState_tmp: date;
   VAR LastDate_temp:        date;
   VAR ACCOUNT_RATING : STRING = "";

   IF (_ObjectTypeID == LO_ENSCONTR)
      RETURN СЕГМЕНТ_СДЕЛКА_ДО(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID)
   END;

   IF (_ObjectTypeID == LO_GUARANTEE)
      RETURN СЕГМЕНТ_СДЕЛКА_ДГ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID)
   END;

   RS = CRSDCommand("SELECT * FROM DLBKI_407_TMP lbki407, " +
                                 " DLBKI_404_TMP lbki404, " +
                                 " DLBKI_402_TMP lbki402, " +
                                 " DFININSTR_DBT fin WHERE " +
                    " lbki407.T_CREDITNUMBER_REF = ? " +
                " AND lbki407.T_TFID_REF         = ? " +
                " AND lbki402.T_CREDITNUMBER_REF = lbki407.T_CREDITNUMBER_REF " +
                " AND lbki402.T_TFID_REF         = lbki407.T_TFID_REF "         +
                " AND lbki402.T_REPORTDATE       = lbki407.T_BALANCEDATE "      +
                " AND lbki404.T_CREDITNUMBER_REF = lbki407.T_CREDITNUMBER_REF " +
                " AND lbki404.T_TFID_REF         = lbki407.T_TFID_REF "         +
                " AND fin.T_FIID                 = lbki402.T_CURCODE "          +
                    " ORDER BY T_BALANCEDATE",
                    "CREDITNUMBER", _ObjectNumber,
                    "TFID",         TFID,
                     V_GENOBJ);

   GENERAL_FAILURE = FALSE;

   // Дата открытия договора
   DateOpened_tmp = CRSDCommand("SELECT MIN(cop.T_CREDOPERDATE) " +
                                  "FROM VCRE_CRDOP_DBT cop " +
                                 "WHERE cop.T_SYSTEMOPERATIONID = ? " + 
                                   "AND cop.T_CREDITNUMBER_REF  = ? " +
                                   "AND cop.T_CREDOPERDATE     <= ? ",
                                      "p1", CS_NEWCRD,
                                      "p2", _ObjectNumber,
                                      "p4", ReportDate,
                                       V_DATE); 

   WHILE (RS.MoveNext())
      RS_TR = NULL;
      RS_TR =
         CRSDCommand("SELECT * FROM DNBKI_TR_CRD_TMP WHERE " + 
                        " T_SEGNAME = ? AND T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ? AND T_CLIENTID = ? AND T_REPDATE = ?",
                  "p0", "TR",
                  "p1", _ObjectTypeID,
                  "p2", _ObjectNumber,
                  "p3", credit_c.rec.ClientID_Ref,
                  "p4", SQL_NVL(RS.Value("T_REPORTDATE"), V_DATE),
                  V_GENOBJ);
      RS_TR.MoveNext();
   
      FIRSTREC = TRUE;

      СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

      НАИМЕНОВАНИ_СЕГМЕНТА = "TR01";

      InsertString("TR", "1. Наименование сегмента",
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                                               "О", FALSE);

      InsertString("TR", "2. Код участника",
                   "AN", 12, lbki.rec.SourceID,                                                  "О");

      InsertString("TR", "3. Номер счета",
                    "P", 35, credit_c.rec.UsCreditNumber,                                        "О");

      InsertString("TR", "4. Тип счета",
                    "AN",  2, string(SQL_NVL(RS.Value("T_TYPECREDIT"), V_INTEGER):2:0:o),                       "О");  /* DLBKI_402_DBT.T_TYPECREDIT  */

      InsertString("TR", "5. Отношение к счету",
                    "N",  1, SQL_Nvl(RS.Value("T_TYPECLIENT"), V_INTEGER),                       "О");  /* DLBKI_402_DBT.T_TYPECLIENT  */

      IF (Regim_Rejected)
         InsertString("TR", "6. Дата открытия",
                       "D",  8, InsertSpezialValue(DateOpened_tmp),                               "О");
      
         DateSplit(DateOpened_tmp, null, null, year_reg);
         DateSplit(lbki_201.rec.Born, null, null, year_rog);
      
         IF (
             (TypeClient != PTLEGF_INST) AND
             (
             ((year_reg - year_rog) < 14) 
             OR  //154458
             ((year_reg - year_rog) > 110)
             )
            )
            InsErrorMessage("Неверное значение обязательного поля");
         END;
      
      ELSE
         InsertString("TR", "6. Дата открытия",                                                   
                       "D",  8, DateOpened_tmp,                                                  "О");
         DateSplit(DateOpened_tmp, null, null, year_reg);
         DateSplit(lbki_201.rec.Born, null, null, year_rog);
      
         IF (
             (TypeClient != PTLEGF_INST) AND
             (
              ((year_reg - year_rog) < 14) 
              OR  //154458
              ((year_reg - year_rog) > 110)
             )
            )
            InsErrorMessage("Неверное значение обязательного поля");
         END;
      END;

      // Последняя дата погашения
      LastDate_temp = CRSDCommand("SELECT NVL(MAX(cop.T_CREDOPERDATE), ?)" + 
                                  "  FROM DCRD_OP_DBT cop WHERE " +
                                                    " cop.T_CREDITNUMBER_REF  = ? " +
                                                " AND cop.T_SYSTEMOPERATIONID = ? " +
                                                " AND cop.T_STAGEID_REF       = ? " +
                                                " AND cop.T_ISDELETED         = ? " +
                                                " AND cop.T_CREDOPERDATE     <= ? ",
                                          "DOP",          date(0,0,0),
                                          "CREDITNUMBER", _ObjectNumber,
                                          "SYSID",        CS_DUTY,
                                          "STAGEID",      CF_COMPLIT,
                                          "ISDELETED",    0,
                                          "DATEOP",       SQL_Nvl(RS.Value("T_REPORTDATE"), V_DATE),
                                          V_DATE);
      
      IF (LastDate_temp <= date(1,1,1900))
          LastDate_temp  = date(2,1,1900);
      END;
      InsertString("TR", "7. Дата последней выплаты", "D", 8, LastDate_temp,                      "О");
      
      ACCOUNT_RATING = RS.Value("T_CREDITSTATE");
      IF (RS.Value("T_CREDITSTATE") == 0)
         InsertString("TR", "8. Состояние счета",
                      "A",  2, "00",                                                              "О");
      ELSE
         InsertString("TR", "8. Состояние счета",
                      "N",  2, SQL_Nvl(RS.Value("T_CREDITSTATE"), V_INTEGER),                     "О");   /* DLBKI_402_DBT.T_CREDITSTATE */
      END;
      
      
      IF   (SQL_Nvl(RS.Value("T_CREDITSTATE"), V_INTEGER) ==  0)
         InsertString("TR", "9. Дата состояния счета",
                       "D",  8, "",                                                               "Н");
      ELIF ((SQL_NVL(RS.Value("T_CREDITSTATE"), V_INTEGER) == 13) OR
            (SQL_NVL(RS.Value("T_CREDITSTATE"), V_INTEGER) == 21) OR
            (SQL_NVL(RS.Value("T_CREDITSTATE"), V_INTEGER) == 52))
         InsertString("TR", "9. Дата состояния счета",
                       "D",  8, SQL_NVL(RS.Value("T_DATESTATE"), V_DATE),                         "О");   /* DLBKI_402_DBT.T_DATESTATE */

      ELIF (SQL_NVL(RS.Value("T_CREDITSTATE"), V_INTEGER) == 61)
         DateAccountState_tmp = SQL_NVL(RS.Value("T_DATESTATE"), V_DATE);
         IF(DateAccountState_tmp < DateOpened_tmp)
            DateAccountState_tmp = DateOpened_tmp;  
         END;
         InsertString("TR", "9. Дата состояния счета",
                       "D",  8, DateAccountState_tmp,                                             "О");
      
      ELIF ((SQL_NVL(RS.Value("T_CREDITSTATE"), V_INTEGER) == 95)
         OR (SQL_NVL(RS.Value("T_CREDITSTATE"), V_INTEGER) == 96))
         InsertString("TR", "9. Дата состояния счета",
                       "D",  8, SQL_NVL(RS.Value("T_DATESTATE"), V_DATE),                         "Н");

      END;
      
      InsertString("TR", "10. Дата составления отчета",
                    "D",  8, SQL_NVL(RS.Value("T_REPORTDATE"), V_DATE),                           "О");   /*  DLBKI_402_DBT.T_REPORTDATE */

      Money = SQL_NVL(RS.Value("T_DUTYSUM"), V_MONEY);   /*  DLBKI_402_DBT.T_DUTYSUM */
      IF (Money > BigMoney ) Money = BigMoney; END;
      InsertString("TR", "11. Лимит кредита/Исходная сумма кредита",
                    "S", 10, MAX(0, Money),                                                       "О");
   
      
      Money = SQL_NVL(RS.Value("T_DUTY"), V_MONEY); /* DLBKI_402_DBT.T_DUTY */
      IF (Money > BigMoney ) Money = BigMoney; END;
      InsertString("TR", "12. Баланс",
                    "S", 10, Money,                                                               "О");

      Money = CHECK_MONEY(ACCOUNT_RATING,SQL_NVL(RS.Value("T_EXPSUM"), V_MONEY)); /* DLBKI_407_DBT.T_EXPSUM */
      var asd = string(Money:0:2:r);
      IF (Money > BigMoney ) Money = BigMoney; END;
      InsertString("TR", "13. Просрочка",
                    "S", 10, Money,                                                               "О");
   
      //   Для Карты заполнение обязательно
      IF (ObjectTypeID == LO_KARTA)
         IF (SQL_NVL(RS.Value("T_NEXTDUTY"), V_MONEY) == -1)          /* DLBKI_402_DBT.T_NEXTDUTY */
            InsertString("TR", "14. Следующий платеж",
                          "A",  1, "",                                                            "О");
         END;
      END;
   
      Money = CHECK_MONEY(ACCOUNT_RATING,SQL_NVL(RS.Value("T_NEXTDUTY"), V_MONEY));
      IF (Money > BigMoney ) Money = BigMoney; END;
      InsertString("TR", "14. Следующий платеж",
                    "S", 10, Money,                                                               "У");
   
      InsertString("TR", "15. Частота выплат",
                    "N",  1, SQL_NVL(RS.Value("T_PERIODDUTY"), V_INTEGER),                        "Н");  /* DLBKI_402_DBT.T_PERIODDUTY */
   
      InsertString("TR", "16. Своевременность платежей",
                   "AN",  1, SQL_NVL(RS.Value("T_TIMEPAYM"), V_STRING),                           "О");  /* DLBKI_407_DBT.T_TIMEPAYM   */
      
      /* DLBKI_402_DBT.T_CURCODE */
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_CCY"), V_STRING)))
         InsErrorMessage("17. Код валюты. Код RUR запрещен к передаче!");
      ELSE
         InsertString("TR", "17. Код валюты",
                      "A",  3, SQL_NVL(RS.Value("T_CCY"), V_STRING),                              "Н");
      END;
      
      IF (SQL_NVL(RS.Value("T_CODEBAIL"), V_INTEGER) == 0) // DLBKI_402_DBT.T_CODEBAIL
         InsertString("TR", "18. Код залога",
                       "A",  2, "",                                                               "Н");
      ELSE
         InsertString("TR", "18. Код залога",
                       "A", 2, string(SQL_NVL(RS.Value("T_CODEBAIL"), V_INTEGER):2:0:o), "О");
      END;
      
      // DLBKI_404_DBT.T_CLOSEDATE
      InsertString("TR", "19. Дата окончания срока договора",
                    "D",  8, SQL_NVL(RS.Value("T_CLOSEDATE"), V_DATE),                            "Н");
      
      // DLBKI_404_DBT.T_FINALDATE
      InsertString("TR", "20. Дата финального платежа",
                    "D",  8, SQL_NVL(RS.Value("T_FINALDATE"), V_DATE),                            "О");
      
      // DLBKI_404_DBT.T_FINALPERCDATE
      InsertString("TR", "21. Дата финальной выплаты процентов",
                    "D",  8, SQL_NVL(RS.Value("T_FINALPERCDATE"), V_DATE),                        "О");
      
      // DLBKI_402_DBT.T_PERIODPERC
      InsertString("TR", "22. Частота выплат процентов",
                    "N",  1, SQL_NVL(RS.Value("T_PERIODPERC"), V_INTEGER),                        "Н");
      
      InsertString("TR", "23. Старый код участника",
                   "AN", 12, "",                                                                  "Н");
      
      InsertString("TR", "24. Старый номер счета",
                    "P", 35, "",                                                                  "Н");
      
      InsertString("TR", "25. Текущая задолженность",
                    "S", 10, CHECK_MONEY(ACCOUNT_RATING,SQL_NVL(RS.Value("T_CURRENTDUTYREST"),V_MONEY)),                      "О");  // DLBKI_402_DBT.T_CURRENTDUTYREST

      InsertString("TR", "26. Флаг о наличии поручителя",
                    "A",   1,  SQL_NVL(RS_TR.Value("T_GUARANTOR_INDICATOR"), V_STRING),          "У");

      InsertString("TR", "27. Объем обязательства, обеспечиваемого поручительством",
                    "A",   1,  SQL_NVL(RS_TR.Value("T_VOLUME_OF_DEBT"), V_STRING),
                           mandatory(SQL_NVL(RS_TR.Value("T_GUARANTOR_INDICATOR"), V_STRING) == "G"));

      InsertString("TR", "28. Сумма поручительства",
                    "S",  10,  SQL_NVL(RS_TR.Value("T_GUARANTEE_SUM"), V_NUMERIC),
                           mandatory(SQL_NVL(RS_TR.Value("T_GUARANTOR_INDICATOR"), V_STRING) == "G"));

      InsertString("TR", "29. Срок поручительства",
                    "D",   8,  SQL_NVL(RS_TR.Value("T_GUARANTEE_TERM"), V_DATE),
                           mandatory(SQL_NVL(RS_TR.Value("T_GUARANTOR_INDICATOR"), V_STRING) == "G"));

      InsertString("TR", "30. Флаг о наличии банковской гарантии",
                    "A",   1,  SQL_NVL(RS_TR.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING),     "У");

      InsertString("TR", "31. Объем обязательства, обеспечиваемого банковской гарантией",
                    "A",   1,  SQL_NVL(RS_TR.Value("T_VOLUME_OF_SECURED"), V_STRING),
                      mandatory(SQL_NVL(RS_TR.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING) == "B"));

      InsertString("TR", "32. Сумма банковской гарантии",
                    "S",  10,  SQL_NVL(RS_TR.Value("T_BANK_GUARANTEE_SUM"), V_NUMERIC),
                      mandatory(SQL_NVL(RS_TR.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING) == "B"));

      InsertString("TR", "33. Срок банковской гарантии",
                    "D",   8,  SQL_NVL(RS_TR.Value("T_BANK_GUARANTEE_TERM"), V_DATE),
                      mandatory(SQL_NVL(RS_TR.Value("T_BANK_GUARANTEE_INDICATOR"), V_STRING) == "B"));

      InsertString("TR", "34. Оценочная стоимость залога",
                    "S",  10,  SQL_NVL(RS_TR.Value("T_COLLATERAL_VALUE"), V_NUMERIC), "Н");

      InsertString("TR", "35. Дата оценки стоимости залога",
                    "D",   8,  SQL_NVL(RS_TR.Value("T_COLLATERAL_DATE"), V_DATE), "Н");

      InsertString("TR", "36. Срок действия договора залога",
                    "D",   8,  SQL_NVL(RS_TR.Value("T_COLLATERAL_EXPIRATION"), V_DATE), "Н");

      InsertString("TR", "37. Полная стоимость кредита",
                    "A",  10,  SQL_NVL(RS_TR.Value("T_OVERALL_VALUE_OF_CREDIT"), V_STRING),      "У");

      InsertString("TR", "38. Наименование приобретателя права требования", 
                    "P",2520,  SQL_NVL(RS_TR.Value("T_RIGHT_OF_CLAIM_NAMES"), V_STRING),
                                       mandatory(SQL_Nvl(RS.Value("T_CREDITSTATE"), V_INTEGER) == 14));

      InsertString("TR", "39. Идентификационные данные приобретателя права требования", 
                    "P", 738,  SQL_NVL(RS_TR.Value("T_RIGHT_OF_CLAIM_REGISTRATION"), V_STRING),
                                       mandatory(SQL_Nvl(RS.Value("T_CREDITSTATE"), V_INTEGER) == 14));

      // Перевел тип поля на "P" потому что в базе это строка. Преобразование к INT в ХП
      InsertString("TR", "40. ИНН приобретателя права требования", 
                    "P", 12,  SQL_NVL(RS_TR.Value("T_RIGHT_OF_CLAIM_TAXPAYER"), V_STRING),
                                       mandatory(SQL_Nvl(RS.Value("T_CREDITSTATE"), V_INTEGER) == 14));

      // Перевел тип поля на "P" потому что в базе это строка. Преобразование к INT в ХП
      IF (SQL_NVL(RS_TR.Value("T_RIGHT_OF_CLAIM_SOCIAL"), V_STRING) == "-=none=-")
         InsertString("TR", "41. СНИЛС приобретателя права требования", 
                       "P", 15,  "", "О");

      ELSE
         InsertString("TR", "41. СНИЛС приобретателя права требования", 
                       "P", 15,  SQL_NVL(RS_TR.Value("T_RIGHT_OF_CLAIM_SOCIAL"), V_STRING),
                         mandatory((SQL_Nvl(RS.Value("T_CREDITSTATE"), V_INTEGER) == "14")
                                   AND
                                   (TRIM(SQL_NVL(RS_TR.Value("T_RIGHT_OF_CLAIM_SOCIAL"), V_STRING)) != "")
                                  )
                                  );
      END;

      InsertString("TR", "42. Дата фактического исполнения обязательств в полном объеме",
                    "D", 8, SQL_NVL(RS.Value("T_FULFILLMENT_DATE"), V_DATE), "У", TRUE);

      COUNT = COUNT + 1;
   END;

   IF (NOT GENERAL_FAILURE)
       STAT            = FIRSTREC;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
// LE
// Блок LE
MACRO СЕГМЕНТ_ЮРИДИЧЕСКИЙ_СТАТУС(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   IF ((_ObjectTypeID == LO_ENSCONTR) OR (_ObjectTypeID == LO_CLAIM))
      RETURN;
   END;

   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       DateSatisfied       : DATE,
       STAT                : BOOL = FALSE,
       save_GENERAL_FAILURE: BOOL = GENERAL_FAILURE,
       RS =
   CRSDCommand("SELECT * FROM DLBKI_406_TMP lbki_406 WHERE " +
                     " lbki_406.T_CREDITNUMBER_REF= ? "  +
                 " AND lbki_406.T_TFID_REF = ? ",
               "CREDITNUMBER", _ObjectNumber,
               "TFID",         TFID,
              V_GENOBJ);

   IF (NOT RS.MoveNext())
      RETURN FALSE;
   END;

   СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

   СЕГМЕНТ_LE = СЕГМЕНТ_LE + 1;
   IF (СЕГМЕНТ_LE < 10)
      НАИМЕНОВАНИ_СЕГМЕНТА = "LE0" + СЕГМЕНТ_LE;
   ELSE
      НАИМЕНОВАНИ_СЕГМЕНТА = "LE"  + СЕГМЕНТ_LE;
   END;

   InsertString("LE", "1. Наименование сегмента",
                "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                          "О", FALSE);

   InsertString("LE", "2. Номер иска",
                 "P",  35, SQL_NVL(RS.Value("T_SUITNUMBER2"), V_STRING), "О");

   InsertString("LE", "3. Наименование суда",
                 "P", 170, SQL_NVL(RS.Value("T_COURTNAME2"), V_STRING),  "О");

   InsertString("LE", "4. Дата отчета",
                 "D",   8, ReportDate,                                   "У");

   InsertString("LE", "5. Дата исполнения",
                 "D",   8, "",                                           "Н");

   DateSatisfied = SQL_NVL(RS.Value("T_DATESATISFIED"), V_DATE);
   var strDateSatisfied = TRIM(String(DateSatisfied:f));
   IF ((strDateSatisfied == "") OR
       (strDateSatisfied == "31.12.9999") OR
       (strDateSatisfied == "01.01.0001"))
      InsertString("LE",  "6. Дата возмещения",
                    "D",   8, "",                                        "Н");
   ELSE
      InsertString("LE", "6. Дата возмещения",
                    "D",   8, DateSatisfied,                             "О");
   END;

   InsertString("LE", "7. Истец",
                 "P",  32, "",                                           "Н");

   InsertString("LE", "8. Решение",
                 "P", 500, SQL_NVL(RS.Value("T_INF2"), V_STRING),        "О", TRUE);

   COUNT = COUNT + 1;

   IF (NOT GENERAL_FAILURE)
       STAT            = TRUE;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
// BK
// 304
MACRO СЕГМЕНТ_БАНКРОТСТВО(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: string = "",

       НАИМЕНОВАНИЕ_СУДА   : STRING = "", НОМЕР_ДЕЛА     : STRING = "",
       ДАТА_ИСПОЛНЕНИЯ     : STRING = "", ИСТЕЦ          : STRING = "",
       ТИП_БАНКРОТСТВА     : STRING = "", ВИД_БАНКРОТСТВА: STRING = "",
       РЕШЕНИЕ             : STRING = "", TEXT           : STRING = "",
       STAT                : BOOL   = FALSE,
       save_GENERAL_FAILURE: BOOL   = GENERAL_FAILURE;

   // Только для юрика
   IF (TypeClient != PTLEGF_INST)
      RETURN FALSE;
   END;

   IF (NOT GetBlock(304, TFID, OtherDebtorNum, _ObjectTypeID, _ObjectNumber))
      RETURN FALSE;
   END;

   text = GetProperty(44, 3, {curdate});
   IF (Trim(text) != "")
      // Наименование суда
      НАИМЕНОВАНИЕ_СУДА = SubStr(text, 1, Index(text, ";") - 1); // Копируем с первого символа, до символа перед ";"
      text              = SubStr(text,    Index(text, ";") + 1); // Копируем со следующего символа
                                                                 // после ";" до символа перед следующим ";"
      // Номер дела
      НОМЕР_ДЕЛА        = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      // Дата
      ДАТА_ИСПОЛНЕНИЯ   = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      // Истец
      ИСТЕЦ             = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      // Тип банкротства
      ТИП_БАНКРОТСТВА   = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      ВИД_БАНКРОТСТВА   = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      РЕШЕНИЕ           = SubStr(text, 1, Index(text, ";") - 1);
   ELSE
      RETURN FALSE;
   END;

   GENERAL_FAILURE = FALSE;

   СЕГМЕНТ_BK = СЕГМЕНТ_BK + 1;
   IF (СЕГМЕНТ_BK < 10)
      НАИМЕНОВАНИ_СЕГМЕНТА = "BK0" + СЕГМЕНТ_BK;
   ELSE
      НАИМЕНОВАНИ_СЕГМЕНТА = "BK"  + СЕГМЕНТ_BK;
   END;

   СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

   InsertString("BK", "1. Наименование сегмента",
                "AN",   4, НАИМЕНОВАНИ_СЕГМЕНТА,    "О", FALSE);

   InsertString("BK", "2. Наименование суда",
                 "P",  170, НАИМЕНОВАНИЕ_СУДА,      "Н");

   InsertString("BK", "3. Номер дела",
                 "P",   35, НОМЕР_ДЕЛА,             "Н");

   InsertString("BK", "4. Дата исполнения",
                 "D",    8, date(ДАТА_ИСПОЛНЕНИЯ),  "Н");

   InsertString("BK", "5. Дата отчета",
                 "D",    8, ReportDate,             "У");

   InsertString("BK", "6. Истец",
                 "P",   32, ИСТЕЦ,                  "Н");

   InsertString("BK", "7. Тип банкротства",
                 "N",    1, int(ТИП_БАНКРОТСТВА),   "О");

   InsertString("BK", "8. Решение",
                 "P",  500, РЕШЕНИЕ,                "Н", TRUE);

   COUNT = COUNT + 1;

   IF (NOT GENERAL_FAILURE)
       STAT            = FALSE;
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;


////////////////////////////////////////////////////////////////////////////////
// Сегмент IP
// Блоки: 
MACRO СЕГМЕНТ_ИНФОРМАЦИОННАЯ_ЧАСТЬ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer, ClientID: integer)
   VAR НАИМЕНОВАНИ_СЕГМЕНТА: STRING = "",
       STAT                : BOOL   = FALSE,
       save_GENERAL_FAILURE: BOOL   = GENERAL_FAILURE,
       RS = NULL;

   // Сегмент IP формируется начиная с 01.03.2015
   IF (ReportDate < date(01,03,2015))
      RETURN TRUE;
   END;

   // Только для физика
   IF (TypeClient == PTLEGF_INST)
      RETURN FALSE;
   END;

   // Для ДО все проще
   IF (_ObjectTypeID == LO_ENSCONTR)
      RS = CRSDCommand("SELECT * FROM DNBKI_IP_ENSCONTR_TMP WHERE T_ENSCONTRACTID = ? AND T_TFID = ?",
                    "p1", _ObjectNumber,
                    "p2", TFID,
                     V_GENOBJ);

      GENERAL_FAILURE = FALSE;

      WHILE (RS.MoveNext())
         СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

         НАИМЕНОВАНИ_СЕГМЕНТА = "IP01";
      
         InsertString("IP", "1. Наименование сегмента",                      
                      "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                                 "О", FALSE);
      
         InsertString("IP", "2. Имя пользователя",
                      "AN", 12, SQL_NVL(RS.Value("T_MEMBER_CODE"),              V_STRING),  "О");

         InsertString("IP", "3. Номер заявки",                                             
                       "P", 35, SQL_NVL(RS.Value("T_APPLICATION_NUMBER"),        V_STRING),  "Н");
                                                                                        
         InsertString("IP", "4. Дата заявки",                                              
                       "D",  8, SQL_NVL(RS.Value("T_DATE_OF_APPLICATION"),         V_DATE),  "О");
                      
         InsertString("IP", "5. Тип займодавца",                                 
                       "N",  1, SQL_NVL(RS.Value("T_CREDITOR_TYPE"),            V_INTEGER),  "О");
                                                                              
         InsertString("IP", "6. Вид обязательства",                              
                       "N",  1, SQL_NVL(RS.Value("T_TYPE_FLAG"),                V_INTEGER),  "О");

         InsertString("IP", "7. Тип запрошенного кредита",                                 
                       "N",  5, SQL_NVL(RS.Value("T_REQUESTED_LOAN_TYPE"),      V_INTEGER),  "О");
      
         InsertString("IP", "8. Способ предоставления заявки",
                       "N",  2, "",                                                          "Н");

         InsertString("IP", "9. Решение об одобрении",
                       "P",  1,  "",                                                         "Н");
      
         InsertString("IP", "10. Срок окончания действия одобрения",
                       "P",  1,  "",                                                         "Н");
      
         InsertString("IP", "11. Сумма займа по отклоненной заявке",
                       "P",  1,  "",                                                         "Н");
      
         InsertString("IP", "12. Валюта отклоненной заявки",
                       "P",  1,  "",                                                         "Н");
      
         InsertString("IP", "13. Дата отказа в предоставлении займа",
                       "P",  1,  "",                                                         "Н");
      
         InsertString("IP", "14. Основание отказа в выдаче займа",
                       "P",  1,  "",                                                         "Н");

         InsertString("IP", "15. Номер кредитного договора",
                       "P",  35,  "",                                                        "Н");

         InsertString("IP", "16. Информация об одобренном кредите",
                       "P",  1,  "",                                                         "Н");
                       
         InsertString("IP", "17. Признак дефолта",
                       "A",   1, SQL_NVL(RS.Value("T_DEFAULT_FLAG"),            V_STRING),   "У");
      
         InsertString("IP", "18. Кредит погашен",
                       "A",   1, SQL_NVL(RS.Value("T_LOAN_FULLY_RETURNED"),     V_STRING),   "У");

         InsertString("IP", "19. Старый номер заявки",
                       "P",  1,  "",                                                         "Н", TRUE);

         STAT = TRUE;

         COUNT = COUNT + 1;
      END;
      RETURN STAT;
   END;

   // Дальше только заявки
   IF (_ObjectTypeID != LO_CLAIM)
      RETURN FALSE;
   END;

   RS = CRSDCommand("SELECT l.*, f.T_CCY FROM DNBKI_IP_CLAIM_TMP l LEFT OUTER JOIN DFININSTR_DBT f ON (l.T_REJECTED_AMOUNT_CURRENCY = f.T_FIID) " +
                    " WHERE l.T_CLAIMID = ? AND l.T_TFID = ? ",
                    "p1", _ObjectNumber,
                    "p2", TFID,
                     V_GENOBJ);

   GENERAL_FAILURE = FALSE;

   WHILE (RS.MoveNext())

      СЕГМЕНТЫ_ОБЩИЕ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

      НАИМЕНОВАНИ_СЕГМЕНТА = "IP01";

      InsertString("IP", "1. Наименование сегмента",                      
                   "AN",  4, НАИМЕНОВАНИ_СЕГМЕНТА,                                        "О", FALSE);

      InsertString("IP", "2. Имя пользователя",
                   "AN", 12, SQL_NVL(RS.Value("T_MEMBER_CODE"),              V_STRING),  "О");
                                                                                        
      InsertString("IP", "3. Номер заявки",                                             
                    "P", 35, SQL_NVL(RS.Value("T_APPLICATION_NUMBER"),        V_STRING),  "Н");
                                                                                        
      InsertString("IP", "4. Дата заявки",                                              
                    "D",  8, SQL_NVL(RS.Value("T_DATE_OF_APPLICATION"),         V_DATE),  "О");
                                                                                        
      InsertString("IP", "5. Тип займодавца",                                           
                    "N",  1, SQL_NVL(RS.Value("T_CREDITOR_TYPE"),            V_INTEGER),  "О");
                                                                                        
      InsertString("IP", "6. Вид обязательства",                                        
                    "N",  1, SQL_NVL(RS.Value("T_TYPE_FLAG"),                V_INTEGER),  "О");
                                                                                        
      InsertString("IP", "7. Тип запрошенного кредита",                                 
                    "N",  5, SQL_NVL(RS.Value("T_REQUESTED_LOAN_TYPE"),      V_INTEGER),  "О");

      InsertString("IP", "8. Способ предоставления заявки",
                    "N",  2, allowed("IP", "8", 
                             SQL_NVL(RS.Value("T_APPLICATION_SHIPMENT_WAY"), V_INTEGER)), "О");

      InsertString("IP", "9. Решение об одобрении",
                    "A",  1, SQL_NVL(RS.Value("T_FLAG_OF_APPROVAL"),          V_STRING),  "У");

      InsertString("IP", "10. Срок окончания действия одобрения",
                    "D",  8, SQL_NVL(RS.Value("T_APPROVAL_EXPIRATION"),         V_DATE),  "У");

      IF (ValType(RS.Value("T_REJECTED_AMOUNT")) != V_SPECVAL)
         InsertString("IP", "11. Сумма займа по отклоненной заявке",
                       "S",  10, SQL_NVL(RS.Value("T_REJECTED_AMOUNT"),      V_NUMERIC),  "У");

      ELSE
         InsertString("IP", "11. Сумма займа по отклоненной заявке",
                       "P",  1, "",                                                       "У");

      END;

      IF (ValType(RS.Value("T_REJECTED_AMOUNT_CURRENCY")) != V_SPECVAL)
         InsertString("IP", "12. Валюта отклоненной заявки",
                       "A",  3, SQL_NVL(RS.Value("T_CCY"), V_STRING),                     "У");

      ELSE
         InsertString("IP", "12. Валюта отклоненной заявки",
                       "P",  1, "",                                                       "У");

      END;

      IF (ValType(RS.Value("T_REJECTION_DATE")) != V_SPECVAL)
         InsertString("IP", "13. Дата отказа в предоставлении займа",
                       "D",  8,  SQL_NVL(RS.Value("T_REJECTION_DATE"),          V_DATE),  "У");

      ELSE
         InsertString("IP", "13. Дата отказа в предоставлении займа",
                       "P",  1,  "",                                                      "У");

      END;

      IF (ValType(RS.Value("T_REJECTION_REASON")) != V_SPECVAL)
         InsertString("IP", "14. Основание отказа в выдаче займа",
                       "N",  2,  SQL_NVL(RS.Value("T_REJECTION_REASON"),     V_INTEGER),  "У");
      
      ELSE
         InsertString("IP", "14. Основание отказа в выдаче займа",
                       "P",  1,  "",                                                      "У");

      END;

      InsertString("IP", "15. Номер кредитного договора",
                    "P",  35,  SQL_NVL(RS.Value("T_AGREEMENT_NUMBER"),        V_STRING),  "У");

      IF (SQL_NVL(RS.Value("T_APPROVED_LOAN_TYPE"), V_INTEGER) != SQL_NVL(RS.Value("T_REQUESTED_LOAN_TYPE"),      V_INTEGER))
         InsertString("IP", "16. Информация об одобренном кредите",
                       "N",  5,  SQL_NVL(RS.Value("T_APPROVED_LOAN_TYPE"),   V_INTEGER),  "Н");
      ELSE
         InsertString("IP", "16. Информация об одобренном кредите",
                       "P",  1,  "",                                                      "Н");
      END;

      InsertString("IP", "17. Признак дефолта",
                    "A",   1,  SQL_NVL(RS.Value("T_DEFAULT_FLAG"),           V_STRING),   "У");

      InsertString("IP", "18. Кредит погашен",
                    "A",   1,  SQL_NVL(RS.Value("T_LOAN_FULLY_RETURNED"), V_STRING),      "У");

      InsertString("IP", "19. Старый номер заявки",
                    "P",  1,  "",                                                         "Н", TRUE);
      STAT = TRUE;
      COUNT = COUNT + 1;
   END;

   IF (NOT GENERAL_FAILURE)
       GENERAL_FAILURE = save_GENERAL_FAILURE;
   END;

   RETURN STAT;
END;



////////////////////////////////////////////////////////////////////////////////
// TRLR
//
MACRO СЕГМЕНТ_ТРЕЙЛЕР()
   // Сегмент заголовка + трейлер
   COUNT = 2 + COUNT;

   nbki_tmp.Clear();

   InsertString("TRLR", "1. Сегмент трейлер",
                   "A", 4, "TRLR", "О", FALSE);

   InsertString("TRLR", "2. Счетчик",
                   "N", 9,  COUNT, "Н", TRUE);

   InsertToFile("\n");

   RETURN TRUE;
END;


MACRO СформироватьБлокиОбеспечения(BkiID, TFID, ReportDate)
   VAR
   cmd1 = RsdCommand (RslDefCon, "BEGIN RSO_LOANS_NBKI.Create_Block_GR(?, ?, ?); END;");

   cmd1.addParam ("BkiID",   RSDBP_IN); cmd1.value ("BkiID")   = BkiID;
   cmd1.addParam ("TFID",    RSDBP_IN); cmd1.value ("TFID")    = TFID;
   cmd1.addParam ("RepDate", RSDBP_IN); cmd1.value ("RepDate") = ReportDate;

   cmd1.execute();

   VAR
   cmd2 = RsdCommand (RslDefCon, "BEGIN RSO_LOANS_NBKI.Create_Block_BG(?, ?, ?); END;");

   cmd2.addParam ("BkiID",   RSDBP_IN); cmd2.value ("BkiID")   = BkiID;
   cmd2.addParam ("TFID",    RSDBP_IN); cmd2.value ("TFID")    = TFID;
   cmd2.addParam ("RepDate", RSDBP_IN); cmd2.value ("RepDate") = ReportDate;

   cmd2.execute();

   VAR
   cmd3 = RsdCommand (RslDefCon, "BEGIN RSO_LOANS_NBKI.Create_Block_CL(?, ?, ?); END;");

   cmd3.addParam ("BkiID",   RSDBP_IN); cmd3.value ("BkiID")   = BkiID;
   cmd3.addParam ("TFID",    RSDBP_IN); cmd3.value ("TFID")    = TFID;
   cmd3.addParam ("RepDate", RSDBP_IN); cmd3.value ("RepDate") = ReportDate;

   cmd3.execute();
END;

// Массовая обработка договоров Гарантии
MACRO СформироватьБлокиГарантии(BkiID, TFID, ReportDate)
   VAR
   cmd1 = RsdCommand (RslDefCon, "BEGIN RSO_LOANS_NBKI.Create_Block_TRForGUARANTEE(?, ?, ?); END;");

   cmd1.addParam ("BkiID",   RSDBP_IN); cmd1.value ("BkiID")   = BkiID;
   cmd1.addParam ("TFID",    RSDBP_IN); cmd1.value ("TFID")    = TFID;
   cmd1.addParam ("RepDate", RSDBP_IN); cmd1.value ("RepDate") = ReportDate;

   cmd1.execute();
END;

////////////////////////////////////////////////////////////////////////////////
// Разбор вида КИ
// TF_ID    - ID транспортного файла
//          = 0 - Если формируется виртуальная история
//          > 0 - Идет запись в ТФ
MACRO СформироватьБлоки(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer)
   VAR  RSP = NULL, RSE = NULL, RS;

   // Для ДО нет записей в таблице СОЗАЕМЩИКИ
   IF (_ObjectTypeID == LO_ENSCONTR)
      RS =
   CRSDCommand("SELECT  p.*, T_ISEMPLOYER, 1 AS T_OTHERDEBTORNUM FROM DENSCONTR_DBT lo, DPARTY_DBT p LEFT JOIN DPERSN_DBT pr ON p.T_PARTYID = pr.T_PERSONID WHERE " +
                     " LO.T_ENSCONTRACTID = ? " +
                 " AND LO.T_ENSCONTRACTPERSONID_REF = p.T_PARTYID ",
               "OBJECTNUMBER", _ObjectNumber,
               V_GENOBJ);
   ELSE
      RS =
   CRSDCommand("SELECT * FROM DLOTHDEB_DBT lo, DPARTY_DBT p LEFT JOIN DPERSN_DBT pr ON p.T_PARTYID = pr.T_PERSONID WHERE " +
                     " lo.T_OBJECTTYPEID_REF = ? " +
                 " AND lo.T_OBJECTNUMBER_REF = ? " +
                 " AND lo.T_PARTYID_REF      = p.T_PARTYID " +
                 " AND Nvl(lo.T_ISDELETED, ?) <> ? " +
                 " ORDER BY lo.T_OTHERDEBTORNUM ",
               "OBJECTTYPEID", _ObjectTypeID,
               "OBJECTNUMBER", _ObjectNumber,
               "ISDEL",        0,
               "DEL",        "X",
               V_GENOBJ);
   END;

   VAR OtherDebtorNum = 0;

   WHILE (RS.MoveNext())
      ClientID       = SQL_NVL(RS.Value("T_PARTYID"), V_INTEGER);
      OtherDebtorNum = SQL_NVL(RS.Value("T_OTHERDEBTORNUM"), V_INTEGER);

      // Определим тип клиента
      TypeClient = ТипКлиента(SQL_NVL(RS.Value("T_LEGALFORM"),  V_INTEGER),
                              SQL_NVL(RS.Value("T_ISEMPLOYER"), V_STRING));
      // Определим является ли клиент нерезидентом
      Client_NotResident = Нерезедент(ClientID);                        

      // Физ лица
      IF (TypeClient != PTLEGF_INST)
         СформироватьБлок_202(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);
         СформироватьБлок_203(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);
         СформироватьБлок_302(_ObjectTypeID, _ObjectNumber, TFID, RS);
      ELSE
         СформироватьБлок_301(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);
         СформироватьБлок_302(_ObjectTypeID, _ObjectNumber, TFID, RS);
      END;

      IF (TypeClient == PTLEGF_INST)
         СформироватьБлок_304(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);
      END;

      СформироватьБлок_401(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);
      СформироватьБлок_Phone(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum, ClientID);

      IF ((ClientID == credit_c.rec.ClientID_Ref) AND ((_ObjectTypeID != LO_ENSCONTR) AND (_ObjectTypeID != LO_CLAIM) AND (_ObjectTypeID != LO_GUARANTEE)))
         СформироватьБлок_404(_ObjectNumber, TFID);
         СформироватьБлок_LE (_ObjectNumber, TFID);
         СформироватьБлок_407(_ObjectNumber, TFID);
      END;

      IF (_ObjectTypeID == LO_ENSCONTR)
         СформироватьБлок_СделкаДляДО(_ObjectTypeID, _ObjectNumber, TFID, ReportDate);
         СформироватьБлок_ИнформационнаяЧастьПоПоручительсву(_ObjectTypeID, _ObjectNumber, TFID, ReportDate);
      END;

      IF (_ObjectTypeID == LO_CLAIM)
         СформироватьБлок_ИнформационнаяЧастьПоЗаявке(_ObjectTypeID, _ObjectNumber, TFID, ReportDate);
      END;
   END;

   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// ID
// Обязателен для физ/юр лица.
// Номер договора, ID транспортного файла, ID созаемщика
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ИДЕНТИФИКАЦИИ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR cnt: INTEGER = 0, A_TFID: integer = 0;
   // Тип ID
   // Для физ. лица.
   IF ((TypeClient == PTLEGF_PERSN) OR (TypeClient == PTLEGF_PBUL))

      // Последняя успешная выгрузка блока 202
      A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_202_DBT lbki_202 WHERE " +
                        " l.T_OBJECTTYPEID     = ? " +
                    " AND l.T_OBJECTNUMBER     = ? " +
                    " AND l.T_BKIID_REF        = ? " +
                   // " AND t.T_RESULTLOAD       = ? " +
                    " AND lbki_202.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF         = t.T_TFID " + 
                    " AND l.T_OBJECTTYPEID = lbki_202.T_OBJECTTYPEID " + 
                    " AND l.T_OBJECTNUMBER = lbki_202.T_OBJECTNUMBER ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                 // "RESULTLOAD",   0,
                  V_INTEGER);

      // Есть ли данные в блоке ,
      cnt = CRSDCommand("SELECT COUNT(*) FROM DLBKI_202_TMP l WHERE " +
                                 " l.T_OBJECTTYPEID     = ? " +
                             " AND l.T_OBJECTNUMBER     = ? " +
                             " AND l.T_TFID_REF         = ? " +
                             " AND l.T_OTHERDEBTORNUM   = ? ",
                           "ObjectTypeID",   _ObjectTypeID,
                           "ObjectNumber",   _ObjectNumber,
                           "TFID",           TFID,
                           "OTHERDEBTORNUM", OtherDebtorNum,
                           V_INTEGER);
      // Данных нет, КИ не будет передана
      IF (cnt == 0)
          RETURN FALSE;
      END;

      //если успешных выгрузок не было, то выгружаем
      IF  (A_TFID == 0)
        RETURN TRUE;
      END;
      
      cnt =
      CRSDCommand("SELECT COUNT(*) FROM DLBKI_202_TMP l1 WHERE" +
           " l1.T_OBJECTTYPEID     = ? " +
       " AND l1.T_OBJECTNUMBER     = ? " +
       " AND l1.T_TFID_REF         = ? " +
       " AND(l1.T_SERIES, l1.T_NUMBER, l1.T_DATE, l1.T_ORGANIZATION) <> " +
    "(SELECT l2.T_SERIES, l2.T_NUMBER, l2.T_DATE, l2.T_ORGANIZATION FROM DLBKI_202_DBT l2 WHERE " +
           " l2.T_OBJECTTYPEID     = l1.T_OBJECTTYPEID " +
       " AND l2.T_OBJECTNUMBER     = l1.T_OBJECTNUMBER " +
       " AND l2.T_OTHERDEBTORNUM   = l1.T_OTHERDEBTORNUM   " +
       " AND l2.T_CODEKIND         = l1.T_CODEKIND " +
       " AND l2.T_TFID_REF         = ?)",
                  "ObjectTypeID",   _ObjectTypeID,
                  "ObjectNumber",   _ObjectNumber,
                  "OTHERDEBTORNUM", OtherDebtorNum,
                  "TFID1",          TFID,
                  "TFID2",        A_TFID,
                  V_INTEGER);
      IF (cnt > 0)
         RETURN TRUE;
      END;
   END;

   // ПБЮЛ
   IF (TypeClient == PTLEGF_PBUL)
      cnt =
      CRSDCommand("SELECT COUNT(*) FROM DLBKI_203_TMP l1 WHERE" +
           " l1.T_OBJECTTYPEID = ? AND l1.T_OBJECTNUMBER = ? " +
       " AND l1.T_OTHERDEBTORNUM   = ? " +
       " AND l1.T_TFID_REF         = ? " +
       " AND l1.T_NUMBER <> " +
    "(SELECT l2.T_NUMBER FROM DLBKI_203_DBT l2 WHERE " +
           " l2.T_OBJECTTYPEID   = l1.T_OBJECTTYPEID " +
       " AND l2.T_OBJECTNUMBER   = l1.T_OBJECTNUMBER " +
       " AND l2.T_OTHERDEBTORNUM = l1.T_OTHERDEBTORNUM " +
       " AND l2.T_DOCKIND        = l1.T_DOCKIND " +
       " AND l2.T_TFID_REF       = ?)",
                  "ObjectTypeID",   _ObjectTypeID,
                  "ObjectNumber",   _ObjectNumber,
                  "OTHERDEBTORNUM", OtherDebtorNum,
                  "TFID1",          TFID,
                  "TFID2",        A_TFID,
                  V_INTEGER);
      IF (cnt > 0)
         RETURN TRUE;
      END;
   END;

   // ЮР. Лицо
   IF ((TypeClient == PTLEGF_INST) OR (TypeClient == PTLEGF_PBUL))
      cnt =
      CRSDCommand("SELECT COUNT(*) FROM DLBKI_302_TMP l1 WHERE" +
           " l1.T_OBJECTTYPEID     = ? AND T_OBJECTNUMBER = ? " +
       " AND l1.T_OTHERDEBTORNUM   = ? " +
       " AND l1.T_TFID_REF         = ? " +
       " AND(l1.T_OGRN, l1.T_INN) <> " +
    "(SELECT l2.T_OGRN, l2.T_INN FROM DLBKI_302_DBT l2 WHERE " +
           " l2.T_OBJECTTYPEID     = l1.T_OBJECTTYPEID " +
       " AND l2.T_OBJECTNUMBER     = l1.T_OBJECTNUMBER " +
       " AND l2.T_OTHERDEBTORNUM   = l1.T_OTHERDEBTORNUM " +
       " AND l2.T_TFID_REF         = ?)",
                  "ObjectTypeID",   _ObjectTypeID,
                  "ObjectNumber",   _ObjectNumber,
                  "OTHERDEBTORNUM", OtherDebtorNum,
                  "TFID1",          TFID,
                  "TFID2",        A_TFID,
                  V_INTEGER);
      IF (cnt > 0)
         RETURN TRUE;
      END;
   END;
END;

////////////////////////////////////////////////////////////////////////////////
// NA
// Блок 201
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ИМЕНИ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   // Последняя успешная выгрузка блока 201
   VAR A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_201_DBT lbki_201 WHERE " +
                        " l.T_OBJECTTYPEID     = ? " +
                    " AND l.T_OBJECTNUMBER     = ? " +
                    " AND l.T_BKIID_REF        = ? " +
                    " AND lbki_201.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF         = t.T_TFID " + 
                    " AND l.T_OBJECTTYPEID = lbki_201.T_OBJECTTYPEID " + 
                    " AND l.T_OBJECTNUMBER = lbki_201.T_OBJECTNUMBER ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                  V_INTEGER);

   IF (A_TFID > 0)
   VAR cnt: INTEGER =
   CRSDCommand(
   "SELECT COUNT(*) FROM DLBKI_201_TMP l1 WHERE " +
         " l1.T_OBJECTTYPEID     = ? " +
     " AND l1.T_OBJECTNUMBER     = ? " +
     " AND l1.T_OTHERDEBTORNUM   = ? " +
     " AND l1.T_TFID_REF         = ? " +
     " AND(l1.T_NAME1, l1.T_NAME2, l1.T_NAME3,  l1.T_GENDER, l1.T_BORN, l1.T_BIRSPLACE, l1.T_NATIONALITY ) <> " +
  "(SELECT l2.T_NAME1, l2.T_NAME2, l2.T_NAME3,  l2.T_GENDER, l2.T_BORN, l2.T_BIRSPLACE, l2.T_NATIONALITY  "
     " FROM DLBKI_201_DBT l2 WHERE " +
         " l2.T_OBJECTTYPEID     = l1.T_OBJECTTYPEID " +
     " AND l2.T_OBJECTNUMBER     = l1.T_OBJECTNUMBER " +
     " AND l2.T_OTHERDEBTORNUM   = l1.T_OTHERDEBTORNUM   " +
     " AND l2.T_TFID_REF         = ?)",
              "ObjectTypeID",   _ObjectTypeID,
              "ObjectNumber",   _ObjectNumber,
              "OTHERDEBTORNUM", OtherDebtorNum,
              "TFID1",          TFID,
              "TFID2",        A_TFID,
              V_INTEGER);
   
      IF (cnt > 0)
         RETURN TRUE;
      END;
   ELSE
      RETURN TRUE;
   END;

   RETURN FALSE;
END;

////////////////////////////////////////////////////////////////////////////////
// Сегмент BU
// Блоки: 301, 302
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ПРЕДПРИЯТИЯ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR cnt: INTEGER = 0;

   // Последняя успешная выгрузка блока 301
   VAR A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_301_DBT lbki WHERE " +
                        " l.T_OBJECTTYPEID = ? " +
                    " AND l.T_OBJECTNUMBER = ? " +
                    " AND l.T_BKIID_REF    = ? " +
                    " AND lbki.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF     = t.T_TFID " + 
                    " AND l.T_OBJECTTYPEID = lbki.T_OBJECTTYPEID " + 
                    " AND l.T_OBJECTNUMBER = lbki.T_OBJECTNUMBER ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                  V_INTEGER);

   IF (A_TFID > 0)
      cnt = CRSDCommand(
   " SELECT COUNT(*) FROM DLBKI_301_TMP l1 WHERE " +
          " l1.T_OBJECTTYPEID     = ? AND l1.T_OBJECTNUMBER = ? " +
      " AND l1.T_OTHERDEBTORNUM   = ? " +
      " AND l1.T_TFID_REF         = ? " +
      " AND (l1.T_FULLNAME, l1.T_SHORTNAME) <> " +
   "(SELECT  l2.T_FULLNAME, l2.T_SHORTNAME FROM DLBKI_301_DBT l2 WHERE " +
           " l2.T_OBJECTTYPEID     = l1.T_OBJECTTYPEID " +
       " AND l2.T_OBJECTNUMBER     = l1.T_OBJECTNUMBER " +
       " AND l2.T_OTHERDEBTORNUM   = l1.T_OTHERDEBTORNUM " +
       " AND l2.T_TFID_REF         = ?)",
           "ObjectTypeID",   _ObjectTypeID,
           "ObjectNumber",   _ObjectNumber,
           "OTHERDEBTORNUM", OtherDebtorNum,
           "TFID1",          TFID,
           "TFID2",        A_TFID,
           V_INTEGER);

      IF (cnt > 0)
         RETURN TRUE;
      END;
   END;

   IF (A_TFID > 0)
      cnt =
      CRSDCommand("SELECT COUNT(*) FROM DLBKI_302_TMP l1 WHERE " +
         " l1.T_OBJECTTYPEID     = ? AND l1.T_OBJECTNUMBER = ? " +
     " AND l1.T_OTHERDEBTORNUM   = ? " +
     " AND l1.T_TFID_REF         = ? " +
     " AND (l1.T_REGDATE, l1.T_OKPO, l1.T_OKONH, l1.T_OKVED, l1.T_OKATO, l1.T_OKFS, l1.T_OKOPF, l1.T_KPP) <> " +
   "(SELECT l2.T_REGDATE, l2.T_OKPO, l2.T_OKONH, l2.T_OKVED, l2.T_OKATO, l2.T_OKFS, l2.T_OKOPF, l2.T_KPP " +
    " FROM DLBKI_302_DBT l2 WHERE " +
         " l2.T_OBJECTTYPEID     = l1.T_OBJECTTYPEID " +
     " AND l2.T_OBJECTNUMBER     = l1.T_OBJECTNUMBER " +
     " AND l2.T_OTHERDEBTORNUM   = l1.T_OTHERDEBTORNUM   " +
     " AND l2.T_TFID_REF         = ?)",
              "ObjectTypeID",   _ObjectTypeID,
              "ObjectNumber",   _ObjectNumber,
              "OTHERDEBTORNUM", OtherDebtorNum,
              "TFID1",          TFID,
              "TFID2",          A_TFID,
              V_INTEGER);
   
      IF (cnt > 0)
         RETURN TRUE;
      END;
   ELSE
      RETURN TRUE;
   END;

   RETURN FALSE;
END;

////////////////////////////////////////////////////////////////////////////////
// AD
// Блок 401
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_АДРЕСА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   // Последняя успешная выгрузка блока 301
   VAR A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_401_DBT lbki WHERE " +
                        " l.T_OBJECTTYPEID = ? " +
                    " AND l.T_OBJECTNUMBER = ? " +
                    " AND l.T_BKIID_REF    = ? " +
                    " AND lbki.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF     = t.T_TFID " + 
                    " AND l.T_OBJECTTYPEID = lbki.T_OBJECTTYPEID " + 
                    " AND l.T_OBJECTNUMBER = lbki.T_OBJECTNUMBER ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                  V_INTEGER);

   IF (A_TFID > 0)
      VAR cnt : integer =
      CRSDCommand("SELECT COUNT(*) FROM DLBKI_401_TMP l1 WHERE " +
                     " l1.T_OBJECTTYPEID = ? AND l1.T_OBJECTNUMBER = ? " +
                 " AND l1.T_OTHERDEBTORNUM   = ? " +
                 " AND l1.T_TYPEADRESS IN (?, ?) " +
                 " AND l1.T_TFID_REF         = ? " +
                 " AND l1.T_ADRESS <> " +
               "(" +
                "SELECT l2.T_ADRESS FROM DLBKI_401_DBT l2 WHERE " +
                      " l2.T_TYPEADRESS       = l1.T_TYPEADRESS     " +
                  " AND l2.T_OBJECTTYPEID     = l1.T_OBJECTTYPEID   " +
                  " AND l2.T_OBJECTNUMBER     = l1.T_OBJECTNUMBER   " +
                  " AND l2.T_OTHERDEBTORNUM   = l1.T_OTHERDEBTORNUM " +
                  " AND l2.T_TFID_REF         = ? " +
               ")",
               "ObjectTypeID",   _ObjectTypeID,
               "ObjectNumber",   _ObjectNumber,
               "OTHERDEBTORNUM", OtherDebtorNum,
               "TYPEADRESS1",    1,
               "TYPEADRESS2",    2,
               "TFID1",          TFID,
               "TFID2",          A_TFID,
               V_INTEGER);

      // Изменения были!!
      IF (cnt > 0)
         RETURN TRUE;
      END;
   ELSE
      RETURN TRUE;
   END;

   RETURN FALSE;
END;

////////////////////////////////////////////////////////////////////////////////
// EM
// Блок 201
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_РАБОТОДАТЕЛЯ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   // Последняя успешная выгрузка блока 201
   VAR A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_201_DBT lbki WHERE " +
                        " l.T_OBJECTTYPEID = ? " +
                    " AND l.T_OBJECTNUMBER = ? " +
                    " AND l.T_BKIID_REF    = ? " +
                    " AND lbki.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF     = t.T_TFID " + 
                    " AND l.T_OBJECTTYPEID = lbki.T_OBJECTTYPEID " + 
                    " AND l.T_OBJECTNUMBER = lbki.T_OBJECTNUMBER ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                  V_INTEGER);

   IF (A_TFID > 0)
   VAR cnt : integer =
   CRSDCommand("SELECT COUNT(*) FROM DLBKI_201_TMP l WHERE " +
                     " l.T_OBJECTTYPEID     = ? " +
                 " AND l.T_OBJECTNUMBER     = ? " +
                 " AND l.T_OTHERDEBTORNUM   = ? " +
                 " AND l.T_TFID_REF         = ? " +
                 " AND l.T_PLACEOFEMPLOYMENT <> " +
               "(" +
                "SELECT l2.T_PLACEOFEMPLOYMENT FROM DLBKI_201_DBT l2 WHERE " +
                      " l2.T_OBJECTTYPEID     = l.T_OBJECTTYPEID " +
                  " AND l2.T_OBJECTNUMBER     = l.T_OBJECTNUMBER " +
                  " AND l2.T_OTHERDEBTORNUM   = l.T_OTHERDEBTORNUM   " +
                  " AND l2.T_TFID_REF         = ? " +
               ")",
               "OBJECTTYPEID",   _ObjectTypeID,
               "OBJECTNUMBER",   _ObjectNumber,
               "OTHERDEBTORNUM", OtherDebtorNum,
               "TFID1",          TFID,
               "TFID2",          A_TFID,
               V_INTEGER);

      // Изменения были!!
      IF (cnt > 0)
         RETURN TRUE;
      END;
   ELSE
      RETURN TRUE;
   END;

   RETURN FALSE;
END;


////////////////////////////////////////////////////////////////////////////////
// PN
// Блок 401
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ТЕЛЕФОНА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   // Последняя успешная выгрузка блока 301
   VAR A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_401_DBT lbki WHERE " +
                        " l.T_OBJECTTYPEID = ? " +
                    " AND l.T_OBJECTNUMBER = ? " +
                    " AND l.T_BKIID_REF    = ? " +
                    " AND lbki.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF     = t.T_TFID " + 
                    " AND l.T_OBJECTTYPEID = lbki.T_OBJECTTYPEID " + 
                    " AND l.T_OBJECTNUMBER = lbki.T_OBJECTNUMBER ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                  V_INTEGER);

   IF (A_TFID > 0)
      VAR cnt : integer =
      CRSDCommand("SELECT COUNT(*) FROM DLBKI_401_TMP l WHERE " +
                     " l.T_OBJECTTYPEID     = ? " +
                 " AND l.T_OBJECTNUMBER     = ? " +
                 " AND l.T_TFID_REF         = ? " +
                 " AND l.T_OTHERDEBTORNUM   = ? " +
                 " AND l.T_TELEPHONE <> " +
               "(" +
                "SELECT l2.T_TELEPHONE FROM DLBKI_401_DBT l2 WHERE " +
                      " l2.T_TYPEADRESS       = l.T_TYPEADRESS " +
                  " AND l2.T_OBJECTTYPEID     = l.T_OBJECTTYPEID " +
                  " AND l2.T_OBJECTNUMBER     = l.T_OBJECTNUMBER " +
                  " AND l2.T_TFID_REF         = ? " +
                  " AND l2.T_OTHERDEBTORNUM   = l.T_OTHERDEBTORNUM   " +
               ")",
               "OBJECTTYPEID",   _ObjectTypeID,
               "OBJECTNUMBER",   _ObjectNumber,
               "TFID1",          TFID,
               "OTHERDEBTORNUM", OtherDebtorNum,
               "TFID2",          A_TFID,
               V_INTEGER);

      // Изменения были!!
      IF (cnt > 0)
         RETURN TRUE;
      END;
   ELSE
      RETURN TRUE;

   END;

   RETURN FALSE;
END;
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// TR
// Блоки: 402, 407, 404
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_СДЕЛКА(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer)
   VAR A_TFID: INTEGER = 0,
          cnt: INTEGER = 0,
   CreditNumber = _ObjectNumber,
   ObjectTypeID = _ObjectTypeID;

   IF (_ObjectTypeID == LO_ENSCONTR)
      VAR RC = 
      CRSDCommand("SELECT C.T_CRD_KIND, C.T_CREDITNUMBER FROM DENS_CRD_DBT e JOIN DCREDIT_C_DBT c ON (E.T_CREDITNUMBER_REF = C.T_CREDITNUMBER) "
      "WHERE E.T_ENSCONTRACTID_REF = ?",
      "p1", _ObjectNumber,
      V_GENOBJ);

      RC.MoveNext();

      CreditNumber = RC.Value("T_CREDITNUMBER");
      ObjectTypeID = RC.Value("T_CRD_KIND");
   END;

   // Блок 404
   // Есть ли данные в блоке ,
   cnt = CRSDCommand("SELECT COUNT(*) FROM DLBKI_404_TMP l WHERE " +
                           " l.T_CREDITNUMBER_REF = ? " +
                       " AND l.T_TFID_REF         = ? ",
                     "CREDITNUMBER", CreditNumber,
                     "TFID",         TFID,
                     V_INTEGER);
   IF (cnt == 0)
      RETURN FALSE;
   END;

   A_TFID =
   CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, " +
                                                  " DLDEVBKI_DBT  l, " +
                                                  " DLBKI_404_DBT lbki_404 WHERE " +
                     " l.T_CREDITNUMBER_REF = ? " +
                 " AND l.T_BKIID_REF        = ? " +
                 " AND t.T_RESULTLOAD       = ? " +
                 " AND lbki_404.T_TFID_REF  = t.T_TFID " +
                 " AND l.T_TFID_REF         = t.T_TFID " + 
                 " AND l.T_CREDITNUMBER_REF = LBKI_404.T_CREDITNUMBER_REF",
               "CREDITNUMBER", CreditNumber,
               "BKIID",        lbki.rec.BkiID,
               "RESULTLOAD",   0,
               V_INTEGER);

   // Нет предыдущей информации
   IF (A_TFID == 0)
       RETURN TRUE;
   END;

   cnt = CRSDCommand("SELECT COUNT(*) FROM DLBKI_404_TMP l1 WHERE " +
                     " l1.T_CREDITNUMBER_REF = ? " +
                 " AND l1.T_TFID_REF         = ? " +
                 " AND(l1.T_LASTDATE, l1.T_CLOSEDATE, l1.T_FINALDATE, l1.T_FINALPERCDATE) <> " +
              "(SELECT l2.T_LASTDATE, l2.T_CLOSEDATE, l2.T_FINALDATE, l2.T_FINALPERCDATE " +
                " FROM DLBKI_404_DBT l2 WHERE " +
                     " l2.T_CREDITNUMBER_REF = l1.T_CREDITNUMBER_REF " +
                 " AND l2.T_TFID_REF         = ?)",
              "CREDITNUMBER", CreditNumber,
              "TFID1",        TFID,
              "TFID2",      A_TFID,
              V_INTEGER);
   IF (cnt > 0)
      RETURN TRUE;
   END;

   // 402
   // Есть ли данные в блоке ,
   cnt = CRSDCommand("SELECT COUNT(*) FROM DLBKI_402_TMP l WHERE " +
                           " l.T_CREDITNUMBER_REF = ? " +
                       " AND l.T_TFID_REF         = ? ",
                     "CREDITNUMBER", CreditNumber,
                     "TFID",         TFID,
                     V_INTEGER);
   IF (cnt == 0)
      RETURN FALSE;
   END;

   A_TFID =
   CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, " +
                                                  " DLDEVBKI_DBT  l, " +
                                                  " DLBKI_402_DBT lbki_402 WHERE " +
                     " l.T_CREDITNUMBER_REF = ? " +
                 " AND l.T_BKIID_REF        = ? " +
                 " AND t.T_RESULTLOAD       = ? " +
                 " AND lbki_402.T_TFID_REF  = t.T_TFID " +
                 " AND l.T_TFID_REF         = t.T_TFID ",
               "CREDITNUMBER", CreditNumber,
               "BKIID",        lbki.rec.BkiID,
               "RESULTLOAD",   0,
               V_INTEGER);

   // Нет предыдущей информации
   IF (A_TFID == 0)
       RETURN TRUE;
   END;

   cnt =
   CRSDCommand(
   "SELECT COUNT(*) FROM DLBKI_402_TMP l1 WHERE " +
         " l1.T_CREDITNUMBER_REF = ? " +
     " AND l1.T_TFID_REF         = ? " +
     " AND l1.T_REPORTDATE       = " +
          "(" +
            "SELECT MAX(l4.T_REPORTDATE) FROM DLBKI_402_TMP l4 WHERE " +
                  " l4.T_CREDITNUMBER_REF = l1.T_CREDITNUMBER_REF " +
              " AND l4.T_TFID_REF         = l1.T_TFID_REF " +
          ")" +
     " AND(l1.T_TYPECREDIT, "      +
          "l1.T_TYPECLIENT, "      +
          "l1.T_CREDITSTATE, "     +
          "l1.T_DATESTATE, "       +
          "l1.T_DUTYSUM, "         +
          "l1.T_DUTY, "            +
          "l1.T_NEXTDUTY, "        +
          "l1.T_PERIODDUTY, "      +
          "l1.T_CURCODE, "         +
          "l1.T_PERIODPERC, "      +
          "l1.T_CURRENTDUTYREST) <> " +
  "(SELECT l2.T_TYPECREDIT, "      +
          "l2.T_TYPECLIENT, "      +
          "l2.T_CREDITSTATE, "     +
          "l2.T_DATESTATE, "       +
          "l2.T_DUTYSUM, "         +
          "l2.T_DUTY, "            +
          "l2.T_NEXTDUTY, "        +
          "l2.T_PERIODDUTY, "      +
          "l2.T_CURCODE, "         +
          "l2.T_PERIODPERC, "      +
          "l2.T_CURRENTDUTYREST FROM DLBKI_402_DBT l2 WHERE " +
         " l2.T_CREDITNUMBER_REF = l1.T_CREDITNUMBER_REF " +
     " AND l2.T_REPORTDATE       = "+
          "(" +
            "SELECT MAX(l3.T_REPORTDATE) FROM DLBKI_402_DBT l3 WHERE " +
                  " l3.T_CREDITNUMBER_REF = l1.T_CREDITNUMBER_REF " +
              " AND l3.T_TFID_REF         = l2.T_TFID_REF " +
          ")" +
     " AND l2.T_TFID_REF         = ?)",
          "CREDITNUMBER", CreditNumber,
          "TFID1",        TFID,
          "TFID2",      A_TFID,
           V_INTEGER);
   IF (cnt > 0)
      RETURN TRUE;
   END;

   // Блок 407
   // Есть ли данные в блоке ,
   cnt = CRSDCommand("SELECT COUNT(*) FROM DLBKI_407_TMP l WHERE " +
                           " l.T_CREDITNUMBER_REF = ? " +
                       " AND l.T_TFID_REF         = ? ",
                     "CREDITNUMBER", CreditNumber,
                     "TFID",         TFID,
                     V_INTEGER);
   IF (cnt == 0)
      RETURN FALSE;
   END;

   A_TFID =
   CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, " +
                                                  " DLDEVBKI_DBT  l, " +
                                                  " DLBKI_407_DBT lbki_407 WHERE " +
                     " l.T_CREDITNUMBER_REF = ? " +
                 " AND l.T_BKIID_REF        = ? " +
                 " AND t.T_RESULTLOAD       = ? " +
                 " AND l.T_TFID_REF         = t.T_TFID " +
                 " AND lbki_407.T_TFID_REF  = t.T_TFID " +
                 " AND LBKI_407.T_CREDITNUMBER_REF = l.T_CREDITNUMBER_REF",
               "CREDITNUMBER", CreditNumber,
               "BKIID",        lbki.rec.BkiID,
               "RESULTLOAD",   0,
               V_INTEGER);

   // Нет предыдущей информации
   IF (A_TFID == 0)
       RETURN TRUE;
   END;

   cnt = CRSDCommand("SELECT COUNT(*) FROM DLBKI_407_TMP l1 WHERE " +
                           " l1.T_CREDITNUMBER_REF = ? " +
                       " AND l1.T_TFID_REF         = ? " +
                       " AND(l1.T_TIMEPAYM, l1.T_EXPSUM) <> " +
                    "(SELECT l2.T_TIMEPAYM, l2.T_EXPSUM FROM DLBKI_407_DBT l2 WHERE " +
                           " l2.T_CREDITNUMBER_REF = l1.T_CREDITNUMBER_REF " +
                       " AND l2.T_OPERATIONID      = l1.T_OPERATIONID " +
                       " AND l2.T_TFID_REF         = ?)",
                     "CREDITNUMBER", CreditNumber,
                     "TFID1",        TFID,
                     "TFID2",      A_TFID,
                     V_INTEGER);
   IF (cnt > 0)
      RETURN TRUE;
   END;

   // ==>
   // Есть ли данные в блоке DNBKI_TR_CRD_TMP
   cnt = CRSDCommand("SELECT COUNT(*) FROM DNBKI_TR_CRD_TMP l WHERE " +
                           " l.T_OBJECTTYPEID = ? " +
                       " AND l.T_OBJECTNUMBER = ? ",
                     "OBJECTTYPEID", ObjectTypeID,
                     "OBJECTNUMBER", CreditNumber,
                     V_INTEGER);
   IF (cnt == 0)
      RETURN FALSE;
   END;

   A_TFID =
   CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, " +
                                                  " DLDEVBKI_DBT  l, " +
                                                  " DNBKI_TR_CRD_DBT tr WHERE " +
                     " l.T_OBJECTTYPEID = ? " +
                 " AND l.T_OBJECTNUMBER = ? " +
                 " AND l.T_BKIID_REF  = ? " +
                 " AND t.T_RESULTLOAD = ? " +
                 " AND l.T_TFID_REF   = t.T_TFID " +
                 " AND tr.T_TFID      = t.T_TFID " +
                 " AND tr.T_OBJECTTYPEID = l.T_OBJECTTYPEID" + 
                 " AND tr.T_OBJECTNUMBER = l.T_OBJECTNUMBER",
               "ObjectTypeID", ObjectTypeID,
               "ObjectNumber", CreditNumber,
               "BKIID",        lbki.rec.BkiID,
               "RESULTLOAD",   0,
               V_INTEGER);

   // Нет предыдущей информации
   IF (A_TFID == 0)
       RETURN TRUE;
   END;

   cnt = CRSDCommand(
   "SELECT COUNT (1) FROM " +
   "( " +
   "SELECT T_CLIENTID, T_REPDATE, T_GUARANTOR_INDICATOR, T_VOLUME_OF_DEBT, T_GUARANTEE_SUM,  " +
          "T_GUARANTEE_TERM, T_BANK_GUARANTEE_INDICATOR, T_VOLUME_OF_SECURED,  " +
          "T_BANK_GUARANTEE_SUM, T_BANK_GUARANTEE_TERM, T_COLLATERAL_VALUE,  " +
          "T_COLLATERAL_DATE, T_COLLATERAL_EXPIRATION, T_OVERALL_VALUE_OF_CREDIT,  " +
          "T_RIGHT_OF_CLAIM_NAMES, T_RIGHT_OF_CLAIM_REGISTRATION, T_RIGHT_OF_CLAIM_TAXPAYER,  " +
          "T_RIGHT_OF_CLAIM_SOCIAL, T_ENSOBJECTID, T_ENSVOUCHER,  " +
          "T_ENSGUARANTEE, T_ENSSECUR, T_SEGNAME,  " +
          "T_COLLATERAL_CODE, T_CREDITNUMBER, T_CCY,  " +
          "T_ACCOUNTNUMBER FROM DNBKI_TR_CRD_TMP l1 WHERE  " +
                              "l1.T_OBJECTTYPEID = :1  " +
                          "AND l1.T_OBJECTNUMBER = :2  " +
                          "AND l1.T_TFID         = :3 " +
   "MINUS " +
   "SELECT T_CLIENTID, T_REPDATE, T_GUARANTOR_INDICATOR, T_VOLUME_OF_DEBT, T_GUARANTEE_SUM,  " +
          "T_GUARANTEE_TERM, T_BANK_GUARANTEE_INDICATOR, T_VOLUME_OF_SECURED,  " +
          "T_BANK_GUARANTEE_SUM, T_BANK_GUARANTEE_TERM, T_COLLATERAL_VALUE,  " +
          "T_COLLATERAL_DATE, T_COLLATERAL_EXPIRATION, T_OVERALL_VALUE_OF_CREDIT,  " +
          "T_RIGHT_OF_CLAIM_NAMES, T_RIGHT_OF_CLAIM_REGISTRATION, T_RIGHT_OF_CLAIM_TAXPAYER,  " +
          "T_RIGHT_OF_CLAIM_SOCIAL, T_ENSOBJECTID, T_ENSVOUCHER,  " +
          "T_ENSGUARANTEE, T_ENSSECUR, T_SEGNAME,  " +
          "T_COLLATERAL_CODE, T_CREDITNUMBER, T_CCY,  " +
          "T_ACCOUNTNUMBER FROM DNBKI_TR_CRD_DBT l2 WHERE  " +
                              "l2.T_OBJECTTYPEID = :1  " +
                          "AND l2.T_OBJECTNUMBER = :2  " +
                          "AND l2.T_TFID         = :3 " +
   ")",
                     "ObjectTypeID1", ObjectTypeID,
                     "ObjectNumber1", CreditNumber,
                     "TFID1",         TFID,
                     "ObjectTypeID2", ObjectTypeID,
                     "ObjectNumber2", CreditNumber,
                     "TFID2",        A_TFID,
                     V_INTEGER);
   IF (cnt > 0)
      RETURN TRUE;
   END;
   // <==


   RETURN FALSE;
END;

////////////////////////////////////////////////////////////////////////////////
// LE
// Блок LE
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ЮРИДИЧЕСКИЙ_СТАТУС(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer)

   // Последняя успешная выгрузка блока 301
   VAR A_TFID =
      CRSDCommand("SELECT MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l, DLBKI_406_DBT lbki WHERE " +
                        " l.T_OBJECTTYPEID = ? " +
                    " AND l.T_OBJECTNUMBER = ? " +
                    " AND l.T_BKIID_REF    = ? " +
                    " AND lbki.T_TFID_REF  = t.T_TFID " +
                    " AND l.T_TFID_REF     = t.T_TFID " + 
                    " AND l.T_CREDITNUMBER_REF = lbki.T_CREDITNUMBER_REF ",
                  "ObjectTypeID", _ObjectTypeID,
                  "ObjectNumber", _ObjectNumber,
                  "BKIID",        lbki.rec.BkiID,
                  V_INTEGER);

   IF (A_TFID == 0)
      VAR cnt: INTEGER =
      CRSDCommand(
      "SELECT COUNT(*) FROM DLBKI_406_TMP l1 WHERE "+
           "  l1.T_CREDITNUMBER_REF = ? " +
        " AND l1.T_TFID_REF         = ? ",
                 "CREDITNUMBER", _ObjectNumber,
                 "TFID1",        TFID,
                 V_INTEGER);
      IF (cnt > 0)
         RETURN TRUE;
      ELSE
         RETURN FALSE;
      END;
   END;

   cnt =
   CRSDCommand(
   "SELECT COUNT(*) FROM DLBKI_406_TMP l1 WHERE "+
        "  l1.T_CREDITNUMBER_REF = ? " +
     " AND l1.T_TFID_REF         = ? " +
     " AND(l1.T_INF2, l1.T_SUITNUMBER2, l1.T_COURTNAME2) <> " +
  "(SELECT l2.T_INF2, l2.T_SUITNUMBER2, l2.T_COURTNAME2 FROM DLBKI_406_DBT l2 WHERE " +
        "  l2.T_CREDITNUMBER_REF = l1.T_CREDITNUMBER_REF " +
     " AND l2.T_TFID_REF         = ?)",
              "CREDITNUMBER", _ObjectNumber,
              "TFID1",        TFID,
              "TFID2",      A_TFID,
              V_INTEGER);
   IF (cnt > 0)
      RETURN TRUE;
   END;

   RETURN FALSE;
END;

MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ИНФОРМАЦИЯ(_ObjectTypeID, _ObjectNumber, TFID)
   VAR cnt: INTEGER = 0;

   IF (_ObjectTypeID == LO_CLAIM) 
      cnt = CRSDCommand(
      "SELECT COUNT(*) FROM DNBKI_IP_CLAIM_TMP l1 WHERE "+
           "  l1.T_CLAIMID = ? " +
        " AND l1.T_TFID    = ? ",
                 "CLAIMID", _ObjectNumber,
                 "TFID",    TFID,
                V_INTEGER);
      IF (cnt > 0)
         RETURN TRUE;
      END;
   ELSE
      cnt = CRSDCommand(
      "SELECT COUNT(*) FROM DNBKI_IP_ENSCONTR_TMP l1 WHERE "+
           "  l1.T_ENSCONTRACTID = ? " +
        " AND l1.T_TFID    = ? ",
                 "ENSCONTR", _ObjectNumber,
                 "TFID",     TFID,
                V_INTEGER);
      IF (cnt > 0)
         RETURN TRUE;
      END;
   END;

   RETURN FALSE;
END;

////////////////////////////////////////////////////////////////////////////////
MACRO ИЗМЕНЕНИЯ_В_СЕГМЕНТАХ(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, OtherDebtorNum: integer)
   VAR save_COUNT = COUNT; // Сохраним кол-во успешно сформированных сегментов

   IF (((_ObjectTypeID == LO_CLAIM) OR (_ObjectTypeID == LO_ENSCONTR)))
      VAR RS_OBJ = CRSDCommand("SELECT * FROM DOBJECT_BKI_TMP WHERE T_OBJECTTYPEID IN (3,4) AND T_OBJECTNUMBER = ? ",
                             "p2", _ObjectNumber,
                            V_GENOBJ);

      WHILE (RS_OBJ.MoveNext)
         IF (RS_OBJ.Value("T_RESULT") == -1)
            RETURN FALSE;
         END;
      END;
   END;

   IF (TypeClient != PTLEGF_INST)
      // Сегмент EM
      IF (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_РАБОТОДАТЕЛЯ(_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
         RETURN TRUE;
      END;
   END;

   // Сегмент PN
   IF (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ТЕЛЕФОНА       (_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      RETURN TRUE;
   END;

   // Сегмент ID
   IF (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ИДЕНТИФИКАЦИИ  (_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      RETURN TRUE;
   END;

   // Физик
   IF (TypeClient != PTLEGF_INST)
       // Сегмент NA
      IF (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ИМЕНИ       (_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
         RETURN TRUE;
      END;
   // Юрик
   ELSE

      // Сегмент BU
      IF (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ПРЕДПРИЯТИЯ (_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
         RETURN TRUE;
      END;
   END;

   // Сегмент AD
   IF (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_АДРЕСА         (_ObjectTypeID, _ObjectNumber, TFID, OtherDebtorNum))
      RETURN TRUE;
   END;

   IF((ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ЮРИДИЧЕСКИЙ_СТАТУС    (_ObjectTypeID, _ObjectNumber, TFID)) OR
      (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_СДЕЛКА                (_ObjectTypeID, _ObjectNumber, TFID)))
      RETURN TRUE;
   END;

   IF (((_ObjectTypeID == LO_CLAIM) OR (_ObjectTypeID == LO_ENSCONTR))
   AND (ИЗМЕНЕНИЯ_В_СЕГМЕНТЕ_ИНФОРМАЦИЯ(_ObjectTypeID, _ObjectNumber, TFID)))
      RETURN TRUE;
   END;

   // Изменений в блоках не было, удалим.


   RETURN FALSE;
END;

MACRO СформироватьСегменты(_ObjectTypeID: integer, _ObjectNumber: integer, TFID: integer, SendKind: integer)
   VAR s1  : BOOL = FALSE,
       s2  : BOOL = FALSE,
       s3  : BOOL = FALSE,
       S5  : BOOL = FALSE,
       STAT: BOOL = TRUE,
       save_COUNT = COUNT;

   VAR  RSP = NULL, RSE = NULL, RSA = NULL, type1 = 0, type2 = 0, RS;

   IF (_ObjectTypeID == LO_ENSCONTR)
      RS =
   CRSDCommand("SELECT  p.*, T_ISEMPLOYER, 1 AS T_OTHERDEBTORNUM FROM DENSCONTR_DBT lo, DPARTY_DBT p LEFT JOIN DPERSN_DBT pr ON p.T_PARTYID = pr.T_PERSONID WHERE " +
                     " LO.T_ENSCONTRACTID = ? " +
                 " AND LO.T_ENSCONTRACTPERSONID_REF = p.T_PARTYID ",
               "OBJECTNUMBER", _ObjectNumber,
               V_GENOBJ);
   ELSE
      RS =
   CRSDCommand("SELECT * FROM DLOTHDEB_DBT lo, DPARTY_DBT p LEFT JOIN DPERSN_DBT pr ON p.T_PARTYID = pr.T_PERSONID WHERE " +
                     " lo.T_OBJECTTYPEID_REF = ? " +
                 " AND lo.T_OBJECTNUMBER_REF = ? " +
                 " AND lo.T_PARTYID_REF      = p.T_PARTYID " +
                 " AND Nvl(lo.T_ISDELETED, ?) <> ? " +
                 " ORDER BY lo.T_OTHERDEBTORNUM ",
               "OBJECTTYPEID", _ObjectTypeID,
               "OBJECTNUMBER", _ObjectNumber,
               "ISDEL",        0,
               "DEL",          "X",
               V_GENOBJ);
   END;

   GENERAL_FAILURE = FALSE;

   WHILE (RS.MoveNext())
      VAR OTHERDEBTORNUM = SQL_NVL(RS.Value("T_OTHERDEBTORNUM"), V_INTEGER);

      ClientID   = SQL_NVL(RS.Value("T_PARTYID"), V_INTEGER);

      // Определим тип клиента
      TypeClient = ТипКлиента(SQL_NVL(RS.Value("T_LEGALFORM"),  V_INTEGER),
                              SQL_NVL(RS.Value("T_ISEMPLOYER"), V_STRING));
      // Определим является ли клиент нерезидентом
      Client_NotResident = Нерезедент(ClientID);                         

      // Найдем блок 201
      GetBlock_201 = FALSE;
      IF (
          (TypeClient == PTLEGF_PERSN) 
          OR
          (TypeClient == PTLEGF_PBUL) //  TFS. v 2.20. И ПБЮЛ
         )
         //  TFS. v 2.20. Начало ==>
         // Это обязательный сегмент
         IF (GetBlock(201, TFID, OTHERDEBTORNUM, _ObjectTypeID, _ObjectNumber))
            GetBlock_201 = TRUE;
         END;
      END;

      // Найдем блоки 401 ==>
      IF (TypeClient != PTLEGF_INST)
         type1 = 1; // Адрес прописки
         type2 = 2; // Фактический адрес
      ELSE
         type1 = 4; // Фактический для юриков
         type2 = 3; // Юридеческий
      END;

      Adress1_401 = "-1";
      Adress2_401 = "-1";
      RSA = CRSDCommand(
         "SELECT T_ADRESS, T_TYPEADRESS " +
         " FROM DLBKI_401_TMP WHERE " +
               " T_OBJECTTYPEID = ? " +
           " AND T_OBJECTNUMBER = ? " +
           " AND T_TFID_REF = ? " + 
           " AND T_OTHERDEBTORNUM = ? " + 
           " AND T_TYPEADRESS IN (?, ?) " +
           " AND T_PARTYID_REF = ? ", 
         "p0", _ObjectTypeID, 
         "p1", _ObjectNumber, 
         "p2", TFID, 
         "p3", OTHERDEBTORNUM,
         "p4", type1,
         "p5", type2,
         "p6", ClientID, V_GENOBJ);
   
      WHILE (RSA.MoveNext())
         IF (type1 == int(RSA.Value("T_TYPEADRESS")))
            Adress1_401 = SQL_NVL(RSA.Value("T_ADRESS"), V_STRING);
         END;
         IF (type2 == int(RSA.Value("T_TYPEADRESS")))
            Adress2_401 = SQL_NVL(RSA.Value("T_ADRESS"), V_STRING);
         END;
      END;
      // Надем блоки 401 <==

      IF ((SendKind == REQUEST_FULL) OR
          (SendKind == REQUEST_DEL) OR
         ((SendKind == REQUEST_CHNG) AND (ИЗМЕНЕНИЯ_В_СЕГМЕНТАХ(_ObjectTypeID, _ObjectNumber,
                                                                TFID,
                                                                OTHERDEBTORNUM))))
         nbki_tmp.Clear();
         // Дополнительные сегменты
         // Сегмент LE
         IF ((S2 = СЕГМЕНТ_ЮРИДИЧЕСКИЙ_СТАТУС(_ObjectTypeID, _ObjectNumber, TFID, OTHERDEBTORNUM, ClientID)) == TRUE)
            InsertToFile();
         END;

         nbki_tmp.Clear();
         // Сегмент BK
         IF ((S3 = СЕГМЕНТ_БАНКРОТСТВО(_ObjectTypeID, _ObjectNumber, TFID, OTHERDEBTORNUM, ClientID)) == TRUE)
            InsertToFile();
         END;

         nbki_tmp.Clear();
         // Сегмент TR
         IF ((S1 = СЕГМЕНТ_СДЕЛКА(_ObjectTypeID, _ObjectNumber, TFID, OTHERDEBTORNUM, ClientID)) == TRUE)
           InsertToFile();
         END;

         nbki_tmp.Clear();
         IF ((S5 = СЕГМЕНТ_ИНФОРМАЦИОННАЯ_ЧАСТЬ(_ObjectTypeID, _ObjectNumber, TFID, OTHERDEBTORNUM, ClientID)) == TRUE)
            InsertToFile();
         END;

         IF ((NOT s1) AND (NOT s2) AND (NOT s3) AND (NOT S5))
            InsErrorMessage("Отсутствуют сегменты TR/LE/BK/IP");
            COUNT = save_COUNT;
         END;

         СЕГМЕНТ_ID = 0; СЕГМЕНТ_NA = 0; СЕГМЕНТ_BU = 0;
         СЕГМЕНТ_AD = 0; СЕГМЕНТ_PN = 0; СЕГМЕНТ_TR = 1;
         СЕГМЕНТ_LE = 0; СЕГМЕНТ_BK = 0; СЕГМЕНТ_CL = 0;
         СЕГМЕНТ_GR = 0; СЕГМЕНТ_BG = 0;

      ELSE
         LoansError     ("КИ не изменилась!");
         InsErrorMessage("КИ не изменилась!");
      END;
      nbki_tmp.Clear();
   END;

   IF (GENERAL_FAILURE)
       STAT = FALSE;
   END;

   RETURN STAT;
END;

////////////////////////////////////////////////////////////////////////////////
//
// ФОРМИРОВАНИЕ ВИРТУАЛЬНОЙ ИСТОРИИ
//
// ПАРАМЕТРЫ:
//   BkiID        - системный номер БКИ
//   CreditNumber - номер КД
//   TFID         - Ссылка на транспортный файл
//   _ObjectTypeID - Вид объекта
//   _ObjectNumber - Номер объекта
MACRO СформироватьВиртуальнуюИсторию(BkiID: Integer, CrdNum: integer, SendKind: integer, TFID: integer, StartDate: date, cfAutoFindStartDate: string, _ObjectTypeID: integer, _ObjectNumber: integer)
   VAR query      : STRING  = "",
       exists     : STRING  = "",
       CrdOp_New  : INTEGER = 0,
       CrdOp_Old  : INTEGER = 0,
       stat       : BOOL    = FALSE,
       RS         = NULL,
       pos,
       crd_regdate:      date,
       crd_daterejected: date,
       count = 0, ID = 0, FLAG = "",
       RSDcmd,
       saveSendKind = SendKind; // Сохраним параметры КИ

   // Найдем БКИ
   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №" + BkiID);
      RETURN FALSE;
   END;

   // Найдем транспортный файл
   // В случае пакетной передачи TFID равен = 0
   ltr_file.rec.TFID     = TFID;
   ltr_file.rec.FileDate = {curdate};
   IF ((TFID != 0) AND (NOT ltr_file.getEQ()))
      LoansError("Не найден транспортный файл №" + TFID);
      RETURN FALSE;
   END;

   BegAction(2000, "Идет обработка...", TRUE);

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LOANS_NBKI.fillcreditlist(?, ?, ?, ?, ?, ?, ?); END;"); 
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER); 
   RSDcmd.addParam("bkiid",        RSDBP_IN); RSDcmd.value("bkiid")        = BkiID;
   RSDcmd.addParam("reportdate",   RSDBP_IN); RSDcmd.value("reportdate")   = ReportDate;
   RSDcmd.addParam("sendkind",     RSDBP_IN); RSDcmd.value("sendkind")     = SendKind;
   RSDcmd.addParam("legalform",    RSDBP_IN); RSDcmd.value("legalform")    = _legalform;
   RSDcmd.addParam("oper",         RSDBP_IN); RSDcmd.value("oper")         = OpOper;
   RSDcmd.addParam("ObjectTypeID", RSDBP_IN); RSDcmd.value("ObjectTypeID") = _ObjectTypeID;
   RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = _ObjectNumber;
   RSDcmd.execute();
   RSDcmd.Close();

   RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LOANS_NBKI.BkiID:= ?; RSO_LOANS_NBKI.SendKind:= ?; END;"); 
   RSDcmd.addParam("bkiid",        RSDBP_IN); RSDcmd.value("bkiid")        = BkiID;
   RSDcmd.addParam("sendkind",     RSDBP_IN); RSDcmd.value("sendkind")     = SendKind;
   RSDcmd.execute();

   count = LnSelectValue("SELECT COUNT(1) FROM DOBJECT_BKI_TMP WHERE T_OBJECTTYPEID NOT IN (3, 4)", V_INTEGER);
   InitProgress(count, "Стадия обработки...", "Построение виртуальной КИ");
   count = 0;

   // Удалим виртуальную историю этого КД
   CRSDCommand("DELETE FROM DLBKI_201_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_202_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_203_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_302_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_401_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_PHONE_TMP       WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);   
   CRSDCommand("DELETE FROM DLBKI_301_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_304_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_402_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_404_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_406_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DLBKI_407_TMP         WHERE T_TFID_REF = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DNBKI_TR_CRD_TMP      WHERE T_TFID     = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DNBKI_TR_ENS_TMP      WHERE T_TFID     = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DNBKI_IP_CLAIM_TMP    WHERE T_TFID     = ?", "TFID", TFID, V_GENOBJ);
   CRSDCommand("DELETE FROM DNBKI_IP_ENSCONTR_TMP WHERE T_TFID     = ?", "TFID", TFID, V_GENOBJ);
   
   СформироватьБлокиОбеспечения(BkiID, TFID, ReportDate);
   СформироватьБлокиГарантии   (BkiID, TFID, ReportDate);
   СформироватьБлок_201        (TFID);

   VAR RS_OBJ = CRSDCommand("SELECT oo.*, LB.T_ACCESSCODE " +
                            " FROM DOBJECT_BKI_TMP oo, DLBKICONT_DBT lb WHERE oo.T_OBJECTTYPEID NOT IN (3, 4) " +
                            "AND oo.T_BKIID = ? " +
                            "AND LB.T_CREDITNUMBER_REF = OO.T_CREDITNUMBER " +
                            "AND LB.T_BKIID_REF    = ? " +
                            "AND LB.T_OBJECTTYPEID = oo.T_OBJECTTYPEID " +
                            "AND LB.T_OBJECTNUMBER = OO.T_OBJECTNUMBER ",
                            "p1", BkiID,
                            "p2", BkiID,
                            V_GENOBJ);

   WHILE (RS_OBJ.MoveNext)
      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");
      UseProgress (count = count + 1);

      STAT = TRUE;

      CrdNum = RS_OBJ.Value("T_CREDITNUMBER");

      credit_c.rec.CreditNumber = CrdNum;
      credit_c.GetEQ();

      ObjectNumber = credit_c.rec.CreditNumber;
      ObjectTypeID = credit_c.rec.Crd_kind;

      LnSQLExec  ("DELETE FROM DNBKI_TMP");
   
      // Найдем КД
      credit_c.rec.CreditNumber = CrdNum;
      IF (NOT credit_c.GetEQ())
         LoansError("Не найден договор №" + CrdNum);
         STAT = FALSE;
         CONTINUE;
      END;

      AccessCode   = SQL_NVL(RS_OBJ.Value("T_ACCESSCODE"), V_STRING);

      // TFS. SCR 190724
      IF (ReportDate < date(01,07,2014))
         // Анализируем признак согласия
         ID = CRSDCommand("SELECT MAX(T_ID) FROM DLCONSDEV_DBT WHERE T_CREDITNUMBER_REF = ? AND T_CHANGEDATE <= ?",
                          "p1", CrdNum,
                          "p2", {CURDATE},
                         V_INTEGER);
      
         IF (ID > 0)
            // Флаг согласия на передачу КИ
            FLAG = CRSDCommand("SELECT T_FLAG FROM DLCONSDEV_DBT WHERE T_ID = ?",
                               "p1", ID,
                              V_STRING);
      
            IF ((Flag != "X") AND ((SendKind == REQUEST_CHNG) OR (SendKind == REQUEST_FULL)))
               LoansError("Передавать КИ нельзя, так как нет согласия заемщика");
               STAT = FALSE;
               CONTINUE;
            END;
      
            IF ((Flag == "X") AND (SendKind == REQUEST_DEL))
               LoansError("Нельзя передавать запрос на удаление КИ в БКИ | так как заемщик согласен на передачу КИ");
               STAT = FALSE;
               CONTINUE;
            END;
      
            IF ((Flag != "X") AND (SendKind == REQUEST_DEL))
               ID = CRSDCommand("SELECT MAX(T_ID) FROM DLDEVBKI_DBT WHERE T_CREDITNUMBER_REF = ? AND T_SENDDATE <= ?",
                                "p1", CrdNum,
                                "p2", {CURDATE},
                               V_INTEGER);
      
               IF (ID == 0)
                  LoansError("Нельзя передавать запрос на удаление КИ | так как передачи в БКИ еще не было");
                  STAT = FALSE;
                  CONTINUE;
               END;
            END;
         ELSE
            IF ((SendKind == REQUEST_CHNG) OR (SendKind == REQUEST_FULL))
               LoansError("Передавать КИ нельзя, так как нет согласия заемщика!");
               STAT = FALSE;
               CONTINUE;
            END;
      
            IF (SendKind == REQUEST_DEL)
               LoansError("Нельзя передавать запрос на удаление КИ \n так как передачи в БКИ еще не было");
               STAT = FALSE;
               CONTINUE;
            END;
         END;
      END;

      A_REPORTDATE = date(1,1,1900);

      IF (SendKind != REQUEST_FULL)
         RS =
         CRSDCommand("SELECT t.T_REPORTDATE AS A_REPORTDATE, MAX(t.T_TFID) AS A_TFID FROM DLTR_FILE_DBT t, DLDEVBKI_DBT l WHERE " +
                              " l.T_CREDITNUMBER_REF = ? " +
                          " AND l.T_BKIID_REF        = ? " +
                          " AND t.T_RESULTLOAD       = ? " +
                          " AND l.T_TFID_REF         = t.T_TFID " +
                          " AND t.T_TFID             < ? " +
                        " GROUP BY t.T_REPORTDATE ORDER BY t.T_REPORTDATE DESC",
                        "CREDITNUMBER", _ObjectNumber,
                        "BKIID",        BkiID,
                        "RESULTLOAD",   0,
                        "TFIF",         TFID,
                        V_GENOBJ);
         IF (RS.MoveNext())
            SendKind = saveSendKind;
            
            // Дата отчета и ID ТФ предыдущей успешной выгрузки
            A_REPORTDATE = SQL_NVL(RS.Value("A_REPORTDATE"), V_DATE);
            A_TFID       = SQL_NVL(RS.Value("A_TFID"),       V_INTEGER);

            IF (A_REPORTDATE > ReportDate)
               InsErrorMessage("Дата отчета должна быть больше:" + (A_REPORTDATE - 1));
               LoansError("Дата отчета должна быть больше:" + (A_REPORTDATE - 1));
               STAT = FALSE;
               CONTINUE;
            END;
         ELSE
            SendKind = REQUEST_FULL;
         END;
      END;

      // Включать ли режим недостающей информации
      crd_regdate      = credit_c.rec.RegDate;
      crd_daterejected = lbki.rec.DateRejected;
      IF (crd_regdate < crd_daterejected)
         Regim_Rejected = true;
      END;

      stat = СформироватьБлоки(ObjectTypeID, ObjectNumber, TFID);

      // Проверим правильность данных в пакетной процедуре формирования КИ
      IF ((TFID == 0) AND (stat == TRUE))
         demo_mode = TRUE;
   
         IF (NOT СЕГМЕНТ_ЗАГОЛОВКА())
            InsErrorMessage("Ошибка формирования сегмента TUTDF");
            CONTINUE;
         END;
   
         IF ((STAT = СФОРМИРОВАТЬСЕГМЕНТЫ(ObjectTypeID, ObjectNumber, 0, SendKind)) == TRUE)
             СЕГМЕНТ_ТРЕЙЛЕР();
         END;
   
         demo_mode = FALSE;
      END;
      SendKind = saveSendKind;
   END;
   RemProgress (count);

   count = LnSelectValue("SELECT COUNT(1) FROM DOBJECT_BKI_TMP WHERE T_OBJECTTYPEID IN (3, 4)", V_INTEGER);
   InitProgress(count, "Стадия обработки...", "Построение виртуальной КИ");
   count = 0;

   SendKind = saveSendKind;
   RS_OBJ = CRSDCommand("SELECT oo.*, LB.T_ACCESSCODE FROM V_OBJECT_BKI oo LEFT OUTER JOIN DLBKICONT_DBT lb "+
                     " ON (oo.T_OBJECTTYPEID = LB.T_OBJECTTYPEID AND oo.T_OBJECTNUMBER = LB.T_OBJECTNUMBER) "+
                     " WHERE oo.T_ORDERNUM = 0 AND oo.T_OBJECTTYPEID IN (3, 4) AND LB.T_BKIID_REF = ? "+
                       " AND oo.T_BKIID = ? ORDER BY oo.T_OBJECTTYPEID, oo.T_OBJECTNUMBER",
                         "p1", BkiID,
                         "p2", BkiID,
                         V_GENOBJ);

   WHILE (RS_OBJ.MoveNext)
      UseProgress (count = count + 1);

      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");
      AccessCode   = SQL_NVL(RS_OBJ.Value("T_ACCESSCODE"), V_STRING);

      // Пока не надо
      stat = СформироватьБлоки(RS_OBJ.Value("T_OBJECTTYPEID"), RS_OBJ.Value("T_OBJECTNUMBER"), TFID);

      stat = TRUE;

      // Проверим правильность данных в пакетной процедуре формирования КИ
      IF ((TFID == 0) AND (stat == TRUE))
         demo_mode = TRUE;
   
         IF (NOT СЕГМЕНТ_ЗАГОЛОВКА())
            InsErrorMessage("Ошибка формирования сегмента TUTDF");
            CONTINUE;
         END;
   
         IF ((STAT = СФОРМИРОВАТЬСЕГМЕНТЫ(RS_OBJ.Value("T_OBJECTTYPEID"), RS_OBJ.Value("T_OBJECTNUMBER"), 0, SendKind)) == TRUE)
            СЕГМЕНТ_ТРЕЙЛЕР();
         END;
   
         demo_mode = FALSE;
      END;
   END;

   IF (TFID == 0)
      ПроверитьДанные(BkiID, TFID, ReportDate);
   END;

   RemProgress (count);
   EndAction();

   IF (TFID == 0)
      RETURN TRUE;
   ELSE
      RETURN STAT;
   END;
END;

////////////////////////////////////////////////////////////////////////////////
//
// Функция вызывается из Сишника, при индивидуальной передаче информации
// Параметры:
//    TFID         - ID Транспортного файла
//    BkiID        - ID БКИ
//    CreditNumber - ID Договора
//    SendKind     - Вид передачи (2 - Полная    КИ)
//    Path         - Путь
//    FileName     - Имя файла
//    _ObjectTypeID - Вид объекта
//    _ObjectNumber - Номер объекта
MACRO СформироватьТранспортныйФайл(TFID: integer, BkiID: Integer, CreditNumber: integer, SendKind: integer, Path: string, FileName: string, StartDate: date, _ObjectTypeID: integer, _ObjectNumber: integer)
   VAR STAT: BOOL = TRUE, ID = 0, FLAG = 0, RS = NULL, MSG, RegDate = NULL, isCess:BOOL = FALSE;
   VAR ЭЦП    = RsCryptoAPI();
   LnSqlExec("DELETE FROM DREZ_ERR_TMP");
   IF (_ObjectTypeID == LO_ENSCONTR)
      VAR RS_END = CRSDCommand("SELECT e.T_ENSCONTRACTFIRSTDATE, "+
                                     " t.T_SYSTYPEENSID_REF, "+
                             " NVL ( (SELECT MAX (T_REGDATE) "+
                        " FROM DCREDIT_C_DBT CRD JOIN  DENS_CRD_DBT EN "+
                     " ON (CRD.T_CREDITNUMBER = EN.T_CREDITNUMBER_REF) "+
               " WHERE EN.T_ENSCONTRACTID_REF = E.T_ENSCONTRACTID), TO_DATE ('01.01.0001', 'dd.mm.yyyy')) "+
          " AS T_REGDATE "+
     " FROM DENSCONTR_DBT e, DTYPE_ENS_DBT t "+
     " WHERE E.T_ENSCONTRACTID = ? AND E.T_ENSSYSTYPE = t.T_TYPEENSID",
                                     "p1", _ObjectNumber,
                                    V_GENOBJ);
      RS_END.MoveNext();
      RegDate =  RS_END.Value("T_ENSCONTRACTFIRSTDATE");

      IF (RS_END.Value("T_SYSTYPEENSID_REF") != 1)
         LoansError("Формирование ТФ возможно только по договорам поручительства");
         RETURN FALSE;

      ELIF (RegDate > ReportDate)
         LoansError("Дата начала ДО больше даты формирования КИ");
         RETURN FALSE;

      ELIF (RegDate < date(01,03,2015))
         LoansError("Запрещена передача КИ по ДО, введенным до 01.03.2015");
         RETURN FALSE;

      ELIF (SQL_NVL(RS_END.Value("T_REGDATE"), V_DATE) < date(01,07,2014))
         LoansError("Запрещена передача КИ по Договорам заключенным до 01.07.2014");
         RETURN FALSE;

      END;

   ELIF (_ObjectTypeID == LO_CLAIM)
      VAR RS_CLM = CRSDCommand("SELECT clm.T_GIVINGDATE, PT.T_LEGALFORM, CLM.T_CLAIMKIND, crd.T_REGDATE, GREATEST(T_APPROVALDATE, T_REJECTIONDATE) AS T_STATUSDATE" +
                                " FROM DCLAIM_DBT clm JOIN DPARTY_DBT pt ON (CLM.T_LOANERID_REF = PT.T_PARTYID) " +
                                " LEFT OUTER JOIN DCREDIT_C_DBT crd ON (CLM.T_CREDITNUMBER_REF = crd.T_CREDITNUMBER) " +
                                " WHERE clm.T_CLAIMID = ?",
                                "p1", _ObjectNumber,
                               V_GENOBJ);
      RS_CLM.MoveNext();

      IF ((SQL_NVL(RS_CLM.Value("T_LEGALFORM"), V_INTEGER) != 2) 
           OR
          ((SQL_NVL(RS_CLM.Value("T_CLAIMKIND"), V_INTEGER) != 0) AND (SQL_NVL(RS_CLM.Value("T_CLAIMKIND"), V_INTEGER) != 2)))
         LoansError("Формирование ТФ возможно только по кредитным заявкам физических лиц!");
         RETURN FALSE;

      ELIF (SQL_NVL(RS_CLM.Value("T_GIVINGDATE"), V_DATE) > ReportDate)
         LoansError("Дата начала Заявки больше даты формирования КИ");
         RETURN FALSE;

      ELIF (ReportDate < date(01,03,2015))
         LoansError("По КЗ ТФ формируется начиная с 01.03.2015");
         RETURN FALSE;

      ELIF (
            (ValType(RS_CLM.Value("T_REGDATE")) != V_SPECVAL)
        AND (SQL_NVL(RS_CLM.Value("T_GIVINGDATE"), V_DATE) < date(01,07,2014))
           )
         LoansError("По КЗ ТФ формируется начиная с 01.03.2015 по тем заемщикам - физическим лицам, которые заключили кредитные договоры с 01.07.2014 года");
         RETURN FALSE;
      END;

      RegDate = RS_CLM.Value("T_GIVINGDATE");

   ELSE
      VAR RS_CRD = CRSDCommand("SELECT T_REGDATE FROM DCREDIT_C_DBT WHERE " + 
                                     " T_CREDITNUMBER = ? ",
                                 "p1", _ObjectNumber,
                                  V_GENOBJ);
      RS_CRD.MoveNext();

      RegDate = RS_CRD.Value("T_REGDATE");
      IF (RegDate > ReportDate)
         LoansError("Дата начала Договора больше даты формирования КИ");
         RETURN FALSE;
      END;
   END;

   Path = TRIM(Path) + "\\" + TRIM(FileName) + ".";
   ltr_file.rec.TFID = TFID;
   IF (NOT ltr_file.getEQ())
      LoansError("Не найден транспортный файл №" + TFID);
      RETURN FALSE;
   END;
   ReportDate = ltr_file.rec.ReportDate;

   IF ((RegDate < date(01,07,2014)) AND (_ObjectTypeID != LO_ENSCONTR))

      IF (_ObjectTypeID == LO_CLAIM)
         ID = CRSDCommand("SELECT MAX(T_ID) FROM DLCONSDEV_DBT WHERE T_CLAIMID_REF = ? AND T_CHANGEDATE <= ?",
                       "p1", _ObjectNumber,
                       "p2", ReportDate,
                      V_INTEGER);
      ELSE
         ID = CRSDCommand("SELECT MAX(T_ID) FROM DLCONSDEV_DBT WHERE T_CREDITNUMBER_REF = ? AND T_CHANGEDATE <= ?",
                       "p1", CreditNumber,
                       "p2", ReportDate,
                      V_INTEGER);
      END;

      IF (ID > 0)
         // Флаг согласия на передачу КИ
         FLAG = CRSDCommand("SELECT T_FLAG FROM DLCONSDEV_DBT WHERE T_ID = ?",
                            "p1", ID,
                           V_STRING);
   
         IF ((Flag != "X") AND ((SendKind == REQUEST_CHNG) OR (SendKind == REQUEST_FULL)))
            LoansError("Нет согласия заемщика на передачу КИ");
            RETURN FALSE;
         END;
   
         IF ((Flag == "X") AND (SendKind == REQUEST_DEL))
            LoansError("Нельзя передавать запрос на удаление КИ в БКИ | так как заемщик согласен на передачу КИ");
            RETURN FALSE;
         END;
   
         IF ((Flag != "X") AND (SendKind == REQUEST_DEL))
            ID = CRSDCommand("SELECT MAX(T_ID) FROM DLDEVBKI_DBT WHERE T_CREDITNUMBER_REF = ? AND T_SENDDATE <= ?",
                             "p1", CreditNumber,
                             "p2", {CURDATE},
                            V_INTEGER);
   
            IF (ID == 0)
               LoansError("Нельзя передавать запрос на удаление КИ | так как передачи в БКИ еще не было");
               RETURN FALSE;
            END;
         END;
      ELSE
         IF ((SendKind == REQUEST_CHNG) OR (SendKind == REQUEST_FULL))
            LoansError("Нет согласия заемщика на передачу КИ!");
            RETURN FALSE;
         END;
   
         IF (SendKind == REQUEST_DEL)
            LoansError("Нельзя передавать запрос на удаление КИ \n так как передачи в БКИ еще не было");
            RETURN FALSE;
         END;
      END;
   END;

   IF (_ObjectTypeID == LO_CREDIT)
      var countCess = 0; 
      countCess =  CRSDCommand("SELECT COUNT (*) FROM dcrdlink_dbt lnk WHERE LNK.T_TYPEPARENT = ? AND LNK.T_OBJECTTYPEID = ? AND LNK.T_OBJECTNUMBER = ?",
                       "p1", LO_DOGCREDCLAIMBUY,
                       "p2", LO_CREDIT,
                       "p3", CreditNumber,
                      V_INTEGER);
      IF (countCess >0)
         isCess = TRUE;
      ELSE
         isCess = FALSE;
      END;
   END;

   IF ((_ObjectTypeID == LO_ENSCONTR) OR (_ObjectTypeID == LO_GUARANTEE) OR ((_ObjectTypeID == LO_CREDIT) AND (isCess)))
      IF (RegDate < date(01,03,2015))

         VAR VOBJ = CRSDCommand("SELECT T_SHORTNAME FROM DLOBJECT_DBT WHERE T_OBJECTID = ?",
                                "p1", _ObjectTypeID,
                               V_STRING);
         IF (_ObjectTypeID == LO_CREDIT)
            VOBJ = "КД, приобретенным по договору уступки";
         ELIF (_ObjectTypeID == LO_CLAIM)
            VOBJ = "Заявкам";
         END;

         LoansError("Запрещена передача КИ по " + VOBJ + ", введенным до 01.03.2015");
         RETURN FALSE;
      END;
   END;

   IF (NOT СформироватьВиртуальнуюИсторию(BkiID, CreditNumber, SendKind, TFID, {curdate}, "", _ObjectTypeID, _ObjectNumber))
      LoansError("КИ не изменилась!");
      RETURN FALSE;
   END;
   //Path = ToANSI(Path); 139278 
/*
   IF (0 <
       CRSDCommand("SELECT COUNT(1) FROM DREZ_ERR_TMP WHERE T_OBJECTID = ? AND T_OBJECTNUMBER = ?",
               "p1", _ObjectTypeID,
               "p2", _ObjectNumber,
              V_INTEGER))
      LoansError("Ошибки формирования КИ!");

      RETURN TRUE;
   END;
*/
   SetDelim("");

   // Открыть главный файл
   IF (NOT Open(fMainTXT, Path,"rsansi"))
      LoansError("Не найден файл: " + Path);
      RETURN FALSE;
   END;

   //LnSqlExec("DELETE FROM DREZ_ERR_TMP");
   IF (NOT СЕГМЕНТ_ЗАГОЛОВКА())
      InsErrorMessage("Ошибка формирования сегмента TUTDF");
      RETURN FALSE;
   END;

   ПроверитьДанные(BkiID, TFID, ReportDate);

   VAR RS_OBJ = CRSDCommand("SELECT oo.*, LB.T_ACCESSCODE FROM V_OBJECT_BKI oo LEFT OUTER JOIN DLBKICONT_DBT lb "+
                            " ON (oo.T_OBJECTTYPEID = LB.T_OBJECTTYPEID AND oo.T_OBJECTNUMBER = LB.T_OBJECTNUMBER)  "+
                          " WHERE oo.T_ORDERNUM = 0 AND oo.T_OBJECTTYPEID NOT IN (3, 4) AND LB.T_BKIID_REF = ? "+
                            " AND oo.T_BKIID = ? ORDER BY oo.T_OBJECTTYPEID, oo.T_OBJECTNUMBER",
                            "p1", BkiID,
                            "p2", BkiID,
                            V_GENOBJ);
   var flag_change_KI   = 0; //Проверяем были изменения или нет. если были объекты(они удаляются если не подошло), то значит КИ менялось.
   WHILE (RS_OBJ.MoveNext)
      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");
      AccessCode   = SQL_NVL(RS_OBJ.Value("T_ACCESSCODE"), V_STRING);
      flag_change_KI = 1;   //Были какие то изменения в КД.
      STAT = TRUE;

      credit_c.rec.CreditNumber = RS_OBJ.Value("T_CREDITNUMBER"); 
      credit_c.GetEQ();

      ObjectNumber = credit_c.rec.CreditNumber;
      ObjectTypeID = credit_c.rec.Crd_kind;

      STAT = СФОРМИРОВАТЬСЕГМЕНТЫ(ObjectTypeID, ObjectNumber, TFID, SendKind);
   END;

   RS_OBJ = CRSDCommand("SELECT oo.*, LB.T_ACCESSCODE FROM V_OBJECT_BKI oo LEFT OUTER JOIN DLBKICONT_DBT lb "+
                            " ON (oo.T_OBJECTTYPEID = LB.T_OBJECTTYPEID AND oo.T_OBJECTNUMBER = LB.T_OBJECTNUMBER)  "+
                          " WHERE oo.T_ORDERNUM = 0 AND oo.T_OBJECTTYPEID IN (3, 4) AND LB.T_BKIID_REF = ? "+
                            " AND oo.T_BKIID = ? ORDER BY oo.T_OBJECTTYPEID, oo.T_OBJECTNUMBER",
                            "p1", BkiID,
                            "p2", BkiID,
                         V_GENOBJ);

   WHILE (RS_OBJ.MoveNext)
      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");
      AccessCode   = SQL_NVL(RS_OBJ.Value("T_ACCESSCODE"), V_STRING);
      IF ((SendKind == REQUEST_FULL) OR
          (SendKind == REQUEST_DEL) OR
          (SendKind  == REQUEST_CHNG))
            STAT = СФОРМИРОВАТЬСЕГМЕНТЫ(RS_OBJ.Value("T_OBJECTTYPEID"), RS_OBJ.Value("T_OBJECTNUMBER"), TFID, SendKind);
        flag_change_KI = 1;   //Были какие то изменения в ДО.
      END;      
   END;

   IF (flag_change_KI == 0)
      LoansError("КИ не изменилась!");
      // InsErrorMessage("КИ не изменилась!");
      RETURN FALSE;
   END;

   IF (STAT == TRUE)
      СЕГМЕНТ_ТРЕЙЛЕР();
   END;


   Close(fMainTXT);

/*
   // Наложение ЭЦП. !!! НЕ УДАЛЯТЬ !!!
   IF (ЭЦП.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", Path))
      LoansError("Файл подписан успешно!");
   ELSE
      LoansError("Ошибка при наложении ЭЦП.|" + ЭЦП.GetErrorDescription);
   END;
*/
   RETURN TRUE;
END;


////////////////////////////////////////////////////////////////////////////////
//
// Функция вызывается из Сишника, при пакетной передаче информации
// Параметры:
//    TFID         - ID Транспортного файла
//    BkiID        - ID БКИ
//    PartyID      - ID Заемщика
//    SendKind     - Вид передачи (2 - Полная    КИ)
//    Path         - Путь
//    FileName     - Имя файла
//
MACRO СформироватьТранспортныйФайл_ГрупповойРежим(TFID: integer, BkiID: Integer, SendKind: integer, Path: string, FileName: string)
   VAR change: bool = FALSE,
       stat  : bool = FALSE,
       count : integer = 0;
   VAR ЭЦП    = RsCryptoAPI();

   Path = TRIM(Path) + "\\" + TRIM(FileName) + ".";

   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №" + BkiID);
      RETURN FALSE;
   END;

   IF (TFID == 0)
      demo_mode = TRUE;
   ELSE
      demo_mode = FALSE;
      LnSqlExec("DELETE FROM DREZ_ERR_TMP");
   END;
  
   // Подчищаем перед формированием  
   LnSQLExec  ("DELETE FROM DNBKI_TMP");

   ltr_file.rec.TFID = TFID;
   IF (NOT ltr_file.getEQ())
      LoansError("Не найден транспортный файл №" + TFID);
      RETURN FALSE;
   END;
   ReportDate = ltr_file.rec.ReportDate;

   //Path = ToANSI(Path); 139278

   SetDelim("");

   // Открыть главный файл
   IF (NOT Open(fMainTXT, Path,"rsansi"))
      LoansError("Не найден файл: " + Path);
      RETURN FALSE;
   END;

   IF (NOT СЕГМЕНТ_ЗАГОЛОВКА())
      InsErrorMessage("Ошибка формирования сегмента TUTDF");
      RETURN FALSE;
   END;

   count = LnSelectValue("SELECT COUNT(1) FROM V_OBJECT_BKI WHERE T_ORDERNUM = 0 AND T_OBJECTTYPEID NOT IN (3, 4)", V_INTEGER);
   LoansPutIndic(count, "Стадия обработки...", "Построение виртуальной КИ");
   count = 0;

   VAR RS_OBJ = CRSDCommand("SELECT oo.*, LB.T_ACCESSCODE FROM V_OBJECT_BKI oo, DLBKICONT_DBT lb WHERE " +
                                  " oo.T_ORDERNUM = 0 " +
                              " AND oo.T_OBJECTTYPEID NOT IN (3, 4) " +
                              " AND oo.T_BKIID = ? " +
                              " AND LB.T_BKIID_REF    = ? " +
                              " AND LB.T_OBJECTTYPEID = oo.T_OBJECTTYPEID " +
                              " AND LB.T_OBJECTNUMBER = OO.T_OBJECTNUMBER " +
                              " ORDER BY oo.T_OBJECTTYPEID, oo.T_OBJECTNUMBER",
                            "p1", BkiID,
                            "p2", BkiID,
                            V_GENOBJ);

   WHILE (RS_OBJ.MoveNext)
      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");

      credit_c.rec.CreditNumber = RS_OBJ.Value("T_CREDITNUMBER");
      IF (NOT credit_c.GetEQ())
         LoansRemIndic();
         LoansError("Не найден договор №" + RS_OBJ.Value("T_CREDITNUMBER"));
         RETURN FALSE;
      END;

      AccessCode = SQL_NVL(RS_OBJ.Value("T_ACCESSCODE"), V_STRING);

      // Определим тип клиента
      ClientID   = credit_c.rec.ClientID_Ref;
      TypeClient = ТипКлиента(ClientID);
       // Определим является ли клиент нерезидентом
      Client_NotResident = Нерезедент(ClientID);       

      ObjectNumber = credit_c.rec.CreditNumber;
      ObjectTypeID = credit_c.rec.Crd_kind;

      UpdateBlock(ObjectNumber, TFID, ObjectTypeID, ObjectNumber);
      СФОРМИРОВАТЬСЕГМЕНТЫ(ObjectTypeID, ObjectNumber, TFID, SendKind);

      LoansUseIndic(count = count + 1);
   END;
   LoansRemIndic();

   count = LnSelectValue("SELECT COUNT(1) FROM V_OBJECT_BKI WHERE T_ORDERNUM = 0 AND T_OBJECTTYPEID IN (3, 4)", V_INTEGER);
   LoansPutIndic(count, "Стадия обработки...", "Построение виртуальной КИ");
   count = 0;

   RS_OBJ = CRSDCommand("SELECT oo.*, LB.T_ACCESSCODE FROM V_OBJECT_BKI oo LEFT OUTER JOIN DLBKICONT_DBT lb "+
                     " ON (oo.T_OBJECTTYPEID = LB.T_OBJECTTYPEID AND oo.T_OBJECTNUMBER = LB.T_OBJECTNUMBER) "+
                     " WHERE oo.T_ORDERNUM = 0 AND oo.T_OBJECTTYPEID IN (3, 4) AND LB.T_BKIID_REF = ? "+
                       " AND oo.T_BKIID = ? ORDER BY oo.T_OBJECTTYPEID, oo.T_OBJECTNUMBER",
                         "p1", BkiID,
                         "p2", BkiID,
                         V_GENOBJ);

   WHILE (RS_OBJ.MoveNext)
      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");
      AccessCode   = SQL_NVL(RS_OBJ.Value("T_ACCESSCODE"), V_STRING);

      UpdateBlock(0, TFID, ObjectTypeID, ObjectNumber);

      STAT = СФОРМИРОВАТЬСЕГМЕНТЫ(RS_OBJ.Value("T_OBJECTTYPEID"), RS_OBJ.Value("T_OBJECTNUMBER"), TFID, SendKind);
      LoansUseIndic(count = count + 1);
   END;
   LoansRemIndic();

   СЕГМЕНТ_ТРЕЙЛЕР();

   Close(fMainTXT);

/*
   // Наложение ЭЦП. !!! НЕ УДАЛЯТЬ !!!
   IF (ЭЦП.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", Path))
      LoansError("Файл подписан успешно!");
   ELSE
      LoansError("Ошибка при наложении ЭЦП.|" + ЭЦП.GetErrorDescription);
   END;
*/
   RETURN TRUE;
END;

////////////////////////////////////////////////////////////////////////////////
// ПРИНЯТЬ КВИТАНЦИЮ БКИ
//
// Параметры:
//   BkiID       - ID БКИ
//   ReceptKind  - Тип квитанции
//   Path        - Путь
//   FileName    - Имя файла
MACRO ПринятьКвитанцию(BkiID: integer, ReceptKind: integer, Path: string, FileName: string)
   FILE ReceptFile() TXT;
   VAR ltr_file = TBFile ("ltr_file.dbt", "w", 0);
   VAR OriginalFileName : string  = "",
       ReceiveDate      : date    = date(0,0,0),
       ReceiveTime      : time    = time(0,0,0),
       NameCheck        : string  ="",
       Descryption      : string  ="",
       Extract          : string  ="",
       SignatureCheck   : string  ="",
       FormatCheck      : string  ="",
       AcceptedRecords  : integer = 0,
       LoadedRecords    : integer = 0,
       RejectedRecords  : integer = 0,
       RejectFile       : string  ="",
       TFID             : integer = 0;

   // Получить дату из строки в формате ДДММГГ
   MACRO GetReceptDate(value: string)
      VAR day : integer = 0,
          mon : integer = 0,
          year: integer = 0;

      year = SubStr(value, 1, 4);
      mon  = SubStr(value, 5, 2);
      day  = SubStr(value, 7, 2);

      RETURN date(day, mon, year);
   END;

   // Получить время из строки ЧМС
   MACRO GetReceptTime(value: string)
      VAR hour : integer = 0,
          min  : integer = 0,
          sec  : integer = 0;

      hour = SubStr(value,  9, 2);
      min  = SubStr(value, 11, 2);
      sec  = SubStr(value, 13, 2);

      RETURN time(hour, min, sec);
   END;

   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №"+BkiID);
      RETURN FALSE;
   END;

   IF (Index(FileName, ".") == 0)
      IF (NOT Open(ReceptFile, Path + "\\" + FileName + "."))
         LoansError("Ошибка открытия файла | " + Path + "\\" + FileName);
         RETURN FALSE;
      END;
   ELSE
      IF (NOT Open(ReceptFile, Path + "\\" + FileName))
         LoansError("Ошибка открытия файла | " + Path + "\\" + FileName);
         RETURN FALSE;
      END;
   END;

   SetDelim("\t", ReceptFile);

   // Обработка квитанции
   WHILE (Next(ReceptFile))
      IF   (trim(ReceptFile(0)) == "OriginalFileName")
         OriginalFileName = trim(ReceptFile(1)); // ToOEM() 139278 
      ELIF (trim(ReceptFile(0)) == "ReceiveDateTime")
         ReceiveDate      = GetReceptDate(trim(ReceptFile(1)));
         ReceiveTime      = GetReceptTime(trim(ReceptFile(1)));
      ELIF (trim(ReceptFile(0)) == "Name check result")
         NameCheck        = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "Decryption result")
         Descryption      = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "Extract result")
         Extract          = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "Signature check result")
         SignatureCheck   = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "Format check result")
         FormatCheck      = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "AcceptedRecords")
         AcceptedRecords  = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "LoadedRecords")
         LoadedRecords    = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "RejectedRecords")
         RejectedRecords  = trim(ReceptFile(1));
      ELIF (trim(ReceptFile(0)) == "RejectFile")
         RejectFile       = trim(ReceptFile(1));
      END;
   END;

      // Найдем транспортный файл
      TFID = LnSelectValue("SELECT T_TFID FROM DLTR_FILE_DBT WHERE " +
                                 " T_FILENAME  = " + SQLString(OriginalFileName) +
                             " AND T_BKIID_REF = " + BkiID, V_INTEGER);
      ltr_file.rec.TFID = TFID;
      IF ((NOT ltr_file.GetEQ()) OR (ltr_file.rec.TFID != TFID))
         LoansError("Не найдет транспортный файл: " + OriginalFileName);
         RETURN FALSE;
      END;

      // Все в порядке
      IF  ((NameCheck       == "OK") AND
           (Descryption     == "OK") AND
           (Extract         == "OK") AND
           (SignatureCheck  == "OK") AND
           (FormatCheck     == "OK"))
         // Успешно
         ltr_file.rec.ResultLoad =  0;
         ltr_file.rec.DateLoad = ReceiveDate;

      LnSqlExec("UPDATE DLDEVBKI_DBT TL SET TL.T_RESULT = '+' WHERE TL.T_TFID_REF = " + TFID); 
      ELIF ((NameCheck      == "FAIL") OR
            (NameCheck      == "NODATA"))
         // Ошибка в имени ТФ
         ltr_file.rec.ResultLoad =  9;

      ELIF ((Descryption    == "FAIL") OR
            (Descryption    == "NODATA"))
         // Ошибки шифрования
         ltr_file.rec.ResultLoad = 10;

      ELIF ((Extract        == "FAIL") OR
            (Extract        == "NODATA"))
         // Ошибки архивирования
         ltr_file.rec.ResultLoad = 11;

      ELIF ((SignatureCheck == "FAIL") OR
            (SignatureCheck == "NODATA"))
         // Некорректная ЭЦП или ЭЦП отсутствует
         ltr_file.rec.ResultLoad =  1;
      ELIF ((FormatCheck    == "FAIL") OR
            (FormatCheck    == "NODATA"))
         // Ошибки формата
         ltr_file.rec.ResultLoad = 12;
      END;
      ltr_file.Update();

   Close(ReceptFile);

   LoansError("Прием квитанции прошел успешно");
   RETURN TRUE;
END;

MACRO ОбработкаКвитанции(Dir: string, FileName: string)

   FILE ReceptFile() TXT;
   VAR  Number: string  = "",
       Segment: string  = "",
     NumberRec: string  = "",
     CodeError: string  = "",
     error_msg: string  = "",
    ClientName: string  = "",
       Field  : integer = "",
        found : bool    = FALSE,
     rs = NULL;

   LnSqlExec("DELETE FROM DREZ_ERR_TMP");

   IF (Index(FileName, ".") == 0)      // 125603
      IF ((NOT Open(ReceptFile, Dir + "\\" + FileName + "_reject"+ ".", "rsansi")) AND 
          (NOT Open(ReceptFile, Dir + "\\" + FileName + ".", "rsansi")))
            LoansError("Файл " + Dir+ "\\"+FileName+ "." + " не найден!");
            RETURN FALSE;
      END;
   END;

   WHILE (Next(ReceptFile))

      Var ZeroPos = StrUpr(TRIM(ReceptFile[0])); // 224210
      VAR TwoPos  = TRIM(ReceptFile[2]);

      IF(TRIM(ReceptFile[1]) == "INVALID")
         error_msg = "Полученная сумма символов во всех полях сегмента превышает максимально допустимую.";
           
      // Номер КД
      ELIF  ((Index(ZeroPos, "TR") != 0) AND (ZeroPos != "TRLR"))
         ObjectNumber = 0;
         ObjectTypeID = 0;
        
         rs = CRSDCommand("SELECT T_CREDITNUMBER, T_CRD_KIND FROM DCREDIT_C_DBT WHERE T_USCREDITNUMBER = ?",
                          "p1", SQLString(TwoPos), 
                          V_GENOBJ);
         IF ((rs != NULL) AND rs.MoveNext() AND (rs.value(0, null, V_INTEGER) != NULL)
                                            AND (rs.value(1, null, V_INTEGER) != NULL))
            ObjectNumber = rs.value(0, null, V_INTEGER);
            ObjectTypeID = rs.value(1, null, V_INTEGER);
         END;
        
         IF ((ObjectNumber == 0) AND (ObjectTypeID == 0))
            ObjectNumber = -1;
            ObjectTypeID = -1;
         END;

      // Заемщик
      ELIF((Index(ZeroPos, "NA") != 0) OR
           (Index(ZeroPos, "BU") != 0))

         ClientID = CRSDCommand("SELECT T_PARTYID FROM DPARTY_DBT WHERE T_NAME = ?",
                                "p1", SQLString(TRIM(ReceptFile[1])), 
                               V_INTEGER);
         IF (ClientID == 0)
             ClientID = -1;
         END;

      // Сегмент ошибки
      ELIF (ZeroPos == "ERROR")
         found = TRUE;
         // Порядковый номер записи в исходном файле TUTDF, содержащей отклонённые данные.
         NumberRec = trim(ReceptFile[1]);

         IF   (TwoPos ==  "@NABU") //125603 NAX
            error_msg = "Присутствуют взаимоисключающие сегменты NA и BU или не найдено ни одного корректного сегмента NA или BU";

         //ELIF (TwoPos == "@CREX")
         //   error_msg = "Присутствуют взаимоисключающие сегменты BK, LE, OF или TR";
         ELIF (TwoPos == "@BUPN")
            error_msg = "PN. Не найден рабочий телефон юр. лица";

         ELIF (TwoPos == "@NATR")
            error_msg = "TR. В поле 'Тип счета' указан тип, недопустимый для физического лица";

         ELIF (TwoPos == "@TRID")
            error_msg = "TR. Отношение к счету=юр.лицо допустимо только для ПБЮЛ";

         ELIF (TwoPos == "@NAID")
            error_msg = "ID. Не найдены обязательные документы для физ.лица";

         ELIF (TwoPos == "@NAAD")
            error_msg = "AD. Не найдены адреса прописки и проживания для физ.лица";

         ELIF (TwoPos == "@BUID")
            error_msg = "ID. Не найдены ОГРН и ИНН, обязательные для юр.лица";

         ELIF (TwoPos == "@BUAD")
            error_msg = "AD. Не найдены юридический и фактический адреса, обязательные для юр.лица";

         ELIF (TwoPos == "@NADB")
            error_msg = "Дата выдачи в сегменте ID меньше даты рождения в сегменте NA";

         ELIF (TwoPos == "@NAAO")
            error_msg = "Дата рождения в сегменте NA не прошла проверку на допустимый возраст на дату открытия счета сегмента TR. Текущее ограничение - от 14 до 110 лет.";

         ELIF (TwoPos == "@RDHD")
            error_msg = "Дата отчета в сегменте TR, LE, BK или OF должна быть между: датой рождения сегмента NA/19000102 и Датой отчета сегмента TUTDF";

         ELIF (TwoPos == "@RDSS")
            error_msg = "В сегменте TR Дата состояния счета позднее Даты составления отчета";

         ELIF (TwoPos == "@NAYR")
            error_msg = "Паспорт РФ не может быть выдан в возрасте ранее 14 лет.";

         ELIF (TwoPos == "@RDPD")
            error_msg = "В сегменте TR если Состояние счета (Account Rating) = 21 (Спор), 52 (Просрочен) или 61 (Проблемы с возвратом), поле Просрочка не может быть равна 0.";

         ELIF (TwoPos == "@RDDT")
            error_msg = "Паспорт РФ не может иметь дату выдачи ранее 01.01.1997";

         ELIF (TwoPos == "@RDCF")
            error_msg = "Недопустимый код валюты в сегменте TR";

         ELIF (TwoPos == "@CRED")
            error_msg = "Не найден хотя бы один из сегментов BK, LE, IP или TR";
            InsErrorMessage(error_msg);
            error_msg = "";

            IF (TRIM(ReceptFile[5]) == "1-I")
               error_msg = "Неверное число полей в сегменте " + TRIM(ReceptFile[4]);
            END;

         // Сегмент не найден
         ELIF (Index(TwoPos, "@") != 0)
            Segment = SubStr(TwoPos, 2, 2);

            IF (TRIM(ReceptFile[3]) == "1-I")
               error_msg = "Отсутсвует обязательный сегмент " + Segment;

            ELIF ((TRIM(ReceptFile[3]) == "1-I") )  // 154458   
               error_msg = "Сегмент " + Segment + "содержит неверное число полей / отсутсвует .";
            ELSE
               error_msg = Segment + ". Сегмент не найден";
            END;

         ELSE
            // Две первые позиции - сегмент и порядковый номер записи с ошибкой
            Segment = SubStr(TwoPos, 1, 2);
            Number  = SubStr(TwoPos, 3, 2);

            // Номер поля с ошибкой
            // 0 - Отсутствует обязательный сегмент
            Field   = int(SubStr(trim(ReceptFile[3]), 1, 1));

            // Код ошибки (M, I, W, Q)
            CodeError= SubStr(trim(ReceptFile[3]), 3, 1);

            IF (Field == 0)
               IF (CodeError == "M")
                  error_msg = TwoPos + " Отсутствует обязательный сегмент";

               ELIF (CodeError == "Q")
                  error_msg = TwoPos + " Пробелы в названии сегмента";
               END;
            ELSE
              IF   (CodeError == "M")
                  error_msg = TwoPos + " Отсутствует значение обязательного поля";
              ELIF (CodeError == "I")
                  error_msg = TwoPos + " Неверный формат обязательного поля";
              ELIF (CodeError == "W")
                  error_msg = TwoPos + " Неверный формат не обязательного поля";
              END;
            END;
         END;
      END;

      IF (error_msg != "")
         InsErrorMessage(error_msg);
         error_msg = "";
      END;
   END;
   Close();

   IF (NOT found)
       LoansError("Ошибок не найдено!");
       RETURN FALSE;
   END;

   RETURN TRUE;
END;

RECORD lbki_rec    ("lbki.dbt");
// Шаблон имени из параметров БКИ
// ФОРМАТ: SSSSSSS
MACRO СформироватьИмяФайла(SendKind: INTEGER)

   VAR ИмяФайла : string  = lbki_rec.TemplateName,
       str_day  : string  = "00", str_mon  : string  = "00",
       str_hour : string  = "00", str_min  : string  = "00", str_sec  : string  = "00",
           day  : integer = 0, mon : integer = 0, year  : integer = 0,
          hour  : integer = 0, min : integer = 0, sec   : integer = 0;

   IF (Index(lbki_rec.TemplateName, "XXXXXXXXXXXX") != 0)
      ИмяФайла = lbki_rec.SourceID;
   ELSE
      ИмяФайла = "XXXXXXXXXXXX";
   END;
   ИмяФайла = ИмяФайла + "_";

   IF (Index(lbki_rec.TemplateName, "YYYYMMDD") != 0)
      DateSplit({curdate}, day, mon, year);

      StrSet(str_day, 3 - strlen(string(day)), string(day));
      StrSet(str_mon, 3 - strlen(string(mon)), string(mon));

      ИмяФайла = ИмяФайла + string(year) + str_mon + str_day;
   ELSE
      ИмяФайла = ИмяФайла + "YYYYMMDD";
   END;
   ИмяФайла = ИмяФайла + "_";

   IF (Index(lbki_rec.TemplateName, "HHMMSS") != 0)
      TimeSplit(time, hour, min, sec);

      StrSet(str_hour, 3 - strlen(string(hour)), string(hour));
      StrSet(str_min,  3 - strlen(string(min)),  string(min));
      StrSet(str_sec,  3 - strlen(string(sec)),  string(sec));

      ИмяФайла = ИмяФайла + str_hour + str_min + str_sec;
   ELSE
      ИмяФайла = ИмяФайла + "HHMMSS";
   END;

   RETURN ИмяФайла;
END;
