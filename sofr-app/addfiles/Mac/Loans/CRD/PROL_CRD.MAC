/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : prol_crd.mac
 Description : Создание документа по шагу операции (операция пролонгации)

 Programmer  : ROV
 16.07.98    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, total;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record cattype     ("cat_type.dbt", "loans.def");

PRIVATE VAR acc_mac = TBFile ("acc_mac.tmp", "r", 0);

private var {curdate};

macro ВыполнитьШаг (OperDate, Sum, Data)
   var flcusreg = TBFile("lcusreg.dbt", "R", 1, "lcusreg.dbt", "loans.def");

   var DocID:integer = 0;
   var stat:integer = 0;
   var ObjID:integer = 0;
   var ObjN:integer = 0;
   var Query:string;

   acc_mac.rewind;
   acc_mac.Clear();
   acc_mac.rec.AccCategID = CRD_ACC;

   acc_mac.AddFilter("T_AccCategID = " + CRD_ACC + " AND T_Sum > " + $0);

   IF (acc_mac.GetGE() AND (acc_mac.rec.AccCategID == CRD_ACC))
     acc_mac.Prev();

      WHILE (acc_mac.Next())
         ObjID = acc_mac.rec.ObjectTypeID;
         ObjN  = acc_mac.rec.OldObjectNumber;

         if (Loans_FindCatType(0, acc_mac.rec.CatTypeID_Ref, 0, 0, 0, 0, cattype))
             if ((acc_mac.rec.AccountNumber != acc_mac.rec.OldAccountNumber) and (cattype.isMove == "X"))
                Документ.CarrySum = acc_mac.rec.Sum;
                Документ.Debit    = acc_mac.rec.AccountNumber;
                Документ.Credit   = acc_mac.rec.OldAccountNumber;
                Документ.CurCode  = acc_mac.rec.CurCode;
                stat = СоздатьДокумент(Документ, DocID);
                if (stat != 0)
                   return stat;
                end;
             end;
         end;
      END;
   END;
   acc_mac.DropFilter();

   RETURN STAT;
END;
