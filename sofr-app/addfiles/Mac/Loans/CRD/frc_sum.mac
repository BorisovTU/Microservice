IMPORT "total.mac", SbCrdInter;

private VAR  payment_tmp = TBFile ("payment.tmp", "w", 0);
private VAR  planpay_tmp = TBFile ("planpay.tmp", "w", 0);
private VAR  isCredit:bool = false;

MACRO CalcAllSum()
   RETURN  LnSelectValue("select Sum(t_Sum) from dpayment_tmp where t_ParentID != 0 and t_ObjID != -1 and t_ObjN != -1", V_MONEY);
END;


MACRO ReCalcSumFrc()
  if (isCredit)
     LnSqlExec("update dpayment_tmp a set t_Sum = " +
                          " (Select SUM(t_Sum) from DPAYMENT_TMP b where b.t_ParentID = a.t_Reference and" +
                          " t_ObjID != -1 and t_ObjN != -1)" +
                      " WHERE t_ParentID = 0 and t_ObjID = -1 and t_ObjN = -1");

     LnSqlExec("update dpayment_tmp a set t_Sum = " +
                          " (Select SUM(t_Sum) from DPAYMENT_TMP b where b.t_Reference = a.t_Reference and " +
                          " b.t_ParentID = a.t_ParentID and t_ObjID != -1 and t_ObjN != -1) " +
                      " where t_ParentID != 0 and t_ObjID = -1 and t_ObjN = -1");
  else
     LnSqlExec("update dpayment_tmp a set t_Sum = " +
                          " (Select SUM(t_Sum) from DPAYMENT_TMP b where b.t_ParentID = a.t_Reference and" +
                          " t_ObjID != -1 and t_ObjN != -1)" +
                      " WHERE t_ParentID = 0 and t_ObjID != -1 and t_ObjN != -1");
  end;
END;

macro CalcExpPercFrc(OpDate)
var RateID:integer,
    query:string,
    Dnac:date;
    record rlcusrate("lcusrate.dbt", "loans.def");

    /*ID αβ Ά¨*/
    IF (Loans_FindLCUR(payment_tmp.rec.ObjID, payment_tmp.rec.ObjN, TRU_CRD, 0, rlcusrate))
        RateID = rlcusrate.RateID_Ref;
    END;

    query = "select Sum(t_CalcPercent) from dplanpay_tmp where ";
    query = query + " t_Marker = 'X'";
    query = query + " and t_RateID = " + RateID;
    query = query + " and t_Date < " + SQLDate(OpDate);

    payment_tmp.rec.Sum = LnSelectValue(query, V_MONEY);

    query = "select MAX(t_Date) from dplanpay_tmp where ";
    query = query + " t_Marker = 'X'";
    query = query + " and t_RateID = " + RateID;
    query = query + " and t_Date < " + SQLDate(OpDate);

    Dnac = LnSelectValue(query, V_DATE);

    payment_tmp.rec.Sum = payment_tmp.rec.Sum + αβ β®¥£¨αβΰ (payment_tmp.rec.ObjID, payment_tmp.rec.ObjN, TDR_EXPPERC, Dnac);
    payment_tmp.rec.Sum = payment_tmp.rec.Sum + αβ β®¥£¨αβΰ (payment_tmp.rec.ObjID, payment_tmp.rec.ObjN, TDR_CLAIM, Dnac);
    payment_tmp.update;
end;


MACRO CalcPercentFrc(OpDate:date, PercDate:date, Marker:bool)
    VAR RSDcmd = RsdCommand(RslDefCon, "begin Loansuserfunction.calc_prognosis(?,?,?); end;");

    RSDcmd.addParam("opdate",   RSDBP_IN);  RSDcmd.value("opdate") = OpDate;
    RSDcmd.addParam("percdate", RSDBP_IN);  RSDcmd.value("percdate") = PercDate;
    RSDcmd.addParam("marker", RSDBP_IN);
    IF (Marker)
      RSDcmd.value("marker") = "X";
    ELSE
      RSDcmd.value("marker") = " ";
    END;
    RSDcmd.execute();

    ReCalcSumFrc();
    RETURN true;
END;

MACRO FillPaymentForAllOper(TypeOp:integer, ObjID:integer, ObjN:integer, OpDate:date, DebtDate:date)
   var cmd:object;
   var typeOpID = 0;
   record typeOpRec(type_op);
   if (Loans_FindTypeOp(TypeOp, 0, typeOpRec) != 0)
      typeOpID = typeOpRec.typeOperID; 
   end;
   cmd = RsdCommand(RslDefCon, "begin ? := Loansfillpayment.fillpaymentforalloper(?,?,?,?,?); end;");
   cmd.addParam("stat",   RSDBP_RETVAL, V_INTEGER);
   cmd.addParam("typeop", RSDBP_IN); cmd.value("typeop") = typeOpID;
   cmd.addParam("objid",  RSDBP_IN); cmd.value("objid")  = ObjID;
   cmd.addParam("objn",   RSDBP_IN); cmd.value("objn")   = ObjN;
   cmd.addParam("opdate", RSDBP_IN); cmd.value("opdate") = OpDate;
   cmd.addParam("debtdt", RSDBP_IN); cmd.value("debtdt") = DebtDate;
   cmd.execute();

   return SQL_NVL(cmd.value("stat"), V_INTEGER);
onError
   return 1;
END;

macro GetTypeDefOpr(objK:integer, ObjN:integer, OpSyst:integer, TypeDef:integer)
   var cmd:object;
 
   cmd = RSDCommand ("begin ? := rsi_loans_additional_algo.gettypedefopr(?,?,?,?,?); end;"); 
   cmd.addParam ("typeop",  RSDBP_RETVAL, V_INTEGER);
   cmd.addParam ("ObjK",    RSDBP_IN); cmd.value ("ObjK")    = objK;
   cmd.addParam ("ObjN",    RSDBP_IN); cmd.value ("ObjN")    = ObjN;
   cmd.addParam ("OpSyst",  RSDBP_IN); cmd.value ("OpSyst")  = OpSyst;
   cmd.addParam ("Igdefid", RSDBP_IN); cmd.value ("Igdefid") = 0;
   cmd.addParam ("TypeDef", RSDBP_IN); cmd.value ("TypeDef") = TypeDef;
   cmd.execute();
   
   return cmd.value("typeop");
end;

macro GetTotalDuty(objK:integer, ObjN:integer, OpDate:date, PaymID:integer)
   var cmd:object;
   
   cmd = RSDCommand ("begin ? := loanskernel.getTotalDuty(?,?,?,?); end;"); 
   cmd.addParam ("totalDuty",  RSDBP_RETVAL, /*V_INTEGER*/V_MONEY);
   cmd.addParam ("ObjK",    RSDBP_IN); cmd.value ("ObjK")   = objK;
   cmd.addParam ("ObjN",    RSDBP_IN); cmd.value ("ObjN")   = ObjN;
   cmd.addParam ("OpDate",  RSDBP_IN); cmd.value ("OpDate") = OpDate;
   cmd.addParam ("PaymID",  RSDBP_IN); cmd.value ("PaymID")  = PaymID;
   cmd.execute();
   
   return SQL_NVL(cmd.value("totalDuty"), V_MONEY);
end;

macro FillPaymentCalcResSum(TypeOp:integer, objK:integer, ObjN:integer, OpDate:date, Prior:integer, PaymSum:money)
   var cmd:object;
   
   cmd = RSDCommand ("begin ? := loansfillpayment.fillpaymentcalcressum(?,?,?,?,?,?); end;"); 
   cmd.addParam ("stat",    RSDBP_RETVAL, V_INTEGER);
   cmd.addParam ("TypeOp",  RSDBP_IN); cmd.value ("TypeOp")  = TypeOp;
   cmd.addParam ("ObjK",    RSDBP_IN); cmd.value ("ObjK")    = objK;
   cmd.addParam ("ObjN",    RSDBP_IN); cmd.value ("ObjN")    = ObjN;
   cmd.addParam ("OpDate",  RSDBP_IN); cmd.value ("OpDate")  = OpDate;
   cmd.addParam ("Prior",   RSDBP_IN); cmd.value ("Prior")   = Prior;
   cmd.addParam ("PaymSum", RSDBP_IN); cmd.value ("PaymSum") = PaymSum;
   cmd.execute();
   
   return SQL_NVL(cmd.value("stat"), V_INTEGER);
end;

MACRO FillFileFrc(ObjID:integer, ObjN:integer, OpDate:date, EndDate:date, Marker:bool, AddPrc :integer)
   VAR TypeOp = GetTypeDefOpr(ObjID, ObjN, CS_DUTY, 2);

   IF (TypeOp == 0) 
      RETURN FALSE;
   END;
    
   FillPaymentForAllOper(TypeOp, ObjID, ObjN, OpDate, EndDate);

   RETURN TRUE;
END;


MACRO FillFileForCreditFrc(ObjID:integer, ObjN:integer, OpDate:date, EndDate:date, Marker:bool, AddPrc :integer)
   var rs = null;
   var RSDcmd = null;

   isCredit = true;

   FillFileFrc(ObjID, ObjN, OpDate, EndDate, Marker, AddPrc);

   LnSqlExec("insert into dpayment_tmp (T_IsOperation, T_ObjID, T_ObjN, T_RegID, T_CurCode, " +
                    "T_BegDate, T_EndDate, T_Sum, T_PaySum, T_RestNoPay, T_DocDutyID_Ref, T_ParentID, " +
                    "T_Reference, T_RateID, T_SystemOperationID, T_CreditNumber_Ref, t_PaymentID_Ref) " +
               "select T_IsOperation, -1, -1, T_RegID, T_CurCode, T_BegDate, T_EndDate, T_Sum, T_PaySum, T_RestNoPay, T_DocDutyID_Ref, T_ParentID, "+
               "T_Reference, T_RateID, T_SystemOperationID, T_CreditNumber_Ref, t_PaymentID_Ref from dpayment_tmp where T_ObjID = " + ObjID);
END;

MACRO GetDutyPriority (ObjID: integer, ObjectNumber: integer, SystemOperationID: integer, TypeOperNum: integer)
   VAR typeOpID     = 0;

   RECORD typeOpRec(type_op);

   IF (NOT Loans_FindTypeOp(TypeOperNum, 0, typeOpRec))
      RETURN 0;
   END;
   typeOpID = typeOpRec.typeOperID; 

   var cmd:object;
   
   cmd = RSDCommand ("BEGIN ? := RSI_LOANS_ADDITIONAL_ALGO.GetDutyPriorityDef ( ?,?,?,?,? ); END;"); 
   cmd.addParam ("stat",    RSDBP_RETVAL, V_INTEGER);
   cmd.addParam ("ObjID",   RSDBP_IN); cmd.value ("ObjID")  = ObjID;
   cmd.addParam ("ObjN",    RSDBP_IN); cmd.value ("ObjN")   = ObjectNumber;
   cmd.addParam ("Sys",     RSDBP_IN); cmd.value ("Sys")    = SystemOperationID;
   cmd.addParam ("typID",   RSDBP_IN); cmd.value ("typID")  = typeOpID;
   cmd.addParam ("dutyPriority", RSDBP_OUT, V_INTEGER);
   cmd.execute();
   
   return SQL_NVL(cmd.value("dutyPriority"), V_INTEGER);
END;