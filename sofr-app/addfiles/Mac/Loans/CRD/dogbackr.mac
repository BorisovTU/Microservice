/*
$Name:             dogbackr.mac
$Module:           Кредитование
$Description:      Договор обратного выкупа
*/
import ActiveX, total, replib, dlwreps, replib, global, acc_crd, SbCrdInter;

private record credit_c ("credit_c.dbt", "loans.def");
private const TemplateName = "dogbackr.dot";
private record cur_credit ("credit_c", "loans.def");
private file   currency   ("fininstr.dbt", "bank.def");
private file   ces_parm    ("ASGMTPARM.DBT", "loans.def");
private file   bankdprt    ("bankdprt.dbt", "bank.def");

macro RunReport(CreditBuf)

      var axerr:object = null, ExtCurCode, rub, kop, Code:string , INN:string, KPP:string,coracc:string,  Price = $0;

      SetBuff(credit_c, CreditBuf);
      private var   OurBank = TLoansClient;

      if(not OurBank.GetRecord({OurBank}))
         Exit(1);
      end;
      if (not depclnt.GetRecord(credit_c.ClientID_Ref))
          RunError ("Не найден заещик в справочнике клиентов");
      end;
      
      currency.FIID = credit_c.CurCode;         
      if(getEQ(currency))                       
          ExtCurCode =currency.ISO_Number;
      end;

      bankdprt.partyid = credit_c.ClientID_Ref;
      if(getEQ(bankdprt))                       
          coracc = bankdprt.coracc;
      end;

      ces_parm.CreditNumber = credit_c.CreditNumber;
      if(getEq(ces_parm))
         Price = ces_parm.Price;
      end;                        

      SetOutput (GetTxtFileName("dogbackr_rep"));
      
      println(TemplateName);              //Имя файла-шаблона
      println(GetDocName(TemplateName));  // Генерируем имя результирующего файла документа

      /* № договора */
      [~CrdNum];
      println (credit_c.UsCreditNumber);
      /* Дата начала договора */
      [~RegDate];
      println (DateToStringFull (credit_c.RegDate));
      [~CUR];
      println(FindShortName (credit_c.CurCode));
      
      [~Bank];
      println(OurBank.ShortName);
      [~Bank2];
      println(OurBank.ShortName);
      /* Почтовый адрес банка */
      [~B_Adress];
      println ( CONST_FACTADDR );
      [~B_Adress1];
      println ( CONST_FACTADDR );
      [~B_CorrAcc];
      println ( CONST_CORRACC );
      [~B_INN];
      println (CONST_INN);

      [~Price];
      println (Price);
       /* Цена договора прописью*/
      [~Price1];
      println (CurToStrAlt (Price, rub, kop, ExtCurCode));

       /* Полное имя заемщика */
      [~Client];
      println(depclnt.ShortName);
      [~Client2];
      println(depclnt.ShortName);

      /* Адрес заемщика */
      [~C_Adress];
      println (depclnt.AddressF);

      [~C_Phone];
      println (depclnt.PhoneNumberF);

      /* БИК */
      [~C_BIC];
      println(depclnt.GetCode(3/*БИК*/));

      [~C_Account];
      println(coracc);

      Code = depclnt.GetCode(16/*ИНН*/);

      IF (Trim(Code) != "")
         IF (Index(Code, "/") != 0)
            INN        = SubStr(Code, 1,                  Index(Code, "/") - 1);  // ИНН
            KPP        = SubStr(Code, Index(Code, "/")+1, Strlen(Code));          // КПП
         ELSE
            INN        = Code;
            KPP        = "";
         END;
      END;

      /* ИНН */
      [~C_INN];
      println(INN);
      /* КПП */
      [~C_KPP];
      println(KPP);


      [~B_ACC_B];
      println(CONST_NAMEBANK);
      [~C_ACCB];
      println(depclnt.Name);

      [~B_Phone];
       println(GetPhone(OurBank.CodClient, OurBank.LegalForm));

      var tag = SetOutput (NULL, false);
      return tag;

      onError(axerr)
         SetOutput(NULL, false);
         RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Договор обратного выкупа сформирован.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;
