IMPORT RsbDataSet, total;

MACRO FillFile (ObjID: integer, ObjN: integer, OpDate: date, CalcEndDate: date)
    var cmd:object;
    cmd = RsdCommand(RslDefCon, "begin ? := Loansfillpayment.fillpaymentforalloper(?,?,?,?,?); end;");
    cmd.addParam("stat",   RSDBP_RETVAL, V_INTEGER);
    cmd.addParam("typeop", RSDBP_IN); cmd.value("typeop") = CF_BIND_BUY_BACK;
    cmd.addParam("objid",  RSDBP_IN); cmd.value("objid")  = ObjID;
    cmd.addParam("objn",   RSDBP_IN); cmd.value("objn")   = ObjN;
    cmd.addParam("opdate", RSDBP_IN); cmd.value("opdate") = OpDate;
    cmd.addParam("debtdt", RSDBP_IN); cmd.value("debtdt") = CalcEndDate;
    cmd.execute();
    //Удаляем группы задолженностей без видов
    LnSQLExec("DELETE FROM DPAYMENT_TMP PM WHERE PM.T_PARENTID = 0 AND PM.T_Reference NOT IN (SELECT T_PARENTID FROM DPAYMENT_TMP PM2 WHERE PM2.T_PARENTID != 0 AND t_ObjID = " + ObjID + " and t_ObjN = " + ObjN+ ")");

END;

MACRO ReCalcSum(ObjID, ObjN)
   var FiltrStr = "";

   FiltrStr = " and t_CreditNumber_Ref = " + ObjN;

   LnSqlExec("update dpayment_tmp a set t_Sum = " +
                      " (Select SUM(t_Sum) from DPAYMENT_TMP b where b.t_ParentID = a.t_Reference " +
                                                                   " and (b.t_ObjID = a.t_ObjID or a.t_ObjID = -1)" +
                                                                   " and (b.t_ObjN  = a.t_ObjN or a.t_ObjN = -1)" + FiltrStr + ")" +
                  " WHERE t_ParentID = 0 " + FiltrStr);
END;

/* Расчет сумм */
MACRO CalcPercent(OpDate:date, ObjID, ObjN)
   VAR RSDcmd : object = null;
   VAR rs = null;
   VAR FiltrStr = "";

   FiltrStr = " t_CreditNumber_Ref = " + ObjN;

   LnSqlExec("update dpayment_tmp set T_SUM = 0, T_PAYSUM = 0, T_RESTNOPAY = 0 WHERE " + FiltrStr);

   rs = LnGetRecordSet("select * from dpayment_tmp " +
      " where t_ParentID != 0 " +
      " and t_IsOperation != " + SQLString("X") +
      " and  " + FiltrStr);

   if (rs != null)
      RSDcmd = RsdCommand(RslDefCon, "begin Loansfillpayment.debtscalculation(?,?,?,?,?); end;");
      RSDcmd.addParam("objid",     RSDBP_IN);
      RSDcmd.addParam("objn",      RSDBP_IN);
      RSDcmd.addParam("parentid",  RSDBP_IN);
      RSDcmd.addParam("REFERENCE", RSDBP_IN);
      RSDcmd.addParam("opdate",    RSDBP_IN);
      
      WHILE (rs.MoveNext)
         RSDcmd.value("objid")     = rs.value("t_ObjID",             false, V_INTEGER);
         RSDcmd.value("objn")      = rs.value("t_ObjN",              false, V_INTEGER);
         RSDcmd.value("parentid")  = rs.value("t_ParentID",          false, V_INTEGER);
         RSDcmd.value("REFERENCE") = rs.value("t_Reference",         false, V_INTEGER);
         RSDcmd.value("opdate")    = OpDate;
         RSDcmd.execute();
      END;
      RSDcmd = null;
   END;
   ReCalcSum(ObjID, ObjN);
end;
