/*--------------------------------------------------------------------------------------
Filename    : rsbus_SynchCreditdData.mac                                              
Description : Синхронизация данных по кредитному договору
Service #   : 5.4.3.5
Programmer  : Shershnev Victor
12.04.12    : Создан
--------------------------------------------------------------------------------------*/
import Total,SbCrdInter,XmlRpcInter;

class  TOperInfo
   var
      OperID        :integer,
      OperName      :string;
end;    

class TSynchCreditContr
   var 
      ID                 :integer,
      Number             :string,
      creditType         :integer,
      creditTypeName     :string,
      clientID           :integer,
      creditstate        :string,
      regDate            :date,
      returnDate         :date,
      closeDate          :date,
      territorialStruct  :integer,
      groupNum           :integer,
      userType           :string,
      privilege          :bool,
      specific           :string,
      sum                :money,
      repDate            :date,
      currency           :string,
      beforeDutyIsInd    :bool,
      fineCondIsInd      :bool,
      annuit             :bool,
      indClassification  :bool,
      dutyPriory         :integer,
      userField1         :string,
      userField2         :string,
      OperInfo           :TOperInfo;
end;

//Globals
var crFILE=Tbfile("credit_c.dbt","W");
var crTYPE=Tbfile("type_crd.dbt","W");
var crFIN=Tbfile("fininstr.dbt","W");
var crOP=Tbfile("crd_op.dbt","W");                   
record CRDFILE ("credit_c.dbt");
private var URL = GetSynchUrl(LO_CREDIT), Method = GetSynchMethod(LO_CREDIT), TimeOut = GetSynchTimeOut(LO_CREDIT);
var OperData:TOperInfo,SynchObj:TSynchCreditContr;

//=======================================================================================
/* Функция заполнения объекта */
//=======================================================================================
Macro FillObj(Credit_c) 
   //данные оператора
   OperData.OperID= {oper};      
   OperData.OperName={Name_Oper};

   //получаем RecBuf из Си кода
   if (ValType(Credit_c) == V_STRUC)
      copy(CRDFILE, Credit_c);
   elif(Credit_c != NULL)
      setBuff(CRDFILE, Credit_c); 
   end;

   SynchObj.ID=CRDFILE.CREDITNUMBER;
   SynchObj.number=CRDFILE.UsCreditNumber;
   SynchObj.creditType=CRDFILE.CreditTypeID_Ref;
   crTYPE.Clear();
   crTYPE.KeyNum=0;
   crTYPE.rec.CREDITTYPEID=CRDFILE.CreditTypeID_Ref;
   if (NOT crTYPE.GetEQ())
      println("Код не найден");
   end;
   SynchObj.creditTypeName=crTYPE.rec.CREDITTYPENAME;
   SynchObj.clientID=CRDFILE.ClientID_Ref;
   SynchObj.creditstate=CRDFILE.CreditState;
   SynchObj.regDate=CRDFILE.RegDate;
   SynchObj.returnDate=CRDFILE.ReturnDate;
   SynchObj.territorialStruct=CRDFILE.TerritorialStruct;
   SynchObj.groupNum=CRDFILE.GroupNum;
   SynchObj.userType=CRDFILE.UserType;
   if (CRDFILE.PrivilegeFlag==" ")
      SynchObj.privilege=false;
   else
      SynchObj.privilege=CRDFILE.PrivilegeFlag;
   end;
   SynchObj.specific=CRDFILE.Specific;
   SynchObj.sum=CRDFILE.CreditSum;
   SynchObj.repDate=CRDFILE.RepDate;
   crFIN.Clear();
   crFIN.KeyNum=0;
   crFIN.rec.FIID=CRDFILE.CURCODE;
   if (NOT crFIN.GetEQ())
      println("Код не найден");
   end; 
   SynchObj.currency=crFIN.rec.FI_CODE;
   SynchObj.beforeDutyIsInd=CRDFILE.BeforeDuty; 
   SynchObj.fineCondIsInd=CRDFILE.FineCond;
   SynchObj.annuit=CRDFILE.Annuit;
   if (CRDFILE.IndClassification)
      SynchObj.indClassification=true;
   else 
      SynchObj.indClassification=false;
   end;
   SynchObj.dutyPriory = 0;
   SynchObj.userField1=CRDFILE.UserField1;
   SynchObj.userField2=CRDFILE.UserField2;
   if (SynchObj.creditstate=="З")
      SynchObj.closeDate=lastopdate(LO_CREDIT,SynchObj.ID,CS_CLCRD);
   else
      SynchObj.closeDate=NULL;

   end;
   SynchObj.OperInfo.OperID = {oper};
   SynchObj.OperInfo.OperName = {name_oper};
     

end; 

//=======================================================================================
/* Функция вызова веб-сервиса и передачи ему объекта */
//=======================================================================================
Macro InsertObj
   var outParams,xml;
   var errMsg :string;
   var uID=CreateGUID(); // создание уникального идентификатора запроса
   var stat = 0; // ConvertToXML(SynchObj,NULL,xml);  //значение полученного объекта переводим в XML
XML = "<?xml version='1.0' encoding='windows-1251'?>"+
"<methodResponse xmlns="+StrFor(34)+"http://www.softlab.ru/xml-rpc/schema"+StrFor(34)+
" xmlns:n0="+StrFor(34)+"http://www.softlab.ru/xml-rpc/schema"+StrFor(34)+
" n0:reqId="+StrFor(34)+CreateGUID()+StrFor(34)+
" n0:logicalId="+StrFor(34)+StrFor(34)+">"+
"<params><param><value><struct>"+
"<member><name>ID</name><value><integer>"+SynchObj.ID+"</integer></value></member>"+
"<member><name>Number</name><value><string>"+SynchObj.Number+"</string></value></member>"+
"<member><name>creditType</name><value><integer>"+SynchObj.creditType+"</integer></value></member>"+
"<member><name>creditTypeName</name><value><string>"+SynchObj.creditTypeName+"</string></value></member>"+
"<member><name>clientID</name><value><integer>"+SynchObj.clientID+"</integer></value></member>"+
"<member><name>creditstate</name><value><string>"+SynchObj.creditstate+"</string></value></member>"+
"<member><name>regDate</name><value>"+XMLisDate(SynchObj.regDate)+"</value></member>"+
"<member><name>returnDate</name><value>"+XMLisDate(SynchObj.returnDate)+"</value></member>"+
"<member><name>closeDate</name><value>"+XMLisDate(SynchObj.closeDate)+"</value></member>"+
"<member><name>territorialStruct</name><value><integer>"+SynchObj.territorialStruct+"</integer></value></member>"+
"<member><name>groupNum</name><value><integer>"+SynchObj.groupNum+"</integer></value></member>"+
"<member><name>userType</name><value><string>"+SynchObj.userType+"</string></value></member>"+
"<member><name>privilege</name><value><boolean>"+XMLisBool(SynchObj.privilege)+"</boolean></value></member>"+
"<member><name>specific</name><value><string>"+SynchObj.specific+"</string></value></member>"+
"<member><name>sum</name><value><money>"+XMLisMoney(SynchObj.sum)+"</money></value></member>"+
"<member><name>repDate</name><value>"+XMLisDate(SynchObj.repDate)+"</value></member>"+
"<member><name>currency</name><value><string>"+SynchObj.currency+"</string></value></member>"+
"<member><name>beforeDutyIsInd</name><value><boolean>"+XMLisBool(SynchObj.beforeDutyIsInd)+"</boolean></value></member>"+
"<member><name>fineCondIsInd</name><value><boolean>"+XMLisBool(SynchObj.fineCondIsInd)+"</boolean></value></member>"+
"<member><name>annuit</name><value><boolean>"+XMLisBool(SynchObj.annuit)+"</boolean></value></member>"+
"<member><name>indClassification</name><value><boolean>"+XMLisBool(SynchObj.indClassification)+"</boolean></value></member>"+
"<member><name>dutyPriory</name><value><integer>"+SynchObj.dutyPriory+"</integer></value></member>"+
"<member><name>userField1</name><value><string>"+SynchObj.userField1+"</string></value></member>"+
"<member><name>userField2</name><value><string>"+SynchObj.userField2+"</string></value></member>"+
"<member><name>OperInfo</name><value><struct>"+
"<member><name>OperID</name><value><integer>"+SynchObj.OperInfo.OperID+"</integer></value></member>"+
"<member><name>OperName</name><value><string>"+SynchObj.OperInfo.OperName+"</string></value></member>"+
"</struct></value></member>"+
"</struct></value></param></params></methodResponse>";   
   var login="";
   var pass="";
   var inParams = TArray(3);
   var prm = RslSoapPrm;
   var prm2 = RslSoapPrm;
   var prm3 = RslSoapPrm;

   prm.Name="request";
   prm.Value=xml;
   inParams[0]=prm;
   prm2.Name="timeout";
   prm2.Value=0;
   inParams[1]=prm2;
   prm3.Name="priority";
   prm3.Value=0;
   inParams[2]=prm3;
   var encoding;
   var outResponse;
   //функция вызова web-service
   stat=CallSimpleExtService(uId,url,method,inParams,"","",timeout,outParams,encoding, outResponse,errMsg); 
   if (stat)
      println(errMsg);
      return 0;
   end;
end; 

//=======================================================================================
/* Функция синхронизации */
//=======================================================================================
Macro SynchCreditdData  (Credit_c, OperationType:integer) :integer
   if (NOT GetSynchState)
      return;
   end;
   //если при формировании объекта для синхронизации возникла ошибка, то завершаем работу макроса
   if (FillObj(Credit_c)==0)     
      LoansError("Ошибка при заполнении объекта");      
      return 0;
   end;

   if (InsertObj())
      LoansError("Ошибка при вызове веб-сервиса");      
      return 0;
   end;
           
   return 0;
end; 


 
