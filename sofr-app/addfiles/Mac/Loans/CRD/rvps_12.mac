/*
$Name:             rvps_12.mac
$Module:           Кредитование
$Description:      rvps_12.mac
*/

IMPORT ActiveX, VBAConst, SbCrdInter, LoansFind, total;

var num  :integer = 1,
    I :Integer,
    J :Integer,
    Row: integer,
    ItogSum = TArray(10),
    MegaItogSum = TArray(10),
    AllCasesSum = TArray(10),
    CurrList = TArray,
    ActSheet : Object,
    FNCashStr: string;

/* VVVVVV =================== ОТЧЕТ ПРИЛОЖЕНИЕ 12 А ================= VVVVVVV*/
macro getListAccount (ObjectNumber:integer, CurCode:integer, opdate:date, prevopdate:date, FlagProsr: integer)
   var ListAccount:string = "";
   var rs = NULL;
   var qAccount:string;

   qAccount = " SELECT DISTINCT a.T_AccountNumber_Ref" +
      " FROM dacc_crd_dbt a, dduty_crd_dbt b, dturn_acc_dbt c, dsb_acc_dbt s" +
      " WHERE a.T_CurCode = " + CurCode +
      " AND S.T_ACCOUNTNUMBER = A.T_ACCOUNTNUMBER_REF";

   if (FlagProsr == 1) // если просроченный договор
      qAccount = qAccount + " AND S.T_SYSTYPE = 'З'";
   else
      qAccount = qAccount + " AND S.T_SYSTYPE = 'С'";
   end;

   qAccount = qAccount + " AND S.T_CURCODE = " + CurCode +
      " AND S.T_OPERDPRT IN (" + FNCashStr + ")"+
      " AND" +
          " (((a.T_ObjectID = " + LO_CREDIT +
             " OR a.T_ObjectID = " + LO_KARTA +
             " OR a.T_ObjectID = " + LO_GUARANTEE +
             " OR a.T_ObjectID = " + LO_OVERDRAFT + ")" +
          " AND a.T_ObjectNumber = " + ObjectNumber + ")" +
          " OR" +
          " (a.T_ObjectID = " + LO_DUTY +
          " AND a.T_ObjectNumber = b.T_DutyID" +
          " AND b.T_CreditNumber_Ref = " + ObjectNumber + "))" +
      " AND c.T_CurCode = a.T_CurCode" +
      " AND c.T_AccountNumber_Ref = a.T_AccountNumber_Ref" +
      " AND C.T_OPERDPRT IN (" + FNCashStr + ")" +
      " AND ( C.T_TURNOVERDATE = (" +
            " select max(d.T_TURNOVERDATE) from dturn_acc_dbt d" +
            " where d.T_TURNOVERDATE < to_date('" + opdate + "','dd.mm.yyyy')" +
            " and d.T_ACCOUNTNUMBER_REF = c.T_ACCOUNTNUMBER_REF)" +
         " OR C.T_TURNOVERDATE = (" +
            " select max(d.T_TURNOVERDATE) from dturn_acc_dbt d" +
            " where d.T_TURNOVERDATE < to_date('" + prevopdate + "','dd.mm.yyyy')" +
            " and d.T_ACCOUNTNUMBER_REF = c.T_ACCOUNTNUMBER_REF)" +
      " )" +
      " AND c.T_TurnoverRest <> 0";

   rs = LnGetRecordSet (qAccount);
   if (rs == NULL)
      return ListAccount; end;

   while (rs.MoveNext())
      ListAccount = ListAccount + rs.Value("T_AccountNumber_Ref", NULL, V_STRING);
      ListAccount = ListAccount + ", ";
   end;

   ListAccount = SubStr (ListAccount, 1, StrLen(ListAccount) - 2);

   return ListAccount;
end;

macro PrintRepA(FlagProsr, FlagCurr, opdate, prevopdate)
VAR
rate:double,
query:string,
Curcode:string,
CrdNum :integer,
ObjType:integer,
k1:double, // коэффициент для первой категории качества обеспечения
k2:double, // коэффициент для второй категории качества обеспечения
qCount: integer, // количество обеспечений обязательства НЕ второй категории качества
sum  :Money,
sumpr:Money,
rs = NULL,
rs1 = NULL;
VAR RowData = TArray(28);
VAR MiniItogSum = TArray(10);

    if (FlagCurr == 0)
        Curcode = " = 0 ";
    else
        Curcode = " <> 0 ";
    end;

    // коэффициент для первой категории качества обеспечения
    k1 = LnSelectValue ("select T_COEFFICIENT from dquality_dbt where T_QUALITYID = 1", V_NUMERIC);
    // коэффициент для второй категории качества обеспечения
    k2 = LnSelectValue ("select T_COEFFICIENT from dquality_dbt where T_QUALITYID = 2", V_NUMERIC);

    I = 0;
    While (I < 10)
       MiniItogSum(I) = 0;
       I = I + 1;
    end;

    query = "SELECT * FROM DCREDIT_C_DBT c WHERE c.T_CurCode " + Curcode;
    query = query + "AND (c.T_FNcash IN (" +FNCashStr+ ")";
    query = query + " OR c.T_TERRITORIALSTRUCT IN (" +FNCashStr+ "))";
    rs = LnGetRecordSet(query);

    if (rs == NULL) return; end;

    while (rs.MoveNext())

        crdNum = rs.Value("t_CreditNumber", NULL, V_INTEGER);
        query = "SELECT c.T_SYSTEMOPERATIONID " +
                  "FROM DLBFRCCRD_DBT a, DCRD_OP_DBT c "+
                  "WHERE a.T_OBJECTNUMBER = " + crdNum +
                   " AND a.T_CREDOPERID_REF = " +
                      "(SELECT MAX(b.T_CREDOPERID_REF) FROM DLBFRCCRD_DBT b " +
                         "WHERE b.T_OBJECTNUMBER = " + crdNum +
                      ") AND c.T_CREDOPERID = a.T_CREDOPERID_REF";
        rs1 = LnGetRecordSet(query);
        if ((rs1 == NULL) OR (rs1.MoveNext() == FALSE) OR (rs1.Value(0, NULL, V_INTEGER) == 37))
            ObjType = rs.Value("t_Crd_kind", NULL, V_INTEGER);

            Sum = ОстатокРегистра (ObjType, crdNum, TDR_MAINREST, opdate) +
               ОстатокРегистра (ObjType, crdNum, TDR_MAINREST, prevopdate) +
               ОстатокКД (crdNum, TDR_MAINREST, opdate) +
               ОстатокКД (crdNum, TDR_MAINREST, prevopdate);
            SumPr = ОстатокРегистра (ObjType, crdNum, TDR_EXPREST, opdate) +
               ОстатокРегистра (ObjType, crdNum, TDR_EXPREST, prevopdate) +
               ОстатокКД (crdNum, TDR_EXPREST, opdate) +
               ОстатокКД (crdNum, TDR_EXPREST, prevopdate);

            if(((FlagProsr == 1) AND (SumPr > 0)) OR ((FlagProsr == 0) AND (Sum > 0)))

                I = 2;
                While (I < 28)
                   RowData(I) = $0;
                   I = I + 1;
                end;

                RowData(2) = num; /*№ позиции*/

                /*Наименование заемщика*/
                RowData(3) = LnSelectValue("SELECT T_Name from Dparty_dbt where T_PartyID = " + rs.Value("t_Clientid_ref", NULL, V_INTEGER), V_STRING);

                /*Вид обязательства*/
                if(ObjType != 9)
                     RowData(4) = "Ссуда";
                else
                     RowData(4) = "Гарантия";
                end;

                /*№ ссудного счета*/
                RowData(5) = getListAccount (
                   crdNum,
                   rs.Value("t_curcode", NULL, V_INTEGER),
                   opdate + 1,
                   prevopdate + 1,
                   FlagProsr);
                
                /*Финансовое состояние заемщика*/
                RowData(6) = LnSelectValue("select a.T_Name from Dobjattr_dbt a, Dobjatcor_dbt b " +
                                             "where a.T_ObjectType = 3 AND " +
                                               "a.T_GroupID = 22 AND " +
                                               "a.T_AttrID = b.T_AttrID AND " +
                                               "b.T_ObjectType = 3 AND " +
                                               "b.T_GroupID = 22 AND " +
                                               "b.T_Object = '" + Int2Str(rs.Value("t_Clientid_ref", NULL, V_INTEGER), 10) + "' AND "+
                                               "b.T_ValidFromDate = " +
                                                "(select Max(t.T_ValidFromDate) from Dobjatcor_dbt t " +
                                                 " where t.T_ObjectType = 3 AND " +
                                                    "t.T_GroupID = 22 AND " +
                                                    "t.T_Object = '" + Int2Str(rs.Value("t_Clientid_ref", NULL, V_INTEGER), 10) +
                                                    "' AND t.T_ValidFromDate <= " + SQLDate(OpDate) + ")" , V_STRING);

                /*Обслуживание долга*/
                RowData(7) = LnSelectValue("select N.T_SZNAMEALG from Dnamealg_dbt N, Dlhquasrv_dbt Q " +
                                             "where N.T_iTypeAlg = 993 AND " +
                                               "N.T_iNumberAlg = Q.T_Value AND " +
                                               "Q.T_CreditNumber_Ref = " +CrdNum+ " AND " +
                                               "Q.T_CredOperID_Ref <> 0 AND " +
                                               "Q.T_Date = " +
                                                "(select Max(t.T_Date) from Dlhquasrv_dbt t " +
                                                  "where  t.T_CreditNumber_Ref = " +CrdNum+ " AND " +
                                                   "t.T_Date <= " + SQLDate(OpDate) + ")", V_STRING);

                /*Дополнительные факторы влияющие на категорию риска*/
                RowData(8) = LnSelectValue("select a.T_Ground from Dcrdrghb_dbt a " +
                                             "where a.T_ObjectNumber = " +CrdNum+ " AND " +
                                              "(a.T_ObjectTypeID = 1 OR a.T_ObjectTypeID = 8) AND " +
                                               "a.T_Type = 1 AND " +
                                               "a.T_CredOperID_Ref <> 0 AND " +
                                               "a.T_Date = " +
                                                 "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                     "where  t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                       "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8) AND t.T_Date <= " + SQLDate(OpDate) + ")" +
                                               " and a.T_Ground <> Chr(1)", V_STRING);

                /*Обеспечение*/
                RowData(9) = КачествоОбеспечения( CrdNum, opdate );
                             
                if ( RowData(9) == Обеспеченная )
                    RowData(9) = "Обеспеченная";
                else
                    RowData(9) = "Необеспеченная";
                end;


                /*Задолженность по ссуде (приравненной к ней задолженности) в рублевом эквиваленте на предыдущую и текущую отчетные даты*/
                if(FlagCurr == 0)
                    rate = 1;
                    if(FlagProsr == 0)
                        RowData(12) = ОстатокРегистра(ObjType, crdNum, TDR_MAINREST, prevopdate);
                        RowData(13) = Sum;
                    else
                        RowData(12) = ОстатокРегистра(ObjType, crdNum, TDR_EXPREST, prevopdate);
                        RowData(13) = SumPr;
                    end;
                else
                /*Определим курс валюты*/
                    rate = GetRate(opdate, rs.Value("t_Curcode", NULL, V_INTEGER));
                    if(FlagProsr == 0)
                        RowData(10) = ОстатокРегистра(ObjType, crdNum, TDR_MAINREST, prevopdate);
                        RowData(11) = Sum;
                    else
                        RowData(10) = ОстатокРегистра(ObjType, crdNum, TDR_EXPREST, prevopdate);
                        RowData(11) = SumPr;
                    end;
                    RowData(12) = money(round(RowData(10) * rate));
                    RowData(13) = money(round(RowData(11) * rate));
                end;

                /*Категория качества на предыдущую отчетную дату*/
                RowData(14) = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                              "where c.T_ObjectNumber = " +CrdNum+ " AND " +
                                               "(c.T_ObjectTypeID = 1 OR c.T_ObjectTypeID = 8) AND " +
                                                "c.T_Type = 1 AND " +
                                                "c.T_CredOperID_Ref <> 0 AND " +
                                                "c.T_Date = " +
                                                  "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                     "where t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                       "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8) AND t.T_Date <= " + SQLDate(PrevOpDate) + ")", V_INTEGER);


                /*Категория качества на отчетную дату*/
                RowData(15) = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                              "where c.T_ObjectNumber = " +CrdNum+ " AND " +
                                               "(c.T_ObjectTypeID = 1 OR c.T_ObjectTypeID = 8) AND " +
                                                "c.T_Type = 1 AND " +
                                                "c.T_CredOperID_Ref <> 0 AND " +
                                                "c.T_Date = " +
                                                  "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                     "where  t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                       "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8) AND t.T_Date <= " + SQLDate(OpDate) + ")", V_INTEGER);


                /*Величина отчислений в резерв (%) на предыдущую  отчетную дату*/
                RowData(16) = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                              "where a.T_ObjectNumber = " +CrdNum + " AND " +
                                               "(a.T_ObjectTypeID = 1 OR a.T_ObjectTypeID = 8) AND " +
                                                "a.T_Type = 1 AND " +
                                                "a.T_CredOperID_Ref <> 0 AND " +
                                                "a.T_Date = " +
                                                  "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                     "where  t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                       "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8) AND t.T_Date <= " + SQLDate(PrevOpDate) + ")", V_NUMERIC)/100;

                /*Величина отчислений в резерв (%) на отчетную дату*/
                RowData(17) = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                              "where a.T_ObjectNumber = " +CrdNum + " AND " +
                                               "(a.T_ObjectTypeID = 1 OR a.T_ObjectTypeID = 8) AND " +
                                                "a.T_Type = 1 AND " +
                                                "a.T_CredOperID_Ref <> 0 AND " +
                                                "a.T_Date = " +
                                                  "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                     "where  t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                       "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8) AND t.T_Date <= " + SQLDate(OpDate) + ")", V_NUMERIC)/100;

                /* Стоимостная оценка обеспечения на отчетную дату 1 категории*/
                RowData(18) = rate * LnSelectValue("select sum(t_rezsum) from (" +
                                                   // для залогов
                                                   " select x.t_rezsum from decn_eob_dbt x, dens_crd_dbt e, densobj_dbt g" +
                                                   " where x.T_ENSCONTRACTID_REF = e.T_ENSCONTRACTID_REF" +
                                                   "   and e.T_CREDITNUMBER_REF = " + CrdNum +
                                                   "   and x.T_ENSOBJECTID_REF = g.T_ENSOBJECTID" +
                                                   "   and g.T_QUALITYID_REF = 1" +
                                                   " union" +
                                                   // для поручительств
                                                   " select z.t_rezsum from dens_crd_dbt z , denscontr_dbt t" +
                                                   " where z.T_ENSCONTRACTID_REF = t.T_ENSCONTRACTID" +
                                                   "   and z.T_CREDITNUMBER_REF = " + CrdNum +
                                                   "   and t.T_QUALITYID_REF = 1)", V_MONEY);
                 RowData(18) = money(round(RowData(18)));
                /* Стоимостная оценка обеспечения на отчетную дату 2 категории*/
                RowData(19) = rate * LnSelectValue("select sum(t_rezsum) from (" +
                                                   // для залогов
                                                   " select x.t_rezsum from decn_eob_dbt x, dens_crd_dbt e, densobj_dbt g" +                                                   
                                                   " where x.T_ENSCONTRACTID_REF = e.T_ENSCONTRACTID_REF" +
                                                   "   and e.T_CREDITNUMBER_REF = " + CrdNum +
                                                   "   and x.T_ENSOBJECTID_REF = g.T_ENSOBJECTID" +
                                                   "   and g.T_QUALITYID_REF = 2" +
                                                   " union" +
                                                   // для поручительств
                                                   " select z.t_rezsum from dens_crd_dbt z , denscontr_dbt t" +
                                                   " where z.T_ENSCONTRACTID_REF = t.T_ENSCONTRACTID" +
                                                   "   and z.T_CREDITNUMBER_REF = " + CrdNum +
                                                   "   and t.T_QUALITYID_REF = 2)", V_MONEY);
                 RowData(19) = money(round(RowData(19)));
                /* Резерв с учетом обеспечения на предыдущую отчетную дату*/
                RowData(20) = ОстатокРегистра(ObjType, crdNum, TREG_REZERVE, prevopdate);

                /* Резерв с учетом обеспечения на отчетную дату*/
                RowData(21) = ОстатокРегистра(ObjType, crdNum, TREG_REZERVE, opdate);

                if (RowData(21) > RowData(20))
                    if((RowData(14) < RowData(15)) AND RowData(14) == 1)
                        /*Изменения резерва, доначисление с уменьшением налогооблагаемой базы*/
                        RowData(22) = RowData(21) - RowData(20);
                    end;
                    if(((RowData(14) == 1) AND (RowData(15) == 1)) OR ((RowData(14) != 1) AND (RowData(15) != 1)))
                        /*Изменения резерва, доначисление без уменьшения налогооблагаемой базы*/
                        RowData(23) = RowData(21) - RowData(20);
                    end;
                else
                    if((RowData(14) > RowData(15)) AND RowData(15) == 1)
                        /*Изменения резерва, уменьшение/использование с увеличением налогооблагаемой базы*/
                        RowData(24) = RowData(20) - RowData(21);
                    end;
                    if(((RowData(14) == 1) AND (RowData(15) == 1)) OR ((RowData(14) != 1) AND (RowData(15) != 1)))
                        /*Изменения резерва, уменьшение/использование без увеличения налогооблагаемой базы*/
                        RowData(25) = RowData(20) - RowData(21);
                    end;
                end;

                // превышение достаточной стоимости обеспечения 1 категории
                RowData(26) = RowData(18) - round(RowData(13)/k1);
                RowData(26) = max (0, RowData(26));

                // превышение достаточной стоимости обеспечения 2 категории
                // .. получим количество обеспечений обязательства НЕ второй категории качества
                qCount = LnSelectValue(" select count(*) from" +
                   " (" +
                      " select c.T_QUALITYID_REF from dens_crd_dbt e, denscontr_dbt c" +
                      " where e.T_CREDITNUMBER_REF = " + CrdNum +
                      " and e.T_ENSCONTRACTID_REF = c.T_ENSCONTRACTID" +
                      " and c.T_QUALITYID_REF != 2 " +
                      " and c.T_ENSSYSTYPE = 1 " + // поручительство
                   " union" +
                      " select j.T_QUALITYID_REF from dens_crd_dbt e, densobj_dbt j, decn_eob_dbt x" +
                      " where e.T_CREDITNUMBER_REF = " + CrdNum +
                      " and e.T_ENSCONTRACTID_REF = x.T_ENSCONTRACTID_REF " +
                      " and x.T_ENSOBJECTID_REF = j.T_ENSOBJECTID" +
                      " and j.T_QUALITYID_REF != 2" +
                   " )", V_INTEGER);

                if (qCount == 0)
                   RowData(27) = RowData(19) - (RowData(13)/k2);
                else
                   if (round(k1*RowData(18)) >= RowData(13))
                      RowData(27) = RowData(19);
                   else
                      RowData(27) = money(round(RowData(19) - (RowData(13) - RowData(18)*k1)/k2));
                   end;
                end;
                // .. отрицательных значений не должно быть
                RowData(27) = max (0, RowData(27));
                
                // итого
                I = 20;
                while (I < 28)
                   MegaItogSum(I-18) = MegaItogSum(I-18) + RowData(I);
                   MiniItogSum(I-18) = MiniItogSum(I-18) + RowData(I);
                   ItogSum(I-18) = ItogSum(I-18) + RowData(I);
                   I = I + 1;
                end;
                ItogSum(0) = ItogSum(0) + RowData(12);
                ItogSum(1) = ItogSum(1) + RowData(13);
                MegaItogSum(0) = MegaItogSum(0) + RowData(12);
                MegaItogSum(1) = MegaItogSum(1) + RowData(13);
                MiniItogSum(0) = MiniItogSum(0) + RowData(12);
                MiniItogSum(1) = MiniItogSum(1) + RowData(13);


                ActSheet.Rows(Int(Row+1)).Insert;
                I = 2;
                while (I < 28)
                    ActSheet.Cells (Row, I).Value = RowData(I);
                    RowData(I) = 0;
                    I = I + 1;
                end;

                num = num + 1;
                row = row + 1;
            end;
        end;
    end;
    row = row + 1;
    ActSheet.Rows(Int(Row)).Delete;
    ActSheet.Cells (Row, 12).Value = MiniItogSum(0);
    ActSheet.Cells (Row, 13).Value = MiniItogSum(1);
    ActSheet.Cells (Row, 20).Value = MiniItogSum(2);
    ActSheet.Cells (Row, 21).Value = MiniItogSum(3);
    ActSheet.Cells (Row, 22).Value = MiniItogSum(4);
    ActSheet.Cells (Row, 23).Value = MiniItogSum(5);
    ActSheet.Cells (Row, 24).Value = MiniItogSum(6);
    ActSheet.Cells (Row, 25).Value = MiniItogSum(7);
    ActSheet.Cells (Row, 26).Value = MiniItogSum(8);
    ActSheet.Cells (Row, 27).Value = MiniItogSum(9);
    row = row + 2;
end;

Macro PrintItog()
   ActSheet.Cells (Row, 12).Value = ItogSum(0);
   ActSheet.Cells (Row, 13).Value = ItogSum(1);
   ActSheet.Cells (Row, 20).Value = ItogSum(2);
   ActSheet.Cells (Row, 21).Value = ItogSum(3);
   ActSheet.Cells (Row, 22).Value = ItogSum(4);
   ActSheet.Cells (Row, 23).Value = ItogSum(5);
   ActSheet.Cells (Row, 24).Value = ItogSum(6);
   ActSheet.Cells (Row, 25).Value = ItogSum(7);
   ActSheet.Cells (Row, 26).Value = ItogSum(8);
   ActSheet.Cells (Row, 27).Value = ItogSum(9);
   I = 0;
   While (I < 10)
      ItogSum (I) = 0;
      I = I + 1;
   end;
   Row = Row + 2;
end;

Macro PrintMegaItog()
   ActSheet.Cells (Row, 12).Value = MegaItogSum(0);
   ActSheet.Cells (Row, 13).Value = MegaItogSum(1);
   ActSheet.Cells (Row, 20).Value = MegaItogSum(2);
   ActSheet.Cells (Row, 21).Value = MegaItogSum(3);
   ActSheet.Cells (Row, 22).Value = MegaItogSum(4);
   ActSheet.Cells (Row, 23).Value = MegaItogSum(5);
   ActSheet.Cells (Row, 24).Value = MegaItogSum(6);
   ActSheet.Cells (Row, 25).Value = MegaItogSum(7);
   ActSheet.Cells (Row, 26).Value = MegaItogSum(8);
   ActSheet.Cells (Row, 27).Value = MegaItogSum(9);
end;

MACRO Print12a(ДатаОтчета, ПредДатаОтчета, FNCash)
    FNCashStr = FNCash;
    ExcelApplication.SheetsInNewWorkbook = 3;
    ExcelApplication.ActiveWorkbook.Sheets("Приложение 12а").Select;
    ActSheet = ExcelApplication.ActiveSheet; /*Активная страница*/
    I = 0;
    While (I < 10)
       MegaItogSum (I) = 0;
       ItogSum (I) = 0;
       I = I + 1;
    end;

    Row = 11;
    ActSheet.Cells (11, 18).Value = ДатаОтчета;
    ActSheet.Cells (18, 21).Value = "на " + ДатаОтчета;
    Row = 21;
    PrintRepA(0, 0, ДатаОтчета, ПредДатаОтчета);
    PrintRepA(1, 0, ДатаОтчета, ПредДатаОтчета);    //первый параметр Действующие/Просроченные
    PrintItog();

    Row = Row + 1;
    PrintRepA(0, 1, ДатаОтчета, ПредДатаОтчета);    // второй параметр рублевые/валютные
    PrintRepA(1, 1, ДатаОтчета, ПредДатаОтчета);
    PrintItog();
    PrintMegaItog();
END;

/* ^^^^^ =================== ОТЧЕТ ПРИЛОЖЕНИЕ 12 А ================= ^^^^^^*/




/* VVVVV =================== ОТЧЕТ ПРИЛОЖЕНИЕ 12 Б ================= VVVVVV*/

macro PrintRepB(CaseID, FlagProsr, FlagRes, OpDate, PrevOpDate)
var query: string;
var resid: string;
var rs1  : object;
var CurCode:integer;
var СуммыПоВалютам = Tarray;
var CurInd: integer,
    crdNum: integer,
    ObjType:integer;
var rezerv_id:integer = 0;
var ItogStr: string = "Итого ",
    ResidStr:string;

var Sum:  money = 0,
    SumPr:money = 0,
    Itog1:money = 0,
    Itog2:money = 0,
    ItogRes1:money = 0,
    ItogRes2:money = 0,
    ItogReRes1:money = 0,
    ItogReRes2:money = 0;
var PercRes1: double,
    PercRes2: double;

    СуммыПоВалютам.Size = 0;

    if(FlagRes == 0)
        ResidStr = "Нерезиденты ";
    resid = " = 'X' ";
    else
        ResidStr = "Резиденты ";
    resid = " <> 'X' ";
    end;
    query = "select * from dcredit_c_dbt c, dparty_dbt p " +
          "where p.T_PartyID = c.T_ClientID_Ref and p.T_NotResident " + Resid + " AND " +
        "c.T_CREDITNUMBER IN (select f.T_OBJECTNUMBER from dlbfrccrd_dbt f, dcrd_op_dbt o " +
                       "where f.T_BRIEFCASEID_REF = " + CaseID + " AND " +
                     "o.T_SYSTEMOPERATIONID != 37 and o.T_CREDOPERID = f.T_CREDOPERID_REF and " +
                     "f.T_CREDOPERID_REF = (select max(s.T_CREDOPERID_REF) from dlbfrccrd_dbt s " +
                                      "where s.T_BRIEFCASEID_REF = " +CaseID+ " and s.T_OBJECTNUMBER = f.T_OBJECTNUMBER))";
    rs1 = LnGetRecordSet(query);

    while(rs1.MoveNext())

        CrdNum = rs1.Value("t_creditnumber", NULL, V_INTEGER);
        ObjType = rs1.Value("t_Crd_kind", NULL, V_INTEGER);


        Sum = ОстатокОткрытыхСО (crdNum, TDR_MAINREST, opdate) + ОстатокРегистра(ObjType, crdNum, TDR_MAINREST, opdate);
        SumPr = ОстатокОткрытыхСО (crdNum, TDR_EXPREST,  opdate) + ОстатокРегистра(ObjType, crdNum, TDR_EXPREST, opdate) ;

        If(((FlagProsr == 1) AND (SumPr > 0)) OR ((FlagProsr == 0) AND (Sum > 0)))
        I = 0;
        CurInd = -1;
        WHILE ((I < СуммыПоВалютам.Size) AND (CurInd == -1))
           IF (СуммыПоВалютам[I][0] == rs1.Value("t_curcode", NULL, V_INTEGER));
              CurInd = I;
           END;
           I = I + 1;
        END;

        IF (CurInd == -1)
            CurInd = СуммыПоВалютам.Size;
            СуммыПоВалютам[Curind] = TArray;
            СуммыПоВалютам[CurInd][0] = rs1.Value("t_curcode", NULL, V_INTEGER);
            СуммыПоВалютам[CurInd][1] = LnSelectValue("select f.t_fi_code from dfininstr_dbt f where f.t_fiid = " + rs1.Value("t_curcode", NULL, V_INTEGER), V_STRING);
            СуммыПоВалютам[CurInd][2] = $0;
            СуммыПоВалютам[CurInd][3] = $0;
            СуммыПоВалютам[CurInd][4] = $0;
            СуммыПоВалютам[CurInd][5] = $0;
            СуммыПоВалютам[CurInd][6] = GetRate(opdate,     rs1.Value("t_curcode", NULL, V_INTEGER));  // курс валюты
            СуммыПоВалютам[CurInd][8] = GetRate(prevopdate, rs1.Value("t_curcode", NULL, V_INTEGER));  // курс валюты
            СуммыПоВалютам[CurInd][7] = LnSelectValue("select f.T_CCY from dfininstr_dbt f where f.t_fiid = " + rs1.Value("t_curcode", NULL, V_INTEGER), V_STRING);
            ItogStr = ItogStr + СуммыПоВалютам[CurInd][1] + " ";
        END;

        IF (rs1.Value("t_curcode", NULL, V_INTEGER) == 0)
                if(FlagProsr == 0)
                    СуммыПоВалютам[CurInd][4] = СуммыПоВалютам[CurInd][4] + ОстатокРегистра(ObjType, crdNum, TDR_MAINREST, prevopdate)
                                                + ОстатокОткрытыхСО (crdNum, TDR_MAINREST, prevopdate);
                    СуммыПоВалютам[CurInd][5] = СуммыПоВалютам[CurInd][5] + Sum;
                else
                    СуммыПоВалютам[CurInd][4] = СуммыПоВалютам[CurInd][4] + ОстатокРегистра(ObjType, crdNum, TDR_EXPREST, prevopdate)
                                                + ОстатокОткрытыхСО (crdNum, TDR_EXPREST, prevopdate);;
                    СуммыПоВалютам[CurInd][5] = СуммыПоВалютам[CurInd][5] + SumPr;
                end;
        ELSE
           IF (FlagProsr == 0)
              СуммыПоВалютам[CurInd][2] = СуммыПоВалютам[CurInd][2] + ОстатокРегистра(ObjType, crdNum, TDR_MAINREST, prevopdate)
                                        + ОстатокОткрытыхСО (crdNum, TDR_MAINREST, prevopdate);
              СуммыПоВалютам[CurInd][3] = СуммыПоВалютам[CurInd][3] + Sum;
           ELSE
              СуммыПоВалютам[CurInd][2] = СуммыПоВалютам[CurInd][2] + ОстатокРегистра(ObjType, crdNum, TDR_EXPREST, prevopdate)
                                        + ОстатокОткрытыхСО (crdNum, TDR_EXPREST, prevopdate);
              СуммыПоВалютам[CurInd][3] = СуммыПоВалютам[CurInd][3] + SumPr;
           END;
           СуммыПоВалютам[CurInd][4] = /*СуммыПоВалютам[CurInd][4] + */ СуммыПоВалютам[CurInd][2] * СуммыПоВалютам[CurInd][6];
           СуммыПоВалютам[CurInd][5] = /*СуммыПоВалютам[CurInd][5] + */ СуммыПоВалютам[CurInd][3] * СуммыПоВалютам[CurInd][6];
        END;
        END;
    end;

    if((СуммыПоВалютам.Size > 0) AND (FlagRes == 1))
       ActSheet.Rows(Int(Row)).Insert;
       ActSheet.Cells (Row, 1).Value = Row - 8;
       if(FlagProsr == 0)
           ActSheet.Cells (Row, 2).Value = "Срочная задолженность";
       else
       ActSheet.Cells (Row, 2).Value = "Просроченная задолженность";
       end;
       Row = Row + 1;
    end;

   I = 0;
   WHILE (I<СуммыПоВалютам.Size)
      ActSheet.Rows(Int(Row)).Insert;
      ActSheet.Cells (Row, 1).Value = Row - 8;
      ActSheet.Cells (Row, 2).Value = ResidStr + СуммыПоВалютам[I][1];
      ActSheet.Cells (Row, 3).Value = СуммыПоВалютам[I][2];
      ActSheet.Cells (Row, 4).Value = СуммыПоВалютам[I][3];
      ActSheet.Cells (Row, 5).Value = СуммыПоВалютам[I][4];
      ActSheet.Cells (Row, 6).Value = СуммыПоВалютам[I][5];
      Itog1 = Itog1 + СуммыПоВалютам[I][4];
      Itog2 = Itog2 + СуммыПоВалютам[I][5];
      Row   = Row + 1;

      CurInd = -1;
      J = 0;
      WHILE ((J < CurrList.Size) AND (CurInd == -1))
         IF (CurrList[J][0] == СуммыПоВалютам[I][0]);
            IF (CurrList[J][0] == 0)
               CurrList[J][1] = CurrList[J][1] + СуммыПоВалютам[I][4];
               CurrList[J][2] = CurrList[J][2] + СуммыПоВалютам[I][5];
            ELSE
               CurrList[J][1] = CurrList[J][1] + СуммыПоВалютам[I][2];
               CurrList[J][2] = CurrList[J][2] + СуммыПоВалютам[I][3];
            END;
            CurInd = J;
         END;
         J = J + 1;
      END;

      IF (CurInd == -1)
         CurInd = CurrList.Size;
         CurrList[Curind] = TArray;
         CurrList[J][0] = СуммыПоВалютам[I][0];
         IF (CurrList[J][0] == 0)
            CurrList[J][1] = СуммыПоВалютам[I][4];
            CurrList[J][2] = СуммыПоВалютам[I][5];
         ELSE
            CurrList[J][1] = СуммыПоВалютам[I][2];
            CurrList[J][2] = СуммыПоВалютам[I][3];
            CurrList[J][3] = СуммыПоВалютам[I][6];
            CurrList[J][5] = СуммыПоВалютам[I][8];
         END;
         CurrList[J][4] = СуммыПоВалютам[I][7];
      END;
      I = I + 1;
   END;

   IF (СуммыПоВалютам.Size > 0)

        ActSheet.Rows(Int(Row)).Insert;
        ActSheet.Cells (Row, 1).Value = Row - 8;
        ActSheet.Cells (Row, 2).Value = ItogStr;
        ActSheet.Cells (Row, 5).Value = Itog1;
        ActSheet.Cells (Row, 6).Value = Itog2;

        /*Категория качества на предыдущую отчетную дату*/
        ActSheet.Cells (Row, 7).Value = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                                     "where c.T_ObjectNumber = " +CaseID+ " AND " +
                                                      "c.T_ObjectTypeID = 17 AND c.T_Type = 1 AND " +
                                                       "c.T_CredOperID_Ref <> 0 AND c.T_Date = " +
                                 "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                    "where t.T_ObjectNumber = " +CaseID+ " AND " +
                                                              "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(PrevOpDate) + ")", V_INTEGER);

        /*Категория качества на отчетную дату*/
        ActSheet.Cells (Row, 8).Value = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                                    "where c.T_ObjectNumber = " +CaseID+ " AND " +
                                                    "c.T_ObjectTypeID = 17 AND c.T_Type = 1 AND " +
                                                    "c.T_CredOperID_Ref <> 0 AND c.T_Date = " +
                                    "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                    "where  t.T_ObjectNumber = " +CaseID+ " AND " +
                                                            "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(OpDate) + ")", V_INTEGER);

        /*Величина отчислений в резерв (%) на предыдущую  отчетную дату*/
        PercRes1 = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                "where a.T_ObjectNumber = " +CaseID+ " AND " +
                                    "a.T_ObjectTypeID = 17 AND a.T_Type = 1 AND " +
                                    "a.T_CredOperID_Ref <> 0 AND a.T_Date = " +
                    "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                        "where  t.T_ObjectNumber = " +CaseID+ " AND " +
                                        "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(PrevOpDate) + ")", V_NUMERIC)/100;

        /*Величина отчислений в резерв (%) на отчетную дату*/
        PercRes2 = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                "where a.T_ObjectNumber = " +CaseID+ " AND " +
                                    "a.T_ObjectTypeID = 17 AND a.T_Type = 1 AND " +
                                    "a.T_CredOperID_Ref <> 0 AND a.T_Date = " +
                    "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                        "where  t.T_ObjectNumber = " +CaseID+ " AND " +
                                        "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(OpDate) + ")", V_NUMERIC)/100;


        if (FlagProsr == 1)
            ItogRes1 = ItogRes1 + ОстатокРегистра(17, CaseID, TREG_EXPREZ, PrevOpDate);
            ItogRes2 = ItogRes2 + ОстатокРегистра(17, CaseID, TREG_EXPREZ, OpDate);
        end;

        rezerv_id = 38;               // Резерв по кредитам Минфину

        while (rezerv_id < 55)                    //считает суммы по всем необходимым регистрам "TDR_REZ_MINFIN - TDR_REZ_PRSN_NO"
               ItogRes1 = ItogRes1 + ОстатокРегистра(17, CaseID, rezerv_id, PrevOpDate);
               ItogRes2 = ItogRes2 + ОстатокРегистра(17, CaseID, rezerv_id, OpDate);
               rezerv_id = rezerv_id + 1;
        end;

        if(ItogRes2 > ItogRes1)
        ItogReRes1 = ItogRes2 - ItogRes1;
        else
        ItogReRes2 = ItogRes1 - ItogRes2;
        end;

        ActSheet.Cells (Row,  9).Value = PercRes1;
        ActSheet.Cells (Row, 10).Value = PercRes2;
        ActSheet.Cells (Row, 11).Value = ItogRes1;
        ActSheet.Cells (Row, 14).Value = ItogRes2;
        ActSheet.Cells (Row, 17).Value = ItogReRes1;
        ActSheet.Cells (Row, 19).Value = ItogReRes2;
        ItogSum(0) = ItogSum(0) + Itog1;
        ItogSum(1) = ItogSum(1) + Itog2;
        ItogSum(2) = ItogSum(2) + ItogRes1;
        ItogSum(3) = ItogSum(3) + ItogRes2;
        ItogSum(4) = ItogSum(4) + ItogReRes1;
        ItogSum(5) = ItogSum(5) + ItogReRes2;
        MegaItogSum(0) = MegaItogSum(0) + Itog1;
        MegaItogSum(1) = MegaItogSum(1) + Itog2;
        MegaItogSum(2) = MegaItogSum(2) + ItogRes1;
        MegaItogSum(3) = MegaItogSum(3) + ItogRes2;
        MegaItogSum(4) = MegaItogSum(4) + ItogReRes1;
        MegaItogSum(5) = MegaItogSum(5) + ItogReRes2;
    Row = Row + 1;
    end;
end;

macro PrintDutyItogB(FlagProsr)
   if((ItogSum(0) == 0) AND (ItogSum(1) == 0))
       return;
   end;
   ActSheet.Rows(Int(Row)).Insert;
   ActSheet.Cells (Row, 1).Value = Row - 8;
    if(FlagProsr ==1)
    ActSheet.Cells (Row, 2).Value = "Итого по просроченной задолженности ";
    else
    ActSheet.Cells (Row, 2).Value = "Итого по по срочной задолженности ";
    end;
    ActSheet.Cells (Row, 5).Value  = ItogSum(0);
    ActSheet.Cells (Row, 6).Value  = ItogSum(1);
    ActSheet.Cells (Row, 11).Value = ItogSum(2);
    ActSheet.Cells (Row, 14).Value = ItogSum(3);
    ActSheet.Cells (Row, 17).Value = ItogSum(4);
    ActSheet.Cells (Row, 19).Value = ItogSum(5);
    I = 0;
    While(I<10)
        ItogSum(I) = 0;
        I = I + 1;
    end;
    Row = Row + 1;
end;

macro PrintCaseItogB()
    ActSheet.Rows(Int(Row)).Insert;
    ActSheet.Cells (Row, 1).Value = Row - 8;
    ActSheet.Cells (Row, 2).Value  = "Всего по портфелю";
    ActSheet.Cells (Row, 5).Value  = MegaItogSum(0);
    ActSheet.Cells (Row, 6).Value  = MegaItogSum(1);
    ActSheet.Cells (Row, 11).Value = MegaItogSum(2);
    ActSheet.Cells (Row, 14).Value = MegaItogSum(3);
    ActSheet.Cells (Row, 17).Value = MegaItogSum(4);
    ActSheet.Cells (Row, 19).Value = MegaItogSum(5);
    AllCasesSum(0) = AllCasesSum(0) + MegaItogSum(0);
    AllCasesSum(1) = AllCasesSum(1) + MegaItogSum(1);
    AllCasesSum(2) = AllCasesSum(2) + MegaItogSum(2);
    AllCasesSum(3) = AllCasesSum(3) + MegaItogSum(3);
    AllCasesSum(4) = AllCasesSum(4) + MegaItogSum(4);
    AllCasesSum(5) = AllCasesSum(5) + MegaItogSum(5);
    I = 0;
    While(I<10)
        MegaItogSum(I) = 0;
        I = I + 1;
    end;
    Row = Row + 1;
end;

macro PrintAllCasesItogB()
    Row = Row + 1;
    ActSheet.Cells (Row, 5).Value  = AllCasesSum(0);
    ActSheet.Cells (Row, 6).Value  = AllCasesSum(1);
    ActSheet.Cells (Row, 11).Value = AllCasesSum(2);
    ActSheet.Cells (Row, 14).Value = AllCasesSum(3);
    ActSheet.Cells (Row, 17).Value = AllCasesSum(4);
    ActSheet.Cells (Row, 19).Value = AllCasesSum(5);
end;

macro PrintCurrItogB()
    Row = Row + 11;
    I = 0;
    while(I < CurrList.size)
       ActSheet.Cells (Row, 4).Value  = CurrList[I][1];
       ActSheet.Cells (Row, 5).Value  = CurrList[I][4];
       ActSheet.Cells (Row, 6).Value  = CurrList[I][3];
       Row = Row + 1;
       I = I + 1;
       ActSheet.Rows(Int(Row)).Insert;
    end;
    ActSheet.Rows(Int(Row)).Delete;

    Row = Row + 1;
    I = 0;
    while(I < CurrList.size)
       ActSheet.Cells (Row, 4).Value  = CurrList[I][2];
       ActSheet.Cells (Row, 5).Value  = CurrList[I][4];
       ActSheet.Cells (Row, 6).Value  = CurrList[I][5];
       Row = Row + 1;
       I = I + 1;
       ActSheet.Rows(Int(Row)).Insert;
    end;
    ActSheet.Rows(Int(Row)).Delete;
end;

MACRO Print12b(ДатаОтчета, ПредДатаОтчета, FNCash)
var query:string;
var rs:object;
    FnCashStr = FnCash;
    ExcelApplication.SheetsInNewWorkbook = 3;
    ExcelApplication.ActiveWorkbook.Sheets("Приложение 12б").Select;
    ActSheet = ExcelApplication.ActiveSheet; /*Активная страница*/

    CurrList.Size = 0;
    I = 0;
    While(I<10)
        AllCasesSum(I) = 0;
        MegaItogSum(I) = 0;
        ItogSum(I) = 0;
        I = I + 1;
    end;

    query = "SELECT * FROM dlbrfcase_dbt l where l.T_Type = 1 " +
                   "AND l.T_FNcash IN ("+FNCashStr+")";
    rs = LnGetRecordSet(query);

    if (rs == NULL) return; end;
    ActSheet.Cells (2, 3).Value = ActSheet.Cells (2, 3).Value+ DateToStringFull(ДатаОтчета);
    Row = 9;
    WHILE (rs.MoveNext())
       ActSheet.Rows(Int(Row)).Insert;
       ActSheet.Cells (Row, 1).Value = Row - 8;
       ActSheet.Cells (Row, 2).Value = "Портфель. Кредиты, предоставленные на стандартных условиях " + rs.Value("t_briefcasename", NULL, V_STRING);
       Row = Row + 1;

       PrintRepB(rs.Value(0, NULL, V_INTEGER), 0, 1, ДатаОтчета, ПредДатаОтчета);
       PrintRepB(rs.Value(0, NULL, V_INTEGER), 0, 0, ДатаОтчета, ПредДатаОтчета);
       PrintDutyItogB(0);

       PrintRepB(rs.Value(0, NULL, V_INTEGER), 1, 1, ДатаОтчета, ПредДатаОтчета);
       PrintRepB(rs.Value(0, NULL, V_INTEGER), 1, 0, ДатаОтчета, ПредДатаОтчета);
       PrintDutyItogB(1);

       PrintCaseItogB();
    END;
    PrintAllCasesItogB();
    PrintCurrItogB();
END;

/* ^^^^^ =================== ОТЧЕТ ПРИЛОЖЕНИЕ 12 Б ================= ^^^^^^*/
