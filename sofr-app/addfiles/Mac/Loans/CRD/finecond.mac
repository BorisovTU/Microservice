import "total.mac", Календарь, SbCrdInter;
/*
PRIVATE RECORD Договор       ("credit_c.dbt", "loans.def");
PRIVATE RECORD Обязательство ("duty_crd.dbt", "loans.def");
PRIVATE var FineCond = TBFile("finecond.dbt", "W", 0);
private var CrdOp    = TBFile("crd_op.dbt",   "R", 2);

private VAR  mdb = TBFile ("payment.tmp", "w", 0);

private CLASS ID_DATE
    VAR ID:integer;
    VAR BD:date;
    VAR DT:date;
END;

private VAR {GROUP_MODE};

private VAR Type:integer,
    BEGDATE:date = date(0,0,0),
    ENDDATE:date = date(0,0,0);

private var ArIdDt = TArray(0);

MACRO ПолучитьДатыДляШтрафов()
    VAR First:bool;
    VAR stat:bool = false;
    VAR D:date;
    VAR NextIf:bool = false;

    ArIdDt = TArray(0);
    IF (Type == ALG_CRD)
        FineCond.Clear;
        FineCond.AddFilter("t_ID_Ref = " + Договор.CreditNumber + " and t_Type = " + Type);
        FineCond.rec.ID_Ref = Договор.CreditNumber;
        FineCond.rec.Type = Type;
        FineCond.rec.BegDate = date(0,0,0);
        FineCond.rec.ID = 0;
        stat = FineCond.GetGE;
        WHILE (stat AND
              (FineCond.rec.ID_Ref == Договор.CreditNumber) AND
              (FineCond.rec.Type == Type));
            ArIdDt(ArIdDt.size) = GenObject("ID_DATE");
            ArIdDt(ArIdDt.size-1).ID = FineCond.rec.ID;
            ArIdDt(ArIdDt.size-1).BD = FineCond.rec.BegDate;
            ArIdDt(ArIdDt.size-1).DT = FineCond.rec.EndDate;
            stat = FineCond.Next;
        END;
        FineCond.DropFilter;
    ELSE
        FineCond.Clear;
        FineCond.AddFilter("t_ID_Ref = " + Договор.CreditTypeID_Ref + " and t_Type = " + Type);
        FineCond.rec.ID_Ref = Договор.CreditTypeID_Ref;
        FineCond.rec.Type = Type;
        FineCond.rec.ID = 0;
        stat = FineCond.GetGE;
        WHILE (stat AND
              (FineCond.rec.ID_Ref == Договор.CreditTypeID_Ref) AND
              (FineCond.rec.Type == Type));
            First = true;
            D = date(0,0,0);

            IF (FineCond.rec.CalcDuration == FCOND_EXPDATE)
                WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_EXP, false, Договор.CurCode) AND (D == date(0,0,0)))
                    IF (GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT)
                        D = CrdOp.rec.CredOperDate;
                    END;
                END
            END;

            IF (FineCond.rec.CalcDuration == FCOND_PROLONG)
                WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_PROL, false, Договор.CurCode) AND (D == date(0,0,0)))
                    IF (GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT)
                        D = CrdOp.rec.CredOperDate;
                    END;
                END
            END;

            IF ((FineCond.rec.CalcDuration == FCOND_PREV) AND (ArIdDt.size != 0))
                D = ArIdDt(ArIdDt.size-1).DT;
            END;

            IF (D != date(0,0,0))
                IF (NextIf)
                    ArIdDt(ArIdDt.size-1).DT = D - 1;
                    NextIf = false;
                END;
                ArIdDt(ArIdDt.size) = GenObject("ID_DATE");
                ArIdDt(ArIdDt.size-1).ID = FineCond.rec.ID;
                ArIdDt(ArIdDt.size-1).BD = D;
                IF (FineCond.rec.Duration != 0)
                    IF (FineCond.rec.TypeDuration == CF_DAY)
                        ArIdDt(ArIdDt.size-1).DT = DateAfterCalenDays(D, FineCond.rec.Duration);
                    ELSE
                        ArIdDt(ArIdDt.size-1).DT = DateAfterCalenMonths(D, FineCond.rec.Duration);
                    END;
                ELSE
                    ArIdDt(ArIdDt.size-1).DT = date(0,0,0);
		    IF (FineCond.rec.BeforeCalcDuration == CDFBD_CLOSECREDIT)
                        WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_CLCRD, true, Договор.CurCode) AND (ArIdDt(ArIdDt.size-1).DT == date(0,0,0)))
                            IF ((GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT) AND
                                (CrdOp.rec.CredOperDate >= ArIdDt(ArIdDt.size-1).BD))
                                ArIdDt(ArIdDt.size-1).DT = CrdOp.rec.CredOperDate;
                            END;
                        END;
                    ELIF (FineCond.rec.BeforeCalcDuration == CDFBD_PROLONG)
                        WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_PROL, true, Договор.CurCode) AND (ArIdDt(ArIdDt.size-1).DT == date(0,0,0)))
                            IF ((GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT) AND
                                (CrdOp.rec.CredOperDate >= ArIdDt(ArIdDt.size-1).BD))
                                ArIdDt(ArIdDt.size-1).DT = CrdOp.rec.CredOperDate;
                            END;
                        END;
                    ELSE /*CDFBD_NEXTIF*/
                        NextIf = true;
                    END;

                    IF (ArIdDt(ArIdDt.size-1).DT == date(0,0,0))
                        ArIdDt(ArIdDt.size-1).DT = date(31,12,9999);
                    END;
                END;
            END;
            stat = FineCond.Next;
        END;
        FineCond.DropFilter;
    END;
END;


MACRO ПереносИндивидуальныеНастройкиДляШтрафов()
    VAR i:integer = 0;

    FineCond.KeyNum = 0;

    WHILE (i < ArIdDt.size)
        FineCond.rec.ID = ArIdDt(i).ID;
        IF (FineCond.GetEQ)
            FineCond.rec.ID = 0;
            FineCond.rec.Type = ALG_CRD;
            FineCond.rec.ID_Ref = Договор.CreditNumber;
            FineCond.rec.BegDate = ArIdDt(i).BD;
            FineCond.rec.EndDate = ArIdDt(i).DT;
            FineCond.Insert;
        END;
        i = i + 1;
    END;
END;


MACRO ИндивидуальныеНастройкиДляШтрафов()
    Type = ALG_GROUP;
    ПолучитьДатыДляШтрафов();
    IF (NOT ProcessTrn(0, "ПереносИндивидуальныеНастройкиДляШтрафов", FineCond))
        MsgBox("Ошибка при переносе в индивидуальные настройки");
    END;
END;


MACRO РассчитатьДатуДляШтрафов(ID:integer)
    VAR i:integer = 0;

    Type = Договор.FineCond;

    IF (ArIdDt.size == 0)
        ПолучитьДатыДляШтрафов();
    END;

    WHILE(i < ArIdDt.size)
        IF (ArIdDt(i).ID == ID)
            BEGDATE = ArIdDt(i).BD;
            ENDDATE = ArIdDt(i).DT;
            RETURN;
        END;
        i = i + 1;
    END;

    BEGDATE = ENDDATE = date(0,0,0);
    RETURN;
END;


MACRO РасчетШтрафов(ObjID:integer, ObjN:integer, PayDate:date, PaySum:moneyl, dp:integer)
    VAR SP:moneyl,
        SX:moneyl,
        SumPay6:moneyl,
        Sum6:moneyl,
        tmp_sum:moneyl,
        tmp_sum1:moneyl,
        i:integer = 0,
        Противоречие:bool,
        stat:bool = false,
        found:bool = false,
        rs = NULL,
        select: string = "",
        DutyStageID:integer = 0,
        CreditNumber:integer = 0;

    MACRO CalcPennySum(Sum:double, Perc:integer)
        VAR Sum1:moneyl;
        IF (Perc == CPD_CRDSUM)
            Sum1 = (ОстатокОткрытыхСО(Договор.CreditNumber, TDR_MAINREST, PayDate) + ОстатокРегистра(LO_CREDIT, Договор.CreditNumber, TDR_MAINREST, PayDate))*Sum/100;
        ELIF (Perc == CPD_RESTDUTYS)
            Sum1 = ОстатокОткрытыхСО(Договор.CreditNumber, TDR_MAINREST, PayDate)*Sum/100;
        ELIF (Perc == CPD_DUTYSUM)
            Sum1 = PaySum*Sum/100;
        ELIF (Perc == CPD_SUM)
            Sum1 = SumPay6*Sum/100;
        ELIF (Perc == CPD_OVERPAYSUM)
            Sum1 = (SumPay6 - Sum6)*Sum/100;
        ELSE
            Sum1 = $0;
        END;

        IF (Sum1 < $0)
            Sum1 = $0;
        END;
        RETURN round(Sum1);
    END;

    MACRO ПроверитьПротиворечияДляШтрафов()
        VAR Penny:integer = 0;
        VAR Flag:bool = true;
        VAR LastIF:integer = 0;
        VAR Sum:moneyl;

        WHILE(i < ArIdDt.size)
            IF ((ArIdDt(i).BD <= PayDate) AND
                (ArIdDt(i).DT >= PayDate))
                FineCond.rec.ID = ArIdDt(i).ID;
                IF (FineCond.GetEQ)
                    IF (FineCond.rec.FineTypeSum == 0)
                        Sum = FineCond.rec.FineSum;
                    ELSE
                        Sum = CalcPennySum(double(FineCond.rec.FineSum), FineCond.rec.CalcFinePerc);
                    END;
                    ConvSum(Sum, Sum, PayDate, FineCond.rec.FineCurrency);
                    IF (FineCond.rec.FineSum != $0)
                        Penny = Penny + 1;
                        LastIF = i;
                    END;
                END;
            END;
            i = i + 1;
        END;

        IF ((Penny > 1))
            MsgBox("Условия досрочного погашения противоречивы, принимается последнее!");
            Противоречие = true;
            i = LastIF;
        ELSE
            Противоречие = false;
            i = 0;
        END;
    END;

    if(ObjID == LO_DUTY)
        Loans_FindDuty(ObjN, Обязательство);
        CreditNumber = Обязательство.CreditNumber_Ref;
    end;

    if(ObjID == LO_CREDIT)
        CreditNumber = ObjN;
    end;
    
    Loans_FindCrdContract(CreditNumber, Договор);

    SP = $0;

    SP = LnSelectValue("SELECT Sum(t_Sum) FROM dpayment_tmp WHERE " +
                                       "     t_ParentID != 0 "
                                       " and t_ObjID     = " + ObjID +
                                       " and t_ObjN      = " + ObjN +
                                       " and t_RegID    != " + TDR_PENNY, V_MONEY);

    SumPay6 = LnSelectValue("SELECT t_PaySum FROM dpayment_tmp WHERE " +
                                       "     t_ParentID != 0 "
                                       " and t_ObjID     = " + ObjID +
                                       " and t_ObjN      = " + ObjN +
                                       " and t_RegID     = " + TDR_MAINREST, V_MONEY);

    Sum6 = LnSelectValue("SELECT t_Sum FROM dpayment_tmp WHERE " +
                                       "     t_ParentID != 0 "
                                       " and t_ObjID     = " + ObjID +
                                       " and t_ObjN      = " + ObjN +
                                       " and t_RegID     = " + TDR_MAINREST, V_MONEY);


    mdb.rewind;
    WHILE((NOT found) and (mdb.next))
        IF ((mdb.rec.ObjID == ObjID)       and
            (mdb.rec.ObjN == ObjN)         and
            (mdb.rec.ParentID != 0)        and
            (mdb.rec.Reference == DS_FINE) and
            (mdb.rec.RegID == TDR_PENNY))
            found = true;
        END;
    END;

    if(NOT found)
        return 1;
    end;

    Type = Договор.FineCond;
    ПолучитьДатыДляШтрафов();

    ConvSum(SP, SP, PayDate, Договор.CurCode);

    ПроверитьПротиворечияДляШтрафов();

    ConvSum(tmp_sum, PaySum, PayDate, Договор.CurCode);

    WHILE (i < ArIdDt.size)
        IF ((ArIdDt(i).BD <= PayDate) AND
            (ArIdDt(i).DT >= PayDate))
            FineCond.rec.ID = ArIdDt(i).ID;
            IF (FineCond.GetEQ)
                IF (FineCond.rec.FineTypeSum == 0)
                    SX = FineCond.rec.FineSum;
                ELSE
                    SX = CalcPennySum(double(FineCond.rec.FineSum), FineCond.rec.CalcFinePerc);
                END;
                ConvSum(SX, SX, PayDate, FineCond.rec.FineCurrency);

                IF ( (tmp_sum > SP) AND
                     (tmp_sum < (SP+SX))
                   )
                    IF (GetTrue(TRUE, "Досрочное погашение данной суммы запрещено. Продолжить?") == FALSE)
                        mdb.rec.PaySum = $0;
                        mdb.update;
                        RETURN 1;
                    END;
                END;

                IF ((tmp_sum >= (SP + SX)) OR
                    (tmp_sum >  (SP + SX)))
                    mdb.rec.PaySum = $0;
                    mdb.update;
                    IF ({GROUP_MODE})
                        RETURN 1;
                    ELSE
                        IF (GetTrue(TRUE, "Досрочное погашение данной суммы запрещено. Продолжить?") == FALSE)
                            RETURN 1;
                        ELSE
                            RETURN 0;
                        END;
                    END;
                END;
                
                if(FineCond.rec.CalcFinePerc != CPD_OVERPAYINCPEN)                    
                    IF (FineCond.rec.FineTypeSum == 0)
                        mdb.rec.PaySum = FineCond.rec.FineSum;
                    ELSE
                        mdb.rec.PaySum = CalcPennySum(double(FineCond.rec.FineSum), FineCond.rec.CalcFinePerc);
                    END;
                else
                    mdb.rec.PaySum = CalcPennySum(double(FineCond.rec.FineSum), FineCond.rec.CalcFinePerc);
                end;

                if(PaySum != $0)
                    ConvSum(tmp_sum1, mdb.rec.PaySum, PayDate, FineCond.rec.FineCurrency);
                    IF (FineCond.rec.FineCurrency != Договор.CurCode)
                        ConvSum(mdb.rec.PaySum, mdb.rec.PaySum, PayDate, FineCond.rec.FineCurrency, Договор.CurCode);
                    END;
                end;
            END;
        END;
        IF (Противоречие)
            i = ArIdDt.size;
        END;
        i = i + 1;
    END;
    
    mdb.rec.PaySum = round(mdb.rec.PaySum);
    mdb.rec.Sum = mdb.rec.PaySum;
    mdb.update;

    RETURN 0;
END;

 */