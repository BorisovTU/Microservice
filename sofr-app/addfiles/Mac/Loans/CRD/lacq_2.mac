import SbCrdInter, total, "macperc.mac";

record ШагОперации ("step_op.dbt",  "loans.def");
record Документ    ("doc_acc.dbt",  "loans.def");
record Операция    ("crd_op.dbt",   "loans.def");
record Договор     ("credit_c.dbt", "loans.def");
record Цессия      ("credit_c.dbt", "loans.def");
record Сумма       ("SUM.",         "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var stat:integer;
   var rs = null;

macro ИзменитьРегистры(objid, objn)
var stat:integer, paytype;
var ОснДолг, ПрДолг, Начисленные, Доначисленные, Просроченные, НеустойкаПроц, НеустойкаДолг, ЛимитВыд, НеиспЛимитВыд, ЛимитЗад, НеиспЛимитЗад, ДоступныйЛимит;
   stat = 0;
   paytype = LnSelectValue ("select t_paytype from dcredit_c_dbt where t_creditnumber = " + objn, V_INTEGER);
   
   ОснДолг       = GetPaySum(DS_DUTY,        objid, objn);
   ПрДолг        = GetPaySum(DS_EXPDUTY,     objid, objn);
   Начисленные   = GetPaySum(DS_PERC,        objid, objn);
   Доначисленные = GetPaySum(DS_ADDPERC,     objid, objn);
   Просроченные  = GetPaySum(DS_EXPPERC,     objid, objn);
   НеустойкаПроц = GetPaySum(DS_EXPPERCFINE, objid, objn);
   НеустойкаДолг = GetPaySum(DS_EXPDUTYFINE, objid, objn);

   ЛимитВыд      = LnSelectValue ("SELECT sum(t_paysum) FROM dpayment_tmp WHERE t_parentid != 0 AND t_isoperation != 'X' AND t_regid =  " + TDR_LIMPAY    + " AND t_objid = " + objid + " AND t_objn = " + objn, V_MONEY);
   ЛимитЗад      = LnSelectValue ("SELECT sum(t_paysum) FROM dpayment_tmp WHERE t_parentid != 0 AND t_isoperation != 'X' AND t_regid =  " + TDR_LIMDUTY   + " AND t_objid = " + objid + " AND t_objn = " + objn, V_MONEY);
   НеиспЛимитВыд = LnSelectValue ("SELECT sum(t_paysum) FROM dpayment_tmp WHERE t_parentid != 0 AND t_isoperation != 'X' AND t_regid =  " + TCLTR_LIMPAY  + " AND t_objid = " + objid + " AND t_objn = " + objn, V_MONEY);
   НеиспЛимитЗад = LnSelectValue ("SELECT sum(t_paysum) FROM dpayment_tmp WHERE t_parentid != 0 AND t_isoperation != 'X' AND t_regid =  " + TCLTR_LIMDUTY + " AND t_objid = " + objid + " AND t_objn = " + objn, V_MONEY);

   stat = ИзменитьРегистр(objid, objn, TDR_PERC_ACQCRD, 0, Начисленные + Доначисленные, Операция.CredOperID);

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_MAINREST, 0, ОснДолг, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_EXPREST, 0, ПрДолг, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_CLAIM, 0, Начисленные, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_EXPPERC_ACQ, 0, Просроченные, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_EXPPERC, 0, Просроченные, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_PENALTI_PERC, 0, НеустойкаПроц, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_PENALTI_CRD,  0, НеустойкаДолг, Операция.CredOperID);
   end;

   if(objid == LO_CREDIT)
      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TDR_ACQCRD,  0, Сумма(0), Операция.CredOperID);
      end;

      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TDR_LIMPAY,  0, ЛимитВыд, Операция.CredOperID);
      end;
      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TCLTR_LIMPAY,  0, НеиспЛимитВыд, Операция.CredOperID);
      end;
      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TDR_LIMDUTY,  0, ЛимитЗад, Операция.CredOperID);
      end;
      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TCLTR_LIMDUTY,  0, НеиспЛимитЗад, Операция.CredOperID);
      end;

      if(paytype == CF_CRLIN)
         ДоступныйЛимит = min(НеиспЛимитВыд, НеиспЛимитЗад);
      elif(paytype == CF_CRLINNO)
         ДоступныйЛимит = НеиспЛимитВыд;
      elif(paytype == CF_CRLINNEW)
         ДоступныйЛимит = НеиспЛимитЗад;
      else
         ДоступныйЛимит = 0;
      end;

      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TDR_AVAILABLELIMIT,  0, ДоступныйЛимит, Операция.CredOperID);
      end;
   end;

   return stat;
end;

   setbuff(Сумма, Sum);

   stat = ИзменитьРегистры(LO_CREDIT, Договор.CreditNumber);

   rs = LnGetRecordSet("SELECT t_dutyid FROM dduty_crd_dbt d WHERE d.t_creditnumber_ref = " + Договор.CreditNumber);
   if (rs != NULL)
       while (rs.MoveNext())
          if (stat == 0)
             stat = ИзменитьРегистры(LO_DUTY, rs.Value("t_dutyid", NULL, V_INTEGER));
          end;
       end;
   end;

   return stat;
end;
