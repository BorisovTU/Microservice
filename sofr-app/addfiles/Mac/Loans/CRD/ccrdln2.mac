/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ccrdln2.mac
 Description : Создание документа

 Programmer  : PA
 30.05.01    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, "total";

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var stat = 0;
   
   IF (((Договор.crd_kind == LO_CREDIT) and ((Договор.PayType == CF_CRLIN) or (Договор.PayType == CF_CRLINNEW))) 
         OR (Договор.crd_kind == LO_OVERDRAFT) OR (Договор.crd_kind == LO_KARTA))

      IF ((Договор.crd_kind == LO_OVERDRAFT) OR (Договор.crd_kind == LO_KARTA))
         Документ.CarrySum = ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMDUTY, OperDate);
      ELSE
         Документ.CarrySum = ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TDR_AVAILABLELIMIT, OperDate);
      END;
      stat = СоздатьДокумент (Документ);
  
      stat = ИзменитьРегистр (Договор.Crd_kind, Договор.CreditNumber, TDR_AVAILABLELIMIT, 0, -ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TDR_AVAILABLELIMIT, OperDate), Операция.CredOperID);
      IF (stat != 0) RETURN stat END;

      stat = ИзменитьРегистр (Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMDUTY, 0, -ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMDUTY, OperDate), Операция.CredOperID);
      IF (stat != 0) RETURN stat END;
  
      stat = ИзменитьРегистр (Договор.Crd_kind, Договор.CreditNumber, TDR_LIMDUTY,   0, -ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TDR_LIMDUTY,   OperDate), Операция.CredOperID);
      IF (stat != 0) RETURN stat END;
   
      stat = ИзменитьРегистр (Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMPAY,  0, -ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMPAY,  OperDate), Операция.CredOperID);
      IF (stat != 0) RETURN stat END;
  
      stat = ИзменитьРегистр (Договор.Crd_kind, Договор.CreditNumber, TDR_LIMPAY,    0, -ОстатокРегистра (Договор.Crd_kind, Договор.CreditNumber, TDR_LIMPAY,    OperDate), Операция.CredOperID);
      IF (stat != 0) RETURN stat END;
   END;
   RETURN stat;
END;