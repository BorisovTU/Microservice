/*
$Name:             agrref.mac
$Module:           Кредитование
$Description:      Соглашение о рефинансировании
*/
import ActiveX, total, replib, dlwreps, replib, global, acc_crd, SbCrdInter;

private record credit_c ("credit_c.dbt", "loans.def");
private const TemplateName = "agrref.dot";
private record cur_credit ("credit_c", "loans.def");
private file   bankdprt    ("bankdprt.dbt", "bank.def");


// получить почтовый адрес
macro GetPostAdr (partyID: integer)
   var rs = null;
   var RSDcmd = null;
   var PostAdr:string = "";

   RSDcmd = RsdCommand(RslDefCon, "SELECT t_adress FROM dadress_dbt WHERE t_type = ? and t_partyID = ?");
  
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = PTADDR_POST; // Почтовый адрес
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = partyID;
   rs = RsdRecordset(RSDcmd);
   RSDcmd.execute;

   if ((rs != null) and (rs.MoveNext()) and (rs.value(0, null, V_STRING) != null))
      PostAdr = rs.value(0, null, V_STRING);
   end;
   
   return PostAdr;
end;

macro RunReport(CreditBuf)

   var axerr:object = null, Code:string , INN:string, coracc:string = "";

      SetBuff(credit_c, CreditBuf);
      private var   OurBank = TLoansClient;

      if(not OurBank.GetRecord({OurBank}))
         Exit(1);
      end;
      if (not depclnt.GetRecord(credit_c.ClientID_Ref))
          RunError ("Не найден заещик в справочнике клиентов");
      end;

      bankdprt.partyid = credit_c.ClientID_Ref;
      if(getEQ(bankdprt))                       
          coracc = bankdprt.coracc;
      end;

      SetOutput (GetTxtFileName("agrref_rep"));
      
      println(TemplateName);             //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа


      /*Дата начала соглашения*/
      [~AG_DATE];
      println (DateToStringFull (credit_c.RegDate));
      /* Сокращенное имя контрагнета */
      [~Client];
      println(depclnt.ShortName);

       /* Юридический адрес банка */
      [~C_Address];
      println (depclnt.AddressF);
      /* Фактический адрес контрагента */
      [~C_AddressF];
      println (depclnt.AddressF);

      /* БИК */
      [~C_BIC];
      println(depclnt.GetCode(3/*БИК*/));
      [~C_BIC2];
      println(depclnt.GetCode(3/*БИК*/));

      /* Коррсчет контрагента*/
      [~C_CorrAcc];
      println(coracc);
      /* Коррсчет контрагента*/
      [~C_CorrAcc2];
      println(coracc);
      /* Название банка-контрагента*/
      [~C_Name];
      println(depclnt.Name);
      [~C_OGRN];
      println(depclnt.GetCode(27/*ОГРН*/));
      /* Электронная почта банка-контрагента*/
      [~C_email];
      println(GetEmail(depclnt.CodClient));
      /*почтовый адрес клиента*/
      [~C_AddressP];
      println(GetPostAdr(credit_c.ClientID_Ref));

      Code = depclnt.GetCode(16/*ИНН*/);

      IF (Trim(Code) != "")
         IF (Index(Code, "/") != 0)
            INN        = SubStr(Code, 1,                  Index(Code, "/") - 1);  // ИНН
         ELSE
            INN        = Code;
         END;
      END;

      /* ИНН */
      IF (INN==NULL)
          INN = "";
      END;

      [~C_INN];
      println(INN);


      Code = CONST_INN;

      IF (Trim(Code) != "")
        IF (Index(Code, "/") != 0)
           INN        = SubStr(Code, 1,                  Index(Code, "/") - 1);  // ИНН
        ELSE
           INN        = Code;
        END;
      END;

         /* ИНН */
      IF (INN==NULL)
          INN = "";
      END;

      [~B_INN];
      println(INN);

      /* Сокращенное название банка*/
      [~Bank];
      println(OurBank.ShortName);
      /* Юридический адрес банка */
      [~B_Address];
      println (OurBank.Address );
       /* Фактический адрес банка */
      [~B_AddressF];
      println (OurBank.AddressF );
      /* Коррсчет банка*/
      [~B_CorrAcc];
      println ( CONST_CORRACC );
      /* Коррсчет банка*/
      [~B_CorrAcc2];
      println ( CONST_CORRACC );
      /*название банка*/
      [~B_Name];
      println(CONST_NAMEBANK);
      /*БИК*/
      [~B_BIC];
      println(CONST_BIK);
       /* Электронная почта банка-контрагента*/
      [~B_email];
      println(GetEmail(OurBank.CodClient));
      [~B_OGRN];
      println(OurBank.GetCode(27/*ОГРН*/));
      /*почтовый адрес клиента*/
      [~B_AddressP];
      println(GetPostAdr({OurBank}));

   var tag = SetOutput (NULL, false);
   return tag;

   onError(axerr)
      SetOutput(NULL, false);
      RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Соглашение о рефинансировании сформировано.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;
