/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pzpk_15.mac
 Description : Создание документа по шагу операции (списание переплаты)

 Programmer  : Zigel Petr
 07.10.08    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, macperc;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var stat   : integer = 0;
    var AllSum : moneyl;
    var PaySum  : money = $0;

    SetBuff (DutyData, Data);

    if (DutyData.PayTypeID == LPM_ALLPAY)
       Документ.InDocID = DutyData.PaymentID;
    end;

    PaySum = GetPaySum(DS_DUTY, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
    AllSum = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_MAINREST, OperDate);

    if (PaySum > AllSum)
        Документ.CarrySum = PaySum - AllSum;
        stat = СоздатьДокумент (Документ);
    end;

    return stat;
end;
