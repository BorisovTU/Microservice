/*
$Name:              enscontr.mac
$Module:            Кредитование
$Description:       Макрос для работы с ДО
*/
/*******************************************************************************
 * RS-Loans                                                                    *
 * --------------------------------------------------------------------------- *
 * Description | Скроллинг всех ДО                                             *
 * Programmer  | Kopacheva Olga                                                *
 * Date        | 31.03.2009                                                    *
 *******************************************************************************/
import total;

/* Установка подсказки для скролингов из макроса */
MACRO УстановитьПодсказку(TableName:string, IndexNum:integer, DefaultHint:string, oper:integer):string
 VAR hnt = " ";
 
 RETURN "/*+FIRST_ROWS*/";

 hnt = "/*+ INDEX(t denscontr_dbt_idx1) INDEX(crd dcredit_c_dbt_idx0) INDEX(fininstr dfininstr_dbt_idx0) " +
       " INDEX(type_ens dtype_ens_dbt_idx0) INDEX(party dparty_dbt_idx0) " +
       " */ ";
 
 return hnt;
END;

/* Функция позволяет установить SQL запрос для ОБЩЕГО скроллинга ДО */
/* ClientType - Клиенты (5 - общий список)                          */
/* Если функция вернула FALSE то строится по умолчанию выборка      */
/* Если функция вернула СТРОКУ, она подставляется в SQL запрос      */
MACRO GetSQLQuery(ClientType)
VAR sql_query_crd : STRING = "",
    sql_query_kart: STRING = "",
    sql_query_over: STRING = "",
    sql_query_guar: STRING = "",
    sql_query_gengr:STRING = "",
    sql_query_genov:STRING = "",
    sql_query_claim:STRING = "";


   // Пока выборку строит сишник, если надо можно убрать RETURN и должно работать так же
   RETURN FALSE;
  
   IF (NOT(GetObjectRestriction (sql_query_crd ,  36, {oper}, "crd")) OR
       NOT(GetObjectRestriction (sql_query_kart , 40, {oper}, "crd")) OR
       NOT(GetObjectRestriction (sql_query_over , 48, {oper}, "crd")) OR
       NOT(GetObjectRestriction (sql_query_guar , 44, {oper}, "crd")) OR
       NOT(GetObjectRestriction (sql_query_gengr, 85, {oper}, "crd")) OR
       NOT(GetObjectRestriction (sql_query_genov, 89, {oper}, "crd")) OR
       NOT(GetObjectRestriction (sql_query_claim, 55, {oper}, "claim")))
     LoansError("Ошибка чтения параметров СУД");
     RETURN FALSE;
   END;

   VAR result, typeCRD = " ", typeClm = " ";
   IF (ClientType != 5)
      typeCRD = " AND crd.T_TypeDebtor   = " + ClientType;
      typeClm = " AND claim.T_TypeDebtor = " + ClientType;
   END;

   result = "(NOT EXISTS (SELECT 1 FROM DENS_CRD_DBT WHERE t.T_ENSCONTRACTID = T_ENSCONTRACTID_REF) " +
                           " OR  EXISTS (SELECT 1 FROM DENS_CRD_DBT ens, DCREDIT_C_DBT crd WHERE t.T_ENSCONTRACTID = T_ENSCONTRACTID_REF " +
                           " AND CRD.T_CREDITNUMBER = ENS.T_CREDITNUMBER_REF" +
                           typeCRD + 
                                       " AND((crd.T_CRD_KIND = 1  AND " + sql_query_crd  + ")"+
                                        " OR (crd.T_CRD_KIND = 8  AND " + sql_query_kart + ")"+
                                        " OR (crd.T_CRD_KIND = 22 AND " + sql_query_over + ")"+
                                        " OR (crd.T_CRD_KIND = 21 AND " + sql_query_guar + ")"+
                                        " OR (crd.T_CRD_KIND = 25 AND " + sql_query_gengr+ ")"+
                                        " OR (crd.T_CRD_KIND = 26 AND " + sql_query_genov+ "))"+
                                          ") "+
                           " OR  (t.T_CLAIMID_REF > 0 AND EXISTS (SELECT 1 FROM DCLAIM_DBT claim WHERE t.T_CLAIMID_REF = claim.t_ClaimID"+
                                     typeClm +
                                   " AND " + sql_query_claim + ")"+
                          "))";

   RETURN result;
END;