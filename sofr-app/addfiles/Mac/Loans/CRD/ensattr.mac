/*
$Name:               ensattr.mac
$Module:            Кредитование
$Description:      Макрос ДОПОЛНИТЕЛЬНЫЕ АТТРИБУТЫ ОО
*/
/*
  RS-Loans

  ДОПОЛНИТЕЛЬНЫЕ АТТРИБУТЫ ОО

  Programmer: TFS
  Date      : 01.08.13
 */

import SbCrdInter, total;

VAR FT_INT     = 0,
    FT_DOUBLE  = 4,
    FT_STRING  = 7,
    FT_DATE    = 9,
    FT_CHR     = 12,
    FT_NUMERIC = 25;

VAR ESC  = 27,
    F3   = 317,
    F9   = 323,
    SHF6 = 345;
    
PRIVATE VAR ens_obj = TBFile("ensobj.dbt");

IMPORT RsbFormsInter;

// Для вида обеспечения <Транспортное средство>
CLASS (TRsbPanel) CarBaseParm(ID)

   VAR EnsObjectID : integer = 0,
       SaveValue   : TArray = TArray(),
	   HistoryFlag   : TArray = TArray(),
	   DateArray   : TArray = TArray();
   // constructor
   MACRO Init()
      SetSize    (71, 9); 
      SetPosition(1,  10);
      
      setCaption("Дополнительные атрибуты ОО");
      setStatus("~ESC~ Выход  ~SPACE~ Переключить  ~SHIFT-F6~ Пользовательские поля  ~F3~ Выбор  ~F9~ Ввод");
      
      VAR control = TRsbEditField;
      
      addLabel(TRsbLabel(1, 0, "Владелец ТС:"));
      
      control.name       = "Vlad";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(15, 0);
      control.setSize    (56, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 1, "Номер ТС:"));
      
      control = TRsbEditField;
      control.name       = "NomerTS";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(11, 1);
      control.setSize    (60, 1);
      control.Editable  = true;
      addControl(control);

      addLabel(TRsbLabel(1, 2, "VIN-номер ТС:"));
      
      control = TRsbEditField;
      control.name       = "VIN_TS";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(11, 2);
      control.setSize    (60, 1);
      control.Editable  = true;
      addControl(control);      
      
      addLabel(TRsbLabel(1, 3, "------Технический паспорт----------------------------------------------------"));
      
      addLabel(TRsbLabel(1, 4, "Кем выдан:"));
      
      control = TRsbEditField;
      control.name       = "KemVid";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(11, 4);
      control.setSize    (60, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 5, "Дата выдачи:"));
      
      control = TRsbEditField;
      control.name       = "DatVid";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(13, 5);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 6, "------Свидетельство о регистрации ТС-----------------------------------------"));
      
      addLabel(TRsbLabel(1, 7, "Кем выдан:"));
      control = TRsbEditField;
      control.name       = "KemVid2";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(11, 7);
      control.setSize    (60, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 8, "Дата выдачи:"));
      
      control = TRsbEditField;
      control.name       = "DatVid2";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(13, 8);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(5, 9, "Признак постановки на учет ПТС"));
      
      control = TRsbCheckBox;
      control.name       = "Priz";
      control.dataType   = FT_CHR;
      control.setPosition(1, 9);
      addControl(control);
      
      addEventHandler(RSB_EV_KEY_PRESSED, r2m(this, "eventHandler"));
   END;
   
   MACRO GetDate(UsField: integer)
	//Проверка флага хранения истории  
	HistoryFlag(UsField) = " ";
	HistoryFlag(UsField) = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
		     " L.T_PARENTID = ? " +
		 " AND L.T_REFERENS = ? " +
		 " AND LF.T_USFLAGID_REF = ? " +
		 " AND LF.T_USFIELDID_REF = ? " +
		 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
		     "p1", LO_ENSOBJECT,
		     "p2", ens_obj.rec.ENSTYPEID_REF,
		     "p3", 4,
		     "p4", UsField,
		      V_STRING);
		
	//установка даты сохранения и получения данных
	DateArray(UsField) = {curdate};
		
	IF (HistoryFlag(UsField) != "X")
			VAR RS_1 = CRSDCommand("SELECT T_USFIELDVALDATE  from dlufvalue_dbt val, dlufotype_dbt luf WHERE " +
				 " LUF.T_OBJECTID_REF = ? " +
			 " AND LUF.T_OBJID_REF = ? " +
			 " AND LUF.T_USFIELDID_REF = ? " +
			 " AND VAL.T_USFOBJTYPEID_REF = LUF.T_USFOBJTYPEID",
			"p1", LO_ENSOBJECT,
			"p2", ens_obj.rec.ENSOBJECTID,
			"p3", UsField,
			V_GENOBJ);
			IF (RS_1.MoveNext)
				DateArray(UsField) = SQL_NVL(RS_1.Value(0), V_DATE);
			END;
	end;
   END;

   MACRO SetDefaultValue(NameFld: string, UsField: integer)
      VAR RS = CRSDCommand("SELECT T_ISDIRONLY, T_USFIELDTYPE FROM DLUFIELD_DBT WHERE T_USFIELDID = ?", "p1", UsField, V_GENOBJ);
      IF (NOT RS.MoveNext)
          RETURN;
      END;

      // Запрет редактирования
      VAR ReadOnly = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
                     " L.T_PARENTID = ? " +
                 " AND L.T_REFERENS = ? " +
                 " AND LF.T_USFLAGID_REF = ? " +
                 " AND LF.T_USFIELDID_REF = ? " +
                 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
                     "p1", LO_ENSOBJECT,
                     "p2", ens_obj.rec.ENSTYPEID_REF,
                     "p3", 3,
                     "p4", UsField,
                      V_STRING);

      // Запрет редактирования(не установлен признак построения панели доп. атрибутов ОО)
      VAR ReadOnly1 = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
		     " L.T_PARENTID = ? " +
		 " AND L.T_REFERENS = ? " +
		 " AND LF.T_USFLAGID_REF = ? " +
		 " AND LF.T_USFIELDID_REF = ? " +
		 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
		     "p1", LO_ENSOBJECT,
		     "p2", ens_obj.rec.ENSTYPEID_REF,
		     "p3", 5,
		     "p4", UsField,
		      V_STRING);
      GetDate(UsField);
			  
      IF (SQL_NVL(RS.Value(0), V_STRING) == "X")
         getControl(NameFld).editable = FALSE;
      ELSE
         getControl(NameFld).editable = TRUE;
      END;

      IF ((ReadOnly == "X") OR (ReadOnly1 != "X"))
         getControl(NameFld).focusable = FALSE;
         getControl(NameFld).editable  = FALSE;
      ELSE
         getControl(NameFld).focusable = TRUE;
      END;

      IF (getControl(NameFld).dataType != SQL_NVL(RS.Value(1), V_INTEGER))
          getControl(NameFld).dataType = SQL_NVL(RS.Value(1), V_INTEGER);
      END;

      IF (getControl(NameFld).dataType == FT_STRING)
         getControl(NameFld).textLength = 500;
      END;

	//Установка значения при отрытии панели
        IF (getControl(NameFld).dataType == FT_STRING)

		IF (GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField))=="\X01") 
			getControl(NameFld).Value    = "";
		ELSE
			getControl(NameFld).Value    = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField));
		END;		
	ELIF (getControl(NameFld).dataType == FT_CHR)
	      IF (GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField)) == "X")
		 getControl(NameFld).checked = TRUE;
	      ELSE
		 getControl(NameFld).checked = FALSE;
	      END;
	ELSE
		getControl(NameFld).Value    = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField));
        END;

      VAR isVisible = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
                     " L.T_PARENTID = ? " +
                 " AND L.T_REFERENS = ? " +
                 " AND LF.T_USFLAGID_REF = ? " +
                 " AND LF.T_USFIELDID_REF = ? " +
                 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
                     "p1", LO_ENSOBJECT,
                     "p2", ens_obj.rec.ENSTYPEID_REF,
                     "p3", 1,
                     "p4", UsField,
                      V_STRING);
      IF (isVisible != "X")
         getControl(NameFld).focusable = FALSE;
         getControl(NameFld).editable  = FALSE;
         getControl(NameFld).Value     = "";
      END;
   END;

   MACRO SetValue()
      // "Владелец ТС:"
      SetDefaultValue("Vlad", 174 /* Владелец транспортного средства */);

      // "Номер ТС:"
      SetDefaultValue("NomerTS", 175 /* Номер транспортного средства */);

      // "VIN-номер ТС:"
      SetDefaultValue("VIN_TS", 212 /* VIN-номер транспортного средства */);
      
      // "Кем выдан:"
      SetDefaultValue("KemVid", 172 /* Организация, выдавшая технический паспорт */);

      // "Дата выдачи:"
      SetDefaultValue("DatVid", 173 /* Дата выдачи технического паспорта */);

      // "Кем выдан:"
      SetDefaultValue("KemVid2", 176 /* Организация */);

      // "Дата выдачи:"
      SetDefaultValue("DatVid2", 177 /* Дата выдачи свидетельства о регистрации ТС */);
      

      // "Признак постановки на учет ПТС"
      SetDefaultValue("Priz", 181  /* Признак постановки на учет ПТС */);
	
      FOR (VAR I, 0, numControls - 2)
         IF (ValType(GetControl(I).Value) != V_UNDEF)
            SaveValue(I) = GetControl(I).Value;
         ELSE
            SaveValue(I) = "";
         END;
      END;
      IF (GetControl("Priz").checked)
         SaveValue(SaveValue.Size) = "X";
      ELSE
         SaveValue(SaveValue.Size) = "";
      END;
   END;

   MACRO SaveValues()
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 174, 0, getControl("Vlad").Value,    true, DateArray(174));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 175, 0, getControl("NomerTS").Value, true, DateArray(175));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 172, 0, getControl("KemVid").Value,  true, DateArray(172));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 173, 0, getControl("DatVid").Value,  true, DateArray(173));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 176, 0, getControl("KemVid2").Value, true, DateArray(176));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 177, 0, getControl("DatVid2").Value, true, DateArray(177));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 212, 0, getControl("VIN_TS").Value, true, DateArray(212));

      IF (getControl("Priz").checked)
         SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 181, 0, "X", true, DateArray(181));
      ELSE
         SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 181, 0, "", true, DateArray(181));
      END;

      MsgBox("Данные успешно сохранены!");
   END;

   MACRO eventHandler(EV)
      IF (EV.KeyCode == F9)
         SaveValues();

         close(0);

         RETURN TRUE;
      END;

      IF (EV.KeyCode == SHF6)
         LoansUserField(LO_ENSOBJECT, EnsObjectID);
      END;

      IF (EV.KeyCode == ESC)
         FOR (VAR I, 0, numControls - 2)
            IF (GetControl(I).Value != SaveValue(I))
               IF (MsgBoxEx("Сохранить изменения?", MB_YES + MB_NO, IND_NO) == IND_YES)
                  SaveValues();
               END;
               RETURN TRUE;
            END;
         END;
         IF ((GetControl("Priz").checked AND (SaveValue(SaveValue.Size -1) != "X"))
             OR
             (NOT GetControl("Priz").checked AND (SaveValue(SaveValue.Size -1) == "X")))
            IF (MsgBoxEx("Сохранить изменения?", MB_YES + MB_NO, IND_NO) == IND_YES)
               SaveValues();
            END;
            RETURN TRUE;
         END;
      END;

      RETURN TRUE;
   END;

   IF ((ValType(ID) != V_INTEGER) OR (ID == 0))
      MsgBox("Не передан ID ОО");
      RETURN;
   END;

   ens_obj.rec.EnsObjectID = ID;
   IF (NOT ens_obj.getEQ())
      MsgBox("Не найден ОО №" + ID);
      RETURN;
   END;
   EnsObjectID = ens_obj.rec.EnsObjectID;

   InitTRsbPanel();
   Init();
   SetValue();
END;
/*
╔══════════════════   Дополнительные атрибуты ОО ════════════════════════╗
║  Владелец ТС:  <A1>                                                    ║
║  Номер ТС:  <A2>                                                       ║
║------Технический паспорт-----------------------------------------------║
║  Кем выдан:  <A3>                                                      ║
║  Дата выдачи: <A4>                                                     ║
║---------Свидетельство о регистрации ТС---------------------------------║
║  Кем выдано:  <A5>                                                     ║
║  Дата выдачи: <A6>                                                     ║
║  [<A7>]Признак постановки на учет ПТС                                  ║
╚════════════════════════════════════════════════════════════════════════╝
 */

// Для вида обеспечения <Дом с земельным участком>
CLASS (TRsbPanel) HomeBaseParm(ID)
   VAR EnsObjectID : integer = 0,
       OzenVal     : integer = 0,
       OzenUchVal1 : integer = 0,
       SaveValue   : TArray = TArray(),
       HistoryFlag : TArray = TArray(),
       DateArray   : TArray = TArray();
//constructor

   MACRO Init()
      SetSize    (71, 22); 
      SetPosition(1,  10);

      setCaption("Дополнительные атрибуты ОО");
      setStatus("~ESC~ Выход  ~SHIFT-F6~ Пользовательские поля  ~F3~ Выбор  ~F9~ Ввод");
   
      VAR control = TRsbEditField;
   
      addLabel(TRsbLabel(1, 0, "Адрес объекта:"));
   
      control.name       = "Adress";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(15, 0);
      control.setSize    (56, 2);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 2, "Оценочная стоимость дома:"));
      control = TRsbEditField;
      control.name       = "OzenDom";
      control.dataType   = FT_NUMERIC;
      control.valuePrecision = 2;
      control.setPosition(25, 2);
      control.setSize    (12, 1);
      control.Editable  = true;
      addControl(control);
   
      control = TRsbEditField;
      control.name       = "OzenVal";
      control.dataType   = FT_STRING;
      control.textLength = 4;
      control.setPosition(38, 2);
      control.setSize    (4, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 3, "--------------Договор купли-продажи дома-------------------------------------"));
   
      addLabel(TRsbLabel(1, 4, "Номер"));
      control = TRsbEditField;
      control.name       = "Nomer";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(7, 4);
      control.setSize    (25, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(35, 4, "Дата"));
      control = TRsbEditField;
      control.name       = "NomerData";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(40, 4);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 5, "Продавец"));
      control = TRsbEditField;
      control.name       = "Prodavec";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(10, 5);
      control.setSize    (60, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 6, "№ записи о регистрации"));
      control = TRsbEditField;
      control.name       = "Register";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(22, 6);
      control.setSize    (35, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 7, "Дата записи о регистрации"));
      control = TRsbEditField;
      control.name       = "DataRegister";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(25, 7);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 8, "--------Регистрационное свидетельство на дом---------------------------------"));
   
      addLabel(TRsbLabel(1, 9, "Серия"));
      control = TRsbEditField;
      control.name       = "Seria1";
      control.dataType   = FT_STRING;
      control.textLength = 20;
      control.setPosition(6, 9);
      control.setSize    (15, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(25, 9, "Номер"));
      control = TRsbEditField;
      control.name       = "Nomer1";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(30, 9);
      control.setSize    (22, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(55, 9, "Дата"));
      control = TRsbEditField;
      control.name       = "Data1";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(60, 9);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 10, "-----------------------------------------------------------------------------"));
   
      addLabel(TRsbLabel(1, 12, "Площадь земельного участка, кв.м"));
      control = TRsbEditField;
      control.name       = "Plosh";
      control.dataType   = FT_DOUBLE;
      control.textLength = 7;
      control.setPosition(31, 12);
      control.setSize    (7, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 13, "Оценочная стоимость участка:"));
      control = TRsbEditField;
      control.name       = "OzenUch1";
      control.dataType   = FT_NUMERIC;
      control.valuePrecision = 2;
      control.setPosition(28, 13);
      control.setSize    (12, 1);
      control.Editable  = true;
      addControl(control);
   
      control = TRsbEditField;
      control.name       = "OzenUchVal1";
      control.dataType   = FT_STRING;
      control.textLength = 4;
      control.setPosition(41, 13);
      control.setSize    (4, 1);
      control.Editable  = true;
      addControl(control);

      addLabel(TRsbLabel(1, 14, "--------Договор купли-продажи земельного участка-----------------------------"));
   
      addLabel(TRsbLabel(1, 15, "Номер"));
      control = TRsbEditField;
      control.name       = "Nomer2";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(7, 15);
      control.setSize    (22, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(31, 15, "Дата"));
      control = TRsbEditField;
      control.name       = "Data2";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(37, 15);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 16, "Продавец"));
      control = TRsbEditField;
      control.name       = "Prodavec2";
      control.dataType   = FT_STRING;
      control.textLength = 80;
      control.setPosition(10, 16);
      control.setSize    (60, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 17, "№ записи о регистрации"));
      control = TRsbEditField;
      control.name       = "Register2";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(22, 17);
      control.setSize    (35, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 18, "Дата записи о регистрации"));
      control = TRsbEditField;
      control.name       = "DataRegister2";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(25, 18);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
 
      addLabel(TRsbLabel(1, 19, "--------Регистрационное свидетельство на участок-----------------------------"));
      addLabel(TRsbLabel(1, 20, "Серия"));
      control = TRsbEditField;
      control.name       = "Seria3";
      control.dataType   = FT_STRING;
      control.textLength = 20;
      control.setPosition(6, 20);
      control.setSize    (15, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(25, 20, "Номер"));
      control = TRsbEditField;
      control.name       = "Nomer3";
      control.dataType   = FT_STRING;
      control.textLength = 35;
      control.setPosition(30, 20);
      control.setSize    (22, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(55, 20, "Дата"));
      control = TRsbEditField;
      control.name       = "Data3";
      control.dataType   = FT_DATE;
      control.textLength = 10;
      control.setPosition(60, 20);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
   
      addLabel(TRsbLabel(1, 21, "-----------------------------------------------------------------------------"));

      addEventHandler(RSB_EV_KEY_PRESSED, r2m(this, "eventHandler"));
   END;

   MACRO GetDate(UsField: integer)
	//Проверка флага хранения истории  
	HistoryFlag(UsField) = " ";
	HistoryFlag(UsField) = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
		     " L.T_PARENTID = ? " +
		 " AND L.T_REFERENS = ? " +
		 " AND LF.T_USFLAGID_REF = ? " +
		 " AND LF.T_USFIELDID_REF = ? " +
		 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
		     "p1", LO_ENSOBJECT,
		     "p2", ens_obj.rec.ENSTYPEID_REF,
		     "p3", 4,
		     "p4", UsField,
		      V_STRING);
		
	//установка даты сохранения и получения данных
	DateArray(UsField) = {curdate};
		
	IF (HistoryFlag(UsField) != "X")
			VAR RS_1 = CRSDCommand("SELECT T_USFIELDVALDATE  from dlufvalue_dbt val, dlufotype_dbt luf WHERE " +
				 " LUF.T_OBJECTID_REF = ? " +
			 " AND LUF.T_OBJID_REF = ? " +
			 " AND LUF.T_USFIELDID_REF = ? " +
			 " AND VAL.T_USFOBJTYPEID_REF = LUF.T_USFOBJTYPEID",
			"p1", LO_ENSOBJECT,
			"p2", ens_obj.rec.ENSOBJECTID,
			"p3", UsField,
			V_GENOBJ);
			IF (RS_1.MoveNext)
				DateArray(UsField) = SQL_NVL(RS_1.Value(0), V_DATE);
			END;
	end;
   END;

   MACRO SetDefaultValue(NameFld: string, UsField: integer, ChangeType: bool)
      VAR RS = CRSDCommand("SELECT T_ISDIRONLY, T_USFIELDTYPE FROM DLUFIELD_DBT WHERE T_USFIELDID = ?", "p1", UsField, V_GENOBJ);
      IF (NOT RS.MoveNext)
          RETURN;
      END;

      // Запрет редактирования
      VAR ReadOnly = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
                     " L.T_PARENTID = ? " +
                 " AND L.T_REFERENS = ? " +
                 " AND LF.T_USFLAGID_REF = ? " +
                 " AND LF.T_USFIELDID_REF = ? " +
                 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
                     "p1", LO_ENSOBJECT,
                     "p2", ens_obj.rec.ENSTYPEID_REF,
                     "p3", 3,
                     "p4", UsField,
                      V_STRING);

      // Запрет редактирования(не установлен признак построения панели доп. атрибутов ОО)
      VAR ReadOnly1 = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
		     " L.T_PARENTID = ? " +
		 " AND L.T_REFERENS = ? " +
		 " AND LF.T_USFLAGID_REF = ? " +
		 " AND LF.T_USFIELDID_REF = ? " +
		 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
		     "p1", LO_ENSOBJECT,
		     "p2", ens_obj.rec.ENSTYPEID_REF,
		     "p3", 5,
		     "p4", UsField,
		      V_STRING);
      GetDate(UsField);

      IF (SQL_NVL(RS.Value(0), V_STRING) == "X")
         getControl(NameFld).editable = FALSE;
      ELSE
         getControl(NameFld).editable = TRUE;
      END;

      IF ((ReadOnly == "X") OR (ReadOnly1 != "X"))
         getControl(NameFld).focusable = FALSE;
         getControl(NameFld).editable  = FALSE;
      ELSE
         getControl(NameFld).focusable = TRUE;
      END;

      IF ((ValType(ChangeType) == V_UNDEF) OR ((ValType(ChangeType) == V_BOOL) AND (ChangeType == TRUE)))
         IF (getControl(NameFld).dataType != SQL_NVL(RS.Value(1), V_INTEGER))
            getControl(NameFld).dataType = SQL_NVL(RS.Value(1), V_INTEGER);
         END;

         IF (getControl(NameFld).dataType == FT_STRING)
            getControl(NameFld).textLength = 500;
         END;

	//Установка значения при отрытии панели
        IF (getControl(NameFld).dataType == FT_STRING)

		IF (GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField))=="\X01") 
			getControl(NameFld).Value    = "";
		ELSE
			getControl(NameFld).Value    = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField));
		END;		
	ELSE 
		getControl(NameFld).Value    = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField));
        END;
      END;

      VAR isVisible = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
                     " L.T_PARENTID = ? " +
                 " AND L.T_REFERENS = ? " +
                 " AND LF.T_USFLAGID_REF = ? " +
                 " AND LF.T_USFIELDID_REF = ? " +
                 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
                     "p1", LO_ENSOBJECT,
                     "p2", ens_obj.rec.ENSTYPEID_REF,
                     "p3", 1,
                     "p4", UsField,
                      V_STRING);
      IF (isVisible != "X")
         getControl(NameFld).focusable = FALSE;
         getControl(NameFld).editable  = FALSE;
         getControl(NameFld).Value     = "";
      END;
   END;

   MACRO SetValue()
      VAR I;

      // "Адрес объекта:"
      SetDefaultValue("Adress",       135 /* Адрес объекта */);
   
      // "Оценочная стоимость дома:"
      SetDefaultValue("OzenDom",      158 /* Оценочная стоимость дома */);

      SetDefaultValue("OzenVal",      207 /* Валюта оценочной стоимости дома */, false);
      GetDate(207);
      OzenVal = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 207, DateArray(207));
      getControl("OzenVal").Value = FindShortName(OzenVal);
      getControl("OzenVal").editable  = FALSE;

      // "Номер"                     
      SetDefaultValue("Nomer",        149 /* № договора купли-продажи дома */);

      // "Дата"                      
      SetDefaultValue("NomerData",    150 /* Дата договора купли-продажи дома */);
     
      // "Продавец"                  
      SetDefaultValue("Prodavec",     151 /* Продавец по договору купли-продажи дома */);
     
      // "№ записи о регистрации"    
      SetDefaultValue("Register",     153 /* № записи о регистрации договора купли-продажи дома */);
   
      // "Дата записи о регистрации"
      SetDefaultValue("DataRegister", 152 /* Дата записи о регистрации договора купли-продажи дома */);
   
      // "Серия"
      SetDefaultValue("Seria1",       154 /* Серия регистрационного свидетельства (дом) */);
   
      // "Номер"
      SetDefaultValue("Nomer1",       155 /* № регистрационного свидетельства (дом) */);
   
      // "Дата"
      SetDefaultValue("Data1",        156 /* Дата регистрационного свидетельства (дом) */);
   
      // "Площадь земельного участка, кв.м"
      SetDefaultValue("Plosh",        159 /* Площадь земельного участка, кв.м. */);
   
      // "Оценочная стоимость участка:"
      SetDefaultValue("OzenUch1",     169 /* Оценочная стоимость земельного участка */);
      
      GetDate(209);
      SetDefaultValue("OzenUchVal1",  209 /* Валюта оценочной стоимости земельного участка */, false);
      OzenUchVal1 = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 209, DateArray(209));
      getControl("OzenUchVal1").Value = FindShortName(OzenUchVal1);
      getControl("OzenUchVal1").editable  = FALSE;

      // "Номер"
      SetDefaultValue("Nomer2",       160 /* № договора купли-продажи земельного участка */);
   
      // "Дата"
      SetDefaultValue("Data2",        161 /* Дата договора купли-продажи земельного участка */);
   
      // "Продавец"
      SetDefaultValue("Prodavec2",    162 /* Продавец по договору купли-продажи земельного участка */);
   
      // "№ записи о регистрации"
      SetDefaultValue("Register2",    164 /* № записи о регистрации договора купли-продажи участка */);
   
      // "Дата записи о регистрации"
      SetDefaultValue("DataRegister2",163 /* Дата записи о регистрации договора купли-продажи участка */);
 
      // "Серия"
      SetDefaultValue("Seria3",       165 /* Серия регистрационного свидетельства (участок) */);
   
      // "Номер"
      SetDefaultValue("Nomer3",       166 /* № регистрационного свидетельства (участок) */);
   
      // "Дата"
      SetDefaultValue("Data3",        167 /* Дата регистрационного свидетельства (участок) */);

      FOR (I, 0, numControls - 1)
         IF (ValType(GetControl(I).Value) != V_UNDEF)
            SaveValue(I) = GetControl(I).Value;
         ELSE
            SaveValue(I) = "";
         END;
      END;

      updateNavigationRoute();
   END;

   MACRO SaveValues()
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 135, 0, getControl("Adress").Value,        true, DateArray(135)); // "Адрес объекта"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 158, 0, getControl("OzenDom").Value,       true, DateArray(158)); // "Оценочная стоимость дома"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 207, 0, OzenVal,                           true, DateArray(207)); // "Валюта оценочной стоимости дома"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 149, 0, getControl("Nomer").Value,         true, DateArray(149)); // "Номер"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 150, 0, getControl("NomerData").Value,     true, DateArray(150)); // "Дата"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 151, 0, getControl("Prodavec").Value,      true, DateArray(151)); // "Продавец"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 153, 0, getControl("Register").Value,      true, DateArray(153)); // "№ записи о регистрации"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 152, 0, getControl("DataRegister").Value,  true, DateArray(152)); // "Дата записи о регистрации"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 154, 0, getControl("Seria1").Value,        true, DateArray(154)); // "Серия"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 155, 0, getControl("Nomer1").Value,        true, DateArray(155)); // "Номер"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 156, 0, getControl("Data1").Value,         true, DateArray(156)); // "Дата"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 159, 0, getControl("Plosh").Value,         true, DateArray(159)); // "Площадь земельного участка, кв.м"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 169, 0, getControl("OzenUch1").Value,      true, DateArray(169)); // "Оценочная стоимость участка:"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 209, 0, OzenUchVal1,                       true, DateArray(209)); // Валюта оценочной стоимости земельного участка
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 160, 0, getControl("Nomer2").Value,        true, DateArray(160)); // "Номер"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 161, 0, getControl("Data2").Value,         true, DateArray(161)); // "Дата"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 162, 0, getControl("Prodavec2").Value,     true, DateArray(162)); // "Продавец"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 164, 0, getControl("Register2").Value,     true, DateArray(164)); // "№ записи о регистрации"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 163, 0, getControl("DataRegister2").Value, true, DateArray(163)); // "Дата записи о регистрации"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 165, 0, getControl("Seria3").Value,        true, DateArray(165)); //"Серия"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 166, 0, getControl("Nomer3").Value,        true, DateArray(166)); // "Номер"
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 167, 0, getControl("Data3").Value,         true, DateArray(167)); // "Дата"

      MsgBox("Данные успешно сохранены!");
   END;

   MACRO eventHandler(EV)

      IF (EV.KeyCode == F3)
         IF    (FocusedControl.Name == "OzenVal")
            OzenVal = ListFinInstr();
            IF (OzenVal >= 0)
               getControl("OzenVal").Value = FindShortName(OzenVal);;
            END;
         ELIF (FocusedControl.Name == "OzenUchVal1")
            OzenUchVal1 = ListFinInstr();
            IF (OzenUchVal1 >= 0)
               getControl("OzenUchVal1").Value = FindShortName(OzenUchVal1);;
            END;
         END;
      END;

      IF (EV.KeyCode == F9)
         SaveValues();
         
         close(0);

         RETURN TRUE;
      END;

      IF (EV.KeyCode == SHF6)
         LoansUserField(LO_ENSOBJECT, EnsObjectID);
      END; 

      IF (EV.KeyCode == ESC)
         FOR (VAR I, 0, numControls - 1)
            IF (GetControl(I).Value != SaveValue(I))
               IF (MsgBoxEx("Сохранить изменения?", MB_YES + MB_NO, IND_NO) == IND_YES)
                  SaveValues();
               END;
               RETURN TRUE;
            END;
         END;
      END;

      RETURN TRUE;
   END;

//constructor
   IF ((ValType(ID) != V_INTEGER) OR (ID == 0))
      MsgBox("Не передан ID ОО");
      RETURN;
   END;

   ens_obj.rec.EnsObjectID = ID;
   IF (NOT ens_obj.getEQ())
      MsgBox("Не найден ОО №" + ID);
      RETURN;
   END;
   EnsObjectID = ens_obj.rec.EnsObjectID;

   InitTRsbPanel();
   Init();
   SetValue();

END;
/*
╔══════════════════  Дополнительные атрибуты ОО ════════════════════════╗
║ Адрес объекта:  <A1>                                                  ║
║                                                                       ║
║ Оценочная стоимость дома   <A2.1>            <A2.2>                   ║
║--------Договор купли-продажи дома-------------------------------------║
║ Номер  <A3>            Дата  <A4>                                     ║
║ Продавец   <A5>                                                       ║
║ № записи о регистрации <A6>                                           ║
║ Дата записи о регистрации <A7>                                        ║
║--------Регистрационное свидетельство на дом---------------------------║
║ Серия  <A8>   Номер  <A9>                Дата  <A10>                  ║
║-----------------------------------------------------------------------║
║                                                                       ║
║ Площадь земельного участка, кв.м  <A11>                               ║
║ Оценочная стоимость участка   <A12.1>            <A12.2>              ║
║--------Договор купли-продажи земельного участка-----------------------║
║ Номер  <A13>           Дата  <A14>                                    ║
║ Продавец   <A15>                                                      ║
║ № записи о регистрации <A16>                                          ║
║ Дата записи о регистрации <A17>                                       ║
║--------Регистрационное свидетельство на участок-----------------------║
║ Серия  <A18>   Номер  <A19>                Дата  <A20>                ║
║-----------------------------------------------------------------------║
║                                                                       ║
╚═══════════════════════════════════════════════════════════════════════╝
 */


// Для вида обеспечения <Квартира>
CLASS (TRsbPanel) FlatBaseParm(ID)

VAR EnsObjectID : integer = 0,
    InvestVal   : integer = 0,
    SaveValue   : TArray = TArray(),
    HistoryFlag : TArray = TArray(),
    DateArray   : TArray = TArray();

   MACRO Init()
      SetSize    (71, 15); 
      SetPosition(1,  14);
      
      setCaption("Дополнительные атрибуты ОО");
      setStatus("~ESC~ Выход  ~SHIFT-F6~ Пользовательские поля  ~F3~ Выбор  ~F9~ Ввод");
      
      VAR control = TRsbEditField;

      addLabel(TRsbLabel(1, 0, "Адрес объекта:"));
      
      control.name       = "Adress";
      control.dataType   = 7; //FT_STRING;
      control.textLength = 80;
      control.setPosition(15, 0);
      control.setSize    (56, 2);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 2, "№ записи о регистрации в гос. реестре:"));
      control = TRsbEditField;
      control.name       = "Register";
      control.dataType   = 7; //FT_STRING;
      control.textLength = 32;
      control.setPosition(36, 2);
      control.setSize    (35, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 3, "Дата записи о регистрации в гос. реестре"));
      control = TRsbEditField;
      control.name       = "DateRegister";
      control.dataType   = 9; //FT_DATE;
      control.textLength = 32;
      control.setPosition(38, 3);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 5, "Количество комнат"));
      control = TRsbEditField;
      control.name       = "KolVo";
      control.dataType   = 0; //FT_INT;
      control.textLength = 3;
      control.setPosition(18, 5);
      control.setSize    (3, 1);
      control.Editable  = true;
      addControl(control);

      addLabel(TRsbLabel(1, 6, "Полезная площадь, кв.м."));
      control = TRsbEditField;
      control.name       = "Ploshad";
      control.dataType   = FT_DOUBLE;
      control.textLength = 7;
      control.setPosition(23, 6);
      control.setSize    (7, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(34, 6, "Жилая площадь, кв. м."));
      control = TRsbEditField;
      control.name       = "Zil";
      control.dataType   = FT_DOUBLE;
      control.textLength = 7;
      control.setPosition(54, 6);
      control.setSize    (7, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 7, "Этаж"));
      control = TRsbEditField;
      control.name       = "Etaz";
      control.dataType   = 0; //FT_INT;
      control.textLength = 3;
      control.setPosition(6, 7);
      control.setSize    (3, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(13, 7, "Кол-во этажей в доме"));
      control = TRsbEditField;
      control.name       = "KolEtaz";
      control.dataType   = 0; //FT_INT;
      control.textLength = 3;
      control.setPosition(32, 7);
      control.setSize    (3, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 9, "Инвентаризационная стоимость квартиры"));

      control = TRsbEditField;
      control.name       = "Invest1";
      control.dataType   = FT_NUMERIC;
      control.valuePrecision = 2;
      control.setPosition(36, 9);
      control.setSize    (17, 1);
      control.Editable  = true;
      control.Value     = $0;
      addControl(control);

      control = TRsbEditField;
      control.name       = "InvestVal";
      control.dataType   = 7; //FT_STRING;
      control.textLength = 4;
      control.setPosition(54, 9);
      control.setSize    (3, 1);
      control.Editable  = true;
      addControl(control);

      addLabel(TRsbLabel(1, 11, "--------------Регистрационное свидетельство----------------------------------"));
      
      addLabel(TRsbLabel(1, 12, "Серия"));

      control = TRsbEditField;
      control.name       = "Ser1";
      control.dataType   = FT_STRING;
      control.textLength = 15;
      control.setPosition(7, 12);
      control.setSize    (15, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(26, 12, "Номер"));
      
      control = TRsbEditField;
      control.name       = "Ser2";
      control.dataType   = FT_STRING;
      control.textLength = 20;
      control.setPosition(32, 12);
      control.setSize    (20, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(55, 12, "Дата"));
      
      control = TRsbEditField;
      control.name       = "Ser3";
      control.dataType   = 9; //FT_DATE;
      control.textLength = 10;
      control.setPosition(60, 12);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(1, 14, "--------------Договор купли-продажи------------------------------------------"));
      
      addLabel(TRsbLabel(1, 15, "Номер"));
      
      control = TRsbEditField;
      control.name       = "Kup1";
      control.dataType   = FT_STRING;
      control.textLength = 15;
      control.setPosition(7, 15);
      control.setSize    (15, 1);
      control.Editable  = true;
      addControl(control);
      
      addLabel(TRsbLabel(26, 15, "Дата"));
      
      control = TRsbEditField;
      control.name       = "Kup2";
      control.dataType   = 9; //FT_DATE;
      control.textLength = 10;
      control.setPosition(33, 15);
      control.setSize    (10, 1);
      control.Editable  = true;
      addControl(control);

      addEventHandler(RSB_EV_KEY_PRESSED, r2m(this, "eventHandler"));
   END;

   MACRO GetDate(UsField: integer)
	//Проверка флага хранения истории  
	HistoryFlag(UsField) = " ";
	HistoryFlag(UsField) = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
		     " L.T_PARENTID = ? " +
		 " AND L.T_REFERENS = ? " +
		 " AND LF.T_USFLAGID_REF = ? " +
		 " AND LF.T_USFIELDID_REF = ? " +
		 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
		     "p1", LO_ENSOBJECT,
		     "p2", ens_obj.rec.ENSTYPEID_REF,
		     "p3", 4,
		     "p4", UsField,
		      V_STRING);
		
	//установка даты сохранения и получения данных
	DateArray(UsField) = {curdate};
		
	IF (HistoryFlag(UsField) != "X")
			VAR RS_1 = CRSDCommand("SELECT T_USFIELDVALDATE  from dlufvalue_dbt val, dlufotype_dbt luf WHERE " +
				 " LUF.T_OBJECTID_REF = ? " +
			 " AND LUF.T_OBJID_REF = ? " +
			 " AND LUF.T_USFIELDID_REF = ? " +
			 " AND VAL.T_USFOBJTYPEID_REF = LUF.T_USFOBJTYPEID",
			"p1", LO_ENSOBJECT,
			"p2", ens_obj.rec.ENSOBJECTID,
			"p3", UsField,
			V_GENOBJ);
			IF (RS_1.MoveNext)
				DateArray(UsField) = SQL_NVL(RS_1.Value(0), V_DATE);
			END;
	end;
   END;

   MACRO SetDefaultValue(NameFld: string, UsField: integer, ChangeType: bool)
      VAR RS = CRSDCommand("SELECT T_ISDIRONLY, T_USFIELDTYPE FROM DLUFIELD_DBT WHERE T_USFIELDID = ?", "p1", UsField, V_GENOBJ);
      IF (NOT RS.MoveNext OR (ValType(getControl(NameFld)) == V_UNDEF))
          RETURN;
      END;

      // Запрет редактирования
      VAR ReadOnly = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
                     " L.T_PARENTID = ? " +
                 " AND L.T_REFERENS = ? " +
                 " AND LF.T_USFLAGID_REF = ? " +
                 " AND LF.T_USFIELDID_REF = ? " +
                 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
                     "p1", LO_ENSOBJECT,
                     "p2", ens_obj.rec.ENSTYPEID_REF,
                     "p3", 3,
                     "p4", UsField,
                      V_STRING);
      // Запрет редактирования(не установлен признак построения панели доп. атрибутов ОО)
      VAR ReadOnly1 = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
		     " L.T_PARENTID = ? " +
		 " AND L.T_REFERENS = ? " +
		 " AND LF.T_USFLAGID_REF = ? " +
		 " AND LF.T_USFIELDID_REF = ? " +
		 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
		     "p1", LO_ENSOBJECT,
		     "p2", ens_obj.rec.ENSTYPEID_REF,
		     "p3", 5,
		     "p4", UsField,
		      V_STRING);	

      GetDate(UsField);

      IF (SQL_NVL(RS.Value(0), V_STRING) == "X")
         getControl(NameFld).editable = FALSE;
      ELSE
         getControl(NameFld).editable = TRUE;
      END;

      IF ((ReadOnly == "X") OR (ReadOnly1 != "X"))
         getControl(NameFld).focusable = FALSE;
         getControl(NameFld).editable  = FALSE;
         getControl(NameFld).enabled   = FALSE;
      ELSE
         getControl(NameFld).focusable = TRUE;
      END;

      IF ((ValType(ChangeType) == V_UNDEF) OR ((ValType(ChangeType) == V_BOOL) AND (ChangeType == TRUE)))

         IF ((getControl(NameFld).dataType != SQL_NVL(RS.Value(1), V_INTEGER)) AND (getControl(NameFld).dataType != FT_NUMERIC))
            getControl(NameFld).dataType = SQL_NVL(RS.Value(1), V_INTEGER);
         END;

         IF (getControl(NameFld).dataType == FT_STRING)
            getControl(NameFld).textLength = 500;
         END;
         
	  //Установка значения при отрытии панели
         IF (getControl(NameFld).dataType == FT_STRING)

		IF (GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField))=="\X01") 
			getControl(NameFld).Value    = "";
		ELSE
			getControl(NameFld).Value    = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField));
		END;		
	  ELSE 
		getControl(NameFld).Value    = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, UsField, DateArray(UsField));
         END;
      END;

      VAR isVisible = CRSDCommand("SELECT T_FLAG FROM DLOBJECT_DBT l, DLUSFFLAG_DBT lf WHERE " + 
                     " L.T_PARENTID = ? " +
                 " AND L.T_REFERENS = ? " +
                 " AND LF.T_USFLAGID_REF = ? " +
                 " AND LF.T_USFIELDID_REF = ? " +
                 " AND LF.T_OBJECTID_REF  = L.T_OBJECTID",
                     "p1", LO_ENSOBJECT,
                     "p2", ens_obj.rec.ENSTYPEID_REF,
                     "p3", 1,
                     "p4", UsField,
                      V_STRING);
      IF (isVisible != "X")
         getControl(NameFld).enabled   = FALSE;
         getControl(NameFld).focusable = FALSE;
         getControl(NameFld).editable  = FALSE;
         getControl(NameFld).Value     = "";
      END;
   END;

   MACRO SetValue()
      VAR I = 0;
      SetDefaultValue("Adress",       135 /* Адрес объекта                                       */); // "Адрес объекта:"
      SetDefaultValue("Register",     136 /* № записи о регистрации в государственном реестре    */); // "№ записи о регистрации в гос. реестре:"
      SetDefaultValue("DateRegister", 137 /* Дата записи о регистрации в государственном реестре */); // "Дата записи о регистрации в гос. реестре"
      SetDefaultValue("KolVo",        141 /* Количество комнат                                   */); // "Количество комнат"
      SetDefaultValue("Ploshad",      142 /* Полезная площадь, кв.м.                             */); // "Полезная площадь, кв.м."
      SetDefaultValue("Zil",          143 /* Жилая площадь, кв.м.                                */); // "Жилая площадь, кв. м."
      SetDefaultValue("Etaz",         144 /* Этаж                                                */); // "Этаж"
      SetDefaultValue("KolEtaz",      145 /* Количество этажей в доме                            */); // "Кол-во этажей в доме"

      SetDefaultValue("Invest1",      146 /* Инвентаризационная стоимость квартиры               */); // "Инвентаризационная стоимость квартиры"
      SetDefaultValue("InvestVal",    205 /* Валюта инвентаризационной стоимости квартиры        */, false);
      InvestVal = GetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 205, DateArray(205));

      IF (ValType(getControl("InvestVal")) != V_UNDEF)
         getControl("InvestVal").Value = FindShortName(InvestVal);
         getControl("InvestVal").editable  = FALSE;
      END;

      SetDefaultValue("Ser1",         138 /* Серия регистрационного свидетельства                */); // "Серия"
      SetDefaultValue("Ser2",         139 /* № регистрационного свидетельства                    */); // "Номер"
      SetDefaultValue("Ser3",         140 /* Дата регистрационного свидетельства                 */); // "Дата"
      SetDefaultValue("Kup1",         148 /* Регистрационный номер договора купли-продажи        */); // "Номер"
      SetDefaultValue("Kup2",         147 /* Дата регистрации договора купли-продажи             */); // "Дата"

      FOR (I, 0, numControls - 1)
         IF (ValType(GetControl(I).Value) != V_UNDEF)
            SaveValue(I) = GetControl(I).Value;
         ELSE
            SaveValue(I) = "";
         END;
      END;

      updateNavigationRoute();
   END;

   MACRO SaveValues()
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 135, 0, getControl("Adress").Value,       true, DateArray(135));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 136, 0, getControl("Register").Value,     true, DateArray(136));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 137, 0, getControl("DateRegister").Value, true, DateArray(137));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 141, 0, getControl("KolVo").Value,        true, DateArray(141));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 142, 0, getControl("Ploshad").Value,      true, DateArray(142));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 143, 0, getControl("Zil").Value,          true, DateArray(143));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 144, 0, getControl("Etaz").Value,         true, DateArray(144));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 145, 0, getControl("KolEtaz").Value,      true, DateArray(145));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 146, 0, getControl("Invest1").Value,      true, DateArray(146));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 205, 0, InvestVal,                        true, DateArray(205));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 138, 0, getControl("Ser1").Value,         true, DateArray(138));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 139, 0, getControl("Ser2").Value,         true, DateArray(139));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 140, 0, getControl("Ser3").Value,         true, DateArray(140));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 148, 0, getControl("Kup1").Value,         true, DateArray(148));
      SetUsFieldValue(LO_ENSOBJECT, EnsObjectID, 147, 0, getControl("Kup2").Value,         true, DateArray(147));

      MsgBox("Данные успешно сохранены!");
   END;

   MACRO eventHandler(EV)

      IF (EV.KeyCode == F3)
         IF (this.focusedControl AND (this.focusedControl.name == "InvestVal"))
            InvestVal = ListFinInstr();
            IF (InvestVal >= 0)
               getControl("InvestVal").Value = FindShortName(InvestVal);
            END;
         END;
      END;

      IF (EV.KeyCode == F9)
         SaveValues();

         close(0);

         RETURN TRUE;
      END;

      IF (EV.KeyCode == SHF6)
         LoansUserField(LO_ENSOBJECT, EnsObjectID);
      END; 

      IF (EV.KeyCode == ESC)
         FOR (VAR I, 0, numControls - 1)
            IF (GetControl(I).Value != SaveValue(I))
               IF (MsgBoxEx("Сохранить изменения?", MB_YES + MB_NO, IND_NO) == IND_YES)
                  SaveValues();
               END;
               RETURN TRUE;
            END;
         END;
      END;

      RETURN TRUE;
   END;

//constructor
   IF ((ValType(ID) != V_INTEGER) OR (ID == 0))
      MsgBox("Не передан ID ОО");
      RETURN;
   END;

   ens_obj.rec.EnsObjectID = ID;
   IF (NOT ens_obj.getEQ())
      MsgBox("Не найден ОО №" + ID);
      RETURN;
   END;
   EnsObjectID = ens_obj.rec.EnsObjectID;

   InitTRsbPanel();
   Init();
   SetValue();
END;
/*
<A2>                          .
╔══════════════════  Дополнительные атрибуты ОО ════════════════════════╗
║ Адрес объекта:  <A1>                                                . ║
║                                                                       ║
║ № записи о регистрации в гос. реестре <A2>                          . ║
║ Дата записи о регистрации в гос. реестре <A3>                         ║
║                                                                       ║
║ Количество комнат  <A4>                                               ║
║ Полезная площадь, кв.м.  <A5>  Жилая площадь, кв. м  <A6>             ║
║ Этаж <A7>   Кол-во этажей в доме <A8>                                 ║
║                                                                       ║
║ Инвентаризационная стоимость квартиры  <A9.1>            <A9.2>       ║
║                                                                       ║
║--------Регистрационное свидетельство----------------------------------║
║ Серия  <A10>   Номер  <A11>                Дата  <A12>                ║
║                                                                       ║
║--------Договор купли-продажи------------------------------------------║
║ Номер  <A13>           Дата  <A14>                                    ║
╚═══════════════════════════════════════════════════════════════════════╝
*/