/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : Rvps_f.mac
 Description : Вспомогательные макросы для РВПС

 Programmer  :
 27.04.01    : Создан
 US, 17.11.01
  1. Функция IsInsider скопирована из total.mac, cтарые функции
     определения признака инсайдера физ.лица исключены

------------------------------------------------------------------------------*/
import SbCrdInter, total;

CONST
      CUR_CRED_INSIDER  = 111,
      CUR_CRED_PRIVILEG = 112,
      CUR_CRED          = 113,
      CUR_EXP_INSIDER   = 121,
      CUR_EXP_PRIVILEG  = 122,
      CUR_EXP           = 123,
      RUB_CRED_INSIDER  = 211,
      RUB_CRED_PRIVILEG = 212,
      RUB_CRED          = 213,
      RUB_EXP_INSIDER   = 221,
      RUB_EXP_PRIVILEG  = 222,
      RUB_EXP           = 223;

VAR
    type1, /* тип счета до 1 года            */
    type2, /* тип счета от 1 года до 3-х лет */
    type3, /* тип счета до 30 дней           */
    type4, /* тип счета от 31 до 90 дней     */
    type5; /* тип счета от 91 до 180 дней    */


file _AcCrd    ("acc_crd.dbt",  "loans.def") key 1;
file _TurnAcc  ("turn_acc.dbt", "loans.def") key 0;
file _HistAcc  ("hist_acc.dbt", "loans.def") key 2;
FILE _Ensure   ("ensure.dbt",   "loans.def");

FILE _NameAlg  ("namealg.dbt",  "bank.def" );
file Risk      ("crdrghb.dbt",  "loans.def");
/*file ClUserCrd ("depclus.dbt",  "sbbank.def");*/

/*file ClUserOvc    ("depclus.dbt",  "sbbank.def");*/
file ДокумOvc     ("doc_acc.dbt",  "loans.def") key 3;
FILE Credit       ("credit_c.dbt", "loans.def") key 2;
FILE ДокументыOVC ("doc_acc.dbt",  "loans.def") key 4;

/*Open (ClUserOvc);*/
Open (ДокумOvc);
Open (Credit);
Open (ДокументыOVC);

macro КачествоОбеспеченияВОтчете (Str)
 if (Str == "Необеспеченная")
   return "необесп.";
   elif (Str == "Недостаточно обеспеченная")
     return "н/обесп.";
   elif (Str == "Обеспеченная")
     return "обесп.";
   else
     return Str;
 end;
end;

macro ОтнесениеНаСебестоимость (ГР, КачествоОбеспечения)
   IF ((ГР != 1) and (ГР != 2) and(ГР != 3) and(ГР != 4)) return -1; END;
   IF (КачествоОбеспечения == "") return -1; END;
   /* Усачев, 16.07.02 */
/*   IF ((ГР == 1) or (КачествоОбеспечения == "Необеспеченная")) */
   IF (ГР == 1)
     return FALSE;
   ELSE
     return TRUE;
   END;
end;


/*Качество обеспечения по кредитному договору*/
MACRO КачествоОбеспеченияПоДоговору (CreditNumber, DateParm)
  _Ensure.CreditNumber = CreditNumber;
  _Ensure.Date         = DateParm;
  IF (GetLE(_Ensure) and
     (_Ensure.CreditNumber == CreditNumber))
     _NameAlg.iTypeAlg   = 993;
     _NameAlg.iNumberAlg = _Ensure.TypeEnsure;
     IF (GetEQ(_NameAlg))
       RETURN _NameAlg.szNameAlg;
     END;
  END;
  RETURN "";
END;

macro ГруппаРискаПоДоговору (НомерДоговора, Дата)
  Risk.ObjectNumber = НомерДоговора;
  Risk.ObjectTypeID = LO_CREDIT;
  Risk.Date         = Дата;
  if ((getLE(Risk)) and
      (Risk.ObjectNumber == НомерДоговора))
    return Risk.iRiskGroup;
  else
    return 0;
  end;
end;


macro SetType (type)
  type1 = 0;
  type2 = 0;
  type3 = 0;
  type4 = 0;
  type5 = 0;
/*
  if( type == CRD_ACC )
    type1 = CRD_1;
    type2 = CRD_2;
    type3 = CRD_4;
    type4 = CRD_5;
    type5 = CRD_6;

  if( type == PERC )
    type1 = PERC_1;
    type2 = PERC_2;
  elif( type == CLAIM )
    type1 = CF_CLAIM_1;
    type2 = CF_CLAIM_2;
  elif( type == NO_PERC_2 )
    type1 = CF_NO_PERC_2_1;
    type2 = CF_NO_PERC_2_2;*/
  /*  9.07.99 ROV
  elif( type = NO_EXPPERC )
    type1 = CF_NO_EXPPERC_1;
    type2 = CF_NO_EXPPERC_2;
  */
  /*elif( type == REZ_ACC )
    type1 = REZ_ACC_1;
    type2 = REZ_ACC_2;
  elif( type == REZ_EXP )
    type1 = REZ_EXP_1;
    type2 = REZ_EXP_2;
  end;*/
end;


macro RestAcc (CurCode, AccountNumber_Ref, TurnOverDate)
  var rest;

  _TurnAcc.CurCode           = CurCode;
  _TurnAcc.AccountNumber_Ref = AccountNumber_Ref;
  _TurnAcc.TurnOverDate      = TurnOverDate;
  if( GetLE( _TurnAcc )
     and (_TurnAcc.CurCode == CurCode)
     and (_TurnAcc.AccountNumber_Ref == AccountNumber_Ref)
    )
    rest = _TurnAcc.TurnOverRest;
    if( rest < 0.0 )
      rest = -rest;
    end;
  else
    return 0;
/*    MsgBox("Не найден остаток по счету N" + AccountNumber_Ref);*/
  end;
  return rest;
end;

macro GetHistAcc (ObjectID, ObjectNumber, CreditAccountType, CurCode, RegDate)
  _HistAcc.ObjectTypeID = ObjectID;
  _HistAcc.ObjectNumber = ObjectNumber;
  _HistAcc.CreditAccountType = CreditAccountType;
  _HistAcc.CurCode = CurCode;
  _HistAcc.RegDate = RegDate;
  if (GetLE(_HistAcc) and
     (_HistAcc.ObjectTypeID      == ObjectID)          and
     (_HistAcc.ObjectNumber      == ObjectNumber)      and
     (_HistAcc.CreditAccountType == CreditAccountType) and
     (_HistAcc.CurCode           == CurCode))
     return true;
  end;
  return false;
end;

/*macro GetAccountCBF (type, CreditNumber, CurCode, RegDate)
  _AcCrd.CreditNumber_Ref = CreditNumber;
  _AcCrd.CreditAccountType = type;
  _AcCrd.Applic = 0;
  _AcCrd.CurCode = CurCode;
  if( GetEQ( _AcCrd ))
    if (ValType(RegDate) == V_UNDEF)
      return true;
    end;
    if (_AcCrd.RegDate <= RegDate)
      return true;
    end;
    if (GetHistAcc(CreditNumber, type, CurCode, RegDate))
      if (_HistAcc.RegDateNew > RegDate)
         _AcCrd.AccountNumber_Ref = _HistAcc.OldAccountNumber_Ref;
         return true;
      end;
    end;
  end;
  return false;
end;*/

macro GetAccountReserve (type, ObjectNumber, CurCode, RegDate)
  _AcCrd.ObjectID          = LO_CREDIT;
  _AcCrd.ObjectNumber      = ObjectNumber;
  _AcCrd.CreditAccountType = type;
  /*_AcCrd.Applic            = 0;*/
  _AcCrd.CurCode           = CurCode;
  if( GetEQ( _AcCrd ))
    if (ValType(RegDate) == V_UNDEF)
      return _AcCrd.AccountNumber_Ref;
    end;
    if (_AcCrd.RegDate <= RegDate)
      return _AcCrd.AccountNumber_Ref;
    end;
    if (GetHistAcc(LO_CREDIT, ObjectNumber, type, CurCode, RegDate))
      if (_HistAcc.RegDate < RegDate)
         _AcCrd.AccountNumber_Ref = _HistAcc.AccountNumber;
         return _AcCrd.AccountNumber_Ref;
      end;
    end;
  end;
  return "";
end;


macro _IsTurn (CurCode, AccountNumber_Ref, TurnOverDate)
  _TurnAcc.CurCode           = CurCode;
  _TurnAcc.AccountNumber_Ref = AccountNumber_Ref;
  _TurnAcc.TurnOverDate      = TurnOverDate;
  if( GetLE( _TurnAcc )
     and (_TurnAcc.CurCode == CurCode)
     and (_TurnAcc.AccountNumber_Ref == AccountNumber_Ref)
    )
    return true;
  else
    return false;
  end;
end;


macro _GetRest (ObjectNumber, type, RestDate, CurCode, ObjectTypeID)
  if (ValType(ObjectTypeID) == V_UNDEF)
     ObjectTypeID = LO_CREDIT;
  end;
  return ОстатокНаСчете(ObjectTypeID, ObjectNumber, CurCode, Type, RestDate);
/*
  SetType(type);
  if( type != 0 )
    if( GetAccountCBF( type, CreditNumber, CurCode, RestDate ))
      if( _IsTurn( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate))
        return RestAcc( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate);
      end;
    end;
  end;
  if( type2 != 0 )
    if( GetAccountCBF( type2, CreditNumber,CurCode, RestDate ))
      if( _IsTurn( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate))
        return RestAcc( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate);
      end;
    end
  end;
  if( type1 != 0 )
    if( GetAccountCBF( type1, CreditNumber, CurCode, RestDate ))
      if( _IsTurn( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate))
        return RestAcc( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate);
      end;
    end;
  end;
  /*ROV 27.06.00 обработать новые типы ссудного счета*/
/*
  if( type5 != 0 )
    if( GetAccountCBF( type5, CreditNumber, CurCode, RestDate ))
      if( _IsTurn( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate))
        return RestAcc( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate);
      end;
    end;
  end;
  if( type4 != 0 )
    if( GetAccountCBF( type4, CreditNumber, CurCode, RestDate ))
      if( _IsTurn( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate))
        return RestAcc( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate);
      end;
    end;
  end;
  if( type3 != 0 )
    if( GetAccountCBF( type3, CreditNumber, CurCode, RestDate ))
      if( _IsTurn( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate))
        return RestAcc( _SetIsCur(_AcCrd.CurCode), _AcCrd.CurCode, _AcCrd.AccountNumber_Ref, RestDate);
      end;
    end;
  end;
*/
  return $0;*/
end;

/* вернуть номер счета заданного типа на заданную дату*/
macro AccNumberCrd (CreditNumber, type, RepDate, CurCode)
   return НомерСчета (CreditNumber, CurCode, type);
end;


/*  Номер счета для карты с овердрафтом  */
macro AccNumberOVC (NumberOVC, typeOVC, CurCode)

  _AcCrd.ObjectID          = LO_KARTA;
  _AcCrd.ObjectNumber      = NumberOVC;
  _AcCrd.CreditAccountType = typeOVC;
  _AcCrd.CurCode           = CurCode;
  if(not GetEQ(_AcCrd))
    MsgBox("Не найден счет (тип ", typeOVC, " ) по карте ", NumberOVC);
    return(0);
  else
    return(_AcCrd.AccountNumber_Ref);
  end;
end;


macro ПоискДокументаOVC (Счет, Дата)
  var Search;

  ДокумOVC.CurCode   = Credit.CurCode;
  ДокумOVC.Credit    = Счет;
  ДокумOVC.IsDeleted = 0;

  Search = getGE(ДокумOVC);
  while(Search and
    (ДокумOVC.CurCode == Credit.CurCode) and
    (ДокумOVC.Credit == Счет) and
    (ДокумOVC.IsDeleted == 0))

    if(( ДокумOVC.RegDate == Дата) AND
       (substr(ДокумOVC.Debit, 1, 5) == "42308") )
        return( ДокумOVC.CarrySum );
    end;
    Search = next(ДокумOVC);
  end;
  return(0);
end;


macro ПоискДокументПросрочкаOVC (D_Tek, OperType, Acc_Cr, Cred_Numb)
    var WWW, D_V, D_Prosr, Search3;

    WWW = True;
    D_V = D_Tek + 1;
    while( WWW )
      D_V = D_V - 1;
      ДокументыOVC.IsDeleted = 0;
      ДокументыOVC.CreditNumber_Ref = Cred_Numb;
      ДокументыOVC.OperTypeNumber_Ref = OperType;  /* 3; */
      Search3 = getGE(ДокументыOVC);
      while(Search3 and
        (ДокументыOVC.IsDeleted == 0) AND
        (ДокументыOVC.CreditNumber_Ref == Cred_Numb) AND
        (ДокументыOVC.OperTypeNumber_Ref == OperType))
        if((ДокументыOVC.RegDate == D_V) and (ДокументыOVC.Debit == Acc_Cr))
          D_Prosr = ДокументыOVC.RegDate;
          WWW = False;
        end;
        Search3 = next(ДокументыOVC);
      end;
      if( D_V == Credit.RegDate )
        D_Prosr = D_V;
        WWW = False;
      end;
    end;
    return(D_Prosr);
end;

MACRO ПричинаИзмененияРезерва(Тип, ДельтаОД, ДельтаГР)
  IF ( (Тип == CUR_CRED_INSIDER)
        or (Тип == CUR_CRED_PRIVILEG)
        or (Тип == CUR_CRED)
        or (Тип == RUB_CRED_INSIDER)
        or (Тип == RUB_CRED_PRIVILEG)
        or (Тип == RUB_CRED) )
      /* Основной долг */
     IF (ДельтаОД > 0)
         if (ДельтаГР < 0)
            return "Выдача кредита, понижение группы риска";
         elif (ДельтаГР == 0)
            return "Выдача кредита";
         elif (ДельтаГР > 0)
            return "Выдача кредита, повышение группы риска";
         end;
     ELIF (ДельтаОД == 0)
         if (ДельтаГР < 0)
            return "Понижение группы риска";
         elif (ДельтаГР == 0)
            return "";
         elif (ДельтаГР > 0)
            return "Повышение группы риска";
         end;
     ELIF (ДельтаОД < 0)
         if (ДельтаГР < 0)
            return "Погашение кредита (вынос на просрочку), понижение группы риска";
         elif (ДельтаГР == 0)
            return "Погашение кредита (вынос на просрочку)";
         elif (ДельтаГР > 0)
            return "Погашение кредита (вынос на просрочку), повышение группы риска";
         end;
     END;
  ELSE
       /* Просроченный основной долг */
     IF (ДельтаОД > 0)
         if (ДельтаГР < 0)
            return "Вынос на просрочку, понижение группы риска";
         elif (ДельтаГР == 0)
            return "Вынос на просрочку";
         elif (ДельтаГР > 0)
            return "Вынос на просрочку, повышение группы риска";
         end;
     ELIF (ДельтаОД == 0)
         if (ДельтаГР < 0)
            return "Понижение группы риска";
         elif (ДельтаГР == 0)
            return "";
         elif (ДельтаГР > 0)
            return "Повышение группы риска";
         end;
     ELIF (ДельтаОД < 0)
         if (ДельтаГР < 0)
            return "Погашение просрочки, понижение группы риска";
         elif (ДельтаГР == 0)
            return "Погашение просрочки";
         elif (ДельтаГР > 0)
            return "Погашение просрочки, повышение группы риска";
         end;
     END;
  END;
  return "";
END; /* MACRO ПричинаИзмененияРезерва(Тип, ДельтаОД, ДельтаГР) */

macro IsTurn(CurCode, AccountNumber_Ref, TurnOverDate)
  _TurnAcc.CurCode = CurCode;
  _TurnAcc.AccountNumber_Ref = AccountNumber_Ref;
  _TurnAcc.TurnOverDate = TurnOverDate;
  if( GetLE( _TurnAcc )
     and (_TurnAcc.CurCode == CurCode)
     and (_TurnAcc.AccountNumber_Ref == AccountNumber_Ref)
    )
    return true;
  else
    return false;
  end;
end;


macro GetAccount(type, ObjectNumber, CurCode, RegDate, ObjectID )

  if (ValType(ObjectID) == V_UNDEF)
      ObjectID = LO_CREDIT;
  end;

  ClearRecord(_AcCrd);
  _AcCrd.ObjectNumber = ObjectNumber;
  _AcCrd.ObjectID     = ObjectID;
  _AcCrd.CreditAccountType = type;
  _AcCrd.CurCode = CurCode;
  if( GetEQ( _AcCrd ))
    if (ValType(RegDate) == V_UNDEF)
      return true;
    end;
    if (_AcCrd.RegDate <= RegDate)
      return true;
    end;
    if (GetHistAcc(ObjectNumber, type, CurCode, RegDate))
      if (_HistAcc.RegDateNew > RegDate)
         _AcCrd.AccountNumber_Ref = _HistAcc.OldAccountNumber_Ref;
         return true;
      end;
    end;
  end;
  return false;
end;

MACRO RiskPercent(RiskGroup)
  //PRIVATE FILE riskgr ("riskgr.dbt", "loans.def");
  RECORD riskgr_val("riskgr_val.dbt");
  RECORD riskgr("riskgr.dbt");
/*
  riskgr.NumberRiskGroup = RiskGroup;
  IF (GetEQ(riskgr) and (riskgr.NumberRiskGroup == RiskGroup))
    RETURN riskgr.DefaultPercentRate;
  END;
*/
  IF (Loans_FindRiskGroup(RiskGroup,riskgr,riskgr_val))
    RETURN riskgr_val.DefaultPercentRate;
  END;
  RETURN 0.0;
END;