/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : guar49.mac
 Description : Создание документа по шагу операции (погашение гарантии)
               Погашение просроч. % по оплаченной гарантии 1 гр.
 Programmer  : KOE
 06.06.05    : Создан
-----------------------------------------------------------------------------------*/
import macperc,SbCrdInter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.dat", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var stat = 0;
    var DocID = 0;

    var СуммаПогашПроц  = $0,
        СуммаПогашДоначПроц = $0,
        СуммаРассчитДоначПроц = $0;
    
    var PercChargeType = "";

    IF ((Договор.Crd_kind == LO_GUARANTEE) and (NOT (НадежныйДоговор(Договор.CreditNumber, Договор.Crd_kind, OperDate))))
        RETURN 0;
    END;

    if(ExistsOperation(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, CS_GUARPAYM) != 0)
        SetBuff(DutyData, Data);

        IF (NOT GetPercChargeType(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, PercChargeType))
            MsgBox("Ошибка получения значения: НАЧИСЛ_ПРОЦ_ПЕРЕД_ОПЛАТОЙ");
        END;
        
        СуммаПогашПроц = GetPaySum(DS_PAYMGUARPERCENT, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
        
        if (PercChargeType == "ON")
            СуммаПогашДоначПроц = GetPaySum(DS_PAYMGUARADDPERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
            СуммаРассчитДоначПроц = GetCalcSum(DS_PAYMGUARADDPERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
        
            Документ.CarrySum = СуммаПогашПроц + min(СуммаПогашДоначПроц, СуммаРассчитДоначПроц);
        else
            Документ.CarrySum = СуммаПогашПроц;
        end;
        return СоздатьДокумент(Документ, DocID);
    end;
    return 0;
END;