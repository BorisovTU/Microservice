/*
$Name:        cre.mac
$Module:      Кредитование
$Description: Передача кредитной истории в CRE
*/

/*
  RS-Loans

  ПЕРЕДАЧА КРЕДИТНОЙ ИСТОРИИ В CRE

  Programmer: TFS
  Date      : 11.02.13
*/

IMPORT GLOBALS, TOTAL, "dutysum.mac", likepy, "bkilib.mac", rsexts, oralib;

PRIVATE VAR lbkicont = TBFile ("lbkicont.dbt", "r", 0);

PRIVATE VAR RS_KLADR = CRSDCommand("SELECT rsb_common.GetRegFlagValue ('CB\\PARTY\\КЛАДР\\КЛАДР', RsbSessionData.oper) AS FLAG_KLADR FROM DUAL", V_STRING);

PRIVATE VAR SendDel  = 0;

// Проверка на разрешенные символы и значения
PRIVATE MACRO allowed(Block: string, Segments: string, Value)
   VAR BL = StrUpr(TRIM(Block)),
       SG = StrUpr(TRIM(Segments));

   IF (BL == "IP")
      IF ((SG == "CREDTYPE") OR (SG == "REQCREDTYPE"))
         IF ((int(Value) == 01)
          OR (int(Value) == 06)
          OR (int(Value) == 10)
          OR (int(Value) == 16)
          OR (int(Value) == 22)
          OR (int(Value) == 99))

            RETURN Value;
         END;

         RETURN "";
      END;

   ELIF (BL == "BG")
      IF (SG == "REASONFORCLOSURE")
         IF ((int(Value) == 1)
          OR (int(Value) == 2)
          OR (int(Value) == 3)
          OR (int(Value) == 4)
          OR (int(Value) == 5)
          OR (int(Value) == 98)
          OR (int(Value) == 99))
         
            RETURN int(Value);
         END;

         RETURN FALSE;
      END;

   ELIF (BL == "TRADE")
      IF (SG == "CATEGORY")
         IF ((int(Value) == 101)
          OR (int(Value) == 102)
          OR (int(Value) == 200)
          OR (int(Value) == 201)
          OR (int(Value) == 202)
          OR (int(Value) == 203)
          OR (int(Value) == 204)
          OR (int(Value) == 301)
          OR (int(Value) == 302)
          OR (int(Value) == 303)
          OR (int(Value) == 304)
          OR (int(Value) == 305)
          OR (int(Value) == 306)
          OR (int(Value) == 401)
          OR (int(Value) == 402)
          OR (int(Value) == 403)
          OR (int(Value) == 404)
          OR (int(Value) == 405)
          OR (int(Value) == 406)
          OR (int(Value) == 407)
          OR (int(Value) == 408)
          OR (int(Value) == 501)
          OR (int(Value) == 601)
          OR (int(Value) == 999))

            RETURN int(Value);
         END;

         RETURN "";
      END;
      IF (SG == "FINANCETYPE")
         IF ((Value == "01")
          OR (Value == "02")
          OR (Value == "03")
          OR (Value == "04")
          OR (Value == "05")
          OR (Value == "21")
          OR (Value == "23")
          OR (Value == "26")
          OR (Value == "27"))

            RETURN Value;
         END;

         RETURN "";
      END;

      IF (SG == "PAYMENTFREQUENCY")
         IF ((Value == "1")
          OR (Value == "2")
          OR (Value == "3")
          OR (Value == "4")
          OR (Value == "5")
          OR (Value == "6")
          OR (Value == "7")
          OR (Value == "8")
          OR (Value == "9"))

            RETURN Value;
         END;

         RETURN "";
      END;
   END;
  
   RETURN Value;  
END;

PRIVATE VAR Word : Tarray = TArray();
   Word(Word.Size) = "НЕТ";
   Word(Word.Size) = "ФЫВА";
   Word(Word.Size) = "ТЕСТ";
   Word(Word.Size) = "ОТСУТСТВУЕТ";
   Word(Word.Size) = "ОШИБКА";
   Word(Word.Size) = "НЕИЗВЕСТНО";
   Word(Word.Size) = "НЕ ИЗВЕСТНО";
   Word(Word.Size) = "НЕТ ДАННЫХ";
   Word(Word.Size) = "Н/Д";
   Word(Word.Size) = "ДАННЫЕ ОТСУТСТВУЮТ";
   Word(Word.Size) = "ПУСТО";
   Word(Word.Size) = "НЕ ЗАДАНО";
   Word(Word.Size) = "NOT";
   Word(Word.Size) = "NA";
   Word(Word.Size) = "N/A";
   Word(Word.Size) = "NONE";
   Word(Word.Size) = "TEST";
   Word(Word.Size) = "MISSING";
   Word(Word.Size) = "ERROR";
   Word(Word.Size) = "UNKNOWN";
   Word(Word.Size) = "NO DATA";
   Word(Word.Size) = "NOT SUPPLIED";
   Word(Word.Size) = "NOT PROVIDED";
   Word(Word.Size) = "NOT DEFINED";
   Word(Word.Size) = "UNDEFINED";   


MACRO ВырезатьЗапрещенныеСлова(InWord)
   VAR I, RpWord;

   IF ((ValType(InWord) != V_STRING) OR (Trim(InWord) == ""))
      RETURN;
   END;

   // Для цифр сразу ОК
   VAR ln: integer = InWord, found = FALSE;
   IF (ln == InWord)
      RETURN;
   END;

   RpWord = InWord;

   // 209155 tmp solution "ТЕСТИРОВЩИК"
   RpWord = StrSubst(StrUpr(RpWord), "ТЕСТИРОВЩИК", "%PATTERN%");

   FOR (I, 0, Word.Size - 1)
      RpWord = StrSubst(StrUpr(RpWord), Word(I), "");
   END;

   RpWord = StrSubst(StrUpr(RpWord), "%PATTERN%", "ТЕСТИРОВЩИК");

   IF (StrLen(RpWord) != StrLen(InWord))
      SetParm(0, RpWord);
   ELSE 
      SetParm(0, InWord);
   END;
END;


//\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\
/////////////////////////////////////////////////////////////////////////////////\
///////////////////////////        //        //       ///////////////////////////\
///////////////////////////  ////  //  ////  //  ///  ////////////////////////////
///////////////////////////  ////////  ////  //  ////////////////////////////////\
///////////////////////////  ////////        //  /////////////////////////////////
///////////////////////////  ////////    //////     /////////////////////////////\
///////////////////////////  ////////  /  /////  /////////////////////////////////
///////////////////////////  ////////  //  ////  ////////////////////////////////\
///////////////////////////  ////  //  ///  ///  ///  ////////////////////////////
///////////////////////////        //  ////  //       ///////////////////////////\
/////////////////////////////////////////////////////////////////////////////////\
//\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/

   VAR xml = NULL, root = NULL, newElem = NULL, root1 = null, newBlokName="";
   VAR TreeNodes = TArray(0), NodeDepth = 0;
   //экспорт в нбки
   VAR ExpNBKI: string;
   //экспорт во все БКИ
   VAR ExpAllBki: string;
   //экспорт в эквифакс
   VAR ExpEQIFAX: string;
   //Экспириан(ОКБ)
   VAR ExpEXPERIAN: string;

PRIVATE MACRO НачатьСложныйБлок( ИмяБлока )
  NodeDepth = NodeDepth + 1;
  TreeNodes(NodeDepth)  = xml.createElement(ИмяБлока);

  newBlokName = ИмяБлока;
END;

PRIVATE MACRO ЗадатьНовыйБлок(ИмяБлока:  string)
  newElem = xml.createElement(ИмяБлока);
END;

PRIVATE MACRO ВставитьБлок()
  VAR XMLElement;
  XMLElement = TreeNodes(NodeDepth);
  IF (ValType(XMLElement) == V_GENOBJ)
      XMLElement.appendChild(newElem);
  ELSE
      root.appendChild(newElem);
  END;
END;

PRIVATE MACRO ВставитьСложныйБлок(IsCDataBlockWrap)
  VAR XMLElement,ParentNode; 
  IF (ValType(TreeNodes(NodeDepth)) == V_GENOBJ)
      XMLElement = TreeNodes(NodeDepth);
      if (NodeDepth > 1)
          ParentNode = TreeNodes(NodeDepth-1);
          if (IsCDataBlockWrap == true) // Обернуть блок в CDATA'у
            ParentNode.appendChild(xml.createCDATASection("<?xml version='1.0' encoding='Windows-1251' standalone='no'?>"+XMLElement.XML));
          ELSE
            ParentNode.appendChild(XMLElement);
          END;
      ELSE
          root.appendChild(XMLElement);
      END;
      TreeNodes(NodeDepth) = "";
      NodeDepth = NodeDepth - 1;
  END;
END;

//////////////////////////////////// 
// Name    - Имя Свойства (если значение "" - то автоматически относим к ЗначениЮ блока)
// Type    - Тип значения
// Size    - Размер
// Value   - Значение
// Param   - Обязательный параметр
// IsCoplexBlock - Флаг куда будет вставлятся информация (в текущий блок или в Сложный блок)
// Вырезать_Запрещенные_Слова - если не задан или задана 1 то проверку проводим
PRIVATE MACRO ДобавитьВБлок(Name: string, Value, Type, Size, Param, IsCoplexBlock, Вырезать_Запрещенные_Слова)
   VAR day : integer = 0,
        mon : integer = 0,
        year: integer = 0,
        temp: string  ="",
        mast_be: bool = FALSE; // Признак обязательного присутствия сегмента
   // Проверяем Параметры
   Name = TRIM(Name);
  
   // Не задан обязательный параметр!
   IF ( Param == "О") // Обязательный параметр
      IF ((ValType(Value) == V_UNDEF) OR (Trim(string(Value)) == "") or (Trim (string(Value)) == StrFor(1)))
         IF (Name == "") Name = "'Значение блока'"; END;
         InsErrorMessage("Сегмент: " + newBlokName+ ". Не заполнено поле: " + Name + " - Поле Обязательно для заполнения");
         // RETURN;
      END;
   END;
  
   // Целые числа от 0..9
   IF   (Type == "M")
      IF (Trim(string(Value)) != "")
         temp = Value;
         Value = Money(Value);
      END;
  
      // Это не число
      IF (((ValType(Value) != V_MONEY) OR ((Value == $0) AND (StrLen(temp) > 1))) AND (Param == "О"))
         IF (Name == "") Name = "'Значение блока'"; END;
         InsErrorMessage("Сегмент: " + newBlokName+ ". Не заполнено поле: " + Name + " - Поле Обязательно для заполнения");
         // RETURN;
      ELSE
       Value = String(Value);
      END;
      
   END;
   
   // Целые числа от 0..9
   IF   (Type == "N")
      IF (Trim(string(Value)) != "")
         temp = Value;
         Value = int(double(Value));
      END;
  
      // Это не число
      IF (((ValType(Value) != V_INTEGER) OR ((Value == 0) AND (StrLen(temp) > 1))) AND (Param == "О"))
         IF (Name == "") Name = "'Значение блока'"; END;
         InsErrorMessage("Сегмент: " + newBlokName+ ". Не заполнено поле: " + Name + " - Поле Обязательно для заполнения");
         // RETURN;
      END;

      Value = string(Value);
  
   // Строка
   // ЗАГЛАВНЫЕ БУКВЫ: АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ
   //                  ABCDEFGHIJKLMNOPQRSTUVWYZ
   ELIF (Type == "A")
      // Это не строка
      IF ((ValType(Value) != V_STRING)  AND (Param == "О"))
         IF (Name == "") Name = "'Значение блока'"; END;
         InsErrorMessage("Сегмент: " + newBlokName+ ". Не заполнено поле: " + Name + " - Поле Обязательно для заполнения");
         // RETURN ;
      END;
  
      Value = StrUpr(string(Value));
  
   // Дата
   // Формат: ДДММГГГГ
   ELIF (Type == "D")
      IF ( (ValType(Value) != V_DATE) OR
          (Value <= date(1,1,1900)) )
         IF (Name == "") Name = "'Значение блока'"; END;
         IF (Param == "О") // Необязательную ПУСТУЮ дату просто НЕ Заполняем!
          InsErrorMessage("Сегмент: " + newBlokName+ ". Не заполнено поле: " + Name + " - Поле Обязательно для заполнения");
         END;
         Value = "";
         // RETURN ;
      END;
      
      IF (Trim(string(Value)) != "")
         DateSplit(Value, DAY, MON, YEAR);
  
         temp = "00";
         StrSet(temp, 3 - StrLen(string(DAY)),  string(DAY));  Value = temp+".";
  
         temp = "00";
         StrSet(temp, 3 - StrLen(string(MON)),  string(MON));  Value = Value + temp+".";
  
         temp = "0000";
         StrSet(temp, 5 - StrLen(string(YEAR)), string(YEAR)); Value = Value + temp;
  
      END;
  
   // Буквенно-цифровые данные
   // а..я; А..Я; a..z; A..Z; 0..9
   ELIF (Type == "AN")
  
   // Любые символы
   ELIF (Type == "P")
  
   // число с плавающей точкой формата
   ELIF (Type == "F")
      IF (ValType(Value) == V_MONEY)
         Value = string(Value);
      END;  
   END;
  
   IF ((ValType(Value) == V_STRING) AND (Size > 1))
      Value = SubStr(Value, 1, Size);
   END;
  
   IF  ((ValType(Вырезать_Запрещенные_Слова) == V_UNDEF ) or ((ValType(Вырезать_Запрещенные_Слова) == V_INTEGER ) and Вырезать_Запрещенные_Слова == 1))
   ВырезатьЗапрещенныеСлова(Value); 
   END;
   
   IF (IsCoplexBlock)
       IF (Name == "")
          TreeNodes(NodeDepth).appendChild( xml.createTextNode(ToANSI(Value)) );
       ELSE
          TreeNodes(NodeDepth).setAttribute(Name, ToANSI(Value));
       END;
   ELSE
       ЗадатьНовыйБлок(Name);

       newElem.appendChild( xml.createTextNode(ToANSI(Value)) );

       ВставитьБлок();
   END;
END;


MACRO СформироватьСегмент_CollateralObjects(RS)
   
   НачатьСложныйБлок("CollateralObjects");

   НачатьСложныйБлок("CollateralObject");
   //1. Предмет залога.
   ДобавитьВБлок("CollateralType", string(SQL_NVL(RS.Value("T_COLLATERALTYPE"), V_INTEGER):2:0:o), "S", 2, "О");

   //2. Идентификатор предмета залога (VIN-номер залогового автомобиля).
   var undef; // не инициирование значение
   ДобавитьВБлок("CollateralID", SQL_NVL(RS.Value("T_COLLATERALVIN"), V_STRING), "S", 35, "О", undef,0);

   //3. Описание залога. 
   ДобавитьВБлок("CollateralDescription", SQL_NVL(RS.Value("T_COLLATERALDESCRIPTION"), V_STRING), "S", 150, "О");

   ВставитьСложныйБлок();
   
   ВставитьСложныйБлок();
END;


// 12.2.11  TradeCollateral - информация о залоге
MACRO СформироватьСегмент_TradeCollateral(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)
   IF ((ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_CLAIM))
      RETURN;
   END;

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_TradeCollateral(?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("ObjectTypeID", RSDBP_IN); RSDcmd.value("ObjectTypeID") = ObjectTypeID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT * FROM DCRE_TRADECOLLATERAL_TMP WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ? ORDER BY T_ENSCONTRACTID, T_ENSOBJECTID",
                        "p1", ObjectTypeID,
                        "p2", ObjectNumber,
                        V_GENOBJ);
   VAR STAT = RS.MoveNext();

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("TradeCollaterals");

   WHILE (STAT)
      НачатьСложныйБлок("TradeCollateral");
      
      // 1. Уникальный (в рамках партнера) номер договора залога
      ДобавитьВБлок("CollateralContract", SQL_NVL(RS.Value("T_COLLATERALCONTRACT"), V_STRING), "S", 35, "О");

      // 2. Дата договора залога. Обязателен при наличии залога.
      //    Если договоров залога несколько, передается самая ранняя дата открытия договора залога с большей суммой залога.
      ДобавитьВБлок("CollateralDate", SQL_NVL(RS.Value("T_COLLATERALDATE"), V_DATE), "D", 0, "О");

      IF (ObjectTypeID != LO_GUARANTEE)
         // 3. Дата окончания (срок) действия договора залога.
         //    TR(36) Срок действия договора залога 
         ДобавитьВБлок("CollateralEndDate", SQL_NVL(RS.Value("T_COLLATERALENDDATE"), V_DATE), "D", 0, "О");

         // 4. Предмет залога. Обязателен при наличии залога.
         //    TR(18) Код залога по кредиту (справочник Код залога)
         ДобавитьВБлок("CollateralType", string(SQL_NVL(RS.Value("T_COLLATERALTYPE"), V_INTEGER):2:0:o), "S", 2, "О");

         // 5. TR(34) Оценочная стоимость залога 
         ДобавитьВБлок("CollateralAssessment", SQL_NVL(RS.Value("T_COLLATERALASSESSMENT"), V_MONEY), "F", 0, "О");
      ELSE
         ДобавитьВБлок("CollateralEndDate",    "", "S", 0, "Н");
         ДобавитьВБлок("CollateralType",       "", "S", 0, "Н");
         ДобавитьВБлок("CollateralAssessment", "", "S", 0, "Н");
      END;


      // 6. Валюта, в которой произведена оценка предмета залога. Обязательно, если не рубли.
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_COLLATERALCURRENCY"), V_STRING)))
         InsErrorMessage("CollateralCurrency. Код RUR запрещен к передаче!");
      ELSE
      ДобавитьВБлок("CollateralCurrency", SQL_NVL(RS.Value("T_COLLATERALCURRENCY"), V_STRING), "S", 3, "У");
      END;

      // 7. TR(35) Дата оценки стоимости залога 
      ДобавитьВБлок("CollateralAssessmentDate", SQL_NVL(RS.Value("T_COLLATERALASSESSMENTDATE"), V_DATE), "D", 0, "О");

      // 8. Наименование залогодателя (для ФЛ) или организации-залогодателя (для ЮЛ). Обязательно, если отличается от ФИО/Названия заявителя.
      //    Передаем, если отличается от данных, переданных в сегменте <Person> - для ФЛ или в сегменте <Business> - для ЮЛ. 
      //    Если соответствующих договоров залога несколько, указываем в параметре то значение, которое указано у договора залога с самой большой оценочной стоимостью.
      ДобавитьВБлок("CollateralPledgorName", SQL_NVL(RS.Value("T_COLLATERALPLEDGORNAME"), V_STRING), "S", 150, "У");

      // 9. Идентификатор предмета залога, если он применим. 
      //    Например, указывается VIN-номер залогового автомобиля или номер свидетельства о регистрации для объекта недвижимости.
      //    Не заполняется.
      var undef; // не инициирование значение    
      ДобавитьВБлок("CollateralID", SQL_NVL(RS.Value("T_COLLATERALVIN"), V_STRING), "S", 35, "Н", undef,0);

      // 10. Дата государственной регистрации выпуска облигаций (если при заполнении CollateralID использован Государственный регистрационный номер выпуска облигаций)
      //     Не заполняется.
      ДобавитьВБлок("CollateralIssueDate", "", "S", 0, "Н");

      // 11. Адрес нахождения или регистрации предмета залога. Обязательно для ипотеки
      //     Заполняется данными из поля <Наименование объекта> панели <Объект обеспечения> только для залогов типа <Залог недвижимости>.
      //     Если соответствующих договоров залога несколько и/или соответствующих предметов залога несколько, указываем в параметре то значение, которое указано у предмета залога с самой большой оценочной стоимостью.
      ДобавитьВБлок("CollateralAddress", SQL_NVL(RS.Value("T_COLLATERALADDRESS"), V_STRING), "S", 200, "У");

      // 12. Описание залога (комментарии и дополнительная информация).
      //     Не заполняется.
      ДобавитьВБлок("CollateralDescription", "", "S", 150, "Н");

      // 13. Разрешение на экспорт в Реестр залогов.
      //     Допустимые значения:
      //     1 - разрешена выгрузка в Реестр залогов;
      //     0 - выгрузка в Реестр залогов запрещена;
      //     Не указано - Выгрузка в Реестр залогов запрещена.
      //     Если на предмете залога договора залога установлен признак <Разрешен экспорт в Реестр залогов> передаем 1, иначе - 0
      ДобавитьВБлок("CanExportPledgeRegistry", SQL_NVL(RS.Value("T_CANEXPORTPLEDGEREGISTRY"), V_INTEGER), "N", 1, "Н");

      //14.Статус выгрузки залога в Реестр залогов
      IF (SQL_NVL(RS.Value("T_STATUSPLEDGEREGISTRY"), V_INTEGER) == -1)
         ДобавитьВБлок("StatusPledgeRegistry", "", "S", 1, "Н");

      ELSE
      ДобавитьВБлок("StatusPledgeRegistry", SQL_NVL(RS.Value("T_STATUSPLEDGEREGISTRY"), V_INTEGER), "N", 1, "Н");
   
      END;
   
      //15.Фактическая дата окончания срока действия договора залога
      ДобавитьВБлок("CollateralFactEndDate", SQL_NVL(RS.Value("T_COLLATERALFACTENDDATE"), V_DATE), "D", 0, "У");
      
      //16.Дата ввода предмета залога
      ДобавитьВБлок("CollateralInputDate", "", "S", 0, "Н");
      
      //17.Дата вывода предмета залога
      ДобавитьВБлок("CollateralOutputDate", "", "S", 0, "Н");
      
      //18.Причина окончания договора залога
      ДобавитьВБлок("CollateralReasonForClosure", SQL_NVL(RS.Value("T_COLLATERALREASONFORCLOSURE"), V_INTEGER), "N", 2, "У");

      //19.Информация о дополнительных объектах обеспечения по договору залога
      IF ( SQL_NVL( RS.Value("T_COLLATERALTYPE"), V_INTEGER ) == 1)
         СформироватьСегмент_CollateralObjects(@RS);
      END;   
   
      ВставитьСложныйБлок();

      STAT = RS.MoveNext();
   END;

   ВставитьСложныйБлок();
END;

// 12.2.13  BankGuarantee - банковская гарантия
MACRO СформироватьСегмент_BankGuarantee(ObjectTypeID: integer, ObjectNumber: integer, ClientID: integer, SendKind: integer)
   IF ((ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_CLAIM))
      RETURN;
   END;

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_BankGuarantee(?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("ObjectTypeID", RSDBP_IN); RSDcmd.value("ObjectTypeID") = ObjectTypeID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   // Передается по принципалу (по ДГ) и по заемщику, если у него в обеспечении есть договор банковской гарантии (по КД, БК и ОВ).
   VAR RS;
   IF (ObjectTypeID == LO_GUARANTEE)
      RS = CRSDCommand("SELECT * FROM DCRE_BANKGUARANTEE_TMP WHERE T_CREDITNUMBER = ? ORDER BY T_OBJECTNUMBER",
                        "p2", ObjectNumber,
                        V_GENOBJ);
   ELSE
      RS = CRSDCommand("SELECT * FROM DCRE_BANKGUARANTEE_TMP WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ?",
                        "p1", ObjectTypeID,
                        "p2", ObjectNumber,
                        V_GENOBJ);
   END;

   VAR STAT = RS.MoveNext();

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("BankGuarantees");

   WHILE (STAT)
      НачатьСложныйБлок("BankGuarantee");
      
      // 1. Номер банковской гарантии.
      // Для заемщика - номер договора банковской гарантии, принятого в обеспечение (договор обеспечения системного типа <Поручительство>, типа <Гарантия>). 
      // Если таких договоров несколько, передается номер договора с наибольшей суммой.
      // Для принципала - номер договора выданной гарантии.
      ДобавитьВБлок("Number",            SQL_NVL(RS.Value("T_NUMBER"), V_STRING),          "S", 35,   "О");
      
      // 2. Номер счета\кредита - уникальный идентификатор счета в Банке\Кредитной организации. 
      // Заполняется, если банковская гарантия указана в качестве обеспечения счёта (только для заемщика).
      // Значение должно совпадать со значением, передаваемым в поле Trade.Account.
      ДобавитьВБлок("Account",           SQL_NVL(RS.Value("T_ACCOUNT"), V_STRING),         "S", 35,   "У");
      
      // 3. Код участника, предоставленный НБКИ
      // (Member Code). 
      ДобавитьВБлок("MemberCode",        SQL_NVL(RS.Value("T_MEMBERCODE"), V_STRING),      "S", 12,   "О");
      
      // 4. Наименование банка, выдавшего гарантию.
      // Для заемщика - параметр <Банк, выдавший гарантию> договора банковской гарантии, принятого в обеспечение (договор обеспечения типа <Гарантия>).  
      // Если таких договоров несколько, передаются данные договора с наибольшей суммой.
      // Для принципала - Наш Банк.
      ДобавитьВБлок("BankName",          SQL_NVL(RS.Value("T_BANKNAME"), V_STRING),        "S", 150,  "Н");
      
      // 5. TR(31) Объем обязательства, обеспечиваемого банковской гарантией (Volume of debt secured by guarantee)
      // 1 - в полном объеме
      // 2 - частично.
      ДобавитьВБлок("Volume",            SQL_NVL(RS.Value("T_VOLUME"), V_INTEGER),           "N", 1,  "У");
      
      // 6. Объем обязательства, обеспечиваемого банковской гарантией - сумма займа или ее часть из договора займа, обеспечиваемая договором гарантии
      // По заемщику: 
      // Сумма всех договоров обеспечения типа <Гарантия> в долях, относящихся к данному договору кредитования.
      // По принципалу: значение параметра договора гарантии <Сумма обязательства, обеспечиваемого гарантией>: 
      ДобавитьВБлок("VolumeSum",         SQL_NVL(RS.Value("T_VOLUMESUM"), V_MONEY),          "F", 1,   
                                           mandatory(TRIM(SQL_NVL(RS.Value("T_ACCOUNT"), V_STRING)) != ""));
      
      // 7. TR(32) Сумма банковской гарантии (Bank guarantee sum) 
      ДобавитьВБлок("Sum",               SQL_NVL(RS.Value("T_SUM"), V_MONEY),                "F", 1,   "О");
      
      // 8. Валюта банковской гарантии.
      // Для заемщика - валюта договора обеспечения типа <Гарантия>, относящегося к данному договору кредитования. 
      // Если таких договоров несколько, передается валюта договора с наибольшей суммой.
      // Для принципала - валюта договора выданной гарантии.
      // Обязательно, если не рубли.
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_CURRENCY"), V_STRING)))
         InsErrorMessage("Currency. Код RUR запрещен к передаче!");
      ELSE
         ДобавитьВБлок("Currency",          SQL_NVL(RS.Value("T_CURRENCY"),            V_STRING), "S", 3, "О");
      END;      

      // 9. Дата банковской гарантии.
      // Для заемщика - дата начала договора обеспечения типа <Гарантия>, относящегося к данному договору кредитования. 
      // Если таких договоров несколько, передается самая ранняя дата из всех договоров.
      // Для принципала - дата начала договора выданной гарантии.
      ДобавитьВБлок("Date",              SQL_NVL(RS.Value("T_DATE"),                     V_DATE), "D", 0, "О");

      // 10. TR(33) Срок банковской гарантии (Bank guarantee term)
      ДобавитьВБлок("EndDate",           SQL_NVL(RS.Value("T_ENDDATE"),                  V_DATE), "D", 0, "О");

      // 11. Фактическая дата окончания срока действия договора гарантии.
      // Дата операции закрытия договора гарантии (и ДО, и ДГ).
      // Если договор не закрыт - не заполняется.
      // Для заемщика - передается самая поздняя дата операции закрытия и только если закрыты все договоры гарантий, 
      // привязанные к данному кредитному договору.
      IF (ValType(RS.Value("T_FACTCLOSEDATE")) != V_SPECVAL)
         ДобавитьВБлок("FactCloseDate",     SQL_NVL(RS.Value("T_FACTCLOSEDATE"),         V_DATE), "D", 0, "У");
      END;

      // 12. Причина окончания срока действия гарантии
      // Обязательно, если указано FactCloseDate. 
      // Для заемщика передается относительно того договора обеспечения, дата закрытия которого указана в поле 11 <FactCloseDate>.
      // Допустимые значения:
      // 1 - Исполнение обязательств за счет обеспечения; 
      //     Для ДО - не передается; 
      //     для ДГ - если операция закрытия ДГ прошла после операции оплаты по договору гарантии.
      // 2 - Истек срок действия договора обеспечения; 
      //     Указывается, если дата закрытия договора гарантии (и ДО, и ДГ) больше или равна дате окончания договора, указанной в панели.
      // 3 - Утрачено обеспечение; Не передается
      // 4 - Договор обеспечения расторгнут; 
      //     Указывается, если дата закрытия договора гарантии (и ДО, и ДГ) меньше даты окончания договора, указанной в панели.
      // 5 - Уступка прав требования; 
      //     Для ДО - если кредитный договор, к которому привязан текущий догвоор обеспечения типа <Гарантия> привязан к договору уступки прав требования. 
      //     Для ДГ - если ДГ привязан к договору уступки прав требования.
      // 98 - Иное; Не передается
      // 99 - Нет информации Передается, если договор не подпадает ни под один из выше изложенных пунктов.
      // 94. Поле "Reasonforclosure" (Причина закрытия).
      IF (allowed("BG", "ReasonForClosure", SQL_NVL(RS.Value("T_REASONFORCLOSURE"), V_INTEGER)))
         ДобавитьВБлок("ReasonForClosure",  SQL_NVL(RS.Value("T_REASONFORCLOSURE"),      V_INTEGER), "N", 0, "У");
      END;
      
      //14. Разрешение на экспорт в НБКИ
      ДобавитьВБлок("CanExportNBCH",          SQL_NVL(RS.Value("T_CANEXPORTNBCH"),     V_STRING), "A", 1, "Н"); 
      //15. Разрешение на экспорт в Эквифакс
      ДобавитьВБлок("CanExportGPCS",          SQL_NVL(RS.Value("T_CANEXPORTGPCS"),     V_STRING), "A", 1, "Н");
      //16. Разрешение на экспорт в Экспериан (ОКБ)
      ДобавитьВБлок("CanExportExperian",      SQL_NVL(RS.Value("T_CANEXPORTEXPERIAN"), V_STRING), "A", 1, "Н");
      //17. Разрешение на экспорт в КБРС
      ДобавитьВБлок("CanExportBrs",           SQL_NVL(RS.Value("T_CANEXPORTBRS"),      V_STRING), "S", 1, "Н");

      //13. Информация о прекращении банковской гарантии в иных, отличных от окончания срока гарантии случаях.
      ДобавитьВБлок("OtherReason ",          SQL_NVL(RS.Value("T_OtherReason"),     V_STRING), "S", 255, "У");
      
      //18 Тип банковской гарантии (справочник Тип банковской гарантии). Только для КБРС. 
      // Не передается
      //ДобавитьВБлок("Type",           SQL_NVL(RS.Value("T_Type"),      V_STRING), "N", 1, "Н");
      // Так как данных нет, то 
      ДобавитьВБлок("Type",           "", "S", 1, "Н");
      
      ВставитьСложныйБлок();

      STAT = RS.MoveNext();
   END;

   ВставитьСложныйБлок();
END;

// 12.2.8   Bankruptcy - данные о банкротствах
MACRO СформироватьСегмент_Bankruptcy(PartyID: integer, ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)
   IF ((ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_CLAIM))
      RETURN;
   END;

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Bankruptcy(?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("PartyID",      RSDBP_IN); RSDcmd.value("PartyID")      = PartyID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT UTL_RAW.cast_to_varchar2(T_TEXT) AS T_TEXT FROM DLBKI_304_TMP l304 WHERE " + 
                         " l304.T_CREDITNUMBER_REF = ? " +
                     " AND l304.T_PARTYID_REF = ? " +
                     " AND l304.T_TFID_REF = ? ",
                           "p1", ObjectNumber,
                           "p2", PartyID,
                           "p3", 0,
                          V_GENOBJ),
   НАИМЕНОВАНИЕ_СУДА, НОМЕР_ДЕЛА, ДАТА_ИСПОЛНЕНИЯ, ИСТЕЦ, ТИП_БАНКРОТСТВА, ВИД_БАНКРОТСТВА, РЕШЕНИЕ, text;

   VAR STAT = RS.MoveNext();

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("Bankruptcies");
   IF (STAT)
      НачатьСложныйБлок("Bankruptcy");
      text = SQL_NVL(RS.Value("T_TEXT"), V_STRING);

      // Наименование суда
      НАИМЕНОВАНИЕ_СУДА = SubStr(text, 1, Index(text, ";") - 1); // Копируем с первого символа, до символа перед ";"
      text              = SubStr(text,    Index(text, ";") + 1); // Копируем со следующего символа
                                                                 // после ";" до символа перед следующим ";"
      // Номер дела
      НОМЕР_ДЕЛА        = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      // Дата
      ДАТА_ИСПОЛНЕНИЯ   = date(SubStr(text, 1, Index(text, ";") - 1));
      text              = SubStr(text,    Index(text, ";") + 1);

      // Истец
      ИСТЕЦ             = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      // Тип банкротства
      ТИП_БАНКРОТСТВА   = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      ВИД_БАНКРОТСТВА   = SubStr(text, 1, Index(text, ";") - 1);
      text              = SubStr(text,    Index(text, ";") + 1);

      РЕШЕНИЕ           = SubStr(text, 1, Index(text, ";") - 1);

      ДобавитьВБлок("DateReported",      ReportDate,        "D", 0,   "О");
      ДобавитьВБлок("CourtName",         НАИМЕНОВАНИЕ_СУДА, "S", 170, mandatory((ExpNBKI == "Да") OR (ExpAllBki == "Да") OR (ExpEQIFAX == "3.0")or(ExpEQIFAX == "2.0")));
      ДобавитьВБлок("CaseNumber",        НОМЕР_ДЕЛА,        "S", 35,  mandatory((ExpNBKI == "Да") OR (ExpAllBki == "Да")));
      ДобавитьВБлок("DateConsideration", ДАТА_ИСПОЛНЕНИЯ,   "D", 0,   "Н");
      ДобавитьВБлок("Plaintiff",         ИСТЕЦ,             "S", 32,  "Н");
      ДобавитьВБлок("Status",            ТИП_БАНКРОТСТВА,   "N", 0,   "О");
      ДобавитьВБлок("Resolution",        РЕШЕНИЕ,           "S", 500, mandatory((ExpNBKI == "Да") OR (ExpAllBki == "Да") OR (ExpEQIFAX == "3.0")or(ExpEQIFAX == "2.0")));
      ДобавитьВБлок("Updated",           ReportDate,        "D", 0,   "Н");
      ВставитьСложныйБлок();

      STAT = RS.MoveNext();
   END;
   ВставитьСложныйБлок();
END;

// 12.2.12     InfoPart - информационная часть
MACRO СформироватьСегмент_InfoPart(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)
   var RegDate;
   IF (ReportDate < date(01,03,2015))
      RETURN;
   END;

   IF (ObjectTypeID == LO_CLAIM)
      VAR RS_CLM = CRSDCommand("SELECT T_GIVINGDATE FROM DCLAIM_DBT WHERE " + 
                                     " T_CLAIMID = ? ",
                                 "p1", ObjectNumber,
                                     V_GENOBJ);
      RS_CLM.MoveNext();

      RegDate = RS_CLM.Value("T_GIVINGDATE");

      IF (RegDate == NULL)
         RETURN;
      END;

      IF ((RegDate < date(01,07,2014)) AND ((TypeClient == PTLEGF_PERSN) OR (TypeClient ==PTLEGF_PBUL)))
         RETURN;
      END;

   ELIF (ObjectTypeID == LO_CREDIT)
      VAR RS_CRD = CRSDCommand("SELECT T_REGDATE FROM DCREDIT_C_DBT WHERE " + 
                                     " T_CREDITNUMBER = ? ",
                                 "p1", ObjectNumber,
                                     V_GENOBJ);
      RS_CRD.MoveNext();

      RegDate = RS_CRD.Value("T_REGDATE");

      IF (RegDate==NULL)
         RETURN;
      END;

      IF ((RegDate < date(01,07,2014)) AND ((TypeClient ==PTLEGF_PERSN) OR  (TypeClient ==PTLEGF_PBUL)))
         RETURN;
      END;
   END;
   
   IF (ObjectTypeID == LO_CLAIM)
   VAR RS = CRSDCommand("SELECT l.*, " +
                        " TRUNC(MONTHS_BETWEEN(TO_DATE(L.T_APPLICATIONDATE, 'dd.mm.yyyy hh24:mi:ss'), ps.T_BORN) / 12) AS BORN " +
                        " FROM DCRE_INFOPART_TMP l, DCLAIM_DBT clm, DPERSN_DBT ps WHERE " + 
                             " L.T_CLAIMID = CLM.T_CLAIMID " +
                         " AND CLM.T_LOANERID_REF = PS.T_PERSONID " +
                         " AND L.T_CLAIMID = ? " +
                          " AND T_TFID = ?",
                        "p2", ObjectNumber,
                        "p3", 0,
                       V_GENOBJ);
   ELSE
      RS = CRSDCommand("SELECT lc.*, NULL AS BORN FROM DCRE_INFOPART_TMP lc WHERE " + 
                             " lc.T_CREDITNUMBER = ? " +
                         " AND lc.T_TFID = ?",
                        "p2", ObjectNumber,
                        "p3", 0,
                       V_GENOBJ);
   END;

   VAR STRAD = RS.MoveNext();

   IF (NOT STRAD)
      RETURN;
   END;

   НачатьСложныйБлок("InfoPart");
   WHILE (STRAD)

      // 1. IP(3) Номер кредитной заявки (Application Number)
      // Должно совпадать со значением одноименного поля 24 сегмента <Trade>.
      ДобавитьВБлок("ApplicationNumber          ", SQL_NVL(RS.Value("T_APPLICATIONNUMBER"),         V_STRING), "S",  30, "О");

      // 2. IP(4) Дата и время заявки (Date of Application).
      // Должно совпадать со значением одноименного поля 25 сегмента <Trade>.
      IF((ValType(RS.Value("BORN")) == V_SPECVAL)
         OR 
        ((SQL_NVL(RS.Value("BORN"), V_INTEGER) >= 14) AND (SQL_NVL(RS.Value("BORN"), V_INTEGER) <= 110))
        )
         ДобавитьВБлок("ApplicationDate            ", SQL_NVL(RS.Value("T_APPLICATIONDATE"),        V_STRING), "T",   0, "О");
      ELSE
         InsErrorMessage("Неверное значение обязательного поля");
      END;

      // 3. Отношение к заявке. 
      ДобавитьВБлок("Relationship               ", SQL_NVL(RS.Value("T_RELATIONSHIP"),              V_STRING), "N",   1, "О");

      // 4. Статус (решение) по заявке.
      // Допустимые значения: 0, 1, 2, 3, 4
      ДобавитьВБлок("Status                     ", SQL_NVL(RS.Value("T_STATUS"),                   V_INTEGER), "N",   1, "О");

      // 5. Дата статуса заявки.
      // Определяется по шагу маршрута заявки.
      // Если операция маршрута  еще не начата, то передается дата ввода заявки.
      ДобавитьВБлок("StatusDate                 ", SQL_NVL(RS.Value("T_STATUSDATE"),                  V_DATE), "D",   0, "О");

      // 6. Вид запрошенного кредита
      // (Requested Loan Type).
      // Заполняется по справочнику <Целевое назначение кредита> - аналогично полю 4 <Type> сегмента <Сделка> по полю <Цель кредита> в панели <Кредитная заявка>.
      // Значение поля определяется один раз  - при передаче информции по вновь заведенной кредитной заявке и не обновляется при дальнеших передачах
      IF (SendKind == REQUEST_FULL)
         ДобавитьВБлок("ReqCredType             ", allowed("IP", "REQCREDTYPE", SQL_NVL(RS.Value("T_REQCREDTYPE"),               
                                                                                                   V_STRING)), "S",   2, "Н");
      //ELSE
      //   ДобавитьВБлок("ReqCredType             ", "", "S",   2, "Н");
      END;

      // 7. Категория запрошенного кредита
      // IP (7). Категория запрошенного кредита.
      ДобавитьВБлок("ReqCredCategory         ", SQL_NVL(RS.Value("T_REQCREDCATEGORY"), V_INTEGER),             "N",   3, "О");

      // 9. IP(8) Способ предоставления заявки  (Application Shipment Way)
      ДобавитьВБлок("ApplicationWay             ", SQL_NVL(RS.Value("T_APPLICATIONWAY"),           V_INTEGER), "N",   1, "О");

      // 10. Запрошенная сумма кредита/займа, указанная в заявке.
      ДобавитьВБлок("AppAmount                  ", SQL_NVL(RS.Value("T_APPAMOUNT"),                  V_MONEY), "F",   0, "О");

      // 11. Желаемая валюта кредита/займа, указанная в заявке
      // IP(12) Валюта отклоненной заявки
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_APPCURRENCY"), V_STRING)))
         InsErrorMessage("AppCurrency. Код RUR запрещен к передаче!");
      ELSE
         ДобавитьВБлок("AppCurrency             ", SQL_NVL(RS.Value("T_APPCURRENCY"),               V_STRING), "S",   3, 
                                                       mandatory((SQL_NVL(RS.Value("T_STATUS"),      V_INTEGER) == 3) AND 
                                                                 (SQL_NVL(RS.Value("T_APPCURRENCY"), V_STRING) != "RUB")));
      END;

      // 12. Желаемая длительность (количество месяцев) кредитного договора, указанная в заявке.
      ДобавитьВБлок("AppCredDuration            ", SQL_NVL(RS.Value("T_APPCREDDURATION"),          V_INTEGER), "N",   3, "О");

      // 13. IP(10) Дата окончания действия одобрения Заявления
      ДобавитьВБлок("ApprovalExpiration      ", SQL_NVL(RS.Value("T_APPROVALEXPIRATION"),             V_DATE), "D",   0, 
                                                                    mandatory(SQL_NVL(RS.Value("T_STATUS"), V_INTEGER) == 4));
      
      // 14. IP(2) Код участника, предоставленный НБКИ (Member Code)
      ДобавитьВБлок("MemberCode                 ", SQL_NVL(RS.Value("T_MEMBERCODE"),                V_STRING), "S",  12, "О");

      // 15. IP(15) Номер кредитного договора (или другой уникальный идентификатор)
      ДобавитьВБлок("Account                    ", SQL_NVL(RS.Value("T_ACCOUNT"),                   V_STRING), "S",  35, 
                                                                    mandatory(SQL_NVL(RS.Value("T_STATUS"), V_INTEGER) == 1));

      // 16. Вид выданного кредита (Requested Loan Type).
      IF (SendKind == REQUEST_FULL)
         ДобавитьВБлок("CredType                   ", allowed("IP", "CREDTYPE", SQL_NVL(RS.Value("T_CREDTYPE"),              
                                                                                                  V_INTEGER)), "N",   2, "Н");
      END;

      // 17. Категория потребительского кредита.
      ДобавитьВБлок("CredCategory               ", SQL_NVL(RS.Value("T_CREDCATEGORY"), V_INTEGER), "N",   3, 
                                                      mandatory((SQL_NVL(RS.Value("T_STATUS"), V_INTEGER) == 1) 
                                                            AND (SQL_NVL(SQL_NVL(RS.Value("T_REQCREDCATEGORY"), V_INTEGER) 
                                                                      != SQL_NVL(RS.Value("T_CREDCATEGORY"), V_INTEGER)))));

      // 18. Сумма/лимит выданного займа (кредита)
      ДобавитьВБлок("CredAmount                 ", SQL_NVL(RS.Value("T_CREDAMOUNT"),                 V_MONEY), "F",   0, 
                                                               mandatory((SQL_NVL(RS.Value("T_STATUS"), V_INTEGER)    == 1) 
                                                                           AND (SQL_NVL(RS.Value("T_APPAMOUNT") , V_MONEY)
                                                                             != SQL_NVL(RS.Value("T_CREDAMOUNT"), V_MONEY))));

      // 19. Валюта выданного займа (кредита).
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_CREDCURRENCY"), V_STRING)))
         InsErrorMessage("CredCurrency. Код RUR запрещен к передаче!");
      ELSE
         ДобавитьВБлок("CredCurrency            ", SQL_NVL(RS.Value("T_CREDCURRENCY"),              V_STRING), "S",   3, 
                                                      mandatory((SQL_NVL(RS.Value("T_STATUS"),      V_INTEGER) == 1) AND
                                                                (SQL_NVL(RS.Value("T_CREDCURRENCY"), V_STRING) != "RUB")));
      END;

      // 20. Дата договора  займа (кредита).
      ДобавитьВБлок("CredDateOpened          ", SQL_NVL(RS.Value("T_CREDDATEOPENED"),              V_DATE), "D",   0, 
                                                                    mandatory(SQL_NVL(RS.Value("T_STATUS"), V_INTEGER) == 1));

      // 21. Дата (плановая) окончания договора займа (кредита)
      ДобавитьВБлок("CredDateContractTermination", SQL_NVL(RS.Value("T_CREDDATECONTRACTTERMINATION"), V_DATE), "D",   0, "Н");

      // 22. Причина отказа.
      ДобавитьВБлок("RejectReason               ", SQL_NVL(RS.Value("T_REJECTREASON"),             V_INTEGER), "N",   2, 
                                                                    mandatory(SQL_NVL(RS.Value("T_STATUS"), V_INTEGER) == 3));

      // 23. Текст причины отказа.
      ДобавитьВБлок("RejectComments             ", SQL_NVL(RS.Value("T_REJECTCOMMENTS"),            V_STRING), "S", 255, 
                                                                    mandatory(SQL_NVL(RS.Value("T_STATUS"), V_INTEGER) == 9));

       //24.Разрешение на экспорт в НБКИ
      ДобавитьВБлок("CanExportNBCH",          SQL_NVL(RS.Value("T_CANEXPORTNBCH"), V_STRING), "A",    1, "Н");
      //25.Разрешение на экспорт в Эквифакс
      ДобавитьВБлок("CanExportGPCS",          SQL_NVL(RS.Value("T_CANEXPORTGPCS"), V_STRING), "A",    1, "Н");
      //26.Разрешение на экспорт в Экспериан (ОКБ)
      ДобавитьВБлок("CanExportExperian",      SQL_NVL(RS.Value("T_CANEXPORTEXPERIAN"), V_STRING), "A",    1, "Н");
      //27.Разрешение на экспорт в КБРС
      ДобавитьВБлок("CanExportBrs",           SQL_NVL(RS.Value("T_CANEXPORTBRS"), V_STRING), "S",    1, "Н");

      // 28. Поля расширения (для передачи дополнительной информации), имя дополнительного поля передается в атрибуте name
      ДобавитьВБлок("Extra                      ", "",                                                         "S", 250, "Н");

      STRAD = RS.MoveNext();
   END;

   ВставитьСложныйБлок();
END;

// 12.2.10  Trade - кредит (займ)
MACRO СформироватьСегмент_Trade(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)
   IF (ObjectTypeID == LO_CLAIM)
      RETURN;
   END;

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Trade(?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectTypeID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   IF (ObjectTypeID == LO_GUARANTEE)
      RETURN СформироватьСегмент_BankGuarantee(ObjectTypeID, ObjectNumber, ClientID, SendKind);
   END;

   VAR RS = "";
 
   RS = CRSDCommand("SELECT * FROM DCRE_TRADE_TMP WHERE " + 
                          " T_OBJECTTYPEID = ? " +
                      " AND T_OBJECTNUMBER = ? " +
                      " AND T_TFID = ? ORDER BY T_DATEREPORTED",
                    "p1", ObjectTypeID,
                    "p2", ObjectNumber,
                    "p3", 0,
                   V_GENOBJ);
   VAR Born = date(0,0,0);
   
   IF (TypeClient != PTLEGF_INST)
      Born = SQL_NVL(CRSDCommand("SELECT T_BORN " +
                           " FROM DLBKI_201_TMP cop WHERE " + 
                                " cop.T_OBJECTTYPEID = ? " + 
                            " AND cop.T_OBJECTNUMBER = ? " + 
                            " AND cop.T_PARTYID_REF = ? ",
                            "p1", ObjectTypeID,
                            "p2", ObjectNumber,
                            "p3", ClientID,
                          V_DATE), V_DATE);
   END;

   VAR STRAD = RS.MoveNext(), ObF = "Н";

   IF (NOT STRAD)
      RETURN;
   END;

   VAR BANKGUARANTEEINDICATOR = 0;
   НачатьСложныйБлок("Trades");
   WHILE (STRAD)
      НачатьСложныйБлок("Trade");

      ДобавитьВБлок("DateReported",              SQL_NVL(RS.Value("T_DATEREPORTED"),                V_DATE), "D",    0, "О");
      ДобавитьВБлок("MemberCode",                SQL_NVL(RS.Value("T_MEMBERCODE"),                V_STRING), "S",   12, "О");
      ДобавитьВБлок("Account",                   SQL_NVL(RS.Value("T_ACCOUNT"),                   V_STRING), "S",   35, "О");
      ДобавитьВБлок("Type",                      SQL_NVL(RS.Value("T_TYPE"),                      V_STRING), "A",    2, "О");
      ДобавитьВБлок("Relationship",              SQL_NVL(RS.Value("T_RELATIONSHIP"),              V_STRING), "A",    2, "О");
      ДобавитьВБлок("DateOpened",                SQL_NVL(RS.Value("T_DATEOPENED"),                  V_DATE), "D",    0, "О");

      IF ((TypeClient != PTLEGF_INST) AND (Born > DATE(0, 0, 0)))
         VAR Year = CRSDCommand("SELECT TRUNC(MONTHS_BETWEEN(?, ?) / 12) FROM DUAL",
                    "p1", SQL_NVL(RS.Value("T_DATEOPENED"), V_DATE),
                    "p2", Born,
                    V_INTEGER);         
         
         IF (
             (Year < 14) 
             OR
             (Year > 110)
            )
            InsErrorMessage("Неверное значение обязательного поля");
         END;
      END;
    
      ДобавитьВБлок("DateLastPayment",           SQL_NVL(RS.Value("T_DATELASTPAYMENT"),             V_DATE), "D",    0, "У");
      ДобавитьВБлок("AccountState",              SQL_NVL(RS.Value("T_ACCOUNTSTATE"),              V_STRING), "A",    2, "О");

      // 9. Currency TR(17) Символьный код валюты договора. 
      IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_CURRENCY"), V_STRING)))
         InsErrorMessage("Currency. Код RUR запрещен к передаче!");
      ELSE
         ДобавитьВБлок("Currency",                  SQL_NVL(RS.Value("T_CURRENCY"),                  V_STRING), "S",    3, "Н");
      END;

      // 10. Limit   TR(11) Лимит кредита\Исходная сумма кредита 
      IF (SQL_NVL(RS.Value("T_LIMIT"), V_MONEY) != -1)
         ДобавитьВБлок("Limit",               SQL_NVL(RS.Value("T_LIMIT"),                      V_MONEY), "F",    0, "О");
      ELSE
         ДобавитьВБлок("Limit",                                                                       "", "F",    0, "О");
      END;
      
      // 11. Balance  TR(12) Общая выплаченная сумма, включая проценты и пени за дату, указанную в поле Дата последней выплаты.
      ДобавитьВБлок("Balance",                SQL_NVL(RS.Value("T_BALANCE"),                    V_MONEY), "F",    0, "О");
      
      // 12. PastDue TR(13) Сумма просрочки на последнюю дату обновления, указанную в поле даты отчёта.
      ДобавитьВБлок("PastDue",                SQL_NVL(RS.Value("T_PASTDUE"),                    V_MONEY), "F",    0, "О");
      
      
      // 13.MannerOfPayment TR(16) Своевременность платежей (справочник Своевременность платежей)\Состояние платежа по счету за дату отчета DateReported.
      ДобавитьВБлок("MannerOfPayment",        SQL_NVL(RS.Value("T_MANNEROFPAYMENT"),           V_STRING), "A",    1, "О");
      
      // 14. DateContractTermination TR(19) Дата окончания срока договора.
      ДобавитьВБлок("DateContractTermination",SQL_NVL(RS.Value("T_DATECONTRACTTERMINATION"),     V_DATE), "D",    0, "Н");
      
      // 15. DatePaymentDue TR(20) Договорная дата финального платежа. Может отличаться или совпадать с <Датой окончания срока договора>.
      ДобавитьВБлок("DatePaymentDue",         SQL_NVL(RS.Value("T_DATEPAYMENTDUE"),              V_DATE), "D",    0, "О");
      
      // 16. DateInterestPaymentDue TR(21) Договорная дата финальной выплаты процентов
      ДобавитьВБлок("DateInterestPaymentDue", SQL_NVL(RS.Value("T_DATEINTERESTPAYMENTDUE"),      V_DATE), "D",    0, "О");
      
      // 17. DateAccountState  TR(9) Дата состояния счёта. Дата наступления состояния счёта, указанного в поле 8 <AccountState>.
      // Поле обязательно для заполнения, если Состояние счета (AccountState) не равно 00.
      ДобавитьВБлок("DateAccountState",       SQL_NVL(RS.Value("T_DATEACCOUNTSTATE"),            V_DATE), "D",    0, 
                                                        mandatory(SQL_NVL(RS.Value("T_ACCOUNTSTATE"), V_STRING) != "00"));
      
      // 18. NextPayment TR(14) Сумма следующего очередного платежа. 
      IF (SQL_NVL(RS.Value("T_NEXTPAYMENT"),  V_MONEY) != -1)
         ДобавитьВБлок("NextPayment",         SQL_NVL(RS.Value("T_NEXTPAYMENT"),                V_MONEY), "F",    0, "Н");
      ELSE
         ДобавитьВБлок("NextPayment",                                                                 "", "S",    0, "Н");
      END;
      
      // 19. PaymentFrequency TR(15) Частота выплат по основному долгу (справочник Частоты выплат) 
      IF (SQL_NVL(RS.Value("T_PAYMENTFREQUENCY"), V_STRING) != "-1")
         ДобавитьВБлок("PaymentFrequency", allowed("TRADE", "PAYMENTFREQUENCY", SQL_NVL(RS.Value("T_PAYMENTFREQUENCY"), V_STRING)), "S", 2, 
                                                                                           mandatory(ExpEQIFAX == "3.0"));
      ELSE
         ДобавитьВБлок("PaymentFrequency",                                                            "", "S",    2, "Н");
      END;
                                                                                           
      // 20. Наличие предмета залога 
      IF (TRIM(SQL_NVL(RS.Value("T_COLLATERAL"), V_STRING)) != "")
         ДобавитьВБлок("Collateral",          SQL_NVL(RS.Value("T_COLLATERAL"),          V_STRING):2:0:o, "S",    2, "Н");
      ELSE
         ДобавитьВБлок("Collateral",             "",                                                      "S",    2, "Н");
      END;
      
      // 21. InterestPaymentFrequency TR(22) Частота выплат процентов 
      IF (SQL_NVL(RS.Value("T_INTERESTPAYMENTFREQUENCY"),  V_STRING) != "-1")
         ДобавитьВБлок("InterestPaymentFrequency", SQL_NVL(RS.Value("T_INTERESTPAYMENTFREQUENCY"), V_STRING), "S",   2, "Н");
      
      ELSE
         ДобавитьВБлок("InterestPaymentFrequency",                                                        "", "S",   2, "Н");
      END;
     
      // 22. OldMemberCode TR(23) Старый код участника
      ДобавитьВБлок("OldMemberCode",             SQL_NVL(RS.Value("T_OLDMEMBERCODE"),             V_STRING), "S",   12, "Н");

      // 23. OldAccount Старый номер счета.
      ДобавитьВБлок("OldAccount",                SQL_NVL(RS.Value("T_OLDACCOUNT"),                V_STRING), "S",   35, "Н");

      // 24. AmountOutstanding TR(25) Текущая задолженность. Размер суммарной текущей задолженности по данному кредиту, включая проценты и пени. 
      ДобавитьВБлок("AmountOutstanding",         SQL_NVL(RS.Value("T_AMOUNTOUTSTANDING"),          V_MONEY), "F",    0, "О");

      // 60. Разрешение на экспорт во все БКИ.
      ДобавитьВБлок("CanExport",                 SQL_NVL(RS.Value("T_CANEXPORT"),                 V_STRING), "A",    1, "Н");

      // 61. Разрешение на экспорт в НБКИ.
      ДобавитьВБлок("CanExportNBCH",             SQL_NVL(RS.Value("T_CANEXPORTNBCH"),             V_STRING), "A",    1, "Н");

      // 62. Разрешение на экспорт в Эквифакс.
      ДобавитьВБлок("CanExportGPCS",             SQL_NVL(RS.Value("T_CANEXPORTGPCS"),             V_STRING), "A",    1, "Н");

      // 63. Разрешение на экспорт в Экспериан (ОКБ) 
      ДобавитьВБлок("CanExportExperian",         SQL_NVL(RS.Value("T_CANEXPORTEXPERIAN"),         V_STRING), "A",    1, "Н");

      // 64. Разрешение на экспорт в КБРС
      ДобавитьВБлок("CanExportBrs",              SQL_NVL(RS.Value("T_CANEXPORTBRS"),              V_STRING), "S",    1, "Н");

      // 65. Разрешение на экспорт в КБРС
      ДобавитьВБлок("Updated",                   SQL_NVL(RS.Value("T_DATEREPORTED"),                V_DATE), "D",    0, "Н");

      // Поля (66-74) заполняются если установлено одно из значений для ПП "CRE. Разрешен экспорт в Эквифакс" "2.0",  "3.0".
      IF ((ExpEQIFAX == "3.0") OR (ExpEQIFAX == "2.0"))
         IF ((ValType(RS.Value("T_ENDDATEFACT")) != V_SPECVAL))
            // 66. Дата фактического исполнения обязательств заемщика в полном размере. 
            ДобавитьВБлок("EndDateFact",               SQL_NVL(RS.Value("T_ENDDATEFACT"),           V_DATE), "D",    0, "Н");
         END;
      
         // 67. Сумма фактического частичного исполнения обязательств заемщика.
         ДобавитьВБлок("LastPayment",               SQL_NVL(RS.Value("T_LASTPAYMENT"),             V_MONEY), "F",    0, "Н");

         // 68. Комментарий партнера
         // ДобавитьВБлок("Comment",                SQL_NVL(RS.Value("T_COMMENT"),                V_STRING), "S",   80, "Н");
      
         // 69. Текущий неиспользованный лимит.
         IF (ValType(RS.Value("T_CURLIMIT")) == V_MONEY)
            ДобавитьВБлок("CurLimit",               SQL_NVL(RS.Value("T_CURLIMIT"),                V_MONEY), "F",    0, "У");

         ELSE
            ДобавитьВБлок("CurLimit",                                                                    "", "P",    0, "У");

         END;
      
         // 70. Сумма просрочки по основному долгу.
         ДобавитьВБлок("PastDueNoExtra",            SQL_NVL(RS.Value("T_PASTDUENOEXTRA"),          V_MONEY), "F",    0, "О");
      
         IF (ExpEQIFAX != "3.0")
            // 71. Дата уплаты процентов по договору.
            ДобавитьВБлок("NextInterPaymentDate",      SQL_NVL(RS.Value("T_NEXTINTERPAYMENTDATE"),  V_DATE), "D",    0, "Н");
      
            // 72. Сумма фактического исполнения обязательств заемщика в полном размере.
            // Если договор закрыт, то значение равно записи 11 Balance данного сегмента.
            // Иначе, значение не заполняется.
            IF (ValType(RS.Value("T_TOTALSUMFACT")) != V_SPECVAL)
               ДобавитьВБлок("TotalSumFact",              SQL_NVL(RS.Value("T_TOTALSUMFACT"),      V_MONEY), "F",    0, "У");
            END;
         END;
      
         // 73. Текущая задолженность по основному долгу.
         ДобавитьВБлок("AmountOutstandingNoExtra",  SQL_NVL(RS.Value("T_AMOUNTOUTSTANDINGNOEXTRA"), V_MONEY), "F",   0, "О");
      
         // 74. Дата фактического исполнения обязательств заемщика в неполном размере, дата последней выплаты по основному долгу.
         ДобавитьВБлок("DateLastPaymentNoExtra", SQL_NVL(RS.Value("T_DATELASTPAYMENTNOEXTRA"),      V_DATE), "D",    0, 
                                                                                              mandatory(ExpEQIFAX == "3.0"));
      END;

      // Поля (75-88) заполняются если установлено значение для ПП "CRE. Разрешен экспорт в Эквифакс"равно  "3.0"
      IF (ExpEQIFAX == "3.0")
         // 78. Флаг страховки кредита
         ДобавитьВБлок("InsuredFlag",               SQL_NVL(RS.Value("T_INSUREDFLAG"),               V_STRING), "A", 1, "Н");
      
         // 79. Сумма страховки кредита
         ДобавитьВБлок("InsuredAmount",             SQL_NVL(RS.Value("T_INSUREDAMOUNT"),              V_MONEY), "F", 0, "У");
      
         // 80. Дата последнего пропущенного платежа.
         ДобавитьВБлок("MissedPaymentDate",         SQL_NVL(RS.Value("T_MISSEDPAYMENTDATE"),           V_DATE), "D", 0, "О");
      
         // 81. Баланс по основному долгу
         ДобавитьВБлок("BalanceNoExtra",            SQL_NVL(RS.Value("T_BALANCENOEXTRA"),             V_MONEY), "F", 0, "О");
      
         // 82. Дата возникновения просрочки по основному долгу. 
         ДобавитьВБлок("CurrentOverdueNoExtraDate", SQL_NVL(RS.Value("T_CURRENTOVERDUENOEXTRADATE"),   V_DATE), "D", 0, "О");
      
         // 83. Сумма следующего платежа по основному долгу. 
         ДобавитьВБлок("NextPaymentNoExtra",        SQL_NVL(RS.Value("T_NEXTPAYMENTNOEXTRA"),         V_MONEY), "F", 0, "О");
      
         // 84. Дата следующего платежа по основному долгу. 
         ДобавитьВБлок("NextPaymentNoExtraDate",    SQL_NVL(RS.Value("T_NEXTPAYMENTNOEXTRADATE"),      V_DATE), "D", 0, "О");
      
         // 85. Сумма фактического исполнения обязательств заемщика в неполном размере (последний платеж).
         ДобавитьВБлок("TotalLastPayment",          SQL_NVL(RS.Value("T_TOTALLASTPAYMENT"),           V_MONEY), "F", 0, "О");
      
         // 86. Дата возникновения текущей просрочки. 
         ДобавитьВБлок("CurrentOverdueDate",        SQL_NVL(RS.Value("T_CURRENTOVERDUEDATE"),          V_DATE), "D", 0, "О");
      
         // 87. Дата следующего платежа.
         ДобавитьВБлок("NextPaymentDate",           SQL_NVL(RS.Value("T_NEXTPAYMENTDATE"),             V_DATE), "D", 0, "О");
      
         // 88. Статус кредитной линии. Допустимые значения:
         ДобавитьВБлок("CredFacility",              SQL_NVL(RS.Value("T_CREDFACILITY"),             V_INTEGER), "N", 1, "Н");
      END;

      IF (ExpEXPERIAN == "ДА")
         // 89. Если кредитная линия одновременно имеет и лимит выдачи и лимит задолженности, то в данном поле необходимо указывать лимит задолженности.
         ДобавитьВБлок("PaymentLimit",              SQL_NVL(RS.Value("T_PAYMENTLIMIT"),               V_MONEY), "F", 0, "С");

         // 90. Код одноименного словаря Experian, который идентифицирует тип кредита
         ДобавитьВБлок("FinanceType",               allowed("TRADE", "FINANCETYPE", 
                                                   string(SQL_NVL(RS.Value("T_FINANCETYPE"),   V_INTEGER):2:0:o)), "S", 2, "Н");
      
         // 91. Код одноименного словаря Experian, который идентифицирует цель кредитования. 
         ДобавитьВБлок("PurposeOfFinance",                                                                  "", "S",    2, "Н");
      
         // 92. Поле отражает исполнение платежей по счету за дату учета. 
         ДобавитьВБлок("AccPaymentStatus",          SQL_NVL(RS.Value("T_ACCPAYMENTSTATUS"),          V_STRING), "A",    2, "Н");
      
         // 93. Поле "Interestrate" (Процентная ставка, числовое значение годовой процентной ставки, указанной в договоре).
         // ДобавитьВБлок("InterestRate",              SQL_NVL(RS.Value("T_INTERESTRATE"),            V_MONEY), "F",    0, "Н");
      
         // 94. Поле "Reasonforclosure" (Причина закрытия).
         // ДобавитьВБлок("ReasonForClosure",       SQL_NVL(RS.Value("T_REASONFORCLOSURE"),         V_INTEGER), "N",    2, "Н");
      
         // 95. Статус кредитного дела в ОКБ. 
         // ДобавитьВБлок("StatusEI",                  SQL_NVL(RS.Value("T_STATUSEI"),              V_INTEGER), "N",    1, "Н");
      
         // 96. Статус кредитного дела в КБРС:
         // ДобавитьВБлок("StatusBRS",                 SQL_NVL(RS.Value("T_STATUSBRS"),             V_INTEGER), "N",    1, "Н");
      END;

      // 25. ApplicationNumber Уникальный номер кредитной заявки
      ДобавитьВБлок("ApplicationNumber",         SQL_NVL(RS.Value("T_APPLICATIONNUMBER"),         V_STRING), "S",   30, "У");

      // 26. Дата и время кредитной заявки
      ДобавитьВБлок("ApplicationDate",           SQL_NVL(RS.Value("T_APPLICATIONDATE"),           V_STRING), "S",    0, "У");

      // 27. Информация об отсутствии двух и более подряд платежей в течение 120 календарных дней 
      //     с даты наступления срока исполнения обязательства по договору займа (кредита)
      ДобавитьВБлок("TwoConsPayMissed",          SQL_NVL(RS.Value("T_TWOCONSPAYMISSED"),         V_INTEGER), "N",    1, "У");

      // 28. Признак погашения кредита в полном объеме
      ДобавитьВБлок("FullyPaidOff",              SQL_NVL(RS.Value("T_FULLYPAIDOFF"),             V_INTEGER), "N",    1, "У");
      
      // 29. Признак погашения кредита в полном объеме
      ДобавитьВБлок("FullyPaidOffDate",          SQL_NVL(RS.Value("T_FULLYPAIDOFFDATE"),            V_DATE), "D",    1, 
                                                           mandatory(SQL_NVL(RS.Value("T_ACCOUNTSTATE"), V_STRING) == "13"));
      
      // 30. TotalCredCost TR(37) Полная стоимость кредита.
      // Обязательно для ФЛ. Для ИП доп проверка, на договоре должен стоять признак - физ. лицо (credit_c.rec.TYPEDEBTOR = 2). 
      var TOTALCREDCOST = "";
      var Обяз = "Н";
      IF ((TypeClient == PTLEGF_PERSN) or ((TypeClient == PTLEGF_PBUL) and (credit_c.rec.TYPEDEBTOR == 2)))
            TOTALCREDCOST = SQL_NVL(RS.Value("T_TOTALCREDCOST"),             V_STRING);
            Обяз = "О";
      END;
      ДобавитьВБлок("TotalCredCost",TOTALCREDCOST         , "F",    0, Обяз );
      
      // 31. Отображение данного договора в информационной части (только для ОКБ)
      ДобавитьВБлок("AllowInInfoPart",           SQL_NVL(RS.Value("T_ALLOWININFOPART"),          V_INTEGER), "N",    1, "Н");

      // 32. Номер договора займа.
      ДобавитьВБлок("Contract",                  SQL_NVL(RS.Value("T_CONTRACT"),                  V_STRING), "S",   35, mandatory((ExpEXPERIAN == "ДА")
                                                                                                                                  and
                                                                                                                                  (credit_c.rec.RegDate>=date(01,03,2015))
                                                                                                                                  ));

      IF (ObjectTypeID == LO_ENSCONTR)
         ДобавитьВБлок("GuaranteeIndicator",     "",                                                         "S",    2, "Н");

      ELSE
         // 33. GuaranteeIndicator TR(26) Флаг о наличии поручителя 
         ДобавитьВБлок("GuaranteeIndicator",     SQL_NVL(RS.Value("T_GUARANTORINDICATOR"),       V_INTEGER), "N",    1, "У");

      END;

      // 34. TR(30) Флаг о наличии банковской гарантии (Bank guarantee indicator). 
      ДобавитьВБлок("BankGuaranteeIndicator", SQL_NVL(RS.Value("T_BANKGUARANTEEINDICATOR"),      V_INTEGER), "N",    1, "У");

      // 88. Категория потребительского займа (кредита) по справочнику. 
      IF (ExpEXPERIAN == "ДА")
         var CATEGORY = SQL_NVL(RS.Value("T_CATEGORY"), V_INTEGER);
         IF (CATEGORY == 0) //Категорию не удалось определить
            IF (TypeClient == PTLEGF_PBUL)
                CATEGORY = 601;
            ELSE
                CATEGORY = 999;
            END;                
         END;
         
         ДобавитьВБлок("Category",                  allowed("Trade", "Category", CATEGORY), "N",    3, "Н");
      END;

      // Поля (75-88) заполняются если установлено значение для ПП "CRE. Разрешен экспорт в Эквифакс"равно  "3.0"
      IF (ExpEQIFAX == "3.0")
         // 76. Способ предоставления займа (кредита)
         ДобавитьВБлок("CredWay",                   SQL_NVL(RS.Value("T_CREDWAY"),                  V_INTEGER), "N",    2, "У");
      
         // 77. Запрошенная сумма займа (кредита).
         ДобавитьВБлок("ReqAmount",                 SQL_NVL(RS.Value("T_REQAMOUNT"),                  V_MONEY), "F",    0, "У");
      END;

      // если поля не заполняются, то CRE само определяет значения
      ДобавитьВБлок("CredActive",              "", "N", 1, "Н");
      ДобавитьВБлок("CredSpecialStatus",       "", "N", 1, "Н");

      IF (ObjectTypeID == LO_ENSCONTR)
         // 35. Уникальный номер (ID) договора поручительства.
         ДобавитьВБлок("GuaranteeNumber",           SQL_NVL(RS.Value("T_GUARANTEENUMBER"),           V_STRING), "S",   35, "У");

      ELSE
         // 35. Уникальный номер (ID) договора поручительства.
         ДобавитьВБлок("GuaranteeNumber", "", "S",   35, "У");
      
      END;

      // 36. 
      ДобавитьВБлок("GuaranteeExecutedIndicator", SQL_NVL(RS.Value("T_GUARANTEEEXECUTEDINDICATOR"), V_INTEGER), "N", 1, "Н");

      // 37. GuaranteeVolume TR(27) Объем обязательства, обеспечиваемого поручительством.
      ДобавитьВБлок("GuaranteeVolume",            SQL_NVL(RS.Value("T_GUARANTEEVOLUME"),          V_INTEGER), "N",    1, "У");
      

      IF (ObjectTypeID == LO_ENSCONTR)
         // 38. GuaranteeSum  TR(28) Сумма поручительства.
         ДобавитьВБлок("GuaranteeSum",               SQL_NVL(RS.Value("T_GUARANTEESUM"),               V_MONEY), "F",    0, 
                                                                                         mandatory(ObjectTypeID == LO_ENSCONTR));
         
         // 39. Валюта суммы поручительства. Обязательно, если отлично от рублей.
         IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_GUARANTEESUMCURRENCY"), V_STRING)))
            InsErrorMessage("GuaranteeSumCurrency. Код RUR запрещен к передаче!");
         ELSE
            ДобавитьВБлок("GuaranteeSumCurrency",      SQL_NVL(RS.Value("T_GUARANTEESUMCURRENCY"),      V_STRING), "S",    3, "У");
         END;
      
         IF ((TypeClient != PTLEGF_INST) AND (Born > DATE(0, 0, 0)) AND (SQL_NVL(RS.Value("T_GUARANTEEDATE"), V_DATE) > DATE(0,0,0)))
            Year = CRSDCommand("SELECT TRUNC(MONTHS_BETWEEN(?, ?) / 12) FROM DUAL",
                       "p1", SQL_NVL(RS.Value("T_GUARANTEEDATE"), V_DATE),
                       "p2", Born,
                       V_INTEGER);         
            
            IF (
                (Year < 14) 
                OR
                (Year > 110)
               )
               InsErrorMessage("Неверное значение обязательного поля");
            END;
         END;
      
         // 40. Дата договора поручительства. Обязателен для поручителей и гарантов. 
         ДобавитьВБлок("GuaranteeDate",             SQL_NVL(RS.Value("T_GUARANTEEDATE"),               V_DATE), "D",    0, "У");
      
         // 41. GuaranteeEndDate TR(29) Дата окончания (срок) договора поручительства 
         ДобавитьВБлок("GuaranteeEndDate",       SQL_NVL(RS.Value("T_GUARANTEEENDDATE"),            V_DATE), "D",    0, 
                                                                                        mandatory(ObjectTypeID == LO_ENSCONTR));

         // 42. Причина окончания срока действия договора поручительства
         ДобавитьВБлок("GuaranteeReasonForClosure",SQL_NVL(RS.Value("T_GuaranteeReasonForClosure"), V_INTEGER) , "N", 1, "У");

      ELSE
         // 38. GuaranteeSum  TR(28) Сумма поручительства.
         ДобавитьВБлок("GuaranteeSum",              "", "S", 1, "Н");
         
         // 39. Валюта суммы поручительства. Обязательно, если отлично от рублей.
         ДобавитьВБлок("GuaranteeSumCurrency",      "", "S", 1, "Н");
      
         // 40. Дата договора поручительства. Обязателен для поручителей и гарантов. 
         ДобавитьВБлок("GuaranteeDate",             "", "S", 1, "Н");
      
         // 41. GuaranteeEndDate TR(29) Дата окончания (срок) договора поручительства 
         ДобавитьВБлок("GuaranteeEndDate",          "", "S", 1, "Н");

         // 42. Причина окончания срока действия договора поручительства
         ДобавитьВБлок("GuaranteeReasonForClosure", "", "S", 1, "Н");

      END;

      // 43. Наименования приобретателя права требования 
      ДобавитьВБлок("PurchaserBusinessName",     SQL_NVL(RS.Value("T_PURCHASERBUSINESSNAME"),     V_STRING), "S", 1020, "У");  

      // 44. ОГРН для ЮЛ или ОГРНИП для ФЛ. Обязательно для ЮЛ.
      ДобавитьВБлок("PurchaserOGRN        ",     SQL_NVL(RS.Value("T_OGRN"),                      V_STRING), "S",   20, "У");  

      // 45. ИНН. Обязательно для ЮЛ.
      ДобавитьВБлок("PurchaserINN         ",     SQL_NVL(RS.Value("T_INN"),                       V_STRING), "S",   12, "У");  

      // 46. Фамилия приобретателя прав - ФЛ
      ДобавитьВБлок("PurchaserLastName    ",     SQL_NVL(RS.Value("T_PURCHASERLASTNAME"),         V_STRING), "S",   60, "У");  

      // 47. Имя приобретателя прав - ФЛ
      ДобавитьВБлок("PurchaserFirstName   ",     SQL_NVL(RS.Value("T_PURCHASERFIRSTNAME"),        V_STRING), "S",   60, "У");  

      // 48. Отчество приобретателя прав - ФЛ
      ДобавитьВБлок("PurchaserMiddleName  ",     SQL_NVL(RS.Value("T_PURCHASERMIDDLENAME"),       V_STRING), "S",   60, "У");  

      // 49. Дата рождения приобретателя прав - ФЛ
      ДобавитьВБлок("PurchaserBirthDate   ",     SQL_NVL(RS.Value("T_PURCHASERBIRTHDATE"),          V_DATE), "D",   10, "У");  

      // 50. Место рождения приобретателя прав - ФЛ
      ДобавитьВБлок("PurchaserBirthPlace  ",     SQL_NVL(RS.Value("T_PURCHASERBIRTHPLACE"),       V_STRING), "S", 1020, "У");  

      // 51. Тип документа, удостоверяющего личность
      ДобавитьВБлок("PurchaserDocType     ",     SQL_NVL(RS.Value("T_PURCHASERDOCTYPE"),          V_STRING), "S",    2, "У");  

      // 52. Серия и номер документа, удостоверяющего личность.
      ДобавитьВБлок("PurchaserDocNumber   ",     SQL_NVL(RS.Value("T_PURCHASERDOCNUMBER"),        V_STRING), "S",   40, "У");  

      // 53. Дата выдачи документа, удостоверяющего личность.
      ДобавитьВБлок("PurchaserDocDate     ",     SQL_NVL(RS.Value("T_PURCHASERDOCDATE"),            V_DATE), "D",   10, "У");  

      // 55. Наименование органа, выдавшего ДУЛ.
      ДобавитьВБлок("PurchaserDocAuthority",     SQL_NVL(RS.Value("T_PURCHASERDOCAUTHORITY"),     V_STRING), "S",  200, "У");  

      // 57. TR(41) СНИЛС приобретателя права требования 
      ДобавитьВБлок("PurchaserSNILS       ",     SQL_NVL(RS.Value("T_SNILS"),                     V_STRING), "S",   11, "У");  

      // 59. Дата уступки прав требования. 
      ДобавитьВБлок("PurchaserAssigneeDate",     SQL_NVL(RS.Value("T_PURCHASERASSIGNEEDATE"),       V_DATE), "D",    0, "У");   

      // 95. Статус кредитного дела в НБКИ. 
      // ДобавитьВБлок("StatusNBCH",                SQL_NVL(RS.Value("T_STATUSNBCH"),            V_INTEGER), "N",    1, "Н");

      // 96. Статус кредитного дела в ЭКС. 
      // ДобавитьВБлок("StatusGPCS",                SQL_NVL(RS.Value("T_STATUSGPCS"),            V_INTEGER), "N",    1, "Н");
 
      // 97. Статус кредитного дела в ОКБ. 
      // ДобавитьВБлок("StatusEI",                  SQL_NVL(RS.Value("T_STATUSEI"),              V_INTEGER), "N",    1, "Н");
      
      // 98. Статус кредитного дела в КБРС:
      // ДобавитьВБлок("StatusBRS",                 SQL_NVL(RS.Value("T_STATUSBRS"),             V_INTEGER), "N",    1, "Н");
      
      IF ((TRIM(SQL_NVL(RS.Value("T_COLLATERAL"), V_STRING ) ) != "") /*and (TRIM(SQL_NVL(RS.Value("T_COLLATERAL"), V_STRING ) ) != "03")*/)
         СформироватьСегмент_TradeCollateral(ObjectTypeID, ObjectNumber, SendKind);
      END;

      ДобавитьВБлок("Extra                ",                                    "",                          "S",  250, "Н");  

      // 34.
      ДобавитьВБлок("ExtraDetail          ",     SQL_NVL(RS.Value("T_EXTRADETAIL"),               V_STRING), "S",  250, "Н");

      ВставитьСложныйБлок();

      STRAD = RS.MoveNext();

      BANKGUARANTEEINDICATOR = SQL_NVL(RS.Value("T_BANKGUARANTEEINDICATOR"), V_INTEGER);
   END;

   ВставитьСложныйБлок();

   IF (BANKGUARANTEEINDICATOR != 0)
      СформироватьСегмент_BankGuarantee(ObjectTypeID, ObjectNumber, ClientID, SendKind);
   END;
END;

// 12.2.9   Employment - места работы
MACRO СформироватьСегмент_Employment(PartyID: integer, ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Employment(?, ?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("PartyID",      RSDBP_IN); RSDcmd.value("PartyID")      = PartyID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectTypeID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT * FROM DLBKI_412_TMP l412 WHERE " + 
                              " l412.T_PARTYID      = ? " +
                          " AND l412.T_OBJECTTYPEID = ? " +
                          " AND l412.T_OBJECTNUMBER = ? " +
                          " AND l412.T_TFID_REF     = ? ",
                        "p1", PartyID,
                        "p2", ObjectTypeID,
                        "p3", ObjectNumber,
                        "p4", 0,
                       V_GENOBJ);
   VAR STAT = RS.MoveNext();
   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("Employments");
   IF (STAT)
      НачатьСложныйБлок("Employment");

      ДобавитьВБлок("EmployerName", SQL_NVL(RS.Value("T_EMPLOYERNAME"),     V_STRING), "S", 170, "О");

      IF (StrLen(SQL_NVL(RS.Value("T_OCCUPATIONCODE"),   V_STRING)) > 1)
         ДобавитьВБлок("OccupationCode",   SQL_NVL(RS.Value("T_OCCUPATIONCODE"),   V_STRING), "A",   2, "Н");
      END;
   
      IF (Trim(SQL_NVL(RS.Value("T_OCCUPATIONSTATUS"),   V_STRING)) != "")
         ДобавитьВБлок("OccupationStatus", SQL_NVL(RS.Value("T_OCCUPATIONSTATUS"), V_STRING), "A",   1, "Н");
      END;
      ДобавитьВБлок("Current",      SQL_NVL(RS.Value("T_CURRENT"),          V_STRING), "A",   1, "Н");

      ВставитьСложныйБлок();

      STAT = RS.MoveNext();
   END;
   ВставитьСложныйБлок();
END;

// 12.2.6   Legal - судебное дело
MACRO СформироватьСегмент_Legal(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)

   IF ((ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_CLAIM))
      RETURN;
   END;

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Legal(?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT * FROM DLBKI_406_TMP l406 WHERE " + 
                              " l406.T_CREDITNUMBER_REF = ? " +
                          " AND l406.T_TFID_REF = ? " +
                          " AND l406.T_SUITNUMBER2 IS NOT NULL " +
                          " AND l406.T_COURTNAME2  IS NOT NULL " +
                          " AND l406.T_INF2 IS NOT NULL ",
                        "p1", ObjectNumber,
                        "p2", 0,
                         V_GENOBJ), DateSatisfied;
   VAR STAT = RS.MoveNext(), UsCreditNumber = "";

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("Legals");
   WHILE (STAT)
      НачатьСложныйБлок("Legal");

      ДобавитьВБлок("DateReported",  ReportDate,                                   "D",   0, "О");
                                                                                           
      // LE(2) Номер иска                                                                  
      ДобавитьВБлок("ClaimNumber",   SQL_NVL(RS.Value("T_SUITNUMBER2"), V_STRING), "S",  35, "О");

      // LE(3) Наименование суда                                                           
      ДобавитьВБлок("CourtName",        SQL_NVL(RS.Value("T_COURTNAME2"),  V_STRING),       "S", 170, "О");

      // LE(6) Дата возмещения                                                             
      ДобавитьВБлок("DateSatisfied",    SQL_NVL(RS.Value("T_DATESATISFIED"), V_DATE),       "D",   0, "Н");
                                                                                           
      // LE(8)Резолютивная часть судебного решения\решение                                 
      ДобавитьВБлок("Resolution",       SQL_NVL(RS.Value("T_INF2"), V_STRING),              "S", 1500, "О");

      // Номер решения суда
      ДобавитьВБлок("ResolutionNumber", SQL_NVL(RS.Value("T_RESOLUTIONNUMBER"), V_STRING),  "S", 60, "О");

      // Тип судебного решения.
      ДобавитьВБлок("ResolutionType",   SQL_NVL(RS.Value("T_RESOLUTIONTYPE"),   V_INTEGER), "N",  1, "О");

      IF(
         (SQL_NVL(RS.Value("T_RESOLUTIONTYPE"),   V_INTEGER) == 3)
          OR
         (SQL_NVL(RS.Value("T_RESOLUTIONTYPE"),   V_INTEGER) == 5)
        )
         // Сумма взыскания по решению суда, если она была в решении. 
         ДобавитьВБлок("RecoveryAmount",   SQL_NVL(RS.Value("T_RECOVERYAMOUNT"),   V_MONEY), "N",  15, 
                                           mandatory((SQL_NVL(RS.Value("T_RESOLUTIONTYPE"), V_INTEGER) == 3) OR 
                                                     (SQL_NVL(RS.Value("T_RESOLUTIONTYPE"), V_INTEGER) == 5)));
      
         // Валюта взыскания
         IF (({curdate} >= date(1,8,2011)) AND ("RUR" == SQL_NVL(RS.Value("T_RECOVERYCURRENCY"), V_STRING)))
            InsErrorMessage("RecoveryCurrency. Код RUR запрещен к передаче!");
         ELSE
            ДобавитьВБлок("RecoveryCurrency", SQL_NVL(RS.Value("T_RECOVERYCURRENCY"), V_STRING),  "S",   3, "Н");
         END;      
      END;

      // Номер счета, к которому относится информация из данного блока
      ДобавитьВБлок("Account",          SQL_NVL(RS.Value("T_ACCOUNT"), V_STRING),           "S",  35, mandatory(ExpEXPERIAN == "ДА"));

      // Дата фактического обновления
      ДобавитьВБлок("Updated",          SQL_NVL(RS.Value("T_UPDATED"), V_DATE),             "D",  0, "Н");

      ВставитьСложныйБлок();

      STAT = RS.MoveNext();
   END;
      ВставитьСложныйБлок();
END;

// 12.2.7   Official - информация полученная из официальных органов
MACRO СформироватьСегмент_Official(ObjectType: integer, ObjectNumber: integer)
   IF ((ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_CLAIM))
      RETURN;
   END;

   VAR RS = CRSDCommand("SELECT * FROM DLBKI_406_TMP l406 WHERE " + 
                              " l406.T_CREDITNUMBER_REF = ? " +
                          " AND l406.T_TFID_REF = ? " +
                          " AND T_COURTNAME3 IS NOT NULL " +
                          " AND T_INF3 IS NOT NULL ",
                        "p1", ObjectNumber,
                        "p2", 0,
                         V_GENOBJ), DateSatisfied;

   VAR STAT = RS.MoveNext();

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("Officials");
   WHILE (STAT)
      НачатьСложныйБлок("Official");

      ДобавитьВБлок("DateReported", ReportDate, "D",   0, "О");
      ДобавитьВБлок("Source",       SQL_NVL(RS.Value("T_COURTNAME3"), V_STRING), "S", 180, "О");
      ДобавитьВБлок("Information",  SQL_NVL(RS.Value("T_INF3"),       V_STRING), "S", 500, "О");
      ДобавитьВБлок("Updated",      ReportDate,                                  "D",   0, "Н");

      ВставитьСложныйБлок();

      STAT = RS.MoveNext();
   END;
   ВставитьСложныйБлок();
END;


// 12.2.5   Phone - телефонные номера
MACRO СформироватьСегмент_Phone(PartyID: integer, ObjectType: integer, ObjectNumber: integer, SendKind: integer)

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Phone(?, ?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("PartyID",      RSDBP_IN); RSDcmd.value("PartyID")      = PartyID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectType;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT * FROM DLBKI_PHONE_TMP LBKI_PHONE WHERE " + 
                              " LBKI_PHONE.T_PARTYID_REF  = ? " +
                          " AND LBKI_PHONE.T_OBJECTTYPEID = ? " +
                          " AND LBKI_PHONE.T_OBJECTNUMBER = ? " +
                          " AND LBKI_PHONE.T_TFID_REF     = ? " +
                          " AND Length(NVL(LBKI_PHONE.T_CONTACT_VALUE, CHR(1))) > 2 ",
                        "p1", PartyID,
                        "p2", ObjectType,
                        "p3", ObjectNumber,
                        "p4", 0,
                         V_GENOBJ), LF, CNT = 2;

   VAR STAT = RS.MoveNext;

   // В режиме выгрузки изменений записей может не быть
   IF ((NOT STAT) AND (SendKind == REQUEST_CHNG))
      RETURN;
   END;

   НачатьСложныйБлок("Phones");
   WHILE (STAT)
      IF ( Trim ( SQL_NVL(RS.Value("T_CONTACT_VALUE"), V_STRING ) ) != "" )
         НачатьСложныйБлок("Phone");
         ДобавитьВБлок("Type",   SQL_NVL(RS.Value("T_CONTACTTYPE"),  V_INTEGER ), "A",  1, "Н");
         ДобавитьВБлок("Number", SQL_NVL(RS.Value("T_CONTACT_VALUE"), V_STRING ), "S", 14, "О");
         ВставитьСложныйБлок();
      END;

      IF ((TypeClient == PTLEGF_INST) AND (SQL_NVL(RS.Value("T_CONTACTTYPE"), V_INTEGER ) == 1)) 
         CNT = 0;
      END;

      STAT = RS.MoveNext();
   END;
   ВставитьСложныйБлок();

   IF ((TypeClient == PTLEGF_INST) AND (CNT == 2))
      InsErrorMessage("Для юр. лица должен быть задан рабочий телефон!");
   END;

END;

// 12.2.3   Document - Идентификатор личности\документа
MACRO СформироватьСегмент_Document(PartyID: integer, ObjectType: integer, ObjectNumber: integer, SendKind: integer)
   var fFiz = 0, fPbul = 0, fUr = 0;
   var fUr_84 = 0;
   var DocKind = 0,
       НомерДокумента       : string = "",
       СерияДокумента       : string = "",
       ФлагОбязСерии        : string = "У",
       ФлагОбязНомер        : string = "О";
   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Document(?, ?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("PartyID",      RSDBP_IN); RSDcmd.value("PartyID")      = PartyID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectType;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;
 
   VAR Born = date(0,0,0);

   // Для заемщика физического лица (в т.ч. и частного предпринимателя)
   // обязательно наличие хотя бы одного сегмента Document с типом от 1 до 27   
   IF ((TypeClient == PTLEGF_PERSN) OR (TypeClient == PTLEGF_PBUL))
      Born = SQL_NVL(CRSDCommand("SELECT T_BORN " +
                  " FROM DLBKI_201_TMP cop WHERE " + 
                  " cop.T_OBJECTTYPEID = ? " + 
              " AND cop.T_OBJECTNUMBER = ? " +
              " AND cop.T_PARTYID_REF  = ? ",
              "p2", ObjectTypeID,
              "p3", ObjectNumber,
              "p4", PartyID,
              V_DATE), V_DATE);
   END;
   var RS = CRSDCommand("SELECT * FROM DCRE_DOCUMENT_TMP l WHERE " +
                               " l.T_TFID         = 0 " +
                           " AND l.T_PARTYID      = ? " +
                           " AND l.T_OBJECTTYPEID = ? " +
                           " AND l.T_OBJECTNUMBER = ? " +
                         "ORDER BY T_TYPE ",
                            "p1", PartyID,
                            "p2", ObjectType,
                            "p3", ObjectNumber,
                             V_GENOBJ);

   VAR STAT = rs.MoveNext();

   // В режиме выгрузки изменений записей может не быть
   IF ((NOT STAT) AND (SendKind == REQUEST_CHNG))
      RETURN;
   END;

   НачатьСложныйБлок("Documents");

   WHILE (STAT)
      НомерДокумента = "";
      СерияДокумента = "";
      ФлагОбязСерии  = "У";
      ФлагОбязНомер  = "О";

      НачатьСложныйБлок("Document");
      DocKind = SQL_NVL(RS.Value("T_TYPE"),   V_INTEGER );
      
      НомерДокумента = SQL_NVL(RS.Value("T_NUMBER"),     V_STRING);      
      IF ((DocKind == 1) OR (DocKind == 2) OR (DocKind == 21) OR (DocKind == 22))
           ФлагОбязСерии = "О";
           СерияДокумента = SQL_NVL(RS.Value("T_SERIES"),    V_STRING);

      ELIF (DocKind == 97)
         IF (ObjectTypeID == LO_CLAIM)
            VAR DateOpen = CRSDCommand("SELECT TO_DATE(L.T_APPLICATIONDATE, 'dd.mm.yyyy hh:mi:ss') AS BORN " +
                                        " FROM DCRE_INFOPART_TMP l WHERE " + 
                                             " L.T_CLAIMID = ? " +
                                         " AND L.T_TFID = ?",
                                      "p1", ObjectNumber,
                                      "p2", 0,
                                     V_DATE);
         ELIF (ObjectTypeID == LO_GUARANTEE)
            DateOpen = CRSDCommand("SELECT T_DATE " +
                                        " FROM DCRE_BANKGUARANTEE_TMP l WHERE " + 
                                             " L.T_OBJECTTYPEID = ? " +
                                         " AND L.T_OBJECTNUMBER = ?",
                                      "p1", ObjectTypeID,
                                      "p2", ObjectNumber,
                                     V_DATE);

         ELSE
            VAR RST= CRSDCommand("SELECT T_DATEOPENED, T_GUARANTEEDATE, T_RELATIONSHIP FROM DCRE_TRADE_TMP WHERE " + 
                                       " T_OBJECTTYPEID = ? " +
                                   " AND T_OBJECTNUMBER = ? " +
                                   " AND T_TFID = ? ORDER BY T_DATEREPORTED",
                                      "p1", ObjectType,
                                      "p2", ObjectNumber,
                                      "p3", 0,
                                     V_GENOBJ);
            RST.MoveNext();

            IF (SQL_NVL(RST.Value("T_RELATIONSHIP"), V_INTEGER) == 5)
               DateOpen = SQL_NVL(RST.Value("T_GUARANTEEDATE"), V_DATE);
            ELSE
               DateOpen = SQL_NVL(RST.Value("T_DATEOPENED"), V_DATE);
            END;
         END;

         IF (date(01,01,2017) <= DateOpen)
            DocKind = 32;
         END;

      ELIF (DocKind == 35)
           ФлагОбязСерии = "У";
           СерияДокумента = SQL_NVL(RS.Value("T_SERIES"),    V_STRING);   
      ELSE
           ФлагОбязСерии = "Н";
           СерияДокумента = "";
      END;   
      ДобавитьВБлок("Type",    string ( DocKind :2:0:o ), "S",   2, "О");

      IF (CheckDocumentFormat(DocKind, НомерДокумента, СерияДокумента, "Document","Number " , "Series ", ФлагОбязСерии, ФлагОбязНомер ) )
        ДобавитьВБлок("Series",   СерияДокумента  , "S",  20, ФлагОбязСерии);
        ДобавитьВБлок("Number",   НомерДокумента  , "S",  20, ФлагОбязНомер);
      END;
      
      ДобавитьВБлок("IssueDate",      SQL_NVL(RS.Value("T_ISSUEDATE"),        V_DATE), "D",   0, "У");
      ДобавитьВБлок("IssueAuthority", SQL_NVL(RS.Value("T_ISSUEAUTHORITY"), V_STRING), "S", 510, "У");
      ДобавитьВБлок("IssuePlace",     SQL_NVL(RS.Value("T_ISSUEPLACE"),     V_STRING), "S", 510, "У");
      ВставитьСложныйБлок();

      // Длина кода должна быть не менее 4 символов и не более 15 символов
      IF ((SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 98) AND 
         (((StrLen(SQL_NVL(RS.Value("T_NUMBER"), V_STRING)) < 4) OR (StrLen(SQL_NVL(RS.Value("T_NUMBER"), V_STRING)) > 15))))
         InsErrorMessage("Код субъекта КИ не соответствует формату");//#166525 
      END;

   
      IF ((TypeClient == PTLEGF_PERSN) OR (TypeClient == PTLEGF_PBUL))
         IF ((SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) >= 1) AND
             (SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) <= 27))
            fFiz  = 1;
         END;

         IF (SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 33)
            fPbul = 1;
         END;

         IF ((Born > SQL_NVL(RS.Value("T_ISSUEDATE"), V_DATE)) AND (SQL_NVL(RS.Value("T_ISSUEDATE"), V_DATE) > date(0,0,0)))
            InsErrorMessage("Неверное значение обязательного поля");
      END;
      ELSE
         IF (Client_NotResident)
            if ((ExpNBKI == "Да") OR (ExpAllBki == "Да") OR (ExpEQIFAX == "3.0")or(ExpEQIFAX == "2.0"))
                 IF ((SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 35) AND (SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 82))
                    fUr  = fUr + 1;  
                 END;
            ELSE
                fUr = 2;  
            END; 
            
            IF ((ExpAllBki == "Да") OR ( ExpEXPERIAN == "ДА"))
                 IF ((SQL_NVL(RS.Value("T_TYPE"), V_INTEGER ) == 84) )
                    fUr_84  =  1;  
                 END;                
            else 
                fUr_84 = 1;
            END;
            
         ELSE
             fUr_84 = 1 ;
             IF ((SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 34) AND (SQL_NVL(RS.Value("T_TYPE"), V_INTEGER) == 81))
                fUr  = fUr + 1;   
             END;
         END;
      END;

      STAT = rs.MoveNext();
   END;

   ВставитьСложныйБлок();

   IF ((fPbul == 0) AND (TypeClient == PTLEGF_PBUL))
      InsErrorMessage("Сегмент Document. Отсутствуют данные о регистрации ПБЮЛ");
   END;

   IF (((TypeClient == PTLEGF_PERSN) OR
        (TypeClient == PTLEGF_PBUL)) AND
       (fFiz == 0)) 
      InsErrorMessage("Для физ. лица должны быть заданы документы удостоверяющие личность!");
   END;

   IF ((fUr != 2) AND (TypeClient == PTLEGF_INST) AND (fUr_84 != 1))
      InsErrorMessage("Сегмент Document. Отсутствуют документы юр. лица");
   END;
END;

// 12.2.4   Address - данные адреса
MACRO СформироватьСегмент_Address(PartyID: integer, ObjectType: integer, ObjectNumber: integer, SendKind: integer)
   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Address(?, ?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("PartyID",      RSDBP_IN); RSDcmd.value("PartyID")      = PartyID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectType;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT * FROM DLBKI_401_TMP l401 WHERE " + 
                              " l401.T_PARTYID_REF = ? " +
                          " AND l401.T_OBJECTTYPEID = ? " +
                          " AND l401.T_OBJECTNUMBER = ? " +
                          " AND l401.T_TFID_REF = ?",
                        "p1", PartyID,
                        "p2", ObjectType,
                        "p3", ObjectNumber,
                        "p4", 0,
                         V_GENOBJ);
   VAR CNT : INTEGER = 2;

   VAR STAT = RS.MoveNext();

   // В режиме выгрузки изменений записей может не быть
   IF ((NOT STAT) AND (SendKind == REQUEST_CHNG))
      RETURN;
   END;

   IF (NOT STAT)
      IF ((
           (TypeClient == PTLEGF_PERSN) 
            OR 
           (TypeClient == PTLEGF_PBUL)
          ) AND (CNT != 0))
         InsErrorMessage("Для физ. лица должны быть заданы юридический и физический адреса!");
      END;
   
      IF ((TypeClient == PTLEGF_INST) AND (CNT == 2))
         InsErrorMessage("Для юр. лица должен быть задан юридический адрес!");
      END;

      RETURN;
   END;

   НачатьСложныйБлок("Addresses");
   WHILE (STAT)
      НачатьСложныйБлок("Address");

      var street_tmp: string = SQL_NVL(RS.Value("T_Street"), V_STRING);
      IF ((StrLen(Trim(street_tmp)) == 0) OR
          (Trim(street_tmp) == StrFor(1)))
         street_tmp = SQL_NVL(RS.Value("T_Location"), V_STRING);   
      END;

      var region_tmp: string = SQL_NVL(RS.Value("T_Region"), V_STRING);
      IF (RS_KLADR == "X")
         region_tmp = CRSDCommand("SELECT "+
                    " CASE WHEN NVL(TRIM(ADR.T_REGIONNUM), CHR(1)) = CHR(1) THEN "+
                    " ( "+
                    "  SELECT SUBSTR(kf.T_REGIONCODE, 1, 2)  "+
                    "    FROM DAS_ADDROBJ_DBT kf WHERE "+
                    "         kf.T_SHORTNAME  = RPAD(adr.T_CODEREGION, LENGTH(kf.T_SHORTNAME), ' ') "+
                    "     AND kf.T_FORMALNAME = RPAD(adr.T_REGION,     LENGTH(kf.T_FORMALNAME),' ') "+
                    "     AND ROWNUM = 1 "+
                    " ) "+
                    "  ELSE "+
                    "  NVL(TRIM(ADR.T_REGIONNUM), CHR(1)) "+
                    "  END  "+
                    " FROM DADRESS_DBT adr WHERE "+
                    "      adr.T_PARTYID = ? "+
                    "  AND adr.T_TYPE    = ?",
                      "PARTYID", PartyID,
                      "TYPE",    SQL_NVL(RS.Value("T_TYPEADRESS"), V_INTEGER),  
                       V_STRING);      
      END;

      var typeadress_tmp: string = string(SQL_NVL(RS.Value("T_TYPEADRESS"), V_INTEGER));
      // ЮРИДИЧЕСКИЙ
      IF (SQL_NVL(RS.Value("T_TYPEADRESS"), V_INTEGER) == 1)
         IF (TypeClient != PTLEGF_INST)
            typeadress_tmp = 1; // Адрес регистрации
         ELIF (TypeClient == PTLEGF_INST)
            typeadress_tmp = 3; // Юридический
         END;
      // ФАКТИЧЕСКИЙ
      ELIF (SQL_NVL(RS.Value("T_TYPEADRESS"), V_INTEGER) == 2)
         IF   (TypeClient != PTLEGF_INST)
            typeadress_tmp = 2; // Фактический
         ELIF (TypeClient == PTLEGF_INST)
            typeadress_tmp = 4; // Для Юридического лица
         END;
      END;

      ДобавитьВБлок("Type",        typeadress_tmp,                               "A",   1, "О");
      ДобавитьВБлок("Location",    SQL_NVL(RS.Value("T_Location"),    V_STRING), "S", 255, "У");
      ДобавитьВБлок("Street",      street_tmp,                                   "S", 255, "Н");
      ДобавитьВБлок("PostalCode",  SQL_NVL(RS.Value("T_PostalCode"),  V_STRING), "S",   6, "Н");
      ДобавитьВБлок("Country",     SQL_NVL(RS.Value("T_Country"),     V_STRING), "S",   2, "Н");
      ДобавитьВБлок("Region",      region_tmp,                                   "A",   2, "Н");
      ДобавитьВБлок("District",    SQL_NVL(RS.Value("T_District"),    V_STRING), "S",  80, "Н");
      ДобавитьВБлок("StreetType",  SQL_NVL(RS.Value("T_StreetType"),  V_STRING), "A",   2, "Н");
      ДобавитьВБлок("HouseNumber", SQL_NVL(RS.Value("T_HouseNumber"), V_STRING), "S",  40, "Н");
      ДобавитьВБлок("Block",       SQL_NVL(RS.Value("T_Block"),       V_STRING), "S",  10, "Н");
      ДобавитьВБлок("Apartment",   SQL_NVL(RS.Value("T_Apartment"),   V_STRING), "S",  40, "Н");

      ВставитьСложныйБлок();

      IF(
         (
          (TypeClient == PTLEGF_PERSN) 
          OR 
          (TypeClient == PTLEGF_PBUL)
         )
         AND 
         (
          (SQL_NVL(RS.Value("T_TYPEADRESS"),V_INTEGER) == 1)
          OR
          (SQL_NVL(RS.Value("T_TYPEADRESS"),V_INTEGER) == 2)
         )
        )
         CNT = CNT - 1;
      END;

      IF (TypeClient == PTLEGF_INST) 
         CNT = 0;
      END;

      STAT = RS.MoveNext();
   END;
   ВставитьСложныйБлок();

   IF ((
        (TypeClient == PTLEGF_PERSN) 
         OR 
        (TypeClient == PTLEGF_PBUL)
       ) AND (CNT != 0))
      InsErrorMessage("Для физ. лица должны быть заданы юридический и физический адреса!");
   END;

   IF ((TypeClient == PTLEGF_INST) AND (CNT == 2))
      InsErrorMessage("Для юр. лица должен быть задан юридический адрес!");
   END;
END;

// 12.2.1   Person - титульные данные физического лица
MACRO СформироватьСегмент_Person(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Person(?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectTypeID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;
   
   VAR RS = CRSDCommand("SELECT * FROM DLBKI_201_TMP lbki201 WHERE " + 
                              " lbki201.T_OBJECTTYPEID = ? " +
                          " AND lbki201.T_OBJECTNUMBER = ? " +
                          " AND lbki201.T_TFID_REF = ? " +
                          " AND lbki201.T_PARTYID_REF = ? " +
                          " ORDER BY lbki201.T_OTHERDEBTORNUM", 
                            "p1", ObjectTypeID,
                            "p2", ObjectNumber,
                            "p3", 0,
                            "p4", ClientID,
                             V_GENOBJ);

   VAR STAT = RS.MoveNext();

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("Person");
  
   // Наличие блока InfoPart по заявке
   VAR InfoPart = 0;
   IF (ObjectTypeID == LO_CLAIM)
      InfoPart = CRSDCommand("SELECT 1 FROM DCRE_INFOPART_TMP WHERE T_CLAIMID = ? ",
                             "p1", ObjectNumber,
                             V_INTEGER);
   END;     

   IF (STAT)
      // Игнорируется, если передается InfoPart.
      IF (InfoPart == 0)
         ДобавитьВБлок("ReferenceCode", string(SQL_NVL(RS.Value("T_PARTYID_REF"), V_INTEGER)),  "S", 32, "О");
         ДобавитьВБлок("ApplicantCode", "",  "S", 32, "Н"); 
      ELSE
         ДобавитьВБлок("ApplicantCode", string(SQL_NVL(RS.Value("T_PARTYID_REF"), V_INTEGER)),  "S", 32, "О");
      END;

      ДобавитьВБлок("LastName",      SQL_NVL(RS.Value("T_Name1"),                V_STRING),  "S",  640, "О");
      ДобавитьВБлок("FirstName",     SQL_NVL(RS.Value("T_Name2"),                V_STRING),  "S",  640, "О");
      ДобавитьВБлок("MiddleName",    SQL_NVL(RS.Value("T_Name3"),                V_STRING),  "S",  640, "Н");
      ДобавитьВБлок("BirthDate",     SQL_NVL(RS.Value("T_Born"),                   V_DATE),  "D",  0,   "О");

      IF ((TypeClient != PTLEGF_INST) AND (SQL_NVL(RS.Value("T_Born"), V_DATE) > DATE(0, 0, 0)))
         VAR RS_Year = 
         CRSDCommand("SELECT TRUNC(MONTHS_BETWEEN(RSO_LNS_CRE.GETSTARTDATE(?, ?), ?) / 12) " +
                     " FROM DUAL",
                 "p1", ObjectTypeID,
                 "p2", ObjectNumber,
                 "p3", SQL_NVL(RS.Value("T_Born"), V_DATE),
                 V_GENOBJ);

         IF (RS_Year AND RS_Year.MoveNext() AND (ValType(RS_Year.Value(0)) != V_SPECVAL))
            VAR Year = SQL_NVL(RS_Year.Value(0), V_INTEGER);

            IF (
                (Year < 14) 
                OR
                (Year > 110)
               )
               InsErrorMessage("Неверное значение обязательного поля");
            END;
         END;
      END;

      ДобавитьВБлок("BirthPlace",    SQL_NVL(RS.Value("T_BIRSPLACE"), V_STRING),  "S", 1020, "О");
      ДобавитьВБлок("Gender", string(SQL_NVL(RS.Value("T_GENDER"),     V_INTEGER)), "A",  2, "Н");
      ДобавитьВБлок("Citizenship",   SQL_NVL(RS.Value("T_NATIONALITY"),       V_STRING),  "S",  2, 
                                                                  mandatory(ExpEXPERIAN == "ДА"));

      IF (SQL_NVL(RS.Value("T_Remarks"),     V_INTEGER) == 1)
         ДобавитьВБлок("Remarks",    1,                                             "A",  1, "Н");
      ELSE                                                                          
         ДобавитьВБлок("Remarks",    "",                                            "A",  1, "Н");
      END;
      ДобавитьВБлок("INN",           SQL_NVL(RS.Value("T_INN"),         V_STRING),  "S", 12, "Н");

      ДобавитьВБлок("sourceCode",    0,                                             "S", 32, "Н");
      ДобавитьВБлок("GroupCode",    "0",                                            "S", 32, "Н");

      СформироватьСегмент_Document  (RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Address   (RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Phone     (RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);

      IF (InfoPart == 0)
         СформироватьСегмент_Employment(RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);
      END;
   END;
   
   IF (InfoPart == 0)
      СформироватьСегмент_Trade(ObjectTypeID, ObjectNumber, SendKind);
      
      СформироватьСегмент_Legal     (ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Official  (ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Bankruptcy(ClientID, ObjectTypeID, ObjectNumber, SendKind);
   ELSE
      СформироватьСегмент_InfoPart  (ObjectTypeID, ObjectNumber, SendKind);
   END;

   ВставитьСложныйБлок();
END;

// 12.2.2   Business - титульные данные юридического лица
MACRO СформироватьСегмент_Business(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)

   // Режим изменений, а были ли ?
   IF (SendKind == REQUEST_CHNG)
      VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.Changes_Business(?, ?, ?); END;"); 
      RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
      RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectTypeID;
      RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
      RSDcmd.execute();
      RSDcmd.Close();
   END;

   VAR RS = CRSDCommand("SELECT * FROM DLBKI_301_TMP l301, DLBKI_302_TMP l302 WHERE " + 
                              " l301.T_OBJECTTYPEID = ? AND l301.T_OBJECTNUMBER = ? AND l301.T_TFID_REF = ? " +
                          " AND l302.T_OBJECTTYPEID = ? AND l302.T_OBJECTNUMBER = ? AND l302.T_TFID_REF = ? " +
                          " AND l301.T_PARTYID_REF = l302.T_PARTYID_REF " +
                          " AND l301.T_PARTYID_REF = ? AND l302.T_PARTYID_REF = ?" +
                          " ORDER BY l301.T_OTHERDEBTORNUM",
                        "p1", ObjectTypeID,
                        "p2", ObjectNumber,
                        "p3", 0,
                        "p4", ObjectTypeID,
                        "p5", ObjectNumber,
                        "p6", 0,
                        "p7", ClientID,
                        "p8", ClientID,
                         V_GENOBJ);

   VAR STAT = RS.MoveNext();

   IF (NOT STAT)
      RETURN;
   END;

   НачатьСложныйБлок("Business");

   var OldName       :string = "";
   var OldOKPO       :string = "";
   var OldOKATO      :string = "";
   var OldKPP        :string = "";
   var OldShortName  :string = "";     
    
   // Получим данные из предыдущей выгрузки
   VAR PrevValue = CRsdCommand ("SELECT LBKI_301.T_FULLNAME, LBKI_301.T_SHORTNAME, LBKI_302.T_OKPO, LBKI_302.T_OKATO, LBKI_302.T_KPP  " +
                               "  FROM DLBKI_301_dbt LBKI_301, DLBKI_302_dbt LBKI_302 " +
                               " WHERE LBKI_301.T_TFID_REF = LBKI_302.T_TFID_REF " +
                               "   AND LBKI_301.T_CREDITNUMBER_REF = LBKI_302.T_CREDITNUMBER_REF " +
                               "   AND LBKI_301.T_CREDITNUMBER_REF = ? " +
                               "   AND LBKI_301.T_PARTYID_REF = LBKI_302.T_PARTYID_REF " +
                               "   AND LBKI_301.T_PARTYID_REF = ? AND LBKI_302.T_PARTYID_REF = ?" +
                               "   AND LBKI_301.T_TFID_REF = (SELECT MAX(DEVBKI.T_TFID_REF) FROM dldevbki_dbt devbki " + 
                               "                              WHERE DEVBKI.T_OBJECTTYPEID = ?  AND DEVBKI.T_OBJECTNUMBER = ? AND DEVBKI.T_BKIID_REF = ? " + 
                               "                              AND DEVBKI.T_TFID_REF != ?" +
                               "                              AND DEVBKI.T_SENDDATE IN ( " + 
                               "                                                        SELECT MAX(BKI.T_SENDDATE )  FROM dldevbki_dbt bki " + 
                               "                                                        WHERE BKI.T_OBJECTTYPEID = ?  AND BKI.T_OBJECTNUMBER = ? AND BKI.T_BKIID_REF = ? " + 
                               "                                                        AND BKI.T_SENDDATE <= ?) " + 
                               "                              ) ",                                         
                               "p1", ObjectNumber,
                               "p2", ClientID,
                               "p3", ClientID,
                               "p4", ObjectTypeID,
                               "p5", ObjectNumber,  
                               "p6", lbki.rec.BKIID,      // текущее значение для данной выгрузки
                               "p7", ltr_file.rec.TFID,   // текущее значение для данной выгрузки
                               "p8", ObjectTypeID,
                               "p9", ObjectNumber,
                               "p10",lbki.rec.BKIID,
                               "p11",{curdate},                               
                                V_GENOBJ);
       
   IF (PrevValue.MoveNext()) 
      IF (PrevValue.Value("T_FULLNAME") != RS.Value("T_FULLNAME"))
        OldName = PrevValue.Value("T_FULLNAME");
      END; 
      
      IF(PrevValue.Value("T_SHORTNAME") != RS.Value("T_SHORTNAME"))
        OldShortName = PrevValue.Value("T_SHORTNAME");
      END;
      
      IF(PrevValue.Value("T_OKPO") != RS.Value("T_OKPO"))
        OldOKPO = PrevValue.Value("T_OKPO");
      END;
      
      IF(PrevValue.Value("T_OKATO") != RS.Value("T_OKATO"))
        OldOKATO = PrevValue.Value("T_OKATO");
      END;
      
      IF(PrevValue.Value("T_KPP") != RS.Value("T_KPP"))
        OldKPP = PrevValue.Value("T_KPP");
      END;        
   END;    

   IF (STAT)
      ДобавитьВБлок("ReferenceCode", string(SQL_NVL(RS.Value("T_PARTYID_REF"),V_INTEGER)), "S",  32, "О"); //301
      ДобавитьВБлок("Name",               SQL_NVL(RS.Value("T_FULLNAME"),       V_STRING), "S", 170, "О"); //301

      ДобавитьВБлок("RegistrationNumber", SQL_NVL(RS.Value("T_OGRN"),           V_STRING), "S",  13, "О"); //302
      ДобавитьВБлок("RegistrationDate",   SQL_NVL(RS.Value("T_REGISTRATIONDATE"), V_DATE), "D",   0, "Н"); //302
      var INN_str: string = SQL_NVL(RS.Value("T_INN"),            V_STRING );
      IF (ExpEQIFAX == "3.0")
         ДобавитьВБлок("RegistrationPlace",  SQL_NVL(RS.Value("T_OGRNPLACE"),   V_STRING), "S",  80, mandatory(INN_str!=""));
      END;

      ДобавитьВБлок("INN",                INN_str, "S",  10, "О"); //302

      IF (ExpEQIFAX == "3.0")
        ДобавитьВБлок("INNDate",          SQL_NVL(RS.Value("T_REGDATE"),          V_DATE), "D",   0, mandatory(INN_str!=""));
        ДобавитьВБлок("INNPlace",         SQL_NVL(RS.Value("T_INNPLACE"),       V_STRING), "S", 160, mandatory(INN_str!=""));
      END;

      ДобавитьВБлок("Status",             0,                                               "A",   2, "Н");
      ДобавитьВБлок("OKPO",               SQL_NVL(RS.Value("T_OKPO"),           V_STRING), "S",  10, "Н"); //302
      ДобавитьВБлок("OKONH",              SQL_NVL(RS.Value("T_OKONH"),          V_STRING), "S",   5, "Н"); //302
      ДобавитьВБлок("OKVED",              SQL_NVL(RS.Value("T_OKVED"),          V_STRING), "S",   8, "Н"); //302
      ДобавитьВБлок("OKATO",              SQL_NVL(RS.Value("T_OKATO"),          V_STRING), "S",  11, "Н"); //302
      ДобавитьВБлок("OKFS",               SQL_NVL(RS.Value("T_OKFS"),           V_STRING), "S",   2, "Н"); //302
      ДобавитьВБлок("OKOPF",              SQL_NVL(RS.Value("T_OKOPF"),          V_STRING), "S",   2, "Н"); //302
      ДобавитьВБлок("KPP",                SQL_NVL(RS.Value("T_KPP"),            V_STRING), "S",   9, "Н"); //302
      ДобавитьВБлок("ShortName",          SQL_NVL(RS.Value("T_SHORTNAME"),      V_STRING), "S", 170, 
                                                                          mandatory(ExpEXPERIAN == "ДА")); //301
      ДобавитьВБлок("OldName",            SQL_NVL(OldName,                      V_STRING), "S", 170, "Н");
      ДобавитьВБлок("OldOKPO",            SQL_NVL(OldOKPO,                      V_STRING), "S",  10, "Н");
      ДобавитьВБлок("OldOKATO",           SQL_NVL(OldOKATO,                     V_STRING), "S",  11, "Н");
      ДобавитьВБлок("OldKPP",             SQL_NVL(OldKPP,                       V_STRING), "S",   9, "Н");
      ДобавитьВБлок("OldShortName",       SQL_NVL(OldShortName,                 V_STRING), "S", 170, "Н");
      ДобавитьВБлок("FirmName",           0,                                               "S",  32, "Н");      
      ДобавитьВБлок("LocalLanguageName",  0,                                               "S",  32, "Н");      
      ДобавитьВБлок("ForeignLanguageName",0,                                               "S",  32, "Н");

      IF (ExpEQIFAX == "2.0")
         ДобавитьВБлок("Resident",  string(SQL_NVL(RS.Value("T_NOTRESIDENT"),   V_STRING)), "A",   1, "У");
         ДобавитьВБлок("CountryReg",       SQL_NVL(RS.Value("T_COUNTRYREG"),     V_STRING), "S",   2, "У");
      END;

      ДобавитьВБлок("sourceCode",         0,                                               "S",  32, "Н");
      ДобавитьВБлок("GroupCode",         "0",                                              "S",  32, "Н");

      СформироватьСегмент_Document(RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Address (RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Phone   (RS.Value("T_PARTYID_REF"), ObjectTypeID, ObjectNumber, SendKind);
   END;
   СформироватьСегмент_Trade(ObjectTypeID, ObjectNumber, SendKind);
   СформироватьСегмент_Legal(ObjectTypeID, ObjectNumber, SendKind);
   СформироватьСегмент_Official(ObjectTypeID, ObjectNumber, SendKind);
   СформироватьСегмент_Bankruptcy(ClientID, ObjectTypeID, ObjectNumber, SendKind);

   ВставитьСложныйБлок();
END;

MACRO СформироватьСегмент_Update(ObjectTypeID: integer, ObjectNumber: integer, ClientID: integer, SendKind: integer)
   VAR RSDcmd = RsdCommand(RslDefCon, "BEGIN ? := RSO_LNS_CRE.Changes_Update(?, ?, ?, ?); END;"); 
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("BkiID",        RSDBP_IN); RSDcmd.value("BkiID")        = lbki.rec.BKIID;
   RSDcmd.addParam("PartyID",      RSDBP_IN); RSDcmd.value("PartyID")      = ClientID;
   RSDcmd.addParam("ObjectType",   RSDBP_IN); RSDcmd.value("ObjectType")   = ObjectTypeID;
   RSDcmd.addParam("ObjectNumber", RSDBP_IN); RSDcmd.value("ObjectNumber") = ObjectNumber;
   RSDcmd.execute();
   IF (RSDcmd.value(0) == 0)
      LoansError     ("КИ не изменилась!");
      InsErrorMessage("КИ не изменилась!");
      RETURN;
   END;
   
   НачатьСложныйБлок("Update");

   // 13.7  Загрузка информации о заявках и принятых по ним решениях
   // 5) При выполнении обновления (режим Update) по заявке внутри элемента Update должен содержаться только один элемент InfoPart: 
   // указание ReferenceCode, ApplicantCode, Documents, Addresses, Phones, Employments, Trades, Legals, Bankruptcies, BankGuarantees запрещено. 
   // Ключевым полем по заявке для её поиска и обновления в БД CRE выступает ApplicationNumber (также см. п.12.1.4).
   IF (ObjectTypeID == LO_CLAIM)
      СформироватьСегмент_InfoPart  (ObjectTypeID, ObjectNumber, SendKind);
   ELSE
      ДобавитьВБлок("ReferenceCode", string(ClientID), "S",  32, "О"); //301
      СформироватьСегмент_Document  (ClientID, ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Address   (ClientID, ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Phone     (ClientID, ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Employment(ClientID, ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Trade     (ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Legal     (ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Official  (ObjectTypeID, ObjectNumber, SendKind);
      СформироватьСегмент_Bankruptcy(ClientID, ObjectTypeID, ObjectNumber, SendKind);
   END;
   ВставитьСложныйБлок();

   RSDcmd.Close();
END;

MACRO СформироватьСегмент_InfoDelete(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)

   VAR ClaimNumber = LnSelectValue("SELECT T_CLAIMNUMBER FROM DCLAIM_DBT WHERE T_CLAIMID = " + ObjectNumber, 
                                    V_STRING);
   
   НачатьСложныйБлок("InfoParts");
   
      НачатьСложныйБлок("InfoPart");

      ДобавитьВБлок("MemberCode",        SQL_NVL(lbki.rec.SourceID, V_STRING), "S", 12, "О");
      ДобавитьВБлок("ApplicationNumber", ClaimNumber,                          "S", 30, "О");

      ВставитьСложныйБлок();

   ВставитьСложныйБлок();
END;

MACRO СформироватьСегмент_TradeDelete(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)
   НачатьСложныйБлок("Trades");

      НачатьСложныйБлок("Trade");

      ДобавитьВБлок("MemberCode", SQL_NVL(lbki.rec.SourceID, V_STRING), "S", 12, "О");

      IF (ObjectTypeID == LO_ENSCONTR)

      ELSE
         ДобавитьВБлок("Account", credit_c.rec.UsCreditNumber, "S", 35, "О");         

      END;

      ВставитьСложныйБлок();

   ВставитьСложныйБлок();
END;

// 13.1.1   Delete - удаление 
MACRO СформироватьСегмент_Delete(ObjectTypeID: integer, ObjectNumber: integer, SendKind: integer)

   НачатьСложныйБлок("Delete");
  
   // Игнорируется, если передается InfoPart.
   IF (SendDel == 1)
      ДобавитьВБлок("ReferenceCode", string(ClientID),  "S", 32, "О");
   ELSE
      ДобавитьВБлок("AllConvenientSubjects", "1", "S", 1, "О");
   END;

   IF (ObjectTypeID == LO_CLAIM)
      СформироватьСегмент_InfoDelete(ObjectTypeID, ObjectNumber, SendKind);
   ELSE
      СформироватьСегмент_TradeDelete(ObjectTypeID, ObjectNumber, SendKind);
   END;

   ВставитьСложныйБлок();
END;


// TFID     - ID ТФ. Заполняется в пакетном режиме
// OrderNum - номер пачки
MACRO СформироватьXMLФайл(FileName, TFID: integer, SendKind: integer)
   VAR RS = NULL, cnt = 0, cnt_OBJECT_BKI = 0; 
   var path = "", srvFile = "", name = "", ext = "";

   // 202. CRE. Разрешен экспорт в НБКИ
   ExpNBKI = Trim(GetUsFieldValue(30, lbki.rec.BkiID, 202, {curdate}));   

   // 203. CRE. Разрешен экспорт в Эквифакс
   ExpEQIFAX = Trim(GetUsFieldValue(30, lbki.rec.BkiID, 203, {curdate}));
   
   // 204. CRE. Разрешен экспорт в Экспериан
   ExpEXPERIAN = StrUpr(Trim(GetUsFieldValue(30, lbki.rec.BkiID, 204, {curdate})));

   //211 CRE. Разрешен экспорт во все БКИ
   ExpAllBki = Trim(GetUsFieldValue(30, lbki.rec.BkiID, 211, {curdate}));
   

   xml = ActiveX( "MSXML.DOMDocument" );
   xml.loadXML("");
   xml.appendChild(xml.createProcessingInstruction("xml", " version='1.0' encoding='windows-1251'"));
   root = xml.createElement("ImportCreditRegistry");
   root.setAttribute("xmlns", "http://www.creditregistry.ru/schema/import");

   cnt = 0;
   cnt_OBJECT_BKI = LnSelectValue("SELECT COUNT(1) FROM V_OBJECT_BKI WHERE T_ORDERNUM = 0", V_INTEGER);
   IF ((cnt_OBJECT_BKI == 0) AND (SendKind == REQUEST_CHNG))
       LoansError     ("КИ не изменилась!");
       RS = CRSDCommand("SELECT T_CREDITNUMBER FROM DOBJECT_BKI_TMP WHERE T_OBJECTTYPEID NOT IN (3, 4) AND T_RESULT = 1 ORDER BY T_CREDITNUMBER",
                        V_GENOBJ);
       WHILE (RS.MoveNext())
          credit_c.rec.CreditNumber = RS.Value("T_CREDITNUMBER", V_INTEGER);
          credit_c.GetEQ();

          ClientID     = credit_c.rec.ClientID_REF;
          ObjectTypeID = credit_c.rec.Crd_Kind;
          ObjectNumber = credit_c.rec.CreditNumber;
          InsErrorMessage("КИ не изменилась!");
          END;        
   END;
   LoansPutIndic(cnt_OBJECT_BKI, "Формирование транспортного файла");

   RS = CRSDCommand("SELECT T_CREDITNUMBER, LO.T_PARTYID_REF, pt.T_LEGALFORM, pr.T_ISEMPLOYER " +
                    " FROM V_OBJECT_BKI bk " +
                    " JOIN DLOTHDEB_DBT lo ON (BK.T_OBJECTTYPEID = LO.T_OBJECTTYPEID_REF AND BK.T_OBJECTNUMBER = LO.T_OBJECTNUMBER_REF) " +
                    " JOIN DPARTY_DBT   pt ON (PT.T_PARTYID = LO.T_PARTYID_REF) " +
               " LEFT JOIN DPERSN_DBT   pr ON (PR.T_PERSONID = PT.T_PARTYID) " +
                   " WHERE T_OBJECTTYPEID NOT IN (3, 4) " +
                     " AND T_ORDERNUM = 0 AND Nvl(lo.T_ISDELETED, CHR(0)) <> 'X' ORDER BY T_CREDITNUMBER",
                    V_GENOBJ);
   WHILE (RS.MoveNext())
      credit_c.rec.CreditNumber = RS.Value("T_CREDITNUMBER", V_INTEGER);
      credit_c.GetEQ();

      ClientID     = RS.Value("T_PARTYID_REF", V_INTEGER);
      ObjectTypeID = credit_c.rec.Crd_Kind;
      ObjectNumber = credit_c.rec.CreditNumber;

      TypeClient = ТипКлиента(SQL_NVL(RS.Value("T_LEGALFORM"),  V_INTEGER),
                              SQL_NVL(RS.Value("T_ISEMPLOYER"), V_STRING));
       // Определим является ли клиент нерезидентом
      Client_NotResident = Нерезедент(ClientID); 


      IF (SendKind == REQUEST_DEL)
         СформироватьСегмент_Delete(ObjectTypeID, RS.Value("T_CREDITNUMBER", V_INTEGER), SendKind);

      ELSE
         СформироватьСегмент_Person  (ObjectTypeID, RS.Value("T_CREDITNUMBER", V_INTEGER), SendKind);
         СформироватьСегмент_Business(ObjectTypeID, RS.Value("T_CREDITNUMBER", V_INTEGER), SendKind);
      
         IF (SendKind == REQUEST_CHNG)
            СформироватьСегмент_Update  (ObjectTypeID, RS.Value("T_CREDITNUMBER", V_INTEGER), ClientID, SendKind);
         END;
      END;

      LoansUseIndic(cnt);
      cnt = cnt + 1;
   END;

   VAR RS_OBJ = CRSDCommand("SELECT LB.T_PARTYID, NVL2(PR.T_PERSONID, 2, 1) AS T_LEGALFORM, NVL(pr.T_ISEMPLOYER, CHR(0)) AS T_ISEMPLOYER, lb.T_OBJECTTYPEID, LB.T_OBJECTNUMBER " +
                             " FROM V_OBJECT_BKI lb LEFT JOIN DPERSN_DBT pr ON LB.T_PARTYID = PR.T_PERSONID " +
                             " WHERE T_OBJECTTYPEID IN (3, 4) AND T_ORDERNUM = 0 ORDER BY T_OBJECTTYPEID, T_OBJECTNUMBER",
                            V_GENOBJ);

   WHILE (RS_OBJ.MoveNext)
      ClientID     = RS_OBJ.Value("T_PARTYID");
      ObjectTypeID = RS_OBJ.Value("T_OBJECTTYPEID");
      ObjectNumber = RS_OBJ.Value("T_OBJECTNUMBER");

      TypeClient = ТипКлиента(SQL_NVL(RS_OBJ.Value("T_LEGALFORM"),  V_INTEGER),
                              SQL_NVL(RS_OBJ.Value("T_ISEMPLOYER"), V_STRING));
       // Определим является ли клиент нерезидентом
      Client_NotResident = Нерезедент(ClientID);                               

      IF (SendKind == REQUEST_DEL)
         СформироватьСегмент_Delete(ObjectTypeID, ObjectNumber, SendKind);

      ELSE
   
         СформироватьСегмент_Person  (ObjectTypeID, ObjectNumber, SendKind);
         СформироватьСегмент_Business(ObjectTypeID, ObjectNumber, SendKind);

         IF (SendKind == REQUEST_CHNG)
            СформироватьСегмент_Update  (ObjectTypeID, ObjectNumber, ClientID, SendKind);
         END;
      END;

      LoansUseIndic(cnt);
      cnt = cnt + 1;
   END;
   LoansRemIndic();

   xml.appendChild(root);
   //Если 3-звенка
   IF (not IsStandAlone())
      path = splitFile(FileName, name, ext);
      srvFile = GetTxtFileName(name);

      // Если в строке пути есть знак ":" или "\\", то это абсолютный путь  
      IF(Index(toAnsi(FileName), ":") OR Index(toAnsi(FileName), "\\\\"))
         ;
      ELSE
         srvFile = GetCurDir() + "\\" + srvFile;
      END;     
      
      // xml.Save(srvFile);
      xml.Save(FileName);

      copyFile(srvFile, "$" + FileName); // перенесем файл на клиент
      RemoveFile(srvFile); // удалим временный файл с сервера      
   ELSE
      xml.Save(FileName);
   END;
END;

////////////////////////////////////////////////////////////////////////////////
//
// ФОРМИРОВАНИЕ ВИРТУАЛЬНОЙ ИСТОРИИ
//
// ПАРАМЕТРЫ:
//   BkiID        - системный номер БКИ
//   CreditNumber - номер КД
//   TFID         - Ссылка на транспортный файл
MACRO СформироватьВиртуальнуюИсторию(BkiID: Integer, CrdNum: integer, SendKind: integer, TFID: integer, StartDate: date, cfAutoFindStartDate: string, ObjectTypeID: integer, ObjectNumber: integer)
   VAR RSDcmd;

   ltr_file.rec.TFID = TFID;

   IF ((REQUEST_CHNG != SendKind) AND (REQUEST_FULL != SendKind) AND (REQUEST_DEL != SendKind))
      LoansError("Данный вид передачи не предусмотрен!");
      RETURN FALSE;
   END;

   RSDcmd = RsdCommand(RslDefCon, "BEGIN RsbSessionData.m_curdate:= ?; END;");
   RSDcmd.addParam("cd", RSDBP_IN); RSDcmd.value("cd") = {curdate};
   RSDcmd.execute ();
   RSDcmd = NULL;

   BegAction(2000, "Идет отбор договоров...", TRUE);

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.fillcreditlist(?,?,?,?,?,?,?,?); end;");

   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);

   RSDcmd.addParam("bkiid",      RSDBP_IN); RSDcmd.value("bkiid")      = BkiID;
   RSDcmd.addParam("reportdate", RSDBP_IN); RSDcmd.value("reportdate") = ReportDate;
   RSDcmd.addParam("sendkind",   RSDBP_IN); RSDcmd.value("sendkind")   = SendKind;
   RSDcmd.addParam("legalform",  RSDBP_IN); RSDcmd.value("legalform")  = _LegalForm;
   RSDcmd.addParam("oper",       RSDBP_IN); RSDcmd.value("oper")       = OpOper;
   RSDcmd.addParam("TrFileID",   RSDBP_IN); RSDcmd.value("TrFileID")   = TFID;
   RSDcmd.addParam("ObjID",      RSDBP_IN); RSDcmd.value("ObjID")      = ObjectTypeID;
   RSDcmd.addParam("ObjN",       RSDBP_IN); RSDcmd.value("ObjN")       = ObjectNumber;
   RSDcmd.execute();

   RSDcmd = RsdCommand(RslDefCon, "BEGIN RSO_LNS_CRE.BkiID:= ?; RSO_LNS_CRE.SendKind:= ?; END;");
   RSDcmd.addParam("bkiid",      RSDBP_IN); RSDcmd.value("bkiid")      = BkiID;
   RSDcmd.addParam("sendkind",   RSDBP_IN); RSDcmd.value("sendkind")   = SendKind;
   RSDcmd.execute();

   IF (LnSelectValue("SELECT COUNT(1) FROM DOBJECT_BKI_TMP", V_INTEGER) == 0)
      EndAction();

      LoansError("Не отобранно ни одного договора!");
      RETURN FALSE;
   END;
   EndAction();


   IF (SendKind == REQUEST_DEL)
      RETURN TRUE;
   END;

   RSDcmd = null;
   InitProgress(13, "Идет формирование КИ. Ждите...", "Этапы формирования виртуальной КИ");

   // Данные по заемщикам 
   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_201(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (1);     

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.SegmentDocument(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (2);    

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_301(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (3);   

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_302(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID; 
   RSDcmd.execute();
   UseProgress (4);   

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_304(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID; 
   RSDcmd.execute();
   UseProgress (5);   
   
   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_401(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (6);   

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_406(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (7);   

   IF (CrdNum == 0)
      RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.SegmentTrade(?); end;");
      RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
      RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
      RSDcmd.execute();
   ELSE
      VAR CNT = CRSDCommand("SELECT COUNT(1) FROM DOBJECT_BKI_TMP WHERE T_OBJECTTYPEID NOT IN (3, 4)", V_INTEGER);
      LoansPutIndic(CNT, "Обработка договоров");

      VAR cmin = 1, cmax = 0, Step = 1000;

      WHILE (cmax <= CNT)
         cmax = cmin + Step;
      
         VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.SegmentTrade ( ?, ?, ? ); END; ");
         cmd.addParam( "retval", RSDBP_RETVAL, V_INTEGER );

         cmd.addParam("p1", RSDBP_IN); cmd.Value("p1") = BkiID;
         cmd.addParam("p2", RSDBP_IN); cmd.Value("p2") = cmin;
         cmd.addParam("p3", RSDBP_IN); cmd.Value("p3") = cmax;
         cmd.execute();

         cmin = cmin + Step + 1;

         LoansUseIndic(cmin);
      END;

      LoansRemIndic();
   END;

   UseProgress (8);

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.SegmentInfoPart(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (9); 

   RSDcmd = RsdCommand(RslDefCon, "begin RSO_LNS_CRE.Segment_TradeCollateral(?); end;");
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (10); 

   RSDcmd = RsdCommand(RslDefCon, "begin RSO_LNS_CRE.Segment_BankGuarantee(?); end;");
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (11); 

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.bki_block_412(?); end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam("bkiid",  RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.execute();
   UseProgress (12);  

   RSDcmd = RsdCommand(RslDefCon, "begin ? := RSO_LNS_CRE.updatecreditnumber; end;");
   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.execute();
   UseProgress (13);   

   RemProgress (13);

   RETURN TRUE;
onError
   EndAction();
   RemProgress (13);
   Loanserror("Ошибка формирования ТФ. Вызов функции 'СформироватьВиртуальнуюИсторию' завершился ошибкой.");
   RETURN FALSE;
END;

////////////////////////////////////////////////////////////////////////////////
//
// Функция вызывается из Сишника, при индивидуальной передаче информации
// Параметры:
//    TFID         - ID Транспортного файла
//    BkiID        - ID БКИ
//    CreditNumber - ID Договора
//    SendKind     - Вид передачи (2 - Полная    КИ)
//    Path         - Путь
//    FileName     - Имя файла
//                                
MACRO СформироватьТранспортныйФайл(
       TFID          : integer, 
       BkiID         : integer, 
       CreditNumber  : integer, 
       SendKind      : integer, 
       Path          : string, 
       FileName      : string, 
       StartDate     : date, 
       ObjectTypeID  : integer, 
       ObjectNumber  : integer,
       SendKindDel   : integer)
   VAR STAT: BOOL = TRUE, ID = 0, FLAG = 0, RS = NULL, MSG, RegDate = NULL, isCess:BOOL = FALSE;

   SendDel = SendKindDel;

   IF ((REQUEST_CHNG != SendKind) AND (REQUEST_FULL != SendKind) AND (REQUEST_DEL != SendKind))
      LoansError("Данный вид передачи не предусмотрен!");
      RETURN FALSE;
   END;

   Path = TRIM(Path) + "\\" + TRIM(FileName);

   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №" + BkiID);
      RETURN FALSE;
   END;

   ltr_file.rec.TFID = TFID;
   IF (NOT ltr_file.getEQ())
      LoansError("Не найден транспортный файл №" + TFID);
      RETURN FALSE;
   END;
   ReportDate = ltr_file.rec.ReportDate;
   
   IF (ObjectTypeID == LO_ENSCONTR)
      VAR RS_ENS = CRSDCommand("SELECT t.T_SYSTYPEENSID_REF, T_ENSCONTRACTFIRSTDATE FROM DENSCONTR_DBT e, DTYPE_ENS_DBT t WHERE " + 
                                         " E.T_ENSCONTRACTID = ? " + 
                                     " AND E.T_ENSSYSTYPE = t.T_TYPEENSID",
                                     "p1", ObjectNumber,
                                    V_GENOBJ);
      RS_ENS.MoveNext();
      
      IF (SQL_NVL(RS_ENS.Value("T_SYSTYPEENSID_REF"), V_INTEGER) != 1)
         LoansError("Формирование ТФ возможно только по договорам поручительства");
         RETURN FALSE;
      END;

      IF (SQL_NVL(RS_ENS.Value("T_ENSCONTRACTFIRSTDATE"), V_DATE) > ReportDate)
         LoansError("Дата начала ДО больше даты формирования КИ");
         RETURN FALSE;
      END;

      VAR IsGuar = CRSDCommand(
      "SELECT 1 FROM DENS_CRD_DBT ens, DCREDIT_C_DBT crd WHERE ENS.T_ENSCONTRACTID_REF = ? AND ENS.T_CREDITNUMBER_REF = CRD.T_CREDITNUMBER AND CRD.T_CRD_KIND = ?",
          "p1", ObjectNumber,
          "p2", LO_GUARANTEE,
              V_INTEGER);
      IF (IsGuar == 1)
         LoansError("Передача ДО по ДГ не предусмотрена форматом");
         RETURN FALSE;
      END;

      RegDate =  RS_ENS.Value("T_ENSCONTRACTFIRSTDATE");

   ELIF (ObjectTypeID == LO_CLAIM)
      VAR RS_CLM = CRSDCommand("SELECT clm.T_GIVINGDATE, PT.T_LEGALFORM, CLM.T_CLAIMKIND " +
                                " FROM DCLAIM_DBT clm JOIN DPARTY_DBT pt " +
                                " ON (CLM.T_LOANERID_REF = PT.T_PARTYID) " +
                                " WHERE clm.T_CLAIMID = ?",
                                "p1", ObjectNumber,
                               V_GENOBJ);
      RS_CLM.MoveNext();

      IF ((SQL_NVL(RS_CLM.Value("T_LEGALFORM"), V_INTEGER) != 2) 
           OR
          ((SQL_NVL(RS_CLM.Value("T_CLAIMKIND"), V_INTEGER) != 0) AND (SQL_NVL(RS_CLM.Value("T_CLAIMKIND"), V_INTEGER) != 2)))
         LoansError("Формирование ТФ возможно только по кредитным заявкам физических лиц!");
         RETURN FALSE;

      ELIF (SQL_NVL(RS_CLM.Value("T_GIVINGDATE"), V_DATE) > ReportDate)
         LoansError("Дата начала Заявки больше даты формирования КИ");
         RETURN FALSE;
      END;

      RegDate = RS_CLM.Value("T_GIVINGDATE");

   ELSE
      VAR RS_CRD = CRSDCommand("SELECT T_REGDATE FROM DCREDIT_C_DBT WHERE " + 
                                     " T_CREDITNUMBER = ? ",
                                 "p1", ObjectNumber,
                                     V_GENOBJ);
      RS_CRD.MoveNext();

      RegDate = RS_CRD.Value("T_REGDATE");
      IF (RegDate > ReportDate)
         LoansError("Дата начала Договора больше даты формирования КИ");
         RETURN FALSE;
      END;

   END;

   // Найдем последную запись о передаче КИ
   VAR RS_DEV = CRSDCommand(
   "SELECT * FROM DLDEVBKI_DBT WHERE " +
         " T_OBJECTTYPEID     = ? " +
     " AND T_OBJECTNUMBER     = ? " +
     " AND T_BKIID_REF        = ? " +
     " AND T_TFID_REF         = ? " +
     " AND T_SENDDATE         = ? ",
           "p1", ObjectTypeID,
           "p2", ObjectNumber,
           "p3", BkiID,
           "p4", TFID,
           "p5", ReportDate,
   V_GENOBJ);

   // Данные о передаче должны быть уже сохранены в БД
   IF (NOT RS_DEV.MoveNext())
      LoansError("Не найдена запись о передаче в БКИ! | Договор №" + CreditNumber + "| Дата " + ReportDate);
      RETURN FALSE;
   END;

   IF (RegDate == NULL)
       RETURN FALSE;
   END;

   IF ((RegDate < date(01,07,2014)) AND (ObjectTypeID != LO_ENSCONTR))

      IF (ObjectTypeID == LO_CLAIM)
         ID = CRSDCommand("SELECT MAX(T_ID) FROM DLCONSDEV_DBT WHERE T_CLAIMID_REF = ? AND T_CHANGEDATE <= ?",
                       "p1", ObjectNumber,
                       "p2", ReportDate,
                      V_INTEGER);
      ELSE
         ID = CRSDCommand("SELECT MAX(T_ID) FROM DLCONSDEV_DBT WHERE T_CREDITNUMBER_REF = ? AND T_CHANGEDATE <= ?",
                       "p1", CreditNumber,
                       "p2", ReportDate,
                      V_INTEGER);
      END;

      IF (ID > 0)
         // Флаг согласия на передачу КИ
         FLAG = CRSDCommand("SELECT T_FLAG FROM DLCONSDEV_DBT WHERE T_ID = ?",
                            "p1", ID,
                           V_STRING);

         IF ((Flag != "X") AND ((SendKind == REQUEST_CHNG) OR (SendKind == REQUEST_FULL)))
            LoansError("Нет согласия заемщика на передачу КИ");
            RETURN FALSE;
         END;
      ELSE
         IF ((SendKind == REQUEST_CHNG) OR (SendKind == REQUEST_FULL))
            LoansError("Нет согласия заемщика на передачу КИ");
            RETURN FALSE;
         END;
      END;
   END;

   IF (ObjectTypeID == LO_CREDIT)
      var countCess = 0; 
               countCess =  CRSDCommand("SELECT COUNT (*) FROM dcrdlink_dbt lnk WHERE LNK.T_TYPEPARENT = ? AND LNK.T_OBJECTTYPEID = ? AND LNK.T_OBJECTNUMBER = ?",
                     "p1", LO_DOGCREDCLAIMBUY,
                     "p2", LO_CREDIT,
                     "p3", CreditNumber,
                    V_INTEGER);
      IF (countCess >0)
         isCess = TRUE;
      ELSE
         isCess = FALSE;
      END;
   END;

   IF ((ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_ENSCONTR) OR (ObjectTypeID == LO_GUARANTEE) OR (ObjectTypeID == LO_CLAIM) OR ((ObjectTypeID == LO_CREDIT) AND (isCess)))
      IF (RegDate < date(01,03,2015))
         VAR VOBJ = CRSDCommand("SELECT T_SHORTNAME FROM DLOBJECT_DBT WHERE T_OBJECTID = ?",
                                "p1", ObjectTypeID,
                               V_STRING);
         IF (ObjectTypeID == LO_CREDIT)
            VOBJ = "КД, приобретенным по договору уступки";
         ELIF (ObjectTypeID == LO_CLAIM)
            VOBJ = "Заявкам";
         END;

         LoansError("Запрещена передача КИ по " + VOBJ + ", введенным до 01.03.2015");
         RETURN FALSE;
      END;
   END;

   IF (NOT СформироватьВиртуальнуюИсторию(BkiID, CreditNumber, SendKind, TFID, {curdate}, "", ObjectTypeID, ObjectNumber))
      LoansError("КИ не изменилась!");
      RETURN FALSE;
   END;

   СформироватьXMLФайл(Path, TFID, SendKind, 0);

   RETURN TRUE;
END;
            
////////////////////////////////////////////////////////////////////////////////
//
// Функция вызывается из Сишника, при пакетной передаче информации
// Параметры:
//    TFID         - ID Транспортного файла
//    BkiID        - ID БКИ
//    PartyID      - ID Заемщика
//    SendKind     - Вид передачи (2 - Полная    КИ)
//    Path         - Путь
//    FileName     - Имя файла
//
MACRO СформироватьТранспортныйФайл_ГрупповойРежим(TFID: integer, BkiID: Integer, SendKind: integer, Path: string, FileName: string, StartDate: date, bAutoDate)
   VAR change: bool = FALSE,
       stat  : bool = FALSE,
       count : integer = 0;

   IF ((REQUEST_CHNG != SendKind) AND (REQUEST_FULL != SendKind) AND (REQUEST_DEL != SendKind))
      LoansError("Данный вид передачи не предусмотрен!");
      RETURN FALSE;
   END;

   Path = TRIM(Path) + "\\" + TRIM(FileName);

   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №" + BkiID);
      RETURN FALSE;
   END;

   // Подчищаем перед формированием  
   LnSQLExec  ("DELETE FROM DNBKI_TMP");

   ltr_file.rec.TFID = TFID;
   IF (NOT ltr_file.getEQ())
      LoansError("Не найден транспортный файл №" + TFID);
      RETURN FALSE;
   END;
   ReportDate = ltr_file.rec.ReportDate;

   СформироватьXMLФайл(Path, TFID, SendKind);

   RETURN TRUE;
END;

MACRO ОбработкаКвитанции(Dir: string, FileName: string)

   LoansError("Просмотр ошибок выгрузки невозможен в связи с отсутствием квитанции из CRE");
   RETURN FALSE;
END;

RECORD lbki_rec    ("lbki.dbt");
// Шаблон имени из параметров БКИ
// ФОРМАТ: SSSSSSS
MACRO СформироватьИмяФайла(SendKind: INTEGER)

   VAR ИмяФайла : string  = lbki_rec.TemplateName,
       str_day  : string  = "00", str_mon  : string  = "00",
       str_hour : string  = "00", str_min  : string  = "00", str_sec  : string  = "00",
           day  : integer = 0, mon : integer = 0, year  : integer = 0,
          hour  : integer = 0, min : integer = 0, sec   : integer = 0;

   IF (Index(lbki_rec.TemplateName, "CRE") != 0)
      ИмяФайла = "CRE_";
   END;

   IF (Index(lbki_rec.TemplateName, "DDMMYYYY") != 0)
      DateSplit({curdate}, day, mon, year);

      StrSet(str_day, 3 - strlen(string(day)), string(day));
      StrSet(str_mon, 3 - strlen(string(mon)), string(mon));

      ИмяФайла = ИмяФайла + str_day + str_mon + string(year);
   END;

   IF (Trim(ИмяФайла) != "")
      ИмяФайла = ИмяФайла + "_";
   END;

   IF (Index(lbki_rec.TemplateName, "NN") != 0)
      var serialnum = CRSDCommand("SELECT COUNT (T_TFID) FROM dltr_file_dbt WHERE T_BKIID_REF = ? AND T_FILEDATE = ?", "p_bkiid", lbki_rec.BkiID, "p_date", {curdate}, V_INTEGER);
      ИмяФайла = ИмяФайла + serialnum;
   END;

   IF (Trim(ИмяФайла) != "")
      ИмяФайла = ИмяФайла + ".xml";
   END;

   RETURN ИмяФайла;
END;

MACRO ОтборОбъектовДляКонвейернойОбработки(_taskID:integer, _execID:integer, _conveyerID:integer, _packetSize:integer, _Params)
   
   const DoubleFirstHalf = true; //todo перенести параметр в интерфейс отбора
   
   CRSDCommand("DELETE FROM dset_tcr_tmp", V_GENOBJ);

   CRSDCommand("INSERT INTO dset_tcr_tmp (t_CreditTypeID_Ref,  t_CurCode, t_SetFlag)         " +
               "     SELECT               t_CreditTypeID,      t_CurCode, 'X'                " +
               "       FROM dtype_crd_dbt                                                    " +
               "      WHERE     t_CreditTypeID >= 1000                                       " +
               "            AND t_Crd_Kind     <> 28                                         " +
               "            AND T_CreditTypeID in (" + join (_Params.CreditKind, ",") + ") ", 
               V_GENOBJ);
  

   CRSDCommand("DELETE FROM dcredit_c_tmp", V_GENOBJ);

   CRSDCommand(" INSERT INTO dcredit_c_tmp (T_CREDITNUMBER, T_CREDITTYPEID_REF, T_FNCASH, T_CLIENTID_REF, T_CREDITSTATE, T_CREDITSUM, T_PAYTYPE, T_CURCODE, T_REGDATE, T_PAYMENTDATE, T_DURATION, T_RETURNDATE, T_USERFIELD1, T_USERFIELD2, T_FULLDURATION, T_GROUPNUM, T_USERTYPE, T_RISKGROUP, T_FLAGOB, T_ENSURE, T_TYPEDURATION, T_USCREDITNUMBER, T_PRIVILEGEFLAG, T_REPDATE, T_BEFOREDUTY, T_ACCOUNTKARTA, T_CRD_KIND, T_DUTYDAY, T_REPDAY, T_RETAILACCPAY_REF, T_RETAILACCDUTY_REF, T_FINECOND, T_LEGALFORM, T_BENEFICIARY, T_TERRITORIALSTRUCT, T_ACCEPTANCE, T_ACCEPTANCEDAY, T_TYPEREPDATE, T_SPECIFIC, T_ANNUIT, T_GENERALAGREEMENT_REF, T_GRACEPERIODDAY, T_GRACEPERIODTUNING, T_MININSTALLMENT, T_BRANCH, T_RETAILKARTA, T_TYPEDEBTOR, T_INDCLASSIFICATION, T_DEBTORGROUP_REF, T_SERVICELOAN ) " +
               "      SELECT                T_CREDITNUMBER, T_CREDITTYPEID_REF, T_FNCASH, T_CLIENTID_REF, T_CREDITSTATE, T_CREDITSUM, T_PAYTYPE, T_CURCODE, T_REGDATE, T_PAYMENTDATE, T_DURATION, T_RETURNDATE, T_USERFIELD1, T_USERFIELD2, T_FULLDURATION, T_GROUPNUM, T_USERTYPE, T_RISKGROUP, T_FLAGOB, T_ENSURE, T_TYPEDURATION, T_USCREDITNUMBER, T_PRIVILEGEFLAG, T_REPDATE, T_BEFOREDUTY, T_ACCOUNTKARTA, T_CRD_KIND, T_DUTYDAY, T_REPDAY, T_RETAILACCPAY_REF, T_RETAILACCDUTY_REF, T_FINECOND, T_LEGALFORM, T_BENEFICIARY, T_TERRITORIALSTRUCT, T_ACCEPTANCE, T_ACCEPTANCEDAY, T_TYPEREPDATE, T_SPECIFIC, T_ANNUIT, T_GENERALAGREEMENT_REF, T_GRACEPERIODDAY, T_GRACEPERIODTUNING, T_MININSTALLMENT, T_BRANCH, T_RETAILKARTA, T_TYPEDEBTOR, T_INDCLASSIFICATION, T_DEBTORGROUP_REF, T_SERVICELOAN   " +
               "        FROM dcredit_c_dbt c                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                " +
               "       WHERE t_crd_kind in (1,8,21,22)                                                  " +
               "         AND t_credittypeid_ref in (" + join (_Params.CreditKind, ",") + ")             " +
               "         AND t_creditstate not in ('Ч', 'Д')                                            ", 
               V_GENOBJ);            

   CRSDCommand("BEGIN RsbSessionData.m_curdate:= ?; END;", "cd", {curdate}, V_GENOBJ);

   RunStoredFunc("RSO_LNS_CRE.fillcreditlist", V_INTEGER, null, 
                  _Params.BkiID              ,     //bkiid          IN NUMBER,
                  _Params.RepDate            ,     //reportdate     IN DATE,
                  _Params.SendKind           ,     //sendkind       IN NUMBER,
                  _Params.LegalForm          ,     //legalform      IN NUMBER,
                  _Params.Oper               ,     //oper           IN NUMBER,
                  0                          ,     //tfid           IN NUMBER,
                  0                          ,     //ObjectTypeID   IN NUMBER,
                  0                                //ObjectNumber   IN NUMBER 
                  );

   IF (_packetSize == 0)
      _packetSize = CRSDCommand("SELECT T_MAXMESSAGE FROM DLBKI_DBT WHERE T_BKIID = :BkiID", "BkiID", _Params.BkiID, V_INTEGER);
   END;
                  
   CRSDCommand("INSERT INTO DCNVDOC_DBT                                                               " +
               "SELECT :taskID          taskid,                                                       " +
               "       :execID          execid,                                                       " +
               "       :ConvTypeID  convtypeid,                                                       " +
               "       floor((ROW_NUMBER () OVER (ORDER BY t_objectnumber) - 1)/:packsize) + 1 packid," +
               "       t_objecttypeid,                                                                " +
               "       t_objectnumber                                                                 " +
               "  FROM DOBJECT_BKI_TMP                                                                ",
               ":taskID"    , _taskID    ,
               ":execID"    , _execID    ,
               ":ConvTypeID", _conveyerID,
               ":packsize"  , _packetSize,
               V_GENOBJ);
                
   //сколько получилось пачек
   var pack_num = CRSDCommand("SELECT MAX(T_PACKID)              " + 
                              "  FROM DCNVDOC_DBT                " + 
                              " WHERE T_TASKID     = :taskid     " +
                              "   AND T_EXECID     = :execid     " +
                              "   AND T_CONVTYPEID = :convtypeid ",
                              ":taskID"    , _taskID    ,
                              ":execID"    , _execID    ,
                              ":ConvTypeID", _conveyerID,
                              V_INTEGER
                                  );
   
   //Удвоить количество объектов в первой половине пачек за счет последних
   IF (DoubleFirstHalf)
      //количество нитей
      VAR threads_num = CRSDCommand("SELECT T_THREADS                      " +
                                    "  FROM DCNVEXECOPR_DBT                " +
                                    " WHERE T_TASKID     = :taskid         " +
                                    "   AND T_EXECID     = :execid         " +
                                    "   AND T_CONVTYPEID = :convtypeid     ",
                                    ":taskID"    , _taskID    ,
                                    ":execID"    , _execID    ,
                                    ":ConvTypeID", _conveyerID,
                                    V_INTEGER
                                  );
                                  
      IF (pack_num > threads_num * 1.5) //пачек достаточно для того чтобы удвоить первую половину пачек
      
         pack_num = pack_num - int(threads_num/2);
      
         CRSDCommand("UPDATE DCNVDOC_DBT                             " +
                     "   SET T_PACKID     = T_PACKID - :remain_pack_num1 " +
                     " WHERE T_TASKID     = :taskid                  " +        
                     "   AND T_EXECID     = :execid                  " +
                     "   AND T_CONVTYPEID = :convtypeid              " +
                     "   AND T_PACKID > :remain_pack_num2            ",
                     ":remain_pack_num1"   , pack_num    ,
                     ":taskID"             , _taskID     ,
                     ":execID"             , _execID     ,
                     ":ConvTypeID"         , _conveyerID ,
                     ":remain_pack_num2"   , pack_num    ,
                     V_GENOBJ
                   );
                   
          //Суть такого действия в следующием. 
          //Выгрузку КИ условно можно поделить на два этапа - сбор КИ в БД и запись в файл.
          //Здесь мы удваиваем работу для первой половины нитей, так что когда она
          // доберется до этапа выгрузки в файл - вторая половина свою выгрузку уже должна закончить и начать сбор КИ в БД 
          // для следующих пачек. Таким образом нагрузка между сервером баз данных и файловой системой сервера приложений
          // будет распределена более равномерно
      END;
   END;
   
   RETURN pack_num;
END;

MACRO КонвейернаяОбработкаПачки(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
   FILE lbki2 ("lbki.dbt") key 0;
   CRSDCommand("DELETE FROM DSET_TCR_TMP", V_GENOBJ);

   CRSDCommand("INSERT INTO DSET_TCR_TMP (T_CREDITTYPEID_REF,  T_CURCODE, T_SETFLAG)         " +
               "     SELECT               T_CREDITTYPEID,      T_CURCODE, 'X'                " +
               "       FROM dtype_crd_dbt                                                    " +
               "      WHERE     t_CreditTypeID >= 1000                                       " +
               "            AND t_Crd_Kind     <> 28                                         " +
               "            AND T_CreditTypeID in (" + join (_Params.CreditKind, ",") + ") ", 
               V_GENOBJ);
  

   CRSDCommand("DELETE FROM dcredit_c_tmp", V_GENOBJ);

   CRSDCommand(" INSERT INTO dcredit_c_tmp (T_CREDITNUMBER, T_CREDITTYPEID_REF, T_FNCASH, T_CLIENTID_REF, T_CREDITSTATE, T_CREDITSUM, T_PAYTYPE, T_CURCODE, T_REGDATE, T_PAYMENTDATE, T_DURATION, T_RETURNDATE, T_USERFIELD1, T_USERFIELD2, T_FULLDURATION, T_GROUPNUM, T_USERTYPE, T_RISKGROUP, T_FLAGOB, T_ENSURE, T_TYPEDURATION, T_USCREDITNUMBER, T_PRIVILEGEFLAG, T_REPDATE, T_BEFOREDUTY, T_ACCOUNTKARTA, T_CRD_KIND, T_DUTYDAY, T_REPDAY, T_RETAILACCPAY_REF, T_RETAILACCDUTY_REF, T_FINECOND, T_LEGALFORM, T_BENEFICIARY, T_TERRITORIALSTRUCT, T_ACCEPTANCE, T_ACCEPTANCEDAY, T_TYPEREPDATE, T_SPECIFIC, T_ANNUIT, T_GENERALAGREEMENT_REF, T_GRACEPERIODDAY, T_GRACEPERIODTUNING, T_MININSTALLMENT, T_BRANCH, T_RETAILKARTA, T_TYPEDEBTOR, T_INDCLASSIFICATION, T_DEBTORGROUP_REF, T_SERVICELOAN ) " +
               "      SELECT                T_CREDITNUMBER, T_CREDITTYPEID_REF, T_FNCASH, T_CLIENTID_REF, T_CREDITSTATE, T_CREDITSUM, T_PAYTYPE, T_CURCODE, T_REGDATE, T_PAYMENTDATE, T_DURATION, T_RETURNDATE, T_USERFIELD1, T_USERFIELD2, T_FULLDURATION, T_GROUPNUM, T_USERTYPE, T_RISKGROUP, T_FLAGOB, T_ENSURE, T_TYPEDURATION, T_USCREDITNUMBER, T_PRIVILEGEFLAG, T_REPDATE, T_BEFOREDUTY, T_ACCOUNTKARTA, T_CRD_KIND, T_DUTYDAY, T_REPDAY, T_RETAILACCPAY_REF, T_RETAILACCDUTY_REF, T_FINECOND, T_LEGALFORM, T_BENEFICIARY, T_TERRITORIALSTRUCT, T_ACCEPTANCE, T_ACCEPTANCEDAY, T_TYPEREPDATE, T_SPECIFIC, T_ANNUIT, T_GENERALAGREEMENT_REF, T_GRACEPERIODDAY, T_GRACEPERIODTUNING, T_MININSTALLMENT, T_BRANCH, T_RETAILKARTA, T_TYPEDEBTOR, T_INDCLASSIFICATION, T_DEBTORGROUP_REF, T_SERVICELOAN   " +
               "        FROM dcredit_c_dbt c                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                " +
               "       WHERE t_crd_kind in (1,8,21,22)                                                  " +
               "         AND t_credittypeid_ref in (" + join (_Params.CreditKind, ",") + ")             " +
               "         AND t_creditstate not in ('Ч', 'Д')                                            ", 
               V_GENOBJ);            

   CRSDCommand("BEGIN RsbSessionData.m_curdate:= ?; END;", "cd", {curdate}, V_GENOBJ);

   RunStoredFunc("RSO_LNS_CRE.fillcreditlist", V_INTEGER, null, 
                  _Params.BkiID              ,     //bkiid          IN NUMBER,
                  _Params.RepDate            ,     //reportdate     IN DATE,
                  _Params.SendKind           ,     //sendkind       IN NUMBER,
                  _Params.LegalForm          ,     //legalform      IN NUMBER,
                  _Params.Oper               ,     //oper           IN NUMBER,
                  0                          ,     //tfid           IN NUMBER,
                  0                          ,     //ObjectTypeID   IN NUMBER,
                  0                          ,     //ObjectNumber   IN NUMBER,
                  _execID                    ,     //conv_execid    IN NUMBER DEFAULT 0
                  _taskID                    ,     //conv_taskid    IN NUMBER DEFAULT 0
                  _conveyerID                ,     //conv_typeid    IN NUMBER DEFAULT 0
                  _packetID                        //conv_packid    IN NUMBER DEFAULT 0
                  );
   
   CRsdCommand("BEGIN RSO_LNS_CRE.BkiID:= :bkiid; RSO_LNS_CRE.SendKind:= :sendkind; END;", "bkiid", _Params.BkiID, "sendkind", _Params.SendKind, V_GENOBJ);

   IF (LnSelectValue("select count(1) from dobject_bki_tmp", V_INTEGER) == 0)
      RunError("В пачке нет ни одного объекта");
   END;

   RunStoredFunc("RSO_LNS_CRE.bki_block_201"  , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.SegmentDocument", V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.bki_block_301"  , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.bki_block_302"  , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.bki_block_304"  , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.bki_block_401"  , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.bki_block_406"  , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.SegmentTrade"   , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.SegmentInfoPart", V_INTEGER, null, _Params.BkiID);
   
   execStoredFunc("RSO_LNS_CRE.Segment_TradeCollateral", V_UNDEF, makeArray(SQLParam("bkiid", _Params.BkiID)));
   execStoredFunc("RSO_LNS_CRE.Segment_BankGuarantee"  , V_UNDEF, makeArray(SQLParam("bkiid", _Params.BkiID)));
   
   RunStoredFunc("RSO_LNS_CRE.bki_block_412"     , V_INTEGER, null, _Params.BkiID);
   RunStoredFunc("RSO_LNS_CRE.updatecreditnumber", V_INTEGER, null);
   
   CRSDCommand( "UPDATE DREZ_ERR_TMP SET T_BKIID = 2 WHERE T_BKIID = 0", V_GENOBJ);
    
   //todo добавить вывод ошибок в протокол
   CRSDCommand(" UPDATE DOBJECT_BKI_TMP o SET T_FLAG = 'X', T_RESULT = 1    " +
               "  WHERE EXISTS (SELECT 1 FROM DREZ_ERR_TMP r                " +
               "                 WHERE r.T_OBJECTID = o.T_OBJECTTYPEID      " +
               "                   AND r.T_OBJECTNUMBER = o.T_OBJECTNUMBER) ", V_GENOBJ);  

   execStoredFunc("LoansKernel.SetVSessionAction", V_UNDEF, makeArray(SQLParam("action", "Передача КИ")));
            
   CRSDCommand( " DELETE FROM DOBJECT_BKI_TMP WHERE T_FLAG = 'X' OR T_RESULT = -1", V_GENOBJ);
    
   CRSDCommand( "BEGIN select t_maxmessage into RSI_BKI_Core.MAXMESSAGE from DLBKI_DBT where T_BKIID = :BkiID; END;", "BkiID", _Params.BkiID, V_GENOBJ);
   
   var Orders = CRSDCommand( "SELECT DISTINCT T_ORDERNUM AS T_ORDERNUM FROM V_OBJECT_BKI ORDER BY T_ORDERNUM", V_GENOBJ);
   
   WHILE (Orders.MoveNext())
   
      lbki2.BkiID = _Params.BkiID;
      GetEQ(lbki2);
      Copy(lbki_rec, lbki2);

      //todo здесь надо как то убедиться, что параллельные потоки не получат одинаковое имя файла
      var transportFile = СформироватьИмяФайла(_Params.SendKind);
   
      var tr_file = execSQL(  "BEGIN                                                                                                                                                               " + 
                              "  INSERT INTO dltr_file_dbt (T_TFID,T_BKIID_REF,T_FILENAME,T_FILEDATE,T_MESSAGECOUNT,T_DATERECEPTION,T_DATELOAD,T_RESULTLOAD,T_RESULTDELETE,T_REPORTDATE,T_OBJECTID)" + 
                              "       VALUES               ( :tfid, :bkiid_ref, :filename, :filedate, :messagecount, :datereception, :dateload, :resultload, :resultdelete, :reportdate, :objectid)" +
                              "    RETURNING T_TFID INTO :actual_tfid;                                                                                                                             " +
                              "END;                                                                                                                                                                ",
                              makeArray(
                                        SQLParam("tfid"         , 0                                                                                     ),
                                        SQLParam("bkiid_ref"    , _Params.BkiID                                                                         ),
                                        SQLParam("filename"     , transportFile                                                                         ),
                                        SQLParam("filedate"     , dttm({curdate})                                                                       ),
                                        SQLParam("messagecount" , LnSelectValue(" SELECT COUNT(1) FROM V_OBJECT_BKI WHERE T_ORDERNUM = 0", V_INTEGER)   ),
                                        SQLParam("datereception", dttm()                                                                                ),
                                        SQLParam("dateload"     , dttm()                                                                                ),
                                        SQLParam("resultload"   , -1                                                                                    ),
                                        SQLParam("resultdelete" , -1                                                                                    ),
                                        SQLParam("reportdate"   , dttm(_Params.RepDate)                                                                 ),
                                        SQLParam("objectid"     , 0                                                                                     ),
                                        SQLParam("actual_tfid"  , V_INTEGER, RSDBP_OUT)               
                                       )
                              );
   
      execSQL( "INSERT INTO DLDEVBKI_DBT (T_ID, T_CREDITNUMBER_REF, T_SENDDATE, T_TFID_REF, T_SENDKIND, T_RESULT, T_BKIID_REF,    T_OBJECTTYPEID,   T_OBJECTNUMBER)  " + 
               "                   SELECT    0,  vb.t_creditnumber,  :senddate,  :tfid_ref,  :sendkind,      '-',  :bkiid_ref, vb.t_objecttypeid, vb.t_objectnumber  " + 
               "                     FROM V_OBJECT_BKI vb                                                                                                            " +
               "                    WHERE vb.T_ORDERNUM = 0                                                                                                          ",
               makeArray(
                         SQLParam("senddate"  , _Params.RepDate                       ),
                         SQLParam("tfid_ref"  , tr_file.param("actual_tfid").value   ),
                         SQLParam("sendkind"  , _Params.SendKind                      ),
                         SQLParam("bkiid_ref" , _Params.BkiID                         )
                        )
               );
   
      СформироватьТранспортныйФайл_ГрупповойРежим(tr_file.param("actual_tfid").value    , //TFID: integer, 
                                                  _Params.BkiID                         , //BkiID: Integer, 
                                                  _Params.SendKind                      , //SendKind: integer, 
                                                  _Params.PathForming                   , //Path: string, 
                                                  transportFile                         , //FileName: string, 
                                                  _Params.RepDate                       , //StartDate: date, 
                                                  true                                   //bAutoDate
                                                  );
   
      execStoredFunc("RSI_BKI_Core.InsertFromTempToDbt", V_UNDEF, makeArray(SQLParam("TFID", tr_file.param("actual_tfid").value)));

      execSQL( "UPDATE DLDEVBKI_DBT SET T_RESULT = :result WHERE T_TFID_REF = :tfid_ref AND T_BKIID_REF = :bkiid_ref",
               
               makeArray(
                         SQLParam("result"   , "+"                               ),
                         SQLParam("tfid_ref" , tr_file.param("actual_tfid").value),
                         SQLParam("bkiid_ref", _Params.BkiID                      )
                        )
               );
   
      execSQL( "UPDATE DLBKI_DBT SET T_NUMBER = CASE T_NUMBER WHEN 999 THEN 1 ELSE T_NUMBER + 1 END WHERE T_BKIID = :bkiid", makeArray(SQLParam("bkiid", _Params.BkiID)));
   
   END;
   
   return 0;
END;