/*
$Name:         rep_128.mac
$Module:       Кредитование
$Description:  rep_128.mac 
*/

IMPORT Календарь, "total.mac", CommonInter;

var ddep = TRecHandler( "i_dp_dep.rec" );
FILE Credit   ("credit_c.dbt", "loans.def");
FILE Rep  () txt write;

CONST _DAY_      = 1,
      _YEAR_     = 2,
      _PERCENT_  = 1,
      _DURATION_ = 2,
      _SUM_      = 3;

CONST Tbl ="123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ0";

private var ErrCode, workpath;

if(GetRegistryValue ("RS-RETAIL\\INI\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, workpath, ErrCode) != V_STRING)
    msgBox(ErrCode);
    return true;
end;

private const  NameFile = workpath;

var CrdOp    = TBFile      ("crd_op.dbt",   "r", 1, "crd_op.dbt",   "loans.def");
var DutyCrd  = TBFile      ("duty_crd.dbt", "r", 0, "duty_crd.dbt", "loans.def");
var PAYOP    = TRecHandler ("PAYOP.", "loans.def");

var OutShem = "";
if(GetRegistryValue ("RS-LOANS\\ОТЧЕТЫ\\СХЕМА_ВЫГРУЗКИ", V_STRING, OutShem, ErrCode) != V_STRING)
    msgBox(ErrCode);
    return true;
end;
VAR BegDate:date,
    EndDate:date,
    FN:string;

VAR i      :integer = 0,
    c      :integer = 0;
VAR day    :integer,
    mon    :integer,
    year   :integer;

VAR {ФИЛИАЛ};

CLASS Data
    VAR P:string;
    VAR D:variant;
END;

VAR Out = TArray(0);

MACRO InputDate()
    Array m;
    var Ext = "";

    if (ValType(OutShem) == V_UNDEF)
       MsgBox("Не определена схема выгрузки!");
       OutShem = "F";
    else
       OutShem = StrUpr(Substr(trim(OutShem), 1, 1));
    end;

    if (OutShem == "F")
       Ext = "BNK";
    else
       Ext = String({ФИЛИАЛ}:3:o)
    end;

    DateSplit({curdate}, day, mon, year);

    m(0) = "январь";
    m(1) = "февраль";
    m(2) = "март";
    m(3) = "апрель";
    m(4) = "май";
    m(5) = "июнь";
    m(6) = "июль";
    m(7) = "август";
    m(8) = "сентябрь";
    m(9) = "октябрь";
    m(10) = "ноябрь";
    m(11) = "декабрь";

    i = Menu( m, " Выберите мecяц, ESC - выход ", " Месяцы " );
    IF (i < 0)
        Exit();
    END;
    i = i + 1;

    IF (NOT GetInt(year, " Введите год ", 4))
        Exit();
    END;

    if(i == 12)
        EndDate = date(1, 1, year+1)-1;
        BegDate = date(1,12,year)
    else
        EndDate = date(1, i+1, year)-1;
        BegDate = date(1,i,year);
    end;

    FN = "#2"+SubStr(Tbl, i, 1)+"1"+SubStr(String(year),3,2)+"4"+OutShem+"."+Ext;
END;

MACRO GetSum(CurCode:integer, FD:integer, TFD:integer, LD:integer, TLD:integer, TS:integer)
    VAR CredOperID:integer = 0,
        stat = false,
        FirstDate:date,
        LastDate:date,
        First:bool,
        AllSum:moneyl = $0,
        Sum:moneyl = $0;

    MACRO CheckDate(BD:date, ED:date)
        VAR day = ED - BD;

        IF ((TFD == _DAY_) AND (TLD == _DAY_))
            IF ((day >= FD) AND (day <= LD))
                RETURN TRUE;
            END;
        ELIF ((TFD == _DAY_) AND (TLD == _YEAR_))
            IF (LD == 999)
                IF (day >= FD)
                    RETURN TRUE;
                END;
            ELIF ((day >= FD) AND (DateAfterCalenMonths(BD, LD*12) <= ED))
                RETURN TRUE;
            END;
        ELSE
            IF (LD == 999)
                IF ((BD+day) > DateAfterCalenMonths(BD, FD*12))
                    RETURN TRUE;
                END;
            ELIF (((BD+day) > DateAfterCalenMonths(BD, FD*12)) AND (DateAfterCalenMonths(BD, LD*12) <= ED))
                RETURN TRUE;
            END;
        END;

        RETURN FALSE;
    END;

    UseProgress(i);
    i = i + 1;

    ReWind(Credit);
    WHILE (Next(Credit))
        IF (Credit.CurCode == CurCode)
            FirstDate = LastDate = date(0,0,0);
            DutyCrd.Clear;
            DutyCrd.AddFilter("t_DutyType  = 0 and t_CreditNumber_Ref = " + Credit.CreditNumber);
            DutyCrd.rec.CreditNumber_Ref = Credit.CreditNumber;
            DutyCrd.rec.DutyType  = 0;
            DutyCrd.rec.DutyState = "";
            stat = DutyCrd.GetGE;
            WHILE (stat AND (DutyCrd.rec.CreditNumber_Ref == Credit.CreditNumber)
                        AND (DutyCrd.rec.DutyType == 0))
                IF  ((DutyCrd.rec.DutyFirstDate >= BegDate) AND
                     (DutyCrd.rec.DutyFirstDate <= EndDate) AND
                     CheckDate(Credit.RegDate, Credit.ReturnDate) AND
                     (GetHistoryClient(Credit.ClientID_Ref, BegDate) != "X"))
                    First = true;
                    CredOperID = 0;
                    WHILE (NextOpSystType(First, DutyCrd.rec.DutyID, @CrdOp, CS_PAY, true, Credit.CurCode, 0, LO_DUTY, CF_COMPLIT, @CredOperID))
                        IF ((CrdOp.rec.CredOperDate >= BegDate) AND
                            (CrdOp.rec.CredOperDate <= EndDate))
                            PAYOP.SetRecordAddr(CrdOp);
                            IF (TS == _PERCENT_)
                                Sum = Sum + PAYOP.rec.PaySum * Loans_FindRateVal(LO_DUTY, DutyCrd.rec.DutyID, TRU_CRD, DutyCrd.rec.DutyFirstDate, false);
                            ELIF (TS == _DURATION_)
                                Sum = Sum + PAYOP.rec.PaySum * DutyCrd.rec.Duration;
                            END;
                            AllSum = AllSum + PAYOP.rec.PaySum;
                        END;
                    END;
                    Sum = money(round(Sum));
                END;
                stat = DutyCrd.Next;
            END;
            DutyCrd.DropFilter;
        END;
    END;

    IF ((TS != _SUM_) AND (AllSum != $0))
        RETURN Sum / AllSum;
    END;
    RETURN money(round(AllSum * GetRate(EndDate, CurCode)));
END;

InputDate();
InitProgress(48, "Ждите...", "Формирование отчета...");
Out(0) = GenObject("Data");
Out(0).P = "2400A1";
Out(0).D = GetSum(0, 0, _DAY_, 30, _DAY_, _PERCENT_);

Out(1) = GenObject("Data");
Out(1).P = "2400A2";
Out(1).D = GetSum(1, 0, _DAY_, 30, _DAY_, _PERCENT_);

Out(2) = GenObject("Data");
Out(2).P = "3400A1";
Out(2).D = GetSum(0, 0, _DAY_, 30, _DAY_, _DURATION_);

Out(3) = GenObject("Data");
Out(3).P = "3400A2";
Out(3).D = GetSum(1, 0, _DAY_, 30, _DAY_, _DURATION_);

Out(4) = GenObject("Data");
Out(4).P = "1400A1";
Out(4).D = GetSum(0, 0, _DAY_, 30, _DAY_, _SUM_);

Out(5) = GenObject("Data");
Out(5).P = "1400A2";
Out(5).D = GetSum(1, 0, _DAY_, 30, _DAY_, _SUM_);

Out(6) = GenObject("Data");
Out(6).P = "240031";
Out(6).D = GetSum(0, 2, _DAY_, 7, _DAY_, _PERCENT_);

Out(7) = GenObject("Data");
Out(7).P = "240032";
Out(7).D = GetSum(1, 2, _DAY_, 7, _DAY_, _PERCENT_);

Out(8) = GenObject("Data");
Out(8).P = "340031";
Out(8).D = GetSum(0, 2, _DAY_, 7, _DAY_, _DURATION_);

Out(9) = GenObject("Data");
Out(9).P = "340032";
Out(9).D = GetSum(1, 2, _DAY_, 7, _DAY_, _DURATION_);

Out(10) = GenObject("Data");
Out(10).P = "140031";
Out(10).D = GetSum(0, 2, _DAY_, 7, _DAY_, _SUM_);

Out(11) = GenObject("Data");
Out(11).P = "140032";
Out(11).D = GetSum(1, 2, _DAY_, 7, _DAY_, _SUM_);

Out(12) = GenObject("Data");
Out(12).P = "240051";
Out(12).D = GetSum(0, 31, _DAY_, 90, _DAY_, _PERCENT_);

Out(13) = GenObject("Data");
Out(13).P = "240052";
Out(13).D = GetSum(1, 31, _DAY_, 90, _DAY_, _PERCENT_);

Out(14) = GenObject("Data");
Out(14).P = "340051";
Out(14).D = GetSum(0, 31, _DAY_, 90, _DAY_, _DURATION_);

Out(15) = GenObject("Data");
Out(15).P = "340052";
Out(15).D = GetSum(1, 31, _DAY_, 90, _DAY_, _DURATION_);

Out(16) = GenObject("Data");
Out(16).P = "140051";
Out(16).D = GetSum(0, 31, _DAY_, 90, _DAY_, _SUM_);

Out(17) = GenObject("Data");
Out(17).P = "140052";
Out(17).D = GetSum(1, 31, _DAY_, 90, _DAY_, _SUM_);

Out(18) = GenObject("Data");
Out(18).P = "240061";
Out(18).D = GetSum(0, 91, _DAY_, 180, _DAY_, _PERCENT_);

Out(19) = GenObject("Data");
Out(19).P = "240062";
Out(19).D = GetSum(1, 91, _DAY_, 180, _DAY_, _PERCENT_);

Out(20) = GenObject("Data");
Out(20).P = "340061";
Out(20).D = GetSum(0, 91, _DAY_, 180, _DAY_, _DURATION_);

Out(21) = GenObject("Data");
Out(21).P = "340062";
Out(21).D = GetSum(1, 91, _DAY_, 180, _DAY_, _DURATION_);

Out(22) = GenObject("Data");
Out(22).P = "140061";
Out(22).D = GetSum(0, 91, _DAY_, 180, _DAY_, _SUM_);

Out(23) = GenObject("Data");
Out(23).P = "140062";
Out(23).D = GetSum(1, 91, _DAY_, 180, _DAY_, _SUM_);

Out(24) = GenObject("Data");
Out(24).P = "240071";
Out(24).D = GetSum(0, 181, _DAY_, 1, _YEAR_, _PERCENT_);

Out(25) = GenObject("Data");
Out(25).P = "240072";
Out(25).D = GetSum(1, 181, _DAY_, 1, _YEAR_, _PERCENT_);

Out(26) = GenObject("Data");
Out(26).P = "340071";
Out(26).D = GetSum(0, 181, _DAY_, 1, _YEAR_, _DURATION_);

Out(27) = GenObject("Data");
Out(27).P = "340072";
Out(27).D = GetSum(1, 181, _DAY_, 1, _YEAR_, _DURATION_);

Out(28) = GenObject("Data");
Out(28).P = "140071";
Out(28).D = GetSum(0, 181, _DAY_, 1, _YEAR_, _SUM_);

Out(29) = GenObject("Data");
Out(29).P = "140072";
Out(29).D = GetSum(1, 181, _DAY_, 1, _YEAR_, _SUM_);

Out(30) = GenObject("Data");
Out(30).P = "240081";
Out(30).D = GetSum(0, 1, _YEAR_, 3, _YEAR_, _PERCENT_);

Out(31) = GenObject("Data");
Out(31).P = "240082";
Out(31).D = GetSum(1, 1, _YEAR_, 3, _YEAR_, _PERCENT_);

Out(32) = GenObject("Data");
Out(32).P = "340081";
Out(32).D = GetSum(0, 1, _YEAR_, 3, _YEAR_, _DURATION_);

Out(33) = GenObject("Data");
Out(33).P = "340082";
Out(33).D = GetSum(1, 1, _YEAR_, 3, _YEAR_, _DURATION_);

Out(34) = GenObject("Data");
Out(34).P = "140081";
Out(34).D = GetSum(0, 1, _YEAR_, 3, _YEAR_, _SUM_);

Out(35) = GenObject("Data");
Out(35).P = "140082";
Out(35).D = GetSum(1, 1, _YEAR_, 3, _YEAR_, _SUM_);

Out(36) = GenObject("Data");
Out(36).P = "240091";
Out(36).D = GetSum(0, 3, _YEAR_, 999, _YEAR_, _PERCENT_);

Out(37) = GenObject("Data");
Out(37).P = "240092";
Out(37).D = GetSum(1, 3, _YEAR_, 999, _YEAR_, _PERCENT_);

Out(38) = GenObject("Data");
Out(38).P = "340091";
Out(38).D = GetSum(0, 3, _YEAR_, 999, _YEAR_, _DURATION_);

Out(39) = GenObject("Data");
Out(39).P = "340092";
Out(39).D = GetSum(1, 3, _YEAR_, 999, _YEAR_, _DURATION_);

Out(40) = GenObject("Data");
Out(40).P = "140091";
Out(40).D = GetSum(0, 3, _YEAR_, 999, _YEAR_, _SUM_);

Out(41) = GenObject("Data");
Out(41).P = "140092";
Out(41).D = GetSum(1, 3, _YEAR_, 999, _YEAR_, _SUM_);

Out(42) = GenObject("Data");
Out(42).P = "240041";
Out(42).D = GetSum(0, 8, _DAY_, 30, _DAY_, _PERCENT_);

Out(43) = GenObject("Data");
Out(43).P = "240042";
Out(43).D = GetSum(1, 8, _DAY_, 30, _DAY_, _PERCENT_);

Out(44) = GenObject("Data");
Out(44).P = "340041";
Out(44).D = GetSum(0, 8, _DAY_, 30, _DAY_, _DURATION_);

Out(45) = GenObject("Data");
Out(45).P = "340042";
Out(45).D = GetSum(1, 8, _DAY_, 30, _DAY_, _DURATION_);

Out(46) = GenObject("Data");
Out(46).P = "140041";
Out(46).D = GetSum(0, 8, _DAY_, 30, _DAY_, _SUM_);

Out(47) = GenObject("Data");
Out(47).P = "140042";
Out(47).D = GetSum(1, 8, _DAY_, 30, _DAY_, _SUM_);
RemProgress;

findDepartment({ФИЛИАЛ}, null, ddep);

[  ###########
                     Средневзвешенные процентные ставки по кредитам, предоставленным банком
                                     За период  с ########## по ##########
+---------+-----------------------------------------------------------------------------------------------+
|         |                                       Кредиты физ. Лиц                                        |
|         |-----------------------------------------------------------------------------------------------|
|  Сроки  |         Средний процент       |         Средний срок          |          Общая сумма          |
|         |---------------+---------------+---------------+---------------+---------------+---------------+
|         |     Рубли          Валюта     |     Рубли          Валюта     |     Рубли          Валюта     |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
|1. до 30 |               |               |               |               |               |               |
|дней, в  |###############|###############|###############|###############|###############|###############|
|том числе|               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
| 1.1 2-7 |###############|###############|###############|###############|###############|###############|
|  дней   |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
| 1.2 от  |               |               |               |               |               |               |
| 8 до 30 |###############|###############|###############|###############|###############|###############|
| дней    |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
|2. 31-90 |###############|###############|###############|###############|###############|###############|
|дней     |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
|3. 91-180|###############|###############|###############|###############|###############|###############|
|дней     |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
|4. 181-1 |###############|###############|###############|###############|###############|###############|
|год      |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
|5. от 1  |###############|###############|###############|###############|###############|###############|
|до 3 лет |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
|6. свыше |###############|###############|###############|###############|###############|###############|
|   3 лет |               |               |               |               |               |               |
+---------+---------------+---------------+---------------+---------------+---------------+---------------+
]
(ddep.rec.Name,
 BegDate, EndDate,
 Out(0).D:15:2:r,  Out(1).D:15:2:r,  Out(2).D:15:2:r,  Out(3).D:15:2:r,  Out(4).D/1000:15:2:r,  Out(5).D/1000:15:2:r,
 Out(6).D:15:2:r,  Out(7).D:15:2:r,  Out(8).D:15:2:r,  Out(9).D:15:2:r,  Out(10).D/1000:15:2:r, Out(11).D/1000:15:2:r,
 Out(42).D:15:2:r, Out(43).D:15:2:r, Out(43).D:15:2:r, Out(45).D:15:2:r, Out(46).D/1000:15:2:r, Out(47).D/1000:15:2:r,
 Out(12).D:15:2:r, Out(13).D:15:2:r, Out(14).D:15:2:r, Out(15).D:15:2:r, Out(16).D/1000:15:2:r, Out(17).D/1000:15:2:r,
 Out(18).D:15:2:r, Out(19).D:15:2:r, Out(20).D:15:2:r, Out(21).D:15:2:r, Out(22).D/1000:15:2:r, Out(23).D/1000:15:2:r,
 Out(24).D:15:2:r, Out(25).D:15:2:r, Out(26).D:15:2:r, Out(27).D:15:2:r, Out(28).D/1000:15:2:r, Out(29).D/1000:15:2:r,
 Out(30).D:15:2:r, Out(31).D:15:2:r, Out(32).D:15:2:r, Out(33).D:15:2:r, Out(34).D/1000:15:2:r, Out(35).D/1000:15:2:r,
 Out(36).D:15:2:r, Out(37).D:15:2:r, Out(38).D:15:2:r, Out(39).D:15:2:r, Out(40).D/1000:15:2:r, Out(41).D/1000:15:2:r
 );

IF (Open(Rep, NameFile + FN))

    Rep.str = "";
    i = 0;
    WHILE (i < 100)
        Rep.str = Rep.str + " ";
        i = i + 1;
    END;
    Insert(Rep);

    i = 0;
    WHILE (i < Out.size)
        IF (Out(i).D != 0)
            c = c + 1;
        END;
        i = i + 1;
    END;

    Rep.str = OutShem + "=" + ddep.rec.Name + "=";
    DateSplit(EndDate+1, day, mon, year);
    Rep.str = Rep.str + string(day:2:o)+string(mon:2:o)+SubStr(string(year), 2, 3)+"1=";
    DateSplit(BegDate, day, mon, year);
    Rep.str = Rep.str + string(day:2:o)+string(mon:2:o)+SubStr(string(year), 2, 3)+"2=";
    DateSplit(EndDate, day, mon, year);
    Rep.str = Rep.str + string(day:2:o)+string(mon:2:o)+SubStr(string(year), 2, 3)+"3=";
    DateSplit(date(), day, mon, year);
    Rep.str = Rep.str + string(day:2:o)+string(mon:2:o)+SubStr(string(year), 2, 3)+"4=";
    TimeSplit(time(), day, mon, year);
    Rep.str = Rep.str + string(day:2:o)+string(mon:2:o)+"="+string(c:9:o)+"="+FN;
    Insert(Rep);
    // 3-я строка - пустая
    Rep.str = "";
    Insert(Rep);

    i = 0;
    WHILE (i < Out.size)
        IF (Out(i).D != 0)
            Rep.str = Out(i).P+"="+string(Out(i).D);
            Insert(Rep);
        END;
        i = i + 1;
    END;

    Close(Rep);
END;
