/*
$Name:             notifycs.mac
$Module:           Кредитование
$Description:      Уведомление об уступке прав требования по кредиту
*/
import ActiveX, total, replib, dlwreps, replib, global, acc_crd, SbCrdInter;

private record cur_credit ("credit_c.dbt", "loans.def");
private record AdviceBuf ("advice.dbt", "loans.def");

private const TemplateName = "notifycs.dot";


private VAR {GROUP_MODE};

macro PrintLoansReport(_AdviceBuf, _FIO, _Post)
var axerr:object = null;
var CrdNum,CrdDate:date, n_f, n_s;
var StrCmd,RSDcmd, rsRow; 
 
      SetBuff(AdviceBuf, _AdviceBuf);
      if(AdviceBuf.AdviceKindID_Ref != 10)
         if(not {GROUP_MODE})
            MsgBox ("ОШИБКА: Необходимо сформировать уведомление об уступке прав требования по кредиту!");
         end;
         Exit(1);
      end;
      

      println(TemplateName);              //Имя файла-шаблона
      println(GetDocName(TemplateName));  // Генерируем имя результирующего файла документа

      private var   OurBank = TLoansClient;

      if(not OurBank.GetRecord({OurBank}))    //не найден "Наш банк"
         Exit(1);
      end;


      StrCmd = " SELECT cr.T_UsCreditNumber CrdNum, cr.T_RegDate CrdDate, clnt.T_NAME n_f, clnt.T_SHORTNAME n_s "+
               " FROM DCREDIT_C_DBT cr, dparty_dbt clnt"+ 
               " WHERE cr.T_CreditNumber = ? AND clnt.T_PARTYID = cr.T_CLIENTID_REF";

      RSDcmd = RsdCommand (RslDefCon, StrCmd);
      RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = AdviceBuf.ObjectNumber;

      rsRow = RsdRecordset(RSDcmd);

      if (rsRow == NULL)
         Exit(1);
      end;

      if(not rsRow.MoveNext()) 
         Exit(1);
      end;


      CrdNum = rsRow.value("CrdNum", NULL, V_STRING);
      CrdDate= rsRow.value("CrdDate" , NULL, V_DATE);
      n_f= rsRow.value("n_f", NULL, V_STRING);
      n_s= rsRow.value("n_s", NULL, V_STRING);
      
      
      /* № уведомления */
      [~Note_Num];
      println (AdviceBuf.AdviceUsNumber);

      [~Note_Date];
      println (DateToStringFull (AdviceBuf.AdviceDate));

      /* Полное имя заемщика */
      [~CrdClientName_F];
      println(n_f);
      /* Сокращенное имя заемщика */
      [~CrdClientName_S];
      println(n_s);
       /* Номер КД*/
      [~CrdNum];
      println(CrdNum);
      [~CrdDate];
      println(DateToStringFull(CrdDate));

      [~OurBank_F];
      println(OurBank.Name);
      [~OurBank];
      println(OurBank.ShortName);
      
      StrCmd = null;
      RSDcmd = null;
      rsRow = null;

      StrCmd = " SELECT cr.t_uscreditnumber un, cr.t_regdate rd, cl.t_name n_f, cl.t_shortname n_s "+
               " FROM dcredit_c_dbt cr, dparty_dbt cl, dlbfrccrd_dbt lbfrccrd "+ 
               " WHERE lbfrccrd.t_objectnumber = ? AND lbfrccrd.t_objecttypeid = ? "+
               "   AND cr.t_creditnumber = t_briefcaseid_ref AND cr.t_crd_kind = ? "+
               "   AND cl.t_partyid = cr.t_clientid_ref";

      RSDcmd = RsdCommand (RslDefCon, StrCmd);
      RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = AdviceBuf.ObjectNumber;
      RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = AdviceBuf.ObjectTypeID;
      RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(2) = LO_DOGCREDCLAIMCESSION;

      rsRow = RsdRecordset(RSDcmd);

      if (rsRow == NULL)
         Exit(1);
      end;

      if(not rsRow.MoveNext()) 
         Exit(1);
      end;

      [~DogNum];
      println(rsRow.value("un", NULL, V_STRING));
      [~DogDate];
      println(DateToStringFull(rsRow.value("rd" , NULL, V_DATE)));
      [~Bank_F];
      println(rsRow.value("n_f", NULL, V_STRING));
      [~Bank];
      println(rsRow.value("n_s", NULL, V_STRING));

      if({GROUP_MODE})
         [~Post];
         println(string(_Post));
         [~FIO];
         println(string(_FIO));   
      else
         [~Post];
         println("");
         [~FIO];
         println("");
      end;
     
      DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
      SetOutput(NULL, false);


	  CRSDCommand ("UPDATE DADVICE_DBT SET T_PATHPRINTFORM = ? "
					" WHERE T_ADVICEID = ? ",
					"ppf", Substr(TemplateName, 1, Index(TemplateName, ".") - 1) + StrSubst(string(time), ":", "") + string(UserNumber) + "." + string(UserNumber),
					//"ppf", GetDocName(TemplateName),
					"aid", AdviceBuf.AdviceID,
					V_GENOBJ);
					
      if(not {GROUP_MODE})
         MsgBoxEx("Уведомление об уступке прав требования по кредиту сформировано.");
      end;   
      Exit(0);

      onError(axerr)
         if(axerr.Code != 0)
             WordError(axerr, false);
         end;
         Exit(0);

      return 0;
end;