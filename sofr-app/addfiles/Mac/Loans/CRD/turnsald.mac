/*
$Name: turnsald.mac
$Module: Кредитование
$Description: Оборотно-сальдовая ведомость
*/
/*****************************************************************************/
/*                                                                           */
/*                        Оборотно-сальдовая ведомость                       */
/*                                                                           */
/*****************************************************************************/
IMPORT SbCrdInter, LoansFind, Календарь, total, FIInter, "or_tpl_h.mac";

// названия полей панели
PRIVATE CONST
    FNAME_DEPART             = "f_depart",
    FNAME_FORM               = "f_form",
    FNAME_CURR               = "f_curr",
    FNAME_RECALC             = "f_recalc",
    FNAME_TYPE_PERIOD        = "f_type_period",
    FNAME_TYPEPERIOD_NAME    = "f_type_period_name",
    FNAME_YEAR               = "f_year",
    FNAME_PERIOD1            = "f_period1",
    FNAME_PERIOD2            = "f_period2",
    FNAME_TYPECRD            = "f_typecrd",
    FNAME_USERTYPE           = "f_usertype",
    FNAME_CLIENT             = "f_client",
    FNAME_CHAPTER            = "f_chapter",
    FNAME_MASK_FLAG          = "f_mask_flag",
    FNAME_MASK               = "f_mask",
    FNAME_KU_FLAG            = "f_ku_flag",
    FNAME_KU                 = "f_ku",
    FNAME_COLUMN_ORD         = "f_column_ord",
    FNAME_COLUMN_CLIENT      = "f_column_client",
    FNAME_COLUMN_NAMEACCOUNT = "f_column_nameaccount",
    FNAME_ZERO_REST          = "f_zero_rest",
    FNAME_ZERO_TURN          = "f_zero_turn";

// номера полей панели
PRIVATE VAR
    F_DEPART             = -1,
    F_FORM               = -1,
    F_CURR               = -1,
    F_RECALC             = -1,
    F_TYPE_PERIOD        = -1,
    F_TYPEPERIOD_NAME    = -1,
    F_YEAR               = -1,
    F_PERIOD1            = -1,
    F_PERIOD2            = -1,
    F_TYPECRD            = -1,
    F_USERTYPE           = -1,
    F_CLIENT             = -1,
    F_CHAPTER            = -1,
    F_MASK_FLAG          = -1,
    F_MASK               = -1,
    F_KU_FLAG            = -1,
    F_KU                 = -1,
    F_COLUMN_ORD         = -1,
    F_COLUMN_CLIENT      = -1,
    F_COLUMN_NAMEACCOUNT = -1,
    F_ZERO_REST          = -1,
    F_ZERO_TURN          = -1;

PRIVATE VAR
    Depart:integer         = -1,
    Form:integer           = 2,
    CurCode:integer        = NATCUR,
    ReCalc:string          = " ",
    TypePeriod:integer     = 1,
    TypePeriodName:integer = 0,
    BegDate:date           = {curdate},
    EndDate:date           = {curdate},
    Year:integer           = 0,
    UserType:string        =  "",
    SetCln :string         = " ",
    Chapt:integer          = 0,
    Mask:string            = "";

ARRAY FR, TP, MN, KV,CH;

PRIVATE VAR
    PrevCurCode:Integer = CurCode;

VAR ClientTmp = TBFile ("set_cln.tmp", "r", 0);          /*временный файл для выбора клиентов*/
RECORD turnsald("turnsald", "sbcrd") DIALOG;
private  var FI = TBFile("fininstr.dbt", "r", 2, "fininstr.dbt", "bank.def");

private var TypeCrdTmp = TBFile ("set_tcr.tmp",  "r", 0, "set_tcr.tmp",   "loans.def");  /* временный файл для выбора кредитов */
private var TypeAccTmp = TBFile ("set_tacc.tmp", "r", 0, "set_tacc.tmp",  "loans.def");  /* временный файл для выбора категории учета */

private const TemplateName:string = "turnsald.xls";
private var ExcelObj : CTemplateXLS = CTemplateXLS();
private var RezSum : object = NULL;

CONST ALL:string = "Все",
      AllStatus:string = "~Esc~ Выход  ~Enter~ Продолжить";

CONST ESC:integer = 27,
      ENTER:integer = 13,
      F2:integer = 316,
      F3:integer = 317,
      SPACE:integer = 32;

private var {RSL_TOOLS_VERSION}, {ФИЛИАЛ};

// установить соответсвие названия полей с номером поля в панели
MACRO GetFieldsNumber(d)
    F_DEPART             = FldIndex (d, FNAME_DEPART);
    F_FORM               = FldIndex (d, FNAME_FORM);
    F_CURR               = FldIndex (d, FNAME_CURR);
    F_RECALC             = FldIndex (d, FNAME_RECALC);
    F_TYPE_PERIOD        = FldIndex (d, FNAME_TYPE_PERIOD);
    F_TYPEPERIOD_NAME    = FldIndex (d, FNAME_TYPEPERIOD_NAME);
    F_YEAR               = FldIndex (d, FNAME_YEAR);
    F_PERIOD1            = FldIndex (d, FNAME_PERIOD1);
    F_PERIOD2            = FldIndex (d, FNAME_PERIOD2);
    F_TYPECRD            = FldIndex (d, FNAME_TYPECRD);
    F_USERTYPE           = FldIndex (d, FNAME_USERTYPE);
    F_CLIENT             = FldIndex (d, FNAME_CLIENT);
    F_CHAPTER            = FldIndex (d, FNAME_CHAPTER);
    F_MASK_FLAG          = FldIndex (d, FNAME_MASK_FLAG);
    F_MASK               = FldIndex (d, FNAME_MASK);
    F_KU_FLAG            = FldIndex (d, FNAME_KU_FLAG);
    F_KU                 = FldIndex (d, FNAME_KU);
    F_COLUMN_ORD         = FldIndex (d, FNAME_COLUMN_ORD);
    F_COLUMN_CLIENT      = FldIndex (d, FNAME_COLUMN_CLIENT);
    F_COLUMN_NAMEACCOUNT = FldIndex (d, FNAME_COLUMN_NAMEACCOUNT);
    F_ZERO_REST          = FldIndex (d, FNAME_ZERO_REST);
    F_ZERO_TURN          = FldIndex (d, FNAME_ZERO_TURN);
END;

MACRO PrintReport()
    VAR i:integer,
        cb:integer = 0,
        Acc1:string = "",
        Acc2:string = "",
        IsHead:bool = true;

    VAR rs = NULL, cmd: string;

    VAR Account = "", ;
    VAR RecalcCurRate;
    ARRAY Sum, SumRecalc, SumAcc1, SumAcc2, SumAccAll;
    ARRAY Merge1, Merge2;

    /* Печать заголовка */
    MACRO PrintHead()
        if ((Form == 0)and(ReCalc != "X"))
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL5").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL6").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL7").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL8").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL10").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL12").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL13").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL14").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL15").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL16").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Rows(ExcelObj.Sheet.Range("T_STR1").Address).RowHeight      = 0;
        elif ((Form == 0)and(ReCalc == "X"))
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL5").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL6").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL7").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL8").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL13").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL14").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL15").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL16").Address).ColumnWidth = 0;
        elif ((Form == 1)and(ReCalc != "X"))
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL6").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL8").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL9").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL10").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL11").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL12").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL14").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL16").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Rows(ExcelObj.Sheet.Range("T_STR1").Address).RowHeight      = 0;
        elif ((Form == 1)and(ReCalc == "X"))
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL9").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL10").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL11").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL12").Address).ColumnWidth = 0;
        elif ((Form == 2)and(ReCalc != "X"))
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL6").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL8").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL10").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL12").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL14").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL16").Address).ColumnWidth = 0;
            ExcelObj.Sheet.Rows(ExcelObj.Sheet.Range("T_STR1").Address).RowHeight      = 0;
        elif ((Form == 2)and(ReCalc == "X"))
            ;
        end;

        if (turnsald(F_COLUMN_ORD) != "X")
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL1").Address).ColumnWidth = 0;
        end;
        if (turnsald(F_COLUMN_CLIENT) != "X")
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL2").Address).ColumnWidth = 0;
        end;
        if (turnsald(F_COLUMN_NAMEACCOUNT) != "X")
            ExcelObj.Sheet.Columns(ExcelObj.Sheet.Range("T_CL4").Address).ColumnWidth = 0;
        end;

        ExcelObj.SetValue_NameCell("T_H1", FR(Form));

        if (TypePeriod == 0)
            ExcelObj.SetValue_NameCell("T_H2", "за " + String(BegDate:f));
        elif (TypePeriod == 1)
            ExcelObj.SetValue_NameCell("T_H2", "с " + String(BegDate:f) + " по " + String(EndDate:f));
        elif (TypePeriod == 2)
            ExcelObj.SetValue_NameCell("T_H2", "за " + turnsald(F_TYPEPERIOD_NAME) + " " + String(Year) + " г.");
        elif (TypePeriod == 3)
            ExcelObj.SetValue_NameCell("T_H2", "за " + turnsald(F_TYPEPERIOD_NAME) + " " + String(Year) + " г.");
        elif (TypePeriod == 4)
            ExcelObj.SetValue_NameCell("T_H2", "за " + String(Year) + " г.");
        end;

        ExcelObj.SetValue_NameCell("T_H3", "Глава счетов: " + CH(Chapt));
        ExcelObj.SetValue_NameCell("T_H4", FindExtCode (CurCode) + ". " + FindFullName(CurCode));

        if (ReCalc == "X")
            ExcelObj.SetValue_NameCell("T_H5", "Курс ЦБ на " + String((EndDate + 1):f) + " г.  " + String(GetRate((EndDate + 1), CurCode):0:2));
        else
            ExcelObj.SetValue_NameCell("T_H5", "");
        end;
    END;

    MACRO PrintSum()
      var
          i = 14;

        if (not IsHead)
            RezSum.AddStr();
        end;

        if (turnsald(F_COLUMN_ORD) != "X")
            ExcelObj.Sheet.Range("T_SUM").Borders(8).LineStyle = 1;
        end;

        ExcelObj.SetValue_NameCell("T_A1", rs.Value("uscrdnum", NULL, V_STRING));
        ExcelObj.SetValue_NameCell("T_A2", rs.Value("clientname", NULL, V_STRING));

        if (Account != rs.Value("accountnumber", NULL, V_STRING))
            Account = rs.Value("accountnumber", NULL, V_STRING);
            while (i >= 0)
                if (Merge1(i) != Merge2(i))
                    ExcelObj.Sheet.Range(Merge1(i) + ":" + Merge2(i)).Merge;
                end;

                i = i - 1;
            end;
 
            Merge1(0)  = Merge2(0)  = ExcelObj.Sheet.Range("T_A2").Address;
            Merge1(1)  = Merge2(1)  = ExcelObj.Sheet.Range("T_A3").Address;
            Merge1(2)  = Merge2(2)  = ExcelObj.Sheet.Range("T_A4").Address;
            Merge1(3)  = Merge2(3)  = ExcelObj.Sheet.Range("T_A5").Address;
            Merge1(4)  = Merge2(4)  = ExcelObj.Sheet.Range("T_A6").Address;
            Merge1(5)  = Merge2(5)  = ExcelObj.Sheet.Range("T_A7").Address;
            Merge1(6)  = Merge2(6)  = ExcelObj.Sheet.Range("T_A8").Address;
            Merge1(7)  = Merge2(7)  = ExcelObj.Sheet.Range("T_A9").Address;
            Merge1(8)  = Merge2(8)  = ExcelObj.Sheet.Range("T_A10").Address;
            Merge1(9)  = Merge2(9)  = ExcelObj.Sheet.Range("T_A11").Address;
            Merge1(10) = Merge2(10) = ExcelObj.Sheet.Range("T_A12").Address;
            Merge1(11) = Merge2(11) = ExcelObj.Sheet.Range("T_A13").Address;
            Merge1(12) = Merge2(12) = ExcelObj.Sheet.Range("T_A14").Address;
            Merge1(13) = Merge2(13) = ExcelObj.Sheet.Range("T_A15").Address;
            Merge1(14) = Merge2(14) = ExcelObj.Sheet.Range("T_A16").Address;

            ExcelObj.SetValue_NameCell("T_A3", Account);
            ExcelObj.SetValue_NameCell("T_A4", rs.Value("shortname", NULL, V_STRING));
            ExcelObj.SetValue_NameCell("T_A5", Sum(0));
            ExcelObj.SetValue_NameCell("T_A6", SumRecalc(0));
            ExcelObj.SetValue_NameCell("T_A7", Sum(1));
            ExcelObj.SetValue_NameCell("T_A8", SumRecalc(1));
            ExcelObj.SetValue_NameCell("T_A9", Sum(2));
            ExcelObj.SetValue_NameCell("T_A10", SumRecalc(2));
            ExcelObj.SetValue_NameCell("T_A11", Sum(3));
            ExcelObj.SetValue_NameCell("T_A12", SumRecalc(3));
            ExcelObj.SetValue_NameCell("T_A13", Sum(4));
            ExcelObj.SetValue_NameCell("T_A14", SumRecalc(4));
            ExcelObj.SetValue_NameCell("T_A15", Sum(5));
            ExcelObj.SetValue_NameCell("T_A16", SumRecalc(5));
         else
            ExcelObj.Sheet.Range("T_SUM").Borders(8).LineStyle = xlNone;
            Merge2(0)  = ExcelObj.Sheet.Range("T_A2").Address;
            Merge2(1)  = ExcelObj.Sheet.Range("T_A3").Address;
            Merge2(2)  = ExcelObj.Sheet.Range("T_A4").Address;
            Merge2(3)  = ExcelObj.Sheet.Range("T_A5").Address;
            Merge2(4)  = ExcelObj.Sheet.Range("T_A6").Address;
            Merge2(5)  = ExcelObj.Sheet.Range("T_A7").Address;
            Merge2(6)  = ExcelObj.Sheet.Range("T_A8").Address;
            Merge2(7)  = ExcelObj.Sheet.Range("T_A9").Address;
            Merge2(8)  = ExcelObj.Sheet.Range("T_A10").Address;
            Merge2(9)  = ExcelObj.Sheet.Range("T_A11").Address;
            Merge2(10) = ExcelObj.Sheet.Range("T_A12").Address;
            Merge2(11) = ExcelObj.Sheet.Range("T_A13").Address;
            Merge2(12) = ExcelObj.Sheet.Range("T_A14").Address;
            Merge2(13) = ExcelObj.Sheet.Range("T_A15").Address;
            Merge2(14) = ExcelObj.Sheet.Range("T_A16").Address; 

            if (turnsald(F_COLUMN_ORD) != "X")
                ExcelObj.Sheet.Rows(ExcelObj.Sheet.Range("T_SUM").Row + ":" + ExcelObj.Sheet.Range("T_SUM").Row).RowHeight = 0;
            end;
       end;

        return 0;
    END;

    MACRO PrintSumAcc1()
      var
          T_A1 = "",
          T_A2 = "",
          T_A3 = "",
          T_A4 = "",
          T_A5 = "",
          T_A6 = "",
          T_A7 = "",
          T_A8 = "",
          T_A9 = "",
          T_A10 = "",
          T_A11 = "",
          T_A12 = "",
          T_A13 = "",
          T_A14 = "",
          T_A15 = "",
          T_A16 = "";

        if ((acc1 != "") and
            (acc1 != rs.Value("acc1", NULL, V_STRING)))
            if (not IsHead)
                RezSum.AddStr();
                ExcelObj.Sheet.Range("T_SUM").Borders(8).LineStyle = 1;
            end;

            T_A1 = ExcelObj.Sheet.Range("T_A1").Address;
            T_A2 = ExcelObj.Sheet.Range("T_A2").Address;
            T_A3 = ExcelObj.Sheet.Range("T_A3").Address;
            T_A4 = ExcelObj.Sheet.Range("T_A4").Address;
            T_A5 = ExcelObj.Sheet.Range("T_A5").Address;
            T_A6 = ExcelObj.Sheet.Range("T_A6").Address;
            T_A7 = ExcelObj.Sheet.Range("T_A7").Address;
            T_A8 = ExcelObj.Sheet.Range("T_A8").Address;
            T_A9 = ExcelObj.Sheet.Range("T_A9").Address;
            T_A10 = ExcelObj.Sheet.Range("T_A10").Address;
            T_A11 = ExcelObj.Sheet.Range("T_A11").Address;
            T_A12 = ExcelObj.Sheet.Range("T_A12").Address;
            T_A13 = ExcelObj.Sheet.Range("T_A13").Address;
            T_A14 = ExcelObj.Sheet.Range("T_A14").Address;
            T_A15 = ExcelObj.Sheet.Range("T_A15").Address;
            T_A16 = ExcelObj.Sheet.Range("T_A16").Address;
            RezSum.AddStr();
            ExcelObj.Sheet.Range("T_SUM").Borders(8).LineStyle = 1;

            ExcelObj.Sheet.Range(T_A1 + ":" + T_A4).Merge;
            ExcelObj.SetValue_NameCell(T_A1, "Итого для БС 1-го порядка");
            ExcelObj.Sheet.Range(T_A1).Font.Bold = true;

            ExcelObj.SetValue_NameCell(T_A5, SumAcc1(0));
            ExcelObj.SetValue_NameCell(T_A6, SumAcc1(1));
            ExcelObj.SetValue_NameCell(T_A7, SumAcc1(2));
            ExcelObj.SetValue_NameCell(T_A8, SumAcc1(3));
            ExcelObj.SetValue_NameCell(T_A9, SumAcc1(4));
            ExcelObj.SetValue_NameCell(T_A10, SumAcc1(5));
            ExcelObj.SetValue_NameCell(T_A11, SumAcc1(6));
            ExcelObj.SetValue_NameCell(T_A12, SumAcc1(7));
            ExcelObj.SetValue_NameCell(T_A13, SumAcc1(8));
            ExcelObj.SetValue_NameCell(T_A14, SumAcc1(9));
            ExcelObj.SetValue_NameCell(T_A15, SumAcc1(10));
            ExcelObj.SetValue_NameCell(T_A16, SumAcc1(11));

            SumAcc1(0) = Sum(0);
            SumAcc1(1) = SumRecalc(0);
            SumAcc1(2) = Sum(1);
            SumAcc1(3) = SumRecalc(1);
            SumAcc1(4) = Sum(2);
            SumAcc1(5) = SumRecalc(2);
            SumAcc1(6) = Sum(3);
            SumAcc1(7) = SumRecalc(3);
            SumAcc1(8) = Sum(4);
            SumAcc1(9) = SumRecalc(5);
            SumAcc1(10) = Sum(5);
            SumAcc1(11) = SumRecalc(5);

            IsHead = true;
        elif (Account != rs.Value("accountnumber", NULL, V_STRING))
             SumAcc1(0) = SumAcc1(0) + Sum(0);
             SumAcc1(1) = SumAcc1(1) + SumRecalc(0);
             SumAcc1(2) = SumAcc1(2) + Sum(1);
             SumAcc1(3) = SumAcc1(3) + SumRecalc(1);
             SumAcc1(4) = SumAcc1(4) + Sum(2);
             SumAcc1(5) = SumAcc1(5) + SumRecalc(2);
             SumAcc1(6) = SumAcc1(6) + Sum(3);
             SumAcc1(7) = SumAcc1(7) + SumRecalc(3);
             SumAcc1(8) = SumAcc1(8) + Sum(4);
             SumAcc1(9) = SumAcc1(9) + SumRecalc(4);
             SumAcc1(10) = SumAcc1(10) + Sum(5);
             SumAcc1(11) = SumAcc1(11) + SumRecalc(5);
        end;

        acc1 = rs.Value("acc1", NULL, V_STRING);
    END;

    MACRO PrintSumAcc2()
      var
          T_A1 = "",
          T_A2 = "",
          T_A3 = "",
          T_A4 = "",
          T_A5 = "",
          T_A6 = "",
          T_A7 = "",
          T_A8 = "",
          T_A9 = "",
          T_A10 = "",
          T_A11 = "",
          T_A12 = "",
          T_A13 = "",
          T_A14 = "",
          T_A15 = "",
          T_A16 = "";

        if ((acc2 != "") and
            (acc2 != rs.Value("acc2", NULL, V_STRING)))
            if (not IsHead)
                RezSum.AddStr();
                ExcelObj.Sheet.Range("T_SUM").Borders(8).LineStyle = 1;
            end;

            T_A1 = ExcelObj.Sheet.Range("T_A1").Address;
            T_A2 = ExcelObj.Sheet.Range("T_A2").Address;
            T_A3 = ExcelObj.Sheet.Range("T_A3").Address;
            T_A4 = ExcelObj.Sheet.Range("T_A4").Address;
            T_A5 = ExcelObj.Sheet.Range("T_A5").Address;
            T_A6 = ExcelObj.Sheet.Range("T_A6").Address;
            T_A7 = ExcelObj.Sheet.Range("T_A7").Address;
            T_A8 = ExcelObj.Sheet.Range("T_A8").Address;
            T_A9 = ExcelObj.Sheet.Range("T_A9").Address;
            T_A10 = ExcelObj.Sheet.Range("T_A10").Address;
            T_A11 = ExcelObj.Sheet.Range("T_A11").Address;
            T_A12 = ExcelObj.Sheet.Range("T_A12").Address;
            T_A13 = ExcelObj.Sheet.Range("T_A13").Address;
            T_A14 = ExcelObj.Sheet.Range("T_A14").Address;
            T_A15 = ExcelObj.Sheet.Range("T_A15").Address;
            T_A16 = ExcelObj.Sheet.Range("T_A16").Address;
            RezSum.AddStr();
            ExcelObj.Sheet.Range("T_SUM").Borders(8).LineStyle = 1;

            ExcelObj.Sheet.Range(T_A1 + ":" + T_A4).Merge;
            ExcelObj.SetValue_NameCell(T_A1, "Итого для БС 2-го порядка");
            ExcelObj.Sheet.Range(T_A1).Font.Bold = true;

            ExcelObj.SetValue_NameCell(T_A5, SumAcc2(0));
            ExcelObj.SetValue_NameCell(T_A6, SumAcc2(1));
            ExcelObj.SetValue_NameCell(T_A7, SumAcc2(2));
            ExcelObj.SetValue_NameCell(T_A8, SumAcc2(3));
            ExcelObj.SetValue_NameCell(T_A9, SumAcc2(4));
            ExcelObj.SetValue_NameCell(T_A10, SumAcc2(5));
            ExcelObj.SetValue_NameCell(T_A11, SumAcc2(6));
            ExcelObj.SetValue_NameCell(T_A12, SumAcc2(7));
            ExcelObj.SetValue_NameCell(T_A13, SumAcc2(8));
            ExcelObj.SetValue_NameCell(T_A14, SumAcc2(9));
            ExcelObj.SetValue_NameCell(T_A15, SumAcc2(10));
            ExcelObj.SetValue_NameCell(T_A16, SumAcc2(11));

            SumAcc2(0) = Sum(0);
            SumAcc2(1) = SumRecalc(0);
            SumAcc2(2) = Sum(1);
            SumAcc2(3) = SumRecalc(1);
            SumAcc2(4) = Sum(2);
            SumAcc2(5) = SumRecalc(2);
            SumAcc2(6) = Sum(3);
            SumAcc2(7) = SumRecalc(3);
            SumAcc2(8) = Sum(4);
            SumAcc2(9) = SumRecalc(5);
            SumAcc2(10) = Sum(5);
            SumAcc2(11) = SumRecalc(5);

            IsHead = true;
        elif (Account != rs.Value("accountnumber", NULL, V_STRING))
             SumAcc2(0) = SumAcc2(0) + Sum(0);
             SumAcc2(1) = SumAcc2(1) + SumRecalc(0);
             SumAcc2(2) = SumAcc2(2) + Sum(1);
             SumAcc2(3) = SumAcc2(3) + SumRecalc(1);
             SumAcc2(4) = SumAcc2(4) + Sum(2);
             SumAcc2(5) = SumAcc2(5) + SumRecalc(2);
             SumAcc2(6) = SumAcc2(6) + Sum(3);
             SumAcc2(7) = SumAcc2(7) + SumRecalc(3);
             SumAcc2(8) = SumAcc2(8) + Sum(4);
             SumAcc2(9) = SumAcc2(9) + SumRecalc(4);
             SumAcc2(10) = SumAcc2(10) + Sum(5);
             SumAcc2(11) = SumAcc2(11) + SumRecalc(5);
        end;

        acc2 = rs.Value("acc2", NULL, V_STRING);
    END;

    MACRO PrintEnd()
        ExcelObj.Sheet.Range(ExcelObj.Sheet.Range("T_A1").Address + ":" + ExcelObj.Sheet.Range("T_A4").Address).Merge;
        ExcelObj.SetValue_NameCell("T_A1", "Итого");
        ExcelObj.Sheet.Range("T_A1").Font.Bold = true;

        ExcelObj.SetValue_NameCell("T_A5", SumAccAll(0));
        ExcelObj.SetValue_NameCell("T_A6", SumAccAll(1));
        ExcelObj.SetValue_NameCell("T_A7", SumAccAll(2));
        ExcelObj.SetValue_NameCell("T_A8", SumAccAll(3));
        ExcelObj.SetValue_NameCell("T_A9", SumAccAll(4));
        ExcelObj.SetValue_NameCell("T_A10", SumAccAll(5));
        ExcelObj.SetValue_NameCell("T_A11", SumAccAll(6));
        ExcelObj.SetValue_NameCell("T_A12", SumAccAll(7));
        ExcelObj.SetValue_NameCell("T_A13", SumAccAll(8));
        ExcelObj.SetValue_NameCell("T_A14", SumAccAll(9));
        ExcelObj.SetValue_NameCell("T_A15", SumAccAll(10));
        ExcelObj.SetValue_NameCell("T_A16", SumAccAll(11));

        ExcelObj.SetValue_NameCell("T_F1", String({curdate}:f) + "    " + String(Time()));
        ExcelObj.SetValue_NameCell("T_F2", "___________________   " + String({Name_Oper}));
        ExcelObj.SetValue_NameCell("T_F3", "           (подпись)");
    END;

    if (not ExcelObj.OpenTemplate(TemplateName, false))
        Exit(0, "Не удалось открыть шаблон отчета " + TemplateName);
        return 0;
    end;

    RezSum = ExcelObj.RegisterTable("T_SUM");

    PrintHead();

    if(strlen(Mask) != 0)
        Mask = StrSubst (Mask, "*", "%");
    else
        Mask = "%";
    end;

    cmd = "FROM TABLE (loansuserfunction.turnsaldquery(" + SQLDate(begdate) + ", " + SQLDate(enddate) + ", " + CurCode + ", '" + Mask + "', ";

    if(Chapt == 0)
       cmd = cmd + "'А', ";
    else
       cmd = cmd + "'В', ";
    end;

    if (strlen(UserType) == 0)
        cmd = cmd + "NULL, ";
    else
        cmd = cmd + "'" + UserType + "', ";
    end;

    cmd = cmd + Depart + ", '" + turnsald(F_ZERO_TURN) + "', '" + turnsald(F_ZERO_REST) + "')) tbl where uscrdnum <> ' ' and clientname <> ' ' and length(accountnumber) <> 1 order by 1,2,3;";

    rs = LnGetRecordSet("select substr(accountnumber, 1,3) as acc1, substr(accountnumber, 1,5) as acc2, substr(accountnumber, 6,length(accountnumber)), tbl.* " + cmd);

    SumAcc1(0) = SumAcc1(1) = SumAcc1(2) = SumAcc1(3) = SumAcc1(4) = SumAcc1(5) = SumAcc1(6) = SumAcc1(7) = SumAcc1(8) = SumAcc1(9) = SumAcc1(10) = SumAcc1(11) = $0;
    SumAcc2(0) = SumAcc2(1) = SumAcc2(2) = SumAcc2(3) = SumAcc2(4) = SumAcc2(5) = SumAcc2(6) = SumAcc2(7) = SumAcc2(8) = SumAcc2(9) = SumAcc2(10) = SumAcc2(11) = $0;
    SumAccAll(0) = SumAccAll(1) = SumAccAll(2) = SumAccAll(3) = SumAccAll(4) = SumAccAll(5) = SumAccAll(6) = SumAccAll(7) = SumAccAll(8) = SumAccAll(9) = SumAccAll(10) = SumAccAll(11) = $0;

    if(rs != NULL)
        while(rs.MoveNext())
            if (cb == 0)
                InitProgress(-1, "Обработка лицевых счетов", "Лицевые счета");
            end;

            cb = cb + 1;
            UseProgress(cb);

            IF (rs.Value("inrest", null, V_MONEY) < $0)
               Sum(0) = abs(rs.Value("inrest", null, V_MONEY));
               Sum(1) = abs($0);
            ELSE
               Sum(0) = abs($0);
               Sum(1) = abs(rs.Value("inrest", null, V_MONEY));
            END;

            Sum(2) = abs(rs.Value("deb", null, V_MONEY));
            Sum(3) = abs(rs.Value("cred", null, V_MONEY));

            IF (rs.Value("outrest", null, V_MONEY) < $0)
               Sum(4) = abs(rs.Value("outrest", null, V_MONEY));
               Sum(5) = abs($0);
            ELSE
               Sum(4) = abs($0);
               Sum(5) = abs(rs.Value("outrest", null, V_MONEY));
            END;

            SumRecalc(0) = SumRecalc(1) = SumRecalc(2) = SumRecalc(3) = SumRecalc(4) = SumRecalc(5) = $0;

            IF (turnsald(F_RECALC) == "X")
                RecalcCurRate = GetRate(EndDate, CurCode);
                SumRecalc(0) = MoneyL(round(Sum(0) * RecalcCurRate));
                SumRecalc(1) = MoneyL(round(Sum(1) * RecalcCurRate));
                SumRecalc(2) = MoneyL(round(Sum(2) * RecalcCurRate));
                SumRecalc(3) = MoneyL(round(Sum(3) * RecalcCurRate));
                SumRecalc(4) = MoneyL(round(Sum(4) * RecalcCurRate));
                SumRecalc(5) = MoneyL(round(Sum(5) * RecalcCurRate));
            END;

            if (Account != rs.Value("accountnumber", NULL, V_STRING))
                SumAccAll(0) = SumAccAll(0) + Sum(0);
                SumAccAll(1) = SumAccAll(1) + SumRecalc(0);
                SumAccAll(2) = SumAccAll(2) + Sum(1);
                SumAccAll(3) = SumAccAll(3) + SumRecalc(1);
                SumAccAll(4) = SumAccAll(4) + Sum(2);
                SumAccAll(5) = SumAccAll(5) + SumRecalc(2);
                SumAccAll(6) = SumAccAll(6) + Sum(3);
                SumAccAll(7) = SumAccAll(7) + SumRecalc(3);
                SumAccAll(8) = SumAccAll(8) + Sum(4);
                SumAccAll(9) = SumAccAll(9) + SumRecalc(4);
                SumAccAll(10) = SumAccAll(10) + Sum(5);
                SumAccAll(11) = SumAccAll(11) + SumRecalc(5);
            end;

            PrintSumAcc2();
            PrintSumAcc1();
            PrintSum();
            IsHead = false;
        END;
   END;
   if (cb > 0)
       RemProgress();
   end;

   if (acc2 != "")
       acc2 = NULL;
       PrintSumAcc2();
   end;
   if (acc1 != "")
       acc1 = NULL;
       PrintSumAcc1();
   end;

   PrintEnd();

   if (cb > 0)
       ExcelObj.SaveAsTemplate(NULL, true);
   else
       ExcelObj.Close();
   end;

  return cb;
END;

private macro SelectScroll(Query, Header, Status, x, y /*...*/)
    var rs     = RsdRecordset(Query, NULL, RSDVAL_STATIC),
        Column = TArray(),
        i, ColumnValue, ColumnName, NumColumns = 0;

  macro EvProc(rs, cmd, id, key)
      if ((cmd == DLG_KEY)and(key == 13))
          if (rs.RecCount > 0)
              return CM_SELECT;
          end;
      end;
      return CM_DEFAULT;
  end;
    
  macro AddColumn(ar,ind, fld, head)
      ar.value( ind * 6 + 0 ) = fld;
      ar.value( ind * 6 + 1 ) = head;
      ar.value( ind * 6 + 2 ) = NULL;
      ar.value( ind * 6 + 3 ) = 2;
      ar.value( ind * 6 + 4 ) = NULL;
      ar.value( ind * 6 + 5 ) = 0;
      NumColumns = NumColumns + 1;
  end;

    i = 5;
    while (GetParm(i, ColumnValue)and(GetParm(i+1, ColumnName)))              
       AddColumn( Column, NumColumns, ColumnValue, ColumnName );
       i = i + 2;
    end;   
  
    if (RunScroll(rs, NumColumns, Column, NULL, @EvProc, Header, Status, true, x, y, 40, 25))
        return rs;
    end;

    return NULL;
end;

// Выбор филиала
MACRO SetDepart(d, isinit)
    ARRAY ID;
    ARRAY NAME;
    var rs = null, rs2 = null, query = "";

    VAR i:integer = 0,
        cb:integer = 0;

    if({RSL_TOOLS_VERSION} < 4049)
        rs2 = LnGetRecordSet(" select T_Code, T_NAME " + 
                            " from ddp_dep_dbt");   
        if ((rs2 != null) and rs2.MoveNext)
             ID(cb) = rs2.Value("T_Code", null, V_INTEGER);
             NAME(cb) = rs2.Value("T_Name", null, V_STRING);
             cb = cb + 1;
             while(rs2.MoveNext) 
                 ID(cb) = rs2.Value("T_Code", null, V_INTEGER);
                 NAME(cb) = rs2.Value("T_Name", null, V_STRING);
                 cb = cb + 1;
            end;
        end;          
    else
        query =query +"  SELECT dp.t_code, pt.t_shortname";
        query =query +"    FROM dparty_dbt pt, ddp_dep_dbt dp";
        query =query +"   WHERE pt.t_partyid = dp.t_partyid";
        query =query +"     AND dp.t_code IN (SELECT     t_code";
        query =query +"                             FROM ddp_dep_dbt";
        query =query +"                       CONNECT BY PRIOR t_code = t_parentcode";
        query =query +"                       START WITH t_code = ";
        rs = LnGetRecordSet(query + {ФИЛИАЛ} + ")");
        if ((rs != null) and rs.MoveNext)
            ID(cb) = rs.Value(0, null, V_INTEGER);
            NAME(cb) = rs.Value(1, null, V_STRING);
            cb = cb + 1;
            while(rs.MoveNext) 
                ID(cb) = rs.Value(0, null, V_INTEGER);

                // текущий филиал
                if(rs.Value(0, null, V_INTEGER) == {ФИЛИАЛ})
                   i = cb;
                end;

                NAME(cb) = rs.Value(1, null, V_STRING);
                cb = cb + 1;
            end;
        end;
    end;

    if (isinit == false)
       i = Menu(NAME, AllStatus, "Филиал", 26, 3, i);
    end;

    IF (i >= 0)
        Depart = ID(i);
        d(F_DEPART) = NAME(i);
    END;
END;

// Форма отчета
MACRO SetForm(d)
    VAR i:integer;

    i = Menu(FR, AllStatus, "", 24, 6, Form);
    IF (i >= 0)
        Form = i;
        d(F_FORM) = FR(i);
    END;
END;

// Валюта
MACRO SetCurCode(d, f, cur)
  var 
      rs = NULL,
      Query = "select fi.t_fiid, fi.t_ccy, t_name from dfininstr_dbt fi where fi.t_fi_kind = 1 and fi.t_avoirkind = 0";

    rs = SelectScroll(Query, "Валюта", AllStatus, 24, 0, "t_ccy", "Код", "t_name", "Наименование");

    IF (rs != NULL)
        SetParm(2, rs.value("t_fiid"));
    END;
END;

// Тип периода
MACRO SetTypePeriod(d, init)
    VAR i:integer;
    VAR day:integer,
        m:integer,
        y:integer;

    if (init)
        i = TypePeriod;
    else
        i = Menu(TP, AllStatus, "", 24, 8, TypePeriod);
    end;

    IF (i >= 0)
        TypePeriod = i;
        d(F_TYPE_PERIOD) = TP(i);

        DateSplit({curdate}, day, m, y);

        IF (i == 0)
            d(F_TYPEPERIOD_NAME) = " ";
            TypePeriodName = -1;
            d(F_YEAR) = " ";
            Year = -1;
            BegDate = EndDate = {curdate};
        ELIF (i == 1)
            d(F_TYPEPERIOD_NAME) = " ";
            TypePeriodName = -1;
            d(F_YEAR) = " ";
            Year = -1;
            BegDate = EndDate = {curdate};
        ELIF (i == 2)
            d(F_TYPEPERIOD_NAME) = MN(m-1);
            TypePeriodName = m-1;
            d(F_YEAR) = String(y);
            Year = y;
            BegDate = date(1, m, y);
            EndDate = DateAfterCalenMonths(BegDate, 1) - 1;
        ELIF (i == 3)
            day = Int((m - 1) / 3) + 1;
            d(F_TYPEPERIOD_NAME) = KV(day - 1);
            TypePeriodName = day - 1;
            d(F_YEAR) = String(y);
            Year = y;
            BegDate = date(1, (day-1)*3+1, y);
            EndDate = DateAfterCalenMonths(BegDate, 3) - 1;
        ELIF (i == 4)
            d(F_TYPEPERIOD_NAME) = " ";
            TypePeriodName = -1;
            d(F_YEAR) = String(y);
            Year = y;
            BegDate = date(1, 1, y);
            EndDate = date(31, 12, y);
        END;

        d(F_PERIOD1) = String(BegDate:f);
        d(F_PERIOD2) = String(EndDate:f);
    END;
END;

// Название типа периода
MACRO SetPeriodName(d)
    VAR i:integer;

    IF (TypePeriod == 2)
        i = Menu(MN, AllStatus, "", 43 , 12);
        IF (i >= 0)
            d(F_TYPEPERIOD_NAME) = MN(i);
            BegDate = date(1, i+1, Year);
            EndDate = DateAfterCalenMonths(BegDate, 1) - 1;
           d(F_PERIOD1) = String(BegDate:f);
           d(F_PERIOD2) = String(EndDate:f);
        END;
    ELIF (TypePeriod == 3)
        i = Menu(KV, AllStatus, "", 43, 12);
        IF (i >= 0)
            d(F_TYPEPERIOD_NAME) = KV(i);
            BegDate = date(1, i*3+1, Year);
            EndDate = DateAfterCalenMonths(BegDate, 3) - 1;
            d(F_PERIOD1) = String(BegDate:f);
            d(F_PERIOD2) = String(EndDate:f);
        END;
    ELSE
        d(F_TYPEPERIOD_NAME) = " ";
    END;
END;

// Год
MACRO SetYear(d);
    VAR i:integer = Year;
    VAR day:integer,
        m:integer,
        y:integer;

    IF (GetInt(i, "Введите год", 4))
        Year = i;
        d(F_YEAR) = String(Year);
        DateSplit(BegDate, day, m, y);
        BegDate = date(day, m, Year);
        DateSplit(EndDate, day, m, y);
        EndDate = date(day, m, Year);
        d(F_PERIOD1) = String(BegDate:f);
        d(F_PERIOD2) = String(EndDate:f);
    END;
END;

// Период
MACRO SetPeriod(d, f)
   IF (f == F_PERIOD1)
       if ((TypePeriod == 0) OR
           (TypePeriod == 1))
           if (GetDate(BegDate, "Введите дату"))
               EndDate = BegDate;
               d(F_PERIOD1) = String(BegDate:f);
               d(F_PERIOD2) = String(EndDate:f);
           end;
       end;
   ELIF (f == F_PERIOD2)
       if (TypePeriod == 1)
           if (GetDate(EndDate, "Введите дату"))
               d(F_PERIOD2) = String(EndDate:f);
               if (EndDate < BegDate) 
                   BegDate = EndDate;
                   d(F_PERIOD1) = String(BegDate:f);
               end;
           end;
       end;
   END;
END;

// Типы Кредита
MACRO SetTypeCrd(d, f, CurCode)
  var
      crdSelect = 0, sql = "", ID = 0;

     УстановитьВидыКредитов (0, CurCode);
     TypeCrdTmp.rewind();
     while(TypeCrdTmp.next())
        if ((TypeCrdTmp.rec.SetFlag == "X") and
            (TypeCrdTmp.rec.CurCode == CurCode))
           ID = TypeCrdTmp.rec.CreditTypeID_Ref;
           crdSelect = crdSelect + 1;
        end;
     end;

    if (crdSelect == 1)
        d(f) = LnSelectValue("select t_CreditTypeName from dtype_crd_dbt where t_CreditTypeID = " + ID, V_STRING);
    elif (crdSelect > 1)
        d(f) = "Несколько";
    else
        d(f) = "";
    end;

    sql = "delete from dset_tcr_tmp where t_SetFlag <> 'X'";
    LnSqlExec(sql);

    RETURN TRUE;
END;

MACRO Inizial_client
    VAR  i:integer = 0,  retval = "";
    ARRAY ID;
    var  sql, sql_1, sql1_1, sql2_1, str, rs;

    LnGetRecordSet("delete from dset_cln_tmp");

    sql = "insert into  dset_cln_tmp (T_CODCLIENT, T_SETFLAG, T_CLIENTNAME)";
    sql = sql + " select  dparty_dbt.t_PartyId, 'X', dparty_dbt.t_Name ";
    sql = sql + " from dparty_dbt where dparty_dbt.t_Locked = chr(0) and dparty_dbt.T_LEGALFORM = 2 ";
    sql = sql + " union ";
    sql = sql + " select  dparty_dbt.t_PartyId, 'X', dparty_dbt.t_Name ";
    sql = sql + " from dparty_dbt, dpartyown_dbt where dpartyown_dbt.t_PartyKind = 1 and dpartyown_dbt.t_SubKind = 0 and dpartyown_dbt.t_PartyID = dparty_dbt.t_PartyId";

    rs = LnGetRecordSet(sql);

    SetCln = "X";
    return ALL;                  
END; 

// Клиенты
MACRO SetClient(d)
    VAR i:integer = 0, iall:integer = 0, CodClient:integer = 0;
    var  sql;

    DepClnt.SetListClient(0);
    ClientTmp.ReWind();
    WHILE(ClientTmp.Next())
        IF (ClientTmp.rec.SetFlag == "X")
            CodClient = ClientTmp.rec.CodClient;
            i = i + 1;
        END;
        iall = iall + 1;
    END;
    IF (i == 0)
        d(F_CLIENT) = "";
        SetCln = " ";
    ELIF (i == 1)
        d(F_CLIENT) = FindFullClient (CodClient, false);
        SetCln = "X";
    ELIF (i == iall)
        d(F_CLIENT) = ALL;
        SetCln = "X";
    ELSE
        d(F_CLIENT) = "Несколько";
        SetCln = "X";
    END;

    sql = "delete from dset_cln_tmp where t_SetFlag <> 'X'";
    LnSqlExec(sql);
END;
// Баланс или внебаланс
MACRO SetChapt(d)
    VAR i:integer;

    i = Menu(CH, AllStatus, "Глава счетов", 29, 21, Chapt);
    IF (i >= 0)
        Chapt = i;
        d(F_CHAPTER) = CH(i);
    END;
END;

MACRO Inizial_KU(isMask)
    if (isMask == "X")
        LnSqlExec("INSERT INTO dset_tacc_tmp ( T_TypeName, T_TypeAccNumber, T_SetFlag) SELECT t_NameTypeAccount, t_TypeAccCred, 'X' FROM dtaccred_dbt");
    else
        LnSqlExec("delete from dset_tacc_tmp");
    end;
END; 

// Установить категорию учета
MACRO SetKU (d, f)
    VAR i:integer = 0, sql = "";

    УстановитьТипыСчетов ();
    TypeAccTmp.ReWind();
    WHILE (TypeAccTmp.Next() AND (i < 2))
        IF (TypeAccTmp.rec.SetFlag == "X")
            i = i + 1;
            d(f) = TypeAccTmp.rec.TypeName;
        END;
    END;
    IF (i == 0)
        d(f) = "";
    ELIF (i > 1)
        d(f) = "Несколько";
    END;

    sql = "delete from dset_tacc_tmp where t_SetFlag <> 'X'";
    LnSqlExec(sql);
END;

PRIVATE MACRO EnDisFields(d, ID)
    IF (ID == F_RECALC)
        if (CurCode == NATCUR)
            d(F_RECALC) = ReCalc = " ";
            DisableFields(d, F_RECALC);
        else
            EnableFields(d, F_RECALC);
        end;
    ELIF (ID == F_TYPEPERIOD_NAME)
        if ((TypePeriod == 0) OR
            (TypePeriod == 1) OR
            (TypePeriod == 4))
            d(F_TYPEPERIOD_NAME) = " ";
            DisableFields(d, F_TYPEPERIOD_NAME);
        else
            EnableFields(d, F_TYPEPERIOD_NAME);
        end;
    ELIF (ID == F_YEAR)
        if ((TypePeriod == 0) OR
            (TypePeriod == 1))
            DisableFields(d, F_YEAR);
        else
            EnableFields(d, F_YEAR);
        end;
    ELIF (ID == F_PERIOD1)
        if ((TypePeriod == 2) OR
            (TypePeriod == 3) OR
            (TypePeriod == 4))
            DisableFields(d, F_PERIOD1);
        else
            EnableFields(d, F_PERIOD1);
        end;
    ELIF (ID == F_PERIOD2)
        if ((TypePeriod == 0) OR
            (TypePeriod == 2) OR
            (TypePeriod == 3) OR
            (TypePeriod == 4))
            DisableFields(d, F_PERIOD2);
        else
            EnableFields(d, F_PERIOD2);
        end;
    ELIF (ID == F_MASK)
        if (d(F_KU_FLAG) == "X")
            d(F_MASK_FLAG) = " ";
            d(F_MASK) = "";
            DisableFields(d, F_MASK);
            EnableFields(d, F_KU);
        else
            EnableFields(d, F_MASK);
            DisableFields(d, F_KU);
        end;
    ELIF (ID == F_KU)
        if (d(F_MASK_FLAG) == "X")
            d(F_KU_FLAG) = " ";
            d(F_KU) = "";
            DisableFields(d, F_KU);
            EnableFields(d, F_MASK);
        else
            EnableFields(d, F_KU);
            DisableFields(d, F_MASK);
        end;
    END;
END;

MACRO DialogMesProc (d,      m,     f,     k)
    IF (m == DLG_INIT) /* инициализация панели */
        GetFieldsNumber(d);

        d(F_DEPART)      = ALL;                                 /* филиал            */
        SetDepart(d, true);
        d(F_FORM)        = FR(Form);                            /* форма отчета      */
        d(F_CURR)        = FindShortName(CurCode);              /* валюта            */
        d(F_RECALC)      = ReCalc;                              /* пересчет (валюта) */
        EnDisFields(d, F_RECALC);
        SetTypePeriod(d, true);                                 /* тип периода       */
        EnDisFields(d, F_TYPEPERIOD_NAME);
        EnDisFields(d, F_YEAR);
        EnDisFields(d, F_PERIOD1);
        EnDisFields(d, F_PERIOD2);
        d(F_TYPECRD)     = " ";                                 /* вид кредита       */
        d(F_USERTYPE)    = UserType;
        d(F_CLIENT)      = Inizial_client;                      /* клиент            */
        d(F_CHAPTER)     = CH(Chapt);                           /* глава счетов      */
        d(F_MASK_FLAG)   = " ";
        d(F_KU_FLAG)     = "X";
        Inizial_KU(d(F_MASK_FLAG));
        EnDisFields(d, F_MASK);
        EnDisFields(d, F_KU);
        d(F_MASK)        = Mask;                                /* маска счета       */
        d(F_KU)          = "";                                  /* категория учета   */

        UpdateFields(d);
        SetFocus(d, 0);
    ELIF (m == DLG_SETFOCUS) /* фокусировка на поле */
        IF ((f == F_DEPART)  OR
            (f == F_TYPECRD) OR
            (f == F_CLIENT))
            Message("~Esc~ Выход  ~F3~ Список  ~Space~ Все  ~F2~ Продолжить");
        ELIF ((f == F_FORM)            OR
              (f == F_CURR)            OR
              (f == F_TYPE_PERIOD)     OR
              (f == F_TYPEPERIOD_NAME) OR
              (f == F_CHAPTER)         OR
              (f == F_KU))
            Message("~Esc~ Выход  ~F3~ Список  ~F2~ Продолжить");
        ELIF ( (f == F_USERTYPE) OR
               (f == F_PERIOD1)   OR
               (f == F_PERIOD2))
            Message("~Esc~ Выход  ~F3~ Значение  ~F2~ Продолжить");
        ELIF ((f == F_RECALC)             OR
              (f == F_MASK_FLAG)          OR
              (f == F_KU_FLAG)            OR
              (f == F_COLUMN_ORD)         OR
              (f == F_COLUMN_CLIENT)      OR
              (f == F_COLUMN_NAMEACCOUNT) OR
              (f == F_ZERO_REST)          OR
              (f == F_ZERO_TURN))
            Message("~Esc~ Выход  ~Space~ Установить  ~F2~ Продолжить");
        ELSE
            Message(AllStatus);
        END;
    ELIF (m == DLG_KEY)  /* обработка клавиш */
        IF (k == ESC)
            RETURN CM_CANCEL;
        ELIF (k == F2)
            if(CurCode == -1)
                LoansError("Не задана валюта.");
                return 0;
            End;
            if ((d(F_KU_FLAG) == "X") AND
                (strlen(d(F_KU)) == 0))
                LoansError("Не задана категория учета");
                return 0;
            End;

            if (SetCln != "X")
                LoansError("Не выбран ни один клиент");
                return 0;
            End;

            // LPS SCR 184192
            if ( d(F_TYPECRD) == " " )
                LoansError("Не задан вид кредита");
                return 0;
            End;

            Mask = d(F_MASK);

            if (PrintReport() == 0)
                LoansError("Отсутствуют лицевые счета, удовлетворяющие параметрам отчета");
                return 0;
            else
                RETURN CM_SAVE;
            end;
        ELIF (k == F3)
            IF (f == F_DEPART)
                SetDepart(d, false);
            ELIF (f == F_FORM)
                SetForm(d);
            ELIF (f == F_CURR)
                  SetCurCode(d, f, CurCode);
                  PrevCurCode = CurCode;
                  d(F_CURR)   = FindShortName(CurCode);
                  EnDisFields(d, F_RECALC);
                  UpdateFields(d);
            ELIF (f == F_TYPE_PERIOD)
                SetTypePeriod(d, false);
                EnDisFields(d, F_TYPEPERIOD_NAME);
                EnDisFields(d, F_YEAR);
                EnDisFields(d, F_PERIOD1);
                EnDisFields(d, F_PERIOD2);
                UpdateFields(d);
            ELIF (f == F_TYPEPERIOD_NAME)
                SetPeriodNAME(d);
                UpdateFields(d);
            ELIF (f == F_YEAR)
                SetYear(d);
                UpdateFields(d);
            ELIF ((f == F_PERIOD1) OR
                  (f == F_PERIOD2))
                SetPeriod(d, f);
                UpdateFields(d);
            ELIF (f == F_TYPECRD)
                SetTypeCrd(d, f, curCode);
                UpdateFields(d);
            ELIF (f == F_USERTYPE)
                UserType = Loans_UserTypeCredit(UserType);
                d(F_USERTYPE) = UserType;
                UpdateFields(d);
            ELIF (f == F_CLIENT)
                SetClient(d);
                UpdateFields(d);
            ELIF (f == F_CHAPTER)
                SetChapt(d);
                UpdateFields(d);
            ELIF (f == F_KU)
                SetKU (d, f);
            END;
        ELIF (k == SPACE)
            IF (f == F_DEPART)
                d(f) = ALL;
                Depart = -1;
            ELIF (f == F_RECALC)
                if(ReCalc == "X") ReCalc = " "; else ReCalc = "X"; end;
                d(f) = ReCalc;
            ELIF (f == F_MASK_FLAG)
                if(d(F_MASK_FLAG) == " ")
                    d(F_MASK_FLAG) = "X";
                    Inizial_KU(d(F_MASK_FLAG));
                end;
                EnDisFields(d, F_KU);
                UpdateFields(d);
            ELIF (f == F_KU_FLAG)
                if(d(F_KU_FLAG) == " ")
                    d(F_KU_FLAG) = "X";
                    Inizial_KU("");
                end;
                EnDisFields(d, F_MASK);
                UpdateFields(d);
            ELIF ((f == F_COLUMN_ORD)         OR
                  (f == F_COLUMN_CLIENT)      OR
                  (f == F_COLUMN_NAMEACCOUNT) OR
                  (f == F_ZERO_REST)          OR
                  (f == F_ZERO_TURN))
                if(d(f) == "X") d(f) = " "; else d(f) = "X"; end;
                UpdateFields(d);
            END;
        END;
    ELSE
        RETURN CM_DEFAULT;
    END;
END;

// Задать параметры отчета
MACRO GetParam()
    FR(0) = "Оборотная ведомость";
    FR(1) = "Сальдовая ведомость";
    FR(2) = "Оборотно-сальдовая ведомость";

    TP(0) = "День";
    TP(1) = "Интервал дат";
    TP(2) = "Месяц";
    TP(3) = "Квартал";
    TP(4) = "Год";

    KV(0) = "1-й квартал";
    KV(1) = "2-й квартал";
    KV(2) = "3-й квартал";
    KV(3) = "4-й квартал";

    MN(0) = "январь";
    MN(1) = "февраль";
    MN(2) = "март";
    MN(3) = "апрель";
    MN(4) = "май";
    MN(5) = "июнь";
    MN(6) = "июль";
    MN(7) = "август";
    MN(8) = "сентябрь";
    MN(9) = "октябрь";
    MN(10) = "ноябрь";
    MN(11) = "декабрь";

    CH(0) = "A. Балансовые счета";
    CH(1) = "B. Внебалансовые счета";

    IF (NOT RunDialog (turnsald, "DialogMesProc"))
        Exit(1);
    END;
END;

MACRO Report()
    GetParam();
END;

Report();
exit(1);
