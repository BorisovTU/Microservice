/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ChkNum.mac
 Description : Макрос инициализации, проверки кредитных объектов
------------------------------------------------------------------------------*/
import "total.mac", RsbDataSet;

record СтарыйБуфер ("credit_c.dbt", "loans.def");  /* Буфер до обновления/вставки */
record Буфер       ("credit_c.dbt", "loans.def");  /* Текущий буфер               */

PRIVATE MACRO CalcUsCredNumCount(UsCredNum, Crd_Kind, CredNum, FNC)
   VAR FCash: integer = {OperDprt};

   // TFS 
   IF ((ValType(FNC) == V_INTEGER) AND (FNC > 0))
      FCash = FNC;
   END;


   RETURN CRsdCommand("SELECT COUNT(1) FROM DCREDIT_C_DBT WHERE T_USCREDITNUMBER = ? AND T_CRD_KIND = ? AND T_CREDITNUMBER <> ? AND T_FNCASH = ?", 
                      "USNAME",  UsCredNum, 
                      "CRDKIND", Crd_Kind,
                      "CREDNUM", CredNum,
                      "FCash",   FCash,
                     V_INTEGER);
END;

PRIVATE MACRO ВО(ObjID: integer)
RETURN CRsdCommand("SELECT T_SHORTNAME FROM DLOBJECT_DBT WHERE T_OBJECTID = ?", "SHORTNAME", ObjID, V_STRING);
END;

PRIVATE MACRO CheckNum()
   IF (CalcUsCredNumCount(Буфер.USCREDITNUMBER, Буфер.CRD_KIND, Буфер.CREDITNUMBER, Буфер.FNCASH))
      LoansError("Дублируется номер объекта ", ВО(Буфер.CRD_KIND));
      Return FALSE;
   END;
   Return true;
end;

macro __Init__()
    return true;
end;

macro __Check_Input__ ()
   if( CheckNum() == false)
      return false;
   end;

   if(Буфер.CRD_KIND == LO_KARTA)       
      if(Буфер.ReturnDate < getCardEndDate(Буфер.Branch, Буфер.RetailKarta))
         if (NOT GetTrue(TRUE, "Дата окончания договора в Loans меньше даты окончания действия карты в Retail! | "+
                                      "Продолжить открытие договора?"))
            return false;
         end;
      end;
   end;
   return true;
end;

macro __Check_Edit__ ()
    if( CheckNum() == false)
       return false;
    end;

    if(Буфер.CRD_KIND == LO_KARTA)       
       if(Буфер.ReturnDate < getCardEndDate(Буфер.Branch, Буфер.RetailKarta))
          if (NOT GetTrue(TRUE, "Дата окончания договора в Loans меньше даты окончания действия карты в Retail! | "+
                                       "Продолжить открытие договора?"))
             return false;
          end;
       end;
    end;
    return true;
end;

macro __Check_Delete__ ()
    return true;
end;

MACRO CheckPayBeforeInsertOp (OpDate: date, SumOp: money, TypeOp: integer, ObjectTypeID: integer)
 
   return true;
END;
