/*
$Name:             calcsc01.mac
$Module:           Кредитование
$Description:      Отчет - результаты скоринга
*/
IMPORT ActiveX, total, lclient, replib, scoring;

private record claim ("claim.dbt", "loans.def");
private file  crtype ("type_crd.dbt", "loans.def");
private record cur_credit ("credit_c", "loans.def");

private var client = TLoansClient;
private CONST TemplateName = "ScrConcl.xls";

macro PrintLoansReport (ClaimBuf, FromWeb)

      if (FromWeb == true)
          return "";
      end;

   var axerr:object = null, k, SelectedCell, СрокДоговораЛет, СуммаМРК;

   SetBuff(claim, ClaimBuf);

   if (not client.GetRecord(claim.LoanerID_Ref))
       MsgBoxEx("Не найден заемщик в справочнике клиентов");
       Exit(1);
   end;

   if (client.LegalForm != 2)
       MsgBoxEx("Отчет выпускается только по физическим лицам.");
       Exit(1);
   end;

   if (not Скоринг(claim.ClaimID, {curdate}))
      return false;
   end;

   if (not NewExcelWorkbook (true, TemplateName))
      return false;
   end;

   ActiveSheet.Range("FIO").Value = client.ConvertFIOFull();
   ActiveSheet.Range("Address").Value = client.Address;
   ActiveSheet.Range("Passport").Value =
     "серии " + trim(client.PaperSeries) + " № "
     + trim(client.PaperNumber) + " выдан " + trim(client.PaperIssuer)
     + " " + trim(client.PaperIssuedDate);

   ActiveSheet.Range("v_Р0").Value = double(v_Р0);
   ActiveSheet.Range("v_I").Value = double(v_I);
   ActiveSheet.Range("v_N").Value = v_N;

   ActiveSheet.Range("v_A1").Value = double(v_A1);
   ActiveSheet.Range("v_A2").Value = double(v_A2);
   ActiveSheet.Range("v_A3").Value = double(v_A3);
   ActiveSheet.Range("v_A4").Value = double(v_A4);
   ActiveSheet.Range("v_A5").Value = double(v_A5);
   ActiveSheet.Range("v_A6").Value = double(v_A6);
   ActiveSheet.Range("v_A7").Value = double(v_A7);
   ActiveSheet.Range("v_A8").Value = double(v_A8);

   ActiveSheet.Range("v_K1").Value = v_K1;
   ActiveSheet.Range("v_K2").Value = v_K2;
   ActiveSheet.Range("v_K3").Value = v_K3;

   ActiveSheet.Range("v_S1").Value = double(v_S1);
   ActiveSheet.Range("v_S2").Value = double(v_S2);
   ActiveSheet.Range("v_SUMCRED").Value = double(v_SUMCRED);
   ActiveSheet.Range("v_LI").Value = double(v_LI);
   ActiveSheet.Range("v_G").Value = double(v_G);
   ActiveSheet.Range("v_V").Value = double(v_V);

   ActiveSheet.Range("v_C").Value = double(v_С);
   ActiveSheet.Range("v_T").Value = double(v_Т);
   ActiveSheet.Range("v_X").Value = double(moneyl((v_С - v_Т) * v_Х_perc) );

   ActiveSheet.Range("v_Duration").Value =  claim.LCreditDuration;
   ActiveSheet.Range("v_ENDSUM").Value = double(min(v_V, v_SUMCRED));

   ActiveSheet.Range("v_DATE").Value = {curdate};

   ActiveSheet.Range("НАЛИЧИЕ_БАНКСЧЕТА").Value = НаличиеБСС;

   //Exit(1);

   onError (axerr)
      ExcelError(axerr);
      return 1;
END;
