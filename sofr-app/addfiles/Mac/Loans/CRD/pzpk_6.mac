/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pzpk_6.mac
 Description : Создание документа по шагу операции (Погашение просроч. % (опред. доход))

 Programmer  : Zigel Petr
 07.10.08    : Создан
-----------------------------------------------------------------------------------*/

import macperc, SbCrdInter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var DocID : integer = 0;
   var stat  : integer = 0;
   var Sпprпб, Sprп, Sprпвб, Sпрн1, Sprпб, Sпт1, Sпр1, Sппт1;

   SetBuff (DutyData, Data);  
   Документ.InDocID = DutyData.PaymentID;

   IF (НадежныйДоговор (Договор.CreditNumber, Договор.Crd_kind, OperDate))
      Sпт1 = ОстатокРегистра (Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_ACQ, OperDate);
      Sпр1 = GetPaySum (DS_EXPPERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);

      Документ.CarrySum = max (0, Sпр1 - min (Sпр1, Sпт1));
      stat = СоздатьДокумент (Документ, DocID);
      
      if (stat == 0)
         stat = ИзменитьРегистр (Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC, 0, -Документ.CarrySum, Операция.CredOperID);
      end;
   ELSE
      Sprп = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC,     OperDate) -
             ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_ACQ, OperDate);

      Sprпвб = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_VN, OperDate);
      
      Sprпб = Sprп - Sprпвб;
      if(Sprпб != $0)
         Sпт1 = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_ACQ, OperDate);
         Sпр1 = GetPaySum(DS_EXPPERC,Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
         Sппт1= min(Sпр1, Sпт1);
         Sпрн1= Sпр1  - Sппт1;
         if(Sпрн1 < 0)
           Sпрн1 = 0;
         end;
         Sпprпб = min(Sпрн1, Sprпб);
         Документ.CarrySum = Sпprпб;
         stat = СоздатьДокумент(Документ, DocID);
         if(stat == 0)
            stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC, 0, -Документ.CarrySum, Операция.CredOperID);
         end;
      end;
   END;

   return stat;
end;
