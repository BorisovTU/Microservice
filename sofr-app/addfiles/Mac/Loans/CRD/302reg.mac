/*---------------------------------------------------------------------------------

 Filename    : 302REG.mac
 Description : пункт меню:  Работа/пакетный режим/переход на 302-П/Привязка новых регистров

 Programmer  : Sviridenko
 22.11.07
-----------------------------------------------------------------------------------*/

IMPORT total, SbCrdInter;

/*******************************************************************
 * Добавить недостающие регистры к типу обьекта                    *
 * Вход: тип обьекта , массив регистров                            *
 * Функция проверяет наличие переданных регистров в связках        *
 * Если переданных регистров нет - добавляет в связку недостающие  *
 * Функция иллюстрирует прогресс выполнения для каждого регистра   *
 *******************************************************************/

MACRO AddNewRegisterSetToObject(ObjectID, RegisterSet, ObjectName, quarry)

VAR query;
VAR i = 1,total,count;

  if ( RegisterSet[1] == V_UNDEF )
    MsgBox("Не заданы ригистры для привязки");
    return;
  end;


  while (ValType(RegisterSet[i]) != V_UNDEF)
     i = i + 1;
  end;

  count = i-1;

  i = 1;
  InitProgress (count, "~Alt-Break~ - Прервать", "Привязка новых регистров для:"+ObjectName);
  while (ValType(RegisterSet[i]) != V_UNDEF)
     UseProgress (i-1);

     IF (ObjectID == LO_DUTY)
        query = " INSERT INTO DLCUSREG_DBT (T_ID, T_OBJECTTYPEID, T_OBJECTNUMBER, T_REGID) "
                "                   SELECT     0,              6,       T_DUTYID, "+RegisterSet[i]
                                   +" FROM DDUTY_CRD_DBT WHERE (T_DUTYID, 6) NOT IN " +
                                        "( SELECT T_OBJECTNUMBER, T_OBJECTTYPEID " +
                                        "    FROM  DLCUSREG_DBT " +
                                        "   WHERE  T_REGID IN ( "+RegisterSet[i]+" ) " +
                                        "     AND  T_OBJECTTYPEID = 6  "
                                        "     AND  T_OBJECTNUMBER = T_DUTYID ) "
     ELSE
        query = " INSERT INTO DLCUSREG_DBT (T_ID, T_OBJECTTYPEID,                  T_OBJECTNUMBER, T_REGID) "
                "                      SELECT 0,     T_CRD_KIND AS  OBJECTTYPEID, T_CREDITNUMBER, "+RegisterSet[i]+
                "                        FROM DCREDIT_C_DBT "                               +
                "                       WHERE T_CRD_KIND = "+ ObjectID                  +
                "                         AND (T_CREDITNUMBER, T_CRD_KIND ) NOT IN    "     +
                "                             ( SELECT T_OBJECTNUMBER, T_OBJECTTYPEID "     +
                "                                 FROM DLCUSREG_DBT                   "     +
                "                                WHERE T_REGID IN ( "+RegisterSet[i]+" )"   +
                "                                  AND T_OBJECTTYPEID = T_CRD_KIND   "      +
                "                                  AND T_OBJECTNUMBER = T_CREDITNUMBER ) ";

     END;
     LnSqlExec(query);
     i = i + 1;
  end;
  RemProgress ();

END;

array КД,БК,СО,ОВ,ДГ,ГС,ГСО;

//Привязка регистров к Кредитным договорам
КД[1] = TDR_CLAIM_VN;
КД[2] = TDR_EXPPERC_VN;
КД[3] = TDR_RESSOURCEKOMISS;
КД[4] = TDR_REZEXPPERC;
AddNewRegisterSetToObject(LO_CREDIT, КД, "Кредитные договора");

//Привязка регистров к срочным обязательствам
СО[1] = TDR_CLAIM_VN;
СО[2] = TDR_EXPPERC_VN;
AddNewRegisterSetToObject(LO_DUTY, СО, "Срочные обязательства");

//Привязка регистров к Банковским гарантиям
ДГ[1] = TDR_PAYMGUARANTEEPERCDEM_VN;
ДГ[2] = TDR_PAYMGUARANTEEEXPPERC_VN;
ДГ[3] = TDR_REZEXPPERC;
AddNewRegisterSetToObject(LO_GUARANTEE, ДГ, "Банковские гарантии");

//Привязка регистров к Договорам овердрафта юр.лиц по расчетным счетам
ОВ[1] = TDR_CLAIM_VN;
ОВ[2] = TDR_EXPPERC_VN;
ОВ[3] = TDR_REZEXPPERC;
AddNewRegisterSetToObject(LO_OVERDRAFT, ОВ, "Договора овердрафта юридических лиц");

//Привязка регистров к договорам кредитов по картам
БК[1] = TDR_CLAIM_VN;
БК[2] = TDR_EXPPERC_VN;
БК[3] = TDR_PERCLIM_VN;
БК[4] = TDR_EXPPERC_OV_VN;
БК[5] = TDR_REZEXPPERC;
AddNewRegisterSetToObject(LO_KARTA, БК, "Договора кредитов по картам");

ГС[1] = TDR_REZEXPPERC;
AddNewRegisterSetToObject(LO_GENAGGR, ГС, "Генеральные соглашения");

ГСО[1] = TDR_REZEXPPERC;
AddNewRegisterSetToObject(LO_GENAGGROV, ГСО, "Генеральные соглашения по договорам овердрафта");
