/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : wroffl2.mac
 Description : Создание документа при списании невыбранного лимита

 Programmer  : KOE
 28.05.07    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, total;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record Сумма       ("SUM.",         "loans.def");
record lcusreg     ("lcusreg.dbt",  "loans.def");

MACRO ВыполнитьШаг (OperDate, Sum, Data)
   VAR stat = 0;
   VAR Rest:moneyl;
   VAR ОстатокДоступногоЛимита, ЛВ, Нлв, ЛЗ, Нлз: moneyl = $0;
   VAR DocID:integer;
   VAR IsDilatoryCondition: string = "";
   VAR IsGraphSampling: string = "";
   VAR sqlstr = "select T.t_IsDilatoryCondition IsDilatoryCondition, T.t_IsGraphSampling IsGraphSampling "+
                 "from dparmdemandline_dbt T where t.t_ObjectTypeID = ? and t.t_ObjectNumber = ?";
   VAR cmd : RsdCommand;
   VAR rs;
   
   MACRO Common()
      VAR err = 0;
 
      ОстатокДоступногоЛимита = ОстатокРегистра(LO_CREDIT, Договор.CreditNumber, TDR_AVAILABLELIMIT, OperDate);
      ЛВ  = ОстатокРегистра(LO_CREDIT, Договор.CreditNumber, TCLTR_LIMPAY,  OperDate);
      Нлв = ОстатокРегистра(LO_CREDIT, Договор.CreditNumber, TDR_LIMPAY,    OperDate);
      ЛЗ  = ОстатокРегистра(LO_CREDIT, Договор.CreditNumber, TCLTR_LIMDUTY, OperDate);
      Нлз = ОстатокРегистра(LO_CREDIT, Договор.CreditNumber, TDR_LIMDUTY,   OperDate);

      Документ.CarrySum = ОстатокДоступногоЛимита - Сумма(0);
      IF ((err = СоздатьДокумент(Документ, DocID)) != 0)
         RETURN err;
      END;

      IF ((err = ИзменитьРегистр(LO_CREDIT, Договор.CreditNumber, TDR_AVAILABLELIMIT, 0, Сумма(0) - ОстатокДоступногоЛимита)) != 0)
         RETURN err;
      END;

      IF ((err = ИзменитьРегистр(LO_CREDIT, Договор.CreditNumber, TCLTR_LIMDUTY, 0, -Сумма(2))) != 0)
         RETURN err;
      END;

      IF ((err = ИзменитьРегистр(LO_CREDIT, Договор.CreditNumber, TDR_LIMDUTY,   0, -Сумма(2))) != 0)
         RETURN err;
      END;

      IF (Договор.PayType == CF_CRLIN)
         IF ((err = ИзменитьРегистр(LO_CREDIT, Договор.CreditNumber, TCLTR_LIMPAY,  0, -Сумма(1))) != 0)
            RETURN err;
         END;

         IF ((err = ИзменитьРегистр(LO_CREDIT, Договор.CreditNumber, TDR_LIMPAY,    0, -Сумма(1))) != 0)
            RETURN err;
         END;
      END;

      RETURN err;
   END; 

   IF ((Договор.PayType != CF_CRLIN) AND (Договор.PayType != CF_CRLINNEW))
      RETURN 0;
   END;
   
   // Без отлагательных условий
   IF ((IsDilatoryCondition != "X") OR
      // С отлагательными условиями без графика выборки
      ((IsDilatoryCondition == "X") and (IsGraphSampling != "X")) OR
      // С отлагательными условиями с графиком выборки
      ((IsDilatoryCondition == "X") and (IsGraphSampling == "X"))
     )
      setbuff(Сумма, Sum);
 
      RETURN Common();
   END;
   RETURN stat;
END;