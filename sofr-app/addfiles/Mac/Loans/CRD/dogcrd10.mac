/*
$Name:             dogcrd10.mac
$Module:           Кредитование
$Description:      Кредитный договор: Молодая семья
*/
import ActiveX, total, replib, global, CTInter;

private const  TemplateName = "dogcrd10.doc";
private record credit_c     ("credit_c.dbt", "loans.def");
private file   lothdeb      ("lothdeb.dbt",  "loans.def");
private file   party        ("party.dbt",    "bank.def");        
private record othdeb_party ("party.dbt",    "bank.def"); 
private file   Duty1        ("duty_crd.dbt", "loans.def") key 1;
private record cur_credit ("credit_c", "loans.def");
private var ПСК=0;      // ПСК в % годовых
private var ПСКСУММ=$0; // ПСК в денежном эквиваленте

macro CalcPSK()
    var OpDate = credit_c.regdate;
    var precision = 0, ErrCode = 0;
    
    var RSDcmd = RsdCommand(RslDefCon, "BEGIN ? := Loanspercent.GetXirr(?,?,?,?,?,?); END;");
    RSDcmd.addParam("retval",   RSDBP_RETVAL, V_INTEGER);
    RSDcmd.addParam("crd_kind",  RSDBP_IN);     RSDcmd.value("crd_kind")   = credit_c.crd_kind;
    RSDcmd.addParam("creditnumber",  RSDBP_IN); RSDcmd.value("creditnumber")   = credit_c.creditnumber;
    RSDcmd.addParam("calcdate", RSDBP_IN);      RSDcmd.value("calcdate")  = OpDate;
    RSDcmd.addParam("PSK", RSDBP_OUT, V_DOUBLE);
    RSDcmd.addParam("PSKSUM", RSDBP_OUT, V_DOUBLE);
    RSDcmd.addParam("DateCalcPSK", RSDBP_OUT, V_DATE);
    
    RSDcmd.execute();
 
    if (GetRegistryValue ("RS-LOANS\\ПСК\\ТОЧНОСТЬ_РЕЗУЛЬТАТОВ", V_INTEGER, precision, ErrCode) != V_INTEGER)
    msgBox(ErrCode);
    end;
	
    if (precision > 28)
    precision = 28;
    end;
	
    SetDefPrec (precision);
    
    if(RSDcmd.Value("retval") == 1)
      msgBox("По договору не рассчитано значение ПСК на дату начала договора" + OpDate + ". Для вывода формы на печать необходимо его рассчитать!");        
      Exit(1);
    else
      if(RSDcmd.value("DateCalcPSK") == OpDate)
        ПСК = RSDcmd.Value("PSK");
        ПСКСУММ = RSDcmd.Value("PSKSUM"); 
      else
        if (GetTrue(TRUE, "По договору рассчитано значение ПСК на дату" + RSDcmd.value("DateCalcPSK", NULL, V_DATE) + 
                          ", отличную от даты начала договора " + OpDate + ". Выводить на печать форму договора с данным значением ПСК?"))
          ПСК = RSDcmd.Value("PSK");
          ПСКСУММ = RSDcmd.Value("PSKSUM"); 
        else
          Exit(1);
        end;
      end;  
    end;
    
    RSDcmd = null;
    
    onError        
      RunError; 
end;

macro PrintLoansReport(CreditBuf, FromWeb)

    if (FromWeb == true)
        return "";
    end;

    const ФИОПредставителяЗаемщика = 76,
          ДолжностьПредставителяЗаемщика = 77,
          ОснованиеПредставителяЗаемщика = 78,
          ЦельПолученияКредита = 79;

    var TablesCollection:object = null;
    var CurRow:object = null, curCell:object = null,
        CurTable: object = null, row, row_, row__, parents = 0, spouses = 1, i = 2,
        ExtCurCode, ПроцОД, РасчетныйСчет, DutyIsFound:bool = false, ИД_Основного = 0;               
    var axerr:object = null,
        ФИО                 :string = "",
        ФИО_вкратце         :string = "",
        ФИО_основного       :string = "",
        ФИО_супругов        :string = "",
        ФИО_родителей       :string = "",
        ФИО_всех_супругов   :string = "",
        Адреса_и_реквизиты1 :string = "",
        Адреса_и_реквизиты2 :string = "",
        Адреса_и_реквизиты3 :string = "",
        Адреса_и_реквизиты4 :string = "";

    var Sum, Rub, Kop;

    SetBuff(credit_c, CreditBuf);

    if (not depclnt.GetRecord(credit_c.ClientID_Ref))
        MsgBox ("ОШИБКА: не найден заемщик в справочнике клиентов");
        Exit(1);
    end;

    if(credit_c.PayType != CF_BEFOREMATURITY)
        /* Текущее (последнее) срочное обязательство */                                              
        ClearRecord (Duty1);                                                                         
        Duty1.CreditNumber_Ref = credit_c.CreditNumber;                                              
        Duty1.DutyState = credit_c.CreditState;                                                      
        IF (GetEQ(Duty1))
            DutyIsFound = true;
        ELSE
            if(credit_c.PayType != CF_NONREP)
                MsgBox ("ОШИБКА: не найдено срочное обязательство по договору № " + credit_c.UsCreditNumber);
                Exit(1);
            end;
        END;
    end;                                                                                         

    if (not NewWordDocument (false, TemplateName))
        return false;
    end;
  
    InitForm ();                                           
    TablesCollection = ActiveDocument.Tables;              
                                                            
    ФИО_супругов = ФИО_основного = ФИО = depclnt.ConvertFIOFull();                        
    ФИО_вкратце = depclnt.ConvertFIO();
    ИД_Основного = depclnt.CodClient;
                                                            
    CurTable = ActiveDocument.Tables(2);                   
    row = 1;                                               
                                                            
    CurRow  = CurTable.Rows(row);                          
    CurCell = CurRow.Cells(1);                             
    CurCell.Select;                                        
                                                            
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.Text = String(ФИО);          
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
//      PutFields();

    Адреса_и_реквизиты1 = "Адрес регистрации (прописки)  " + depclnt.Address;
    Адреса_и_реквизиты2 = "Адрес фактического проживания  " + depclnt.AddressF;
    Адреса_и_реквизиты3 = "Паспорт/удостоверение личности: " + "Серия: " + trim(depclnt.PaperSeries) + 
                                                                " №"+ trim(depclnt.PaperNumber) + 
                                                                " выдан " + depclnt.PaperIssuer + " " + depclnt.PaperIssuedDate;
    Адреса_и_реквизиты4 = "Телефоны: домашний/служебный " + depclnt.PhoneNumber + "/" + depclnt.PhoneNumber2;
    
    CurTable = ActiveDocument.Tables(3);                   
    row_ = 1;                                               
                                                            
    CurRow  = CurTable.Rows(row_);                          
    CurCell = CurRow.Cells(1);                             
    CurCell.Select;                                        
    
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.Text = String(ФИО);          
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.Font.Italic = wdToggle;             
    WordApplication.Selection.Text = Адреса_и_реквизиты1;
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    row_ = row_+1;
    WordApplication.Selection.Text = Адреса_и_реквизиты2;
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    row_ = row_+1;                                         
    WordApplication.Selection.Text = Адреса_и_реквизиты3;             
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    row_ = row_+1;                                         
    WordApplication.Selection.Text = Адреса_и_реквизиты4;

//      PutFields();

    CurTable = ActiveDocument.Tables(5);                   
    row__ = 2;                                              
                                                            
    CurRow  = CurTable.Rows(row__);                         
    CurCell = CurRow.Cells(1);                             
    CurCell.Select;                                        
    
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.Text = String(ФИО_вкратце);          
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
    WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
//      PutFields();                                           

    ClearRecord(lothdeb);
    lothdeb.ObjectTypeID_Ref = LO_CREDIT;
    lothdeb.ObjectNumber_Ref = credit_c.CreditNumber;
    lothdeb.PartyID_Ref      = 0;
    if((GetGE(lothdeb)) and                                   
        (lothdeb.ObjectNumber_Ref == credit_c.CreditNumber) and       
        (lothdeb.ObjectTypeID_Ref == LO_CREDIT))                
        prev(lothdeb);                                        
        
        while((next(lothdeb)) and                             
            (lothdeb.ObjectNumber_Ref == credit_c.CreditNumber) and
            (lothdeb.ObjectTypeID_Ref == LO_CREDIT))
            
            if (not depclnt.GetRecord(lothdeb.PartyID_Ref))               
                MsgBox ("ОШИБКА: не найден созаемщик в справочнике клиентов");
                Exit(1);                                                    
            end;                                                            
            
            if (ИД_Основного == lothdeb.PartyID_Ref)
                continue;
            end;

            CurTable = ActiveDocument.Tables(2);                   
            row = row + 1;
            
            CurRow  = CurTable.Rows(row);
            CurCell = CurRow.Cells(2);   
            CurCell.Select;              
            
            ФИО = depclnt.ConvertFIOFull();
            ФИО_вкратце = depclnt.ConvertFIO();
            
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);        
            WordApplication.Selection.Text = String("гр.");                
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.Font.Italic = wdToggle;
            WordApplication.Selection.Font.Underline = wdUnderlineSingle;
            WordApplication.Selection.Text = String(ФИО);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);               
            WordApplication.Selection.Font.Italic = wdToggle;
            WordApplication.Selection.Font.Underline = wdUnderlineNone;                  
            WordApplication.Selection.Text = String("(Ф.И.О. полностью)");
//              PutFields();
            row = row + 1;                
            
            Адреса_и_реквизиты1 = "Адрес регистрации (прописки)  " + depclnt.Address;
            Адреса_и_реквизиты2 = "Адрес фактического проживания  " + depclnt.AddressF;
            Адреса_и_реквизиты3 = "Паспорт/удостоверение личности: " + "Серия: " + trim(depclnt.PaperSeries) + 
                                                                        " №"+ trim(depclnt.PaperNumber) + 
                                                                        " выдан " + depclnt.PaperIssuer + " " + depclnt.PaperIssuedDate;
            Адреса_и_реквизиты4 = "Телефоны: домашний/служебный " + depclnt.PhoneNumber + "/" + depclnt.PhoneNumber2;

            CurTable = ActiveDocument.Tables(3);                          
            row_ = row_ + 2;                                                
            CurRow  = CurTable.Rows(row_);                                 
            CurCell = CurRow.Cells(2);                                    
            CurCell.Select;                                               
                                                                        
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);       
            WordApplication.Selection.Text = String(i) + ")";               
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);       
            WordApplication.Selection.Font.Underline = wdUnderlineSingle; 
            WordApplication.Selection.Text = String(ФИО);                 
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);       
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);       
            WordApplication.Selection.Font.Italic = wdToggle;             
            WordApplication.Selection.Font.Underline = wdUnderlineNone;   
            WordApplication.Selection.Text = String("(Ф.И.О. полностью)");
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.Font.Italic = wdToggle;             
            WordApplication.Selection.Text = Адреса_и_реквизиты1;
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            row_ = row_+1;
            WordApplication.Selection.Text = Адреса_и_реквизиты2;
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            row_ = row_+1;                                         
            WordApplication.Selection.Text = Адреса_и_реквизиты3;             
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            row_ = row_+1;                                         
            WordApplication.Selection.Text = Адреса_и_реквизиты4;
//              PutFields();
            row_ = row_ + 1;                                                
            i = i+1;
            
            CurTable = ActiveDocument.Tables(5);                          
            row__ = row__ + 1;                                              
            CurRow  = CurTable.Rows(row__);                                
            CurCell = CurRow.Cells(2);                                    
            CurCell.Select;                                               
            
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);       
            WordApplication.Selection.Text = "_____________________";
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);
            WordApplication.Selection.Font.Italic = wdToggle;
            WordApplication.Selection.Font.Underline = wdUnderlineSingle; 
            WordApplication.Selection.Text = String(ФИО_вкратце);
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);         
            WordApplication.Selection.Font.Underline = wdUnderlineNone;   
            WordApplication.Selection.Text = String("(подпись)");
            WordApplication.Selection.MoveRight(wdCell, 1, wdMove);       
            WordApplication.Selection.Text = String("(Ф.И.О.)");
            row__ = row__ + 1;
//              PutFields();                                                  

            ClearRecord(party);                 
            party.PartyID = lothdeb.PartyID_Ref;
            if(GetEQ(party))                    
                if(GetLinkedObject(OBJROLE_PARTY_SPOUSE, OBJTYPE_PARTY, party, OBJTYPE_PARTY, othdeb_party))
                    depclnt.GetRecord(lothdeb.PartyID_Ref);
                    ФИО_супругов = ФИО_супругов + ", " + depclnt.ConvertFIOFull();
                    spouses = spouses + 1;
                end;
                if(GetLinkedObject(OBJROLE_PARTY_MOTHER, OBJTYPE_PARTY, party, OBJTYPE_PARTY, othdeb_party) or
                    GetLinkedObject(OBJROLE_PARTY_FATHER, OBJTYPE_PARTY, party, OBJTYPE_PARTY, othdeb_party))
                    depclnt.GetRecord(lothdeb.PartyID_Ref);
                    if(parents != 0)
                        ФИО_родителей = ФИО_родителей + ", ";
                    end;
                    ФИО_родителей = ФИО_родителей + depclnt.ConvertFIOFull();
                    parents = parents + 1;
                end;
            else
                MsgBox ("ОШИБКА: не найден созаемщик в справочнике клиентов");
                Exit(1);                                                    
            end;
        end;
    end;

    CalcPSK();
    
    Sum = СуммаЕдиновременногоПлатежа(LO_CREDIT, credit_c.CreditNumber);

    /* Код валюты 810 - рубли, 840 - USD и т.д.*/
    ExtCurCode = int(FindExtCode(credit_c.CurCode));
     
     /* ПСК в процентах*/
    AddFormField(ПСК);
    /* ПСК Прописью */
    AddFormField(NumToStr(ПСК, "", "", "", true, 5));
    /* ПСК в денежном выражении */
    AddFormField(Money(ПСКСУММ));
    /* ПСК в денежном выражении прописью */
    AddFormField(CurToStrAlt (ПСКСУММ, rub, kop, ExtCurCode));
    /* Сумма ежемесячного платежа договора */
    AddFormField(Sum);
    /* Сумма ежемесячного платежа договора прописью */
    AddFormField(CurToStrAlt(Sum, rub, kop, ExtCurCode));

    /* № кредитного договора */                           
    AddFormField(credit_c.UsCreditNumber);

    /* Город, берется из пользовательских полей договора */
    AddFormField(GetUsFieldValue(LO_CREDIT, credit_c.CreditNumber, НаселенныйПункт));

    /* Дата начала кредитного договора */
    AddFormField(DateToStringFull (credit_c.RegDate));

    /* Кредитор */
    AddFormField (GetUsFieldValue(LO_CREDIT, credit_c.CreditNumber, ДолжностьКредитора) + " " + GetStrPart(GetUsFieldValue(LO_CREDIT, credit_c.CreditNumber, ФИОКредитора), 2));
    
    /* Сумма кредитного договора */                              
    AddFormField(MoneyToMString(credit_c.CreditSum, ExtCurCode));
    
    /* Дата окончания кредитного договора */              
    AddFormField (DateToStringFull (credit_c.ReturnDate));
    
    if(DutyIsFound)
        /* % ставка */
        ПроцОД = Loans_FindRateVal(LO_DUTY, Duty1.DutyID, TRU_CRD, Duty1.DutyLastDate, false);
    else
        /* % ставка */
        ПроцОД = Loans_FindRateVal(LO_CREDIT, credit_c.CreditNumber, TRU_CRD, credit_c.ReturnDate);
    end;
    
    /* % ставка по основному долгу */  
    AddFormField(NumAndStr(ПроцОД, 1));
    
    /* Ссудный счёт */                                                           
    AddFormField (НомерСчета (credit_c.CreditNumber, credit_c.CurCode, CRD_ACC));

    AddFormField(GetUsFieldValue(LO_CREDIT, credit_c.CreditNumber, ТарифЗаОбслуживание));

    /* ФИО основного созаёмщика */ 
    AddFormField (ФИО_основного);
    AddFormField (ФИО_основного);
    AddFormField (ФИО_основного);
    
    РасчетныйСчет = НомерСчета (credit_c.CreditNumber, credit_c.CurCode, 42, LO_CREDIT);
                                                                                
    /* Расчетный счет */                                                       
    AddFormField (РасчетныйСчет);
    
    AddFormField (ФИО_основного);                                              
    
    AddFormField (DateToStringFull (credit_c.PaymentDate));
    
    AddFormField (ФИО_основного);
    AddFormField (ФИО_основного);
    

    if((parents == 2) and (spouses == 2))
        ФИО_всех_супругов = ФИО_родителей + ", " + ФИО_супругов;
    elif((parents == 2) and (spouses != 2))
        ФИО_всех_супругов = ФИО_родителей;
    elif((parents != 2) and (spouses == 2))
        ФИО_всех_супругов = ФИО_супругов; 
    end;
    
    AddFormField (ФИО_всех_супругов);

    if((spouses == 1) and (parents ==2))
        ФИО_супругов = ФИО_родителей;
    end;

    if(parents == 2)
        spouses = spouses + parents;
    end;

    if(spouses == 2)
        AddFormField (ФИО_супругов);
    end;

    PutFields ();

    MsgBoxEx("Кредитный договор сформирован");
    Exit(0);

    onError(axerr)
        if(axerr.Code != 0)
            WordError(axerr, false);
        end;
        Exit(1);
end;