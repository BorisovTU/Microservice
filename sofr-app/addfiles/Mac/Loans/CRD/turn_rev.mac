/*
$Name: turn_rev.mac
$Module: Кредитование
$Description: Сверка оборотов
*/
/*****************************************************************************/
/*                                                                           */
/*                        Сверка оборотов                                    */
/*                                                                           */
/*****************************************************************************/
IMPORT SbCrdInter, Календарь, total;

RECORD turn_rev("turn_rev", "rtusrmac") DIALOG;

private RECORD doc_acc  ("doc_acc.dbt",  "loans.def");
private FILE cb_doc   ("cb_doc.dbt",   "bank.def" );
private FILE multydoc ("multydoc.dbt", "bank.def" );
private FILE cashdoc  ("pscshdoc.dbt", "bank.def" );
private FILE pmpaym   ("pmpaym.dbt",   "bank.def" ) key 0;
private FILE memorder ("memorder.dbt", "bank.def" );
private FILE pmrmprop ("pmrmprop.dbt", "bank.def" ) key 0;
private var  turnrev = TBFile ("turn_rev.tmp", "w", 0, "turn_rev.tmp", "loans.def");      


CONST ALL:string = "Все",
      AllStatus:string = "~Esc~ Выход  ~F3~ Список ~F9~ Выполнить",
      Stat_:string = "~Esc~ Выход  ~ENTER~ Ввод";

CONST ESC:integer = 27,
      ENTER:integer = 13,
      F9:integer = 323,
      F3:integer = 317;

VAR BegDate:date = {curdate},
    EndDate:date = {curdate},
    Filter:integer = 0, OutDocID:integer = 0,
    i, First, stat, Flag, Curr;  

VAR RSBankExport:integer = 1; //SCR 212347 
VAR ErrCode = 0;

ARRAY Ground, LoansStatus, BankStatus;

ARRAY FR, ST_DOCACC, ST_CBDOC, ST_MULTYDOC, ST_CASHDOC, ST_PAYMDOC, ST_MEMORDER;

ST_DOCACC(0) = "";
ST_DOCACC(1) = "Отложенный";
ST_DOCACC(2) = "Проведен";
ST_DOCACC(3) = "Выгружен";
ST_DOCACC(4) = "Сведен, готов к выгрузке";

ST_PAYMDOC(0)     = "На этапе подготовки";
i = 1;
while(i<50)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(50)    = "Пустой платеж";
ST_PAYMDOC(51)    = "Платеж, участвовавший в слиянии";
i = 52;
while(i<55)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(55)    = "Платеж вынесен на пролонгацию";
ST_PAYMDOC(56)    = "Платеж закрыт пролонгацией";
ST_PAYMDOC(57)    = "Платеж капитализирован";
ST_PAYMDOC(58)    = "Платеж пролонгирован";
ST_PAYMDOC(59)    = "Платеж просрочен";
ST_PAYMDOC(60)    = "Досрочная обработка платежа";
ST_PAYMDOC(61)    = "Платеж снят с просрочки";
i = 62;
while(i<100)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(100)   = "Отвергнутый платеж (обработка завершена, но неуспешно";
i = 101;
while(i<150)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(150)   = "Платеж закрыт без движения средств (в результате неттинга)";
i = 151;
while(i<1000)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(1000)  = "Незавершенный платеж";
i = 1001;
while(i<2000)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(2000)  = "Платеж помещен в картотеку 2";
i = 2001;
while(i<2990)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(2990)  = "Платеж на приеме (в Корсчетах/МБР->АРМ позиционера)";
i = 2991;
while(i<2995)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(2995)  = "Квитуемый платеж";
i = 2996;
while(i<3000)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(3000)  = "Платеж готов к отправке (в Корсчета/МБР)";
i = 3001;
while(i<3010)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(3010)  = "Платеж на отправке (в АРМ позиционера->Корсчетах/МБР)";
i = 3011;
while(i<3100)
    ST_PAYMDOC(i) = "";
    i = i+1;
end;
ST_PAYMDOC(3100)  = "Платеж обрабатывается в БЭК-ОФИСЕ";

ST_CBDOC(0)   = ST_CASHDOC(1) = ST_MEMORDER(1) = ST_MULTYDOC(1) = "Отложен";
ST_CBDOC(1)   = "Обрабатывается";
i = 2;
while(i<50)
    ST_CBDOC(i) = "";
    i = i+1;
end;
ST_CASHDOC(2) = ST_MEMORDER(2) = ST_MULTYDOC(2) =  "Открыт";
ST_CBDOC(50)  = ST_CASHDOC(3)  = ST_MEMORDER(3) = ST_MULTYDOC(3) ="Закрыт";

// конвертация суммы с учетом кросс-курсов
private macro SmartConvertSum (sumTo, sumFrom, sinceDate, fiidFrom, fiidTo)
   var NewSum : money = $0;
   var SumConv : money = $0;

   if (fiidFrom == fiidTo) 
      NewSum = sumFrom;

   elif (ConvSum (NewSum, sumFrom, sinceDate, fiidFrom, fiidTo) != 0)

     if (ConvSumCross (NewSum, sumFrom, sinceDate, fiidFrom, fiidTo) != true)
        return false;
     end;
   end;

   SetParm (0, NewSum);

   return true;
end;


MACRO Setfilter(d)
    VAR i:integer;
    i = Menu(FR, Stat_, "Параметры фильтра", 32, 5, Filter);
    IF (i >= 0)
        Filter = i;
        d(2) = FR(i);
    END;
END;

MACRO DialogMesProc (d, m, f, k)
    IF (m == DLG_INIT)
        d(0) = BegDate;
        d(1) = EndDate;
        d(2) = FR(0);
        UpdateFields(d);
        SetFocus(d, 0);
		message(AllStatus); 
    ELIF (m == DLG_REMFOCUS)
        IF (FldName(d, f) == "fld_begdate")
            BegDate = d(f);
        ELIF (FldName(d, f) == "fld_enddate")
            EndDate = d(f);
        END;
    ELIF (m == DLG_KEY)
        IF (k == ESC)
            RETURN CM_CANCEL;
    ELIF (k == ENTER)
        return CM_IGNORE;
        ELIF (k == F9)
            DialogMesProc(d, DLG_REMFOCUS, f, 0);
            if (BegDate > {curdate})                                 
                MsgBox ("Дата начала периода больше даты текущего опердня!");    
                RETURN CM_IGNORE;
            end;
            if (EndDate < BegDate)                                 
                MsgBox ("Дата окончания периода меньше даты начала!");    
                RETURN CM_IGNORE;
            end;
            RETURN CM_SAVE;
        ELIF (k == F3)
            IF (FldName(d, f) == "fld_filter")
                SetFilter(d);
            END;
        END;
    ELSE
        RETURN CM_DEFAULT;
    END;
END;


MACRO GetParam()
    FR(0) = ALL;
    FR(1) = "Не выгруженные";
    FR(2) = "Не проведённые";
    FR(3) = "Несоответствие дат";
    FR(4) = "Несоответствие сумм";
    FR(5) = "Несоответствие счетов";
    FR(6) = "Выгруженные с расхождениями";
    FR(7) = "Не удаленные";
  
    IF ( NOT RunDialog (turn_rev, "DialogMesProc"))
        Exit(1);
    END;
END;

macro AddUnknown()
    turnrev.rec.BankCredit    = "";  
    turnrev.rec.BankCarrySum  = 0;  
    turnrev.rec.BankStatus    = "";  
    turnrev.rec.BankCarryDate = Date(0,0,0);  
end;

macro AddDocAccToRep()
    turnrev.rec.LoansDebet     = doc_acc.Debit;
    turnrev.rec.LoansCredit    = doc_acc.Credit;
    Curr = int(FindExtCode(doc_acc.CurCode));
    turnrev.rec.LoansCurCode   = FindShortName(doc_acc.CurCode);
    turnrev.rec.LoansCurCode_Credit = FindShortName(doc_acc.CurCodeCredit);
    turnrev.rec.LoansCarrySum  = doc_acc.CarrySum;
    turnrev.rec.LoansCarrySum_Credit = doc_acc.CarrySumCredit;
    turnrev.rec.LoansStatus    = ST_DOCACC(doc_acc.State);
    turnrev.rec.LoansCarryDate = doc_acc.RegDate;
    turnrev.rec.LoansODBDebet  = doc_acc.OutDebAccount;
    turnrev.rec.LoansODBCredit = doc_acc.OutCredAccount; 
    turnrev.rec.Ground         = doc_acc.Ground;      
    if(doc_acc.IsDeleted == 1)
        turnrev.rec.IsDeleted      = "X";
    else
        turnrev.rec.IsDeleted      = "";
    end;
end;

macro AddCbDocToRep()
    turnrev.rec.BankDebet     = pmpaym.PayerAccount;
    turnrev.rec.BankCredit    = pmpaym.ReceiverAccount;  
    turnrev.rec.BankCarrySum  = pmpaym.Amount;
    turnrev.rec.BankCarrySum_Credit = pmpaym.PayAmount;  
    //turnrev.rec.BankStatus    = ST_CBDOC(cb_doc.State);  
    turnrev.rec.BankCarryDate = pmpaym.ValueDate;  
end;

macro AddMDocToRep()
    turnrev.rec.BankDebet     = pmpaym.PayerAccount;
    turnrev.rec.BankCredit    = pmpaym.ReceiverAccount;  
    Curr = int(FindExtCode(doc_acc.CurCode));
    SmartConvertSum (turnrev.rec.BankCarrySum, pmpaym.Amount, doc_acc.RegDate,pmpaym.FIID, doc_acc.CurCode);
    SmartConvertSum (turnrev.rec.BankCarrySum_Credit, pmpaym.Amount, doc_acc.RegDate, pmpaym.PayFIID, doc_acc.CurCode);
    //turnrev.rec.BankStatus    = ST_MULTYDOC(multydoc.Status);  
    turnrev.rec.BankCarryDate = pmpaym.ValueDate;  
end;

macro AddCashDocToRep()
    turnrev.rec.BankDebet     = pmpaym.PayerAccount;
    turnrev.rec.BankCredit    = pmpaym.ReceiverAccount;  
    turnrev.rec.BankCarrySum  = pmpaym.Amount;
    turnrev.rec.BankCarrySum_Credit = pmpaym.PayAmount;   
    //turnrev.rec.BankStatus    = ST_CASHDOC(cashdoc.Status);  
    turnrev.rec.BankCarryDate = pmrmprop.Date;  
end;

macro AddPaymDocToRep()
    turnrev.rec.BankDebet     = pmpaym.PayerAccount;
    turnrev.rec.BankCredit    = pmpaym.ReceiverAccount;  
    turnrev.rec.BankCarrySum  = pmpaym.Amount;
    turnrev.rec.BankCarrySum_Credit = pmpaym.PayAmount;   
    //turnrev.rec.BankStatus    = ST_MEMORDER(memorder.Status);  
    turnrev.rec.BankCarryDate = pmpaym.ValueDate;  
end;

macro SetDocs()
 var rs = null;
 var str:string;
 var nrec:integer;
 var ID:integer;
 
 if(OpenLoansCommonFiles() == 0)
     exit(1);
 end;
 stat = 1;
 Flag = 0;
 str = "select count(*) from ddoc_acc_dbt where t_RegDate <= " + SQLDate(EndDate) +
       " and t_RegDate >= " + SQLDate(BegDate) +
       " and t_State = " + CF_UPLOAD;

 rs = LnGetRecordset(str);
 if (rs == null)
   return 0;
 end;

 if (rs.MoveNext)
   nrec = rs.value(0, null, V_INTEGER);
 end;

 str = "select t_docaccid from ddoc_acc_dbt where t_RegDate <= " + SQLDate(EndDate) +
       " and t_RegDate >= " + SQLDate(BegDate) +
       " and t_State = " + CF_UPLOAD;

 rs = LnGetRecordset(str);
 if (rs == null)
   return 0;
 end;

 InitProgress(nrec, "", "Обработка документов");
 nrec = 0;
 while(rs.MoveNext)
 nrec = nrec + 1;
 UseProgress(nrec);
 ID = rs.value(0, null, V_INTEGER);
 if(Loans_FindDocAcc(12, "", 0, ID, doc_acc))
         OutDocID = GetExternDocument(doc_acc.OutDocID);   //ID внешнего документа
         if(OutDocID != 0) //Если найден внешний документ
             if((Filter == 0) or (Filter == 3) or (Filter == 4) or (Filter == 5) or (Filter == 6))
                 if((doc_acc.IsDeleted == 0) and (Filter != 7))
                     if(doc_acc.AlgoID == IgAlgoID_MO) /* Мемориальный ордер*/
                         Flag = 0;
                         ClearRecord(cb_doc);
                         cb_doc.DocumentID = OutDocID;
                         if(GetEQ(cb_doc) and (cb_doc.DocumentID == OutDocID))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID= cb_doc.DocumentID;
                             if(GetEQ(pmpaym))
                                 if(((Filter == 0) or (Filter == 3) or (Filter == 6)) and 
                                     (doc_acc.CarrySum != pmpaym.Amount))
                                     AddDocAccToRep();
                                     AddCbDocToRep();
                                     turnrev.insert;
                                     Flag = 1;
                                 end;
                         
                                 if(((Filter == 0) or (Filter == 5) or (Filter == 6)) and 
                                    (doc_acc.RegDate != pmpaym.ValueDate))
                                     AddDocAccToRep();
                                     AddCbDocToRep();
                                     turnrev.insert;
                                     Flag = 1;
                                 end;
                             
                                 if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and 
                                    (doc_acc.OutDebAccount != pmpaym.PayerAccount))
                                     AddDocAccToRep();
                                     AddCbDocToRep();
                                     turnrev.insert;
                                     Flag = 1;
                                 end;
                             
                                 if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and 
                                    (doc_acc.OutCredAccount != pmpaym.ReceiverAccount))
                                     AddDocAccToRep();
                                     AddCbDocToRep();
                                     turnrev.insert;
                                     Flag = 1;
                                 end;

                             else
                                 AddDocAccToRep();
                                 turnrev.rec.BankDebet     = "Документ не найден";
                                 AddUnknown();
                                 turnrev.insert; 
                             end;
                         else
                             AddDocAccToRep();
                             turnrev.rec.BankDebet     = "Документ не найден";
                             AddUnknown();
                             turnrev.insert;    
                         end;
                     
                     elif (doc_acc.AlgoID == IgAlgoID_MCD)/*Мультивалютный документ*/
                         Flag = 0;
                         ClearRecord(multydoc);
                         ClearRecord(pmpaym);                                                                          
                         multydoc.AutoKey = OutDocID;     
                         if(GetEQ(multydoc) and (multydoc.AutoKey == OutDocID))
                            pmpaym.PaymentID= multydoc.AutoKey;
                     if(GetEQ(pmpaym))                           
                              if(((Filter == 0) or (Filter == 3) or (Filter == 6)) and (doc_acc.CarrySum != pmpaym.Amount))                                                        
                                       AddDocAccToRep();                                                                     
                                       AddMDocToRep();                                                                      
                                       turnrev.insert;                                                                      
                                       Flag = 1;                                                                             
                              end;                                                                                      
                                                                                                                          
                              if(((Filter == 0) or (Filter == 5) or (Filter == 6)) and (doc_acc.RegDate != pmpaym.ValueDate))                              
                                       AddDocAccToRep();                                                                     
                                       AddMDocToRep();                                                                      
                                       turnrev.insert;                                                                      
                                       Flag = 1;                                                                             
                              end;                                                                                      
                                                                                                                          
                              if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and (doc_acc.OutDebAccount != pmpaym.PayerAccount))                       
                                    AddDocAccToRep();                                                                     
                                       AddMDocToRep();                                                                      
                                       turnrev.insert;                                                                      
                                       Flag = 1;                                                                             
                              end;                                                                                      
                                                                                                                          
                              if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and (doc_acc.OutCredAccount != pmpaym.ReceiverAccount))                   
                                       AddDocAccToRep();                                                                     
                                       AddMDocToRep();                                                                      
                                       turnrev.insert;
                                       Flag = 1;                                                                      
                              end;
                             else
                                 AddDocAccToRep();
                                 turnrev.rec.BankDebet     = "Документ не найден";
                                 AddUnknown();
                                 turnrev.insert; 
                             end;

                                                        
                         else
                             AddDocAccToRep();
                             turnrev.rec.BankDebet = "Документ не найден";
                             AddUnknown();
                             turnrev.insert;    
                         end;                                                                                          
                     
                     elif ((doc_acc.AlgoID == IgAlgoID_KOP) or /* Кассовый ордер (приход)*/
                           (doc_acc.AlgoID == IgAlgoID_COR))   /* Кассовый ордер (расход)*/
                         Flag = 0;
                         ClearRecord(cashdoc);                                                                          
                         cashdoc.AutoKey = OutDocID;                                                         
                         if(GetEQ(cashdoc) and (cashdoc.AutoKey == OutDocID))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = cashdoc.AutoKey; 

                             if(GetEQ(pmpaym))
                                 ClearRecord(pmrmprop);
                                 pmrmprop.PaymentID = pmpaym.PaymentID;
                                 if(GetEQ(pmrmprop))
                                     if(((Filter == 0) or (Filter == 3) or (Filter == 6)) and (doc_acc.CarrySum != pmpaym.Amount))                                                        
                                         AddDocAccToRep();                                                                     
                                         AddCashDocToRep();                                                                      
                                         turnrev.insert;                                                                      
                                         Flag = 1;                                                                             
                                     end;                                                                                      
                                                                                                                           
                                     if(((Filter == 0) or (Filter == 5) or (Filter == 6)) and (doc_acc.RegDate != pmrmprop.Date))                              
                                         AddDocAccToRep();                                                                     
                                         AddCashDocToRep();                                                                      
                                         turnrev.insert;                                                                      
                                         Flag = 1;                                                                             
                                     end;                                                                                      
                                                                                                                           
                                     if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and (doc_acc.OutDebAccount != pmpaym.PayerAccount))                       
                                         AddDocAccToRep();                                                                     
                                         AddCashDocToRep();                                                                      
                                         turnrev.insert;                                                                      
                                         Flag = 1;                                                                             
                                     end;                                                                                      
                                                                                                                           
                                     if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and (doc_acc.OutCredAccount != pmpaym.ReceiverAccount))                   
                                         AddDocAccToRep();                                                                     
                                         AddCashDocToRep();                                                                      
                                         turnrev.insert;
                                         Flag = 1;                                                                      
                                     end;

                                 end;
                             end;                                                                                      
                         else    
                             AddDocAccToRep();
                             turnrev.rec.BankDebet = "Документ не найден";
                             AddUnknown();
                             turnrev.insert;    
                         end;                                                                                          
                     
                     elif (doc_acc.AlgoID == IgAlgoID_PP)/* Платежное поручение*/
                         Flag = 0;
                         ClearRecord(memorder);
                         memorder.OrderID = OutDocID;
                         if(GetEQ(memorder))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = memorder.OrderID;
                             if(GetEQ(pmpaym))
                                 if(((Filter == 0) or (Filter == 3) or (Filter == 6)) and (doc_acc.CarrySum != pmpaym.Amount))                                                        
                                     AddDocAccToRep();                                                                     
                                     AddPaymDocToRep();                                                                      
                                     turnrev.insert;                                                                      
                                     Flag = 1;                                                                             
                                 end;                                                                                      
                                                                                                                       
                                 if(((Filter == 0) or (Filter == 5) or (Filter == 6)) and (doc_acc.RegDate != pmpaym.ValueDate))                              
                                     AddDocAccToRep();                                                                     
                                     AddPaymDocToRep();                                                                      
                                     turnrev.insert;                                                                      
                                     Flag = 1;                                                                             
                                 end;                                                                                      
                                                                                                                           
                                 if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and (doc_acc.OutDebAccount != pmpaym.PayerAccount))                       
                                     AddDocAccToRep();                                                                     
                                     AddPaymDocToRep();                                                                      
                                     turnrev.insert;                                                                      
                                     Flag = 1;                                                                             
                                 end;                                                                                      
                                                                                                                       
                                 if(((Filter == 0) or (Filter == 4) or (Filter == 6)) and (doc_acc.OutCredAccount != pmpaym.ReceiverAccount))                   
                                     AddDocAccToRep();                                                                     
                                     AddPaymDocToRep();                                                                      
                                     turnrev.insert;
                                     Flag = 1;                                                                      
                                end;
                             else
                                 AddDocAccToRep();
                                 turnrev.rec.BankDebet = "Документ не найден";
                                 AddUnknown();
                                 turnrev.insert;    
                             end;
                         else
                             AddDocAccToRep();
                             turnrev.rec.BankDebet = "Документ не найден";
                             AddUnknown();
                             turnrev.insert;    
                         end;
                     end;
                 elif((doc_acc.IsDeleted == 1) and ((Filter == 0) or (Filter == 7)))
                     if(doc_acc.AlgoID == IgAlgoID_MO) /* Мемориальный ордер*/
                         ClearRecord(cb_doc);
                         cb_doc.DocumentID = OutDocID;
                         if((GetEQ(cb_doc)) and (cb_doc.DocumentID == OutDocID))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = cb_doc.DocumentID;
                             if(GetEQ(pmpaym))
                                 AddDocAccToRep();
                                 AddCbDocToRep();
                                 if(cb_doc.State == 0)   
                                    turnrev.rec.BankStatus = "Отложен";
                  elif(cb_doc.State == 1)
                  turnrev.rec.BankStatus = "Обрабатывается";
                  elif(cb_doc.State == 2)
                  turnrev.rec.BankStatus = "Отвергнут";
                  end;
                                 turnrev.insert;
                             end;
                         end;
                     elif (doc_acc.AlgoID == IgAlgoID_MCD)/*Мультивалютный документ*/
                         ClearRecord(multydoc);                                                                          
                         multydoc.AutoKey = OutDocID;                                                         
                         if(GetEQ(multydoc) and (multydoc.AutoKey == OutDocID))        
                             AddDocAccToRep();                                                                     
                             AddMDocToRep();
                 if(multydoc.Status == 1) 
                              turnrev.rec.BankStatus = "Отложен";
                 elif(multydoc.Status == 2)
                    turnrev.rec.BankStatus = "Открыт";
                 elif(multydoc.Status == 4)
                    turnrev.rec.BankStatus = "Отвергнут";
                 end;                                                                      
                             turnrev.insert;                                                                      
                         end;                                                                                          
                     
                     elif ((doc_acc.AlgoID == IgAlgoID_KOP) or /* Кассовый ордер (приход)*/
                           (doc_acc.AlgoID == IgAlgoID_COR))   /* Кассовый ордер (расход)*/
                         ClearRecord(cashdoc);                                                                          
                         cashdoc.AutoKey = OutDocID;                                                         
                         if(GetEQ(cashdoc) and (cashdoc.AutoKey == OutDocID))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = cashdoc.AutoKey;
                             if(GetEQ(pmpaym))
                                 AddDocAccToRep();                                                                     
                                 AddCashDocToRep();
                     if(cashdoc.Status == 1) 
                                 turnrev.rec.BankStatus = "Отложен";
                     elif(cashdoc.Status == 2)
                        turnrev.rec.BankStatus = "Открыт";
                     elif(cashdoc.Status == 4)
                        turnrev.rec.BankStatus = "Отвергнут";
                     end;                                                                        
                                 turnrev.insert;                                                                      
                             end;                                                                                      
                         end;                                                                                          
                     
                     elif (doc_acc.AlgoID == IgAlgoID_PP)/* Платежное поручение*/
                         Flag = 0;
                         ClearRecord(memorder);
                         memorder.OrderID = OutDocID;
                         if(GetEQ(memorder))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = memorder.OrderID;
                             if(GetEQ(pmpaym))
                                 AddDocAccToRep();                                                                     
                                 AddPaymDocToRep();                                                                      
                     if(memorder.Status == 1)   
                                 turnrev.rec.BankStatus = "Отложен";
                     elif(memorder.Status == 2)
                        turnrev.rec.BankStatus = "Открыт";
                     elif(memorder.Status == 4)
                        turnrev.rec.BankStatus = "Отвергнут";
                     end;
                                 turnrev.insert;                                                                      
                             end;                                                                                      
                         end;
                     end;
                 end;
         end;
             if((Filter == 2) or (Filter == 0))/*Не проведённые или все*/
                 if(doc_acc.IsDeleted == 0)
                     if(doc_acc.AlgoID == IgAlgoID_MO) /* Мемориальный ордер*/
                         ClearRecord(cb_doc);
                         cb_doc.DocumentID = OutDocID;
                         if(GetEQ(cb_doc) and (cb_doc.DocumentID == OutDocID) and ((cb_doc.State == 0) or (cb_doc.State == 1) or (cb_doc.State == 2)))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = cb_doc.DocumentID;
                             if(GetEQ(pmpaym))
                                 AddDocAccToRep();
                                 AddCbDocToRep();
                  if(cb_doc.State == 0)   
                                    turnrev.rec.BankStatus = "Отложен";
                  elif(cb_doc.State == 1)
                     turnrev.rec.BankStatus = "Обрабатывается";
                  elif(cb_doc.State == 2)
                     turnrev.rec.BankStatus = "Отвергнут";
                  end;
                                 turnrev.insert;
                             end;
                         end;
                     
                     elif (doc_acc.AlgoID == IgAlgoID_MCD)/*Мультивалютный документ*/
                         ClearRecord(multydoc);                                                                          
                         multydoc.AutoKey = OutDocID;                                                         
                         if(GetEQ(multydoc) and (multydoc.AutoKey == OutDocID) and ((multydoc.Status == 1) or (multydoc.Status == 2) or (multydoc.Status == 4)))        
                             AddDocAccToRep();                                                                     
                             AddMDocToRep();                                                                      
                 if(multydoc.Status == 1) 
                              turnrev.rec.BankStatus = "Отложен";
                 elif(multydoc.Status == 2)
                    turnrev.rec.BankStatus = "Открыт";
                 elif(multydoc.Status == 4)
                  turnrev.rec.BankStatus = "Отвергнут";
                 end;
                             turnrev.insert;                                                                      
                         end;                                                                                      
                     
                     elif ((doc_acc.AlgoID == IgAlgoID_KOP) or /* Кассовый ордер (приход)*/
                           (doc_acc.AlgoID == IgAlgoID_COR))   /* Кассовый ордер (расход)*/
                         ClearRecord(cashdoc);                                                                          
                         cashdoc.AutoKey = OutDocID;                                                         
                         if(GetEQ(cashdoc) and (cashdoc.AutoKey == OutDocID) and ((cashdoc.Status == 1) or (cashdoc.Status == 2) or (cashdoc.Status == 4)))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = cashdoc.AutoKey;
                             if(GetEQ(pmpaym))
                                 AddDocAccToRep();                                                                     
                                 AddCashDocToRep();
                     if(cashdoc.Status == 1) 
                                 turnrev.rec.BankStatus = "Отложен";
                     elif(cashdoc.Status == 2)
                        turnrev.rec.BankStatus = "Открыт";
                     elif(cashdoc.Status == 4)
                        turnrev.rec.BankStatus = "Отвергнут";
                     end;                                                                    
                                 turnrev.insert;                                                                      
                             end;                                                                                      
                         end;

                     elif (doc_acc.AlgoID == IgAlgoID_PP)/* Платежное поручение*/
                         Flag = 0;
                         ClearRecord(memorder);
                         memorder.OrderID = OutDocID;
                         if(GetEQ(memorder) and ((memorder.Status == 1) or (memorder.Status == 2) or (memorder.Status == 4)))
                             ClearRecord(pmpaym);
                             pmpaym.PaymentID = memorder.OrderID;
                             if(GetEQ(pmpaym))  
                                 AddDocAccToRep();                                                                     
                                 AddPaymDocToRep();                                                                      
                     if(memorder.Status == 1)   
                                 turnrev.rec.BankStatus = "Отложен";
                     elif(memorder.Status == 2)
                        turnrev.rec.BankStatus = "Открыт";
                     elif(memorder.Status == 4)
                        turnrev.rec.BankStatus = "Отвергнут";
                     end;    
                                 turnrev.insert;                                                                      
                             end;                                                                                      
                         end;
                     end;
                 end;
             end;
         else //Если документ не найден
             if ((Filter == 0) OR (Filter == 1))         /*Все и Невыгруженные*/    
                 if(doc_acc.IsDeleted == false)
                     if(doc_acc.AlgoID == IgAlgoID_MO) /* Мемориальный ордер*/
                             AddDocAccToRep();
                             turnrev.rec.BankDebet     = "Невыгружен";  
                             AddUnknown();
                             turnrev.insert;                  
                     elif (doc_acc.AlgoID == IgAlgoID_MCD)/*Мультивалютный документ*/
                             AddDocAccToRep();
                             turnrev.rec.BankDebet     = "Невыгружен";  
                             AddUnknown();
                             turnrev.insert;                                                                                         
                     elif ((doc_acc.AlgoID == IgAlgoID_KOP) or /* Кассовый ордер (приход)*/
                           (doc_acc.AlgoID == IgAlgoID_COR))   /* Кассовый ордер (расход)*/
                             AddDocAccToRep();                                                                     
                             turnrev.rec.BankDebet     = "Невыгружен";  
                             AddUnknown();
                             turnrev.insert;                                                                                          
                     elif (doc_acc.AlgoID == IgAlgoID_PP) /* Платежное поручение  */
                             Flag = 0;
                             AddDocAccToRep();
                             turnrev.rec.BankDebet     = "Невыгружен";  
                             AddUnknown();
                             turnrev.insert;                                                                      
                     end;    
                 end;         
             end;
         end;
     end;
 end;
 RemProgress();
 CloseLoansCommonFiles ();
end;

/*Точка входа*/

IF (GetRegistryValue("RS-LOANS\\ВЫГРУЗКА\\РЕЖИМ_ВЫГРУЗКИ", V_INTEGER, RSBankExport, ErrCode) != V_INTEGER)

    msgBox(ErrCode);
    Exit(0);
END;

IF(RSBankExport)
LnGetRecordset("delete from dturn_rev_tmp");
GetParam();
SetDocs();
   
if(BegDate != EndDate)
           [                                                                          Отчет по процедуре сверки выгруженных оборотов за период с ########## по ########## ](BegDate, EndDate);
else
           [                                                                               Отчет по процедуре сверки выгруженных оборотов за ########## ](BegDate);
end;
           [ ];
           [
             ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T----------------------------------------------------------------------------------------------------------------------------------------┐ 
             │                                                                       Документ RS-Loans                                                                                                     │                                                               Документ RS-Bank                                                         │ 
             +--------------------------T---------------------------T-----------T----------T-----------T----------T------------T----------T----------T--------------------------T--------------------------+--------------------------T---------------------------T----------T----------T------------T----------T-----------------------------------+ 
             │                          │                           │           │          │           │          │            │          │          │                          │                          │                          │                           │          │          │            │          │                                   │                         
             │   Счет дебета RS-Loans   │   Cчет кредита RS-Loans   │Вал. счёта │Сумма док.│Вал. счёта │Сумма док.│   Статус   │ Признак  │  Дата    │    Счет дебета RS-Bank   │   Счет кредита RS-Bank   │       Счет дебета        │       Cчет кредита        │Сумма док.│Сумма док.│   Статус   │   Дата   │        Основание документа        │                            
             │                          │                           │   по ДТ   │  по Дт   │   по КТ   │  по Кт   │            │ удаления │ проводки │                          │                          │                          │                           │  по ДТ   │  по КТ   │            │ проводки │                                   │                            
             +--------------------------+---------------------------+-----------+----------+-----------+----------+------------+----------+----------+--------------------------+--------------------------+--------------------------+---------------------------+----------+----------+------------+----------+-----------------------------------+     
           ];                                                                                                                                                                                                                                                                                          
First = 0;
InitProgress(turnrev.NRecords());
if(turnrev.NRecords()> 0)
    turnrev.rewind;
    i = 0;
    while(turnrev.next)
        First = 1;
        strsplit(turnrev.rec.Ground,      Ground,      35, 35, 6);
        strsplit(turnrev.rec.LoansStatus, LoansStatus, 12, 12, 5);
        strsplit(turnrev.rec.BankStatus,  BankStatus,  12, 12, 5);
        
        UseProgress(i = i + 1);

           [ │##########################│ ##########################│   ####    │##########│   ####    │##########│############│    #     │##########│##########################│##########################│##########################│ ##########################│##########│##########│############│##########│###################################│
             │                          │                           │           │          │           │          │############│          │          │                          │                          │                          │                           │          │          │############│          │###################################│
             │                          │                           │           │          │           │          │############│          │          │                          │                          │                          │                           │          │          │############│          │###################################│
             │                          │                           │           │          │           │          │            │          │          │                          │                          │                          │                           │          │          │            │          │###################################│
             │                          │                           │           │          │           │          │            │          │          │                          │                          │                          │                           │          │          │            │          │###################################│
             │                          │                           │           │          │           │          │            │          │          │                          │                          │                          │                           │          │          │            │          │###################################│
           ]
             (turnrev.rec.LoansDebet,
              turnrev.rec.LoansCredit,
              turnrev.rec.LoansCurCode,
              turnrev.rec.LoansCarrySum,
              turnrev.rec.LoansCurCode_Credit,
              turnrev.rec.LoansCarrySum_Credit,
              LoansStatus(0):l,
              turnrev.rec.IsDeleted,
              turnrev.rec.LoansCarryDate,
              turnrev.rec.LoansODBDebet,
              turnrev.rec.LoansODBCredit,
              turnrev.rec.BankDebet,
              turnrev.rec.BankCredit,
              turnrev.rec.BankCarrySum,
              turnrev.rec.BankCarrySum_Credit,
              BankStatus(0):l,
              turnrev.rec.BankCarryDate,
              Ground(0):l,
              LoansStatus(1):l,
              BankStatus(1):l,
              Ground(1):l,
              LoansStatus(2):l,
              BankStatus(2):l,
              Ground(2):l,
              LoansStatus(3):l,
              BankStatus(3):l,
              Ground(3):l,
              LoansStatus(4):l,
              BankStatus(4):l,
              Ground(4):l,
              Ground(5):l
         );

           [ L--------------------------+---------------------------+-----------+----------+-----------+----------+------------+----------+----------+--------------------------+--------------------------+--------------------------+---------------------------+----------+----------+------------+----------+------------------------------------];
    end;
end;
if(First == 0)
           [ │##########################│                           │           │          │           │          │            │          │          │                          │                          │                          │                           │          │          │            │          │                                   │
           ]
           ("Нет записей");
           [ L--------------------------+---------------------------+-----------+----------+-----------+----------+------------+----------+----------+--------------------------+--------------------------+--------------------------+---------------------------+----------+----------+------------+----------+------------------------------------];
end;
RemProgress;
LnGetRecordset("delete from dturn_rev_tmp");else
    msgbox("Отчет формируется только при включенной настройке RS-LOANS\\ВЫГРУЗКА\\ВЫГРУЗКА_В_RS-BANK");
end;