IMPORT "total.mac", "advsum.mac", "or_tpl_h.mac", RsbDataSet;

private VAR  payment_tmp = TBFile ("payment.tmp", "r", 0);

MACRO FillFileGroup(AdviceKindID:integer, ObjectTypeID:integer, ObjectNumber:integer, OpDate:date, EndDate:date, AdvDate:date, CurCode:integer, CreditNumber:integer)
    record Credit("credit_c.dbt", "loans.def");
    FillFile(AdviceKindID, ObjectTypeID, ObjectNumber, OpDate, EndDate, AdvDate, CurCode, CreditNumber);
    CalcPercent(OpDate); 
END;

MACRO FillFileAdvicFrc(OpDate: date)
   "  "
END;

MACRO PrintReportFile(AdvDate: date)
   PRIVATE const TemplateName:string = "Advis.xls";

   PRIVATE VAR ExcelObj : CTemplateXLS = CTemplateXLS ();
   PRIVATE VAR TemplateTable : object = NULL;
   PRIVATE VAR Obj : C_CSVFile = C_CSVFile ();
   PRIVATE VAR FileNameCSV : string = obj.CreateFullFileName ("data.txt");

   VAR rsRow  : object = NULL;
   VAR RSDcmd : object = NULL;

   RSDcmd = RsdCommand (RslDefCon, 
   "SELECT t.T_FLAG AS FLAG, " + 
         " credit_c.t_UsCreditNumber AS UsCreditNumber, " +
         " party.t_Name AS PName, " +
         " type_crd.t_CREDITTYPENAME AS CName, " +
         " FI.T_CCY AS CCY, " +
         " dutstage.t_DUTYSTAGENAME AS DStage, " +
         " payment.t_PAYSUM AS PSum, " +
         " t.t_EXPDAY AS EDate, " +
         " t.t_objecttypeid_ref AS ObjID,  " +
         " t.t_objectnumber_ref AS ObjN " +
   " FROM dexpadv_tmp t, dcredit_c_dbt credit_c, ddutstage_dbt dutstage, dparty_dbt party, dpayment_tmp payment, " + 
        " dtype_crd_dbt type_crd, dfininstr_dbt fi WHERE " +
        " t.t_DUTYSTAGEID_REF=payment.t_REFERENCE AND payment.t_CREDITNUMBER_REF=credit_c.t_CreditNumber " +
    " AND t.t_OBJECTTYPEID_REF=payment.t_OBJID AND t.t_OBJECTNUMBER_REF=payment.t_OBJN " +
    " AND dutstage.t_DUTYSTAGEID=t.t_DUTYSTAGEID_REF AND party.t_PartyID=credit_c.t_ClientID_Ref " +
    " AND credit_c.t_CREDITTYPEID_REF=type_crd.t_CREDITTYPEID AND FI.T_FIID = CREDIT_C.T_CURCODE " + 
    " ORDER BY CREDIT_C.T_CURCODE, credit_c.t_CreditNumber, t.t_objecttypeid_ref, t.t_objectnumber_ref, t.t_DUTYSTAGEID_REF");

   rsRow = RsdRecordset(RSDcmd);
   RSDcmd.execute;

   IF (Obj.FileOpen (FileNameCSV, TRUE))
      WHILE (rsRow.MoveNext())
         Obj.AddCell(rsRow.value ("FLAG",           NULL, V_STRING));
         Obj.AddCell(rsRow.value ("UsCreditNumber", NULL, V_STRING));
         Obj.AddCell(rsRow.value ("PName",          NULL, V_STRING));
         Obj.AddCell(rsRow.value ("CName",          NULL, V_STRING));
         Obj.AddCell(rsRow.value ("CCY",            NULL, V_STRING));
         Obj.AddCell(rsRow.value ("DStage",         NULL, V_STRING));
         Obj.AddCell(rsRow.value ("PSum",           NULL, V_MONEY));
         Obj.AddCell(rsRow.value ("EDate",          NULL, V_INTEGER));

         IF (rsRow.value ("ObjID", NULL, V_INTEGER) == 6)
            Obj.AddCell(LnSelectValue("SELECT T_USERNUMBER FROM DDUTY_CRD_DBT WHERE T_DUTYID = " + rsRow.value ("ObjN", NULL, V_INTEGER), V_STRING));
         ELSE
            Obj.AddCell("");
         END;

         Obj.AddRow ();
      END;
   END;
   Obj.FileClose ();

   IF (ExcelObj.OpenTemplate (TemplateName))
      ExcelObj.SetValue_NameCell("Head", "Предстоящие погашения (просрочки) на " + AdvDate);
      TemplateTable = ExcelObj.RegisterTable ("rowtemp");
      TemplateTable.FillTabelFromCSV (FileNameCSV, 1);
      TemplateTable.EndTable ();
      ExcelObj.SaveAsTemplate ();
   END;
END;