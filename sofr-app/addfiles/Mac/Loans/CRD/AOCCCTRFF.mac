/*
$Name:              AOCCCTRFF.mac
$Module:            Кредитование
$Description:      пост обработка операции Проверка условия изменения тарифа.
*/
import "rate_change.mac";
record Операция("crd_op.dbt", "loans.def");    /*операция по договору*/
record batch_op ("lbatchop.dbt"); // пакетная операция (для оптимизированного пакетного режима, group_mode == true)

private MACRO AfterOper(Тип_объекта,Номер_объекта,ДатаОперации)
var Виды_опраций = CF_RATE;
var Дата_начала_действия = ДатаОперации;

var RateCh = TRate_change(Тип_объекта,Номер_объекта,ДатаОперации,Виды_опраций); 
    RateCh.послеПроверкиУсловияИзмененияТарифа(Дата_начала_действия);
    if (RateCh.Выполнить!=0)
        println("Операция выполнена успешно. Номер операции ", RateCh.OpID);
    END;         
        
   OnError(err)
      IF (ValType(err.Err) == V_INTEGER)
         println("Номер ошибки:",RateCh.NumError);
         println("Ошибка:", RateCh.TxtError);
      END;      
END;

/* В случае ошибки возвращать false*/
macro ПроверкиПользователя(group_mode:bool)
VAR operation = TRecHandler("crd_op.dbt", "loans.def");
Copy(operation, Операция);
if (group_mode == false) 
 AfterOper( operation.rec.OBJECTTYPEID_REF,
            operation.rec.OBJECTID_REF,
            operation.rec.CREDOPERDATE);
 END;

   return true; //успешно
  //return false; - ошибка, необходимо откатить операцию(операции)
  //для group_mode == true:
  // - макрос запускается один раз после выполнения всей пакетной операции
  // - список операций для отката формируется по payment.tmp.
  // - в функции ПроверкиПользователя() необходимо в Payment.tmp вставить записи с objid и objn
  //   тех объектов, по которым нужно откатить операцию, сформированную в рамках текущей пакетной.
end;
