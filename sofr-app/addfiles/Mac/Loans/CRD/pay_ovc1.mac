/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pay_crd.mac
 Description : Создание документа по шагу операции (операция возникновения овердрафта)

 Programmer  : Терещенко Ф.С.
 21.01.04    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter;

record ШагОперации (step_op,        "loans.def");     /* Запись шага операции */
record Документ    (doc_acc,        "loans.def");     /* Буфер документа      */
record Договор     ("credit_c.dbt", "loans.def");
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Сумма       ("SUM.",         "loans.def");

MACRO ВыполнитьШаг (OperDate, Sum, Data)
  var DocID: integer;
  var stat:  integer = 0;
  var СуммаОП, НеиспЛимДо: money = $0;
/*
Входные параметры:
   Debit, Credit - пустые строки. Счета берутся из шага операции.
   Sum - массив сумм, по операции "Выдача" задается только Sum(0)
   CurCode - валюта,в которой задана сумма. Для всех операций,кроме учета и списания
             обеспечений,эта валюта равна валюте из договора.Для учета и списания обеспечений
             валюта равна валюте обеспечения
*/
  setbuff(Сумма, Sum);

  СуммаОП    = Сумма(0);
  НеиспЛимДо = ОстатокРегистра(LO_KARTA, Договор.CreditNumber, TCLTR_LIMDUTY, OperDate);

  Документ.CarrySum = min(СуммаОП, НеиспЛимДо);
  stat = СоздатьДокумент(Документ, DocID);

  if ((stat == 0) AND (DocID != 0))
      stat = ИзменитьРегистр(LO_KARTA, Операция.ObjectID_Ref, TDR_MAINREST, DocID, min(СуммаОП, НеиспЛимДо));
  end;

  return stat;
End;