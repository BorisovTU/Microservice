/*
$Name:             genagr02.mac
$Module:           Кредитование
$Description:      ГЕНЕРАЛЬНОЕ СОГЛАШЕНИЕ об овердрафтных кредитах 
*/
import ActiveX, total, replib, global, dlwreps, replib;;

private record cur_credit ("credit_c.dbt", "loans.def");
private file   currency  ("fininstr.dbt", "bank.def");
private FILE   crdacc    ("igCrdAcc.dbt", "loans.def") key 0;
private FILE   igsetacc  ("igSetAcc.dbt", "loans.def") key 0;
private var 	 BankName:string;
private const  TemplateName = "genagr02.dot";


macro RunReport(CreditBuf)

      const ДолжностьПредставителяЗаемщика = 77,
            ЦельПолученияКредита = 79;

      var ПроцОД, ФИО, Sum, ExtCurCode ;

      SetBuff(cur_credit, CreditBuf);
      if (not depclnt.GetRecord({OurBank}))
          RunError ("Не найдены сведения о банках");
      end;
      BankName = depclnt.Name;
      if (not depclnt.GetRecord(cur_credit.ClientID_Ref))
          RunError ("Не найден заещик в справочнике клиентов");
      end;                             
      if (cur_credit.Crd_kind != LO_GENAGGROV)
          RunError ("ГЕНЕРАЛЬНОЕ СОГЛАШЕНИЕ об об овердрафтных кредитах формируется| только по ген. соглашению об овердрафте!");
      end;
      
      ПроцОД = Loans_FindRateVal(cur_credit.Crd_kind, cur_credit.CreditNumber, TRU_CRD, cur_credit.ReturnDate);
      
      /* Код валюты 810 - рубли, 840 - USD и т.д.*/
      currency.FIID = cur_credit.CurCode;         
      if(getEQ(currency))                       
          ExtCurCode = currency.ISO_Number;
      end; 

      ФИО = depclnt.ConvertFIOFull();

      SetOutput (GetTxtFileName("genagr02_rep"));
      
      println(TemplateName); //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа
      
      /* № договора */
      [~CrdNum];
      println (cur_credit.UsCreditNumber);
      /*Дата регистрации*/
      [~RegDate];
      println (DateToStringFull (cur_credit.RegDate));
      /* ФИО заёмщика */
      [~BankName];
      println (BankName);
      /* ФИО заёмщика */
      [~FIO];
      println (ФИО);
      /*Счет клиента*/
      [~AccuntKarta];
      println (cur_credit.AccountKarta);
      /* Дата окончания договора */
      [~ReturnDate];
      println (DateToStringFull (cur_credit.ReturnDate));
      /*Наименование банка*/
      [~BankName2];
      println(BankName);

      /* Полное имя заемщика */
      [~FullName];
      println(depclnt.Name);

     /* Юридический адрес */
      [~Address];
      println ( CONST_POSTADDR );

      /* Серия паспорта и номер */
      [~Passport];
      if (trim(DepClnt.PaperSeries) != "")
         println("Серия: " + trim(DepClnt.PaperSeries) + " №"+ trim(DepClnt.PaperNumber));
      else
         println("№"+ trim(DepClnt.PaperNumber));
      end;
      /* Кем и когда выдан паспорт берется из формы клиента */
      [~DatePassport];
      println(depclnt.PaperIssuer + " " + depclnt.PaperIssuedDate);


      /* Адрес заемщика */
      [~AddressZaem];
      println (depclnt.Address);
      /* Адрес проживания заёмщика */
      [~PAddressZaem];
      if (trim(DepClnt.AddressF) != "")
         println (DepClnt.AddressF);
      else /* Адрес проживания не указан - подставляем адрес прописки */
         println (DepClnt.Address);
      end;

      /* Реквизиты банка */
      [~INN];
      println ( CONST_INN );
      [~CorrAcc];
      println ( CONST_CORRACC );
      [~BIC];
      println ( CONST_BIK );

      /* Телефоны заемщика */
      [~Phone];
      println (depclnt.PhoneNumber);
      [~Fax];
      println (depclnt.Fax);

      /* Кредитор: Фамилия И. О. */
      [~Creditor];
      println (GetShortFIO(GetStrPart(GetUsFieldValue(cur_credit.Crd_kind, cur_credit.CreditNumber, ФИОКредитора, cur_credit.RegDate),1)));

      /* Фамилия И.О. представителя заемщика*/
      [~FioPredst];
      println (GetUsFieldValue(cur_credit.Crd_kind, cur_credit.CreditNumber, ДолжностьПредставителяЗаемщика));

      var tag = SetOutput (NULL, false);
      return tag;

      onError(axerr)
         SetOutput(NULL, false);
         RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Печатная форма сформирована.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;