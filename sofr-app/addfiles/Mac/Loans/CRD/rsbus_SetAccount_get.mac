/*--------------------------------------------------------------------------------------
              
Filename    : rsbus_SetAccount_get.mac                                              
Description : реализация сервиса формирования данных по СПИ  
03.09.13    : Создан
Programmer  : Shershnev Victor
--------------------------------------------------------------------------------------*/
import TOTAL, RSBUS_STRUCTS, RSBUS_CHECK,"rsbus_checkusr.mac";
//номер сервиса согласно списоку сервисов описананых в rsbus_checkusr.mac
private const NumServ:integer = NumServ_GetSetAccount;

record credContr(credit_c);
var TYPACC=Tbfile("IGTYPACC.DBT","W");

Macro GetSetACcount (CreditID:integer ,CreditNumber: string, TypeAccList)
                                                                     
   var SetAccountData :TSetAccountData;

   FindCrd(@CreditID, CreditNumber, credContr);
   var i:integer;
   var j:integer = 0;

   if (ValType(TypeAccList) == V_UNDEF)
       TypeAccList= TArray();
       TypeAccList[0]=1;
       TypeAccList[1]=2;
   end;

   // Если нужно, то проверим пользовательской функцией
   if(NOT skip_user_chec.GetSetACcount)
      if(NOT GetSetACcountUserCheck(NumServ,credContr,TypeAccList))
         return 0;
      end;
   end;
   
   TYPACC.Clear();
   TYPACC.KeyNum=0;
       
     for(i, 0, TypeAccList.size - 1, 1)
       TYPACC.rec.TYPEACCID=TypeAccList[i];
           if (NOT TYPACC.GetEQ())
                RunError("Неверный тип счета другой подсистемы "+TypeAccList[i], 18766);
               
           end;

       var RSDCmd = RsdCommand(RslDefCon, " SELECT crd.*,acc.*  FROM digCrdAcc_dbt crd , digSetAcc_dbt   acc "+
                               "  WHERE     crd.t_creditNumber  = ? AND crd.t_TypeAccId  = ?  "+
                               "  AND crd.t_SetAccId = acc.T_SETTACCID ");

       RSDcmd.addParam ("creditNumber",     RSDBP_IN); RSDcmd.value ("creditNumber") = CreditID;
       RSDcmd.addParam ("first",    RSDBP_IN); RSDcmd.value ("first") = TypeAccList[i];

       var rs = RsdRecordset(RSDcmd);
       RSDcmd.execute;
            if(rs.MoveNext)
          
          SetAccountData.setAccountList[j] = TSetAccountGet();
          SetAccountData.setAccountList[j].Type = rs.value("T_TypeAccID");
          if ( rs.value("T_Description") ==StrFor(1))
             SetAccountData.setAccountList[j].TypeName ="";
          else
             SetAccountData.setAccountList[j].TypeName = rs.value("T_Description");
          end;
          if ( rs.value("T_Account") ==StrFor(1))
             SetAccountData.setAccountList[j].AccountNumber ="";
          else
             SetAccountData.setAccountList[j].AccountNumber = rs.value("T_Account");
          end;
          SetAccountData.setAccountList[j].AccountCurCode = getCurISOl(rs.value("T_FIID"));
          if ( rs.value("T_PartyID")==NULL)
              SetAccountData.setAccountList[j].ClientID  = 0;
          else
             SetAccountData.setAccountList[j].ClientID  = rs.value("T_PartyID");
          end;
          if ( rs.value("T_INN") ==StrFor(1))
             SetAccountData.setAccountList[j].ClientINN="";
          else
             SetAccountData.setAccountList[j].ClientINN = rs.value("T_INN"); 
          end;
          if ( rs.value("T_RecName") ==StrFor(1))
             SetAccountData.setAccountList[j].ClientName="";
          else
             SetAccountData.setAccountList[j].ClientName = rs.value("T_RecName");
          end;
          SetAccountData.setAccountList[j].Department  = rs.value("T_OperDprt");
          SetAccountData.setAccountList[j].Bank.BankID  = rs.value("T_BankID");
          SetAccountData.setAccountList[j].Bank.BankCodeKind  = rs.value("T_BankCodeKind");
          if ( rs.value("T_BankCode") ==StrFor(1))
             SetAccountData.setAccountList[j].Bank.BankCode="";
          else
             SetAccountData.setAccountList[j].Bank.BankCode = rs.value("T_BankCode");
          end;
          if ( rs.value("T_BankName") ==StrFor(1))
             SetAccountData.setAccountList[j].Bank.BankName="";
          else
             SetAccountData.setAccountList[j].Bank.BankName = rs.value("T_BankName");
          end;
          SetAccountData.setAccountList[j].BankCorr.BankID = rs.value("T_BankCorrID");
          SetAccountData.setAccountList[j].BankCorr.BankCodeKind = rs.value("T_BankCorrCodeKind");
          if ( rs.value("T_BankCorrCode") ==StrFor(1))
               SetAccountData.setAccountList[j].BankCorr.BankCode ="";
          else
               SetAccountData.setAccountList[j].BankCorr.BankCode = rs.value("T_BankCorrCode");   
          end;
          if ( rs.value("T_BankCorrName") ==StrFor(1))
               SetAccountData.setAccountList[j].BankCorr.BankName ="";
          else
               SetAccountData.setAccountList[j].BankCorr.BankName= rs.value("T_BankCorrName");    
          end;
          SetAccountData.setAccountList[j].UsePriority  = rs.value("T_UsePriority");
          
          j=j+1; 
      end;

     end;
  
      SetAccountData.ID = CreditID;
      SetAccountData.number = credContr.USCREDITNUMBER;
      SetAccountData.AccCount = j; 
    
   return SetAccountData;
end;

