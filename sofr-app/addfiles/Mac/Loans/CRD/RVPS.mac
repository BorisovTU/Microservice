/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : Rvps.mac
 Description : Расчет резерва на возможные потери по ссудам

 Programmer  :
 27.04.01    : Создан

 16.11.01, US:
 1. Исключена их макроса функция получения курса валюты, константы, файлы,
    связанные с валютами. Используется функция из totalovc.mac
 2. Льготость кредит определяется теперь по флагу в кред.договоре.
 3. Разделены группы "Льготные кредиты" и "Кредиты инсайдерам"
    Если кредит выдан инсайдеру, и он льготный, по такой договор попадает
    в раздел инсайдеров.
 4. Добавлена константа ОВЕРДРАФТ - признак обработки овердрафтных карт.

------------------------------------------------------------------------------*/

IMPORT "rvps_12.mac", ActiveX;

FILE   Филиалы   ("set_lfd.tmp", "loans.def"); /* временный файл филиалов */

var DatePrevReport : Date,
    DateReport : Date = {curdate},
    DepSelect:bool;

private var ErrCode, workpath, FNCashStr:string = "";

if(GetRegistryValue ("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\WORKDIR", V_STRING, workpath, ErrCode) != V_STRING) 
    msgBox(ErrCode);                                                                                             
    return true;                                                                                                 
end;                                                                                                             

MACRO ReadBeginParm ()
  VAR dp_dep  = TBFile ("dp_dep.dbt","r", 1);

  IF(GetDate(DateReport, "Введите дату отчета") == FALSE)
    RETURN FALSE;
  END;
  DatePrevReport = DateReport - 30;
  IF(GetDate(DatePrevReport, "Введите дату предыдущего отчета") == FALSE)
    RETURN FALSE;
  END;

  depSelect = false;
  while (not depSelect)
     if (УстановитьФилиалы() == false)
        return;
     else
        rewind(Филиалы);
        while(next(Филиалы) and (not depSelect))
           if (Филиалы.SetFlag == "X")
              depSelect = true;
           end;
        end;
        if (not depSelect)
           MsgBox("Не выбрано ни одно подразделение!");
           Close (Филиалы);
        end;
     end;
  end;
  rewind(Филиалы);
  while(next(Филиалы))
      if (Филиалы.SetFlag == "X")
          FNCashStr = FNCashStr + ", " + Филиалы.FNCash;
      end;
  end;
  FNCashStr = substr(FNCashStr, 3);
  RETURN TRUE;
END;


/*******************************************************************************
 **                             Основной макрос                               **
 *******************************************************************************/
MACRO RVPS ()

  IF (ReadBeginParm())
    NewExcelWorkbook (False, "rvps.xls");
    Print12a(DateReport, DatePrevReport, FNCashStr);
    Print12b(DateReport, DatePrevReport, FNCashStr);
    ExcelApplication.Visible = true;
  END;
END;
