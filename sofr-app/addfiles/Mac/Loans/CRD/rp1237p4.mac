/*
$Name:             rp1237p4.mac
$Module:           Кредитование
$Description:      rp1237p4.mac
*/

IMPORT ActiveX, total;

PRIVATE VAR Филиалы = TBFile ("set_lfd.tmp", "r", 0); /* временный файл филиалов */

private var DatePrevReport : Date,
            DateReport     : Date = {curdate},
            DepSelect      : bool,
            FNCashStr      : string = "";

MACRO ReadBeginParm ()
  IF(GetDate(DateReport, "Введите дату отчета") == FALSE)
    RETURN FALSE;
  END;
  DatePrevReport = DateReport - 30;
  IF(GetDate(DatePrevReport, "Введите дату предыдущего отчета") == FALSE)
    RETURN FALSE;
  END;

  depSelect = false;
  while (not depSelect)
     if (УстановитьФилиалы() == false)
        return;
     else
        Филиалы.rewind;
        while(Филиалы.next and (not depSelect))
           if (Филиалы.rec.SetFlag == "X")
              depSelect = true;
           end;
        end;
        if (not depSelect)
           MsgBox("Не выбрано ни одно подразделение!");
        end;
     end;
  end;
  Филиалы.rewind;
  while(Филиалы.next)
      if (Филиалы.rec.SetFlag == "X")
          FNCashStr = FNCashStr + ", " + Филиалы.rec.FNCash;
      end;
  end;
  FNCashStr = substr(FNCashStr, 3);
  RETURN TRUE;
END;


macro PrintRep()
var query: string,
    ActSheet : Object,
    num: integer = 1,
    I: integer,
    J: integer,
    CaseItogStrNum: integer,
    Row: integer,
    CaseID,
    CrdNum: integer,
    ObjType: integer,
    PayType: integer,
    AccountType: string = "",
    Rate: double,
    rs = NULL,
    rs1 = NULL,
    rs5 = NULL;
VAR Itog = TArray(20);
VAR CaseItog = TArray(20);
VAR RowData  = TArray(20);
var СуммыПоГрРиска = Tarray;
var СуммыПоГрРискаПортф = Tarray;
var СуммаЗалогов = $0;
var СуммаПоручит = $0;
var curcode_temp: INTEGER;

    СуммыПоГрРиска.Size = 4;
    СуммыПоГрРискаПортф.Size = 4;

    I = 0;
    while(I<5)
        СуммыПоГрРиска[I] = TArray;
        СуммыПоГрРискаПортф[I] = TArray;
        J = 0;
        while(J<5)
            СуммыПоГрРиска[I][J] = $0;
            СуммыПоГрРискаПортф[I][J] = $0;
            J = J + 1;
        end;
        I = I + 1;
    end;

    I = 8;
    while(I<20)
       CaseItog(I) = 0;
       Itog(I) = 0;
       I = I + 1;
    end;

    ActSheet = ExcelApplication.ActiveSheet; /*Активная страница*/
    ActSheet.Cells (5, 10).Value = "по состоянию на " + String(DateReport:m);
    query = "SELECT * FROM DCREDIT_C_DBT c WHERE ((c.t_PayType IN (3, 4, 5)) " + 
               " OR c.t_Crd_Kind = " + LO_GUARANTEE +
               " OR c.t_Crd_Kind = " + LO_KARTA +
               " OR c.t_Crd_Kind = " + LO_OVERDRAFT + ")" +
              " AND c.t_RegDate <= " + SQLDate(DateReport) +
              " AND c.t_ReturnDate >= " + SQLDate(DatePrevReport) +
              " AND c.T_FNcash IN (" + FNCashStr + ")" +
              " ORDER BY t_Crd_Kind";

    rs = LnGetRecordSet(query);

    if (rs == NULL) return; end;
    Row = 10;
    while(rs.MoveNext()) /*цикл по кредитным договорам*/

       crdNum = rs.Value("t_creditnumber", NULL, V_INTEGER);
       query = "SELECT c.T_SYSTEMOPERATIONID " +
                 "FROM DLBFRCCRD_DBT a, DCRD_OP_DBT c "+
                 "WHERE a.T_OBJECTNUMBER = " + crdNum +
                  " AND a.T_CREDOPERID_REF = " +
                     "(SELECT MAX(b.T_CREDOPERID_REF) FROM DLBFRCCRD_DBT b " +
                        "WHERE b.T_OBJECTNUMBER = " + crdNum +
                     ") AND c.T_CREDOPERID = a.T_CREDOPERID_REF";
       rs1 = LnGetRecordSet(query);
       if ((rs1 == NULL) OR (rs1.MoveNext() == FALSE) OR (rs1.Value(0, NULL, V_INTEGER) == 37))

           ObjType = rs.Value("t_Crd_kind", NULL, V_INTEGER);
           PayType = rs.Value("t_PayType", NULL, V_INTEGER);   // Тип выдачи

           Rate = GetRate(DateReport, rs.Value("t_curcode", NULL, V_INTEGER));  // курс валюты

           /*№ позиции*/
           RowData(1) = num;

           /*Наименование заемщика*/
           RowData(2) = LnSelectValue("SELECT T_Name from Dparty_dbt where T_PartyID = " + rs.Value(3, NULL, V_INTEGER), V_STRING);
          /*№ счета по учету обязательств*/

           if (ObjType == LO_CREDIT)
              RowData(3) = "Ссуда";
              if (PayType == CF_CRLINNO)            // Лимит выдачи
                  AccountType = CF_UNUSED_CRD_LINE; // Неиспользованные кредитные линии
              elif (PayType == CF_CRLINNEW)         // Лимит задолженности
                  AccountType = CF_UNUSED_LIMIT;    // Неиспользованные лимиты
              elif (PayType == CF_CRLIN)            // Лимит выд + зад
                   AccountType = CF_UNUSED_LIMIT;
              end;

           elif (ObjType == LO_KARTA)
              RowData(3) = "Карта";
              AccountType = CF_UNUSED_LIMIT;  // Неиспользованные лимиты

           elif (ObjType == LO_OVERDRAFT)
              RowData(3) = "Овердрафт";
              AccountType = CF_UNUSED_LIMIT;

           elif (ObjType == LO_GUARANTEE)
              AccountType = CF_PAYEDGUARANTEES;     // Счет выданных гарантий
              if (PayType == CF_GUARANTEE)
                 RowData(3) = "Гарантия";
              elif (PayType == CF_GUARANTEELINE)
                 RowData(3) = "Гарантийная линия";
              end;
           end;

           rs5 = LnGetRecordSet("SELECT T_AccountNumber_Ref from dacc_crd_dbt" +
                                         " where T_CurCode = " + rs.Value("t_curcode", NULL, V_INTEGER) +
                                         " AND T_CreditAccountType IN (" + AccountType + ")"
                                         " AND T_ObjectID = " +  ObjType +
                                         " AND T_ObjectNumber = " + crdNum);

           if (rs5 == null)
               return 0;
           end;
           RowData(4) = "";
           if (rs5.MoveNext())
               RowData(4) = rs5.Value("T_AccountNumber_Ref", NULL, V_STRING);
           end;
           /*Наименование валюты*/
           RowData(5) = LnSelectValue("select f.T_CCY from dfininstr_dbt f where f.t_fiid = " + rs.Value("t_curcode", NULL, V_INTEGER), V_STRING);
           if(rs.Value("t_curcode", NULL, V_INTEGER) != 0)
               if(PayType == CF_CRLIN)       // Лимит выдачи+задолженности
                   /*База резерва в инвалюте на предыдущую отчетную дату*/
                   RowData(6) = Min(ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport),
                                    ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY , DatePrevReport));
                   /*База резерва в инвалюте на отчетную дату*/
                   RowData(7) = Min(ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport),
                                    ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY , DateReport));
               elif(PayType == CF_CRLINNO)                        // кредитная линия под лимит выдачи
                   RowData(6) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY, DatePrevReport);
                   RowData(7) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY, DateReport);
               elif(((PayType == CF_GUARANTEE) or (PayType == CF_GUARANTEELINE)) and (ObjType == LO_GUARANTEE)) // гарантия
                   RowData(6) = ОстатокРегистра(ObjType, crdNum, TDR_PAYEDGUARANTEE, DatePrevReport);
                   RowData(7) = ОстатокРегистра(ObjType, crdNum, TDR_PAYEDGUARANTEE, DateReport);
               elif(PayType == CF_CRLINNEW)                      // кредитная линия под лимит задолженности
                   RowData(6) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport);
                   RowData(7) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport);
               elif(ObjType == LO_KARTA)                         // Овердрафт
                   RowData(6) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport);
                   RowData(7) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport);
               end;
               /*База резерва в рублевом эквиваленте на предыдущую отчетную дату*/
               RowData(8) = money(round(Rate*RowData(6)));
               /*База резерва в рублевом эквиваленте на отчетную дату*/
               RowData(9) = money(round(Rate*RowData(7)));
           else
               Rate = 1;
               RowData(6) = 0;
               RowData(7) = 0;
               RowData(8) = 0;
               RowData(9) = 0;
               if(PayType == CF_CRLIN)       // Лимит выдачи+задолженности
                   /*База резерва на предыдущую отчетную дату*/
                   RowData(8) = Min(ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport),
                                    ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY , DatePrevReport));
                   /*База резерва на отчетную дату*/
                   RowData(9) = Min(ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport),
                                    ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY , DateReport));
               elif(PayType == CF_CRLINNO)                        // кредитная линия под лимит выдачи
                   RowData(8) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY, DatePrevReport);
                   RowData(9) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY, DateReport);
               elif(((PayType == CF_GUARANTEE) or (PayType == CF_GUARANTEELINE)) and (ObjType == LO_GUARANTEE)) // гарантия
                   RowData(8) = ОстатокРегистра(ObjType, crdNum, TDR_PAYEDGUARANTEE, DatePrevReport);
                   RowData(9) = ОстатокРегистра(ObjType, crdNum, TDR_PAYEDGUARANTEE, DateReport);                                           // гарантия
               elif(PayType == CF_CRLINNEW)                      // кредитная линия под лимит задолженности
                   RowData(8) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport);
                   RowData(9) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport);
               elif(ObjType == LO_KARTA)                         // Овердрафт
                   RowData(8) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport);
                   RowData(9) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport);
               end;
           end;
           /*Стоимостная оценка принятого обеспечения (I категория качества)*/
           СуммаЗалогов =   LnSelectValue("select sum(b.T_RezSum) from dens_crd_dbt a, decn_eob_dbt b, densobj_dbt c " +
                                                  "where a.T_ENSCONTRACTID_REF = b.T_ENSCONTRACTID_REF and " +
                                                    "b.T_ENSOBJECTID_REF = c.T_ENSOBJECTID and " +
                                                    "c.T_QualityID_Ref = 1 and a.T_CreditNumber_Ref = " +CrdNum, V_MONEY);

           СуммаПоручит =   LnSelectValue("select Sum(b.T_ENSCONTRACTSUM) from dens_crd_dbt a, denscontr_dbt b " +
                                                   "where b.T_QualityID_Ref = 1 AND " +
                                                     "b.T_EnsContractID = a.T_EnsContractID_Ref AND " +
                                                     "b.T_ENSSYSTYPE = 1 AND " +
                                                     "a.T_CreditNumber_Ref = " +CrdNum, V_MONEY);

           RowData(10) =  money(round(rate * (СуммаЗалогов + СуммаПоручит)));

           /*Стоимостная оценка принятого обеспечения (II категория качества)*/
           СуммаЗалогов =   LnSelectValue("select sum(b.T_RezSum) from dens_crd_dbt a, decn_eob_dbt b, densobj_dbt c " +
                                                  "where a.T_ENSCONTRACTID_REF = b.T_ENSCONTRACTID_REF and " +
                                                    "b.T_ENSOBJECTID_REF = c.T_ENSOBJECTID and " +
                                                    "c.T_QualityID_Ref = 2 and a.T_CreditNumber_Ref = " +CrdNum, V_MONEY);

           СуммаПоручит =   LnSelectValue("select Sum(b.T_ENSCONTRACTSUM) from dens_crd_dbt a, denscontr_dbt b " +
                                                   "where b.T_QualityID_Ref = 2 AND " +
                                                     "b.T_EnsContractID = a.T_EnsContractID_Ref AND " +
                                                     "b.T_ENSSYSTYPE = 1 AND " +
                                                     "a.T_CreditNumber_Ref = " +CrdNum, V_MONEY);
           RowData(11) =  money(round(rate * (СуммаЗалогов + СуммаПоручит)));

           /*Группа риска на предыдущую отчетную дату*/
           RowData(12) = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                          "where c.T_ObjectNumber = " +CrdNum+ " AND " +
                                            "(c.T_ObjectTypeID = 1 OR c.T_ObjectTypeID = 8 OR c.T_ObjectTypeID = 21) AND " +
                                             "c.T_Type = 2 AND " +
                                             "c.T_CredOperID_Ref <> 0 AND " +
                                             "c.T_Date = " +
                                              "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                 "where t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                   "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8 OR t.T_ObjectTypeID = 21) AND t.T_Date <= " + SQLDate(DatePrevReport) + ")", V_INTEGER);


           /*Группа риска на  отчетную дату*/
           RowData(13) = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                          "where c.T_ObjectNumber = " +CrdNum+ " AND " +
                                            "(c.T_ObjectTypeID = 1 OR c.T_ObjectTypeID = 8 OR c.T_ObjectTypeID = 21) AND " +
                                             "c.T_Type = 2 AND " +
                                             "c.T_CredOperID_Ref <> 0 AND " +
                                             "c.T_Date = " +
                                              "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                 "where t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                   "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8 OR t.T_ObjectTypeID = 21) AND t.T_Date <= " + SQLDate(DateReport) + ")", V_INTEGER);

           /*Норматив резерва (%) на предыдущую отчетную дату*/
           RowData(14) = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                          "where a.T_ObjectNumber = " +CrdNum + " AND " +
                                            "(a.T_ObjectTypeID = 1 OR a.T_ObjectTypeID = 8 OR a.T_ObjectTypeID = 21) AND " +
                                             "a.T_Type = 2 AND " +
                                             "a.T_CredOperID_Ref <> 0 AND " +
                                             "a.T_Date = " +
                                              "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                 "where  t.T_ObjectNumber = " +CrdNum+ " AND " +
                                               "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8 OR t.T_ObjectTypeID = 21) AND t.T_Date <= " + SQLDate(DatePrevReport) + ")", V_NUMERIC)/100;

           /*Норматив резерва (%) на отчетную дату*/
           RowData(15) = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                          "where a.T_ObjectNumber = " +CrdNum + " AND " +
                                            "(a.T_ObjectTypeID = 1 OR a.T_ObjectTypeID = 8 OR a.T_ObjectTypeID = 21) AND " +
                                             "a.T_Type = 2 AND " +
                                             "a.T_CredOperID_Ref <> 0 AND " +
                                             "a.T_Date = " +
                                              "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                                 "where  t.T_ObjectNumber = " +CrdNum+ " AND " +
                                                   "(t.T_ObjectTypeID = 1 OR t.T_ObjectTypeID = 8 OR t.T_ObjectTypeID = 21) AND t.T_Date <= " + SQLDate(DateReport) + ")", V_NUMERIC)/100;

           /*Расчетный резерв на отчетную дату*/
           if(RowData(10) > 0)
               RowData(16) = money(round((RowData(9)-RowData(10))*RowData(15)));
           else
               RowData(16) = money(round((RowData(9)-RowData(11)/2)*RowData(15)));
           end;
           RowData(16) = max (0, RowData(16)); // Расчетный резев не может быть меньше нуля

           /*Фактически созданный резерв на последний рабочий день месяца*/
           RowData(17) = ОстатокРегистра(ObjType, crdNum, TREG_REZ232, DateReport);
           RowData(17) = max (0, RowData(17));

           /*Расчетное изменение резерва с доначислением*/
           RowData(18) = RowData(16) - RowData(17);
           RowData(18) = max (0, RowData(18));

           /*Расчетное изменение резерва с уменьшением*/
           RowData(19) = RowData(17) - RowData(16);
           RowData(19) = max (0, RowData(19));

           if(RowData(13) > 0)
               СуммыПоГрРиска[RowData(13)-1][0] = СуммыПоГрРиска[RowData(13)-1][0] + RowData(8);
               СуммыПоГрРиска[RowData(13)-1][1] = СуммыПоГрРиска[RowData(13)-1][1] + RowData(10) + RowData(11);
               СуммыПоГрРиска[RowData(13)-1][2] = СуммыПоГрРиска[RowData(13)-1][2] + RowData(16);
               СуммыПоГрРиска[RowData(13)-1][3] = СуммыПоГрРиска[RowData(13)-1][3] + RowData(17);
           else
               PrintLn("Не задана группа риска договор " + rs.Value("t_uscreditnumber", NULL, V_STRING));
           end;

           IF ((ОстатокНаСчете(ObjType, CrdNum, rs.Value("t_curcode", NULL, V_INTEGER), AccountType, DateReport) != 0) /*остаток на счете*/
               or (RowData(6) != 0) or (RowData(7) != 0)                   /*База резерва в инвалюте*/
               or (RowData(8) != 0) or (RowData(9) != 0)                   /*База резерва в рублевом эквиваленте*/
               or (RowData(16) !=0)                                        /*Расчетный резерв на отчетную дату*/
               or (RowData(17) !=0)                                        /*Фактически созданный резерв на последний рабочий день месяца*/
               or (RowData(18) !=0) or (RowData(19) != 0))                 /*Расчетное изменение резерва*/
               I = 1;
               while(I<20)
                  ActSheet.Cells (Row, I).Value = RowData(I);
                  if(I > 7)
                     Itog(I) = Itog(I) + RowData(I);
                  end;
                  RowData(I) = 0;
                  I = I + 1;
               end;
               num = num + 1;
               Row = Row + 1;
               ActSheet.Rows(Int(Row)).Insert;
           END;
       end;
    end; /*цикл по кредитным договорам*/
    ActSheet.Rows(Int(Row)).Delete;
    Row = Row + 1;

    CaseItogStrNum = Row - 1;
    query = "SELECT * FROM DLBRFCASE_DBT c WHERE c.t_Type = 0 "
               " AND c.t_BeginDate <= " + SQLDate(DateReport) +
               " AND c.T_FNcash IN (" + FNCashStr + ")";
    rs = LnGetRecordSet(query);

    if (rs == NULL) return; end;

    while(rs.MoveNext()) /*цикл по портфелям*/

        CaseID = rs.Value("t_briefcaseid", NULL, V_INTEGER);  // ID Порфеля

        query = "select * from dcredit_c_dbt c where c.T_CREDITNUMBER IN " +
                  "(select f.T_OBJECTNUMBER from dlbfrccrd_dbt f, dcrd_op_dbt o " +
                     "where f.T_BRIEFCASEID_REF = " + CaseID + " AND " +
                       "o.T_SYSTEMOPERATIONID != 37 and o.T_CREDOPERID = f.T_CREDOPERID_REF and " +
                       "f.T_CREDOPERID_REF = (select max(s.T_CREDOPERID_REF) from dlbfrccrd_dbt s " +
                                               "where s.T_BRIEFCASEID_REF = " +CaseID+ " and s.T_OBJECTNUMBER = f.T_OBJECTNUMBER))";
        rs1 = LnGetRecordSet(query);
        if (rs1 == NULL) return; end;
        RowData(8) = 0;
        RowData(9) = 0;
        while(rs1.MoveNext()) /*цикл по договорам, входящим в портфель*/
           CrdNum = rs1.Value("t_creditnumber", NULL, V_INTEGER);    // ID Объекта
           PayType = rs1.Value("t_paytype", NULL, V_INTEGER);   // Тип выдачи
           ObjType = rs1.Value("t_crd_kind", NULL, V_INTEGER);
           if(rs1.Value("t_curcode", NULL, V_INTEGER) > 0)
               Rate = GetRate(DateReport, rs1.Value("t_crd_kind", NULL, V_INTEGER));  // курс валюты
           else
               Rate = 1;
           end;

           if(PayType == CF_CRLIN)       // Лимит выдачи+задолженности
               /*База резерва в инвалюте на предыдущую отчетную дату*/
               RowData(6) = Min(ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport),
                                ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY , DatePrevReport));
               /*База резерва в инвалюте на отчетную дату*/
               RowData(7) = Min(ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport),
                                ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY , DateReport));
           elif(PayType == CF_CRLINNO)                        // кредитная линия под лимит выдачи
               RowData(6) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY, DatePrevReport);
               RowData(7) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMPAY, DateReport);
           elif(((PayType == CF_GUARANTEE) or (PayType == CF_GUARANTEELINE)) and (ObjType == LO_GUARANTEE)) // гарантия
               RowData(6) = ОстатокРегистра(ObjType, crdNum, TDR_PAYEDGUARANTEE, DatePrevReport);
               RowData(7) = ОстатокРегистра(ObjType, crdNum, TDR_PAYEDGUARANTEE, DateReport);
           elif(PayType == CF_CRLINNEW)                      // кредитная линия под лимит задолженности
               RowData(6) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport);
               RowData(7) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport);
           elif(ObjType == LO_KARTA)                         // Овердрафт
               RowData(6) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DatePrevReport);
               RowData(7) = ОстатокРегистра(ObjType, crdNum, TCLTR_LIMDUTY, DateReport);
           end;
           /*База резерва в рублевом эквиваленте на предыдущую отчетную дату*/
           RowData(8) = money(round(RowData(8) + Rate*RowData(6)));
           /*База резерва в рублевом эквиваленте на отчетную дату*/
           RowData(9) = money(round(RowData(9) + Rate*RowData(7)));
        end; /*цикл по договорам, входящим в портфель*/

        /*Группа риска на предыд. отчетную дату*/
        RowData(12) = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                      "where c.T_ObjectNumber = " +CaseID+ " AND " +
                                        "c.T_ObjectTypeID = 17 AND c.T_Type = 2 AND " +
                                        "c.T_CredOperID_Ref <> 0 AND c.T_Date = " +
                                         "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                            "where t.T_ObjectNumber = " +CaseID+ " AND " +
                                              "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(DatePrevReport) + ")", V_INTEGER);

        /*Категория качества на отчетную дату*/
        RowData(13) = LnSelectValue("select c.T_iRiskGroup from Dcrdrghb_dbt c " +
                                      "where c.T_ObjectNumber = " +CaseID+ " AND " +
                                        "c.T_ObjectTypeID = 17 AND c.T_Type = 2 AND " +
                                        "c.T_CredOperID_Ref <> 0 AND c.T_Date = " +
                                          "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                             "where  t.T_ObjectNumber = " +CaseID+ " AND " +
                                               "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(DateReport) + ")", V_INTEGER);

        /*Норматив резерва (%) на предыдущую отчетную дату*/
        RowData(14) = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                      "where a.T_ObjectNumber = " +CaseID+ " AND " +
                                        "a.T_ObjectTypeID = 17 AND a.T_Type = 2 AND " +
                                        "a.T_CredOperID_Ref <> 0 AND a.T_Date = " +
                                         "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                            "where  t.T_ObjectNumber = " +CaseID+ " AND " +
                                              "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(DatePrevReport) + ")", V_NUMERIC)/100;

        /*Норматив резерва (%) на отчетную дату*/
        RowData(15) = LnSelectValue("select a.T_PercentReserve from Dcrdrghb_dbt a " +
                                      "where a.T_ObjectNumber = " +CaseID+ " AND " +
                                        "a.T_ObjectTypeID = 17 AND a.T_Type = 2 AND " +
                                        "a.T_CredOperID_Ref <> 0 AND a.T_Date = " +
                                          "(select Max(t.T_Date) from Dcrdrghb_dbt t " +
                                             "where  t.T_ObjectNumber = " +CaseID+ " AND " +
                                               "t.T_ObjectTypeID = 17 AND t.T_Date <= " + SQLDate(DateReport) + ")", V_NUMERIC)/100;
        /*Расчетный резерв на отчетную дату*/
        RowData(16) = money(round(RowData(9) * RowData(15)));
        RowData(16) = max (0, RowData(16));

	 
        query = "select * from dlbrf_uniformity_dbt where T_BRIEFCASEID = " + CaseID;
        rs1 = LnGetRecordSet(query);
        Rate = 1;
	 if (rs1.MoveNext());
        	curcode_temp = rs1.Value("t_curcode", NULL, V_INTEGER);
        	if( curcode_temp > 0)
            		Rate = GetRate(DateReport, curcode_temp);  // курс валюты
        	else
            		Rate = 1;
        	end;
	 end;

        /*Фактически созданный резерв на последний рабочий день месяца*/
        RowData(17) = money(round(ОстатокРегистра(LO_CASE, CaseID, TREG_REZ232, DateReport) * Rate));
        RowData(17) = max (0, RowData(17));

        /*Расчетное изменение резерва с доначислением*/
        RowData(18) = RowData(16) - RowData(17);
        RowData(18) = max (0, RowData(18));

        /*Расчетное изменение резерва с уменьшением*/
        RowData(19) = RowData(17) - RowData(16);
        RowData(19) = max (0, RowData(19));

        if(RowData(13) > 0)
            СуммыПоГрРискаПортф[RowData(13)-1][0] = СуммыПоГрРискаПортф[RowData(13)-1][0] + RowData(9);
            СуммыПоГрРискаПортф[RowData(13)-1][1] = СуммыПоГрРискаПортф[RowData(13)-1][1] + RowData(16);
            СуммыПоГрРискаПортф[RowData(13)-1][2] = СуммыПоГрРискаПортф[RowData(13)-1][2] + RowData(17);
        else
            PrintLn("Не задана группа риска портфеля " + rs.Value("t_usernumber", NULL, V_STRING));
        end;

        ActSheet.Cells (Row, 1).Value = num;
        ActSheet.Cells (Row, 8).Value = RowData(8);
        ActSheet.Cells (Row, 9).Value = RowData(9);
        CaseItog(8) = CaseItog(8) + RowData(8);
        CaseItog(9) = CaseItog(9) + RowData(9);
        RowData(8) = 0;
        RowData(9) = 0;
        I = 12;
        while(I<20)
           ActSheet.Cells (Row, I).Value = RowData(I);
           CaseItog(I) = CaseItog(I) + RowData(I);
           RowData(I) = 0;
           I = I + 1;
        end;

        num = num + 1;
        Row = Row + 1;
        ActSheet.Rows(Int(Row)).Insert;
    end; /*цикл по портфелям*/
    ActSheet.Rows(Int(Row)).Delete;
    Row = Row + 1;

    /*Итог по портфелям*/
    Itog(8) = Itog(8) + CaseItog(8);
    Itog(9) = Itog(9) + CaseItog(9);
    ActSheet.Cells (CaseItogStrNum, 8).Value = CaseItog(8);
    ActSheet.Cells (CaseItogStrNum, 9).Value = CaseItog(9);
    I = 16;
    while(I<20)
       ActSheet.Cells (CaseItogStrNum, I).Value = CaseItog(I);
       Itog(I) = Itog(I) + CaseItog(I);
       I = I + 1;
    end;

    /*общий итог*/
    ActSheet.Cells (Row, 8).Value = Itog(8);
    ActSheet.Cells (Row, 9).Value = Itog(9);
    I = 16;
    while(I<20)
       ActSheet.Cells (Row, I).Value = Itog(I);
       I = I + 1;
    end;
    Row = Row + 15;

    /*Распределение данных по группам риска*/
    I = 0;
    while(I<5)
       /* по договорам итд */
       J = 0;
       while(J<4)
           ActSheet.Cells (Row, J+3).Value = СуммыПоГрРиска[I][J];
           J = J + 1;
       end;
       if(СуммыПоГрРиска[I][2] > СуммыПоГрРиска[I][3])
           ActSheet.Cells (Row, 7).Value = СуммыПоГрРиска[I][2] - СуммыПоГрРиска[I][3];
           ActSheet.Cells (Row, 8).Value = 0;
       else
           ActSheet.Cells (Row, 7).Value = 0;
           ActSheet.Cells (Row, 8).Value = СуммыПоГрРиска[I][3] - СуммыПоГрРиска[I][2];
       end;

       /* по портфелям */
       ActSheet.Cells (Row, 13).Value = СуммыПоГрРискаПортф[I][0];
       ActSheet.Cells (Row, 14).Value = СуммыПоГрРискаПортф[I][1];
       ActSheet.Cells (Row, 15).Value = СуммыПоГрРискаПортф[I][2];
       if(СуммыПоГрРискаПортф[I][1] > СуммыПоГрРискаПортф[I][2])
           ActSheet.Cells (Row, 16).Value = СуммыПоГрРискаПортф[I][1] - СуммыПоГрРискаПортф[I][2];
           ActSheet.Cells (Row, 17).Value = 0;
       else
           ActSheet.Cells (Row, 16).Value = 0;
           ActSheet.Cells (Row, 17).Value = СуммыПоГрРискаПортф[I][2] - СуммыПоГрРискаПортф[I][1];
       end;

       Row = Row + 1;
       I = I + 1;
    end;
    ActSheet.Cells (Row, 3).Value = Itog(9) - CaseItog(9);
    ActSheet.Cells (Row, 4).Value = Itog(10) + Itog(11);
    ActSheet.Cells (Row, 5).Value = Itog(16) - CaseItog(16);
    ActSheet.Cells (Row, 6).Value = Itog(17) - CaseItog(17);
    ActSheet.Cells (Row, 7).Value = Itog(18) - CaseItog(18);
    ActSheet.Cells (Row, 8).Value = Itog(19) - CaseItog(19);
    ActSheet.Cells (Row, 13).Value = CaseItog(9);
    ActSheet.Cells (Row, 14).Value = CaseItog(16);
    ActSheet.Cells (Row, 15).Value = CaseItog(17);
    ActSheet.Cells (Row, 16).Value = CaseItog(18);
    ActSheet.Cells (Row, 17).Value = CaseItog(19);

end;

/*******************************************************************************
 **                             Основной макрос                               **
 *******************************************************************************/
  IF (ReadBeginParm())
    NewExcelWorkbook (False, "1237-p4.xls");
    PrintRep();
    ExcelApplication.Visible = true;
  END;
