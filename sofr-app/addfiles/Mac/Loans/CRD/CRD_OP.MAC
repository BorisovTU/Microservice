/*ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
  RS-Bank 4.3                                          R-Style Software Lab

  File Name   : crd_op.mac                                    23.07.98
  Description : Æ‚Á•‚ "éØ•‡†Ê®® ØÆ §Æ£Æ¢Æ‡„"

¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ*/
import SbCrdInter, "lclient.mac", LoansFind, total;

FILE   Credit   ("credit_c.dbt", "loans.def");
FILE   CrdOp    ("crd_op.dbt",   "loans.def") key 3;
FILE   StepOp   ("step_op.dbt",  "loans.def");
FILE   DocAcc   ("doc_acc.dbt",  "loans.def");
FILE   fininstr ("fininstr.dbt", "bank.def" ) key 1;

private file TypeOp   ("type_op.dbt",  "loans.def") key 1;
private var  PayOp    = TRecHandler ("lpayop.dbt",  "loans.def");
private var  PayOffOp = TrecHandler ("doc_duty.dbt","loans.def");

var {GROUP_OPER};
var {TypePerson};

var ç†ß¢†≠®•é‚Á•‚†="éØ•‡†Ê®® ØÆ §Æ£Æ¢Æ‡„ N ";
var CreditNumber = 0;  /*≠Æ¨•‡ §Æ£Æ¢Æ‡†*/
var UsCreditNumber:string = "";
var CurCode = 0;       /*¢†´Ó‚† §Æ£Æ¢Æ‡†*/
var BDate,EDate;

/*************************************************************/
macro Ç¢•·‚®à·ÂÆ§≠Î•Ñ†≠≠Î•()
  BDate = {curdate};
  EDate = {curdate};
  if (not Ç¢•·‚®è•‡®Æ§Ñ†‚ (BDate, EDate))
     exit (1);
  end;
  if (BDate > {curdate})
     msgbox ("ç†Á†´Ï≠†Ô §†‚† Ø‡•¢ÎË†•‚ ‚•™„È„Ó");
     exit (1);
  end;
  if (EDate > {curdate})
     msgbox ("äÆ≠•Á≠†Ô §†‚† Ø‡•¢ÎË†•‚ ‚•™„È„Ó");
     exit (1);
  end;
end;
/**************************************************************/
macro èÆ´„Á®‚ÏÑÆ£Æ¢Æ‡()
  array LCreditNumber;
  array LCreditID;
  array LClientName;
  array LCurName;
  array LCurCode;
  array MenuCrdContr;
  var   number = 0;

  WHILE( next (Credit) )
    if ( /*(Credit.IsCur == flagcur) and*/
       (({TypePerson} == 128) or ({TypePerson} == 129) or
       (({TypePerson} == 142) and (Credit.GroupNum == {GROUP_OPER})) or
       (({TypePerson} == 147) and ({GROUP_OPER} == 0)) or
       (({TypePerson} == 147) and (Credit.GroupNum == {GROUP_OPER}))))
      LCreditNumber(number) = Credit.UsCreditNumber;
      LCreditID(number) = Credit.CreditNumber;
      LClientName(number) = FindClient(Credit.ClientID_Ref);
      LCurName(number) = FindShortName(Credit.CurCode);
      LCurCode(number) = Credit.CurCode;
      MenuCrdContr(number) = string(LCreditNumber(number):15:l) + " " + LClientName(number) + " " + LCurName(number);
      number = number + 1 ;
    end;
  END;
  if(number == 0)
    msgbox("ëØ®·Æ™ §Æ£Æ¢Æ‡Æ¢ Ø„·‚");
    exit(1);
  end;
  number = Menu( MenuCrdContr, " ÇÎ°•‡®‚• §Æ£Æ¢Æ‡ : ", " ëØ®·Æ™ §Æ£Æ¢Æ‡Æ¢ " );
  if(number < 0)  exit(1); end;
  SetParm ( 0 , LCreditID(number) );
  SetParm ( 1 , LCreditNumber(number) );
  SetParm ( 2 , LCurCode(number) );
end;
/**********************************************************************/
macro ç†Ø•Á†‚†‚Ïá†£Æ´Æ¢Æ™()
[ ];
[                                                              # #] (ç†ß¢†≠®•é‚Á•‚†:r, UsCreditNumber:l);
[                                  ≠† Ø•‡®Æ§ · ########## ØÆ ########## ]( BDate, EDate );
[ ];
[                                                   ¢†´Ó‚† ###](FindShortName(CurCode):r);
[
 ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
 ≥             ≥                         ≥                ≥                               ÑÆ™„¨•≠‚Î ØÆ ÆØ•‡†Ê®®                          ≥
 ≥Ñ†‚† ÆØ•‡†Ê®®≥    ç†ß¢†≠®• ÆØ•‡†Ê®®    ≥ ë„¨¨† ÆØ•‡†Ê®® √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥             ≥                         ≥                ≥              Ñ‚              ≥             ä‡               ≥     ë„¨¨†      ≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];
end;

macro èÆ§¢•·‚®ó•‡‚„_1()

[√ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];
end;

macro èÆ§¢•·‚®ó•‡‚„_1D()

[≥             ≥                         ≥                √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];
end;

macro èÆ§¢•·‚®ó•‡‚„_2()

[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
];
end;
/*************************************************************************/
macro è•Á†‚Ïá†£Æ´Æ¢Æ™()
  èÆ§¢•·‚®ó•‡‚„_1();
  [≥             ≥ ÑÆ™„¨•≠‚Î ·‰Æ‡¨®‡Æ¢†≠≠Î•≥                ≥                              ≥                              ≥                ≥];
  [≥             ≥ ¢‡„Á≠„Ó:                ≥                ≥                              ≥                              ≥                ≥];
end;
/*************************************************************************/
macro è•Á†‚ÏÑÆ™„¨•≠‚(Name_Op, Sum_Op, Date_Op, count_doc)
  var _Name;
  _Name = substr(Name_Op, ((count_doc - 1)*25 + 1), 25);
  if (count_doc == 1)
/*    èÆ§¢•·‚®ó•‡‚„_1();*/
    [≥  ########## ≥#########################≥################≥##############################≥##############################≥################≥]
    (
    Date_Op,
    _Name,
    Sum_Op:z:a,
    DocAcc.Debit:f,
    DocAcc.Credit:f,
    DocAcc.CarrySum:a
    );
  else
/*    èÆ§¢•·‚®ó•‡‚„_1D();*/
    [≥             ≥#########################≥                ≥##############################≥##############################≥################≥]
    (
    _Name,
    DocAcc.Debit:f,
    DocAcc.Credit:f,
    DocAcc.CarrySum:a
    );
  end;

end;
/*************************************************************************/
macro ÑÆ™„¨•≠‚Î()
  var count = 0;
  var First = True;
  var NameOp = "";
  var POST = 1;

  macro OneStepDoc()
    if ( First )
      First = False;
      DocAcc.CreditNumber_Ref = CreditNumber;
      DocAcc.IsDeleted = 0;
      DocAcc.RegDate = BDate;
      return ( GetGE(DocAcc)
               and (DocAcc.CreditNumber_Ref == CreditNumber)
               and (DocAcc.IsDeleted == 0)
               and (DocAcc.RegDate <= EDate )
             );
    else
      return ( Next(DocAcc)
               and (DocAcc.CreditNumber_Ref == CreditNumber)
               and (DocAcc.IsDeleted == 0)
               and (DocAcc.RegDate <= EDate )
             );
    end;
  end;

  /* ÇÎ°Æ‡ §Æ™„¨•≠‚Æ¢ ß†§†≠≠Æ£Æ §Æ£Æ¢Æ‡† */
  if( not open( DocAcc ) )
    OpenErrMes( "doc_acc.dbt" );
  else
    if (NRecords( DocAcc ) == 0)   return 0;   end;
    initProgress( NRecords( DocAcc ), "é°‡†°Æ‚™† §Æ™„¨•≠‚Æ¢ ØÆ §Æ£Æ¢Æ‡„ | Ü§®‚•...",
                  "ÑÆ™„¨•≠‚Î ØÆ §Æ£Æ¢Æ‡„ (doc_acc.dbt)");
    KeyNum(DocAcc, 8);
    KeyNum(TypeOp, 0);
    count = 0;
    è•Á†‚Ïá†£Æ´Æ¢Æ™();
    while ( OneStepDoc() )
      useProgress( count);
      count = count + 1;
       /* ‡†··¨†‚‡®¢†•¨  §Æ™„¨•≠‚Î ≠• Ø‡®¢Ôß†≠≠Î• ™ ÆØ•‡†Ê®® - Ø‡Æ¢•§•≠≠Î• ®´® ¢Î£‡„¶•≠≠Î• */
      if ((DocAcc.State != POST) and (DocAcc.CredOperID_Ref == 0) and (DocAcc.FlagRP == "\x00"))
          StepOp.StepID = DocAcc.StepID;
          if (GetEQ(StepOp))
            TypeOp.TypeOperID = StepOp.TypeOperID_Ref;
            if (GetEQ(TypeOp))  /* ÆØ‡•§•´Ô•¨ ≠†ß¢†≠®• ÆØ•‡†Ê®® */
              NameOp = TypeOp.TypeOperName;
            else
              NameOp = "";
            end;
            è•Á†‚ÏÑÆ™„¨•≠‚(NameOp, DocAcc.CarrySum, DocAcc.RegDate, 1);
          end;
      end;
    end;
    remProgress();
  end;
  èÆ§¢•·‚®ó•‡‚„_2();
end;

/*************************************************************************/
macro éØ•‡†Ê®®()
  var count = 0;
  var count_doc = 0;
  var First = True;
  var FirstD = True;
  var NameOp = "";
  var SumOp = 0;
  var DateOp = date(0,0,0);
  var POST = 1;
  var rs = null;
  var rs_1 = null;
  var rsdoc = null;

  macro OneStepDoc(CredOperID)
      //§•´†•¨ ¢Î°Æ‡™„ Æ§®≠ ‡†ß §´Ô Æ§≠Æ© ÆØ•‡†Ê®®
      if (rsdoc == null)         
         rsdoc = CRsdCommand(" select * from ddoc_acc_dbt " + 
                              " where t_credoperid_ref = ? and t_isdeleted = 0 ",
                                "p1", CredOperID, V_GENOBJ);
      end;

      // Ø•‡•°®‡†•¨ ¢·• §Æ™„¨•≠‚Î ØÆ ‚•™„È•© ÆØ•‡†Ê®®
      if (rsdoc.moveNext)
         DocAcc.Credit   = rsdoc.Value("t_credit"); 
         DocAcc.Debit    = rsdoc.Value("t_debit");
         DocAcc.CarrySum = rsdoc.Value("t_carrySum");
         return true;
      end;
      rsdoc = null;
      return false;    
  end;

  if( not open( CrdOp ) )
    OpenErrMes( "crd_op.dbt" );
  else
    if (NRecords( CrdOp ) == 0)   return 0;   end;
    initProgress( NRecords( CrdOp ), "é°‡†°Æ‚™† ÆØ•‡†Ê®© ØÆ §Æ£Æ¢Æ‡„ | Ü§®‚•...",
                  "éØ•‡†Ê®® ØÆ §Æ£Æ¢Æ‡„ (crd_op.dbt)");
    KeyNum(DocAcc, 7);
    KeyNum(TypeOp, 1);
    count = 0;

    rs_1 =  LnGetRecordSet("select t_CredOperID, t_OperTypeNumber_Ref, t_CredOperDate, t_objecttypeid_ref, t_objectid_ref from dcrd_op_dbt " +
                           " where t_CreditNumber_Ref = " + CreditNumber + 
                           " and t_IsDeleted = 0 and t_CredOperDate <= " + SqlDate(EDate) +
                           " and t_CredOperDate >= " + SqlDate(BDate) +
                           " order by t_CredOperDate asc"); 
    if (rs_1 == null) return 0;   end; 

    while (rs_1.MoveNext())
      useProgress( count);
      count = count + 1;
      TypeOp.TypeOperNumber = rs_1.Value(1);

      if (GetEQ(TypeOp))    /* ÆØ‡•§•´Ô•¨ ≠†ß¢†≠®• ÆØ•‡†Ê®®, §†‚„ ® ·„¨¨„ */
        NameOp = TypeOp.TypeOperName;
        if (TypeOp.SystTypeOp_Ref == CS_PAY)
          if(Loans_FindPayOp(rs_1.Value(0), PayOp))
              SumOp = PayOp.rec.PaySum;
          end;
        elif (TypeOp.SystTypeOp_Ref == CS_DUTY)
          if(Loans_FindPayOp(rs_1.Value(0), PayOffOp))
              SumOp = PayOffOp.rec.CalcSum;
          end;
        elif (TypeOp.SystTypeOp_Ref == CS_EXP)
          rs = LnGetRecordSet("select sum(t_Sum) from dlchsumrg_dbt where (t_UsRegID_Ref = loanskernel.getusregid_forobject (" + rs_1.Value("t_objecttypeid_ref")+ ", " + rs_1.Value("t_objectid_ref") + ", " + TDR_CLAIM + ")" +
                                                                     "  or t_UsRegID_Ref = loanskernel.getusregid_forobject (" + rs_1.Value("t_objecttypeid_ref")+ ", " + rs_1.Value("t_objectid_ref") + ", " + TDR_CLAIM + ")" +   // ØÆÂÆ¶• ´®Ë≠•• „·´Æ¢®•
                                                                     " and t_CredOperID_Ref = " + rs_1.Value(0));
          if ((rs == null) or (rs.MoveNext != true) or (rs.value(0, null, V_MONEY) == null) )
             SumOp = 0;
          else
             SumOp = rs.value(0, null, V_MONEY);
          end;
        elif (TypeOp.SystTypeOp_Ref == CS_PERC)
          rs = LnGetRecordSet(" select sum(t_Sum) from dlchsumrg_dbt "+ 
                              " where t_UsRegID_Ref = loanskernel.getusregid_forobject (" + rs_1.Value("t_objecttypeid_ref")+ ", " + rs_1.Value("t_objectid_ref") + ", " + TDR_CLAIM + ")" +
                                                                    " and t_CredOperID_Ref = " + rs_1.Value(0));
          if ((rs == null) or (rs.MoveNext != true) or (rs.value(0, null, V_MONEY) == null) )
             SumOp = 0;
          else
             SumOp = rs.value(0, null, V_MONEY);
          end;
        else SumOp = 0;
        end;
      else
        NameOp = "";
        SumOp = 0;
      end;
      DateOp = rs_1.Value(2, null, V_DATE);
      FirstD = True;
      count_doc = 0;
       /* ‡†··¨†‚‡®¢†•¨  §Æ™„¨•≠‚Î Ø‡®¢Ôß†≠≠Î• ™ ÆØ•‡†Ê®® - Ø‡Æ¢•§•≠≠Î• ®´® ¢Î£‡„¶•≠≠Î• */
      while (OneStepDoc(rs_1.Value(0)))
        if (DocAcc.State != POST)
          count_doc = count_doc + 1;
          è•Á†‚ÏÑÆ™„¨•≠‚(NameOp, SumOp, DateOp, count_doc);
        end;
      end;
    end;
    remProgress();
  end;
end;
 èÆ´„Á®‚ÏÑÆ£Æ¢Æ‡(CreditNumber, UsCreditNumber, CurCode);
 Ç¢•·‚®à·ÂÆ§≠Î•Ñ†≠≠Î•();
 ç†Ø•Á†‚†‚Ïá†£Æ´Æ¢Æ™();
 éØ•‡†Ê®®();
 ÑÆ™„¨•≠‚Î();
end;
