import SbCrdInter, total, "macperc.mac";

record ШагОперации ("step_op.dbt",  "loans.def");
record Документ    ("doc_acc.dbt",  "loans.def");
record Операция    ("crd_op.dbt",   "loans.def");
record Договор     ("credit_c.dbt", "loans.def");
record Цессия      ("credit_c.dbt", "loans.def");
record Сумма       ("SUM.",         "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var stat:integer;
   var rs = null;

macro ИзменитьРегистры(objid, objn)
var stat:integer, paytype;
var Начисленные, Доначисленные, Просроченные, НеустойкаПроц, НеустойкаДолг, ПроцВнебаланс, ПроцВнПрос;

   paytype = LnSelectValue ("select t_paytype from dcredit_c_dbt where t_creditnumber = " + objn);
   
   Начисленные   = GetPaySum(DS_PERC,        objid, objn);
   Доначисленные = GetPaySum(DS_ADDPERC,     objid, objn);
   Просроченные  = GetPaySum(DS_EXPPERC,     objid, objn);
   НеустойкаПроц = GetPaySum(DS_EXPPERCFINE, objid, objn);
   НеустойкаДолг = GetPaySum(DS_EXPDUTYFINE, objid, objn);

   ПроцВнебаланс = ОстатокРегистра (objid, objn, TDR_CLAIM_VN,   OperDate);
   ПроцВнПрос    = ОстатокРегистра (objid, objn, TDR_EXPPERC_VN, OperDate);

   stat = ИзменитьРегистр(objid, objn, TDR_PERC_ACQCRD, 0, Начисленные + Доначисленные, Операция.CredOperID);

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_CLAIM_VN, 0, -ПроцВнебаланс, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_CLAIM, 0, Начисленные, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_EXPPERC_ACQ, 0, Просроченные, Операция.CredOperID);
   end;
   
   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_EXPPERC_VN, 0, -ПроцВнПрос, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_PENALTI_PERC, 0, НеустойкаПроц, Операция.CredOperID);
   end;

   if (stat == 0)
      stat = ИзменитьРегистр(objid, objn, TDR_PENALTI_CRD,  0, НеустойкаДолг, Операция.CredOperID);
   end;

   if(objid == LO_CREDIT)
      if (stat == 0)
         stat = ИзменитьРегистр(objid, objn, TDR_ACQCRD,  0, Сумма(0), Операция.CredOperID);
      end;
   end;

   return stat;
end;

   setbuff(Сумма, Sum);

   stat = ИзменитьРегистры(LO_CREDIT, Договор.CreditNumber);

   rs = LnGetRecordSet("SELECT t_dutyid FROM dduty_crd_dbt d WHERE d.t_creditnumber_ref = " + Договор.CreditNumber);
   if (rs != NULL)
       while (rs.MoveNext())
          if (stat == 0)
             stat = ИзменитьРегистры(LO_DUTY, rs.Value("t_dutyid", NULL, V_INTEGER));
          end;
       end;
   end;

   return stat;
end;
