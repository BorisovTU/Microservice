/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : payOV1.mac
 Description : Создание документа по шагу операции (операция возникновения овердрафта)

 Programmer  : TFS
 09.08.05    : Создан
-----------------------------------------------------------------------------------*/
IMPORT SbCrdInter, Total;

RECORD ШагОперации (step_op,        "loans.def");     /* Запись шага операции */
RECORD Документ    (doc_acc,        "loans.def");     /* Буфер документа      */
RECORD Договор     ("credit_c.dbt", "loans.def");
RECORD Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
RECORD Сумма       ("SUM.",         "loans.def");
RECORD lcusreg     ("lcusreg.dbt",  "loans.def");

MACRO ВыполнитьШаг (OperDate, Sum, Data)
   VAR DocID : integer;
   VAR stat  :  integer = 0;
   VAR СуммаОП, НеиспЛимДо: money;
   setbuff(Сумма, Sum);

   СуммаОП    = Сумма(0);
   НеиспЛимДо = ОстатокРегистра(Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMDUTY, OperDate);

   Документ.CarrySum = min(СуммаОП, НеиспЛимДо);
   stat = СоздатьДокумент(Документ, DocID);

   IF ((stat == 0) AND (DocID != 0))
      stat = ИзменитьРегистр(Договор.Crd_kind, Операция.ObjectID_Ref, TDR_MAINREST, DocID, min(СуммаОП, НеиспЛимДо));
   END;

   RETURN stat;
END;