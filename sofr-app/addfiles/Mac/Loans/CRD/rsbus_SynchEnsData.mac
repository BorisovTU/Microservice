
/*-----------------------------------------------------------------------------------+
|  File Name   : rsbus_SynchEnsData.c          10.04.2012                            |
|                                                                                    |
|  Description : Сервис синхронизации данных по договору                             |
|                поручительства/залога                                               |
|                                                                                    |    
|  Programmer  : Alexandr Shvets                                                     |        
|                                                                                    |
|  History     :                                                                     |      
|  10.04.2012  : Создан                                                              |
+-----------------------------------------------------------------------------------*/

import Total, SbCrdInter, XmlRpcInter;

// данные операциониста
class TOperInfo
   var
      OperID   :integer,
      OperName :string;
END;

// структура объекта (для договора поручительтсва) передаваемого во внешнюю систему
private class TSynchGuarContract
   var
      CreditId      :integer,
      CreditNumber  :string,
      EnsContractID :integer,
      Type      :integer,
      Number    :string,
      PersonID  :integer,
      BeginDate :date,
      EndDate   :date,
      CloseDate :date,
      Sum       :money,
      CurCode   :string,
      Category  :integer,
      RVPS      :bool = false,
      Quality   :integer,
      Status    :integer,
      OperInfo  :TOperInfo,
      IsDelete  :integer;
END;

// структура объекта (для договора залога) передаваемого во внешнюю систему
private class TSynchCollatContract
   var
      CreditId      :integer,
      CreditNumber  :string,
      EnsContractID :integer,
      Number    :string,
      Type      :integer,
      PersonID  :integer,
      BeginDate :date,
      EndDate   :date,
      CloseDate :date,
      Sum       :money,
      CurCode   :string,
      Category  :integer,
      Discount  :double,
      Deposit   :bool = false,
      Status    :integer,
      OperInfo  :TOperInfo,
      IsDelete  :integer;
END;

// Глобальные данные
private record ensBuff ("enscontr.dbt");
private record crdBuff ("credit_c.dbt");

//===========================================================================
/* Функция поиска и проверки валюты. Принимает код валюты(string или integer).
  При неудаче генерирует ошибку. Возвращает код валюты(integer или string)
  сответственно. */
//===========================================================================
macro getCurCode (CurCode)
   IF (CurCode != null)
      var err = 0;
         
      CurCode = getCurISOl(CurCode, err);
         
      IF (err != 0)
         RunError("Валюта задана некорректно", err);
      END;
   END;

   return CurCode;
   
   onError(err)
      RunError(err.Code, err.Message);
END;

//============================================================================
/* Функция формирования данных по договору поручительтсва */
//============================================================================
macro MakeGuarantyData (Credit_c, EnsContract, IsDel :integer) :TSynchGuarContract
   var SynchGuarContract : TSynchGuarContract;
   var OperInfo          : TOperInfo;
   
   // заполним глобальные буферы ДО и ДК структурой из Си кода
   IF (ValType(Credit_c) == V_STRUC)
      copy(crdBuff, Credit_c)
   ELIF (Credit_c != NULL)
      setBuff(crdBuff, Credit_c);
   END;
   
   IF (ValType(EnsContract) == V_STRUC)
      copy(ensBuff, EnsContract);
   ELIF (EnsContract != NULL)
      setBuff(ensBuff, EnsContract);
   END;
   
   OperInfo.OperID   = {Oper};
   OperInfo.OperName = {Name_Oper};
   
   SynchGuarContract.CreditID      = crdBuff.CREDITNUMBER;
   SynchGuarContract.CreditNumber  = crdBuff.USCREDITNUMBER;
   SynchGuarContract.OperInfo      = OperInfo;

   SynchGuarContract.EnsContractID = ensBuff.ENSCONTRACTID;
   SynchGuarContract.Type          = ensBuff.ENSSYSTYPE;
   SynchGuarContract.Number        = ensBuff.ENSCONTRACTNUMBER;
   SynchGuarContract.PersonID      = ensBuff.ENSCONTRACTPERSONID_REF;
   SynchGuarContract.BeginDate     = ensBuff.ENSCONTRACTFIRSTDATE;
   SynchGuarContract.EndDate       = ensBuff.ENSCONTRACTLASTDATE;
   SynchGuarContract.Sum           = ensBuff.ENSCONTRACTSUM;
   SynchGuarContract.CurCode       = getCurCode(ensBuff.ENSCONTRACTCUR);
   SynchGuarContract.Category      = ensBuff.ENSCATEGORY;
   SynchGuarContract.Quality       = ensBuff.QUALITYID_REF;
   SynchGuarContract.Status        = ensBuff.ENSCONTRACTSTATUS;
   
   IF (ensBuff.ENSCONTRACTSTATUS == EC_CLOSE)
      SynchGuarContract.CloseDate = lastopdate(LO_ENSCONTR, ensBuff.ENSCONTRACTID, CS_CLOSE_ENS);
   END;
   
   IF (ensBuff.FLAG_RVPS)
      SynchGuarContract.RVPS       = true;
   END;
   
   IF (IsDel != 1)
      SynchGuarContract.IsDelete  = 0;
   else
      SynchGuarContract.IsDelete  = IsDel;
   END;
   
   return SynchGuarContract;
   
   onError(err)
      RunError("При формировании данных по договору поручительства/залога произошла непредвиденная ошибка", 18598);
END;

//============================================================================
/* Функция формирования данных по договору залога */
//============================================================================
macro MakeCollateralData (Credit_c, EnsContract, IsDel :integer) :TSynchCollatContract
   var SynchCollatContract : TSynchCollatContract;
   var OperInfo            : TOperInfo;
   
   // заполним глобальные буферы ДО и ДК структурой из Си кода
   IF (ValType(Credit_c) == V_STRUC)
      copy(crdBuff, Credit_c)
   ELIF (Credit_c != NULL)
      setBuff(crdBuff, Credit_c);
   END;
   
   IF (ValType(EnsContract) == V_STRUC)
      copy(ensBuff, EnsContract)
   ELIF (EnsContract != NULL)
      setBuff(ensBuff, EnsContract);
   END;
   
   OperInfo.OperID   = {Oper};
   OperInfo.OperName = {Name_Oper};
   
   SynchCollatContract.CreditID      = crdBuff.CREDITNUMBER;
   SynchCollatContract.CreditNumber  = crdBuff.USCREDITNUMBER;
   SynchCollatContract.OperInfo      = OperInfo;
   
   SynchCollatContract.EnsContractID = ensBuff.ENSCONTRACTID;
   SynchCollatContract.Type          = ensBuff.ENSSYSTYPE;
   SynchCollatContract.Number        = ensBuff.ENSCONTRACTNUMBER;
   SynchCollatContract.PersonID      = ensBuff.ENSCONTRACTPERSONID_REF;
   SynchCollatContract.BeginDate     = ensBuff.ENSCONTRACTFIRSTDATE;
   SynchCollatContract.EndDate       = ensBuff.ENSCONTRACTLASTDATE;
   SynchCollatContract.Sum           = ensBuff.ENSCONTRACTSUM;
   SynchCollatContract.CurCode       = getCurCode(ensBuff.ENSCONTRACTCUR);
   SynchCollatContract.Category      = ensBuff.ENSCATEGORY;
   SynchCollatContract.Discount      = ensBuff.DISCOUNT;
   SynchCollatContract.Status        = ensBuff.ENSCONTRACTSTATUS;
   
   IF (ensBuff.ENSCONTRACTSTATUS == EC_CLOSE)
      SynchCollatContract.CloseDate = lastopdate(LO_ENSCONTR, ensBuff.ENSCONTRACTID, CS_CLOSE_ENS);
   END;
   
   IF (ensBuff.DEPOSIT)
      SynchCollatContract.Deposit    = true;
   END;
   
   IF (IsDel != 1)
      SynchCollatContract.IsDelete  = 0;
   else
      SynchCollatContract.IsDelete  = IsDel;
   END;
   
   return SynchCollatContract;
   
   onError(err)
      RunError("При формировании данных по договору поручительства/залога произошла непредвиденная ошибка", 18598);
END;

//============================================================================
/* Синхронизирует данные по договору поручительства */
//============================================================================
macro SynchGuarantyData(Credit_c, EnsContract, IsDel :integer, OperationType :integer) :Integer
private var URL = GetSynchUrl(-1), Method = GetSynchMethod(-1), TimeOut = GetSynchTimeOut(-1);

   IF (NOT GetSynchState)
      return 0;
   END;

   var SynchGuarContract : TSynchGuarContract;
   
   // формируем данные по ДО для передачи внешнему веб-сервису
   SynchGuarContract = MakeGuarantyData(Credit_c, EnsContract, IsDel);

   // заполняем параметры сервиса
   var inParamsArray = TArray(RslSoapPrm);
   var soapParams : RslSoapPrm; 
   var xml;

   // заполняем массив входящих параметров сервиса
   soapParams.name  = "request";
   //ConvertToXML(SynchGuarContract, null, xml);
XML = 
"<?xml version='1.0' encoding='windows-1251'?>"+
"<methodResponse xmlns="+StrFor(34)+"http://www.softlab.ru/xml-rpc/schema"+StrFor(34)+
" xmlns:n0="+StrFor(34)+"http://www.softlab.ru/xml-rpc/schema"+StrFor(34)+
" n0:reqId="+StrFor(34)+CreateGUID()+StrFor(34)+" n0:logicalId="+StrFor(34)+StrFor(34)+">"+
"<params><param><value><struct>"+
"<member><name>CreditId</name><value><integer>"+SynchGuarContract.CreditId+"</integer></value></member>"+
"<member><name>CreditNumber</name><value><string>"+SynchGuarContract.CreditNumber+"</string></value></member>"+
"<member><name>EnsContractID</name><value><integer>"+SynchGuarContract.EnsContractID+"</integer></value></member>"+
"<member><name>Type</name><value><integer>"+SynchGuarContract.Type+"</integer></value></member>"+
"<member><name>Number</name><value><string>"+SynchGuarContract.Number+"</string></value></member>"+
"<member><name>PersonID</name><value><integer>"+SynchGuarContract.PersonID+"</integer></value></member>"+
"<member><name>BeginDate</name><value>"+XMLisDate(SynchGuarContract.BeginDate)+"</value></member>"+
"<member><name>EndDate</name><value>"+XMLisDate(SynchGuarContract.EndDate)+"</value></member>"+
"<member><name>CloseDate</name><value>"+XMLisDate(SynchGuarContract.CloseDate)+"</value></member>"+
"<member><name>Sum</name><value><money>"+XMLisMoney(SynchGuarContract.Sum)+"</money></value></member>"+
"<member><name>CurCode</name><value><string>"+SynchGuarContract.CurCode+"</string></value></member>"+
"<member><name>Category</name><value><integer>"+SynchGuarContract.Category+"</integer></value></member>"+
"<member><name>RVPS</name><value><boolean>"+XMLisBool(SynchGuarContract.RVPS)+"</boolean></value></member>"+
"<member><name>Quality</name><value><integer>"+SynchGuarContract.Quality+"</integer></value></member>"+
"<member><name>Status</name><value><integer>"+SynchGuarContract.Status+"</integer></value></member>"+
"<member><name>OperInfo</name><value><struct>"+
"<member><name>OperID</name><value><integer>"+SynchGuarContract.OperInfo.OperID+"</integer></value></member>"+
"<member><name>OperName</name><value><string>"+SynchGuarContract.OperInfo.OperName+"</string></value></member>"+
"</struct></value></member>"+
"<member><name>IsDelete</name><value><integer>"+SynchGuarContract.IsDelete+"</integer></value></member>"+
"</struct></value></param></params></methodResponse>";
   soapParams.value = xml;  
   inParamsArray[inParamsArray.size] = soapParams;
   soapParams = null;

   soapParams.name  = "timeout";    
   soapParams.value = 0;
   inParamsArray[inParamsArray.size] = soapParams;
   soapParams = null;

   soapParams.name  = "priority"; 
   soapParams.value = 0;
   inParamsArray[inParamsArray.size] = soapParams;
   soapParams = null;
   
   // вызываем собственно сервис
   var outParams;
   var encoding;
   var outResponse;
   var errMsg :string;
   var reqID = CreateGUID();   
   
   CallSimpleExtService(reqID, Url, Method, inParamsArray,"", "", Timeout, outParams, encoding, outResponse, errMsg);
  
   return 0;   
   
   onError(err)
      RunError(err.Code, err.Message);
END;
 
//============================================================================
/* Синхронизирует данные по договору залога */
//============================================================================
macro SynchCollateralData(Credit_c, EnsContract, IsDel :integer, OperationType :integer) :Integer
private var URL = GetSynchUrl(-2), Method = GetSynchMethod(-2), TimeOut = GetSynchTimeOut(-2);
   IF (NOT GetSynchState)
      return 0;
   END;
   
   var SynchCollatContract : TSynchCollatContract;

   // формируем данные по ДО для передачи внешнему веб-сервису
   SynchCollatContract = MakeCollateralData(Credit_c, EnsContract, IsDel);
  
  // заполняем параметры сервиса  
   var inParamsArray = TArray(RslSoapPrm);
   var soapParams : RslSoapPrm;
   var xml;
   
   // заполняем массив входящих параметров сервиса
   soapParams.name  = "request";
   // ConvertToXML(SynchCollatContract, null, xml);
      XML =
"<?xml version='1.0' encoding='windows-1251'?><methodResponse"+
" xmlns="+StrFor(34)+"http://www.softlab.ru/xml-rpc/schema"+StrFor(34)+
" xmlns:n0="+StrFor(34)+"http://www.softlab.ru/xml-rpc/schema"+StrFor(34)+
" n0:reqId="+StrFor(34)+CreateGUID()+StrFor(34)+" n0:logicalId="+StrFor(34)+StrFor(34)+">"+
"<params>"+
"<param>"+
"<value>"+
"<struct>"+
"<member><name>CreditId</name><value><integer>"+SynchCollatContract.CreditId+"</integer></value></member>"+
"<member><name>CreditNumber</name><value><string>"+SynchCollatContract.CreditNumber+"</string></value></member>"+
"<member><name>EnsContractID</name><value><integer>"+SynchCollatContract.EnsContractID+"</integer></value></member>"+
"<member><name>Number</name><value><string>"+SynchCollatContract.Number+"</string></value></member>"+
"<member><name>Type</name><value><integer>"+SynchCollatContract.Type+"</integer></value></member>"+
"<member><name>PersonID</name><value><integer>"+SynchCollatContract.PersonID+"</integer></value></member>"+
"<member><name>BeginDate</name><value>"+XMLisDate(SynchCollatContract.BeginDate)+"</value></member>"+
"<member><name>EndDate</name><value>"+XMLisDate(SynchCollatContract.EndDate)+"</value></member>"+
"<member><name>CloseDate</name><value>"+XMLisDate(SynchCollatContract.CloseDate)+"</value></member>"+
"<member><name>Sum</name><value><money>"+XMLisMoney(SynchCollatContract.Sum)+"</money></value></member>"+
"<member><name>CurCode</name><value><string>"+SynchCollatContract.CurCode+"</string></value></member>"+
"<member><name>Category</name><value><integer>"+SynchCollatContract.Category+"</integer></value></member>"+
"<member><name>Discount</name><value><double>"+XMLisDouble(SynchCollatContract.Discount)+"</double></value></member>"+
"<member><name>Deposit</name><value><boolean>"+XMLisBool(SynchCollatContract.Deposit)+"</boolean></value></member>"+
"<member><name>Status</name><value><integer>"+SynchCollatContract.Status+"</integer></value></member>"+
"<member><name>OperInfo</name><value>"+
"<struct>"+
"<member><name>OperID</name><value><integer>"+SynchCollatContract.OperInfo.OperID+"</integer></value></member>"+
"<member><name>OperName</name><value><string>"+SynchCollatContract.OperInfo.OperName+"</string></value></member>"+
"</struct></value></member>"+
"<member><name>IsDelete</name><value><integer>"+SynchCollatContract.IsDelete+"</integer></value></member>"+
"</struct></value></param></params></methodResponse>";

   soapParams.value = xml;
   inParamsArray[inParamsArray.size] = soapParams;
   soapParams = null;

   soapParams.name  = "timeout";    
   soapParams.value = 0;
   inParamsArray[inParamsArray.size] = soapParams;
   soapParams = null;

   soapParams.name  = "priority"; 
   soapParams.value = 0;
   inParamsArray[inParamsArray.size] = soapParams;
   soapParams = null;
   
   // вызываем собственно веб-сервис
   var outParams;
   var encoding;
   var outResponse;
   var errMsg :string;
   var reqID = CreateGUID();
   
   CallSimpleExtService(reqID, Url, Method, inParamsArray,"", "", Timeout, outParams, encoding, outResponse, errMsg);

   return 0;
   
   onError(err)
      RunError(err.Code, err.Message);
END;
