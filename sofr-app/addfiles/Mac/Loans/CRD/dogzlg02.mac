/*
$Name:             dogzlg02.mac
$Module:           Кредитование
$Description:      Договор купли-продажи дома
*/
import lclient, ActiveX, total, replib, dlwreps, replib;

private record enscontract("enscontr.dbt", "loans.def");
private file   ensobject  ("ensobj.dbt",   "loans.def");
private file   credit_c   ("credit_c.dbt", "loans.def");
private file   claim      ("claim.dbt",    "loans.def");
private record cur_credit ("credit_c", "loans.def");

private const TemplateName = "dogzlg02.dot";
private var   ensPerson    = TloansClient;
private var   enscrd = TBFile ("ens_crd.dbt",  "r", 0);
private var   ecneob = TBFile ("ecn_eob.dbt",  "r", 0);

macro RunReport(EnsContrBuf)

      var axerr:object = null, ФИОКонтрагента, ФИОЗаемщика;

      SetBuff(ensContract, EnsContrBuf);
      if (not ensPerson.GetRecord(ensContract.EnsContractPersonID_Ref))
          RunError ("Не найден контрагент в справочнике клиентов");
      end;

      enscrd.AddFilter("t_EnsContractID_Ref = " + enscontract.EnsContractID);
      enscrd.rewind;
      enscrd.next;
      enscrd.DropFilter();

      ClearRecord(credit_c);
      credit_c.CreditNumber = enscrd.rec.CreditNumber_Ref;
      if (GetEQ(credit_c))
         if (not depclnt.GetRecord(credit_c.ClientID_Ref))
             RunError ("Не найден контрагент в справочнике клиентов");
         end;
      else
         ClearRecord(claim);
         claim.ClaimID = enscontract.ClaimID_Ref;
         if (GetEQ(claim))
            if (not depclnt.GetRecord(claim.LoanerID_Ref))
                RunError ("Не найден контрагент в справочнике клиентов");
            end;
         else
            RunError ("Не найден кредитный договор или кредитная заявка| для договора обеспечения");
         end;
      end;

      if (ensperson.LegalForm != 2)
          RunError ("Печатная форма предназначена для формирования | по договорам обеспечения физических лиц");
      end;

      ecneob.AddFilter("t_EnsContractID_Ref = " + enscontract.EnsContractID);
      ecneob.rewind;
      ecneob.next;
      ecneob.DropFilter();

      ClearRecord (EnsObject);
      EnsObject.EnsObjectID       = ecneob.rec.EnsObjectID_ref;
      if (NOT (GetGE (EnsObject)))
         if (not GetTrue(false, "ОШИБКА: не найден объект обеспечения. Данные по объекту обеспечения |не будут выведены в печатную форму. Продолжить?"));
             return false;
         end;
      end;

      ФИОЗаемщика    = depclnt.ConvertFIOFull();
      ФИОКонтрагента = ensPerson.ConvertFIOFull();

      SetOutput (GetTxtFileName("doglzg02_rep"));
      
      println(TemplateName); //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа

      /* Дата */
      [~Date];
      println (DateToStringFull ({curdate}));
      /* ФИО продавца (контрагента) */
      [~FioSeller];
      println (ФИОКонтрагента);
      /* Дата рождения продавца (контрагента) */
      [~BornDateSeller];
      println (DateToStringShort (DepClnt.Born));
      /* Адрес проживания продавца (контрагента) */
      [~AddressSeller];
      println (DepClnt.AddressF);
      /* ФИО покупателя (заёмщика) */
      [~FioZaem];
      println (ФИОЗаемщика);
      /* Дата рождения покупателя (заёмщика) */
      [~BornDateZaem];
      println (DateToStringShort (DepClnt.Born));
      /* Адрес проживания покупателя (заёмщика) */
      [~AddressZaem];
      println (DepClnt.AddressF);
      /* Адрес квартиры */
      [~AddressFlat];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 135));
      /* Количество комнат квартиры */
      [~CountRoom];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 141));
      /* Полезная площадь квартиры */
      [~FullArea];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 142));
      /* Жилая площадь квартиры */
      [~Area];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 143));
      /* Этаж */
      [~Storey];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 144));
      /* Количество этажей в доме */
      [~StoreyHouse];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 145));
      /* Инвентаризационная стоимость квартиры */
      [~AssessedSum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 146));
      /* № договора купли-продажи (обеспечения) */
      [~NumContractLot];
      println (EnsContract.EnsContractNumber);
      /* Дата договора купли-продажи (обеспечения) */
      [~DateContractLot];
      println (DateToStringFull (EnsContract.EnsContractFirstDate));
      /* Дата регистрации договора купли-продажи */
      [~RegDateLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 147));
      /* Регистрационный № договора купли-продажи */
      [~RegDateNum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 148));
      /* Дата записи в реестре */
      [~ReestrDate];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 137));
      /* № регистрационной записи в реестре */
      [~ReestrNum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 136));
      /* Серия свидетельства о регистрации */
      [~ReestrRegSeries];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 138));
      /* № свидетельства о регистрации */
      [~ReestrRegNum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 139));
      /* Дата свидетельства о регистрации */
      [~ReestrRegDate];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 140));
      /* Стоимость квартиры */
      [~EnsSum];
      println (EnsContract.EnsContractSum);
      /* Собственные средства */
      [~Sum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 171));
      /* Сумма кредита */
      [~CrdSum];
      println (credit_c.CreditSum);
      /* № кредитного договора */
      [~CrdNum];
      println (credit_c.UsCreditNumber);
      /* Дата кредитного договора */
      [~RegDate];
      println (DateToStringFull (credit_c.RegDate));

      var tag = SetOutput (NULL, false);
      return tag;

      onError(axerr)
         SetOutput(NULL, false);
         RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Договор купли-продаже дома (квартиры) сформирован.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;