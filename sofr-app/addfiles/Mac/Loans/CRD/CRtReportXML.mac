/*
$Name:             CRtReportXML.mac                                             
$Module:           Кредитование
$Description:      Класс для работы с xml-файлами
*/
class CRtReportXML
  var doc:object  = NULL;  // непосредственно XML-документ
  var err:integer = 0;

  private macro error()
    if( doc.ParseError.errorCode )   
      err = doc.ParseError.errorCode;
    else                             
      err = -1;
    end;
    return err;
    onError
      return -1;
  end;

  macro Destructor()
    return 0;
    onError
      return error();
  end;

  private macro CreateXML4Object( xml:object )
    var axServer = NULL;
    
    //if( isStandalone() )
      SetParm(1, ActiveX ("Msxml2.DOMDocument.4.0", null, true ) );
   /* else
      axServer = CreateObject( "rsax", "TRsAxServer", "RetailAxServer", false );
      if( axServer )
        SetParm(1, axServer.CreateComObject("Msxml2.DOMDocument.4.0"));
      end;*/
    //end;
    return true;
    OnError( er )
      return false;
  end;

  private macro CreateXML2Object( xml:object )
    var axServer = NULL;
    
    //if( isStandalone() )
      SetParm(1, ActiveX ("Msxml2.DOMDocument", null, true ) );
    /*else
      axServer = CreateObject( "rsax", "TRsAxServer", "RetailAxServer", false );
      if( axServer )
        SetParm(1, axServer.CreateComObject("Msxml2.DOMDocument"));
      end;
    end;*/
    return true;
    OnError( er )
      return false;
  end;

  private macro CreateXML1Object( xml:object )
    var axServer = NULL;
    //if( isStandalone() )
      SetParm(1, ActiveX ("MSXML.DOMDocument") );
   /* else
      axServer = CreateObject( "rsax", "TRsAxServer", "RetailAxServer", false );
      if( axServer )
        SetParm(1, axServer.CreateComObject("MSXML.DOMDocument"));
      end;
    end;*/
    return true;
    OnError( er )
      return false;
  end;
  // ─── создание xml-объекта ───
  private macro CreateXMLObject()
    var obj:object = NULL;

    if( CreateXML1Object(obj) )  return obj;  end;
    if( CreateXML2Object(obj) )  return obj;  end;      
    if( CreateXML4Object(obj) )  return obj;  end;      

    RunError("Ошибка инициализации Active-X компонента.");
  end;
  // ─── Конструктор ───
  private macro Constructor()
    doc = CreateXMLObject();
    return 0;
    onError
      msgbox("Ошибка инициализации Active-X компонента.\nВозможно необходимо переустановить Internet Explorer.");
      exit(1);
      return error();
  end;
  // ─── загрузка файла ───
  macro Load( path:string )
    doc.load( path );
    return 0;
    onError
      return error();
  end;
  // ─── сохранение ───
  macro Save( path:string )
    doc.save( path );
    return 0;
    onError
      return error();
  end;
  // ─── инициализация ───
  macro Init()
    var vrsn = doc.createProcessingInstruction( "xml", "version=\"1.0\" encoding=\"WINDOWS-1251\"" );
    doc.appendChild( vrsn );
    return 0;
    onError
      return error();
  end;

  // Конструктор
  Constructor();
end;
