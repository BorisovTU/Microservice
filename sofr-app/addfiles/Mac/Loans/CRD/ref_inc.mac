/*
$Name:              ref_inc.mac
$Module:            Кредитование
$Description:       Отражение прочих доходов
*/
/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : def_grp.mac
 Description : Отражение прочих доходов

 Programmer  : TFS
 05.07.2018  : Создан
------------------------------------------------------------------------------*/

IMPORT total;

MACRO NameObject(buff)
   RECORD Credit("credit_c.dbt");
   RECORD Duty("duty_crd.dbt");
   RECORD payment_tmp("payment.tmp");

   SetBuff(payment_tmp, buff);

   IF ((payment_tmp.ObjID == LO_CREDIT)    OR
       (payment_tmp.ObjID == LO_KARTA)     OR
       (payment_tmp.ObjID == LO_GUARANTEE) OR
       (payment_tmp.ObjID == LO_DEPOSIT)
      )
      IF (Loans_FindCrdContract(payment_tmp.ObjN, Credit))
         IF (payment_tmp.ObjID == LO_CREDIT)
             RETURN "КД №"+Credit.UsCreditNumber;
         ELIF (payment_tmp.ObjID == LO_GUARANTEE)
             RETURN "ДГ №"+Credit.UsCreditNumber;
         ELIF (payment_tmp.ObjID == LO_KARTA)
             RETURN "БК №"+Credit.UsCreditNumber;
         ELIF (payment_tmp.ObjID == LO_DEPOSIT)
             RETURN "ДД №"+Credit.UsCreditNumber;
         END;
      END;
   ELIF ((payment_tmp.ObjID == LO_DUTY) OR (payment_tmp.ObjID == LO_BANKGUARANTEE))
       IF (Loans_FindDuty(payment_tmp.ObjN, Duty))
           IF (Loans_FindCrdContract(Duty.CreditNumber_Ref, Credit))
               RETURN "Договор " + Credit.UsCreditNumber + " Обязательство " + Duty.UserNumber;
           END;
       END;
   END;
   RETURN "";
END;

// Формирование разноски
MACRO FillFileGroup(
                    CurCode   : integer,
                    DutyType  : integer,
                    szUserType: string,
                    Exclude   : integer,
                    OperDate  : date,
                    CalcDate  : date,
                    ForGraph  : integer,
                    FNCash    : integer,
                    SMAString : string)

   VAR RSDcmd = NULL, Cnt = -1 * GetCNum(), ErrCode = 0, PackSize = 0;

   BegAction(1, "Формирование списка задолженности. Ждите, это может занять время.", false);

   RSDcmd = RsdCommand(RslDefCon, "BEGIN ? := RSO_LoansRsBus.FillWSRefInc(?,?,?,?,?,?,?,?,?,?); END;");
   RSDcmd.addParam("RetVal",     RSDBP_RETVAL, V_INTEGER );
   RSDcmd.AddParam("taskID",     RSDBP_IN, 0);
   RSDcmd.AddParam("execID",     RSDBP_IN, Cnt);
   RSDcmd.AddParam("conveyerID", RSDBP_IN, 0);
   RSDcmd.AddParam("packetSize", RSDBP_IN, 0);
   RSDcmd.AddParam("CurCode",    RSDBP_IN, CurCode);
   RSDcmd.AddParam("szUserType", RSDBP_IN, szUserType);
   RSDcmd.AddParam("Exclude",    RSDBP_IN, Exclude);
   RSDcmd.AddParam("OperDate",   RSDBP_IN, OperDate);
   RSDcmd.AddParam("FNCash",     RSDBP_IN, FNCash);
   RSDcmd.AddParam("SMAString",  RSDBP_IN, SMAString);

   RSDcmd.execute();

   IF (LnSelectValue("SELECT COUNT(1) FROM DCNVDOC_DBT WHERE T_EXECID = " + Cnt, V_INTEGER) == 0)
      EndAction(1);
      RETURN;
   END;

   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN ? := LoansFillPayment.FillWSRefInc(?,?,?,?,?,?,?,?); END;");
   RSDcmd1.addParam("RetVal",     RSDBP_RETVAL, V_INTEGER );
   RSDcmd1.AddParam("TaskID",     RSDBP_IN, 0);
   RSDcmd1.AddParam("ExecID",     RSDBP_IN, Cnt);
   RSDcmd1.AddParam("ConveyerID", RSDBP_IN, 0);
   RSDcmd1.AddParam("PacketID",   RSDBP_IN, 0);
   RSDcmd1.AddParam("DutyType",   RSDBP_IN, DutyType);
   RSDcmd1.AddParam("OperDate",   RSDBP_IN, OperDate);
   RSDcmd1.AddParam("CalcDate",   RSDBP_IN, CalcDate);
   RSDcmd1.AddParam("ForGraph",   RSDBP_IN, ForGraph);

   RSDcmd1.execute();

   EndAction(1);
END;