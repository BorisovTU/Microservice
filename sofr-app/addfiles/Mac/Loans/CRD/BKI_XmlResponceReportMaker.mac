/*
$Name:             BKI_XmlResponceReportMaker.mac                                              
$Module:           Кредитование
$Description:      Класс для разбора xml-ответов из БКИ и формирования отчета
*/
import zp_CXml, or_tpl_h;
import Consts_XmlBKI_XlsTmplNamedFields; // Константы. Именованные поля, XML-теги.
private VAR {GROUP_MODE};
//--------------------------------------------------------------------
MACRO BKI_isStandalone( )
   return true; // в WEB нет 3х звенки
END;

class BKI_XmlResponceReportMaker(_ReportType:integer)

    // Члены класса
    private var XML_Obj:C_XML      = NULL;
    private var CurrentNode:object = NULL;
    private var FNameReport:string = NULL;
    private var ReportType:integer = NULL;

    private var BlocksNum:integer      = 0;  // Кол-во блоков в отчете(для прогрес-бара)
    private var NameXlsTemplate:string = "";

    private var ErrCode:string         = "";
    private var ErrString:string       = "";

    private var ReportFileName         = "";

    private macro InitErrorValues(ErrObj:variant)

        if(ValType(ErrObj) == V_STRING)
            ErrString = ErrObj;
        elif(ValType(ErrObj) == V_UNDEF)
            ErrCode   = CurrentNode.selectSingleNode("//" + BKI.TAG_CODE).text;
            ErrString = CurrentNode.selectSingleNode("//" + BKI.TAG_TEXT).text;
        end;

    end;

    private macro Constructor(RepType:integer)

        ReportType = RepType;
        if   (ReportType == BKI.CHIP) NameXlsTemplate = BKI.CHIP_TEMPLATE; BlocksNum = 10;
        elif (ReportType == BKI.CHST) NameXlsTemplate = BKI.CHST_TEMPLATE; BlocksNum = 9;
        elif (ReportType == BKI.CIPO) NameXlsTemplate = BKI.CIPO_TEMPLATE; BlocksNum = 4;
        elif (ReportType == BKI.BHST) NameXlsTemplate = BKI.BHST_TEMPLATE; BlocksNum = 9;
        else
            InitErrorValues("Неверно задан тип отчета");
            exit(1);
        end;

    end;


    macro Init(RespXMLPath:string, _FNameReport:string) : bool

        FNameReport = _FNameReport;
        XML_Obj = C_XML();
        if (not XML_Obj.load(RespXMLPath))
            return TRUE;
        end;

        InitErrorValues("Ошибка загрузки <" + RespXMLPath + ">");
        return FALSE;

    end;

    macro GetErrCode() return ErrCode;   end;

    macro GetErrMess() return ErrString; end;


    // Получает родную ноду-дочку
    private macro GetChildNodeByTagName(CurNode:object, ChildTagName:string) : object

        CurNode = CurNode.lastChild;
        while(CurNode)
            if(CurNode.NodeName == ChildTagName) return CurNode; end;
            CurNode = CurNode.previousSibling;
        end;

        return CurNode;
    end;


    // Получает значение родной ноды-дочки
    private macro GetChildTagValueByTagName(CurNode:object, ChildTagName:string) : string

        var retStr:string = "";

        if(CurNode = GetChildNodeByTagName(CurNode, ChildTagName))
            retStr = CurNode.text;
            if(retStr != "") return retStr; end;
        end;

        return "нет данных";
    end;


    // Высота подТаблиц
    private macro SetHeightSubTable(Tbl:object, h:integer, nameDelimitr:string)

        if (h > BKI.HEIGHT_COLUMN)
            h = h - BKI.HEIGHT_COLUMN;
            while(h)
                Tbl.AddStr();
                h = h - 1;
            end;
        end;
    end;


    // Если тег не найден
    private macro NoInfo(Tmpl:object, ClearFldName:string, NoInfoFldName:string, BlockName:string)

        var ClearTable:object = Tmpl.RegisterTable(ClearFldName);

        ClearTable.EndTable();
        Tmpl.SetValue_NameCell(NoInfoFldName, BlockName + " - нет информации");

    end;


    // Формирование отчета
    macro RunReport()
        const BASE_PARENT_NODE:object = CurrentNode;  // - это узел <report>
        var tempNode:object    = NULL;
        var ChildArray1:object = NULL;
        var ChildArray2:object = NULL;
        var Tmpl:CTemplateXLS  = CTemplateXLS();
        var Tbl:object         = NULL;
        var Clear_Area:object  = NULL;
        var Value:string       = "";
        var tStr:string        = "";
        var CellAddr1:string   = "";
        var CellAddr2:string   = "";
        var endNum1:integer    = 0;
        var endNum2:integer    = 0;
        var i:integer          = 0;
        var j:integer          = 0;
        var tVariable:integer  = 0;
        var Progress:integer   = 0;
        var PathFile = "";
        //var ProgressBar = CRslProgressBar2();
        
        
        // Открываем шаблон
        if (not Tmpl.OpenTemplate(NameXlsTemplate)) InitErrorValues("Не найден XLS-шаблон <" + NameXlsTemplate + " >"); end;


        // Заполнение шапки
        Tmpl.SetValue_NameCell(BKI.INQ_CONTROL_NUM, GetChildTagValueByTagName(BASE_PARENT_NODE, BKI.INQ_CONTROL_NUM)); // Код запроса
        Tmpl.SetValue_NameCell(BKI.MEMEBER_CODE, GetChildTagValueByTagName(BASE_PARENT_NODE, BKI.MEMEBER_CODE));       // Код участника

        // Форматируем дату получения отчета в удобоваримый вид
        if(CurrentNode = BASE_PARENT_NODE.SelectSingleNode("//" + BKI.TAG_PREPLY + "//" + BKI.CALC + "//" + BKI.REPORT_ISSUE_DATE_TIME))
            Value = CurrentNode.text;
            Value = SubStr(Value, 1, 10) + " " + SubStr(Value, 12, 8);
        else
            Value = "нет данных";
        end;
        Tmpl.SetValue_NameCell(BKI.REPORT_ISSUE_DATE_TIME, Value); // Дата отчета

        // Прогрес-бар
        //ProgressBar.Open(0, BlocksNum, "Заполнение шаблона");
        InitProgress(BlocksNum, "Идет заполнение шаблона. Ждите...", "Заполнение шаблона.");
        
        Tmpl.SetCopyByRows(TRUE);


        if(ReportType == BKI.BHST) // Блок "Заемщик" <BusinessReply> --- если тип отчета BHST

            // Классифицирование
            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.CLASSIFICATION_REPLY);
            if(ChildArray1 and ChildArray1.length)

                Tbl = Tmpl.RegisterTable(BKI.CR_DELIMITER);

                SetHeightSubTable(Tbl, ChildArray1.length, BKI.CR_DELIMITER);

                CellAddr1 = Tbl.GetCurAddress(BKI.CR_TYPE_CODE);
                endNum1   = Int(SubStr(CellAddr1, 4));
                CellAddr1 = SubStr(CellAddr1, 2, 1);

                i = 0;
                while(i < ChildArray1.length)
                    if(i < ChildArray1.length)
                        Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i), BKI.CR_TAG_NUMBER));
                        Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i),BKI.CR_TYPE_CODE));
                    end;
                    i = i + 1;
                end;

            else
                Clear_Area = Tmpl.RegisterTable(BKI.CR_INFO_AREA);
                Clear_Area.ClearCurRow(BKI.CR_INFO_AREA);
            end;



            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.BUSINESS_REPLY);
            if(ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Заемщик\"");
                InitProgress(ChildArray1.length, "Идет заполнение шаблона. Ждите...", "Заполнение блока \"Заемщик\"");
                
                // Регистрируем два рабочих диапазона
                       Tbl = Tmpl.RegisterTable(BKI.BR_BUSINESS_HEIGHT ); // Так как используем SetCopyByRows(TRUE) задаем высоту копируемой области
                Clear_Area = Tmpl.RegisterTable(BKI.BR_BUSINESS_CAPTION);

                i = 0;
                while(i < ChildArray1.length)

                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_BUSINESS_NAME);
                    Tmpl.SetValue_NameCell(BKI.BR_BUSINESS_NAME, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_BUSINESS_NAME_ALT);
                    Tmpl.SetValue_NameCell(BKI.BR_BUSINESS_NAME_ALT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_ABBREVIATED_BUSINESS_NAME);
                    Tmpl.SetValue_NameCell(BKI.BR_ABBREVIATED_BUSINESS_NAME, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_BUSINESS_STATUS_TEXT);
                    Tmpl.SetValue_NameCell(BKI.BR_BUSINESS_STATUS_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_DATE_OF_STATUS);
                    Tmpl.SetValue_NameCell(BKI.BR_DATE_OF_STATUS, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_REVENUE_RANGE_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.BR_REVENUE_RANGE_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_NUMBER_OF_EMPLOYEES);
                    Tmpl.SetValue_NameCell(BKI.BR_NUMBER_OF_EMPLOYEES, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.BR_NUMBER_OF_DIRECTORS);
                    Tmpl.SetValue_NameCell(BKI.BR_NUMBER_OF_DIRECTORS, Value);


                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.PERSON_CAPTION);  // Удаляем заголовок после каждого добавления диапазона
                    Clear_Area.ClearCurRow(BKI.CR_INFO_AREA);
                    //ProgressBar.Use(1, i);
                    UseProgress (i); 
                    i = i + 1;
                end;
                RemProgress (ChildArray1.length);
                Tbl.EndTable();
            else
                NoInfo(Tmpl, BKI.BR_BUSINESS_INFO_AREA, BKI.BR_BUSINESS_NO_INFO, "Заемщик"); // Если тег не найден, очищается иформационная область
                                                                                             // и выводится "нет данных"
            end;
        else  // Блок "Заемщик" <PersonReply> --- Все другие типы отчета

            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.PERSON_REPLY);
            if(ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Заемщик\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Заемщик\"");
                
                // Регистрируем два рабочих диапазона
                       Tbl = Tmpl.RegisterTable(BKI.PERSON_HEIGHT ); // Так как используем SetCopyByRows(TRUE) задаем высоту копируемой области
                Clear_Area = Tmpl.RegisterTable(BKI.PERSON_CAPTION);





                while(i < ChildArray1.length)

                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_NAME) + "  "
                        + GetChildTagValueByTagName(CurrentNode, BKI.PERSON_PATERNAL) + "  "
                        + GetChildTagValueByTagName(CurrentNode, BKI.PERSON_FIRST);

                    if(i) Value = Value + "  (доп.)"; end;

                    Tmpl.SetValue_NameCell(BKI.PERSON_NAME, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_GENDER_TEXT);
                    Tmpl.SetValue_NameCell(BKI.PERSON_GENDER_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_NATIONALITY_TEXT);
                    Tmpl.SetValue_NameCell(BKI.PERSON_NATIONALITY_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_BIRTH_DATE);
                    Tmpl.SetValue_NameCell(BKI.PERSON_BIRTH_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_PLACE_OF_BIRTH);
                    Tmpl.SetValue_NameCell(BKI.PERSON_PLACE_OF_BIRTH, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_MARITAL_STATUS_TEXT);
                    Tmpl.SetValue_NameCell(BKI.PERSON_MARITAL_STATUS_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_NUM_DEPENDATS);
                    Tmpl.SetValue_NameCell(BKI.PERSON_NUM_DEPENDATS, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PERSON_DEATH_FLAG);
                    Tmpl.SetValue_NameCell(BKI.PERSON_DEATH_FLAG, Value);

                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.PERSON_CAPTION);  // Удаляем заголовок после каждого добавления диапазона
                    //ProgressBar.Use(1, i);
                    UseProgress (i); 
                    i = i + 1;
                end;
                RemProgress (ChildArray1.length);
                Tbl.EndTable();
            else
                NoInfo(Tmpl, BKI.PERSON_INFO_TABLE, BKI.PERSON_NO_INFO, "Заемщик");
            end;
        end;

        //ProgressBar.Use(0, Progress = Progress + 1);
        UseProgress (Progress = Progress + 1);
        Tmpl.SetCopyByRows(FALSE);

        //-------------------------------------------------------------------------------------
        //Блок "Сводка" <calc>


        if (CurrentNode = GetChildNodeByTagName(BASE_PARENT_NODE, BKI.CALC))


            if(ReportType != BKI.CIPO)

                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_ACCTS);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_ACCTS, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_NEGATIVE_RATING);
                Tmpl.SetValue_NameCell(BKI.CALC_NEGATIVE_RATING, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_ACTIVE_BALANCE_ACCOUNTS);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_ACTIVE_BALANCE_ACCOUNTS, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_MOST_RECENT_ACC);
                Tmpl.SetValue_NameCell(BKI.CALC_MOST_RECENT_ACC, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_OLDEST);
                Tmpl.SetValue_NameCell(BKI.CALC_OLDEST, Value);

                        /*----------подТаблица-------------*/

                Tbl = Tmpl.RegisterTable(BKI.CALC_DELIMITER1);

                // Запоминаем адрес ячейки от которой будем заполнять подтаблицу
                CellAddr1 = Tbl.GetCurAddress(BKI.CALC_TOTAL_HIGH_CREDIT);
                endNum1   = Int(SubStr(CellAddr1, 4));
                CellAddr1 = SubStr(CellAddr1, 2, 1);

                CellAddr2 = Tbl.GetCurAddress(BKI.CALC_TOTAL_CURRENT_BALANCE);
                endNum2   = Int(SubStr(CellAddr2, 4));
                CellAddr2 = SubStr(CellAddr2, 2, 1);


                ChildArray1 = CurrentNode.GetElementsByTagName(BKI.CALC_TOTAL_HIGH_CREDIT);
                ChildArray2 = CurrentNode.GetElementsByTagName(BKI.CALC_TOTAL_CURRENT_BALANCE);

                j = max(ChildArray1.length, ChildArray2.length); // Максимальная высота подтаблицы

                // Функция добавляет нужное кол-во пустых строк для корректного вывода подтаблиц любой высоты
                SetHeightSubTable(Tbl, j, BKI.CALC_DELIMITER1);

                // Заполняем подтаблицы от запомненных ранее адресов

                if(not ChildArray1.length)
                    Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1), "");
                    Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1), "нет данных");
                else
                    i = 0;
                    while(i < ChildArray1.length)
                        Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i), BKI.TAG_VALUE));
                        Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i),BKI.TAG_CODE));
                        i = i + 1;
                    end;
                end;



                if(not ChildArray2.length)
                    Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr2) +1) + String(endNum2), "");
                    Tmpl.SetValue_NameCell(CellAddr2 + String(endNum2), "нет данных");
                else
                    i = 0;
                    while(i < ChildArray2.length)
                        Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr2) +1) + String(endNum2+i), GetChildTagValueByTagName(ChildArray2.item(i), BKI.TAG_VALUE));
                        Tmpl.SetValue_NameCell(CellAddr2 + String(endNum2+i), GetChildTagValueByTagName(ChildArray2.item(i), BKI.TAG_CODE));
                        i = i + 1;
                    end;
                end;


                        /*----------подТаблица-------------*/

                Tbl = Tmpl.RegisterTable(BKI.CALC_DELIMITER2);

                // Запоминаем адрес ячейки от которой будем заполнять подтаблицу
                CellAddr1 = Tbl.GetCurAddress(BKI.CALC_TOTAL_SCHEDULED_PAYMNTS);
                endNum1   = Int(SubStr(CellAddr1, 4));
                CellAddr1 = SubStr(CellAddr1, 2, 1);

                CellAddr2 = Tbl.GetCurAddress(BKI.CALC_TOTAL_OUTSTANDING_BALANCE);
                endNum2   = Int(SubStr(CellAddr2, 4));
                CellAddr2 = SubStr(CellAddr2, 2, 1);


                ChildArray1 = CurrentNode.GetElementsByTagName(BKI.CALC_TOTAL_SCHEDULED_PAYMNTS);
                ChildArray2 = CurrentNode.GetElementsByTagName(BKI.CALC_TOTAL_OUTSTANDING_BALANCE);

                j = max(ChildArray1.length, ChildArray2.length); // Максимальная высота подтаблицы
                SetHeightSubTable(Tbl, j, BKI.CALC_DELIMITER2);


                // Заполняем подтаблицы от запомненных ранее адресов


                if(not ChildArray1.length)
                    Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1), "");
                    Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1), "нет данных");
                else
                    i = 0;
                    while(i < ChildArray1.length)
                        Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i), BKI.TAG_VALUE));
                        Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i),BKI.TAG_CODE));
                        i = i + 1;
                    end;
                end;


                if(not ChildArray2.length)
                    Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr2) +1) + String(endNum2), "");
                    Tmpl.SetValue_NameCell(CellAddr2 + String(endNum2), "нет данных");
                else
                    i = 0;
                    while (i < ChildArray2.length)
                        Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr2) +1) + String(endNum2+i), GetChildTagValueByTagName(ChildArray2.item(i), BKI.TAG_VALUE));
                        Tmpl.SetValue_NameCell(CellAddr2 + String(endNum2+i), GetChildTagValueByTagName(ChildArray2.item(i), BKI.TAG_CODE));
                        i = i + 1;
                    end;
                end;

                        /*----------подТаблица-------------*/

                Tbl = Tmpl.RegisterTable(BKI.CALC_DELIMITER3);

                CellAddr1 = Tbl.GetCurAddress(BKI.CALC_TOTAL_PAST_DUE_BALANCE);
                endNum1   = Int(SubStr(CellAddr1, 4));
                CellAddr1 = SubStr(CellAddr1, 2, 1);

                ChildArray1 = CurrentNode.GetElementsByTagName(BKI.CALC_TOTAL_PAST_DUE_BALANCE);
                SetHeightSubTable(Tbl, ChildArray1.length, BKI.CALC_DELIMITER3);

                if(not ChildArray1.length)
                    Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1), "");
                    Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1), "нет данных");
                else
                    i = 0;
                    while(i < ChildArray1.length)
                        Tmpl.SetValue_NameCell(StrFor(CodeFor(CellAddr1) +1) + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i), BKI.TAG_VALUE));
                        Tmpl.SetValue_NameCell(CellAddr1 + String(endNum1+i), GetChildTagValueByTagName(ChildArray1.item(i), BKI.TAG_CODE ));
                        i = i + 1;
                    end;
                end;

                // Заполняем оставшиеся поля в этом блоке
                // Запросы
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_INQUIRIES);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_INQUIRIES, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_RECENT_INQUIRIES);
                Tmpl.SetValue_NameCell(BKI.CALC_RECENT_INQUIRIES, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_COLLECTIONS_INQUIRIES);
                Tmpl.SetValue_NameCell(BKI.CALC_COLLECTIONS_INQUIRIES, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_MOST_RECENT_INQ_TEXT);
                Tmpl.SetValue_NameCell(BKI.CALC_MOST_RECENT_INQ_TEXT, Value);

            end;

            // Информац.часть
            if((ReportType == BKI.CIPO) or (ReportType == BKI.CHIP))
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_IP_RECORDS);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_IP_RECORDS, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_MOST_RECENT_LOAN_APP_DT);
                Tmpl.SetValue_NameCell(BKI.CALC_MOST_RECENT_LOAN_APP_DT, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_OLDEST_LOAN_APP_DT);
                Tmpl.SetValue_NameCell(BKI.CALC_OLDEST_LOAN_APP_DT, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_REJECTED_IP_RECORDS);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_REJECTED_IP_RECORDS, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_APPROVED_IP_RECORDS);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_APPROVED_IP_RECORDS, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_DEFAULT_FLAG_IP_RECORDS);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_DEFAULT_FLAG_IP_RECORDS, Value);
            end;

            // Банкротства
            if(ReportType != BKI.CIPO)
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_BANKRUPTCIES);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_BANKRUPTCIES, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_MOST_RECENT_BANKRUPTCY);
                Tmpl.SetValue_NameCell(BKI.CALC_MOST_RECENT_BANKRUPTCY, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.CALC_TOTAL_CLOSED_BANKRUPTCIES);
                Tmpl.SetValue_NameCell(BKI.CALC_TOTAL_CLOSED_BANKRUPTCIES, Value);
            end;
        else
            NoInfo(Tmpl, BKI.CALC_INFO_AREA, BKI.CALC_NO_INFO, "Сводка");
        end;
        Progress = Progress + 1;

        //-----------------------------------------------------------------------------------
        // Блок "Идентификация заемщика"  <IdReply>

        ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.ID_REPLY);

        if(ChildArray1 and ChildArray1.length)

            //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Идентификация заемщика\"");
            InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Идентификация заемщика\"");

            Tbl =        Tmpl.RegisterTable(BKI.ID_HEIGHT);
            Clear_Area = Tmpl.RegisterTable(BKI.ID_CAPTION);

            Tmpl.SetCopyByRows(TRUE);

            i = 0;
            while (i < ChildArray1.length)
                CurrentNode = ChildArray1.item(i);

                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_TYPE_TEXT);
                Tmpl.SetValue_NameCell(BKI.ID_TYPE_TEXT, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_SERIES_NUMBER);
                Tmpl.SetValue_NameCell(BKI.ID_SERIES_NUMBER, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_NUM);
                Tmpl.SetValue_NameCell(BKI.ID_NUM, Value);

                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_DATA_VALIDITY);
                if (Value == "")
                    Tmpl.SetValue_NameCell(BKI.ID_DATA_VALIDITY, "документ не действителен");
                elif (Value == "I")
                    Tmpl.SetValue_NameCell(BKI.ID_DATA_VALIDITY, "документ действителен");
                else
                    Tmpl.SetValue_NameCell(BKI.ID_DATA_VALIDITY, Value);
                end;

                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_ISSUE_DATE);
                Tmpl.SetValue_NameCell(BKI.ID_ISSUE_DATE, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_ISSUE_AUTHORITY);
                Tmpl.SetValue_NameCell(BKI.ID_ISSUE_AUTHORITY, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.ID_ISSUE_COUNTRY);
                if(Value == "нет данных" ) Value = ""; end;
                Tmpl.SetValue_NameCell(BKI.ID_ISSUE_COUNTRY, Value);
                Value = GetChildTagValueByTagName(CurrentNode, BKI.TAG_LAST_UPDATED_DT);
                Tmpl.SetValue_NameCell(BKI.ID_LAST_UPDATED_DT, Value);

                Tbl.AddStr();
                Clear_Area.ClearCurRow(BKI.ID_CAPTION);
                //ProgressBar.Use(1, i);
                 UseProgress (i); 
                i = i + 1;
            end;
            Tbl.EndTable();
            RemProgress (ChildArray1.length);           
        else
            NoInfo(Tmpl, BKI.ID_INFO_AREA, BKI.ID_NO_INFO, "Идентификация заемщика");
        end;

       // ProgressBar.Use(0, Progress = Progress + 1);
        UseProgress (Progress = Progress + 1); 
        //-----------------------------------------------------------------------------
        // Блок "Адреса" <AddressReply>

        if(ReportType != BKI.CIPO)

            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.ADDRESS_REPLY);
            if(ChildArray1 and ChildArray1.length)

               // ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Адреса\"");
               InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Адреса\"");
               
                Tbl =        Tmpl.RegisterTable(BKI.ADDRESS_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.ADDRESS_CAPTION);

                var StrArray:tarray = TArray();
                StrArray[StrArray.Size] = BKI.TAG_ADDR_POSTAL;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_CITY;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_STREET_TYPE_TEXT;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_STREET;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_HOUSE_NUMBER;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_BLOCK;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_BUILDING;
                StrArray[StrArray.Size] = BKI.TAG_ADDR_APARTMENT;

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ADDR_ADDRESS_TYPE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_ADDRESS_TYPE_TEXT, Value);

                    // Форматируем строку адреса, расставляем запятые и т.д.
                    j = 0;
                    tStr = "";
                    while(j < StrArray.Size)
                        Value = GetChildTagValueByTagName(CurrentNode, StrArray[j]);
                        if((Value != "нет данных") and (Value != ""))
                            if((StrArray[j] == BKI.TAG_ADDR_APARTMENT) or (tStr == ""))
                            else
                                if (StrArray[j] == BKI.TAG_ADDR_STREET)
                                    Value = " " + Value;
                                else
                                    Value = ", " + Value;
                                end;
                            end;
                            tStr = tStr + Value;
                        end;
                        j = j + 1;
                    end;
                    Tmpl.SetValue_NameCell(BKI.ADDR_ADDRESS, tStr);

                    // Остальные поля
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ADDR_COUNTRY_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_COUNTRY_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ADDR_PROV_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_PROV_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ADDR_DISTRICT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_DISTRICT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.TAG_LAST_UPDATED_DT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_LAST_UPDATED_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ADDR_RES_STAT_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_RES_STAT_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ADDR_SINCE_DT);
                    Tmpl.SetValue_NameCell(BKI.ADDR_SINCE_DT, Value);

                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.ADDRESS_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length); 
            else
                NoInfo(Tmpl, BKI.ADDRESS_INFO_AREA, BKI.ADDRESS_NO_INFO, "Адреса");
            end;


            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1); 
            
            //----------------------------------------------------------------------------------
            // Блок "Телефоны" <PhoneReply>

            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.PHONE_REPLY);
            if(ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Телефоны\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Телефоны\"");

                Tbl =        Tmpl.RegisterTable(BKI.PHONE_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.PHONE_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PHONE_TYPE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.PHONE_TYPE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.PHONE_NUMBER);
                    Tmpl.SetValue_NameCell(BKI.PHONE_NUMBER, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.TAG_LAST_UPDATED_DT);
                    Tmpl.SetValue_NameCell(BKI.PHONE_LAST_UPDATED_DT, Value);

                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.PHONE_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);
            else
                NoInfo(Tmpl, BKI.PHONE_INFO_AREA, BKI.PHONE_NO_INFO, "Телефоны");
            end;

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1); 
            
            //----------------------------------------------------------------------------------
            // Блок "Сделка" <AccountReply>

            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.ACCOUNT_REPLY);
            if (ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Сделка\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Сделка\"");

                Tbl =        Tmpl.RegisterTable(BKI.ACCNT_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.ACCNT_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_ACCT_TYPE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_ACCT_TYPE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_OWNER_INDIC_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_OWNER_INDIC_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_CURRENCY_CODE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_CURRENCY_CODE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_CREDIT_LIMIT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_CREDIT_LIMIT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_CREDIT_TOTAL_AMT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_CREDIT_TOTAL_AMT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_ACCOUNT_RATING_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_ACCOUNT_RATING_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_OPENED_DT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_OPENED_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_PAYMENT_DUE_DATE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_PAYMENT_DUE_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_ACCOUNT_RATING_DATE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_ACCOUNT_RATING_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_INTEREST_PAYMENT_DUE_DATE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_INTEREST_PAYMENT_DUE_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_LAST_PAYMT_DT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_LAST_PAYMT_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_PAYMT_FREQ_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_PAYMT_FREQ_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_COMPLETE_PERFORM_DT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_COMPLETE_PERFORM_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_INTEREST_PAYMENT_FREQUENCY_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_INTEREST_PAYMENT_FREQUENCY_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_LAST_UPDATE_DT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_LAST_UPDATE_DT, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_COLLATERAL_2_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_COLLATERAL_2_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_COLLATERAL_VALUE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_COLLATERAL_VALUE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_COLLATERAL_DATE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_COLLATERAL_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_COLLATERAL_EXPIRATION_DATE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_COLLATERAL_EXPIRATION_DATE, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_NUM_DAYS_30);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_NUM_DAYS_30, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_NUM_DAYS_60);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_NUM_DAYS_60, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_NUM_DAYS_90);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_NUM_DAYS_90, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_GUARANTEE_VOLUME_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_GUARANTEE_VOLUME_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_GUARANTEE_AMT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_GUARANTEE_AMT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_GUARANTEE_TERM);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_GUARANTEE_TERM, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_CUR_BALANCE_AMT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_CUR_BALANCE_AMT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_AMT_OUTSTANDING);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_AMT_OUTSTANDING, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_AMT_PAST_DUE);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_AMT_PAST_DUE, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_TERMS_AMT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_TERMS_AMT, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_BANK_GUARANTEE_VOLUME_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_BANK_GUARANTEE_VOLUME_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_BANK_GUARANTEE_AMT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_BANK_GUARANTEE_AMT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_BANK_GUARANTEE_TERM);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_BANK_GUARANTEE_TERM, Value);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_MONTHS_REVIEWED);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_MONTHS_REVIEWED, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.ACCNT_PAYMT_PAT);
                    Tmpl.SetValue_NameCell(BKI.ACCNT_PAYMT_PAT, Value);

                    if(tempNode = GetChildNodeByTagName(CurrentNode, BKI.TAG_ACCNT_ADD_COLLATERAL))
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_COLLATERAL_2_TEXT);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_2_TEXT, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_COLLATERAL_VALUE);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_VALUE, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_COLLATERAL_DATE);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_DATE, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_COLLATERAL_EXPIRATION_DATE);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_EXPIRATION_DATE, Value);
                    else
                        Value = "нет данных";
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_2_TEXT, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_VALUE, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_DATE, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_COLLATERAL_EXPIRATION_DATE, Value);

                    end;


                    if(tempNode = GetChildNodeByTagName(CurrentNode, BKI.TAG_ACCNT_ADD_BANK_GUARANTEE))
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_BANK_GUARANTEE_VOLUME_CODE_TEXT);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_BANK_GUARANTEE_VOLUME_CODE_TEXT, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_BANK_GUARANTEE_AMT);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_BANK_GUARANTEE_AMT, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_BANK_GUARANTEE_TERM);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_BANK_GUARANTEE_TERM, Value);
                    else
                        Value = "нет данных";
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_BANK_GUARANTEE_VOLUME_CODE_TEXT, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_BANK_GUARANTEE_AMT, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_BANK_GUARANTEE_TERM, Value);
                    end;


                    if(tempNode = GetChildNodeByTagName(CurrentNode, BKI.TAG_ACCNT_ADD_GUARANTOR))
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_GUARANTEE_VOLUME_CODE_TEXT);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_GUARANTEE_VOLUME_CODE_TEXT, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_GUARANTEE_AMT);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_GUARANTEE_AMT, Value);
                        Value = GetChildTagValueByTagName(tempNode, BKI.ACCNT_GUARANTEE_TERM);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_GUARANTEE_TERM, Value);
                    else
                        Value = "нет данных";
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_GUARANTEE_VOLUME_CODE_TEXT, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_GUARANTEE_AMT, Value);
                        Tmpl.SetValue_NameCell(BKI.ACCNT_ADD_GUARANTEE_TERM, Value);
                    end;
                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.ACCNT_CAPTION);
                    UseProgress (i);
                    //ProgressBar.Use(1, i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);
            else
                NoInfo(Tmpl, BKI.ACCNT_INFO_AREA, BKI.ACCNT_NO_INFO, "Сделка");
            end;

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1); 

            //------------------------------------------------------------------------------------------------
            // Блок "Случаи привлечения к ответственности" <LegalItemsReply>


            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.LEGAL_ITEMS_REPLY);
            if (ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Случаи привлечения к ответственности\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Случаи привлечения к ответственности\"");

                Tbl =        Tmpl.RegisterTable(BKI.LI_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.LI_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.LI_COURT);
                    Tmpl.SetValue_NameCell(BKI.LI_COURT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.LI_FILE_SINCE_DT);
                    Tmpl.SetValue_NameCell(BKI.LI_FILE_SINCE_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.LI_CONSIDERED_DT);
                    Tmpl.SetValue_NameCell(BKI.LI_CONSIDERED_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.LI_SATISFIED_DT);
                    Tmpl.SetValue_NameCell(BKI.LI_SATISFIED_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.LI_RESOLUTION);
                    Tmpl.SetValue_NameCell(BKI.LI_RESOLUTION, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.TAG_LAST_UPDATED_DT);
                    Tmpl.SetValue_NameCell(BKI.LI_LAST_UPDATED_DT, Value);
                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.LI_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);
            else
                NoInfo(Tmpl, BKI.LI_INFO_AREA, BKI.LI_NO_INFO, "Случаи привлечения к ответственности");
            end;

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1); 
        end;

        //-------------------------------------------------------------------------------------------------
        // Блок "Банкротство физлица" <ConsumerBankruptcyReply>
        if((ReportType == BKI.CHIP) or (ReportType == BKI.CHST))
            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.CONSUMER_BANKRUPTCY_REPLY);
            if (ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Банкротство физлица\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Банкротство физлица\"");

                Tbl =        Tmpl.RegisterTable(BKI.CBR_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.CBR_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_CASE_ID);
                    Tmpl.SetValue_NameCell(BKI.CBR_CASE_ID, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_REPORTING_DATE);
                    Tmpl.SetValue_NameCell(BKI.CBR_REPORTING_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_BANKRUPTCY_TYPE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.CBR_BANKRUPTCY_TYPE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_MANAGER_START_DT);
                    Tmpl.SetValue_NameCell(BKI.CBR_MANAGER_START_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_MANAGER_END_DT);
                    Tmpl.SetValue_NameCell(BKI.CBR_MANAGER_END_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_ADDITIONAL_INFO_TEXT);
                    Tmpl.SetValue_NameCell(BKI.CBR_ADDITIONAL_INFO_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_CLOSE_DT);
                    Tmpl.SetValue_NameCell(BKI.CBR_CLOSE_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_OTHER_ADDITIONAL_INFO);
                    Tmpl.SetValue_NameCell(BKI.CBR_OTHER_ADDITIONAL_INFO, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.CBR_ADDITIONAL_INCLUSION_DT);
                    Tmpl.SetValue_NameCell(BKI.CBR_ADDITIONAL_INCLUSION_DT, Value);
                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.CBR_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);
            else
                NoInfo(Tmpl, BKI.CBR_INFO_AREA, BKI.CBR_NO_INFO, "Банкротство физлица");
            end;

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1); 
        end;

        //-------------------------------------------------------------------------------------------------
        // Блок "Банкротство юрлица"
        if(ReportType == BKI.BHST)
            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.BANKRUPTCY_REPLY);
            if (ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Банкротство юрлица\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Банкротство юрлица\"");

                Tbl =        Tmpl.RegisterTable(BKI.B_BANKRUPTCY_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.B_BANKRUPTCY_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_COURT);
                    Tmpl.SetValue_NameCell(BKI.B_BANKRUPTCY_COURT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_CASE_NUM);
                    Tmpl.SetValue_NameCell(BKI.B_CASE_NUM, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_PLAINTIFF);
                    Tmpl.SetValue_NameCell(BKI.B_PLAINTIFF, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_RESOLUTION);
                    Tmpl.SetValue_NameCell(BKI.B_BANKRUPTCY_RESOLUTION, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_BANKRUPTCY_STATUS_TEXT);
                    Tmpl.SetValue_NameCell(BKI.B_BANKRUPTCY_STATUS_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_DISCHARGE_DT);
                    Tmpl.SetValue_NameCell(BKI.B_DISCHARGE_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.B_REPORTED_DT);
                    Tmpl.SetValue_NameCell(BKI.B_REPORTED_DT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.TAG_LAST_UPDATED_DT);
                    Tmpl.SetValue_NameCell(BKI.B_BANKRUPTCY_LAST_UPDATED_DT, Value);
                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.B_BANKRUPTCY_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);
            else
                NoInfo(Tmpl, BKI.B_BANKRUPTCY_INFO_AREA, BKI.B_BANKRUPTCY_NO_INFO, "Банкротство юрлица");
            end;

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1);
        end;
        //-------------------------------------------------------------------------------------------------
        // Блок "Информационная часть" <InformationPartReply>
        if((ReportType == BKI.CHIP) or (ReportType == BKI.CIPO))
            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.INFORMATION_PART_REPLY);
            if (ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Информационная часть\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Информационная часть\"");

                Tbl =        Tmpl.RegisterTable(BKI.IP_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.IP_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_APPLICATION_NUMBER);
                    Tmpl.SetValue_NameCell(BKI.IP_APPLICATION_NUMBER, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_APPLICATION_DATE);
                    Tmpl.SetValue_NameCell(BKI.IP_APPLICATION_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_CREDITOR_TYPE_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.IP_CREDITOR_TYPE_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_FLAG_INDICATOR_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.IP_FLAG_INDICATOR_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_REQUESTED_LOAN_TYPE_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.IP_REQUESTED_LOAN_TYPE_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_APPLICATION_SHIPMENT_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.IP_APPLICATION_SHIPMENT_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_APPROVAL_FLAG);
                    Tmpl.SetValue_NameCell(BKI.IP_APPROVAL_FLAG, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_APPROVAL_EXPIRE_DATE);
                    Tmpl.SetValue_NameCell(BKI.IP_APPROVAL_EXPIRE_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_REJECTED_AMT);
                    Tmpl.SetValue_NameCell(BKI.IP_REJECTED_AMT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_REJECTED_AMT_CURRENCY_CODE);
                    Tmpl.SetValue_NameCell(BKI.IP_REJECTED_AMT_CURRENCY_CODE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_REJECTED_DATE);
                    Tmpl.SetValue_NameCell(BKI.IP_REJECTED_DATE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_REJECTED_REASON_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.IP_REJECTED_REASON_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_APPROVED_LOAN_TYPE_CODE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.IP_APPROVED_LOAN_TYPE_CODE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_DEFAULT_FLAG);
                    Tmpl.SetValue_NameCell(BKI.IP_DEFAULT_FLAG, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.IP_LOAN_INDICATOR);
                    Tmpl.SetValue_NameCell(BKI.IP_LOAN_INDICATOR, Value);
                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.IP_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);
            else
                NoInfo(Tmpl, BKI.IP_INFO_AREA, BKI.IP_NO_INFO, "Информационная часть");
            end;

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1);
        end;

        //-------------------------------------------------------------------------------------------------
        // Блок "Запросы" <InquiryReply>
        if(ReportType != BKI.CIPO)
            ChildArray1 = BASE_PARENT_NODE.GetElementsByTagName(BKI.INQUIRY_REPLAY);
            if (ChildArray1 and ChildArray1.length)

                //ProgressBar.Open(1, ChildArray1.length, "Заполнение блока \"Запросы\"");
                InitProgress(ChildArray1.length, "Идет заполнение. Ждите...", "Заполнение блока \"Запросы\"");

                Tbl =        Tmpl.RegisterTable(BKI.INQ_HEIGHT);
                Clear_Area = Tmpl.RegisterTable(BKI.INQ_CAPTION);

                i = 0;
                while (i < ChildArray1.length)
                    CurrentNode = ChildArray1.item(i);

                    Value = GetChildTagValueByTagName(CurrentNode, BKI.INQ_INQUIRY_PERIOD);
                    Tmpl.SetValue_NameCell(BKI.INQ_INQUIRY_PERIOD, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.INQ_INQ_PURPOSE_TEXT);
                    Tmpl.SetValue_NameCell(BKI.INQ_INQ_PURPOSE_TEXT, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.TAG_CURRENCY_CODE);
                    Tmpl.SetValue_NameCell(BKI.INQ_CURRENCY_CODE, Value);
                    Value = GetChildTagValueByTagName(CurrentNode, BKI.INQ_AMOUNT);
                    Tmpl.SetValue_NameCell(BKI.INQ_AMOUNT, Value);
                    Tbl.AddStr();
                    Clear_Area.ClearCurRow(BKI.INQ_CAPTION);
                    //ProgressBar.Use(1, i);
                    UseProgress (i);
                    i = i + 1;
                end;
                Tbl.EndTable();
                RemProgress (ChildArray1.length);

            else
                NoInfo(Tmpl, BKI.INQ_INFO_AREA, BKI.INQ_NO_INFO, "Запросы");
            end;

            Tmpl.SetCopyByRows(FALSE);

            //ProgressBar.Use(0, Progress = Progress + 1);
            UseProgress (Progress = Progress + 1);
        end;
        
        
        RemProgress (BlocksNum);
        // Сохранение и вывод отчета
        PathFile = Tmpl.m_WorkDir;
        Tmpl.m_WorkDir = "";
        var flag = true;
        if ({GROUP_MODE} == true)
           flag = false;
        end;
        ReplaceMacro ( "isStandalone", "BKI_isStandalone" );
        Tmpl.SaveAsTemplate(FNameReport,flag);
        ReplaceMacro ( "isStandalone", NULL );
        ReportFileName = Tmpl.ReportFileName_xls;
        Tmpl.m_WorkDir = PathFile;      
        
        OnError(er)
            InitErrorValues("Ошибка! \n" + er.Message);
    end;

    macro GetReportName()
      return ReportFileName;
    end;

    macro CheckXmlType() : bool

        if(CurrentNode = XML_Obj.GetDoc().firstChild.selectSingleNode("//" + BKI.TAG_ERR))
            InitErrorValues();
            return FALSE;
        elif(CurrentNode = XML_Obj.GetDoc().firstChild.selectSingleNode("//" + BKI.TAG_REPORT))
            return TRUE;
        else
            InitErrorValues("Нарушена структура XML-файла");
        end;

    end;

   Constructor(_ReportType);

end;

// --- EOF -----------------------------------------------------------------------
