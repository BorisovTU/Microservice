/*
$Name:             batens.mac
$Module:           Šà¥¤¨â®¢ ­¨¥
$Description:      Œ áá®¢®¥ ¯à¨­ïâ¨¥/á¯¨á ­¨¥ ¤®£®¢®à®¢ ®¡¥á¯¥ç¥­¨ï
*/
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

    RS-Loans 5.10

    Šà¥¤¨â®¢ ­¨¥

    Œ áá®¢®¥ ¯à¨­ïâ¨¥/á¯¨á ­¨¥ ¤®£®¢®à®¢ ®¡¥á¯¥ç¥­¨ï
                    Orlov V.          15.11.2002

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/

import LoansFind;
import "total.mac";


macro ReportPrintHeader(OperDate, OperName)
/*
Ž¡à ¡®â ­
ˆáª«îç¥­ ¯®«ì§®¢ â¥«¥¬
Žè¨¡ª  ¢ë¯®«­¥­¨ï
  */

[     ‚¨¤ ®¯¥à æ¨¨: ##################################################](OperName);
[     „ â  ®¯¥à æ¨¨: ##########](OperDate);
[ ];
[ ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·];
[ º ü ¤®£. ®¡¥á¯¥ç¥­¨ï ³                ü Š„               ³  ®àãç¨â¥«ì/§ «®£®¤ â¥«ì    ³   „ â    ³     ‘ã¬¬       ³‚ «îâ ³             ‘â âãá ¢ë¯®«­¥­¨ï ®¯¥à æ¨¨                    º];
[ ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶];
    RETURN 0;
END;/*ReportPrintHeader*/

MACRO ReportPrintLine(EnsContrRec, Res, Msg)
   CONST ln = 59; // „«¨­  áâà®ª¨
   VAR pos = ln;  // •¨âà®áâ¨, çâ® ¡ë ¢¥¢¥áâ¨ ¬­®£®áâà®ç­ë© â¥ªáâ á ¯¥à¥­®á ¬¨

   var rs  = null;
   var rs1 = null;
   var CredNum: string;
   var CredID : integer;
   var    strStatus = "";
   record „®£Ž¡¥á¯    ("enscontr.dbt" );   /* â¥ªãé¨© ¡ãä¥à ¤®£®¢®à  ®¡¥á¯¥ç¥­¨ï */
   record Šà¥¤„®£     ("credit_c.dbt" );   /* â¥ªãé¨© ¡ãä¥à ªà¥¤¨â­®£® ¤®£®¢®à  */

   SetBuff(„®£Ž¡¥á¯, EnsContrRec);
   
   IF (Res == 0)
      strStatus = "“¤ ç­® § ¢¥àè¥­®";
   ELIF (Res == 1)
      strStatus = "Žè¨¡ª  ¢ë¯®«­¥­¨ï";
   ELIF (Res == 2)
      strStatus = "ˆáª«îç¥­ ¯®«ì§®¢ â¥«¥¬";
   ELIF (Res == 3)
      strStatus = Msg;
   END;
 
   rs = CRSDCommand("SELECT T_CREDITNUMBER_REF FROM DENS_CRD_DBT WHERE T_ENSCONTRACTID_REF = ?", 
                    "p1", „®£Ž¡¥á¯.EnsContractID, 
                   V_GENOBJ);
   IF ((rs != null) and rs.MoveNext)
      CredID = rs.Value(0, null, V_INTEGER);
      IF (rs.MoveNext) 
         CredNum = "¥áª®«ìª®";
      ELSE
         rs1 = CRSDCommand("SELECT T_USCREDITNUMBER FROM DCREDIT_C_DBT WHERE T_CREDITNUMBER = ?",
                           "p1", CredID,
                          V_GENOBJ);  
          
         IF ((rs1 != null) and rs1.MoveNext)          
            CredNum = rs1.Value(0, null, V_STRING);
         ELSE
            CredNum = "¥ ­ ©¤¥­"
         END;
      END;
   ELSE
      CredNum = "¥â";
   END;

   // ‚ áâà®ª¥ ¥áâì ¯¥à¥­®áë (/n) ?
   // …á«¨ ¥áâì, â® ¢ë¢®¤¨¬ ¤® ¯¥à¥­®á  áâà®ª¨
   IF (Index(strStatus, StrFor(13)) > 0)
      pos = MIN(Index(strStatus, StrFor(13)) - 1, ln);
   END;

[ º####################³###################################³#############################³##########³################³######³###########################################################º]
(  „®£Ž¡¥á¯.EnsContractNumber,
   CredNum,
   FindFullClient(„®£Ž¡¥á¯.EnsContractPersonID_Ref), 
   „®£Ž¡¥á¯.EnsContractFirstDate,
   „®£Ž¡¥á¯.EnsContractSum,
   FindExtCode(„®£Ž¡¥á¯.EnsContractCur),
   SubStr(strStatus, 1, pos));

   // …á«¨ ¢ áâà®ª¥ ¥áâì á¨¬¢®«ë ¯¥à¥­®á , ã¡¥à¥¬ ¨å
   IF ((Index(strStatus, StrFor(13)) > 0) AND (Index(strStatus, StrFor(13)) < ln))
      pos = pos + 1;
   END;

   // …á«¨ ¢¥áì â¥ªáâ ­¥ ã¬¥áâ¨«áï
   WHILE (StrLen(SubStr(strStatus, pos + 1)) > 0)
      strStatus = SubStr(strStatus, pos + 1); // Ž¡à¥§ ¥¬ áâà®ªã

      // ˆé¥¬ ¯¥à¥­®áë
      IF (Index(strStatus, StrFor(13)) > 0)
         pos = MIN(Index(strStatus, StrFor(13)) - 1, ln);
      ELSE
         pos = ln;
      END;

[ º####################³###################################³#############################³##########³################³######³###########################################################º]
     ("",
      "",
      "", 
      "",
      "",
      "",
      SubStr(strStatus, 1, pos));

      // …á«¨ ¢ áâà®ª¥ ¥áâì á¨¬¢®«ë ¯¥à¥­®á , ã¡¥à¥¬ ¨å
      IF ((Index(strStatus, StrFor(13)) > 0) AND (Index(strStatus, StrFor(13)) < ln))
         pos = pos + 1;
      END;
   END;

   RETURN 0;
END;/*ReportPrintLine*/

macro ReportPrintFooter()
[ ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½];
END;


MACRO FillFile(CurCode, EnsSysType, UserTypeCrd, Skip, EnsOnliCloseCredit)
   VAR RSDcmd = RsdCommand (RslDefCon, "BEGIN LoansFillPayment.FillEnsContrForClose (?,?,?,?,?); END;");

   RSDcmd.addParam ("CurCode",     RSDBP_IN); RSDcmd.value ("CurCode")     = CurCode;
   RSDcmd.addParam ("EnsSysType",  RSDBP_IN); RSDcmd.value ("EnsSysType")  = EnsSysType;
   RSDcmd.addParam ("UserTypeCrd", RSDBP_IN); RSDcmd.value ("UserTypeCrd") = UserTypeCrd;
   RSDcmd.addParam ("Skip",        RSDBP_IN); RSDcmd.value ("Skip")        = Skip;
   RSDcmd.addParam ("EnsOnliCloseCredit", RSDBP_IN); RSDcmd.value ("EnsOnliCloseCredit") = EnsOnliCloseCredit;

   RSDcmd.execute();
END;

// ”ã­ªæ¨ï ¯à®¢¥àª¨, ¯à®å®¤¨â ®¯¥à æ¨ï ¨«¨ ­¥â
// ‚®§¢à é ¥â ­®¬¥à ®¯¥à æ¨¨. …á«¨ 0, â® ®¯¥à æ¨ï ­¥ ¢ë¯®«­ï¥âáï
MACRO CheckOperation(EnsContrRec, Crd_kind, CreditNumber, CreditTypeID, SystTypeOp, TypeOperNumber, Choice, Protocol)
   RECORD  „®£Ž¡¥á¯ ("enscontr.dbt" );
   SetBuff(„®£Ž¡¥á¯, EnsContrRec);

   VAR PR = "";
   IF (Protocol == 88)
      PR = "X";
   END;

   LnSQLExec("DELETE FROM DLNSERROR_TMP");

   VAR RSDcmd = RsdCommand (RslDefCon, "BEGIN ? := LoansOperation.GetAndCheckDefaultOperation(?, ?, ?, ?, ?, ?, ?); END;");

   RSDcmd.addParam("RetVal", RSDBP_RETVAL, V_INTEGER);

   RSDcmd.addParam("ObjectTypeID",   RSDBP_IN); RSDcmd.Value("ObjectTypeID")   = Crd_kind;
   RSDcmd.addParam("ObjectNumber",   RSDBP_IN); RSDcmd.Value("ObjectNumber")   = CreditNumber;
   RSDcmd.addParam("CreditTypeID",   RSDBP_IN); RSDcmd.Value("CreditTypeID")   = CreditTypeID; 
   RSDcmd.addParam("SysOperation",   RSDBP_IN); RSDcmd.Value("SysOperation")   = SystTypeOp;
   RSDcmd.addParam("TypeOperNumber", RSDBP_IN); RSDcmd.Value("TypeOperNumber") = TypeOperNumber;
   RSDcmd.addParam("Choice",         RSDBP_IN); RSDcmd.Value("Choice")         = Choice;
   RSDcmd.addParam("Protocol",       RSDBP_IN); RSDcmd.Value("Protocol")       = PR;

   RSDcmd.Execute();

   // …á«¨ áâ®¨â - ¢ë¢®¤¨âì ¢ ¯à®â®ª®«, ¢ë¢¥¤¥¬ çâ® ­¨¡ã¤ì.
   VAR RS = CRSDCommand("SELECT TRIM(T_ERROR) FROM DLNSERROR_TMP", V_GENOBJ);
   WHILE (RS.MoveNext)
      ReportPrintLine(EnsContrRec, 3, RS.Value(0));
   END;

   LnSQLExec("DELETE FROM DLNSERROR_TMP");

   RETURN RSDcmd.Value("RetVal");
END;