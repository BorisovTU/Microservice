/*
$Name:             dogovcrd.mac
$Module:           Кредитование
$Description:      Соглашение об овердрафтном кредите
*/
import ActiveX, total, replib, global, dlwreps, replib;;

private record cur_credit ("credit_c.dbt", "loans.def");
private record credit_c  ("credit_c.dbt", "loans.def");
private file   currency  ("fininstr.dbt", "bank.def");

private const  TemplateName = "dogovcrd.dot";

macro RunReport(CreditBuf)

      const ДолжностьПредставителяЗаемщика = 77,
            ЦельПолученияКредита = 79;

      var ФИО, Sum, ExtCurCode = $0;

      SetBuff(cur_credit, CreditBuf);

      if (not depclnt.GetRecord(cur_credit.ClientID_Ref))
          RunError ("Не найден заещик в справочнике клиентов");
      end;                             
      if (NOT cur_credit.GeneralAgreement_Ref)
          RunError ("Соглашение об овердрафтном кредите формируется| только по договорам по ген. соглашению!");
      end;
      
      if (NOT Loans_FindCrdContract(cur_credit.GeneralAgreement_Ref, credit_c))
          RunError ("Не найдено ген. соглашение об овердрафтном кредите!");
      end;

      /* Код валюты 810 - рубли, 840 - USD и т.д.*/
      currency.FIID = cur_credit.CurCode;         
      if(getEQ(currency))                       
          ExtCurCode = int(currency.ISO_Number);
      end; 

      ФИО = depclnt.ConvertFIOFull();

      SetOutput (GetTxtFileName("dogovcrd_rep"));
      
      println(TemplateName); //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа
      
      /* № договора */
      [~CrdNum];
      println (cur_credit.UsCreditNumber);
      /*Название банка*/
      [~NameBank];
      println (CONST_NAMEBANK);
      /* Дата начала договора */
      [~RegDate];
      println (DateToStringFull (cur_credit.RegDate));
      /* ФИО заёмщика */
      [~FIO];
      println (ФИО);
      /* № ГС */
      [~AgrNum];
      println (credit_c.UsCreditNumber);
      /* Дата начала ГС */
      [~AgrRegDate];
      println (DateToStringFull (credit_c.RegDate));
      /*Сумма лимита*/
      [~StrSum];
      Sum = GetLimRest(cur_credit.CreditNumber, TDR_LIMDUTY, {curdate});
      println (MoneyToMString(Sum, ExtCurCode));
      /*Счет клиента*/
      [~AccountKarta];
      println (cur_credit.AccountKarta);
      /* Дата окончания кредитного договора */
      [~ReturnDate];
      println (DateToStringFull (cur_credit.ReturnDate));
      /* % ставка по основному долгу */
      [~Percent];
      println (NumAndStr(Loans_FindRateVal(cur_credit.Crd_kind, cur_credit.CreditNumber, TRU_CRD, cur_credit.ReturnDate), 1));
      /* Ссудный счёт */
      [~Account];
      println (НомерСчета (cur_credit.CreditNumber, cur_credit.CurCode, CRD_ACC));
      /*Название банка*/
      [~NameBank2];
      println (CONST_NAMEBANK);
      /* Полное имя заемщика */
      [~FullName];
      println(depclnt.Name);

      /* Юридический адрес */
      [~Address];
      println ( CONST_POSTADDR );

      /* Серия паспорта и номер */
      [~Passport];
      if (trim(DepClnt.PaperSeries) != "")
         println("Серия: " + trim(DepClnt.PaperSeries) + " №"+ trim(DepClnt.PaperNumber));
      else
         println("№"+ trim(DepClnt.PaperNumber));
      end;
      /* Кем и когда выдан паспорт берется из формы клиента */
      [~DatePassport];
      println(depclnt.PaperIssuer + " " + depclnt.PaperIssuedDate);


      /* Адрес заемщика */
      [~AddressZaem];
      println (depclnt.Address);
      /* Адрес проживания заёмщика */
      [~PAddressZaem];
      if (trim(DepClnt.AddressF) != "")
         println (DepClnt.AddressF);
      else /* Адрес проживания не указан - подставляем адрес прописки */
         println (DepClnt.Address);
      end;

      /* Реквизиты банка */
      [~INN];
      println ( CONST_INN );
      [~CorrAcc];
      println ( CONST_CORRACC );
      [~BIC];
      println ( CONST_BIK );

      /* Телефоны заемщика */
      [~Phone];
      println (depclnt.PhoneNumber);
      [~Fax];
      println (depclnt.Fax);

      /* Кредитор: Фамилия И. О. */
      [~Creditor];
      println (GetShortFIO(GetStrPart(GetUsFieldValue(cur_credit.Crd_kind, cur_credit.CreditNumber, ФИОКредитора, cur_credit.RegDate),1)));

      /* Фамилия И.О. представителя заемщика*/
      [~FioPredst];
      println (GetUsFieldValue(cur_credit.Crd_kind, cur_credit.CreditNumber, ДолжностьПредставителяЗаемщика));


   var tag = SetOutput (NULL, false);
   return tag;

   onError(axerr)
      SetOutput(NULL, false);
      RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Печатная форма сформирована.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;