/*
$Name:             requestNBKI.mac                                              
$Module:           Кредитование
$Description:      Класс для отправки запросов в НБКИ
*/
import "total.mac", "CRtReportXML.mac" ,"bkiSendBase.mac"/*, "CommonRep.mac", "NBKIconst.mac"*/,"BKI_XmlResponceReportMaker.mac";

private const  ErrorStat      = 9999;  // код ошибки
private const  ErrorCriptoProCSR = -2147467259;  // Не установлен КриптоПро CSP версии не ниже 4.0!
private const  ErrorCriptoArm = 429;  // Не установлен КриптоArm
private const  ErrorCriptoArm_FNS = 999;    //не задана настройка FNS
private const  ZERO_DATE      = date(0,0,0);
private VAR {GROUP_MODE};


// Номера документов субъекта
const DOC_PASSPORT          =   0, // Паспорт гражданина  РФ
      DOC_OFFICERCERT       =   1, // Удостоверение офицера
      DOC_MILCARD           =   2, // Военный билет
      DOC_NAVYPASS          =   3, // Паспорт министерства военно-морского флота
      DOC_BIRTH_CERTIFICATE =   4, // Свидетельство о рождении
      DOC_RESPERMIT         =   5, // Вид на жительство
      DOC_RFFORPASS         =   6, // Загранпаспорт гражданина РФ
      DOC_USSRPASS          =   7, // Паспорт гражданина СССР
      DOC_USSRFORPASS       =   8, // Загранпаспорт гражданина СССР     
     
      DOC_DIPLPASS          =  10, // Дипломатический паспорт гражданина РФ
      DOC_FORPASS           =  11, // Паспорт иностранного гражданина
      
      DOC_REFUGEE_CERT      =  13, // Удостоверение беженца      
      DOC_INTCERT           =  14, // Временное удостоверение гражданина РФ
      DOC_SAILORPASS        =  15, // Паспорт моряка
      DOC_RESOFFCERT        =  16, // Удостоверение офицера в запасе
      DOC_OTHDOCMVD         =  17, // Прочие документы, выдаваемые Министерством Внутренних Дел
      DOC_INTPERMIT         =  19; // Разрешение на временное проживание лица без гражданства
      //DOC_DRIVLIC           =  25, // Водительское удостоверение
      
      //DOC_NUMRETINSUR       = 105, // Номер обязательного пенсионного страхования

      //DOC_KISUBCODE         = 162, // Кода субъекта КИ
      //DOC_ID                = 999, // CIF. внутренний номер идентификационного файла клиента
      //DOC_NOSNILS           = 998, // Признак отсутствия СНИЛС
      //DOC_INN               = 100; // ИНН
      //DOC_KPP               = 101, // КПП
      //DOC_OGRN              = 102, // ОГРН (для ЮЛ)
      //DOC_REGNUM            = 102, // ОГРН (для ФЛ)
      //DOC_SNILS             = 106, // Страховое свидетельство
      //DOC_DEATH_CERTIFICATE = 109, // Свидетельство о смерти                    
        
      
      
      
      /*Для номеров ниже, соответствие должно быть задано пользователем*/
     // DOC_FOREIGN_OGRN      = 102;  // Иностранный государственный регистрационный номер, присвоенный уполномоченными органами страны происхождения
     // DOC_FOREIGN_INN       = 100;  // Иностранный идентификационный номер налогоплательщика, присвоенный уполномоченными органами страны происхождения

 // перевод кода документа RS-Bank в код документа БКИ
MACRO FindDocCodeKI(code_in):string
    VAR code_out:string = "";
    IF (code_in == DOC_USSRPASS) // Паспорт гражданина СССР
        code_out = "01";
    ELIF (code_in == DOC_USSRFORPASS) // Загранпаспорт гражданина СССР
        code_out = "02";
    ELIF (code_in == DOC_BIRTH_CERTIFICATE) // Свидетельство о рождении
        code_out = "03";
    ELIF (code_in == DOC_OFFICERCERT) // Удостоверение офицера
        code_out = "04";
    ELIF (code_in == DOC_NAVYPASS) // Паспорт министерства военно-морского флота
        code_out = "06";
    ELIF (code_in == DOC_MILCARD) // Военный билет
        code_out = "07";
    ELIF (code_in == DOC_DIPLPASS) // Дипломатический паспорт гражданина РФ
        code_out = "09";
    ELIF (code_in == DOC_FORPASS) // Паспорт иностранного гражданина
        code_out = "10";
    ELIF (code_in == DOC_RESPERMIT) // Вид на жительство
        code_out = "12";
    ELIF (code_in == DOC_REFUGEE_CERT) // Удостоверение беженца
        code_out = "13";
    ELIF (code_in == DOC_INTCERT) // Временное удостоверение гражданина РФ
        code_out = "14";
    ELIF (code_in == DOC_INTPERMIT) // Разрешение на временное проживание лица без гражданства 
        code_out = "15";
    ELIF (code_in == DOC_PASSPORT) // Паспорт гражданина РФ
        code_out = "21";
    ELIF (code_in == DOC_RFFORPASS) // Загранпаспорт гражданина РФ
        code_out = "22";
    ELIF (code_in == DOC_SAILORPASS) // Паспорт моряка
        code_out = "26";
    ELIF (code_in == DOC_RESOFFCERT) // Удостоверение офицера в запасе
        code_out = "27";
   /* ELIF (code_in == DOC_DRIVLIC) // Водительское удостоверение
        code_out = "31";
    ELIF ( (code_in == DOC_NUMRETINSUR) or ( code_in == DOC_SNILS ) ) // Номер обязательного пенсионного страхования
        code_out = "32";
    ELIF ((code_in == DOC_REGNUM) and Физлицо()) // Регистрационный номер предпринимателя
        code_out = "33";
    ELIF ((code_in == DOC_OGRN) and Юрлицо() and Резидент()) // ОГРН
        code_out = "34";
    ELIF (code_in == DOC_FOREIGN_OGRN) // Иностранный государственный регистрационный номер, присвоенный уполномоченными органами страны происхождения
        code_out = "35";
    ELIF ((code_in == DOC_INN ) and (Резидент() OR Физлицо())) // Номер налогоплательщика (ИНН)
        code_out = "81";
    ELIF (code_in == DOC_FOREIGN_INN) // Иностранный идентификационный номер налогоплательщика, присвоенный уполномоченными органами страны происхождения
        code_out = "82";
    ELIF (code_in == DOC_OTHDOCMVD) // Прочие документы, выдаваемые Министерством Внутренних Дел
        code_out = "91";
    ELIF (code_in == DOC_KISUBCODE) // Кода субъекта КИ
        code_out = "98";
    ELIF (code_in == DOC_NOSNILS) // Кода субъекта КИ
        code_out = "97";
    ELIF (code_in == DOC_ID)
        code_out = "99"*/
    END;
    RETURN code_out;
END;     

MACRO FindDocName(code_in):string
    VAR code_out:string = "";
    IF (code_in == DOC_USSRPASS) // Паспорт гражданина СССР
        code_out = "Паспорт гражданина СССР";
    ELIF (code_in == DOC_USSRFORPASS) // Загранпаспорт гражданина СССР
        code_out = "Загранпаспорт гражданина СССР";
    ELIF (code_in == DOC_BIRTH_CERTIFICATE) // Свидетельство о рождении
        code_out = "Свидетельство о рождении";
    ELIF (code_in == DOC_OFFICERCERT) // Удостоверение офицера
        code_out = "Удостоверение офицера";
    ELIF (code_in == DOC_NAVYPASS) // Паспорт министерства военно-морского флота
        code_out = "Паспорт министерства военно-морского флота";
    ELIF (code_in == DOC_MILCARD) // Военный билет
        code_out = "Военный билет";
    ELIF (code_in == DOC_DIPLPASS) // Дипломатический паспорт гражданина РФ
        code_out = "Дипломатический паспорт гражданина РФ";
    ELIF (code_in == DOC_FORPASS) // Паспорт иностранного гражданина
        code_out = "Паспорт иностранного гражданина";
    ELIF (code_in == DOC_RESPERMIT) // Вид на жительство
        code_out = "Вид на жительство";
    ELIF (code_in == DOC_REFUGEE_CERT) // Удостоверение беженца
        code_out = "Удостоверение беженца";
    ELIF (code_in == DOC_INTCERT) // Временное удостоверение гражданина РФ
        code_out = "Временное удостоверение гражданина РФ";
    ELIF (code_in == DOC_INTPERMIT) // Разрешение на временное проживание лица без гражданства 
        code_out = "Разрешение на временное проживание лица без гражданства";
    ELIF (code_in == DOC_PASSPORT) // Паспорт гражданина РФ
        code_out = "Паспорт гражданина РФ";
    ELIF (code_in == DOC_RFFORPASS) // Загранпаспорт гражданина РФ
        code_out = "Загранпаспорт гражданина РФ";
    ELIF (code_in == DOC_SAILORPASS) // Паспорт моряка
        code_out = "Паспорт моряка";
    ELIF (code_in == DOC_RESOFFCERT) // Удостоверение офицера в запасе
        code_out = "Удостоверение офицера в запасе";
   /* ELIF (code_in == DOC_DRIVLIC) // Водительское удостоверение
        code_out = "31";
    ELIF ( (code_in == DOC_NUMRETINSUR) or ( code_in == DOC_SNILS ) ) // Номер обязательного пенсионного страхования
        code_out = "32";
    ELIF ((code_in == DOC_REGNUM) and Физлицо()) // Регистрационный номер предпринимателя
        code_out = "33";
    ELIF ((code_in == DOC_OGRN) and Юрлицо() and Резидент()) // ОГРН
        code_out = "34";
    ELIF (code_in == DOC_FOREIGN_OGRN) // Иностранный государственный регистрационный номер, присвоенный уполномоченными органами страны происхождения
        code_out = "35";
    ELIF ((code_in == DOC_INN ) and (Резидент() OR Физлицо())) // Номер налогоплательщика (ИНН)
        code_out = "81";
    ELIF (code_in == DOC_FOREIGN_INN) // Иностранный идентификационный номер налогоплательщика, присвоенный уполномоченными органами страны происхождения
        code_out = "82";
    ELIF (code_in == DOC_OTHDOCMVD) // Прочие документы, выдаваемые Министерством Внутренних Дел
        code_out = "91";
    ELIF (code_in == DOC_KISUBCODE) // Кода субъекта КИ
        code_out = "98";
    ELIF (code_in == DOC_NOSNILS) // Кода субъекта КИ
        code_out = "97";
    ELIF (code_in == DOC_ID)
        code_out = "99"*/
    END;
    RETURN code_out;
END;       


//---------------------------------------------------------------------------------------
// Печать Протокола ошибок
//---------------------------------------------------------------------------------------
MACRO PrintErrProtocol( fnamePrtcl)
   file PrtclFile() txt;
   IF ( not ExistFile( fnamePrtcl ) )
      LoansError("Не найден протокол " + fnamePrtcl );
   ELSE
      IF ( open( PrtclFile, fnamePrtcl ) )
         viewFile( PrtclFile );
         close( PrtclFile );
      END;
   END;
END;

//---------------------------------------------------------------------------------------
// Печать отчета
//---------------------------------------------------------------------------------------
MACRO PrintXLSReport( fnameRep)
   IF ( not ExistFile( fnameRep ) )
      LoansError("Не найден отчет " + fnameRep );
   ELSE
      VAR fullPath:String = fnameRep;//MakeFullPath(fnameRep);
      VAR ObjDoc = CDAOMSExcel();
      ObjDoc.Open( fullPath );
      ObjDoc.Show(true);
   END;
END;

// Класс для подготовки запроса и обработки ответа от НБКИ. Базовый класс CSendMessage.
class (CSendMessage) CSendMessage_TMP( Parm_ptr, NeedRewrite_,TypeQueryName,Parm_ptr_BKI, NameRepGroup)

   //-----------------------------------------------------------------------
   // Конструктор
   //-----------------------------------------------------------------------
   RECORD Parm( "Bki_Req.dbt", "loans.def" );
   VAR Parm_rec = TRecHandler("Bki_Req.dbt", "loans.def");
   setbuff( Parm, Parm_ptr );
   copy( Parm_rec, Parm );

   RECORD Parm_BKI( "lbki.dbt", "loans.def" );
   VAR Parm_rec_BKI = TRecHandler("lbki.dbt", "loans.def");
   setbuff( Parm_BKI, Parm_ptr_BKI );
   copy( Parm_rec_BKI, Parm_BKI ); 

   VAR TypeMsg     = TypeQueryName;  // Тип сообщения
   VAR NeedRewrite = NeedRewrite_;          // Признак необходимости перезаписи xml-запроса

   VAR outXml      = CRtReportXML();        // xml-объект для исходящего xml-сообщения

   initCSendMessage();                      // Конструктор базового класса
   m_NameRepGroup = NameRepGroup;   //Имя файла группового отчета
   //-----------------------------------------------------------------------
   // Пользовательские функции формирования xml сообщения
   //-----------------------------------------------------------------------
   MACRO getDate( SrcDate)
      VAR dd, mm, yyyy;
      dateSplit( SrcDate, dd, mm, yyyy );
      RETURN  String( yyyy:o:4 ) + "-" + String( mm:o:2 ) + "-" + String( dd:o:2 );
   END;

   //Формирование сегмента адресса
   MACRO segmentAddres(node, req)
      VAR attr;
      node = req.appendChild( outXML.doc.createNode(1, "AddressReq", "") );
      attr = node.appendChild( outXML.doc.createNode(1, "district", "") );    attr.text = Parm_rec.rec.district1;
      attr = node.appendChild( outXML.doc.createNode(1, "houseNumber", "") ); attr.text = Parm_rec.rec.houseNumber1;
      attr = node.appendChild( outXML.doc.createNode(1, "street", "") );      attr.text = Parm_rec.rec.street1;
      attr = node.appendChild( outXML.doc.createNode(1, "block", "") );       attr.text = Parm_rec.rec.block1;
      attr = node.appendChild( outXML.doc.createNode(1, "building", "") );    attr.text = Parm_rec.rec.building1;
      attr = node.appendChild( outXML.doc.createNode(1, "apartment", "") );   attr.text = Parm_rec.rec.apartment1;
      attr = node.appendChild( outXML.doc.createNode(1, "city", "") );        attr.text = Parm_rec.rec.city1;
      attr = node.appendChild( outXML.doc.createNode(1, "prov", "") );        attr.text = Parm_rec.rec.prov1;
      attr = node.appendChild( outXML.doc.createNode(1, "postal", "") );      attr.text = Parm_rec.rec.postal1;
      attr = node.appendChild( outXML.doc.createNode(1, "countryCode", "") ); attr.text = Parm_rec.rec.countryCode1;
      attr = node.appendChild( outXML.doc.createNode(1, "addressType", "") ); attr.text = Parm_rec.rec.addressType1;
      attr = node.appendChild( outXML.doc.createNode(1, "streetType", "") );  attr.text = Parm_rec.rec.streetType1;
      
      node = req.appendChild( outXML.doc.createNode(1, "AddressReq", "") );
      attr = node.appendChild( outXML.doc.createNode(1, "district", "") );    attr.text = Parm_rec.rec.district2;
      attr = node.appendChild( outXML.doc.createNode(1, "houseNumber", "") ); attr.text = Parm_rec.rec.houseNumber2;
      attr = node.appendChild( outXML.doc.createNode(1, "street", "") );      attr.text = Parm_rec.rec.street2;
      attr = node.appendChild( outXML.doc.createNode(1, "block", "") );       attr.text = Parm_rec.rec.block2;
      attr = node.appendChild( outXML.doc.createNode(1, "building", "") );    attr.text = Parm_rec.rec.building2;
      attr = node.appendChild( outXML.doc.createNode(1, "apartment", "") );   attr.text = Parm_rec.rec.apartment2;
      attr = node.appendChild( outXML.doc.createNode(1, "city", "") );        attr.text = Parm_rec.rec.city2;
      attr = node.appendChild( outXML.doc.createNode(1, "prov", "") );        attr.text = Parm_rec.rec.prov2;
      attr = node.appendChild( outXML.doc.createNode(1, "postal", "") );      attr.text = Parm_rec.rec.postal2;
      attr = node.appendChild( outXML.doc.createNode(1, "countryCode", "") ); attr.text = Parm_rec.rec.countryCode2;
      attr = node.appendChild( outXML.doc.createNode(1, "addressType", "") ); attr.text = Parm_rec.rec.addressType2;
      attr = node.appendChild( outXML.doc.createNode(1, "streetType", "") );  attr.text = Parm_rec.rec.streetType2;       
   END;  

   // заполнение документов
   MACRO segmentIdReq(node, req)
      VAR attr;  
      IF ( TypeMsg == "BHST" )
         node = req.appendChild( outXML.doc.createNode(1, "IdReq", "") );
         attr = node.appendChild( outXML.doc.createNode(1, "idNum", "") ); attr.text           = Parm_rec.rec.idNum1;
         attr = node.appendChild( outXML.doc.createNode(1, "idType", "") ); attr.text          = Parm_rec.rec.idType1;
         attr = node.appendChild( outXML.doc.createNode(1, "issueCountry", "") ); attr.text    = Parm_rec.rec.issueCountry1;
         IF ( Parm_rec.rec.issueDate1 != ZERO_DATE)
           attr = node.appendChild( outXML.doc.createNode(1, "issueDate", "") ); attr.text       = getDate(Parm_rec.rec.issueDate1);
         END;
         attr = node.appendChild( outXML.doc.createNode(1, "issueAuthority", "") ); attr.text  = Parm_rec.rec.issueAuthority1;
         node = req.appendChild( outXML.doc.createNode(1, "IdReq", "") );
         attr = node.appendChild( outXML.doc.createNode(1, "idNum", "") ); attr.text           = Parm_rec.rec.idNum2;
         attr = node.appendChild( outXML.doc.createNode(1, "idType", "") ); attr.text          = Parm_rec.rec.idType2;
         attr = node.appendChild( outXML.doc.createNode(1, "issueCountry", "") ); attr.text    = Parm_rec.rec.issueCountry2;
         IF ( Parm_rec.rec.issueDate2 != ZERO_DATE)
           attr = node.appendChild( outXML.doc.createNode(1, "issueDate", "") ); attr.text       = getDate( Parm_rec.rec.issueDate2 );
         END;
         attr = node.appendChild( outXML.doc.createNode(1, "issueAuthority", "") ); attr.text  = Parm_rec.rec.issueAuthority2;      
      ELSE
         node = req.appendChild( outXML.doc.createNode(1, "IdReq", "") );

         attr = node.appendChild( outXML.doc.createNode(1, "idNum", "") ); attr.text           = Parm_rec.rec.idNum;
         attr = node.appendChild( outXML.doc.createNode(1, "idType", "") ); attr.text          = FindDocCodeKI(Parm_rec.rec.idType);
         attr = node.appendChild( outXML.doc.createNode(1, "seriesNumber", "") ); attr.text    = Parm_rec.rec.seriesNumber;
         attr = node.appendChild( outXML.doc.createNode(1, "issueCountry", "") ); attr.text    = Parm_rec.rec.issueCountry;
         IF ( Parm_rec.rec.issueDate != ZERO_DATE)
           attr = node.appendChild( outXML.doc.createNode(1, "issueDate", "") ); attr.text       = getDate( Parm_rec.rec.issueDate );
         END;
         attr = node.appendChild( outXML.doc.createNode(1, "issueAuthority", "") ); attr.text  = Parm_rec.rec.issueAuthority;       

         node = req.appendChild( outXML.doc.createNode(1, "IdReq", "") );
         VAR  Type = 32;
         IF (Parm_rec.rec.SnilsRegNum == "")
          Type = 97; //СНИЛС не задан
         END;
         attr = node.appendChild( outXML.doc.createNode(1, "idNum", "") ); attr.text           = Parm_rec.rec.SnilsRegNum;
         attr = node.appendChild( outXML.doc.createNode(1, "idType", "") ); attr.text          = Type;      
      END; 
   END;

   //блок с данными, содержащими сведения о кредитном отчете, данные которого запрашиваются в НБКИ  
   MACRO segmentInquiryReq(node, req)
      VAR attr, InquiryReq;
      VAR Flag = "";
      InquiryReq = req.appendChild( outXML.doc.createNode(1, "InquiryReq", "") );
      node = InquiryReq.appendChild( outXML.doc.createNode(1, "ConsentReq", "") );
      IF (Parm_rec.rec.consentFlag == "X")
         Flag = "Y";
      ELSE 
         Flag = "I";
      END;

      attr = node.appendChild( outXML.doc.createNode(1, "consentFlag", "") ); attr.text         = Flag;       
      IF ( Parm_rec.rec.consentDate != ZERO_DATE)
         attr = node.appendChild( outXML.doc.createNode(1, "consentDate", "") ); attr.text         = getDate(Parm_rec.rec.consentDate);
      END;
      
      IF ( Parm_rec.rec.consentExpireDate != ZERO_DATE)
         attr = node.appendChild( outXML.doc.createNode(1, "consentExpireDate", "") ); attr.text   = getDate(Parm_rec.rec.consentExpireDate);
      END;
      attr = node.appendChild( outXML.doc.createNode(1, "consentPurpose", "") ); attr.text      = Parm_rec.rec.consentPurpose;
      attr = node.appendChild( outXML.doc.createNode(1, "otherConsentPurpose", "") ); attr.text = Parm_rec.rec.otherConsentPurpose;
      attr = node.appendChild( outXML.doc.createNode(1, "reportUser", "") ); attr.text          = Parm_rec.rec.reportUser;
      
      IF (Parm_rec.rec.liability == "X")
         Flag = "Y";
      ELSE 
         Flag = "I";
      END;
        
      attr = node.appendChild( outXML.doc.createNode(1, "liability", "") ); attr.text           = Flag;
      node = InquiryReq.appendChild( outXML.doc.createNode(1, "inqPurpose", "") ); node.text     = Parm_rec.rec.inqPurpose;
      node = InquiryReq.appendChild( outXML.doc.createNode(1, "inqAmount", "") ); node.text      = MoneyToString(Parm_rec.rec.inqAmount, 0);
      node = InquiryReq.appendChild( outXML.doc.createNode(1, "currencyCode", "") ); node.text   = FindShortName(Parm_rec.rec.CurrCode);//Parm_rec.rec.currencyCode;
   END;  

   //блок с данными, содержащими сведения о кредитном отчете, данные которого запрашиваются в НБКИ  
   MACRO segmentPersonReq(node, req)
      VAR attr;
      node = req.appendChild( outXML.doc.createNode(1, "PersonReq", "") );
      attr = node.appendChild( outXML.doc.createNode(1, "name1", "") ); attr.text         = Parm_rec.rec.name1;
      attr = node.appendChild( outXML.doc.createNode(1, "first", "") ); attr.text         = Parm_rec.rec.first;
      attr = node.appendChild( outXML.doc.createNode(1, "paternal", "") ); attr.text      = Parm_rec.rec.paternal;
      attr = node.appendChild( outXML.doc.createNode(1, "gender", "") ); attr.text        = Parm_rec.rec.gender;
      IF ( Parm_rec.rec.birthDt != ZERO_DATE)
         attr = node.appendChild( outXML.doc.createNode(1, "birthDt", "") ); attr.text       = getDate( Parm_rec.rec.birthDt );
      END;
      attr = node.appendChild( outXML.doc.createNode(1, "placeOfBirth", "") ); attr.text  = Parm_rec.rec.placeOfBirth;    
   END;
   
   //блок с данными, содержащими сведения о субъекте - юридическом лице, по договору которого выполняется запрос кредитного отчета в НБКИ
   MACRO segmentRequestorReq(node, req)
      VAR attr;
      node = req.appendChild( outXML.doc.createNode(1, "RequestorReq", "") );
      attr = node.appendChild( outXML.doc.createNode(1, "MemberCode", "") ); attr.text = Parm_rec_BKI.rec.MemberCode;//Parm_rec.rec.MemberCode;
      attr = node.appendChild( outXML.doc.createNode(1, "UserID", "") ); attr.text     = Parm_rec_BKI.rec.SourceID;//Parm_rec.rec.UserID;
      attr = node.appendChild( outXML.doc.createNode(1, "Password", "") ); attr.text   = Parm_rec_BKI.rec.AuthorizationCode;//Parm_rec.rec.Password;    
   END;
  
   //блок с данными, содержащими другую справочную информацию о запросе кредитного отчета в НБКИ
   MACRO segmentRefReq(node, req)
      VAR attr;
      node = req.appendChild( outXML.doc.createNode(1, "RefReq", "") );
      attr = node.appendChild( outXML.doc.createNode(1, "product", "") ); attr.text       = TypeMsg;    
   END;  
  
   //заполнение общих блоков  
   MACRO segmentСommon(node, req)
      node = req.appendChild( outXML.doc.createNode(1, "IOType", "") ); node.text          = "B2B";
      node = req.appendChild( outXML.doc.createNode(1, "OutputFormat", "") ); node.text    = "XML";
      node = req.appendChild( outXML.doc.createNode(1, "lang", "") ); node.text            = "ru";   
   END;  
  
   MACRO PrepareXmlReq_CHIP()
      VAR node, attr, req,InquiryReq;
      outXml.doc.documentElement = outXml.doc.createNode(1, "product", "");
      node = outXml.doc.documentElement.appendChild( outXml.doc.createNode(1, "prequest", "") );
      req = node.appendChild( outXML.doc.createNode(1, "req", "") );    
      segmentAddres(node, req);
      segmentIdReq(node, req);
      segmentInquiryReq(node, req);
      segmentPersonReq(node, req);   
      segmentRequestorReq(node, req);       
      segmentRefReq(node, req);
      segmentСommon(node, req);
   END;

   MACRO PrepareXmlReq_CIPO()
      VAR node, attr, req,InquiryReq;
      outXml.doc.documentElement = outXml.doc.createNode(1, "product", "");
      node = outXml.doc.documentElement.appendChild( outXml.doc.createNode(1, "prequest", "") );
      req = node.appendChild( outXML.doc.createNode(1, "req", "") );
      segmentAddres(node, req);
      segmentIdReq(node, req);
      segmentInquiryReq(node, req);
      segmentPersonReq(node, req);
      segmentRequestorReq(node, req);
      segmentRefReq(node, req);
      segmentСommon(node, req);
   END;

   MACRO PrepareXmlReq_CHST()
      VAR node, attr, req,InquiryReq;
      outXml.doc.documentElement = outXml.doc.createNode(1, "product", "");
      node = outXml.doc.documentElement.appendChild( outXml.doc.createNode(1, "prequest", "") );
      req = node.appendChild( outXML.doc.createNode(1, "req", "") );
      segmentAddres(node, req);
      segmentIdReq(node, req);
      segmentInquiryReq(node, req);
      segmentPersonReq(node, req);
      segmentRequestorReq(node, req);
      segmentRefReq(node, req);
      segmentСommon(node, req);
   END;

   MACRO PrepareXmlReq_BHST()
      VAR node, attr, req,InquiryReq;
      outXml.doc.documentElement = outXml.doc.createNode(1, "product", "");
      node = outXml.doc.documentElement.appendChild( outXml.doc.createNode(1, "prequest", "") );
      req = node.appendChild( outXML.doc.createNode(1, "req", "") );
      segmentAddres(node, req);
      segmentIdReq(node, req);
      segmentInquiryReq(node, req);
      node = req.appendChild( outXML.doc.createNode(1, "BusinessReq", "") );
      attr = node.appendChild( outXML.doc.createNode(1, "businessName", "") ); attr.text = Parm_rec.rec.name1;
      segmentRequestorReq(node, req);
      segmentRefReq(node, req);
      node = req.appendChild( outXML.doc.createNode(1, "requestDateTime", "") ); node.text = getDate( date());
      segmentСommon(node, req);
   END;

   //-----------------------------------------------------------------------
   // Пользовательские функции обработки xml ответа
   //-----------------------------------------------------------------------
   MACRO ParseXmlResponse_CHIP(fnameXML, fnamePDF, RepFNameFact, ErrorCode, ErrorString)
      VAR Stat = 0;
      VAR obj:object = BKI_XmlResponceReportMaker(BKI.CHIP);

      IF (obj.Init(fnameXML, fnamePDF) and obj.CheckXmlType())
         obj.RunReport();
         RepFNameFact = obj.GetReportName();
      ELSE
         ErrorCode   = obj.GetErrCode();
         ErrorString = obj.GetErrMess();
         Stat = ErrorStat;
      END;
      SetParm( 3, RepFNameFact );
      SetParm( 4, ErrorCode );
      SetParm( 5, ErrorString );

      RETURN Stat;
   END;

   MACRO ParseXmlResponse_CHST(fnameXML, fnamePDF, RepFNameFact, ErrorCode, ErrorString)
      VAR Stat = 0;
      VAR obj:object = BKI_XmlResponceReportMaker(BKI.CHST);

      IF (obj.Init(fnameXML, fnamePDF) and obj.CheckXmlType())
         obj.RunReport();
         RepFNameFact = obj.GetReportName();
      ELSE
         ErrorCode   = obj.GetErrCode();
         ErrorString = obj.GetErrMess();
         Stat = ErrorStat;
      END;

      SetParm( 3, RepFNameFact );
      SetParm( 4, ErrorCode );
      SetParm( 5, ErrorString );

      RETURN Stat;
   END;

   MACRO ParseXmlResponse_CIPO(fnameXML, fnamePDF, RepFNameFact, ErrorCode, ErrorString)
      VAR Stat = 0;
      VAR obj:object = BKI_XmlResponceReportMaker(BKI.CIPO);

      IF (obj.Init(fnameXML, fnamePDF) and obj.CheckXmlType())
         obj.RunReport();
         RepFNameFact = obj.GetReportName();
      ELSE
         ErrorCode   = obj.GetErrCode();
         ErrorString = obj.GetErrMess();
         Stat = ErrorStat;
      END;
      SetParm( 3, RepFNameFact );
      SetParm( 4, ErrorCode );
      SetParm( 5, ErrorString );

      RETURN Stat;
   END;

   MACRO ParseXmlResponse_BHST(fnameXML, fnamePDF, RepFNameFact, ErrorCode, ErrorString)
      VAR Stat = 0;
      VAR obj:object = BKI_XmlResponceReportMaker(BKI.BHST);

      IF (obj.Init(fnameXML, fnamePDF) and obj.CheckXmlType())
         obj.RunReport();
         RepFNameFact = obj.GetReportName();
      ELSE
         ErrorCode   = obj.GetErrCode();
         ErrorString = obj.GetErrMess();
         Stat = ErrorStat;
      END;
      SetParm( 3, RepFNameFact );
      SetParm( 4, ErrorCode );
      SetParm( 5, ErrorString );

      RETURN Stat;
   END;

//\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
// Перегрузка функций базового класса
//\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

   //---------------------------------------------------------------------------------------
   // Получение URL
   //---------------------------------------------------------------------------------------
   MACRO getUrlAddress()
      VAR resString:string = "", 
      StrErr :string = ""; 
      GetRegistryValue( "RS-LOANS\\БКИ\\АДРЕС_API_НБКИ",V_STRING, resString, StrErr );

      RETURN resString;
   END;

   //---------------------------------------------------------------------------------------
   // Формирование исходящего xml сообщения
   //---------------------------------------------------------------------------------------
   MACRO PrepareXmlRequest( fnameSrcXml, XmlReq )
      VAR IsExistFile = ExistFile( fnameSrcXml );

      IF ( NeedRewrite or ( (not NeedRewrite) and (not IsExistFile ) ) )

         IF ( TypeMsg == "CHIP" )
            PrepareXmlReq_CHIP();
         ELIF ( TypeMsg == "CHST" )
            PrepareXmlReq_CHST();
         ELIF ( TypeMsg == "CIPO" )
            PrepareXmlReq_CIPO();
         ELIF ( TypeMsg == "BHST" )
            PrepareXmlReq_BHST();
         END;
         outXml.save(fnameSrcXml);
      ELSE
         outXml.Load(fnameSrcXml);
      END;
      SetParm( 2, outXml.doc.xml );
   END;

   //---------------------------------------------------------------------------------------
   // Расшифровка ответа от БКИ
   //---------------------------------------------------------------------------------------
   MACRO UncodingInMessage( fnameСAnsw, fnameAnswXML, ErrorString )
      VAR stat = 0;

      IF ( not ExistFile( fnameСAnsw ) )
         ErrorString = "Не найден файл " + fnameСAnsw + ".";
         stat = ErrorStat;
      END;

      IF ( not stat )
         IF (ExistFile( fnameAnswXML ) )
            RemoveFile( fnameAnswXML );
         END;

         //\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
         //  В качестве примера для расшифровки используется сервис КриптоАрм,
         // который предоставляет возможность вызова команд из командной строки.
         // Для этого ими реализован скрипт cryptoArmScrpt.vbs, аналог которого можно реализовать самостоятельно.
         // Файл cryptoArmScrpt.vbs необходимо скопировать в папку obj.
         // В команде используется только каталог RequestPath, который содержит зашифрованный файл и расшифровывает в файл этого же каталога.
         //\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
         IF ( not ExistFile( "..\\obj\\cryptoArmScrpt.vbs" ) )
            stat = ErrorStat;
            ErrorString = "Не найден файл ..\\obj\\cryptoArmScrpt.vbs.";
         ELSE
            VAR CommandProc = GetEnv( "COMSPEC");
            VAR CommandStr:string = "";
            CommandStr  = "/C cscript.exe cryptoArmScrpt.vbs \"" + RequestPath + "\\\"" + " \"" + RequestPath + "\\" + "\" \"FNS\" \"T\" > cryptoArmScrpt.log";

            stat = RUN( CommandProc, CommandStr);
            IF (stat)
            if( stat == ErrorCriptoArm)
                ErrorString = "Не найден объект DigtCrypto.PKCS7Message! Скорее всего не установлен CryptoArm";
            elif ( stat == ErrorCriptoArm_FNS)
                ErrorString = "Не найдена настройка КриптоАРМ. Настройте(добавьте) профиль КриптоАРМ FNS";
            else
                ErrorString = "Ошибка при расшифровке КриптоАрм";
            end;
               stat = ErrorStat;
            END;
         END;
      END;
  
      SetParm( 3, ErrorString );
      RETURN stat;
   END;

   //---------------------------------------------------------------------------------------
   // Разбор входящего xml сообщения
   //---------------------------------------------------------------------------------------
   MACRO ParseXmlResponse( fnameXML, PathPdf, RepFNameFact, ErrorCode, ErrorString )
      VAR Stat = 0;
      IF ( not ExistFile( fnameXML ) )
         ErrorString = "Не найден файл " + fnameXML + ".";
         Stat = ErrorStat;
      END;

      IF ( not Stat )
         VAR RepFName = Parm_rec.rec.fname;
         VAR RepFullfname = PathPdf + RepFName;

         IF ( TypeMsg == "CHIP" )
            Stat = ParseXmlResponse_CHIP(fnameXML, RepFullfname, RepFNameFact, ErrorCode, ErrorString);
         ELIF ( TypeMsg == "CHST" )
            Stat = ParseXmlResponse_CHST(fnameXML, RepFullfname, RepFNameFact, ErrorCode, ErrorString);
         ELIF ( TypeMsg == "CIPO" )
            Stat = ParseXmlResponse_CIPO(fnameXML, RepFullfname, RepFNameFact, ErrorCode, ErrorString);
         ELIF ( TypeMsg == "BHST" )
            Stat = ParseXmlResponse_BHST(fnameXML, RepFullfname, RepFNameFact, ErrorCode, ErrorString);
         END;

         VAR fName: string = "";
         VAR fExt : string = "";

         SplitFile( RepFNameFact, fName, fExt);
         RepFNameFact = fName + fExt;
      END;
  
      SetParm( 3, RepFNameFact );
      SetParm( 4, ErrorCode );
      SetParm( 5, ErrorString );
      RETURN Stat;
   END;

   //---------------------------------------------------------------------------------------
   // Добавление записи в протокол и печать
   //---------------------------------------------------------------------------------------
   MACRO RunErrorProtocol(fnameOut, ErrorCode, ErrorString)
      VAR h, m;
      TimeSplit( Parm_rec.rec.Time, h, m);

      setOutput( fnameOut, true );
      println("*****************************************************************************************************************************");
      println( "  Протокол по итогам обработки запроса №" + Parm_rec.rec.ID +"\n" );
    
      println( "  " + "  Сформирован файл:" + RequestPath + "\\" + Parm_rec.rec.FName + ".out"); 
      println( "  " + "  Дата формирования файла:" + String( Parm_rec.rec.Date) + "  "+  String( Parm_rec.rec.Time )/*"  "+h+":"+m */); 
      println( "  " + "  Код ошибки: ", ErrorCode,  "  Сообщение: ", ErrorString);
      println("");
    
      setOutput( NULL, 0 );
      IF ({GROUP_MODE} == false)
         PrintErrProtocol( fnameOut);
      END;    
   END;

   MACRO RunProtocol( fnameOut, fnameRep)
      VAR h, m;
      TimeSplit(Time(), h, m);

      setOutput( fnameOut, true );
      println("*****************************************************************************************************************************");
      println( "  Протокол по итогам обработки запроса №" + Parm_rec.rec.ID +"\n" );

      println( "  " + "  Сформирован файл: " + RequestPath + "\\" + Parm_rec.rec.FNameRep ); 
      println( "  " + "  Дата формирования файла: " + String( Parm_rec.rec.Date) + "  "+  String( Parm_rec.rec.Time ) + "\n");

      println( "  " + "  Тип запроса: " + TypeMsg + "\n");
    
      println( "  " + "  Запрошены данные о субъекте КИ: \n" );
    
      IF (Parm_rec.rec.ClForm == 2)
         println( "  " + "  Фамилия:  " + Parm_rec.rec.name1);
         println( "  " + "  Имя:      " + Parm_rec.rec.first); 
         println( "  " + "  Отчество: " + Parm_rec.rec.paternal); 
       
         println( "  " + "  Документ: " + FindDocName(Parm_rec.rec.idType));
         println( "  " + "  Серия: " + Parm_rec.rec.seriesNumber + " Номер: " + Parm_rec.rec.idNum + " Дата выдачи: " + String( Parm_rec.rec.issueDate));
      ELSE
         println( "  " + "  Наименование:");
         println( "  " + Parm_rec.rec.name1);
         println( "  " + "  ОГРН: " + Parm_rec.rec.idNum1 + " ИНН: " + Parm_rec.rec.idNum2);
      END;
      println("");
    
      setOutput( NULL, 0 );
   END;

   //---------------------------------------------------------------------------------------
   // Выполнение отправки сообщения
   //---------------------------------------------------------------------------------------
   MACRO Send()
      RETURN Send( Parm_rec.rec.FName, Parm_rec_BKI );
   END;  
END;

//-----------------------------------------------------------------------
//Точка входа
//-----------------------------------------------------------------------
// Получение имени папки, содержащей файлы запроса (основа для имени каждого файла запроса)
MACRO getReqDirName( NameBkiClient, Parm_ptr )
   VAR  d,m,y,hh,mm,ss;
   RECORD Parm( "Bki_Req.dbt", "loans.def" );
   VAR Parm_rec = TRecHandler("Bki_Req.dbt", "loans.def");

   setbuff( Parm, Parm_ptr );

   copy( Parm_rec, Parm );
 
   DateSplit ( date( Parm_rec.rec.date ), d, m, y );
   TimeSplit(Time(), hh, mm, ss);
   RETURN NameBkiClient + "_"  + string ( y:4:o ) + string ( m:2:o ) + string ( d:2:o ) + "_" + string ( hh:2:o ) + string ( mm:2:o ) + string ( ss:2:o )/* + ".XML"*/;
END;

MACRO SendQuery( Parm_ptr, NeedRewrite,TypeQueryName,Parm_ptr_BKI, NameRepGroup)
   VAR Stat = 0;
   VAR arrayOUT = TArray();

   VAR SendMsgObj = CSendMessage_TMP( Parm_ptr, NeedRewrite,TypeQueryName,Parm_ptr_BKI, NameRepGroup );
   Stat = SendMsgObj.Send();
   IF (ValType(Stat) != V_GENOBJ)
      arrayOUT[0] = 1;
      arrayOUT[1] = "Ошибка типа возващаемого параметра."; 
      RETURN arrayOUT;     
   END;
  
   RETURN Stat;
END;

MACRO PrintReport( NameRepFile, IsProtocol , Parm_ptr_BKI )
   RECORD Parm_BKI( "lbki.dbt", "loans.def" );
   VAR Parm_rec_BKI = TRecHandler("lbki.dbt", "loans.def");
   setbuff( Parm_BKI, Parm_ptr_BKI );
   copy( Parm_rec_BKI, Parm_BKI ); 

   NameRepFile = Parm_rec_BKI.rec.Path_request + "\\" + NameRepFile;
   IF ( IsProtocol )
      PrintErrProtocol( NameRepFile );
   ELSE
      PrintXLSReport( NameRepFile );
   END;
END;