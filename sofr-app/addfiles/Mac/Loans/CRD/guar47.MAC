/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : guar47.mac
 Description : Создание документа по шагу операции (погашение гарантии)
 Programmer  : KOE
 06.06.05    : Создан
-----------------------------------------------------------------------------------*/
import macperc,SbCrdInter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.dat", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var stat = 0;
    var DocID = 0;

    IF ((Договор.Crd_kind == LO_GUARANTEE) and (NOT (НадежныйДоговор(Договор.CreditNumber, Договор.Crd_kind, OperDate))))
        RETURN 0;
    END;

    if(ExistsOperation(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, CS_GUARPAYM) != 0)
        SetBuff(DutyData, Data);

        Документ.CarrySum = GetPaySum(DS_PAYMGUAREXPPERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
        return СоздатьДокумент(Документ, DocID);
    end;
    return 0;
END;