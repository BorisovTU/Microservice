/*
$Name:             notice.mac
$Module:           Кредитование
$Description:      Работа с уведомлениями
*/
import total;

VAR notice = TBFile("notice.dbt", "r", 0);

CLASS VehicleProperty // Транспортное средство
   VAR ID         : String; // ID код транспортного средства, переданного в залог
   VAR VIN        : String; // VIN (указывается при наличии)
   VAR Description: String; // Описание транспортного средства
   VAR TypeExport : String; // Действие, которое требуется выполнить в реестре залогов по предмету залога (ре-гистрация, исключение, изменение).
END;


MACRO fillEnsObj(buff)
   RECORD notice ("notice.dbt");
   SetBuff(notice, buff);

   LnSQLExec("TRUNCATE TABLE DENSOBJ_TMP");

   IF (notice.TypeNotice == 1)
      CRSDCommand(
         "INSERT INTO DENSOBJ_TMP (T_ENSCONTRACTID, T_ENSOBJECTID, T_TYPE_EXSPORT, T_ENSOBJECTSUM, T_VIN, T_ENSOBJECTNAME) "+
         "SELECT E3.T_ENSCONTRACTID_REF, E3.T_ENSOBJECTID_REF, 0, E1.T_ENSOBJECTSUM, "+
               " CASE E2.T_TYPETRANSPORT "+
                    " WHEN 1 THEN SubStr(LoansUserFunction.GetUsFieldValue (212, ?, 5, E3.T_ENSOBJECTID_REF), 1, 20) "+
                    " WHEN 2 THEN SubStr(LoansUserFunction.GetUsFieldValue (213, ?, 5, E3.T_ENSOBJECTID_REF), 1, 20) "+
                    " ELSE CHR(1) "+
                " END, T_ENSOBJECTNAME "+
         " FROM DENSOBJ_DBT E1 JOIN DENSTYPE_DBT E2 ON (E1.T_ENSTYPEID_REF = E2.T_ENSTYPEID) "+
                             " JOIN DECN_EOB_DBT E3 ON (E1.T_ENSOBJECTID   = E3.T_ENSOBJECTID_REF)  "+
         " WHERE E1.T_FORMATIONFNP = 'X' "+
           " AND E1.T_BASE = 1 "+
           " AND E2.T_TYPETRANSPORT > 0 "+
           " AND E3.T_ENSCONTRACTID_REF = ? "+
           " AND E1.T_DATEFORMATION <= ? ",
         "p1", {curdate},
         "p2", {curdate},
         "p3", notice.EnsContractID,
         "p4", notice.DateNotice,
      V_GENOBJ);

   ELIF ((Notice.TypeNotice == 2) OR (Notice.TypeNotice == 3))
      VAR TypeNotice = 
      CRSDCommand("SELECT T_TYPENOTICE FROM DNOTICE_DBT WHERE "+
                        " T_REGNUM = ? "+
                    " AND T_ID    <> ? "+
                    " AND T_ENSCONTRACTID = ?", 
                    "p1", notice.RegNum,
                    "p2", notice.ID,
                    "p3", notice.EnsContractID,
                    V_INTEGER);

      IF (TypeNotice == 1)

      ELSE
         CRSDCommand(
         "INSERT INTO DENSOBJ_TMP (T_ENSCONTRACTID, T_ENSOBJECTID, T_TYPE_EXSPORT, T_ENSOBJECTSUM, T_VIN, T_ENSOBJECTNAME) "+
         "SELECT E3.T_ENSCONTRACTID_REF, E3.T_ENSOBJECTID_REF, 0, E1.T_ENSOBJECTSUM, "+
               " CASE E2.T_TYPETRANSPORT "+
                    " WHEN 1 THEN SubStr(LoansUserFunction.GetUsFieldValue (212, ?, 5, E3.T_ENSOBJECTID_REF), 1, 20) "+
                    " WHEN 2 THEN SubStr(LoansUserFunction.GetUsFieldValue (213, ?, 5, E3.T_ENSOBJECTID_REF), 1, 20) "+
                    " ELSE CHR(1) "+
                " END, T_ENSOBJECTNAME "+
         " FROM DENSOBJ_DBT E1 JOIN DENSTYPE_DBT E2 ON (E1.T_ENSTYPEID_REF = E2.T_ENSTYPEID) "+
                             " JOIN DECN_EOB_DBT E3 ON (E1.T_ENSOBJECTID   = E3.T_ENSOBJECTID_REF)  "+
         " WHERE E1.T_FORMATIONFNP = 'X' "+
           " AND E1.T_BASE > 1 "+
           " AND E2.T_TYPETRANSPORT > 0 "+
           " AND E3.T_ENSCONTRACTID_REF = ? "+
           " AND E1.T_DATEFORMATION <= ? ",
         "p1", {curdate},
         "p2", {curdate},
         "p3", notice.EnsContractID,
         "p4", notice.DateNotice,
         V_GENOBJ);
      END;   
   END;

   RETURN TRUE;
END;

MACRO Block_Pledgors(ID)
   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNP.Block_Pledgors(?); END;");
   RSDcmd1.addParam("ID",  RSDBP_IN); RSDcmd1.value ("ID") = ID;
   RSDcmd1.execute();
END;

MACRO Block_PersonalProperties(ID)
   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNP.Block_PersonalProperties(?); END;");
   RSDcmd1.addParam("ID",  RSDBP_IN); RSDcmd1.value ("ID") = ID;
   RSDcmd1.execute();
END;


MACRO Block_Pledgees(ID)
   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNP.Block_Pledgees(?); END;");
   RSDcmd1.addParam("ID",  RSDBP_IN); RSDcmd1.value ("ID") = ID;
   RSDcmd1.execute();
END;

MACRO Block_PledgeContract(ID)
   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNP.Block_PledgeContract(?); END;");
   RSDcmd1.addParam("ID",  RSDBP_IN); RSDcmd1.value ("ID") = ID;
   RSDcmd1.execute();
END;

MACRO Block_NotificationApplicant(ID)
   VAR RSDcmd1 = RsdCommand(RslDefCon, "BEGIN RSO_Loans_FNP.Block_NotificationApplicant(?); END;");
   RSDcmd1.addParam("ID",  RSDBP_IN); RSDcmd1.value ("ID") = ID;
   RSDcmd1.execute();
END;

MACRO onUpload(ID)
   Notice.rec.ID = ID;
   IF (NOT Notice.GetEQ())
      RETURN;
   END;

   IF (Notice.rec.TypeNotice == 1)
      Block_PersonalProperties(ID);
      Block_Pledgors(ID);
      Block_Pledgees(ID);
      Block_PledgeContract(ID);
      Block_NotificationApplicant(ID);

   ELIF (Notice.rec.TypeNotice == 2)
      Block_PersonalProperties(ID);

      IF (Notice.rec.Flag2 == "X")
         Block_PledgeContract(ID);
      END;

      IF (Notice.rec.Flag3 == "X")
         Block_Pledgors(ID);
      END;

      IF (Notice.rec.Flag4 == "X")
         Block_Pledgees(ID);
      END;

      Block_NotificationApplicant(ID);
   
   ELIF (Notice.rec.TypeNotice == 3)
      Block_PersonalProperties(ID);
      Block_NotificationApplicant(ID);
   END;

   // ID сервиса
   VAR RS = 
   CRSDCommand("SELECT T_MACRO, T_MACRO_FUNC, T_URL FROM DSERVICE_CHANGE_DBT WHERE T_ID_LIST = ? AND T_TYPE_SERVICE = 1 AND T_TYPE_NOTICE = ?",
               "p1", Notice.rec.ServiceID,
               "p2", Notice.rec.TypeNotice,
              V_GENOBJ);
   IF (Not RS.MoveNext())
      MsgBox("Нельзя отправить уведомление! Не найден сервис передачи уведомлений");
      RETURN FALSE;
   END;

   VAR MACROS = RS.Value("T_MACRO", V_STRING);
   VAR MACRO_FUNC = RS.Value("T_MACRO_FUNC", V_STRING);
   VAR URL = RS.Value("T_URL", V_STRING);

   ExecMacroFile(MACROS, MACRO_FUNC, URL, ID);

   RETURN TRUE;
END;


// Запрос статуса
MACRO checkStatus(ID)
   Notice.rec.ID = ID;
   IF (NOT Notice.GetEQ())
      RETURN;
   END;

   // ID сервиса
   VAR RS = 
   CRSDCommand("SELECT T_MACRO, T_MACRO_FUNC, T_URL FROM DSERVICE_CHANGE_DBT WHERE T_ID_LIST = ? AND T_TYPE_SERVICE = 2",
               "p1", Notice.rec.ServiceID,
              V_GENOBJ);
   IF (Not RS.MoveNext())
      MsgBox("Нельзя выполнить запрос!\nНе найден сервис запроса статусов уведомлений");
      RETURN FALSE;
   END;

   VAR MACROS = RS.Value("T_MACRO", V_STRING);
   VAR MACRO_FUNC = RS.Value("T_MACRO_FUNC", V_STRING);
   VAR URL = RS.Value("T_URL", V_STRING);

   ExecMacroFile(MACROS, MACRO_FUNC, URL, ID);

   RETURN TRUE;
END;