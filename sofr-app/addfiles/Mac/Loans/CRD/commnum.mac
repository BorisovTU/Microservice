 /*
 $Name: commnum.mac
 $Module: commnum
 $Description: Обработка Шаблона
 */
/*
 Any text.
*/
import sbcrdnum, total;

const SymNextNum     = "C"; // след номер заседания
const SymTypeCrdComm = "N"; // вид кредитного комитета
const SymBeginDate   = "D"; // дата начала заседания
const SymFnCash      = "F"; // Филиал
const SymBranch      = "B"; // Подразделение

MACRO GetNextNum()
    var result = LnSelectValue("SELECT max(t_meetid) from dcrdcommmeet_dbt", V_INTEGER);
    return string(result + 1);
END;

MACRO BeginDate(buff)
    var day, mon, year;
    DateSplit(buff.BeginDate, day, mon, year);
    RETURN String(year);
    OnError
       RETURN "";
END;

MACRO GetCrdCommNum(buff, Template)
    var CrdCommNum = Template;
    ВставитьФрагмент(SymNextNum, GetNextNum(), Template, CrdCommNum);
    ВставитьФрагмент(SymTypeCrdComm, buff.typecrdcommid, Template, CrdCommNum);
    ВставитьФрагмент(SymBeginDate, BeginDate(buff), Template, CrdCommNum);
    ВставитьФрагмент(SymFnCash, buff.fncash, Template, CrdCommNum);
    ВставитьФрагмент(SymBranch, buff.branch, Template, CrdCommNum);
    return CrdCommNum;
END;



MACRO ОбработкаШаблона(buff, Template)
    RECORD CrdCommMeetBuff("crdcommmeet.dbt", "loans.def");
    SetBuff(CrdCommMeetBuff, buff);
    CrdCommMeetBuff.MeetNumber = GetCrdCommNum(CrdCommMeetBuff, Template);
END;