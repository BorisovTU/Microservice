/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : payOV2.mac
 Description : Создание документа по возникновению овердрафта, корректировка неиспользованного лимита

 Programmer  : TFS
 09.08.05    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, Total;

RECORD ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
RECORD Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
RECORD Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
RECORD Договор     ("credit_c.dbt", "loans.def");
RECORD Сумма       ("SUM.",         "loans.def");

MACRO ВыполнитьШаг (OperDate, Sum, Data)
   VAR DocID: integer = 0;
   VAR stat : integer = 0;
   VAR СуммаОП, НеиспЛимДо: money;

   setbuff(Сумма, Sum);
   СуммаОП    = Сумма(0);
   НеиспЛимДо = ОстатокРегистра(Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMDUTY, OperDate);

   Документ.CarrySum = min(НеиспЛимДо, СуммаОП);

   stat = СоздатьДокумент(Документ, DocID);
   IF ((stat == 0) AND (DocID != 0))
      stat = ИзменитьРегистр(Договор.Crd_kind, Договор.CreditNumber, TCLTR_LIMDUTY, DocID, -(min(НеиспЛимДо, СуммаОП)));
   END;
   RETURN stat;
END;