/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : exp_212.mac
 Description : Создание документа по шагу операции (вынос на просрочку срочных %)
                            для 1-й группы риска договора
 Programmer  : Taneev
 20.03.2001  : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, BankInter, macperc;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record lcusreg     ("lcusreg.dbt",  "loans.def");
record lcusrate    ("lcusrate.dbt", "loans.def");
record dutycrd     ("duty_crd.dbt", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var DocID:integer = 0;
    var stat:integer = 0;
    var ErrCode = 0;
    var PercChargeType = "";
    var AddPerc = $0, AddCrdPerc = $0, AddNoOvcPerc = $0;

    IF( ( (Договор.Crd_kind != LO_GUARANTEE)                                      and 
          (NOT НадежныйДоговор(Договор.CreditNumber, Договор.Crd_kind, OperDate)) and 
          (Договор.FlagOB == FlagOB_SetValue)
        ) OR

        ( (Договор.Crd_kind == LO_GUARANTEE)                                      and 
          (NOT НадежныйДоговор(Договор.CreditNumber, Договор.Crd_kind, OperDate))
       )
      )
        RETURN 0;
    END;

   IF (NOT GetPercChargeType(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, PercChargeType))
      MsgBox("Ошибка получения значения: НАЧИСЛ_ПРОЦ_ПЕРЕД_ОПЛАТОЙ");
   END;

    if (PercChargeType == "OFF")
        if(Договор.Crd_kind != LO_GUARANTEE)
            /*Начисленные в текущем периоде (не отражены на счетах требований)*/
            AddCrdPerc   = GetPaySum (DS_ADDPERC,           Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
            AddNoOvcPerc = GetPaySum (DS_ADDNOOVCRDPERCENT, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
            AddPerc      = AddCrdPerc  + AddNoOvcPerc;

            Документ.CarrySum = AddPerc;
            stat = СоздатьДокумент(Документ, DocID);
               if (stat == 0)
                  stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC, DocID, AddCrdPerc,      Операция.CredOperID);
               if (stat != 0) return stat; end;
                  stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_OV, DocID, AddNoOvcPerc, Операция.CredOperID);
               if (stat != 0) return stat; end;
            end;
        else

            AddCrdPerc   = GetPaySum (DS_PAYMGUARADDPERC,  Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
            AddPerc      = AddCrdPerc;

            Документ.CarrySum = AddPerc;
            stat = СоздатьДокумент(Документ, DocID);
            if (stat == 0)
                stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_PAYMGUARANTEEEXPPERC,  DocID, AddCrdPerc, Операция.CredOperID);
            end;

        end;
    end;
    return stat;
end;
