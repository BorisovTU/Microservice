
/*---------------------------------------------------------------------------------

 Filename    : 302SUM.mac
 Description : пункт меню:  Работа/пакетный режим/переход на 302-П/Формирование остатков регистров

 Programmer  : Sviridenko
 22.11.07
-----------------------------------------------------------------------------------*/

//IMPORT total,RsbDataSet;
import "total.mac", SbCrdInter, RsbDataSet;

PRIVATE VAR {ФИЛИАЛ};


PRIVATE MACRO ШапкаПротокола(НазваниеПротокола)
   [ #########################################################################                    ] (НазваниеПротокола);
   [                                                                                              ];
   [╓─────────────┬────────────┬───────────────────────────┬──────────────────────────────────────────────╖];
   [║ Вид объекта │ ID объекта │     Название объекта      │ Выполение операции                           ║];
   [║             │            │                           │                                              ║];
   [╟─────────────┼────────────┼───────────────────────────┼──────────────────────────────────────────────╢];
END;

PRIVATE MACRO СообщениеПротокола(CredOperID: integer, ObjID: integer, ObjN: integer)
   VAR Результат: string = "";
   MACRO ВО(ObjID: integer)
      RETURN CRsdCommand("SELECT T_SHORTNAME FROM DLOBJECT_DBT WHERE T_OBJECTID = ?", "SHORTNAME", ObjID, V_STRING);
   END;

   MACRO Имя(ObjID: integer, ObjN: integer)
      IF (ObjID == LO_DUTY)
         RETURN CRsdCommand("SELECT T_USERNUMBER     FROM DDUTY_CRD_DBT WHERE T_DUTYID       = ?", "SHORTNAME", ObjN, V_INTEGER);
      ELSE
         RETURN CRsdCommand("SELECT T_USCREDITNUMBER FROM DCREDIT_C_DBT WHERE T_CREDITNUMBER = ?", "SHORTNAME", ObjN, V_STRING);
      END;
   END;

   IF (CredOperID <= 0)
      Результат = "Ошибка " + GetMO_LoansError();
   ELSE
      Результат = "Успешно";

   END;

   [║ ############│ ###########│ ##########################│ #############################################║]
      (
      ВО(ObjID),
      ObjN,
      Имя(ObjID, ObjN),
      Результат
      );

END;

PRIVATE MACRO ИтогПротокола()
   [╚═════════════╧════════════╧═══════════════════════════╧══════════════════════════════════════════════╝];
END;


var inData = {curdate};

MACRO GetSQLDate( _date )
   return string( "TO_DATE( '",_date,"', 'DD.MM.YYYY' )" );
end;


/*******************************************************************
 *                                                                 *
 * Отбираем все договора на дату ККС которых больше 2              *
 * и вызываем оперцию 102 Фомирование регистров                    *
 *                                                                 *
 *******************************************************************/


MACRO FillRegistersOnDate( Date )

VAR query;
var CrdSet;
var stat;
var CreditNumber = -1;
var CrdKind = -1;

  query = " SELECT T_CRD_KIND AS CRD_KIND,T_CREDITNUMBER FROM DCREDIT_C_DBT WHERE "
          " T_FNCASH = "+{ФИЛИАЛ}+" AND "+
          " LoansKernel.GetRiskGroup302(T_CRD_KIND, T_CREDITNUMBER, 1," + GetSQLDate(Date) +") >= 2 "
          " AND LoansKernel.ExistsOperation( T_CRD_KIND , T_CREDITNUMBER, "+CS_MOVE_SUM+", 102) = 0 ";
  CrdSet = LnGetRecordSet(query);

  SetLoansGroupMode(TRUE);

  ШапкаПротокола("Формирование остатков регистров (302-П)");

  while(CrdSet.MoveNext())
    CreditNumber = CrdSet.Value("T_CREDITNUMBER");
    CrdKind      = INT(CrdSet.Value("CRD_KIND"));
    stat = MakeOperation(CreditNumber, CrdKind , 102, 0, Date, 0 , 0, 0);
    СообщениеПротокола(stat,CrdKind,CreditNumber);
  end;

  ИтогПротокола();

  SetLoansGroupMode(FALSE);


END;


GetDate(inData, "Введите дату операции");
FillRegistersOnDate( inData );