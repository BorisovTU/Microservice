/*
$Name:             dogbckrz.mac
$Module:           Кредитование
$Description:      Договор обратного выкупа: реестр приобретенных закладных
*/
import "or_tpl_h.mac", total, RsbDataSet, global;


private record credit_c ("credit_c.dbt", "loans.def");
private record cur_credit ("credit_c", "loans.def");
private file   bankdprt    ("bankdprt.dbt", "bank.def");
private file   ces_parm    ("ASGMTPARM.DBT", "loans.def");
private file   currency   ("fininstr.dbt", "bank.def");

private const TemplateName:string = "dogbckrz.xls";
private var ExcelObj : CTemplateXLS = CTemplateXLS();
private var TemplateTable : object = NULL;


/*
   Полное преобразование даты в строку: dd месяца yyyy г.
*/
MACRO DateToStringFull (IDate)
   VAR    Day, Month, Year;
   Array  AMonth;
   AMonth (1)  = "января";
   AMonth (2)  = "февраля";
   AMonth (3)  = "марта";
   AMonth (4)  = "апреля";
   AMonth (5)  = "мая";
   AMonth (6)  = "июня";
   AMonth (7)  = "июля";
   AMonth (8)  = "августа";
   AMonth (9)  = "сентября";
   AMonth (10) = "октября";
   AMonth (11) = "ноября";
   AMonth (12) = "декабря";
   if (ValType (IDate) != V_DATE)
      MsgBox ("Неверный формат даты: "+IDate);
      return "";
   end;
   if (IDate == Date (0,0,0))
      return "00.00.0000";
   end;
   DateSplit (IDate, Day, Month, Year);
   return String (Day+" "+AMonth (Month)+" "+Year+" г.");
END;



macro PrintLoansReport(CreditBuf, FromWeb)

      if (FromWeb == true)
          return "";
      end;

   var StateName:string = "";
   var rsRow = NULL;
   var RSDcmd = NULL;
   var StrCmd:string = "";
   var row:integer = 0;
   var CrdOD,CrdPerc,CrdFineRate;
   var CrdPrice:double = 0;
   var AllCrdOD: double = 0,AllCrdPerc: double = 0,AllCrdFineRate: double = 0,AllCrdPrice: double = 0;
   var ExtCurCode , rub,kop;


   
   if (not ExcelObj.OpenTemplate(TemplateName))
      Exit(0, "Не удалось открыть шаблон отчета " + TemplateName);
      return 0;
   end;

   SetBuff(credit_c, CreditBuf);

   if (not depclnt.GetRecord(credit_c.ClientID_Ref))
      MsgBox ("ОШИБКА: не найден заещик в справочнике клиентов");
      return 0;
   end; 

   ces_parm.CreditNumber = credit_c.CreditNumber;
   if(not getEq(ces_parm))
      Exit(0, "Не найдены параметры договора");
      return 0;
   end; 


    currency.FIID = credit_c.CurCode;         
    if(getEQ(currency))                       
      ExtCurCode = currency.ISO_Number;
    end;

              
   ExcelObj.SetValue_NameCell("RegDate"," к Договору обратного выкупа (купли-продажи) закладных № "+
                              credit_c.UsCreditNumber+"__ от "+DateToStringFull (credit_c.RegDate) );

   ExcelObj.SetValue_NameCell("DogCurr", "Номинальная стоимость закладной (цена объема прав по денежному обязательству "+
                                 " на дату подписания настоящего приложения),"+FindShortName (credit_c.CurCode)+" в т.ч.");   

   ExcelObj.SetValue_NameCell("DogCurr2", "Цена продажи закладной, "+FindShortName (credit_c.CurCode));
  
   // строки отчета
   TemplateTable = ExcelObj.RegisterTable("tpl_Row");



   StrCmd = 
"SELECT "+
"   du_crd.*, "+
"   crd_opp.t_credoperdate, "+
"   (LoansKernel.GetRegRestWithSO (1, CrdK, CrdN, ?) + LoansKernel.GetRegRestWithSO (2, CrdK, CrdN, ?)) CrdOD, "+
"   (LoansKernel.GetRegRestWithSO (139, CrdK, CrdN,?) + LoansKernel.GetRegRestWithSO (140, CrdK, CrdN, ?)) CrdPerc, "+
"   (LoansKernel.GetRegRestWithSO (6, CrdK, CrdN, ?) +LoansKernel.GetRegRestWithSO (5, CrdK, CrdN, ?)) CrdPenalty, "+
"    LoansKernel.GetRegRestWithSO (129, CrdK, CrdN, ?) CrdSelling "+
"FROM "+
"   ( "+
"       select cr.t_Crd_kind CrdK, cr.t_CreditNumber CrdN, cr.T_UsCreditNumber UN, cr.T_RETURNDATE RD, cl.t_ShortName NameCl "+
"       from dcredit_c_dbt cr, dparty_dbt cl, dlbfrccrd_dbt lbfrccrd "+
"       where lbfrccrd.t_briefcaseid_ref = ? "+
"       AND cr.t_crd_kind = lbfrccrd.t_objecttypeid "+
"       AND cr.t_creditnumber = lbfrccrd.t_objectnumber "+
"       AND cl.t_partyid = cr.t_clientid_ref "+
"   ) du_crd,   "+
"   dcrd_op_dbt crd_opp"+
" WHERE       "+
"   crd_opp.t_credoperid = "+
"                   (SELECT MIN (op.t_credoperid) "+
"                      FROM dcrd_op_dbt op "+
"                     WHERE op.t_creditnumber_ref = du_crd.CrdN "+
"                       and op.t_SystemOperationID = 2 "+
"                       AND op.t_isdeleted = 0 "+
"                   )";
   

   RSDcmd = RsdCommand (RslDefCon, StrCmd);

   row = 0;
   while(row<7)
      RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(row) = ces_parm.concession;
      row = row+1;
   end;
   row = 0;  
   
   RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(7) = credit_c.creditnumber;

   rsRow = RsdRecordset(RSDcmd);

   if (rsRow == NULL)
      return 0;
   end;

   while (rsRow.MoveNext())


      CrdOD       = rsRow.Value("CrdOD");
      CrdPerc     = rsRow.Value("CrdPerc");
      CrdFineRate = rsRow.Value("CrdPenalty");
      CrdPrice    = rsRow.Value("CrdSelling"); 


      AllCrdOD = AllCrdOD + CrdOD;
      AllCrdPerc = AllCrdPerc + CrdPerc;
      AllCrdFineRate = AllCrdFineRate + CrdFineRate;
      AllCrdPrice = AllCrdPrice + CrdPrice;


      row = row+1;
      TemplateTable.SetValueCell("Crd_N",      row);
      TemplateTable.SetValueCell("Crd_Name",   rsRow.Value("NameCl"));
      TemplateTable.SetValueCell("CrdNum",     rsRow.Value("UN"));
      TemplateTable.SetValueCell("CrdPayDate", rsRow.Value("t_credoperdate"));
      TemplateTable.SetValueCell("CrdRetDate", rsRow.Value("RD"));



      TemplateTable.SetValueCell("CrdOD",        CrdOD );
      TemplateTable.SetValueCell("CrdPerc",      CrdPerc);
      TemplateTable.SetValueCell("CrdFineRate",  CrdFineRate);
      TemplateTable.SetValueCell("CrdPrice",     CrdPrice);
      
      
   
      TemplateTable.AddStr();
   end;

   ExcelObj.SetValue_NameCell("AllCrdOD",        AllCrdOD );
   ExcelObj.SetValue_NameCell("AllCrdPerc",      AllCrdPerc);
   ExcelObj.SetValue_NameCell("AllCrdFineRate",  AllCrdFineRate);   
   ExcelObj.SetValue_NameCell("AllCrdPrice",     AllCrdPrice);

   ExcelObj.SetValue_NameCell("AllCrdPrice_Str", " Всего на сумму: __"+
                              CurToStrAlt (AllCrdPrice, rub, kop, ExtCurCode)+"_______________(Сумма прописью)" );
 
 
   TemplateTable.EndTable();  
   ExcelObj.SaveAsTemplate();
end;