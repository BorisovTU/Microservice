/*
$Name:               riskcalc.mac
$Module:            Кредитование
$Description:      Расчёт группы риска
*/
/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : riskcalc.mac
 Description : Расчёт группы риска

 Programmer  : TFS
 10.04.04    : Создан
------------------------------------------------------------------------------*/
Import total, SbCrdInter;

VAR credit_c = TBFile ("credit_c.dbt", "R", "loans.def");
    //riskgr   = TBFile ("riskgr.dbt",   "R", "loans.def");

VAR CurRiskGr = -1;
VAR CurPercRes = -1.11;
RECORD riskgr_val("riskgr_val.dbt");
RECORD riskgr("riskgr.dbt");

RECORD grouptmp ("grouprsk.tmp", "loans.def");

PRIVATE VAR ФинПоложение     = 0,
            ККС    : integer = 0,
            ПроцРез: double  = 0.0,
            Клиент           = 0,
            КачествоОбслуживания = 0,
            {GROUP_MODE},
            UsCreditNumber:string = "",
            CurKKC:string = "",
            CalcKKC:string = "",
            Reason:string = "",
            Message:string = "";


MACRO ТекущаяККС(ObjectID: integer, ObjectNumber: integer)
VAR RealKKC: integer = 0,
    select : string = "",
    query  : string = "";

   query = query + string(" T_TYPE = " + REZ_RVPS);
   query = query + string(" AND T_OBJECTTYPEID = " + ObjectID);
   query = query + string(" AND T_OBJECTNUMBER = " + ObjectNumber);

   select = "SELECT T_IRISKGROUP FROM DCRDRGHB_DBT WHERE ";
   select = select + " T_DATE = (SELECT MAX(T_DATE) FROM DCRDRGHB_DBT WHERE " + query + ") AND " + query;

   RealKKC = LnSelectValue(select, V_INTEGER);

   RETURN RealKKC;
END;

MACRO IsFromCase(Crd_kind:integer, CreditNumber:integer)
   VAR RSDcmd = RsdCommand(RslDefCon, "begin ? := RSI_LoansRisk.IsFromCase(?,?); end;");

   RSDcmd.AddParam("IsFromCase", RSDBP_RETVAL,   V_INTEGER);
   RSDcmd.addParam("objid",   RSDBP_IN, credit_c.rec.Crd_kind);
   RSDcmd.addParam("objn",    RSDBP_IN, credit_c.rec.CreditNumber);
   RSDcmd.execute();

   RETURN RSDcmd.value("IsFromCase", NULL, V_INTEGER);

END;

MACRO Beginning(Opdate:date) 
   MsgBox("Протокол выполнения пакетной операции изменения ККС");   
   MsgBox("Дата формирования: " + Opdate);
   MsgBox("Время формирования: " + Time() + "\n\n");   
END;

/* Рассчитываем ККС для заданного объекта */
MACRO РассчитатьККС(ObjectID: integer, ObjectNumber: integer, RiskDate: date, workMode: bool)

   VAR RealPercRez: doubleL = 0.0,
       RealKKC    : integer = 0,
       query      : string  = "",
       select     : string  = "",
	retval;
   VAR RSDcmd;

   ККС     = 0;  
   ПроцРез = 0.0;

   // Категория качества обслуживания долга
   КачествоОбслуживания = КачествоОбслуживанияДолга (ObjectNumber, RiskDate);
   IF (КачествоОбслуживания <= 0)
      IF (workMode)
         IF (NOT {GROUP_MODE})
             MsgBox("Не задано качество обслуживания!");
         ELSE
             Message = "Договор " + credit_c.rec.UsCreditNumber + "\nНе задано качество обслуживания.\n\n";            
             MsgBox(Message);
         END;
         RETURN 1;
      END;

      IF (NOT GetTrue(TRUE, "Не задано качество обслуживания! | Продолжить?"))
         RETURN 1;
      END;
   END;

   IF   (ФинПоложение == 1) /* Хорошее */
      IF   (КачествоОбслуживания == 1) /* Хорошее              */
         ККС = 1;
      ELIF (КачествоОбслуживания == 2) /* Среднее              */
         ККС = 2;
      ELIF (КачествоОбслуживания == 3) /* Неудовлетворительное */
         ККС = 3;
      ELSE
         ККС = -1;
      END;
   ELIF (ФинПоложение == 2) /* Среднее */
      IF   (КачествоОбслуживания == 1) /* Хорошее              */
         ККС = 2;
      ELIF (КачествоОбслуживания == 2) /* Среднее              */
         ККС = 3;
      ELIF (КачествоОбслуживания == 3) /* Неудовлетворительное */
         ККС = 4;
      ELSE
         ККС = -1;
      END;
   ELIF (ФинПоложение == 3) /* Плохое  */
      IF   (КачествоОбслуживания == 1) /* Хорошее              */
         ККС = 3;
      ELIF (КачествоОбслуживания == 2) /* Среднее              */
         ККС = 4;
      ELIF (КачествоОбслуживания == 3) /* Неудовлетворительное */
         ККС = 5;
      ELSE
         ККС = -1;
      END;
   ELSE
      ККС = -1;
   END;

   /* Если (рассчитанная/введенная группа риска Гр_Р ="1" ИЛИ Гр_Р = "2") И
           (Тип выдачи по договору "До востребования" ИЛИ "До наступления условия") И
           (на регистре "История ОД" по КД находится остаток свыше 20 календарных дней
           (Дата_первого_оборота_по_регистру+1 - Дата_операции >20)), то:
    */
   IF (((ККС == 1) OR (ККС == 2)) AND
      ((credit_c.rec.PayType == CF_POSTERESTANTE) OR (credit_c.rec.PayType == CF_BEFOREMATURITY)) AND
       CountDay(ObjectID, ObjectNumber, TDR_MAINREST, RiskDate, 20))
       IF (workMode)
          ККС = 3;
       ELSE
          IF (NOT GetTrue(TRUE, "Ссуда должна быть классифицирована не выше чем в 3 категорию качества. | " +
                                "Имеется остаток на счете 'До востребования' свыше 20 дней | Продолжить? "))

             ККС = 3;
          ELSE
             RETURN 1;
          END;
       END;
   END;

   /* Найдем % резервирования */
   //Внимаение!!! При поиске процентов если была рестукторизация, то ККС может быть изменено (222683)
     
   VAR RSDcmd_DR;    
   VAR RS_DateR;   
   VAR NumRestr;  // кол-во реструктуризаций
   VAR dateFirstRestr  = date(0,0,0);
   VAR dateLastRestr   = date(0,0,0);
   VAR ДатаПросрочкиОД = date(0,0,0),
       ДатаПросрочкиПроц = date(0,0,0),
       КоличествоДнейОД = 0,
       КоличествоДнейПроц = 0;
   VAR КачОбслР;  // КОД на дату последней реструктуризации
   VAR CountDelay = 0;
   VAR CurDelay = 0;    

   RSDcmd_DR = RsdCommand(RslDefCon, "begin ? := RSI_LOANS_ADDITIONAL_ALGO.GetDataRestructContract(?,?,?,?); END;");    
 
   RSDcmd_DR.addParam( "NumRestr", RSDBP_RETVAL, V_INTEGER );
   RSDcmd_DR.addParam("objid",     RSDBP_IN); RSDcmd_DR.value("objid")           = ObjectID;
   RSDcmd_DR.addParam("objn",      RSDBP_IN); RSDcmd_DR.value("objn")           = ObjectNumber;   
   RSDcmd_DR.addParam("dateFirstRestr", 3 /*RSDBP_IN_OUT*/); RSDcmd_DR.value("dateFirstRestr") = dateFirstRestr;
   RSDcmd_DR.addParam("dateLastRestr", 3 /*RSDBP_IN_OUT*/); RSDcmd_DR.value("dateLastRestr") = dateLastRestr;
   RSDcmd_DR.execute();
	
   NumRestr = RSDcmd_DR.value("NumRestr", null, V_INTEGER);  // кол-во реструктуризаций по договору
   IF(NumRestr > 0)  
     dateFirstRestr = RSDcmd_DR.value("dateFirstRestr", null, V_DATE);
     dateLastRestr =  RSDcmd_DR.value("dateLastRestr", null, V_DATE);

     // Проверим, были ли просрочки по договору за первые 360 дней с момента последней реструктуризации                      
      
      RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansUserFunction.CalcSumExpDaysOD(?,?,?,?); end;");

      RSDcmd.AddParam("expdays", RSDBP_RETVAL,   V_INTEGER);
      RSDcmd.addParam("objid",   RSDBP_IN, ObjectID);
      RSDcmd.addParam("objn",    RSDBP_IN, ObjectNumber);
      RSDcmd.addParam("calcdate",RSDBP_IN, dateLastRestr + 360);
      RSDcmd.addParam("begdate", RSDBP_IN, dateLastRestr);
      RSDcmd.execute();

      CountDelay   = RSDcmd.value("expdays", NULL, V_INTEGER);

      RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansUserFunction.CalcSumExpDaysPerc (?,?,?,?); end;");

      RSDcmd.AddParam("expdays", RSDBP_RETVAL,   V_INTEGER);
      RSDcmd.addParam("objid",   RSDBP_IN, ObjectID);
      RSDcmd.addParam("objn",    RSDBP_IN, ObjectNumber);
      RSDcmd.addParam("calcdate",RSDBP_IN, dateLastRestr + 360);
      RSDcmd.addParam("begdate", RSDBP_IN, dateLastRestr);
      RSDcmd.execute();

     CountDelay = CountDelay + RSDcmd.value("expdays", NULL, V_INTEGER);

     КачОбслР = КачествоОбслуживанияДолга (ObjectNumber, dateLastRestr);  // КОД на дату последней реструктуризации
	
     IF((NumRestr == 1) AND (RiskDate == dateFirstRestr))   //2
       IF((КачествоОбслуживания == 1) AND (ФинПоложение == 3))  //2.1
        ККС = 4;
        IF(Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
          ПроцРез = riskgr_val.DefaultPercentRate;
         END;

         VAR Msg = "Внимание! Анализ ФП должен производится за текущий и предыдущий годы";
         IF({GROUP_MODE})
           MsgBox("Договор " + ObjectNumber + "\n" + Msg + "\n");
         ELSE
           MsgBox(Msg);
         END;	
        ELIF(Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))   //2.2
		ПроцРез = riskgr_val.DefaultPercentRate;
       END;
     ELIF((NumRestr > 0) AND ((RiskDate - dateLastRestr) >= 1))  //пункт 3 и 4  
     //Так как условия 3 пункта включают условия 4, то для исправления 22700 возникшего после SCR 220739 необходимо их объеденить                
       IF( ((RiskDate - dateLastRestr) > 360) AND (CountDelay == 0))  //4 пункт
             IF((КачОбслР == 1) AND ((КачествоОбслуживания == 1) OR (КачествоОбслуживания == 2))) //4.1
               IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
                 ПроцРез = riskgr_val.DefaultPercentRate;
               END;
             ELIF((КачОбслР == 1) AND (КачествоОбслуживания == 3))    //4.2
               IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
                 ПроцРез = riskgr_val.UpperPercentLimit;
               END;
             ELIF((КачОбслР == 2) AND ((КачествоОбслуживания == 1) OR (КачествоОбслуживания == 2))) //4.3
               // Для КОД = "Среднее"           
               IF(ФинПоложение == 1)    // хорошее
                 ККС = 2;
               ELIF(ФинПоложение == 2) // среднее
                 ККС = 3;
               ELIF(ФинПоложение == 3) // Плохое
                 ККС = 4;
               END;

               IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
                 ПроцРез = riskgr_val.DefaultPercentRate;
              END;
             ELIF((КачОбслР == 2) AND (КачествоОбслуживания == 3)) //4.4
               IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
                 ПроцРез = riskgr_val.UpperPercentLimit;
               END;
             ELIF(КачОбслР == 3)        //4.5
               // Для КОД = "Неудовлетворительное"
               IF(ФинПоложение == 1)    // хорошее
                 ККС = 3;
               ELIF(ФинПоложение == 2) // среднее
                 ККС = 4;
               ELIF(ФинПоложение == 3) // Плохое
                 ККС = 5;
               END;

               IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
                 ПроцРез = riskgr_val.DefaultPercentRate;
              END;
             END;
        ELSE //3 пункт             
       // Определим, имеется ли текущая просрочка по договору
       CurDelay = CRSDCommand(
	        "SELECT Count(1) " +
                "FROM Dexpresthist_dbt e1 " +
                "WHERE  t_objn = :ObjectNumber " +
                "AND e1.T_REPAYMENTEXPDATE = TO_DATE ('01.01.0001', 'dd.mm.yyyy') " +
                        "AND e1.T_EXPDATE <= :RiskDate ",
                     "ObjectNumber", ObjectNumber, "RiskDate", RiskDate, V_INTEGER);
       
     
       IF((КачОбслР == 1) AND(КачествоОбслуживания == 1))                   //пункт 3.1
         IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
           ПроцРез = riskgr_val.DefaultPercentRate;
   	    END;        
       ELIF((КачОбслР == 1) AND ((КачествоОбслуживания == 2) OR (КачествоОбслуживания == 3))) //пункт 3.2
         IF((КачествоОбслуживания == 2)  AND (ФинПоложение == 3) AND (CurDelay > 0))   //3.2.1
                   ККС = 5;
                   IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
             ПроцРез = riskgr_val.UpperPercentLimit;
   	    END;
         ELSE
           IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))//это то что выполнится по пункут 3.2, учитывая исключения 3.2.1
             ПроцРез = riskgr_val.UpperPercentLimit;
   	    END;  
         END;
       ELIF((КачОбслР == 2) AND ((КачествоОбслуживания == 1) OR (КачествоОбслуживания == 2))) //3.3
         IF((ФинПоложение == 3) AND (CurDelay > 0))  //3.3.1
                   ККС = 5;
                   IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
             ПроцРез = riskgr_val.UpperPercentLimit;
   	      END;
         ELSE           //это то что выполнится будет по пункту 3.3,учитывая исключения 3.3.1
           // Для КОД = "Среднее"
           IF(ФинПоложение == 1)    // хорошее
                     ККС = 2;
           ELIF(ФинПоложение == 2) // среднее
                     ККС = 3;
           ELIF(ФинПоложение == 3) // Плохое
                     ККС = 4;
           END;
          
                   IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
             ПроцРез = riskgr_val.DefaultPercentRate;
   	    END;  
         END;
       ELIF((КачОбслР == 2) AND (КачествоОбслуживания == 3)) //3.4
          IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
             ПроцРез = riskgr_val.UpperPercentLimit;
   	    END; 
       ELIF(КачОбслР == 3) //3.5
          // Для КОД = "Неудовлетворительное"           
          IF(ФинПоложение == 1)    // хорошее
                     ККС = 3;
          ELIF(ФинПоложение == 2) // среднее
                     ККС = 4;
          ELIF(ФинПоложение == 3) // Плохое
                     ККС = 5;
          END;

           IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
             ПроцРез = riskgr_val.DefaultPercentRate;
   	      END;
   	      END;
         END;                    
     ELIF(NumRestr > 1)             //5
       // Получим список дат реструктуризаций договора, включая его СО                            
       RS_DateR = CRSDCommand( 
       "SELECT T_PARENT_OPDATE " +     
       "FROM (SELECT OPLNK.T_PARENT_OPID, OPLNK.T_PARENT_OPDATE " +
             "FROM dOpLink_dbt oplnk " +
             "WHERE OPLNK.T_PARENT_OBJECTTYPEID = :ObjectID " +
               "AND OPLNK.T_PARENT_OBJECTID = :ObjectNumber " +
               "AND OPLNK.T_PARENT_OPSTYPE = :CS_RESTRUCTURE " +
               "AND OPLNK.T_ISDELETED = 0 " +
             "UNION ALL " +
             "SELECT OPLNK.T_PARENT_OPID, OPLNK.T_PARENT_OPDATE " +
             "FROM dOpLink_dbt oplnk " +
             "WHERE OPLNK.T_PARENT_OBJECTTYPEID = :LO_DUTY " +
               "AND OPLNK.T_PARENT_OBJECTID IN " +
                           "(SELECT OPL.T_CHILD_OBJECTID " +
                           "FROM dOpLink_dbt opl " +
                           "WHERE OPL.T_PARENT_OBJECTTYPEID = :ObjectID " +
                             "AND OPL.T_PARENT_OBJECTID = :ObjectNumber " +
                             "AND OPL.T_PARENT_OPSTYPE =  :CS_RESTRUCTURE " +
                             "AND OPL.T_ISDELETED = 0) " +
               "AND OPLNK.T_PARENT_OPSTYPE = :CS_RESTRUCTURE " +
               "AND OPLNK.T_ISDELETED = 0) " +
       "ORDER BY t_parent_opid ASC ", 
       "ObjectID", ObjectID, "ObjectNumber", ObjectNumber, "CS_RESTRUCTURE", CS_RESTRUCTURE, "LO_DUTY", LO_DUTY, V_GENOBJ);                                      

       VAR DateRestr : date;
       VAR flagR : bool = false;

       RS_DateR.MoveNext; // пропустим первую реструктуризацию
       while(RS_DateR.MoveNext AND (flagR == FALSE))
         DateRestr = RS_DateR.value(0);
         IF(DateRestr == RiskDate)
            flagR = TRUE;
         END;
       END; 
       
       IF(flagR == TRUE)         
        var NumRestr_temp = CRSDCommand( 
                                        "select t_RESTRNUMBER " + 
                                        "from driskrestr_val_dbt where "+
                                        "t_NumberRiskGroup = :NumberRiskGroup " +
                                        "and  ROWNUM = 1 " +
                                        "ORDER BY t_RESTRNUMBER desc ",
                                        "NumberRiskGroup",ККС,
                                        V_INTEGER);
        IF (NumRestr_temp>NumRestr)
            NumRestr_temp = NumRestr;
        END;
        ПроцРез = CRSDCommand( 
               "SELECT  RISKRESTR_VAL.T_Percent " +
               "FROM driskrestr_val_dbt riskrestr_val " +
               "WHERE riskrestr_val.t_NumberRiskGroup = :NumberRiskGroup " +
               "AND riskrestr_val.t_RESTRNUMBER = :RESTRNUMBER " +
               "AND riskrestr_val.t_active_date = " +
               "      (SELECT MAX (It.t_active_date) " +
               "         FROM driskrestr_val_dbt It " +
               "         WHERE It.t_active_date <= :RepDate " +
               "               AND riskrestr_val.t_NumberRiskGroup = It.t_NumberRiskGroup " +
               "               AND riskrestr_val.t_RESTRNUMBER = It.t_RESTRNUMBER)",
               "NumberRiskGroup",ККС,
               "RESTRNUMBER",NumRestr_temp,
               "RepDate", RiskDate,
               V_DOUBLE);
       END; 
     	
       IF(ПроцРез == 0)
         MsgBox("Не установлен процент резервирования для ссуд при повторной реструктцризации!");
       END;      
     END;
   ELSE      
     IF (Loans_FindRiskGroup(ККС,riskgr,riskgr_val,RiskDate))
       ПроцРез = riskgr_val.DefaultPercentRate;/*% по умолчанию*/
     END;                    
   END;

   RSDcmd = RsdCommand(RslDefCon, "begin RSI_LOANSRESERVE.calc_kks_reservlimits_mac(?,?,?,?,?); END;");

   RSDcmd.addParam("objid",        RSDBP_IN); RSDcmd.value("objid")        = ObjectID;
   RSDcmd.addParam("objn",		 RSDBP_IN); RSDcmd.value("objn") = ObjectNumber;
   RSDcmd.addParam("calcdate",     RSDBP_IN); RSDcmd.value("calcdate")     = RiskDate;
   RSDcmd.addParam("kks_in_out",         RSDBP_IN_OUT); RSDcmd.value("kks_in_out")  = ККС;
   RSDcmd.addParam("perc_in_out",        RSDBP_IN_OUT); RSDcmd.value("perc_in_out")        = ПроцРез;
   RSDcmd.execute();
   ККС = RSDcmd.value(3, null, V_INTEGER);
   ПроцРез =  RSDcmd.value(4, null, V_INTEGER);
   RSDcmd = null;

   RETURN 0;
END;

macro РасчетКатКачБалансовогоАктива(ObjectID: integer, ObjectNumber: integer, RiskDate: date, workMode: bool)
var expsum:money, expsum1:money,
    expdate:date, expdate1:date;
   expsum  = ОстатокРегистра(ObjectID, ObjectNumber, TDR_EXPPAY_CESCRD, RiskDate);
   expsum1 = ОстатокРегистра(ObjectID, ObjectNumber, TDR_EXPKOM_SERV,   RiskDate);
   ККС = 1;
   ПроцРез = 0;

   IF (expsum != $0)
      Expdate = LnSelectValue(
      "SELECT MAX (d.t_restdate)"+
      "  FROM ddutyrest_dbt d"+
      " WHERE d.t_id_ref = "+
      "          (SELECT t_id "+
      "             FROM dlcusreg_dbt "+
      "            WHERE t_objecttypeid = "+ ObjectID +
      "              AND t_objectnumber = "+ ObjectNumber +
      "              AND t_regid = " + TDR_EXPPAY_CESCRD + ")"+
      "   AND d.t_restdate <= " +SQLDate(RiskDate) +
      "   AND d.t_restsum != 0", V_DATE);
      IF (RiskDate - Expdate> 30)
         ККС = 5;
         ПроцРез = 100.0;
      END;
   END;
   IF (expsum1 != $0)
      Expdate = LnSelectValue(
      "SELECT MAX (d.t_restdate) "+
      "  FROM ddutyrest_dbt d "+
      " WHERE d.t_id_ref = "+
      "          (SELECT t_id"+
      "             FROM dlcusreg_dbt "+
      "            WHERE t_objecttypeid = "+ObjectID+
      "              AND t_objectnumber = "+ObjectNumber+
      "              AND t_regid = " + TDR_EXPKOM_SERV + ")"+
      "   AND d.t_restdate <= " + SQLDate(RiskDate) +
      "   AND d.t_restsum != 0", V_DATE);
      IF (RiskDate - Expdate> 30)
         ККС = 5;
         ПроцРез = 100.0;
      END;
   END;
   RETURN 0;
END;

/*
   Вызывается по F6 из панели ввода группы риска и при пакетном расчёте
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   Входные параметры:
      ObjectID     - ID Вида объекта
      ObjectNumber - ID объекта
      RiskDate     - дата установки группы риска
      workMode     - режим работы(F6 / F9)
   Выходные параметры - рассчитанная группа риска.
*/

MACRO CalcRisk (ObjectID, ObjectNumber, RiskDate, workMode)
VAR
   Гр_Рmax                   = 0,
   PercResMax                = 0.0,
   ПроцРезУмолч              = 0.0,
   rs                        = 0,
   Query                     = "",
   ТипОбъекта                = 0,
   stat: bool                = true,
   RealKKC:integer           = 0,
   ПакетныйРежим             = {GROUP_MODE};

   credit_c.KeyNum = 0;
   credit_c.Rewind();
   credit_c.rec.CreditNumber = ObjectNumber;
   IF (NOT credit_c.GetEQ())
      IF (ObjectID == LO_CREDIT)
          IF (NOT {GROUP_MODE})
              MsgBox("Не найден кредитный договор: №"+ObjectNumber);
          ELSE
              MsgBox("Не найден кредитный договор: №" + ObjectNumber + "\n\n");
          END;
      ELIF (ObjectID == LO_KARTA)
          IF (NOT {GROUP_MODE})
              MsgBox("Не найдена банковская карта: №"+ObjectNumber);
          ELSE
              MsgBox("Не найдена банковская карта: №" + ObjectNumber + "\n\n");
          END;
      ELIF (ObjectID == LO_OVERDRAFT)
          IF (NOT {GROUP_MODE})
              MsgBox("Не найден договор овердрафта: №"+ObjectNumber);
          ELSE
              MsgBox("Не найден договор овердрафта: №" + ObjectNumber + "\n\n");
          END;
      ELIF ((ObjectID == LO_DOGCREDCLAIMCESSION)  or 
             (ObjectID == LO_DOGCREDCLAIMBUYBACK) or
             (ObjectID == LO_DOGCREDCLAIMBUY)     or
             (ObjectID == LO_CREDSERVDOG))
          IF (NOT {GROUP_MODE})
              MsgBox("Не найден договор цессии: №"+ObjectNumber);
          ELSE
              MsgBox("Не найден договор цессии: №" + ObjectNumber + "\n\n");
          END;
      END;
      RETURN -1;
   END;

   IF((ObjectID == LO_DOGCREDCLAIMCESSION) or 
      (ObjectID == LO_DOGCREDCLAIMBUYBACK) or
      (ObjectID == LO_DOGCREDCLAIMBUY)     or
      (ObjectID == LO_CREDSERVDOG))
      IF(РасчетКатКачБалансовогоАктива(ObjectID, ObjectNumber, RiskDate, workMode) != 0)
         RETURN -1;
      END;

      grouptmp.CalcRiskGroup = ККС;
      grouptmp.CalcPersRez   = ПроцРез;
      RETURN 0;
   END;

   Клиент = credit_c.rec.ClientID_Ref;

   /* Финансовое положение заемщика */
   IF ((ФинПоложение = ФинПоложениеЗаемщика(credit_c.rec.ClientID_Ref, RiskDate)) == 0)
      IF (workMode)
          IF (NOT {GROUP_MODE})
              MsgBox("Не определено финансовое положение заемщика!");
          ELSE
              Message = "Договор " + credit_c.rec.UsCreditNumber + "\n" + "Не определено финансовое положение заемщика.\n\n";              
              MsgBox(Message);
          END;
          RETURN -1;
      END;

      IF (NOT GetTrue(TRUE, "Не определено финансовое положение заемщика. | Продолжить?"))
         RETURN -1;
      END;
   END;

   /* Произведем расчет для текущего объекта */
   IF (РассчитатьККС(ObjectID, ObjectNumber, RiskDate, workMode) != 0)
      RETURN -1;
   END;
   /*Сохраним расчитанные значения*/
   grouptmp.CalcRiskGroup = max(ККС, CurRiskGr);
   grouptmp.CalcPersRez   = max(ПроцРез, CurPercRes);

       /* Максимальная РАСЧИТАННАЯ категория качества ссуды для КД/БК клиента  */
       Гр_Рmax    = 0;
       PercResMax = 0.0;

       credit_c.KeyNum = 6;
       credit_c.rewind();
       credit_c.rec.ClientID_Ref = Клиент;
       credit_c.rec.CreditState  = "О";
       credit_c.AddFilter("T_ClientID_Ref = " + Клиент+" AND T_CREDITNUMBER <> " + ObjectNumber+" AND T_CREDITSTATE = 'О'");
       /* Что бы не выдавать глупые сообщения */
       ПакетныйРежим  = {GROUP_MODE};
       SetLoansGroupMode(TRUE);

       WHILE (credit_c.Next())
          ObjectID = credit_c.rec.Crd_kind;
	/*Входящие в портфели договора в анализ не входят*/ 
          IF (DutyInCases(credit_c.rec.Crd_kind, credit_c.rec.CreditNumber, RiskDate, -1, -1) > 0)
             CONTINUE;
          END;

          IF (IsFromCase(credit_c.rec.Crd_kind, credit_c.rec.CreditNumber) > 0)
             CONTINUE;
          END;

          ККС     = ГруппаРиска(ObjectID, credit_c.rec.CreditNumber, REZ_RVPS, RiskDate, 0);
          /* Максимальная ККС */
          IF (ККС > Гр_Рmax)
             Гр_Рmax    = ККС;
          END;
	    
       END;

	credit_c.Rewind();   //на первую позицию и пробегаем заново для определения макс % резервирования среди договоров с макс ККС
       WHILE (credit_c.Next())
          ObjectID = credit_c.rec.Crd_kind;
	/*Входящие в портфели договора в анализ не входят*/ 
          IF (DutyInCases(credit_c.rec.Crd_kind, credit_c.rec.CreditNumber, RiskDate, -1, -1) > 0)
             CONTINUE;
          END;

          IF (IsFromCase(credit_c.rec.Crd_kind, credit_c.rec.CreditNumber) > 0)
            CONTINUE;
          END;

          ККС     = ГруппаРиска(ObjectID, credit_c.rec.CreditNumber, REZ_RVPS, RiskDate, 0);
          ПроцРез = ГруппаРиска(ObjectID, credit_c.rec.CreditNumber, REZ_RVPS, RiskDate, 1);

          IF(ККС == Гр_Рmax)
             IF (ПроцРез > PercResMax)
                PercResMax = ПроцРез;
             END;
          END;
       END;
    IF (Loans_FindRiskGroup(Гр_Рmax,riskgr,riskgr_val,RiskDate))
     ПроцРезУмолч = riskgr_val.DefaultPercentRate;/*% по умолчанию*/
   	END;
    
	IF (ПроцРезУмолч > PercResMax)
	    PercResMax = ПроцРезУмолч;
       END;

       SetLoansGroupMode(ПакетныйРежим);

       credit_c.DropFilter();

//Теперь сравниваем полученные данные по текущему договору и по остальным договорам заемщика
       IF (Гр_Рmax == grouptmp.CalcRiskGroup)
          IF (PercResMax > grouptmp.CalcPersRez)
             grouptmp.CalcPersRez = PercResMax;
          END;
          RETURN 0;
       ELIF ((grouptmp.CalcRiskGroup < Гр_Рmax) AND (Гр_Рmax > 0))
          IF (workMode)
             grouptmp.CalcRiskGroup = Гр_Рmax;
             grouptmp.CalcPersRez   = PercResMax;
             RETURN 0;
          ELSE
             IF (NOT GetTrue(TRUE, "Ссуда должна быть классифицирована не выше чем в '"+Гр_Рmax+"' категорию качества. | "+
                                   "У заемщика есть договоры с "+ Гр_Рmax + " категорией качества. | Продолжить?"))
                grouptmp.CalcRiskGroup = Гр_Рmax;
                grouptmp.CalcPersRez   = PercResMax;
                RETURN 1;
             END;
          END;
       END;
   RETURN 0;
END;

////////////////////////////////////////////////////////////////////////////////
// Определить наихудшую категорию качества для клиента данного объекта
MACRO РасчетКатегорииКачества(ВидОбъекта: integer, НомерОбъекта: integer, ДатаОперации: date)
   VAR ГруппаРиска : integer = 0,
       НомерКлиента: integer = 0;

   IF (ВидОбъекта != LO_CASE)
      НомерКлиента = LnSelectValue("SELECT T_CLIENTID_REF FROM DCREDIT_C_DBT WHERE T_CREDITNUMBER = " + НомерОбъекта, V_INTEGER);
      IF (НомерКлиента == 0)
         LoansError("Заемщик не определен!");
         RETURN FALSE;
      END;

      ГруппаРиска = LnSelectValue("SELECT MAX(T_IRISKGROUP) FROM DCRDRGHB_DBT, DCREDIT_C_DBT WHERE " +
                                            " T_OBJECTNUMBER = T_CREDITNUMBER " +
                                        " AND T_CLIENTID_REF = " + НомерКлиента +
                                        " AND T_DATE        <= " + SQLDate(ДатаОперации), V_INTEGER);
      RETURN ГруппаРиска;
   ELSE

   END;

   RETURN 0;
END;
// Формирование списка договоров
MACRO FillFileForKKS(CaseNum:integer, OperDprt:integer, OpDate:date, Restruct:integer, Exclude_Restruct:integer, SMAString:string)
   VAR RSDCmd = NULL;
BegAction(0, "Отбор договоров. Ждите...", false);
   RSDcmd = RsdCommand(RslDefCon, "begin RSI_LoansRisk.FillFileForRiskCalc(?, ?, ?, ?, ?, ?); end;");
   RSDcmd.addParam("CaseNum",  RSDBP_IN, CaseNum);
   RSDcmd.addParam("OperDprt",  RSDBP_IN, OperDprt);
   RSDcmd.addParam("OpDate",  RSDBP_IN, OpDate);
   RSDcmd.addParam("Restruct",  RSDBP_IN, Restruct);
   RSDcmd.addParam("Exclude_Restruct", RSDBP_IN, Exclude_Restruct);
   RSDcmd.addParam("SMAString",        RSDBP_IN, SMAString);   
   RSDcmd.execute();
onError()
   EndAction();
END;
