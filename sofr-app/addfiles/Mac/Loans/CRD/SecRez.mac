
IMPORT "total.mac";

macro PrintSecRezOp(EnsContractID,opdate)
var 
    EnsContractNumber = "",
    Prez              = 0,
    SCB_rez           = 0,
    SCB_bez_rez       = 0,
    SOC_CT_DO         = 0,
    SOD_PRK           = 0,
    ELRB              = 0,
    SREZ              = 0,
    rs                = NULL;

  EnsContractNumber = LnSelectValue("select t_EnsContractNumber from denscontr_dbt where t_EnsContractID = " + String(EnsContractID), V_STRING, 0);
  Prez              = LnSelectValue("select NVL(rsb_common.getregdoublevalue('RS-LOANS/èêéñÖçí_êÖáÖêÇÄ_ñÅ_ÇéÅÖëèÖóÖçàà', " + {oper} + "), 100.0) from dual", V_DOUBLE, 0);
  SCB_rez           = LnSelectValue("select " + 
                                     "   NVL(SUM( " + 
                                     "           overval.t_Sum  * " + 
                                     "           NVL(RSI_RSB_FIINSTR.ConvSum(1, obj.t_EnsObjectCur, 0, " + SQLDate(opdate) + ", 1), 1) " + 
                                     "         ), 0)  " + 
                                     "from densobj_dbt obj, decn_eob_dbt ensobj, deoverval_dbt overval,  " + 
                                     "( " + 
                                     "   select t_attrid, t_object, MAX(t_validfromdate) from dobjatcor_dbt where  " + 
                                     "   t_objecttype = 3 and t_groupid = 52  " + 
                                     "   and t_general = 'X' and t_validfromdate <= " + SQLDate(opdate) + "  " + 
                                     "   group by t_attrid, t_object " + 
                                     ") ctg " + 
                                     "where " + 
                                     "overval.t_EnsobjectID_Ref = obj.t_EnsObjectID " + 
                                     "AND obj.t_EnsObjectID = ensobj.t_EnsObjectID_Ref " + 
                                     "AND ensobj.t_EnsContractID_Ref = " + EnsContractID + 
                                     "AND ltrim(ctg.t_object(+), 0) = obj.t_Depository  " + 
                                     "AND ctg.t_attrid = 1", V_MONEY, 0);
  SCB_bez_rez       = LnSelectValue("select " +
                                     "   NVL(SUM( " +
                                     "           overval.t_Sum  * " +
                                     "           NVL(RSI_RSB_FIINSTR.ConvSum(1, obj.t_EnsObjectCur, 0, " + SQLDate(opdate) + ", 1), 1) " +
                                     "         ), 0) " +
                                     "from densobj_dbt obj, decn_eob_dbt ensobj, deoverval_dbt overval,  " +
                                     "( " +
                                     "   select t_attrid, t_object, MAX(t_validfromdate) from dobjatcor_dbt where  " +
                                     "   t_objecttype = 3 and t_groupid = 52  " +
                                     "   and t_general = 'X' and t_validfromdate <= " + SQLDate(opdate) + "  " +
                                     "   group by t_attrid, t_object " +
                                     ") ctg " +
                                     "where " +
                                     "overval.t_EnsobjectID_Ref = obj.t_EnsObjectID " +
                                     "AND obj.t_EnsObjectID = ensobj.t_EnsObjectID_Ref " +
                                     "AND ensobj.t_EnsContractID_Ref = " + EnsContractID +
                                     "AND ltrim(ctg.t_object(+), 0) = obj.t_Depository  " +
                                     "AND (ctg.t_attrid <> 1 or ctg.t_attrid is null) ", V_MONEY, 0);
  SOC_CT_DO         = LnSelectValue("select NVL(SUM( " +
                                     "               costcr.t_RatingSum * " +
                                     "               NVL(RSI_RSB_FIINSTR.ConvSum(1, costcr.t_RatingCurCode, 0, " + SQLDate(opdate) + ", 1), 1)), 0) " +
                                     "from dhcostecr_dbt costcr " +
                                     "where costcr.T_CreditNumber IN ( " +
                                     "                                 select  distinct T_CreditNumber " +
                                     "                                 from dhcostecr_dbt " +
                                     "                                 where " +
                                     "                                 t_EnsContractID = " + EnsContractID + 
                                     "                               ) " +
                                     "AND costcr.t_Date <=  " + SQLDate(opdate) + " " +
                                     "AND t_EnsContractID <> " + EnsContractID, V_MONEY, 0);
  SOD_PRK           = LnSelectValue("select NVL(SUM( " +
                                     "( " +
                                     "   LoansKernel.getregrestwithso (" + TDR_MAINREST + ", " + LO_CREDIT + ", enscrd.t_CreditNumber_Ref, " + SQLDate(opdate) + ")      + " +
                                     "   LoansKernel.getregrestwithso (" + TDR_EXPREST + ", " + LO_CREDIT + ", enscrd.t_CreditNumber_Ref, " + SQLDate(opdate) + ")       + " +
                                     "   LoansKernel.getregrestwithso (" + TDR_PAYMGUARANTEE + ", " + LO_GUARANTEE + ", enscrd.t_CreditNumber_Ref, " + SQLDate(opdate) + ") + " +
                                     "   LoansKernel.getregrestwithso (" + TDR_EXPPAYMGUARANTEE + ", " + LO_GUARANTEE + ", enscrd.t_CreditNumber_Ref, " + SQLDate(opdate) + ") " +
                                     ") * RSI_RSB_FIINSTR.ConvSum(1, crd.t_CurCode, 0, " + SQLDate(opdate) + ", 1)), 0) " +
                                     "from dens_crd_dbt enscrd, dcredit_c_dbt crd " +
                                     "where " +
                                     "crd.t_CreditNumber = enscrd.t_CreditNumber_Ref " +
                                     "AND enscrd.t_EnsContractID_Ref = " + EnsContractID, V_MONEY, 0);
  if ((SOC_CT_DO + SCB_bez_rez + SCB_rez) < SOD_PRK)
      ELRB = SCB_rez;
  else
      ELRB = (SOD_PRK * SCB_rez) / (SOC_CT_DO + SCB_bez_rez + SCB_rez);
  end;

  SREZ = ELRB * Prez / 100;

  SCB_rez     = Round(SCB_rez, 2);
  SCB_bez_rez = Round(SCB_bez_rez, 2);
  SOC_CT_DO   = Round(SOC_CT_DO, 2);
  SOD_PRK     = Round(SOD_PRK, 2);
  SREZ        = Round(SREZ, 2);

[  ê†·Á•‚ ·„¨¨Î ‡•ß•‡¢† ØÆ Ê•≠≠Î¨ °„¨†£†¨ ¢ Æ°•·Ø•Á•≠®® ØÆ ÑÆ£Æ¢Æ‡„ Æ°•·Ø•Á•≠®Ô ####################  ](EnsContractNumber:l);
[ ];
[ ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒø ];
[ ≥    ù´•¨•≠‚ ê†·Á•‚≠Æ© °†ßÎ    ≥       á≠†Á•≠®•       ≥ Ç†´ ≥ ];
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥ ];
[ ≥ éÊ•≠ÆÁ≠†Ô ·‚Æ®¨Æ·‚Ï Ê°  -    ≥                      ≥ ‡„° ≥ ];
[ ≥ ≠•≠†§•¶≠Î© §•ØÆß®‚†‡®©       ≥ #################### ≥     ≥ ](String(SCB_rez):r);
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥ ];
[ ≥ éÊ•≠ÆÁ≠†Ô ·‚Æ®¨Æ·‚Ï §‡„£®Â   ≥                      ≥ ‡„° ≥ ];
[ ≥ Æ°Í•™‚Æ¢ Æ°•·Ø•Á•≠®Ô         ≥ #################### ≥     ≥ ](String(SCB_bez_rez+SOC_CT_DO):r);
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥ ];
[ ≥ Å†´†≠·Æ¢†Ô ·‚Æ®¨Æ·‚Ï         ≥                      ≥     ≥ ];
[ ≥ ‡†ß¨•È•≠≠ÎÂ ·‡•§·‚¢          ≥ #################### ≥ ‡„° ≥ ](String(SOD_PRK):r);
[ ≥ Æ·≠Æ¢≠Æ£Æ §Æ£Æ¢Æ‡†           ≥                      ≥     ≥ ];
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥ ];
[ ≥ è‡ÆÊ•≠‚ ‡•ß•‡¢®‡Æ¢†≠®Ô       ≥ #################### ≥     ≥ ](String(Prez):r);
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥ ];
[ ≥ ù´•¨•≠‚ ‡†·Á•‚≠Æ© °†ßÎ       ≥ #################### ≥ ‡„° ≥ ](String(ELRB):r);
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥ ];
[ ≥ ê•ß•‡¢ ØÆ ñÅ                 ≥ #################### ≥ ‡„° ≥ ](String(SREZ):r);
[ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒŸ ];
[                                                                                         ];
[é°Í•™‚Î, ØÆ ™Æ‚Æ‡Î¨ ¢ÎØÆ´≠Ô´·Ô ‡†·Á•‚:                                                   ];
  rs = LnGetRecordSet("select t2.t_enscontractnumber, SUBSTR(MAX(path),2) " +
                       "from " +
                       "( " +
                       "    select t.*, sys_connect_by_path(t.t_ensobjectname,', ') as path " +
                       "    from " +
                       "    ( " +
                       "        select " +
                       "        ensure.*, LAG (ensure.t_EnsObjectID) OVER(partition by ensure.t_EnsContractID order by ensure.t_EnsContractID) prev " +
                       "        from " +
                       "        ( " +
                       "               select ensc.t_EnsContractID, ensc.t_enscontractnumber,  obj.t_EnsObjectID, obj.t_ensobjectname " +
                       "               from dhcostecr_dbt costcr, denscontr_dbt ensc, densobj_dbt obj, decn_eob_dbt ensobj " +
                       "               where costcr.T_CreditNumber IN ( " +
                       "                                                select  distinct T_CreditNumber " +
                       "                                                from dhcostecr_dbt " +
                       "                                                where " +
                       "                                                t_EnsContractID = " + EnsContractID +
                       "                                              ) " +
                       "               AND costcr.t_Date <=  " + SQLDate(opdate) + " " +
                       "               AND ensc.t_EnsContractID = costcr.t_EnsContractID " +
                       "               AND obj.t_EnsObjectID = ensobj.t_EnsObjectID_Ref " +
                       "               AND ensobj.t_EnsContractID_Ref =  costcr.t_EnsContractID " +
                       "               order by ensc.t_EnsContractID " +
                       "        ) ensure " +
                       "    )  t " +
                       "    CONNECT BY PRIOR t.t_EnsObjectID = t.prev " +
                       "    START WITH t.prev is NULL " +
                       "    order by 1 " +
                       ") t2 " +
                       "GROUP BY t2.t_enscontractnumber " +
                       "order by 1 ", NULL);
  if (rs != NULL)
      while (rs.MoveNext)
          [ÑÆ£Æ¢Æ‡ Æ°•·Ø•Á•≠®Ô: ####################                                                ](String(rs.value(0, null, V_STRING)):l);
          [é°Í•™‚Î Æ°•·Ø•Á•≠®Ô ØÆ ÑÆ£Æ¢Æ‡„ Æ°•·Ø•Á•≠®Ô: ########################################### ](String(rs.value(1, null, V_STRING)):l);
          [                                                                                         ];
      end;
  end;

[                                                                                         ];

  rs = LnGetRecordSet("select t2.t_CreditNumber, SUBSTR(MAX(path),2) " +
                       "from " +
                       "( " +
                       "    select t.*, sys_connect_by_path(t.t_UsCreditNumber,', ') as path " +
                       "    from " +
                       "    ( " +
                       "        select " +
                       "        ensure.*, LAG (ensure.t_CreditNumber) OVER(partition by ensure.t_EnsContractID_Ref order by ensure.t_EnsContractID_Ref) prev " +
                       "        from " +
                       "        ( " +
                       "            select enscrd.t_EnsContractID_Ref, crd.t_CreditNumber, crd.t_UsCreditNumber  " +
                       "            from dens_crd_dbt enscrd, dcredit_c_dbt crd " +
                       "            where " +
                       "            crd.t_CreditNumber = enscrd.t_CreditNumber_Ref " +
                       "            AND enscrd.t_EnsContractID_Ref = " + EnsContractID +
                       "        ) ensure " +
                       "    )  t " +
                       "    CONNECT BY PRIOR t.t_CreditNumber = t.prev " +
                       "    START WITH t.prev is NULL " +
                       "    order by 1 " +
                       ") t2 " +
                       "GROUP BY t2.t_CreditNumber " +
                       "order by 1", NULL);

  if (rs != NULL)
      while (rs.MoveNext)
          [é·≠Æ¢≠Î• §Æ£Æ¢Æ‡Î, ØÆ ™Æ‚Æ‡Î¨ ‡†ß¨•È•≠Î ·‡•§·‚¢†: ########################################### ](String(rs.value(1, null, V_STRING)):l);
      end;
  end;
end;
