/*
 ╔═════════════════════════════════════════════════════════════════════════════════╗
 ║ Операция   : Признание доходов 302-П                                            ║
 ║ Шаг        : №8 Учет просроченных комиссий                                      ║
 ╟─────────────────────────────────────────────────────────────────────────────────╢
 ║ Программист: TFS                                                                ║
 ║ Дата       : 20.11.2007                                                         ║
 ╚═════════════════════════════════════════════════════════════════════════════════╝ */

import recognize;

RECORD ШагОперации ("step_op.dbt",  "loans.def"); // Запись шага операции
RECORD Документ    ("doc_acc.dbt",  "loans.def"); // Буфер документа
RECORD Операция    ("crd_op.dbt",   "loans.def"); // Операция по договору
RECORD Договор     ("credit_c.dbt", "loans.def");
RECORD Сумма       ("SUM.",         "loans.def");

MACRO ВыполнитьШаг (OperDate, Sum, Data)
   VAR stat : integer = 0,
       DocID: integer = 0,
       ОстПр:   money =$0,
       ОстУб:   money =$0,
       СумКомис:money =$0;

   IF ((Договор.Crd_kind != LO_CREDIT) AND (Договор.Crd_kind != LO_GUARANTEE) AND (Договор.Crd_kind != LO_GENAGGR))
      RETURN 0;
   END;

   Документ.CarrySum = СуммаТребованийПоКомиссии_302(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, OperDate, Договор);
   ЗаполнитьСчета(Операция.ObjectTypeID_Ref, OperDate, Документ, ШагОперации);

   stat = СоздатьДокумент(Документ, DocID);

   RETURN stat;
END;