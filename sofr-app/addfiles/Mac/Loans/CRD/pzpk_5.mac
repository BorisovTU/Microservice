/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pzpk_5.mac
 Description : Создание документа по шагу операции (Погашение доначисленных % (опред. доход))

 Programmer  : Zigel Petr
 07.10.08    : Создан
-----------------------------------------------------------------------------------*/

import macperc, SbCrdInter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var DocID:integer = 0;
   var stat :integer = 0;
   var ObjK, ObjN, CrdK, CrdN;

   var sum_ds_addperc : money = $0;

   var PercChargeType = "";

   ObjK = Операция.ObjectTypeID_Ref;
   ObjN = Операция.ObjectID_Ref;
   CrdK = Договор.Crd_kind;
   CrdN = Договор.CreditNumber;

   SetBuff (DutyData, Data);  
   Документ.InDocID = DutyData.PaymentID;

   if (not GetPercChargeType (ObjK, ObjN, PercChargeType))
      MsgBox("Ошибка получения значения: НАЧИСЛ_ПРОЦ_ПЕРЕД_ОПЛАТОЙ");
      return 1;
   end;

   if (НадежныйДоговор (CrdN, CrdK, OperDate) and 
       (StrUpr(trim(PercChargeType)) != "ON")) 

      Документ.CarrySum = min(GetPaySum (DS_PERC, ObjK, ObjN)- abs (GetPaySum (DS_SUPERFLUOUS_PERC, ObjK, ObjN)),getPaymentField(DS_PERC,6, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref ));
      stat = СоздатьДокумент (Документ, DocID);
   end;

   return stat;
end;
