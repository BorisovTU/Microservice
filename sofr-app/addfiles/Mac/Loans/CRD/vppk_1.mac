/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : vppk_1.mac
 Description : Создание документа по шагу операции (Учет просроченной задолженности)

 Programmer  : Zigel Petr
 2008-10-09  : Создан
 2009-08-19  : (Manushkina E.V.) Учет переплаты процентов по 302 П
-----------------------------------------------------------------------------------*/
import macperc, sbcrdinter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var stat = 0;
   var DocID = 0;
   var ObjK, ObjN, CrdK, CrdN;

   var sum_ds_perc : money = $0;      
   var Sт1, Sнс1, Sод, Sпт, Sппт;
   var Concession: date;

   ObjK = Операция.ObjectTypeID_Ref;
   ObjN = Операция.ObjectID_Ref;
   CrdK = Договор.Crd_kind;
   CrdN = Договор.CreditNumber;

   SetBuff(DutyData, Data);
  
   Concession = LnSelectValue("select t_concession from dasgmtparm_dbt where t_creditnumber = " + LastBindedCess(ObjK, ObjN), V_DATE);
   
   Sт1 = ОстатокРегистра(CrdK, CrdN, TDR_ACQCRD, Concession);
   Sнс1 = ОстатокРегистра(CrdK, CrdN, TDR_PRICE_CRD, Concession);
   Sод = GetPaySum(DS_DUTY,ObjK, ObjN);

   if (GetUnderPaySum (DS_PERC, ObjK, ObjN) < 0)
      sum_ds_perc = GetCalcSum (DS_PERC, ObjK, ObjN);
   else
      sum_ds_perc = GetPaySum (DS_PERC, ObjK, ObjN);
   end;
   Sпт  = ОстатокРегистра(ObjK, ObjN, TDR_PERC_ACQCRD, OperDate);
   Sппт = min (sum_ds_perc, Sпт);
   
   if (Sнс1 != $0)
      Документ.CarrySum = (Sод + Sппт) * Sт1/ Sнс1;
      stat = СоздатьДокумент(Документ, DocID);
      if(stat == 0)
         stat = ИзменитьРегистр(ObjK, ObjN, TDR_MAINREST,    DocID, -Sод,  Операция.CredOperID);
      end;
      if(stat == 0)
         stat = ИзменитьРегистр(ObjK, ObjN, TDR_EXPREST,     DocID,  Sод,  Операция.CredOperID);
      end;
      if(stat == 0)
         stat = ИзменитьРегистр(ObjK, ObjN, TDR_CLAIM,       DocID, -Sппт, Операция.CredOperID);
      end;
      if(stat == 0)
         stat = ИзменитьРегистр(ObjK, ObjN, TDR_PERC_ACQCRD, DocID, -Sппт, Операция.CredOperID);
      end;
      if(stat == 0)
         stat = ИзменитьРегистр(ObjK, ObjN, TDR_EXPPERC,     DocID, Sппт,  Операция.CredOperID);
      end;
      if(stat == 0)
         stat = ИзменитьРегистр(ObjK, ObjN, TDR_EXPPERC_ACQ, DocID, Sппт,  Операция.CredOperID);
      end;
   end;
   return stat;
END;
