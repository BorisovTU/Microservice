/*--------------------------------------------------------------------------------------
Filename    : rsbus_GetFactDutyPayments.mac                                             
Description : реализация сервиса формирования данных по погашениям
24.09.13    : Создан
Programmer  : Shershnev Victor
--------------------------------------------------------------------------------------*/
import SbCrdInter, TOTAL, RSBUS_STRUCTS, RSBUS_CHECK,"rsbus_checkusr.mac";
//номер сервиса согласно списоку сервисов описананых в rsbus_checkusr.mac
private const NumServ:integer = NumServ_GetFactDutyPayments;

record credContr(credit_c);
private var credID:integer, usCreditNumber:string, pDateDebt:date, pBeginDate:date, pEndDate:date, pTypeOperList:TArray , pReportType:integer;

class TFactDutyDetail   
   var DutyStageId: integer;
   var DutyStageName: string;
   var ClaimSum: money;
   var ActualAmount: money;
   var Underpaysum: money;
   var Calcenddate: date;

end;

class TOperDutyDetail  
   var CredOperId: integer;
   var CredOperDate: date;
   var OperTypeNumber: integer;
   var OperDutySum: money;
   var FactDutyList: TArray = TArray(TFactDutyDetail);

end;

class TFactDuty 
   var OperDutyTotalSum: money;
   var OperDutyCount: integer;
   var OperDutyList: TArray = TArray(TOperDutyDetail);
end;


 var FactDuty:TFactDuty;

macro Check(CheckFlag:bool):bool
   var rs, RSDCmd;
   FindCrd(@credID, usCreditNumber, credContr);
   IF ((pBeginDate ==NULL) OR (pBeginDate ==""))

      pBeginDate = CRsdCommand ("SELECT t_CredOperDate FROM dcrd_op_dbt WHERE T_OBJECTTYPEID_REF = ?"+
                                   " AND T_CREDITNUMBER_REF =? AND T_SYSTEMOPERATIONID = ? " +
                                   " AND T_STAGEID_REF = ? AND T_ISDELETED = ? AND T_CORRECTOPERATION = ?"+
                                   " AND T_OPERATIONTYPE not like ?  AND T_OPERATIONTYPE not like ?" ,
                                     "p1", LO_CREDIT,
                                     "p2", credID,
                                     "p3", CS_NEWCRD,
                                     "p4", CF_COMPLIT,
                                     "p5", 0,
                                     "p6", 0,
                                     "p7", "И",
                                     "p8", "С",
                                      V_DATE);
      END;

   if (pTypeOperList) //Если массив задан
      var chr = " ";
      var i = 0;  
      while(i < pTypeOperList.size)

          RSDCmd  = CRsdCommand ("SELECT  * FROM dtype_op_dbt  WHERE T_SYSTTYPEOP_REF = ?"+
                                 " AND T_TYPEOPERNUMBER  = ? AND T_ISHIDEFROMSCROLL = chr(0)",
                                 "p1", CS_DUTY,
                                 "p2", pTypeOperList[i],
                                  V_GENOBJ);
      IF (not RSDCmd.MoveNext)
        RunError("Недопустимый вид операции "+pTypeOperList[i], 18767  );  
      END;

      i=i+1;

      end;
   end;
       
   IF ((pBeginDate ==NULL) OR (pBeginDate =="")) //Если не нашли дату , то берём дату из КД
          pBeginDate = credContr.RegDate;
   end;
 
   IF ((pEndDate  ==NULL) OR (pEndDate  ==""))
     pEndDate={curdate};
   END;

   IF (pReportType ==NULL)
      pReportType =0;
   END;
   IF ((pReportType != 0) AND (pReportType != 1))
      RunError("Неизвестный тип выписки", 18594 );
   END;
 

end;

Macro FillData()    
   var i = 0;
   var j = 0;
   var k = 0; 
   var prevCredoperId = 0;
   var rs, RSDCmd;  
   FactDuty=TFactDuty();
   FactDuty.OperDutyTotalSum = $0;
   FactDuty.OperDutyCount =0;
   FactDuty.OperDutyList = TArray();


   var query: string="";
    i = 1;
  if ((pTypeOperList) AND (pTypeOperList.size > 0))
      query = pTypeOperList[0];
      while (i < pTypeOperList.size)
       query = query + "," + pTypeOperList[i];
       i = i + 1;
      end;

      RSDCmd  = CRsdCommand ("SELECT COUNT (DISTINCT pln.T_CREDOPERID_REF) OVER (), sum(PLN.t_actualamount)  OVER(),  sum(PLN.t_actualamount) over (PARTITION by PLN.t_credoperid_ref), op.*, pln.*"+
                             " FROM dcrd_op_dbt op, dplanfact_dbt pln WHERE t_creditnumber = ?"+
                               " AND op.t_credoperdate BETWEEN (?) AND (?)"+
                               " AND op.T_SYSTEMOPERATIONID= ? "+
                               " AND op.T_OPERTYPENUMBER_REF IN (" +query + ") "+
                               " AND op.t_CredOperID=pln.T_CREDOPERID_REF AND pln.t_actualamount != 0" +
                               " ORDER BY op.t_CredOperID ",
                               "p1", credID,
                               "p2", pBeginDate,
                               "p3", pEndDate,
                               "p4", CS_DUTY,
                               "p5",query,
                                V_GENOBJ);


    else  ///Если массив не задан
         RSDCmd  = CRsdCommand ("SELECT COUNT (DISTINCT pln.T_CREDOPERID_REF) OVER (), sum(PLN.t_actualamount)  OVER(),  sum(PLN.t_actualamount) over (PARTITION by PLN.t_credoperid_ref), op.*, pln.*"+
                             " FROM dcrd_op_dbt op, dplanfact_dbt pln WHERE t_creditnumber = ?"+
                               " AND op.t_credoperdate BETWEEN (?) AND (?)"+
                               " AND op.T_SYSTEMOPERATIONID= ? "+
                               " AND op.t_CredOperID=pln.T_CREDOPERID_REF AND pln.t_actualamount != 0" +
                               " ORDER BY op.t_CredOperID ",
                               "p1", credID,
                               "p2", pBeginDate,
                               "p3", pEndDate,
                               "p4", CS_DUTY,
                                V_GENOBJ);

   end;
  
   while (RSDCmd.MoveNext)
                 
           FactDuty.OperDutyCount = RSDCmd.value(0);
           FactDuty.OperDutyTotalSum =RSDCmd.value(1);
           //Если CredoperId уникальный то создаём объект
           if(prevCredoperId != RSDCmd.value(3))
              var OperDutyDetail:TOperDutyDetail;
              OperDutyDetail = TOperDutyDetail();

              OperDutyDetail.CredOperId= RSDCmd.Value("t_CredOperId", null, V_INTEGER);
              OperDutyDetail.CredOperDate =RSDCmd.Value("t_CredOperDate", null, V_DATE); 
              OperDutyDetail.OperTypeNumber = RSDCmd.Value("t_OperTYpeNumber_Ref", null, V_INTEGER); 
              OperDutyDetail.OperDutySum =  RSDCmd.value(2);
              OperDutyDetail.FactDutyList = TArray();
              FactDuty.OperDutyList[j] =OperDutyDetail;
              j=j+1;  
              k=0; 

              prevCredoperId = RSDCmd.value(3);
           end;

           var FactDutyDetail:TFactDutyDetail;
           FactDutyDetail = TFactDutyDetail();
           FactDutyDetail.DutyStageId  =RSDCmd.Value("t_DutystageId_ref", null, V_INTEGER);

           IF (pReportType==1)
              FactDutyDetail.DutyStageName = CRsdCommand ("SELECT NVL(DUTY.T_DUTYSTAGENAME, chr(1))"+
                             " FROM ddutstage_dbt duty"+
                               " WHERE DUTY.T_DUTYSTAGEID = ?",
                               "p1", FactDutyDetail.DutyStageId,
                                 V_STRING);
           ELSE
                FactDutyDetail.DutyStageName ="";
           END; 
           FactDutyDetail.ClaimSum   =RSDCmd.Value("t_ClaimSum", null, V_MONEY);
           FactDutyDetail.ActualAmount =RSDCmd.Value("t_ActualAmount", null, V_MONEY);
           FactDutyDetail.Underpaysum  =RSDCmd.Value("t_UnderpaySum", null, V_MONEY);
           FactDutyDetail.Calcenddate  =RSDCmd.Value("t_CalcEndDate", null, V_DATE);
           OperDutyDetail.FactDutyList[k] = FactDutyDetail;
           k=k+1;
       end;
end;

Macro GetFactDutyPayments (creditId:integer, CreditNumber:string, BeginDate:date,    EndDate:date, TypeOperList:TArray, ReportType:integer)

   credID      = creditID;
   usCreditNumber  = CreditNumber;
   pBeginDate = BeginDate;
   pEndDate = EndDate;
   pReportType = ReportType;
   pTypeOperList=TypeOperList;
       
   Check();
   
   // Если нужно, то проверим пользовательской функцией
   if(NOT skip_user_chec.UpdateAccountRollback)
      if(NOT GetFactDutyPaymentsUserCheck(NumServ, credContr,BeginDate,EndDate,TypeOperList))
         return 0;
      end;
   end;
   FillData();
   return FactDuty;

END;   

