/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : op_dut.mac
 Description : Создание документа по шагу открытие обязательства

 Programmer  : ROV
 16.07.98    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record Сумма       ("SUM."        , "loans.def");

PRIVATE VAR acc_mac = TBFile ("acc_mac.tmp", "r", 0);

private var {curdate};

MACRO ВыполнитьШаг (OperDate, Sum, Data)
   var DocID : integer = 0;
   var stat  : integer = 0;

   SetBuff(Сумма, Sum);
   /* До востребования */
   IF (Договор.PayType != CF_POSTERESTANTE)
      RETURN 0;
   END;

   acc_mac.Rewind();
   acc_mac.AddFilter("T_AccCategID = " + CRD_ACC);

   WHILE (acc_mac.Next())
      Документ.CarrySum = Сумма(0); //ОстатокРегистра(LO_CREDIT, Операция.CreditNumber_Ref, TDR_MAINREST, {curdate});
      Документ.Debit    = acc_mac.rec.AccountNumber;
      stat = СоздатьДокумент(Документ, DocID);
      IF (stat == 0)
         stat = ИзменитьРегистр(LO_CREDIT, Операция.CreditNumber_Ref, TDR_MAINREST, DocID, -Документ.CarrySum);
      END;
   END;
   acc_mac.DropFilter();

   RETURN stat;
END;