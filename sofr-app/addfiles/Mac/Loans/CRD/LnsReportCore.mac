/*
$Name: lnsreportcore.mac
$Module: WebLoans
$Description: Ядро механизма печатных форм
*/
IMPORT SbCrdInter, BankInter, RsbDataSet, RsbFormsInter, ServiceAction, XmlRpcInter, globals, FIInter;
IMPORT "ws_file.mac", "ws_common.mac", "ws_report.mac", "total.mac";

CONST
    repParmType_Date = 1,
    repParmType_Sum = 2,
    repParmType_Num = 3,
    repParmType_Str = 4,
    repParmType_CheckBox = 5,
    repParmType_Classificator = 6;

CONST
    repIFACEMODE_NOPANEL  = 0,
    repIFACEMODE_SYSPANEL = 1,
    repIFACEMODE_USRPANEL = 2;

CLASS CLnsReportUISession()
    var UISessionID = CreateGUID();
    var UISessionForm = NULL;
    var UISessionParm = NULL; // для веб - если отдаем на клиент, то NULL
END;

CLASS CLnsReportTemplate
    var ObjID         = 0;
    var SysOpID       = 0;
    var TemplateID    = 0;
    var ObjN          = 0;
    var UserParm      = NULL; // для веб - сериализованные параметры в виде строки или NULL
    var UISession     = NULL;
    var ReportFile    = NULL;
END;

MACRO LnsReportMsgBox(_msg)
    RunError(_msg);
END;

PRIVATE MACRO LnsPrintReport(TemplateParm)
  var
      qStr = "", rs = NULL, report = NULL;

    qStr = "select t_macroname from dlrsprtml_dbt where t_templateid = " + TemplateParm.TemplateID;
    rs = TRsbDataSet(qStr);
    if (rs.moveNext())
        if (FromWebService)
            report = ExecMacroFile(rs.macroname, "RunReportWeb", TemplateParm);
        else
            report = ExecMacroFile(rs.macroname, "RunReportEW", TemplateParm);
        end;
    else
        RunError("Не найден шаблон отчета с номером = " + String(TemplateParm.TemplateID));
    end;

    return report;

    OnError(err)
        RunError();
END;

PRIVATE MACRO LnsGenerateReport(TemplateParm)
    if (TemplateParm == NULL)
        RunError("ошибка при получении параметров отчета.");
    end;

    TemplateParm.ReportFile = LnsPrintReport(TemplateParm);
    TemplateParm.UserParm = NULL;
    TemplateParm.UISession = NULL;

    return TemplateParm;
END;

PRIVATE MACRO LnsGenRepParmPanel_usr(TemplateParm)
  var
      qStr = "", rs = NULL, panel = NULL;

    qStr = "select t_macroname from dlrsprtml_dbt where t_templateid = " + TemplateParm.TemplateID;
    rs = TRsbDataSet(qStr);
    if (rs.moveNext())
        if (FromWebService)
            panel = ExecMacroFile(rs.macroname, "LnsGenRepParmPanelWeb", TemplateParm);
        else
            panel = ExecMacroFile(rs.macroname, "LnsGenRepParmPanelEW", TemplateParm);
        end;
    else
        RunError("Не найден шаблон отчета с номером = " + String(TemplateParm.TemplateID));
    end;

    return panel;
END;

MACRO LnsPrintReportForTemplate(TemplateParm)
  var
      qStr = "", rs = NULL, next_ui = NULL; 

    qStr = 
        "select * from DLROBJTML_DBT objtml, DLRSPRTML_DBT tml " +
        "where " +
        "objtml.t_ObjectID = " + String(TemplateParm.ObjID) + 
        "and objtml.t_SystemOperationID = " + String(TemplateParm.SysOpID) + 
        " and tml.t_TemplateID = objtml.t_TemplateID " +
        " and tml.t_TemplateID = " + String(TemplateParm.TemplateID) +
        " and T_ISVISIBLE = 'X' AND T_ISUSEINWEB = 'X'";

    rs = TRsbDataSet(qStr);
    if (rs.MoveNext)
        if (FromWebService)
            InstLoadModule("LnsReportWeb.mac");
        else
            InstLoadModule("LnsReportEW.mac");
        end;

        if (ValType(TemplateParm.UISession) != V_UNDEF)
            if (rs.T_IFACEMODE == repIFACEMODE_SYSPANEL)
                TemplateParm = LnsGenerateReport(ExecMacro2("LnsTemplateParmSerialize_sys", TemplateParm));
            elif (rs.T_IFACEMODE == repIFACEMODE_USRPANEL)
                next_ui = LnsGenRepParmPanel_usr(TemplateParm);
                if (next_ui == NULL)
                    TemplateParm = LnsGenerateReport(TemplateParm);
                else
                    TemplateParm.UISession = next_ui;
                end; 
            else
                TemplateParm = LnsGenerateReport(TemplateParm);
            end;
        else
            TemplateParm.ReportFile == NULL;

            if (rs.T_IFACEMODE == repIFACEMODE_SYSPANEL)
                TemplateParm.UISession = ExecMacro2("LnsGenRepParmPanel_sys", TemplateParm.TemplateID);
            elif (rs.T_IFACEMODE == repIFACEMODE_USRPANEL)
                TemplateParm.UISession = LnsGenRepParmPanel_usr(TemplateParm);
            else
                TemplateParm.UISession == NULL;
            end;

            if ((ValType(TemplateParm.UISession) == V_UNDEF)OR(ValType(TemplateParm.UISession.UISessionForm) == V_UNDEF))
                if (rs.T_IFACEMODE == repIFACEMODE_SYSPANEL)
                    TemplateParm = LnsGenerateReport(ExecMacro2("LnsTemplateParmSerialize_sys", TemplateParm));
                else
                    TemplateParm = LnsGenerateReport(TemplateParm);
                end;
            end;
        end;
    else
        RunError("Не найден шаблон отчета с номером = " + String(TemplateParm.TemplateID));
    end;

    if ((TemplateParm.UISession == NULL) and (TemplateParm.ReportFile == NULL))
        RunError("Отчёт не реализован в текущей версии системы.");
    end;

    return TemplateParm;
END;