/*
$Name:             dogzlg01.mac
$Module:           Кредитование
$Description:      Договор залога дома и земельного участка
*/
import lclient, ActiveX, total, replib, dlwreps, replib;

private record enscontract("enscontr.dbt", "loans.def");
private file   ensobject  ("ensobj.dbt",   "loans.def");
private file   credit_c   ("credit_c.dbt", "loans.def");
private file   claim      ("claim.dbt",    "loans.def");
private record cur_credit ("credit_c", "loans.def");

private const TemplateName = "dogzlg01.dot";
private var   ensPerson    = TloansClient;
private var   enscrd = TBFile ("ens_crd.dbt",  "r", 0);
private var   ecneob = TBFile ("ecn_eob.dbt",  "r", 0);

macro RunReport(EnsContrBuf)

      var axerr:object = null, ФИОКонтрагента, ФИОЗаемщика, ПроцОД, ExtCurCode;

      SetBuff(ensContract, EnsContrBuf);
      if (not ensPerson.GetRecord(ensContract.EnsContractPersonID_Ref))
          RunError ("Не найден контрагент в справочнике клиентов");
      end;

      enscrd.AddFilter("t_EnsContractID_Ref = " + enscontract.EnsContractID);
      enscrd.rewind;
      enscrd.next;
      enscrd.DropFilter();

      ClearRecord(credit_c);
      credit_c.CreditNumber = enscrd.rec.CreditNumber_Ref;
      if (GetEQ(credit_c))
         if (not depclnt.GetRecord(credit_c.ClientID_Ref))
             RunError ("Не найден контрагент в справочнике клиентов");
         end;
      else
         ClearRecord(claim);
         claim.ClaimID = enscontract.ClaimID_Ref;
         if (GetEQ(claim))
            if (not depclnt.GetRecord(claim.LoanerID_Ref))
                RunError ("Не найден контрагент в справочнике клиентов");
            end;
         else
            RunError ("Не найден кредитный договор или кредитная заявка| для договора обеспечения");
         end;
      end;

      if (ensperson.LegalForm != 2)
          RunError ("Печатная форма предназначена для формирования | по договорам обеспечения физических лиц");
      end;

      ecneob.AddFilter("t_EnsContractID_Ref = " + enscontract.EnsContractID);
      ecneob.rewind;
      ecneob.next;
      ecneob.DropFilter();

      ClearRecord (EnsObject);
      EnsObject.EnsObjectID       = ecneob.rec.EnsObjectID_ref;
      if (NOT (GetEQ (EnsObject)))
         if (not GetTrue(false, "Не найден объект обеспечения. Данные по объекту обеспечения |не будут выведены в печатную форму. Продолжить?"));
             return false;
         end;
      end;

      ФИОЗаемщика    = depclnt.ConvertFIOFull();
      ФИОКонтрагента = ensPerson.ConvertFIOFull();
      /* % ставка */
      ПроцОД = Loans_FindRateVal(LO_CREDIT, credit_c.CreditNumber, TRU_CRD, EnsContract.EnsContractFirstDate);
      /* Код валюты 810 - рубли, 840 - USD и т.д.*/

      SetOutput (GetTxtFileName("dogzlg01_rep"));
      
      println(TemplateName); //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа

      /* № договора залога */
      [~EnsNum];
      println (EnsContract.EnsContractNumber);
      /* Дата договора залога */
      [~DateOp];
      println (DateToStringFull (EnsContract.EnsContractFirstDate));
      /* ФИО залогодателя (контрагента) */
      [~FioZalog];
      println (ФИОКонтрагента);
      /* Дата рождения залогодателя (контрагента) */
      [~BornDateZalog];
      println (DateToStringShort (DepClnt.Born));
      /* Серия паспорта залогодателя (контрагента) */
      [~PasportSeriesZalog];
      println (DepClnt.PaperSeries);
      /* № паспорта залогодателя (контрагента) */
      [~PasportNumberZalog];
      println (DepClnt.PaperNumber);
      /* Дата выдачи, выдавшее учреждение */
      [~PasportDateZalog];
      println (DepClnt.PaperIssuer + " " + DepClnt.PaperIssuedDate);
      /* Адрес проживание залогодателя (контрагента) */
      [~AddressZalog];
      println (DepClnt.AddressF);
      /* № кредитного договора */
      [~CrdNum];
      println (credit_c.UsCreditNumber);
      /* Дата кредитного договора */
      [~RegDate];
      println (DateToStringFull (credit_c.RegDate));
      /* Целевое назначение кредита (вид кредита) */
      [~Target];
      println (FindTypeCrd (credit_c.CreditTypeID_Ref));
      /* Сумма кредитного договора */
      [~Sum];
      println (credit_c.CreditSum);
      /* Сумма прописью кредитного договора */
      [~StrSum];
      println (RubToStr (credit_c.CreditSum));
      /* Дата окончания кредитного договора */
      [~ReturnDate];
      println (DateToStringFull (credit_c.ReturnDate));
      /* % ставка по основному долгу */
      [~Percent];
      println (ПроцОД);
      /* День выноса на просрочку */
      [~ExpDay];
      println (GetArrearDate(LO_CREDIT, credit_c.CreditNumber, credit_c.CurCode, 0));
      /* Сумма ежемесячного платежа договора */
      [~SumPay];
      println (СуммаЕдиновременногоПлатежа (LO_CREDIT, credit_c.CreditNumber));
      [~StrSumPay];
      println (RubToStr (СуммаЕдиновременногоПлатежа (LO_CREDIT, credit_c.CreditNumber)));
      /* Адрес объекта */
      [~Address];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 135));
      /* № договора купли-продажи дома */
      [~NumContract];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 149));
      /* Дата договора купли-продажи дома */
      [~DateContract];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 150));
      /* ФИО продавца по договору купли-продажи дома */
      [~FioSeller];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 151));
      /* ФИО покупателя по договору купли-продажи дома (заёмщика) */
      [~FioZaem];
      println (ФИОЗаемщика);
      /* Дата регистрационной записи в реестре (дом) */
      [~DateReg];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 152));
      /* Регистрационный № договора купли-продажи дома */
      [~RegNum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 153));
      /* Серия свидетельства о регистрации (дом) */
      [~EvidenceSeries];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 154));
      /* № свидетельства о регистрации (дом) */
      [~EvidenceNum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 155));
      /* Дата свидетельства о регистрации (дом) */
      [~EvidenceDate];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 156));
      /* Рыночная стоимость дома */
      [~MarketSum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 157));
      /* Оценочная стоимость дома */
      [~AssessedSum];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 158));
      /* Площадь участка */
      [~Area];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 159));
      /* № договора купли-продажи участка */
      [~NumContractLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 160));
      /* Дата договора купли-продажи участка */
      [~DateContractLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 161));
      /* ФИО продавца по договору купли-продажи участка */
      [~FioLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 162));
      /* Дата регистрационной записи в реестре (участок) */
      [~DateReestrLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 163));
      /* Регистрационный № договора купли-продажи участка */
      [~NumContractLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 164));
      /* Серия свидетельства о регистрации (участок) */
      [~SeriesLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 165));
      /* № свидетельства о регистрации (участок) */
      [~NumLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 166));
      /* Дата свидетельства о регистрации (участок) */
      [~DateLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 167));
      /* Нормативная стоимость участка */
      [~SumLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 168));
      /* Оценочная стоимость участка */
      [~AssessedLot];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 169));
      /* Дата ввода в эксплуатацию */
      [~DateInput];
      println (GetUsFieldValue (LO_ENSOBJECT, EnsObject.EnsObjectID, 170));

      var tag = SetOutput (NULL, false);
      return tag;

      onError(axerr)
         SetOutput(NULL, false);
         RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Договор залога сформирован.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;