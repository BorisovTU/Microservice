/*
$Name:             SV_CREAT.MAC                                              
$Module:           Кредитование Депозиты юридических лиц
$Description:      Сводные документы
*/

import sbCrdInter, total;

RECORD СводныйДокумент ("doc_acc.dbt", "loans.def");

var BeginDate : Date,   // Дата формирования документов
    CarryDate : Date;   // Дата проводки документов

macro ВвестиИсходныеДанные()
   if (GetTrue (true, "Сформировать сводный документ для выгрузки в RS-BANK?") == false)
      return 1;
   end;

   BeginDate = {curdate};
   if (not GetDate (Begindate, "Введите дату формирования документов:"))
      return 1;
   end;

   CarryDate = BeginDate;
   if (not GetDate (CarryDate , "Введите дату проводки документов:"))
      return 1;
   end;

   return 0;
end;

// Создание сводных документов.
// Во входных параметрях функции информация о наложенном пользовательском фильтре #82449,82450
macro СводныеДокументы (sql_from: string, sql_where: string)
   var RSDcmd;

   if (ВвестиИсходныеДанные())
      return 0;
   end;

   RSDcmd = RsdCommand (RslDefCon, "begin ? := RSO_LOANS_UPLOAD.SvodDoc (?,?,?,?); end;");

   RSDcmd.addParam ("CountDoc", RSDBP_RETVAL, V_INTEGER);
   RSDcmd.addParam ("UserFiltr_From", RSDBP_IN, sql_from); 
   RSDcmd.addParam ("UserFiltr_Where", RSDBP_IN, sql_where);
   RSDcmd.addParam ("DateFormedDoc", RSDBP_IN, Begindate);
   RSDcmd.addParam ("DateCarryDoc", RSDBP_IN, CarryDate);

   RSDcmd.execute();

   if (RSDcmd.Value(0) == -1)
      MsgBox ("При сведении документов произошли ошибки!");
   end;

   if (RSDcmd.Value(0) == 0)
      MsgBox ("Нет документов для формирования сводного!");
   end;
   return 0;
end;

macro АвтоматическоеСведениеДокумента (CredOperID: integer)
   var RSDcmd;
   RSDcmd = RsdCommand (RslDefCon, "begin ? := RSO_LOANS_UPLOAD.AutoSvodDoc (?); end;");

   RSDcmd.addParam ("RetVal", RSDBP_RETVAL, V_INTEGER);

   RSDcmd.addParam ("CredOperID", RSDBP_IN);
   RSDcmd.value ("CredOperID") = CredOperID;
   RSDcmd.execute();

   if (RSDcmd.Value(0) == -1)
      PrintLn ("При сведении документов произошли ошибки!");
   end;

   return 0;
end;