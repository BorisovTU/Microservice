/*
$Name:             expcrd.mac
$Module:           Šà¥¤¨â®¢ ­¨¥
$Description:      âç¥â ® ª®«¨ç¥áâ¢¥ ¤­¥© ¯à®áà®çª¨ ¤®£. ¯®àâä¥«ï
*/
import ActiveX, total, replib, CTInter, BankInter;

private record lbrfcase ("lbrfcase.dbt", "loans.def");

macro PrintLoansReport(buff, FromWeb)

      if (FromWeb == true)
          return "";
      end;

   VAR RepDate;
   var rs;
   SetBuff(lbrfcase, buff);      
   VAR qstr :string;
   VAR Num = 0;

   RepDate = {curdate};
   IF (GetDate(RepDate, "‚¢¥¤¨â¥ ¤ âã ®âç¥â ") == FALSE)
      RETURN FALSE;                                        
   END;
        
   qstr = " SELECT   *" +
          "  FROM (SELECT t_uscreditnumber, t_name," + SQLDate(RepDate) +
          "           - NVL((SELECT MAX (t_restdate)" +
          "                    FROM ddutyrest_dbt rest" +
          "                   WHERE (t_id_ref, t_restdate) IN (" +
          "                            SELECT   l.t_id, MAX (d.t_restdate)" +
          "                                FROM dlcusreg_dbt l JOIN ddutyrest_dbt d" +
          "                                     ON l.t_id = d.t_id_ref" +
          "                               WHERE l.t_regid IN (2, 3)" +
          "                                 AND d.t_restdate <= " + SQLDate(RepDate) +
          "                                 AND (   (    l.t_objecttypeid =" +
          "                                                              t_crd_kind" +
          "                                          AND l.t_objectnumber =" +
          "                                                          t_creditnumber" +
          "                                         )" +
          "                                      OR (    l.t_objecttypeid = 6" +
          "                                          AND l.t_objectnumber IN " +
          "                                               (SELECT t_dutyid" +
          "                                                    FROM dduty_crd_dbt" +
          "                                                   WHERE t_creditnumber_ref =" +
          "                                                            t_creditnumber" +
          "                                                     AND t_dutystate =" +
          "                                                               '')" +
          "                                         )" +
          "                                     )" +
          "                                 AND l.t_id = rest.t_id_ref" +
          "                            GROUP BY l.t_objecttypeid," +
          "                                     l.t_objectnumber," +
          "                                     l.t_id)" +
          "                     AND rest.t_restsum > 0)," +
          "                 TO_DATE ('01-01-2099', 'dd-mm-yyyy')" +
          "                ) AS cnt" +
          "      FROM dcredit_c_dbt JOIN dparty_dbt ON t_clientid_ref = t_partyid" +
          "     WHERE loanskernel.dutyincases (t_crd_kind," +
          "                                    t_creditnumber," +
          "                                    " + SQLDATE(RepDate) + "," +
          "                                " + lbrfcase.type +
          "                                   ) = " + lbrfcase.briefcaseID + ")" +
          " WHERE cnt > 0" +
          " ORDER BY cnt DESC";

   rs = LnGetRecordSet (qstr);
   if (rs != NULL)
       InitProgress( -1, "”®à¬¨à®¢ ­¨¥ ®âç¥â ", "”®à¬¨à®¢ ­¨¥ ®âç¥â " );

       [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿];
       [³  ü ¤®£®¢®à                 ³                   ‡ ¥¬é¨ª                           ³Š®«¨ç¥áâ¢® ³];
       [³                            ³                                                     ³   ¤­¥©    ³];
       [³                            ³                                                     ³ ¯à®áà®çª¨ ³];
       [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´];

       while (rs.MoveNext())
        UseProgress(Num = Num + 1);

        [³ ######################### ³#####################################################³ ##########³]
            (        
              rs.Value("t_uscreditnumber", NULL, V_STRING),
              rs.Value("t_name", NULL, V_STRING),
              rs.Value("cnt", NULL, V_INTEGER)
            )
       end;
       [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÙ];

       RemProgress();
   end;   
end;
