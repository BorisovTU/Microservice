/*
$Name:               list_crd.mac
$Module:            Кредитование
$Description:      Отчёт "Список открытых/закрытых договоров за период"
*/
/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : list_crd.mac
 Description : Отчёт "Список открытых/закрытых договоров за период"

 Programmer  : SAE
 13.07.01    : Создан
------------------------------------------------------------------------------*/

IMPORT ActiveX, total;

FILE Credit  ("credit_c.dbt", "loans.def");
VAR  TmpCred = TBFile ("set_cln.tmp", "r", 0);  /* Временный файл отфильтрованных договоров */
var rsRow : object = NULL;

Const
   Top = 5;

VAR
   Row = Top, Льготность, ПереоформленийСИзм, ПереоформленийБезИзм,
   КоличествоДнейОД, КоличествоДнейПроц, ПросроченныйОД, ПросроченныеПр, Number,
   СумПросроченныйОД = $0, СумПросроченныеПр = $0, ОбеспЦБ, ОбеспПоруч, ОбеспЗалог,
   ВыданнаяСумма, СумВыданнаяСумма = $0, ОстатокЗадолженности, СумОстатокЗадолженности = $0,
   RepDate, Range;


MACRO OutString ()
   ВыданнаяСумма = rsRow.value ("PAYSUM", 0, V_DOUBLE);
   СумВыданнаяСумма = СумВыданнаяСумма + ВыданнаяСумма;
   ПросроченныйОД = rsRow.value ("EXPREST", 0, V_DOUBLE);
   ПросроченныеПр = rsRow.value ("EXPPERC", 0, V_DOUBLE);
   СумПросроченныйОД = СумПросроченныйОД + ПросроченныйОД;
   СумПросроченныеПр = СумПросроченныеПр + ПросроченныеПр;
   ПереоформленийСИзм = rsRow.value ("RestructuringCrd_Chang", 0, V_INTEGER);
   ПереоформленийБезИзм = rsRow.value ("RestructuringCrd_notChang", 0, V_INTEGER);
   КоличествоДнейОД = rsRow.value ("ExpDaysOD", 0, V_INTEGER);
   КоличествоДнейПроц = rsRow.value ("ExpDaysPerc", 0, V_INTEGER);
   ОбеспЦБ = rsRow.value ("EnsSum_bail_capital", 0, V_DOUBLE);
   ОбеспПоруч = rsRow.value ("EnsSum_voucher", 0, V_DOUBLE);
   ОбеспЗалог = rsRow.value ("EnsSum_bail", 0, V_DOUBLE);
   ОстатокЗадолженности = rsRow.value ("MAINREST", 0, V_DOUBLE);
   СумОстатокЗадолженности = СумОстатокЗадолженности + ОстатокЗадолженности;
   if (rsRow.value ("PrivilegeFlag", "", V_STRING) == "X") Льготность = "Да"; else Льготность = "Нет"; end;

   ActiveSheet.Cells (Row,  1).Value = rsRow.value ("ROWNUM_", 0, V_INTEGER); 
   ActiveSheet.Cells (Row,  2).Value = rsRow.value ("Number_ACC", "", V_STRING);
   ActiveSheet.Cells (Row,  3).Value = rsRow.value ("UsCreditNumber", "", V_STRING);
   ActiveSheet.Cells (Row,  4).Value = rsRow.value ("FIO", "", V_STRING); 
   ActiveSheet.Cells (Row,  5).Value = Льготность;
   ActiveSheet.Cells (Row,  6).Value = rsRow.value ("IsInsider", "", V_STRING);
   ActiveSheet.Cells (Row,  7).Value = rsRow.value ("Addres", "", V_STRING); 
   ActiveSheet.Cells (Row,  8).Value = rsRow.value ("Placework", "", V_STRING);
   ActiveSheet.Cells (Row,  9).Value = string (ВыданнаяСумма);
   ActiveSheet.Cells (Row, 10).Value = DateToStringShort(rsRow.value ("PaymentDate", Date("00.00.00"), V_DATE));
   ActiveSheet.Cells (Row, 11).Value = DateToStringShort(rsRow.value ("ReturnDate", Date("00.00.00"), V_DATE));
   ActiveSheet.Cells (Row, 12).Value = string (ОстатокЗадолженности);
   ActiveSheet.Cells (Row, 13).Value = double (rsRow.value ("RateVal", 0, V_DOUBLE));
   ActiveSheet.Cells (Row, 14).Value = string (ОбеспЦБ);
   ActiveSheet.Cells (Row, 15).Value = string (ОбеспПоруч);
   ActiveSheet.Cells (Row, 16).Value = string (ОбеспЗалог);
   ActiveSheet.Cells (Row, 17).Value = string (ОбеспЦБ + ОбеспПоруч + ОбеспЗалог);
   ActiveSheet.Cells (Row, 18).Value = string (ПросроченныйОД);
   ActiveSheet.Cells (Row, 19).Value = КоличествоДнейОД;
   ActiveSheet.Cells (Row, 20).Value = string (ПросроченныеПр);
   ActiveSheet.Cells (Row, 21).Value = КоличествоДнейПроц;
   ActiveSheet.Cells (Row, 22).Value = ПереоформленийСИзм;
   ActiveSheet.Cells (Row, 23).Value = ПереоформленийБезИзм;
   ActiveSheet.Cells (Row, 24).Value = rsRow.value ("KKS", 0, V_INTEGER);
   Row = Row + 1;
   
END;


/*******************************************************************
 * Входные параметры:                                              *
 *    CreditState - статус договоров (0 - открытые, 1 - закрытые), *
 *    FirstDate   - дата начала периода,                           *
 *    LastDate    - дата конца периода                             *
 *******************************************************************/
MACRO CreateReport (CreditState, FirstDate, LastDate)
   VAR str;
   VAR t1 = time;
   var StrCmd : string = "";
   var RSDcmd : object = NULL;
   
   if (NOT NewExcelWorkbook (false, "list_crd.xls"))
      Exit (0, "Не открыт Excel-файл");
   end;
   if (CreditState == 0)
      str = "открытых";
   else
      str = "закрытых";
   end;
   RepDate = LastDate;
   ActiveSheet.Cells (1, 1).Value = "Список "+str+" кредитных договоров за период с "+DateToStringFull (FirstDate)+" по "+DateToStringFull (LastDate);
   
   InitProgress (NRecords (TmpCred), "~Alt-Break~ - прервать", "Формирование отчета");
   //TmpCred.Rewind ();
   
   StrCmd = "SELECT * FROM TABLE(LoansUserFunction.List_CRDRepQuery(?,?))";
   RSDcmd = RsdCommand (RslDefCon, StrCmd);

   RSDcmd.addParam ("", RSDBP_IN); RSDcmd.value (0) = RepDate; // дата отчета
   RSDcmd.addParam ("", RSDBP_IN); RSDcmd.value (1) = 1000;
   
   rsRow = RsdRecordset(RSDcmd);
   RSDcmd.execute;

   // вывод отчета
   if (rsRow == NULL)
      return 0;
   end;

   while ((rsRow.MoveNext()) and (rsRow.value(0, null, V_INTEGER) != NULL))  
      OutString ();
      UseProgress (rsRow.value("ROWNUM_", 0, V_INTEGER));
   end;
   
   RemProgress ();
   
   
   
   ActiveSheet.Cells (Row,  1).Value = "Итого:";
   ActiveSheet.Cells (Row,  9).Value = string (СумВыданнаяСумма);
   ActiveSheet.Cells (Row, 12).Value = string (СумОстатокЗадолженности);
   ActiveSheet.Cells (Row, 18).Value = string (СумПросроченныйОД);
   ActiveSheet.Cells (Row, 20).Value = string (СумПросроченныеПр);
   Range = "A"+String (Top)+":X"+String (Row);
   ActiveSheet.Range (Range).Select;
   ExcelApplication.Selection.Borders (xlEdgeLeft).LineStyle = xlContinuous;
   ExcelApplication.Selection.Borders (xlEdgeTop).LineStyle = xlContinuous;
   ExcelApplication.Selection.Borders (xlEdgeBottom).LineStyle = xlContinuous;
   ExcelApplication.Selection.Borders (xlEdgeRight).LineStyle = xlContinuous;
   ExcelApplication.Selection.Borders (xlInsideVertical).LineStyle = xlContinuous;
/*   ExcelApplication.Selection.Borders (xlInsideHorizontal).LineStyle = xlContinuous;*/
   Range = "A"+String (Row)+":X"+String (Row);
   ActiveSheet.Range (Range).Select;
   ExcelApplication.Selection.Borders (xlEdgeTop).LineStyle = xlContinuous;
   ExcelApplication.Selection.Font.Bold = True;
   ExcelApplication.Selection.Interior.ColorIndex = 15;
   ExcelApplication.Selection.Borders (xlInsideVertical).LineStyle = xlLineStyleNone;
   ActiveSheet.Range ("A1").Select;
   ExcelApplication.Visible = true;
   println(time - t1);
END;
