/*
$Name:             guar5.mac
$Module:           Кредитование
$Description:      Создание документа по шагу "Списание гарантии с внебаланса" (операция оплаты гарантии)
*/
/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : guar3.mac
 Description : Создание документа по шагу операции (операция оплаты гарантии)
               Шаг "Списание гарантии с внебаланса"
 26.05.05    : Создан
-----------------------------------------------------------------------------------*/
import total;

record ШагОперации (step_op, "loans.def");        /* Запись шага операции */
record Документ    (doc_acc, "loans.def");        /* Буфер документа      */
record Договор     ("credit_c.dbt", "loans.def"); /* Буфер договора гарантии*/
record Операция    ("crd_op.dbt",   "loans.def"); /* Операция по договору */
record Сумма       ("SUM.", "loans.def");
record PayData     ("paydata.dat", "loans.def");
file   pmpaym      ("pmpaym.dbt", "bank.def");
 
MACRO ВыполнитьШаг (OperDate, Sum, Data)
   VAR DocID:integer;
   VAR stat:integer = 0;
   VAR rest_sum:MONEY = 0;
   VAR rest_sum1:MONEY = 0;
   VAR rest_sum2:MONEY = 0;
   // Гарантия еще не списана с внебаланса.
   VAR CredOperID =
   CRSDCommand(
   "SELECT MIN(T_CREDOPERID) FROM VCRE_CRDOP_DBT WHERE "+
         " T_CREDITNUMBER_REF  = ? "+
     " AND T_SYSTEMOPERATIONID = ? ",
   "p1", Операция.CreditNumber_Ref,
   "p2", CS_GUARWRITEOFF,
   V_INTEGER);

   IF (CredOperID > 0) 
      RETURN 0;
   END;
  
   setbuff(Сумма, Sum);
   setbuff(PayData, Data);
   Документ.CarrySum = Сумма(0);

   rest_sum2 = Сумма(0);
   rest_sum = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_PAYEDGUARANTEE, OperDate);
   
   stat = СоздатьДокумент(Документ, DocID);
   IF (stat == 0)
      stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_PAYEDGUARANTEE, DocID, -Сумма(0));
	  IF( (stat == 0) and ( (rest_sum - rest_sum2) == 0) )
		 /*если после запланированного изменения регистр TDR_PAYEDGUARANTEE обнулится */
			/*обнулим остаток на регистре Цена сделки при первоначальном признании*/
			rest_sum1 = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_price_trade_FAIRCOST, OperDate);
			stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_price_trade_FAIRCOST, DocID, -rest_sum1);
		END;
   END;

   return stat;
END;