/*
$Name:             zvlsps01.mac
$Module:           Кредитование
$Description:      Заявление на списание задолженности
*/
IMPORT LoansFind, ActiveX;
IMPORT "dlwreps.mac", "replib.mac", "ws_report.mac";

PRIVATE RECORD credit_c ("credit_c.dbt", "loans.def");
PRIVATE RECORD cur_credit ("credit_c", "loans.def");

PRIVATE CONST TemplateName = "ZvlSps01.dot";

PRIVATE MACRO GenerateTagFile(ObjID, ObjN)
  var
      retVal = NULL;

  record credit_c ("credit_c.dbt");

    if (Loans_FindCrdContract(ObjN, credit_c))
        SetOutput (GetTxtFileName("zvlsps01_rep"));

        if (not depclnt.GetRecord(credit_c.ClientID_Ref))
            RunError("Не найден заещик в справочнике клиентов");
        end;

        println(TemplateName); //Имя файла-шаблона
        println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа

        /* ФИО заёмщика */
        [~FIO];
        println (DepClnt.ConvertFIOFull);
        /* Адрес прописки заёмщика */
        [~Address];
        println (DepClnt.Address);
        /* ФИО заёмщика */
        [~FioZaem];
        println (DepClnt.ConvertFIOFull);
        /* № лицевого счёта заёмщика */
        [~Account];
        println (НомерСчета(credit_c.CreditNumber, credit_c.CurCode, CF_BORROWER_RUR));
        /* № кредитного договора */
        [~CrdNum];
        println (credit_c.UsCreditNumber);
        /* Дата начала кредитного договора */
        [~RegDate];
        println (DateToStringFull (credit_c.RegDate));
        /* Дата */
        [~Date];
        println (DateToStringFull ({curdate}));

        retVal = SetOutput (NULL, false);
    end;

    return retVal;

    onError(err)
        SetOutput(NULL, false);
        RunError;
end;

MACRO RunReportWeb(TemplateParm)
  var
      tag = NULL,
      RepGenerator = WebWordReportGenerator(),
      FileContainer = NULL;

    tag = GenerateTagFile(TemplateParm.ObjID, TemplateParm.ObjN);
    FileContainer = RepGenerator.GenerateFromTagFileAndPack(tag);// здесь при ошибках Word не закрывается

    return FileContainer;
END;

MACRO RunReportEW(TemplateParm)
  var
      tag = NULL;

    tag = GenerateTagFile(TemplateParm.ObjID, TemplateParm.ObjN);
    DLWREPS_PrintReportFromTagFile(tag); // здесь при ошибках Word не закрывается

    return true;
END;

// Временное решение
MACRO PrintLoansReport(CreditBuf)
    SetBuff(credit_c, CreditBuf);
    RunReportEW(1, credit_c.CreditNumber, 0, 1);
    return true;
END;