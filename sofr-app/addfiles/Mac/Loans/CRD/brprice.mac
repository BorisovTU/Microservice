import total;

record BRContr   ("credit_c.dbt",  "loans.def");
record ASGMTPARM ("ASGMTPARM.dbt", "loans.def");

macro CalcSum()
var RSDcmd;
var rs,rs1;
var idcrd;
var crdsum; // Номинальная стоимость КД 
var crdsel; // Цена приобретения 
   
   ASGMTPARM.Price = 0;
   ASGMTPARM.Selling = 0;

   rs1 = LnGetRecordSet("SELECT t_ObjectNumber FROM dlbfrccrd_dbt WHERE t_briefcaseid_ref = " + BRContr.CreditNumber);
   if (rs1 != NULL)
       while (rs1.MoveNext())
          idcrd = rs1.Value("t_ObjectNumber", NULL, V_INTEGER);

       RSDcmd = RsdCommand (RslDefCon, "begin ? := RSO_LN_CESSIO.GetNominalValue (?, ?, ?); end;");

       RSDcmd.addParam ("NominalValue", RSDBP_RETVAL, V_NUMERIC);
                                                                
       RSDcmd.addParam ("ObjK",   RSDBP_IN); RSDcmd.value ("ObjK")   = LO_CREDIT;
       RSDcmd.addParam ("ObjN",   RSDBP_IN); RSDcmd.value ("ObjN")   = idcrd;
       RSDcmd.addParam ("OpDate", RSDBP_IN); RSDcmd.value ("OpDate") = ASGMTPARM.Concession;

       RSDcmd.execute ();

          crdsum = RSDcmd.value("NominalValue");

          crdsel = ОстатокРегистра (LO_CREDIT, idcrd, TDR_ACQCRD, ASGMTPARM.Concession);


          ASGMTPARM.Price = ASGMTPARM.Price + crdsum;
          ASGMTPARM.Selling = ASGMTPARM.Selling + crdsel;
       end;
   end;
   return true;
end;