/*
$Name:             bef_duty.mac 
$Module:           Кредитование
$Description:      bef_duty.mac
*/  

import "total.mac", Календарь, SbCrdInter, "macperc.mac";
/*
PRIVATE RECORD Договор  ("credit_c.dbt", "loans.def");
PRIVATE RECORD Обязательство ("duty_crd.dbt", "loans.def");
PRIVATE FILE BeforeDuty ("beforedu.dbt", "loans.def") WRITE;
private var CrdOp = TBFile ("crd_op.dbt",  "R", 2, "crd_op.dbt",  "loans.def");

private VAR  mdb = TBFile ("payment.tmp", "w", 0);

CLASS ID_DATE
    VAR ID:integer;
    VAR BD:date;
    VAR DT:date;
END;

VAR {GROUP_MODE};

VAR Type:integer,
    BEGDATE:date = date(0,0,0),
    ENDDATE:date = date(0,0,0);

var ArIdDt = TArray(0);

MACRO ПолучитьДаты()
    VAR First:bool;
    VAR D:date;
    VAR NextIf:bool = false;
    VAR CredOperID:integer;

    ArIdDt = TArray(0);

    IF (Type == ALG_CRD)
        KeyNum(BeforeDuty, 2);
        BeforeDuty.ID_Ref = Договор.CreditNumber;
        BeforeDuty.Type = Type;
        BeforeDuty.BegDate = date(0,0,0);
        BeforeDuty.ID = 0;
        IF (GetGE(BeforeDuty) AND
           (BeforeDuty.ID_Ref == Договор.CreditNumber) AND
           (BeforeDuty.Type == Type));
            prev(BeforeDuty);
            WHILE (next(BeforeDuty) AND
                  (BeforeDuty.ID_Ref == Договор.CreditNumber) AND
                  (BeforeDuty.Type == Type));
                  ArIdDt(ArIdDt.size) = GenObject("ID_DATE");
                  ArIdDt(ArIdDt.size-1).ID = BeforeDuty.ID;
                  ArIdDt(ArIdDt.size-1).BD = BeforeDuty.BegDate;
                  ArIdDt(ArIdDt.size-1).DT = BeforeDuty.EndDate;
            END;
        END;
    ELSE
        KeyNum(BeforeDuty, 1);
        BeforeDuty.ID_Ref = Договор.CreditTypeID_Ref;
        BeforeDuty.Type = Type;
        BeforeDuty.ID = 0;
        IF (GetGE(BeforeDuty) AND
           (BeforeDuty.ID_Ref == Договор.CreditTypeID_Ref) AND
           (BeforeDuty.Type == Type));
            prev(BeforeDuty);
            WHILE (next(BeforeDuty) AND
                  (BeforeDuty.ID_Ref == Договор.CreditTypeID_Ref) AND
                  (BeforeDuty.Type == Type));
                First = true;
                D = date(0,0,0);
                IF (BeforeDuty.CalcDuration == CDFD_PAY)
                    WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_PAY, false, Договор.CurCode)
                           AND (D == date(0,0,0)))
                        IF (GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT)
                            D = CrdOp.rec.CredOperDate;
                        END;
                    END
                END;
                IF (BeforeDuty.CalcDuration == CDFD_REG)
                    /*WHILE (NextOpSystType(First, Договор.CreditNumber, CrdOp, CS_REG, false, Договор.CurCode) AND (D == date(0,0,0)))
                        IF (GetCopStage (CrdOp.CredOperID) == CF_COMPLIT)
                            D = CrdOp.CredOperDate;
                        END;
                    END*/
                    D = Договор.RegDate;
                END;
                IF (BeforeDuty.CalcDuration == CDFD_FIRSTDUTY)
                    WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_DUTY, true, Договор.CurCode) AND (D == date(0,0,0)))
                        IF (GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT)
                            D = CrdOp.rec.CredOperDate;
                        END;
                    END
                END;
                IF (BeforeDuty.CalcDuration == CDFD_PROLONG)
                    WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_PROL, false, Договор.CurCode) AND (D == date(0,0,0)))
                        IF (GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT)
                            D = CrdOp.rec.CredOperDate;
                        END;
                    END
                END;
                IF ((BeforeDuty.CalcDuration == CDFD_PREV) AND (ArIdDt.size != 0))
                    D = ArIdDt(ArIdDt.size-1).DT;
                END;

                IF (D != date(0,0,0))
                    IF (NextIf)
                        ArIdDt(ArIdDt.size-1).DT = D - 1;
                        NextIf = false;
                    END;
                    ArIdDt(ArIdDt.size) = GenObject("ID_DATE");
                    ArIdDt(ArIdDt.size-1).ID = BeforeDuty.ID;
                    ArIdDt(ArIdDt.size-1).BD = D;
                    IF (BeforeDuty.Duration != 0)
                        IF (BeforeDuty.TypeDuration == CF_DAY)
                            ArIdDt(ArIdDt.size-1).DT = DateAfterCalenDays(D, BeforeDuty.Duration);
                        ELSE
                            ArIdDt(ArIdDt.size-1).DT = DateAfterCalenMonths(D, BeforeDuty.Duration);
                        END;
                    ELSE
                        ArIdDt(ArIdDt.size-1).DT = date(0,0,0);
			IF (BeforeDuty.BeforeCalcDuration == CDFBD_CLOSECREDIT)
                            WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_CLCRD, true, Договор.CurCode) AND (ArIdDt(ArIdDt.size-1).DT == date(0,0,0)))
                                IF ((GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT) AND
                                    (CrdOp.rec.CredOperDate >= ArIdDt(ArIdDt.size-1).BD))
                                    ArIdDt(ArIdDt.size-1).DT = CrdOp.rec.CredOperDate;
                                END;
                            END
                        ELIF (BeforeDuty.BeforeCalcDuration == CDFBD_PROLONG)
                            WHILE (NextOpSystType(First, Договор.CreditNumber, @CrdOp, CS_PROL, true, Договор.CurCode) AND (ArIdDt(ArIdDt.size-1).DT == date(0,0,0)))
                                IF ((GetCopStage (CrdOp.rec.CredOperID) == CF_COMPLIT) AND
                                    (CrdOp.rec.CredOperDate >= ArIdDt(ArIdDt.size-1).BD))
                                    ArIdDt(ArIdDt.size-1).DT = CrdOp.rec.CredOperDate;
                                END;
                            END
                        ELSE /*CDFBD_NEXTIF*/
                            NextIf = true;
                        END;
                        IF (ArIdDt(ArIdDt.size-1).DT == date(0,0,0))
                            ArIdDt(ArIdDt.size-1).DT = date(31,12,9999);
                        END;
                    END;
                END;
            END;
        END;
    END;
END;


MACRO ПереносИндивидуальныеНастройки()
    VAR i:integer = 0;
    KeyNum(BeforeDuty, 0);

    WHILE (i < ArIdDt.size)
        BeforeDuty.ID = ArIdDt(i).ID;
        IF (GetEQ(BeforeDuty))
            BeforeDuty.ID = 0;
            BeforeDuty.Type = ALG_CRD;
            BeforeDuty.ID_Ref = Договор.CreditNumber;
            BeforeDuty.BegDate = ArIdDt(i).BD;
            BeforeDuty.EndDate = ArIdDt(i).DT;
            Insert(BeforeDuty);
        END;
        i = i + 1;
    END;
END;


MACRO ИндивидуальныеНастройки()
    Type = ALG_GROUP;
    ПолучитьДаты();
    IF (NOT ProcessTrn(0, "ПереносИндивидуальныеНастройки", BeforeDuty))
        MsgBox("Ошибка при переносе в индивидуальные настройки");
    END;
END;


MACRO РассчитатьДату(ID:integer)
    VAR i:integer = 0;
    Type = Договор.BeforeDuty;

    IF (ArIdDt.size == 0)
        ПолучитьДаты();
    END;

    WHILE(i < ArIdDt.size)
        IF (ArIdDt(i).ID == ID)
            BEGDATE = ArIdDt(i).BD;
            ENDDATE = ArIdDt(i).DT;
            RETURN;
        END;
        i = i + 1;
    END;

    BEGDATE = ENDDATE = date(0,0,0);
    RETURN;
END;


MACRO РасчетШтрафа(ObjID:integer, ObjN:integer, PayDate:date, PaySum:moneyl /*Фактическая сумма платежа*/, dp:integer)
    VAR DS:moneyl,
        SP:moneyl,
        SX:moneyl,
        SumPay6:moneyl,
        Sum6:moneyl,
        tmp_sum:moneyl,
        tmp_sum1:moneyl,
        i:integer = 0,
        Противоречие:bool,
        stat:bool = false,
        found:bool = false,
        SuperPerc = false,
        rs = NULL,
        select: string = "",
        DutyStageID:integer = 0,
        CreditNumber:integer = 0;

    // Функция возвращает сумму в нацвалюте, поскольку базовые суммы к этому времени уже сконвертированы в нац.валюту
    MACRO CalcSum(Sum:double, Perc:integer)
        VAR Sum1:moneyl;
        IF (Perc == CPD_CRDSUM)
            Sum1 = (ОстатокОткрытыхСО(Договор.CreditNumber, TDR_MAINREST, PayDate) + ОстатокРегистра(Договор.Crd_kind, Договор.CreditNumber, TDR_MAINREST, PayDate))*Sum/100;
            // Сумма получилась в валюте договора - сконвертируем в нац.валюту
            ConvSum(sum1, Sum1, PayDate, Договор.CurCode);
        ELIF (Perc == CPD_RESTDUTYS)
            Sum1 = ОстатокОткрытыхСО(Договор.CreditNumber, TDR_MAINREST, PayDate)*Sum/100;
            // Сумма получилась в валюте договора - сконвертируем в нац.валюту
            ConvSum(sum1, Sum1, PayDate, Договор.CurCode);
        ELIF (Perc == CPD_DUTYSUM)
            Sum1 = PaySum*Sum/100;
            // Сумма получилась в валюте договора - сконвертируем в нац.валюту
            ConvSum(sum1, Sum1, PayDate, Договор.CurCode);
        ELIF (Perc == CPD_SUM)
            Sum1 = SumPay6*Sum/100;
        ELIF (Perc == CPD_OVERPAY)
            Sum1 = DS*Sum/100;
        ELIF (Perc == CPD_OVERPAYSUM)
            Sum1 = (SumPay6 - Sum6)*Sum/100;
        ELIF (Perc == CPD_OVERPAYINCPEN)
            Sum1 = moneyl(double(DS*Sum)/(100+Sum));
            SuperPerc = true;
        ELSE
            Sum1 = $0;
        END;
        IF (Sum1 < $0)
            Sum1 = $0;
        END;
        RETURN money(round(Sum1));
    END;

    MACRO ПроверитьПротиворечия()
        VAR Stop:integer = 0,
            Penny:integer = 0;
        VAR Flag:bool = true;
        VAR LastIF:integer = 0;
        VAR Sum:moneyl;
        WHILE(i < ArIdDt.size)
            IF ((ArIdDt(i).BD <= PayDate) AND
                (ArIdDt(i).DT >= PayDate))
                BeforeDuty.ID = ArIdDt(i).ID;
                IF (GetEQ(BeforeDuty))
                    IF (BeforeDuty.TypeSum == 0)
                        Sum = BeforeDuty.Sum; //в валюте условия
                         // сконвертируем в нацвалюту
                         ConvSum(Sum, Sum, PayDate, BeforeDuty.SumCurrency);
                    ELSE
                        Sum = CalcSum(double(BeforeDuty.Sum), BeforeDuty.CalcPerc);  // в нацвалюте
                    END;

                    IF (DS >= Sum)
                        IF (BeforeDuty.Stop != "")
                            Stop = Stop + 1;
                            LastIF = i;
                        END;
                        IF (BeforeDuty.FineSum != $0)
                            Penny = Penny + 1;
                            LastIF = i;
                        END;
                    END;
                END;
            END;
            i = i + 1;
        END;

        IF ((Stop > 1) OR (Penny > 1))
            MsgBox("Условия досрочного погашения противоречивы, принимается последнее!");
            Противоречие = true;
            i = LastIF;
        ELSE
            Противоречие = false;
            i = 0;
        END;
    END;

    if(ObjID == LO_DUTY)
        Loans_FindDuty(ObjN, Обязательство);
        CreditNumber = Обязательство.CreditNumber_Ref;
    end;

    if((ObjID == LO_CREDIT) OR (ObjID == LO_KARTA))
        CreditNumber = ObjN;
    end;

    Loans_FindCrdContract(CreditNumber, Договор);

    SP = $0;

    //SP - Сумма платежа (рассчитанная)
    if (ObjID == LO_CREDIT)
       SP = LnSelectValue("SELECT Sum(t_Sum) FROM dpayment_tmp WHERE " +
                                       "     t_ParentID != 0 "
                                          " and t_CreditNumber_Ref = " + ObjN +
                                          " and t_IsOperation != " + SQLString("X") +
                                          " and t_Reference != " + DS_FINE, V_MONEY);
    else
       SP = LnSelectValue("SELECT Sum(t_Sum) FROM dpayment_tmp WHERE " +
                                       "     t_ParentID != 0 "
                                       " and t_ObjID     = " + ObjID +
                                       " and t_ObjN      = " + ObjN +
                                          " and t_IsOperation != " + SQLString("X") +
                                          " and t_Reference != " + DS_FINE, V_MONEY);

    end;

    SumPay6 = GetPaySum (DS_DUTY, ObjID, ObjN); // сумма погашения по ОД
    Sum6    = GetCalcSum(DS_DUTY, ObjID, ObjN); // расчитанная сумма по ОД

    DS = PaySum - SP; // сумма переплаты
    IF (DS <= 0)
        RETURN 0; // переплаты нет
    END;

    mdb.rewind;
    WHILE((NOT found) and (mdb.next))
        IF ((mdb.rec.ObjID == ObjID)       and
            (mdb.rec.ObjN == ObjN)         and
            (mdb.rec.ParentID != 0)        and
            (mdb.rec.Reference == DS_FINE) and
            (mdb.rec.RegID == TDR_PENNY))
            found = true;
        END;
    END;

    if(NOT found)
        return 1;
    end;

    Type = Договор.BeforeDuty;
    ПолучитьДаты();

    ConvSum(DS, DS, PayDate, Договор.CurCode); //сконвертировали переплату в нацвалюту
    ConvSum(SP, SP, PayDate, Договор.CurCode); //сконвертировали расчитанную сумму в нацвалюту

    //далее все проверки и сравнения выполняем в нацвалюте. Результат возвращаем в валюте договора (а не штрафа)
    KeyNum(BeforeDuty, 0);
    ПроверитьПротиворечия();

    ConvSum(tmp_sum, PaySum, PayDate, Договор.CurCode); //сконвертировали сумму платежа в нацвалюту

    WHILE (i < ArIdDt.size)
        IF ((ArIdDt(i).BD <= PayDate) AND
            (ArIdDt(i).DT >= PayDate)/* AND
            ((BeforeDuty.Stop != "") OR (BeforeDuty.FineSum != $0))*/)
            BeforeDuty.ID = ArIdDt(i).ID;
            IF (GetEQ(BeforeDuty))
                IF (BeforeDuty.TypeSum == 0)
                    SX = BeforeDuty.Sum; //сумма ограничения в валюте условия
                    // сконвертируем в нацвалюту
                    ConvSum(SX, SX, PayDate, BeforeDuty.SumCurrency);
                ELSE
                    SX = CalcSum(double(BeforeDuty.Sum), BeforeDuty.CalcPerc); // в нацвалюте
                END;

                IF (((tmp_sum < (SP + SX))     AND
                     (BeforeDuty.MinMax == "")) OR
                    ((tmp_sum >  (SP + SX))     AND
                     (BeforeDuty.MinMax != "")))
                    IF (BeforeDuty.Stop != "")
                        mdb.rec.PaySum = $0;
                        mdb.update;
                        IF ({GROUP_MODE})
                            RETURN 1;
                        ELSE
                            IF (GetTrue(TRUE, "Досрочное погашение данной суммы запрещено. Продолжить?") == FALSE)
                                RETURN 1;
                            ELSE
                                RETURN 0;
                            END;
                        END;
                    END;

                    if(BeforeDuty.CalcFinePerc != CPD_OVERPAYINCPEN)
                        IF (BeforeDuty.FineTypeSum == 0)
                            mdb.rec.PaySum = BeforeDuty.FineSum; // в валюте условия
                            // сконвертируем в нацвалюту
                            ConvSum(tmp_sum1, mdb.rec.PaySum, PayDate, BeforeDuty.FineCurrency);
                        ELSE
                            tmp_sum1 = CalcSum(double(BeforeDuty.FineSum), BeforeDuty.CalcFinePerc); // в нацвалюте
                        END;
                    else
                        tmp_sum1 = CalcSum(double(BeforeDuty.FineSum), BeforeDuty.CalcFinePerc); // в нацвалюте
                    end;

                    IF (((BeforeDuty.MinMax != "") AND
                         (tmp_sum1 > (DS-SX)))      OR
                        ((BeforeDuty.MinMax == "") AND
                         (tmp_sum1 > DS)))
                        MsgBox("Pазмер штрафа больше размера переплаты!");
                        mdb.rec.PaySum = $0;
                        mdb.update;
                        RETURN 1;
                    END;
                    //Сконвертируем итоговый штраф из нацвалюты в валюту договора
                    ConvSum(mdb.rec.PaySum, tmp_sum1, PayDate, NATCUR, Договор.CurCode);
                END;
            END;
        END;
        IF (Противоречие)
            i = ArIdDt.size;
        END;
        i = i + 1;
    END;

    mdb.rec.PaySum = round(mdb.rec.PaySum);
    mdb.rec.Sum = mdb.rec.PaySum;
    mdb.update;

    if(SuperPerc)
        select = "select t_DutyStageID_Ref from ";
        select = select + "dst_prior_dbt where t_DutyStageNumber = ";
        select = select + "(select MAX(t_DutyStageNumber) from dst_prior_dbt a, dpayment_tmp b ";
        select = select + " where a.t_DutyPriorityID_Ref = " + dp;
        select = select + " and a.t_DutyStageID_Ref = b.t_Reference)";
        select = select + " and t_DutyPriorityID_Ref = ";
        rs = LnGetRecordSet(string(select + dp));

        IF ((rs != NULL) AND (rs.MoveNext() == TRUE) AND
            (ValType(rs.Value(0, NULL, V_INTEGER)) == V_INTEGER))
            DutyStageID = rs.Value(0, NULL, V_INTEGER);

            LnSqlExec ("update dpayment_tmp set t_PaySum = t_Sum + " + DS + " - " + mdb.rec.PaySum +
                       " where t_Reference = " + DutyStageID +
                       " and t_ObjID = " + ObjID +
                       " and t_ObjN = " + ObjN +
                       " and t_ParentID != 0");

            LnSqlExec ("update dpayment_tmp set t_RestNoPay = (t_Sum-t_PaySum)" +
                       " where t_Reference = " + DutyStageID +
                       " and t_ObjID = " + ObjID +
                       " and t_ObjN = " + ObjN +
                       " and t_ParentID != 0");
        END;
    end;
    RETURN 0;
END;

 */