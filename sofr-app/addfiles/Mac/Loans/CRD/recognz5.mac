/*
 ╔═════════════════════════════════════════════════════════════════════════════════╗
 ║ Операция   : Признание доходов 302-П                                            ║
 ║ Шаг        : №5 Учет просроченных процентов                                     ║
 ╟─────────────────────────────────────────────────────────────────────────────────╢
 ║ Программист: TFS                                                                ║
 ║ Дата       : 20.11.2007                                                         ║
 ╚═════════════════════════════════════════════════════════════════════════════════╝ */

import recognize;

RECORD ШагОперации ("step_op.dbt",  "loans.def"); // Запись шага операции
RECORD Документ    ("doc_acc.dbt",  "loans.def"); // Буфер документа
RECORD Операция    ("crd_op.dbt",   "loans.def"); // Операция по договору
RECORD Договор     ("credit_c.dbt", "loans.def");
RECORD Сумма       ("SUM.",         "loans.def");

MACRO ВыполнитьШаг (OperDate, Sum, Data)
   VAR RegID    : integer = 0,
       DocID    : integer = 0,
       stat     : integer = 0;

   IF (NOT ОтобратьДоговор_302(OperDate, Договор))
      RETURN 0;
   END;

   Документ.CarrySum = GetPaySum(DS_PAYMGUAREXPPERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref) +
                       GetPaySum(DS_EXPPERC,         Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref) +
                       GetPaySum(DS_NOOVCRDEXPPERC,  Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
   ЗаполнитьСчета(Операция.ObjectTypeID_Ref, OperDate, Документ, ШагОперации);

   stat = СоздатьДокумент(Документ, DocID);

   RETURN stat;
END;