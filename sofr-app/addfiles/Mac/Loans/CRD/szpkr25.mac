/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : szpkr5.mac
 Description : Создание документа по шагу операции
              "Списание задолженности приобр. кредита за счет резерва" - Списание просроч% за счет резерва

 Programmer  : Zigel Petr
 27-04-2009  : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, macperc;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var stat:integer = 0;
    VAR DocID        : integer = 0;
    var Spr = $0, Sprвб = $0, Sprпк = $0, Sprб = $0, Sр = $0, Sрprб = $0, Sдprб = $0, Sрпп = $0,
        Sрprпк = $0, Sдprпк = $0;

    Spr    = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC,     OperDate);
    Sprвб  = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_VN,  OperDate);
    Sprпк  = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_ACQ, OperDate);
    Sprб   = Spr - Sprвб - Sprпк;
    Sр     = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_REZEXPPERC,  OperDate);    
    Sрprб  = min(Sр, Sprб);
    Sдprб  = Sprб - Sрprб;
    Sрпп   = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_REZ_EXPACQ,  OperDate);
    Sрprпк = min(Sрпп, Sprпк);
    Sдprпк = Sдprпк - Sрprпк;
   
    if(SprПК > 0)
       Документ.CarrySum = SДprПК;
       stat = СоздатьДокумент (Документ, DocID);
       if (stat == 0)
          stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC,     DocID, -Документ.CarrySum, Операция.CredOperID);
          if (stat != 0) return stat; end;
          stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_EXPPERC_ACQ, DocID, -Документ.CarrySum, Операция.CredOperID);
          if (stat != 0) return stat; end;
          stat = ИзменитьРегистр(Договор.Crd_Kind, Договор.creditnumber, TDR_ACQCRD,      DocID, -Документ.CarrySum, Операция.CredOperID);
       end;
    end;

    return stat;
end;
