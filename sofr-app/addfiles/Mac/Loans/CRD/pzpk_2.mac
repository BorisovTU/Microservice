/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pzpk_2.mac
 Description : Создание документа по шагу операции (Уплата неустойки за просроч.задолженность)

 Programmer  : Zigel Petr
 07.10.08    : Создан
-----------------------------------------------------------------------------------*/
import macperc, sbcrdinter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   var stat = 0;
   var DocID = 0;
   var Sн1 = $0, Sопп1 = $0, Sоп1 = $0, Sост1 = $0, Sпг1 = $0;
   var Concession: date;

   SetBuff (DutyData, Data);
   Документ.InDocID = DutyData.PaymentID;
 
   Concession = LnSelectValue("select t_concession from dasgmtparm_dbt where t_creditnumber = " + LastBindedCess(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref), V_DATE);

   Sн1 = GetPaySum(DS_EXPDUTYFINE, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
   Sост1 = ОстатокРегистра(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_PENALTI_CRD, Concession); 

   Sпг1 = LnSelectValue("select sum(t_claimsum) from dplanfact_dbt where t_objecttypeid_ref = " + Операция.ObjectTypeID_Ref + " and t_objectnumber_ref = " + Операция.ObjectID_Ref + " and t_credoperdate between " + SQLDate(Concession) + " and " + SQLDate(OperDate) + " and t_dutystageid_ref = " + DS_EXPDUTYFINE , V_MONEY);

   Sоп1 = max(Sост1 - Sпг1, 0);
   Sопп1 = min(Sн1, Sоп1);

   if ((Sн1 - Sопп1) > 0)
      Документ.CarrySum = Sн1 - Sопп1;
      stat = СоздатьДокумент(Документ, DocID);
   end;

   return stat;
END;
