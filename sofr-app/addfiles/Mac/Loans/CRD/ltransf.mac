/*
$Name:             ltransf.mac
$Module:           Šà¥¤¨â®¢ ­¨¥
$Description:       ª¥â­ë© à¥¦¨¬ ¯¥à¥¢®¤  ááã¤
*/
/*===============================================================================
     ª¥â­ë© à¥¦¨¬ ¯¥à¥¢®¤  ááã¤
=================================================================================*/
import LoansFind, "total.mac", SbCrdInter,
       "lgo_func.mac", "crdRunGroupOp.mac", "lgo_opstruct.mac";

record lobject ("lobject.dbt",  "loans.def");
record lcase   ("lbrfcase.dbt", "loans.def");

macro StartTrnLoanTransferGroup(OperDate       : date,
                                CarryDate      : date,
                                DateEndCalcPerc: date,
                                BriefCaseId    : integer,
                                Fiz            : string,
                                Jur            : string,
                                CalcPercDown   : integer,
                                CalcPercUp     : integer
                               )
   VAR
     workMode = GROUPOP_WM_INONESESSION,
     OpInitStruct = NULL, selobj = false, ConvID = 0, stat = 0,
     obj = TransferOperation(), R;

   BegAction(1, "‚ë¯®«­¥­¨¥ ®¯¥à æ¨¨. †¤¨â¥, íâ® ¬®¦¥â § ­ïâì ¢à¥¬ï.", false);

   OpInitStruct = GroupOpInitStruct(workMode, selobj, false);

   obj.OperDate        = OperDate;
   obj.CarryDate       = CarryDate;
   obj.CalcDate        = DateEndCalcPerc;
   obj.BriefCaseId     = BriefCaseId;
   obj.Fiz             = Fiz;
   obj.Jur             = Jur;
   obj.CalcPercDown    = CalcPercDown;
   obj.CalcPercUp      = CalcPercUp;
   obj.InitStruct      = OpInitStruct;
   obj.FNCash          = {OperDprt};

   GetRegistryValue("RS-LOANS\\€Š…’›… …€–ˆˆ\\……‚„ ‘‘“„\\‚ˆ„_‡€“‘Š€", V_INTEGER, ConvID, stat);
   IF ((stat != 0) OR (ConvID == 0))
      LoansError("¥ § ¤ ­® §­ ç¥­¨¥ ­ áâà®©ª¨ à¥¥áâà  'RS-LOANS\€Š…’›… …€–ˆˆ\……‚„ ‘‘“„\‚ˆ„_‡€“‘Š€'!");
      EndAction(1);
      RETURN 1;
   END;

   R = RunGroupOp(ConvID, obj, OpInitStruct);
   EndAction(1);

   RETURN R;
OnError(err)
      IF (ValType(err.Err) == V_INTEGER)
         LoansError(err.Err + " " + err.Message);
      ELSE
         LoansError("18644. è¨¡ª  ¢ë¯®«­¥­¨ï ®¯¥à æ¨¨");
      END;

      EndAction(1);
      RETURN 0;
END;

MACRO FillFileGroupLoanTransfer(OperDate     : date,
                                BriefCaseId  : integer,
                                Fiz          : string,
                                Jur          : string,
                                CalcDate     : date,
                                CalcPercDown : integer,
                                CalcPercUp   : integer,
                                StLoansDate  : date)
   VAR RSDcmd = NULL, Cnt = -1 * GetCNum();
   VAR query : string = "", stat = 0;

   BegAction(1, "â¡®à ®¡ê¥ªâ®¢. †¤¨â¥, íâ® ¬®¦¥â § ­ïâì ¢à¥¬ï.", false);

   // ’ ¡«¨æë ¤«ï ª®­¢¥©¥à 
   RunStoredFunc("RSO_LoansRsBus.FillWSConveerCase", V_INTEGER, NULL, 0, Cnt, 0, 0,
                 -1,
                  OperDate,
                 {OperDprt},
                  BriefCaseID);

   // ¡ï§ â¥«ìáâ¢ 
   LgoSqlExec("begin RSI_LoansRisk.FillGroup_Pay_For_CaseGr(?,?,?,?,?,?,?); end;",
                0, Cnt, 0, -1, StLoansDate, Fiz, Jur);

   
   LgoSqlExec("begin RSI_LoansRisk.CalcRiskGroup(?); end;", OperDate);
   
   // ­ ç¨á«¨¬ ¯à®æ¥­âë
   IF ((CalcPercDown == 1) OR (CalcPercUp == 1))
      LgoSqlExec("begin LoansFillPayment.RSI_FillPaymentForGroupRiskOp(?,?,?,?,?); end;",
                 CF_RISK, OperDate, CalcDate, CalcPercDown, CalcPercUp);
   END;

   EndAction(1);
END;

macro ReportPrintHeader()
[ ];
[ ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ  ¥à¥¢®¤ ááã¤   ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»];
[ ÇÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶];
[ º      ³               ³                     ³                    ³                    ³                                   ³                                   ³                  º];
[ º¡ê¥ªâ³ ®¬¥à ®¡ê¥ªâ  ³     ‚¨¤ ªà¥¤¨â      ³       ‡ ¥¬é¨ª      ³      ®àâä¥«ì      ³             ¥à¥¢®¤ ¨§            ³             ¥à¥¢®¤ ¢             ³¥§ã«ìâ â ®¯¥à æ¨¨º];
[ ÇÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶];

    return 0;
end;/*ReportPrintHeader*/


macro ReportPrintLine(ObjectTypeID,
                      ObjectNumber,
                      CreditTypeID,
                      Loaner,
                      CaseID,
                      GroupOUT,
                      GroupIN,
                      Res)

   var    strStatus = "", strObject = "---", CaseName = "",
          GroupOUT_ = "", GroupIN_ = "";

   if   (Res == 0) strStatus = "“¤ ç­® § ¢¥àè¥­®";
   elif (Res == 1) strStatus = "˜ˆŠ€";
   elif (Res == 2) strStatus = "ˆáª«îç¥­";
   end;

   IF (Loans_FindObject(ObjectTypeID, lobject))
      strObject = lobject.ShortName;
   END;

   IF (Loans_FindCASE(CaseID, lcase))
       CaseName = lcase.BriefcaseName;
   END;

[ º######³###############³#####################³####################³####################³###################################³###################################³##################º]
(  strObject,
   ObjectNumber,
   FindTypeCrd(CreditTypeID),
   FindClient (Loaner),
   CaseName,
   GroupOUT_,
   GroupIN_,
   strStatus);

    return 0;
end;/*ReportPrintLine*/

macro ReportPrintFooter( )

[ ÓÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½];
end;
