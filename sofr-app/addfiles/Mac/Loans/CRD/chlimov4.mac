/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : chlimp4.mac
 Description : Создание документа при вводе лимита овердрафта,
               увеличение неиспользованного лимита

 Programmer  : Tereschenko FS
 22.01.04    : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, total;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record Сумма       ("SUM.",         "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
  var stat            = 0;
  var ИзмЛим, ЛимитДо, ЛимитПосл: moneyl; /* Лимит до выполнения операции */
  var НОД_До: moneyl;

  var DocID:  integer;
  setbuff(Сумма, Sum);

  НОД_До = ОстатокРегистра(LO_KARTA, Договор.CreditNumber, TDR_LIM, OperDate);
  ЛимитПосл = Сумма(0);
  ЛимитДо   = GetLimRest(Договор.CreditNumber, TDR_LIMDUTY, OperDate);

  ИзмЛим    = ЛимитДо - ЛимитПосл + НОД_До;

  IF (ИзмЛим < $0)

      Документ.CarrySum = -ИзмЛим;
      stat = СоздатьДокумент(Документ, DocID);

      IF ((ЛимитПосл > ЛимитДо) and (stat == 0))
        stat = ИзменитьРегистр(LO_KARTA, Договор.CreditNumber, TCLTR_LIMDUTY, DocID, -ИзмЛим);
      END;
  END;

  Return stat;
End;