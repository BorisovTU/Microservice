/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pzpk_3.mac
 Description : Создание документа по шагу операции (Доначисление срочных % (опред. доход))

 Programmer  : Zigel Petr
 07.10.08    : Создан
-----------------------------------------------------------------------------------*/

import macperc, SbCrdInter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var DocID:integer = 0;
    var stat :integer = 0;
    VAR PercChargeType = "";

    SetBuff (DutyData, Data);  
   Документ.InDocID = DutyData.PaymentID;

   /* Здесь работаем только с первой категорией качества */
   IF (NOT НадежныйДоговор(Договор.CreditNumber, Договор.Crd_kind, OperDate)) 
       return 0; 
   END;

   IF (NOT GetPercChargeType(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, PercChargeType))
      MsgBox("Ошибка получения значения: НАЧИСЛ_ПРОЦ_ПЕРЕД_ОПЛАТОЙ");
      return 1;
   END;

   IF (StrUpr(trim(PercChargeType)) == "ON")
   
      Документ.CarrySum = getPaymentField(DS_PERC,6, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref );
      stat = СоздатьДокумент(Документ, DocID);
      if(stat == 0)
        stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_CLAIM, 0, Документ.CarrySum, Операция.CredOperID);
      end;
   END;

   return stat;
end;