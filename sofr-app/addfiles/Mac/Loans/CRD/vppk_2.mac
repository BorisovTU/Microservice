/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : vppk_2.mac
 Description : Создание документа по шагу операции (Доначисление % (опред. доход))

 Programmer  : Zigel Petr
 09.10.08    : Создан
-----------------------------------------------------------------------------------*/
import macperc, sbcrdinter;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record DutyData    ("dutydata.tmp", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var stat = 0;
    var DocID = 0;

    SetBuff(DutyData, Data);
  
    IF(НадежныйДоговор(Договор.CreditNumber, Договор.Crd_kind, OperDate)) 
    
       Документ.CarrySum = GetPaySum(DS_ADDPERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
       stat = СоздатьДокумент(Документ, DocID);
       if(stat == 0)
          stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_CLAIM, DocID, Документ.CarrySum, Операция.CredOperID);
       end;
    end;

    return stat;
END;