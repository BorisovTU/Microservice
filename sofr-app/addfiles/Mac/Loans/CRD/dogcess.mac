/*
$Name:             dogcess.mac
$Module:           Кредитование
$Description:      Договор уступки прав требования: договор купли-продажи закладных
*/
import ActiveX, total, replib, dlwreps, replib, global, acc_crd, SbCrdInter;

private record credit_c ("credit_c.dbt", "loans.def");
private const TemplateName = "dogcess.dot";
private record cur_credit ("credit_c", "loans.def");
private file   bankdprt    ("bankdprt.dbt", "bank.def");

macro RunReport(CreditBuf)

      var axerr:object = null, Code:string , INN:string, KPP:string, coracc:string = "";

      SetBuff(credit_c, CreditBuf);
      private var   OurBank = TLoansClient;

      if(not OurBank.GetRecord({OurBank}))
         Exit(1);
      end;
      if (not depclnt.GetRecord(credit_c.ClientID_Ref))
          RunError ("Не найден заещик в справочнике клиентов");
      end;

      bankdprt.partyid = credit_c.ClientID_Ref;
      if(getEQ(bankdprt))                       
          coracc = bankdprt.coracc;
      end;

      SetOutput (GetTxtFileName("dogcess_rep"));
      
      println(TemplateName);             //Имя файла-шаблона
      println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа

      /* № договора */
      [~CrdNum];
      println (credit_c.UsCreditNumber);
      /* Дата начала договора */
      [~RegDate];
      println (DateToStringFull (credit_c.RegDate));

      /* Сокращенное название банка*/
      [~Bank];
      println(OurBank.ShortName);
      [~Bank2];
      println(OurBank.ShortName);
  
      /* Сокращенное имя контрагнета */
      [~Client];
      println(depclnt.ShortName);
      [~Client2];
      println(depclnt.ShortName);

      /* Фактический адрес контрагента */
      [~C_AddressF];
      println (depclnt.AddressF);

      /* БИК */
      [~C_BIC];
      println(depclnt.GetCode(3/*БИК*/));

      /* Коррсчет контрагента*/
      [~C_CorrAcc];
      println(coracc);
      /* Название банка-контрагента*/
      [~C_Name];
      println(depclnt.Name);

      Code = depclnt.GetCode(16/*ИНН*/);

      IF (Trim(Code) != "")
         IF (Index(Code, "/") != 0)
            INN        = SubStr(Code, 1,                  Index(Code, "/") - 1);  // ИНН
            KPP        = SubStr(Code, Index(Code, "/")+1, Strlen(Code));          // КПП
         ELSE
            INN        = Code;
            KPP        = "";
         END;
      END;

      /* ИНН */
      [~C_INN];
      println(INN);
      /* КПП */
      [~C_KPP];
      println(KPP);


      Code = CONST_INN;

      IF (Trim(Code) != "")
        IF (Index(Code, "/") != 0)
           INN        = SubStr(Code, 1,                  Index(Code, "/") - 1);  // ИНН
           KPP        = SubStr(Code, Index(Code, "/")+1, Strlen(Code));          // КПП
        ELSE
           INN        = Code;
           KPP        = "";
        END;
      END;

         /* ИНН */
      [~B_INN];
      println(INN);
      
      /* КПП */
      [~B_KPP];
      println(KPP);

      /* Фактический адрес банка */
      [~B_AddressF];
      println ( CONST_FACTADDR );
      
      /* Коррсчет банка*/
      [~B_CorrAcc];
      println ( CONST_CORRACC );
      
      /*название банка*/
      [~B_Name];
      println(CONST_NAMEBANK);
      
      /*БИК*/
      [~B_BIC];
      println(CONST_BIK);

      /* Номер телефона контрагента */
      [~C_Phone];
      println(GetPhone(depclnt.CodClient, depclnt.LegalForm));
      
      /* Номер телефона банка */
      [~B_Phone];
      println(GetPhone(OurBank.CodClient, OurBank.LegalForm));

   var tag = SetOutput (NULL, false);
   return tag;

   onError(axerr)
      SetOutput(NULL, false);
      RunError;
end;

macro PrintLoansReport(CreditBuf)
    var tag = RunReport(CreditBuf);
    DLWREPS_PrintReportFromTagFile (tag);
    MsgBoxEx("Договор купли-продажи сформирован.");
    Exit(0);
    onError(axerr)
        if(axerr.Code != 0)
             WordError(axerr, false);
        end;
        Exit(1);
end;