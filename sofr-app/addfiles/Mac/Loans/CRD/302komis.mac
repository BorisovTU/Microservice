/*
 ╔═════════════════════════════════════════════════════════════════════════════════╗
 ║ Пакетное открытие счетов по категориям "Требования по прочим операциям"         ║
 ║                                        "Расчеты с контрагентами"                ║
 ║                                                                                 ║
 ╟─────────────────────────────────────────────────────────────────────────────────╢
 ║ Программист: TFS                                                                ║
 ║ Дата       : 22.11.2007                                                         ║
 ╚═════════════════════════════════════════════════════════════════════════════════╝ */
import SbCrdInter, total, "acc_crd.mac";

VAR CatTypeKD   = TArray, // Массив категорий по кредитным договорам
    CatTypeBK   = TArray, // Массив категорий по всем остальным объектам

    rsKD        = NULL,
    rsBK        = NULL,
    OperDate  : date    = {curdate},
    CredOperID: integer = 0;

   IF (NOT GetDate(OperDate, "Введите дату операции"))
      RETURN FALSE;
   END;

PRIVATE MACRO ШапкаПротокола()
   [╓─────────────┬────────────┬─────────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────╖];
   [║ Вид объекта │ ID объекта │      Название объекта   │ Выполение операции                                                                         ║];
   [║             │            │                         │                                                                                            ║];
   [╟─────────────┼────────────┼─────────────────────────┼────────────────────────────────────────────────────────────────────────────────────────────╢];
END;

PRIVATE MACRO СообщениеПротокола(CredOperID: integer, ObjID: integer, ObjN: integer)
   VAR Результат: string = "";
   MACRO ВО(ObjID: integer)
      RETURN CRsdCommand("SELECT T_SHORTNAME FROM DLOBJECT_DBT WHERE T_OBJECTID = ?", "SHORTNAME", ObjID, V_STRING);
   END;

   MACRO Имя(ObjN: integer)
      RETURN CRsdCommand("SELECT T_USCREDITNUMBER FROM DCREDIT_C_DBT WHERE T_CREDITNUMBER = ?", "SHORTNAME", ObjN, V_STRING);
   END;

   IF (CredOperID <= 0)
      Результат = "Ошибка: " + GetMO_LoansError();
   ELSE
      Результат = "Успешно";

   END;

   [║ ############│ ###########│ ####################### │ ###########################################################################################║]
      (
      ВО(ObjID),
      ObjN,
      Имя(ObjN),
      Результат:w
      );

END;

PRIVATE MACRO ИтогПротокола()
   [╚═════════════╧════════════╧═════════════════════════╧════════════════════════════════════════════════════════════════════════════════════════════╝];
END;

// Открытие счетов по Кредитным договорам и БГ
   CatTypeKD(0) = CF_DEMAND_OTHER_OP; // Требования по прочим операциям
   CatTypeKD(1) = CF_COVENANT;        // Расчеты с поставщиками, подрядчиками и покупателями
   CatTypeKD(2) = CF_REZPERC;
   CatTypeKD(3) = CF_REZEXPPERC;

   rsKD = LnGetRecordSet(
   "SELECT * FROM DCREDIT_C_DBT WHERE " +
   "(" +
     "SELECT COUNT(1) FROM DACC_CRD_DBT WHERE " +
           " T_OBJECTNUMBER = T_CREDITNUMBER " +
       " AND T_OBJECTID     = T_CRD_KIND " +
       " AND T_CREDITACCOUNTTYPE IN ("+CatTypeKD(0)+","+CatTypeKD(1)+","+CatTypeKD(2)+","+CatTypeKD(3)+") "+
   ") < " + CatTypeKD.Size() +
   " AND T_CRD_KIND IN (1, 21)");


   ШапкаПротокола();
   SetLoansGroupMode(TRUE);
   WHILE (rsKD.MoveNext())
      CredOperID = MakeOperation(rsKD.Value("T_CREDITNUMBER", NULL, V_INTEGER),
                                 rsKD.Value("T_CRD_KIND",      NULL, V_INTEGER),
                                 OP_ACC, 0, OperDate, CatTypeKD, -1);

      СообщениеПротокола(CredOperID, RSKD.Value("T_CRD_KIND", NULL, V_INTEGER), RSKD.Value("T_CREDITNUMBER", V_INTEGER));
   END;

// Открытие счетов по остальным видам объектов (не КД и БГ)
   CatTypeBK(0) = CF_REZPERC;
   CatTypeBK(1) = CF_REZEXPPERC;

   rsBK = LnGetRecordSet(
   "SELECT * FROM DCREDIT_C_DBT WHERE " +
   "(" +
     "SELECT COUNT(1) FROM DACC_CRD_DBT WHERE " +
           " T_OBJECTNUMBER = T_CREDITNUMBER " +
       " AND T_OBJECTID     = T_CRD_KIND " +
       " AND T_CREDITACCOUNTTYPE IN ("+CatTypeBK(0)+","+CatTypeBK(1) + ")) < " + CatTypeBK.Size() +
   " AND T_CRD_KIND NOT IN (1, 21)");

   WHILE (rsBK.MoveNext())
      CredOperID = MakeOperation(rsBK.Value("T_CREDITNUMBER", NULL, V_INTEGER),
                                 rsBK.Value("T_CRD_KIND",      NULL, V_INTEGER),
                                 OP_ACC, 0, OperDate, CatTypeBK, -1);

      СообщениеПротокола(CredOperID, rsBK.Value("T_CRD_KIND", NULL, V_INTEGER), rsBK.Value("T_CREDITNUMBER", V_INTEGER));
   END;
   SetLoansGroupMode(FALSE);
   ИтогПротокола();

OnError
   SetLoansGroupMode(FALSE);
