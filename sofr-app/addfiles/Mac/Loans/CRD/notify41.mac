/*
$Name:             notify41.mac
$Module:           Кредитование
$Description:      Уведомление о полном погашении всей задолженности
*/
import ActiveX, total, replib, "notifyclass.mac";

private record cur_credit ("credit_c.dbt", "loans.def");
private record AdviceBuf ("advice.dbt", "loans.def");

private VAR {GROUP_MODE};
private var i: integer = 1, workpath,ErrCode;
private ARRAY str;

IF (GetRegistryValue ("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, workpath, ErrCode) != V_STRING)
    msgBox(ErrCode);
    return true;
END;

private macro УвеличитьДлину(str, len)
var spacestr: string = " ";
    while (strlen(str) != len)
          str = str + spacestr;
    end;
    return str;
end;

MACRO PrinHead(obj)
str(0)  = "Реквизиты банка:                                                            Реквизиты заемщика:";
str(1)  = УвеличитьДлину(String({Name_Bank}),76) + obj.ИмяКлиента;
str(2)  = УвеличитьДлину(String("ИНН" + {INN_Bank}),76) + obj.АдресКлиента;
str(3)  = УвеличитьДлину(String("БИК" + {MFO_Bank}), 76);
str(4)  = "Кор.счет " + {CORAC_Bank};
str(5)  = "Адрес " +  {Post_Addr};
str(6)  = "                                               Уведомление";
str(7)  = "                                    О полном погашении задолженности";
str(8)  = "                                       № " + AdviceBuf.AdviceUsNumber + " от " + AdviceBuf.AdviceDate;
str(9)  = "";                         
str(10) = "                               Уважаемый(ая) " + obj.ИмяКлиента + "!";
str(11) = "    Сообщаем об окончательном погашении задолженности  по заключенному Кредитному договору № " + obj.UsCreditNumber;
str(12) = " от " + obj.RegDate;
str(13) = " между " + {Name_Bank} + " и " + obj.ИмяКлиента;
end;

macro PrintLoansReport(_AdviceBuf, _FIO, _Post)
file  prnoper() txt write;
var  indexxx:integer;
var namefile= "", fname = "";
var UsCreditNumber= "";
var obj;
      SetBuff(AdviceBuf, _AdviceBuf);
      obj = LoansNotify(AdviceBuf);
      PrinHead(obj);

      if ({GROUP_MODE})
         fname = "Notify";

         NameFile = workpath + "\\" + fname + "_" + String(AdviceBuf.AdviceID) + ".txt";
         if (NOT Open(prnoper, NameFile))
            return 1;
         end
      end;

      indexxx = 0;
      while(indexxx <= (13))
         if({GROUP_MODE})
           Insert(prnoper, str(indexxx));
         else
           [ #] (str(indexxx));
         end;
         indexxx = indexxx + 1;
      end;

	  CRSDCommand ("UPDATE DADVICE_DBT SET T_PATHPRINTFORM = ? "
					" WHERE T_ADVICEID = ? ",
					"ppf", fname + "_" + String(AdviceBuf.AdviceID) + ".txt",
					"aid", AdviceBuf.AdviceID,
					V_GENOBJ);

      if({GROUP_MODE})
         Close(prnoper);
      end;
      return 0;
end;
