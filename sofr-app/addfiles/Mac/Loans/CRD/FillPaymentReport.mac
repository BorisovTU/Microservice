/*
$Name: FillPaymentReport.mac
$Module: เฅคจโฎขญจฅ
$Description: ชเฎแ ฏฎแโเฎฅญจ๏ ฎโ็ฅโ คซ๏  ใญจขฅเแซ์ญฎฉ เงญฎแชจ
*/
/************************************************************
* ชเฎแ ฏฎแโเฎฅญจ๏ ฎโ็ฅโ คซ๏  ใญจขฅเแซ์ญฎฉ เงญฎแชจ      *
* ฎงคญ: 28.08.2012   ฎงคญ๏ชฎข ..                       *
* 24.06.2013    ฎกเกฎโช "จแชซ๎็จโ์ จง จโฎฃฎขฎฉ แใฌฌ๋"     *
************************************************************/

import LoansFind, total;
var bs : string =" "; 
var upp,rpp,ccp,pay,rest:money;

 // ฎกขซฅญจฅ แฌฎฃฎ ขฅเๅญฅฃฎ ใเฎขญ๏ ฏเจ โเฅๅใเฎขญฅขฎฉ เงญฎแชฅ 
MACRO AddHighLvl(objid:integer,objn:integer,mode:integer)
   Var RSD_Ref = NULL,
   RSD_Data = NULL;
          
   RSD_Ref = CRsdCommand ("SELECT PM.T_REFERENCE FROM dpayment_tmp pm " +
                          "WHERE PM.T_PARENTID = 0 " + 
                          "GROUP BY PM.T_REFERENCE", V_GENOBJ);

   WHILE (RSD_Ref.MoveNext)         
      RSD_Data = CRsdCommand ("SELECT MIN(T_BEGDATE) AS MinBegDate, MAX(T_ENDDATE) AS MaxEndDate, SUM(T_SUM) as Sum,  SUM(T_PAYSUM) as PaySum, SUM(T_RESTNOPAY) as RestNoPay, SUM(T_UPP_SUM) as UPP_SUM, SUM(T_RPP_SUM) as RPP_SUM, SUM(T_CCP_SUM) as CCP_SUM " +
                              "FROM dpayment_tmp " + 
                              "WHERE T_PARENTID  = 0 AND T_REFERENCE = ? ", "Reference", RSD_Ref.value("T_REFERENCE"), V_GENOBJ);
      RSD_Data.MoveNext;
         
      CRsdCommand ("INSERT INTO dpayment_tmp (T_OBJID, T_OBJN, T_BEGDATE, T_ENDDATE, T_SUM, T_PAYSUM, T_RESTNOPAY, T_PARENTID, T_REFERENCE,  T_SYSTEMOPERATIONID, " +
                                                "T_CREDITNUMBER_REF,  T_PAYMENTID_REF, T_TYPEOPERNUMBER, T_UPP_SUM, T_RPP_SUM, T_CCP_SUM, T_STRNAME) " + 
                   "SELECT -1, -1, ?, ?, ?, ?, ?, 0, ?, PM.T_SYSTEMOPERATIONID, ?, 0, PM.T_TYPEOPERNUMBER, ?, ?, ?, PM.T_STRNAME " +
                     "FROM dpayment_tmp pm " +
                    "WHERE pm.T_PARENTID  = 0 AND pm.T_REFERENCE = ? " +
                      "AND ROWNUM = 1; ",
                           "MinBegDate",   RSD_Data.value("MinBegDate"), 
                           "MaxEndDate",   RSD_Data.value("MaxEndDate"),
                           "Sum",          RSD_Data.value("Sum"),
                           "PaySum",       RSD_Data.value("PaySum"),
                           "RestNoPay",    RSD_Data.value("RestNoPay"),                                
                           "Reference1",   RSD_Ref.value("T_REFERENCE"),
                           "objn",         objn,
                           "UPP_SUM",      RSD_Data.value("UPP_SUM"),
                           "RPP_SUM",      RSD_Data.value("RPP_SUM"),
                           "CCP_SUM",      RSD_Data.value("CCP_SUM"), 
                           "Reference2",   RSD_Ref.value("T_REFERENCE"),                                
                            V_GENOBJ);                                                              
   END;    
END;

//ไฎเฌจเใฅฌ "ขจเโใซ์ญใ๎ เงญฎแชใ" ฏฎ แใ้ฅแโขใ๎้จฌ งฏจแ๏ฌ ข planfact.dbt

MACRO fillpayment(objid:integer,objn:integer,mode:integer,crdopid:integer)
   VAR RSDcmd : object = NULL;
   VAR rs          : object = NULL;
   VAR RSDcmd1 : object = NULL;

   IF(LnSelectValue("SELECT count(t_id) FROM dpayment_tmp WHERE t_parentid = 0", V_INTEGER)==0)

      RSDcmd = RsdCommand (RslDefCon, "INSERT INTO dpayment_tmp (t_reference, t_objid,t_objn,t_systemoperationid,t_creditnumber_ref, t_typeopernumber, t_parentid,"+
            " t_strname,t_begdate,t_enddate,t_upp_sum,t_rpp_sum,t_ccp_sum,t_sum,t_paysum,t_restnopay,t_id,t_paymentid_ref)"+
            " SELECT gds.t_number,t_objecttypeid_ref,t_objectnumber_ref,t_systemoperationid_ref,t_creditnumber,t_typeopernumber_ref,0, "+
            " MAX (gds.t_name), MIN (pf.t_calcbegdate), MIN (pf.t_calcenddate),SUM (pf.t_upp_sum), SUM (pf.t_rpp_sum), SUM (pf.t_ccp_sum), SUM (pf.t_claimsum),"+
            " SUM (pf.t_actualamount), SUM (pf.t_underpaysum),0,0 FROM dplanfact_dbt pf, dgrpdebts_dbt gds WHERE pf.t_parentid = gds.t_number AND pf.t_credoperid_ref = ? "+
            " AND pf.T_FLAGEXCFROMTOTAL != 'X' "+
            " GROUP BY gds.t_number, "+
            " t_objecttypeid_ref,"+
            " t_objectnumber_ref, "+
            " t_systemoperationid_ref, "+
            " t_creditnumber, "+
            " t_typeopernumber_ref");
      RSDcmd.addParam ("crdopid",  RSDBP_IN); RSDcmd.value ("crdopid")    = crdopid; 
      RSDcmd.execute();  
   
      if((objid == LO_CREDIT) AND (mode == -1)) // โเฅๅใเฎขญฅข๏ เงญฎแช (ข ฎฏฅเๆจจ ใ็แโขฎขซจ คฎ็ฅเญจฅ ฎก๊ฅชโ๋ - ) 
        AddHighLvl(objid, objn, mode);              
      END; 
   END;
END;

MACRO fillpayment_rlt(objid:integer,objn:integer,mode:integer,crdopid:integer)
   VAR RSDcmd : object = NULL;   

   IF(LnSelectValue("SELECT count(t_id) FROM dpayment_tmp WHERE t_parentid = 0", V_INTEGER)==0)
         
      RSDcmd = RsdCommand (RslDefCon, "INSERT INTO dpayment_tmp (t_reference, t_objid,t_objn,t_systemoperationid,t_creditnumber_ref, t_typeopernumber, t_parentid,"+
            " t_strname,t_begdate,t_enddate,t_upp_sum,t_rpp_sum,t_ccp_sum,t_sum,t_paysum,t_restnopay,t_id,t_paymentid_ref)"+
            " SELECT gds.t_number,t_objecttypeid_ref,t_objectnumber_ref,t_systemoperationid_ref,t_creditnumber,t_typeopernumber_ref,0, "+
            " MAX (gds.t_name), MIN (pf.t_calcbegdate), MIN (pf.t_calcenddate),SUM (pf.t_upp_sum), SUM (pf.t_rpp_sum), SUM (pf.t_ccp_sum), SUM (pf.t_claimsum),"+
            " SUM (pf.t_actualamount), SUM (pf.t_underpaysum),0,0 FROM drlt_pfact_dbt pf, dgrpdebts_dbt gds WHERE pf.t_parentid = gds.t_number AND pf.t_credoperid_ref = ? "+
            " AND pf.T_FLAGEXCFROMTOTAL != 'X' "+
            " GROUP BY gds.t_number, "+
            " t_objecttypeid_ref,"+
            " t_objectnumber_ref, "+
            " t_systemoperationid_ref, "+
            " t_creditnumber, "+
            " t_typeopernumber_ref");
       RSDcmd.addParam ("crdopid",  RSDBP_IN); RSDcmd.value ("crdopid")    = crdopid; 
       RSDcmd.execute(); 
      
      if((objid == LO_CREDIT) AND (mode == -1)) // เฅๅใเฎขญฅข๏ เงญฎแช (ข ฎฏฅเๆจจ ใ็แโขฎขซจ คฎ็ฅเญจฅ ฎก๊ฅชโ๋ - ) 
         AddHighLvl(objid, objn, mode);           
      END;      
   END;
END;

MACRO fillperc(crdopid:integer)
   VAR RSDcmd : object = NULL;
   
   IF(LnSelectValue("SELECT count(1) FROM DPERCPAY_TMP", V_INTEGER) == 0)
      RSDcmd = RsdCommand (RslDefCon, "INSERT INTO DPERCPAY_TMP ( T_ID, T_RATEID, T_BEGINDATE, T_REST, T_PERCSUM, T_PERCRATE, T_OBJECTTYPEID, T_OBJECTNUMBER, T_ROUNDOFFERROR, T_PERIODENDDATE, T_DUTYSTAGE ) " +
                                      "SELECT PD.T_ID_REF, PD.T_RATEID, PD.T_PERCDATE, PD.T_REST, PD.T_PERCSUM, RSI_Loans_TrffAlg.GetTrffRate(PD.T_OBJECTTYPEID, PD.T_OBJECTNUMBER, LCR.T_TYPERATEID_REF , PD.T_PERCDATE), "+
                                             "PD.T_OBJECTTYPEID, PD.T_OBJECTNUMBER, PD.T_ROUNDOFFERROR, PD.T_PERIODENDDATE, PD.T_DUTYSTAGE "+
                                        "FROM dperc_day_dbt pd, dlcusrate_dbt lcr  " + 
                                       "WHERE PD.T_CREDOPID_REF = ? " + 
                                         "AND LCR.T_RATEID_REF =  PD.T_RATEID");
      RSDcmd.addParam ("crdopid",  RSDBP_IN); RSDcmd.value ("crdopid")    = crdopid; 
      RSDcmd.execute();  
   END;
END;

MACRO fillperc_rlt(crdopid:integer)
   VAR RSDcmd : object = NULL;
   
   IF(LnSelectValue("SELECT count(1) FROM DPERCPAY_TMP", V_INTEGER) == 0)
      RSDcmd = RsdCommand (RslDefCon, "INSERT INTO DPERCPAY_TMP ( T_ID, T_RATEID, T_BEGINDATE, T_REST, T_PERCSUM, T_PERCRATE, T_OBJECTTYPEID, T_OBJECTNUMBER, T_ROUNDOFFERROR, T_PERIODENDDATE, T_DUTYSTAGE ) " +
                                      "SELECT PD.T_ID_REF, PD.T_RATEID, PD.T_PERCDATE, PD.T_REST, PD.T_PERCSUM, RSI_Loans_TrffAlg.GetTrffRate(PD.T_OBJECTTYPEID, PD.T_OBJECTNUMBER, LCR.T_TYPERATEID_REF , PD.T_PERCDATE), "+
                                             "PD.T_OBJECTTYPEID, PD.T_OBJECTNUMBER, PD.T_ROUNDOFFERROR, PD.T_PERIODENDDATE, PD.T_DUTYSTAGE "+
                                        "FROM drlt_prcd_dbt pd, dlcusrate_dbt lcr  " + 
                                       "WHERE PD.T_CREDOPID_REF = ? " + 
                                         "AND LCR.T_RATEID_REF =  PD.T_RATEID");
      RSDcmd.addParam ("crdopid",  RSDBP_IN); RSDcmd.value ("crdopid")    = crdopid; 
      RSDcmd.execute();      
   END;
END;



MACRO print_level(objid:integer, objn:integer, lvl:integer, space, reference:integer)

   VAR RSDcmd : object = NULL;
   VAR rs          : object = NULL;
       VAR RSDcmd1 : object = NULL;
       VAR rs1     : object = NULL;
   VAR StrName : STRING = "";
   VAR Sum:money = $0;
       
   IF (reference != 0)
      RSDcmd = RsdCommand (RslDefCon, "SELECT t_strname,t_begdate,t_enddate,t_upp_sum,t_rpp_sum,t_ccp_sum,t_sum,t_paysum,t_restnopay,t_reference,t_parentid,t_objid,T_FLAGEXCFROMTOTAL FROM dpayment_tmp WHERE t_objid=? AND t_objN =?  AND t_parentid= ? AND t_reference = ?");
      RSDcmd.addParam ("objid",   RSDBP_IN); RSDcmd.value ("objid")  = objid;
      RSDcmd.addParam ("objn",    RSDBP_IN); RSDcmd.value ("objn")   = objn;
      RSDcmd.addParam ("parent",  RSDBP_IN); RSDcmd.value ("parent") = lvl;         
      RSDcmd.addParam ("reference",  RSDBP_IN); RSDcmd.value ("reference")    = reference; 
      space = space+bs; 
   ELSE
      RSDcmd = RsdCommand (RslDefCon, "SELECT t_strname,t_begdate,t_enddate,t_upp_sum,t_rpp_sum,t_ccp_sum,t_sum,t_paysum,t_restnopay,t_reference,t_parentid,t_objid,T_FLAGEXCFROMTOTAL FROM dpayment_tmp WHERE t_objid=? AND t_objN =?  AND t_parentid= ?");
      IF (lvl != -1)
         RSDcmd.addParam ("objid",   RSDBP_IN); RSDcmd.value ("objid")  = objid;
         RSDcmd.addParam ("objn",    RSDBP_IN); RSDcmd.value ("objn")   = objn;
         RSDcmd.addParam ("parent",  RSDBP_IN); RSDcmd.value ("parent") = lvl;
         space = space+bs;
      ELSE
          RSDcmd.addParam ("objid",   RSDBP_IN); RSDcmd.value ("objid")    = -1;
          RSDcmd.addParam ("objn",    RSDBP_IN); RSDcmd.value ("objn")     = -1;
          RSDcmd.addParam ("parent",  RSDBP_IN); RSDcmd.value ("parent")   =  0;
      END;
   END;
   RSDcmd.execute();  
   rs = RsdRecordset (RSDcmd);
   WHILE (rs.MoveNext )
      strname = space +  rs.value("t_strname");
         [บ################################################## ณ ##########ณ ##########ณ ################ณ ################ณ ################ณ ################ณ ################ณ ################ บ]
         (strname,
          SQL_NVL(rs.value("t_begdate",   NULL,  V_DATE), V_DATE),
          SQL_NVL(rs.value("t_enddate",   NULL,  V_DATE), V_DATE),
          SQL_NVL(rs.value("t_upp_sum",   NULL, V_MONEY), V_MONEY),
          SQL_NVL(rs.value("t_rpp_sum",   NULL, V_MONEY), V_MONEY),
          SQL_NVL(rs.value("t_ccp_sum",   NULL, V_MONEY), V_MONEY),
          SQL_NVL(rs.value("t_sum",       NULL, V_MONEY), V_MONEY),
          SQL_NVL(rs.value("t_paysum",    NULL, V_MONEY), V_MONEY),
          SQL_NVL(rs.value("t_restnopay", NULL, V_MONEY), V_MONEY)
         );
      IF (rs.value("t_parentid") == 0)
         IF (rs.value("t_objid") != -1)
            print_level(objid,objn,rs.value("t_reference"), space, 0) ;
         ELSE
            // foreach_3x(rs.value("t_reference"));
            RSDcmd1 = RsdCommand (RslDefCon, "SELECT T_REFERENCE, T_PARENTID, T_OBJID, T_OBJN FROM DPAYMENT_TMP WHERE T_OBJID != -1 AND T_OBJN != -1 AND T_PARENTID= 0 AND T_REFERENCE = ?");
            RSDcmd1.addParam ("reference", RSDBP_IN); RSDcmd1.value("reference") = rs.value("t_reference");
            RSDcmd1.execute();  
            rs1 = RsdRecordset (RSDcmd1);
            WHILE (rs1.MoveNext )
               print_level(rs1.value("t_objid"), rs1.value("t_objn"), 0, space,rs1.value("t_reference"));
            END; 
         END;
      ELSE
         IF(rs.value("T_FLAGEXCFROMTOTAL") != "X")
         upp  = upp  + SQL_NVL(rs.value("t_upp_sum",   NULL, V_MONEY), V_MONEY);
         rpp  = rpp  + SQL_NVL(rs.value("t_rpp_sum",   NULL, V_MONEY), V_MONEY);
         ccp  = ccp  + SQL_NVL(rs.value("t_ccp_sum",   NULL, V_MONEY), V_MONEY); 
         sum  = sum  + SQL_NVL(rs.value("t_sum",       NULL, V_MONEY), V_MONEY);
         pay  = pay  + SQL_NVL(rs.value("t_paysum",    NULL, V_MONEY), V_MONEY);
         rest = rest + SQL_NVL(rs.value("t_restnopay", NULL, V_MONEY), V_MONEY);
      END;
   END;
   END;
OnError()
    LoansError("่จกช ฏฎแโเฎฅญจฅ ฎโ็ฅโ");
    return false;
END;

MACRO print_head(objid:integer,objn:integer,typeop:integer,dateop:date)
   var TypeName:String = "";
   Var ObjectName:String = "";
   Var SysOpName: String = "";
   Var TypeOpName:String = "";
   record  recLO("lobject") btr;
   record  credit_c("credit_c") btr;
   record  typeoper("type_op") btr;
   record  duty_crd("duty_crd") btr;
   VAR RSDcmd1 : object = NULL;
   VAR rs1 : object = NULL;
   VAR Sum:money = $0;

   IF (Loans_FindObject (objid, @recLo))
      TypeName = recLO.shortname;
   END;
   
   IF(objid == LO_DUTY)
      IF(Loans_FindDuty(objn, @duty_crd))
		ObjectName = duty_crd.usernumber;
   	 END;	 
   ELIF (Loans_FindCrdContract (objn, @credit_c) ) 
      ObjectName = credit_c.uscreditnumber;
   END;
   
   IF (Loans_FindTypeOp (0,typeop, @typeoper) )
      TypeOpName = typeoper.typeopername;

      RSDcmd1 = RsdCommand (RslDefCon, "SELECT t_SYSTEMOPERATIONNAME FROM dsyst_op_dbt WHERE  T_SYSTEMOPERATIONID = ?");
      RSDcmd1.addParam ("systopid",  RSDBP_IN); RSDcmd1.value ("systopid")   =  typeoper.SYSTTYPEOP_REF;
      RSDcmd1.execute();  
      rs1 = RsdRecordset (RSDcmd1);
      IF (rs1.MoveNext)
         SysOpName = rs1.value("t_SYSTEMOPERATIONNAME");
      END;                                       
   END;
  [ ###### : ######################################################################           ] (TypeName,ObjectName);                                                                                    
  [จฏ ฎฏฅเๆจจ: ########################################                                                        ] (SysOpName);                                 
  [จค ฎฏฅเๆจจ: ############################################################                                    ] (TypeOpName);                                                     
  [โ ฎฏฅเๆจจ: ##########                                  ] (dateop); 
  [ษอออออออออออออออออออออออออออออออออออออออออออออออออออัอออออออออออัอออออออออออัอออออออออออออออออัอออออออออออออออออัอออออออออออออออออัอออออออออออออออออัอออออออออออออออออัออออออออออออออออออป];
  [บ คฎซฆฅญญฎแโ์                                     ณ แ็ฅโ ฎโ ณ แ็ฅโ ฏฎ ณ ฅคฎฏซโ๋       ณ เฅกฎขญจ๏      ณ แ็ฅโ          ณ แ็ฅโ          ณ ็จแซจโ์       ณ ฅคฎฏซโ๋        บ];
  [บ                                                   ณ           ณ           ณ ฏเฎ่ซ๋ๅ         ณ ฏเฎ่ซ๋ๅ         ณ โฅชใ้ฅฃฎ        ณ                 ณ                 ณ                  บ];
  [บ                                                   ณ           ณ           ณ ฏฅเจฎคฎข        ณ ฏฅเจฎคฎข        ณ ฏฅเจฎค         ณ                 ณ                 ณ                  บ];
  [ฬอออออออออออออออออออออออออออออออออออออออออออออออออออุอออออออออออุอออออออออออุอออออออออออออออออุอออออออออออออออออุอออออออออออออออออุอออออออออออออออออุอออออออออออออออออุออออออออออออออออออน];
//[บ################################################## ณ ##########ณ ##########ณ ################ณ ################ณ ################ณ ################ณ ################ณ ################ บ]

END;

MACRO print_foot()
VAR Sum:money = $0;
  [ฬอออออออออออออออออออออออออออออออออออออออออออออออออออฯอออออออออออฯอออออออออออุอออออออออออออออออุอออออออออออออออออุอออออออออออออออออุอออออออออออออออออุอออออออออออออออออุออออออออออออออออออน];
  [บ โฎฃฎ:                                                                    ณ ################ณ ################ณ ################ณ ################ณ ################ณ ################ บ](upp,rpp,ccp,sum,pay,rest);
  [ศอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอออออออออออออออออฯอออออออออออออออออฯอออออออออออออออออฯอออออออออออออออออฯอออออออออออออออออฯออออออออออออออออออผ];

END;

MACRO print_body(objid: integer, objN: integer, mode: integer)
   IF (mode == -1)
      //จ้ฅฌ ขแฅ ญใซฅขฎฃฎ ใเฎขญ๏
      print_level(objid, objn, -1, "", 0);
   ELSE
      print_level(objid, objn, 0, "", 0);
   END;
END;

MACRO Print_DailyPercHead(objid:integer,objn:integer)
   var TypeName:String = "";
   Var ObjectName:String = "";   
   record  recLO("lobject") btr;
   record  credit_c("credit_c") btr;  
   record  duty_crd("duty_crd") btr;
   
   IF (Loans_FindObject (objid, @recLo))
      TypeName = recLO.shortname;
   END;
   
   IF(objid == LO_DUTY)
     IF(Loans_FindDuty(objn, @duty_crd))
		 ObjectName = duty_crd.usernumber;
     END;	 
   ELIF (Loans_FindCrdContract (objn, @credit_c) ) 
      ObjectName = credit_c.uscreditnumber;
   END;
   
  [                                                                                                             ];
  [  กซจๆ ฅฆฅคญฅขญฎฃฎ เแ็ฅโ ฏเฎๆฅญโฎข ง ชฆค๋ฉ คฅญ์ โฅชใ้ฅฃฎ ฏฅเจฎค ฏฎ ### : ############################](TypeName,ObjectName); 
  [ษออออออออออออัอออออออออออออออัอออออออ=อัอออออออออออออออ=อัอออออออ=อออ===========อ==อป];
  [บ    โ    ณ  แโโฎช กง๋ ณ โขช  ณ ใฌฌ ฏเฎๆฅญโฎข |  ฎฃเฅ่ญฎแโ์ ฎชเใฃซฅญจ๏  บ];
  [บ            ณ               ณ โเจไ  ณ                 ณ                          บ];
  [บ            ณ               ณ         ณ                 ณ                          บ];
  [ฬออออออออออออฯออออออออ====อออฯออออออ=ออฯอออออออออออ=อออออฯออออออออออออ==อ===ออออออออน];  
END;

MACRO Print_DailyPercFoot(Sum:Money)
  [ฬออออออออออออุอออออออออออออออุอออออ=อออุออออออออออออออ=อ=ุอออออออ=อออ=============ออน];
  [บ   :   ณ               ณ         ณ ############### ณ                          บ](Sum:c);
  [ศออออออออออออฯออออออออ====อออฯออออออ=ออฯออออออออออออออ=ออฯออออออออออออ==อ===ออออออออผ]; 
END;

MACRO Print_DailyPercBody(objid: integer, objN: integer)  
   Var RS = NULL; 
   Var DutyStageId:integer = 0;
   Var DutyShortName:string = "";
   Var Sum:money = $0;   

   RS = CRsdCommand ("SELECT * FROM dpercpay_tmp " +
                     " WHERE T_OBJECTTYPEID = ? AND T_OBJECTNUMBER = ? " + 
                     " ORDER BY T_DUTYSTAGE ASC, T_BEGINDATE ASC ", "objid", objid, "objN", objN, V_GENOBJ);

   WHILE (RS.MoveNext)      
     IF(DutyStageId != RS.value("T_DUTYSTAGE"))
       IF(DutyStageId != 0)
         Print_DailyPercFoot(Sum);
       END;     
       Sum = $0;
       DutyStageId = RS.value("T_DUTYSTAGE");
       DutyShortName = CRsdCommand ("SELECT T_SHORTNAME FROM ddutstage_dbt WHERE T_DUTYSTAGEID = ?", 
                                              "DutyStageId", DutyStageId, V_STRING);
  
       [บ              #################################################                    บ](DutyShortName:c);
       [ฬออออออออออออัอออออออออออออออัอออออออ=อัอออออออออออออออ=อัอออออออ=อออ=============ออน];
     END;       
     
       [บ ########## ณ  ##########   ณ ####### ณ ############### ณ   ####################   บ]
       (SQL_NVL(RS.value("t_begindate"),  V_DATE):c, 
        SQL_NVL(RS.value("t_rest"),       V_MONEY):c, 
        SQL_NVL(RS.value("t_percrate"),   V_DOUBLE):c, 
        SQL_NVL(RS.value("t_percsum"),    V_MONEY):c,       
        Double(SQL_NVL( RS.value("T_ROUNDOFFERROR"), V_DOUBLE)):3:12:c);
        
        Sum = Sum + RS.value("t_percsum");            
   END;  
  
   Print_DailyPercFoot(Sum);  
END;

// โ็ฅโ <ฆฅคญฅขญ๋ฉ เแ็ฅโ %%>
MACRO DailyPercReport()
   Var RSฏจแฎชก๊ฅชโฎข = NULL; 
   Var objid : integer = 0;
   Var objn : integer = 0;
   RSฏจแฎชก๊ฅชโฎข = CRsdCommand ("SELECT T_OBJECTTYPEID, T_OBJECTNUMBER FROM dpercpay_tmp GROUP BY T_OBJECTTYPEID, T_OBJECTNUMBER ", V_GENOBJ);   

   WHILE (RSฏจแฎชก๊ฅชโฎข.MoveNext)
     objid = int(SQL_NVL( RSฏจแฎชก๊ฅชโฎข.value("T_OBJECTTYPEID"), V_INTEGER));
     objn = int(SQL_NVL( RSฏจแฎชก๊ฅชโฎข.value("T_OBJECTNUMBER"), V_INTEGER));
     
     Print_DailyPercHead(objid,objn);
     Print_DailyPercBody(objid,objn);     
   END;
END;


MACRO FillPayment_Report(objid: integer, objN: integer, typeop: integer, mode: integer, dateop: date, crdopid :integer, storno:bool)            
   upp  = 0;
   rpp  = 0;
   ccp  = 0; 
   pay  = 0;
   rest = 0;
   Var Sum:money = $0;
    
   if((ValType(crdopid) != V_UNDEF) AND (crdopid>0))
     if(storno == TRUE)
       fillpayment_rlt(objid,objn,mode,crdopid);       
       fillperc_rlt(crdopid);       
     else
       fillpayment(objid,objn,mode,crdopid);
       fillperc(crdopid);                 
     end;        
   end;
   print_head(objid,objn,typeop,dateop);
   print_body(objid,objn,mode);
   print_foot();
   
   DailyPercReport();
END;
