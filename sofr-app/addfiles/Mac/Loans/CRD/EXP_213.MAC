/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : exp_213.mac
 Description : Создание документа по шагу операции (перенос предстоящих поступлений
               на счет учета предстоящих поступлений по просроченным %%)
                            для 1-й группы риска договора
 Programmer  : TT
 24.04.2003  : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, BankInter, macperc;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record lcusrate    ("lcusrate.dbt", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    var PercChargeType = "";
    var stat:integer = 0;
    var ErrCode;
    var DocID:integer = 0;

    if (((Договор.Crd_kind != LO_GUARANTEE) and (Договор.RiskGroup >= 2) and (Договор.FlagOB == FlagOB_SetValue)) OR
        ((Договор.Crd_kind == LO_GUARANTEE) and (Договор.RiskGroup >= 2))
       )
        return 0;
    end;

   IF (NOT GetPercChargeType(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, PercChargeType))
      MsgBox("Ошибка получения значения: НАЧИСЛ_ПРОЦ_ПЕРЕД_ОПЛАТОЙ");
   END;

    PercChargeType = trim(strUPR(PercChargeType));

    
    if (PercChargeType == "ON")
        /*Начисленные в текущем периоде (не отражены на счетах требований)*/
        Документ.CarrySum = GetPaySumGroup (LGD_PERC, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
    elif (PercChargeType == "OFF")
        if(Договор.Crd_kind != LO_GUARANTEE)
            Документ.CarrySum = GetPaySum(DS_PERC,  Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
        else
            Документ.CarrySum = GetPaySum(DS_PAYMGUARPERCENT,  Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);
        end;
    end;
    stat = СоздатьДокумент(Документ, DocID);
    
    return stat;
end;
