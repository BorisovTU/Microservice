/*---------------------------------------------------------------------------------
                     Å®°´®Æ‚•™† ®≠‚•‡Ø‡•‚®‡„•¨ÎÂ ¨Æ§„´•©

 Filename    : restdate.mac
 Description : Ç•§Æ¨Æ·‚Ï Æ·‚†‚™Æ¢ ØÆ §Æ£Æ¢Æ‡„ ≠† §†‚„

 Programmer  : ROV
 19.01.2000  : ëÆß§†≠
------------------------------------------------------------------------------------*/
import total, getrest, acc_reserv;

private file   taccred      ("taccred.dbt",  "loans.def") key 0;
private file   sbacc        ("sb_acc.dbt",   "loans.def") key 0;
private record é°Ôß†‚•´Ï·‚¢Æ("duty_crd.dbt", "loans.def");
private record é°•·Ø•Á•≠®•  ("enscontr.dbt", "loans.def");

private var    RDate = date(0,0,0);
private var    RepType = 0;
private var    RepMenu = Tarray;
private var    OurBank = TLoansClient;

private macro á†£Æ´Æ¢Æ™(ObjectID:integer)

   var BankCity = "";
   [ ];
   if (RepType == 0)
      if (ObjectID == LO_DUTY)
      [ Ç•§Æ¨Æ·‚Ï Æ·‚†‚™Æ¢ ØÆ Æ°Ôß†‚•´Ï·‚¢„ #####
                                   §Æ£Æ¢Æ‡† ######################## ≠† ########## ] ( é°Ôß†‚•´Ï·‚¢Æ.UserNumber, Credit.UsCreditNumber, RDate );
      [                       Ç†´Ó‚† §Æ£Æ¢Æ‡† # ] (FindShortName(Credit.CurCode));
      elif (ObjectID == LO_ENSCONTR)
      [ Ç•§Æ¨Æ·‚Ï Æ·‚†‚™Æ¢ ØÆ §Æ£Æ¢Æ‡„ Æ°•·Ø•Á•≠®Ô ################### ≠† ########## ] ( é°•·Ø•Á•≠®•.EnsContractNumber, RDate );
      [                       Ç†´Ó‚† §Æ£Æ¢Æ‡† # ] (FindShortName(é°•·Ø•Á•≠®•.EnsContractCur));
      else
      [ Ç•§Æ¨Æ·‚Ï Æ·‚†‚™Æ¢ ØÆ §Æ£Æ¢Æ‡„ ######################## ≠† ########## ] ( Credit.UsCreditNumber, RDate );
      [                       Ç†´Ó‚† §Æ£Æ¢Æ‡† # ] (FindShortName(Credit.CurCode));
      end;
      [ ];
      [                       ëÁ•‚† ¢ ¢†´Ó‚• §Æ£Æ¢Æ‡† ];
      [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
       ≥          çÆ¨•‡ ·Á•‚†         ≥           ä†‚•£Æ‡®Ô           ≥    é·‚†‚Æ™   ≥
       √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
   else
     if (OurBank.GetRecord({OurBank}))
        BankCity = OurBank.CodePlace + OurBank.Place;
     end;

     if (not Depclnt.GetRecord(Credit.ClientID_Ref))
        MsgBoxEx("á†•¨È®™ ≠• ≠†©§•≠ ¢ ·Ø‡†¢ÆÁ≠®™• ·„°Í•™‚Æ¢.");
        Exit(1);
     end;
     [  #                                                              #](BankCity, RDate);
     [ ];
     [ ];
     [ ];
     [                             à ç î é ê å Ä ñ à ü];
     [          Æ° Æ‚™‡Î‚®® ·Á•‚Æ¢ ØÆ Æ°·´„¶®¢†≠Ó ™‡•§®‚≠Æ£Æ §Æ£Æ¢Æ‡†];
     [ ];
     [      Ç ·ÆÆ‚¢•‚·‚¢®®   ·  ‡†·ØÆ‡Ô¶•≠®•¨  ØÆ  ™‡•§®‚≠Æ¨„  §Æ£Æ¢Æ‡„  ¸######################## Æ‚ ##########,
        ß†™´ÓÁ•≠≠Æ¨„ · #
        ##########, Æ‚™‡Î‚Î ·Á•‚†:](Credit.UsCreditNumber, Credit.RegDate, DepClnt.Name, RDate:l);
     [ ];
     [ ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒø
       ≥          çÆ¨•‡ ·Á•‚†         ≥           ç†ß¢†≠®•                     ≥É´†¢†≥
       √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥];

   end;
end;

private macro á†£Æ´Æ¢Æ™_1(ObjectID:integer)
   if (RepType == 0)
      [≥                                                                             ≥];
      if (ObjectID == LO_DUTY)
      [≥ ê„°´•¢Î• ·Á•‚† ØÆ Æ°Ôß†‚•´Ï·‚¢„ #####
                        §Æ£Æ¢Æ‡† ######################## ≠† ##########              ≥] ( é°Ôß†‚•´Ï·‚¢Æ.UserNumber, Credit.UsCreditNumber, RDate );
      elif (ObjectID == LO_ENSCONTR)
      [≥ ê„°´•¢Î• ·Á•‚† ØÆ §Æ£Æ¢Æ‡„ Æ°•·Ø•Á•≠®Ô #################### ≠† ##########   ≥] ( é°•·Ø•Á•≠®•.EnsContractNumber, RDate );
      else
      [≥ ê„°´•¢Î• ·Á•‚† ØÆ §Æ£Æ¢Æ‡„ ######################## ≠† ##########           ≥] ( Credit.UsCreditNumber, RDate );
      end;
      [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
       ≥          çÆ¨•‡ ·Á•‚†         ≥           ä†‚•£Æ‡®Ô           ≥    é·‚†‚Æ™   ≥
      ];
   else

      [ ≥ CÁ•‚† Æ‚™‡Î‚Î• ¢ ‡„°´ÔÂ                                                     ≥
        √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒ¥
        ≥          çÆ¨•‡ ·Á•‚†         ≥           ç†ß¢†≠®•                     ≥É´†¢†≥
      ];
   end;
end;

private macro CheckAcc ()

    ClearRecord(sbacc); 
    sbAcc.OperDprt      = Credit.TerritorialStruct;
    sbAcc.CurCode       = AcCrd.CurCode;
    sbAcc.AccountNumber = AcCrd.AccountNumber_Ref;
    if (GetEQ(sbAcc) and (sbAcc.OpenDate == RDate))
       return true;
    end;
    return false;
end;

private macro èÆ§¢•·‚®ó•‡‚„()
 if (RepType == 0)
   [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
 else
   [ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒ¥];
 end;
end;

private macro èÆ§¢•·‚®ó•‡‚„1()
 if (RepType == 0)
   [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
 else
   [ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒŸ];
 end;
end;

private macro èÆ§¢•·‚®ó•‡‚„2()
 if (RepType == 0)
    [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
 else
    [ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒ¥];
 end;
end;

/****************************************************************/
private macro è•Á†‚Ï(CurCode, ObjectNumber)
  var rest = $0;
  ClearRecord(Taccred);
  taccred.TypeAccCred = AcCrd.CreditAccountType;
  if (GetEQ(taccred))
    if (AcCrd.RegDate > RDate)
      if (GetHistAcc(ObjectNumber, AcCrd.CreditAccountType, CurCode, RDate))
        AcCrd.AccountNumber_Ref = HistAcc.OldAccountNumber_Ref;
      end;
    end;
    TurnAcc.CurCode = CurCode;
    TurnAcc.AccountNumber_Ref = AcCrd.AccountNumber_Ref;
    TurnAcc.TurnOverDate = RDate;
    if( GetLE( TurnAcc )
       and (TurnAcc.CurCode == CurCode)
       and (TurnAcc.AccountNumber_Ref == AcCrd.AccountNumber_Ref)
      )
      rest = TurnAcc.TurnOverRest;
    end;
    if (RepType == 0)
       [≥##############################≥ ##############################≥##############≥]
       (AcCrd.AccountNumber_Ref, Taccred.NameTypeAccount:w, rest);
    else
       if (CheckAcc())
          [ ≥##############################≥ #######################################≥  #  ≥]
          (AcCrd.AccountNumber_Ref, Taccred.NameTypeAccount:w,sbAcc.Chapter);
       end;
    end;
  end;
end;
/****************************************************************/
macro RestDateCrd(ObjectID:integer, ObjectNumber:integer)
  var First = True, CountCur, CountRUR, i, CurCode;

  if (ObjectID == LO_DUTY)
    Loans_FindDuty(ObjectNumber, é°Ôß†‚•´Ï·‚¢Æ);
    Loans_FindCrdContract(é°Ôß†‚•´Ï·‚¢Æ.CreditNumber_Ref, Credit);
    CurCode = Credit.CurCode;
  elif (ObjectID == LO_ENSCONTR)
    Loans_FindEnsContract(ObjectNumber, é°•·Ø•Á•≠®•);
    Loans_FindCrdContract(é°•·Ø•Á•≠®•.CreditNumber_Ref, Credit);
    CurCode = é°•·Ø•Á•≠®•.EnsContractCur;
  else
    Loans_FindCrdContract(ObjectNumber, Credit);
    CurCode = Credit.CurCode;
  end;

  macro NextAcc(CurCode)
    if ( First )
      First = False;
      AcCrd.ObjectID     = ObjectID;
      AcCrd.ObjectNumber = ObjectNumber;
      AcCrd.CurCode      = CurCode;
      AcCrd.CreditAccountType = 0;
      return (GetGE(AcCrd)
              and (AcCrd.ObjectID     == ObjectID)
              and (AcCrd.ObjectNumber == ObjectNumber)
              and (AcCrd.CurCode == CurCode)
              );
    else
      return (Next(AcCrd)
              and (AcCrd.ObjectID     == ObjectID)
              and (AcCrd.ObjectNumber == ObjectNumber)
              and (AcCrd.CurCode == CurCode)
              );
    end;
  end;

  RepMenu[0] = "  Ç•§Æ¨Æ·‚Ï ~Æ·‚†‚™Æ¢~ ØÆ ·Á•‚†¨  ";
  RepMenu[1] = "  à≠‰Æ‡¨†Ê®Ô Æ° ~Æ‚™‡Î‚®®~ ·Á•‚Æ¢  ";
  RepType    = Menu(RepMenu, "~ENTER~ ¢Î°Æ‡, ~ESC~ Æ‚¨•≠†", " ÇÎ°•‡®‚• ¢®§ Ø•Á†‚≠Æ© ‰Æ‡¨Î: ");

  if (RepType == -2)  Exit(1);  end;

  RDate = Ç¢•·‚®Ñ†‚„é‚Á•‚†({curdate});
  if (RDate == date(0,0,0))  exit(1);  end;

// èÆ§Á®‚†•¨ ™Æ´®Á•·‚¢Æ ·‚‡Æ™ ¢ Æ‚Á•‚•
  First = True;
  countCur = 0;
  while (NextAcc(CurCode))
    if ((RepType == 0) or CheckAcc())
       countCur = CountCur + 1;
    end;
  end;

  First = True;
  countRUR = 0;
  while (NextAcc(0))
    if ((RepType == 0) or CheckAcc())
       countRUR = CountRUR + 1;
    end;
  end;

  if ((countCur + CountRUR) <= 0)
     MsgBoxEx("ç•‚ ·Á•‚Æ¢, Æ‚™‡Î‚ÎÂ " + RDate);
     Exit(1);
  end;
  á†£Æ´Æ¢Æ™(ObjectID);
  First = True;
  i = 0;
  while (NextAcc(CurCode))
    i = i + 1;
    if ((RepType == 0) or CheckAcc())
       è•Á†‚Ï(CurCode);
       if (i != countCur)
          èÆ§¢•·‚®ó•‡‚„();
       else
          if ((CurCode > 0) and (CountRUR > 0))
             èÆ§¢•·‚®ó•‡‚„2(); // Å„§•‚ Ø‡Æ§Æ´¶•≠®• Æ‚Á•‚† ¢ ¢®§• ‡„°´•¢ÎÂ ·Á•‚Æ¢
          else
             èÆ§¢•·‚®ó•‡‚„1(); // è‡Æ§Æ´¶•≠®Ô ≠• °„§•‚. á†¢•‡Ë†ÓÈ†Ô ·‚‡Æ™†
          end;
       end;
    end;
  end;

  if ((CurCode > 0) and (CountRUR > 0))
    á†£Æ´Æ¢Æ™_1(ObjectID);
    First = True;
    i = 0;
    while (NextAcc(0))
      i = i + 1;
      if ((RepType == 0) or (CheckAcc()))
         è•Á†‚Ï(0);
         if (i != countRUR)
            èÆ§¢•·‚®ó•‡‚„();
         else
            èÆ§¢•·‚®ó•‡‚„1();
         end;
      end;
    end;
  end;

  if (RepType != 0)
[ ];
[ ];
[ ä‡•§®‚≠Î© °„Â£†´‚•‡ _______________ î.à.é. °„Â£†´‚•‡†];
  end;
end;
