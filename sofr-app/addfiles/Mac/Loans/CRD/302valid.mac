/*
 ษอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
 บ ชฅโญ๏ ฎฏฅเๆจ๏ "เจงญญจฅ คฎๅฎคฎข 302-"                                     บ
 บ                                                                                 บ
 วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
 บ เฎฃเฌฌจแโ: TFS                                                                บ
 บ โ       : 21.11.2007                                                         บ
 ศอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ */

import SbCrdInter, total;


PRIVATE MACRO ฏชเฎโฎชฎซ()
   [ึฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤท];
   [บ จค ฎก๊ฅชโ ณ ID ฎก๊ฅชโ ณ      งขญจฅ ฎก๊ฅชโ    ณ ๋ฏฎซฅญจฅ ฎฏฅเๆจจ                           บ];
   [บ             ณ            ณ                          ณ                                              บ];
   [วฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ];
END;

PRIVATE MACRO ฎฎก้ฅญจฅเฎโฎชฎซ(CredOperID: integer, ObjID: integer, ObjN: integer)
   VAR ฅงใซ์โโ: string = "";
   MACRO (ObjID: integer)
      RETURN CRsdCommand("SELECT T_SHORTNAME FROM DLOBJECT_DBT WHERE T_OBJECTID = ?", "SHORTNAME", ObjID, V_STRING);
   END;

   MACRO ฌ๏(ObjID: integer, ObjN: integer)
      IF (ObjID == LO_DUTY)
         RETURN CRsdCommand("SELECT T_USERNUMBER     FROM DDUTY_CRD_DBT WHERE T_DUTYID       = ?", "SHORTNAME", ObjN, V_STRING);
      ELSE
         RETURN CRsdCommand("SELECT T_USCREDITNUMBER FROM DCREDIT_C_DBT WHERE T_CREDITNUMBER = ?", "SHORTNAME", ObjN, V_STRING);
      END;
   END;

   IF (CredOperID <= 0)
      ฅงใซ์โโ = "่จกช " + GetMO_LoansError();
   ELSE
      ฅงใซ์โโ = "แฏฅ่ญฎ";

   END;

   [บ ############ณ ###########ณ #########################ณ #############################################บ]
      (
      (ObjID),
      ObjN,
      ฌ๏(ObjID, ObjN),
      ฅงใซ์โโ
      );

END;

PRIVATE MACRO โฎฃเฎโฎชฎซ()
   [ศอออออออออออออฯออออออออออออฯออออออออออออออออออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออผ];
END;

   // ๋ขฅแโจ ฏญฅซ์ ฏเฌฅโเฎข.
   เจงญญจฅฎๅฎคฎข();


VAR OpDate: date, CrdOperID: integer = 0, rs_d = NULL,
   // ญญ๋ฅ แฎๅเญ๏๎โแ๏ ข โกซจๆฅ DCREDIT_C_TMP
   rs = LnGetRecordSet("SELECT T_CREDITNUMBER, T_CRD_KIND, T_REPDATE FROM DCREDIT_C_TMP ORDER BY T_CREDITNUMBER");

   ฏชเฎโฎชฎซ();
   SetLoansGroupMode(TRUE);
   WHILE (rs.MoveNext())
      OpDate = RS.Value("T_REPDATE", V_DATE);
      CrdOperID = MakeOperation(RS.Value("T_CREDITNUMBER", V_INTEGER),
                                RS.Value("T_CRD_KIND",     V_INTEGER),
                                CF_RECOGNIZE,
                                0,
                                OpDate,
                                0,
                                "",
                                "",
                                0);
      ฎฎก้ฅญจฅเฎโฎชฎซ(CrdOperID, RS.Value("T_CRD_KIND", V_INTEGER), RS.Value("T_CREDITNUMBER", V_INTEGER));


      IF ((RS.Value("T_CRD_KIND", V_INTEGER) == LO_CREDIT) OR (RS.Value("T_CRD_KIND", V_INTEGER) == LO_KARTA))
         rs_d = CRSDCommand("SELECT T_DUTYID FROM DDUTY_CRD_DBT WHERE T_CREDITNUMBER_REF = ?",
                            "DUTYID", RS.Value("T_CREDITNUMBER", V_INTEGER),
                             V_GENOBJ);

         WHILE (rs_d.MoveNext())
            CrdOperID = MakeOperation(rs_d.Value("T_DUTYID", V_INTEGER),
                                      LO_DUTY,
                                      CF_RECOGNIZE,
                                      0,
                                      OpDate,
                                      0,
                                      "",
                                      "",
                                      0);
            ฎฎก้ฅญจฅเฎโฎชฎซ(CrdOperID, LO_DUTY, rs_d.Value("T_DUTYID", V_INTEGER));
         END;
      END;
   END;
   SetLoansGroupMode(FALSE);
   โฎฃเฎโฎชฎซ();