/*
$Name:             concls01.mac
$Module:           Кредитование
$Description:      Заключение на получение кредита
*/
IMPORT ActiveX, total, mrk, lclient, replib, dlwreps, replib;

private record claim ("claim.dbt", "loans.def");
private file  crtype ("type_crd.dbt", "loans.def");
private record cur_credit ("credit_c", "loans.def");

private CONST TemplateName = "Conclus.dot";

macro PrintLoansReport (ClaimBuf, FromWeb)

      if (FromWeb == true)
          return "";
      end;

  var  stat :integer = 0;

   var axerr:object = null, isLoaner = "", isGuarantee = "", PeriodType, k, SelectedCell,
       СрокДоговораЛет;

   SetBuff(claim, ClaimBuf);

   if (not depclnt.GetRecord(claim.LoanerID_Ref))
       MsgBoxEx("Не найден заемщик в справочнике клиентов");
       Exit(1);
   end;

   if (depclnt.LegalForm != 2)
       MsgBoxEx("Отчет выпускается только по физическим лицам.");
       Exit(1);
   end;

   ClearRecord(crtype);
   crtype.CreditTypeID = Claim.CreditTypeID_Ref;
   if (not GetEQ(crtype) )
       MsgBoxEx("Установленный вид кредита не найден в справочнике видов кредита.");
       Exit(1);
   end;

   stat = CalcMRK(claim.ClaimID);
   if((not stat) OR (stat == -1)) 
      return false; 
   end;

   println(TemplateName); //Имя файла-шаблона
   println(GetDocName(TemplateName)); // Генерируем имя результирующего файла документа

   [~CurrencyType];
   if (ВалютаКредита == 0) /* Рублевый кредит */
      println("рублевого кредита");
   else
      println ("кредита в валюте " + FindFullName (ВалютаКредита));
   end;

   /* Номер заявки */
   [~ClaimNumber];
   println (claim.ClaimNumber);
   /* Дата заявки */
   [~ClaimDate];
   println (claim.GivingDate);
   /* ФИО заёмщика */
   [~FIO];
   println (Контрагент[0][FULL_FIO]);
   /* Дата рождения */
   [~BirthDate];
   println (Контрагент[0][BORNDATE]);
   /* Возраст в настоящее время */
   [~Vozrast];
   println(Возраст(Контрагент[0][CLIENT_ID], claim.GivingDate));
   /* Возраст по окончании срока кредита */
   [~VozrastEnd];
   println(Возраст(Контрагент[0][CLIENT_ID], ДатаВозврата));
/*Адрес*/
   /* Тип и название населенного пункта */
   [~City];
   println(НазваниеНаселенногоПункта(depclnt));
   /* Тип улицы */
   [~TypeStreet];
   println(StrLwr(trim(depclnt.StreetType)));
   /* Название улицы */
   [~Street];
   println(depclnt.StreetName);
   /* Номер дома */
   [~Home];
   println(depclnt.House);
   /* Номер корпуса */
   [~Korp];
   println(depclnt.NumCorp);
   /* Номер квартиры */
   [~Flat];
   println(depclnt.Flat);
   /* Место работы и должность*/
   [~WorkName];
   println(LnSelectValue ("select t_placework from dpersn_dbt" +
      " where t_personid = " + Контрагент[0][CLIENT_ID], V_STRING));
   /* Стаж работы в данной организации */
   [~Stag];
   println(СтажРаботыВОрганизации(Контрагент[0][CLIENT_ID], claim.GivingDate, @PeriodType));
   /* Тип срока для стажа работы в данной организации */
   [~StagYear];
   println(PeriodType);
   /* Название вида кредита */
   [~Target];
   println(crtype.CreditTypeName);
   /* Сумма кредита */
   [~SumResult];
   println(СуммаКредита);
   /* Сумма кредита прописью */
   [~StrSumResult];
   println(CurToStrAlt(СуммаКредита, null, null, int(FindExtCode(ВалютаКредита)) ) );
   /* Срок кредита */
   [~Srok];
   println(СрокДоговораМес);
   /* Наличие кредитной истории */
   [~CrdHistory];
   println(КредитнаяИстория(Контрагент[0][CLIENT_ID], @isLoaner, @isGuarantee));
   /* Нерегулярность Выплаты Зарплаты*/
   [~notReg];
   println(GetClientUsFieldValue(Контрагент[0][CLIENT_ID], НерегулярностьВыплатыЗарплаты));
   /* Наличие в доходах разовых выплат */
   [~onePay];
   println(GetClientUsFieldValue(Контрагент[0][CLIENT_ID], РазовыеВыплаты));
   /* Заемщик является одновременно заемщиком */
   [~Zaem];
   println(isLoaner);
   /* Заемщик является одновременно поручителем */
   [~Poruch];
   println(isGuarantee);
   /* Количество поручителей */
   [~CountPoruch];
   println(GuaranteeCount);

   k = 1;
   if (k < Контрагент.size())
      [~MultipleRow];
      [2];
      println(Контрагент.size() - 2);
      while (k < Контрагент.size())
         /* ФИО поручителя */
         println("~PoruchFIO_"+k);
         println (Контрагент[k][FULL_FIO]);
         /* Дата рождения */
         println("~PoruchBirthDate_"+k);
         println(Контрагент[k][BORNDATE]);
         /* Возраст в настоящее время */
         println("~PoruchVozrast_"+k);
         println(Возраст(Контрагент[k][CLIENT_ID], claim.GivingDate));
      /*Адрес*/
         if (not depclnt.GetRecord(Контрагент[k][CLIENT_ID]))
            /* Тип и название населенного пункта */
            println("~PoruchCity_"+k);
            println(" ");
            /* Тип улицы */
            println("~PoruchTypeStreet_"+k);
            println(" ");
            /* Название улицы */
            println("~PoruchStreet_"+k);
            println(" ");
            /* Номер дома */
            println("~PoruchHome_"+k);
            println(" ");
            /* Номер корпуса */
            println("~PoruchKorp_"+k);
            println(" ");
            /* Номер квартиры */
            println("~PoruchFlat_"+k);
            println(" ");
         else
            /* Тип и название населенного пункта */
            println("~PoruchCity_"+k);
            println(НазваниеНаселенногоПункта(depclnt));
            /* Тип улицы */
            println("~PoruchTypeStreet_"+k);
            println(StrLwr(trim(depclnt.StreetType)));
            /* Название улицы */
            println("~PoruchStreet_"+k);
            println(depclnt.StreetName);
            /* Номер дома */
            println("~PoruchHome_"+k);
            println(depclnt.House);
            /* Номер корпуса */
            println("~PoruchKorp_"+k);
            println(depclnt.NumCorp);
            /* Номер квартиры */
            println("~PoruchFlat_"+k);
            println(depclnt.Flat);
         end;

         /* Место работы и должность*/
         println("~PoruchWorkName_"+k);
         println((LnSelectValue ("select t_placework from dpersn_dbt" +
         " where t_personid = " + Контрагент[k][CLIENT_ID], V_STRING)));
         /* Стаж работы в данной организации */
         println("~PoruchStag_"+k);
         println(СтажРаботыВОрганизации(Контрагент[k][CLIENT_ID], claim.GivingDate, @PeriodType));
         /* Тип срока для стажа работы в данной организации */
         println("~PoruchStagYear_"+k);
         println(PeriodType);

         КредитнаяИстория(Контрагент[k][CLIENT_ID], @isLoaner, @isGuarantee);
         /* Поручитель является одновременно заемщиком */
         println("~PoruchZaem_"+k);
         println(isLoaner);
         /* Поручитель является одновременно поручителем */
         println("~PoruchPoruch_"+k);
         println(isGuarantee);
         /* Сумма поручительства */
         println("~PoruchSumResult_"+k);
         println(CurStr(Контрагент[k][ENS_SUM], Контрагент[k][ENS_SUM_CUR]));
         /* Доля поручительства в сумме кредита */
         println("~PoruchProcresult_"+k);
         println(doubleL(Контрагент[k][ENS_SUM])*GetRate(claim.GivingDate, Контрагент[k][ENS_SUM_CUR]) / doubleL(СуммаКредитаРубли));
         k = k + 1;
      end;
   else
      [~DeleteRows];
      [2];
      [%];
      [1];
      [1];
   end;

   /* %% ставка */
   [~Percent];
   println(string(Ставка:4:1));
   /* Срок кредита */
   [~SrokYear];
   СрокДоговораЛет = int(СрокДоговораМес) / 12;
   if ((СрокДоговораМес - СрокДоговораЛет*12) == 0)
      if (СрокДоговораЛет == 1)
         println(СрокДоговораЛет + " год");
      elif (СрокДоговораЛет > 4)
         println(СрокДоговораЛет + " лет");
      else
         println(СрокДоговораЛет + " года");
      end;
   else
      println(СрокДоговораМес + " мес.");
   end;

   /* ФИО кредитного инспектора */
   [~FIOInspector];
   println(GetFIOEmployee({oper}));

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);

   return 0;
   onError (axerr)
      WordError(axerr);
      return 1;

END;
