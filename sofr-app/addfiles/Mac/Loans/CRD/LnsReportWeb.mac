/*
$Name: lnsreportweb.mac
$Module: WebLoans
$Description: ядро механизма печатных форм
*/
IMPORT RsbDataSet, globals;
IMPORT "LnsReportCore.mac";

PRIVATE MACRO GetValueClassificatorID(ClassificatorID)
  var
      qStr = "", rs = NULL, retVal = 0;

    qStr = "select * from dllclsval_dbt where t_Classificator = " + String(ClassificatorID);
    rs = TRsbDataSet(qStr);
    if (rs.MoveNext)
        retVal = rs.t_List;
    end;
    return retVal;
END;

PRIVATE MACRO ConvertParmWeb_sys(Parm)
  var
    retVal = NULL, idx = 0, 
    types = NULL, d,m,y;

    if (ValType(Parm) != V_UNDEF)
        types = Parm[0];

        retVal = 
        "<?xml version='1.0' encoding='UTF-8'?>" +
        "<methodResponse xmlns='http://www.softlab.ru/xml-rpc/schema' " +
        "                xmlns:n0='http://www.softlab.ru/xml-rpc/schema' " +
        "                n0:reqId='" + CreateGUID() + "' " + 
        "                n0:logicalId=''>"+
        "    <params><param><value><struct>";

        while (idx < types.Value.size)
            if (types.Value[idx] == repParmType_Date)
                DateSplit (Parm[idx + 1].Value, d, m, y);
                retVal = retVal +
                "<member><name>" + Parm[idx + 1].ValueName + "</name><value><date>" + String(y) + "-" + String(m:2:o) + "-" + String(d:2:o) + "Z</date></value></member>";
            elif (types.Value[idx] == repParmType_Sum)
                retVal = retVal +
                "<member><name>" + Parm[idx + 1].ValueName + "_" + Parm[idx + 1].Value[0].ValueName + "</name><value><money>" + String(Parm[idx + 1].Value[0].Value) + "</money></value></member>"+
                "<member><name>" + Parm[idx + 1].ValueName + "_" + Parm[idx + 1].Value[1].ValueName + "</name><value><integer>" + String(Parm[idx + 1].Value[1].Value) + "</integer></value></member>";
            elif (types.Value[idx] == repParmType_Num)
                retVal = retVal +
                "<member><name>" + Parm[idx + 1].ValueName + "</name><value><integer>" + String(Parm[idx + 1].Value) + "</integer></value></member>";
            elif (types.Value[idx] == repParmType_Str)
                retVal = retVal +
                "<member><name>" + Parm[idx + 1].ValueName + "</name><value><string>" + String(Parm[idx + 1].Value) + "</string></value></member>";
            elif (types.Value[idx] == repParmType_CheckBox)
                retVal = retVal +
                "<member><name>" + Parm[idx + 1].ValueName + "</name><value><boolean>" + String(Parm[idx + 1].Value) + "</boolean></value></member>";
            elif (types.Value[idx] == repParmType_Classificator)
                if (ValType(Parm[idx + 1].Value) == V_UNDEF)
                    retVal = retVal +
                    "<member><name>" + Parm[idx + 1].ValueName + "</name><value><NULL/></value></member>";
                else
                    retVal = retVal +
                    "<member><name>" + Parm[idx + 1].ValueName + "</name><value><integer>" + String(Parm[idx + 1].Value) + "</integer></value></member>";
                end;
            end;

            idx = idx + 1;
        end;

        retVal = retVal + 
        "</struct></value></param></params></methodResponse>";

        if (ConvertToRSL(retVal, retVal) != 0)
            retVal = NULL;
        end;
    end;

    return retVal;
END;

MACRO LnsGenRepParmPanel_sys(TemplateID)
  var
      retVal = CLnsReportUISession(),
      idx = 0,
      qStr = "", rs = NULL;

  var
      panel = "", resource = "", globalresource = "", typeelem = "";

    qStr = "select * from DLRTMLPARM_DBT where t_TemplateID = " + String(TemplateID) + " order by t_NUM";
    rs = TRsbDataSet(qStr);

    panel = "";
    resource = "";

    while (rs.MoveNext())
        typeelem = typeelem +
        "<System:Int32>" + rs.t_TypeElem + "</System:Int32>";

        if (rs.t_TypeElem == repParmType_Date)
            panel = panel +
            "<TextBlock Grid.Row='" + String(idx) + "' Grid.Column='0' Text='" + String(rs.t_Name) + ":' VerticalAlignment='Center'  Margin='0,0,0,5'/>" +
            "<RsControls:RsDatePicker Grid.Row='" + String(idx) + "' Grid.Column='2' SelectedDate='{Binding Value[" + String(idx+1) + "].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' HorizontalAlignment='Left' Margin='0,0,0,5'/>";

            resource = resource +
            "<LnsCommonType:LnsValueDependencyObject ValueName='" + String(rs.t_ShortName) + "' Value='{Binding Curdate, Source={StaticResource LnsDateTimeHelper}}' />";
        elif (rs.t_TypeElem == repParmType_Sum)
            panel = panel +
            "<TextBlock Grid.Row='" + String(idx) + "' Grid.Column='0' Text='" + String(rs.t_Name) + ":' VerticalAlignment='Center'  Margin='0,0,0,5'/>" +
            "<StackPanel Orientation='Horizontal' Grid.Row='" + String(idx) + "' Grid.Column='2' Margin='0,0,0,5'> " +
                "<RsControls:RsMoneyBox Value='{Binding Value[" + String(idx+1) + "].Value[0].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' Margin='0,0,6,0' MinWidth='200' RenderTransformOrigin='0,0' DecimalPlaces='2' /> " +
                "<FIUniList:FIUniListWidget FIid='{Binding Value[" + String(idx+1) + "].Value[1].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' CodeKindWidget='3' CodeKindList='3' Width='394'> " +
                    "<FIUniList:FIUniListWidget.FIKinds>" +
                        "<CustomTypes:IntList>" +
                            "<System:Int32>1</System:Int32>" +
                        "</CustomTypes:IntList>" +
                    "</FIUniList:FIUniListWidget.FIKinds>" +
                "</FIUniList:FIUniListWidget>" +
            "</StackPanel>";

            resource = resource +
            "<LnsCommonType:LnsValueObject ValueName='" + String(rs.t_ShortName) + "'>" +
            "    <LnsCommonType:LnsValueObject.Value>" +
            "        <CustomTypes:LnsValueList>" + 
            "            <LnsCommonType:LnsValueObject ValueName='Sum'>" +
            "                <LnsCommonType:LnsValueObject.Value>" +
            "                    <RsTools:Money>0</RsTools:Money>" +
            "                </LnsCommonType:LnsValueObject.Value>" +
            "            </LnsCommonType:LnsValueObject>" +
            "            <LnsCommonType:LnsValueObject ValueName='CurCode'>" +
            "                <LnsCommonType:LnsValueObject.Value>" +
            "                    <System:Int32>" + String(rs.t_KindElem) + "</System:Int32>" +
            "                </LnsCommonType:LnsValueObject.Value>" +
            "            </LnsCommonType:LnsValueObject>" +
            "        </CustomTypes:LnsValueList>" +
            "    </LnsCommonType:LnsValueObject.Value>" +
            "</LnsCommonType:LnsValueObject>";
        elif (rs.t_TypeElem == repParmType_Num)
            panel = panel +
            "<TextBlock Grid.Row='" + String(idx) + "' Grid.Column='0' Text='" + String(rs.t_Name) + ":' VerticalAlignment='Center'  Margin='0,0,0,5'/>" +
            "<RsControls:RsNumericBox Grid.Row='" + String(idx) + "' Grid.Column='2' Value='{Binding Value[" + String(idx+1) + "].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' DecimalPlaces='0' HorizontalAlignment='Left' Margin='0,0,0,5' MinWidth='600'/>";

            resource = resource +
            "<LnsCommonType:LnsValueObject ValueName='" + String(rs.t_ShortName) + "'>" +
            "    <LnsCommonType:LnsValueObject.Value>" +
            "        <System:Int32>0</System:Int32>" +
            "    </LnsCommonType:LnsValueObject.Value>" +
            "</LnsCommonType:LnsValueObject>";
        elif (rs.t_TypeElem == repParmType_Str)
            panel = panel +
            "<TextBlock Grid.Row='" + String(idx) + "' Grid.Column='0' Text='" + String(rs.t_Name) + ":' VerticalAlignment='Center'  Margin='0,0,0,5'/>" +
            "<RsControls:RsTextBox Grid.Row='" + String(idx) + "' Grid.Column='2' Text='{Binding Value[" + String(idx+1) + "].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' VerticalAlignment='Center' TextWrapping='Wrap' HorizontalAlignment='Left' Margin='0,0,0,5' MinWidth='600'/>";

            resource = resource +
            "<LnsCommonType:LnsValueObject ValueName='" + String(rs.t_ShortName) + "'>" +
            "    <LnsCommonType:LnsValueObject.Value>" +
            "        <System:String></System:String>" +
            "    </LnsCommonType:LnsValueObject.Value>" +
            "</LnsCommonType:LnsValueObject>";
        elif (rs.t_TypeElem == repParmType_CheckBox)
            panel = panel +
            "<CheckBox Grid.Row='" + String(idx) + "' Grid.ColumnSpan='2' Content='" + String(rs.t_Name) + "' IsChecked='{Binding Value[" + String(idx+1) + "].Value, Source={StaticResource PanelParmData}, Mode=TwoWay}' VerticalAlignment='Center' Margin='0,0,0,5'/>";

            resource = resource +
            "<LnsCommonType:LnsValueObject ValueName='" + String(rs.t_ShortName) + "'>" +
            "    <LnsCommonType:LnsValueObject.Value>" +
            "        <System:Boolean>False</System:Boolean>" +
            "    </LnsCommonType:LnsValueObject.Value>" +
            "</LnsCommonType:LnsValueObject>";
        elif (rs.t_TypeElem == repParmType_Classificator)
            var 
                val = GetValueClassificatorID(rs.t_KindElem);

            if (val > 0)
                panel = panel +
                "<TextBlock Grid.Row='" + String(idx) + "' Grid.Column='0' Text='" + String(rs.t_Name) + ":' VerticalAlignment='Center'  Margin='0,0,0,5'/>" +
                "<WCSystemDictionary:ClassifValuesWidget Name='Classif" + String(idx) + "' Grid.Row='" + String(idx) + "' Grid.Column='2' Classificator='" + String(rs.t_KindElem) + "' VerticalAlignment='Center' HorizontalAlignment='Left' Margin='0,0,0,5' IsClearButtonVisible='False' MinWidth='600'/>";
            end;

            globalresource = globalresource +
            "<UIBasic:ReferenceToElement x:Key='Classif" + String(idx) + "_ref' ElementName='Classif" + String(idx) + "' />";

            resource = resource +
            "<LnsCommonType:LnsValueDependencyObject ValueName='" + String(rs.t_ShortName) + "' Value='{Binding Reference.Entity.Element, Source={StaticResource Classif" + String(idx) + "_ref}}' />";
        end;

        idx = idx + 1;
    end;

    if (resource == "")
        retVal = NULL;
    else
        retVal.UISessionForm = 
"<Grid" +
"    xmlns='http://schemas.microsoft.com/winfx/2006/xaml/presentation' " +
"    xmlns:x='http://schemas.microsoft.com/winfx/2006/xaml' " +
"    xmlns:d='http://schemas.microsoft.com/expression/blend/2008' " +
"    xmlns:mc='http://schemas.openxmlformats.org/markup-compatibility/2006' " +
"    xmlns:sdk='http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk' " +
"    xmlns:toolkit='http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit' " +
"    xmlns:System='clr-namespace:System;assembly=mscorlib' " +
"    xmlns:RsControls='clr-namespace:RsControls;assembly=RsControls' " +
"    xmlns:RsTools='clr-namespace:RsTools;assembly=RsTools' " +
"    xmlns:WCSystemDictionary='clr-namespace:WCSystemDictionary.View.Widgets;assembly=WCSystemDictionary' " +
"    xmlns:FIUniList='clr-namespace:FIUniList.View.Widgets;assembly=FIUniList' " +
"    xmlns:CustomTypes='clr-namespace:Loans.LoansCommon.CustomTypes;assembly=LoansCommon' " +
"    xmlns:LnsCommonType='clr-namespace:Loans.LoansCommon.DataModel;assembly=LoansCommon' " +
"    xmlns:LnsConverter='clr-namespace:Loans.LoansCommon.Helpers;assembly=LoansCommon' " +
"    xmlns:UIBasic='clr-namespace:UIBasic;assembly=UIBasic' " +
">" +
"    <Grid.Resources>" +
"        <LnsConverter:LnsDateTimeHelper x:Key='LnsDateTimeHelper' /> " +
globalresource +
"        <LnsCommonType:LnsValueObject x:Key='PanelParmData'>" +
"            <LnsCommonType:LnsValueObject.Value>" +
"                <CustomTypes:LnsValueList>" + 
"                    <LnsCommonType:LnsValueObject ValueName='TypeElements'>" +
"                        <LnsCommonType:LnsValueObject.Value>" +
"                            <CustomTypes:IntList>" + 
typeelem +
"                            </CustomTypes:IntList>" +
"                        </LnsCommonType:LnsValueObject.Value>" +
"                    </LnsCommonType:LnsValueObject>" +
resource +
"                </CustomTypes:LnsValueList>" +
"            </LnsCommonType:LnsValueObject.Value>" +
"        </LnsCommonType:LnsValueObject>" +
"    </Grid.Resources>" +
"    <Grid.ColumnDefinitions>" +
"        <ColumnDefinition Width='Auto'/>" +
"        <ColumnDefinition Width='6'/>" +
"        <ColumnDefinition Width='*'/>" +
"    </Grid.ColumnDefinitions>" +
"    <Grid.RowDefinitions>";
        while (idx > 0)
            retVal.UISessionForm = retVal.UISessionForm +
"        <RowDefinition Height='Auto'/>";
            idx = idx - 1;
        end;
        retVal.UISessionForm = retVal.UISessionForm +
"    </Grid.RowDefinitions>" +
panel +
"</Grid>";
    end;

    return retVal;
END;

MACRO LnsTemplateParmSerialize_sys(TemplateParm)
  var 
      retVal = TemplateParm;

    if (
        (retVal != NULL) and
        (retVal.UiSession != NULL) and
        (retVal.UiSession.UISessionParm != NULL)
       )
        retVal.UiSession.UISessionParm = ConvertParmWeb_sys(retVal.UiSession.UISessionParm)
    end; 

    return retVal;
END;

