/*
$Name:        asdd.mac
$Module:      Кредитование
$Description: Передача данных в АС СД
*/
/*
    RS-Loans

    1) ФОРМИРОВАНИЕ ТРАНСПОРТНОГО ФАЙЛА.
       Функции: СформироватьТранспортныйФайл()
                СформироватьТранспортныйФайл_ГрупповойРежим()

    2) ПРИЕМ КВИТАНЦИЙ БКИ
       Функция: ПринятьКвитанцию()

   Programmer: SAI
   Date      : 09.06.09
*/

IMPORT GLOBALS, TOTAL,rsexts,RsbDataSet,ActiveX, VBAConst,"dutysum.mac";/*, cryptdlm*/;

   VAR credit_c = TBFile ("credit_c.dbt", "r", 0),
       lbki     = TBFile ("lbki.dbt",     "r", 0),
       ltr_file = TBFile ("ltr_file.dbt", "w", 0),
       nbki     = TBFile ("nbki.tmp",     "r", 0);

   //////////////////////////// ASSD Add /////////////////////////////////
   VAR receipt =  TBFile ("receipt.dbt",  "w", 0),
       ensBki   = TBFile ("lensbki.tmp",  "r", 0),
       enscontr = TBFile ("enscontr.dbt", "r", 0);


 private VAR ReportDate;
 private VAR opoper;
 private var _legalform;
 private var НачПерФормКи; // Чтобы не ругалось ошибками при выходе из модуля

 /////////////////////////////// ВЫГРУЗКА УДЕЛЯНИЕ ДО КЛИЕНТА ИТП ////////////////////////////
 RECORD safe_crd ("credit_c.dbt");
 
 VAR CreditNumber  : integer = 0,
     ObjectTypeID  : integer = 0,
     ClientID      : integer = 0,
     TypeClient    : integer = 0, // Тип клиента(1 - Юрик, 2 - Физик,5 - ПБЮЛ)
     Count         : integer = 1,
     НОМЗАПР       : integer = 1, // Порядковый номер сообщения в файле
     OTHERDEBTORNUM: integer = 0;
     
  // Данные о клиенте
  VAR CodClient  : integer= 0,
      LegalForm  : integer= 0,
      IsEmployer : string = "",          //
      Name       : string = "",
      Name1      : string = "",          // Фамилия
      Name2      : string = "",          // Имя
      Name3      : string = "",          // Отчество
      Born       : date   = date(0,0,0); // Дата рождения

  PRIVATE VAR RSD_partcode = NULL;
      
  ////////////////////////// END OF : ВЫГРУЗКА УДЕЛЯНИЕ ДО КЛИЕНТА ИТП ///////////////////////      
     

 CONST PTLEGF_PBUL  = 5;
 CONST REQUEST_CHNG = 1; // Передача изменений
 CONST REQUEST_FULL = 2; // Передача полной истории
 CONST REQUEST_DEL  = 3; // Запрос на удаление

   // Путь к папке временых файлов
   VAR TxtFileDir : string = "";
   VAR ErrCode    : integer = 0;
   IF (GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, TXTFILEDIR, ErrCode) != V_STRING)
      LoansError("Ошибка чтения параметра: | BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR");
      RETURN FALSE;
   END;
   TXTFILEDIR = TXTFILEDIR + "\\bki_tmp."+UserNumber;

   // Файлы
   FILE fMainTXT () WRITE TXT; // КИ
   FILE fTempTXT () WRITE TXT; // Временая КИ
   FILE fTempTXT_() TXT;       // Временая КИ


   // Секция Chek BKI DATA 135900,135178
   PRIVATE VAR NotUsefillcreditlist:BOOL = FALSE;
   PRIVATE VAR NotUseUpdateTFID:BOOL = FALSE;
   PRIVATE VAR Report_Ptr,CurIDBlock:String,Undef;
   PRIVATE VAR ErrMes: STRING = "";
   PRIVATE VAR GENERAL_FAILURE: BOOL = FALSE; // Наличие ошибки при формировании ТФ АССД3: А теперь и в проверке квитанции!

   // ASSD2
   PRIVATE VAR ActSheet : Object;
   PRIVATE VAR Row : INTEGER;

   // ASSD3
   PRIVATE VAR  IsDONow: BOOL = FALSE;
   PRIVATE VAR  MAX_DATE: DATE = Date(1,1,9999);
   PRIVATE VAR  NULL_DATE: DATE = Date(0,0,0);
   private record lcalghis ("lcalghis.dbt", "loans.def");
   //PRIVATE VAR  ReportDate: Date; // ONLE FOR DEBUG
   PRIVATE VAR  LastSendDate: Date = Date(0,0,0);  // Дата последней успешной выгрузки

   PRIVATE VAR GRP_BKI_MODE = FALSE; // Вынесено из Группового режима для корректного подсчета КД в Групповом режиме!
   PRIVATE VAR GRP_BKI_ID = 0;

   PRIVATE VAR OnlyInTF:BOOL = FALSE;
   // ASSD3/3
   PRIVATE VAR ManyExpOps:BOOL = FALSE;
   PRIVATE VAR GlobalTFID:INTEGER = 0;
   // PRE PSI
   PRIVATE VAR HeaderFunck;
   PRIVATE VAR GlobalSendKind:INTEGER = 0;
   PRIVATE VAR GlobalBKIID:INTEGER = 0;
   PRIVATE VAR HeaderAlreadyWritten:BOOL = TRUE;
   

MACRO InitRSCCommand()
   RSD_partcode = RSDCommand(RslDefCon, "SELECT pc.T_CODE FROM DPARTCODE_DBT pc WHERE " +
                                              " pc.T_PARTYID  = ? " +
                                          " AND pc.T_CODEKIND = ? ");
   RSD_partcode.AddParam("PARTYID",  RSDBP_IN);
   RSD_partcode.AddParam("CODEKIND", RSDBP_IN);
END;

   //////////////////////////// DBUG ONLY /////////////////////////////////
   //////////////////////////// DBUG ONLY /////////////////////////////////
   //////////////////////////// DBUG ONLY /////////////////////////////////
    macro TableView(Table: string)
    var
        rs    = null, cmd;
        cmd    = RsdCommand(RslDefCon, "select * from " + Table);
        rs    = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
        RunScroll (rs, null, null, null, null, "Таблица: " + Table, null, true);
    end;
   //////////////////////////// DBUG ONLY /////////////////////////////////
   //////////////////////////// DBUG ONLY /////////////////////////////////
   //////////////////////////// DBUG ONLY /////////////////////////////////


////////////////////////////////////////////////////////////////////////////////
// Код клиента

MACRO GetPartCode(ClientID: integer, CodeKind: integer)
   // Ошибка
   IF (RSD_partcode == NULL)
      InitRSCCommand();
   END;

   RSD_partcode.Value("PARTYID")  = ClientID;
   RSD_partcode.Value("CODEKIND") = CodeKind;
   RSD_partcode.Execute();

   VAR RS = RsdRecordset(RSD_partcode);
   IF ((RS != NULL) AND (RS.moveNext() == TRUE) AND (ValType(RS.Value(0)) == V_STRING))
      RETURN RS.Value(0);
   END;

   RETURN "";
END;


// Записать строку в ТФ
MACRO InsertString(ID, ABBR: String, Type: String, Size: Integer, Flag: String, Value, Parm, BindingFlag)
   VAR I         = 0,
       tmpString = "",
       fMODE    : BOOL   = FALSE,
       Nesessary: STRING = "",
       ZeroCanBe      : BOOL = FALSE,
       НеОбязательный : BOOL = TRUE;
       

   // Запись в главный файл
   IF (ValType(Parm) == V_BOOL)
      fMODE = Parm;
   END;

   IF (ValType(Parm) == V_STRING)
      Nesessary = Parm;
   END;

   IF (ValType(BindingFlag) == V_UNDEF)
      НеОбязательный = TRUE;
   ELIF((ValType(BindingFlag) == V_STRING) AND ((BindingFlag == "O") OR (BindingFlag == "Oz"))) // Oz - значит обязательный но может быть равным нулю
      IF (BindingFlag == "Oz") ZeroCanBe = TRUE; END;
      НеОбязательный = FALSE;
   ELIF((ValType(BindingFlag) == V_STRING) AND (BindingFlag == "Н"))
      НеОбязательный = TRUE;
   ELIF((ValType(BindingFlag) == V_STRING) AND (BindingFlag == "Нz"))
      НеОбязательный = TRUE;
      ZeroCanBe = TRUE;
   END;
   

   IF   (Type == "N") // Число
      // Тип INTEGER или MONEY или DOUBLE (СТАВКА)
      IF((
          (((Value == 0) AND not ZeroCanBe) AND
          (ABBR != "ЧИСЛОПР") AND
          (ABBR != "СУМНОД")  AND
          (ABBR != "СУМНПР"))
         OR
          (Trim(string(Value)) == "")
          ) AND (НеОбязательный)
          )
         RETURN FALSE;
      END;
      IF ((not НеОбязательный) AND (not ZeroCanBe))
          IF ((ValType(Value) == V_INTEGER) AND (Value == 0))
              Value = ""; // Создаем ошибку незаполнненности обязательного параметра
          END;
      END;
   ELIF (Type == "A") // Строка
      Value = string(Value);
      // Длина строки и обязательность заполнения лидирующими нулями
      IF (Flag == "S")
         IF (Size < StrLen(Value))
            Value = Substr(Value, 1, Size); // TT. Урезаем слишком длинную строку - оставляем первые Size символов
         END;
         tmpString = MkStr("0", Size);
         StrSet(tmpString, Size - StrLen(Value) + 1, Value);
         Value = tmpString;
      END;

      // Убираем пустые строки из транспортного файла
      IF (Trim(Value) == "")
         RETURN FALSE;
      END;

      Value = StrUpr(Value);
   ELIF (Type == "D") // Дата
      // Избавление от разделительных точек и добавление нулей
      Value = StrSubst(String(Value), " ", "0");
      Value = StrSubst(String(Value), ".", "");

      IF (Trim(string(Value)) == "")
         RETURN FALSE;
      END;
   END;

   IF ((ABBR == "@@@") OR (ABBR == "==="))
      IF ((ValType(fMODE) == V_BOOL) AND (fMODE == TRUE))
         fMainTXT[0] = string(ABBR);
      ELSE
         fTempTXT[0] = string(ABBR);
      END;
   ELSE
      if(ABBR != "")
         IF ((ValType(fMODE) == V_BOOL) AND (fMODE == TRUE))
            fMainTXT[0] = string(ABBR, ":", Value);
         ELSE
            fTempTXT[0] = string(ABBR, ":", Value);
         END;
      else
         IF ((ValType(fMODE) == V_BOOL) AND (fMODE == TRUE))
            fMainTXT[0] = string(Value);
         ELSE
            fTempTXT[0] = string(Value);
         END;
      end;
   END;

   IF ((ValType(fMODE) == V_BOOL) AND (fMODE == TRUE))
      Insert(fMainTXT);
   ELSE
      Insert(fTempTXT);
   END;

   RETURN TRUE;
END;

MACRO IsFirstASSD_Send(Bki_ID,CrdNumber,TrFileID, SuccessSendCount:@Integer)
   VAR SuccessSendID;
   SuccessSendID = 0;
   //SuccessSendID = CRSDCommand("SELECT ld.T_SENDKIND, MAX(ld.T_ID) FROM DLDEVBKI_DBT ld WHERE " +
   SuccessSendID = CRSDCommand("SELECT COUNT(ld.T_ID) TOTAL FROM DLDEVBKI_DBT ld WHERE " +
                    " ld.T_BKIID_REF        =  ? " +
                    " AND ld.T_CREDITNUMBER_REF =  ? " +
                    " AND ld.T_SENDDATE        <=  ? " +
                    " AND ld.T_RESULT        = CHR(?)" +
                    " AND ld.T_TFID_REF      != ?" +
                    " AND t_sendkind IN (1,2) ",
                    //" GROUP BY ld.T_SENDKIND ORDER BY MAX(ld.T_ID) DESC",
                    "BKIID",        Bki_ID,
                    "CREDITNUMBER", CrdNumber,
                    "SENDDATE",     {CurDate},
                    "RESULT",       43,
                    "CutTFID",      TrFileID,
                    V_INTEGER);
    IF (SuccessSendID > 0)
        IF (VALTYPE(SuccessSendCount) != V_UNDEF)
            SuccessSendCount = SuccessSendID;
        END;
        RETURN FALSE;
    ELSE
        IF (VALTYPE(SuccessSendCount) != V_UNDEF)
            SuccessSendCount = 0;
        END;
        RETURN TRUE;
    END;
    RETURN TRUE;
END;

MACRO IsFindDelKI(Bki_ID,CrdNumber,TrFileID);
   VAR SuccessDelKISends:INTEGER = 0;
   
   SuccessDelKISends =CRSDCommand(" SELECT COUNT(T_ID) FROM DLDEVBKI_DBT , ( "+
                                  " SELECT MAX(ld.T_ID) MAX_ID FROM DLDEVBKI_DBT ld WHERE " +
                                  " ld.T_BKIID_REF        =  ? " +
                                  " AND ld.T_CREDITNUMBER_REF =  ? " +
                                  " AND ld.T_SENDDATE        <=  ? " +
                                  " AND ld.T_RESULT        = CHR(?)" +
                                  " AND ld.T_TFID_REF      != ?" +
                                  " AND ld.t_sendkind IN (1,2) ) LST_FT " +
                                  " WHERE T_ID > LST_FT.MAX_ID AND " +
                                  " T_BKIID_REF        =  ? " +
                                  " AND T_CREDITNUMBER_REF =  ? " +
                                  " AND T_SENDDATE        <=  ? " +
                                  " AND T_RESULT        = CHR(?)" +
                                  " AND T_TFID_REF      != ?" +
                                  " AND t_sendkind NOT IN (1,2) ",
                                  "BKIID1",        Bki_ID,
                                  "CREDITNUMBER1", CrdNumber,
                                  "SENDDATE1",     {CurDate},
                                  "RESULT1",       43,
                                  "CutTFID1",      TrFileID,
                                  "BKIID2",        Bki_ID,
                                  "CREDITNUMBER2", CrdNumber,
                                  "SENDDATE2",     {CurDate},
                                  "RESULT2",       43,
                                  "CutTFID2",      TrFileID,
                                  V_INTEGER);


    IF (SuccessDelKISends > 0)
        RETURN TRUE;
    END;
    RETURN FALSE;    
END;

MACRO MarkCreditFirstTimeSended(CrdNumber)
    CRSDCommand("UPDATE DOBJECT_BKI_TMP SET T_SUM = 1 "
                " WHERE T_GROUPBKI = ? "
                " AND  T_CREDITNUMBER = ? ",
                "PAYOFFDOCID_REF", GRP_BKI_ID,
                "CREDITNUMBER_REF",CrdNumber,
                V_GENOBJ);
END;



MACRO ПолучитьЧислоСообщений(IsGroupMode : BOOL, BkiID: Integer, TF_ID_REF: INTEGER)
  var КоличествоСообщений : Integer = 0;
  var КолвоСообщенийДО : Integer = 0;

  КоличествоСообщений = LnSelectValue("SELECT COUNT(T_ROWNUM) FROM DNBKI_TMP WHERE T_TEXT like '@@@'", V_INTEGER);
  return КоличествоСообщений;
END;

////////////////////////////////////////////////////////////////////////////////
//  Состав блоков данных КИ
//  Блок данных с информацией заголовка файла
MACRO ЗаголовокФайла(IsGroupMode : BOOL, BkiID: Integer, TF_ID_REF: INTEGER)
   var Sum,SQL_GuarantySum,SQL_GuarantyCount,OnlyGuarantyCondition,MixGuarantyCondition;
   var MinCloseDate = NULL_DATE;
   var  dd:integer = 0, mm:integer = 0, yy:integer = 0;
  

   MACRO СуммаЗадолженностиПОДоговорам( Валюта : STRING )
      Var TotalSumm = 0;
      var SQL_BK_OV_SUM,SQL_KD_Raz_SUM,SQL_RL_SUM;
      var BK_OV_SUM,KD_Raz_SUM,RL_SUM;

      BK_OV_SUM = KD_Raz_SUM = RL_SUM = 0;

      SQL_BK_OV_SUM =   " SELECT SUM(loansKernel.getregrest( loansKernel.getusregid_forobject(t_crd_kind,T_CREDITNUMBER,?),?)) "
                        "  FROM DCREDIT_C_DBT, DFININSTR_DBT WHERE  "
                        " (T_CRD_KIND = ?  OR T_CRD_KIND = ? ) "
                        " AND T_CURCODE = T_FIID "
                        " AND T_FI_CODE = ? "
                        " AND (loansvox.GetCloseDate(T_CRD_KIND,T_CREDITNUMBER) > ? "
                        " OR loansvox.GetCloseDate(T_CRD_KIND,T_CREDITNUMBER) = TO_DATE('01/01/0001','DD/MM/YYYY')) ";


      SQL_KD_Raz_SUM =  " SELECT SUM(T_CREDITSUM) FROM DCREDIT_C_DBT, DFININSTR_DBT "
                        " WHERE  "
                        " T_CRD_KIND = ? "
                        " AND T_PAYTYPE IN (?,?,?,?) "
                        " AND T_CURCODE = T_FIID "
                        " AND T_FI_CODE = ? "
                        " AND (loansvox.GetCloseDate(T_CRD_KIND,T_CREDITNUMBER) > ? "
                        " OR loansvox.GetCloseDate(T_CRD_KIND,T_CREDITNUMBER) = TO_DATE('01/01/0001','DD/MM/YYYY')) ";

      SQL_RL_SUM     =  " SELECT GREATEST( "
                        " loansKernel.getregrest( loansKernel.getusregid_forobject(t_crd_kind,T_CREDITNUMBER,?),?), "
                        " loansKernel.getregrest( loansKernel.getusregid_forobject(t_crd_kind,T_CREDITNUMBER,?),?)) "
                        " FROM DCREDIT_C_DBT, DFININSTR_DBT "
                        " WHERE  "
                        " T_CRD_KIND = ? "
                        " AND T_PAYTYPE IN (?,?,?) "
                        " AND T_CURCODE = T_FIID "
                        " AND T_FI_CODE = ? "
                        " AND (loansvox.GetCloseDate(t_crd_kind,T_CREDITNUMBER) > ? "
                        " OR loansvox.GetCloseDate(t_crd_kind,T_CREDITNUMBER) = TO_DATE('01/01/0001','DD/MM/YYYY')) ";


      BK_OV_SUM   =  CRSDCommand(SQL_BK_OV_SUM, "REG_ID", TDR_LIMDUTY,
                                "DATE", {curdate},  "CRD_KIND1",8/*LO_KARTA*/  , "CRD_KIND2",  22, /*LO_OVERDRAFT*/
                                "CURCODE", Валюта, 
                                "MinCloseDate",MinCloseDate, 
                                V_MONEY);


      KD_Raz_SUM  =  CRSDCommand(SQL_KD_Raz_SUM, "CRD_KIND", 1/*LO_CREDIT*/  ,
                                "PAY_TYPE1",CF_NONREP,
                                "PAY_TYPE2",CF_REP,
                                "PAY_TYPE3",CF_POSTERESTANTE,
                                "PAY_TYPE4",CF_BEFOREMATURITY,
                                "CURCODE", Валюта, 
                                "MinCloseDate",MinCloseDate, 
                                V_MONEY);
  
      RL_SUM      =  CRSDCommand(SQL_RL_SUM, "REG_ID1", TDR_LIMDUTY, "DATE1", {curdate},
                                "REG_ID2", TDR_LIMPAY, "DATE2", {curdate},
                                "CRD_KIND", 1/*LO_CREDIT*/  ,
                                "PAY_TYPE1",CF_CRLIN,
                                "PAY_TYPE2",CF_CRLINNO,
                                "PAY_TYPE3",CF_CRLINNEW,
                                "CURCODE", Валюта, 
                                "MinCloseDate",MinCloseDate, 
                                V_MONEY);

      TotalSumm = BK_OV_SUM+KD_Raz_SUM+RL_SUM;

      return TotalSumm;
   END;

   //  New
   DateSplit({curdate}, dd, mm, yy);
   IF ((dd == 29) AND (mm == 2)) dd = 28; END;
   MinCloseDate = date(dd,mm,yy-5);

   //ASSD
   OnlyGuarantyCondition = "1";
   MixGuarantyCondition  = "2,3,6";
   SQL_GuarantyCount = " SELECT COUNT(*) FROM DENSCONTR_DBT, DTYPE_ENS_DBT "
                       " WHERE T_ENSSYSTYPE = T_TYPEENSID AND "
                       " T_ENSCONTRACTSTATUS != 4 AND  "
                       " T_SYSTYPEENSID_REF IN (?,?,?,?)";
   SQL_GuarantySum  = " SELECT SUM(sum.t_sum) FROM DENSCONTR_DBT, DTYPE_ENS_DBT, DFININSTR_DBT,DLESCHSUM_DBT sum "
                       " WHERE T_ENSSYSTYPE = T_TYPEENSID AND "
                       " T_ENSCONTRACTSTATUS != 4 AND  "
                       " T_SYSTYPEENSID_REF IN (?,?,?) AND "
                       " T_ENSCONTRACTCUR = T_FIID AND "
                       " T_FI_CODE = ? AND"
                       " T_ENSCONTRACTID = sum.T_ENSCONTRACTID_REF "
                       " AND sum.t_date = (SELECT MAX(t_date) from DLESCHSUM_DBT "
                       " where T_ENSCONTRACTID = T_ENSCONTRACTID_REF)";


   InsertString(1, "ДЛИНЗАГ",  "N",  2,  "", 20,                    TRUE,"Н");
   InsertString(2, "ИДИСТ",    "A", 10, "S", lbki.rec.SourceID,     TRUE,"Н");
   InsertString(3, "ИДПОЛУЧ",  "A", 10, "S", "9999999999",          TRUE,"Н");
   InsertString(4, "ЧИСЛСООБ", "N", 12,  "", ПолучитьЧислоСообщений(IsGroupMode,BkiID, TF_ID_REF),TRUE,"Н");
   InsertString(5, "ДАТФАЙЛ",  "D",  8,  "", ltr_file.rec.FileDate, TRUE,"Н");
   InsertString(6, "ИМЯФАЙЛ",  "A", 12,  "", ltr_file.rec.FileName, TRUE,"Н");

   InsertString(7, "НОМВЕРС", "N", 2,  "", 6, TRUE,"O");

   //ASSD 2
   Sum = CRSDCommand("SELECT COUNT(T_CREDITNUMBER) FROM  (SELECT T_CREDITNUMBER, "
                      " loansvox.GetCloseDate(t_crd_kind,T_CREDITNUMBER) CLOSE_DATE "
                      " FROM DCREDIT_C_DBT ) CRD_CL_DATE "
                      " WHERE "
                      " CLOSE_DATE > ? "
                      " OR CLOSE_DATE = TO_DATE('01/01/0001','DD/MM/YYYY')  ",
                      "MinCloseDate",MinCloseDate,
                      V_INTEGER);
   InsertString(8, "КОЛДД",   "N", 12,  "", Sum, TRUE,"Oz");
   Sum = СуммаЗадолженностиПОДоговорам("810");
   InsertString(9, "СУММОБЯЗР", "N", 14.2,  "", Sum, TRUE,"Oz");
   Sum = СуммаЗадолженностиПОДоговорам("840");
   InsertString(10,"СУММОБЯЗД", "N", 14.2,  "", Sum, TRUE,"Oz");
   Sum = СуммаЗадолженностиПОДоговорам("978");
   InsertString(11,"СУММОБЯЗЕ", "N", 14.2,  "", Sum, TRUE,"Oz");
   //ASSD
   Sum = CRSDCommand(SQL_GuarantyCount, "ID1", 1,"ID2", 1,"ID3", 1,"ID4", 1, V_INTEGER);
   InsertString(12, "КОЛДП",   "N", 12,  "", Sum, TRUE,"Oz");
   Sum = CRSDCommand(SQL_GuarantySum,   "ID1", 1,"ID2", 1,"ID3", 1,  "CUR","810", V_MONEY);
   InsertString(13, "СУММПОР", "N", 14.2,  "", Sum, TRUE,"Oz");
   Sum = CRSDCommand(SQL_GuarantySum,   "ID1", 1,"ID2", 1,"ID3", 1,  "CUR","840", V_MONEY);
   InsertString(14,"СУММПОД", "N", 14.2,  "", Sum, TRUE,"Oz");
   Sum = CRSDCommand(SQL_GuarantySum,   "ID1", 1,"ID2", 1,"ID3", 1,  "CUR","978", V_MONEY);
   InsertString(15,"СУММПОЕ", "N", 14.2,  "", Sum, TRUE,"Oz");
   Sum = CRSDCommand(SQL_GuarantyCount, "ID1", 2,"ID2", 3,"ID3", 4,"ID4",5,   V_INTEGER);
   InsertString(16,"КОЛДЗ",   "N", 12,  "", Sum, TRUE,"Oz");
   Sum = CRSDCommand(SQL_GuarantySum,   "ID1", 2,"ID2", 3,"ID3", 6,  "CUR","810", V_MONEY);
   InsertString(17,"СУММЗАЛР","N", 14.2,  "", Sum, TRUE,"O");
   Sum = CRSDCommand(SQL_GuarantySum,   "ID1", 2,"ID2", 3,"ID3", 6,  "CUR","840", V_MONEY);
   InsertString(18,"СУММЗАЛД","N", 14.2,  "", Sum, TRUE,"Oz");
   InsertString(19,"ДАТАКТ",  "D", 8,     "", {curdate}, TRUE, "Oz");
   Sum = CRSDCommand(SQL_GuarantySum,   "ID1", 2,"ID2", 3,"ID3", 6,  "CUR","978", V_MONEY);
   InsertString(20,"СУММЗАЛЕ","N", 14.2,  "", Sum, TRUE,"Oz");
   InsertString(21, "@@@",      "A",  3, "S", "",                    TRUE,"Н");
END;

////////////////////////////////////////////////////////////////////////////////
//
// ФОРМИРОВАНИЕ ВИРТУАЛЬНОЙ ИСТОРИИ
//
// ПАРАМЕТРЫ:
//   BkiID        - системный номер БКИ
//   CreditNumber - номер КД
//   SendKind     - Вид передачи. (1 - Изменения КИ, 2 - Полная КИ, 3 - Запрос на удаление КИ)
//   TrFileID     - Ссылка на транспортный файл

MACRO СформироватьВиртуальнуюИсторию(BkiID: Integer, CrdNum: integer, SK: integer, TrFileID: integer)
   VAR RSDcmd, RSDcmd0, RSDcmd1, RSDcmd2, RSDcmd3,RSDcmd31, RSDcmd4, RSDcmd5, RSDcmd6, RSDcmd7, RSDcmd71, RSDcmd8, RSDcmd9, RSDcmd10, RSDcmd11, RSDcmd12,RSDcmd12_1,RSDcmd12_2, RSDcmd13, RSDcmd14, RSDcmd15;

   IF (VALTYPE(NotUsefillcreditlist) == V_UNDEF)  NotUsefillcreditlist = FALSE; END; // Используется при вызове в ф MACRO ПроверкаДанных(...)   

   // Пакетная выгрузка
   IF ((CrdNum == 0) AND (TrFileID == 0))
      IF ((SK != 1) AND (SK != 2))
         LoansError("Для данного вида передачи пакетный режим не предусмотрен!");
         RETURN FALSE;
      END;
   END;

   BegAction(2000, "Идет обработка...", TRUE);
   InitProgress(21, "Стадия обработки...", "Построение виртуальной КИ");

   IF (not NotUsefillcreditlist)
      RSDcmd = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.fillcreditlist(?,?,?,?,?,?,?); end;");

      RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);

      RSDcmd.addParam("bkiid",        RSDBP_IN); RSDcmd.value("bkiid")        = BkiID;
      RSDcmd.addParam("reportdate",   RSDBP_IN); RSDcmd.value("reportdate")   = ReportDate;
      RSDcmd.addParam("sendkind",     RSDBP_IN); RSDcmd.value("sendkind")     = SK;
      RSDcmd.addParam("legalform",    RSDBP_IN); RSDcmd.value("legalform")    = _legalform;
      RSDcmd.addParam("oper",         RSDBP_IN); RSDcmd.value("oper")         = opoper;
      RSDcmd.addParam("creditnumber", RSDBP_IN); RSDcmd.value("creditnumber") = crdnum;
      RSDcmd.addParam("TrFileID",     RSDBP_IN); RSDcmd.value("TrFileID")     = TrFileID;
      RSDcmd.execute();

      IF (LnSelectValue("SELECT COUNT(1) FROM DOBJECT_BKI_TMP", V_INTEGER) == 0)
         RemProgress ();
         EndAction();

         LoansError("Передача КИ запрещена!");
         RETURN FALSE;
      END;

      RSDcmd = null;

      // ASSD   
      RSDcmd = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.fill_DO_list(?,?,?,?,?,?); end;");

      RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);

      RSDcmd.addParam("bkiid",        RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
      RSDcmd.addParam("reportdate",   RSDBP_IN); RSDcmd.value("reportdate") = ReportDate;
      RSDcmd.addParam("sendkind",     RSDBP_IN); RSDcmd.value("sendkind") = SK;
      RSDcmd.addParam("legalform",    RSDBP_IN); RSDcmd.value("legalform") = _legalform;
      RSDcmd.addParam("oper",         RSDBP_IN); RSDcmd.value("oper") = opoper;
      RSDcmd.addParam("creditnumber", RSDBP_IN); RSDcmd.value("creditnumber") = crdnum;
      RSDcmd.execute();
      RSDcmd = null;
   ELSE
      LnSqlExec("DELETE FROM dlbki_201_tmp");
      LnSqlExec("DELETE FROM dlbki_202_tmp");
      LnSqlExec("DELETE FROM dlbki_203_tmp");
      LnSqlExec("DELETE FROM dlbki_301_tmp");
      LnSqlExec("DELETE FROM dlbki_302_tmp");
      LnSqlExec("DELETE FROM dlbki_304_tmp");
      LnSqlExec("DELETE FROM dlbki_401_tmp");
      LnSqlExec("DELETE FROM dlbki_402_tmp");
      LnSqlExec("DELETE FROM dlbki_404_tmp");
      LnSqlExec("DELETE FROM dlbki_406_tmp");
      LnSqlExec("DELETE FROM dlbki_407_tmp");
      LnSqlExec("DELETE FROM dlbki_601_tmp");
   END;
   UseProgress (1);
   
   RSDcmd0 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_182(?,?); end;");
   RSDcmd0.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd0.addParam("tfid",  RSDBP_IN); RSDcmd0.value ("tfid") = TrFileID;
   RSDcmd0.addParam("bkiid", RSDBP_IN); RSDcmd0.value("bkiid") = BkiID;
   RSDcmd0.execute();
   UseProgress (2);
   RSDcmd0 = null;

   RSDcmd1 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_201(?,?); end;");
   RSDcmd1.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd1.addParam("tfid",  RSDBP_IN); RSDcmd1.value("tfid")  = TrFileID;
   RSDcmd1.addParam("bkiid", RSDBP_IN); RSDcmd1.value("bkiid") = BkiID;
   RSDcmd1.execute();
   UseProgress (3);
   RSDcmd1 = null;

   RSDcmd2 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_202(?,?); end;");
   RSDcmd2.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd2.addParam("tfid",  RSDBP_IN); RSDcmd2.value("tfid")  = TrFileID;
   RSDcmd2.addParam("bkiid", RSDBP_IN); RSDcmd2.value("bkiid") = BkiID;
   RSDcmd2.execute();
   RSDcmd2 = null;
   UseProgress (4);

   RSDcmd3 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_203(?,?); end;");
   RSDcmd3.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd3.addParam("tfid",  RSDBP_IN); RSDcmd3.value("tfid")  = TrFileID;
   RSDcmd3.addParam("bkiid", RSDBP_IN); RSDcmd3.value("bkiid") = BkiID;
   RSDcmd3.execute();
   RSDcmd3 = null;
   UseProgress (5);

   RSDcmd31 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_204(?,?); end;");
   RSDcmd31.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd31.addParam("tfid",  RSDBP_IN); RSDcmd31.value("tfid")  = TrFileID;
   RSDcmd31.addParam("bkiid", RSDBP_IN); RSDcmd31.value("bkiid") = BkiID;
   RSDcmd31.execute();
   RSDcmd31 = null;
   UseProgress (6);

   RSDcmd4 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_301(?,?); end;");
   RSDcmd4.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd4.addParam("tfid",  RSDBP_IN); RSDcmd4.value("tfid")  = TrFileID;
   RSDcmd4.addParam("bkiid", RSDBP_IN); RSDcmd4.value("bkiid") = BkiID;
   RSDcmd4.execute();
   RSDcmd4 = null;
   UseProgress (7);

   RSDcmd5 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_302(?,?); end;");
   RSDcmd5.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd5.addParam("tfid",   RSDBP_IN);
   RSDcmd5.value("tfid")  = TrFileID; RSDcmd5.addParam("bkiid",   RSDBP_IN);
   RSDcmd5.value("bkiid") = BkiID;    RSDcmd5.execute();
   RSDcmd5 = null;
   UseProgress (8);

   RSDcmd6 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_304(?,?); end;");
   RSDcmd6.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd6.addParam("tfid",  RSDBP_IN); RSDcmd6.value("tfid")  = TrFileID;
   RSDcmd6.addParam("bkiid", RSDBP_IN); RSDcmd6.value("bkiid") = BkiID;
   RSDcmd6.execute();
   RSDcmd6 = null;
   UseProgress (9);

   RSDcmd7 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_401(?,?); end;");
   RSDcmd7.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd7.addParam("tfid",  RSDBP_IN); RSDcmd7.value("tfid")  = TrFileID;
   RSDcmd7.addParam("bkiid", RSDBP_IN); RSDcmd7.value("bkiid") = BkiID;
   RSDcmd7.execute();
   RSDcmd7 = null;
   UseProgress (10);

   RSDcmd71 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_415(?,?); end;");
   RSDcmd71.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd71.addParam("tfid",  RSDBP_IN); RSDcmd71.value("tfid")  = TrFileID;
   RSDcmd71.addParam("bkiid", RSDBP_IN); RSDcmd71.value("bkiid") = BkiID;
   RSDcmd71.execute();
   RSDcmd71 = null;
   UseProgress (11);

   RSDcmd8 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_402(?,?); end;");
   RSDcmd8.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd8.addParam("tfid",  RSDBP_IN); RSDcmd8.value("tfid")  = TrFileID;
   RSDcmd8.addParam("bkiid", RSDBP_IN); RSDcmd8.value("bkiid") = BkiID;
   RSDcmd8.execute();
   RSDcmd8 = null;
   UseProgress (12);

   RSDcmd9 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_404(?,?); end;");
   RSDcmd9.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd9.addParam("tfid",  RSDBP_IN); RSDcmd9.value("tfid")  = TrFileID;
   RSDcmd9.addParam("bkiid", RSDBP_IN); RSDcmd9.value("bkiid") = BkiID;
   RSDcmd9.execute();
   RSDcmd9 = null;
   UseProgress (13);

   RSDcmd10 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_406(?,?); end;");
   RSDcmd10.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd10.addParam("tfid",  RSDBP_IN); RSDcmd10.value("tfid")  = TrFileID;
   RSDcmd10.addParam("bkiid", RSDBP_IN); RSDcmd10.value("bkiid") = BkiID;
   RSDcmd10.execute();
   RSDcmd10 = null;
   UseProgress (14);

   RSDcmd11 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_407(?,?); end;");
   RSDcmd11.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd11.addParam("tfid",  RSDBP_IN); RSDcmd11.value("tfid") = TrFileID;
   RSDcmd11.addParam("bkiid", RSDBP_IN); RSDcmd11.value("bkiid") = BkiID;
   RSDcmd11.execute();
   RSDcmd11 = null;
   UseProgress (15);

   RSDcmd12 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_408(?,?); end;");
   RSDcmd12.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd12.addParam("tfid",  RSDBP_IN); RSDcmd12.value ("tfid") = TrFileID;
   RSDcmd12.addParam("bkiid", RSDBP_IN); RSDcmd12.value("bkiid") = BkiID;
   RSDcmd12.execute();
   RSDcmd12 = null;
   UseProgress (16);
   
   RSDcmd12_1 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_409(?,?); end;");
   RSDcmd12_1.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd12_1.addParam("tfid",  RSDBP_IN); RSDcmd12_1.value ("tfid") = TrFileID;
   RSDcmd12_1.addParam("bkiid", RSDBP_IN); RSDcmd12_1.value("bkiid") = BkiID;
   RSDcmd12_1.execute();
   RSDcmd12_1 = null;
   UseProgress (17);

   RSDcmd12_2 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_410(?,?); end;");
   RSDcmd12_2.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd12_2.addParam("tfid",   RSDBP_IN);   RSDcmd12_2.value("tfid") = TrFileID;
   RSDcmd12_2.addParam("bkiid",  RSDBP_IN);   RSDcmd12_2.value("bkiid") = BkiID;
   RSDcmd12_2.execute();
   RSDcmd12_2 = null;
   UseProgress (18);
   
   RSDcmd13 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.bki_block_601(?,?); end;");
   RSDcmd13.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd13.addParam("tfid",   RSDBP_IN);   RSDcmd13.value("tfid") = TrFileID;
   RSDcmd13.addParam("bkiid",  RSDBP_IN);   RSDcmd13.value("bkiid") = BkiID;
   RSDcmd13.execute();
   RSDcmd13 = null;
   UseProgress (19);

   RSDcmd14 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.update_ens_crd_num; end;");
   RSDcmd14.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd14.execute();
   RSDcmd14 = null;
   UseProgress (20);

   RSDcmd15 = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.updatecreditnumber; end;");
   RSDcmd15.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   RSDcmd15.execute();
   RSDcmd15 = null;
   UseProgress (21);

   RemProgress (21);
   EndAction();
                                                                                                                                            
   RETURN TRUE;
END;

                                                                                                                                            
MACRO FillCrd( CreditNumber )
VAR Str;
   Str = "INSERT INTO DCREDIT_C_TMP ("
                                     "T_CREDITNUMBER, T_CREDITTYPEID_REF, T_FNCASH, T_CLIENTID_REF, T_CREDITSTATE, "
                                     "T_CREDITSUM, T_PAYTYPE, T_CURCODE, T_REGDATE, T_PAYMENTDATE, T_DURATION, "
                                     "T_RETURNDATE, T_USERFIELD1, T_USERFIELD2, T_FULLDURATION, T_GROUPNUM, "
                                     "T_USERTYPE, T_RISKGROUP, T_FLAGOB, T_ENSURE, T_TYPEDURATION, T_USCREDITNUMBER, "
                                     "T_PRIVILEGEFLAG, T_REPDATE, T_BEFOREDUTY, T_ACCOUNTKARTA, "
                                     "T_CRD_KIND, T_DUTYDAY, T_REPDAY, T_RETAILACCPAY_REF, T_RETAILACCDUTY_REF, "
                                     "T_FINECOND, T_LEGALFORM, T_BENEFICIARY, T_TERRITORIALSTRUCT, T_ACCEPTANCE, "
                                     "T_ACCEPTANCEDAY, T_TYPEREPDATE, T_SPECIFIC, T_ANNUIT, T_GENERALAGREEMENT_REF, "
                                     "T_GRACEPERIODDAY, T_GRACEPERIODTUNING, T_MININSTALLMENT, "
                                     "T_BRANCH, T_RETAILKARTA, "
                                     "T_TYPEDEBTOR, T_INDCLASSIFICATION, T_DEBTORGROUP_REF, "
                                     "T_SERVICELOAN "
                                     ") ";
  Str = Str + "SELECT "
                                      "c.T_CREDITNUMBER, c.T_CREDITTYPEID_REF, c.T_FNCASH, c.T_CLIENTID_REF, c.T_CREDITSTATE, "
                                      "c.T_CREDITSUM, c.T_PAYTYPE, c.T_CURCODE, c.T_REGDATE, c.T_PAYMENTDATE, c.T_DURATION, "
                                      "c.T_RETURNDATE, c.T_USERFIELD1, c.T_USERFIELD2, c.T_FULLDURATION, c.T_GROUPNUM, "
                                      "c.T_USERTYPE, c.T_RISKGROUP, c.T_FLAGOB, c.T_ENSURE, c.T_TYPEDURATION, c.T_USCREDITNUMBER, "
                                      "c.T_PRIVILEGEFLAG, c.T_REPDATE, c.T_BEFOREDUTY, c.T_ACCOUNTKARTA, "
                                      "c.T_CRD_KIND, c.T_DUTYDAY, c.T_REPDAY, c.T_RETAILACCPAY_REF, c.T_RETAILACCDUTY_REF, "
                                      "c.T_FINECOND, c.T_LEGALFORM, c.T_BENEFICIARY, c.T_TERRITORIALSTRUCT, c.T_ACCEPTANCE, "
                                      "c.T_ACCEPTANCEDAY, c.T_TYPEREPDATE, c.T_SPECIFIC, c.T_ANNUIT, c.T_GENERALAGREEMENT_REF, "
                                      "c.T_GRACEPERIODDAY, c.T_GRACEPERIODTUNING, c.T_MININSTALLMENT, "
                                      "c.T_BRANCH, c.T_RETAILKARTA, "
                                      "c.T_TYPEDEBTOR, c.T_INDCLASSIFICATION, c.T_DEBTORGROUP_REF, "
                                      "c.T_SERVICELOAN "
                                      "FROM DCREDIT_C_DBT c WHERE c.T_CREDITNUMBER = "+CreditNumber ;
   LnSqlExec(Str);

END;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Преобразование типов данных, возвращаемых SQL запросами
MACRO Nvl(val, type)
   VAR dt: date;

   // Тип datetime => date
   IF ((ValType(val) == V_DTTM) AND (type == V_DATE))
      DtTmSplit(val, dt);
      RETURN dt;
   END;

   IF ((ValType(val) == V_DOUBLE) AND (type == V_INTEGER))
      RETURN int(val);
   END;

   IF ((ValType(val) == V_STRING) AND (CodeFor(val) == 1))
      val = "";
   END;

   IF((ValType(val) != type) OR (ValType(val) == V_UNDEF))
      IF   (type == V_STRING)  RETURN "";
      ELIF (type == V_INTEGER) RETURN  0;
      ELIF (type == V_DOUBLE)  RETURN  0;
      ELIF (type == V_MONEY)   RETURN $0;
      ELIF (type == V_DATE)    RETURN date(0,0,0);
      END;
   END;

   RETURN Val;
END;


MACRO ЗаполнитьДанныеКлиента(CrdNum: integer, ClientID: integer)
   VAR RS = NULL;

   IF (ValType(ClientID) != V_INTEGER)
      ClientID = -1;
   END;
   
   RS = CRSDCommand("SELECT l.T_OTHERDEBTORNUM AS OTHERDEBTORNUM, " +
                          " p.T_LEGALFORM      AS LEGALFORM,   " +
                          " prsn.T_ISEMPLOYER  AS ISEMPLOYER,  " +
                          " l.T_PARTYID_REF    AS PARTYID,     " +
                          " p.T_NOTRESIDENT    AS NOTRESIDENT, " +
                          " prsn.T_NAME1       AS NAME1, " +
                          " prsn.T_NAME2       AS NAME2, " +
                          " prsn.T_NAME3       AS NAME3, " +
                          " prsn.T_BORN        AS BORN,  " +
                          " prsn.T_BIRSPLASE   AS BIRSPLASE, " +
                          " p.T_NRCOUNTRY      AS COUNTRY,   " +
                          " p.T_SHORTNAME      AS SHORTNAME, " +
                          " p.T_NAME           AS NAME,  " +
                          " p.T_OKPO           AS OKPO,  " +
                          " prsn.T_ISMALE      AS ISMALE " +
                    " FROM DLOTHDEB_DBT l, DPARTY_DBT p, DPERSN_DBT prsn WHERE " +
                        " l.T_ISDELETED      <> CHR(?) " +
                    " AND l.T_OBJECTTYPEID_REF = ? " +
                    " AND l.T_OBJECTNUMBER_REF = ? " +
                    " AND l.T_PARTYID_REF      = p.T_PARTYID "
                    " AND p.T_LEGALFORM        = ? " +
                    " AND p.T_PARTYID          = prsn.T_PERSONID " +
                    " AND (p.T_PARTYID = " + ClientID + " OR -1 = " + ClientID + ")" +
                    " UNION ALL " +
                    "SELECT l.T_OTHERDEBTORNUM AS OTHERDEBTORNUM, " +
                          " p.T_LEGALFORM   AS LEGALFORM,   " +
                          " CHR(?)          AS ISEMPLOYER,  " +
                          " l.T_PARTYID_REF AS PARTYID,     " +
                          " p.T_NOTRESIDENT AS NOTRESIDENT, " +
                          " CHR(?) AS NAME1, " +
                          " CHR(?) AS NAME2, " +
                          " CHR(?) AS NAME3, " +
                          " ?      AS BORN," +
                          " CHR(?) AS BIRSPLASE, " +
                          " p.T_NRCOUNTRY AS COUNTRY,   " +
                          " p.T_SHORTNAME AS SHORTNAME, " +
                          " p.T_NAME AS NAME,  " +
                          " p.T_OKPO AS OKPO,  " +
                          " CHR(?)   AS ISMALE " +
                    " FROM DLOTHDEB_DBT l, DPARTY_DBT p WHERE " +
                        " l.T_ISDELETED      <> CHR(?) " +
                    " AND l.T_OBJECTTYPEID_REF    = ?  " +
                    " AND l.T_OBJECTNUMBER_REF    = ?  " +
                    " AND l.T_PARTYID_REF         = p.T_PARTYID "
                    " AND p.T_LEGALFORM           = ?  ",
                    "ISDELETED",     88,
                    "OBJECTTYPEID",  ObjectTypeID,
                    "OBJECTNUMBER",  CrdNum,
                    "LEGALFORM",     2,
                    "E",  32,
                    "N1", 32, "N2", 32, "N3", 32,
                    "D1", date(0,0,0),
                    "B",  32,
                    "ISMALE",  32,
                    "ISDELETED2",    88,
                    "OBJECTTYPEID2", ObjectTypeID,
                    "OBJECTNUMBER2", CrdNum,
                    "LEGALFORM2",    1,
                    V_GENOBJ);

   IF (RS AND RS.MoveNext())
      OTHERDEBTORNUM = Nvl(RS.Value("OTHERDEBTORNUM"), V_INTEGER);
      LegalForm      = Nvl(RS.Value("LEGALFORM"),      V_INTEGER);
      IsEmployer     = Nvl(RS.Value("ISEMPLOYER"),     V_STRING );
      CodClient      = Nvl(RS.Value("PARTYID"),        V_INTEGER);
      Name           = Nvl(RS.Value("NAME"),           V_STRING );
      //ShortName      = Nvl(RS.Value("SHORTNAME"),      V_STRING );
      //OKPO           = Nvl(RS.Value("OKPO"),           V_STRING );
      //IsMale         = Nvl(RS.Value("ISMALE"),         V_STRING );
      //passport       = true;
      //registration   = true;

      // Определим тип клиента
      // Физ. лицo.
      IF (LegalForm == 2)
         TypeClient = PTLEGF_PERSN;
         
         Name1       = Nvl(RS.Value("NAME1"),       V_STRING); // Фамилия
         Name2       = Nvl(RS.Value("NAME2"),       V_STRING); // Имя
         Name3       = Nvl(RS.Value("NAME3"),       V_STRING); // Отчество
         Born        = Nvl(RS.Value("BORN"),          V_DATE); // Дата рождения
         //BirsPlace   = Nvl(RS.Value("BIRSPLASE"),   V_STRING); // Место рождения
         //NotResident = Nvl(RS.Value("NOTRESIDENT"), V_STRING); // Признак резидента
         //Country     = Nvl(RS.Value("COUNTRY"),     V_STRING); // Страна
      ELSE
         // Юp. лицo
         TypeClient = PTLEGF_INST;
         //NotResident = Nvl(RS.Value("NOTRESIDENT"), V_STRING); // Признак резидента
      END;
   END;         
END;

// Блок данных с информацией запроса на удаление КИ из АС БКИ. 500
MACRO СформироватьБлок_500(BkiID: Integer, CreditNumber: integer, SendKind: integer)
    VAR ИДДОГ      : string  = "",
        UserNumber : string  = "",
        Type       : integer =  0,
        Value,DO_Type,Status;
        
   credit_c.rec.CreditNumber = CreditNumber;
   IF (NOT credit_c.GetEQ())
      Copy(credit_c, safe_crd);
      LoansError("БЛОК 500: Не найден договор №"+CreditNumber);
      RETURN FALSE;
   END;
   
   IF (credit_c.rec.Crd_kind == LO_CREDIT)
       ObjectTypeID = LO_CREDIT;
   ELSE
       ObjectTypeID = LO_KARTA;
   END;
   
   ЗаполнитьДанныеКлиента(CreditNumber);        

   IF((credit_c.rec.PayType == CF_NONREP ) OR
      (credit_c.rec.PayType == CF_REP    ) OR
      (credit_c.rec.PayType == CF_POSTERESTANTE) OR
      (credit_c.rec.PayType == CF_BEFOREMATURITY ))
     Type = 1;
   END;

   IF( credit_c.rec.PayType == CF_CRLINNEW )
     Type = 2;
   END;

   IF((credit_c.rec.PayType == CF_CRLINNO) OR
      (credit_c.rec.PayType == CF_CRLIN))
     Type = 3;
   END;

   // БК
   IF (credit_c.rec.Crd_Kind == LO_KARTA) // 8
      Type       = 5;
      UserNumber = credit_c.rec.AccountKarta;

      // Если длина больше 20, запишем системный номер
      IF (strlen(UserNumber) > 20)
         UserNumber = credit_c.rec.CreditNumber;
      END;
   ELSE
      UserNumber = string(credit_c.rec.CreditNumber);
   END;

   Value = string(TypeClient + "" + Type + "00000000000000000000");
   StrSet(Value, 23 - StrLen(UserNumber), UserNumber);

   InsertString(1, "ИДБЛОК",  "A",  3, "S", "500", TRUE,"O");
   InsertString(2, "НОМЗАПР", "N", 12,  "", НОМЗАПР, TRUE,"O"); НОМЗАПР = НОМЗАПР + 1;
   InsertString(3, "ИДИСТ",   "A", 10,  "", lbki.rec.SourceID, TRUE,"O");
   IF (SendKind == 3) // Удаление КИ
      InsertString(4, "ИДДОГ",   "A", 22,  "", Value, TRUE,"O");
   ELSE // 4 (данный блок вызывается только для  удалени 3 и 4 )
      enscontr.Clear();
      enscontr.rec.EnsContractID = ltr_file.rec.ObjectID;
      IF (NOT enscontr.GetEQ())
         LoansError("Не найден договор №"+ltr_file.rec.ObjectID);
      END;

      DO_Type = -1;
      DO_Type = CRSDCommand("SELECT T_SYSTYPEENSID_REF FROM DTYPE_ENS_DBT WHERE T_TYPEENSID  = ?",
           "ENS_SYS_TYPE",enscontr.rec.EnsSysType,V_INTEGER);
      IF (DO_Type > 0)
         //4 - залог
         //5 - поручительство
         //6 - прочее обеспечение
         IF  (DO_Type == 1) //  поручительство DNAMEALG_DBT ( ITYPEALG = 944 )
            DO_Type = 5;
         ELIF ((DO_Type >= 2) AND (DO_Type <= 7)) //4 - залог
            DO_Type = 4;
         ELSE //6 - прочее обеспечение
            DO_Type  = 6;
         END;
      END;

      Status = TypeClient;
      IF (TypeClient == PTLEGF_PBUL ) Status = 3; END;

      UserNumber = string(Status + "" + DO_Type + "00000000000000000000");
      StrSet(UserNumber, 23 - StrLen(String(enscontr.rec.EnsContractID)), String(enscontr.rec.EnsContractID)); // (строка обрежется с слева 20тью символами
      InsertString(4, "ИДДОГОБ",   "A", 22,  "", UserNumber, TRUE,"O");
   END;
   InsertString(5, "@@@", "A",  3, "S", "", TRUE,"Н");

   RETURN TRUE;
END;

// Блок данных с информацией запроса на удаление КИ из АС БКИ. 251
MACRO СформироватьБлок_251(BkiID: Integer, CreditNumber: integer, SendKind: integer)
   VAR ИДДОГ      : string  = "",
       UserNumber : string  = "",
       Type       : integer =  0,
       Value;
   
   credit_c.rec.CreditNumber = CreditNumber;
   IF (NOT credit_c.GetEQ())
      Copy(credit_c, safe_crd);
      LoansError("БЛОК 500: Не найден договор №"+CreditNumber);
      RETURN FALSE;
   END;
   
   IF (credit_c.rec.Crd_kind == LO_CREDIT)
       ObjectTypeID = LO_CREDIT;
   ELSE
       ObjectTypeID = LO_KARTA;
   END;
   
   ЗаполнитьДанныеКлиента(CreditNumber, ltr_file.rec.ObjectID);
   IF (LegalForm != 2)
      LoansError("Запрос на удаление контрагента возможен только для физ. лиц");
      RETURN FALSE;
   END;

   IF((credit_c.rec.PayType == CF_NONREP ) OR
      (credit_c.rec.PayType == CF_REP    ) OR
      (credit_c.rec.PayType == CF_POSTERESTANTE) OR
      (credit_c.rec.PayType == CF_BEFOREMATURITY ))
     Type = 1;
   END;

   IF( credit_c.rec.PayType == CF_CRLINNEW )
     Type = 2;
   END;

   IF((credit_c.rec.PayType == CF_CRLINNO) OR
      (credit_c.rec.PayType == CF_CRLIN))
     Type = 3;
   END;

   // БК
   IF (credit_c.rec.Crd_Kind == LO_KARTA)
     Type       = 5;
     UserNumber = credit_c.rec.AccountKarta;

     // Если длина больше 20, запишем системный номер
     IF (strlen(UserNumber) > 20)
        UserNumber = credit_c.rec.CreditNumber;
     END;
   ELSE
     UserNumber = string(credit_c.rec.CreditNumber);
   END;

   Value = string(TypeClient + "" + Type + "00000000000000000000");
   StrSet(Value, 23 - StrLen(UserNumber), UserNumber);

   InsertString(1, "ИДБЛОК",  "A",  3, "S", "251", TRUE,"O");
   InsertString(2, "ИДИСТ",   "A", 10,  "", lbki.rec.SourceID, TRUE,"O");
   InsertString(3, "ИДДОГ",   "A", 22,  "", Value, TRUE,"O");
   InsertString(4, "НОМЗАЕМ", "N",   2,  "",OTHERDEBTORNUM, TRUE,"O");
   InsertString(5, "ИНН",     "A",  12,  "", GetPartCode(ClientID, 16), TRUE,"Н");                  // TRUE
   InsertString(6, "ФАМ",     "A",  40,  "", Name1, TRUE,"O");
   InsertString(7, "ИМЯ",     "A",  40,  "", Name2, TRUE,"O");
   InsertString(8, "ОТЧ",     "A",  40,  "", Name3, TRUE,"O");
   InsertString(9, "ДАТАРОЖД","D",   8,  "", Born, TRUE,"O");
   InsertString(10, "@@@",    "A",   3, "S", "", TRUE,"Н");

   RETURN TRUE;
END;


// Блок данных с информацией запроса на удаление КИ из АС БКИ. 417
MACRO СформироватьБлок_417(BkiID: Integer, CreditNumber: integer, SendKind: integer)
    VAR ИДДОГ      : string  = "",
        UserNumber : string  = "",
        Type       : integer =  0,
        OperNumber : integer = -1,
        Value;
        
   credit_c.rec.CreditNumber = CreditNumber;
   IF (NOT credit_c.GetEQ())
      Copy(credit_c, safe_crd);
      LoansError("БЛОК 500: Не найден договор №"+CreditNumber);
      RETURN FALSE;
   END;
   
   IF (credit_c.rec.Crd_kind == LO_CREDIT)
       ObjectTypeID = LO_CREDIT;
   ELSE
       ObjectTypeID = LO_KARTA;
   END;
   
   ЗаполнитьДанныеКлиента( CreditNumber );        

   OperNumber = ltr_file.rec.ObjectID;

   IF((credit_c.rec.PayType == CF_NONREP ) OR
      (credit_c.rec.PayType == CF_REP    ) OR
      (credit_c.rec.PayType == CF_POSTERESTANTE) OR
      (credit_c.rec.PayType == CF_BEFOREMATURITY ))
     Type = 1;
   END;

   IF( credit_c.rec.PayType == CF_CRLINNEW )
     Type = 2;
   END;

   IF((credit_c.rec.PayType == CF_CRLINNO) OR
      (credit_c.rec.PayType == CF_CRLIN))
     Type = 3;
   END;

   // БК
   IF (credit_c.rec.Crd_Kind == LO_KARTA)
     Type       = 5;
     UserNumber = credit_c.rec.AccountKarta;

     // Если длина больше 20, запишем системный номер
     IF (strlen(UserNumber) > 20)
        UserNumber = credit_c.rec.CreditNumber;
     END;
   ELSE
     UserNumber = string(credit_c.rec.CreditNumber);
   END;

   Value = string(TypeClient + "" + Type + "00000000000000000000");
   StrSet(Value, 23 - StrLen(UserNumber), UserNumber);

   IF ((ValType(OperNumber) == V_UNDEF) OR (OperNumber < 0))
       OperNumber = "Не выбрана операция!";
   END;
   InsertString(1, "ИДБЛОК",  "A",  3, "S", "417", TRUE,"O");
   InsertString(3, "ИДИСТ",   "A", 10,  "", lbki.rec.SourceID, TRUE,"O");
   InsertString(4, "ИДДОГ",   "A", 22,  "", Value, TRUE,"O");
   InsertString(5, "НОМОПЕР", "N", 12,  "", OperNumber, TRUE,"O");
   InsertString(6, "@@@",     "A",  3, "S", "", Undef,"Н");

   RETURN TRUE;
END;



MACRO СгенерироватьЗапросНаУдаление(BkiID: Integer, CreditNumber: integer, SendKind: integer)
   VAR RETVAL = FALSE;

   IF ((SendKind == 3) OR (SendKind == 4))
      RETVAL = СформироватьБлок_500(BkiID, CreditNumber, SendKind);
   END;

    IF (SendKind == 5)
      RETVAL = СформироватьБлок_251(BkiID, CreditNumber, SendKind);
    END;

    IF (SendKind == 6)
      RETVAL = СформироватьБлок_417(BkiID, CreditNumber, SendKind);
    END;

    RETURN RETVAL;
END;



////////////////////////////////////////////////////////////////////////////////
//
// Функция вызывается из Сишника, при индивидуальной передаче информации
// Параметры:
//    TrFileID     - ID Транспортного файла
//    BkiID        - ID БКИ
//    CreditNumber - ID Договора
//    PartyID      - ID Заемщика
//    SendKind     - Вид передачи (1 - Изменения КИ,
//                                 2 - Полная    КИ,
//                                 3 - Запрос на удаление КИ)
//    Path         - Путь
//    FileName     - Имя файла
//
MACRO СформироватьТранспортныйФайл(TrFileID: integer, BkiID: Integer, CreditNumber: integer, SK: integer, Path: string, FileName: string)

//   VAR ЭЦП    = RsCryptoAPI();
VAR RSDcmd, Flag = "", ID = 0;

   Path = TRIM(Path) + "\\" + TRIM(FileName);

   ltr_file.rec.TFID = TrFileID;
   IF (NOT ltr_file.getEQ())
      LoansError("Не найден транспортный файл №"+TrFileID);
      RETURN FALSE;
   END;

   // Найдем БКИ
   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №"+BkiID);
      RETURN FALSE;
   END;
   
   FillCrd(CreditNumber);

   // TFS. SCR 190724
   IF (ReportDate < date(01,07,2014))
      ID = CRSDCommand("SELECT MAX(T_ID) FROM DLCONSDEV_DBT WHERE T_CREDITNUMBER_REF = ? AND T_CHANGEDATE <= ?",
                       "p1", CreditNumber,
                       "p2", {CURDATE},
                      V_INTEGER);
      
      IF (ID > 0)
         // Флаг согласия на передачу КИ
         FLAG = CRSDCommand("SELECT T_FLAG FROM DLCONSDEV_DBT WHERE T_ID = ?",
                            "p1", ID,
                           V_STRING);
      
         IF ((Flag != "X") AND (lbki.rec.Confirm != "X") AND
            ((SK == REQUEST_CHNG) OR (SK == REQUEST_FULL)))
            LoansError("Передавать КИ нельзя, так как нет согласия заемщика");
            RETURN FALSE;
         END;
      
         IF ((Flag == "X") AND (SK == REQUEST_DEL) AND (lbki.rec.Confirm != "X"))
            LoansError("Нельзя передавать запрос на удаление КИ в БКИ | так как заемщик согласен на передачу КИ");
            RETURN FALSE;
         END;
      
         IF ((Flag != "X") AND (SK == REQUEST_DEL))
            ID = CRSDCommand("SELECT MAX(T_ID) FROM DLDEVBKI_DBT WHERE T_CREDITNUMBER_REF = ? AND T_SENDDATE <= ?",
                             "p1", CreditNumber,
                             "p2", {CURDATE},
                            V_INTEGER);
      
            IF (ID == 0)
               LoansError("Нельзя передавать запрос на удаление КИ | так как передачи в БКИ еще не было");
               RETURN FALSE;
            END;
         END;
      ELSE
         IF ((lbki.rec.Confirm != "X") AND ((SK == REQUEST_CHNG) OR (SK == REQUEST_FULL)))
            LoansError("Передавать КИ нельзя, так как нет согласия заемщика!");
            RETURN FALSE;
         END;
      
         IF (SK == REQUEST_DEL)
            LoansError("Нельзя передавать запрос на удаление КИ \n так как передачи в БКИ еще не было");
            RETURN FALSE;
         END;
      END;
   END;

   IF (NOT ((SK >= 3) AND (SK <= 14) AND (SK != 10) ))
      IF (NOT СформироватьВиртуальнуюИсторию(BkiID, CreditNumber, SK, TrFileID))
         RETURN FALSE;
      END;
   END;

   SetDelim("");

   // Открыть главный файл
   IF (NOT Open(fMainTXT, Path))
      LoansError("Не найден файл: " + Path);
      RETURN FALSE;
   END;

   RSDcmd = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.filltransportfile (?,?,?,?); end;");

   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);

   RSDcmd.addParam("trfileid", RSDBP_IN); RSDcmd.value("trfileid") = TrFileID;
   RSDcmd.addParam("bkiid",    RSDBP_IN); RSDcmd.value("bkiid")    = BkiID;
   RSDcmd.addParam("sk",       RSDBP_IN); RSDcmd.value("sk")       = SK;
   RSDcmd.addParam("filedate", RSDBP_IN); RSDcmd.value("filedate") = {curdate};

   RSDcmd.execute();
   RSDcmd = null;

   IF ((SK >= 3) AND (SK <= 14) AND (SK != 10) )
      // Одно сообщение
      LnSqlExec("INSERT INTO DNBKI_TMP (T_ROWNUM, T_TEXT) VALUES (0, '@@@')");
   END;

   ЗаголовокФайла( FALSE , BkiID, TrFileID);
   
   // ПРОВЕРКА НА ГЕНЕРАЦИЮ ТФ УДАЛЕНИЯ
   IF ((SK >= 3) AND (SK <= 14) AND (SK != 10) )
      IF (NOT СгенерироватьЗапросНаУдаление( BkiID, CreditNumber, SK))
         Close(fMainTXT);
         RETURN FALSE;
      END;
   ELSE
      nbki.Rewind();
      WHILE (nbki.Next())
         InsertString(1, "", "A",  0, " ", NBKI.rec.text, true);
      END;
   END;
   
   InsertString(2, "===", "A",  3, "S", "", TRUE);
   Close(fMainTXT);

/*
   // Наложение ЭЦП. !!! НЕ УДАЛЯТЬ !!!
   IF (ЭЦП.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", Path))
      LoansError("Файл подписан успешно!");
   ELSE
      LoansError("Ошибка при наложении ЭЦП.|" + ЭЦП.GetErrorDescription);
   END;
*/
   RETURN TRUE;
END;


////////////////////////////////////////////////////////////////////////////////
//
// Функция вызывается из Сишника, при пакетной передаче информации
// Параметры:
//    TrFileID     - ID Транспортного файла
//    BkiID        - ID БКИ
//    PartyID      - ID Заемщика
//    SendKind     - Вид передачи (1 - Изменения КИ,
//                                 2 - Полная    КИ,
//                                 3 - Запрос на удаление КИ)
//    Path         - Путь
//    FileName     - Имя файла
//
MACRO СформироватьТранспортныйФайл_ГрупповойРежим(TrFileID: integer, BkiID: Integer, SK: integer, Path: string, FileName: string)
   VAR change = FALSE,
       count = 0;
   //   VAR ЭЦП    = RsCryptoAPI();
   VAR RSDcmd;
   VAR KD_Query    = "";
   Path = TRIM(Path) + "\\" + TRIM(FileName);

   ltr_file.rec.TFID = TrFileID;
   IF (NOT ltr_file.getEQ())
      LoansError("Не найден транспортный файл №"+TrFileID);
      RETURN FALSE;
   END;

   SetDelim("");

   // Открыть главный файл
   IF (NOT Open(fMainTXT, Path))
      LoansError("Не найден файл: " + Path);
      RETURN FALSE;
   END;
   
   // Найдем БКИ
   lbki.rec.BkiID = BkiID;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №"+BkiID);
      RETURN FALSE;
   END;
   
   RSDcmd = RsdCommand(RslDefCon, "begin ? := rso_lns_assd.filltransportfile (?,?,?,?,?); end;");

   RSDcmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);

   RSDcmd.addParam("trfileid", RSDBP_IN); RSDcmd.value("trfileid") = TrFileID;
   RSDcmd.addParam("bkiid",    RSDBP_IN); RSDcmd.value("bkiid") = BkiID;
   RSDcmd.addParam("sk",       RSDBP_IN); RSDcmd.value("sk") = SK;
   RSDcmd.addParam("filedate", RSDBP_IN); RSDcmd.value("filedate") = {curdate};
   RSDcmd.addParam("isASSD",   RSDBP_IN); RSDcmd.value("isASSD") = 1;
   RSDcmd.execute();
   //return RSDcmd.Value(0);
   RSDcmd = null;
   
   //ЗаголовокФайла(LnSelectValue("SELECT COUNT(T_ROWNUM) FROM DNBKI_TMP WHERE T_TEXT like '@@@'", V_INTEGER));
   ЗаголовокФайла( TRUE, BkiID, TrFileID);
   
   // ПРОВЕРКА НА ГЕНЕРАЦИЮ ТФ УДАЛЕНИЯ
   IF ((SK >= 3) AND (SK <= 14) AND (SK != 10) )
     KD_Query = "SELECT * FROM DOBJECT_BKI_TMP WHERE T_GROUPBKI = ? ";
     RSDcmd = RsdCommand(RslDefCon,KD_Query);
     RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = 0;

     VAR _rs = TRsbDataSet(RSDCmd,RSDVAL_CLIENT, RSDVAL_STATIC);
     WHILE (_rs AND _rs.MoveNext())
        CreditNumber = _rs.CreditNumber;
        СгенерироватьЗапросНаУдаление( BkiID, CreditNumber, SK );
     END;

   ELSE
      nbki.Rewind();
      WHILE (nbki.Next())

         InsertString(1, "", "A",  0, " ", NBKI.rec.text, true);
         change = true;
      END;
   END;

   InsertString(2, "===", "A",  3, "S", "", TRUE);
   Close(fMainTXT);
   
/*
   // Наложение ЭЦП. !!! НЕ УДАЛЯТЬ !!!
   IF (ЭЦП.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", Path))
      LoansError("Файл подписан успешно!");
   ELSE
      LoansError("Ошибка при наложении ЭЦП.|" + ЭЦП.GetErrorDescription);
   END;
*/
   RETURN TRUE;
END;
////////////////////////////////////////////////////////////////////////////////



/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////----[         ПРИНЯТЬ КВИТАНЦИЮ БЛОК       ] ----//////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   MACRO НайтиКД_по_ИДДОГ(ИДДОГ, ИДДОГОБ)
      VAR UserName:String,TempStr:String;
      VAR IsDO = FALSE,lstZero,isBREAK = FALSE, i = 1;
      VAR IsBK = FALSE,IS_ACCOUNT = FALSE,KD_Type:INTEGER = -1;
      IF (ValType(ИДДОГОБ) != V_UNDEF)
        IsDO = TRUE;
      END;
      IF (IsDO)
          UserName = substr(ИДДОГОБ,3);
      ELSE
          KD_Type = substr(ИДДОГ,2,1);
          IF (KD_Type > 4) IsBK = TRUE; END;
          UserName = substr(ИДДОГ,3);
      END;

      // Получаем последний незначащий ноль в номере ИД
      lstZero = 0;
      while(NOT isBREAK)
        IF (substr(UserName,i,1) == "0")
            lstZero = i;
        ELSE
            isBREAK = TRUE;
        END;
        i = i + 1;
      end;
      // Получили ID
      IF (((lstZero == 0) OR (StrLen(UserName) > 15 )) AND (IsBK))
          IS_ACCOUNT = TRUE;
      END;
      UserName = substr(UserName,lstZero+1);

      IF (IsDO)
          enscontr.rec.EnsContractID = UserName;
          IF (NOT enscontr.GetEQ())
              //LoansError("Не найден договор №"+UserName);
              [ #] ("Ошибка. Не найден договор №"+UserName+" из ИДДОГОБ");
              [ #] ("Проверка ДО с ИДДОГОБ:"+ИДДОГОБ+" прекращена");
              RETURN FALSE;
          END;
      ELSE
          // Найдем КД / БК
          IF (IsBK) // ЭТО БК
              IF (IS_ACCOUNT)
                  credit_c.rec.CreditNumber =  CRSDCommand("SELECT T_CREDITNUMBER  FROM DCREDIT_C_DBT WHERE T_ACCOUNTKARTA like  ?",
                                                           "ACCOUNT",UserName,V_INTEGER);
              ELSE
                  credit_c.rec.CreditNumber = UserName;
              END;
              IF (NOT credit_c.GetEQ())
                  credit_c.rec.CreditNumber = -1;
                  //LoansError("Не найден договор №"+UserName);
                  [ #] ("Ошибка. Не найден договор №"+UserName+" из ИДДОГ");
                  [ #] ("Проверка договора с ИДДОГ:"+ИДДОГ+" прекращена");
                  RETURN FALSE;
              END;
          ELSE
              credit_c.rec.CreditNumber = UserName;
              IF (NOT credit_c.GetEQ())
                  credit_c.rec.CreditNumber = -1;
                  //LoansError("Не найден договор №"+UserName);
                  [ #] ("Ошибка. Не найден договор №"+UserName+" из ИДДОГ");
                  [ #] ("Проверка договора с ИДДОГ:"+ИДДОГ+" прекращена");
                  RETURN FALSE;
              END;
          END
      END;
      RETURN TRUE;
   END;


////////////////////////////////////////////////////////////////////////////////
// Блок данных с информацией квитанции.
// Type - 0
MACRO ПринятьКвитанцию(BKI: INTEGER, Type: INTEGER, Path: STRING, FileName: STRING)
   FILE primer () TXT;
   VAR  ИДБЛОК : string = "";

   VAR  ДЛИНЗАГ,
        ИДИСТ,
        ИДПОЛУЧ,
        ЧИСЛСООБ,
        ДАТФАЙЛ: date,ДАТФАЙЛ_OLD: date,
        ИМЯФАЙЛ,ИМЯФАЙЛА_OLD,
        TOTAL_MSG_RECEIVED:INTEGER = 0;

   VAR  TF_ID   : INTEGER = 0;
   VAR  isBREAK : bool   = FALSE;
   VAR  MSG_NUM : INTEGER = 0;
   VAR  FILTER_BLOCK : STRING = "", MSG_ERROR = "";

   Path = Path + "\\" + FileName;
    
   ДАТФАЙЛ = ДАТФАЙЛ_OLD = date(0,0,0);
   ИМЯФАЙЛ = ИМЯФАЙЛА_OLD = "";

   IF   (Type == 10)
     FILTER_BLOCK = "160"; // Результаты Загрузки в АССД
   ELIF (Type == 11)
     FILTER_BLOCK = "550"; // Удаление КИ
   ELIF (Type == 13)
     FILTER_BLOCK = "501"; // Удаление контрагента
   ELIF (Type == 12)
     FILTER_BLOCK = "550"; // Запрос на удаление ДО
   ELIF (Type == 14)
     FILTER_BLOCK = "427"; // Удаление просрочки
   END;

/* DEBUG !!!!
   // Проверить ЭЦП
   IF (NOT CPCheckSignatureFile(6, Path))
      LoansError("Ошибка проверки ЭЦП файла квитанции!");
      RETURN FALSE;
   END;
*/

   IF (NOT OPEN(primer, Path))
      RETURN FALSE;
   END;

   SetDelim(":", primer);

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   // Преобразовать строку в дату
   MACRO Str2Date(value)
      VAR day  : Integer = 0,
          mon  : Integer = 0,
          year : Integer = 0;

      // Строка - это дата
      IF ((ValType(value) != V_STRING) OR (StrLen(value) != 8))
         RETURN date(0,0,0);
      END;

      day  = SubStr(value, 1, 2);
      mon  = SubStr(value, 3, 2);
      year = SubStr(value, 5, 4);

      IF ((day  < 1) OR (day  > 31) OR
          (mon  < 1) OR (mon  > 12) OR
          (year < 0) OR (year > 9999))
         RETURN date(0,0,0);
      END;

      RETURN date(day, mon, year);
   END;


   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////

   MACRO ПрочестьЗаголовокФайла()
      VAR isBREAK: bool = FALSE, msg: string = "";

      ДЛИНЗАГ = ИДИСТ = ИДПОЛУЧ = ЧИСЛСООБ = ИМЯФАЙЛ = "";
      ДАТФАЙЛ = date(0,0,0);

      WHILE ((NOT isBREAK) AND Next(primer))
         IF   (primer(0) == "ДЛИНЗАГ" ) ДЛИНЗАГ  = trim(primer(1));
         ELIF (primer(0) == "ИДИСТ"   ) ИДИСТ    = trim(primer(1));
         ELIF (primer(0) == "ИДПОЛУЧ" ) ИДПОЛУЧ  = trim(primer(1));
         ELIF (primer(0) == "ЧИСЛСООБ") ЧИСЛСООБ = trim(primer(1));
         ELIF (primer(0) == "ДАТФАЙЛ" ) ДАТФАЙЛ  = Str2Date(trim(primer(1)));
         ELIF (primer(0) == "ИМЯФАЙЛ" ) ИМЯФАЙЛ  = trim(primer(1));
         ELIF (primer(0) == "@@@"     )
            isBREAK = TRUE;
         END;
      END;

      IF (ДЛИНЗАГ  == "") msg = "'ДЛИНЗАГ'";        END;
      IF (ИДИСТ    == "") msg = msg + "'ИДИСТ'";    END;
      IF (ИДПОЛУЧ  == "") msg = msg + "'ИДПОЛУЧ'";  END;
      IF (ЧИСЛСООБ == "") msg = msg + "'ЧИСЛСООБ'"; END;
      IF (ДАТФАЙЛ  == date(0,0,0)) msg = msg + "'ДАТФАЙЛ'"; END;
      IF (ИМЯФАЙЛ  == "") msg = msg + "'ИМЯФАЙЛ'";  END;
      
      IF (StrLen(msg) > 0)
         LoansError("Ошибка. В заголовке квитанции отсутствуют обязательные поля! \n" + msg);
         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      // Найдем ТФ, по которому пришла квитанция
      TF_ID = CRSDCommand("SELECT T_TFID FROM DLTR_FILE_DBT WHERE UPPER(T_FILENAME) = UPPER(?) "+
                          " AND T_FILEDATE  = ? ",
                          "FILENAME", ИМЯФАЙЛ,
                          "FILEDATE", ДАТФАЙЛ,
                          V_INTEGER);
      IF (TF_ID == 0)
         LoansError("Ошибка. Не найден ТФ '" + ИМЯФАЙЛ + "' за дату '"+ДАТФАЙЛ+"'");
         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      RETURN TRUE;
   END;


   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   // 160 - Блок данных с информацией квитанции о результатах загрузки в АС БКИ
   //       информации транспортного файла
   MACRO ПрочестьБлок_160(ИДБЛОК: STRING)
      PRIVATE VAR ИДИСТ, ИМЯФАЙЛ, ДАТФАЙЛ, ДАТПРИЕМ, СООБЩ, ДАТИМП, РЕЗ, ЗАГР, ЗАГРПР, ОШИБ;
      VAR isBREAK = FALSE;
      VAR query;

      ИДИСТ = ИМЯФАЙЛ = ДАТФАЙЛ = ДАТПРИЕМ = СООБЩ = ДАТИМП = РЕЗ = ЗАГР = ЗАГРПР = ОШИБ = "";

      WHILE ((NOT isBREAK) AND Next(primer))
         IF (primer(0) == "ИДИСТ"   )
            ИДИСТ    = trim(primer(1));
         ELIF (primer(0) == "ИМЯФАЙЛ" )
            ИМЯФАЙЛ  = trim(primer(1));
         ELIF (primer(0) == "ДАТФАЙЛ" )
            ДАТФАЙЛ  = Str2Date(trim(primer(1)));
         ELIF (primer(0) == "ДАТПРИЕМ")
            ДАТПРИЕМ = Str2Date(trim(primer(1)));
         ELIF (primer(0) == "СООБЩ"   )
            СООБЩ    = trim(primer(1));
         ELIF (primer(0) == "ДАТИМП"  )
            ДАТИМП   = Str2Date(trim(primer(1)));
         ELIF (primer(0) == "РЕЗ"     )
            РЕЗ      = trim(primer(1));
         ELIF (primer(0) == "ЗАГР"    )
            ЗАГР      = trim(primer(1));
         ELIF (primer(0) == "ЗАГРПР"  )
            ЗАГРПР      = trim(primer(1));
         ELIF (primer(0) == "ОШИБ"    )
            ОШИБ      = trim(primer(1));
         ELIF (primer(0) == "@@@"     )
            isBREAK = TRUE;
         END;
      END;

      IF ( (ИДИСТ    == "") OR
           (ИМЯФАЙЛ  == "") OR
           (ДАТФАЙЛ  == "") OR
           (ДАТПРИЕМ == "") OR
           (СООБЩ    == "") OR
           (ДАТИМП   == "") OR
           (РЕЗ      == "") OR
           (ЗАГР     == "") OR
           (ЗАГРПР   == "") OR
           (ОШИБ     == "")
         )
         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      // ASSD2
      IF (РЕЗ == 9)
        РЕЗ = 13;
      END;
      IF (РЕЗ == 10)
        РЕЗ = 14;
      END;

      IF ((ValType(ИМЯФАЙЛ) != V_UNDEF ) AND (ValType(ДАТФАЙЛ) != V_UNDEF ) AND (ИМЯФАЙЛ != "") AND
          (ИМЯФАЙЛА_OLD != ИМЯФАЙЛ) AND (ДАТФАЙЛ != ДАТФАЙЛ_OLD))
         // Найдем ТФ
         TF_ID = CRSDCommand("SELECT T_TFID FROM DLTR_FILE_DBT WHERE UPPER(T_FILENAME) = UPPER(?) "+
                             " AND T_FILEDATE  = ? ",
                             "FILENAME",     ИМЯФАЙЛ,
                             "FILEDATE",     ДАТФАЙЛ,
                              V_INTEGER);
         // TFS 2
         IF (TF_ID == 0)
            GENERAL_FAILURE = TRUE;
            LoansError("Не найден транспортный файл '" + ИМЯФАЙЛ + "' за дату " + ДАТФАЙЛ);
            RETURN FALSE;
         END;
         ИМЯФАЙЛА_OLD = ИМЯФАЙЛ;
         ДАТФАЙЛ_OLD  = ДАТФАЙЛ;

         // TFS 1
         CRSDCommand(" UPDATE DLTR_FILE_DBT SET T_RESULTLOAD = ?, T_DATELOAD = ?, T_DATERECEPTION = ? "+
                     " WHERE T_TFID = ?",
                     "RESULTLOAD",    РЕЗ,
                     "DATELOAD",      ДАТПРИЕМ,
                     "DATERECEPTION", ДАТИМП,
                     "TF_ID",         TF_ID,
                     V_GENOBJ);
         // TFS 2
         TOTAL_MSG_RECEIVED = TOTAL_MSG_RECEIVED + 1;
      END;
      RETURN TRUE;
   END;

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   // 161 - Блок данных с информацией квитанции о результатах загрузки в АС БКИ
   //       информации транспортного файла
   MACRO ПрочестьБлок_161(ИДБЛОК: STRING)
      PRIVATE VAR НОМСООБ, КОДБЛОК, ИМЯСТР, КОДОШ, ЗНАЧОШ, ТЕКСТ, НОМДОГ, ПРИЗНАК, ИДДОГ;
      VAR isBREAK = FALSE;
      VAR CREDIT_NUM: INTEGER = 0, msg = "";
      VAR ФлагВыгрузки;

      НОМСООБ =  КОДБЛОК =  ИМЯСТР =  КОДОШ =  ЗНАЧОШ =  ТЕКСТ =  НОМДОГ =  ПРИЗНАК =  ИДДОГ = "";
      ПРИЗНАК = "0"; // По умолчанию все нормально

      WHILE ((NOT isBREAK) AND Next(primer))
         IF (primer(0) == "НОМСООБ"   )
            НОМСООБ    = trim(primer(1));
         ELIF (primer(0) == "КОДБЛОК" )
            КОДБЛОК  = trim(primer(1));
         ELIF (primer(0) == "ИМЯСТР" )
            ИМЯСТР  = trim(primer(1));
         ELIF (primer(0) == "КОДОШ")
            КОДОШ  = trim(primer(1));
         ELIF (primer(0) == "ЗНАЧОШ"   )
            ЗНАЧОШ    = trim(primer(1));
         ELIF (primer(0) == "ТЕХТ"  )
            ТЕКСТ = trim(primer(1));
         ELIF (primer(0) == "НОМДОГ"     )
            НОМДОГ    = trim(primer(1));
         ELIF (primer(0) == "ПРИЗНАК"     )
            ПРИЗНАК   = trim(primer(1));
         ELIF (primer(0) == "ИДДОГ"     )
            ИДДОГ     = trim(primer(1));
         ELIF (primer(0) == "@@@"     )
            isBREAK = TRUE;
         END;
      END;

      IF (ИДБЛОК  == "") msg = msg + "'ИДБЛОК'";  END;
      IF (НОМСООБ == "") msg = msg + "'НОМСООБ'"; END;
      IF (КОДОШ   == "") msg = msg + "'КОДОШ'";   END;
      IF (ПРИЗНАК == "") msg = msg + "'ПРИЗНАК'"; END;
      IF (ИДДОГ   == "") msg = msg + "'ИДДОГ'";   END;

      IF ( (ИДБЛОК  == "") OR
           (НОМСООБ == "") OR
           (КОДОШ   == "") OR
           (ПРИЗНАК == "") OR
           (ИДДОГ   == "")
         )
         MSG_ERROR = "В блоке 161 отсутствуют обязательные поля: \n" + msg;
         LoansError(MSG_ERROR);

         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      IF (НайтиКД_по_ИДДОГ(ИДДОГ))
          CREDIT_NUM = credit_c.rec.CreditNumber;
      ELSE
          LoansError("В файле "+ИМЯФАЙЛ+" Для Блока 161 c сообщением:"+НОМСООБ+" не удалось найти Договор!");
          RETURN FALSE;
      END;

      // ЗАПИСЫВАЕМ ВСЕ В ОТЧЕТ ОШИБОК
      IF (TF_ID == 0)
          LoansError("Для КД "+CREDIT_NUM+" не найден транспортный файл");
          RETURN;
      END;
      receipt.CLear();
      receipt.rec.TF_ID        = TF_ID;
      receipt.rec.CREDITNUMBER = CREDIT_NUM;
      receipt.rec.CodBlock     = КОДБЛОК;
      receipt.rec.Rekvizit     = ИМЯСТР;
      receipt.rec.Codeerror    = КОДОШ;
      receipt.rec.Znachosh     = ЗНАЧОШ;
      receipt.rec.text         = ТЕКСТ;
      receipt.rec.Priznak      = ПРИЗНАК;
      receipt.Insert();
      TOTAL_MSG_RECEIVED = TOTAL_MSG_RECEIVED + 1;
   END;

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   // 501 - Удаление из АССД Контрагента по договору
   //
   MACRO ПрочестьБлок_501(ИДБЛОК: STRING)
      PRIVATE VAR ИДИСТ, ИДДОГ, НОМЗАЕМ, ФАМ, ИМЯ, ДАТРОЖД, РЕЗУЛ;
      VAR isBREAK = FALSE, msg = "";

      ИДИСТ = ИДДОГ = НОМЗАЕМ = РЕЗУЛ = ФАМ = ИМЯ = ДАТРОЖД = РЕЗУЛ = "";

      WHILE ((NOT isBREAK) AND Next(primer))
         IF (primer(0) == "ИДИСТ"   )
            ИДИСТ    = trim(primer(1));
         ELIF (primer(0) == "ИДДОГ" )
            ИДДОГ  = trim(primer(1));
         ELIF (primer(0) == "НОМЗАЕМ" )
            НОМЗАЕМ  = trim(primer(1))
         ELIF (primer(0) == "ФАМ")
            ФАМ = trim(primer(1));
         ELIF (primer(0) == "ИМЯ")
            ИМЯ = trim(primer(1));
         ELIF (primer(0) == "ДАТАРОЖД")
            ДАТРОЖД = trim(primer(1));
         ELIF (primer(0) == "РЕЗУЛ")
            РЕЗУЛ = trim(primer(1));
         ELIF (primer(0) == "@@@"     )
            isBREAK = TRUE;
         END;
      END;

      IF (ИДБЛОК  == "") msg = msg + "'ИДБЛОК'";  END;
      IF (ИДИСТ   == "") msg = msg + "'ИДИСТ'";   END;
      IF (НОМЗАЕМ == "") msg = msg + "'НОМЗАЕМ'"; END;
      IF (ФАМ     == "") msg = msg + "'ФАМ'";     END;
      IF (ИМЯ     == "") msg = msg + "'ИМЯ'";     END;
      IF (ДАТРОЖД == "") msg = msg + "'ДАТРОЖД'"; END;
      IF (РЕЗУЛ   == "") msg = msg + "'РЕЗУЛ'";   END;

      IF ( (ИДБЛОК  == "") OR
           (ИДИСТ   == "") OR
           (НОМЗАЕМ == "") OR
           (ФАМ     == "") OR
           (ИМЯ     == "") OR
           (ДАТРОЖД == "") OR
           (РЕЗУЛ   == "")
         )
         MSG_ERROR = "В блоке 501 отсутствуют обязательные поля: \n" + msg;
         LoansError(MSG_ERROR);

         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      IF (НайтиКД_по_ИДДОГ(ИДДОГ))
         CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ? "
                     " WHERE T_TFID_REF = ? AND T_CREDITNUMBER_REF = ? ",
                     "RESULT",     "+",
                     "TFID_REF", TF_ID,
                     "CRDNUM",   credit_c.rec.CreditNumber,
                      V_GENOBJ);
      ELSE
         CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ? "
                     " WHERE T_TFID_REF = ? ",
                     "RESULT",     "+",
                     "TFID_REF", TF_ID,
                      V_GENOBJ);
      END;

      // Найдем ТФ
      CRSDCommand(" UPDATE DLTR_FILE_DBT SET T_RESULTDELETE = ?, T_RESULTLOAD = ? "+
                  " WHERE T_TFID = ?",
                 "RESULTDELETE", РЕЗУЛ,
                 "RESULTLOAD",   0,
                 "TF_ID",    TF_ID,
                 V_GENOBJ);
      TOTAL_MSG_RECEIVED = TOTAL_MSG_RECEIVED + 1;
   END;

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////


   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   // 427 - Удаление из АССД информации о просрочке
   //
   MACRO ПрочестьБлок_427(ИДБЛОК: STRING)
      PRIVATE VAR ИДИСТ, ИДДОГ, НОМОПЕР, РЕЗУЛ, CREDIT_NUM = 0;
      VAR isBREAK = FALSE, msg = "";

      ИДИСТ = ИДДОГ = НОМОПЕР = РЕЗУЛ = "";

      WHILE ((NOT isBREAK) AND Next(primer))
         IF (primer(0) == "ИДИСТ"   )
            ИДИСТ    = trim(primer(1));

         ELIF (primer(0) == "ИДДОГ" )
            ИДДОГ  = trim(primer(1));

         ELIF (primer(0) == "НОМОПЕР" )
            НОМОПЕР  = trim(primer(1))

         ELIF (primer(0) == "РЕЗУЛ")
            РЕЗУЛ = trim(primer(1));

         ELIF (primer(0) == "@@@"     )
            isBREAK = TRUE;
         END;
      END;

      IF (ИДБЛОК  == "") msg =       "'ИДБЛОК'";  END;
      IF (ИДИСТ   == "") msg = msg + "'ИДИСТ'";   END;
      IF (ИДДОГ   == "") msg = msg + "'ИДДОГ'";   END;
      IF (НОМОПЕР == "") msg = msg + "'НОМОПЕР'"; END;
      IF (РЕЗУЛ   == "") msg = msg + "'РЕЗУЛ'";   END;

      IF ( (ИДБЛОК  == "") OR
           (ИДИСТ   == "") OR
           (ИДДОГ   == "") OR
           (НОМОПЕР == "") OR
           (РЕЗУЛ   == "")
         )
         MSG_ERROR = "В блоке 427 отсутствуют обязательные поля: \n" + msg;
         LoansError(MSG_ERROR);
         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      IF (НайтиКД_по_ИДДОГ(ИДДОГ))
         CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ? "
                     " WHERE T_TFID_REF = ? AND T_CREDITNUMBER_REF = ? ",
                     "RESULT",     "+",
                     "TFID_REF", TF_ID,
                     "CRDNUM",   credit_c.rec.CreditNumber,
                      V_GENOBJ);
      ELSE
         CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ? "
                     " WHERE T_TFID_REF = ? ",
                     "RESULT",     "+",
                     "TFID_REF", TF_ID,
                      V_GENOBJ);
      END;

      // Найдем ТФ
      CRSDCommand("UPDATE DLTR_FILE_DBT SET T_RESULTDELETE = ?, T_RESULTLOAD = ? "+
                  " WHERE T_TFID = ? ",
                  "RESULTDELETE", РЕЗУЛ,
                  "RESULTLOAD",   0,
                  "TFID",         TF_ID,
                  V_GENOBJ);
      TOTAL_MSG_RECEIVED = TOTAL_MSG_RECEIVED + 1;
   END;

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   // 550 - Квитанция об удалении КИ из АССД
   //
   MACRO ПрочестьБлок_550(ИДБЛОК: STRING)
      PRIVATE VAR ИДИСТ, ИДДОГ, ИДДОГОБ, РЕЗУЛ;
      VAR isBREAK = FALSE, msg = "";

      ИДДОГ = ИДДОГОБ = РЕЗУЛ = ИДИСТ = "";

      WHILE ((NOT isBREAK) AND Next(primer))
         IF (primer(0) == "ИДИСТ"   )
            ИДИСТ    = trim(primer(1));

         ELIF (primer(0) == "ИДДОГ" )
            ИДДОГ  = trim(primer(1));

         ELIF (primer(0) == "ИДДОГОБ" )
            ИДДОГОБ  = trim(primer(1))

         ELIF (primer(0) == "РЕЗУЛ")
            РЕЗУЛ = trim(primer(1));

         ELIF (primer(0) == "@@@"     )
            isBREAK = TRUE;
         END;
      END;

      IF (ИДБЛОК  == "") msg =       "'ИДБЛОК'";  END;
      IF (ИДИСТ   == "") msg = msg + "'ИДИСТ'";   END;
      IF (РЕЗУЛ   == "") msg = msg + "'РЕЗУЛ'";   END;

      IF ( (ИДБЛОК == "") OR
           (ИДИСТ  == "") OR
           (РЕЗУЛ  == "")
         )
         MSG_ERROR = "В блоке 550 отсутствуют обязательные поля: \n" + msg;
         LoansError(MSG_ERROR);

         GENERAL_FAILURE = TRUE;
         RETURN FALSE;
      END;

      IF ((Strlen(ИДДОГ) > 0) AND НайтиКД_по_ИДДОГ(ИДДОГ))
         CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ? "
                     " WHERE T_TFID_REF = ? AND T_CREDITNUMBER_REF = ? ",
                     "RESULT",     "+",
                     "TFID_REF", TF_ID,
                     "CRDNUM",   credit_c.rec.CreditNumber,
                      V_GENOBJ);
      ELSE
         CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ? "
                     " WHERE T_TFID_REF = ? ",
                     "RESULT",     "+",
                     "TFID_REF", TF_ID,
                      V_GENOBJ);
      END;

      // Найдем ТФ
      CRSDCommand(" UPDATE DLTR_FILE_DBT SET T_RESULTDELETE = ?, T_RESULTLOAD = ? " +
                  " WHERE T_TFID = ?",
                 "RESULTDELETE", РЕЗУЛ,
                 "RESULTLOAD",   0,
                 "TFID",     TF_ID,
                 V_GENOBJ);
      TOTAL_MSG_RECEIVED = TOTAL_MSG_RECEIVED + 1;
   END;

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   GENERAL_FAILURE = FALSE;
   IF (ПрочестьЗаголовокФайла())
      WHILE ((NOT isBREAK) AND Next(primer))
         IF   (primer(0) == "ИДБЛОК")
            ИДБЛОК   = primer(1);
            IF ((FILTER_BLOCK == ИДБЛОК) OR   // Отфильтруем только те блоки, которые указали в форме
                ((FILTER_BLOCK == "160") AND (ИДБЛОК == "161"))
               )
               IF   (ИДБЛОК == "160")
                  ПрочестьБлок_160(ИДБЛОК);
               ELIF (ИДБЛОК == "161")
                  ПрочестьБлок_161(ИДБЛОК);
               ELIF (ИДБЛОК == "427")
                  ПрочестьБлок_427(ИДБЛОК);
               ELIF (ИДБЛОК == "501")
                  ПрочестьБлок_501(ИДБЛОК);
               ELIF  (ИДБЛОК == "550")
                  ПрочестьБлок_550();
               ELSE
                  GENERAL_FAILURE  = TRUE; // НЕИЗВЕСТНЫЙ БЛОК
               END;
            END;

            IF ( GENERAL_FAILURE )
               IF (Strlen(MSG_ERROR) == 0)
                  LoansError("Ошибка. В квитанции отсутствуют обязательные поля!");
               END;
               isBREAK = TRUE;
            END;
         ELIF (primer(0) == "@@@")
             MSG_NUM = MSG_NUM + 1;
             GENERAL_FAILURE = FALSE;
         ELIF (primer(0) == "===")
             isBREAK = TRUE;
         END;
      END;
   END;

   IF ((TF_ID > 0) AND (Type == 10))
      // Устанавливаем признак ошибочной выгрузки по результатам загрузки протокола ошибок
      CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ?"
                    " WHERE T_TFID_REF = ?  "
                    " AND T_CREDITNUMBER_REF IN ( "
                    " SELECT DISTINCT T_CREDITNUMBER FROM DRECEIPT_DBT WHERE "
                    " T_TF_ID = ? AND T_PRIZNAK != ? ) ",
                 "RESULT",       "-",
                 "TFID_REF1",     TF_ID,
                 "TFID_REF2",     TF_ID,
                 "PRIZNAK",       "0",
                 V_GENOBJ);

      // Устанавливаем Удачной выгрузки по результатам загрузки протокола ошибок (если критических ошибок по КД небыло)
      CRSDCommand(" UPDATE DLDEVBKI_DBT SET T_RESULT = ?"
                    " WHERE T_TFID_REF = ?  "
                    " AND T_CREDITNUMBER_REF NOT IN ( "
                    " SELECT DISTINCT T_CREDITNUMBER FROM DRECEIPT_DBT WHERE "
                    " T_TF_ID = ? AND T_PRIZNAK != ? ) ",
                 "RESULT",       "+",
                 "TFID_REF1",     TF_ID,
                 "TFID_REF2",     TF_ID,
                 "PRIZNAK",       "0",
                 V_GENOBJ);
   END;

   IF ( TOTAL_MSG_RECEIVED > 0 )
      LoansError("Квитанция для "+ИМЯФАЙЛ+" загружена!");
   ELIF((TOTAL_MSG_RECEIVED == 0) AND (NOT GENERAL_FAILURE) AND (Strlen(MSG_ERROR) == 0))
      LoansError("В квитанции '"+ИМЯФАЙЛ+"' не обнаружено ни одного блока " + FILTER_BLOCK);
   END;

   IF (NOT CLOSE(primer))
      RETURN FALSE;
   END;
END;


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////----[  КОНЕЦ БЛОКА  :  ПРИНЯТЬ_КВИТАНЦИЮ       ] ----/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////----[  БЛОК  :  ПротоколОшибокТФ       ] ----//////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MACRO PrintHead(TrFileID)
    ltr_file.rec.TFID = TrFileID;
    IF (NOT ltr_file.getEQ())
       LoansError("Не найден транспортный файл №"+TrFileID);
       RETURN FALSE;
    END;

    ActSheet.Cells (2, 3).Value = ltr_file.rec.FileDate;
    ActSheet.Cells (1, 2).Value = ltr_file.rec.FileName;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// ПротоколОшибокТФ (АССД2)
MACRO PrintSingleReportString(SimpleString:@TArray)
END;

MACRO PrintReportBody(BKIID: INTEGER,TF_ID: INTEGER)
    VAR RS;
    VAR I,ArrSize : INTEGER;

    RS = CRSDCommand("SELECT lobj.T_SHORTNAME ,crd.T_USCREDITNUMBER,prt.T_NAME, "
                     "DECODE(rec.T_PRIZNAK,1,?,0,?,rec.T_PRIZNAK) Error, "
                     " rec.T_CODBLOCK,rec.T_REKVIZIT,rec.T_CODEERROR,rec.T_ZNACHOSH,rec.T_TEXT,ldev.T_CORRECT, "
                     "(SELECT NVL(buh.T_NAME,' NOT FOUND') FROM  DPARTY_DBT buh,DPERSON_DBT pers,DCRD_OP_DBT op "
                     " WHERE pers.T_OPER = op.T_OPER "
                     " AND buh.T_PARTYID = pers.T_PARTYID  "
                     " AND op.T_CREDITNUMBER_REF = crd.T_CREDITNUMBER "
                     " AND op.T_OBJECTID_REF = crd.T_CREDITNUMBER "
                     " AND op.T_OBJECTTYPEID_REF = crd.T_CRD_KIND "
                     " AND op.T_SYSTEMOPERATIONID = ? "
                     " AND op.T_ISDELETED = ? "
                     " AND op.T_STAGEID_REF = ? "
                     " ) Bughalter,"
                    " (SELECT d1.T_NAME FROM DDP_DEP_DBT d1 WHERE d1.T_CODE = crd.T_FNCASH) AS FILIAL, "
                    " (SELECT d1.T_NAME FROM DDP_DEP_DBT d1 WHERE d1.T_CODE = crd.T_TERRITORIALSTRUCT) AS PTS "
                     " FROM DRECEIPT_DBT rec,DLDEVBKI_DBT ldev, DCREDIT_C_DBT crd, DLOBJECT_DBT lobj, "
                     " DPARTY_DBT prt "
                     " WHERE "
                     " ldev.T_TFID_REF = ? AND "
                     " ldev.T_BKIID_REF = ? AND "
                     " rec.T_CREDITNUMBER = ldev.T_CREDITNUMBER_REF AND "
                     " rec.T_TF_ID = ldev.T_TFID_REF AND "
                     " crd.T_CREDITNUMBER = ldev.T_CREDITNUMBER_REF AND "
                     " prt.T_PARTYID = crd.T_CLIENTID_REF AND "
                     " crd.T_CRD_KIND = lobj.T_OBJECTID ",
                     "Error", "Ошибка" ,
                     "Warning","Предупреждение",
                     "SYSTEMOPERATIONID",CS_NEWCRD,
                     "ISDELETED",0,
                     "STAGEID",99,

                     "TF_ID",TF_ID,
                     "BKI_ID",BKIID,
                     V_GENOBJ);
   PrintHead(TF_ID);
   Row = 5;
   WHILE(RS.MoveNext())
      // Печать в Exсel
      ActSheet.Rows(Int(Row + 1)).Insert;
      I = 0;
      ArrSize = 13;
      WHILE (I < ArrSize)
          // ROW,COLOMN
          ActSheet.Cells (Row, 1 + I).Value = RS.Value(I);
          I = I + 1;
      END;
      Row = Row + 1;
     //
   END;
END;


MACRO ПротоколОшибокТФ(BKIID: INTEGER,TF_ID: INTEGER)
    VAR ErrorsCount : INTEGER;
    IF (NOT NewExcelWorkbook (false, "BKI_RCPT_RPT.xls"))
        Exit (0, "Не открыт файл отчёта BKI_RCPT_RPT.xls");
    END;

    ErrorsCount = CRSDCommand("SELECT COUNT(T_CREDITNUMBER) FROM "
                     " DRECEIPT_DBT WHERE  T_TF_ID =  ?",
                     "TF_ID",TF_ID,V_INTEGER);
    IF (ErrorsCount == 0)
      MsgBox("По данному ТФ протокола ошибок не найдено!");
      Return 1;
    END;

    ExcelApplication.SheetsInNewWorkbook = 3;
    ExcelApplication.ActiveWorkbook.Sheets("Протокол ошибок ТФ").Select;
    ActSheet = ExcelApplication.ActiveSheet; /*Активная страница*/

    PrintReportBody(BKIID, TF_ID);

    ExcelApplication.Visible = true;

    RETURN 1;
END;




/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////----[  КОНЕЦ БЛОКА  :  ПротоколОшибокТФ       ] ----///////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


RECORD lbki_rec    ("lbki.dbt");
// Шаблон имени из параметров БКИ
// ФОРМАТ: SSSSSSS
MACRO СформироватьИмяФайла(SendKind: INTEGER)

   VAR ИмяФайла : string = SubStr(lbki_rec.TemplateName, 1, 7),
       Номер    : string = "000";

   // Порядковый номер ТФ
   // ФОРМАТ: N.NN
   StrSet(Номер, 4 - strlen(string(lbki_rec.Number)), string(lbki_rec.Number));

   ИмяФайла = ИмяФайла + SubStr(Номер, 1, 1) + "." + SubStr(Номер, 2);

   IF((SendKind == REQUEST_DEL) OR 
      (SendKind == 4) OR
      (SendKind == 5) OR
      (SendKind == 6))
      ИмяФайла = ИмяФайла + "Z";
   ELSE
      ИмяФайла = ИмяФайла + "T";
   END;

   RETURN ИмяФайла;
END;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// NEW BKI CHECK (IN ASSD )
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////-=[  ПроверкаТФ   ]=-//////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

CLASS CommonData
  var ТипЛица, // PTLEGF_INST = 1(Организации) , PTLEGF_PERSN = 2 (Физ Лица), 0 - ВСЕ
      ID_Клиента,
      ID_ОсновногоДокумета,
      ДатаДоговора:date,
      ДатаРаждения:date, // Дата рождения должна заполняться когда идет чтение ТФ (иначе нам НЕОТКУДА взять эту дату в ТФ)
      ДАТФАЙЛ:date,
      ДАТПОГОД:date,
      ДАТОБЯЗ:date,
      Резидент : Bool = TRUE,
      ChekData_For_BKI : BOOL = FALSE, // Флаг: Проверяем ли мы ТФ или Данные (Для ограничения проверок )
      IsПБЮЛ:BOOL = FALSE,          // Флаг, что это ФИЗИК-ПРЕДПРЕНИМАТЕЛЬ
      ИДИСТ,
      ИДДОГ,
      ТИП_КД:INTEGER = LO_CREDIT,
      КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН:BOOL = TRUE, // Блок 100 ИДДОГ
      Контроль_в_Блоке_415:BOOL = FALSE,
      Контроль_в_Блоке_407:BOOL = FALSE,
      Контроль_в_Блоке_408:BOOL = FALSE,
      Контроль_в_Блоке_409:BOOL = FALSE,
      ПЕРИОДПР,
      Страна = "Err";
END;

CLASS CheckItem
  var
  Abr_Name  :string  = "", // Имя аббривиатуры БКИ (Из файла БКИ)
  Chk_Name  :string  = "", // Имя фигурирущее в ошибке (Из таблицы)
  Err_Name  :string  = "", // Имя фигурирущее в ошибке (Зависит от того, проверяем мы ТФ или ДАННЫЕ)
  BLOCK_Name:string  = "", // Имя для отладки
  Res_Str   :string  = "", // Результат для отчета
  Format    :string  = "", // Формат значения
  Value,                   // Проверяемые данные
  ExtParms,                // Дополнительные параметры: Гражданство/Паспорт Гр РФ
  ChekFunArr;

  MACRO AddErrString(ErrStr:String)
      IF (StrLen(Res_Str)>1)
        Res_Str = Res_Str + "\n "+ErrStr;
      ELSE
        Res_Str = ErrStr;
      END;
  END;

END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MACRO ПроверкаФормата(Item:@CheckItem,Data:@CommonData)
   VAR Size:INTEGER;
   VAR TstDate:Date,TstINT:INTEGER,TstSTR:String,TstMoney:Money;

   PRIVATE MACRO CheckDate(value)
     VAR day  : Integer = 0,
         mon  : Integer = 0,
         year : Integer = 0;

     // Строка - это дата
     IF ((ValType(value) != V_STRING) OR (StrLen(value) != 8))
        RETURN FALSE;
     END;

     day  = SubStr(value, 1, 2);
     mon  = SubStr(value, 3, 2);
     year = SubStr(value, 5, 4);

     IF ((day  < 1) OR (day  > 31) OR
         (mon  < 1) OR (mon  > 12) OR
         (year < 0) OR (year > 9999))
        RETURN FALSE;
     END;

     RETURN TRUE;
   END;

   // Усливия необходимости проверки
   IF ((Item.Format == "-") OR (Item.Format == ""))
       RETURN;
   END;
   IF ((VALTYPE(Item.Value) == V_UNDEF) OR (Item.Value == ""))
       RETURN;
   END;

   // Числовой Формат
   IF (Index(Item.Format,"N") != 0)
       RETURN; // В Имеющейся релизации ТЗ / ПРОЭКТА ( 21 ) данные проверки отсутствуют
       IF (Index(Item.Forma,"14.2") != 0)
       // Денежный Формат
           TstMoney = Item.Value;
           TstSTR = TstMoney;
           IF (TstSTR != Item.Value)
               Item.AddErrString("Поле \""+Item.Err_Name+"\" не известный формат данных");
           END;
       ELSE
       // Числовой Формат
           Size = SubStr(Item.Format,2);
           IF (StrLen(Item.Value) > Size)
           END;
       END;
       RETURN;
   ELIF(Index(Item.Format,"A") != 0)
   // Строковый Формат
       Size = SubStr(Item.Format,2);
       IF (StrLen(Item.Value) > Size)
           Item.AddErrString("Значение поля \""+Item.Err_Name+"\" превышает длину поля");
       END;
       IF ((Item.Abr_Name == "КОДСУБ") AND (StrLen(Item.Value) < 4))
           Item.AddErrString("Длина значения поля КОДСУБ  меньше 4 символов");
       END;
       RETURN;
   ELIF(Index(Item.Format,"D") != 0)
   // Формат Даты
       IF (not CheckDate(Item.Value))
           // 156671 
           IF (((Item.Abr_Name == "ДПОД") OR (Item.Abr_Name == "ДПП"))
                 AND Item.Value == "")
              RETURN ;      
            END;

           Item.AddErrString("Значение поля \""+Item.Err_Name+"\" не соответствует шаблону");
       END;
       RETURN;
   END;
   Item.AddErrString("Поле \""+Item.Err_Name+"\" не известный формат данных");
END;


MACRO ПроверкаАдреса(Addr : String, Резидент:BOOL )
   // Разбираем адерс
   VAR CountryCode:STRING,RegionCode:STRING,DistrictName:STRING,TownName:STRING,VillageName;
   VAR TempStr = Addr;
   
   CountryCode = RegionCode = DistrictName = TownName = VillageName = "";
   
   IF (VALTYPE(Addr) == V_UNDEF)
      RETURN FALSE;
   END;
   
   
   CountryCode  = SubStr(TempStr,1,Index(TempStr,"|"));
   TempStr      = SubStr(TempStr,Index(TempStr,"|")+1); 
   TempStr      = SubStr(TempStr,Index(TempStr,"|")+1); // пропускаем 2й сегмент
   RegionCode   = SubStr(TempStr,1,Index(TempStr,"|"));
   TempStr      = SubStr(TempStr,Index(TempStr,"|")+1);
   DistrictName = SubStr(TempStr,1,Index(TempStr,"|"));
   TempStr      = SubStr(TempStr,Index(TempStr,"|")+1);
   TownName     = SubStr(TempStr,1,Index(TempStr,"|"));
   TempStr      = SubStr(TempStr,Index(TempStr,"|")+1);
   VillageName  = SubStr(TempStr,1,Index(TempStr,"|"));
   
   CountryCode  = TRIM(StrSubst(CountryCode, "|"," "));
   RegionCode   = TRIM(StrSubst(RegionCode,  "|"," "));
   DistrictName = TRIM(StrSubst(DistrictName,"|"," "));
   TownName     = TRIM(StrSubst(TownName,    "|"," "));
   VillageName  = TRIM(StrSubst(VillageName, "|"," "));
   
   IF (StrLen(VillageName) > StrLen(TownName))
      TownName = VillageName;
   END;
       
   IF (Резидент)
      IF ((StrLen(CountryCode) != 3 ) OR (StrLen(RegionCode) < 1 ) OR (StrLen(TownName) < 1) )
         RETURN FALSE;
      END;
   ELSE
      IF ((StrLen(CountryCode) != 3 ) OR ((StrLen(DistrictName) < 1 ) AND (StrLen(TownName) < 1)) )
         RETURN FALSE;
      END;
   END;
   
   RETURN TRUE;
END;

MACRO Обязательность(Item:@CheckItem, Data:@CommonData)
   // УСЛОВНЫЕ ПРОВЕРКИ
   IF ((Item.Abr_Name == "НОМДОГ") AND (Item.BLOCK_Name == "Блок 100(150)") AND (Data.ТИП_КД == LO_KARTA))
      // НОМДОГ - ПРОВЕРЯЕМ ТОЛЬКО ДЛЯ КД - для БК не обязательно 151081 
      IF (VALTYPE(Item.Value) == V_UNDEF)
          Item.Value = "";
      END;
      RETURN TRUE;
   END;
   
   IF ((Item.Abr_Name == "АДРЕС") AND (Item.BLOCK_Name == "Блок 401")) // 150538 
      IF (not ПроверкаАдреса(Item.Value,Data.Резидент))
        Item.AddErrString("В поле \""+Item.Err_Name+"\" отсутствуют обязательные поля");
      END;
   END;
   
   IF ((Item.Abr_Name == "ПРРЕЗИД") AND (Item.BLOCK_Name == "Блок 201") AND (Data.ТипЛица != PTLEGF_PBUL))
      // ПРРЕЗИД - ПРОВЕРЯЕМ ТОЛЬКО ДЛЯ ЮРИКОВ
      IF (VALTYPE(Item.Value) == V_UNDEF)
          Item.Value = "";
      END;
      RETURN TRUE;
   END;

   IF (((Item.Abr_Name == "ТЕЛФАКТ") OR (Item.Abr_Name == "ТЕЛРЕГ")) AND (Data.ТипЛица != PTLEGF_INST))
      // ТЕЛФАКТ и ТЕЛРЕГ - ПРОВЕРЯЕМ ТОЛЬКО ДЛЯ ЮРИКОВ ( ДЛЯ ОСТАЛЬНЫХ - НЕ ПРОВЕРЯЕМ )
      IF (VALTYPE(Item.Value) == V_UNDEF)
          Item.Value = "";
      END;
      RETURN TRUE;
   END;

   IF ((Item.Abr_Name == "ТЕЛЕФОН") AND (Data.Контроль_в_Блоке_415))
      // если есть ТЕЛФАКТ или ТЕЛРЕГ - то обязательность не проверяем
      IF (VALTYPE(Item.Value) == V_UNDEF)
          Item.Value = "";
      END;
      RETURN TRUE;
   END;

   /// БАЗОВАЯ ПРОВЕКА
   IF (VALTYPE(Item.Value) != V_UNDEF)
      //IF ((VALTYPE(Item.Value) == V_DATE) AND (Item.Value > date(1,1,2))) RETURN TRUE; END;
      IF (Item.Value != "") RETURN TRUE; END;
   END;

   /*
       Резолючция ФИЛИПА ДЛЯ АССД: Если поля установленно как Проверка обязательности заполнения, НО
       Поле отсутсвует в ТФ. ТО это не является ошибкой! Т.К. Проверка Обязательности заполнения было при формировании ТФ
       *Вопрос возник из за загловка в котором некоторые поля могут отсутсвовать. Хотя ....
   */
   // 148644
   //IF (VALTYPE(Item.Value) == V_UNDEF)
   //   RETURN FALSE;
   //END;


   Item.AddErrString("Поле \""+Item.Err_Name+"\" не заполненено");
   RETURN FALSE;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////


MACRO Пробелы(Item:@CheckItem,Data:@CommonData )
   Var ErrStr = "",Len,i,pos,STR:String;
   IF (VALTYPE(Item.Value) != V_STRING) RETURN; END;

   ErrStr = "В поле \""+Item.Err_Name+"\" содержится лишний пробел";

   IF (Item.BLOCK_Name == "Блок 202")
      IF ( ((Item.Abr_Name =="КОДПОДР") OR (Item.Abr_Name =="НАИМОРГ")) AND (Data.Страна != 643) )
          // Если страна НЕ РОССИЯ, то не проверяем!
          RETURN;
      END;
   END;

   // 3 Между словами не допустимо более одного пробела"
   IF (Index(Item.Value,"  ") != 0) Item.AddErrString(ErrStr); END;

   // 1 Не начинается и не заканчивается пробелом
   Len = StrLen(Item.Value);
   STR = Item.Value;
   IF ((Index(STR," ") == 1) OR (Index(SubStr(Str,len)," ") == 1)) Item.AddErrString(ErrStr); RETURN; END;

   // ПО 149784 релизуем следущий алгоритм: находим подстроку в кавычках и проверяем чтобы:
   // после открывающей и перед закрывающей не было пробелов.
   IF (Index(Str,"`") > 0)
      pos = Index(Item.Value,"`");
      STR = SubStr(Item.Value,pos+1);
      len = Index(Str,"`");
      IF ((Index(STR," ") == 1) OR (Index(SubStr(Str,len)," ") == 1)) Item.AddErrString(ErrStr); END;
   ELIF (Index(Str,"'") > 0)
      pos = Index(Item.Value,"'");
      STR = SubStr(Item.Value,pos+1);
      len = Index(Str,"'");
      IF ((Index(STR," ") == 1) OR (Index(SubStr(Str,len)," ") == 1)) Item.AddErrString(ErrStr); END;
   ELIF (Index(Str,"\"") > 0)
      pos = Index(Item.Value,"\"");
      STR = SubStr(Item.Value,pos+1);
      len = Index(Str,"\"");
      IF ((Index(STR," ") == 1) OR (Index(SubStr(Str,len)," ") == 1)) Item.AddErrString(ErrStr); END;
   END;

  /* не верно: по 149784
  // 2 Нет Пробелов перед и после символов "кавычек всех типов"
  i = 1;
  while(i <= Len)
      pos = Index(SubStr(Str,i)," ");
      IF (pos == 0) RETURN; END;
      IF ((SubStr(Str,pos-1,1) == "`") OR (SubStr(Str,pos+1,1) == "`") OR
          (SubStr(Str,pos-1,1) == "'") OR (SubStr(Str,pos+1,1) == "'") OR
          (SubStr(Str,pos-1,1) == "\"") OR (SubStr(Str,pos+1,1) == "\"")
          )
          Item.AddErrString(ErrStr); RETURN;
      END;
      Str = SubStr(Str,i);
      Len = StrLen(Str);
      i = pos+1;
  END;
  */
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////


MACRO Символы(Item:@CheckItem,Data:@CommonData )
   var Str:String,Chr,Len,i,Rus,Lat,Ser,InvChar;
   var СМЕШЕНИЕ_ОШИБКА,НОМЕР_ТЕЛЕФОНА_ОШИБКА,СИМВОЛЫ_ОШИБКА,ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА,ДЕФИЗ_ОШИБКА,ДОП_ПРОВЕРКА_ДИФИЗОВ;
   var InvCharString = "";
   Str = Item.Value;
   Len = StrLen(Str);
   Rus = Lat = InvChar = false;
   i = 1;
  
   // Значения для "БАЗОВОЙ" проверки
   СМЕШЕНИЕ_ОШИБКА = СИМВОЛЫ_ОШИБКА = ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = ДЕФИЗ_ОШИБКА = TRUE;
   НОМЕР_ТЕЛЕФОНА_ОШИБКА  = TRUE;
   ДОП_ПРОВЕРКА_ДИФИЗОВ = FALSE;
  
   // Далее в зависимости от блока или абревиатуры некоторые проверки выключаются
   IF (Item.BLOCK_Name == "Блок 201")
      НОМЕР_ТЕЛЕФОНА_ОШИБКА = FALSE;
      ДЕФИЗ_ОШИБКА = FALSE;
      ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = FALSE;
      ДОП_ПРОВЕРКА_ДИФИЗОВ = TRUE;

      IF (Item.Abr_Name =="ОТЧ")
          НОМЕР_ТЕЛЕФОНА_ОШИБКА = TRUE;
          ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = TRUE;
      END;
   END;

   IF (Item.BLOCK_Name == "Блок 202")
      НОМЕР_ТЕЛЕФОНА_ОШИБКА = FALSE;
      ДЕФИЗ_ОШИБКА = FALSE; //  дефис - не ошибка только для паспорта СССР. 156802 - неошибка!
      ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = FALSE;
   END;

   IF (Item.BLOCK_Name == "Блок 204")
      НОМЕР_ТЕЛЕФОНА_ОШИБКА = FALSE;
      ДЕФИЗ_ОШИБКА = FALSE;
      ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = FALSE;
      СИМВОЛЫ_ОШИБКА = FALSE;
   END;

   IF (Item.BLOCK_Name == "Блок 301")
      НОМЕР_ТЕЛЕФОНА_ОШИБКА = FALSE;
      ДЕФИЗ_ОШИБКА = FALSE;
      ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = FALSE;
      СИМВОЛЫ_ОШИБКА = FALSE;
   END;

   IF ((Item.BLOCK_Name == "Блок 401") OR (Item.BLOCK_Name == "Блок 203"))
      НОМЕР_ТЕЛЕФОНА_ОШИБКА = FALSE;
      ДЕФИЗ_ОШИБКА = FALSE;
      ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = FALSE;
   END;

   IF (Item.BLOCK_Name == "Блок 415")
      НОМЕР_ТЕЛЕФОНА_ОШИБКА = FALSE;
      ДЕФИЗ_ОШИБКА = TRUE;
      ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА = TRUE;
      //IF (Item.Abr_Name =="ТЕЛЕФОН") - у нас в этом блоке только он и проверяется
      //END;
   END;

   IF ((Item.BLOCK_Name == "Блок 302") AND (Item.Abr_Name == "ИНН"))
      Str = StrSubst(Str,"0"," ");
      Str = Trim(Str);
      IF (StrLen(Str) == 0)
          Item.AddErrString("В поле \""+Item.Err_Name+"\" содержит некорректное значние ИНН");
      ELSE
        RETURN;
      END;
   END;

  // END Зависимости от блоков

  // Далее идут исключительно проверки

   //IF ((Item.Abr_Name == "АДРЕС") AND (not Data.ChekData_For_BKI)) 138191 - реджект
   IF ( Item.Abr_Name == "АДРЕС" )
      Str = StrSubst(Str,"|",";");
      Str = StrSubst(Str,StrFor(1)," ");
   END;

   WHILE(i <= Len)
      Chr = SubStr(Str,i,1);
      IF   (((Chr >="A") AND (Chr <="Z")) OR ((Chr >="a") AND (Chr <="z"))) Lat = TRUE;
      ELIF (((Chr >="А") AND (Chr <="Я")) OR ((Chr >="а") AND (Chr <="я"))) Rus = TRUE;
      ELIF ((Chr =="-") AND ( НОМЕР_ТЕЛЕФОНА_ОШИБКА OR ДЕФИЗ_ОШИБКА) )
          InvChar = TRUE;
          InvCharString = InvCharString+" содержится недопустимый символ \""+Chr+"\" в позиции "+i+" ,"
      ELIF ((Chr >= "0") AND (Chr <= "9") AND ( НОМЕР_ТЕЛЕФОНА_ОШИБКА ) )
          InvChar = TRUE;
          InvCharString = InvCharString+" содержится недопустимый символ \""+Chr+"\" в позиции "+i+" ,"
      ELIF (((Chr ==",") OR  (Chr ==".") OR
             (Chr ==";") OR  (Chr ==":"))
             AND (ЗНАКИ_ПРЕПИНАНИЯ_ОШИБКА)
            )
          InvChar = TRUE;
          InvCharString = InvCharString+" содержится недопустимый символ \""+Chr+"\" в позиции "+i+" ,"
      ELIF  ((
            (Chr =="~") OR  (Chr =="!") OR
            (Chr =="\"")OR  (Chr =="@") OR
            (Chr =="№") OR  (Chr =="#") OR
            (Chr =="$") OR  (Chr =="%") OR
            (Chr =="^") OR  (Chr =="&") OR
            (Chr =="*") OR  (Chr =="{") OR
            (Chr =="}") OR  (Chr =="?") OR
            (Chr =="+") OR  (Chr =="=") OR (Chr =="_") OR
            (Chr =="\\") OR  (Chr =="//") OR
            (Chr =="<") OR  (Chr ==">"))AND ( СИМВОЛЫ_ОШИБКА )
            )
          InvChar = TRUE;
          InvCharString = InvCharString+" содержится недопустимый символ \""+Chr+"\" в позиции "+i+" ,"
      END;
      i = i + 1;
  END;


  // Смешение кодировок
  IF ( Lat AND Rus AND СМЕШЕНИЕ_ОШИБКА)
      Item.AddErrString("В поле \""+Item.Err_Name+"\" содержатся одновременно русские и латинские буквы");
  END;

  IF ( InvChar )
      IF (STRLEN(InvCharString) > 1)
        InvCharString = SUBSTR(InvCharString,1,STRLEN(InvCharString)-2); // Убираем последнюю ","
        Item.AddErrString("В поле \""+Item.Err_Name+"\" "+InvCharString);
      ELSE
        Item.AddErrString("Поле \""+Item.Err_Name+"\" включает недопустимые символы");
      END;
  END;

  /*
  IF ( (Not Lat) AND (Not Rus) AND (Item.Abr_Name !="СЕРДОК") AND (Item.Abr_Name != "АДРЕС")) // АДРЕС - 138191
      Item.AddErrString("Поле \""+Item.Err_Name+"\" включает недопустимые символы");
  END;
  */

  /*Не должна начинатся с "-", не должна заканчиватся на "-", и не должна состоять из "-" */
  IF (ДОП_ПРОВЕРКА_ДИФИЗОВ)
      IF ((Index(Str,"-") == 1) OR (Index(Str," -") >= 1) OR
          (Index(Str," - ") >= 1) OR ((Index(Str,"-") == Len) AND (Len > 0)))
          Item.AddErrString("Поле \""+Item.Err_Name+"\" неверно располжен символ \"-\" ");
      END;
  END;



  // Проверка кодировки по Гражданству (если не заполнено, то неважно, так как в случае смешения все равно будет ошибка)
  IF ((Item.ExtParms != "") AND (VALTYPE(Item.ExtParms) != V_UNDEF))
      IF ((Data.Страна == 643) AND Lat ) Item.AddErrString("Поле \""+Item.Err_Name+"\" должно заполняться символами русского алфавита"); END;
      IF ((Data.Страна != 643) AND Rus ) Item.AddErrString("Поле \""+Item.Err_Name+"\" должно заполняться символами латинского алфавита"); END;

      // Проверка Серии ГР РФ
      IF ( Item.ExtParms == 21)
          Ser = SubStr(Trim(Str),1,2);
          IF ((Ser == "00") OR  (Ser == "02") OR
              (Ser == "06") OR  (Ser == "09") OR
              (Ser == "13") OR  (Ser == "16") OR
              (Ser == "21") OR  (Ser == "23") OR
              (Ser == "31") OR  (Ser == "35") OR
              (Ser == "39") )
          Item.AddErrString("Поле <СЕРДОК> включает недопустимые значения"); END;
      END;
  END;

END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////


PRIVATE MACRO CheckFormat(Format:String, Num:String)
VAR FLen = StrLen(Format),
    i = 1,
    ZeroCount = 0, // 132125
    FSymb = "",
    Value = "",
    FStr = Num;

   // Подсчет количества необязательных символов
   i = Index(Format,"0");
   IF ( i != 0 )
     ZeroCount = 1;
   END;

   IF ((StrLen(Num) != FLen ) AND (StrLen(Num)+ZeroCount != FLen))
      RETURN FALSE;
   END;

   IF ((StrLen(Num)+ZeroCount == FLen) AND (ZeroCount > 0) AND (i == 1))
      Format = SubStr(Format,2,FLen-1);
      FLen = StrLen(Format);
   END;

   FSymb = "";
   i = 1;

   WHILE ( FLen >= i )
   // Длее Разбор Букв Шаблона
     Value = SubStr(Num,i,1);
     FSymb = SubStr(Format,i,1);
     IF ((FSymb != "0") OR ((FSymb == "0") AND (StrLen(Num) == FLen)))
         IF    ( FSymb == "R" )
           IF ( (Value != "X") AND (Value !="V") AND (Value !="I") ) RETURN FALSE; END;
         ELIF  ( FSymb == "Б" )
           IF ( (Value < "А") OR (Value >"я") ) RETURN FALSE; END;
         ELIF  ( (FSymb == "9") OR (FSymb == "0") ) // 0 символ не обязательный НО это цифра!
          IF ( (Value < "0") OR (Value >"9") ) RETURN FALSE; END;
         ELIF  ( FSymb != Value ) // "-"  и дргие символы которых не понимаем будем сравнивать КАК ЕСТЬ
            RETURN FALSE;
         END;
     END;
     i = i + 1;
   END;
   FStr = "";
   RETURN TRUE;
END;


MACRO Шаблон(Item:@CheckItem)
   var Str:String,Ser,Ser2,Num,ID:STRING,Stat = TRUE,Len;
   VAR Code:Integer;
   VAR Num1:Integer,Num2:Integer;
   Str = Item.Value;
   ID  = Item.ExtParms;
   Len = StrLen(Str);

   // ОБЩЕЕ ДЛЯ ВСЕХ ШАБЛОНОВ
   IF (Item.Abr_Name =="ВАЛЮТА")
          Code = -1;
          Code = CRSDCommand("SELECT COUNT(T_FIID) FROM DFININSTR_DBT WHERE T_FI_CODE = ?",
                             "FI_CODE", Str,V_INTEGER);
          IF (Code <= 0)
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN;
   END;

   // ИНДИВИДУАЛЬНЫЕ ПРОВЕРКИ В ЗАВИСИМОСТИ ОТ БЛОКА / ТИПА

    IF ((Item.Abr_Name == "ВИДДОГ") AND (Item.BLOCK_Name == "Блок 182"))
        Code = Item.Value;
        IF ((Code < 1) OR (Code > 15))
            Item.AddErrString("Ошибка. "+Item.Err_Name+" не соответсвует значению из справочника");
        END;
    END;


   IF (Item.BLOCK_Name == "Блок 202")

       IF (Item.Abr_Name =="СТРАНА")
          Code = Item.Value;
          IF ((Code < 100) OR (Len != 3) )
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
       END;

       // Проверяем количество проблелов между символами
       IF (Index(Trim(Str),"      ") != 0) Stat = FALSE; END; // 6 - если есть пробелов ошибка

       IF (ID == "Err")
          Item.AddErrString("Поле \""+Item.Err_Name+"\" документа, удостоверяющего личность, нельзя проверить! Не задан ВИДДОК");
       END;

       // Находим серию
       IF (Item.Abr_Name =="СЕРДОК")
           Ser = SubStr(Str,1,Index(Str," ")-1); // -1 - подстрока БЕЗ пробела
           IF (Trim(Ser) == "")
              Ser = Trim(Str);
           END;
           // Добавочную серию
           IF (ID == "21")
                Num = SubStr(Str,Index(Str," ")+1);
                Ser2 = SubStr(Num,1,Index(Str," "));
                IF (Ser2 == "")
                  Ser2 = Num;
                END;
           END;
       END;
       // Номер
       IF (Item.Abr_Name =="НОМДОК")
           Num = SubStr(Str,Index(Str," "));
           IF (Trim(Num) == "")
            Num = Trim(Str);
           END;
       END;

       IF (Item.Abr_Name =="СЕРДОК")
           IF   ( (ID == "2") AND ( CheckFormat("99",Ser) != TRUE ) ) Stat = FALSE; //Загранпаспорт гражданина СССР
           ELIF ( (ID == "4") AND ( CheckFormat("ББ",Ser) != TRUE ) ) Stat = FALSE; //Удостоверение офицера
           ELIF ( (ID == "6") AND ( CheckFormat("ББ",Ser) != TRUE ) ) Stat = FALSE; //Паспорт министерства военно-морского флота
           ELIF ( (ID == "7") AND ( CheckFormat("ББ",Ser) != TRUE ) ) Stat = FALSE; //Военный билет
           ELIF ( (ID == "9") AND ( CheckFormat("99",Ser) != TRUE ) ) Stat = FALSE; //Дипломатический паспорт гражданина РФ
           ELIF ( (ID == "21") AND ((CheckFormat("99",Ser) != TRUE ) OR ( CheckFormat("99",Ser2) != TRUE ) )) Stat = FALSE; //Паспорт гражданина РФ
           ELIF ( (ID == "22") AND ( CheckFormat("99",Ser) != TRUE ) ) Stat = FALSE; //Загранпаспорт гражданина РФ
           ELIF ( (ID == "26") AND ( CheckFormat("ББ",Ser) != TRUE ) ) Stat = FALSE; //Паспорт моряка
           ELIF ( (ID == "27") AND ( CheckFormat("ББ",Ser) != TRUE ) ) Stat = FALSE; END; //Если Физик, Удостоверение офицера в запасе
           IF (not Stat)
             Item.AddErrString("Поле \""+Item.Err_Name+"\" документа, удостоверяющего личность, не соответствует шаблону");
           END;
       END;

       IF (Item.Abr_Name =="НОМДОК")
           // НОМДОК
           IF   ( (ID == "2") AND ( CheckFormat("0999999",Num) != TRUE ) ) Stat = FALSE; //Загранпаспорт гражданина СССР
           ELIF ( (ID == "4") AND ( CheckFormat("0999999",Num) != TRUE ) ) Stat = FALSE; //Удостоверение офицера
           ELIF ( (ID == "6") AND ( CheckFormat("999999",Num)  != TRUE ) ) Stat = FALSE; //Паспорт министерства военно-морского флота
           ELIF ( (ID == "7") AND ( CheckFormat("0999999",Num) != TRUE ) ) Stat = FALSE; //Военный билет
           ELIF ( (ID == "9") AND ( CheckFormat("9999999",Num) != TRUE ) ) Stat = FALSE; //Дипломатический паспорт гражданина РФ
           ELIF ( (ID == "21") AND ( CheckFormat("999999",Num)  != TRUE ) ) Stat = FALSE; //Паспорт гражданина РФ
           ELIF ( (ID == "22") AND ( CheckFormat("9999999",Num) != TRUE ) ) Stat = FALSE; //Загранпаспорт гражданина РФ
           ELIF ( (ID == "26") AND ( CheckFormat("0999999",Num) != TRUE ) ) Stat = FALSE; //Паспорт моряка
           ELIF ( (ID == "27") AND ( CheckFormat("0999999",Num) != TRUE ) ) Stat = FALSE; END; //Если Физик, Удостоверение офицера в запасе
           IF (not Stat)
             Item.AddErrString("Поле \""+Item.Err_Name+"\" документа, удостоверяющего личность, не соответсвует шаблону");
           END;
       END;
   END; // БЛОК 202

   IF (Item.BLOCK_Name == "Блок 401")  // АДРЕС - пока опустили ( филип обещал уточнить что подразумевается в той проверке)
      IF (Item.Abr_Name =="ТИПЗАЕМ")
          Code = Item.Value;
          IF ((Code != 1) AND (Code != 2) AND (Code != 5))
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
      END;

      IF (Item.Abr_Name =="ТИПАДР") //150538 
          Code = Item.Value;
          IF ((Code < 1) OR (Code > 4))
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
      END;

   END;


   IF (Item.BLOCK_Name == "Блок 402")  // ПЕРИОДОД ПЕРИОДПР
       IF (Item.Abr_Name =="ПЕРИОДОД")
          Code = Item.Value;
          IF ((Code < 1) OR (Code > 8))
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
       END;
       IF (Item.Abr_Name =="ПЕРИОДПР")
          Code = Item.Value;
          IF ((Code < 1) OR (Code > 9))
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
       END;
   END;

   IF (Item.BLOCK_Name == "Блок 404")
      IF (Item.Abr_Name =="КОДЗАКР")
          Code = Item.Value;
          IF ((Code != 1) AND (Code != 2))
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
      END;
   END;
   
   IF (Item.BLOCK_Name == "Блок 415")
      IF ((Item.Abr_Name =="ЕМАЙЛ") AND (Len > 2))
          Num1 = Index(Str,"@");
          Num2 = Index(Str,".");
          IF ((Num1 == 1) OR 
              (Num1 == Len) OR // Стоит последним
              (Num1 == 0) OR  // Нет сабаки 156816 
              (Num2 == 0) OR  // Нет точки  156816 
              (Num1+1 >= Num2 ) // Точка стоит ближе одного символа к сабаке или стоит перед собакой
             )
              Item.AddErrString("Поле \""+Item.Err_Name+"\" не соответсвует шаблону");
          END;
          RETURN; // Все проверили
      END;
   END;
   

END;



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////


private macro ПроверитьКодСубъектаИНН( LegalForm,  IsNotResident, pCode : string)
  var Code;
  var sep;
  var i, contr1, contr2, contr3;

  array ves, ves1, ves2;

  ves(0) =  2;   ves1(0) =  7;   ves2(0) =  3;
  ves(1) =  4;   ves1(1) =  2;   ves2(1) =  7;
  ves(2) = 10;   ves1(2) =  4;   ves2(2) =  2;
  ves(3) =  3;   ves1(3) = 10;   ves2(3) =  4;
  ves(4) =  5;   ves1(4) =  3;   ves2(4) = 10;
  ves(5) =  9;   ves1(5) =  5;   ves2(5) =  3;
  ves(6) =  4;   ves1(6) =  9;   ves2(6) =  5;
  ves(7) =  6;   ves1(7) =  4;   ves2(7) =  9;
  ves(8) =  8;   ves1(8) =  6;   ves2(8) =  4;
                 ves1(9) =  8;   ves2(9) =  6;
                                 ves2(10) = 8;

  if( strlen( pCode ) == 0 )
    return 0;
  end;

  sep = index( pCode, "/" );
  if( sep > 0 )
    Code = substr( pCode, 1, sep - 1 );
  else
    Code = pCode;
  end;

  if( LegalForm == 1 )
    if( IsNotResident == false )
      if( strlen( Code ) != 10 )
        /*Ошибка: ИНН юридического лица - нерезидента должен иметь длину 10 символов*/
        return 21315;
      end;
    else
      if( strlen( Code ) == 5 )
        return 0;
      else
        if( strlen( Code ) != 10 )
          /*Ошибка: ИНН юридического лица - нерезидента должен иметь длину 10 символов, КИО - 5 символов*/
          return 21314;
        end;
      end;
    end;

    i = 0;
    contr1 = 0;
    while( i < 9 )
      contr1 = contr1 + ves( i ) * int( substr( Code, i + 1, 1 ));
      i = i + 1;
    end;
    contr2 = floor( double( contr1 / 11 )) * 11;
    contr3 = mod( contr1 - contr2, 10 );
    if( int( substr( Code, i + 1, 1 )) != contr3 )
      /*Ошибка: ИНН задан неверно*/
      return 21316;
    end;
  elif ( LegalForm == 2 )
    if( strlen( Code ) != 12 )
      /*Ошибка: ИНН физического лица должен иметь длину 12 символов*/
      return 21317;
    end;

    i = 0;
    contr1 = 0;
    while( i < 10 )
      contr1 = contr1 + ves1( i ) * int( substr( Code, i + 1, 1 ));
      i = i + 1;
    end;
    contr2 = floor( double( contr1 / 11 )) * 11;
    contr3 = mod( contr1 - contr2, 10 );
    if( int( substr( Code, i + 1, 1 )) != contr3 )
      /*Ошибка: ИНН задан неверно*/
      return 21316;
    end;

    i = 0;
    contr1 = 0;
    while( i < 11 )
      contr1 = contr1 + ves2( i ) * int( substr( Code, i + 1, 1 ));
      i = i + 1;
    end;
    contr2 = floor( double( contr1 / 11 )) * 11;
    contr3 = mod( contr1 - contr2, 10 );
    if( int( substr( Code, i + 1, 1 )) != contr3 )
      /*Ошибка: ИНН задан неверно*/
      return 21316;
    end;
  end;

  return 0;
end;

private macro ПроверитьКодСубъектаОГРН( LegalForm , pCode : string)
  var Code;
  var contr1, contr2, contr3, contr4;

  if( strlen( pCode ) == 0 )
    return 0;
  end;

  Code = pCode;

  if( LegalForm == 1 )
    contr4 = 11;
    if( strlen( Code ) != 13 )
      /*Ошибка: ОГРН юридического лица должен иметь длину 13 символов*/
      return 21318;
    end;
  elif( LegalForm == 2 )
    contr4 = 13;
    if( strlen( Code ) != 15 )
      /*Ошибка: ОГРН физического лица должен иметь длину 15 символов*/
      return 21319;
    end;
  else
      return 0; // Ошибка определения Типа лица // 149378
  end;

  contr1 = double( substr( Code, 1, strlen( Code ) - 1 ));
  contr2 = floor( double( substr( Code, 1, strlen( Code ) - 1 )) / contr4 ) * contr4;
  contr3 = mod( contr1 - contr2, 10 );

  if( int( substr( Code, strlen( Code ), 1 )) != contr3 )
    /*Ошибка: ОГРН задан неверно*/
    return 21323;
  end;

  return 0;
end;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MACRO Коды(Item:@CheckItem, Data:@CommonData )
    var ТипЛица,Резидент;
    var RegnStr,Count:INTEGER;
    ТипЛица = Data.ТипЛица;
    Резидент = not Data.Резидент;

    IF (Item.BLOCK_Name == "Блок 302")
        IF (Item.Abr_Name == "ИНН")
            RegnStr =  SubStr(Item.Value,1,2);
            Count = -1;
            Count = CRSDCommand("SELECT COUNT(t_coderegion) FROM dptregion_dbt WHERE t_coderegion = ?",
                                "REGN_CODE", RegnStr,V_INTEGER);
            IF (Count < 1)
                Item.AddErrString("Код \""+Item.Err_Name+"\" имеет неверное значение");
            END;
        END;
    END;

    IF ((Item.Abr_Name == "ИНН") OR (Item.Abr_Name == "ИННМР"))
        IF ( ПроверитьКодСубъектаИНН(ТипЛица, Резидент, Item.Value) )
            Item.AddErrString("Код \""+Item.Err_Name+"\" имеет неверное значение");
        END;
    END;
    IF (Item.Abr_Name == "ОГРН")
        IF ( ПроверитьКодСубъектаОГРН(ТипЛица, Item.Value) )
            Item.AddErrString("Код \""+Item.Err_Name+"\" имеет неверное значение");
        END;
    END;
END;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* Функция возвращает возраст клиента на дату (количество полных лет),
   либо 0, если Дата меньше даты рождения */
private macro ВозрастExt(CodClient, Дата, ДатаРаждения:@Date)

   var  d1:integer = 0, d2:integer = 0,
        m1:integer = 0, m2:integer = 0,
        y1:integer = 0, y2:integer = 0;
   var  age : integer = 0;

   if (not depclnt.GetRecord(CodClient))
       return 0;
   end;

   ДатаРаждения = depclnt.Born;
   DateSplit(depclnt.Born, d1, m1, y1);
   DateSplit(Дата, d2, m2, y2);

   age = y2 - y1;
   if (m2 < m1)
      age = age - 1;
   elif ((m2 == m1) and (d2 < d1))
      age = age - 1;
   end;

   if (age < 0)
      return 0;
   end;

   return age;

end;

/* Функция возвращает возраст клиента на дату (количество полных лет),
   либо 0, если Дата меньше даты рождения */
private macro ВозрастНаДату(ДатаРождения, ТекущаяДата)

   var  d1:integer = 0, d2:integer = 0,
        m1:integer = 0, m2:integer = 0,
        y1:integer = 0, y2:integer = 0;
   var  age : integer = 0;

   DateSplit(ДатаРождения, d1, m1, y1);
   DateSplit(ТекущаяДата, d2, m2, y2);

   age = y2 - y1;
   if (m2 < m1)
      age = age - 1;
   elif ((m2 == m1) and (d2 < d1))
      age = age - 1;
   end;

   if (age < 0)
      return 0;
   end;

   return age;

end;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Преобразовать строку в дату
private  MACRO Str2Date(value)
      VAR day  : Integer = 0,
          mon  : Integer = 0,
          year : Integer = 0;

      // Строка - это дата
      IF ((ValType(value) != V_STRING) OR (StrLen(value) != 8))
         RETURN date(0,0,0);
      END;

      day  = SubStr(value, 1, 2);
      mon  = SubStr(value, 3, 2);
      year = SubStr(value, 5, 4);

      IF ((day  < 1) OR (day  > 31) OR
          (mon  < 1) OR (mon  > 12) OR
          (year < 0) OR (year > 9999))
         RETURN date(0,0,0);
      END;

      IF ((day  == 1) AND (mon  == 1) AND (year == 1) )
         RETURN date(0,0,0);
      END;

      RETURN date(day, mon, year);
   END;

MACRO Логические(Item:@CheckItem, Data:@CommonData )
    // Необходимые доп параметры: Тип ЛИЦА, ВОЗРАСТ,
    // ДатаРождения, Дата выдачи паспорта
    // ID основного документа
    //
    var ТипЛица,ТекущийВозраст,ДатаРождения,ДатаВыдачиПаспорта,ID_ОсновногоДокумета,ДатаДоговора;
    Var ПроверкаДАТЫ,Code:INTEGER;
    ТипЛица = Data.ТипЛица;
    ДатаДоговора = Data.ДатаДоговора;
    IF ((VALTYPE(ДатаДоговора) == V_UNDEF))
        ДатаДоговора = date(0,0,0);
    END;
    
    IF (Item.BLOCK_Name == "Блок 402")
      IF (Item.Abr_Name == "ДАТОБЯЗ")
         IF (VALTYPE(Item.Value) != V_UNDEF)
            Data.ДАТОБЯЗ = Str2Date (Item.Value);
         END;
      END;
    END;

    IF (Item.BLOCK_Name == "Блок 408")
        IF (not Data.Контроль_в_Блоке_408)
            Item.AddErrString("Некорректное заполнение блока 408");
            Data.Контроль_в_Блоке_408 = TRUE;
        END;
        IF (Item.Abr_Name != "ДАТДАН") RETURN;  END;    
    END;

    IF (Item.BLOCK_Name == "Блок 409")
        IF (not Data.Контроль_в_Блоке_409)
            Item.AddErrString("Некорректное заполнение блока 409");
            Data.Контроль_в_Блоке_409 = TRUE;
        END;
        RETURN;            
    END;


    ПроверкаДАТЫ =  SubStr(Item.Abr_Name,1,3);
    IF (ПроверкаДАТЫ == "ДАТ")
    // Скорее всего это проверка ДАТЫ
        IF ((Item.Abr_Name == "ДАТДОГ")   OR // 100
            (Item.Abr_Name == "ДАТВВОД")  OR //301 401 204 302 182
            (Item.Abr_Name == "ДАТОБЯЗ")  OR // 402
            (Item.Abr_Name == "ДАТНАЧОД") OR // 402
            (Item.Abr_Name == "ДАТНАЧПР") OR // 402
            (Item.Abr_Name == "ДАТБАЛ")   OR // 407
            (Item.Abr_Name == "ДАТКЛД")   OR // 407
            (Item.Abr_Name == "ДАТПОСЛ")  OR // 404
            (Item.Abr_Name == "ДАТЗАКР")  OR // 404
            (Item.Abr_Name == "ДАТСУД")   OR // 406
            (Item.Abr_Name == "ДАТРЕШ")   OR // 406
            (Item.Abr_Name == "ДАТОФЦ")   OR // 406
            (Item.Abr_Name == "ДАТБАНК")  OR // 304
            (Item.Abr_Name == "ДАТДАН")   OR // 408
            (Item.Abr_Name == "ДАТДОГ")      // 181 182
           )
            IF (VALTYPE(Item.Value) == V_STRING)
                ПроверкаДАТЫ = Str2Date(Item.Value);
            ELSE // Значит ПОЛЮБОМУ ДАТА! 3го не дано! :)
                IF (VALTYPE(Item.Value) == V_UNDEF)
                    ПроверкаДАТЫ = date(0,0,0);
                ELSE
                ПроверкаДАТЫ = Item.Value;
            END;

            END;
            IF (Data.ДАТФАЙЛ < ПроверкаДАТЫ)
                Item.AddErrString("Ошибка. Дата "+Item.Err_Name+" больше, чем дата выгрузки файла");
            END;
        END;
    END;


    IF ((Item.Abr_Name == "ДАТОБЯЗ") OR (Item.Abr_Name == "ДАТНАЧОД") OR (Item.Abr_Name == "ДАТНАЧПР"))
        ПроверкаДАТЫ = Item.Value;
        IF (VALTYPE(ПроверкаДАТЫ) == V_STRING)
            ПроверкаДАТЫ = Str2Date(ПроверкаДАТЫ);
        END;

        IF (ПроверкаДАТЫ > Data.ДАТПОГОД )
            Item.AddErrString("Ошибка. Дата "+Item.Err_Name+" больше, чем дата ДАТПОГОД");
        END;
    END;

    IF (Item.Abr_Name == "ИДИСТ")
        IF (Item.Value != Data.ИДИСТ )
            Item.AddErrString("Ошибка. "+Item.Err_Name+" не совпадает с значением из заголовка файла");
        END;
    END;

    IF ((Item.Abr_Name == "ИДДОГ") AND (Item.BLOCK_Name == "Блок 100(150)") AND (not Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН))
        Item.AddErrString("Ошибка. "+Item.Err_Name+" при первой передаче в АССД отсутствуют необходимые блоки");
    END;

    IF ((Item.BLOCK_Name == "Блок 407") AND (not Data.Контроль_в_Блоке_407))
        Item.AddErrString("Ошибка. "+Item.Err_Name+" не пройден контроль наличия необходимых полей в блоке");
    END;

    IF ((Item.Abr_Name == "ВИДДОК") AND (Item.BLOCK_Name == "Блок 203"))
        Code = Item.Value;
        // возможно понадобится Code = Code - 100; для блока 202
        IF ( ( ((Code < 1) OR (Code > 27)) AND (Code != 91)) OR ((Code > 14) AND (Code < 21)) )
            Item.AddErrString("Ошибка. "+Item.Err_Name+" не соответствует справочнику кодов документов ф/л");
        END;
    END;

    IF (Item.Abr_Name == "ЧИСЛОПР")
        Code = Data.ПЕРИОДПР;
        IF ( ((Code == 1) OR (Code == 5) OR (Code == 6) OR (Code == 7) OR (Code == 8)) AND (Item.Value != "0"))
            Item.AddErrString("Ошибка. "+Item.Err_Name+" не согласуется со значением ПЕРИОДПР");
        END;
    END;

    IF ((Item.Abr_Name == "ВИДДОК") AND (Item.BLOCK_Name == "Блок 203"))
        Code = Item.Value;
        IF ((Code < 1) OR (Code > 14))
            Item.AddErrString("Ошибка. "+Item.Err_Name+" не соответствует значению из справочника");
        END;
    END;

    IF (Item.Abr_Name == "ДАТРОЖД")
        ДатаРождения = Item.Value;
        IF (VALTYPE(ДатаРождения) == V_STRING)
            ДатаРождения = Str2Date(ДатаРождения);
        END;
        ТекущийВозраст = ВозрастНаДату(ДатаРождения, ДатаДоговора);

        // Проверка даты рождения
        IF  (ТекущийВозраст > 80)
            //Item.AddErrString("Дата рождения "+ДатаРождения+" раньше, чем "+ДатаДоговора+" - 80 лет"); 149085
            Item.AddErrString("Ошибка \""+Item.Err_Name+"\" Возраст заемщика должен быть не менее 14 лет и не больше 80 лет");
        END;
        IF  (ТекущийВозраст < 14)
            //Item.AddErrString("Дата рождения "+ДатаРождения+" позже,  чем "+ДатаДоговора+" - 14 лет");
            Item.AddErrString("Ошибка \""+Item.Err_Name+"\" Возраст заемщика должен быть не менее 14 лет и не больше 80 лет");
        END;
    END;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
private CLASS DataCheckerReporter
    VAR Items = TArray(0);
    VAR CheckingBlocks = TArray(0);
    VAR TFBlocks = TArray(0);
    VAR Count :integer = 0;
    Var Data : CommonData;
    Var IsCheckTF:BOOL = FALSE;
    Var Invalid_TR_File_DATA:BOOL = FALSE;
    Var GlobalErr:String = "";
    Var LST_READ_ABBR:String = "";    //ASSD
    VAR TOTAL_MSG_COUNT:integer = 0;  //ASSD
    VAR ID_CRD,SendsCount;

    VAR GetEnErrorInMassge:BOOL = FALSE;
    VAR curBlockName:String = "";
    VAR ReadByBlockABBR = "";
    VAR ReadByBlockVAL  = "";
    VAR ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД:BOOL = FALSE;
    
    // 151081 
    VAR Check_408Bloks = TArray(0);
    VAR НайданоПовторениеДатДан408:BOOL = FALSE;
    
    MACRO Check_408_Datdan( DatDan:String )
        var i = 0;
        IF (НайданоПовторениеДатДан408)
            RETURN FALSE;
        END;

        WHILE(i < Check_408Bloks.size )
            IF ( Check_408Bloks(i) ==  DatDan)
                НайданоПовторениеДатДан408 = TRUE;
                RETURN FALSE;
            END;
            i = i + 1;
        END;

        RETURN TRUE;
    END;
    
    MACRO ADD_408_Datdan( DatDan:String )
        IF (Check_408_Datdan(DatDan))
            Check_408Bloks(Check_408Bloks.size) = DatDan;
        END;
    END;
    
    MACRO Clear_408_Datdan( DatDan:String )
        Check_408Bloks.size = 0;
        НайданоПовторениеДатДан408 = FALSE;
    END;
    /// end 151081


    MACRO CheckBKI_TF();
      IsCheckTF = true;
    END;

    MACRO CheckData_ForBKI();
      IsCheckTF = false;
    END;



    MACRO RegisterCheckParam(BKI_ABR,TablName,Формат,Обязательность,Пробелы,Символы,Шаблон,Коды,Логические,BLOCK_Name);
        // Для АССД проверяется все!
        //IF ( IsCheckTF AND (BKI_ABR == "-") ) RETURN; END;      // Убриаем все параметры которые не проверяются в ТФ
        //IF ( not IsCheckTF AND (TablName == "-") ) RETURN; END; // Убриаем все параметры которые не проверяются в Данных

        Items(Count) = GenObject("CheckItem");
        Items(Count).Abr_Name = BKI_ABR;
        Items(Count).Chk_Name = TablName;
        Items(Count).BLOCK_Name = BLOCK_Name;
        Items(Count).Format = Формат;

        Items(Count).ChekFunArr = TArray(0);
        Items(Count).ChekFunArr[0] = Обязательность;
        Items(Count).ChekFunArr[1] = Пробелы;
        Items(Count).ChekFunArr[2] = Символы;
        Items(Count).ChekFunArr[3] = Шаблон;
        Items(Count).ChekFunArr[4] = Коды;
        Items(Count).ChekFunArr[5] = Логические;

        IF (IsCheckTF)
          Items(Count).Err_Name = Items(Count).Abr_Name;
        ELSE
          Items(Count).Err_Name = Items(Count).Chk_Name;
        END;

        Count = Count + 1;
    END;

    MACRO Clear(TotalClear)
      var i = 0, Undef;
        WHILE(i < Count)
            IF ((Items(i).BLOCK_Name != "Заголовок") OR (TotalClear))
                Items(i).Res_Str = "";
                Items(i).Value = Undef;
            END;
            i = i + 1;
        END;
        GetEnErrorInMassge = FALSE;
        ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД = FALSE;
        TFBlocks.size = 0;
        CheckingBlocks.size = 0;
        Data.ТипЛица = Undef;
        Data.ID_Клиента = Undef;
        Data.ID_ОсновногоДокумета = Undef;
        Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН = TRUE;
        
        Data.ТИП_КД = LO_CREDIT;
        Data.ИДДОГ = "";

        Data.Контроль_в_Блоке_415 = FALSE;
        Data.Контроль_в_Блоке_407 = FALSE;
        Data.Контроль_в_Блоке_408 = FALSE;
        Data.Контроль_в_Блоке_409 = FALSE;
        Clear_408_Datdan();

    END;

    MACRO ClearBlock(BlockName)
      var i = 0, Undef;
        // МультиБлоки Которые необходимо каждый раз очищать: ( остальные типа 100(150),180 - очищать не стоит ;)
        IF (
            (BlockName != "Блок 181") AND
            (BlockName != "Блок 201") AND
            (BlockName != "Блок 204") AND
            (BlockName != "Блок 304") AND
            (BlockName != "Блок 401") AND
            (BlockName != "Блок 407") AND
            (BlockName != "Блок 408") AND
            (BlockName != "Блок 415")
           )
            return;
        END;

        Data.Контроль_в_Блоке_415 = FALSE;
        Data.Контроль_в_Блоке_407 = FALSE;
        Data.Контроль_в_Блоке_408 = FALSE;

        WHILE(i < Count)
            IF ((Items(i).BLOCK_Name == BlockName))
                Items(i).Res_Str = "";
                Items(i).Value = Undef;
            END;
            i = i + 1;
        END;
    END;

    MACRO IsBlockInFile(BlockName:String)
      var i = 0;
      WHILE(i < TFBlocks.size)
            IF (BlockName == TFBlocks(i))
                RETURN TRUE;
            END;
            i = i + 1;
      END;
      RETURN FALSE;
    END;


    // Добавить Блок в проверочные если он фигурировал в ТФ БКИ
    MACRO AddBlockIfNeed(BlockName:String,БлокОбязателен:BOOL)
      RETURN TRUE;
      /*
      IF (БлокОбязателен)
          CheckingBlocks[CheckingBlocks.size] = BlockName;
      END;

      IF (IsBlockInFile(BlockName))
          CheckingBlocks[CheckingBlocks.size] = BlockName;
      END;
     */
    END;



    MACRO AddData(BKI_ABR,TablName,Value,ExtParms,BlockID:STRING);
      var i = 0,Str:String,Undef;
        IF (BKI_ABR == "ИДБЛОК")
            IF ((Value == "100") OR (Value == "150"))
                IF (Value == "150") // 148644
                    ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД = TRUE;
                END;
                Str = "Блок "+"100(150)";
            ELSE
                Str = "Блок "+Value;
            END;
            IF (NOT IsBlockInFile(Str))
                TFBlocks[TFBlocks.size] = Str;
            END;
            curBlockName = Str;
        END;
        //IF (BlockID == "НеДляПроверки")
        //    CheckingBlocks[CheckingBlocks.size] = "НеДляПроверки";
        //END;

        // АвтоЗаполнение
        IF ((BlockID != "НеДляПроверки") AND
            ((BKI_ABR ==  "ИДДОГ") OR (BKI_ABR == "НОМЗАЕМ") OR (BKI_ABR == "ДАТДОГ"))
           )
           AddData(BKI_ABR,TablName,Value,ExtParms,"НеДляПроверки");
        END;
        
        IF ((BlockID == "Блок 408") AND (BKI_ABR == "ДАТДАН"))
            ADD_408_Datdan(Value);
        END;

        WHILE(i < Count)
            IF (Items(i).Abr_Name == BKI_ABR)
                IF ((VALTYPE(BlockID) == V_STRING) AND (BlockID == Items(i).BLOCK_Name)) // на случай если блок ТОЧНО указан
                    Items(i).Value = Value;
                    Items(i).ExtParms = ExtParms;
                ELIF(VALTYPE(BlockID) != V_STRING) // На случай если блок не указан!
                    Items(i).Value = Value;
                    Items(i).ExtParms = ExtParms;
                END;

            END;
            IF (Items(i).Chk_Name == TablName)
                //IF (Items(i).BLOCK_Name == "НеДляПроверки")
                //    CheckingBlocks[CheckingBlocks.size] = "НеДляПроверки";
                //END;
                IF ((VALTYPE(BlockID) == V_STRING) AND (BlockID == Items(i).BLOCK_Name))
                    Items(i).Value = Value;
                    Items(i).ExtParms = ExtParms;
                ELIF(VALTYPE(BlockID) != V_STRING)
                    Items(i).Value = Value;
                    Items(i).ExtParms = ExtParms;
                END;
            END;
            i = i + 1;
        END;
    END;

    MACRO GetData(BKI_ABR,TablName,Num:@Integer,ResStr:@String,ExtParms,BlockID);
      var i = 0;
      var Undef;
        WHILE(i < Count)
            IF ((VALTYPE(BlockID) != V_STRING) OR (BlockID == Items(i).BLOCK_Name))
                IF (Items(i).Abr_Name == BKI_ABR)
                    IF (VALTYPE(Num) == V_INTEGER) Num = i; END;
                    IF (VALTYPE(ResStr) == V_STRING) ResStr = Items(i).Res_Str; END;
                    IF (VALTYPE(ExtParms) != V_UNDEF) ExtParms = Items(i).ExtParms; END;
                    RETURN Items(i).Value;
                END;
                IF (Items(i).Chk_Name == TablName)
                    IF (VALTYPE(Num) == V_INTEGER) Num = i; END;
                    IF (VALTYPE(ResStr) == V_STRING) ResStr = Items(i).Res_Str; END;
                    IF (VALTYPE(ExtParms) != V_UNDEF) ExtParms = Items(i).ExtParms; END;
                    RETURN Items(i).Value;
                END;
            END;
            i = i + 1;
        END;

       //RETURN "("+BKI_ABR+" "+TablName+") - ! НЕ НАЙДЕН !!";
       RETURN undef;
    END;

    // Нужно ли проверять этот блок
    MACRO IsCheckThisBlock(BlockName:String,Num:@Integer)
      /* Оптимизация 149563
      var i = 0,f = 0,stat;
      WHILE(i < CheckingBlocks.size)
            IF (BlockName == CheckingBlocks(i))
              IF (VALTYPE(Num) != V_UNDEF)  Num = i; END;
              RETURN TRUE;
            END;
            i = i + 1;
      END;
      RETURN FALSE;
      */
      RETURN TRUE;
    END;

    // Нужно ли проверять этот элемент
    MACRO IsCheckThisItem(Item:@CheckItem) // Нужно ли проверять этот блок (Разница для физика ЮРИКА)
      RETURN IsCheckThisBlock(Item.BLOCK_Name);
    END;


    MACRO CheckAllParams( BlockName:String )
      var i = 0,f = 0,stat;
      var isBreak = FALSE;
      var ФункцияПроверки:procref = null;
      var CheckingBlock = "";
      var GetAnyError:BOOL = FALSE;
      /// FOR DEBUG
      VAR W_BlockN;
      VAR W_ABBR;
      VAR W_VALUE;
      /// END FOR DEBUG
          IF (VALTYPE(BlockName) != V_UNDEF)
              CheckingBlock = BlockName;
          END;
          WHILE(i < Count)
              W_BlockN     = Items(i).BLOCK_Name;
              W_ABBR       = Items(i).Abr_Name;
              W_VALUE      = Items(i).Value;
              IF (( (IsCheckThisItem(Items(i))) AND (CheckingBlock == "")) // Проверка по блокам
                  OR ( CheckingBlock == Items(i).BLOCK_Name )
                 )
                  ПроверкаФормата(@Items(i),@Data);
                  WHILE((Not isBreak) AND (f < 6))
                      ФункцияПроверки = Items(i).ChekFunArr[f];
                      IF (VALTYPE(ФункцияПроверки) != V_UNDEF)
                          stat = ExecMacro2(@ФункцияПроверки, @Items(i),@Data);
                          IF (stat == false) isBreak = TRUE; END; // Если не прошли обязательность, то смысла проверять дальше - НЕТ!
                          IF (Items(i).Res_Str != "")
                              GetAnyError = TRUE;
                          END;
                      END;
                      f = f + 1;
                  END;
              END;
              f = 0;
              i = i + 1;
              isBreak = FALSE;
          END;
          IF (GetAnyError)
              RETURN FALSE;
          END;
          RETURN TRUE;
    END;

    MACRO FillCommonDataFromParams( BlockName:String )
        var Value,Undef;
        var Str:String,Num:Integer;
        var MoneyVal:Money,MoneyVal2:Money;
        var DateVal:Date;

        Invalid_TR_File_DATA = FALSE;

         // ПРОВЕРКА ЦЕЛОСТНОСТИ ТФ
        IF (TOTAL_MSG_COUNT == 0)
            GlobalErr = "Нарушена целостность ТФ";
            Invalid_TR_File_DATA = TRUE;
            RETURN;
        END;

        // АССД
        Data.ДАТФАЙЛ = date(0,0,0);
        Data.ДАТФАЙЛ = Str2Date(GetData("ДАТФАЙЛ",""));
        Data.ДАТПОГОД= Str2Date(GetData("ДАТПОГОД",""));

        Data.ИДИСТ   = GetData("ИДИСТ","");
        Data.ПЕРИОДПР= GetData("ПЕРИОДПР","");
        

        IF ((BlockName == "Блок 100(150)") OR (BlockName == "Блок 182"))
            IF (BlockName == "Блок 100(150)")
                Value = GetData("ИДДОГ","",Undef,Undef,Undef,"Блок 100(150)");
                if ((VALTYPE(Value) == V_STRING) AND (Index(Value,"НЕ НАЙДЕН") > 0))
                    Value = Undef;
                END;
            ELSE
                Value = GetData("ИДДОГОБ","",Undef,Undef,Undef,"Блок 182");  // 149378
                //Value = GetData("ИДДОГОБ","");
                if ((VALTYPE(Value) == V_STRING) AND (Index(Value,"НЕ НАЙДЕН") > 0))
                    Value = Undef;
                END;
            END;
            IF (VALTYPE(Value) != V_UNDEF)
                Str = SubStr(Value,1,1);
                Num = Str;
                Data.ТипЛица = Num;
                IF (Num == 5)
                    Data.IsПБЮЛ      = TRUE;
                ELSE
                    Data.IsПБЮЛ      = FALSE;
                END;
                Data.ИДДОГ = Value;
                IF (SubStr(Value,2,1) == "5")
                    Data.ТИП_КД = LO_KARTA;
                END;
            ELSE
                GlobalErr = "Выгружен с ошибками траспортного файла. Проверка невозможна.";
                RETURN;
            END;

        END;



        IF (BlockName == "Блок 201")
           IF (Data.ТипЛица == 2) // Только если ФИЗИК
               Data.ID_Клиента           = 0; // ПО ИДЕЕ НЕ НУЖЕН ВООБЩЕ!
               //Data.ДатаДоговора         = Str2Date(GetData("ДАТДОГ","",Undef,Undef,Undef,"Блок 100(150)"));
               Data.ДатаДоговора         = Str2Date(GetData("ДАТДОГ",""));
               IF (VALTYPE(GetData("ДАТДОГ","")) == V_UNDEF)
                   Data.ДатаДоговора = Str2Date(GetData("ДАТДОГ","",Undef,Undef,Undef,"Блок 180"));
                               IF (VALTYPE(Data.ДатаДоговора) == V_UNDEF)  Data.ДатаДоговора  = NULL_DATE;  END;
               END;
               // ДАТА РОЖДЕНИЯ
               Data.ДатаРаждения         = Str2Date(GetData("ДАТРОЖД",""));
               IF (VALTYPE(GetData("ДАТРОЖД","")) == V_UNDEF) Data.ДатаРаждения  = NULL_DATE; END;
           END;
        END;


        // Тут определяем первая ли это передача! а также наличие блоков в файле для разных типов лиц
        IF (BlockName == "ЦЕЛОСТНОСТЬ")
            IF (not ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД) // Теперь этот параметр может заполняться TRUE если есть блок 150 148644
                ID_CRD = GetData("ИДДОГ","");
                IF ((VALTYPE(ID_CRD) == V_UNDEF) OR (ID_CRD == ""))
                  ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД = FALSE;
                ELSE
                    IF (НайтиКД_по_ИДДОГ(ID_CRD))
                        SendsCount = 0;
                        SendsCount = CRSDCommand("SELECT COUNT(T_ID) FROM DLDEVBKI_DBT dldev "
                                                 " WHERE "
                                                 " dldev.T_BKIID_REF = ? AND    "
                                                 " dldev.T_TFID_REF  < ? AND    "
                                                 " dldev.T_CREDITNUMBER_REF = ? ",
                                                 "BKIID",lbki.rec.BkiID,
                                                 "TF_ID",ltr_file.rec.TFID,
                                                 "CRD_NUM",credit_c.rec.CreditNumber,
                                                 V_INTEGER);
                        IF (SendsCount > 0)
                            ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД = FALSE;
                        ELSE
                            ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД = TRUE;
                        END;
                    END;
                END;
            END;


            IF (ЭТО_ПЕРВАЯ_ПЕРЕЧА_В_АССД)
            // Идет контроль блоков в зависимости от лица:
                IF (Data.ТипЛица == PTLEGF_INST) // ЮР
                    IF ( (not IsBlockInFile("Блок 301")) OR
                         (not IsBlockInFile("Блок 302")) OR
                             (not IsBlockInFile("Блок 401")) OR
                             (not IsBlockInFile("Блок 402"))
                     )
                        Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН = FALSE;
                    END;
                ELIF ((Data.ТипЛица == PTLEGF_PERSN) AND (not Data.IsПБЮЛ) ) // ФИЗ
                        IF ( (not IsBlockInFile("Блок 201")) OR
                         (not IsBlockInFile("Блок 202")) OR
                             (not IsBlockInFile("Блок 401")) OR
                             (not IsBlockInFile("Блок 402"))
                     )
                        Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН = FALSE;
                    END;
                ELIF ((Data.ТипЛица == PTLEGF_PERSN) AND (Data.IsПБЮЛ) ) // ПБЮЛ
                        IF ( (not IsBlockInFile("Блок 201")) OR
                         (not IsBlockInFile("Блок 202")) OR
                         (not IsBlockInFile("Блок 203")) OR
                             (not IsBlockInFile("Блок 401")) OR
                             (not IsBlockInFile("Блок 402"))
                     )
                        Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН = FALSE;
                    END;
                END;
            END;

            IF (not Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН)
                GlobalErr = "Ошибка. При первой передаче в АС СД отсутствуют необходимые блоки";
            END;

        END;


        IF (BlockName == "Блок 201")
            // РЕЗИДЕНТ (НО ВООБЩЕ-ТО ОН ТУТ НЕ НЕЖЕН)
            Value = GetData("ПРРЕЗИД","");
            IF (VALTYPE(Value) != V_UNDEF)
              IF (Value == "0")
                  Data.Резидент = TRUE;
              ELSE
                  Data.Резидент = FALSE;
              END;
            ELSE
              Data.Резидент = FALSE;
            END;
        END;

        IF (BlockName == "Блок 202")
            Data.ID_ОсновногоДокумета = GetData("ВИДДОК", "");
            IF ((VALTYPE(Data.ID_ОсновногоДокумета) != V_UNDEF) AND (StrLen(Data.ID_ОсновногоДокумета) > 0 ))
                IF (Int(Data.ID_ОсновногоДокумета) > 100)
                    Data.ID_ОсновногоДокумета = Int(Data.ID_ОсновногоДокумета)-100;
                END;
            ELSE
                Data.ID_ОсновногоДокумета = "Err";
            END;

            // 150514
            Value = GetData("СЕРДОК","");
            AddData("СЕРДОК", "", Value, Data.ID_ОсновногоДокумета, BlockName);

            Value = GetData("НОМДОК","");
            AddData("НОМДОК", "", Value, Data.ID_ОсновногоДокумета, BlockName);

            Value = GetData("СТРАНА","");
            Data.Страна = Value;
        END;

        //
        IF (BlockName == "Блок 415")
            IF ( ((VALTYPE(GetData("ТЕЛФАКТ","")) != V_UNDEF) AND (GetData("ТЕЛФАКТ","") != "")) OR
                 ((VALTYPE(GetData("ТЕЛРЕГ","")) != V_UNDEF) AND (GetData("ТЕЛРЕГ","") != "")) OR
                 ((VALTYPE(GetData("ТЕЛМОБ","")) != V_UNDEF) AND (GetData("ТЕЛМОБ","") != ""))
                )
                // Если один из телефонов задан
                Data.Контроль_в_Блоке_415 = TRUE;
            ELSE
                Data.Контроль_в_Блоке_415 = FALSE;
            END;
        END;

        IF (BlockName == "Блок 407")
            IF ( ((VALTYPE(GetData("ВОЗПОД","")) != V_UNDEF) AND (GetData("ВОЗПОД","") != "")) OR
                 ((VALTYPE(GetData("ПОГПОД","")) != V_UNDEF) AND (GetData("ПОГПОД","") != "")) OR
                 ((VALTYPE(GetData("ВОЗППР",""))  != V_UNDEF) AND (GetData("ВОЗППР","")  != "")) OR
                 ((VALTYPE(GetData("ПОГППР","")) != V_UNDEF) AND (GetData("ПОГППР","") != ""))
                )
                Data.Контроль_в_Блоке_407 = TRUE;
            ELSE
                Data.Контроль_в_Блоке_407 = FALSE;
            END;
        END;

        IF (BlockName == "Блок 408")
            IF ( ((VALTYPE(GetData("СУМВЫПЛ",""))!= V_UNDEF) AND (GetData("СУМВЫПЛ","") != "")) OR
                 ((VALTYPE(GetData("СРОД",""))   != V_UNDEF) AND (GetData("СРОД","") != "")) OR
                 ((VALTYPE(GetData("ПРОД",""))   != V_UNDEF) AND (GetData("ПРОД","") != "")) OR
                 ((VALTYPE(GetData("СПРОЦ",""))  != V_UNDEF) AND (GetData("СПРОЦ","") != "")) OR
                 ((VALTYPE(GetData("ПРПРОЦ","")) != V_UNDEF) AND (GetData("ПРПРОЦ","") != ""))
                )
                // Доп проверки в связи с 151081 
                Data.Контроль_в_Блоке_408 = TRUE;
                //1
                IF ( (VALTYPE(GetData("ДАТНПРО","")) != V_UNDEF) AND (GetData("ДАТНПРО","") != "") )
                     IF ( ((VALTYPE(GetData("ПРОД",""))   != V_UNDEF) OR (GetData("ПРОД","") == "")) )
                        MoneyVal = GetData("ПРОД","");
                        IF (MoneyVal <= 0)
                            Data.Контроль_в_Блоке_408 = FALSE; 
                        END;
                     ELSE
                         Data.Контроль_в_Блоке_408 = FALSE; 
                     END;
                END;
                //2
                IF ( (VALTYPE(GetData("ДАТНПРП","")) != V_UNDEF) AND (GetData("ДАТНПРП","") != "") )
                     IF ( ((VALTYPE(GetData("ПРПРОЦ",""))   != V_UNDEF) OR (GetData("ПРПРОЦ","") == "")) )
                        MoneyVal = GetData("ПРПРОЦ","");
                        IF (MoneyVal <= 0)
                            Data.Контроль_в_Блоке_408 = FALSE; 
                        END;
                     ELSE
                         Data.Контроль_в_Блоке_408 = FALSE; 
                     END;
                END;
                //3
                IF ( (VALTYPE(GetData("ДАТПРОСР","")) != V_UNDEF) AND (GetData("ДАТПРОСР","") != "") )
                     MoneyVal = GetData("ПРОД","");
                     MoneyVal2 = GetData("ПРПРОЦ","");
                     IF ((MoneyVal <= 0) AND (MoneyVal2 <= 0))
                          Data.Контроль_в_Блоке_408 = FALSE; 
                     END;
                END;
                //4
                IF ( (VALTYPE(GetData("ПРОД",""))   != V_UNDEF) AND (GetData("ПРОД","") != ""))
                    MoneyVal = GetData("ПРОД","");
                    IF ( (MoneyVal < 0) AND 
                         ((VALTYPE(GetData("ДАТНПРО","")) == V_UNDEF) OR (GetData("ДАТНПРО","") == ""))
                        )
                         Data.Контроль_в_Блоке_408 = FALSE; 
                    END;
                END;
                //5
                IF ( (VALTYPE(GetData("ПРПРОЦ",""))   != V_UNDEF) AND (GetData("ПРПРОЦ","") != ""))
                    MoneyVal = GetData("ПРПРОЦ","");
                    IF ( (MoneyVal < 0) AND 
                         ((VALTYPE(GetData("ДАТНПРО","")) == V_UNDEF) OR (GetData("ДАТНПРО","") == ""))
                        )
                         Data.Контроль_в_Блоке_408 = FALSE; 
                    END;
                END;
                //foolish date check
        IF ( ((VALTYPE(Data.ДАТОБЯЗ)   != V_UNDEF) AND (Data.ДАТОБЯЗ != date (0, 0, 0))) )
                     IF ( (VALTYPE(GetData("ДАТДАН","")) != V_UNDEF) AND (GetData("ДАТДАН","") != "") )
                        DateVal = Str2Date (GetData("ДАТДАН",""));
                        IF (DateVal < Data.ДАТОБЯЗ)
                            Data.Контроль_в_Блоке_408 = FALSE; 
                        END;
                     ELSE
                         Data.Контроль_в_Блоке_408 = FALSE;
                     END;
                END;
                //Data.Контроль_в_Блоке_408 = TRUE;
            ELSE
                Data.Контроль_в_Блоке_408 = FALSE;
            END;
        END;
        
        IF (BlockName == "Блок 409")
            IF  ( ((VALTYPE(GetData("ДПОД",""))!= V_UNDEF)) AND
                   ((VALTYPE(GetData("СПОД",""))!= V_UNDEF) AND (GetData("СПОД","") != "")) )
                Data.Контроль_в_Блоке_409 = TRUE;
            ELSE
               IF  ( ((VALTYPE(GetData("ДПП",""))  != V_UNDEF)) AND
                   ((VALTYPE(GetData("СПП",""))  != V_UNDEF) AND (GetData("СПП","") != "")) )
                Data.Контроль_в_Блоке_409 = TRUE;
               ELSE
                Data.Контроль_в_Блоке_409 = FALSE;
               END;
            END;
        END;


        //Data.ChekData_For_BKI = not IsCheckTF;
        Data.ChekData_For_BKI = FALSE;

        // ЗАПОЛНЯЕМ НАЗВАНИЕ БЛОКОВ КОТОРЫЕ БУДЕМ ПРОВЕРЯТЬ В ДАННОМ СЛУЧАЕ
//      Не работает так как нужно  проверять ВСЕ БЛОКИ КОТОРЫЕ ЕСТЬ В ТФ ИЛИ ДОЛЖНЫ БЫТЬ В ТФ
        IF (Data.ТипЛица == 2) // Если ФИЗИК
            IF (not Data.IsПБЮЛ) // Если ПБЮЛ
                AddBlockIfNeed("Заголовок",TRUE);
                AddBlockIfNeed("Блок 100(150)",TRUE);
                AddBlockIfNeed("Блок 201",TRUE);
                AddBlockIfNeed("Блок 202",TRUE);
                AddBlockIfNeed("Блок 204",TRUE);
                AddBlockIfNeed("Блок 401",TRUE);
                AddBlockIfNeed("Блок 402");
                AddBlockIfNeed("Блок 403");
                AddBlockIfNeed("Блок 408");
                AddBlockIfNeed("Блок 407");
                AddBlockIfNeed("Блок 404");
                AddBlockIfNeed("Блок 405");
                AddBlockIfNeed("Блок 406");
                AddBlockIfNeed("Блок 304");
                AddBlockIfNeed("Блок 303");
                AddBlockIfNeed("Блок 409");
                AddBlockIfNeed("Блок 410");
                AddBlockIfNeed("Блок 601",TRUE);
            ELSE
                AddBlockIfNeed("Заголовок",TRUE);
                AddBlockIfNeed("Блок 100(150)",TRUE);
                AddBlockIfNeed("Блок 201",TRUE);
                AddBlockIfNeed("Блок 202",TRUE);
                AddBlockIfNeed("Блок 203",TRUE);
                AddBlockIfNeed("Блок 204",TRUE);
                AddBlockIfNeed("Блок 401",TRUE);
                AddBlockIfNeed("Блок 402");
                AddBlockIfNeed("Блок 403");
                AddBlockIfNeed("Блок 408");
                AddBlockIfNeed("Блок 407");
                AddBlockIfNeed("Блок 404");
                AddBlockIfNeed("Блок 405");
                AddBlockIfNeed("Блок 406");
                AddBlockIfNeed("Блок 304");
                AddBlockIfNeed("Блок 303");
                AddBlockIfNeed("Блок 409");
                AddBlockIfNeed("Блок 410");
                AddBlockIfNeed("Блок 601",TRUE);
            END;
        ELSE
            // ЕСЛИ ЮРИК
            AddBlockIfNeed("Заголовок",TRUE);
            AddBlockIfNeed("Блок 100(150)",TRUE);
            AddBlockIfNeed("Блок 301",TRUE);
            AddBlockIfNeed("Блок 401",TRUE);
            AddBlockIfNeed("Блок 302",TRUE);
            AddBlockIfNeed("Блок 303");
            AddBlockIfNeed("Блок 304");
            AddBlockIfNeed("Блок 305");
            AddBlockIfNeed("Блок 402");
            AddBlockIfNeed("Блок 403");
            AddBlockIfNeed("Блок 408");
            AddBlockIfNeed("Блок 407");
            AddBlockIfNeed("Блок 404");
            AddBlockIfNeed("Блок 405");
            AddBlockIfNeed("Блок 406");
            AddBlockIfNeed("Блок 304");
            AddBlockIfNeed("Блок 303");
            AddBlockIfNeed("Блок 409");
            AddBlockIfNeed("Блок 410");
            AddBlockIfNeed("Блок 601",TRUE);
        END;

    END;


    MACRO WriteReport( BlockName  );
      var i = 0,Crd_ID_Num;
      var IDDOG;
      var ReportString:string = "",Value,GetEnError:BOOL = FALSE;
        IF ( VALTYPE(BlockName) == V_UNDEF)
            //BlockName = "";
            IF (not GetEnErrorInMassge) // Если ошибок в данном договоре не было
                [ ИДДОГ #############################################]
                (GetData("ИДДОГ"));
                [ ######################]
                ("Ошибок нет");
            END;
        ELSE
            WHILE(i < Count)
                IF (Items(i).BLOCK_Name == BlockName)
                IF (Items(i).Res_Str != "")
                    GetEnError = true;
                    GetEnErrorInMassge = TRUE;
                    if (Items(i).BLOCK_Name != "Заголовок")
                        IDDOG = GetData("ИДДОГ");
                        IF (VALTYPE(IDDOG) == V_UNDEF)
                          IDDOG = "Не заполнен";
                        END;

                    [ ИДДОГ #############################################]
                        (IDDOG);
                    END;
                    [ ИДБЛОК ##############]
                    (Items(i).BLOCK_Name);
                    IF ((Items(i).BLOCK_Name == "Блок 201") OR (Items(i).BLOCK_Name == "Блок 202") OR
                        (Items(i).BLOCK_Name == "Блок 301") OR (Items(i).BLOCK_Name == "Блок 401") OR
                        (Items(i).BLOCK_Name == "Блок 302") OR (Items(i).BLOCK_Name == "Блок 203") )
                        [ НОМЗАЕМ ##############]
                        (GetData("НОМЗАЕМ"));
                    END;
                    [ #]
                    (Items(i).Res_Str);
                    [ # ](" ");
                END;
                 END;
                 i = i + 1;
             END;
        END;


    END;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MACRO РегистрацияПроверяемыхПараметров( ChekRef:@DataCheckerReporter )
  ///                           BKI_ABR        TablName                   Обязательность   Пробелы     Символы    Шаблон    Коды    Логические   BLOCK_Name
  //                                                                     ,@Обязательность(),@Пробелы(),@Символы(),@Шаблон(),@Коды(),@Логические(), "Блок ХХХ"

  //ChekRef.RegisterCheckParam("-"         ,"Код источника КИ "  ,"-",@Обязательность(),@Пробелы(),      null,     null,   null,         null, "НеДляПроверки");
  ChekRef.RegisterCheckParam("ИДДОГ"     ,"-"                  ,"-",             null,      null,      null,     null,   null,         null, "НеДляПроверки");
  ChekRef.RegisterCheckParam("НОМЗАЕМ"   ,"-"                  ,"-",             null,      null,      null,     null,   null,         null, "НеДляПроверки");
  ChekRef.RegisterCheckParam("ДАТДОГ"    ,"-"                  ,"-",             null,      null,      null,     null,   null,         null, "НеДляПроверки");

  // 408 (ОПТИМИЗАЦИЯ для ускорения ПОИСКА БЛОКА В СПИСКЕ)
  ChekRef.RegisterCheckParam("ДАТДАН"  ,"ДАТДАН"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 408");
  ChekRef.RegisterCheckParam("СУМВЫПЛ" ,"СУМВЫПЛ" ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 408");
  ChekRef.RegisterCheckParam("СРОД"    ,"СРОД"    ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 408");
  ChekRef.RegisterCheckParam("ПРОД"    ,"ПРОД"    ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 408");
  ChekRef.RegisterCheckParam("СПРОЦ"   ,"СПРОЦ"   ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 408");
  ChekRef.RegisterCheckParam("ПРПРОЦ"  ,"ПРПРОЦ"  ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 408");
  ChekRef.RegisterCheckParam("ДАТНПРО" ,"ДАТНПРО" ,"D"    ,             null,      null,      null,     null,   null,         null, "Блок 408"); // 151081 
  ChekRef.RegisterCheckParam("ДАТНПРП" ,"ДАТНПРП" ,"D"    ,             null,      null,      null,     null,   null,         null, "Блок 408");
  ChekRef.RegisterCheckParam("ДАТПРОСР","ДАТПРОСР","D"    ,             null,      null,      null,     null,   null,         null, "Блок 408");
  
  // 407 (ОПТИМИЗАЦИЯ для ускорения ПОИСКА БЛОКА В СПИСКЕ)
  ChekRef.RegisterCheckParam("НОМОПЕР"  ,"НОМОПЕР"   ,"N12"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 407");
  ChekRef.RegisterCheckParam("ДАТБАЛ"   ,"ДАТБАЛ"    ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 407");
  ChekRef.RegisterCheckParam("ДАТКЛД"   ,"ДАТКЛД"    ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 407");
  ChekRef.RegisterCheckParam("ДАТДАН"   ,"ДАТДАН"    ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 407");
  ChekRef.RegisterCheckParam("ВАЛЮТА"   ,"ВАЛЮТА"    ,"A3"   ,@Обязательность(),      null,      null,@Шаблон(),   null,@Логические(), "Блок 407");
  ChekRef.RegisterCheckParam("ВОЗПОД"   ,"ВОЗПОД"    ,"N14.2",             null,      null,      null,     null,   null,         null, "Блок 407");
  ChekRef.RegisterCheckParam("ПОГПОД"   ,"ПОГПОД"    ,"N14.2",             null,      null,      null,     null,   null,         null, "Блок 407");
  ChekRef.RegisterCheckParam("ВОЗППР"   ,"ВОЗППР"    ,"N14.2",             null,      null,      null,     null,   null,         null, "Блок 407");
  ChekRef.RegisterCheckParam("ПОГППР"   ,"ПОГППР"    ,"N14.2",             null,      null,      null,     null,   null,         null, "Блок 407");


  /// ЗАГОЛОВОК
  ChekRef.RegisterCheckParam("ДЛИНЗАГ"   ,"ДЛИНЗАГ"            ,"N2"   ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("ИДПОЛУЧ"   ,"ИДПОЛУЧ"            ,"A10"  ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("ЧИСЛСООБ"  ,"ЧИСЛСООБ"           ,"N10"  ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("ДАТФАЙЛ"   ,"ДАТФАЙЛ"            ,"D"    ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("ИМЯФАЙЛ"   ,"ИМЯФАЙЛ"            ,"A12"  ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("НОМВЕРС"   ,"НОМВЕР"             ,"A1"   ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("КОЛДД"     ,"КОЛДД"              ,"N12"  ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММОБЯЗР" ,"СУМОБЯЗР"           ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММОБЯЗД" ,"СУМОБЯЗД"           ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММОБЯЗЕ" ,"СУМОБЯЗЕ"           ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("КОЛДП"     ,"КОЛДП"              ,"N12"  ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММПОР"   ,"СУММПОР"            ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММПОД"   ,"СУММПОД"            ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММПОЕ"   ,"СУММПОЕ"            ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("КОЛДЗ"     ,"КОЛДЗ"              ,"N12"  ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММЗАЛР"  ,"СУММЗАЛР"           ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММЗАЛД"  ,"СУММЗАЛД"           ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("ДАТАКТ"    ,"ДАТАКТ"             ,"D"    ,@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("СУММЗАЛЕ"  ,"СУММЗАЛЕ"           ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Заголовок");
  ChekRef.RegisterCheckParam("ИДИСТ"     ,"ИДИСТ"              ,"A10"  ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Заголовок");

  /// 100/150
  ChekRef.RegisterCheckParam("ИДИСТ"    ,"ИДИСТ"   ,"A10",@Обязательность(),@Пробелы(),      null,     null,   null,@Логические(), "Блок 100(150)");
  ChekRef.RegisterCheckParam("ИДДОГ"    ,"ИДДОГ"   ,"A22",@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 100(150)");
  ChekRef.RegisterCheckParam("ИДСООБ"   ,"ИДСООБ"  ,"N12",@Обязательность(),      null,      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("НОМСООБ"  ,"НОМСООБ" ,"N6" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("РАЗРБКИ"  ,"РАЗРБКИ" ,"A1" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("КОДТБ"    ,"КОДТБ"   ,"A2" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("НОМДОГ"   ,"НОМДОГ"  ,"A20",@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("НОМОСБ"   ,"НОМОСБ"  ,"A4" ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("НОМДО"    ,"НОМДО"   ,"A20",@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 100(150)");
  ChekRef.RegisterCheckParam("ДАТДОГ"   ,"ДАТДОГ"  ,"D"  ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 100(150)");

  /// 201
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"   ,"N2"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ПРПБЮЛ"   ,"ПРПБЮЛ"    ,"N1"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ПОЛ"      ,"ПОЛ"       ,"A1"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("РОЛЬ"     ,"РОЛЬ"      ,"A2"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ФАМ"      ,"ФАМ"       ,"A40" ,@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ИМЯ"      ,"ИМЯ"       ,"A40" ,@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("МЕСТРОЖД" ,"МЕСТРОЖД"  ,"A255",@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ОТЧ"      ,"ОТЧ"       ,"A40" ,             null,@Пробелы(),@Символы(),     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ИНН"      ,"ИНН"       ,"N12" ,             null,      null,      null,     null,@Коды(),         null, "Блок 201");
  ChekRef.RegisterCheckParam("ДАТРОЖД"  ,"ДАТРОЖД"   ,"D"   ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 201");
  ChekRef.RegisterCheckParam("ПРРЕЗИД"  ,"ПРРЕЗИД"   ,"N1"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 201");
  ChekRef.RegisterCheckParam("ДАТВВОД"  ,"ДАТВВОД"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 201");

  /// 202
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"  ,"N2"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("ДАТДОК"   ,"ДАТДОК"   ,"D"   ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("ВИДДОК"   ,"ВИДДОК"   ,"N3"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("СТРАНА"   ,"СТРАНА"   ,"N3"  ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("СЕРДОК"   ,"СЕРДОК"   ,"A10" ,@Обязательность(),@Пробелы(),@Символы(),@Шаблон(),   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("НОМДОК"   ,"НОМДОК"   ,"A25" ,@Обязательность(),@Пробелы(),      null,@Шаблон(),   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("МЕСТДОК"  ,"МЕСТДОК"  ,"A50" ,             null,@Пробелы(),@Символы(),     null,   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("КОДПОДР"  ,"КОДПОДР"  ,"A12" ,             null,@Пробелы(),      null,     null,   null,         null, "Блок 202");
  ChekRef.RegisterCheckParam("НАИМОРГ"  ,"НАИМОРГ"  ,"A150",@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 202");

  /// 301
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"    ,"N2"   ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 301");
  ChekRef.RegisterCheckParam("НАИМПОЛ"  ,"НАИМПОЛ"    ,"A1020",@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 301");
  ChekRef.RegisterCheckParam("НАИМСОКР" ,"НАИМСОКР"   ,"A255" ,@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 301");
  ChekRef.RegisterCheckParam("ДАТВВОД"  ,"ДАТВВОД"    ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 301");
  ChekRef.RegisterCheckParam("РОЛЬ"     ,"РОЛЬ"       ,"A2"   ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 301");

  // 401
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"    ,"N2"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 401");
  ChekRef.RegisterCheckParam("ТИПЗАЕМ"  ,"ТИПЗАЕМ"    ,"A1"  ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 401");
  ChekRef.RegisterCheckParam("АДРЕС"    ,"АДРЕС"      ,"A255",@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 401");
  ChekRef.RegisterCheckParam("ТИПАДР"   ,"ТИПАДР"     ,"A1"  ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 401");
  ChekRef.RegisterCheckParam("ВАРАДР"   ,"ВАРАДР"     ,"A1"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 401");
  ChekRef.RegisterCheckParam("ДАТВВОД"  ,"ДАТВВОД"    ,"D"   ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 401");


  // 415
  ChekRef.RegisterCheckParam("ТЕЛЕФОН"  ,"ТЕЛЕФОН"    ,"A100",@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 415");
  ChekRef.RegisterCheckParam("ТЕЛФАКТ"  ,"ТЕЛФАКТ"    ,"A20" ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 415");
  ChekRef.RegisterCheckParam("ТЕЛРЕГ"   ,"ТЕЛРЕГ"     ,"A20" ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 415");
  ChekRef.RegisterCheckParam("ЕМАЙЛ"    ,"ЕМАЙЛ"      ,"A100",             NULL,@Пробелы(),      null,@Шаблон(),   null,         null, "Блок 415");
  ChekRef.RegisterCheckParam("ДАТВВОД"  ,"ДАТВВОД"    ,"D"   ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 415");

  // 204
  ChekRef.RegisterCheckParam("НАИМР"   ,"НАИМР"    ,"A1020",             NULL,@Пробелы(),@Символы(),     null,   null,         null, "Блок 204");
  ChekRef.RegisterCheckParam("ИННМР"   ,"ИННМР"    ,"A12"  ,             NULL,@Пробелы(),      null,     null,@Коды(),         null, "Блок 204");
  ChekRef.RegisterCheckParam("ДОЛЖН"   ,"ДОЛЖН"    ,"A60"  ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 204");
  ChekRef.RegisterCheckParam("ДАТВВОД" ,"ДАТВВОД"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 204");

  // 302
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"   ,"N2" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 302");
  ChekRef.RegisterCheckParam("КПП"      ,"КПП"       ,"N9" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 302");
  ChekRef.RegisterCheckParam("ПРРЕЗИД"  ,"ПРРЕЗИД"   ,"N1" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 302");
  ChekRef.RegisterCheckParam("ОГРН"     ,"ОГРН"      ,"N13",@Обязательность(),@Пробелы(),      null,     null,@Коды(),         null, "Блок 302");
  ChekRef.RegisterCheckParam("ИНН"      ,"ИНН"       ,"N10",@Обязательность(),@Пробелы(),@Символы(),     null,@Коды(),         null, "Блок 302");
  ChekRef.RegisterCheckParam("ДАТВВОД"  ,"ДАТВВОД"   ,"D"  ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 302");
  //ChekRef.RegisterCheckParam("ОКПО"   ,"ОКПО"      ,"-"  ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 302");

  // 203
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"   ,"N2"   ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 203");
  ChekRef.RegisterCheckParam("ДАТРЕГ"   ,"ДАТРЕГ"    ,"D"    ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 203");
  ChekRef.RegisterCheckParam("ВИДДОК"   ,"ВИДДОК"    ,"A1"   ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 203");
  ChekRef.RegisterCheckParam("СЕРДОК"   ,"Серия"     ,"A10"  ,             null,@Пробелы(),      null,     null,   null,         null, "Блок 203");
  ChekRef.RegisterCheckParam("ОГРНИП"   ,"ОГРНИП"    ,"A15"  ,             null,@Пробелы(),      null,     null,   null,         null, "Блок 203");
  ChekRef.RegisterCheckParam("НОМДОК"   ,"НОМДОК"    ,"A40"  ,@Обязательность(),@Пробелы(),      null,     null,   null,         null, "Блок 203");
  ChekRef.RegisterCheckParam("НАИМОРГ"  ,"НАИМОРГ"   ,"A1020",@Обязательность(),@Пробелы(),@Символы(),     null,   null,         null, "Блок 203");

  // 402
  ChekRef.RegisterCheckParam("ЛИМИТ"    ,"ЛИМИТ"     ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("ВАЛЮТА"   ,"ВАЛЮТА"    ,"A3"   ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("ДАТПОГОД" ,"ДАТПОГОД"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("ТИППС"    ,"ТИППС"     ,"A3"   ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("СТАВКА"   ,"СТАВКА"    ,"N8.2" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("ДАТОБЯЗ"  ,"ДАТОБЯЗ"   ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 402");
  ChekRef.RegisterCheckParam("ДАТНАЧОД" ,"ДАТНАЧОД"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 402");
  ChekRef.RegisterCheckParam("ДАТНАЧПР" ,"ДАТНАЧПР"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 402");
  ChekRef.RegisterCheckParam("ПЕРИОДОД" ,"ПЕРИОДОД"  ,"N2"   ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("ПЕРИОДПР" ,"ПЕРИОДПР"  ,"N2"   ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 402");
  ChekRef.RegisterCheckParam("ЧИСЛОПР"  ,"ЧИСЛОПР"   ,"N2"   ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 402");
  ChekRef.RegisterCheckParam("НОРМДОК"  ,"НОРМДОК"   ,"A15"  ,             null,@Пробелы(),      null,     null,   null,         null, "Блок 402");


  // 404
  //ChekRef.RegisterCheckParam("ДАТИСП"   ,"ДАТИСП"    ,"D"    ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 404");
  ChekRef.RegisterCheckParam("СУМНОД"   ,"СУМНОД"    ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Блок 404");
  ChekRef.RegisterCheckParam("СУМНПР"   ,"СУМНПР"    ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Блок 404");
  ChekRef.RegisterCheckParam("ДАТПОСЛ"  ,"ДАТПОСЛ"   ,"D"    ,             null,      null,      null,     null,   null,@Логические(), "Блок 404");
  ChekRef.RegisterCheckParam("ДАТЗАКР"  ,"ДАТЗАКР"   ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 404");
  ChekRef.RegisterCheckParam("ВАЛЮТА"   ,"ВАЛЮТА"    ,"A3"   ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 404");
  ChekRef.RegisterCheckParam("КОДЗАКР"  ,"КОДЗАКР"   ,"N1"   ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 404");

  /// 406
  ChekRef.RegisterCheckParam("ИНФСУД"   ,"ИНФСУД"    ,"A255",    null,@Пробелы(),      null,     null,   null,         null, "Блок 406");
  ChekRef.RegisterCheckParam("ИНФРЕШ"   ,"ИНФРЕШ"    ,"A255",    null,@Пробелы(),      null,     null,   null,         null, "Блок 406");
  ChekRef.RegisterCheckParam("ИНФОФЦ"   ,"ИНФОФЦ"    ,"A255",    null,@Пробелы(),      null,     null,   null,         null, "Блок 406");
  ChekRef.RegisterCheckParam("ДАТСУД"   ,"ДАТСУД"    ,"D"   ,    null,      null,      null,     null,   null,@Логические(), "Блок 406");
  ChekRef.RegisterCheckParam("ДАТРЕШ"   ,"ДАТРЕШ"    ,"D"   ,    null,      null,      null,     null,   null,@Логические(), "Блок 406");
  ChekRef.RegisterCheckParam("ДАТОФЦ"   ,"ДАТОФЦ"    ,"D"   ,    null,      null,      null,     null,   null,@Логические(), "Блок 406");

  // 304
  ChekRef.RegisterCheckParam("ИНФБАНК"  ,"ИНФБАНК"    ,"A255",             null,@Пробелы(),      null,     null,   null,         null, "Блок 304");
  ChekRef.RegisterCheckParam("НОМЗАЕМ"  ,"НОМЗАЕМ"    ,"N2"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 304");
  ChekRef.RegisterCheckParam("ДАТБАНК"  ,"ДАТБАНК"    ,"D"   ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 304");

  
  // 180
  ChekRef.RegisterCheckParam("ИДИСТ"    ,"ИДИСТ"    ,"A10",@Обязательность(),      null,      null,     null,   null,         null, "Блок 180");
  ChekRef.RegisterCheckParam("ИДСООБ"   ,"ИДСООБ"   ,"N12",@Обязательность(),      null,      null,     null,   null,         null, "Блок 180");
  ChekRef.RegisterCheckParam("КОЛДОГОВ" ,"КОЛДОГОВ" ,"N12",@Обязательность(),      null,      null,     null,   null,         null, "Блок 180");
  ChekRef.RegisterCheckParam("НОМСООБ"  ,"НОМСООБ"  ,"N6" ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 180");

  // 181
  ChekRef.RegisterCheckParam("ИДДОГ"   ,"ИДДОГ"    ,"A22",@Обязательность(),      null,      null,     null,   null,         null, "Блок 181");
  ChekRef.RegisterCheckParam("ДАТВВОД" ,"ДАТВВОД"  ,"D" ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 181");
  ChekRef.RegisterCheckParam("ДАТДОГ"  ,"ДАТДОГ"   ,"D" ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 181");

  // 182
  ChekRef.RegisterCheckParam("ИДДОГОБ" ,"ИДДОГОБ"  ,"A22"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 182");
  ChekRef.RegisterCheckParam("НОМДОГ"  ,"НОМДОГ"   ,"A20"  ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 182");
  ChekRef.RegisterCheckParam("СУММА"   ,"СУММА"    ,"N14.2",@Обязательность(),      null,      null,     null,   null,         null, "Блок 182");
  ChekRef.RegisterCheckParam("СТАТУС"  ,"СТАТУС"   ,"N1"   ,@Обязательность(),      null,      null,     null,   null,         null, "Блок 182");
  ChekRef.RegisterCheckParam("ВИДДОГ"  ,"ВИДДОГ"   ,"A60"  ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 182");
  ChekRef.RegisterCheckParam("ВАЛЮТА"  ,"ВАЛЮТА"   ,"A3"   ,@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 182");
  ChekRef.RegisterCheckParam("ДАТДОГ"  ,"ДАТДОГ"   ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 182");
  ChekRef.RegisterCheckParam("ДАТВВОД" ,"ДАТВВОД"  ,"D"    ,@Обязательность(),      null,      null,     null,   null,@Логические(), "Блок 182");
  ChekRef.RegisterCheckParam("ВИДЗАЛОГ","ВИДЗАЛОГ" ,"A60"  ,             null,@Пробелы(),      null,     null,   null,@Логические(), "Блок 182");

  // 601
  ChekRef.RegisterCheckParam("КОДСУБ" ,"КОДСУБ"  ,"A15",@Обязательность(),      null,      null,     null,   null,         null, "Блок 601");

  // 409
  ChekRef.RegisterCheckParam("ДПОД"    ,"ДПОД"    ,"D"    ,             null,      null,      null,     null,   null,@Логические(), "Блок 409");
  ChekRef.RegisterCheckParam("СПОД"    ,"СПОД"    ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 409");
  ChekRef.RegisterCheckParam("ДПП"     ,"ДПП"     ,"D"    ,             null,      null,      null,     null,   null,@Логические(), "Блок 409");
  ChekRef.RegisterCheckParam("СПП"     ,"СПП"     ,"N14.2",             null,      null,      null,     null,   null,@Логические(), "Блок 409");
  ChekRef.RegisterCheckParam("ВАЛЮТА"  ,"ВАЛЮТА"  ,"A3"   ,@Обязательность(),      null,      null,@Шаблон(),   null,@Логические(), "Блок 409");

  // 410
  ChekRef.RegisterCheckParam("ВАЛЮТА"  ,"ВАЛЮТА"   ,"A3",@Обязательность(),      null,      null,@Шаблон(),   null,         null, "Блок 410");

END;






//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MACRO ЗаполнитьДаннымиИзТФ( TF , Report:@DataCheckerReporter, ReadByBlock,Header)
   var Stat = FALSE;
   var BKI_ABR : String,ABR_VALUE:String,Str:String,Num:Integer = 0;
   VAR SerchNextIDBlock:BOOL = TRUE;
   VAR isBreak = FALSE;
   VAR OLD_ABBR;
   VAR MSG_IN_BLOCK:INTEGER = 0,Undef;

   IF (VALTYPE(ReadByBlock) == V_UNDEF)
      ReadByBlock = FALSE;
   END;

   IF (VALTYPE(Header) == V_UNDEF)
      Header = FALSE;
   END;

   // Продолжаем с того места, с которого закончили
   IF((Report.ReadByBlockABBR == "ИДБЛОК") AND (ReadByBlock))
       BKI_ABR = Report.ReadByBlockABBR;
       ABR_VALUE = Report.ReadByBlockVAL;
       Report.AddData(BKI_ABR,"",ABR_VALUE);
   END;

   WHILE ( (not isBreak) AND (Next(TF)))
      BKI_ABR = TF(0);
      ABR_VALUE = TF(1);

      // ПРОВЕРКА ЦЕЛОСТНОСТИ ТФ
      IF ( ((Report.LST_READ_ABBR == "@@@") AND ( BKI_ABR != "ИДБЛОК") AND (BKI_ABR != "===")) OR // Начало без ИДБЛОК
           ((BKI_ABR == Report.ReadByBlockABBR) AND (BKI_ABR == "ИДБЛОК") AND (MSG_IN_BLOCK == 0)) OR // 2 ИДБЛОК подряд ( пустой блок )
           ((Report.LST_READ_ABBR == "ИДБЛОК") AND (BKI_ABR == "@@@") AND (MSG_IN_BLOCK == 0))     // ИДБЛОК и @@@ подряд ( пустой блок 601)
         )
          Report.GlobalErr = "Нарушена целостность ТФ";
          Report.Invalid_TR_File_DATA = TRUE;
          Stat = TRUE;
          isBreak = TRUE;
      ELSE
          IF ( (not Header) AND (Report.LST_READ_ABBR == "@@@") AND ( BKI_ABR == "ИДБЛОК") )
             IF( (ABR_VALUE != "100") AND
                 (ABR_VALUE != "150") AND
                 (ABR_VALUE != "155") AND
                 (ABR_VALUE != "156") AND
                 (ABR_VALUE != "180")
               )
                  Report.GlobalErr = "Нарушена целостность ТФ";
                  Report.Invalid_TR_File_DATA = TRUE;
                  Stat = TRUE;
                  isBreak = TRUE;
             ELSE
                Report.TOTAL_MSG_COUNT = Report.TOTAL_MSG_COUNT + 1;
             END;
          END;

          OLD_ABBR = Report.LST_READ_ABBR;
          Report.LST_READ_ABBR = BKI_ABR;
      END;


      IF(BKI_ABR == "@@@")  isBreak = TRUE; END;
      IF(BKI_ABR == "===")  isBreak = TRUE; END;

      IF((BKI_ABR == "ИДБЛОК") AND (ReadByBlock) AND (OLD_ABBR != "@@@"))
          // ЗАПОМИНАЕМ ТЕКУЩИЙ БЛОК
          Report.ReadByBlockABBR = BKI_ABR;
          Report.ReadByBlockVAL  = ABR_VALUE;
          return TRUE;
      END;

      IF (not isBreak)
          IF (Index(Report.curBlockName,"Блок ") > 0 )
              Report.AddData(BKI_ABR,"",ABR_VALUE,Undef,Report.curBlockName);
          ELSE
              Report.AddData(BKI_ABR,"",ABR_VALUE);
          END;
          MSG_IN_BLOCK = MSG_IN_BLOCK + 1;
          Stat = true;
      END;
   END;

   // ПРОВЕРКА ЦЕЛОСТНОСТИ ТФ
   IF (((not isBreak) AND (not Stat)) OR // Неожиданный конец файла
       ((BKI_ABR == "===") AND (Report.TOTAL_MSG_COUNT == 0 ))) // НИ ОДНОГО БЛОКА
       Report.GlobalErr = "Нарушена целостность ТФ";
       Report.Invalid_TR_File_DATA = TRUE;
       Stat = TRUE;
   END;


   Report.ReadByBlockABBR = "";
   Report.ReadByBlockVAL  = "";
   RETURN Stat;
END;

MACRO ПроверкаОдногоТФ(НомерБКИ, Путь, ИмяФайла)
   var Report :DataCheckerReporter;
   var isBreak:BOOL = FALSE;
   var TOTAL_MSG:INTEGER,CUR_MSG:INTEGER;
   FILE TF_File () TXT;
   VAR  PATH;
   VAR  valStr;

   TOTAL_MSG = CUR_MSG = 0;

   PATH = Путь + "\\" + ИмяФайла;

   IF (NOT OPEN(TF_File, PATH))
      RETURN FALSE;
   END;

   lbki.rec.BkiID = НомерБКИ;
   IF (NOT lbki.GetEQ())
      LoansError("Не найдено БКИ №"+НомерБКИ);
      RETURN FALSE;
   END;

   ltr_file.rec.TFID = CRSDCommand("SELECT T_TFID FROM DLTR_FILE_DBT WHERE T_FILENAME = ?","FileName",ИмяФайла,V_INTEGER);
   IF (NOT ltr_file.getEQ())
      LoansError("Не найдена запись о создании транспортного файла: "+ИмяФайла);
      RETURN FALSE;
   END;

   SetDelim(":", TF_File);

   Report.CheckBKI_TF(); // Означает что будем проверять файлы БКИ (В сообщениях об ошибке будет фигурировать АББРЕВИАТУРА БКИ)
   РегистрацияПроверяемыхПараметров(@Report);



   [ Протокол проверки ТФ #]
   (Путь+" "+ИмяФайла);
   [ Дата Проверки  ######################]
   ({curdate});
   [ # ](" ");[ # ](" ");

   // Читаем загловок
   Report.Clear(TRUE);
   ЗаполнитьДаннымиИзТФ(@TF_File,@Report,TRUE,TRUE);
   Report.CheckAllParams("Заголовок");
   TOTAL_MSG = Report.GetData("ЧИСЛСООБ");
   IF (VALTYPE(TOTAL_MSG) == V_UNDEF)
          TOTAL_MSG = 0;
          Report.GlobalErr = "Нарушена целостность ТФ";
          Report.Invalid_TR_File_DATA = TRUE;
          isBreak = TRUE;
   END;
   TOTAL_MSG = TOTAL_MSG + 1;
   InitProgress (TOTAL_MSG, "~Alt-Break~ - прервать", "Проверка ТФ");

   IF (not Report.Invalid_TR_File_DATA)
   Report.WriteReport("Заголовок");
   ELSE
        [ ###########################################################################]
        (Report.GlobalErr);
        [ # ](" ");
        Exit;
   END;
   
   Report.Clear();
   While((ЗаполнитьДаннымиИзТФ(@TF_File,@Report,TRUE)) AND (not isBreak));
     IF (not Report.Invalid_TR_File_DATA) // АССД проверка "ЦЕЛОСТНОСТИ ТФ"
        Report.FillCommonDataFromParams(Report.curBlockName);
     ELSE
        isBreak = TRUE;
     END;
     IF (not Report.Invalid_TR_File_DATA)
         Report.CheckAllParams(Report.curBlockName); /// <- Для того чтобы все задышало! нужно в этой функции заполнить все данные которых у нас нет!
         // Для этого нужна будет функция которая получает определенные параметры и задает EXT параметры другим параметрам
         Report.WriteReport(Report.curBlockName);
     ELSE
        valStr = Report.GetData("","Пользовательский номер");
        IF ((VALTYPE(valStr) != V_UNDEF) AND (valStr != "Undefined"))
        [ Договор #############################################]
            (valStr);
        END;
        [ ###########################################################################]
        (Report.GlobalErr);
        [ # ](" ");
        Exit;

     END;
     // Очищаем только если был конец сообщения
     IF (Report.LST_READ_ABBR == "@@@")
        // ПРОВЕРКА ЦЕЛОСТНОСТИ ТФ перед очисткой текущего сообщения
        Report.FillCommonDataFromParams("ЦЕЛОСТНОСТЬ");
        IF (not Report.Data.КОНТРОЛЬ_БЛОКОВ_ПРОЙДЕН)
            [ ###########################################################################]
            (Report.GlobalErr);
            IF (not Report.Invalid_TR_File_DATA) Report.GlobalErr = ""; END; // Очищаем, если не критично
            Report.GetEnErrorInMassge = TRUE;
        END;
        // 151081 
        IF (Report.НайданоПовторениеДатДан408)
          Report.GlobalErr = "Неправильное количество блоков 408";
          [ # ](" ");
          [ ###########################################################################]
          (Report.GlobalErr);
          [ # ](" ");
          Report.GetEnErrorInMassge = TRUE;
        END;
        // Общий итог ( если не было ошибок, то сказать об этом )
        Report.WriteReport();
        Report.Clear();
        CUR_MSG = CUR_MSG + 1;
        UseProgress (CUR_MSG);
     ELSE
        Report.ClearBlock(Report.curBlockName);
     END;
   END;
   RemProgress();

   IF (NOT CLOSE(TF_File))
      RETURN FALSE;
   END;


   RETURN TRUE;

END;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MACRO ПроверкаТФ(НомерБКИ, Путь, ИмяФайла)
  var DirList,i,ChekDirPath;

  IF (ИмяФайла == "")
      ChekDirPath = Путь+"\\*.*";
      DirList = TDirList (ChekDirPath,"f");
      i = 0;
      WHILE(i < DirList.Count)
         if (not DirList.isDir (i))
            ПроверкаОдногоТФ(НомерБКИ, Путь, DirList.name(i));
         end;
         i = i + 1;
      END;
  ELSE
      ПроверкаОдногоТФ(НомерБКИ, Путь, ИмяФайла);
  END;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////-=[END OF: ПроверкаТФ ]=-/////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// DEBUG ONLY
// DEBUG ONLY
// DEBUG ONLY
// DEBUG ONLY
MACRO TestASSD();
   VAR RSDcmd;
   VAR Sum;
   RSDcmd = RsdCommand(RslDefCon, "begin rso_lns_assd.test_bki; end;");
   RSDcmd.execute();
   
   TableView("dnbki_tmp");
END;