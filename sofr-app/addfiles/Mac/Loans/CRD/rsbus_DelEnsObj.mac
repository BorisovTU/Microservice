/*-------------------------------------------------------------------------------------
Filename    : rsbus_DelEnsObj.mac                                              
Description : Сервис "Удалить предмет залога (входящий)" 

Programmer  : Shershnev Victor
23.03.12    : Создан
---------------------------------------------------------------------------------------*/

import Total, SbCrdInter, "rsbus_synchEnsObj", "rsbus_check","rsbus_checkusr.mac";
//номер сервиса согласно списоку сервисов описананых в rsbus_checkusr.mac
private const NumServ:integer = NumServ_DelEnsZalogObject;

private var arrID=TArray(TEnsObjReqInfo); ///задаем место для хранения ОО
 
//Список глобальных переменных
var crID:integer, crNum:string, conID:integer,conNum:string, EnsObjReqBuf:TEnsObjReqInfo;
private var ErrManager:CErrManager; 

private record crdRec(credit_c);
private record ensRec(enscontr);
private record ensObjRec(ensobj);
var eob =Tbfile("ecn_eob.dbt","W");
var over =Tbfile("eoverval.dbt","W");
var type =Tbfile("lufotype.dbt","W");
var value=Tbfile("lufvalue.dbt","W");
//var ensContr=Tbfile("ENSCONTR.dbt","W");
var ensCRD=Tbfile("ens_crd.dbt","W");  

               

//=======================================================================================
/* Проверка переданных данных по объекту договора обеспечения */
//=======================================================================================
Macro CheckValue()
   var rs;
   var EnsSysType;

   //Проверяем кредитный договор 
   FindCrd(@crID, crNum, crdRec);
     
   //Проверяем договор обеспечения
   if ((conID==NULL) AND (conNum==NULL)) 
      RunError("Договор залога не задан", 18601);
   end;

   if (conID!=NULL)
      if (NOT Loans_FindEnsContract (conID, ensRec))     
         RunError("Договор залога не найден", 18602);
      end;
      
      EnsSysType = CRSDCommand("select t_SysTypeEnsID_Ref from dtype_ens_dbt where t_TYPEENSID = "+ensRec.EnsSysType, V_INTEGER);
      if ( NOT((EnsSysType == 3) OR (EnsSysType == 4)))
         RunError("Недопустимый системный тип обеспечения", 18709);
      end;

      ensCRD.Clear();
      ensCRD.KeyNum=0;
      ensCRD.rec.CREDITNUMBER_REF=crID;
      ensCRD.rec.ENSCONTRACTID_REF=conID;
      if (NOT ensCRD.GetEQ())
         RunError("Договор залога не найден", 18602);
      end; 
      conNum=ensRec.ENSCONTRACTNUMBER;


   end;
        
   //если ContractID не найден
   var arrCON=TArray();
   var j=0; 

   if ((conID==NULL) AND (conNum!=NULL))                             
      rs = CRsdCommand("SELECT * "       +
         "FROM DENSCONTR_DBT e "         + 
         "WHERE                  "       + 
         " e.t_EnsContractnumber = ? ",
         "",TRIM(conNum) ,
          V_GENOBJ  );
             
      if (not rs.MoveNext)
         RunError("Договор залога не найден", 18602);
      end;

      arrCON[j]=rs.value("T_ENSCONTRACTid", null, V_INTEGER);
      ///Если полученных вариантов несколько
      while (rs.MoveNext()) 
          j=j+1;
          arrCON[j]=rs.value("T_ENSCONTRACTid", null, V_INTEGER);
      end;
   
      j=0;
      ensCRD.Clear();
      ensCRD.KeyNum=0;
      ensCRD.rec.CREDITNUMBER_REF=crID;
      ensCRD.rec.ENSCONTRACTID_REF=arrCON[j];
      //проверяем все варианты
      while ((NOT ensCRD.GetEQ) AND(arrCON.size()!=1))
         j=j+1;
         ensCRD.rec.ENSCONTRACTID_REF=arrCON[j];
         conID=arrCON[j];
      end;
      if (NOT ensCRD.GetEQ)
         RunError("Договор залога не найден", 18602);
      end;

      conID=arrCON[j];
  
   end;
  
   if (NOT Loans_FindEnsContract (conID, ensRec))     
         RunError("Договор залога не найден", 18602);
      end;
    EnsSysType = CRSDCommand("select t_SysTypeEnsID_Ref from dtype_ens_dbt where t_TYPEENSID = "+ensRec.EnsSysType, V_INTEGER);
      if ( NOT((EnsSysType == 3) OR (EnsSysType == 4)))
         RunError("Недопустимый системный тип обеспечения", 18709);
      end;
                                               
   //Проверяем наличие ОО
   if (EnsObjReqBuf.EnsObjectID!=NULL)
      if ((Loans_FindEnsObject (EnsObjReqBuf.EnsObjectID,ensObj)))                
         //Проверяем принадлежит ли ОО данному ДО
         rs = CRsdCommand("SELECT * "
             "FROM DECN_EOB_DBT t "+ 
             "WHERE               "+ 
             " t.t_ensobjectid_ref = ?  ", 
             "", EnsObjReqBuf.EnsObjectID,
             V_GENOBJ );
                               
         if (not rs.MoveNext)
            RunError("Объект обеспечения не найден", 18641);                                
         end;
                                     
         if (rs.value(0)==conID)
            //ОО найден и принадлежит текущему договору
         else
            RunError("Объект обеспечения не найден", 18641);
         end;

      end;
                  
   end; 
 
   if (EnsObjReqBuf.EnsObjectID!=NULL)
      if (NOT(Loans_FindEnsObject (EnsObjReqBuf.EnsObjectID,ensObj)))
         RunError("Объект обеспечения не найден", 18641);
      end;
   end;

   var arrENS=TArray();
   var k=0;        
   //если не задан EnsObjectID и задан EnsObjReqInfo.EnsObjectName
   if ((EnsObjReqBuf.EnsObjectID==NULL) AND (EnsObjReqBuf.EnsObjectName!=NULL))
      rs = CRsdCommand("SELECT *"
                      "FROM DENSOBJ_DBT t "     + 
                      "WHERE                   "+ 
                      " t.t_ensobjectname = ?  ", 
                      "",TRIM(EnsObjReqBuf.EnsObjectName) ,
                      V_GENOBJ);
      if (not rs.MoveNext)
         RunError("Объект обеспечения не найден", 18641);
      end;

      arrENS[k]=EnsObjReqBuf.EnsObjectID=rs.value("T_ENSOBJECTID", null, V_INTEGER);
      ///Если полученных вариантов несколько
      while (rs.MoveNext()) 
         k=k+1;
         arrENS[k]=rs.value("T_ENSOBJECTID", null, V_INTEGER);    
      end;
   
      k=0;
      eob.Clear();
      eob.KeyNum=0;
      eob.rec.ENSCONTRACTID_REF=conID;
      eob.rec.ENSOBJECTID_REF=arrENS[k];
      //проверяем все варианты
      while ((NOT eob.GetEQ) AND(arrENS.size()!=1))
         k=k+1;
         eob.rec.ENSOBJECTID_REF=arrENS[k];
         EnsObjReqBuf.EnsObjectID=arrENS[k];
      end;
      if (NOT eob.GetEQ)
         RunError("Объект обеспечения не найден", 18641);
      end;
 
   end;  
     
 onError(err)
      RunError(err.Code,err.Message);
end;

//======================================================================================
/* Удаление объекта(ов) договора обеспечения */
//======================================================================================
Macro TrnDeleteValue() 
   var typearr=TArray();
   var EO = TEnsObjReqInfo();
   var i=0;
        
   if (EnsObjReqBuf.EnsObjectID!=NULL)
      arrID[arrID.size] = EnsObjReqBuf;
      DeleteEnsObject(EnsObjReqBuf.EnsObjectID);
   end; 
 
   if ((EnsObjReqBuf.EnsObjectID==NULL) AND (EnsObjReqBuf.EnsObjectName!=NULL))
      var arrENS=TArray();
      var k=0;  
      var rs = CRsdCommand("SELECT *"
                       "FROM DENSOBJ_DBT t "     + 
                       "WHERE                   "+ 
                       " t.t_ensobjectname = ?  ", 
                       "",TRIM(EnsObjReqBuf.EnsObjectName) ,
                       V_GENOBJ);
      if (not rs.MoveNext)
         RunError("Объект обеспечения не найден", 18641);
      end;

      arrENS[k]=EnsObjReqBuf.EnsObjectID=rs.value("T_ENSOBJECTID", null, V_INTEGER);
      ///Если полученных вариантов несколько
      while (rs.MoveNext()) 
         k=k+1;
         arrENS[k]=rs.value("T_ENSOBJECTID", null, V_INTEGER);    
      end;
   
      k=0;
      eob.Clear();
      eob.KeyNum=0;
      eob.rec.ENSCONTRACTID_REF=conID;
      eob.rec.ENSOBJECTID_REF=arrENS[k];
      //проверяем все варианты
      while ((NOT eob.GetEQ) AND(arrENS.size()!=1))
         k=k+1;
         eob.rec.ENSOBJECTID_REF=arrENS[k];
         EnsObjReqBuf.EnsObjectID=arrENS[k];
      end;
      if (NOT eob.GetEQ())
         RunError("Объект обеспечения не найден", 18641);
      end;
      EnsObjReqBuf.EnsObjectID=arrENS[k];
      DeleteEnsObject(EnsObjReqBuf.EnsObjectID);
   end;  

   //Если параметры ОО не указаны, удаляем все ОО
   if ((EnsObjReqBuf.EnsObjectID==NULL) AND (EnsObjReqBuf.EnsObjectName==NULL))
      i=0; 
      eob.Clear();
      eob.KeyNum=0;                                     
      eob.rec.enscontractid_ref=conID;
      eob.rec.ENSOBJECTID_REF=0;
      eob.AddFilter("T_enscontractid_ref=" + conID);  
      var stat=eob.GetGE();
      IF (stat)                   
         eob.Prev();
         WHILE (eob.Next() AND (eob.rec.enscontractid_ref == conID))
         //Заполняем массив ID ОО
           arrID(i) = TEnsObjReqInfo(); 
           arrID(i).EnsObjectID = eob.rec.ensobjectid_ref;
           arrID(i).EnsObjectName = CRSDCommand("select t_ensobjectName from densobj_dbt where t_ensobjectID = "+eob.rec.ensobjectid_ref, V_STRING);
           i=i+1;
         end;
      END;
      eob.DropFilter();

      i=0;
      WHILE (i<arrID.size)
         DeleteEnsObject(arrID(i).EnsObjectID);
         i=i+1;
      end;
   end;

   return true;

OnError(err)
   if (ValType(err.Err) == V_INTEGER)
      var str;
      str = SubStr(err.Message, 26); 
      ErrManager.SetError(err.Err, str);
   end;

end;
//======================================================================================
/* Основная функция вызова */
//======================================================================================
Macro DelEnsZalogObject(CreditID:integer, CreditNumber:string, ContractID:integer, ContractNumber: string, EnsObjReqInfo)
   ///Инициализация данных
   crID=CreditID;
   crNum=CreditNumber;
   conID=ContractID;
   conNum=ContractNumber;
   EnsObjReqBuf.EnsObjectID=EnsObjReqInfo.EnsObjectID;
   EnsObjReqBuf.EnsObjectName=EnsObjReqInfo.EnsObjectName;
        
   CheckValue();///Проверка полученных данных, при необходимости можно отключить, закомментировав эту строку

   // Если нужно, то проверим пользовательской функцией
   if(NOT skip_user_chec.DelEnsZalogObject)
      if(NOT DelEnsZalogObjectUserCheck(NumServ,crdRec,ensRec,EnsObjReqBuf))
         return 0;
      end;
   end; 
   
   if (RtTRN("TrnDeleteValue")); ///запускаем транзакцию
      Loans_FindCrdContract(crID, crdRec);
      Loans_FindEnsContract(conID, ensRec);
      for (var EO, ArrID)
      EnsObjRec.EnsObjectID = EO.EnsObjectId;
         EnsObjRec.EnsObjectName = EO.EnsObjectName;
         SynchEnsZalogObj(crdRec, ensRec, EnsObjRec, 1);
      end;

      return;
   end;

   if (ErrManager.GetErrCode()!=0)
      ErrManager.RunErr();
   end;
end;

