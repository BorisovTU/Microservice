IMPORT SbCrdInter, LoansFind, total, ActiveX, /*CommonInter,*/ VBAConst/*,"DlRepForm_h.mac"*/;

RECORD revise_rest("revisres", "rtusrmac.lbr") DIALOG;
file   dep( dp_dep );

CONST ESC:integer = 27,
      ENTER:integer = 13,
      F3:integer = 317,
      SPACE:integer = 32,
      F9:integer = 323,
	  ALTF9:integer = 368;

private  var ErrCode, workpath, maska_account;
private ARRAY FL;
private var flag, filial, ialg, xlsrep;
private var opdate;
private var CurrRow;
private var ErrCount;

IF (GetRegistryValue ("RS-LOANS\\СЧЕТА_ДЛЯ_СВЕРКИ", V_STRING, maska_account, ErrCode) != V_STRING)
    msgBox(ErrCode);
    return true;
END;
IF (GetRegistryValue ("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\WORKDIR", V_STRING, workpath, ErrCode) != V_STRING)
    msgBox(ErrCode);
    return true;
END;
                          
MACRO SetFlag(d, f)
    IF (flag == 0)
        flag = 1;
        d(f) = flag;
    ELSE
        flag = 0;
        d(f) = "";
    END;
END;

MACRO DialogMesProc (d, m, f, k)
    IF (m == DLG_INIT)
        d(0) = FL(1);
        d(1) = FL(2);
        d(2) = FL(3);
        d(3) = FL(4);
        d(4) = FL(5);
        UpdateFields(d);
        SetFocus(d, 0);
        RETURN CM_IGNORE;
    ELIF (m == DLG_KEY)
        IF (k == ESC)
            RETURN CM_CANCEL;
        ELIF ((k == ENTER) OR (k == F9))
             maska_account = d(1);
             opdate = d(0);
			 xlsrep = 0;
            RETURN CM_SAVE;
        ELIF (k == F3)
            IF ((FldName(d, f) == "f_filial") AND flag)
               if( ListDepartment( dep ) )
                  filial = dep.Code;
                  d(3)   = /*DL_GetDepartmentNameByCode(*/dep.Name/*)*/ ;
               end;
            END;
            IF (FldName(d, f) == "f_result")
                ialg = list_alg( 1045 );
                if ( not ialg)
                    d(4) = "Протокол (только расхождения)";
                else
                    d(4) = "Отчет (все счета)";
                end
            END;
        ELIF (k == SPACE)
            IF (FldName(d, f) == "f_flag")
                SetFlag(d, f);
            END;
		ELIF (k == ALTF9)
			maska_account = d(1);
            opdate = d(0);
			xlsrep = 1;
            RETURN CM_SAVE;
        END;
    ELSE
        RETURN CM_DEFAULT;
    END;
END;

MACRO GetParam()
    ialg = 0;
    filial = 0;
	xlsrep = 0;
    flag = 0;
    opdate = {curdate};
    FL(1) = opdate;
    FL(2) = maska_account;
    FL(3) = "";
    FL(4) = "";
    FL(5) = "Протокол (только расхождения)";
    IF ( NOT RunDialog (revise_rest, "DialogMesProc"))
        Exit(1);
    END;
END;

MACRO PrintHead()
	if (xlsrep)
		if (NOT NewExcelWorkbook (false , "Revise.xls")) return; end;
		ActiveSheet.Cells (1, 2).Value = DateToStringShort (opdate);
		ActiveSheet.Cells (1, 4).Value = CRSDCommand ("SELECT T_NAME FROM DDP_DEP_DBT WHERE T_CODE = ?", "code", filial, V_STRING);
		CurrRow = 4;
	else
[];
[];
[];
[                         Сверка остатков за ##########  по филиалу](opdate);
		[----------------T-------------------------T----------------T-----------------T-------------------------------------------┐];
		[│ Подразделение │     Номер счета         │  Остаток, руб. │    Остаток      │   Сообщение об ошибке                     │];
		[│ ТС            │                         │                │ в RS-Loans, руб.│                                           │];
		[+---------------+-------------------------+----------------+-----------------+-------------------------------------------+];
	end;
	ErrCount = 0;
END;

Macro PrintBody(depart, Account, Rest1, Rest2, State)                             
	if (xlsrep)
		ActiveSheet.Cells (CurrRow, 1).Value = CRSDCommand ("SELECT T_NAME FROM DDP_DEP_DBT WHERE T_CODE = ?", "code", depart, V_STRING);
		ActiveSheet.Cells (CurrRow, 2).Value = Account;
		ActiveSheet.Cells (CurrRow, 3).Value = Rest1;
		ActiveSheet.Cells (CurrRow, 4).Value = Rest2;
		ActiveSheet.Cells (CurrRow, 5).Value = State;
		CurrRow = CurrRow + 1;
else 
		[│ ############  │#########################│################│#################│###########################################│]
(LnSelectValue("SELECT T_NAME FROM DDP_DEP_DBT WHERE T_CODE = " + depart, V_STRING), Account, Rest1, Rest2, State);
end;
END;

Macro PrintLegs()
var Range;
	if (xlsrep)
		Range = "A4:E"+String (CurrRow-1);
		ActiveSheet.Range (Range).Select;
		ExcelApplication.Selection.Borders (xlEdgeLeft).LineStyle       = xlContinuous;
		ExcelApplication.Selection.Borders (xlEdgeTop).LineStyle        = xlContinuous;
		ExcelApplication.Selection.Borders (xlEdgeBottom).LineStyle     = xlContinuous;
		ExcelApplication.Selection.Borders (xlEdgeRight).LineStyle      = xlContinuous;
		ExcelApplication.Selection.Borders (xlInsideVertical).LineStyle = xlContinuous;
		ActiveSheet.Range ("A1").Select;
		ExcelApplication.Visible = true;
	else
		[L---------------+-------------------------+----------------+-----------------+--------------------------------------------];
	end;
END;
	
MACRO Operation()
var Mask:string = "";
var query:string = "";
var err_str:string = "";
var position:integer = 0;
var variant_maska:string = "";
var ostatok_maska:string = "", strnnn:string = "";
var i:integer = 0; 
var ratecb:integer = 1;
var rs = NULL, rs2 = NULL, sbacc = NULL, turnacc= NULL;
var RSDcmd;
	
Var Account:string = "",
AccountLoans:string = "",
curcode:integer = 0,
chapter:integer = 0,
state:string = "",
rest: money = $0.0,
restloans: money = $0.0,
sbacc_count:integer = 0,
branch:integer = 0,
loansaccclose:bool = true;
var opdatestr:string = "";
if (strlen(maska_account) != 0)
       ostatok_maska = StrSubst ( maska_account, "*", "%" );
END;
	
while ((position = Index ( ostatok_maska, "," )))
       variant_maska = SubStr(ostatok_maska, 1, position - 1);
       ostatok_maska = SubStr(ostatok_maska, position + 1);
       if ( NOT i)
              query = query + " (T_Account Like ('" + variant_maska + "')";
       else 
              query = query + " OR T_Account Like ('" + variant_maska + "')";
       end;
       i = i + 1;
end;
if (i)
       query = query + " OR T_Account Like ('" + ostatok_maska + "')";
       query = query + " )";
else 
       query = " T_Account Like ('" + ostatok_maska + "')"; 
end;
if (filial)
       if (query != "")
       query = query + "  AND T_Department = " + filial;
       else
       query = query + " T_Department = " + filial;
       end;
end;
	
if (query == "")
       query  = "from V_RSLNS_ODBAccount " + query + " Order by T_OPEN_CLOSE";
else 
       query  = "from V_RSLNS_ODBAccount where " + query + " Order by T_OPEN_CLOSE";
end;
	
//LnSqlExec("INSERT INTO DRSVOXPRMVALUES_DBT (T_PRMID, T_PRMNAME, T_PRMVAL) VALUES (1, 'EndDate', UTL_RAW.CAST_TO_RAW('" + opdate +"'))");
LnSqlExec ("begin RSVOXPRM.SETPRMVAL ('EndDate', UTL_RAW.CAST_TO_RAW('" + opdate + "')); end;");
PrintHead();
opdatestr = string(opdate);
if  (LnSelectValue("select count(*) " + query, V_INTEGER))
       rs = LnGetRecordSet("select T_ACCOUNT, T_CURCODE, T_CHAPTER, T_BRANCH, DECODE (T_OPEN_CLOSE, CHR(0), 'О', T_OPEN_CLOSE) as A_OPEN_CLOSE, T_REST " + query);
       if(rs != NULL)
       while (rs.MoveNext())
              Account  = rs.Value("t_account", NULL, V_STRING);
              curcode  = rs.Value("t_curcode", NULL, V_INTEGER);
              chapter  = rs.Value("t_chapter", NULL, V_INTEGER);
              branch   = rs.Value("t_branch", NULL, V_INTEGER);
              state    = rs.Value("a_open_close", NULL, V_STRING);
              rest     = rs.Value("t_rest", NULL, V_MONEY); //4.1.1
		err_str  = "";
              if (state != "З") //Если счёт открыт
				//Выбираем счета лоанса, соответств. счёту ОДБ  4.1.2
			sbacc = LnGetRecordSet("select * from dsb_acc_dbt where t_odbaccount = '" + Account + "' and t_istechaccount != " + "'X'");
			sbacc_count = LnSelectValue("select count(*) from dsb_acc_dbt where t_odbaccount = '" + Account + "' and t_istechaccount != " + "'X'", V_INTEGER);
			restloans = 0.0;
			loansaccclose = true; 
			if (sbacc != NULL)
	                   	while (sbacc.MoveNext())
					if(sbacc.Value("t_accountstate", NULL, V_STRING) != "З")
					  	loansaccclose = false; //Есть открытые счета
				    	end;
			
      					IF ( sbacc.Value("t_curcode", NULL, V_INTEGER) > 0)    //Определим ставку для нерублёвого счёта
         					RSDcmd = RsdCommand(RslDefCon, "begin ? := LoansKernel.RateCB(?,?); end;");
         					RSDcmd.addParam("retval",  RSDBP_RETVAL, V_NUMERIC);
         					RSDcmd.addParam("cbdate",  RSDBP_IN); RSDcmd.value("cbdate")  = opdate;
         					RSDcmd.addParam("curcode", RSDBP_IN); RSDcmd.value("curcode") = sbacc.Value("t_curcode", NULL, V_INTEGER);
         					RSDcmd.execute();
         					ratecb = RSDcmd.Value(0);
					else
						ratecb = 1;
      					END;
					
					AccountLoans = sbacc.Value("t_accountnumber", NULL, V_STRING);
					turnacc= LnGetRecordSet("select t_turnoverrest from dturn_acc_dbt where t_accountnumber_ref = '"+ AccountLoans + "' and t_turnoverdate < to_date('" + opdatestr + "','dd.mm.yyyy') order by t_turnoverdate desc ");
					if (turnacc!= NULL)
                     	    	  	if (turnacc.MoveNext())
							restloans = restloans + turnacc.Value("t_turnoverrest", NULL, V_MONEY) * ratecb;	//Посчитали остатки по счетам Лоанса 4.1.3
						end;
					end;
				end;//конец цикла по счетам лоанса
			end;
			
                     if((rest != restloans) and (sbacc_count != 0))     
			  	err_str = "Расходятся остатки по счетам в ГК и Loans";
			end;
			
			if( (rest != 0) and (sbacc_count == 0))
				err_str = "Счёт в Loans не найден";
  		 	end;
							
			if((rest != 0) and (loansaccclose == true) and (sbacc_count !=0))
				err_str = "Счёт в Loans закрыт";
			end;
		 else   //Если счёт ОДБ закрыт                                    
				//Выбираем счета лоанса, соответств. счёту ОДБ  4.1.2
				sbacc = LnGetRecordSet("select * from dsb_acc_dbt where t_odbaccount = '" + Account + "' and t_istechaccount != " + "'X'");
				sbacc_count = LnSelectValue("select count(*) from dsb_acc_dbt where t_odbaccount = '" + Account + "' and t_istechaccount != " + "'X'", V_INTEGER);
				loansaccclose = true; 
				if (sbacc != NULL)
	                   		while (sbacc.MoveNext())
						if(sbacc.Value("t_accountstate", NULL, V_STRING) != "З")
					  		loansaccclose = false; //Есть открытые счета
				    		end;
					end;//конец цикла по счетам лоанса
				end;
				if((loansaccclose == true) and (sbacc_count !=0))
					err_str = "Счёт в ГК закрыт, счёт в Loans не закрыт";
				end;					
		 end;    //конец проверки счёт открыт/закрыт

			if(ialg == 0)
				if(err_str != "")
					PrintBody(branch, Account, rest, restloans ,err_str);
				end;
			else 
				PrintBody(branch, Account, rest, restloans ,err_str);
			end;
		end;	//Конец цикла по счетам ОДБ
			
		PrintLegs();
		if (xlsrep)
			return 1;
		end;
	end; //конец if(rs != NULL) 
end; //конец if есть счета одб
end;       //конец макро
			
/*ТОЧКА ВХОДА*/
GetParam();
Exit(Operation());