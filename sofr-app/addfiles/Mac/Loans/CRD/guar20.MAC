/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : guar20.mac
 Description : Создание документа по шагу операции
               восстановление резерва по РВП

 Programmer  : KOE
 11.08.05    : Создан
------------------------------------------------------------------------------*/
import SbCrdInter, Total;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record Сумма       ("SUM.",         "loans.def");
record Портфель    ("lbrfcase.dbt", "loans.def");     /* Портфель             */
record ВидКредита  ("type_crd.dbt", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data, mbperc, ObjectID)
    VAR DocID      : integer = 0,
        stat       : integer = 0,
        P          : moneyl  = $0,
        S1         : moneyl  = $0,
        Sr         : moneyl  = $0,
        РВП        : doublel = 0.0,
        КурсЦБ     : doubleL = 1.0;

   setbuff(Сумма, Sum);

   Sr = Сумма(1);
   /* Элемент расчетной базы         */
   // P = ОстатокНаРегистре(ObjectID, Договор.CreditNumber, Договор.PayType, OperDate);

   S1 = ОстатокРегистра(ObjectID, Договор.CreditNumber, TREG_REZ232, OperDate);
   // РВП  = ГруппаРиска (ObjectID, Договор.CreditNumber, REZ_RVP, OperDate, 1)/100;

   // IF (Договор.CurCode != 0)
   //    КурсЦБ = GetRate(OperDate, Договор.CurCode);
   //    IF (КурсЦБ == 0)
   //       MsgBox("Курс валюты не определен!");
   //    END;
   // END;

   // Sr = КурсЦБ * РВП * P;

   IF (S1 > Sr)
      Документ.CarrySum = S1 - Sr;
      Документ.CurCode  = 0;
      stat = СоздатьДокумент(Документ, DocID);
      IF (stat == 0)
         stat = ИзменитьРегистр(ObjectID, Договор.CreditNumber, TREG_REZ232, DocID, -Документ.CarrySum);
      END;
   END;
   RETURN stat;
END;