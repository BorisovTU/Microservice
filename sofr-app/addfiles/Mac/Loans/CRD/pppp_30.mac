/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : pppp_30.mac
 Description : Создание документа по шагу операции (Учет начисленного дисконта)

 Programmer  : Zigel Petr
 07.10.08    : Создан
-----------------------------------------------------------------------------------*/

import SbCrdInter, LoansFind;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record RezData     ("rezdata.tmp",  "loans.def");
record AcCrd       ("acc_crd.dbt",  "loans.def");
record Портфель    ("lbrfcase.dbt", "loans.def");
record Сумма       ("SUM.",         "loans.def");

private var {ФИЛИАЛ};

macro ВыполнитьШаг (OperDate, Sum, Data)
   var DocID : integer = 0;
   var stat  : integer = 0;

   setbuff(Сумма, Sum);

   // КД приобретен с дисконтом
   if (Сумма(0) < 0)
      Документ.CarrySum = - Сумма(0);
      stat = СоздатьДокумент(Документ, DocID);

      if (stat == 0)
         stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_CHARGE_DISCONT, DocID, Документ.CarrySum);
      end;
      
      if (stat == 0)
         stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_ACQCRD, DocID, Документ.CarrySum);
      end;
   end;

   return stat;
end;
