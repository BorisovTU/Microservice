/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ins_ens.mac
 Description : Создание документа по учету обеспечения

 Programmer  : ROV
 11.09.98    : Создан
 29.12.2012  : Добавлен вывод основания документа при принятии обеспечения (SHAN)
-----------------------------------------------------------------------------------*/
import SbCrdInter, Total;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");
record EnsData     ("ensdata.dat",  "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
   setbuff(EnsData, Data);
     
   if (((EnsData.GuaranteeCode != Поручительство) AND (EnsData.GuaranteeCode != Гарантия_Обеспечение)) or
       ((EnsData.GuaranteeCode == Поручительство) and (EnsData.GuaranteeSum < $0)) OR
       ((EnsData.GuaranteeCode == Гарантия_Обеспечение) and (EnsData.GuaranteeSum < $0))
     )
      return 0;
   end;
   
   var isCur = "chr(0)", sql = ""; 
   if ((Документ.CurCode == Документ.CurCodeCredit))
      if (NOT (Документ.CurCode == 0))
         isCur = "'X'";  // иностр. валюта
      end; 
   else
      isCur = "'M'";    // мультивалют
   end;
   sql = "SELECT t_ground FROM DSTEPPARM_DBT WHERE t_stepid_ref = " + ШагОперации.StepID + " AND t_iscur = " + isCur;   

   Документ.Ground   = LnSelectValue(sql, V_STRING); 
   Документ.CarrySum = EnsData.GuaranteeSum;

   ИзменитьРегистр(LO_ENSCONTR, Операция.OBJECTID_REF, TDR_CHANGESUM_ENS_HIST, 0, Документ.CarrySum);
   return СоздатьДокумент(Документ);
end;
