/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : prn_oper.mac
 Description : Печать WORD- и EXCEL-документов для операции по кредитному договору

 Programmer  : SAE
 30.11.00    : Создан
------------------------------------------------------------------------------*/

IMPORT ActiveX, total, LoansFind, SbCrdInter, BankInter,cryptdlm, global, dlwreps, replib;;


private FILE Договор   ("credit_c.dbt", "loans.def");
private FILE ВидКредита("type_crd.dbt", "loans.def");
private FILE CrdOp     ("crd_op.dbt",   "loans.def");       /* Операции по договору */
private FILE CopStage  ("copstage.dbt", "loans.def")key 0;
private FILE step_op   ("step_op.dbt",  "loans.def") key 0;
private FILE person    ("person.dbt",   "sbbank.def") key 0;
private FILE type_op   ("type_op.dbt",  "loans.def") key 1;
private FILE crdacc    ("igCrdAcc.dbt", "loans.def") key 0;
private FILE igsetacc  ("igSetAcc.dbt", "loans.def") key 0;

private record dutycrd ("duty_crd.dbt", "loans.def");

private var РасчетныйДляВыдачи = "", СсудныйСчет = "", OperSysType = 0, ИмяБанка = "", {GROUP_MODE};
private VAR DatePay,DateCreatePay;

private CONST /* Шаблон документа */
   ЗаявлениеНаПеречисление    = "ZvlPay01.dot"; /* Заявление на перечисление */

private var {oper};
/*
   Вызывается по CTRL-F7 из скроллинга операций
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   Входные параметры:
      OperationID - ID операции
*/
macro СтрокаСПробелами(str, num)
VAR i = 1;
VAR str1 = "";
    while(i<=(num-strlen(str)))
        str1 = str1 + StrFor(32);
        i = i+1;
    end;
    return str1;
end;

macro Common()
    DateCreatePay = {curdate};
    DatePay = crdop.CredOperDate;

    if(NOT {GROUP_MODE})
        if(GetDate(DateCreatePay, "Введите дату распоряжения") == FALSE)
            Exit(0);
        end;
    end;

    CopStage.CredOperID_Ref = crdop.CredOperID;
    CopStage.StageID_Ref = 99;
    CopStage.Date = date(0,0,0);
    if (not(GetGE(CopStage) and (CopStage.CredOperID_Ref == crdop.CredOperID) and (CopStage.StageID_Ref == 99)))
        DatePay = DateCreatePay;
        if (GetDate(DatePay, "Введите дату оформления") == FALSE)
            return false;
        end;
    end;
end;

macro CreateOperationDoc (OperationID)
   VAR   ФИО, CrdNum, CrdDate, ДатаНачалаДействияЛимита = date(0,0,0);
   VAR   PayOffPenny1:money = $0, PayOffPenny2:money = $0, PayOffDeligPercents:money = $0;
   VAR   PayOffDeligSum:money = $0, PayOffChargedPercents:money = $0, PayOffSum:money = $0;
   VAR   Acc1, Acc2, Acc3, Acc4, Acc5, Acc6;
   VAR   RateID:integer = 0, Ставка = 0.0;
   VAR   sum_:money = $0, СуммаОперации = $0, PaySum_:money = $0, RestNoPay_:money = $0;
   VAR   BegDate:date, ПлановаяДатаПогашения:date;
   VAR   query:String;
   VAR   Pay, AccBankName;
   VAR   i = 0, j = 0, k = 0;
   VAR   {ФИЛИАЛ};
   VAR   Err, TxtDir;
   VAR   NameFile = "", НазваниеОперации = "", Счет = "", НомерДоговора = "", Тип_Кода = 0, Код = "";
   VAR   PayOp    = TRecHandler ("lpayop.dbt",  "loans.def");
   VAR   AcCrd    = Tbfile("acc_crd.dbt",  "R", 1, "acc_crd.dbt",  "loans.def");
   VAR   DocAcc   = Tbfile("doc_acc.dbt",  "R", 7, "doc_acc.dbt",  "loans.def");
   VAR   LimHis   = TRecHandler ("chlimhis.dbt",  "loans.def");
   VAR   ext = "000", cnum;
   VAR   cryptoAPI = RsCryptoAPI( );
   file  prnoper() txt write;
   ARRAY str, ТипОбеспечения, ДатаОбеспечения, ДоговорОбеспечения, Поручитель;
   var   RepMenu = Tarray, RepType = 0, Count = 0;
   var   RSDcmd = NULL;
   var   rs = NULL;

   GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR",V_STRING, TxtDir, Err);
   person.Oper = {oper};
   if (not GetEQ(person))
       MsgBox ("ОШИБКА: не найден пользователь = "+{oper});
       return false;
   end;

   /* Поиск операции */
   ClearRecord (CrdOp);
   CrdOp.CredOperID = OperationID;
   if (NOT GetEQ (CrdOp))
      MsgBox ("ОШИБКА: не найдена операция по договору ID="+OperationID);
      return false;
   end;

   OperSysType = 0;
   ClearRecord(type_op);
   type_op.TypeOperNumber = crdop.OperTypeNumber_Ref;
   if (GetEQ(type_op))
      OperSysType = type_op.SystTypeOp_Ref;
      НазваниеОперации = type_op.TypeOperName;
      if(type_op.SystTypeOp_Ref == CS_PAY)
         if(Loans_FindPayOp(crdop.CredOperID, PayOp))
             СуммаОперации = PayOp.rec.PaySum;
         end;
      end;
   end;

   if((OperSysType == CS_PAY) and (crdop.OperTypeNumber_Ref != 84))
       return true;
   end;

   /* Поиск документа по операции */
   if (not (OperSysType == CS_OPENACC) and not (OperSysType == CS_ACCRESERV) and not (OperSysType == CS_DUTYOPEN))
       ClearRecord(DocAcc);
       DocAcc.AddFilter("t_CredOperID_Ref = " + OperationID +
                        " and t_IsDeleted = " + 0);
       DocAcc.rec.CredOperID_Ref = OperationID;
       DocAcc.rec.IsDeleted = 0;
       if (NOT DocAcc.GetEQ())
          MsgBoxEx ("Нет документов по операции");
          return true;
       end;
       DocAcc.DropFilter();
   end;

   ФИО = "";
   /* Поиск кредитного договора */
   ClearRecord (Договор);
   Договор.CreditNumber = CrdOp.CreditNumber_Ref;
   if (CrdOp.CreditNumber_Ref)
      if (NOT GetEQ (Договор))
         MsgBox ("ОШИБКА: не найден кредитный договор с ID = "+CrdOp.CreditNumber_Ref);
         return false;
      end;
   end;

   if({GROUP_MODE})
       if(strlen(Договор.UsCreditNumber)<=5)
           НомерДоговора = Договор.UsCreditNumber;
       else
           НомерДоговора = SubStr(Договор.UsCreditNumber, strlen(Договор.UsCreditNumber)-5);
       end;
   end;

   if ((OperSysType == CS_OPENACC) OR (OperSysType == CS_DUTYOPEN))
                   
       RepMenu[0] = " Распоряжение на открытие счетов ";
       
       if(Договор.TypeDebtor == 2)
           RepMenu[1] = " Распоряжение на открытие ссудных счетов (ФЛ)";
       else
           RepMenu[1] = " Распоряжение на открытие ссудных счетов ";
       end;

       RepType = Menu(RepMenu, "~ENTER~ выбор, ~ESC~ отмена", " Выберите вид печатной формы: ");

        if(RepType == -2) // RepType == ESC
           return RepType;
       end;

       if(RepType == 1)
           RSDcmd = RsdCommand(RslDefCon,"SELECT count(*) FROM dcat_type_dbt cat, dacc_crd_dbt acc where cat.t_AccCategID = acc.t_AccCategID_Ref" +
                                     " AND cat.t_SysType = ?" +
                                     " and acc.t_CredOperID = ?");
           RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(0) = "С";                     
           RSDcmd.addParam("", RSDBP_IN); RSDcmd.value(1) = crdop.CredOperID;
           rs  = RsdRecordset(RSDcmd);
           RSDcmd.execute;
  
           if ((rs != null) and (rs.MoveNext()) and (rs.value(0, null, V_INTEGER) != null))
               Count = rs.value(0, null, V_INTEGER);
           end;

           if(Count)
               if(Договор.TypeDebtor != 2)
                   return ExecMacroFile ("prduty04", "ПечатьОбязательствоИзОперации", crdop.CreditNumber_Ref, crdop.ObjectID_Ref, crdop.ObjectTypeID_Ref,crdop.CredOperID,crdop.CredOperDate, false, true);
               else
                   return ExecMacroFile ("prduty08", "ПечатьОбязательствоИзОперацииФЛ", crdop.CreditNumber_Ref, crdop.ObjectID_Ref, crdop.ObjectTypeID_Ref,crdop.CredOperID,crdop.CredOperDate, false, true);
               end;
           end;
       elif(RepType == 0)
           return ExecMacroFile("acdecree", "ПечатьРаспоряжениеИзОперации", crdop.CreditNumber_Ref, crdop.ObjectID_Ref, crdop.ObjectTypeID_Ref, crdop.CredOperID, crdop.CredOperDate);
       end;
       return true;
   elif (OperSysType == CS_ACCRESERV)
       return ExecMacroFile ("acc_reserv", "ПечатьИзОперации", crdop.CredOperID);
   end;

   if({GROUP_MODE})
       NameFile = TxtDir + "\\" + НомерДоговора + "_" + string(CrdOp.OperTypeNumber_Ref) + ".txt";
   else
       cnum = String(GetCNum());
       StrSet(ext, (strlen(ext)-strlen(cnum) + 1), cnum);
       NameFile = TxtDir + "\\" + "prn_oper." + ext;
   end;

   ClearRecord (ВидКредита);
   if (CrdOp.CreditNumber_Ref)
      ВидКредита.CreditTypeID = Договор.CreditTypeID_Ref;
      if (NOT GetEQ (ВидКредита))
         MsgBox ("ОШИБКА: не найден вид кредита с ID = "+Договор.CreditTypeID_Ref);
         return false;
      end;
   end;

   if (Depclnt.GetRecord(Договор.ClientID_Ref))
       ФИО = depclnt.ConvertFIOFull;
   end;

   CrdNum = Договор.UsCreditNumber;
   CrdDate = Договор.RegDate;

   OperSysType = 0;
   ClearRecord(type_op);
   type_op.TypeOperNumber = crdop.OperTypeNumber_Ref;
   if (GetEQ(type_op))
      OperSysType = type_op.SystTypeOp_Ref;
   end;

   if((OperSysType == CS_PAY) and (crdop.ObjectTypeID_Ref == LO_DUTY))
       /* Поиск СО */
       if(NOT Loans_FindDuty(crdop.ObjectID_Ref, dutycrd))
           MsgBox ("ОШИБКА: не найдено срочное обязательство с ID = "+ CrdOp.ObjectID_Ref);
           return false;
       end;
   end;

   ClearRecord(AcCrd);
   AcCrd.AddFilter("t_ObjectID = " + crdop.ObjectTypeID_Ref +
                   " and t_ObjectNumber = " + crdop.ObjectID_Ref +
                   " and t_CreditAccountType = " + CRD_ACC +
                   " and t_CurCode = " + Договор.CurCode);
   AcCrd.rec.ObjectID          = crdop.ObjectTypeID_Ref;
   AcCrd.rec.ObjectNumber      = crdop.ObjectID_Ref;
   AcCrd.rec.CreditAccountType = CRD_ACC;
   AcCrd.rec.CurCode           = Договор.CurCode;
   if (GetEQ (AcCrd))
       СсудныйСчет = AcCrd.rec.AccountNumber_Ref;
   end;
   AcCrd.DropFilter;

   if ((OperSysType == CS_DUTY) or // Распоряжение на погашение задолженности
       (OperSysType == CS_EXP)  or // Распоряжение на просрочку
       (OperSysType == CS_PAY)     // Распоряжение на выдачу
      )
       Common();

       if(OperSysType == CS_PAY)
           /* Получить расчетный счет для погашения из СПИ по договору */
           query = " select t_OutCredAccount, T_OUTCREDBANKCODEKIND, T_OUTCREDBANKCODE from ddoc_acc_dbt " +
                   " where t_CredOperID_Ref = " + crdop.CredOperID +
                   " and T_OperTypeNumber_Ref = " + CS_PAY;
           AccBankName = LnGetRecordSet(query);

           if(AccBankName == NULL)
               exit(1);
           end;

           if(AccBankName.moveNext())
               РасчетныйДляВыдачи = AccBankName.Value("t_OutCredAccount", NULL, V_STRING);
               Тип_Кода = AccBankName.Value("T_OUTCREDBANKCODEKIND", NULL, V_INTEGER);
               Код = AccBankName.Value("T_OUTCREDBANKCODE", NULL, V_STRING);
               if(ValType(РасчетныйДляВыдачи) != V_UNDEF)
                   ИмяБанка = LnSelectValue(" SELECT NVL(t_bankname, 0) from Digsetacc_dbt where t_Account = " + SQLString(РасчетныйДляВыдачи));

                   if (ValType(ИмяБанка) == V_UNDEF)
                       ИмяБанка = LnSelectValue(" select party.T_Name from dparty_dbt party, dpartcode_dbt part" +
                                                " where part.T_CodeKind = " + Тип_Кода + " and part.T_code = " + SQLString(Код) +
                                                " and part.T_partyId = party.T_partyId",V_STRING);
                   end;
               end;
           end;

           if(crdop.ObjectTypeID_Ref == LO_CREDIT)
               Ставка = Loans_FindRateVal(LO_CREDIT, Договор.CreditNumber, TRU_CRD, Договор.ReturnDate);
           else
               Ставка = Loans_FindRateVal(LO_DUTY,   dutycrd.DutyID,       TRU_CRD, dutycrd.DutyLastDate, false);
           end;
       end;

       if(OperSysType != CS_PAY)
           query = "select * from DPlanFact_DBT where t_CredOperID_Ref = " + OperationID;
           Pay = LnGetRecordSet(query);
           if(Pay == NULL)
               exit(1);
           end;

           СуммаОперации = 0;

           while(Pay.moveNext())
               if(OperSysType == CS_DUTY)
                   if(Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_EXPDUTYFINE)
                       PayOffPenny1 = Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
                   elif(Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_EXPPERCFINE)
                       PayOffPenny2 = Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
                   elif(Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_EXPPERC)
                       PayOffDeligPercents = Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
                   elif(Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_EXPDUTY)
                       PayOffDeligSum = Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
                   elif((Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_PERC) or
                        (Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_ADDPERC))
                       PayOffChargedPercents = PayOffChargedPercents + Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
                   elif(Pay.Value("T_DUTYSTAGEID_REF", NULL, V_INTEGER) == DS_DUTY)
                       PayOffSum = Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
                   end;
                   СуммаОперации = СуммаОперации + Pay.Value("T_ACTUALAMOUNT", NULL, V_MONEY);
               else
                   PayOffChargedPercents = $0;
                   PayOffSum =$0;
                   СуммаОперации =$0;
               end;
           end;
       end;

       Acc1 = Acc2 = Acc3 = Acc4 = Acc5 = Acc6 = "";
       query = "select t_StepID, t_Credit, t_Debit, t_CarrySum from DDOC_ACC_DBT where t_CredOperID_Ref = " + OperationID +
               " and t_IsDeleted = " + 0;
       Pay = NULL;
       Pay = LnGetRecordSet(query);
       if(Pay == NULL)
           exit(1);
       end;
       while(Pay.moveNext())
           step_op.StepID = Pay.Value("T_StepID", NULL, V_INTEGER);
           if (GetEQ(step_op))
              if(OperSysType == CS_DUTY)
                  if (step_op.StepNumber == 7)
                    Acc1 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif (step_op.StepNumber == 2)
                    Acc2 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif (step_op.StepNumber == 1)
                    Acc3 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif ((step_op.StepNumber == 8) and (Договор.RiskGroup < 2))
                    Acc4 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif ((step_op.StepNumber == 12) and (Договор.RiskGroup >= 2))
                    Acc4 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif (step_op.StepNumber == 6)
                    Acc5 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif ((step_op.StepNumber == 5) and (Договор.RiskGroup < 2))
                    Acc6 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif ((step_op.StepNumber == 10) and (Договор.RiskGroup < 2) and (Acc6 == ""))
                    Acc6 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif ((step_op.StepNumber == 15) and (Договор.RiskGroup >= 2))
                    Acc6 = Pay.Value("T_Credit", NULL, V_STRING);
                  end;
              elif(OperSysType == CS_EXP)
                  if ((step_op.StepNumber == 8) and (Договор.RiskGroup < 2))
                    Acc1 = Pay.Value("T_Debit",  NULL, V_STRING);
                    Acc2 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif ((step_op.StepNumber == 6) and (Договор.RiskGroup >= 2))
                    Acc1 = Pay.Value("T_Debit",  NULL, V_STRING);
                    Acc2 = Pay.Value("T_Credit", NULL, V_STRING);
                  elif (step_op.StepNumber == 4)
                    PayOffChargedPercents = PayOffChargedPercents + Pay.Value("T_CarrySum",  NULL, V_MONEY);
                    СуммаОперации = СуммаОперации + Pay.Value("T_CarrySum",  NULL, V_MONEY);
                  elif (step_op.StepNumber == 3)
                    PayOffChargedPercents = PayOffChargedPercents + Pay.Value("T_CarrySum",  NULL, V_MONEY);
                    СуммаОперации = СуммаОперации + Pay.Value("T_CarrySum",  NULL, V_MONEY);
                  elif (step_op.StepNumber == 1)
                    Acc3 = Pay.Value("T_Debit",  NULL, V_STRING);
                    Acc4 = Pay.Value("T_Credit", NULL, V_STRING);
                    PayOffSum = PayOffSum + Pay.Value("T_CarrySum",  NULL, V_MONEY);
                    СуммаОперации = СуммаОперации + Pay.Value("T_CarrySum",  NULL, V_MONEY);
                  end;
              end;
           end;
       end;

       if(OperSysType == CS_EXP)
           ПлановаяДатаПогашения = date(0,0,0);
           query = "select min(t_PlannedExpDate) from dplanpay_dbt where ";
           query = query + " t_ObjectID_Ref = " + crdop.ObjectID_Ref;
           query = query + " and t_ObjectTypeID_Ref = " + crdop.ObjectTypeID_Ref;
           query = query + " and t_Type = 0";
           query = query + " and t_CredOperID_Ref = LoansUserFunction.GetLastCredOperID_ForPlanPay("+crdop.ObjectTypeID_Ref+","+crdop.ObjectID_Ref+",0)";
           query = query + " and t_PlannedExpDate >= " + SQLDate(crdop.CredOperDate);
           ПлановаяДатаПогашения = LnSelectValue(query, V_DATE);
       end;

       str(i) = "";
       i=i+1;
       str(i) = CONST_NAMEBANK;
       i=i+1;
       str(i) = "                             Р А С П О Р Я Ж Е Н И Е";
       i = i+1;

       if(OperSysType == CS_DUTY)
           str(i) = " на оформление " + DateToStringShort(DatePay) + " бухгалтерскими проводками сумм, поступивших в погашение";
           i = i+1;
           str(i) ="             ссудной задолженности и уплату процентов за пользование кредитом";
           i = i+1;
       elif(OperSysType == CS_PAY)
           str(i) = "                        на перечисление денежных средств";
           i = i+1;
       else
           str(i) = " на оформление " + DateToStringShort(DatePay) + " бухгалтерскими проводками вынесение суммы";
           i = i+1;
           str(i) ="             не поступивших в срок платежей на счета просроченных ссуд";
           i = i+1;
       end;

       str(i) ="";
       i = i+1;
       str(i) = СтрокаСПробелами(DateToStringFull(DateCreatePay), 50) + DateToStringFull(DateCreatePay);
       i = i+1;
       str(i) = "┌─────────────────────────────┬──────────────────────────────────────────────────┐";
       i = i+1;
       str(i) = "│Наименование заемщика        │" + СтрокаСПробелами(Depclnt.Name,50) + Depclnt.Name + "│";
       i = i+1;
       str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
       i = i+1;
       str(i) = "│№ договора                   │" + СтрокаСПробелами(Договор.UsCreditNumber,50) + Договор.UsCreditNumber + "│";
       i = i+1;
       str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
       i = i+1;
       str(i) = "│Дата кредитного договора     │" + СтрокаСПробелами(DateToStringShort(Договор.RegDate), 50) + DateToStringShort(Договор.RegDate) + "│";
       i = i+1;
       str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
       i = i+1;
       str(i) = "│Валюта кредитования          │" + СтрокаСПробелами(FindFullName(Договор.CurCode), 50) + FindFullName(Договор.CurCode)  + "│";
       i = i+1;
       str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
       i = i+1;
       str(i) = "│№ ссудного счета             │" + СтрокаСПробелами(СсудныйСчет, 50) + СсудныйСчет + "│";
       i = i+1;
       str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
       i = i+1;
       if(OperSysType == CS_PAY)
           str(i) = "│№ расчетного счета           │" + СтрокаСПробелами(РасчетныйДляВыдачи, 50) + РасчетныйДляВыдачи + "│";
           i = i+1;
           if(ИмяБанка != "")
               str(i) = "│                             │" + СтрокаСПробелами("в " + ИмяБанка, 50) + "в " + ИмяБанка + "│";
           else
               str(i) = "│                             │" + СтрокаСПробелами("", 50) + "" + "│";
           end;
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
       end;
       if(OperSysType == CS_DUTY)
           str(i) = "│ОПЕРАЦИЯ                     │" + СтрокаСПробелами((НазваниеОперации), 50) + НазваниеОперации + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
       elif(OperSysType == CS_PAY)
           str(i) = "│Дата предоставления средств  │" + СтрокаСПробелами(DateToStringShort(crdop.CredOperDate), 50) + DateToStringShort(crdop.CredOperDate) + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Сумма предоставленных средств│" + СтрокаСПробелами(string(СуммаОперации), 50) + string(СуммаОперации) + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Процентная ставка по договору│" + СтрокаСПробелами(string(Ставка), 50) + string(Ставка) + "│";
           i = i+1;
           str(i) = "│(в % годовых)                │" + СтрокаСПробелами("", 50) + "" + "│";
           i = i+1;
           str(i) = "└─────────────────────────────┴──────────────────────────────────────────────────┘";
           i = i+1;
       else
           str(i) = "│Плановая дата погашения      │" + СтрокаСПробелами(DateToStringShort(ПлановаяДатаПогашения), 50) + DateToStringShort(ПлановаяДатаПогашения) + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
       end;

       if(OperSysType != CS_PAY)
           str(i) = "│Вид кредита                  │" + СтрокаСПробелами(ВидКредита.CreditTypeName,50) + ВидКредита.CreditTypeName + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Дата окончания кредитного    │" + СтрокаСПробелами(DateToStringShort(Договор.ReturnDate), 50) + DateToStringShort(Договор.ReturnDate) + "│";
           i = i+1;
           str(i) = "│договора                     │                                                  │";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Группа риска                 │" + СтрокаСПробелами(string(Договор.RiskGroup), 50) + string(Договор.RiskGroup) + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Сумма платежа, всего         │" + СтрокаСПробелами(string(СуммаОперации), 50)+ string(СуммаОперации) + "│";
           i = i+1;
           str(i) = "│В том числе                  │                                                  │";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────┬───────────────────┤";
           i = i+1;
           if(OperSysType == CS_DUTY)
               if (PayOffPenny1 != 0)
                   str(i) = "│Неустойка за пр. осн. долга  │" + "Кт " + СтрокаСПробелами(Acc2, 27) + Acc2 + "│" + СтрокаСПробелами(string(PayOffPenny1), 19) + string(PayOffPenny1) + "│";
                   i = i+1;
                   str(i) = "├─────────────────────────────┼──────────────────────────────┼───────────────────┤";
                   i = i+1;
               end;
               if (PayOffPenny2 != 0)
                   str(i) = "│Неустойка за просрочку %%    │" + "Кт " + СтрокаСПробелами(Acc3, 27) + Acc3 + "│" + СтрокаСПробелами(string(PayOffPenny2), 19) + string(PayOffPenny2) + "│";
                   i = i+1;
                   str(i) = "├─────────────────────────────┼──────────────────────────────┼───────────────────┤";
                   i = i+1;
               end;
               if (PayOffDeligPercents != 0)
                   str(i) = "│Просроченные %%              │" + "Кт " + СтрокаСПробелами(Acc4, 27) + Acc4 + "│" + СтрокаСПробелами(string(PayOffDeligPercents),19) + string(PayOffDeligPercents) + "│";
                   i = i+1;
                   str(i) = "├─────────────────────────────┼──────────────────────────────┼───────────────────┤";
                   i = i+1;
               end;
               if (PayOffDeligSum != 0)
                   str(i) = "│Просроченные платежи         │" + "Кт " + СтрокаСПробелами(Acc5, 27) + Acc5 + "│" + СтрокаСПробелами(string(PayOffDeligSum), 19) + string(PayOffDeligSum) + "│";
                   i = i+1;
                   str(i) = "├─────────────────────────────┼──────────────────────────────┼───────────────────┤";
                   i = i+1;
               end;
               if (PayOffChargedPercents != 0)
                   str(i) = "│Срочные %%                   │" + "Кт " + СтрокаСПробелами(Acc6, 27) + Acc6 + "│" + СтрокаСПробелами(string(PayOffChargedPercents), 19) + string(PayOffChargedPercents) + "│";
                   i = i+1;
                   str(i) = "├─────────────────────────────┼──────────────────────────────┼───────────────────┤";
                   i = i+1;
               end;
               if (PayOffSum != 0)
                   str(i) = "│Срочные платежи              │" + "Кт " + СтрокаСПробелами(Acc1, 27) + Acc1 + "│" + СтрокаСПробелами(string(PayOffSum), 19) + string(PayOffSum) + "│";
                   i = i+1;
               end;
           else
               str(i) = "│Сумма просрочки по срочным %%│" + "Дт " + СтрокаСПробелами(Acc1, 27) + Acc1 + "│" + СтрокаСПробелами(string(PayOffChargedPercents), 19) + string(PayOffChargedPercents) + "│";
               i = i+1;
               str(i) = "│                             │" + "Кт " + СтрокаСПробелами(Acc2, 27) + Acc2 + "│" + СтрокаСПробелами("", 19) + "│";
               i = i+1;
               str(i) = "├─────────────────────────────┼──────────────────────────────┼───────────────────┤";
               i = i+1;
               str(i) = "│Сумма пр. задолж. по кредиту │" + "Дт " + СтрокаСПробелами(Acc3, 27) + Acc3 + "│" + СтрокаСПробелами(string(PayOffSum), 19) + string(PayOffSum) + "│";
               i = i+1;
               str(i) = "│                             │" + "Кт " + СтрокаСПробелами(Acc4, 27) + Acc4 + "│" + СтрокаСПробелами("", 19) + "│";
               i = i+1;
           end;
           str(i) = "└─────────────────────────────┴──────────────────────────────┴───────────────────┘";
           i = i+1;
       end;
       str(i) = " Прилагаемые документы:";
       i = i+1;
       str(i) = " Платежное поручение №      от";
       i = i+1;
       str(i) = "";
       i = i+1;
       str(i) = " Начальник                                           (Ф.И.О.)";
       i = i+1;
       str(i) = " Исполнитель                                          " +  person.Name;
       i = i+1;
       str(i) ="";

       if({GROUP_MODE})
           Open(prnoper, NameFile);
       end;

       while(j<=i)
           if({GROUP_MODE})
               Insert(prnoper, str(j));
           else
               [ #] (str(j));
           end;
           j = j+1;
       end;

       if({GROUP_MODE})
           Close(prnoper);
       end;
       cryptoAPI.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", NameFile);
   elif (OperSysType == CS_CHANGE_LIM) // Распоряжение на изменение лимита выдачи
       Common();
       if(Loans_FindChangeLimit(crdop.ObjectID_Ref, TDR_LIMPAY, crdop.CredOperDate, LimHis))
           СуммаОперации = LimHis.rec.Rest;
           ДатаНачалаДействияЛимита = LimHis.rec.Date;

           str(i) = "";
           i=i+1;
           str(i) = "                             Р А С П О Р Я Ж Е Н И Е";
           i = i+1;
           str(i) = " на оформление " + DateToStringShort(DatePay) + " бухгалтерскими проводками изменения лимита";
           i = i+1;
           str(i) ="            кредитования по договору об открытии невозобновляемой кредитной линии";
           i = i+1;
           str(i) ="";
           i = i+1;
           str(i) = "┌─────────────────────────────┬──────────────────────────────────────────────────┐";
           i = i+1;
           str(i) = "│Наименование заемщика        │" + СтрокаСПробелами(Depclnt.Name,50) + Depclnt.Name + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│№ кредитного договора        │" + СтрокаСПробелами(Договор.UsCreditNumber,50) + Договор.UsCreditNumber + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│№ ссудного счета             │" + СтрокаСПробелами(СсудныйСчет, 50) + СсудныйСчет + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Валюта договора              │" + СтрокаСПробелами(FindFullName(Договор.CurCode), 50) + FindFullName(Договор.CurCode)  + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Вид кредита                  │" + СтрокаСПробелами(ВидКредита.CreditTypeName,50) + ВидКредита.CreditTypeName + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Дата кредитного договора     │" + СтрокаСПробелами(DateToStringShort(Договор.RegDate), 50) + DateToStringShort(Договор.RegDate) + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Дата окончания кредитного    │" + СтрокаСПробелами(DateToStringShort(Договор.ReturnDate), 50) + DateToStringShort(Договор.ReturnDate) + "│";
           i = i+1;
           str(i) = "│договора                     │                                                  │";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Группа риска                 │" + СтрокаСПробелами(string(Договор.RiskGroup), 50) + string(Договор.RiskGroup) + "│";
           i = i+1;
           str(i) = "├─────────────────────────────┼──────────────────────────────────────────────────┤";
           i = i+1;
           str(i) = "│Сумма лимита кредитования    │" + СтрокаСПробелами(string(СуммаОперации), 50) + string(СуммаОперации) + "│";
           i = i+1;
           str(i) = "│действует начиная с          │" + СтрокаСПробелами(DateToStringShort(crdop.CredOperDate), 50) + DateToStringShort(crdop.CredOperDate) + "│";
           i = i+1;
           str(i) = "└─────────────────────────────┴──────────────────────────────────────────────────┘";
           i = i+1;
           str(i) = " Прилагаемые документы:";
           i = i+1;
           str(i) = " Платежное поручение №      от";
           i = i+1;
           str(i) = "";
           i = i+1;
           str(i) = " Начальник                                            (Ф.И.О.)";
           i = i+1;
           str(i) = " Исполнитель                                          " +  person.Name;
           i = i+1;
           str(i) ="";

           if({GROUP_MODE})
               Open(prnoper, NameFile);
           end;

           while(j<=i)
               if({GROUP_MODE})
                   Insert(prnoper, str(j));
               else
                   [ #] (str(j));
               end;
               j = j+1;
           end;

           if({GROUP_MODE})
               Close(prnoper);
           end;
           cryptoAPI.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", NameFile);
       end;
   elif(OperSysType == CS_CHANGEENS) // Распоряжение на изменение суммы ДО
       Common();
       query = "select * from DENSCONTR_DBT where t_EnsContractID = " + crdop.ObjectID_Ref;
       Pay = LnGetRecordSet(query);
       if(Pay == NULL)
           exit(1);
       end;

       while(Pay.moveNext())
           k = k+1;
           if(Pay.Value("T_ENSSYSTYPE", NULL, V_INTEGER) == Поручительство)
               ТипОбеспечения(k-1) = "Поручительство";
               Счет = "91305";
               j = 57;
           elif(Pay.Value("T_ENSSYSTYPE", NULL, V_INTEGER) == ЗалогЦБ)
               ТипОбеспечения(k-1) = "Залог ЦБ";
               Счет = "91303";
               j = 59;
           elif(Pay.Value("T_ENSSYSTYPE", NULL, V_INTEGER) == ЗалогИмущества)
               ТипОбеспечения(k-1) = "Залог имущ.";
               Счет = "91307";
               j = 58;
           elif(Pay.Value("T_ENSSYSTYPE", NULL, V_INTEGER) == ЗалогДрагМеталлов)
               ТипОбеспечения(k-1) = "Залог драг.мет.";
               Счет = "91308";
               j = 88;
           else
               ТипОбеспечения(k-1) = "Прочее";
           end;
           ДоговорОбеспечения(k-1) = Pay.Value("T_EnsContractNumber", NULL, V_STRING);
           ДатаОбеспечения(k-1)    = Pay.Value("T_EnsContractFirstDate",  NULL, V_DATE);
           Depclnt.GetRecord(Pay.Value("T_EnsContractPersonID_Ref", NULL,V_INTEGER));
           Поручитель(k-1) = Depclnt.ConvertFIO();
       end;
       query = "select Sum(t_CarrySum) from DDOC_ACC_DBT where t_CredOperID_Ref = " + OperationID +
               " and t_IsDeleted = " + 0;
       СуммаОперации = $0;
       СуммаОперации = LnSelectValue(query, V_MONEY);
       sum_ = ОстатокНаСчете(crdop.ObjectTypeID_Ref, crdop.ObjectID_Ref, Договор.CurCode, j, crdop.CredOperDate);
       str(i) = "";
       i=i+1;
       str(i) = "                             Р А С П О Р Я Ж Е Н И Е";
       i = i+1;
       str(i) = " на корректировку по счетам бухгалтерского учета " + DateToStringShort(DatePay);
       i = i+1;
       if (CrdOp.CreditNumber_Ref)
          str(i) = " договоров обеспечения, заключенных по кредитному договору " + Договор.UsCreditNumber + " от " + DateToStringShort(Договор.RegDate);
       else
          str(i) = " договоров обеспечения";
       end;
       i = i+1;
       str(i) ="";
       i = i+1;
       str(i) = "┌──────────────────────────────────────────┬──────────────────┬──────────────────────────┬───────────────────────┐";
       i = i+1;
       str(i) = "│      №, дата договора обеспечения        │ Вид обеспечения  │ Поручитель/Залогодатель  │     Корректировка     │";
       i = i+1;
       str(i) = "│                                          │                  │                          │   " + Счет + "   │ изменение │";
       i = i+1;
       str(i) = "├──────────────────────────────────────────┼──────────────────┼──────────────────────────┼───────────┼───────────┤";
       i = i+1;
       j = 0;
       while(j<=k-1)
       str(i) = "│" + СтрокаСПробелами((ДоговорОбеспечения(j) + " от " + DateToStringShort(ДатаОбеспечения(j))), 42) + ДоговорОбеспечения(j) + " от " + DateToStringShort(ДатаОбеспечения(j)) + "│" +
                 СтрокаСПробелами(ТипОбеспечения(j), 18) + ТипОбеспечения(j) + "│" +
                 СтрокаСПробелами(Поручитель(j), 26) + Поручитель(j) + "│" +
                 СтрокаСПробелами(string(СуммаОперации), 11) + string(СуммаОперации) + "│" +
                 СтрокаСПробелами(string(СуммаОперации), 11) + string(СуммаОперации) + "│";
       i = i+1;
       str(i) = "├──────────────────────────────────────────┼──────────────────┼──────────────────────────┼───────────┼───────────┤";
       if(j != k-1)
           i = i+1;
       end;
       j = j+1;
       end;
       str(i) = "└──────────────────────────────────────────┴──────────────────┴──────────────────────────┴───────────┴───────────┘";
       i = i+1;
       str(i) = " Прилагаемые документы:";
       i = i+1;
       str(i) = " Платежное поручение №      от";
       i = i+1;
       str(i) = "";
       i = i+1;
       str(i) = " Начальник                                            (Ф.И.О.)";
       i = i+1;
       str(i) = " Исполнитель                                          " +  person.Name;
       i = i+1;
       str(i) ="";

       if({GROUP_MODE})
           Open(prnoper, NameFile);
       end;
       j = 0;
       while(j<=i)
           if({GROUP_MODE})
               Insert(prnoper, str(j));
           else
               [ #] (str(j));
           end;
           j = j+1;
       end;

       if({GROUP_MODE})
           Close(prnoper);
       end;
       cryptoAPI.SignFile("ЯдроRSBank|ПодписьФайлов|НаложениеЭЦП", NameFile);
   else // Заявление на перечисление
      println(ЗаявлениеНаПеречисление); //Имя файла-шаблона
      println(GetDocName(ЗаявлениеНаПеречисление)); // Генерируем имя результирующего файла документа

      /* ФИО заёмщика */
      [~FIO];
      println (ФИО);
      /* Адрес прописки заёмщика */
      [~Address];
      println (DepClnt.Address);
      /* Сумма операции */
      [~Sum];
      println (DocAcc.rec.CarrySum);
      /* Сумма операции прописью */
      [~StrSum];
      println (CurToStrAlt(DocAcc.rec.CarrySum, null, null, int(FindExtCode(DocAcc.rec.CurCode))));
      /* Счёт дебета */
      [~Debet];
      println (DocAcc.rec.Debit);
      /* Счёт кредита */
      [~Credit];
      println (DocAcc.rec.Credit);
      /* № кредитного договора */
      [~CrdNum];
      println (CrdNum);
      /* Дата начала кредитного договора */
      [~RegDate];
      println (DateToStringFull (CrdDate));
      /* Дата операции */
      [~OpDate];
      println (DateToStringFull (CrdOp.CredOperDate));

      DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
      SetOutput(NULL, false);

   end;

   onError (err)
      if(err.Code != 0)
         WordError(err, false);
      end;
      Exit(1);
end;
