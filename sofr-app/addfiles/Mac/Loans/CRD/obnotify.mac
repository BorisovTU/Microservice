/*
$Name:             obnotify.mac
$Module:           Кредитование
$Description:      Уведомление заемщиков об уплате.
*/
/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : obnotify.mac
 Description : Уведомление заемщиков об уплате.

 Programmer  : TT
 15.07.03    : Создан
 13.10.03    : Доделан
------------------------------------------------------------------------------*/
import total, SbCrdInter, ПроцентыБухгалтер;

private file   credit_c ("credit_c.dbt", "loans.def") key 6;
private file   duty_crd ("duty_crd.dbt", "loans.def") key 1;
private file   perc_day ("perc_day.dbt", "loans.def");
private file   planpay  ("planpay.dbt",  "loans.def") key 0;
private record rlcusrate("lcusrate.dbt", "loans.def");
private var    crd_op  = TBFile ("crd_op.dbt",  "r", 1, "crd_op.dbt",  "loans.def");
        var    plnduty = TBFile ("plnduty.rec", "w", 0, "plnduty.rec", "loans.def");

private VAR   LastCredOperID_ForPlanPay, FillPlanPaySum, FillPlanPercSum, DutyDate:date;
private VAR   stat;
private VAR   PaySum, SumExpPerc, Sum, SumNoPay;
private var   plPayCredOperID : integer= 0;
var RateID: integer = 0;

PaySum = SumExpPerc = Sum = SumNoPay = $0;

macro CheckDuty(duty_crd, credit)
    var GraphCrdOp = 0;

    if (duty_crd.DutyState != CF_OPEN)// Закрытое обязательство
        return false;
    end;

    if (not NextOpSystType(true, duty_crd.DutyID, @crd_op, CS_PAY, false, credit.CurCode, LO_DUTY))
       return false; // По обязательству не было выдачи - погашать еще нечего
    end;

    return true;
end;

macro FillNotifyRep(credit, FirstDate, LastDate)
VAR query:string,
    rs = NULL,
    Dnac:date = date(0,0,0),
    RateID:integer = 0,
    ID:integer = 0,
    Rest:moneyl = $0,
    BegDate:date = date(0,0,0);

record rlcusrate("lcusrate.dbt", "loans.def");
record rlcusreg("lcusreg.dbt",  "loans.def");
VAR    planpay_tmp = TBFile ("planpay.tmp", "w", 0);

var objid_ :integer = credit.Crd_Kind,
    objn_ :integer = credit.CreditNumber,
    DutyForm = DF_BY_TRANCHES,
    //RSDcmd = NULL,
    //rs = NULL;

    RSDcmd = RsdCommand(RslDefCon, "select T.t_Duty from dparmdemandline_dbt T where t.t_ObjectTypeID = ? and t.t_ObjectNumber = ?");
    RSDcmd.addParam("t.t_ObjectTypeID", RsdBp_in); RSDcmd.value(0) = credit.Crd_Kind;
    RSDcmd.addParam("t.t_ObjectNumber", RsdBp_in); RSDcmd.value(1) = credit.CreditNumber;
    RSDcmd.execute;
  
    rs = RsdRecordset(RSDcmd);
    if (rs.moveNext)
        DutyForm = rs.value(0, NULL, V_INTEGER);
    end;
    
    if(DutyForm == DF_BY_ACCOUNT)
        LastCredOperID_ForPlanPay = GetLastCredOperID_ForPlanPay (credit.CreditNumber, credit.Crd_Kind);
    end;

    ClearRecord(duty_crd);
    duty_crd.CreditNumber_Ref = credit.CreditNumber;
    duty_crd.DutyType = 0;
    duty_crd.DutyState = "";
    stat = GetGE(duty_crd);
    while (stat and (duty_crd.CreditNumber_Ref == credit.CreditNumber))
        if (CheckDuty(duty_crd, credit))
           LnSqlExec("delete from dplanpay_tmp");
           Dnac = date(0,0,0);
           RateID = 0;
           ID = 0;
           Rest = $0;
           if(DutyForm != DF_BY_ACCOUNT)
           LastCredOperID_ForPlanPay = GetLastCredOperID_ForPlanPay (duty_crd.DutyID, LO_DUTY);
               objid_ = LO_DUTY;
               objn_ = duty_crd.DutyID;
           end;
           if (LastCredOperID_ForPlanPay != 0)
              planpay.ObjectTypeID_Ref = objid_;
              planpay.ObjectID_Ref     = objn_;
              planpay.CredOperID_Ref   = LastCredOperID_ForPlanPay;
              planpay.Type             = 0;
              planpay.PlannedPayDate   = FirstDate;
              planpay.PlannedExpDate   = FirstDate;
              stat = GetGE(planpay);
              FillPlanPaySum  = false;
              FillPlanPercSum = false;
              while(stat and (planpay.ObjectTypeID_Ref == objid_)
                         and (planpay.ObjectID_Ref     == objn_)
                         and (planpay.CredOperID_Ref   == LastCredOperID_ForPlanPay)
                         and (planpay.Type             == 0)
                         and (planpay.PlannedPayDate   >= FirstDate)
                         and (planpay.PlannedExpDate   >= FirstDate)
                         and (planpay.PlannedExpDate   <= LastDate)
                         and ((not FillPlanPaySum) or (not FillPlanPercSum)))
                 LnSqlExec("delete from dplanpay_tmp");
                 Dnac = date(0,0,0);
                 RateID = 0;
                 ID = 0;
                 Rest = $0;

                 plnduty.rec.ClientID       = credit.ClientID_Ref;
                 plnduty.rec.UsCreditNumber = credit.UsCreditNumber;
                 plnduty.rec.RegDate        = credit.RegDate;
                 plnduty.rec.DutyUserNumber = duty_crd.UserNumber;
                 plnduty.rec.DutyRest       = ОстатокСО (duty_crd.DutyID, TDR_MAINREST, FirstDate);

                 if ((planpay.PlannedPaySum > 0) and (not FillPlanPaySum))
                    plnduty.rec.PayDate        = planpay.PlannedPayDate;
                    plnduty.rec.PlanPaySum     = planpay.PlannedPaySum;

                    if( plnduty.rec.DutyRest > 0)
                        if (planpay.PlannedPayDate > credit.ReturnDate)
                            DutyDate = credit.ReturnDate;
                        else
                            DutyDate = planpay.PlannedPayDate;
                        end;

                        //ds_duty_calc(LO_DUTY, duty_crd.DutyID, DutyDate, TDR_MAINREST, 0, @BegDate, LastDate, @Sum, @PaySum, @SumNoPay, CS_EXP);
                        plnduty.rec.ActPaySum      = PaySum;
                        FillPlanPaySum             = true;
                    end;
                 end;

                 if ((planpay.PlannedPercentSum > 0) and (not FillPlanPercSum) and (planpay.PlannedPayDate <= plnduty.rec.PayDate))
                    plnduty.rec.BegPercDate    = CalcLastPercDate(perc_day, duty_crd.DutyID, Credit_c, LO_DUTY, duty_crd.DutyID, TDR_MAINREST, TRU_CRD);
                    plnduty.rec.EndPercDate    = planpay.PlannedPayDate;
                    plnduty.rec.PlanPercDate   = planpay.PlannedPayDate;
                    plnduty.rec.PlanPercSum    = planpay.PlannedPercentSum;       // Сумма процентов из графика

                    if( plnduty.rec.DutyRest > 0)
                        if (planpay.PlannedPayDate > credit.ReturnDate)
                            DutyDate = credit.ReturnDate;
                        else
                            DutyDate = planpay.PlannedPayDate;
                        end;

                        IF(Loans_FindLCUR(LO_DUTY, duty_crd.DutyID, TRU_CRD, 0, rlcusrate))
                            RateID = rlcusrate.RateID_Ref;
                        END;
                        //СуммаПроцентовКПогашению
                        //Начисленные
                        query = "";
                        query = "SELECT max(T_CALCENDDATE) FROM DPLANFACT_DBT WHERE ";
                        query = query + "T_OBJECTTYPEID_REF = " + LO_DUTY;
                        query = query + " and T_OBJECTNUMBER_REF = " + duty_crd.DutyID;
                        query = query + " and T_DUTYSTAGEID_REF = " + DS_PERC;
                        query = query + " and (T_SYSTEMOPERATIONID_REF = " + CS_DUTY;
                        query = query + " or T_SYSTEMOPERATIONID_REF = " + CS_EXP;
                        query = query + ") and T_ActualAmount <> 0";

                        rs = NULL;
                        rs = LnGetRecordSet(query);
                        if((rs != NULL) and
                           (rs.MoveNext() != FALSE) and
                           (ValType(rs.Value(0, NULL, V_DATE)) == V_DATE))
                            Dnac = rs.Value(0, NULL, V_DATE) +1;
                        else
                            Dnac = duty_crd.DutyFirstDate;
                        end;

                        IF (Loans_FindLCUR(LO_DUTY, duty_crd.DutyID, TRU_CRD, 0, rlcusrate))
                            RateID = rlcusrate.RateID_Ref;
                        END;

                        query = "";
                        query = "SELECT SUM (T_PERCSUM) FROM DPERC_DAY_DBT WHERE T_RATEID = " + RateID;
                        query = query + " and T_PERCDATE >= " + SQLDate(Dnac);
                        query = query + " and T_PERCDATE <= " + SQLDate(plnduty.rec.EndPercDate);

                        plnduty.rec.FrcPercSum = LnSelectValue(query, V_MONEY);

                        //Доначисленные
                        IF(Loans_FindLCURG(LO_DUTY, duty_crd.DutyID, TDR_MAINREST, 0, rlcusreg))
                            ID = rlcusreg.ID;
                        END;

                        query = "";
                        query = "SELECT T_PERCDATE FROM DPERC_DAY_DBT WHERE T_RATEID = " + RateID;
                        query = query + " AND T_ID_REF = " + ID;

                        rs = NULL;
                        rs = LnGetRecordSet(query +" ORDER BY T_PERCDATE DESC");

                        if((rs != NULL) and
                           (rs.MoveNext() != FALSE) and
                           (ValType(rs.Value(0, NULL, V_DATE)) == V_DATE))
                            Dnac = rs.Value(0, NULL, V_DATE) +1;
                        else
                            Dnac = duty_crd.DutyFirstDate;
                        end;

                        planpay_tmp.Clear;
                        planpay_tmp.rec.RateID = RateID;
                        planpay_tmp.rec.Rest   = ОстатокРегистра(LO_DUTY, duty_crd.DutyID, TDR_MAINREST, Dnac - 1);
                        planpay_tmp.rec.Date   = Dnac - 1;
                        planpay_tmp.Insert();

                        planpay_tmp.Clear;
                        planpay_tmp.rec.RateID = RateID;
                        planpay_tmp.rec.Rest   = ОстатокРегистра(LO_DUTY, duty_crd.DutyID, TDR_MAINREST, Dnac);
                        planpay_tmp.rec.Date   = Dnac;
                        planpay_tmp.Insert();

                        Rest = planpay_tmp.rec.Rest;

                        if(planpay_tmp.rec.Date  == plnduty.rec.EndPercDate)
                            planpay_tmp.rec.Marker = "X";
                            planpay_tmp.Update();
                        else
                            planpay_tmp.Clear;
                            planpay_tmp.rec.RateID = RateID;
                            planpay_tmp.rec.Date   = plnduty.rec.EndPercDate;
                            planpay_tmp.rec.Marker = "X";
                            planpay_tmp.rec.Rest   = Rest;
                            planpay_tmp.Insert();
                        end;

                        РасчетГрафикаПроцентов(RateID, Dnac, plnduty.rec.EndPercDate, 0.0, false, LO_DUTY, duty_crd.DutyID);

                        query = "";
                        query = "select t_CalcPercent from dplanpay_tmp where t_RateID = " + RateID;
                        query = query + " and t_Marker = 'X' ";
                        query = query + " and t_Date = ";
                        query = query + " (select MAX(t_Date) from dplanpay_tmp a";
                        query = query + " where a.t_RateID = " + RateID;
                        query = query + " and a.t_Marker = 'X')";

                        rs = NULL;
                        rs = LnGetRecordSet(query);

                        IF ((rs != NULL) AND
                            (rs.MoveNext() == TRUE) AND
                            (ValType(rs.Value(0, NULL, V_MONEY)) == V_MONEY))
                            plnduty.rec.FrcPercSum = plnduty.rec.FrcPercSum + rs.Value(0, NULL, V_MONEY);
                        END;

                        plnduty.rec.DutyPercSum    = plnduty.rec.PlanPercSum - plnduty.rec.FrcPercSum;// Уплаченная сумма процентов
                        if(plnduty.rec.DutyPercSum < 0)
                            plnduty.rec.DutyPercSum = 0;
                        end;
                        FillPlanPercSum            = true;
                    end;
                 end;
                 stat = next(planpay);
              end;

              if(FillPlanPercSum or FillPlanPaySum)
                  plnduty.insert;
              end;
           end;
        end;
    stat = next(duty_crd);
    end;
end;

