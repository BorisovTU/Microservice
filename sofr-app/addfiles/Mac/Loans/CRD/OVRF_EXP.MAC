/*
$Name:             OVRF_EXP.MAC
$Module:           Кредитование
$Description:      Отчет - Прогноз просрочки процентов
*/
/*
   File Name   : OVRF_EXP.MAC
   Description : Отчет - Прогноз просрочки процентов
   Programmer  : Tereschenko FS
*/
import RsbDataSet, SbCrdInter, Total, "macperc.mac";


private var  Договор   = TBFile ("credit_c.dbt", "r", 2);  /* карты с овердрафтом       */
private var  Curr      = TBFile ("fininstr.dbt", "r", 1);  /* валюта                    */
private var  TypeKarta = TBFile ("type_crd.dbt", "r", 1);  /* виды кредитов             */
private var  Отчет     = null;

private const FIRSTREC = 1;
private const NEXTREC  = 2;

private var {oper};
private var DateExp        = {curdate};
private var Begin_Date     = {curdate};
private var End_Date       = {curdate};
private var SumExpTCR      = $0;
private var SumAdPrc       = $0;
private var SumPerc        = $0;
private var SumExpPercTCR  = $0;
private var SumExpCurr     = $0;
private var SumExpPercCurr = $0;
private var SumExp         = $0;
private var SumExpPerc     = $0;

private var NewType;

private var ФлагШапка = false;
private var ПослеТипа = false;

private macro Заголовок()
[ ];
[                           Прогноз просрочки c ########## по ##########] (Begin_Date, End_Date);
[ ];
[                                   БАНКОВСКИЕ КАРТЫ];
[
 ┌───────────┬───┬─────────────────────────┬─────────────────┬─────────────────┬─────────────────┐
 │    Вид    │   │                         │                 │      Сумма      │      Сумма      │
 │   карты   │Вал│   N карточного счета    │      ФИО        │    просрочки    │   просрочки %   │
 │           │   │                         │                 │ основного долга │                 │
];
end;

private macro ВыводЗаписи(SumExp, SumExpPerc)
  var _I;
  var _O;
  var _F;

  if(DepClnt.GetRecord(Договор.rec.ClientID_Ref) )
    _I = DepClnt.Name2;
    _O = DepClnt.Name3;
    _F = DepClnt.Name1;
  else
    _I = "";
    _O = "";
    _F = "";
  end;
  if( NewType )
    [├───────────┴───┴─────────────────────────┴─────────────────┴─────────────────┴─────────────────┤
     │ #########   ################################################################################# │
     │                                                                                               │
     │           Дата выноса на просрочку: ##########                                                │
     │           ┌───┬─────────────────────────┬─────────────────┬─────────────────┬─────────────────┤
     │           │   │                         │ ############### │                 │                 │
     │           │###│#########################│ ############### │ ############### │ ############### │
     │           │   │                         │ ############### │                 │                 │]
     (TypeKarta.rec.CreditTypeID:r,
      TypeKarta.rec.CreditTypeName:l,
      DateExp,
      _F:c,
      Curr.rec.CCY:r,
      Договор.rec.AccountKarta:r,
      _I:c,
      SumExp:11:2:r,
      SumExpPerc:11:2:r,
      _O:c);
    NewType = FALSE;
  else
    [│];
    [│           Дата выноса на просрочку: ##########] (DateExp);
    [│           ┌───┬─────────────────────────┬─────────────────┬─────────────────┬─────────────────┐
     │           │   │                         │ ############### │                 │                 │
     │           │###│#########################│ ############### │ ############### │ ############### │
     │           │   │                         │ ############### │                 │                 │]
    (_F:c,
     Curr.rec.CCY:r,
     Договор.rec.AccountKarta:r,
     _I:c,
     SumExp:11:2:r,
     SumExpPerc:11:2:r,
    _O:c);
  end;
end;

private macro Окончание()
[└───────────┴───┴─────────────────────────┴─────────────────┴─────────────────┴─────────────────┘];
end;

private macro Окончание_1()
[│           └───┴─────────────────────────┴─────────────────┴─────────────────┴─────────────────┘];
end;


private macro Шапка()
  var Rest1 = $0;
  var Rest2 = $0;

  [│           Информация по расчету % ];
  [│           Остаток на счете неполученных срочных %: ###########] ((ОстатокРегистра(LO_KARTA, Договор.rec.CreditNumber, TDR_CLAIM, DateExp) + ОстатокРегистра(LO_KARTA, Договор.rec.CreditNumber, TDR_PERCLIM, DateExp)):10:2:l);
  [│           Начисленные срочные %, выносимые на просрочку: ###########] (SumPerc:10:2:l);
  [│];
  [│           ┌──────────┬──────────┬─────────────┬─────────┬───────────────┬───────────┬────────┬───────────┐
   │           │   Дата   │   Дата   │    Сумма    │   Тип   │      Тип      │   Дней    │ Ставка │  Сумма %  │
   │           │  начала  │окончания │             │ остатка │   календаря   │ в периоде │        │ за период │]

end;

private macro Конец()
  [│           └──────────┴──────────┴─────────────┴─────────┴───────────────┴───────────┴────────┴───────────┘]
end;

private macro Итог()
  [│           всего доначислено срочных процентов : ###########                                               ]
    (SumAdPrc:11:2:l);
  [│           всего срочных процентов             : ###########                                               ]
   (SumExpPerc:11:2:l);
end;

private macro СтрокаОтчета()
  var ТипОстатка,
      ТипКалендаря1,
      ТипКалендаря2;
  if( Отчет.Value(3, NULL, V_INTEGER) == PC_IN_REST )
    ТипОстатка = "входящий";
  end;
  if( Отчет.Value(3, NULL, V_INTEGER) == PC_OUT_REST )
    ТипОстатка = "исходящий";
  end;
  if( Отчет.Value(4, NULL, V_INTEGER) == PC_360_30 )
    ТипКалендаря1 = "360 дн. в году";
    ТипКалендаря2 = "30 дн. в мес.";
  end;
  if( Отчет.Value(4, NULL, V_INTEGER) == PC_360_CAL )
    ТипКалендаря1 = "360 дн. в году";
    ТипКалендаря2 = "мес. по кален.";
  end;
  if( Отчет.Value(4, NULL, V_INTEGER) == PC_CAL_30 )
    ТипКалендаря1 = "год по календ.";
    ТипКалендаря2 = "30 дн. в мес.";
  end;
  if( Отчет.Value(4, NULL, V_INTEGER) == PC_CAL_CAL )
    ТипКалендаря1 = "год по календ.";
    ТипКалендаря2 = "мес. по кален.";
  end;
  if( ПослеТипа )
[│           ├──────────┬──────────┬─────────────┬─────────┬───────────────┬───────────┬────────┬───────────┤];
  else
[│           ├──────────┼──────────┼─────────────┼─────────┼───────────────┼───────────┼────────┼───────────┤];
  end;
[│           │##########│##########│#############│#########│###############│###########│########│###########│
 │           │          │          │             │         │###############│           │        │           │]
(date(Отчет.Value(0, NULL, V_DATE)),
 date(Отчет.Value(1, NULL, V_DATE)),
 Отчет.Value(2, NULL, V_MONEY):13:2:r,
 ТипОстатка:c,
 ТипКалендаря1:c,
 int(date(Отчет.Value(1, NULL, V_DATE)) - date(Отчет.Value(0, NULL, V_DATE)) + 1):c,
 Отчет.Value(5, NULL, V_DOUBLE):c,
 Отчет.Value(6, NULL, V_MONEY):11:2:l,
 ТипКалендаря2:c);
 ПослеТипа = false;
 return;
end;

private macro ВыводОтчета()

  Отчет = LnGetRecordSet("SELECT min(t_Begindate) BeginDate, max(t_Begindate) EndDate, t_Rest, t_TypeRest, t_TypeCalendar, t_PercRate, Sum(t_PercSum) PercSum FROM dpercpay_tmp GROUP BY t_Rest, t_TypeRest, t_TypeCalendar, t_PercRate");
  if(Отчет != NULL)
      while (Отчет.MoveNext)
          if ((ValType(Отчет.Value(6, NULL, V_MONEY)) != V_UNDEF) and
              (Отчет.Value(6, NULL, V_MONEY) != $0))
              if( not ФлагШапка )
                  ФлагШапка = true;
                  Шапка();
              end;
              СтрокаОтчета();
          end;
      end;
  end;
end;

private macro ПодробныйОтчет()
  ФлагШапка = false;
  ВыводОтчета();    /*срочные проценты на остаток*/
  Конец();
  Итог();
end;

private macro Вывод()
  var Rest_Claim = $0;
  var Rest_No_Perc = $0;
  var FlagEnd = False;
  var Debit = $0;
  var last_ops = null;
  var planexp  = null;
  var dutySumExp   : money = $0,
      nodutSumExp  : money = $0,
      PercSumExp   : money = $0,
      AdprcSumExp  : money = $0,
      noadpSumExp  : money = $0,
      noprcSumExp  : money = $0,
      tmpsum1      : money = $0,
      tmpsum2      : money = $0,
      tmpdate;
  
  private record rlcusrate("lcusrate.dbt", "loans.def");

  last_ops = LnGetRecordSet("select max(t_CredOperID) MaxOperID, t_ObjectID_Ref from dcrd_op_dbt WHERE " +
                                                " t_SystemOperationID = " + CS_PAY   +
                                                " AND t_ObjectTypeID_Ref = "  + LO_KARTA +
                                                " AND t_ObjectID_Ref = "      + Договор.rec.CreditNumber +
                                                " GROUP BY t_ObjectID_Ref");
 
  if(last_ops != NULL)  
      while ((last_ops.MoveNext) and // Перебираем все последние операции, затронувшие графики погашения по БК
             (ValType(last_ops.Value(0, NULL, V_INTEGER)) != V_UNDEF) and
             (ValType(last_ops.Value(1, NULL, V_INTEGER)) != V_UNDEF)
            )
          planexp = LnGetRecordSet("select t_PlannedExpDate from dplanpay_dbt where t_CredOperID_Ref = " + last_ops.Value(0, NULL, V_INTEGER)
                                    + " AND t_ObjectTypeID_Ref = " + LO_KARTA
                                    + " AND t_ObjectID_Ref >= " + Договор.rec.CreditNumber
                                    + " AND t_Type = " + 0
                                    + " AND t_PlannedExpDate >= " + SQLDate(Begin_Date)
                                    + " AND t_PlannedExpDate <= " + SQLDate(End_Date)
                                    + " ORDER BY t_PlannedExpDate ASC");
          FlagEnd    = false;
          SumExp     = $0;
          SumExpPerc = $0;  
          if(planexp != NULL)
              while ((planexp.MoveNext) and
                     (ValType(planexp.Value(0, NULL, V_DATE)) != V_UNDEF)
                    )
                  DateExp   = date(planexp.Value(0, NULL, V_DATE));
                  if (DateExp != date (0,0,0))
                      ClearTable("DPERCPAY_TMP");
                      
                      tmpdate = date(0,0,0);
                      tmpsum1 = $0;
                      tmpsum2 = $0;
                      dutySumExp = $0;
                      //ds_duty_calc (LO_KARTA, Договор.rec.CreditNumber, DateExp, TDR_MAINREST, 0, tmpdate, DateExp, @dutySumExp,  @tmpsum1, @tmpsum2, CS_EXP);
                      
                      tmpdate = date(0,0,0);
                      tmpsum1 = $0;
                      tmpsum2 = $0;
                      nodutSumExp = $0;
                      //ds_nodut_calc(LO_KARTA, Договор.rec.CreditNumber, DateExp, TDR_LIM,      0, tmpdate, DateExp, @nodutSumExp, @tmpsum1, @tmpsum2, CS_EXP);
           
                      IF(Loans_FindLCUR(LO_KARTA, Договор.rec.CreditNumber, TRU_CRD, 0, rlcusrate))
                          tmpdate = date(0,0,0);
                          tmpsum1 = $0;
                          tmpsum2 = $0;
                          PercSumExp = $0;
                          //ds_perc_calc (LO_KARTA, Договор.rec.CreditNumber, DateExp, TDR_MAINREST, rlcusrate.RateID_Ref,  tmpdate, DateExp, @tmpsum1, @PercSumExp,  @tmpsum2, CS_EXP);
                          
                          tmpdate = date(0,0,0);
                          tmpsum1 = $0;
                          tmpsum2 = $0;
                          AdprcSumExp = $0;
                          //ds_adprc_calc(LO_KARTA, Договор.rec.CreditNumber, DateExp, TDR_MAINREST, rlcusrate.RateID_Ref,  tmpdate, DateExp, @tmpsum1, @AdprcSumExp,  @tmpsum2, CS_EXP);
                      END;
           
                      IF(Loans_FindLCUR(LO_KARTA, Договор.rec.CreditNumber, TRU_LIM, 0, rlcusrate))
                          tmpdate = date(0,0,0);
                          tmpsum1 = $0;
                          tmpsum2 = $0;
                          noprcSumExp = $0;
                          //ds_noprc_calc(LO_KARTA, Договор.rec.CreditNumber, DateExp, TDR_LIM, rlcusrate.RateID_Ref,  tmpdate, DateExp, @tmpsum1, @noprcSumExp,  @tmpsum2, CS_EXP);
                          
                          tmpdate = date(0,0,0);
                          tmpsum1 = $0;
                          tmpsum2 = $0;
                          noadpSumExp = $0;
                          //ds_noadp_calc(LO_KARTA, Договор.rec.CreditNumber, DateExp, TDR_LIM, rlcusrate.RateID_Ref, tmpdate, DateExp, @tmpsum1, @noadpSumExp,  @tmpsum2, CS_EXP);
                      END;
           
                      SumExp     = dutySumExp  + nodutSumExp;
                      SumPerc    = PercSumExp  + noprcSumExp;  //Начисленные %%
                      SumAdPrc   = AdprcSumExp + noadpSumExp; //Доначисленные %%
                      SumExpPerc = SumPerc     + SumAdPrc;
                      if(SumExp < 0)     SumExp = 0;     end;
                      if(SumExpPerc < 0) SumExpPerc = 0; end;
                      if(( SumExp > 0) or (SumExpPerc > 0))
                          ВыводЗаписи(SumExp, SumExpPerc);
                          Окончание_1();
                          if (SumExpPerc > 0)
                              ПодробныйОтчет();
                          end;
                      end;
                  end;
              end;
              if(SumExp < 0)     SumExp = 0;     end;
              if(SumExpPerc < 0) SumExpPerc = 0; end;
              if(( SumExp > 0) or (SumExpPerc > 0))
                  SumExpCurr     = SumExpCurr     + SumExp;
                  SumExpPercCurr = SumExpPercCurr + SumExpPerc;
                  SumExpTCR      = SumExpTCR      + SumExp;
                  SumExpPercTCR  = SumExpPercTCR  + SumExpPerc;
              end;
          end;
      end;  
  end;
end;

private macro GoNextCredit(op)
 if(op == FIRSTREC )
     Договор.rec.Crd_kind         = LO_KARTA;
     Договор.rec.CreditTypeID_Ref = TypeKarta.rec.CreditTypeID;
     Договор.rec.ClientID_Ref     = 0;

     SetParm(0,NEXTREC);
     return (Договор.GetGE and
            (Договор.rec.Crd_Kind         == TypeKarta.rec.Crd_Kind) and
            (Договор.rec.CreditTypeID_Ref == TypeKarta.rec.CreditTypeID)
            )
 else
     return (Договор.Next and
            (Договор.rec.Crd_kind         == TypeKarta.rec.Crd_kind) and
            (Договор.rec.CreditTypeID_Ref == TypeKarta.rec.CreditTypeID)
            )
 end;
end;

private macro ВвестиИсходныеДанные()
  if ( not ВвестиПериодДат( Begin_Date, End_Date) )
     return false;
  end;
  return true;
end;

private macro ПрогнозПросрочки()
 var CreditOper = FIRSTREC;
 var i = 0;
 var Nrec:integer = 0;

 ClearTable("DPERCPAY_TMP");

 if( not ВвестиИсходныеДанные() )
   exit();
 end;

 УстановитьВидыКредитов (1, -1, LO_KARTA);
 Nrec = LnSelectValue ("SELECT COUNT(T_SETFLAG) FROM DSET_TCR_TMP WHERE T_SETFLAG = 'X'", V_INTEGER);
 if (Nrec == 0)
    MsgBox("Не выбран ни один ВК !");
    exit();
 end;
 LnSqlExec("delete from dset_tcr_tmp where t_setflag <> 'X'");
                                      
 Заголовок();

 Curr.AddFilter ("t_FI_kind = 1 and t_Avoirkind = 0");
 Curr.rewind;
 while(Curr.next)
   SumExpCurr = SumExpPercCurr = 0;
   TypeKarta.AddFilter ("t_Crd_kind = " + LO_KARTA +
      " and t_credittypeid in (select t_credittypeid_ref from dset_tcr_tmp)");
   TypeKarta.rewind;
   while(TypeKarta.next)
     if (TypeKarta.rec.CurCode == Curr.rec.FIID)
       NewType = TRUE;
       SumExpTCR = SumExpPercTCR = i = 0;
       CreditOper = FIRSTREC;
       Договор.Clear;
       Договор.AddFilter ("t_Crd_kind = " + LO_KARTA + " and t_CreditTypeID_Ref = " + TypeKarta.rec.CreditTypeID);
       InitProgress(Договор.NRecords, "Ждите...", "Вид карты: " + TypeKarta.rec.CreditTypeName);
       while(GoNextCredit(CreditOper))
          UseProgress(i = i + 1);
          if (CheckUserAccess(Договор.rec.GroupNum, Договор.rec.FNCash, {oper}))
             Вывод();
          end;
       end;
       RemProgress;
       Договор.DropFilter;
       if((SumExpTCR != 0) or (SumExpPercTCR != 0))
         [├───────────┬───┬─────────────────────────┬─────────────────┬─────────────────┬─────────────────┐
          │ Итого     │   │                         │                 │                 │                 │
          │ (по виду  │   │                         │                 │ ############### │ ############### │
          │  карты)   │   │                         │                 │                 │                 │]
         (SumExpTCR:11:2:r, SumExpPercTCR:11:2:r);
       end;
     end;
   end;
   TypeKarta.DropFilter;
   if((SumExpCurr != 0) or (SumExpPercCurr != 0))
     [├───────────┼───┼─────────────────────────┼─────────────────┼─────────────────┼─────────────────┤
      │          Итого│                         │                 │                 │                 │
      │    (по валюте)│                         │                 │ ############### │ ############### │]
      (SumExpCurr:11:2:r,
       SumExpPercCurr:11:2:r);
   end;
 end;
 Curr.DropFilter;
 Окончание();
end;

/*НАЧАЛО*/
OpenLoansCommonFiles();
ПрогнозПросрочки();
CloseLoansCommonFiles();
