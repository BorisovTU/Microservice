/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ddutyrep.mac
 Description : Отчёт из скроллинга платежей по погашению.
               Вызывается по F7 из скроллинга.

 Programmer  : SAE
 14.11.01    : Создан
------------------------------------------------------------------------------*/
Import SbCrdInter, globals;

PRIVATE VAR Currency = TBFile ("fininstr.dbt", "r", 1);
PRIVATE VAR DocDuty  = TBFile ("doc_duty.dbt", "r", 1);

PRIVATE VAR FirstDate, LastDate, stat = false,
            ExtCurtCode : integer, CurShortName, CurCode = 0, DocCount = 0, DocSum = $0;

if (not ВвестиПериодДат (FirstDate, LastDate))
  exit (1);
end;

ExtCurtCode  = {ISONatCur};
if (NOT GetInt (ExtCurtCode, "Введите код валюты:", 3))
  exit (1);
end;

Currency.Clear;
Currency.rec.FI_Code = string(ExtCurtCode);
if (NOT Currency.GetEQ)
  MsgBox ("Не найдена валюта с кодом ", ExtCurtCode);
  exit (1);
end;
CurCode      = Currency.rec.FIID;
CurShortName = Currency.rec.Ccy;

DocDuty.Clear;
DocDuty.AddFilter("t_State = " + CF_INPUT);
DocDuty.rec.State            = CF_INPUT;
DocDuty.rec.CreditNumber_Ref = 0;
DocDuty.rec.PayDate          = Date (0,0,0);
stat = DocDuty.GetGE;
while (stat)
    if ((DocDuty.rec.CurCode == CurCode) AND (DocDuty.rec.PayDate >= FirstDate) AND (DocDuty.rec.PayDate <= LastDate))
      DocCount = DocCount + 1;
      DocSum = DocSum + DocDuty.rec.Sum;
    end;
    stat = DocDuty.Next;
end;
DocDuty.DropFilter;
PrintLn ("Количество документов: ", DocCount);
PrintLn ("Сумма документов:      ", DocSum, " ", CurShortName);
