/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : calcsolv.mac
 Description : Расчет класса кредитоспособности заемщика

 Programmer  : KOE
 28.09.04    : Создан
------------------------------------------------------------------------------*/
import BankInter, CTInter;

FILE party("party.dbt", "bank.def"); /* Справочник субъектов*/

var K1: double = 0,/* коэффициент абсолютной ликвидности */
    K2: double = 0,/* промежуточный коэффициент покрытия */
    K3: double = 0,/* коэффициент абсолютной ликвидности */
    K4: double = 0,/* коэффициент соотношения собственных и заемных средств */
    K5: double = 0,/* рентабельность продаж */
    K6: double = 0,/* рентабельность деятельности п/п */
    K1_k: integer = 0, /* категория показателя */
    K2_k: integer = 0, /* категория показателя */
    K3_k: integer = 0, /* категория показателя */
    K4_k: integer = 0, /* категория показателя */
    K5_k: integer = 0, /* категория показателя */
    K6_k: integer = 0, /* категория показателя */
    S: integer = 0, /* сумма баллов */
    n22: moneyl = 0,
    n23: moneyl = 0,
    n24: moneyl = 0,
    n25: moneyl = 0,
    n26: moneyl = 0,
    n27: moneyl = 0,
    n28: moneyl = 0,
    n29: moneyl = 0,
    n30: moneyl = 0,
    n31: moneyl = 0,
    n32: moneyl = 0,
    n33: moneyl = 0,
    n34: moneyl = 0,
    tmp: moneyl = 0;

macro РасчетКлассаКредитоспособности(LoanerID, DateFrom)
   VAR SolvencyClass = 0, Notetext, i = 22, DateFrom_, IsSet = 0, OK = 1, retval, NumInList;

   DateFrom_ = null;

   ClearRecord(party);
   party.PartyID = LoanerID;
   if(getEQ(party))
       while((i <= 35) and OK)
           Notetext = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), i, DateFrom, DateFrom_);
           IsSet = ((DateFrom_ != null) and (DateFrom_ != Date(0, 0, 0)));
           if(NOT IsSet)
               OK = 0;
           end;
           i = i+1;
       end;

       if(NOT OK)
           MsgBox("Не внесены все необходимые данные!");
           return 0;
       end;

       n22 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 22, DateFrom);
       n23 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 23, DateFrom);
       n24 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 24, DateFrom);
       n25 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 25, DateFrom);
       n26 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 26, DateFrom);
       n27 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 27, DateFrom);
       n28 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 28, DateFrom);
       n29 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 29, DateFrom);
       n30 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 30, DateFrom);
       n31 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 31, DateFrom);
       n32 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 32, DateFrom);
       n33 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 33, DateFrom);
       n34 = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 34, DateFrom);
       tmp = n30 - (n28 + n29);

       K1 = (n25 + n24)/tmp;
       K2 = (n22 + n23 + n25)/tmp;
       K3 = n26/tmp;
       K4 = (n27 + n28 + n29)/n31;
       K5 = n33/n32;
       K6 = n34/n32;

       addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 36, K1, DateFrom);
       addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 37, K2, DateFrom);
       addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 38, K3, DateFrom);
       addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 39, K4, DateFrom);
       addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 40, K5, DateFrom);
       addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 41, K6, DateFrom);

       /*разбиваем показатели на категории в зависимости от их значений*/
       /*K1*/
       if(K1 >= 0.1)
           K1_k = 1;
       elif((K1 >= 0.05) and (K1 < 0.1))
           K1_k = 2;
       elif(K1 < 0.05)
           K1_k = 3;
       end;

       /*K2*/
       if(K2 >= 0.8)
           K2_k = 1;
       elif((K2 >= 0.5) and (K2 < 0.8))
           K2_k = 2;
       elif(K2 < 0.5)
           K2_k = 3;
       end;

       /*K3*/
       if(K3 >= 1.5)
           K3_k = 1;
       elif((K3 >= 1) and (K3 < 1.5))
           K3_k = 2;
       elif(K3 < 1)
           K3_k = 3;
       end;

       /*K4*/
       /*для торговли*/
       if((GetMainObjAttr(retval, OBJTYPE_PARTY, UniID(party,OBJTYPE_PARTY ),
                          6, null, null, NumInList) == true) and (retval == 0) and (NumInList == 1))
           if(K4 >= 0.25)
               K4_k = 1;
           elif((K4 >= 0.15) and (K4 < 0.25))
               K4_k = 2;
           elif(K4 < 0.15)
               K4_k = 3;
           end;
       else
           if(K4 >= 0.4)
               K4_k = 1;
           elif((K4 >= 0.25) and (K4 < 0.4))
               K4_k = 2;
           elif(K4 < 0.25)
               K4_k = 3;
           end;
       end;

       /*K5*/
       if(K5 >= 0.1)
           K5_k = 1;
       elif(K5 < 0.1)
           K5_k = 2;
       elif(K5 == 0)
           K5_k = 3;
       end;

       /*K6*/
       if(K6 >= 0.06)
           K6_k = 1;
       elif(K6 < 0.06)
           K6_k = 2;
       elif(K6 == 0)
           K6_k = 3;
       end;

       S = 0.05*K1_k + 0.10*K2_k + 0.4*K3_k + 0.2*K4_k + 0.15*K5_k + 0.10*K6_k;

       /*по сумме баллов S определяем класс кредитоспособности заемщика*/
       if((S <= 1.25) and (K5 >= 0.10))
           SolvencyClass = 1;
       else
           SolvencyClass = 2;
       end;

       if((S <= 2.35) and (S > 1.25) and ( (K5 > 0) and (K5 < 0.10) ) )
           SolvencyClass = 2;
       else
           SolvencyClass = 3;
       end;

       if(S > 2.35)
           SolvencyClass = 3;
       end;
   else
       MsgBox ("Не найден заемщик в справочнике клиентов");
       return 0;
   end;
   return SolvencyClass;
end;

MACRO СохранитьПримечание(Заемщик, ДатаИзменения, КлассКредитоспособности, ПримечаниеЗаемщика)
   ClearRecord(party);
   party.PartyID = Заемщик;
   IF (getEQ(party))
      addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 42, КлассКредитоспособности, ДатаИзменения);
      addNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 43, ПримечаниеЗаемщика,      ДатаИзменения);
   END;
END;