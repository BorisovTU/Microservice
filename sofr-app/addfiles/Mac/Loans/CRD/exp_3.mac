/*---------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : exp_3.mac
 Description : Создание документа по шагу операции (Просрочка суммы превышения лимита)
 Programmer  : Tereschenko FS
 30.01.2004  : Создан
-----------------------------------------------------------------------------------*/
import SbCrdInter, macperc;

record ШагОперации ("step_op.dbt",  "loans.def");     /* Запись шага операции */
record Документ    ("doc_acc.dbt",  "loans.def");     /* Буфер документа      */
record Операция    ("crd_op.dbt",   "loans.def");     /* Операция по договору */
record Договор     ("credit_c.dbt", "loans.def");

macro ВыполнитьШаг (OperDate, Sum, Data)
    VAR DocID : integer = 0;
    VAR STAT  : integer = 0;
    VAR СуммаОД  : moneyl = $0;
    VAR СуммаНОД : moneyl = $0;


    СуммаНОД = GetPaySum  (DS_NOOVCRD, Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref);

    Документ.CarrySum = СуммаНОД;

    stat = СоздатьДокумент(Документ, DocID);
    IF ((stat == 0) and (Документ.CarrySum != $0))
       stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_LIM, DocID, -СуммаНОД, Операция.CredOperID);
       IF (stat == 0)
           stat = ИзменитьРегистр(Операция.ObjectTypeID_Ref, Операция.ObjectID_Ref, TDR_OV, DocID, СуммаНОД, Операция.CredOperID);
       END;
    END;

    RETURN STAT;
END;