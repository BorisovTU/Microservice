/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : restsrep.mac
 Description : Отчёт о состоянии ссудной задолженности

 Programmer  : SAE
 2001-04-19  : Создан
 2008-11-14  : Manushkina (Оптимизация + переход на WindowsReports)
------------------------------------------------------------------------------*/

import "or_tpl_h.mac", total, RsbDataSet;

const ALL_FLAGCUR = 0; // все виды кредитов для данного режима валютности

const OBJ_PARTY_GROUP_CHARACTER = 2; // характер отношений с банком
const OBJ_ORG_PRAV_FORM = 4;         // организационно-прововая форма
const OBJ_PART_EKONOM = 6;           // отрасль экономики

private const TemplateName:string = "RestsRep.xls";

private var ExcelObj : CTemplateXLS = CTemplateXLS ();
private var TemplateTable : object = NULL;
private var Obj : C_CSVFile = C_CSVFile ();
private var FileNameCSV : string = obj.CreateFullFileName ("data.txt");

private var ВидыКредитов = TBFIle ("set_tcr.tmp", "r", 0); // временный файл для выбора видов кредита
FILE Филиалы      ("set_lfd.tmp",  "loans.def"); // временный файл филиалов

var RepDate : date = {curdate};
var SetFlag = 0;

var TotalPaySumRub : money = $0; // сумма выданого кредита в рублях
var TotalRestDuty  : money = $0; // сумма ссудной задолженности
var TotalRestExpd  : money = $0; // сумма просроченной задолженности
var TotalRestExpp  : money = $0; // сумма просроченных процентов
var TotalRezCalc   : money = $0; // сумма расчитаного резерва
var TotalRezFact   : money = $0; // сумма фактического резерва

var TimeStart, TimeFinish;

var StrCmd : string = "";
var rsRow : object = NULL;
var RSDcmd : object = NULL;
//var i: integer = 0;
var tempstr: string = "";

   // параметры отчета
   // .. дата отчета
   RepDate = {curdate};
   if (not GetDate (RepDate, "Введите дату отчёта:"))
      return;
   end;
   // .. выбор филиалов
   while (SetFlag == 0)
      if (УстановитьФилиалы() == false)
         return;
      else
         Rewind(Филиалы);
         while (Next(Филиалы) and (SetFlag == 0))
            if (Филиалы.SetFlag == "X")
              SetFlag = 1;
            end;
         end;

         if (SetFlag == 0)
            MsgBox("Не один филиал не выбран!");
            Close(Филиалы);
         end;
      end;
   end;
   // выбор видов кредитов
   УстановитьВидыКредитов (ALL_FLAGCUR);
   ВидыКредитов.Rewind();
   SetFlag = 0;
   while (ВидыКредитов.Next() and (SetFlag == 0))
      if (ВидыКредитов.rec.SetFlag == "X")
         SetFlag = 1;
      end;
   end;
   if (SetFlag == 0)
      MsgBox("Не один вид кредита не выбран!");
      return;
   end;

   // отбор данных
   BegAction (1, "Формирование отчета. Ждите, это может занять несколько минут.", false);

   StrCmd = "SELECT * FROM TABLE(LoansUserFunction.RestRepQuery(?))";
   TimeStart = time ();
   RSDcmd = RsdCommand (RslDefCon, StrCmd);

   RSDcmd.addParam ("", RSDBP_IN); RSDcmd.value (0) = RepDate; // дата отчета

   rsRow = RsdRecordset(RSDcmd);
   RSDcmd.execute;

   // вывод отчета
   if (rsRow == NULL)
      return 0;
   end;

   if (Obj.FileOpen (FileNameCSV, true))
      while ((rsRow.MoveNext()) and (rsRow.value(0, null, V_INTEGER) != NULL))
/*
         for (i, 1, rsRow.FldCount - 1)
   	   if ((ValType (rsRow.value (i)) == V_STRING) and (rsRow.value (i) == StrFor(1)))
   	  	rsRow.value(i, null, V_STRING) = "";
   	   end;
         end;
*/       

         // Номер
         Obj.AddCell (rsRow.value ("f1", null, V_INTEGER));
         // Организационно-правовая форма
         tempstr = rsRow.value ("f2", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Отрасль экономики
         tempstr = rsRow.value ("f3", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Ссудный счет
         tempstr = rsRow.value ("f4", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Пользовательский номер КД + дата начала КД
         tempstr = rsRow.value ("f5", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Наименование заемщика
         tempstr = rsRow.value ("f6", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Подразделение выдавшее кредит
         tempstr = rsRow.value ("f7", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // (флаг) Льготность
         tempstr = rsRow.value ("f8", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // инсайдер
         tempstr = rsRow.value ("f9", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Адрес регистрации
         tempstr = rsRow.value ("f10", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Место работы и должность
         tempstr = rsRow.value ("f11", null, V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Выданная сумма в рублях
         Obj.AddCell (SQL_NVL(rsRow.value ("f12"), V_DOUBLE)); TotalPaySumRub = TotalPaySumRub + SQL_NVL(rsRow.value ("f12"), V_DOUBLE);  
         // Выданная сумма в валюте
         Obj.AddCell (SQL_NVL(rsRow.value ("f13"), V_DOUBLE));
         // Дата выдачи кредита
         // При отсутствии выдачи по кредиту поле не заполняем
         tempstr = rsRow.value ("f5", null, V_STRING);
         var contrRegDate:date = date(TRIM(SubStr(tempstr, StrLen(tempstr) - 10))); //извлекаем из строки дату. которая находится в конце строки в виде dd.mm.yyyy
         var issuanceDate:date = SQL_NVL(rsRow.value ("f14"), V_DATE); 		    // дата выдачи. принимает значение 02.01.0001 если выдачи небыло
         if (issuanceDate < contrRegDate)
           Obj.AddCell ("")
         else
           Obj.AddCell (issuanceDate);
         end;
 
         // Цель кредита
         tempstr = SQL_NVL(rsRow.value ("f15"), V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;
         // Дата погашения по договору
         Obj.AddCell (rsRow.value ("f16", null, V_DATE));
         // Дата погашения с учетом последней пролонгации
         Obj.AddCell (rsRow.value ("f17", null, V_DATE));
         // Остаток ссудной задолженности на отчетную дату
         Obj.AddCell (SQL_NVL(rsRow.value ("f18"), V_DOUBLE)); TotalRestDuty = TotalRestDuty + SQL_NVL(rsRow.value ("f18"), V_DOUBLE);
         // Процентная ставка
         Obj.AddCell (SQL_NVL(rsRow.value ("f19"), V_DOUBLE));
         // Сумма обеспечения (ценные бумаги)
         Obj.AddCell (SQL_NVL(rsRow.value ("f20"), V_DOUBLE));
         // Сумма обеспечения (поручительства)
         Obj.AddCell (SQL_NVL(rsRow.value ("f21"), V_DOUBLE));
         // Сумма обеспечения (другие виды)
         Obj.AddCell (SQL_NVL(rsRow.value ("f22"), V_DOUBLE));
         // Сумма обеспечения (всего)
         Obj.AddCell (SQL_NVL(rsRow.value ("f23"), V_DOUBLE));
         // Просроченный ОД сумма
         Obj.AddCell (SQL_NVL(rsRow.value ("f24"), V_DOUBLE)); TotalRestExpd = TotalRestExpd + SQL_NVL(rsRow.value ("f24"), V_DOUBLE);
         // Просроченный ОД кол-во дней
         Obj.AddCell (rsRow.value ("f25", null, V_INTEGER));
         // Просроченные проценты сумма
         Obj.AddCell (SQL_NVL(rsRow.value ("f26"), V_DOUBLE)); TotalRestExpp = TotalRestExpp + SQL_NVL(rsRow.value ("f26"), V_DOUBLE);
         // Просроченные проценты кол-во дней
         Obj.AddCell (rsRow.value ("f27", null, V_INTEGER));
         // Кол-во переоформлений с изменением условий
         Obj.AddCell (rsRow.value ("f28", null, V_INTEGER));
         // Кол-во переоформлений без изменения условий
         Obj.AddCell (rsRow.value ("f29", null, V_INTEGER));
         // Кол-во пролонгаций
         Obj.AddCell (rsRow.value ("f30", null, V_INTEGER));
         // ККС
         Obj.AddCell (rsRow.value ("f31", null, V_INTEGER));
         // Сумма резерва расчетная
         Obj.AddCell (SQL_NVL(rsRow.value ("f32"), V_DOUBLE)); TotalRezCalc = TotalRezCalc + SQL_NVL(rsRow.value ("f32"), V_DOUBLE);
         // Сумма резерва фактическая
         Obj.AddCell (SQL_NVL(rsRow.value ("f33"), V_DOUBLE)); TotalRezFact = TotalRezFact + SQL_NVL(rsRow.value ("f33"), V_DOUBLE);
         // Перспективы погашения по ссудам, 3 и 4 ККС
         tempstr = SQL_NVL(rsRow.value ("f34"), V_STRING);
         if (tempstr == StrFor (1))
           Obj.AddCell ("")
         else
           Obj.AddCell (tempstr);
         end;

         Obj.AddRow ();
      end; // while

      Obj.AddCell (" ");
      Obj.AddCell ("ИТОГО");
      Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" ");  Obj.AddCell (" "); Obj.AddCell (" ");
      Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" ");
      Obj.AddCell (TotalPaySumRub);
      Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" ");  Obj.AddCell (" ");
      Obj.AddCell (TotalRestDuty);
      Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" ");  Obj.AddCell (" ");
      Obj.AddCell (TotalRestExpd);
      Obj.AddCell (" ");
      Obj.AddCell (TotalRestExpp);
      Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" "); Obj.AddCell (" ");  Obj.AddCell (" ");
      Obj.AddCell (TotalRezCalc);
      Obj.AddCell (TotalRezFact);
      Obj.AddCell (" ");
      Obj.AddRow ();
   end; // if
   Obj.FileClose ();

   TimeFinish = time ();

   EndAction (1);

   if (ExcelObj.OpenTemplate (TemplateName))
      ExcelObj.SetValue_NameCell("Head", "Отчёт о состоянии ссудной задолженности на " + string (RepDate:m));
      TemplateTable = ExcelObj.RegisterTable ("tmp_row");
      TemplateTable.FillTabelFromCSV (FileNameCSV, 1);
      TemplateTable.EndTable ();
      ExcelObj.SaveAsTemplate ();
      msgbox ("Отчет сформирован. Время формирования " + string(TimeFinish-TimeStart));
   end;