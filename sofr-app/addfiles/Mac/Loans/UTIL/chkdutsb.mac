/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : chkduty.mac
 Description : Макрос проверки обязательства, инициализация счетов Retail'а

 Programmer  : Tereshenko F.S.
 19.09.03    : Создан
------------------------------------------------------------------------------*/
import LoansFind, SbCrdInter, total;

record Буфер       ("duty_crd.dbt", "loans.def"); /* Текущий буфер СО */
record Договор     ("credit_c.dbt", "loans.def");
record СтарыйБуфер ("SUM.",         "loans.def"); /* Рассчитанная сумма */
/*
CONST
  ТипБИКСчета = 10000,
  ТипНомерСчета = 10001;

var FNCash; // = NumFNCash();
*/

/* Инициализация */
macro __Init__()
/*  file Заявка  ("claim.dbt", "loans.def") key 2;
  file СчетRetail  ("depositr.dbt", "sbbank.def") key 7;
  file Dep         ("depparm.dbt", "sbbank.def");

  var Счет = "",
      БИК = "";

  clearrecord(Заявка);
  Заявка.CreditNumber_Ref = Буфер.CreditNumber_Ref;
  if (GetEQ(Заявка) and (Заявка.CreditNumber_Ref == Буфер.CreditNumber_Ref) )
     БИК = GetUsFieldValue(LO_CLAIM, Заявка.ClaimID, ТипБИКСчета, Буфер.DutyFirstDate);
     Счет= GetUsFieldValue(LO_CLAIM, Заявка.ClaimID, ТипНомерСчета, Буфер.DutyFirstDate);
     if ( (БИК == "") and (Счет != "") )
         // Инициализируем счет RS-Retail
         FNCash = 0;
         rewind(Dep);
         while ( next(Dep) and (Буфер.RetailAccPay_Ref == 0) )
            FNCash = Dep.FNCash;
            clearrecord(СчетRetail);
            СчетRetail.FNCash = FNCash;
            СчетRetail.Account = Счет;
            if ( GetEQ(СчетRetail)
                and ( СчетRetail.FNCash == FNCash )
                and ( СчетRetail.Account == Счет ) )

                Буфер.RetailAccPay_Ref =  СчетRetail.Referenc;
                Буфер.RetailAccDuty_Ref =  СчетRetail.Referenc;
            else
 //              msgbox("Указанный в заявке счет заемщика ", Счет,
 //               " |не найден в RS-Retail");
            end;
         end;
     end;
  end;
*/
  return true;
end;

/* Вставка */
macro __Check_Input__ ()
    var;
    Loans_FindCrdContract(Буфер.CreditNumber_Ref, Договор);
    /*((Договор.PayType == CF_CRLIN)or(Договор.PayType == CF_CRLINNO)or(Договор.PayType == CF_CRLINNEW))*/
    if(((Договор.PayType == CF_REP)    and (Буфер.DutySum > СтарыйБуфер(0))) or
       ((Договор.PayType == CF_NONREP) and (Буфер.DutySum > Договор.CreditSum)))
         MsgBox("Неверно задана сумма");
         return false;
    end;

    if ((Буфер.DutySum == 0) and (Договор.PayType == CF_NONREP))
       MsgBox("Сумма обязательства должна быть больше нуля");
       return false;
    end;

    return true;
end;

/* Правка */
macro __Check_Edit__ ()
    var;
    Loans_FindCrdContract(Буфер.CreditNumber_Ref, Договор);
    if(((Договор.PayType == CF_REP)    and (Буфер.DutySum > СтарыйБуфер(0))) or
       ((Договор.PayType == CF_NONREP) and (Буфер.DutySum > Договор.CreditSum)))
         MsgBox("Неверно задана сумма");
         return false;
    end;
    if ((Буфер.DutySum == 0) and (Договор.PayType == CF_NONREP))
       MsgBox("Сумма обязательства должна быть больше нуля");
       return false;
    end;
    return true;
end;

/* Удаление */
macro __Check_Delete__ ()
    return true;
end;


/* Проверка операции выдачи */
MACRO Check_Pay(opDate: date, SumOp: money, TypeOp: integer, ObjectID: integer, ObjectTypeID: integer)
   IF (ObjectTypeID == LO_DUTY)
      IF (Буфер.DutyFirstDate != opDate)
         MsgBox("Дата выдачи не равна дате начала действия срочного обязательства!");
         RETURN FALSE;
      END;
   ELSE
      IF (Договор.RegDate != opDate)
         IF (not GetTrue(TRUE, "Дата выдачи не равна дате начала действия договора. | Продолжить ?"))
            RETURN FALSE;
         END;
      END;
   END;

   RETURN TRUE;
END;