/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ens_sum.mac
 Description : Расчёт суммы и валюты поручительства договора обеспечения
               Сумма поручительства рассчитывается по сумме КД + %% за весь срок действия КД
 Programmer  : Vasyukova O.E.
 06.02.03    : Создан
 Изменения   :
------------------------------------------------------------------------------*/
import "total.mac", SbCrdInter, ПроцентыБухгалтер;

record       enscontr  ("enscontr.dbt", "loans.def");  /* текущий буфер договора обеспечения*/
private file credit_c  ("credit_c.dbt", "loans.def") key 0;  /* Ключ по ID кредитного договора*/
private file ensobj    ("ensobj.dbt"  , "loans.def") key 0;  /* Ключ по ID кредитного договора*/
private file lchistry    ("lchistry.dbt"  , "loans.def") key 0;
private file lcusrate    ("lcusrate.dbt"  , "loans.def") key 0;
private file lufotype    ("lufotype.dbt"  , "loans.def") key 1 write;
private file lufvalue    ("lufvalue.dbt"  , "loans.def") key 0 write;

/*    Остаток от деления    */
private macro ПолучитьОстатокОтДеления (num1, num2)

  rest = num1 - num1 / num2 * num2;
  return rest;
end;

/* Процедура расчета прогнозируемых процентов по договору поручительства
*/
private macro GetSumEnscontr( CreditSum, ProcOD, BegDate, EndDate )
    var SumProc = $0;
    var dd1 = 0, mm1 = 0, yy1 = 0;
    var dd2 = 0, mm2 = 0, yy2 = 0,tmp=0;
    var Високосность =  false;
    var date_year    = 365;
    var kol_period   = 0;
    var i = 1;
    var One_Date = BegDate, Two_Date = EndDate;

    DateSplit(BegDate, dd1, mm1, yy1);
    DateSplit(EndDate, dd2, mm2, yy2);

    if ( yy1 == yy2 )
        if ( ПолучитьОстатокОтДеления (yy1, 4) == 0)
            date_year = 366;
        else
            date_year = 365;
        end;
        SumProc =  moneyl(CreditSum*ProcOD*(EndDate-BegDate)/100.00/date_year);
    else
        kol_period = yy2 - yy1;
        if (kol_period <= 0)
            return $0;
        end;
        while (i <= kol_period)
            if ( ПолучитьОстатокОтДеления ((yy1+i-1), 4) == 0 )
                SumProc = SumProc + moneyl(CreditSum*ProcOD*(date(31,12,(yy1+i-1)) - One_Date)/100.00/366);
                tmp = tmp + int(date(31,12,(yy1+i-1)) - One_Date);
                One_Date = Date(31,12,(yy1+i-1));
            else
                SumProc = SumProc + moneyl(CreditSum*ProcOD*(date(31,12,(yy1+i-1)) - One_Date)/100.00/365);
                tmp = tmp + int(date(31,12,(yy1+i-1)) - One_Date);
                One_Date = Date(31,12,(yy1+i-1));
            end;
            i = i + 1;
        end;
        if ( ПолучитьОстатокОтДеления (yy2, 4) == 0)
          SumProc = SumProc + moneyl(CreditSum*ProcOD*(EndDate - One_Date)/100.00/366);
          tmp = tmp + int(date(31,12,(yy1+i-1)) - One_Date);
        else
          SumProc = SumProc + moneyl(CreditSum*ProcOD*(EndDate - One_Date)/100.00/365);
          tmp = tmp + int(date(31,12,(yy1+i-1)) - One_Date);
        end;
    end;
    return SumProc;
end;

/*
   Вызывается по F6 из панели корректировки договора обеспечения
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   Входные параметры:

*/
macro CalcEnsSum ()
  var CalcDate:date;
  var ContrCurRate, ObjCurRate:moneyL;
  var ПроцОД=0.0, СуммПР, result;
  var flag:bool;

  CalcDate = {curdate};
  if ( not getdate( CalcDate, "Введите дату расчета: ") )
    return false;
  end;

  if (CalcDate < enscontr.EnsContractFirstDate )
     msgbox("Дата расчета меньше даты начала договора");
     return false;
  end;

  if (CalcDate > enscontr.EnsContractLastDate )
     msgbox("Дата расчета больше даты окончания договора");
     return false;
  end;

  enscontr.EnsContractCur = credit_c.CurCode;
  /*********************************************/
  if (enscontr.EnsContractCur != 0)
        ContrCurRate = GetCurrRate(CalcDate, enscontr.EnsContractCur);
        if (ContrCurRate == 0.0)
            MsgBox("Не определен курс валюты!");
            return false;
        end;
  else
        ContrCurRate = 1;
  end;
  /*********************************************/


  /***если вдруг что-то нужно из кредитного догвора***/
  credit_c.CreditNumber = enscontr.CreditNumber_Ref;

  if( not GetEQ(credit_c) )
    MsgBox("Не найден кредитный договор");
    return false;
  end;
  /***************************************************/

  /*********Расчет суммы и валюты*********************/
  if ( ( enscontr.EnsSysType == Поручительство )/* and (enscontr.EnsContractStatus == 2)*/ )/*для поручительств*/
     lcusrate.ObjectID_Ref=1;
     lcusrate.CredObjID_Ref=credit_c.CreditNumber;
     lcusrate.TypeRateID_Ref=1;
     if(geteq(lcusrate))
       lchistry.RateID_Ref=lcusrate.RateID_Ref;
       lchistry.RateDate=date(0,0,0);
       result=getge(lchistry);
       while(result and (lchistry.RateID_Ref==lcusrate.RateID_Ref))
         if(lchistry.RateState==2)
           ПроцОД=lchistry.RateVal;
         end;
         result=next(lchistry);
       end;
     end;
     if(ПроцОД>0.0)
       СуммПР=GetSumEnscontr(credit_c.CreditSum, ПроцОД, credit_c.RegDate, credit_c.ReturnDate);
     end;

     enscontr.EnsContractSum  = credit_c.CreditSum + moneyl(СуммПР);
  else

     ensobj.EnsContractID_Ref = enscontr.EnsContractID;
     flag = false;

     if(not flag)
        enscontr.EnsContractSum = $0;
     end;

     while((next(ensobj)) and (ensobj.EnsContractID_Ref == enscontr.EnsContractID))
       if (ensobj.EnsObjectCur != 0)
          ObjCurRate = GetCurrRate(CalcDate,ensobj.EnsObjectCur);
          if ( ObjCurRate == 0.0)
              MsgBox("Не определен курс валюты!");
              return false;
          end;
       else
           ObjCurRate = 1;
       end;

       flag = true;
       ensobj.EnsObjectSum      = ConvSum(ensobj.EnsObjectSum, (ObjCurRate/ContrCurRate));
       enscontr.EnsContractSum  = enscontr.EnsContractSum + ensobj.EnsObjectSum;
     end;

  end;
/*  SumProc ();*/
  /***************************************************/
  return true;

END;


/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ens_sum.mac
 Description : Расчёт учетной суммы обеспечения

 Programmer  : Tereshenko F.S.
 19.06.03    : Создан
 Изменения   :
------------------------------------------------------------------------------*/
macro CalcDirectSum()
   var Sum:money;
   var SumProc = $0;
   var ContrCurRate, ObjCurRate:moneyL;
   var ПроцОД=0.0, СуммПР, result;
   var flag:bool;

      /***если вдруг что-то нужно из кредитного догвора***/
      credit_c.CreditNumber = enscontr.CreditNumber_Ref;

      if( not GetEQ(credit_c) )
        MsgBox("Не найден кредитный договор!");
        return false;
      end;
      /***************************************************/
   if ( enscontr.EnsSysType == Поручительство )
     lcusrate.ObjectID_Ref=1;
     lcusrate.CredObjID_Ref=credit_c.CreditNumber;
     lcusrate.TypeRateID_Ref=1;
     if(geteq(lcusrate))
       lchistry.RateID_Ref=lcusrate.RateID_Ref;
       lchistry.RateDate=date(0,0,0);
       result=getge(lchistry);
       while(result and (lchistry.RateID_Ref==lcusrate.RateID_Ref))
         if(lchistry.RateState==2)
           ПроцОД=lchistry.RateVal;
         end;
         result=next(lchistry);
       end;
     end;
     if( ПроцОД > 0.0 )
       SumProc = GetSumEnscontr(credit_c.CreditSum, ПроцОД, credit_c.RegDate, credit_c.ReturnDate);
     end;
   end;

   Sum = Enscontr.EnsContractSum + SumProc;

   return Sum;
END;

macro PrintLoansReport(CreditBuf)

end;
