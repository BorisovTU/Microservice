/*------------------------------------------------------------------------------
                     Библиотека интерпретируемых модулей

 Filename    : ChkCrdSB.mac
 Description : Макрос инициализации, проверки кредитного договора
 Programmer  : TFS
------------------------------------------------------------------------------*/
import SbCrdInter;

record СтарыйБуфер ("credit_c.dbt", "loans.def");  /* Буфер заявки до обновления/вставки */
record Буфер       ("credit_c.dbt", "loans.def");  /*                                    */
record Заявка      ("claim.dbt", "loans.def");     /* Текущий буфер заявки               */

macro __Init__()
//    IF (Заявка.ClaimID != 0)
//       MsgBox("Дата утверждения заявки: ", Заявка.ApprovalDate);
//    END;
    return true;
end;

macro __Check_Input__ ()
    // Сумма кредита должна быть равна сумме, указанной в
    // заявке (если такая есть)
    if ( (Заявка.ClaimID != 0) and (Заявка.BCreditSum != Буфер.CreditSum)
         and (Буфер.PayType == CF_NONREP))
        msgbox("Сумма кредита должна быть равна ", Заявка.BCreditSum,
               "| Договор оформляется по заявке № ", Заявка.ClaimNumber);
        return false;
    end;
    if (Заявка.ClaimID != 0)
       if ((Буфер.RegDate - Заявка.ApprovalDate) > 10)
           MsgBox("Дата оформления договора превышает дату утверждения заявки более чем на 10 дней.");
           return false;
       end;
    end;

    return true;
end;

macro __Check_Edit__ ()
    file   Cl  ("claim.dbt", "loans.def") key 2;

    // Сумма кредита должна быть равна сумме, указанной в
    // заявке (если такая есть)
    clearrecord(Cl);
    Cl.CreditNumber_Ref = Буфер.CreditNumber;
    if ( GetEQ(Cl) and (Cl.CreditNumber_Ref == Буфер.CreditNumber)
         and (Cl.BCreditSum != Буфер.CreditSum)
         and (Буфер.PayType == CF_NONREP))
        msgbox("Сумма кредита должна быть равна ", Cl.BCreditSum,
               "| Договор оформляется по заявке № ", Cl.ClaimNumber);
        return false;
    end;
    if (Заявка.ClaimID != 0)
       if ((Буфер.RegDate - Заявка.ApprovalDate) > 10)
           MsgBox("Дата оформления договора превышает дату утверждения заявки более чем на 10 дней.");
           return false;
       end;
    end;
    return true;
end;
 
macro __Check_Delete__ ()
    return true;
end;