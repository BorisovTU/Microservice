import secinter;

PRIVATE CONST dealid_str = "1883258,1883314,4145806,4145882,4145539,7399140,7399556,7399588,7399618,7399653,"
                         + "7399690,7399725,7399757,7399788,7399812,7399842,7399872,7399899,7399923,7399948,"
                         + "7399979,7400003,7400028,7400342,3225257,8501624,8501600,7393208,7392945,7393003,"
                         + "7393321,7393105,7393159,7393272,7392046,7393054,7391567,7395708,7398788,7398970,"
                         + "7398116,3782222,9130065,"
                         + "7394599,7394654,7394708,7395522,7395949,7396003,7396106,7396160,7396208,7396478,7396527,7396581,7396634,"
                         + "7403777,"
                         + "7399978,7392673,7392617,7392563,7392497,7392007,7391945,7391893,7391840,7393448,"
                         + "7393388,7391788,7391728,7393368,7393340,7393315,7393292,7391671,7391613,7393260,"
                         + "7393200,7393150,7393085,7393025,7392971,7392906,7392862,7392808,7392755,7392704,"
                         + "7392653,7392601,7392543,7392490,7392433,7392370,7392319,7392268,7392205,7392135,"
                         + "7392076,7396020,7398298,7397539,7395266,7399154,7397315,7397250";

private const HeadTable = "ÚÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"
                          "³ Š®¤ ‘Ž ‚“ ³ „ â  ®¯¥à æ¨¨ ³ Š®¤ á¤¥«ª¨ ³ „ â  á¤¥«ª¨  ³   Š®¤ ª«¨¥­â   ³   ®¬¥à ¤®£®¢®à    ³    Š®¤ æ/¡    ³         ¨¬¥­®¢ ­¨¥ æ/¡          ³ ‚ë¯®«­¥­  ³\n"
                          "ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";


PRIVATE VAR comm_arr = TArray();

PRIVATE MACRO CorrectInAcc()
  var comm, stat = 0, nextnumb = 0;
  var cmd, rs;

  execSQL(" UPDATE daccount_dbt "
        + "    SET t_Open_Date = TO_DATE ('05052022', 'ddmmyyyy') "
        + "  WHERE     t_Chapter = 22 "
        + "        AND t_Account IN ('510002685990000835280001', '610002685990000835280000') "
        + "        AND t_Code_Currency = 2212 ");

  execSQL(" UPDATE daccount_dbt "
        + "    SET t_Open_Date = TO_DATE ('14062022', 'ddmmyyyy') "
        + "  WHERE     t_Chapter = 22 "
        + "        AND t_Account IN ('510010887990002118780001', '610010887990002118780000') "
        + "        AND t_Code_Currency = 60775 ");

  execSQL(" BEGIN "
        + "    FOR one_grdeal "
        + "       IN (SELECT DISTINCT grdeal.t_Id "
        + "             FROM ddl_tick_dbt tick, "
        + "                  ddlgrdeal_dbt grdeal, "
        + "                  ddlgrtemplacc_dbt grtemplacc "
        + "            WHERE     tick.t_DealId IN (1883258, 1883314) "
        + "                  AND grdeal.t_DocId = tick.t_DealId "
        + "                  AND grdeal.t_DocKind = tick.t_BOfficeKind "
        + "                  AND grtemplacc.t_TemplNum = grdeal.t_TemplNum "
        + "                  AND grtemplacc.t_AccNum = " + DLGR_ACCKIND_INNER
        + "                  AND NOT EXISTS "
        + "                             (SELECT 1 "
        + "                                FROM ddlgracc_dbt "
        + "                               WHERE t_GrDealId = grdeal.t_Id "
        + "                                     AND t_AccNum = grtemplacc.t_AccNum)) "
        + "    LOOP "
        + "       RSI_DLGR.RSI_UpdateGrDealAccById (one_grdeal.t_Id, " + DLGR_ACCKIND_INNER + ", " + DLGRACC_STATE_PLAN + ", NULL, 0); "
        + "    END LOOP; "
        + "    RSI_DLGR.RSI_ExecCommitDlGr(); "
        + " END; " );

  execSQL(" BEGIN "
        + "    FOR one_grdeal "
        + "       IN (SELECT grdeal.t_Id "
        + "             FROM ddl_tick_dbt tick, ddlgrdeal_dbt grdeal "
        + "            WHERE tick.t_DealId IN ( " + dealid_str + " ) "
        + "                  AND grdeal.t_DocId = tick.t_DealId "
        + "                  AND grdeal.t_DocKind = tick.t_BOfficeKind "
        + "                  AND EXISTS "
        + "                        (SELECT 1 "
        + "                           FROM ddlgracc_dbt gracc "
        + "                          WHERE     gracc.t_GrDealId = grdeal.t_Id "
        + "                                AND gracc.t_AccNum = " + DLGR_ACCKIND_INNER 
        + "                                AND gracc.t_State = " + DLGRACC_STATE_FACTEXEC + ") "
        + "                 AND NOT EXISTS "
        + "                            (SELECT 1 "
        + "                               FROM ddlgrdoc_dbt grdoc, dacctrn_dbt acctrn "
        + "                              WHERE     grdoc.t_grdealid = grdeal.t_id "
        + "                                    AND grdoc.t_dockind = " + DLDOC_CARRY
        + "                                    AND grdoc.t_ServDocKind = " + DL_INACCSRVOP
        + "                                    AND acctrn.t_acctrnid = grdoc.t_docid)) "
        + "    LOOP "
        + "       RSI_DLGR. RSI_BackUpdateGrDealAccById (one_grdeal.t_Id, " + DLGR_ACCKIND_INNER + ", 0);"
        + "    END LOOP; "
        + " END; ");

  cmd = RSDCommand("   SELECT DISTINCT tick.t_DealId, tick.t_DealType, tick.t_pfi, tick.t_ClientId, tick.t_ClientContrId, grdeal.t_PlanDate "
                 + "     FROM ddl_tick_dbt tick, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
                 + "    WHERE tick.t_DealId IN ( " + dealid_str + " ) "
                 + "          AND grdeal.t_DocId = tick.t_DealId "
                 + "          AND grdeal.t_DocKind = tick.t_BOfficeKind "
                 + "          AND gracc.t_GrDealId = grdeal.t_Id "
                 + "          AND gracc.t_AccNum = " + DLGR_ACCKIND_INNER
                 + "          AND gracc.t_State = " + DLGRACC_STATE_PLAN
                 + " ORDER BY t_PlanDate ");
  rs = RSDRecordset(cmd);

  while (rs.MoveNext())
    GenerateReference(227, nextnumb);

    comm = TRecHandler("dl_comm.dbt");

    comm.Clear();
  
    comm.rec.dockind = DL_INACCSRVOP/*4613*/;
    comm.rec.oper = "1";
    comm.rec.division = 1;
    comm.rec.commstatus = 0;
    comm.rec.PartyId = -1;
    comm.rec.issuerID = -1;
    comm.rec.newFIID = -1;//ª®¤ ”ˆ § ¯®«­ïâì ¥á«¨ æ/¡, ¨­ ç¥ -1
    comm.rec.commcode = nextnumb;
    comm.rec.commdate = rs.Value("t_PlanDate");//„ â  ®¯¥à æ¨¨
    comm.rec.operationkind = 0;//‚¨¤ ¤¥©áâ¢¨ï
    comm.rec.opersubkind = rs.Value("t_DealType");//‚¨¤ ®¯¥à æ¨¨
    comm.rec.deal1 = rs.Value("t_DealId");
    comm.rec.fiid = rs.Value("t_pfi");// ª®¤ ”ˆ § ¯®«­ïâì ¥á«¨ ­¥ æ/¡, ¨­ ç¥ -1
    comm.rec.contractkind = 1;
    comm.rec.clientid = rs.Value("t_ClientId");
    comm.rec.contractid = rs.Value("t_ClientContrId");

    stat = SC_CreateDlCommOperation(comm);

    if(stat == 0)
      comm_arr[comm_arr.Size] = comm;
      println("‘ä®à¬¨à®¢ ­  ‘Ž ‚“ á ª®¤®¬ \"" + comm.rec.commcode + "\"");
    else
      println("¥ ã¤ «®áì ¢áâ ¢¨âì ‘Ž ‚“ ­  ¤ âã "+ rs.Value("t_PlanDate"));
    end;
  end;

onError(err)
  println(err.Message);

  AbortTrn();
END;


LoopInTrn(true);

if (ProcessTrn(0, "CorrectInAcc"))
  if (comm_arr.Size > 0)
    var ProgressIndicator = CreateProgressIndicator();
    var Rep = CMakeReport(HeadTable);
    var stat, cmd, rs;
    var dealcode, dealdate, ptcode, contrnum, ficode, finame;
    
    ProgressIndicator.Start(comm_arr.Size, "Š®àà¥ªâ¨à®¢ª  ¤ ­­ëå ‚“", "‚ë¯®«­¥­¨¥ áä®à¬¨à®¢ ­­ëå ‘Ž ‚“");

    for (var i, 0, comm_arr.Size - 1 )
      stat = SC_ServOperExecuteSilent(DL_INACCSRVOP, comm_arr[i].rec.DocumentId);

      cmd = RSDCommand("SELECT tick.t_DealCode, tick.t_DealDate, ptcode.t_Code, sfcontr.t_Number, fi.t_FI_Code, fi.t_Name "
                     + "  FROM ddl_tick_dbt tick, dobjcode_dbt ptcode, dsfcontr_dbt sfcontr, dfininstr_dbt fi "
                     + " WHERE tick.t_DealId = ? "
                     + "   AND ptcode.t_ObjectId = tick.t_ClientId "
                     + "   AND ptcode.t_ObjectType = " + OBJTYPE_PARTY
                     + "   AND ptcode.t_CodeKind = " + PTCK_CONTR 
                     + "   AND sfcontr.t_Id = tick.t_ClientContrId "
                     + "   AND fi.t_FIID = tick.t_PFI ");
      cmd.AddParam("", RSDBP_IN, comm_arr[i].rec.Deal1);
      rs = RsdRecordset(cmd);

      if(rs.MoveNext())
        dealcode = rs.Value("t_DealCode");
        dealdate = date(rs.Value("t_DealDate"));
        ptcode   = rs.Value("t_Code");
        contrnum = rs.Value("t_Number");
        ficode   = rs.Value("t_FI_Code");
        finame   = rs.Value("t_Name");
      end;

      Rep.AddPrintCell(comm_arr[i].rec.CommCode);
      Rep.AddPrintCell(comm_arr[i].rec.CommDate);
      Rep.AddPrintCell(dealcode);
      Rep.AddPrintCell(dealdate);
      Rep.AddPrintCell(ptcode);
      Rep.AddPrintCell(contrnum);
      Rep.AddPrintCell(ficode);
      Rep.AddPrintCell(finame);
      Rep.AddPrintCell(iif(stat == 0, "X", ""), 11, 0, "c");
      Rep.AddStr();

      ProgressIndicator.Update(i + 1, comm_arr.Size);
    end;

    Rep.PrintRep();

    ProgressIndicator.Stop();
  end;
end;


