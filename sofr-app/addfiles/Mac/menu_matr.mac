/********************************************************************************/
/* DESCRIPTION  :   Вывод результатов sql-запроса в Excel                       */
/* PROGRAMMED BY:   Белохонов П.В.                                              */
/* CREATION DATE:   12.04.2010                                                  */
/********************************************************************************/

import "cb_sql.mac", "or_rep_h.mac";

/*Запрос по умолчанию*/
//PRIVATE VAR sql = "select * from dparty_dbt where t_partyid < 10" ;
PRIVATE VAR sql = "" ;

private var Dt1, cmd1, i = 0,count = 0, Choice, Con; 
private var Rep:CMakeReport;
private var Fields = TArray(), MenuValues   = TArray();

const Env = RsdEnvironment("RDDrvO","RDDrvO.dll");

private macro sstring(Val);
  var s = "";
  var stat = 0;
  s = string(val);
  if (index(s,".") <= 0)
     return s;
  end;

  while (index(s,".") > 0)
     if ((substr(s,strlen(s),1) == ".") or (substr(s,strlen(s),1) == "0"))
        s = substr(s,1,strlen(s)-1);
     else
        return s;
     end;
  end;
  return s;
end;

/*Печать строки*/
PRIVATE MACRO PrintStr(Ar);
   var i = 0;
   while (i < Ar.size)
     if (ValType(Ar[i]) == 28)
       Rep.AddPrintCell (sstring(Ar[i]), 0, 0, "l");
     elif (ValType(Ar[i]) == 26/*SpecVal*/)
       Rep.AddPrintCell ("NULL", 0, 0, "l");
     else
       Rep.AddPrintCell (Ar[i], 0, 0, "l");
     end;
     i = i + 1;
   end;
   Rep.AddStr (true);
END;

/*Формирование шапки таблицы по sql-запросу*/
PRIVATE MACRO CreateHead(sql);
  macro MakeLine(n)/*линия заданной длины*/
    var i = 0, s= "";
    while (i < n)
      s = s + "─";
      i = i + 1;
    end;
    return s;
  end;

  var Head = "┌", cmd, rs, Count = 0;
               
  cmd = RsdCommand(Con, sql);
  Rs  = RsdRecordSet(cmd);
  if (Rs.movenext())
    Count = rs.FldCount;
    i = 0;
    while (i < Count) /*┌─...─┬───────┬─ ...─┐\n*/
       Head = Head + MakeLine(StrLen(Rs.fld(i).Name));
       i = i + 1;
       if (i == Count)
          Head = Head + "┐\n";
       else
          Head = Head + "┬";
       end;
    end;                                     
    i = 0;                                
    while (i < Count) /*│ИМЯ_ПОЛЯ_1│ИМЯ_ПОЛЯ2│ ... │\n*/
       Head = Head + "│" + Rs.fld(i).Name;
       i = i + 1;
       if (i == Count)
          Head = Head + "│\n├";
       end;                 
    end;                    
    i = 0;
    while (i < Count) /*│...─┼───────┼─ ...─┤\n*/
       Head = Head + MakeLine(StrLen(Rs.fld(i).Name));
       i = i + 1;
       if (i == Count) 
          Head = Head + "┤";
       else                    
          Head = Head + "┼";
       end;               
    end;
  end;
  return Head;
END;

/*************************************************/
/*   Точка входа                                 */
/*************************************************/

/*Задаем меню выбора и получаем строку соединения*/
Con = RsdConnection(Env, GetIniString( "CONNSTRING", "rsreq.ini" ));

var sql1, sql2, dt2;
// var sql3 = "select T_OPER, T_NAME from DPERSON_DBT where T_USERCLOSED = chr(0)",
var sql3 = "select T_MENUID as T_OPER, T_NAME from DMENUTPL_DBT where T_USEINCHILD = 'X'",
    dt3 = RsdRecordSet(sql3);

class operdata(p1,p2)
  var oper = p1,
      name = p2;
end;
var OperList = TArray(), OL;

while (Dt3.movenext())/*По записям*/
 OperList[OperList.Size] = operdata(dt3.value(0), dt3.value(1));
end;

CLASS RepData(p1,p2,p3,p4,p5)
  var SymbolProg = p1,
      NameProg   = p2,
      SysModul   = "",
      IDModul    = p4,
      NameModul  = p5;
  if (valtype(p3) == 26)
    SysModul = 0;
  else 
    SysModul = codefor(p3);
  end;    
end;

macro  GetMenuPath(p1,p2, p3)
var     sql = "select T_OBJECTID, T_ISTEMPLATE, T_INUMBERPOINT, T_INUMBERFATHER, T_SZNAMEITEM, T_SZNAMEPROMPT "
        + " from dmenuitem_dbt  "
        + " where 1 = 1 "
        + " and T_IIDENTPROGRAM = " + p1
        + " and T_INUMBERPOINT     = " + P2 
        + " and T_OBJECTID      = " + p3
        ;
var Dt  = RsdRecordSet(sql);
Dt.movenext();
if (Dt.value(3) == 0)
  return Dt.value(4) + " \\  \n";
end;
return GetMenuPath(p1,Dt.value(3),p3) + Dt.value(4) + " \\  \n";
end;

var RepA = TArray(),r;

sql1 = "select T_TYPE_ACCOUNT, T_NAME_TYPE from dtypeac_dbt where t_inumtype = 22 and T_TYPE_ACCOUNT = 'Ю'";     
//cmd1 = RsdCommand(Con, sql1);
Dt1  = RsdRecordSet(sql1);
InitProgress(SQL_GetNRecs(sql1), "Обработка записей");
Rep = CMakeReport();
var j, count2;

Fields = TArray();
Fields[0] = "Буквенный код подсистемы";
Fields[1] = "Наименование подсистемы";
Fields[2] = "Признак системнрого модуля";
Fields[3] = "Код моуля";
Fields[4] = "Наименование модуля";
for (OL, OperList)
    if ( (OL.Oper == 1004) or
         (OL.Oper == 1011) or
         (OL.Oper == 1013) or
         (OL.Oper == 1015) or
         (OL.Oper == 1014) or
         (OL.Oper == 1012) or
         (OL.Oper == 1026) or
         (OL.Oper == 1009) 
       )

  Fields[Fields.size] = OL.oper + "   "+ OL.name;
  end;
end;
PrintStr(Fields);

while (Dt1.movenext())/*По записям*/
  UseProgress(count = count + 1);
  sql2 = "select distinct 'X' as t, T_ICASEITEM, T_SZNAMEITEM from ditemsyst_dbt where T_CIDENTPROGRAM = '" + dt1.value(0) + "'";
  Dt2  = RsdRecordSet(sql2);
  while(dt2.movenext())
    RepA[RepA.Size] = RepData(dt1.value(0),dt1.value(1),dt2.value(0),dt2.value(1),dt2.value(2));
  end;
  sql2 = "select distinct '' as t, T_ICASEITEM, T_SZNAMEITEM from ditemuser_dbt where T_CIDENTPROGRAM = '" + dt1.value(0) + "'";
  Dt2  = RsdRecordSet(sql2);
  while(dt2.movenext())
    RepA[RepA.Size] = RepData(dt1.value(0),dt1.value(1),dt2.value(0),dt2.value(1),dt2.value(2));
  end;
end;
RemProgress();


var tmp;



count2 = 0;
InitProgress(RepA.Size, "Обработка записей 2");
var x = 0;
var ppath;
for (r,RepA)
  Fields = TArray();
  Fields[0] = r.SymbolProg +"  "+ codefor(r.SymbolProg);
  Fields[1] = r.NameProg ;
  Fields[2] = strfor(r.SysModul) ;
  Fields[3] = string(r.IDModul);
  Fields[4] = r.NameModul;
  UseProgress(count2 = Count2 + 1);
  for (OL, OperList)

    if ( (OL.Oper == 1004) or
         (OL.Oper == 1011) or
         (OL.Oper == 1013) or
         (OL.Oper == 1015) or
         (OL.Oper == 1014) or
         (OL.Oper == 1012) or
         (OL.Oper == 1026) or   
         (OL.Oper == 1009) 
       )
    sql2 = "select distinct T_OBJECTID, T_ISTEMPLATE, T_INUMBERPOINT, T_INUMBERFATHER, T_SZNAMEITEM, T_SZNAMEPROMPT "
        + " from dmenuitem_dbt  "
        + " where 1 = 1 "
        + " and T_IIDENTPROGRAM = " + codefor(r.SymbolProg) 
        + " and T_ICASEITEM     = " + r.IDModul 
        + " and T_OBJECTID      = " + OL.Oper 
        + " and T_CSYSTEMITEM   = chr(" + r.SysModul +")"
        + " and T_ISTEMPLATE    = 'X'"
        ;
    Dt2  = RsdRecordSet(sql2);
    i = 0;
    tmp = "";    
    while (Dt2.movenext())/*По записям*/

      i = i + 1;
      if (i>1) 
         tmp = tmp + "\n\n-="+i+"=-\n" 
      end;
      ppath = GetMenuPath(codefor(r.SymbolProg),dt2.value(3) ,OL.Oper) + dt2.value(4);
      tmp = tmp + ppath
    end;
    Fields[Fields.size] = tmp;
  end;
  end;

  PrintStr(Fields);


//  x = x + 1;
//  if (x > 5) break; end;
end;
RemProgress;




//  println(sql);
//  Rep.PrintRep();/*При необходимости можно выаодить в текстовом виде, но на некоторых данных может слегка падать*/
  Rep.PrintWinRep();
  Rep.ShowWinRep();


OnError(er)
 msgbox("ОШИБКА! \n Неверный синтаксис запроса или неверная схема.");

