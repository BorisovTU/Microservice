/*   Откат операции - Начало аренды ячейки ЮЛ */
import stforcel, stprocs;

private var rollbackdata  = CreateRollbackDataObject();  /* Обьект, необходимый для отката */

macro TrnProc

var stat = true;
var contr = rollbackdata.footprint.contract;
var cells = rollbackdata.footprint.contract.CellList;
var doc;
var Представитель = 0;
var hasNext = false;
var rs;
var found = false;
var upCell = TbFile("ds_cell.dbt", "W", 0);

    stat = rollbackdata.footprint.bunch.first();
  if( not stat)
    return false;
  end;
      doc = rollbackdata.footprint.bunch.item;
    // Ищем клиента представителя ЮР лица по договору
    rs = FindConClientByAttr( contr.rec.branch, contr.rec.contractid, "П" );
    found = Rs.movenext();
    if( found )
      Представитель = Rs.value("t_clientcode");
    else
      PushErrorMessage("Представитель ЮР лица не найден");
    end;
  
    /* Перебираем ячейки по контракту */
    /* Все ячейки переводим в состояние ЗАБРОНИРОВАНА */
    if( stat )
      hasNext = cells.first();
      while( hasNext )
        upCell.rec.Branch     = cells.item.rec.branch;
        upCell.rec.SafeID     = cells.item.rec.SafeID;
        upCell.rec.CellNumber = cells.item.rec.CellNumber;
        
        if( upCell.getEQ() )
            upCell.rec.State            = DS_CELL_RESERVED;
            upCell.rec.ReservedFor      = Представитель;
            upCell.rec.RsrvBeginDate    = contr.rec.CreateDate;
            upCell.rec.RsrvEndDate      = contr.rec.CreateDate + 10;
            upCell.update();
        else
            PushErrorMessage("Не найдена старая ячейка.");
            stat = false;
        end;

        hasNext = cells.next();
      end;
    end;

  /* обновляем контракт */
    if( stat )
      contr.rec.OpenDate    = doc.rec.OldBeginDate;
      contr.rec.EndDate     = doc.rec.OldEndDate;
      stat = rollbackdata.footprint.contract.save();
      
      if(stat)
        stat = rollbackdata.footprint.rollback();
      end;
    end;

  if(not stat)
    AbortTrn()
  end;

end;

  if(ProcessTrn( 1, "TrnProc") )
    MsgBox("Откат операции Начало аренды ЮЛ прошел успешно");
  else
    rollbackdata.footprint.displayErrorMessage();
    MsgBox("Откат операции Начало аренды ЮЛ прошел с ошибками");
  end;

end;

