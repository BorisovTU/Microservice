/* 
  Печать доп. соглашения при замене ячейки
*/
import "or_rep_h.mac", "ptlib.mac";
import stprocs;
private var {Bank_INN}, {MFO_Bank}, {CORAC_Bank};

private var bunch = CreateOpFootprintObject();   /* Объект, необходимый для печати */

var ObjPrint:CMakeReport = CMakeReport("", SEP_DEFAULT, 99999); 

var docBunch :object = bunch.bunch;
var Contract :object = bunch.contract;
var dsDoc    :object  = null; 
var Код_клиента = 0;
var Код_клиента_владельца = 0;

var Номер_доп_согл, Номер_договора, День_дог,Месяц_дог,Год_дог,
    Город, День_вып,Месяц_вып,Год_вып,
    Инфо_по_заведующей, Наименование_клиента,
    Поверенный = "", Новая_ячейка, Старая_ячейка,
    Почтовый_адрес_банка, Счет_банка, Телефоны_банка, Данные_клиента;

macro regCtrForm()
  ObjPrint.RegisterForm ("Доп_соглашение_замена","доп_соглашение_по_замене.doc","Доп_соглашение_при_замене_ячейки_.doc",
    "Номер_доп_согл", 
    "Номер_договора", 
    "День_дог", "Месяц_дог", "Год_дог",
    "Город",
    "День", "Месяц", "Год",
    "Заведующая",
    "Клиент", 
    "Поверенный", 
    "Новая_ячейка",
    "Старая_ячейка",
    "Адрес", "ИНН", "Счет", "БИК", "Корсч", "Телефон",
    "Данные_клиента"
  );
end;

macro createReport()  
  ObjPrint.AddDoc("Доп_соглашение_замена",
    Номер_доп_согл,
    Номер_договора,
    День_дог,Месяц_дог,Год_дог,
    Город,
    День_вып,Месяц_вып,Год_вып,
    Инфо_по_заведующей,
    Наименование_клиента,
    Поверенный,
    Новая_ячейка,
    Старая_ячейка,
    Почтовый_адрес_банка, {Bank_INN}, Счет_банка, {MFO_Bank}, {CORAC_Bank}, Телефоны_банка,
    Данные_клиента
  );

  ObjPrint.CreateTemplateData();
end;

macro PrintContract()
  array MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1, Код_поверенного_1;
  var Доп_соглашение = null;

  if( docBunch.first() )
    dsDoc = docBunch.item; 
    Доп_соглашение = Найти_доп_cоглашение( dsDoc.rec.ApplicationKind, dsDoc.rec.ApplicationKey );

    if( Доп_соглашение != null )
      /* Данные для печати доп. соглашения */
      /* Данные аренды */
      Номер_договора = Contract.rec.number;
      Номер_доп_согл = Доп_соглашение.value("t_number");
      Дата_для_шаблонов (docBunch.item.rec.date,День_вып,Месяц_вып,Год_вып);
      Дата_для_шаблонов (Contract.rec.opendate,День_дог,Месяц_дог,Год_дог);

      Новая_ячейка  = Доп_соглашение.value("t_newCellNumber");
      Старая_ячейка = dsDoc.rec.oldCellNumber;

      /* Данные клиента */
      if (Есть_юр_лицо (docBunch.item.rec.branch, docBunch.item.rec.contractid, АРЕНДАТОР1))
         Наименование_клиентов_по_юр_договору (dsDoc.rec.branch, dsDoc.rec.contractid, АРЕНДАТОР1, MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1 , Код_поверенного_1);

         Данные_клиента = Сформировать_строку_данных_юр_лица_для_договора( Код_юр_лица_1(0) );
         Наименование_клиента = MAIN_CLNT_1( 0 );
         MAIN_CLNT_1( 1 ) = ""; DOVER_CLNT_1( 1 ) = "" ;
         Поверенный = DOVER_CLNT_1 (0);
      else
         Код_клиента = dsDoc.rec.ClientCode;

         if( Клиент_является_доверенным(Contract.rec.Branch, Contract.rec.ContractID, Код_клиента,"",Код_клиента_владельца) )
            Код_клиента=Код_клиента_владельца;
         end;

         Данные_клиента = Сформировать_строку_данных_физ_лица_для_договора( Код_клиента, dsDoc.rec.referenc );
         Наименование_клиента = Получить_наименование_клиента_физ_лица( Код_клиента );
      end;

      /* Данные по подразделению и банку */
      Почтовый_адрес_банка = GetNumBranch (NumFnCash, "Адрес");
      Инфо_по_заведующей   = "Заведующий " + GetNumBranch( NumFnCash, "Заведующая" );
      Город                = Получить_название_города_из_реестра();
      //Счет_банка           = Получить_счет_проводки( NumFnCash, dsDoc.rec.CurrCode, Счет_банка_474 );
      Телефоны_банка       = GetNumBranch( NumFnCash, "Телефон" );

      regCtrForm();
      createReport();
      ObjPrint.ShowTemplateRep();
      println("Документ сформирован. Переключитесь в окно Word!");

    else
      msgbox ("Не найдено доп. соглашение");
      exit (1);
    end;

  else
    msgbox ("Не найден документ операции");
    exit (1);
  end;

end;

/**************************************************************************************************/
/* Основная программа */
  PrintContract();
