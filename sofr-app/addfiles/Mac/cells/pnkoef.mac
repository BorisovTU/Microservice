/******************************************************************************\

		Макрос по расчету штрафа за просрочку: коэфициент

			Программист: Крестьянинов Е.А.

\******************************************************************************/
import DeprIntr,CommonInter,Календарь, stpencls;

const Koef = 2;

/* Получение количества полных периодов */
private macro GetNumPeriods(PenaltyDays,TermType,BegDate)
var Number = 0,tmpDate = BegDate,EndDate = Date(0,0,0);

  GetDateOff(BegDate,1,PenaltyDays,EndDate);
  while( tmpDate < EndDate )
    GetDateOff(tmpDate,TermType,1,tmpDate);
    Number = Number + 1;
  end;

  return Number;
end;

/* Основной расчет штрафа */
macro GetPenalty(Contract,Tarif)
var Sum = $0, NumPeriods = 0,penDays = 0, tmpDate, lastPayEndDate;

  penDays = GetPenaltyDays( Contract );
  penDays = PenDays - Tarif.rec.PrivilegeDays;
  lastPayEndDate = GetLastPayEndDate( Contract );
  tmpDate = DateAfterCalenDays(lastPayEndDate,Tarif.rec.PrivilegeDays);
  NumPeriods = GetNumPeriods(penDays,Contract.rec.TermType,tmpDate);

  if( penDays > 0 )
    Sum = money(NumPeriods * Tarif.rec.TariffValue * Koef);
  else
    penDays = 0;
  end;

  return String( Sum ) + "|" + String( penDays );
end;