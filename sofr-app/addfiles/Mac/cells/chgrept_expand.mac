/* 
  Печать доп. соглашения на допуск расширенного круга лиц
*/
import "or_rep_h.mac", "ptlib.mac";
import stprocs;
private var {Bank_INN}, {MFO_Bank}, {CORAC_Bank};

private var bunch = CreateOpFootprintObject();   /* Объект, необходимый для печати */

var ObjPrint:CMakeReport = CMakeReport("", SEP_DEFAULT, 99999); 

var docBunch :object = bunch.bunch;
var Contract :object = bunch.contract;
var dsDoc    :object  = null; 
var Код_клиента = 0;
var Код_клиента_владельца = 0;

var Номер_доп_согл, Номер_договора, Город,
    День_дог,Месяц_дог,Год_дог,
    День_вып,Месяц_вып,Год_вып,
    День_нач,Месяц_нач,Год_нач,
    День_кон,Месяц_кон,Год_кон,
    Инфо_по_заведующей, Наименование_клиента,
    Поверенный = "", Ячейка,
    Поверенный_юрлица_или_физлицо, Доверенный, Доверенный_док = "", Доверенный_доквыдан = "",
    Сумма_руб, Сумма_коп, Сумма_стр,
    СуммаНДС_руб, СуммаНДС_коп, СуммаНДС_стр,
    Почтовый_адрес_банка, Счет_банка, Телефоны_банка, Данные_клиента;

macro regCtrForm()
  ObjPrint.RegisterForm ("Доп_соглашение_расшир","Доп_соглашение_расшир.doc","Доп_соглашение_расшир_.doc",
    "Номер_доп_согл", 
    "Номер_договора", 
    "Город",
    "День", "Месяц", "Год",
    "День_дог", "Месяц_дог", "Год_дог",
    "День_нач", "Месяц_нач", "Год_нач",
    "День_кон", "Месяц_кон", "Год_кон",
    "Заведующая",
    "Клиент", 
    "Поверенный",
    "Ячейка",
    "Клиент_П",
    "Клиент_Д", "Клиент_Д_док", "Клиент_Д_доквыдан",
    "Сумма_руб", "Сумма_коп", "Сумма_стр",
    "НДС_руб", "НДС_коп", "Сумма_НДС_стр",
    "Адрес", "ИНН", "Счет", "БИК", "Корсч", "Телефон",
    "Данные_клиента"
  );
end;

macro createReport()  
  ObjPrint.AddDoc("Доп_соглашение_расшир",
    Номер_доп_согл,
    Номер_договора,
    Город,
    День_вып,Месяц_вып,Год_вып,
    День_дог,Месяц_дог,Год_дог,
    День_нач,Месяц_нач,Год_нач,
    День_кон,Месяц_кон,Год_кон,
    Инфо_по_заведующей,
    Наименование_клиента,
    Поверенный,
    Ячейка,
    Поверенный_юрлица_или_физлицо,
    Доверенный, Доверенный_док, Доверенный_доквыдан,
    Сумма_руб, Сумма_коп, Сумма_стр,
    СуммаНДС_руб, СуммаНДС_коп, СуммаНДС_стр,
    Почтовый_адрес_банка, {Bank_INN}, Счет_банка, {MFO_Bank}, {CORAC_Bank}, Телефоны_банка,
    Данные_клиента
  );

  ObjPrint.CreateTemplateData();
end;

macro Заполнить_данные_доверенного
  var Клиент = TClientList;
  var Код_клиента = 0;
  var clList;

  clList = FindConClientWithAttrRs(dsDoc.rec.branch, dsDoc.rec.contractid, АРЕНДАТОР1, "Д");
  if( clList.moveNext )
    Код_клиента = clList.value("t_clientCode");
  end;

  if( (Код_клиента > 0) and (Клиент.GetRecord(Код_клиента)) )
    Доверенный = Клиент.currec.rec.Name1+" "+Клиент.currec.rec.Name2+" "+Клиент.currec.rec.Name3;
    Доверенный_док = GetNameOfPAPRKIND( Клиент.currec.PaperKind )+" "+Клиент.currec.rec.PaperSeries+" №"+Клиент.currec.rec.PaperNumber;
    Доверенный_доквыдан = Клиент.currec.rec.paperissuer+" "+Клиент.currec.rec.paperissueddate;
  end;
end;

macro Заполнить_суммы( КодВалюты)
  var Сумма = $0;
  var i;

  Сумма = dsDoc.rec.inSum + dsDoc.rec.NdsSum;
  Сумма_руб = string(Сумма);
  i = index(Сумма_руб, ".");
  if( i > 0 )
    Сумма_коп = substr(Сумма_руб, i+1, 2);
    Сумма_руб = substr(Сумма_руб, 1, i-1);
  else
    Сумма_коп = "0";
  end;
  Сумма_стр = CurToStrAlt(Сумма, null, null, КодВалюты);

  Сумма = dsDoc.rec.NdsSum;
  СуммаНДС_руб = string(Сумма);
  i = index(СуммаНДС_руб, ".");
  if( i > 0 )
    СуммаНДС_коп = substr(СуммаНДС_руб, i+1, 2);
    СуммаНДС_руб = substr(СуммаНДС_руб, 1, i-1);
  else
    СуммаНДС_коп = "0";
  end;
  СуммаНДС_стр = CurToStrAlt(Сумма, null, null, КодВалюты);
end;

macro PrintContract()
  array MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1, Код_поверенного_1;
  var Доп_соглашение = null;
  var Вид_допуска = 0;
  var stat = true;

  if( docBunch.first() )
    dsDoc = docBunch.item; 
    Доп_соглашение = Найти_доп_cоглашение( dsDoc.rec.ApplicationKind, dsDoc.rec.ApplicationKey );

    if( Доп_соглашение != null )
      /* Данные для печати доп. соглашения */
      /* Данные аренды */
      Номер_договора = Contract.rec.number;
      Номер_доп_согл = Доп_соглашение.value("t_number");
      Вид_допуска    = Доп_соглашение.value("t_accesskind");
      Дата_для_шаблонов (Contract.rec.opendate,День_дог,Месяц_дог,Год_дог);
      Дата_для_шаблонов (docBunch.item.rec.date,День_вып,Месяц_вып,Год_вып);
      Дата_для_шаблонов (Доп_соглашение.value("t_BeginDate"),День_нач,Месяц_нач,Год_нач);
      Дата_для_шаблонов (Доп_соглашение.value("t_EndDate"),День_кон,Месяц_кон,Год_кон);

      /* Данные клиента */
      if (Есть_юр_лицо (dsDoc.rec.branch, dsDoc.rec.contractid, АРЕНДАТОР1))
         Наименование_клиентов_по_юр_договору (dsDoc.rec.branch, dsDoc.rec.contractid, АРЕНДАТОР1, MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1 , Код_поверенного_1);

         Данные_клиента = Сформировать_строку_данных_юр_лица_для_договора( Код_юр_лица_1(0) );
         Наименование_клиента = MAIN_CLNT_1( 0 );
         MAIN_CLNT_1( 1 ) = ""; DOVER_CLNT_1( 1 ) = "" ;
         Поверенный = DOVER_CLNT_1 (0);
         Поверенный_юрлица_или_физлицо = Поверенный;
      else
         Код_клиента = dsDoc.rec.ClientCode;

         if( Клиент_является_доверенным(Contract.rec.Branch, Contract.rec.ContractID, Код_клиента,"",Код_клиента_владельца) )
            Код_клиента=Код_клиента_владельца;
         end;

         Данные_клиента = Сформировать_строку_данных_физ_лица_для_договора( Код_клиента, dsDoc.rec.referenc );
         Наименование_клиента = Получить_наименование_клиента_физ_лица( Код_клиента );
         Поверенный_юрлица_или_физлицо = Наименование_клиента;
      end;

      Доверенный = "__________________________________";
      if( Вид_допуска != DS_AK_CLIENT_2 )
        Заполнить_данные_доверенного;
      end;
      
      if( Вид_допуска == DS_AK_AGENT_2 )
        Поверенный_юрлица_или_физлицо = "__________________________________";
      end;

      /* Данные по подразделению и банку */
      Почтовый_адрес_банка = GetNumBranch (NumFnCash, "Адрес");
      Инфо_по_заведующей   = "Заведующий " + GetNumBranch( NumFnCash, "Заведующая" );
      Город                = Получить_название_города_из_реестра();
      //Счет_банка           = Получить_счет_проводки( NumFnCash, dsDoc.rec.CurrCode, Счет_банка_474 );
      Телефоны_банка       = GetNumBranch( NumFnCash, "Телефон" );

      /* Получить стоимость услуги */
      stat = docBunch.first;
      while( stat )
        dsDoc = docBunch.item; 

        if( (dsDoc.rec.parentOpNumber == OP_AGREXACS) and 
            (dsDoc.rec.opNumber == OP_NESTED_COLLNACCR) and 
            (dsDoc.rec.stepNumber == 1) )
          Заполнить_суммы(dsDoc.rec.CurrCode);
          stat = false;
        else
          stat = docBunch.next;
        end;
      end;

      /* Первая по договору */
      if( Contract.CellList.first )
        Ячейка = Contract.CellList.item.rec.cellnumber;

        regCtrForm();
        createReport();
        ObjPrint.ShowTemplateRep();
        println("Документ сформирован. Переключитесь в окно Word!");
      else
        msgbox( "Не найдено ни одной ячейки" );
        exit (1);
      end;

    else
      msgbox ("Не найдено доп. соглашение");
      exit (1);
    end;

  else
    msgbox ("Не найден документ операции");
    exit (1);
  end;

end;

/**************************************************************************************************/
/* Основная программа */
  PrintContract();
