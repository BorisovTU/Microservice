/*
$Name:             stpencls.mac
$Module:           RS-Retail
$Description:      Сейфовые ячейки. Набор функций для макросов взятия штрафов
*/

/******************************************************************************\

		Набор функций для макросов взятия штрафов
		        
			Программист: Крестьянинов Е.А.


\******************************************************************************/
import Календарь, rsd;

private var {curdate};

/****************** Получение даты последнего оплаченного периода *************/
macro GetLastPayEndDate( Contract )
  var retDate = Contract.rec.OpenDate;
  var cmd = "select max(d.t_PayEndDate) from dds_docum_dbt d where " +
	    " d.t_contractid = " + String( Contract.rec.ContractID ) +
        " and d.t_Branch = " + String( Contract.rec.Branch ) +
	    " and d.t_stepnumber in (select t_stepnumber from dds_opstp_dbt " +
	    "where d.t_opnumber = t_opnumber and d.t_contrtypeid = t_contrtypeid " +
	    "and t_attributes like '%П%')";
  var Rs = RsdRecordSet( cmd );

  if (Rs.MoveNext() and (Rs.fld(0).value != NullVal))
    DtTmSplit(Rs.fld(0).value, retDate);
  end;

  return retDate;
end;

/******************* Получение количества дней просрочки **********************/
macro GetPenaltyDays( Contract )
  var penDays, lastPayDate;

  lastPayDate = GetLastPayEndDate( Contract );
  penDays = NDays(lastPayDate,{curdate});

  if ((penDays < 0) or (Contract.rec.Discount == 100))
    penDays = 0;
  end;

  return penDays;
end;
