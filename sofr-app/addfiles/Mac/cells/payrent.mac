/*
$Name:             payrent.mac
$Module:           RS-Retail
$Description:      Сейфовые ячейки. Макрос операции внесения платы за аренду
*/

/******************************************************************************\

       Макрос операции внесения платы за аренду

      Программист: Крестьянинов Е.А.

\******************************************************************************/
import stforcel,classes,stprocs;

private var operation     = CreateObjectOfOperation();
private var bunch         = CreateOpFootprintObject();

class (TOperationExecutor) TPayRentOperation( opObj )

  macro checkOperation()
    var status = true;
    var contr = operationObj.contract;
    var LastDatePayPeriod = GetLastDatePayPeriod(contr.rec.Branch, contr.rec.ContractID);
    if ((LastDatePayPeriod >= contr.rec.EndDate) or (contr.rec.Discount == 100))
        status = false;
        if ( not operationObj.isPack )
          msgbox("Аренда оплачена до конца договора. Внесение платы не требуется");
        end;
    end;
    return status;
  end;

  macro createDocuments()
    var dsDoc,depDoc,payDoc,stat = true, contr = operationObj.contract;
    var penaltyNDS=$0, penaltyWithoutNDS=$0;

    dsDoc = operationObj.newDsDoc(1);
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;
    operationObj.docList.insert(dsDoc);

/* Взятие штрафа за просрочку */
    if(operationObj.expPnltSum>0)
      dsDoc = operationObj.newDsDoc(2);
      penaltyNDS = round(operationObj.expPnltSum*NDS/(100+NDS),2);
      penaltyWithoutNDS = operationObj.expPnltSum - penaltyNDS;
      dsDoc.rec.InSum = penaltyWithoutNDS;
      dsDoc.rec.NdsSum = penaltyNDS;
      dsDoc.rec.CurrCode = operationObj.expPnltCurrCode;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.expPnltClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      dsDoc.rec.Ground = "Штраф за просрочку внесения ар. платы " + (dsDoc.rec.InSum+dsDoc.rec.NdsSum) + " руб. (в т.ч. НДС " + dsDoc.rec.NdsSum + " руб.)";
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Валюта@Просрочка", dsDoc.rec.CurrCode);
      StoreValue("doc:Сумма@Просрочка", dsDoc.rec.InSum);

      if( operationObj.expPnltIsNonCash != DSPM_PUT )
        payDoc = operationObj.newPayDoc(dsDoc);
        payDoc.rec.Ground = dsDoc.rec.Ground;
        payDoc.setVarPartFormat("pay_doc.ds");
        payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
        if (operationObj.isAddAgrmntInited)
          payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
        else
          payDoc.varPart.rec.AddAgrmntID = 0;
        end;
        payDoc.varPart.rec.StepNumber = 2;
        operationObj.docList.insert(payDoc);
      end;
      
      dsDoc = operationObj.newDsDoc(4);
      dsDoc.rec.InSum = penaltyNDS;
      dsDoc.rec.CurrCode = operationObj.expPnltCurrCode;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.expPnltClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Сумма@ПросрочкаНДС", dsDoc.rec.InSum);

      if( operationObj.expPnltIsNonCash != DSPM_PUT )
        payDoc = operationObj.newPayDoc(dsDoc);
        payDoc.rec.Ground = dsDoc.rec.Ground;
        payDoc.setVarPartFormat("pay_doc.ds");
        payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
        if (operationObj.isAddAgrmntInited)
          payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
        else
          payDoc.varPart.rec.AddAgrmntID = 0;
        end;
        payDoc.varPart.rec.StepNumber = 2; /*2, а не 4*/
        operationObj.docList.insert(payDoc);
      end;
    end;

/* Плата за аренду */
    operationObj.runNestedDSOperation(3);
   /* if( operationObj.pmntSum  )
      dsDoc = operationObj.newDsDoc(3);
      if( operationObj.pmntSum > 0 )
        dsDoc.rec.InSum = operationObj.pmntSum;
      else
        dsDoc.rec.OutSum = abs(operationObj.pmntSum);
      end;
      dsDoc.rec.CurrCode = operationObj.pmntCurrCode;
      dsDoc.rec.NdsSum = operationObj.pmntNds;
      if( operationObj.pmntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      if( operationObj.pmntIsNonCash != DSPM_PUT )
        if( (operationObj.pmntIsNonCash == DSPM_CASHLESS) and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;
/* Взятие НДС */
    if( operationObj.nds )
      dsDoc = operationObj.newDsDoc(4);
      if(operationObj.nds > 0)
        dsDoc.rec.InSum = operationObj.nds;
      else
        dsDoc.rec.OutSum = abs(operationObj.nds);
      end;     
      dsDoc.rec.CurrCode = NATIONAL_CURR;
      if(operationObj.pmntIsNonCash == DSPM_CASHLESS)
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      if( operationObj.pmntIsNonCash != DSPM_PUT ) 
        if((operationObj.pmntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;*/

    return stat;
  end;

  InitTOperationExecutor( opObj );
end;

/************************ Основная программа **********************************/
var obj = TPayRentOperation( operation );

  obj.runOp();

end;
