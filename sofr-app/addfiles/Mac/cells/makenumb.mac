import rsd;


private var {IDBank};
private var {IDDep};

macro GetBankTerIndex()
    var bs="", ds="";
    
    var b = mod({IDBank},100);
    if( b < 10 )
      bs = "0" + string(b);
    else
      bs = string(b);
    end;
    
    var d = mod({IDDep},100);
    if( d < 10 )
      ds = "0" + string(d);
      else
     ds = string(d);
    end;
    
    return bs + ds;
  end;

macro PutPreZeroes(str)
    var sn = str;
    var n = int(sn);
    var m = mod(n, 1000);    
    if (m<10) sn = "00" + string(n)
       elif (m<100) sn = "0" + string(n) 
       else sn = string(n)
    end;     
    return sn;
  end;

macro PutPreZeroes100(n)
    var sn;
    var m = mod(n, 100);    
    if (m < 10) sn = "0" + string(n) 
       else sn = string(n)
    end;     
    return sn;
  end;
macro TestZeroes()
     var str;
     var fi = 0;
     while (fi<1000)
	 str = string(fi);
          Println(PutPreZeroes(fi));
	 fi = fi + 1;
     end;
end;


macro MakeContractNumber(contract)
    var Result : string;
    var cmd, rs, foundnew, cmd2, rs2, foundold, DBNumNew, DBNumOld;

    var MaxSelectedNum : integer;
   cmd = "select substr(t_Number, length(t_Number)-2) as num from dds_contr_dbt " +
         "where t_branch = " + string( contract.rec.Branch ) +  " and t_Number like '________' " +
         "order by CAST(substr(t_Number, length(t_Number)-2) AS NUMBER) DESC";

    Rs = RsdRecordset( cmd );

    foundnew = Rs.moveNext();

   cmd2= "select t_Number from dds_contr_dbt " +
         "where t_branch = " + string( contract.rec.Branch ) + " and length(t_Number) <= 3 " +
         "order by CAST(t_Number AS NUMBER) DESC";

    Rs2 = RsdRecordset( cmd2 );

    foundold = Rs2.moveNext();

    DBNumNew = Rs.value(0);
    DBNumOld = Rs2.value(0);
    
    
    if (foundnew)
        MaxSelectedNum = int(DBNumNew);
        if (MaxSelectedNum > 0)
            Result = GetBankTerIndex() + "_" + PutPreZeroes(MaxSelectedNum + 1);
        else
            Result = "";
        end;
    elif (DBNumOld)
        MaxSelectedNum = int(DBNumOld);
        if (MaxSelectedNum > 0)
            Result = GetBankTerIndex() + "_" + PutPreZeroes(MaxSelectedNum + 1);
        else
            Result = GetBankTerIndex() + "_001";
        end;

    else
        Result = string(1);
    end;
    return Result;
    OnError(er) return string("");
end;

macro MakeAddAgrmntNumber(contract)
    var Result : string;
    var LastAgrNumber;
    var cmd, rs, found;
    var MaxSelectedNum : integer;

   cmd = "select CAST(substr(t_number, instr(t_number,'/')+1) AS NUMBER) from ddsagrmnt_dbt " +
           "where not t_action in (2,11) and t_branch = " + string( contract.rec.Branch ) +
           " and t_ContractID = "+string( contract.rec.ContractID )+
           " order by CAST(substr(t_number, instr(t_number,'/')+1) AS NUMBER) DESC";

    Rs = RsdRecordset( cmd );

    found = Rs.moveNext();
    if(found and (Rs.RecCount > 0))
        MaxSelectedNum = Rs.value(0);
        Result = contract.rec.Number+"/"+PutPreZeroes100(MaxSelectedNum + 1);
    else
        Result = contract.rec.Number+"/01";
    end;
    return Result;
    OnError(er) return string("");
end;

