/* Печать договора аренды по сделкам с недвижимостью
*/
import stforcel, "or_rep_h.mac", ptlib;
import stprocs;

var bunch         = CreateOpFootprintObject();   /* ╬с·хъЄ, эхюсїюфшь√щ фы  яхўрЄш */

var ObjPrint:CMakeReport = CMakeReport("", SEP_DEFAULT, 99999); 

var docBunch=bunch.bunch;

var Contract = bunch.contract;

var rentDoc  :object  = null; 


var День_, Месяц_, Год_, Город, Номер_договора, Инфо_по_заведующей, 
    Ячейка, Адрес_филиала, Наименование_подразделения, Дата_выдачи, Данные_документа,
    Срок_в_днях_строка, Срок_в_днях, 
    Счет_банка, Телефоны_банка, Доверенность_банка, Почтовый_адрес_банка,
    Код_клиента_плательщика, Acc_referenc,
    Данные_покупателя="", Данные_продавца="";

array Сумма, Сумма_стр, Сумма_руб, Сумма_коп, 
      Сумма_НДС, Сумма_НДС_стр, Сумма_НДС_руб, Сумма_НДС_коп;

array MAIN_CLNT_1, DOVER_CLNT_1, DOVER_CODE_1, MAIN_CODE_1;
array MAIN_CLNT_2, DOVER_CLNT_2, DOVER_CODE_2, MAIN_CODE_2;

array Код_юр_лица_1, Код_поверенного_1, Код_юр_лица_2, Код_поверенного_2;

private var {Bank_INN}, {MFO_Bank}, {CORAC_Bank}, hasNextCell;

        if (docBunch.first ())           

           rentDoc = docBunch.item; 

           Код_клиента_плательщика=rentDoc.rec.pmntclient; 

           /* Данные для печати договора */
           /* Данные аренды */
           Номер_договора=Contract.rec.number;
           Дата_для_шаблонов (Contract.rec.OpenDate,День_,Месяц_,Год_);
           if (Contract.rec.TermType==ADSP_DAY)
              Срок_в_днях=Contract.rec.termvalue;
              Срок_в_днях_строка=NumToStr (Срок_в_днях,"","","",TRUE);
           else
              msgbox ("Срок договора согласно текущей 527-3-р должен задаваться в днях!");
              Срок_в_днях=0;
              Срок_в_днях_строка="";
           end;

           /* Суммы по договору */

           /* Сумма аренды */
           Сумма(0)        =rentDoc.rec.pmntSum + rentDoc.rec.NdsSum;
           Сумма_НДС (0)   =rentDoc.rec.NdsSum;

           Сумма_руб (0) = SubStr( String( Сумма(0) ), 1, Index( String( Сумма(0) ), "." ) - 1 );
           Сумма_коп (0) = SubStr( String( Сумма(0) ), Index( String( Сумма(0) ), "." ) + 1 );

           Сумма_НДС_руб (0) = SubStr( String( Сумма_НДС(0) ), 1, Index( String( Сумма_НДС(0) ), "." ) - 1 );
           Сумма_НДС_коп (0) = SubStr( String( Сумма_НДС(0)), Index( String( Сумма_НДС(0) ), "." ) + 1 );

           Сумма_стр     (0)=doMoneyToStr_jar (Сумма(0),0);
           Сумма_НДС_стр (0)=doMoneyToStr_jar (Сумма_НДС(0),0);

           /* Сумма платы за услугу предоставления банковской техники */
           Сумма(1)        =rentDoc.rec.Banktech_Sum+rentDoc.rec.Banktech_VatSum;
           Сумма_НДС (1)   =rentDoc.rec.Banktech_VatSum;

           Сумма_руб (1) = SubStr( String( Сумма(1) ), 1, Index( String( Сумма(1) ), "." ) - 1 );
           Сумма_коп (1) = SubStr( String( Сумма(1) ), Index( String( Сумма(1) ), "." ) + 1 );

           Сумма_НДС_руб (1) = SubStr( String( Сумма_НДС(1) ), 1, Index( String( Сумма_НДС(1) ), "." ) - 1 );
           Сумма_НДС_коп (1) = SubStr( String( Сумма_НДС(1)), Index( String( Сумма_НДС(1) ), "." ) + 1 );

           Сумма_стр     (1)=doMoneyToStr_jar (Сумма(1),0);
           Сумма_НДС_стр (1)=doMoneyToStr_jar (Сумма_НДС(1),0);

           /* Если суммы нулевые, то в договоре необходимо указать пробелы */
           if (Сумма(1)==$0)
             Сумма (1)         = "____";
             Сумма_НДС (1)     = "____";
             Сумма_руб (1)     = "____";
             Сумма_коп (1)     = "__";
             Сумма_НДС_руб (1) = "____";
             Сумма_НДС_коп (1) = "__";
             Сумма_стр (1)     = "_____________";
             Сумма_НДС_стр (1) = "_____________";
           end;


           /* Сумма платы за сделку */
           Сумма(2)        = rentDoc.rec.Deal_Sum+rentDoc.rec.Deal_VatSum;
           Сумма_НДС (2)   = rentDoc.rec.Deal_VatSum;

           Сумма_руб (2) = SubStr( String( Сумма(2) ), 1, Index( String( Сумма(2) ), "." ) - 1 );
           Сумма_коп (2) = SubStr( String( Сумма(2) ), Index( String( Сумма(2) ), "." ) + 1 );

           Сумма_НДС_руб (2) = SubStr( String( Сумма_НДС(2) ), 1, Index( String( Сумма_НДС(2) ), "." ) - 1 );
           Сумма_НДС_коп (2) = SubStr( String( Сумма_НДС(2)), Index( String( Сумма_НДС(2) ), "." ) + 1 );

           Сумма_стр     (2)=doMoneyToStr_jar (Сумма(2),0);
           Сумма_НДС_стр (2)=doMoneyToStr_jar (Сумма_НДС(2),0);


           /* Продавец */
           if (Есть_юр_лицо (Contract.rec.Branch, Contract.rec.ContractID, ПРОДАВЕЦ))

              Наименование_клиентов_по_юр_договору (Contract.rec.Branch, Contract.rec.ContractID, ПРОДАВЕЦ, MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1 , Код_поверенного_1);
              Данные_продавца = Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_1(0));


              if (MAIN_CLNT_1(1))

                Данные_продавца = Данные_продавца+"\n\nКлиент (Продавец) "+Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_1(1));

              else

                MAIN_CLNT_1 (1)=""; DOVER_CLNT_1 (1)="";

              end;


           else


             Клиенты_по_договору (Contract.rec.Branch, Contract.rec.ContractID, ПРОДАВЕЦ, MAIN_CLNT_1, DOVER_CLNT_1, MAIN_CODE_1, DOVER_CODE_1);

             if (MAIN_CLNT_1(0))

                if (Код_клиента_плательщика==MAIN_CODE_1(0))
                   Acc_referenc= rentDoc.rec.referenc;
                else
                   Acc_referenc= 0;
                end;

                Данные_продавца = Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_1(0), Acc_referenc);

             end;

             if (MAIN_CLNT_1(1))

                if (Код_клиента_плательщика==MAIN_CODE_1(1))
                   Acc_referenc= rentDoc.rec.referenc;
                else
                   Acc_referenc= 0;
                end;

                Данные_продавца = Данные_продавца+"\n\nКлиент (Продавец): "+Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_1(1), Acc_referenc);

             end;


           end;

           /* Покупатель */
           if (Есть_юр_лицо (Contract.rec.Branch, Contract.rec.ContractID, ПОКУПАТЕЛЬ))

              Наименование_клиентов_по_юр_договору (Contract.rec.Branch, Contract.rec.ContractID, ПОКУПАТЕЛЬ, MAIN_CLNT_2 , DOVER_CLNT_2 , Код_юр_лица_2, Код_поверенного_2);
              Данные_покупателя = Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_2(0));

              if (MAIN_CLNT_2(1))

                Данные_покупателя = Данные_покупателя+"\n\nКлиент (Покупатель) "+Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_2(1));

              else
                MAIN_CLNT_2 (1)=""; DOVER_CLNT_2 (1)="";
              end;

           else


              Клиенты_по_договору (Contract.rec.Branch, Contract.rec.ContractID, ПОКУПАТЕЛЬ, MAIN_CLNT_2, DOVER_CLNT_2, MAIN_CODE_2, DOVER_CODE_2);

              if (MAIN_CLNT_2(0))

                 if (Код_клиента_плательщика==MAIN_CODE_2(0))
                    Acc_referenc= rentDoc.rec.referenc;
                 else
                    Acc_referenc= 0;
                 end;

                 Данные_покупателя = Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_2(0), Acc_referenc);

              end;

              if (MAIN_CLNT_2(1))

                 if (Код_клиента_плательщика==MAIN_CODE_2(1))
                    Acc_referenc= rentDoc.rec.referenc;
                 else
                    Acc_referenc= 0;
                 end;

                 Данные_покупателя = Данные_покупателя+"\n\nКлиент (Покупатель): "+Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_2(1), Acc_referenc);
                                         
              end;
                
           end;

           /* Данные по подразделению и банку */
           Адрес_филиала              = GetNumBranch (NumFnCash, "Адрес");
           Наименование_подразделения = GetNumBranch (NumFnCash, "Наименование");
           Инфо_по_заведующей         = "Заведующий " + GetNumBranch( NumFnCash, "Заведующая" );
           Город                      = Получить_название_города_из_реестра();
           //Счет_банка                 = Счет_банка_474 ();
           Телефоны_банка             = GetNumBranch( NumFnCash, "Телефон" );
           Доверенность_банка         = "________________________________________________";
           Почтовый_адрес_банка       = Адрес_филиала;


           ObjPrint.RegisterForm ("Договор","договор_аренды_сделка.doc","Договор_сделка_.doc",
                                  "Номер_договора",
                                  "Город",
                                  "День", "Месяц", "Год", 
                                  "Заведующая",
                                  "Доверенность",
                                  "Ячейка",
                                  "Адрес",
                                  "Подразделение",
                                  "Срок_аренды",
                                  "Срок_аренды_строкой",
                                  "Сумма_аренды_руб",
                                  "Сумма_аренды_коп",
                                  "Сумма_аренды_стр",
                                  "НДС_руб",
                                  "НДС_коп",
                                  "Сумма_НДС_стр",
                                  "Сумма_сделки_руб",
                                  "Сумма_сделки_коп",
                                  "Сумма_сделки_стр",
                                  "Сумма_сделки_НДС_руб",
                                  "Сумма_сделки_НДС_коп",
                                  "Сумма_сделки_НДС_стр",
                                  "Сумма_банк_тех_руб",
                                  "Сумма_банк_тех_коп",
                                  "Сумма_банк_тех_стр",
                                  "Сумма_тех_НДС_руб",
                                  "Сумма_тех_НДС_коп",
                                  "Сумма_тех_НДС_стр",
                                  "FIO1",
                                  "DOVER1",
                                  "FIO2",
                                  "DOVER2",
                                  "FIO3",
                                  "DOVER3",
                                  "FIO4",
                                  "DOVER4",
                                  "ИНН", "Счет", "БИК", "Корсч", "Телефон","Почт_адрес_банка",
                                  "Данные_продавца",
                                  "Данные_покупателя"
                                 );
           hasNextCell = Contract.CellList.first();
           if( hasNextCell )
               Ячейка = "";
               while( hasNextCell )
                 Ячейка = Ячейка + Contract.CellList.item.rec.cellnumber;
                 hasNextCell = Contract.CellList.next();
                 if ( hasNextCell )
                    Ячейка = Ячейка + ", ";
                 end;
               end;

               ObjPrint.AddDoc ("Договор",
                                 Номер_договора,   /*  "Номер_договора",*/
                                 Город,  /*   "Город",         */
                                 День_, Месяц_, Год_,  /*   "День", "Месяц", "Год", */
                                 Инфо_по_заведующей,   /*  "Заведующая",*/
                                 Доверенность_банка,   /*  "Доверенность", */
                                 Ячейка,  /*   "Ячейка",*/
                                 Адрес_филиала,  /*   "Адрес",*/
                                 Наименование_подразделения,   /*  "Подразделение",*/
                                 Срок_в_днях,  /*   "Срок_аренды",   */
                                 Срок_в_днях_строка,  /*   "Срок_аренды_строкой",   */
                                 Сумма_руб (0),       /* "Сумма_аренды_руб", */
                                 Сумма_коп (0),       /* "Сумма_аренды_коп", */
                                 Сумма_стр (0),       /* "Сумма_аренды_стр", */
                                 Сумма_НДС_руб (0),   /* "НДС_руб",          */
                                 Сумма_НДС_коп (0),   /* "НДС_коп",          */
                                 Сумма_НДС_стр (0),   /* "Сумма_НДС_стр",    */
                                 Сумма_руб (2),       /* "Сумма_сделки_руб", */
                                 Сумма_коп (2),       /* "Сумма_сделки_коп", */
                                 Сумма_стр (2),       /* "Сумма_сделки_стр", */
                                 Сумма_НДС_руб (2),   /* "Сумма_сделки_НДС_руб", */
                                 Сумма_НДС_коп (2),   /* "Сумма_сделки_НДС_коп", */
                                 Сумма_НДС_стр (2),   /* "Сумма_сделки_НДС_стр", */
                                 Сумма_руб (1),       /* "Сумма_банк_тех_руб",   */
                                 Сумма_коп (1),       /* "Сумма_банк_тех_коп",   */
                                 Сумма_стр (1),       /* "Сумма_банк_тех_стр",   */
                                 Сумма_НДС_руб (1),   /* "Сумма_банк_тех_НДС_руб",*/
                                 Сумма_НДС_коп (1),   /* "Сумма_банк_тех_НДС_коп",*/
                                 Сумма_НДС_стр (1),   /* "Сумма_банк_тех_НДС_стр",*/
                                 MAIN_CLNT_1  (0),      /* "FIO1",     */ 
                                 DOVER_CLNT_1 (0),      /* "DOVER1", */ 
                                 MAIN_CLNT_1  (1),      /* "FIO2",   */ 
                                 DOVER_CLNT_1 (1),      /* "DOVER2",  */ 
                                 MAIN_CLNT_2  (0),      /* "FIO3",    */ 
                                 DOVER_CLNT_2 (0),      /* "DOVER3", */ 
                                 MAIN_CLNT_2  (1),      /* "FIO4",    */ 
                                 DOVER_CLNT_2 (1),      /* "DOVER4",  */ 
                                 {Bank_INN}, Счет_банка, {MFO_Bank}, {CORAC_Bank}, Телефоны_банка, Почтовый_адрес_банка, /*   "ИНН", "Счет", "БИК", "Корсч", "Телефон",*/
                                 Данные_продавца,     /* "Данные_продавца",  */
                                 Данные_покупателя    /* "Данные_покупателя" */
                               );

               ObjPrint.CreateTemplateData();

               ObjPrint.ShowTemplateRep();
           else
               msgbox( "Не найдено ни одной ячейки!" );
           end;
        else
           msgbox ("Не найден документ по операции.");
        end;
