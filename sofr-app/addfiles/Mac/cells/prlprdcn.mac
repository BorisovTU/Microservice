/* Пролонгация/продление договора для типа "С Условием" */

import stforcel,initcond,classes,paygrend;
import stprocs;

var operation     = CreateObjectOfOperation();

class (TOperationExecutor) TConditionProlongProdOperation( opObj )

  private var OldGrntSum = $0;

  macro checkOperation()
    var status = true;

    OldGrntSum = contr.rec.GrntSum;
    
    if( ({curdate} > operationObj.contract.rec.EndDate) and
        ( КоличествоПросроченныхДней({curdate}, operationObj.contract.rec.EndDate, true) > 0) )
        
          PushErrorMessage("Текущая дата - " + date({curdate}) + ". Дата завершения договора - " + date(operationObj.contract.rec.EndDate) + ". "+
                           "Продление пролонгация запрещена");

      status = false;                       
    end;

    if( status )
        if( operationObj.Contract.isClaimRegistered )
            PushErrorMessage("По договору зарегистрировано возникновение исковой ситуации.| Продление/пролонгация договора запрещена");
            status = false;
        end;
    end;
    return status;
  end;

  macro runPanel()      /* Запуск панели операции */
    operationObj.newAddAgreement();
    return operationObj.panel.use();
  end;

  macro checkClients()
    if (not checkClients())
      return false;
    end;

    var AllFound = true,Found,stat,opstat;
    stat = operationObj.contract.clients.first();
    while( stat )
      if( NOT index(operationObj.contract.clients.item.rec.Attributes,"Д") )
        Found = false;
        opstat = operationObj.clientList.first();
        while( opstat and (not Found) )
          if( (operationObj.contract.clients.item.rec.ClientCode == operationObj.clientList.item.rec.ClientCode ) OR
        (operationObj.contract.clients.item.rec.ClientCode == operationObj.clientList.item.rec.ProxyOf ) )
      Found = true;
          end;
          opstat = operationObj.clientList.next();
        end;
        if( NOT Found )
      stat = false;
      AllFound = false;
        end;
      end;
      if( stat )
        stat = operationObj.contract.clients.next();
      end;
    end;
    return AllFound;
  end;


  macro CreateDocForCell( branch, safeid, cellnumber )
    record Parm(CashParm);
    var dsdoc;
    var NumKeys = 0;
  /* Возврат ключей */
    NumKeys = GetNumOfKeys( branch, SafeID, CellNumber);
    if( ( NumKeys > 0 ) and ({MakeDeskDocs}) )
      ClearRecord( Parm );
      Parm.TypeValue = TYPERES_KEY;
      Parm.CodIntValue = VALFORM_KEY;
      Parm.Oper = operationObj.oper;
      Parm.CashDateDoc = operationObj.OperationDate;
      Parm.ValueCol = NumKeys;
      Parm.OperPatern = Parm.Oper;
      Parm.Type = 0;                /* Платежеспосбные ресурсы */
      Parm.NumOper = CASHOP_CREDIT; /* Возврат в банк */
      Parm.ApplicationKind = SB_SAFECELLS;
      Parm.ApplicationKey = FormApplicationKey( Parm.ApplicationKind );
      operationObj.newCashDoc( Parm );

      StoreValue("doc:Ресурс@КодГлавного@Приход", Код_ресурса_ключ_от_сейфовой_ячейки(TYPERES_KEY, VALFORM_KEY, 0, "t_GroupValue"));
      StoreValue("doc:КоличКлючей@Приход", NumKeys + RetrieveValue("doc:КоличКлючей@Приход"));

      dsDoc = operationObj.newDsDoc(8);
      if(not operationObj.multipleClients)
        dsDoc.rec.ClientCode = operationObj.clientCode;
      end;
      dsDoc.rec.OpSafeID = safeid;
      dsDoc.rec.OpCellNumber = cellnumber;
      dsDoc.rec.ApplicationKind = Parm.ApplicationKind;
      dsDoc.rec.ApplicationKey = Parm.ApplicationKey;
      dsDoc.rec.InSum = NumKeys;
      operationObj.docList.insert(dsDoc);
    end;
  end;


  macro createDocuments()
    var dsDoc,payDoc,depDoc,contr;
    var RepDate, EndDate;

    contr = operationObj.contract;

    dsDoc = operationObj.newDsDoc(1);
    operationObj.AddAgreement.SetAddAgreementDoc( dsDoc );

    dsDoc.rec.NewTermType = operationObj.newTermtype;
    dsDoc.rec.NewTermValue = operationObj.newTermValue;
    dsDoc.rec.NewTermTail = operationObj.newTermTail;
    dsDoc.rec.NewBeginDate = contr.rec.OpenDate;
    dsDoc.rec.NewEndDate = operationObj.NewEndProlongDate;
    dsDoc.rec.OldTermType = contr.rec.TermType;
    dsDoc.rec.OldTermValue = contr.rec.TermValue;
    dsDoc.rec.OldTermTail = contr.rec.TermTail;
    dsDoc.rec.OldBeginDate = contr.rec.OpenDate;
    dsDoc.rec.OldEndDate = contr.rec.EndDate;
    dsDoc.rec.OldProlongDate = contr.rec.ProlongDate;
    dsdoc.rec.OldGrntSum = OldGrntSum; //contr.rec.GrntSum;

    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;

/* Запись в переменную часть */
    dsDoc.setVarPartFormat("dsdocdop");
    dsDoc.varPart.rec.CheckBeginDate = contr.varPart.rec.CheckBeginDate;
    dsDoc.varPart.rec.OldCheckBeginDate = contr.varPart.rec.CheckBeginDate;
    dsDoc.varPart.rec.OldCheckEndDate = contr.varPart.rec.CheckEndDate;
    RunPanelForDocument( dsDoc, 1 );
    contr.varPart.rec.CheckEndDate = dsDoc.varPart.rec.CheckEndDate;

    operationObj.docList.insert(dsDoc);

/* Заполнение записи договора новыми сроками */
    contr.rec.TermType = operationObj.newTermtype;
    contr.rec.TermValue =  operationObj.newTermValue;
    contr.rec.TermTail =  operationObj.newTermTail;
    contr.rec.ProlongDate =  {curdate};
    contr.rec.EndDate = operationObj.NewEndProlongDate;

/* Взятие штрафа за просрочку */
    if(operationObj.expPnltSum)
      dsDoc = operationObj.newDsDoc(2);
      if(operationObj.expPnltSum > 0)
        dsDoc.rec.InSum = operationObj.expPnltSum;
      else
        dsDoc.rec.OutSum = abs(operationObj.expPnltSum);
      end;
      dsDoc.rec.CurrCode = operationObj.expPnltCurrCode;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.expPnltClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Валюта@Просрочка", dsDoc.rec.CurrCode);
      StoreValue("doc:Сумма@Просрочка", dsDoc.rec.InSum);

      if( operationObj.expPnltIsNonCash != DSPM_PUT )
        if( (operationObj.expPnltIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          if( contr.rec.GuaranteeAccount != "" )
            payDoc.rec.PayAcc = contr.rec.GuaranteeAccount;
          end;
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;

/* Залог */                                   
    if(operationObj.grntSum)
      dsDoc = operationObj.newDsDoc(3);
      if(operationObj.grntSum > 0)
        dsDoc.rec.InSum = operationObj.grntSum;
      else
        dsDoc.rec.OutSum = abs(operationObj.grntSum);
      end;
      dsDoc.rec.CurrCode = operationObj.grntCurrCode;
      if( operationObj.grntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.guaranteer;
      dsDoc.rec.Referenc = operationObj.grntFromAccount;
      operationObj.docList.insert(dsDoc);

      contr.rec.Guaranteer = operationObj.guaranteer;
      contr.rec.GrntReferenc = operationObj.grntFromAccount;

      if( operationObj.grntIsNonCash != DSPM_PUT )
        if( (operationObj.grntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          if( contr.rec.GuaranteeAccount != "" )
            payDoc.rec.PayAcc = contr.rec.GuaranteeAccount;
          end;
          operationObj.docList.insert(payDoc);
        end;
      end;

      StoreValue("doc:Валюта@Залог", dsDoc.rec.CurrCode);
      if (dsDoc.rec.InSum > 0)
        StoreValue("doc:Сумма@Залог", dsDoc.rec.InSum);
      else
        StoreValue("doc:Сумма@ВозвратЗалога", dsDoc.rec.OutSum);
      end;
    end;
/* Плата за аренду */
    if(operationObj.pmntSum)
      dsDoc = operationObj.newDsDoc(4);
      if(operationObj.pmntSum > 0)
        dsDoc.rec.InSum = operationObj.pmntSum;
      else
        dsDoc.rec.OutSum = abs(operationObj.pmntSum);
      end;
      dsDoc.rec.CurrCode = operationObj.pmntCurrCode;
      dsDoc.rec.NdsSum = operationObj.pmntNds;
      if( operationObj.pmntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Сумма@ПросрочкаНДС", dsDoc.rec.InSum);

      if( operationObj.pmntIsNonCash != DSPM_PUT )
        if( (operationObj.pmntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;
/* Взятие НДС */
    if(operationObj.nds)
      dsDoc = operationObj.newDsDoc(5);
      if(operationObj.nds > 0)
        dsDoc.rec.InSum = operationObj.nds;
      else
        dsDoc.rec.OutSum = abs(operationObj.nds);
      end;
      dsDoc.rec.CurrCode = NATIONAL_CURR;
      if( operationObj.pmntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      if( operationObj.pmntIsNonCash != DSPM_PUT )
        if( (operationObj.pmntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;
/* Взятие НП */
    if(operationObj.salesTax)
      dsDoc = operationObj.newDsDoc(6);
      if(operationObj.salesTax > 0)
        dsDoc.rec.InSum = operationObj.salesTax;
      else
        dsDoc.rec.OutSum = abs(operationObj.salesTax);
      end;
      dsDoc.rec.CurrCode = NATIONAL_CURR;
      if( operationObj.pmntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      if( operationObj.pmntIsNonCash != DSPM_PUT )
        if( (operationObj.pmntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;

/* Отражение платы на доходах банка */
    /*dsDoc = operationObj.newDsDoc(7);
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;
    operationObj.docList.insert(dsDoc);

    RepDate = GetReportDate( GetClientType(contr.rec.ContrTypeID), {curdate} );
    if( RepDate <= {curdate} )
      payDoc = operationObj.newAccrPayDoc(dsDoc);
      if( ValType(payDoc) != V_UNDEF )
        payDoc.varPart.rec.StartDate = dsDoc.rec.PayStartDate;
        EndDate = GetDateEnd( GetClientType(contr.rec.ContrTypeID), {curdate} );
        if( EndDate < dsDoc.rec.PayEndDate )
          payDoc.varPart.rec.EndDate = EndDate;
  else
          payDoc.varPart.rec.EndDate = dsDoc.rec.PayEndDate;
  end;
  payDoc.rec.InSum = dsDoc.rec.InSum * (double(GetNumDaysBetwen2Dates(payDoc.varPart.rec.StartDate, payDoc.varPart.rec.EndDate))/double(GetNumDaysBetwen2Dates(dsDoc.rec.PayStartDate, dsDoc.rec.PayEndDate)));
  payDoc.rec.NDSSum = dsDoc.rec.NdsSum * (double(GetNumDaysBetwen2Dates(payDoc.varPart.rec.StartDate, payDoc.varPart.rec.EndDate))/double(GetNumDaysBetwen2Dates(dsDoc.rec.PayStartDate, dsDoc.rec.PayEndDate)));
        operationObj.docList.insert(payDoc);
      else
        msgbox("Документ прочей операции не создан!");
      end;
    end;*/

/* Возврат ключей */
    /* Определяем количество ячеек для которых количество ключей больше 0 */
    var cellsWithKeys = 0;
    var cells = contr.CellList;
    var hasNext = cells.first();
    while (hasNext)
      if (cells.item.rec.isNeedCloseCell and (GetNumOfKeys(contr.rec.Branch, cells.item.rec.SafeID, cells.item.rec.CellNumber) > 0))
        cellsWithKeys = cellsWithKeys + 1;
      end;
      hasNext = cells.next();
    end;
    // если есть ячейки с ключами    
    if (cellsWithKeys > 0)
      if (not GetTrue(true, "Клиент возвращает ключи от ВСЕХ освобождаемых ячеек"))
        msgbox("Продление невозможно без возврата ключей");
        return false;
      end;

      hasNext = cells.first();
      while (hasNext)
        if (cells.item.rec.isNeedCloseCell and (GetNumOfKeys(contr.rec.Branch, cells.item.rec.SafeID, cells.item.rec.CellNumber) > 0))
          CreateDocForCell(contr.rec.Branch, cells.item.rec.SafeID, cells.item.rec.CellNumber);
        end;
        hasNext = cells.next();
      end;
    end;

    return true;
  end;

  macro runOp()
    if( operationObj.opNumber == OP_PROLONG )
      msgbox("Операция пролонгации невозможна для такого типа договоров!");
      return false;
    else
      operationObj.contract.setVarPartFormat("dscondop");
      msgbox( CreateString(operationObj.contract.varPart.rec.Condition) );
      return runOp();
    end;
  end;

  InitTOperationExecutor( opObj );
end;

/********* Основная программа ******************************/

var obj = TConditionProlongProdOperation( operation );

  obj.runOp();

end;