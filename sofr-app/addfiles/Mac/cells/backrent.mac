/*   Откат операции - аренда ячейки */
import stforcel, rsd;

private var rollbackdata  = CreateRollbackDataObject();  /* Обьект, необходимый для отката */

macro TrnProc

  var cmd;
  var stat,contr = rollbackdata.footprint.contract;

  contr.rec.IsClosed = "З";
  stat = rollbackdata.footprint.contract.save();
  if(stat)
    stat = rollbackdata.footprint.rollback();
  end;


  if ( stat )
    cmd = RsdCommand( string("update dds_cell_dbt set t_state=",DS_CELL_FREE,
                             " where (t_branch, t_safeID, t_cellNumber) in",
                             " (select a.t_branch, a.t_safeID, a.t_cellNumber from ddscn_cel_dbt a where a.t_branch=? and a.t_contractID=?)" ) );   
    cmd.addParam("Branch",   RSDBP_IN, contr.rec.branch );
    cmd.addParam("ContractID",     RSDBP_IN, contr.rec.ContractID );    
    cmd.execute();

    cmd = RsdCommand( "delete from ddscn_cel_dbt where t_branch=? and t_contractID=?" );   
    cmd.addParam("Branch",   RSDBP_IN, contr.rec.branch );
    cmd.addParam("ContractID",     RSDBP_IN, contr.rec.ContractID );    
    cmd.execute();
  end;

  if(not stat)
    AbortTrn()
  end;

end;
  
  if(ProcessTrn( 1, "TrnProc") )
    MsgBox("Откат аренды ячейки прошел успешно");
  else
    rollbackdata.footprint.displayErrorMessage();
    MsgBox("Откат аренды ячейки прошел с ошибками");
  end;

end;