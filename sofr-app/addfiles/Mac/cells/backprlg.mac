/*   Откат операции - Пролонгация / Продление */
import stforcel;

private var rollbackdata  = CreateRollbackDataObject();  /* Обьект, необходимый для отката */

macro TrnProc

var stat,contr = rollbackdata.footprint.contract,doc;

  stat = rollbackdata.footprint.bunch.first();
  if(stat)
    doc = rollbackdata.footprint.bunch.item;
    contr.rec.TermType = doc.rec.OldTermType;
    contr.rec.TermValue = doc.rec.OldTermValue;
    contr.rec.TermTail = doc.rec.OldTermTail;
    contr.rec.ProlongDate = doc.rec.OldBeginDate;
    contr.rec.EndDate = doc.rec.OldEndDate;
    contr.rec.ProlongDate = doc.rec.OldProlongDate;
    contr.rec.GrntSum = doc.rec.OldGrntSum;

    if( rollbackdata.footprint.contractType == CT_PROPERTY )
      contr.setVarPartFormat("dscondop");
      doc.setVarPartFormat("dsdocdop");
      contr.varPart.rec.CheckBeginDate = doc.varPart.rec.OldCheckBeginDate;
      contr.varPart.rec.CheckEndDate = doc.varPart.rec.OldCheckEndDate;
      stat = rollbackdata.footprint.bunch.update();
    end;

    if( stat )
      stat = rollbackdata.footprint.contract.save();
      if(stat)
        stat = rollbackdata.footprint.rollback();
      end;
    end;
  end;

  if(not stat)
    AbortTrn()
  end;

end;

  if(ProcessTrn( 1, "TrnProc") )
    MsgBox("Откат операции Пролонгация / Продление прошел успешно");
  else
    rollbackdata.footprint.displayErrorMessage();
    MsgBox("Откат операции Пролонгация / Продление прошел с ошибками");
  end;

end;