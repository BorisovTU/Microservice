/* Печать доп. соглашения аренды
   Ярмольчук А.Ю.
*/
import stforcel, "or_rep_h.mac", ptlib;
import stprocs;

var bunch         = CreateOpFootprintObject();

var ObjPrint:CMakeReport = CMakeReport("", SEP_DEFAULT, 99999); 

var docBunch=bunch.bunch;

var Contract = bunch.contract;

var rentDoc  :object  = null; 

var Покупатель_=TclientList, 
    Продавец_  =TclientList, 
    Код_клиента, Наименование_клиента;

var День_, Месяц_, Год_, Город, Номер_договора, Инфо_по_заведующей, 
    Ячейка, Адрес_филиала, Наименование_подразделения, Дата_выдачи, Данные_документа,
    Срок_в_днях_строка, Срок_в_днях, RubSum, CopSum, Сумма_аренды, Сумма_аренды_стр,
    Сумма_НДС, Сумма_НДС_стр, RubSum_nds, CopSum_nds,
    Счет_банка, Телефоны_банка, Доверенность_банка, Почтовый_адрес_банка,
    Счет_клиента_, Код_клиента_плательщика, Acc_referenc,
    Данные_продавца_1="", Данные_покупателя_1="",
    Данные_продавца_2="", Данные_покупателя_2="",
    Номер_доп_согл, День_вып, Месяц_вып, Год_вып, День_дог, Месяц_дог, Год_дог,
    День_нач, Месяц_нач, Год_нач, День_зав, Месяц_зав, Год_зав, 
    День_акт, Месяц_акт, Год_акт;



private var {Bank_INN}, {MFO_Bank}, {CORAC_Bank};
var hasNextCell, Доп_соглашение;

array MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1 , Код_поверенного_1,
      MAIN_CLNT_2, DOVER_CLNT_2, Код_юр_лица_2 , Код_поверенного_2,
      MAIN_CODE_1, MAIN_CODE_2,  DOVER_CODE_1,   DOVER_CODE_2;


       if (docBunch.first ())

          rentDoc = docBunch.item; 

          Доп_соглашение = Найти_доп_cоглашение(rentDoc.rec.ApplicationKind, rentDoc.rec.ApplicationKey);
          if ( Доп_соглашение==NULL )
             msgbox ("Не найдено дополнительное соглашение");
             exit;
          end;
          
          /* Данные для печати доп. соглашения */
          /* Данные аренды */
          Номер_договора=Contract.rec.number;
          Номер_доп_согл=Доп_соглашение.value("t_AddAgrmntID"); 
          Дата_для_шаблонов (docBunch.item.rec.date,День_вып,Месяц_вып,Год_вып);
          Дата_для_шаблонов (Contract.rec.opendate,День_дог,Месяц_дог,Год_дог);
          Дата_для_шаблонов (docBunch.item.rec.date,День_акт, Месяц_акт, Год_акт);
          Дата_для_шаблонов (Доп_соглашение.value("t_BeginDate"),День_нач, Месяц_нач, Год_нач);
         Дата_для_шаблонов (Доп_соглашение.value("t_EndDate"),  День_зав, Месяц_зав, Год_зав);

          if (Доп_соглашение.value("t_newtermtype")==ADSP_DAY)
             Срок_в_днях=Доп_соглашение.value("t_newtermvalue");
             Срок_в_днях_строка=NumToStr (Срок_в_днях,"","","",TRUE);
          else
             msgbox ("Срок продления аренды согласно текущей 527-3-р должен задаваться в днях!");
             Срок_в_днях=0;
             Срок_в_днях_строка="";
          end;

          Сумма_аренды = rentDoc.rec.pmntSum + rentDoc.rec.NdsSum;

          Сумма_НДС   = rentDoc.rec.NdsSum;

          RubSum = SubStr( String( Сумма_аренды ), 1, Index( String( Сумма_аренды ), "." ) - 1 );
          CopSum = SubStr( String( Сумма_аренды), Index( String( Сумма_аренды ), "." ) + 1 );

          RubSum_nds = SubStr( String( Сумма_НДС ), 1, Index( String( Сумма_НДС ), "." ) - 1 );
          CopSum_nds = SubStr( String( Сумма_НДС), Index( String( Сумма_НДС ), "." ) + 1 );

          Сумма_аренды_стр=doMoneyToStr_jar (Сумма_аренды,0);
          Сумма_НДС_стр   =doMoneyToStr_jar (Сумма_НДС,0);

          /* Продавец */
          if (Есть_юр_лицо (Contract.rec.Branch, Contract.rec.ContractID, ПРОДАВЕЦ))

             Наименование_клиентов_по_юр_договору (Contract.rec.Branch, Contract.rec.ContractID, ПРОДАВЕЦ, MAIN_CLNT_1, DOVER_CLNT_1, Код_юр_лица_1 , Код_поверенного_1);
             Данные_продавца_1 = "Клиент (Продавец) "+Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_1(0));


             if (MAIN_CLNT_1(1))

               Данные_продавца_2 = "Клиент (Продавец) "+Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_1(1));

             else

               MAIN_CLNT_1 (1)=""; DOVER_CLNT_1 (1)="";

             end;

          else

             Клиенты_по_договору (Contract.rec.Branch, Contract.rec.ContractID, ПРОДАВЕЦ, MAIN_CLNT_1, DOVER_CLNT_1, MAIN_CODE_1, DOVER_CODE_1);

             if (MAIN_CLNT_1(0))

                if (Код_клиента_плательщика==MAIN_CODE_1(0))
                   Acc_referenc= rentDoc.rec.referenc;
                else
                   Acc_referenc= 0;
                end;

                Данные_продавца_1 = "Клиент (Продавец): "+Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_1(0), Acc_referenc);

             end;

             if (MAIN_CLNT_1(1))

                if (Код_клиента_плательщика==MAIN_CODE_1(1))
                   Acc_referenc= rentDoc.rec.referenc;
                else
                   Acc_referenc= 0;
                end;

                Данные_продавца_2 = "Клиент (Продавец): "+Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_1(1), Acc_referenc);

             end;



          end;

          /* Покупатель */
          if (Есть_юр_лицо (Contract.rec.Branch, Contract.rec.ContractID, ПОКУПАТЕЛЬ))

              Наименование_клиентов_по_юр_договору (Contract.rec.Branch, Contract.rec.ContractID, ПОКУПАТЕЛЬ, MAIN_CLNT_2 , DOVER_CLNT_2 , Код_юр_лица_2, Код_поверенного_2);
              Данные_покупателя_1 = Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_2(0));

              if (MAIN_CLNT_2(1))

                Данные_покупателя_1 = "Клиент (Покупатель) "+Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица_2(1));

              else
                MAIN_CLNT_2 (1)=""; DOVER_CLNT_2 (1)="";
              end;


          else

              Клиенты_по_договору (Contract.rec.Branch, Contract.rec.ContractID, ПОКУПАТЕЛЬ, MAIN_CLNT_2, DOVER_CLNT_2, MAIN_CODE_2, DOVER_CODE_2);

              if (MAIN_CLNT_2(0))

                 if (Код_клиента_плательщика==MAIN_CODE_2(0))
                    Acc_referenc= rentDoc.rec.referenc;
                 else
                    Acc_referenc= 0;
                 end;

                 Данные_покупателя_1 = "Клиент (Покупатель): "+Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_2(0), Acc_referenc);

              end;

              if (MAIN_CLNT_2(1))

                 if (Код_клиента_плательщика==MAIN_CODE_2(1))
                    Acc_referenc= rentDoc.rec.referenc;
                 else
                    Acc_referenc= 0;
                 end;

                 Данные_покупателя_2 = "Клиент (Покупатель): "+Сформировать_строку_данных_физ_лица_для_договора (MAIN_CODE_2(1), Acc_referenc);

              end;

               
          end;

          /* Данные по подразделению и банку */
          Адрес_филиала              = GetNumBranch (NumFnCash, "Адрес");
          Наименование_подразделения = GetNumBranch (NumFnCash, "Наименование");
          Инфо_по_заведующей         = "Заведующий " + GetNumBranch( NumFnCash, "Заведующая" );
          Город                      = Получить_название_города_из_реестра();
          //Счет_банка                 = Счет_банка_474 ();
          Телефоны_банка             = GetNumBranch( NumFnCash, "Телефон" );
          Доверенность_банка         = "_________________________________________________";
          Почтовый_адрес_банка       = Адрес_филиала;

          ObjPrint.RegisterForm ("Доп_соглашение","доп_соглашение_сделка.doc","Доп_соглашение_сделка.doc",
                                 "Номер_доп_согл", 
                                 "Номер_договора", 
                                 "День_дог", "Месяц_дог", "Год_дог",
                                 "Город",
                                 "День", "Месяц", "Год",
                                 "Заведующая",
                                 "Доверенность",
                                 "FIO1", "DOVER1",
                                 "FIO2", "DOVER2",
                                 "FIO3", "DOVER3",
                                 "FIO4", "DOVER4",
                                 "Ячейка",
                                 "Срок_аренды",
                                 "Срок_аренды_строкой",
                                 "День_нач", "Месяц_нач", "Год_нач",
                                 "День_зав", "Месяц_зав", "Год_зав",
                                 "Сумма_аренды_руб", 
                                 "Сумма_аренды_коп",
                                 "Сумма_аренды_стр",
                                 "НДС_руб", 
                                 "НДС_коп", 
                                 "Сумма_НДС_стр",
                                 "Адрес", "ИНН", "Счет", "БИК", "Корсч", "Телефон",
                                 "Данные_продавца",
                                 "Данные_продавца_2",
                                 "Данные_покупателя",
                                 "Данные_покупателя_2"
                                );


          hasNextCell = Contract.CellList.first();
          if( hasNextCell )
             Ячейка = "";
             while( hasNextCell )
               Ячейка = Ячейка + Contract.CellList.item.rec.cellnumber;
               hasNextCell = Contract.CellList.next();
               if ( hasNextCell )
                  Ячейка = Ячейка + ", ";
               end;
             end;

             ObjPrint.AddDoc ("Доп_соглашение",
                             Номер_доп_согл,             /*  "Номер_доп_согл", */
                             Номер_договора,             /* "Номер_договора", */
                             День_дог,Месяц_дог,Год_дог, /* "День_дог", "Месяц_дог", "Год_дог",*/
                             Город,                      /* "Город", */
                             День_вып,Месяц_вып,Год_вып, /* "День", "Месяц", "Год",*/
                             Инфо_по_заведующей,         /* "Заведущая", */
                             Доверенность_банка,         /* "Доверенность", */ 
                             MAIN_CLNT_1  (0),      /* "FIO1",     */ 
                             DOVER_CLNT_1 (0),      /* "DOVER1", */ 
                             MAIN_CLNT_1  (1),      /* "FIO2",   */ 
                             DOVER_CLNT_1 (1),      /* "DOVER2",  */ 
                             MAIN_CLNT_2  (0),      /* "FIO3",    */ 
                             DOVER_CLNT_2 (0),      /* "DOVER3", */ 
                             MAIN_CLNT_2  (1),      /* "FIO4",    */ 
                             DOVER_CLNT_2 (1),      /* "DOVER4",  */ 
                             Ячейка,                     /*  "Ячейка", */
                             Срок_в_днях,                /* "Срок_аренды",*/
                             Срок_в_днях_строка,         /* "Срок_аренды_строкой", */
                             День_нач, Месяц_нач, Год_нач,            /* "День_нач", "Месяц_нач", "Год_нач",*/
                             День_зав, Месяц_зав, Год_зав,            /* "День_зав", "Месяц_зав", "Год_зав",*/
                             RubSum,            /* "Сумма_аренды_руб",*/
                             CopSum,            /* "Сумма_аренды_коп",*/
                             Сумма_аренды_стр,            /* "Сумма_аренды_стр",*/
                             RubSum_nds,            /* "НДС_руб",        */
                             CopSum_nds,            /* "НДС_коп",        */
                             Сумма_НДС_стр,            /*  "Сумма_НДС_стр", */
                             Почтовый_адрес_банка, {Bank_INN}, Счет_банка, {MFO_Bank}, {CORAC_Bank}, Телефоны_банка, /*   "ИНН", "Счет", "БИК", "Корсч", "Телефон",*/
                             Данные_продавца_1,
                             Данные_продавца_2,
                             Данные_покупателя_1,
                             Данные_покупателя_2
                             );

             ObjPrint.CreateTemplateData();

             ObjPrint.ShowTemplateRep();

             println("Документ сформирован. Переключитесь в окно Word!");
          else
             msgbox( "Не найдено ни одной ячейки!" );
          end;         
       else
          msgbox ("Не найден документ по операции");
       end;
   end;
