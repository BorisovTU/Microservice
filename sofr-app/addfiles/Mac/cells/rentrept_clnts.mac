/* 
    Печать договора аренды (1 арендатор)
*/

import "or_rep_h.mac", "ptlib.mac";
import stforcel, stprocs;
var bunch         = CreateOpFootprintObject();   /* Объект, необходимый для печати */

private var {Bank_INN}, {MFO_Bank}, {CORAC_Bank};

var ObjPrint:CMakeReport = CMakeReport("", SEP_DEFAULT, 99999); 

var docBunch :object = bunch.bunch;
var Contract :object = bunch.contract;
var rentDoc  :object  = null; 
var ДокументЗаУслугу  :object  = null; 

var Код_клиента = 0;
var Код_клиента_владельца = 0;

var conType = TBFile( "ds_contp", 0, "R" );

var День_дог, Месяц_дог, Год_дог;
var Город, Номер_договора;
var Ячейка, Адрес_филиала, Наименование_подразделения, Инфо_по_заведующей, Подразделение;
var Наименование_клиента, Наименование_клиента2;
var Данные_клиента, Данные_клиента2;
var Почтовый_адрес_банка;
var Счет_банка, Телефоны_банка;    
var Срок_аренды = 0, Срок_аренды_строкой = "";
var Сумма_аренды_руб, Сумма_аренды_коп, Сумма_аренды_стр;
var СуммаНДС_руб, СуммаНДС_коп, СуммаНДС_стр; 
var Сумма_услуги_руб, Сумма_услуги_коп, Сумма_услуги_стр;
var СуммаНДСУслуги_руб, СуммаНДСУслуги_коп, СуммаНДСУслуги_стр; 
var Сумма_техн_руб, Сумма_техн_коп, Сумма_техн_стр;
var СуммаНДСТехн_руб, СуммаНДСТехн_коп, СуммаНДСТехн_стр;

macro createReportForOneCell()  

  ObjPrint.AddDoc("ДоговорАренды",
    Номер_договора,
    Город,
    День_дог, Месяц_дог, Год_дог,
    Инфо_по_заведующей,
    Наименование_клиента, Наименование_клиента2,
    Ячейка, 
    Адрес_филиала,
    Подразделение,
    Срок_аренды, Срок_аренды_строкой,
    string(Сумма_аренды_руб), string(Сумма_аренды_коп), Сумма_аренды_стр,
    string(СуммаНДС_руб), string(СуммаНДС_коп), СуммаНДС_стр, 
    string(Сумма_услуги_руб), string(Сумма_услуги_коп), Сумма_услуги_стр,
    string(СуммаНДСУслуги_руб), string(СуммаНДСУслуги_коп), СуммаНДСУслуги_стр,
    string(Сумма_техн_руб), string(Сумма_техн_коп), Сумма_техн_стр,
    string(СуммаНДСТехн_руб), string(СуммаНДСТехн_коп), СуммаНДСТехн_стр,
    Почтовый_адрес_банка, {Bank_INN}, Счет_банка, {MFO_Bank}, {CORAC_Bank}, Телефоны_банка,
    Данные_клиента, Данные_клиента2
  );

  ObjPrint.CreateTemplateData();
end;


macro regCtrForm()
  ObjPrint.RegisterForm ("ДоговорАренды","Договор_аренды_расчёты.doc","Договор_аренды_расчёты_.doc",
    "Номер_договора",
    "Город",
    "День", "Месяц", "Год",
    "Заведующая",
    "Клиент", "Клиент2",
    "Ячейка",
    "Адрес",
    "Подразделение",
    "Срок_аренды",
    "Срок_аренды_строкой",
    "Сумма_аренды_руб", "Сумма_аренды_коп", "Сумма_аренды_стр",
    "НДС_руб", "НДС_коп", "Сумма_НДС_стр",  
    "СуммаУслугиРуб", "СуммаУслугиКоп", "СуммаУслугиСтрокой",
    "НДСУслугиРуб", "НДСУслугиКоп", "НДСУслугиСтрокой",
    "СуммаТехнРуб", "СуммаТехнКоп", "СуммаТехнСтрокой",
    "НДСТехнРуб", "НДСТехнКоп", "НДСТехнСтрокой",
    "Почт_адрес_банка", "ИНН", "Счет", "БИК", "Корсч", "Телефон",
    "Данные_клиента", "ДанныеКлиента2"
  );
end;


macro PrintContract()
  array MAIN_CLNT_1, DOVER_CLNT_1, MAIN_CODE_1, DOVER_CODE_1;
  array MAIN_CLNT_2, DOVER_CLNT_2, MAIN_CODE_2, DOVER_CODE_2;
  var Сумма = $0, КодВалюты = 0;
  var hasNextCell = false;
  var Acc_referenc1, Acc_referenc2;
  var Код_клиента_плательщика;

  rentDoc = Найти_документ_операции( Contract.rec.Branch, Contract.rec.ContractID, 1, 1 );
  ДокументЗаУслугу  = Найти_документ_операции( Contract.rec.Branch, Contract.rec.ContractID, 1, 9 );

  if( rentDoc != null )
    /* Данные для печати договора */
    /* Данные аренды */
    Номер_договора = Contract.rec.number;
    Дата_для_шаблонов( Contract.rec.OpenDate, День_дог, Месяц_дог, Год_дог );

    if( Contract.rec.TermType == ADSP_DAY )
       Срок_аренды = Contract.rec.TermValue;
       Срок_аренды_строкой = NumToStr( Срок_аренды, "", "", "", TRUE );
    else
       msgbox("Срок договора согласно текущей 527-3-р должен задаваться в днях!");
    end;

    КодВалюты = rentDoc.rec.CurrCode;

    Сумма = rentDoc.rec.pmntSum + rentDoc.rec.NdsSum;
    Сумма_аренды_руб = floor(Сумма);
    Сумма_аренды_коп = Сумма*100 - floor(Сумма)*100;
    Сумма_аренды_стр = CurToStrAlt(Сумма, null, null, КодВалюты);

    Сумма = rentDoc.rec.NdsSum;
    СуммаНДС_руб = floor(Сумма);
    СуммаНДС_коп = Сумма*100 - floor(Сумма)*100;
    СуммаНДС_стр = CurToStrAlt(Сумма, null, null, КодВалюты);   

    if (ДокументЗаУслугу != null)
       
        КодВалюты = ДокументЗаУслугу.rec.CurrCode;

    	Сумма = ДокументЗаУслугу.rec.InSum + ДокументЗаУслугу.rec.NDSSum;
    	Сумма_услуги_руб = floor(Сумма);
    	Сумма_услуги_коп = Сумма*100 - floor(Сумма)*100;
    	Сумма_услуги_стр = CurToStrAlt(Сумма, null, null, КодВалюты);
	
    	Сумма = ДокументЗаУслугу.rec.NDSSum;
    	СуммаНДСУслуги_руб = floor(Сумма);
    	СуммаНДСУслуги_коп = Сумма*100 - floor(Сумма)*100;
    	СуммаНДСУслуги_стр = CurToStrAlt(Сумма, null, null, КодВалюты); 
     
    else
        Сумма_услуги_руб = Сумма_услуги_коп = $0;
        Сумма_услуги_стр = CurToStrAlt($0, null, null, 0);
	СуммаНДСУслуги_руб = СуммаНДСУслуги_коп = $0;
	СуммаНДСУслуги_стр = CurToStrAlt($0, null, null, 0);
    end;


    
        КодВалюты = rentDoc.rec.CurrCode;

    	Сумма = rentDoc.rec.Banktech_Sum + rentDoc.rec.Banktech_VatSum;
    	Сумма_техн_руб = floor(Сумма);
    	Сумма_техн_коп = Сумма*100 - floor(Сумма)*100;
    	Сумма_техн_стр = CurToStrAlt(Сумма, null, null, КодВалюты);
	
    	Сумма = rentDoc.rec.Banktech_VatSum;
    	СуммаНДСТехн_руб = floor(Сумма);
    	СуммаНДСТехн_коп = Сумма*100 - floor(Сумма)*100;
    	СуммаНДСТехн_стр = CurToStrAlt(Сумма, null, null, КодВалюты); 
     

    /* Данные клиентов. */
	Код_клиента_плательщика = rentDoc.rec.pmntClient; /* код клиента плательщика */ 
       
	Клиенты_по_договору (Contract.rec.Branch, Contract.rec.ContractID, АРЕНДАТОР1, MAIN_CLNT_1, DOVER_CLNT_1, MAIN_CODE_1, DOVER_CODE_1);
	Клиенты_по_договору (Contract.rec.Branch, Contract.rec.ContractID, АРЕНДАТОР2, MAIN_CLNT_2, DOVER_CLNT_2, MAIN_CODE_2, DOVER_CODE_2);

	if (Код_клиента_плательщика == MAIN_CODE_1(0))
    	Acc_referenc1 = rentDoc.rec.referenc;
	    Acc_referenc2 = 0;
    else
        Acc_referenc1 = 0;
        Acc_referenc2 = rentDoc.rec.referenc;
    end;

	Данные_клиента = Сформировать_строку_данных_физ_лица_для_договора ( MAIN_CODE_1(0), Acc_referenc1 );
	Данные_клиента2 = Сформировать_строку_данных_физ_лица_для_договора( MAIN_CODE_2(0), Acc_referenc2 );
       
	Наименование_клиента  = MAIN_CLNT_1(0);
	Наименование_клиента2 = MAIN_CLNT_2(0);	   


    /* Данные по подразделению и банку */
    Адрес_филиала             = GetNumBranch( NumFnCash, "Адрес" );
    Наименование_подразделения= GetNumBranch( NumFnCash, "Наименование" );
    Инфо_по_заведующей        = "Заведующий " + GetNumBranch( NumFnCash, "Заведующая" );
    Город                     = Получить_название_города_из_реестра();
    //Счет_банка                = Счет_банка_474();
    Телефоны_банка            = GetNumBranch( NumFnCash, "Телефон" );
    Почтовый_адрес_банка      = Адрес_филиала;

    /* Печать договора */
    regCtrForm();

    /* Определяем тип контракта: мультиячеечный или нет */
    conType.clear();
    conType.rec.contrtypeid = Contract.rec.contrtypeid;
    conType.getEQ();

    /* одна ячейка будет по-любому */
    hasNextCell = Contract.CellList.first();
    if( hasNextCell )
        Ячейка = "";
        while( hasNextCell )
          Ячейка = Ячейка + Contract.CellList.item.rec.cellnumber;
          hasNextCell = Contract.CellList.next();
          if ( hasNextCell )
             Ячейка = Ячейка + ", ";
          end;
        end;
        createReportForOneCell();
        
        ObjPrint.ShowTemplateRep();
        println("Документ сформирован. Переключитесь в окно Word!");
    else
        msgbox( "Не найдено ни одной ячейки!" );
        exit (1);
    end;

  else
    msgbox ("Не найден документ Аренды");
    exit (1);
  end;

end;

/**************************************************************************************************/
/* Основная программа */
  PrintContract();
