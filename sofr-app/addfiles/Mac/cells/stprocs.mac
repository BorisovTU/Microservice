/*
$Name:             stprocs.mac
$Module:           RS-Retail
$Description:      Сейфовые ячейки
*/

import RSD, Календарь, stforcel;

  /* следующий день после окончания договора */
  /* рассчитываем количество выходных дней следующих непрерывно за последним днем аренды */
macro CalcExtraDays( endDate )
  var tmpDate     = endDate + 1;
  var exDays      = 0;
  var hasHolidays = isHoliday( tmpDate );

  while( (hasHolidays==1) and (tmpDate < {curdate}) )
    exDays      = exDays + 1;
    tmpDate     = tmpDate + 1;
    hasHolidays = isHoliday( tmpDate );
  end;

  // если первый рабочий день, следующий после непрерывных нерабочих дней, 
  // меньше или равен дате, предыдущей дате опердня, то прибавляем к количеству еще один (этот) день.
  if( (exDays>0) and (tmpDate <= ({curdate} - 1)) )
    exDays = exDays + 1;
  end;
    
  return exDays;
end;

/*! ищет клиента по номеру контракта и атрибутам */
/* возвращает RsdRecordset */
macro FindConClientByAttr( branch, contractid, attr )

  var query, cmd, Rs;
  query = "select * from dds_concl_dbt " +
          "where T_BRANCH = " + branch + 
          " and T_CONTRACTID = " + contractid + " and T_ATTRIBUTES LIKE '%" + string(attr) + "%'";
               
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  return Rs;

end;

/* 
  Ищет клиентов по контракту С атрибутом attr в группе groupNumber
  если groupNumber == 0 ищет во всех группах
  возвращает RsdRecordset
*/
macro FindConClientWithAttrRs( branch, contractid, groupNumber, attr )

  var cmd = null;
  var Rs  = null; 
  var query = "select * from dds_concl_dbt " +
               "where T_BRANCH = " + branch + 
              " and T_CONTRACTID = " + contractid + 
              " and T_ATTRIBUTES LIKE '%" + string(attr) + "%'";
               
  if( (groupNumber != 0) and (groupNumber != null) )
    query = query + " and T_GroupNumber = " + groupNumber; 
  end;
  
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  return Rs;

end;

/* 
  Ищет клиентов по контракту БЕЗ атрибута attr в группе groupNumber
  если groupNumber == 0 ищет во всех группах
  возвращает RsdRecordset
*/
macro FindConClientWithoutAttrRs( branch, contractid, groupNumber, attr )

  var cmd = null;
  var Rs  = null; 
  var query = "select * from dds_concl_dbt " +
               "where T_BRANCH = " + branch + 
               " and T_CONTRACTID = " + contractid + 
               " and T_ATTRIBUTES NOT LIKE '%" + string(attr) + "%'";
               
  if( (groupNumber != 0) and (groupNumber != null) )
    query = query + " and T_GroupNumber = " + groupNumber; 
  end;
  
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  return Rs;

end;
/* 
  Ищет клиентов по контракту С атрибутом attr в группе groupNumber
  если groupNumber == 0 ищет во всех группах
  возвращает код клиента
*/
macro FindConClientWithAttr( branch, contractid, groupNumber, attr )

  var cmd = null;
  var Rs  = null; 
  var query = "select * from dds_concl_dbt " +
              " where T_BRANCH = " + branch + 
              " and T_CONTRACTID = " + contractid;
              
  if( attr != null )
      if( attr == "" )
          query = query + " and T_ATTRIBUTES LIKE ''";
      else
          query = query + " and T_ATTRIBUTES LIKE '%" + string(attr) + "%'";
      end;
  end;

  if( (groupNumber != 0) and (groupNumber != null) )
    query = query + " and T_GroupNumber = " + groupNumber; 
  end;
  
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  
  if( Rs.moveNext() )
    return Rs.value( "t_ClientCode" );
  end;
  
  return 0;

end;

/* 
  Ищет клиентов по контракту БЕЗ атрибута attr в группе groupNumber
  если groupNumber == 0 ищет во всех группах
  возвращает код клиента
*/
macro FindConClientWithoutAttr( branch, contractid, groupNumber, attr )

  var cmd = null;
  var Rs  = null; 
  var query = "select * from dds_concl_dbt " +
               "where T_BRANCH = " + branch + 
               " and T_CONTRACTID = " + contractid + 
               " and T_ATTRIBUTES NOT LIKE '%" + string(attr) + "%'";
               
  if( (groupNumber != 0) and (groupNumber != null) )
    query = query + " and T_GroupNumber = " + groupNumber; 
  end;
  
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  
  if( Rs.moveNext() )
    return Rs.value( "t_ClientCode" );
  end;
  
  return 0;

end;


macro FindClientByAttr( clientList, attr )
  var hasNext = false;
  
  hasNext = clientList.first();
  while( hasNext )
    if( index( clientList.item.rec.Attributes, attr) != 0 )
      return clientList.item.rec.ClientCode;
    end;
    hasNext = clientList.next();  
  end;
  
  return 0; 
end;

macro DeleteAttribute( attributes, attr )
  
  if( strlen(attributes) < 1 )
      return "";
  end;
  
  if( strlen(attr) != 1 )
      return "";
  end;

  return StrSubst( attributes, attr, "" );
  
end;

macro xackCopy( to, from /* одинаковые по стр-ре  */ )
  var i = 0;

  while( i < to.fldNumber )
    to.item( i ) = from.item( i );
    i = i + 1;
  end;
end;

macro CopyRs2RecHandler( to, from )
  var i = 0;
  var rsCnt = 0;
  var val;

  while( i < to.fldNumber )
  
    val = from.value( rsCnt );
    if( ValType(val) != V_UNDEF )
      to.item( i ) = val;
      i = i + 1;
    end;
    rsCnt = rsCnt + 1;
  end;
end;

MACRO rtSQL_ConvTypeStr( val )
    /* Передан SQL'ый NULL*/
    if (ValType(val) == 26)
      return "";
    end;

    if    ( ValType (val) == V_UNDEF  ) return "";
    elif  ( ValType (val) == V_STRING )
        if ( (StrLen(val) == 1) and (CodeFor(val) == 1) ) 
            val = String("");
        end;
    end;

    return val;
END;

MACRO rtCopyRSetToFBuff( fbuff, rset )
    var idx   = 0,
        nflds = FldNumber( fbuff ),
        val,
        NullConv;

    ClearRecord(fbuff);

    if (IsEqClass("RsdRecordset", rset))
        NullConv = rset.Command.NullConversion;
        rset.Command.NullConversion = true;
    end;

    while( idx < nflds )
        val = rset.value( "t_" + FldName( fbuff, idx ) );
        if ( ValType( fbuff.item( idx ) ) == V_STRING )
            fbuff.item( idx ) = rtSQL_ConvTypeStr( val );
        elif( val != NULL )
            fbuff.item( idx ) = rset.value( "t_" + FldName( fbuff, idx ), null, ValType( fbuff.item( idx ) ) );
        end;
        idx = idx + 1;
    end;

    if (IsEqClass("RsdRecordset", rset))
        rset.Command.NullConversion = NullConv;
    end;
END;

/* Преобразование даты из рекорд-сета в дату RSL */
MACRO rtSQL_ConvTypeDate( dt )

   var d, m, y;    
   PRIVATE CONST V_SPECVAL = 26;

   /* Передан SQL'ый NULL*/
   if (ValType(dt) == V_SPECVAL)
      return Date(0, 0, 0);
   end;

   if( dt == NULL )
      return Date( 0, 0, 0 );
   end;
   if( ValType( dt ) == V_DTTM )
      DtTmSplit( dt, dt );
   end;
   if( ValType( dt ) == V_DATE )
      DateSplit( dt, d, m, y );
      if ( ( d == 1 ) and ( m == 1 ) and ( y == 1 ) )
         return Date( 0, 0, 0 );
      end;
   end;
   return dt;
END;

/*
macro FindContractClient( branch, contractid, groupNumber, clientCode )

  var query = "select * from dds_concl_dbt " +
               "where T_BRANCH = " + branch + 
               " and T_CONTRACTID = " + contractid + " and T_GROUPNUMBER = " + groupNumber +
               " and T_CLIENTCODE = " + clientCode;
               
  var cmd = RsdCommand(query);
  cmd.execute();
  var Rs = RsdRecordset( cmd, null, 0 );
  return Rs;

end;
*/
macro КоличествоПросроченныхДней (Текущая_дата, Дата_завершения, Включать_текущий_день_в_просрочку)

  var RetVal = 0;
           
   if (Текущая_дата>Дата_завершения)
      RetVal = Текущая_дата-Дата_завершения;

      if (Включать_текущий_день_в_просрочку==false)
        RetVal=RetVal-1;
      end;

      if ( isworkday(Дата_завершения)==false )
         RetVal = RetVal - CalcExtraDays( Дата_завершения );
      end;

      if ( RetVal<0 )
         RetVal = 0;
      end;
   end;

   return RetVal;

end;

macro Получить_тариф_по_операции_СЯ (Сумма_операции, Тип_договора, Номер_операции, Шаг_операции)

    var cmd, rs, sqlquery, Sum_Tarif=$0;
    var Мин_сумма, Макс_сумма, Процент, Фикс_сумма;


    sqlquery="select * from dsb_tarif_dbt tarif , dds_opstp_dbt step , dpay_kind_dbt pay_kind "+
             " where  pay_kind .T_GROUPOPERT=step.T_NUMGROUPFORPAYIN and "+
       " pay_kind.T_NUMOPERAT  =step.T_PAYINOP and "+
       " step.T_CONTRTYPEID="+Тип_договора+" and "+
       " step.T_OPNUMBER="+Номер_операции+" and "+ 
       " step.T_STEPNUMBER="+Шаг_операции+" and "+
       " tarif.T_NUMTARIF=pay_kind.T_NUMTARIF and " +
       " tarif.T_ISCUR=" + NumFlagCur + " and " +
       " tarif.T_ISCUR=pay_kind.T_ISCUR";

     cmd = RsdCommand( sqlquery );

     rs = RsdRecordset( cmd );

     cmd.execute;
    
     if ( rs.moveNext ) 
        Мин_сумма =Money(rs.value ("t_minsum"));
        Макс_сумма=Money(rs.value ("t_maxsum"));
        Процент   =Money(rs.value ("t_persent"));
        Фикс_сумма=Money(rs.value ("t_summa"));

        if   (Фикс_сумма>0)
           Sum_Tarif = Фикс_сумма;
        else
           Sum_Tarif=Сумма_операции*Процент/10000;
           Sum_Tarif= Sum_Tarif;
        end;
        if (Sum_Tarif<Мин_сумма)
            Sum_Tarif = Мин_сумма;
        end;
        if ((Макс_сумма>0) and (Sum_Tarif>Макс_сумма))
            Sum_Tarif = Макс_сумма;
        end;
     end;

     return Sum_Tarif;

end;

macro Получить_тариф_по_которому_взималась_сумма_аренды(
       Подразделение, 
       Шкаф, 
       Тип_договора,
       Номер_ячейки, 
       Тип_периода,
       Срок_договора_основной, Действующий_на_дату)


   var cmd, rs, sqlquery;

   var filial = getFilialNum(Подразделение);

   sqlquery="select * from dds_cell_dbt, dds_tarif_dbt "+
                    " where dds_cell_dbt.T_CELLTYPEID=dds_tarif_dbt.T_CELLTYPEID and "+
                    "dds_cell_dbt.T_BRANCH="+Подразделение+" and "+
                    "dds_cell_dbt.T_SAFEID="+Шкаф+" and "+
                    "dds_cell_dbt.T_CELLNUMBER="+Номер_ячейки+" and "+
                    "dds_tarif_dbt.T_CONTRTYPEID="+Тип_договора+
                    " and dds_tarif_dbt.t_Branch = " + filial +
                    " and to_date ('"+Действующий_на_дату+"','dd.mm.yyyy') between t_inputdate "+
                    " and decode (t_deletedate, TO_DATE ('01.01.0001', 'dd.mm.yyyy'), TO_DATE ('31.12.9999', 'dd.mm.yyyy'), "+
                    "             t_deletedate) ";
   var interval =   " and dds_tarif_dbt.T_TERMUNIT="+Тип_периода+
                    " and " + Срок_договора_основной+" between T_TERMMINVAL and T_TERMMAXVAL ";
   var periodic =   " and dds_tarif_dbt.t_PeriodUnit = "+Тип_периода+
                    " and T_TERMMINVAL = 0 and T_TERMMAXVAL = 0 ";
   var order_by =   "order by t_inputdate DESC";


   Array tariff_type;
   tariff_type(0) = interval;
   tariff_type(1) = periodic;

   var i = 0;
   while (i < ASize(tariff_type))
     cmd = RsdCommand( sqlquery + tariff_type(i) + order_by );

     rs = RsdRecordset( cmd );

     cmd.execute;

     if ( rs.moveNext ) 
        return  rs.value("T_TARIFFVALUE");
     end;

     i = i + 1;
   end;

   return 0;
end;

/* Принцип органиции работы с пользовательскими шагами:
   давать одинаковый пользовательский номер шага операции для разных типов договора. 
   Эта процедура вернет системный номер шага операции  для типа договора, который уже 
   нужно будет использовать в макросах операций */
macro GetSystemStepFromUserNum (Тип_договора, Номер_операции, Пользовательский_номер_шага)
   var cmd, rs, sqlquery;
   var RetVal=-1;

   sqlquery="select t_stepnumber from dds_opstp_dbt where t_contrtypeid="+Тип_договора+
            " and t_opnumber="+Номер_операции+" and t_stepnumberinpanel= "+Пользовательский_номер_шага;
           
   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if (rs.movenext)
     RetVal=rs.value ("t_stepnumber");
   end;

   Return RetVal;
end;

/* Получить Фамилию, Имя, Отчество клиента */
macro Get_F_I_O_client (code)

  var Ret_Val=False;
  var FCL = TClientList;
  if (FCL.GetRecord (code))
       SetParm (1,FCL.CurRec.rec.Name1);
       SetParm (2,FCL.CurRec.rec.Name2);
       SetParm (3,FCL.CurRec.rec.Name3);
       Ret_val=True; 
  end;

  return Ret_val;

end;

/* Возвращает число, месяц, год из строки типа 'dd.mm.yyyy' */
macro DateSplit_str (date_c,dd,mm,yy)

     dd=int (substr (date_c,1,2));
     mm=int (substr (date_c,4,2));
     yy=int (substr (date_c,7));

     SetParm (1,dd);
     SetParm (2,mm);
     SetParm (3,yy);

end;

macro Задать_формат_даты (date_value)

    var dd,mm,yy;

    DateSplit (date_value,dd,mm,yy);
    return string (dd:2:o)+"."+string(mm:2:o)+"."+string(yy);

end;

macro Название_месяца (number)

    array month;

    month(1)="января";
    month(2)="февраля";
    month(3)="марта";
    month(4)="апреля";
    month(5)="мая";
    month(6)="июня";
    month(7)="июля";
    month(8)="августа";
    month(9)="сентября";
    month(10)="октября";
    month(11)="ноября";
    month(12)="декабря";

    if ((number>0) and (number<13))
        return month(number);
    else  
        return "";
    end;

end;

/* Получаем дату в формате V_DTTM */
/* Возвращаем день, месяц (наименованием), год */
macro Дата_для_шаблонов (date_value,dd,mm,yy)

  var dd_, mm_, date_;

  dttmsplit (date_value,date_);
  if (date_==null)
     date_=date (0,0,0);
  end;

  DateSplit_str (Задать_формат_даты (date_),dd_,mm_,yy);

  mm=Название_месяца (mm_);

  if (dd_<10)
    dd="0"+dd_;
  else
    dd=dd_;
  end;

  SetParm (1,dd);
  SetParm (2,mm);
  SetParm (3,yy);

end;

/* Возвращаем true если клиент является доверителем
   в группе арендаторов и возвращаем наименование доверенного лица и его код
*/
macro Клиент_является_доверителем (branch, contractid, groupnumber, cod_doveritel, doveren_name, doveren_code)

   var cmd, rs, sqlquery;
   var RetVal1=false, RetVal2="", RetVal3=0;

   sqlquery="select t_name, t_partyid from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
            " and c.t_contractid="+contractid+
            " and c.t_groupnumber="+groupnumber+
            " and c.t_proxyof ="+cod_doveritel+
            " and p.t_partyid=c.t_clientcode";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if (rs.movenext) /* клиент выступает в роли доверителя */
     RetVal1=True;
     RetVal2=rs.value ("t_name");
     RetVal3=rs.value ("t_partyid");
   end;

   SetParm (4,RetVal2);
   SetParm (5,RetVal3);

   return RetVal1;

end;


/* Возвращаем true если клиент является доверенным лицом (или поверенным)
   и возвращаем наименование доверителя и его код
*/
macro Клиент_является_доверенным (branch, contractid, check_clnt_code, doveritel_name, doveritel_code)

   var cmd, rs, sqlquery;
   var RetVal1=false, RetVal2="", RetVal3=0;

   sqlquery="select t_name, t_partyid from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
            " and c.t_contractid="+contractid+
            " and c.t_clientcode="+check_clnt_code+" and c.t_attributes in ('П','Д')"
            " and c.t_proxyof > 0"+
            " and p.t_partyid=c.t_proxyof";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if (rs.movenext) /* клиент выступает в роли доверителя */
     RetVal1=True;
     RetVal2=rs.value ("t_name");
     RetVal3=rs.value ("t_partyid");
   end;

   SetParm (3,RetVal2);
   SetParm (4,RetVal3);

   return RetVal1;

end;


/*
   Если по договору есть доверенное лицо, то доверителя в акт не включаем
*/
macro Клиенты_по_договору (branch, contractid, groupnumber, FIO_, DOVER_, CODE_MAIN, CODE_DOVER) 

   var cmd, rs, sqlquery;
   var RetVal1="", RetVal2="", Clnt_temp="", i=0;
   array FIO__, DOVER__, CODE_MAIN__, CODE_DOVER__;

   asize (FIO__,4);
   asize (DOVER__,4);
   asize (CODE_MAIN__,4);
   asize (CODE_DOVER__,4);

   FIO__(0)   =""; FIO__(1)=   ""; FIO__ (2)  ="";  FIO__ (3)="";
   DOVER__ (0)=""; DOVER__ (1)=""; DOVER__ (2)="";  DOVER__ (3)="";

   CODE_MAIN__ (0) =0; CODE_MAIN__  (1)=0; CODE_MAIN__  (2)=0; CODE_MAIN__  (3)=0;
   CODE_DOVER__ (0)=0; CODE_DOVER__ (1)=0; CODE_DOVER__ (2)=0; CODE_DOVER__ (3)=0;


   sqlquery="select * from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
            " and c.t_contractid="+contractid+
            " and c.t_clientcode=p.t_partyid ";


   if (groupnumber>0)
      sqlquery=sqlquery+" and c.t_groupnumber = "+groupnumber;
   end;

   sqlquery=sqlquery+" order by c.t_groupnumber asc, c.t_proxyof asc";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   while (rs.movenext and (i<4))
      if (rs.value ("t_proxyof")<0) /* ссылочные записи не обрабатываем */
         Clnt_temp=rs.value ("t_clientcode");
         if (Клиент_является_доверителем (branch, 
                                          contractid, 
                                          rs.value ("t_groupnumber"), 
                                          Clnt_temp, 
                                          DOVER__ (i)))
            FIO__(i)      = rs.value ("t_name");
            CODE_MAIN__ (i) = rs.value ("t_clientcode");
            CODE_DOVER__(i) = Clnt_temp;
         else  /* обрабатываем отдельно, т.к. логика этой процедуры вероятно изменится */
            FIO__(i)        = rs.value ("t_name");
            DOVER__ (i)     = "";
            CODE_MAIN__(i)  = rs.value ("t_clientcode");
            CODE_DOVER__(i) = 0;
         end;
         i=i+1;
      end;
   end;

   SetParm (3, FIO__);
   SetParm (4, DOVER__);
   SetParm (5, CODE_MAIN__);
   SetParm (6, CODE_DOVER__);

end;

/* формирует список ячеек по контракту 
   возвращает RsdRecordset
*/

macro Список_ячеек_по_контракту( Branch, ContractID )

   var cmd, sqlquery;

   sqlquery=
    " select * from dds_cell_dbt ds_cell, ddscn_cel_dbt dscn_cel "
    " where dscn_cel.t_Branch = " + Branch + 
    " AND dscn_cel.t_ContractID = " + ContractID +
    " AND ds_cell.t_Branch=dscn_cel.t_Branch AND ds_cell.t_SafeID=dscn_cel.t_SafeID AND "
    " ds_cell.t_CellNumber=dscn_cel.t_CellNumber";

   cmd = RsdCommand( sqlquery );
   cmd.execute();
   return RsdRecordset( cmd );
   
end;

/* формирует список ячеек через запятую по контракту 
   по объекту RslTContract
   возвращает строку
*/
macro Список_ячеек_по_контракту_стр( contract )
  var cells = contract.CellList;
  var hasNext = false;
  var cells_str = "";

  hasNext = cells.first();
  
  while( hasNext )
    cells_str = cells_str + string( cells.item.rec.CellNumber );
    hasNext = cells.next();
    if( hasNext )
      cells_str = cells_str + ",";
    end;
  end;
  
  return cells_str;
end;

/* формирует список ячеек через запятую по контракту 
   по данным из базы
   возвращает строку
*/
macro Список_ячеек_по_контракту_стр2( Branch, ContractID )
  var cells;
  var hasNext = false;
  var cells_str = "";

  cells = Список_ячеек_по_контракту( Branch, ContractID );
  hasNext = cells.movenext();
  
  while( hasNext )
    cells_str = cells_str + string( cells.value( "t_CellNumber" ) );
    hasNext = cells.movenext();
    if( hasNext )
      cells_str = cells_str + ",";
    end;
  end;
  
  return cells_str;
end;

/***********************************************************************
   Получить SQL-представление даты

   _date - дата, котороую необходимо преобразовать

   Возвращаемое значение: (STRING) SQL-представление даты 
***********************************************************************/
MACRO rtGetSQLDate( _date )
    if ( _date!=date(0,0,0) )
        return string( "TO_DATE( '",_date,"', 'DD.MM.YYYY' )" );
    else
        return "TO_DATE('01-01-0001', 'DD-MM-YYYY')";
    end;
end;

/* Получаем числовой код валюты */
macro  GetCurrNumericalCode( Code_Currency )

  file Currency ( "currency.dbt", "sbbank.def" );

  if( ValType(Code_Currency) == V_UNDEF )
    return "";
  end;

  ClearRecord( Currency );
  Currency.Code_Currency = Code_Currency;

  if( GetEQ( Currency ) )
    return Currency.ExternalCode;
  else
    return "";
  end;

end;

/* Возвращает сумму строкой.*/
macro doMoneyToStr_jar( Sum, CodeCurrency )
    var  ext_code;

    ext_code = int( GetCurrNumericalCode( CodeCurrency ) );
    return CurToStrAlt( Sum, null, null, ext_code );
end;

macro Сформировать_строку_телефонов (PH1, PH2, PH3);

  var phone_str ="";

     if (codefor(PH1)>=32) 
        phone_str = PH1;
     end;

     if (codefor(PH2)>=32)
       if (phone_str)
         phone_str=phone_str+", "+PH2; 
       else
         phone_str = PH2; 
       end;
     end;

     if (codefor(PH3)>=32)
       if (phone_str)
         phone_str=phone_str+", факс: "+PH3;
       else
         phone_str = " факс: "+PH3; 
       end;
     end;

  return phone_str;


end;

// =====================================================
//               Средства связи субъекта.
// =====================================================
private macro get_Bank_Contact( _id, _type, _kind )
  var cmd, rs;
  var vCont = "";
  cmd = RsdCommand( "select T_VALUE as rCont "
                    "from DCONTACT_DBT "
                    "where T_PARTYID = ? and T_ADDRESSTYPE = ? and T_CONTACTKIND = ?" );
  rs = RsdRecordset( cmd );
  cmd.addParam( "aCode", RSDBP_IN, _id );
  cmd.addParam( "aType", RSDBP_IN, _type );
  cmd.addParam( "aKind", RSDBP_IN, _kind );
  cmd.execute;
  if ( rs.moveNext() )
    vCont = rs.value( "rCont" );
  end;
  return vCont;
end;


/* Получаем  адрес и телефон юр. лица */
macro Получить_адресные_данные_ЮЛ (code, type, Adress,Phone_number)

   var phone_str="";

   var phone1 = get_Bank_Contact( code, type, 1 );
   var phone2 = get_Bank_Contact( code, 2, 1 );
   var fax    = get_Bank_Contact( code, type, 3 );
 
   phone_str = Сформировать_строку_телефонов( phone1, phone2, fax );

end;

macro Получить_название_города( PartyID )

   var cmd, rs, sqlquery;
   sqlquery="select * from dadress_dbt where t_partyid = " + PartyID +
            " and t_type = 1";

   cmd = RsdCommand( sqlquery );
   rs = RsdRecordset( cmd );
   cmd.execute;

   if ( rs.moveNext ) 
      return rs.Value("T_PLACE");
   end;

   return "";
end;

macro Получить_название_города_из_реестра()

   var RegPath = "RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\ПАРАМЕТРЫ_ДОГОВОРОВ\\НАЗВ_ГОРОДА";
   var ret_val;
   
   ret_val = GetRegVal( trim(RegPath) );
   
   if( Valtype(ret_val) == V_UNDEF)
     ret_val="";
   end;
   
   return ret_val;
end;

/* Получить юридический адрес физ. лица */
macro Получить_юр_адрес_клиента( code )
  var FCL = TClientList;
  if (FCL.GetRecord (code))
    FCL.CurRec.AdressType=1; /* юридический (адрес постоянной регистрации) */
 /*   return FCL.CurRec.MakeFullStrAddress ();*/
    return FCL.CurRec.rec.Address;
  else
    return "";
  end;
end;

macro Получить_наименование_клиента_физ_лица (Код_клиента)

   var RetVal="";

   var Клиент = TClientList;

   if (Клиент.GetRecord (Код_клиента))
     RetVal=Клиент.currec.rec.Name1+" "+Клиент.currec.rec.Name2+" "+Клиент.currec.rec.Name3;
   end;

   return RetVal;

end;

macro Найти_документ_операции( Branch, ContractID, opNumber, stepNumber, action )

  var cmd, rs, sqlquery;
  var rentDoc = TRecHandler("ds_docum");

  if( (Branch == null) or (Branch == 0) or (ContractID == null) or (ContractID == 0) )
    return null;
  end;
  
  sqlquery = " select * from dds_docum_dbt where t_branch = ? and t_ContractID = ? and t_action = 0 ";

  if ( opNumber != null )
      sqlquery = sqlquery + " and t_opnumber = ?";
  end;
  
  if ( stepNumber != null )
      sqlquery = sqlquery + " and t_stepnumber = ?";
  end;
  
  if ( action != null )
      sqlquery = sqlquery + " and t_Action = ? ";
  end;

  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );
  
  if ( opNumber != null )
  cmd.addParam("OpNumber",    RSDBP_IN, opNumber );
  end;

  if ( stepNumber != null )
  cmd.addParam("StepNumber",  RSDBP_IN, stepNumber );
  end;
  
  if ( action != null )
      cmd.addParam("action",  RSDBP_IN, action );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  if ( rs.moveNext ) 
     rtCopyRSetToFBuff( rentDoc, rs );
     return rentDoc;
  end;
  
  return null;
  
end;

macro Найти_документ_по_ячейке( Branch, ContractID, opNumber, stepNumber, SafeID, CellNumber, ParentOp )

  var cmd, rs, sqlquery;
  var rentDoc = TRecHandler("ds_docum");

  if( (Branch == null) or (Branch == 0) or (ContractID == null) or (ContractID == 0) )
    return null;
  end;

  sqlquery = " select * from dds_docum_dbt where t_branch = ? and t_ContractID = ? and t_action = 0 ";

  if ( opNumber != null )
      sqlquery = sqlquery + " and t_opnumber = ? ";
  end;
  
  if ( stepNumber != null )
      sqlquery = sqlquery + " and t_stepnumber = ? ";
  end;

  if( SafeID != null ) 
      sqlquery = sqlquery + " and t_OpSafeID = ? ";
  end;
  
  if( CellNumber != null )
      sqlquery = sqlquery + " and t_OpCellNumber = ? ";
  end;

  if( ParentOp != null )             
      sqlquery = sqlquery + " and t_ParentOpNumber = ? ";
  end;
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );
  
  if ( opNumber != null )
  cmd.addParam("OpNumber",    RSDBP_IN, opNumber );
  end;

  if ( stepNumber != null )
  cmd.addParam("StepNumber",  RSDBP_IN, stepNumber );
  end;
  
  if( SafeID != null ) 
      cmd.addParam("OpSafeID",    RSDBP_IN, SafeID );
  end;
  
  if( CellNumber != null )
      cmd.addParam("OpCellNumber",RSDBP_IN, CellNumber );
  end;

  if( ParentOp != null )
      cmd.addParam("ParentOp",    RSDBP_IN, ParentOp );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  if ( rs.moveNext ) 
     rtCopyRSetToFBuff( rentDoc, rs );
     return rentDoc;
  end;
  
  return null;
  
end;

/*************************************************************************************/
macro Выбрать_документы_по_ячейке( Branch, ContractID, opNumber, stepNumber, SafeID, CellNumber, ParentOp )

  var cmd, rs, sqlquery;

  if( (Branch == null) or (Branch == 0) or (ContractID == null) or (ContractID == 0) )
    return null;
  end;
  
  sqlquery = " select * from dds_docum_dbt where t_branch = ? and t_ContractID = ? ";

  if ( opNumber != null )
      sqlquery = sqlquery + " and t_opnumber = ? ";
  end;

  if ( stepNumber != null )
      sqlquery = sqlquery + " and t_stepnumber = ? ";
  end;

  if( (SafeID != null ) and (CellNumber != null) )             
  
      sqlquery = sqlquery + " and t_OpSafeID = ? and t_OpCellNumber = ? ";
  end;

  if( ParentOp != null )             
  
      sqlquery = sqlquery + " and t_ParentOpNumber = ? ";
  end;

  sqlquery = sqlquery + " order by t_docnumber ";
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );

  if ( opNumber != null )
      cmd.addParam("OpNumber",    RSDBP_IN, opNumber );
  end;

  if ( stepNumber != null )
      cmd.addParam("StepNumber",  RSDBP_IN, stepNumber );
  end;
  
  if( (SafeID != null ) and (CellNumber != null) )             
  
      cmd.addParam("OpSafeID",    RSDBP_IN, SafeID );
      cmd.addParam("OpCellNumber",RSDBP_IN, CellNumber );
  end;

  if( ParentOp != null)             
  
      cmd.addParam("ParentOp",    RSDBP_IN, ParentOp );
  end;

  rs = RsdRecordset( cmd );
  cmd.execute();
  
  return rs;
  
end;

/*************************************************************************************/
/* возвращает рекордсет 
   можно не указывать номера сейфа и ячеек
*/
macro Выбрать_записи_графика_оплаты ( Branch, ContractID, SafeID, CellNumber, AgrID )

  var cmd, rs, sqlquery;
  var doc = TRecHandler("ds_paygr");
  var hasSafe = false;
  var hasCell = false;
  
  sqlquery = " select * from dds_paygr_dbt where t_branch = ? and t_ContractID = ? ";

  if( AgrID != null )             
      sqlquery = sqlquery + " and T_ADDAGRMNTID = ? ";
  end;

  if( SafeID != null )             
      hasSafe = true;
  end;
  
  if( CellNumber != null )             
      hasCell = true;
  end;

  if( hasSafe )
      sqlquery = sqlquery + " and T_SafeID = ? ";
  end;
  
  if( hasCell )
      sqlquery = sqlquery + " and T_CellNumber = ? ";  
  end;

  sqlquery = sqlquery + " order by t_enddate ";
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );

  if( AgrID != null )             
  cmd.addParam("ADDAGRMNTID", RSDBP_IN, AgrID );
  end;
  
  if( hasSafe )
    cmd.addParam("SafeID",    RSDBP_IN, SafeID );
  end;
  
  if( hasCell )
    cmd.addParam("CellNumber",RSDBP_IN, CellNumber );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  return rs;
end;

/*************************************************************************************/

macro Найти_документ_графика_оплаты( Branch, ContractID, opNumber, stepNumber, SafeID, CellNumber )

  var cmd, rs, sqlquery;
  var rentDoc = TRecHandler("ds_docum");

  sqlquery = " select * from dds_docum_dbt where t_branch = ? and t_ContractID = ? ";

  if ( opNumber != null )
      sqlquery = sqlquery + " and t_opnumber = ? ";
  end;

  if ( stepNumber != null )
      sqlquery = sqlquery + " and t_stepnumber = ? ";
  end;
  
  if( (SafeID != null ) and (CellNumber != null) )             
  
      sqlquery = sqlquery + " and t_OpSafeID = ? and t_OpCellNumber = ? ";
  end;
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );
  
  if ( opNumber != null )
  cmd.addParam("OpNumber",    RSDBP_IN, opNumber );
  end;

  if ( stepNumber != null )
  cmd.addParam("StepNumber",  RSDBP_IN, stepNumber );
  end;
  
  if( (SafeID != null ) and (CellNumber != null) )             
  
      cmd.addParam("OpSafeID",    RSDBP_IN, SafeID );
      cmd.addParam("OpCellNumber",RSDBP_IN, CellNumber );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  if ( rs.moveNext ) 
     rtCopyRSetToFBuff( rentDoc, rs );
     return rentDoc;
  end;
  
  return null;
  
end;

macro Выбрать_доп_cоглашения( Branch, ContractID )

  var cmd, rs, sqlquery;
  
  sqlquery = " select * from ddsagrmnt_dbt " +
             " where t_Branch=? AND t_ContractID=? AND t_Action=? " +
             " AND (t_Type_OpNumber=? OR t_Type_OpNumber=?) order by t_Date DESC ";
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );
  cmd.addParam("Action",      RSDBP_IN, 0 );
  cmd.addParam("OpNumber1",   RSDBP_IN, 3 );
  cmd.addParam("OpNumber2",   RSDBP_IN, 4 );  
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  return rs;

end;

macro Выбрать_доп_cогл_по_опер( Branch, ContractID, opNumber, SafeID, CellNumber )

  var cmd, rs, sqlquery;
  
  sqlquery = " select * from ddsagrmnt_dbt " +
             " where t_Branch=? AND t_ContractID=? AND t_Action=? ";

  if( opNumber != null )
      sqlquery = sqlquery + " AND t_Type_OpNumber=? ";
  end;
  
  if( (SafeID != null) and (CellNumber != null) )
      sqlquery = sqlquery + " AND t_newsafeid=? and t_newcellnumber=? ";
  end;

  sqlquery = sqlquery + " order by t_Date DESC ";
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, Branch );
  cmd.addParam("ContractID",  RSDBP_IN, ContractID );
  cmd.addParam("Action",      RSDBP_IN, 0 );
  
  if( opNumber != null )
      cmd.addParam("OpNumber",   RSDBP_IN, opNumber );
  end;

  if( (SafeID != null) and (CellNumber != null) )
      cmd.addParam("SafeID",       RSDBP_IN, SafeID );
      cmd.addParam("CellNumber",   RSDBP_IN, CellNumber );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  return rs;
end;


macro Найти_доп_cоглашение( AppKind, AppKey )

  var cmd, rs, sqlquery;
  
  sqlquery = " select * from ddsagrmnt_dbt " +
             " where t_ApplicationKind=? AND t_ApplicationKey=? ";
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("ApplicationKind", RSDBP_IN, AppKind );
  cmd.addParam("ApplicationKey",  RSDBP_IN, AppKey );

  rs = RsdRecordset( cmd );
  cmd.execute();

  if ( not rs.moveNext() )
     return NULL;
  end;
  
  return rs;

end;

macro  Код_ресурса_ключ_от_сейфовой_ячейки (typevalue, codintvalue, type, field_name)

   var cmd, rs, sqlquery;
   var RetVal=-1;

   if (not field_name)
     field_name = "t_refvalue";
   end;

   sqlquery="select " + field_name + " from dsb_casvl_dbt where t_typevalue="+typevalue+
            " and t_codintvalue="+codintvalue+
            " and t_type="+type;
           
   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if (rs.movenext)
     RetVal = rs.value(field_name);
   end;

   Return RetVal;

end;

macro GetLastDatePayPeriod(ContractBranch, ContractID)
  var query, cmd, Rs;
  var ResultDate = date (0,0,0);
  query = " select MAX(doc.T_PAYENDDATE) AS MaxDate from dds_docum_dbt doc " +
      " where doc.T_PARENTOPNUMBER IN (1,3,4,7,9) " +  
      " AND doc.T_OPNUMBER = 19 " + 
      " AND doc.T_STEPNUMBER IN (3,4) "+
      " AND doc.T_ACTION = 0 "+
      " AND doc.T_CONTRACTID = " + String(ContractID)+
      " AND doc.T_BRANCH = " + String(ContractBranch);
               
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  if( Rs.moveNext() )
    ResultDate = rtSQL_ConvTypeDate( Rs.value("MaxDate") );
    if (ValType (ResultDate) == V_UNDEF)
      ResultDate = date (0,0,0);
    end;
  end;

  if (ResultDate == date(0, 0, 0))
    query = 
        " SELECT MAX(doc.t_PayEndDate) AS MaxDate FROM dds_docum_dbt doc " +
        " WHERE doc.T_PARENTOPNUMBER <> 19 " +  
        "   AND doc.T_OPNUMBER <> 19 " + 
        "   AND doc.T_ACTION = 0 "+
        "   AND doc.T_CONTRACTID = " + String(ContractID)+
        "   AND doc.T_BRANCH = " + String(ContractBranch);

    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset(cmd);
    if (Rs.moveNext())
      ResultDate = rtSQL_ConvTypeDate( Rs.value("MaxDate") );
      if (ValType (ResultDate) == V_UNDEF)
        ResultDate = date (0,0,0);
      end;
    end;
  end;

  return ResultDate;
end;

macro DidWorkOperation(contr, OpNumber)
  var cmd, rs, sqlquery;
  var RetVal=false;

  sqlquery=" select * from dds_docum_dbt doc" +
       " where doc.T_BRANCH = " + String(contr.rec.Branch) +
           " AND doc.T_OPNUMBER = " + String(OpNumber) +
           " AND doc.T_CONTRACTID = " + String(contr.rec.ContractID);
         
  cmd = RsdCommand( sqlquery );

  rs = RsdRecordset( cmd );

  cmd.execute;

  if (rs.movenext)
    RetVal = true;
  end;

  Return RetVal;
end;

//**********************************************************************

macro ПроверитьАрендованЛиЮЛ_Резервированием( docBunch )
  var rentLegal = false;

  if( docBunch.first() )
      if( docBunch.item.rec.isCellReserved != "" )
        rentLegal = true;
      end;
  end;
  
  return rentLegal;
end;

macro СформироватьФИО( code )

  var clnt = TClientList;
  
  if (clnt.GetRecord( code ))   
    return clnt.CurRec.ConvertFIO();
  end;
  
  return "";
end;

macro СформироватьФИО_операциониста( code )

  file pers(person,"bank.def") key 0;

  pers.Oper = code;
  if( GetEQ(pers) )
    return pers.Name;
  else
    return "";
  end;
  
  return "";
end;

macro Найти_документ_по_свзке( akind, akey, refValue, akind2, akey2 )
end;
macro Найти_кассовый_док_на_расход_ключа( docBunch )

  var cmd, rs, sqlquery;
  var doc = TRecHandler("sb_casdc");
  var keyValRef = Код_ресурса_ключ_от_сейфовой_ячейки (TYPERES_KEY, VALFORM_KEY, 0);
  
  if( docBunch.first() )
  
      sqlquery = 
          " SELECT cd.* " 
        + " FROM   dsb_casdc_dbt cd, dsb_casln_dbt l1, dsb_casln_dbt l2 "
        + " WHERE l1.t_applicationkind2 = ? "
        + " AND l1.t_applicationkey2 = ? "
        + " AND l1.t_applicationkind1 = l2.t_applicationkind1 "
        + " AND l1.t_applicationkey1 = l2.t_applicationkey1 "
        + " AND l1.t_refvalue2 = 0 "
        + " AND l2.t_refvalue2 = ? "
        + " AND l2.t_applicationkind2 = cd.t_applicationkind "
        + " AND l2.t_applicationkey2 = cd.t_applicationkey";
      
      cmd = RsdCommand( sqlquery );
      
      cmd.addParam("akind",   RSDBP_IN, docBunch.item.rec.applicationkind );
      cmd.addParam("akey",    RSDBP_IN, docBunch.item.rec.applicationkey );
      cmd.addParam("refval",  RSDBP_IN, keyValRef );
      
      rs = RsdRecordset( cmd );
      cmd.execute();
      
      if ( rs.moveNext ) 
         rtCopyRSetToFBuff( doc, rs );
         return doc;
      end;
      
  end;
  
  return null;
  
end;

macro Выбрать_клиентов_по_операции( branch, contractid, docnumber, groupnum )

  var cmd, rs, sqlquery;
  
  sqlquery = 
      " select concl.* from dds_doccl_dbt doccl left join dds_concl_dbt concl "
    + " on  doccl.t_branch      = concl.t_branch "
    + " and doccl.t_contractid  = concl.t_contractid "
    + " and doccl.T_CLIENTCODE  = concl.T_CLIENTCODE "
    + " and doccl.T_GROUPNUMBER = concl.T_GROUPNUMBER "
    + " where concl.t_branch = ? "
    + " and concl.t_contractid = ? "
    + " and doccl.T_DOCNUMBER = ? ";
     
  if( groupnum != null )   
    sqlquery =   sqlquery + " and doccl.T_GroupNumber = ? ";
  end;
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, branch );
  cmd.addParam("ContractID",  RSDBP_IN, contractid );
  cmd.addParam("DocNumber",   RSDBP_IN, docnumber );

  
  if( groupnum != null )   
    cmd.addParam("GroupNumber",   RSDBP_IN, groupnum );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  return rs;

end;

macro Количество_клиентов_по_операции( branch, contractid, docnumber, groupnum )

  var cmd, rs, sqlquery;
  
  sqlquery = 
     " select count(*) as cnt from dds_doccl_dbt cl "
     " where cl.T_BRANCH = ? "
     " and cl.T_CONTRACTID = ? "
     " and cl.T_DOCNUMBER = ? ";
     
  if( groupnum != null )   
    sqlquery =   sqlquery + " and cl.T_GroupNumber = ?";
  end;
  
  cmd = RsdCommand( sqlquery );
  
  cmd.addParam("Branch",      RSDBP_IN, branch );
  cmd.addParam("ContractID",  RSDBP_IN, contractid );
  cmd.addParam("DocNumber",   RSDBP_IN, docnumber );

  
  if( groupnum != null )   
    cmd.addParam("GroupNumber",   RSDBP_IN, groupnum );
  end;
  
  rs = RsdRecordset( cmd );
  cmd.execute();
  
  if( rs.moveNext )
    return rs.value("cnt");  
  end;
  
  return 0;

end;

macro Найти_клиента_с_атрабутом( rsOpClients, attr )

  var hasNext = false;
  var clFound = false;
  var clinetRec = TRecHandler("ds_concl");
  
  hasNext = rsOpClients.moveNext();
  
  while( hasNext and (not clFound) )
    if( index( rsOpClients.value("t_Attributes"), attr) != 0 )
      clFound = true;
    end;
    if( not clFound )
      hasNext = rsOpClients.moveNext();  
    end;
  end;

  if( clFound )
    rtCopyRSetToFBuff( clinetRec, rsOpClients );
    return clinetRec;
  end;

  return null;
end;

macro Найти_клиента_по_операции( bunch )
  var contr = bunch.contract;
  var rs = null;
  var clntRec = null;
  if( bunch.bunch.first() )
      if( Количество_клиентов_по_операции( contr.rec.branch, contr.rec.contractid, 
            bunch.bunch.item.rec.docnumber) > 0
        )
          rs = Выбрать_клиентов_по_операции(  contr.rec.branch, contr.rec.contractid, 
                  bunch.bunch.item.rec.docnumber );
          if( rs != null)
            clntRec = Найти_клиента_с_атрабутом( rs, "Г" );

            // если не нашли главного берём первого
            if( clntRec == null )
                rs = Выбрать_клиентов_по_операции(  contr.rec.branch, contr.rec.contractid, 
                                bunch.bunch.item.rec.docnumber );
                rs.moveNext;
                return rs.value("t_clientcode");
            end;
            
            // если нашли главного
            return clntRec.rec.ClientCode;
          end;
      else
          // если клиент только один
          return bunch.bunch.item.rec.ClientCode;
      end;
  end;

  return 0;
end;

macro getMYearStr( dd )
  return SubStr( string(dd), Index(string(dd), "." )+1 );
end;

macro Наименование_шкафа (Подразделение, Номер_шкафа)

   var cmd, rs, sqlquery;
   var RetVal="";

   sqlquery="select t_safenumber from dds_safe_dbt where t_branch="+Подразделение+" and t_safeid="+Номер_шкафа;

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 
      RetVal = rs.value("t_safenumber");
   end;

   return RetVal;

end;

/* Возвращает true если в группе по договору есть юридическое лицо (или ПБОЮЛ) */
macro Есть_юр_лицо (branch, contractid, groupnumber) 

   var cmd, rs, sqlquery;

   /* Юр. лицо или ПБОЮЛ */
   sqlquery="select t_clientcode from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
            " and c.t_contractid="+contractid+" and c.t_proxyof=-1 and c.t_clientcode=p.t_partyid "+
            " and (p.t_legalform = 1 or 'X' = (SELECT cc.t_isemployer FROM dpersn_dbt cc WHERE cc.t_personid = p.t_partyid)) "+
            " and c.t_groupnumber="+groupnumber;

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   return rs.movenext;

end;

/* Возвращает true если по договору есть физ.лицо (не поверенный) */
macro Есть_физ_лицо (branch, contractid, groupnumber) 

   var cmd, rs, sqlquery;

   sqlquery="select t_clientcode from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
            " and c.t_contractid="+contractid+" and c.t_proxyof=-1 and c.t_clientcode=p.t_partyid "+
            " and p.t_legalform = 2 and 'X' <> (SELECT cc.t_isemployer FROM dpersn_dbt cc WHERE cc.t_personid = p.t_partyid) "+
            " and c.t_attributes<>'П' ";          

   if (groupnumber>0)
     sqlquery=sqlquery+" and c.t_groupnumber="+groupnumber;
   end;

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   return rs.movenext;

end;

/* Возвращаем массив  юр. лиц и их представителей (для акта) */
macro Наименование_клиентов_по_юр_договору (branch, contractid, groupnumber, Ur_Name, Fiz_Name, Ur_Code, Fiz_Code)

   var cmd, rs, cmd_, rs_, sqlquery, ;
   var i=0;

   /* Юр. лицо или ПБОЮЛ */
   sqlquery="select t_clientcode, t_name from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
            " and c.t_contractid="+contractid+" and c.t_proxyof=-1 and c.t_clientcode=p.t_partyid "+
            "and (p.t_legalform = 1 or 'X' = (SELECT cc.t_isemployer FROM dpersn_dbt cc WHERE cc.t_personid = p.t_partyid))";

   if (groupnumber>0)
     sqlquery=sqlquery+" and c.t_groupnumber="+groupnumber;
   end;

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   while (rs.movenext and (i<4))

     Ur_Name (i) = rs.value ("t_name");
     Ur_Code (i) = rs.value ("t_clientcode");

     sqlquery="select t_clientcode, t_name from dds_concl_dbt c, dparty_dbt p where c.t_branch="+branch+
              " and c.t_contractid="+contractid+" and c.t_proxyof="+Ur_Code (i)+
              " and c.t_attributes='П'"
              " and c.t_clientcode=p.t_partyid";

     cmd_ = RsdCommand( sqlquery );

     rs_ = RsdRecordset( cmd_ );

     cmd_.execute;

     if (rs_.movenext)
       Fiz_Name (i)=rs_.value ("t_name");
       Fiz_Code (i)=rs_.value ("t_clientcode");
     else
       Fiz_Name (i)="";
       Fiz_Code (i)=0;
     end;

     i=i+1;

   end;

   i=0;
   while (i<4)
     if (valtype(Ur_Name(i))==V_UNDEF)
        Ur_Name  (i)="";
        Ur_Code  (i)=0;
        Fiz_Name (i)="";
        Fiz_Code (i)=0;
     end;
     i=i+1;
   end;

   SetParm (3, Ur_Name);
   SetParm (4, Fiz_Name);
   SetParm (5, Ur_Code);
   SetParm (6, Fiz_Code);

end;

macro Получить_код_субъекта (partyid, code)

   var cmd, rs, sqlquery;

   sqlquery="select * from dpartcode_dbt where t_partyid="+partyid+" and t_codekind="+code;

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 
      return rs.value("T_CODE");
   else
      return "";
   end;

end;

macro Получить_наименование_субъекта (code)

   var cmd, rs, sqlquery;

   sqlquery="select * from dparty_dbt where t_partyid="+code;

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 
      return rs.value("T_NAME");
   else
      return "";
   end;

end;

macro Наименование_страны_по_LAT3 (CodeLat3)


  var cmd, rs, sqlquery;

  var RetVal="";

   sqlquery="select t_name from dcountry_dbt where t_codelat3='"+CodeLat3+"'";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 
     RetVal=rs.value ("t_name");
   end;

   return RetVal;

end;

/* Получаем набор реквизитов клиента ЮР.ЛИЦА из СПИ */
/* Возвращает из первой найденной СПИ */
/* На входе:  Код клиента и необязательный параметр в случае необходимости минимальных изменении процедуры при 
              доработке условий выборки */
macro Получить_реквизиты_клиента_из_СПИ (Код_клиента, Reserv_development, Расчетный_счет, ИНН, Корсчет, Бик_банка)

  var cmd, rs, sqlquery;

  var RetVal=false;

   sqlquery="select * from dsettacc_dbt where t_partyid="+Код_клиента+" order by t_order";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 

     RetVal = true;

     setparm (2, rs.value ("t_account"));
     setparm (3, rs.value ("t_inn"));
     setparm (4, rs.value ("t_corracc"));
     setparm (5, rs.value ("t_bankcode"));

   end;

   return RetVal;

end;

macro Получить_номер_счета (Referenc)

   var cmd, rs, sqlquery;
   var RetVal="";

   sqlquery="select t_account from ddepositr_dbt where t_referenc="+Referenc;
           
   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if (rs.movenext)
     RetVal=rs.value ("t_account");
   end;

   Return RetVal;

end;

macro Код_клиента_владельца_счета (Referenc)

   var cmd, rs, sqlquery;
   var RetVal=0;

   sqlquery="select t_codclient from ddepositr_dbt where t_referenc="+Referenc;
           
   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if (rs.movenext)
     RetVal=rs.value ("t_codclient");
   end;

   Return RetVal;
end;

macro Сформировать_строку_данных_физ_лица_для_договора  (Код_физ_лица, Acc_Referenc)

   var Клиент = TClientList,
       Наименование_клиента = "",
       Дата_выдачи          = "",
       Данные_документа     = "",
       Адрес_регистрации    = "",
       Адрес_фактический    = "",
       Дата_рождения        = "",
       Место_рождения       = "",
       Данные_клиента       = "",
       Счет_клиента         = "",
       ИНН                  = "",
       Гражданство          = "",
       Миграционные_данные  = "",
       Телефоны             = "",
       Данные_клиента_      = "",
       phone_str            = "";

       if (Клиент.GetRecord (Код_физ_лица))

         Наименование_клиента=Клиент.currec.rec.Name1+" "+Клиент.currec.rec.Name2+" "+Клиент.currec.rec.Name3;

         if (Клиент.currec.rec.paperissueddate!=date (0,0,0))
           Дата_выдачи=Клиент.currec.rec.paperissueddate;
         else
           Дата_выдачи="         ";
         end;

         Данные_документа="Данные документа, удостоверяющего личность: "+Клиент.currec.makedocstr+", "+Дата_выдачи;

         Клиент.adresstype=1;
         Адрес_регистрации="Адрес места регистрации: "+Клиент.currec.MakeFullStrAddress;
         Клиент.adresstype=2;
         Адрес_фактический="Адрес места жительства: "+Клиент.currec.MakeFullStrAddress;

         if (Клиент.currec.rec.born!=date (0,0,0))
           Дата_рождения="Дата рождения: "+Клиент.currec.rec.born;
         else
           Дата_рождения="Дата рождения: ";
         end;

         Место_рождения ="Место рождения: "+Клиент.currec.Getproperty (1);
                      
         Гражданство    ="Гражданство: "   +Наименование_страны_по_LAT3 (Клиент.currec.rec.nrcountry);
 
         ИНН            ="ИНН: "+ Клиент.currec.rec.inn;

         var phone1 = get_Bank_Contact( Код_физ_лица, 1, 1 );
         var phone2 = get_Bank_Contact( Код_физ_лица, 2, 1 );
         var fax    = get_Bank_Contact( Код_физ_лица, 1, 3 );
       
         phone_str = Сформировать_строку_телефонов( phone1, phone2, fax );

         Телефоны       ="Телефон: " + Сформировать_строку_телефонов( phone1, phone2, fax );

         Данные_клиента_ = Наименование_клиента+"\n"+
                           Дата_рождения+       "\n"+
                           Место_рождения+      "\n"+
                           Гражданство+         "\n"+
                           Данные_документа+    "\n"+
                           Адрес_регистрации+   "\n"+
                           Адрес_фактический+   "\n"+
                           ИНН              +   "\n"+
                           Телефоны                  ;

         if (Acc_Referenc)
             Счет_клиента  ="Счет Клиента: "+Получить_номер_счета (Acc_Referenc);
             Данные_клиента_=Данные_клиента_+"\n"+Счет_клиента;
         end;  

       end;

       return Данные_клиента_;

end;

/* Формируем строку требуемого формата */
macro Сформировать_строку_данных_юр_лица_для_договора (Код_юр_лица)

      var Наименование_клиента = "",
          Расчетный_счет       = "",
          ИНН                  = "",
          Корсчет              = "",
          Бик_банка            = "",
          ОГРН                 = "",
          Адрес_юрлица         = "",
          Адрес_юрлица_        = "",
          Телефон_юрлица       = "",
          Данные_клиента       = "";


          Получить_адресные_данные_ЮЛ (Код_юр_лица, ЮРИДИЧЕСКИЙ, Адрес_юрлица, Телефон_юрлица);

          Адрес_юрлица = "Юридический адрес: "+Адрес_юрлица+"\n"+"Почтовый адрес: ";

          Получить_адресные_данные_ЮЛ (Код_юр_лица, ПОЧТОВЫЙ, Адрес_юрлица_);

          if (Адрес_юрлица_)
            Адрес_юрлица = Адрес_юрлица+Адрес_юрлица_;
          end;

          Получить_реквизиты_клиента_из_СПИ (Код_юр_лица, null, Расчетный_счет, ИНН, Корсчет, Бик_банка);

          ОГРН = Получить_код_субъекта (Код_юр_лица, 27); 

          Наименование_клиента  = Получить_наименование_субъекта (Код_юр_лица);
              
          Данные_клиента        = Наименование_клиента+"\n"+
                                  "БИК "+Бик_банка+" к/с "+Корсчет+" р/c "+Расчетный_счет+" ОГРН "+ОГРН+"\n"+
                                  Адрес_юрлица+        "\n"+
                                  "Телефон: "+Телефон_юрлица;

          return Данные_клиента;

end;

macro Получить_счет_проводки (Код_филиала, Валюта, Наименование_Счета)

   var Валютность = 0;
   var cmd, rs, sqlquery;

   if( Валюта != 0 )
      Валютность = 1;
   end;

   sqlquery= "SELECT T_ACCOUNT FROM DSB_ACDEP_DBT WHERE T_ISCUR="+Валютность+" AND "+
             "T_FNCASH="+Код_филиала+" AND T_CODCUR="+Валюта+" AND T_SPECVARIABLE='"+Наименование_Счета+"'";

   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;
  
   if ( rs.moveNext ) 
      return rs.value("T_ACCOUNT");
   else
      return Наименование_Счета;
   end;

end;

macro Получить_код_ячейки(
       Подразделение, 
       Шкаф, 
       Тип_договора,
       Номер_ячейки, 
       Тип_периода,
       Срок_договора_основной)


   var cmd, rs, sqlquery;

   sqlquery="select * from dds_cell_dbt, dds_tarif_dbt "+
                    " where dds_cell_dbt.T_CELLTYPEID=dds_tarif_dbt.T_CELLTYPEID and "+
                    "dds_cell_dbt.T_BRANCH="+Подразделение+" and "+
                    "dds_cell_dbt.T_SAFEID="+Шкаф+" and "+
                    "dds_cell_dbt.T_CELLNUMBER="+Номер_ячейки+" and "+
                    "dds_tarif_dbt.T_CONTRTYPEID="+Тип_договора+" and "+
                    "dds_tarif_dbt.T_TERMUNIT="+Тип_периода+" and "+
                    Срок_договора_основной+" between T_TERMMINVAL and T_TERMMAXVAL "+
                    " and t_deletedate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')";


   cmd = RsdCommand( sqlquery );

   rs = RsdRecordset( cmd );

   cmd.execute;

   if ( rs.moveNext ) 
      return rs.value("T_CELLCODE");
   else
      return "";
   end;

end;

// считает количество дней аренды с учетом настройки входит ли день завершения в срок
macro CalcRentPeriodLength( begDate, endDate )
  var isLastDayIncluded = GetRegVal( "RS-RETAIL\\СЕРВИСНЫЕ\\СЕЙФОВЫЕ_ЯЧЕЙКИ\\ДАТА_ЗАВЕРШ_ВХОДИТ_В_СРОК", true );
  var petiodLangth = endDate - begDate;
  
  if( isLastDayIncluded )
    petiodLangth = petiodLangth + 1;
  end;
  
  return petiodLangth;
end;
