/*
$Name:             changecl.mac
$Module:           RS-Retail
$Description:      Сейфовые ячейки. Определение базового класса для операции смены ячейки
*/

/* Определение базового класса для операции смены ячейки */

import stforcel,classes, rsd, stprocs;
import globOp;

class (TOperationExecutor) TOperationChangeCell( opObj )

  macro inputClients()      /* Ввод клиентов, участвующих в операции */
    msgbox ("Выберите клиента для операций с получением (возвратом) ключа от ячейки");
    return accessUI( operationObj ); 
  end;

  macro runPanel()      /* Запуск панели операции */
    operationObj.newAddAgreement();
    return operationObj.panel.use();
  end;

  macro createDocuments()

    var DsDoc, depDoc, payDoc, stat = true, Клиент;
    var contr = operationObj.contract;
    var NumKeys = 0;
    var Сумма_штрафа_без_НДС = 0; 
    var Сумма_штрафа_НДС = 0;
    var Основание_штраф = "";
    var OldSafeID, OldCellNumber;
    var NewSafeID, NewCellNumber;
    var cnt = 0;
    var LastDatePayPeriod = date(0,0,0);
    var saveIsNonCash = 0;
    var saveFromAccount = 0;
    var saveCommSum = $0;
    
    /* Освобождение ячейки */
    contr.CellList.first();
    while( cnt < 2 )
      if ( contr.CellList.item.rec.isNeedCloseCell == "X" )
        OldSafeID     = contr.CellList.item.rec.SafeID;
        OldCellNumber = contr.CellList.item.rec.CellNumber;
      else
        NewSafeID     = contr.CellList.item.rec.SafeID;
        NewCellNumber = contr.CellList.item.rec.CellNumber;
      end;
      contr.CellList.next();
      cnt = cnt + 1;
    end;
    
    record Parm(CashParm);
    
      /* Замена ячейки */
      dsDoc = operationObj.newDsDoc(1);
      operationObj.AddAgreement.SetAddAgreementDoc( dsDoc );
      if(not operationObj.multipleClients)
        dsdoc.rec.ClientCode = operationObj.clientCode;
      end;

      dsdoc.rec.OldSafeID     = OldSafeID;
      dsdoc.rec.OldCellNumber = OldCellNumber;
      operationObj.AddAgreement.rec.NewSafeID     = NewSafeID;
      operationObj.AddAgreement.rec.NewCellNumber = NewCellNumber;

      dsDoc.rec.Ground = "Замена ИС";
      operationObj.docList.insert(dsDoc);

      NumKeys = GetNumOfKeys( contr.rec.branch,  NewSafeID, NewCellNumber );
      
      if( ( NumKeys > 0 ) and ({MakeDeskDocs}) )
        ClearRecord( Parm );
        Parm.TypeValue = TYPERES_KEY;
        Parm.CodIntValue = VALFORM_KEY;
        Parm.Oper = operationObj.oper;
        Parm.CashDateDoc = {curdate};
        Parm.ValueCol = NumKeys;
        Parm.OperPatern = Parm.Oper;
        Parm.Type = 0;        /* Платежеспосбные ресурсы */
        Parm.NumOper = CASHOP_DEBET;  /* Расход из банка */
        Parm.ApplicationKind = SB_SAFECELLS;
        Parm.ApplicationKey = FormApplicationKey( Parm.ApplicationKind );
         
        stat = operationObj.newCashDoc( Parm );

        StoreValue("doc:Ресурс@КодГлавного@Расход", Код_ресурса_ключ_от_сейфовой_ячейки(TYPERES_KEY, VALFORM_KEY, 0, "t_GroupValue"));
        StoreValue("doc:КоличКлючей@Расход", NumKeys + RetrieveValue("doc:КоличКлючей@Расход"));

        Dsdoc = operationObj.newDsDoc(2);
        Dsdoc.rec.ApplicationKind = Parm.ApplicationKind;
        Dsdoc.rec.ApplicationKey = Parm.ApplicationKey;
        Dsdoc.rec.OutSum = NumKeys;
        DsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
        operationObj.docList.insert(Dsdoc);
      end;

      if ( operationObj.RetKey ) /* Приход ключа */
      
        /* Возврат ключа клиентом */
        NumKeys = GetNumOfKeys(contr.rec.branch, OldSafeID, OldCellNumber );
        
        if( ( NumKeys > 0 ) and ({MakeDeskDocs}) )
          ClearRecord( Parm );
          Parm.TypeValue = TYPERES_KEY;
          Parm.CodIntValue = VALFORM_KEY;
          Parm.Oper = operationObj.oper;
          Parm.CashDateDoc = {curdate};
          Parm.ValueCol = NumKeys;
          Parm.OperPatern = Parm.Oper;
          Parm.Type = 0;        /* Платежеспосбные ресурсы */
          Parm.NumOper = CASHOP_CREDIT; /* Расход из банка */
          Parm.ApplicationKind = SB_SAFECELLS;
          Parm.ApplicationKey = FormApplicationKey( Parm.ApplicationKind );
           
          stat = operationObj.newCashDoc( Parm );

          StoreValue("doc:Ресурс@КодГлавного@Приход", Код_ресурса_ключ_от_сейфовой_ячейки(TYPERES_KEY, VALFORM_KEY, 0, "t_GroupValue"));
          StoreValue("doc:КоличКлючей@Приход", NumKeys + RetrieveValue("doc:КоличКлючей@Приход"));

          Dsdoc = operationObj.newDsDoc(3);
          Dsdoc.rec.ApplicationKind = Parm.ApplicationKind;
          Dsdoc.rec.ApplicationKey = Parm.ApplicationKey;
          Dsdoc.rec.OpSafeID = OldSafeID;
          Dsdoc.rec.OpCellNumber = OldCellNumber;
          Dsdoc.rec.InSum = NumKeys;
          DsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
          operationObj.docList.insert(Dsdoc);
        end;
      end;

      if ( operationObj.GetPenalty )

         /* Сумма штрафа */
         /* Штраф за порчу оборудования */
         dsDoc = operationObj.newDsDoc(4);
         
         Сумма_штрафа_без_НДС = double (100 * operationObj.expPnltSum /(NDS+100)); 
         Сумма_штрафа_НДС     = operationObj.expPnltSum - Сумма_штрафа_без_НДС;

         dsDoc.rec.InSum    = Сумма_штрафа_без_НДС;
         dsDoc.rec.NdsSum    = Сумма_штрафа_НДС;
         dsDoc.rec.CurrCode = operationObj.expPnltCurrCode;

         if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
           dsDoc.rec.CashFlag = "X";
           dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
         end;

         //operationObj.CommissionsSum = operationObj.CommissionsSum + dsDoc.rec.InSum;


         dsDoc.rec.ClientCode = operationObj.clientCode;
         dsDoc.rec.Ground = "Штраф за порчу имущества банка " + (dsDoc.rec.InSum + dsDoc.rec.NdsSum) +  " руб. (в т.ч. НДС " + dsDoc.rec.NdsSum + " руб.)";
         operationObj.docList.insert(dsDoc);

         StoreValue("doc:Валюта@Штраф", dsDoc.rec.CurrCode);
         StoreValue("doc:Сумма@Штраф", dsDoc.rec.InSum + RetrieveValue("doc:Сумма@Штраф"));
         StoreValue("doc:Сумма@ШтрафНДС", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@ШтрафНДС"));

         if (operationObj.expPnltIsNonCash == DSPM_CASHLESS)                  
           depDoc = operationObj.newDepDoc(dsDoc);
           operationObj.docList.insert(depDoc);
         elif (operationObj.expPnltIsNonCash == DSPM_CASH)
           payDoc = operationObj.newPayDoc(dsDoc);
           payDoc.rec.Ground = dsDoc.rec.Ground;
           payDoc.setVarPartFormat("pay_doc.ds");
           payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
           if (operationObj.isAddAgrmntInited)
             payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
           else
             payDoc.varPart.rec.AddAgrmntID = 0;
           end;
           payDoc.varPart.rec.StepNumber = 4;
           operationObj.docList.insert(payDoc);
         end;


         /* Сумма НДС */
         dsDoc = operationObj.newDsDoc(5);

         dsDoc.rec.InSum    = Сумма_штрафа_НДС;
         dsDoc.rec.CurrCode = operationObj.expPnltCurrCode;

         Основание_штраф = "НДС с суммы штрафа за порчу имущества банка ";

         if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
           dsDoc.rec.CashFlag = "X";
           dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
         end;

         //operationObj.CommissionsSum = operationObj.CommissionsSum + dsDoc.rec.InSum;
         
         dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, Основание_штраф);
         dsDoc.rec.ClientCode = operationObj.clientCode;
         operationObj.docList.insert(dsDoc);
         
         if (operationObj.expPnltIsNonCash == DSPM_CASHLESS)                  
           depDoc = operationObj.newDepDoc(dsDoc);
           operationObj.docList.insert(depDoc);
         elif (operationObj.expPnltIsNonCash == DSPM_CASH)
           payDoc = operationObj.newPayDoc(dsDoc);
           payDoc.rec.Ground = Основание_штраф;
           payDoc.setVarPartFormat("pay_doc.ds");
           payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
           if (operationObj.isAddAgrmntInited)
             payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
           else
             payDoc.varPart.rec.AddAgrmntID = 0;
           end;
           payDoc.varPart.rec.StepNumber = 4; /* Тут именно 4, а не 5 */
           operationObj.docList.insert(payDoc);
         end;

      end;

      if (operationObj.pmntSum > 0)
        LastDatePayPeriod = GetLastDatePayPeriod(contr.rec.Branch, contr.rec.ContractID);
        if ((LastDatePayPeriod < contr.rec.EndDate) and not IgnoreNestedDocs and (contr.rec.Discount != 100))
           msgbox("Не оплачена аренда до конца срока договора. Смена на ячейку большего размера невозможна");
           stat = false;
        else
          stat = operationObj.runNestedDSOperation(6);
        end;
      //elif ( operationObj.CommissionsSum>0 )
        /*saveIsNonCash    = operationObj.pmntIsNonCash;
        saveFromAccount  = operationObj.pmntFromAccount;
        saveCommSum      = operationObj.CommissionsSum;
        
        operationObj.pmntSum = operationObj.CommissionsSum;
        operationObj.CommissionsSum   = $0;
        operationObj.pmntIsNonCash    = operationObj.expPnltIsNonCash;
        operationObj.pmntFromAccount  = operationObj.expPnltFromAccount;*/

        //stat = operationObj.runNestedDSOperation(6);
        /*operationObj.pmntSum = $0;
        operationObj.pmntIsNonCash    = saveIsNonCash;
        operationObj.pmntFromAccount  = saveFromAccount;
        operationObj.CommissionsSum   = saveCommSum;*/
      end;

    return stat;
    
    OnError(e)
      operationObj.status = false;
  end;

  InitTOperationExecutor( opObj );
end;
