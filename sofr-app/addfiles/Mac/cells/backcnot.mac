/*   Откат операции - Замена нотариуса */
import stforcel, stprocs;

private var rollbackdata  = CreateRollbackDataObject();  /* Обьект, необходимый для отката */

macro TrnProc

var stat = 0;
var contr = rollbackdata.footprint.contract;
var doc;
var hasNext = false;
var newNotary = 0;
var newNotaryFound = false;
var oldNotary = 0;
var oldNotaryFound = false;
var lclnt = TBFile("ds_concl", "W", 0);


    stat = rollbackdata.footprint.bunch.first();
    if(stat)
      doc = rollbackdata.footprint.bunch.item;

    // не устанавливать!!! устанавливается в сишном коде      
    //doc.setVarPartFormat("dsdocnot.rec");

    if( stat )
      // обновляем переменную часть контракта данные по нотариусу
      contr.setVarPartFormat("dsnotary.rec");
      
      contr.varPart.rec.OrderNumber    = doc.varPart.rec.OldOrderNumber;
      contr.varPart.rec.OrderDate      = doc.varPart.rec.OldOrderDate;
      contr.varPart.rec.LicenceNumber  = doc.varPart.rec.OldLicenceNumber;
      contr.varPart.rec.LicenceDate    = doc.varPart.rec.OldLicenceDate;

      newNotary = doc.varPart.rec.NewNotaryCode;
      oldNotary = doc.varPart.rec.OldNotaryCode;

      
    /* Ищем текущего неблокированного нотариуса и удаляем*/
    lclnt.clear();
    lclnt.rec.Branch       = contr.rec.Branch;
    lclnt.rec.ContractID   = contr.rec.ContractID;
    lclnt.rec.GroupNumber  = 1;
    lclnt.rec.ClientCode   = newNotary;  
    
    newNotaryFound = lclnt.getEQ();
    if( newNotaryFound )
        stat = lclnt.delete();
        if( not stat )
          PushErrorMessage("Ошибка удаления текущего нотариуса");
        end;
    end;

    if( stat )
        /* Ищем текущего блокированного нотариуса и разблокируем его */
        lclnt.clear();
        lclnt.rec.Branch       = contr.rec.Branch;
        lclnt.rec.ContractID   = contr.rec.ContractID;
        lclnt.rec.GroupNumber  = 1;
        lclnt.rec.ClientCode   = oldNotary;  
        
        oldNotaryFound = lclnt.getEQ();
        if( oldNotaryFound )
            if( index( lclnt.rec.Attributes,"Б") != 0 )
              lclnt.rec.Attributes = DeleteAttribute(lclnt.rec.Attributes, "Б");
              lclnt.update();
            end;
        end;
    end;
    

      if( stat )
        stat = rollbackdata.footprint.contract.save();
      end;
      
      if(stat)
        stat = rollbackdata.footprint.rollback();
      end;
    end;
  end;

  if(not stat)
    AbortTrn()
  end;

end;

  if(ProcessTrn( 1, "TrnProc") )
    MsgBox("Откат операции Замена нотариуса прошел успешно");
  else
    rollbackdata.footprint.displayErrorMessage();
    MsgBox("Откат операции Замена нотариуса прошел с ошибками");
  end;

end;

