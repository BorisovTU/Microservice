/******************************************************************************\

		Макрос по расчету штрафа за просрочку:сумма за день 

			Программист: Крестьянинов Е.А.

\******************************************************************************/
import DeprIntr,CommonInter,stpencls, stprocs;

var SumForDay = 2; /* Сумма за один день просрочки */
var Bank_Standard = GetBankStandart( );  /* Стандарт работы банка */

macro GetPenalty(Contract,Tarif,Expession)
  var Sum = $0,penDays = 0;
  var tmpContract = TRecHandler("ds_contr");
  var tmpTariff;
  var status = true;
  var sumCur = 0;
  // пересчет по пользовательскому значению
  var calcByUserVal = false;
  
  if( Expession != null )
      if( Int(Expession) > 0 )
        SumForDay = Int(Expession);
        calcByUserVal = true;
      end;
  end;

  if ( Bank_Standard == 0 )
  /* Сбербанк РФ */
    penDays = КоличествоПросроченныхДней( {curdate}, Contract.rec.EndDate, false );
    
    if( calcByUserVal )
        if( penDays > 0 )
            Sum = penDays * SumForDay;
        end;
        return String( Sum ) + "|" + String( penDays );
        
    else
    /* ищем тариф за минимальный срок аренды 1 день */
    tmpContract.clear();
    tmpContract.rec.Branch = Contract.rec.Branch;
    tmpContract.rec.ContrTypeID = Tarif.rec.ContrTypeID;
    tmpContract.rec.TermType = ADSP_DAY; 
    tmpContract.rec.TermValue = 1;
    tmpContract.rec.TermTail = 0;
    status = GetTarif( tmpContract, Tarif.rec.CellTypeID, {curdate}, tmpTariff );
    if( status )
        sumCur = tmpTariff.rec.TariffCurrCode; 
        // Проверяем вид периода у найденого тарифа
        if( tmpTariff.rec.PeriodUnit != ADSP_DAY )
          msgbox("Вид периода у тарифа с заданным видом |тарифа за просрочку должен быть задан в днях");
          Sum = $0;
        else
          penDays = PenDays - Tarif.rec.PrivilegeDays;
          if( penDays > 0 )
            Sum = (Sum + penDays * tmpTariff.rec.TariffValue);
          else
            penDays = 0;
          end;
        end;
    end;
    return String( Sum ) + "|" + String( penDays )+ "|" + String( sumCur );

    end; //if( calcByUserVal )

  else
  /* Коммерческий банк */

  penDays = GetPenaltyDays( Contract );
  penDays = PenDays - Tarif.rec.PrivilegeDays;

  if( penDays > 0 )
    Sum = (Sum + penDays * SumForDay);
  else
    penDays = 0;
  end;
      return String( Sum ) + "|" + String( penDays );
  end;

end;
