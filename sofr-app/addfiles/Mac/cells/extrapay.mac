/* Операция "Дополнительная плата"  Ярмольчук */

import stforcel,classes;
import globOp;

class (TOperationExecutor) TExtraPayOperation ( opObj )

  var contr = operation.contract;

  var BegDate, EndDate, Ground; 
  var Account, Referenc, PayMethod, Client;
  var Сумма_к_Оплате, Сумма_без_НДС, Сумма_НДС;
  var КодВалюты = 0;

  macro checkOperation()
    var status = true;
    
    if( {curdate} < contr.rec.EndDate )
        PushErrorMessage("Взимание дополнительной платы возможно только| по окончании срока действия договора");
        status = false;
    end;
    
    return status;
  end;

  macro inputClients()      /* Ввод клиентов, участвующих в операции */
    msgbox ("Выберите из списка клиента-плательщика по договору.|",
            "Если оплата идет как зачисление со счета юридического лица,|",
            "то выберите представителя юридического лица."
         );
    return accessUI( operationObj );
  end;

  macro createDocuments()

    var DsDoc, depDoc, payDoc;

    BegDate        = operationObj.payPeriodBegin;
    EndDate        = operationObj.payPeriodEnd;
    Сумма_к_Оплате  = operationObj.pmntSum;
    КодВалюты       = operationObj.pmntCurrCode;
    
    Referenc  = operationObj.pmntFromAccount;
    PayMethod = operationObj.pmntIsNonCash;
    Ground    = operationObj.ground;

/*! Дополнительная плата без НДС */
    dsDoc = operationObj.newDsDoc(1); 
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;

    Сумма_без_НДС= double (100*Сумма_к_Оплате/(NDS+100));
    Сумма_НДС    = Сумма_к_Оплате-Сумма_без_НДС;

    if (Ground)
        Ground = Ground + 
        ". Сумма платы за аренду инд.сейфа " + money(Сумма_к_Оплате) + " руб. "+
        " (в том числе НДС) " + money (Сумма_НДС) + " руб.)";
    else
        Ground = "";
    end;
    
    dsDoc.rec.InSum        = Сумма_без_НДС;
    dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, Ground);
    dsDoc.rec.PayStartDate = BegDate;
    dsDoc.rec.PayEndDate   = EndDate;

    if (PayMethod==DSPM_CASHLESS) /* безналично */
       dsDoc.rec.CashFlag = "X";
    else
       dsDoc.rec.CashFlag = "";
    end;

    dsDoc.rec.CurrCode = КодВалюты;
    dsDoc.rec.NdsSum   = 0;

    dsDoc.rec.Referenc=Referenc;

    operationObj.docList.insert(dsDoc);

    StoreValue("doc:Сумма@Аренда", dsDoc.rec.InSum + RetrieveValue("doc:Сумма@Аренда"));

    if( PayMethod != DSPM_PUT )
      payDoc = operationObj.newPayDoc(dsDoc);
      payDoc.setVarPartFormat("pay_doc.ds");
      payDoc.varPart.rec.ContractID = contr.rec.ContractID;
        
      if (operationObj.isAddAgrmntInited)
        payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
      else
        payDoc.varPart.rec.AddAgrmntID = 0;
      end;
      payDoc.varPart.rec.StepNumber = 1;
      operationObj.docList.insert(payDoc);
    end;
    
/*! Дополнительная плата. Сумма НДС  */
    dsDoc = operationObj.newDsDoc(2); 
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;

    dsDoc.rec.InSum        = Сумма_НДС;
    dsDoc.rec.PayStartDate = BegDate;
    dsDoc.rec.PayEndDate   = EndDate;

    if (PayMethod==DSPM_CASHLESS) /* безналично */
       dsDoc.rec.CashFlag = "X";
    else
       dsDoc.rec.CashFlag = "";
    end;

    dsDoc.rec.CurrCode = КодВалюты;
    dsDoc.rec.NdsSum   = 0;

    dsDoc.rec.Referenc=Referenc;
    dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
    operationObj.docList.insert(dsDoc);

    StoreValue("doc:Сумма@АрендаНДС", dsDoc.rec.InSum + RetrieveValue("doc:Сумма@АрендаНДС"));

    if( PayMethod != DSPM_PUT )      
      payDoc = operationObj.newPayDoc(dsDoc);
      payDoc.setVarPartFormat("pay_doc.ds");
      payDoc.varPart.rec.ContractID = contr.rec.ContractID;
        
      if (operationObj.isAddAgrmntInited)
        payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
      else
        payDoc.varPart.rec.AddAgrmntID = 0;
      end;
      payDoc.varPart.rec.StepNumber = 1; /* Здесь именно 1, а не 2 */
      
      operationObj.docList.insert(payDoc);
    end;

    /*! Дополнительная плата. Общая сумма */
    dsDoc = operationObj.newDsDoc(3); 
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;

    dsDoc.rec.InSum        = Сумма_без_НДС+Сумма_НДС;
    dsDoc.rec.PayStartDate = BegDate;
    dsDoc.rec.PayEndDate   = EndDate;

    if (PayMethod==DSPM_CASHLESS) /* безналично */
       dsDoc.rec.CashFlag = "X";
    else
       dsDoc.rec.CashFlag = "";
    end;

    dsDoc.rec.CurrCode = КодВалюты;
    dsDoc.rec.NdsSum   = 0;

    dsDoc.rec.Referenc=Referenc;

    operationObj.docList.insert(dsDoc);

    if( PayMethod != DSPM_PUT )
      if( (PayMethod == DSPM_CASHLESS) )
        depDoc = operationObj.newDepDoc(dsDoc);
        operationObj.docList.insert(depDoc);
      else
        payDoc = operationObj.newPayDoc(dsDoc);
        operationObj.docList.insert(payDoc);
      end;
    end;

    StoreValue("doc:Валюта@Опер", dsDoc.rec.CurrCode);
    StoreValue("doc:Сумма@Опер", dsDoc.rec.InSum);

    return true;
  end;


  InitTOperationExecutor( opObj );
end;

/************************ Основная программа **********************************/
var obj = TExtraPayOperation ( operation );

  obj.runOp();

end;
