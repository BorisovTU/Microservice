/*
$Name:             retpaycl.mac
$Module:           RS-Retail
$Description:      Сейфовые ячейки. Операция "Возврат средств"
*/

/* Операция "Возврат средств" */

import stforcel, stprocs, classes, Календарь;
import globOp;
import sqlconv;

private var {curdate};

var contr = operation.contract;

const D_INSERT = 0;    // Вставка
const D_UPDATE = 1;    // Обновить
const D_DELETE = 2;    // Удалить

macro RoundAmount(amount)
  return Money(Floor(Double(amount) * 100 + 0.5) / 100);
end;

macro RetPayCarry()
  var rsPayGr = null;
  var payGrOldRec = TRecHandler("ds_paygr");
  var payGrFile = TBfile("ds_paygr", "W", 0);
  var isUpdated = false;
  var DateMultiplifer = 0.0;
  const NullDate = date(0,0,0);
  var grStartDate = date(0,0,0); 
  var grEndDate = date(0,0,0);
  var grTransferDate = date(0,0,0);
  var status = true;
  
  status = operation.carry();

  if( status )
  
      rsPayGr = Выбрать_записи_графика_оплаты ( contr.rec.Branch, contr.rec.ContractID );
      while( rsPayGr.moveNext() )

          isUpdated = true;
          
          payGrFile.rec.Branch      = rsPayGr.value("t_Branch");
          payGrFile.rec.ContractID  = rsPayGr.value("t_ContractID");
          payGrFile.rec.AddAgrmntID = rsPayGr.value("t_AddAgrmntID");
          payGrFile.rec.SafeID      = rsPayGr.value("t_SafeID");
          payGrFile.rec.CellNumber  = rsPayGr.value("t_CellNumber");
          payGrFile.rec.EndDate     = SQL_ConvTypeDate( rsPayGr.value("t_EndDate") );
          
          payGrFile.getEQ();
          copy( payGrOldRec, payGrFile );
          
          grStartDate    = payGrFile.rec.StartDate;
          grEndDate      = payGrFile.rec.EndDate;
          grTransferDate = payGrFile.rec.TransferDate;
          
          DateMultiplifer = (double({curdate} - grStartDate + 1)) 
                          / (double(grEndDate - grStartDate + 1));

          if( (payGrFile.rec.TransferDate == NullDate) and ( grEndDate < {curdate}) )
              payGrFile.rec.TransferDate = {curdate};
              payGrFile.rec.CurrentSum = payGrFile.rec.FutureSum;
              payGrFile.rec.CurrentNDSSum = payGrFile.rec.FutureNDSSum;
              payGrFile.rec.FutureSum = 0;
              payGrFile.rec.FutureNDSSum = 0;

          elif( (payGrFile.rec.TransferDate == NullDate) and (grStartDate <= {curdate} ) and (grEndDate > {curdate}) )
              payGrFile.rec.TransferDate = {curdate};
              payGrFile.rec.CurrentSum = RoundAmount(payGrFile.rec.FutureSum * DateMultiplifer);
              payGrFile.rec.CurrentNDSSum = RoundAmount(payGrFile.rec.FutureNDSSum * DateMultiplifer);
              payGrFile.rec.FutureSum = 0;
              payGrFile.rec.FutureNDSSum = 0;

          elif( (payGrFile.rec.TransferDate == NullDate) and ( grStartDate > {curdate} ) )
              payGrFile.rec.FutureNDSSum = 0;
              payGrFile.rec.FutureSum = 0;
              
          elif( (payGrFile.rec.TransferDate != NullDate) and ( grStartDate <= {curdate} ) and ( grEndDate > {curdate}) )
              payGrFile.rec.TransferDate = {curdate};
              payGrFile.rec.CurrentSum = RoundAmount(payGrFile.rec.CurrentSum * DateMultiplifer);
              payGrFile.rec.CurrentNDSSum = RoundAmount(payGrFile.rec.CurrentNDSSum * DateMultiplifer);
              
          elif( (payGrFile.rec.TransferDate != NullDate) and ( grStartDate > {curdate} ) )
              payGrFile.rec.TransferDate = NullDate;
              payGrFile.rec.CurrentSum = 0;
              payGrFile.rec.CurrentNDSSum = 0;
          else    // this variant must be last!!!
              isUpdated = false;
          end;
          
          if(isUpdated)
              payGrFile.update();
              LogDSPayGrafik( payGrOldRec, D_UPDATE );
          end;
      
      end; // while
  end;

  if( not status )
    AbortTrn();
  end;
  
  return status;
end;

class (TOperationExecutor) TRetPayOperation ( opObj )

  var SumForPay, 
      Account, Referenc, PayMethod, Client, Сумма_без_НДС, Сумма_НДС, 
      Неиспользовано_дней, Дата_начала_текущего_срока_аренды, Сумма_Тарифа;
  var RentRetSum = 0, RentRetNDS = 0;
  var AgrRetSum = 0, AgrRetNDS = 0;
  var TotalRetSum = 0;
  var Валютность;

  macro carry()       /* Проводка */
    return ProcessTrn( 1, "RetPayCarry");
  end;

  macro checkOperation()

    var LastPayDate = GetLastDatePayPeriod(contr.rec.Branch, contr.rec.ContractID);
    if (LastPayDate == date(0,0,0))
      if (contr.rec.Discount == 100)
        MsgBox("Нет средств к возврату: Скидка 100%");
      else
        MsgBox("Невозможно определить срок до которого оплачен договор");
      end;
      return false;
    end;
    if (LastPayDate <= {curdate})
      MsgBox("Нет средств к возврату: Аренда не оплачена или оплачена не более чем до текущей даты");
      return false;
    end;
    
    if( Найти_документ_операции(contr.rec.Branch, contr.rec.ContractID, 11, null, 0) )
      MsgBox("Операция возврат средств уже проводилась.");
      return false;
    end;
    
    return true;
  end;
  
  macro inputClients()
    msgbox ("Выберите из списка клиента-получателя возвращаемой суммы.|",
            "Если возврат идет как зачисление на счет юридического лица,|",
            "то выберите представителя юридического лица."
         );
    return accessUI( operationObj );
  end;

  macro runPanel()
    var stat = operationObj.contract.panel.use();
      if( stat )
        stat = runPanel();
      end;
    return stat;
  end;

  macro GetMaxRentTransferDate(SafeID, CellNumber, ProlongAgrmntID)
    var query, cmd, Rs;
  var ResultDate = date (0,0,0);
  var Comma = ",";
  query = " select Nvl(max(MaxTransferDate), TO_DATE('01.01.0001', 'dd.mm.yyyy')) AS MaxDate from ( " +
          " select d.T_PAYENDDATE AS MaxTransferDate from dds_docum_dbt d "
      " where d.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and d.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " AND d.T_OPNUMBER = " + String(OP_NESTED_COLLNACCR) +
      " and d.T_STEPNUMBER = 3 " +
      " and d.T_PARENTOPNUMBER in (" + String(OP_RENTCELL) +Comma+ String(OP_PROLONG) +Comma+ String(OP_PRODL) +Comma+ String(OP_PAYRENT) +Comma+ String(OP_BEGRENT)+")" +
      " and d.T_OPSAFEID = " + String(SafeID) +
      " and d.T_OPCELLNUMBER = " + String(CellNumber) +
      " and d.T_ACTION not in (2, 11)" +
      " UNION " + 
      " select p1.T_ENDDATE AS MaxTransferDate from dds_paygr_dbt p1 " +
      " where p1.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " and p1.T_ADDAGRMNTID in (0 , " + String(ProlongAgrmntID) + " ) " +
      " and p1.T_SAFEID = " + String(SafeID) +
      " and p1.T_CELLNUMBER = " + String(CellNumber) +
      " and p1.T_TRANSFERDATE <> to_date('01.01.0001','dd.mm.yyyy') ) ";

  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  if( Rs.moveNext() )
      ResultDate = SQL_ConvTypeDate(Rs.value("MaxDate"));
    end;
  return ResultDate;
  end;

  macro GetMaxAgrmntTransferDate(SafeID, CellNumber, AgrmntID)
    var query, cmd, Rs;
  var ResultDate = date (0,0,0);
  var Comma = ",";
  query = " select Nvl( max(MaxTransferDate), TO_DATE('01.01.0001', 'dd.mm.yyyy')) AS MaxDate from (" +
          " select d.T_PAYENDDATE AS MaxTransferDate from dds_docum_dbt d, ddsagrmnt_dbt ag, dsb_casln_dbt ln1, dsb_casln_dbt ln2 "
      " where ag.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and ag.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " AND ag.T_ADDAGRMNTID  = " + String(AgrmntID) +
      " and ln1.T_APPLICATIONKIND2 = ag.T_APPLICATIONKIND and ln1.T_APPLICATIONKEY2 = ag.T_APPLICATIONKEY and ln1.T_REFVALUE2 = 0 and ln2.T_APPLICATIONKIND1 = ln1.T_APPLICATIONKIND1 and ln2.T_APPLICATIONKEY1 = ln1.T_APPLICATIONKEY1 and ln2.T_REFVALUE2 = 0 and d.T_APPLICATIONKIND = ln2.T_APPLICATIONKIND2 and d.T_APPLICATIONKEY = ln2.T_APPLICATIONKEY2 " +
      " and d.T_OPNUMBER  = " + String(OP_NESTED_COLLNACCR) +
      " and d.T_STEPNUMBER = 3 " +
      " and d.T_OpSafeID = " + String(SafeID) +
      " and d.T_OPCELLNUMBER = " + String(CellNumber) +
      " and d.T_ACTION not in (2, 11)" +
      " UNION " + 
      " select p1.T_ENDDATE AS MaxTransferDate from dds_paygr_dbt p1  " +
      " where p1.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " and p1.t_AddAgrmntID = " + String(AgrmntID) +
      " and p1.T_SAFEID = " + String(SafeID) +
      " and p1.T_CELLNUMBER = " + String(CellNumber) +
      " and p1.T_TRANSFERDATE <> to_date('01.01.0001','dd.mm.yyyy') ) ";
               
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  if( Rs.moveNext() )
      ResultDate = SQL_ConvTypeDate(Rs.value("MaxDate"));
    end;
  return ResultDate;
  end;

  macro GetPayedRentDate(SafeID, CellNumber) : date
    var query, cmd, Rs;
  var ResultDate = date (0,0,0);
  var Comma = ",";
  
  query = " select Nvl(max(d.T_PAYENDDATE), TO_DATE('01.01.0001', 'dd.mm.yyyy')) AS MaxDate from dds_docum_dbt d " +
      " where d.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and d.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " AND d.T_OPNUMBER = " + String(OP_NESTED_COLLNACCR) +
      " and d.T_STEPNUMBER in (3, 4) " +
      " and d.T_PARENTOPNUMBER in (" + String(OP_RENTCELL) +Comma+ String(OP_PROLONG) +Comma+ String(OP_PRODL) +Comma+ String(OP_PAYRENT) +Comma+ String(OP_BEGRENT)+")" +
      " and d.T_OPSAFEID = " + String(SafeID) +
      " and d.T_OPCELLNUMBER = " + String(CellNumber) +
      " and d.T_ACTION not in (2, 11)";
               
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  if( Rs.moveNext() )
      ResultDate = SQL_ConvTypeDate(Rs.value("MaxDate"));
    end;
  return ResultDate;
  end;

  macro GetPayedAgrmntDate(AgrmntID, SafeID, CellNumber) : date
    var query, cmd, Rs;
  var ResultDate = date (0,0,0);
  var Comma = ",";
  
  query = " select Nvl(max(d.T_PAYENDDATE), TO_DATE('01.01.0001', 'dd.mm.yyyy')) AS MaxDate from dds_docum_dbt d, ddsagrmnt_dbt ag, dsb_casln_dbt ln1, dsb_casln_dbt ln2 " +
      " where ag.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and ag.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " AND ag.T_ADDAGRMNTID  = " + String(AgrmntID) +
      " and ln1.T_APPLICATIONKIND2 = ag.T_APPLICATIONKIND and ln1.T_APPLICATIONKEY2 = ag.T_APPLICATIONKEY and ln1.T_REFVALUE2 = 0 and ln2.T_APPLICATIONKIND1 = ln1.T_APPLICATIONKIND1 and ln2.T_APPLICATIONKEY1 = ln1.T_APPLICATIONKEY1 and ln2.T_REFVALUE2 = 0 and d.T_APPLICATIONKIND = ln2.T_APPLICATIONKIND2 and d.T_APPLICATIONKEY = ln2.T_APPLICATIONKEY2 " +
      " and d.T_OPNUMBER  = " + String(OP_NESTED_COLLNACCR) +
      " and d.T_STEPNUMBER in (3, 4) " +
      " and d.T_PARENTOPNUMBER in (" + String(OP_RENTCELL) +Comma+ String(OP_PROLONG) +Comma+ String(OP_PRODL) +Comma+ String(OP_PAYRENT) +Comma+ String(OP_BEGRENT)+") " +
      " and d.T_OpSafeID = " + String(SafeID) +
      " and d.T_OPCELLNUMBER = " + String(CellNumber) +
      " and d.T_ACTION not in (2, 11)";
               
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  if( Rs.moveNext() )
      ResultDate = SQL_ConvTypeDate(Rs.value("MaxDate"));
    end;
  return ResultDate;
  end;

  macro RentSumForTransfer(ProlongAddAgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Result = $0;
    Nds = $0;
    
    query = 
      " select Nvl(sum(FUTURESUM), 0) AS FutSum, NVL(sum(FUTURENDSSUM), 0) AS FutNdsSum " +
      " from ( " +
      "   select p1.T_FUTURESUM AS FUTURESUM, p1.T_FUTURENDSSUM FUTURENDSSUM " +
      "   from dds_paygr_dbt p1  "
      "   where p1.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p1.T_ADDAGRMNTID  in (0, " + String(ProlongAddAgrmntID) + " ) " +
      "     and p1.T_SafeID = " + String(SafeID) +
      "     and p1.T_CELLNUMBER = " + String(CellNumber) +
      "     and p1.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p1.T_ENDDATE < " + GetSQLDate({curdate}) +
      "   UNION " + 
      "   select RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURESUM * ( " + GetSQLDate({curdate}) + " - p2.T_STARTDATE + 1)/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURESUM, "
      "     RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURENDSSUM * ( " + GetSQLDate({curdate}) + " - p2.T_STARTDATE + 1)/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURENDSSUM " +
      "   from dds_paygr_dbt p2 " +
      "   where p2.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p2.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p2.T_ADDAGRMNTID  in (0, " + String(ProlongAddAgrmntID) + " ) " +
      "     and p2.T_SafeID = " + String(SafeID) +
      "     and p2.T_CELLNUMBER = " + String(CellNumber) +
      "     and p2.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p2.T_STARTDATE <= " +GetSQLDate({curdate}) + 
      "     and p2.T_ENDDATE > " + GetSQLDate({curdate}) + 
      " ) ";
        
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("FutSum"));
      Nds = money(Rs.value("FutNdsSum"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro AgrmntSumForTransfer(AgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Result = $0;
    Nds = $0;

    query = 
      " select Nvl(sum(FUTURESUM), 0) AS FutSum, NVL(sum(FUTURENDSSUM), 0) AS FutNdsSum " +
      " from ( " +
      "   select p1.T_FUTURESUM AS FUTURESUM, p1.T_FUTURENDSSUM FUTURENDSSUM " +
      "   from dds_paygr_dbt p1 " +
      "   where p1.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p1.T_ADDAGRMNTID  = " + String(AgrmntID) +
      "     and p1.T_SafeID = " + String(SafeID) +
      "     and p1.T_CELLNUMBER = " + String(CellNumber) +
      "     and p1.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p1.T_ENDDATE < " + GetSQLDate({curdate}) + 
      "   UNION " +
      "   select  RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURESUM * (" + GetSQLDate({curdate}) + " - p2.T_STARTDATE + 1)/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURENDSSUM * (" + GetSQLDate({curdate}) + " - p2.T_STARTDATE + 1)/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_paygr_dbt p2 " +
      "   where p2.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p2.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p2.T_ADDAGRMNTID = " + String(AgrmntID) +
      "     and p2.T_SafeID = " + String(SafeID) +
      "     and p2.T_CELLNUMBER = " + String(CellNumber) +
      "     and p2.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p2.T_STARTDATE <= " +GetSQLDate({curdate}) + 
      "     and p2.T_ENDDATE > " + GetSQLDate({curdate}) + 
      " ) ";
               
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("FutSum"));
      Nds = money(Rs.value("FutNdsSum"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro RentSumForReturn(ProlongAgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Result = $0;
    Nds = $0;
  
    query = 
      " select Nvl(sum(FUTURESUM), 0) AS FutSum, NVL(sum(FUTURENDSSUM), 0) AS FutNdsSum " +
      " from ( " +
      "   select  RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURESUM * (p2.T_ENDDATE - " + GetSQLDate({curdate})  + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURENDSSUM * (p2.T_ENDDATE - " + GetSQLDate({curdate})  + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_paygr_dbt p2 " +
      "   where p2.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p2.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p2.T_ADDAGRMNTID  in (0, " + String(ProlongAgrmntID) + " ) " +
      "     and p2.T_SafeID = " + String(SafeID) +
      "     and p2.T_CELLNUMBER = " + String(CellNumber) +
      "     and p2.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p2.T_STARTDATE <= " +GetSQLDate({curdate}) + 
      "     and p2.T_ENDDATE > " + GetSQLDate({curdate}) +
      "   UNION " +
      "   select p1.T_FUTURESUM AS FUTURESUM, p1.T_FUTURENDSSUM FUTURENDSSUM " + 
      "   from dds_paygr_dbt p1   "
      "   where p1.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p1.T_ADDAGRMNTID  in (0, " + String(ProlongAgrmntID) + " ) " +
      "     and p1.T_SafeID = " + String(SafeID) +
      "     and p1.T_CELLNUMBER = " + String(CellNumber) +
      "     and p1.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p1.T_STARTDATE > " + GetSQLDate({curdate}) + 
      " ) ";     
      
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("FutSum"));
      Nds = money(Rs.value("FutNdsSum"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro RentRetSumFromNotTransferedMoney(ProlongAgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Result = $0;
    Nds = $0;
  
    query = 
      " select Nvl(sum(p1.T_FUTURESUM), 0) AS FUTURESUM, NVL(sum(p1.T_FUTURENDSSUM), 0) AS FUTURENDSSUM " +
      " from dds_paygr_dbt p1 " +
      " where p1.T_BRANCH  = " + String(contr.rec.Branch)  +  
      "   and p1.T_CONTRACTID  = " + String(contr.rec.ContractID) + 
      "   AND p1.T_ADDAGRMNTID  in (0, " + String(ProlongAgrmntID) + " ) " +
      "   and p1.T_SafeID = " + String(SafeID) +
      "   and p1.T_CELLNUMBER = " + String(CellNumber) +
      "   and p1.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "   and p1.T_STARTDATE > " +GetSQLDate({curdate});      

    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd );  
  
    if( Rs.moveNext() )
      Result = money(Rs.value("FUTURESUM"));
      Nds = money(Rs.value("FUTURENDSSUM"));
    end;
    
    SetParm(4, Nds);
    return Result;
  end;

  macro AgrmntRetSumFromNotTransferedMoney(AgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Result = $0;
    Nds = $0;
    
    query = 
      " select Nvl(sum(p1.T_FUTURESUM), 0) AS FUTURESUM, NVL(sum(p1.T_FUTURENDSSUM), 0) AS FUTURENDSSUM " + 
      " from dds_paygr_dbt p1 " +
      " where p1.T_BRANCH  = " + String(contr.rec.Branch)  +  
      "   and p1.T_CONTRACTID  = " + String(contr.rec.ContractID) + 
      "   AND p1.T_ADDAGRMNTID  = " + String(AgrmntID) + 
      "   and p1.T_SafeID = " + String(SafeID) +
      "   and p1.T_CELLNUMBER = " + String(CellNumber) +
      "   and p1.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "   and p1.T_STARTDATE > " +GetSQLDate({curdate});      
                 
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("FUTURESUM"));
      Nds = money(Rs.value("FUTURENDSSUM"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro AgrmntSumForReturn(AgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Result = $0;
    Nds = $0;

    query = 
      " select Nvl(sum(FUTURESUM), 0) AS FutSum, NVL(sum(FUTURENDSSUM), 0) AS FutNdsSum " +
      " from ( " +
      "   select  RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURESUM * ( p2.T_ENDDATE - " + GetSQLDate({curdate}) + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(p2.T_FUTURENDSSUM * (p2.T_ENDDATE - " + GetSQLDate({curdate}) + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_paygr_dbt p2 " +
      "   where p2.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p2.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p2.T_ADDAGRMNTID = " + String(AgrmntID) +
      "     and p2.T_SafeID = " + String(SafeID) +
      "     and p2.T_CELLNUMBER = " + String(CellNumber) +
      "     and p2.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p2.T_STARTDATE <= " +GetSQLDate({curdate}) + 
      "     and p2.T_ENDDATE > " + GetSQLDate({curdate}) +
      "   UNION "
      "   select p1.T_FUTURESUM AS FUTURESUM, p1.T_FUTURENDSSUM FUTURENDSSUM " +
      "   from dds_paygr_dbt p1 " +
      "   where p1.T_BRANCH = " + String(contr.rec.Branch)  +  
      "     and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     AND p1.T_ADDAGRMNTID  = " + String(AgrmntID) +
      "     and p1.T_SafeID = " + String(SafeID) +
      "     and p1.T_CELLNUMBER = " + String(CellNumber) +
      "     and p1.T_TRANSFERDATE = to_date('01.01.0001','dd.mm.yyyy') " + 
      "     and p1.T_STARTDATE > " + GetSQLDate({curdate}) + 
      " ) ";
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("FutSum"));
      Nds = money(Rs.value("FutNdsSum"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro GetProlongAddAgrmntID()
    var Rs = Выбрать_доп_cоглашения(contr.rec.Branch, contr.rec.ContractID);  
    if (Rs.moveNext())
        return Rs.value("T_ADDAGRMNTID");
    else
        return 0;
    end;
  end;

  macro GetAgrmntsForRet()
    var query, cmd, Rs;
  var Comma = ",";
  var Branch = contr.rec.Branch;
  var ContractID = contr.rec.ContractID;
  var ProlongAgrmntID = GetProlongAddAgrmntID();
  
  query = " select ag.T_ADDAGRMNTID AS ADDAGRMNTID from ddsagrmnt_dbt ag " +
      " where ag.T_BRANCH = " + String(contr.rec.Branch)  +  
      " and ag.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      " and ag.T_TYPE_OPNUMBER in " + 
          " (select distinct(op.T_OPNUMBER) from dds_opstp_dbt op " +
          " where op.T_NESTEDDSOPNUMBER = " + String(OP_NESTED_COLLNACCR) + " ) " +
      " and ag.T_ADDAGRMNTID <> " + String(ProlongAgrmntID) +
      " and ag.T_ACTION not in (2, 11)";
               
  cmd = RsdCommand(query);
  cmd.execute();
  Rs = RsdRecordset( cmd, null, 0 );
  return Rs;
  end;

  macro CalcRentRetSumsFromRevenue(ProlongAddAgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Comma = ",";
    var Result = $0;
    Nds = $0;
    
    query = 
      " select Nvl(sum(FUTURESUM), 0) AS RetSum, NVL(sum(FUTURENDSSUM), 0) AS FutNdsSum " +
      " from ( " +
      "   select RSU_RTLCOMMON.AllMath_RoundSum(p2.T_CURRENTSUM * (p2.T_ENDDATE - "+ GetSQLDate( {curdate}) + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(p2.T_CURRENTNDSSUM * (p2.T_ENDDATE - "+ GetSQLDate( {curdate}) + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_paygr_dbt p2 " +
      "   where p2.T_BRANCH = " + String(contr.rec.Branch) +
      "     and p2.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     and p2.T_ADDAGRMNTID in (0, " + String(ProlongAddAgrmntID) + ") " +
      "     and p2.T_SAFEID = " + String(SafeID) + 
      "     and p2.T_CELLNUMBER = " + String(CellNumber) + 
      "     and p2.T_TRANSFERDATE <> to_date('01.01.0001','dd.mm.yyyy') " +
      "     and p2.T_STARTDATE <= " + GetSQLDate({curdate}) + 
      "     and p2.T_ENDDATE > " + GetSQLDate({curdate}) + 
      "   UNION " +
      "   select p1.T_CURRENTSUM AS FUTURESUM, p1.T_CURRENTNDSSUM FUTURENDSSUM " +
      "   from dds_paygr_dbt p1 " +
      "   where p1.T_BRANCH = " + String(contr.rec.Branch) + 
      "     and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     and p1.T_ADDAGRMNTID in (0, " + String(ProlongAddAgrmntID) + ") " + 
      "     and p1.T_SAFEID = " + String(SafeID) + 
      "     and p1.T_CELLNUMBER = " + String(CellNumber) + 
      "     and p1.T_TRANSFERDATE <> to_date('01.01.0001','dd.mm.yyyy') " +
      "     and p1.T_STARTDATE > " + GetSQLDate({curdate}) +
      "   UNION " +
      "   select RSU_RTLCOMMON.AllMath_RoundSum(d.T_INSUM * (d.T_PAYENDDATE - " + GetSQLDate({curdate}) + ")/(d.T_PAYENDDATE - d.T_PAYSTARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(d.T_NDSSUM * (d.T_PAYENDDATE - " + GetSQLDate({curdate}) + ")/(d.T_PAYENDDATE - d.T_PAYSTARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_docum_dbt d " +
      "   where d.T_BRANCH = " + String(contr.rec.Branch) + 
      "     and d.T_CONTRACTID = " + String(contr.rec.ContractID) +
      "     and d.T_OPNUMBER = " + String(OP_NESTED_COLLNACCR) +
      "     and d.T_STEPNUMBER = 3 " +
      "     and d.T_PARENTOPNUMBER in (" + String(OP_RENTCELL) +Comma+ String(OP_PROLONG) +Comma+ String(OP_PRODL) +Comma+ String(OP_PAYRENT) +Comma+ String(OP_BEGRENT)+") " +
      "     and d.T_OPSAFEID = " + String(SafeID) +
      "     and d.T_OPCELLNUMBER = " + String(CellNumber) + 
      "     and d.T_PAYSTARTDATE <= " + GetSQLDate({curdate}) +
      "     and d.T_PAYENDDATE > " + GetSQLDate({curdate}) +
      "     and d.T_ACTION not in (2, 11) " +
      "   UNION " +
      "   select d.T_INSUM AS FUTURESUM, d.T_NDSSUM FUTURENDSSUM " +
      "   from dds_docum_dbt d " +
      "   where d.T_BRANCH = " + String(contr.rec.Branch) +
      "     and d.T_CONTRACTID = " + String(contr.rec.ContractID) +
      "     and d.T_OPNUMBER = " + String(OP_NESTED_COLLNACCR) +
      "     and d.T_STEPNUMBER = 3 " +
      "     and d.T_PARENTOPNUMBER in (" + String(OP_RENTCELL) +Comma+ String(OP_PROLONG) +Comma+ String(OP_PRODL) +Comma+ String(OP_PAYRENT) +Comma+ String(OP_BEGRENT)+") " +
      "     and d.T_OPSAFEID = " + String(SafeID) +
      "     and d.T_OPCELLNUMBER = " +  String(CellNumber) + 
      "     and d.T_PAYSTARTDATE > " + GetSQLDate({curdate}) +
      "     and d.T_ACTION not in (2, 11) " +
      " )";
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("RetSum"));
      Nds = money(Rs.value("FutNdsSum"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro CalcAgrmntRetSumsFromRevenue(AddAgrmntID, SafeID, CellNumber, Nds)
    var query, cmd, Rs;
    var Comma = ",";
    var Result = $0;
    Nds = $0;
    
    query = 
      " select Nvl(sum(FUTURESUM), 0) AS RetSum, NVL(sum(FUTURENDSSUM), 0) AS FutNdsSum " +
      " from ( " +
      "   select RSU_RTLCOMMON.AllMath_RoundSum(p2.T_CURRENTSUM * (p2.T_ENDDATE - " + GetSQLDate( {curdate}) + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(p2.T_CURRENTNDSSUM * (p2.T_ENDDATE - " + GetSQLDate( {curdate}) + ")/(p2.T_ENDDATE - p2.T_STARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_paygr_dbt p2 " +
      "   where p2.T_BRANCH = " + String(contr.rec.Branch) +
      "     and p2.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     and p2.T_ADDAGRMNTID = " + String(AddAgrmntID) + 
      "     and p2.T_SAFEID = " + String(SafeID) + 
      "     and p2.T_CELLNUMBER = " + String(CellNumber) + 
      "     and p2.T_TRANSFERDATE <> to_date('01.01.0001','dd.mm.yyyy') " +
      "     and p2.T_STARTDATE <= " + GetSQLDate({curdate}) + 
      "     and p2.T_ENDDATE > " + GetSQLDate({curdate}) + 
      "   UNION " +
      "   select p1.T_CURRENTSUM AS FUTURESUM, p1.T_CURRENTNDSSUM FUTURENDSSUM " +
      "   from dds_paygr_dbt p1 " +
      "   where p1.T_BRANCH = " + String(contr.rec.Branch) + 
      "     and p1.T_CONTRACTID = " + String(contr.rec.ContractID) + 
      "     and p1.T_ADDAGRMNTID = " + String(AddAgrmntID) +  
      "     and p1.T_SAFEID = " + String(SafeID) + 
      "     and p1.T_CELLNUMBER = " + String(CellNumber) + 
      "     and p1.T_TRANSFERDATE <> to_date('01.01.0001','dd.mm.yyyy') " +
      "     and p1.T_STARTDATE > " + GetSQLDate({curdate}) +
      "   UNION " +
      "   select RSU_RTLCOMMON.AllMath_RoundSum(d.T_INSUM * (d.T_PAYENDDATE - " + GetSQLDate({curdate}) + ")/(d.T_PAYENDDATE - d.T_PAYSTARTDATE + 1), 3) AS FUTURESUM, " +
      "     RSU_RTLCOMMON.AllMath_RoundSum(d.T_NDSSUM * (d.T_PAYENDDATE - " + GetSQLDate({curdate}) + ")/(d.T_PAYENDDATE - d.T_PAYSTARTDATE + 1), 3) FUTURENDSSUM " +
      "   from dds_docum_dbt d, ddsagrmnt_dbt ag, dsb_casln_dbt ln1, dsb_casln_dbt ln2" +
      "   where ag.T_BRANCH = " + String(contr.rec.Branch) + 
      "     and ag.T_CONTRACTID = " + String(contr.rec.ContractID) +
      "     and ag.T_ADDAGRMNTID = " + String(AddAgrmntID) + 
      "     and ln1.T_APPLICATIONKIND2 = ag.T_APPLICATIONKIND and ln1.T_APPLICATIONKEY2 = ag.T_APPLICATIONKEY and ln1.T_REFVALUE2 = 0 and ln2.T_APPLICATIONKIND1 = ln1.T_APPLICATIONKIND1 and ln2.T_APPLICATIONKEY1 = ln1.T_APPLICATIONKEY1 and ln2.T_REFVALUE2 = 0 and d.T_APPLICATIONKIND = ln2.T_APPLICATIONKIND2 and d.T_APPLICATIONKEY = ln2.T_APPLICATIONKEY2 " +
      "     and d.T_OPNUMBER = " + String(OP_NESTED_COLLNACCR) +
      "     and d.T_STEPNUMBER = 3 " +
      "     and d.T_OPSAFEID = " + String(SafeID) +
      "     and d.T_OPCELLNUMBER = " + String(CellNumber) + 
      "     and d.T_PAYSTARTDATE <= " + GetSQLDate({curdate}) +
      "     and d.T_PAYENDDATE > " + GetSQLDate({curdate}) +
      "     and d.T_ACTION not in (2, 11) " +
      "   UNION " +
      "   select d.T_INSUM AS FUTURESUM, d.T_NDSSUM FUTURENDSSUM " +
      "   from dds_docum_dbt d, ddsagrmnt_dbt ag, dsb_casln_dbt ln1, dsb_casln_dbt ln2 " +
      "   where ag.T_BRANCH = " + String(contr.rec.Branch) +
      "     and ag.T_CONTRACTID = " + String(contr.rec.ContractID) +
      "     and ag.T_ADDAGRMNTID = " + String(AddAgrmntID) + 
      "     and ln1.T_APPLICATIONKIND2 = ag.T_APPLICATIONKIND and ln1.T_APPLICATIONKEY2 = ag.T_APPLICATIONKEY and ln1.T_REFVALUE2 = 0 and ln2.T_APPLICATIONKIND1 = ln1.T_APPLICATIONKIND1 and ln2.T_APPLICATIONKEY1 = ln1.T_APPLICATIONKEY1 and ln2.T_REFVALUE2 = 0 and d.T_APPLICATIONKIND = ln2.T_APPLICATIONKIND2 and d.T_APPLICATIONKEY = ln2.T_APPLICATIONKEY2 " +
      "     and d.T_OPNUMBER = " + String(OP_NESTED_COLLNACCR) +
      "     and d.T_STEPNUMBER = 3 " +
      "     and d.T_OPSAFEID = " + String(SafeID) +
      "     and d.T_OPCELLNUMBER = " +  String(CellNumber) + 
      "     and d.T_PAYSTARTDATE > " + GetSQLDate({curdate}) +
      "     and d.T_ACTION not in (2, 11) " +
      " )";
    cmd = RsdCommand(query);
    cmd.execute();
    Rs = RsdRecordset( cmd, null, 0 );
    if( Rs.moveNext() )
      Result = money(Rs.value("RetSum"));
      Nds = money(Rs.value("FutNdsSum"));
    end;
    SetParm(4, Nds);
    return Result;
  end;

  macro createDocumentsOnRentByCell(SafeID, CellNumber, ProlongAddAgrmntID)
    var DsDoc, depDoc, payDoc;
    var PayedDate = GetPayedRentDate(SafeID, CellNumber);
    var TransferDate = GetMaxRentTransferDate(SafeID, CellNumber, ProlongAddAgrmntID);
    var TransferSum = $0;
    var NdsSum = $0;
    var ReturnSum = $0;
    var ReturnSumFromNotTransferedMoney = $0;
    var ReturnNDSSum = $0;
    var Referenc = operationObj.pmntFromAccount;
    var Ground = "";

    if ( ({curdate} >= PayedDate) and (TransferDate == PayedDate))
        return;
    end;

    if ( TransferDate < {curdate} )
        // create document on rent pay for current date
        TransferSum = RentSumForTransfer(ProlongAddAgrmntID, SafeID, CellNumber, NdsSum);
        dsDoc = operationObj.newDsDoc(5); 
        if(not operationObj.multipleClients)
            dsDoc.rec.ClientCode = operationObj.clientCode;
        end;

        dsDoc.rec.CurrCode = NATIONAL_CURR;
        dsDoc.rec.InSum = TransferSum;
        dsDoc.rec.NdsSum = NdsSum;
        
        dsDoc.rec.PayStartDate = TransferDate + 1;
        dsDoc.rec.PayEndDate = {curdate};
        dsDoc.rec.opSafeID = SafeID;
        dsDoc.rec.opCellNumber = CellNumber;

        if (PayMethod==DSPM_CASHLESS) /* безналично */
           dsDoc.rec.CashFlag = "X";
        else
           dsDoc.rec.CashFlag = "";
        end;

        dsDoc.rec.Referenc = Referenc;
        dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
        operationObj.docList.insert(dsDoc);

        StoreValue("doc:Сумма@ДоходыТП", dsDoc.rec.InSum + RetrieveValue("doc:Сумма@ДоходыТП"));
        StoreValue("doc:Сумма@НДСДоходыТП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСДоходыТП"));

        /*if( PayMethod != DSPM_PUT )
            if( (PayMethod == DSPM_CASHLESS) )
                depDoc = operationObj.newDepDoc(dsDoc);
                depDoc.rec.Ground=Ground;
                operationObj.docList.insert(depDoc);
            else*/
                payDoc = operationObj.newPayDoc(dsDoc);
                    payDoc.rec.Ground = Ground;
                operationObj.docList.insert(payDoc);
           /*end;
        end;*/

        // create document on return pay for rent
        ReturnSum = RentSumForReturn(ProlongAddAgrmntID, SafeID, CellNumber, ReturnNDSSum);
        if (ReturnSum > 0)
            RentRetSum = RentRetSum + ReturnSum;
            dsDoc = operationObj.newDsDoc(3); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.OutSum = ReturnSum;
            dsDoc.rec.NdsSum = ReturnNDSSum;
            
            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

            StoreValue("doc:Сумма@ВозвратДоходыБП", dsDoc.rec.OutSum + RetrieveValue("doc:Сумма@ВозвратДоходыБП"));
            StoreValue("doc:Сумма@НДСВозвратДБП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратДБП"));

            /*if( PayMethod != DSPM_PUT )
                if( (PayMethod == DSPM_CASHLESS) )
                    depDoc = operationObj.newDepDoc(dsDoc);
                    depDoc.rec.Ground=Ground;
                    operationObj.docList.insert(depDoc);
                else*/
            payDoc = operationObj.newPayDoc(dsDoc);
            payDoc.rec.Ground = Ground;
            operationObj.docList.insert(payDoc);
                /*end;
            end;*/

            // create document on return NDS
            //ReturnNDSSum = ReturnSum * NDS / 100;
            RentRetNDS = RentRetNDS + ReturnNDSSum;
            dsDoc = operationObj.newDsDoc(2); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.OutSum = ReturnNDSSum;
            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.NdsSum   = 0;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

/*
            if( PayMethod != DSPM_PUT )
                if( (PayMethod == DSPM_CASHLESS) )
                    depDoc = operationObj.newDepDoc(dsDoc);
                    depDoc.rec.Ground=Ground;
                    operationObj.docList.insert(depDoc);
                else
*/
                    payDoc = operationObj.newPayDoc(dsDoc);
                    payDoc.rec.Ground = Ground;
                    operationObj.docList.insert(payDoc);
                // end; // if( (PayMethod == DSPM_CASHLESS) )
            // end; // if( PayMethod != DSPM_PUT )
        end; // if (ReturnSum > 0)
    else    // if ( TransferDate < {curdate} ) else (TransferDate >= {curdate})
        ReturnSum = CalcRentRetSumsFromRevenue(ProlongAddAgrmntID, SafeID, CellNumber, ReturnNDSSum);
        RentRetSum = RentRetSum + ReturnSum;
        if (ReturnSum > 0)
            dsDoc = operationObj.newDsDoc(4); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.OutSum = ReturnSum;
            dsDoc.rec.NdsSum = ReturnNDSSum;
            
            dsDoc.rec.OpSafeID = SafeID;
            dsDoc.rec.OpCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

            StoreValue("doc:Сумма@ВозвратДоходыТП", dsDoc.rec.OutSum + RetrieveValue("doc:Сумма@ВозвратДоходыТП"));
            StoreValue("doc:Сумма@НДСВозвратДТП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратДТП"));

        /*if( PayMethod != DSPM_PUT )
            if( (PayMethod == DSPM_CASHLESS) )
                depDoc = operationObj.newDepDoc(dsDoc);
                depDoc.rec.Ground=Ground;
                operationObj.docList.insert(depDoc);
            else*/
            payDoc = operationObj.newPayDoc(dsDoc);
            payDoc.rec.Ground = Ground;
            operationObj.docList.insert(payDoc);
            /*end;*/
        end;

        ReturnSumFromNotTransferedMoney = RentRetSumFromNotTransferedMoney(ProlongAddAgrmntID, SafeID, CellNumber, NdsSum);
        RentRetSum = RentRetSum + ReturnSumFromNotTransferedMoney;
        if (ReturnSumFromNotTransferedMoney > 0)
            dsDoc = operationObj.newDsDoc(3); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.OutSum = ReturnSumFromNotTransferedMoney;
            dsDoc.rec.NdsSum = NdsSum;
            
            dsDoc.rec.OpSafeID = SafeID;
            dsDoc.rec.OpCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

            StoreValue("doc:Сумма@ВозвратДоходыБП", dsDoc.rec.OutSum + RetrieveValue("doc:Сумма@ВозвратДоходыБП"));
            StoreValue("doc:Сумма@НДСВозвратДБП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратДБП"));

        /*if( PayMethod != DSPM_PUT )
            if( (PayMethod == DSPM_CASHLESS) )
                depDoc = operationObj.newDepDoc(dsDoc);
                depDoc.rec.Ground=Ground;
                operationObj.docList.insert(depDoc);
            else*/
            payDoc = operationObj.newPayDoc(dsDoc);
            payDoc.rec.Ground = Ground;
            operationObj.docList.insert(payDoc);
            /*end;*/
        end;

        //ReturnNDSSum = (ReturnSum+ReturnSumFromNotTransferedMoney) * NDS / 100;
        ReturnNDSSum = ReturnNDSSum + NdsSum;
        RentRetNDS = RentRetNDS + ReturnNDSSum;
        if (ReturnNDSSum>0)
            dsDoc = operationObj.newDsDoc(2); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.OutSum = ReturnNDSSum;
            dsDoc.rec.OpSafeID = SafeID;
            dsDoc.rec.OpCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.NdsSum   = 0;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

/*
            if( PayMethod != DSPM_PUT )
                if( (PayMethod == DSPM_CASHLESS) )
                    depDoc = operationObj.newDepDoc(dsDoc);
                    depDoc.rec.Ground=Ground;
                    operationObj.docList.insert(depDoc);
                else
*/
                    payDoc = operationObj.newPayDoc(dsDoc);
                    payDoc.rec.Ground = Ground;
                    operationObj.docList.insert(payDoc);
                // end; // if( (PayMethod == DSPM_CASHLESS) )
            // end; // if( PayMethod != DSPM_PUT )
        end;
    end;
    
  end;

  macro createDocumentsOnAgrmntByCell(SafeID, CellNumber, CurrAgrmntID)
    var DsDoc, depDoc, payDoc;
    var PayedDate = GetPayedAgrmntDate(CurrAgrmntID, SafeID, CellNumber);
    var TransferDate = GetMaxAgrmntTransferDate(SafeID, CellNumber, CurrAgrmntID);
    var TransferSum = $0;
    var NdsSum = $0;
    var ReturnSum = $0;
    var ReturnSumFromNotTransferedMoney = $0;
    var ReturnNDSSum = $0;
    var Referenc = operationObj.pmntFromAccount;
    var Ground = "";

    if ( ({curdate} >= PayedDate) and (TransferDate == PayedDate))
        return;
    end;

    if ( TransferDate < {curdate} )
        // create document on rent pay for current date
        TransferSum = AgrmntSumForTransfer(CurrAgrmntID, SafeID, CellNumber, NdsSum);
        dsDoc = operationObj.newDsDoc(5); 
        if(not operationObj.multipleClients)
            dsDoc.rec.ClientCode = operationObj.clientCode;
        end;

        dsDoc.rec.CurrCode = NATIONAL_CURR;
        dsDoc.rec.InSum = TransferSum;
        dsDoc.rec.NdsSum = NdsSum;
        
        dsDoc.rec.PayStartDate = TransferDate + 1;
        dsDoc.rec.PayEndDate = {curdate};
        dsDoc.rec.opSafeID = SafeID;
        dsDoc.rec.opCellNumber = CellNumber;

        if (PayMethod==DSPM_CASHLESS) /* безналично */
           dsDoc.rec.CashFlag = "X";
        else
           dsDoc.rec.CashFlag = "";
        end;

        dsDoc.rec.Referenc = Referenc;
        dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
        operationObj.docList.insert(dsDoc);

        StoreValue("doc:Сумма@ДоходыТП", dsDoc.rec.InSum + RetrieveValue("doc:Сумма@ДоходыТП"));
        StoreValue("doc:Сумма@НДСДоходыТП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСДоходыТП"));

        /*if( PayMethod != DSPM_PUT )
            if( (PayMethod == DSPM_CASHLESS) )
                depDoc = operationObj.newDepDoc(dsDoc);
                depDoc.rec.Ground=Ground;
                operationObj.docList.insert(depDoc);
            else*/
                payDoc = operationObj.newPayDoc(dsDoc);
                    payDoc.rec.Ground = Ground;
                operationObj.docList.insert(payDoc);
            /*end;
        end;*/

        // create document on return pay for rent
        ReturnSum = AgrmntSumForReturn(CurrAgrmntID, SafeID, CellNumber, ReturnNDSSum);
        if (ReturnSum > 0)
            RentRetSum = RentRetSum + ReturnSum;
            dsDoc = operationObj.newDsDoc(3); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.OutSum = ReturnSum;
            dsDoc.rec.NdsSum = ReturnNDSSum;

            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

            StoreValue("doc:Сумма@ВозвратДоходыБП", dsDoc.rec.OutSum + RetrieveValue("doc:Сумма@ВозвратДоходыБП"));
            StoreValue("doc:Сумма@НДСВозвратДБП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратДБП"));

            /*if( PayMethod != DSPM_PUT )
                if( (PayMethod == DSPM_CASHLESS) )
                    depDoc = operationObj.newDepDoc(dsDoc);
                    depDoc.rec.Ground=Ground;
                    operationObj.docList.insert(depDoc);
                else*/
            payDoc = operationObj.newPayDoc(dsDoc);
            payDoc.rec.Ground = Ground;
            operationObj.docList.insert(payDoc);
                /*end;
            end;*/

            // create document on return NDS
            //ReturnNDSSum = ReturnSum * NDS / 100;
            RentRetNDS = RentRetNDS + ReturnNDSSum;
            dsDoc = operationObj.newDsDoc(2); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.OutSum = ReturnNDSSum;
            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.NdsSum   = 0;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

/*
            if( PayMethod != DSPM_PUT )
                if( (PayMethod == DSPM_CASHLESS) )
                    depDoc = operationObj.newDepDoc(dsDoc);
                    depDoc.rec.Ground=Ground;
                    operationObj.docList.insert(depDoc);
                else
*/
                    payDoc = operationObj.newPayDoc(dsDoc);
                        payDoc.rec.Ground = Ground;
                    operationObj.docList.insert(payDoc);
                // end; // if( (PayMethod == DSPM_CASHLESS) )
            // end; // if( PayMethod != DSPM_PUT )
        end; // if (ReturnSum > 0)
    else    // if ( TransferDate < {curdate} ) else (TransferDate >= {curdate})
        ReturnSum = CalcAgrmntRetSumsFromRevenue(CurrAgrmntID, SafeID, CellNumber, ReturnNDSSum);
        RentRetSum = RentRetSum + ReturnSum;
        if (ReturnSum>0)
            dsDoc = operationObj.newDsDoc(4); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.OutSum = ReturnSum;
            dsDoc.rec.NdsSum = ReturnNDSSum;

            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

            StoreValue("doc:Сумма@ВозвратДоходыТП", dsDoc.rec.OutSum + RetrieveValue("doc:Сумма@ВозвратДоходыТП"));
            StoreValue("doc:Сумма@НДСВозвратДТП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратДТП"));

        /*if( PayMethod != DSPM_PUT )
            if( (PayMethod == DSPM_CASHLESS) )
                depDoc = operationObj.newDepDoc(dsDoc);
                depDoc.rec.Ground=Ground;
                operationObj.docList.insert(depDoc);
            else*/
            payDoc = operationObj.newPayDoc(dsDoc);
                payDoc.rec.Ground = Ground;
            operationObj.docList.insert(payDoc);
            /*end;*/
        end;

        ReturnSumFromNotTransferedMoney = AgrmntRetSumFromNotTransferedMoney(CurrAgrmntID, SafeID, CellNumber, NdsSum);
        RentRetSum = RentRetSum + ReturnSumFromNotTransferedMoney;
        if (ReturnSumFromNotTransferedMoney>0)
            dsDoc = operationObj.newDsDoc(3); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.OutSum = ReturnSumFromNotTransferedMoney;
            dsDoc.rec.NdsSum = NdsSum;

            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

            StoreValue("doc:Сумма@ВозвратДоходыБП", dsDoc.rec.OutSum + RetrieveValue("doc:Сумма@ВозвратДоходыБП"));
            StoreValue("doc:Сумма@НДСВозвратДБП", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратДБП"));

        /*if( PayMethod != DSPM_PUT )
            if( (PayMethod == DSPM_CASHLESS) )
                depDoc = operationObj.newDepDoc(dsDoc);
                depDoc.rec.Ground=Ground;
                operationObj.docList.insert(depDoc);
            else*/
            payDoc = operationObj.newPayDoc(dsDoc);
            payDoc.rec.Ground = Ground;
            operationObj.docList.insert(payDoc);
            /*end;*/
        end;

        //ReturnNDSSum = (ReturnSum+ReturnSumFromNotTransferedMoney) * NDS / 100;
        ReturnNDSSum = ReturnNDSSum + NdsSum;
        RentRetNDS = RentRetNDS + ReturnNDSSum;
        if (ReturnNDSSum>0)
            dsDoc = operationObj.newDsDoc(2); 
            if(not operationObj.multipleClients)
                dsDoc.rec.ClientCode = operationObj.clientCode;
            end;

            dsDoc.rec.OutSum = ReturnNDSSum;
            dsDoc.rec.opSafeID = SafeID;
            dsDoc.rec.opCellNumber = CellNumber;

            if (PayMethod==DSPM_CASHLESS) /* безналично */
               dsDoc.rec.CashFlag = "X";
            else
               dsDoc.rec.CashFlag = "";
            end;

            dsDoc.rec.CurrCode = NATIONAL_CURR;
            dsDoc.rec.NdsSum   = 0;

            dsDoc.rec.Referenc = Referenc;
            dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
            operationObj.docList.insert(dsDoc);

/*
            if( PayMethod != DSPM_PUT )
                if( (PayMethod == DSPM_CASHLESS) )
                    depDoc = operationObj.newDepDoc(dsDoc);
                    depDoc.rec.Ground=Ground;
                    operationObj.docList.insert(depDoc);
                else
*/
                    payDoc = operationObj.newPayDoc(dsDoc);
                    payDoc.rec.Ground = Ground;
                    operationObj.docList.insert(payDoc);
                // end; // if( (PayMethod == DSPM_CASHLESS) )
            // end; // if( PayMethod != DSPM_PUT )
        end;
    end;
  end;

  macro createDocuments()
    var DsDoc, depDoc, payDoc;
    var stat = true;
    var hasNext = false;
    var cells = contr.cellList;
    var SafeID, CellNumber;
    var ProlongAddAgrmntID = GetProlongAddAgrmntID();
    var AddAgrmntsRS;
    var WorkAgrmntID;
    var Ground = "";
    
    Client        = operationObj.pmntClient;
    Referenc      = operationObj.pmntFromAccount;
    PayMethod     = operationObj.pmntIsNonCash;

    hasNext = cells.first();
    while( hasNext AND (cells.item.rec.isNeedCloseCell == "") )
        SafeID = cells.item.rec.SafeID;
        CellNumber = cells.item.rec.CellNumber;
        createDocumentsOnRentByCell(SafeID, CellNumber, ProlongAddAgrmntID);
        AddAgrmntsRS = GetAgrmntsForRet();
        while (AddAgrmntsRS.moveNext())
            WorkAgrmntID = AddAgrmntsRS.value("ADDAGRMNTID");
            createDocumentsOnAgrmntByCell(SafeID, CellNumber, WorkAgrmntID);
        end;
        hasNext = cells.next();
    end;

    if ((RentRetSum + RentRetNDS + AgrRetSum + AgrRetNDS)>0)
        dsDoc = operationObj.newDsDoc(1); 
        if(not operationObj.multipleClients)
          dsDoc.rec.ClientCode = operationObj.clientCode;
        end;

        if (RentRetSum > 0)
            Ground = "Возврат средств за неиспользованный срок аренды. "+
                     "Сумма к возврату "+ string(RentRetSum+RentRetNDS) +" руб. (включая НДС "+ string(RentRetNDS)+" руб.). ";
        end;
        if (AgrRetSum > 0)
            Ground = Ground + "Возврат средств за неиспользованный срок по доп.соглашениям. Сумма к возврату "+
                     string(AgrRetSum+AgrRetNDS) +" руб. (включая НДС "+ string(AgrRetNDS)+" руб.). ";
        end;

        dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, Ground);

        if (PayMethod==DSPM_CASHLESS) /* безналично */
           dsDoc.rec.CashFlag = "X";
        else
           dsDoc.rec.CashFlag = "";
        end;

        dsDoc.rec.CurrCode = NATIONAL_CURR;
        dsDoc.rec.OutSum   = RentRetSum + RentRetNDS + AgrRetSum + AgrRetNDS;
        dsDoc.rec.NdsSum   = RentRetNDS + AgrRetNDS;

        dsDoc.rec.Referenc=Referenc;

        operationObj.docList.insert(dsDoc);

        StoreValue("doc:Валюта@Нарезка", dsDoc.rec.CurrCode);
        StoreValue("doc:Валюта@Опер", dsDoc.rec.CurrCode);
        StoreValue("doc:Сумма@Опер", dsDoc.rec.OutSum);
        StoreValue("doc:Сумма@ВозвратАренда", dsDoc.rec.OutSum - dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@ВозвратАренда"));
        StoreValue("doc:Сумма@НДСВозвратАренда", dsDoc.rec.NdsSum + RetrieveValue("doc:Сумма@НДСВозвратАренда"));

        if( PayMethod != DSPM_PUT )
          if( (PayMethod == DSPM_CASHLESS) )
              depDoc = operationObj.newDepDoc(dsDoc);
              depDoc.rec.Ground=Ground;
              operationObj.docList.insert(depDoc);
          else
              payDoc = operationObj.newPayDoc(dsDoc);
                 payDoc.rec.Ground = Ground;
              operationObj.docList.insert(payDoc);
          end;
        end;
    end;

    return stat;
  end;

  InitTOperationExecutor( opObj );
end;

/************************ Основная программа **********************************/
var obj = TRetPayOperation ( operation );

  obj.runOp();

end;
