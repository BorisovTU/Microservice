/*
$Name:             prlprdcl.mac
$Module:           RS-Retail
$Description:      Сейфовые ячейки. Определение базового класса для операции пролонгации/продления
*/

/* Определение базового класса для операции пролонгации/продления */
import stforcel,classes, paygrend;
import stprocs;

var operation     = CreateObjectOfOperation();
var bunch         = CreateOpFootprintObject();

class (TOperationExecutor) TProlongProdOperation( opObj )

  private var OldGrntSum = $0;

  macro checkOperation()
    var status = true;
    var contr = operationObj.contract;
    var LastDatePayPeriod = date (0,0,0);
    var rs, cmd, sqlquery;

    OldGrntSum = contr.rec.GrntSum;

    
    if( ({curdate} > operationObj.contract.rec.EndDate) and
        ( КоличествоПросроченныхДней({curdate}, operationObj.contract.rec.EndDate, false) > 0) )
        
          PushErrorMessage("Текущая дата - " + date({curdate}) + ". Дата завершения договора - " + date(operationObj.contract.rec.EndDate) + ". "+
                           "Продление пролонгация запрещена");

      status = false;                       
    end;

    if ( status and (contr.rec.EndDate < {curdate}) and (isHoliday(contr.rec.EndDate)) and (contr.rec.Discount != 100))
       if ( CalcExtraDays( contr.rec.EndDate )>0 )
          sqlquery = " select 1 from dds_docum_dbt where t_branch = ? " +
                     " and t_ContractID = ? and t_opnumber = ? and t_stepnumber = ? and t_date>? ";
          cmd = RsdCommand( sqlquery );
  
          cmd.addParam("Branch",      RSDBP_IN, contr.rec.Branch );
          cmd.addParam("ContractID",  RSDBP_IN, contr.rec.ContractID );
          cmd.addParam("OpNumber",    RSDBP_IN, 10 );
          cmd.addParam("StepNumber",  RSDBP_IN, 1 );
          cmd.addParam("Date",  RSDBP_IN, contr.rec.EndDate );

          rs = RsdRecordset( cmd );
          cmd.execute();

          if ( not rs.moveNext ) 
             PushErrorMessage(string("День окончания договора ", contr.rec.EndDate, " - нерабочий день. Текущая дата - ", {curdate},
                                     ". Необходимо доплатить арендную плату за неоплаченные дни. Выполните операцию 10 - 'Дополнительная плата', а затем продлите договор." ) );
             status = false;
          end;
       end;
    end;

    if( status )
        if( operationObj.Contract.isClaimRegistered )
            PushErrorMessage("По договору зарегистрировано возникновение исковой ситуации.| Продление/пролонгация договора запрещена");
            status = false;
        end;
    end;

    if(status)
      LastDatePayPeriod = GetLastDatePayPeriod(contr.rec.Branch, contr.rec.ContractID);
      if ( ( ( {curdate} > contr.rec.EndDate ) and ( LastDatePayPeriod < contr.rec.EndDate ) )
         or ( {curdate} <= contr.rec.EndDate ) and ( LastDatePayPeriod < {curdate} ) )
        if (contr.rec.Discount != 100)
          msgbox("Не оплачена аренда. Продление/пролонгация договора невозможна");
          status = false;
        end;
      end;
    end;
    
    return status;
  end;

  macro runPanel()      /* Запуск панели операции */
    operationObj.newAddAgreement();
    return operationObj.panel.use();
  end;


  macro CreateDocForCell( branch, safeid, cellnumber )
    record Parm(CashParm);
    var dsdoc;
    var NumKeys = 0;
  /* Возврат ключей */
    NumKeys = GetNumOfKeys( branch, SafeID, CellNumber);
    if( ( NumKeys > 0 ) and ({MakeDeskDocs}) )
      ClearRecord( Parm );
      Parm.TypeValue = TYPERES_KEY;
      Parm.CodIntValue = VALFORM_KEY;
      Parm.Oper = operationObj.oper;
      Parm.CashDateDoc = operationObj.OperationDate;
      Parm.ValueCol = NumKeys;
      Parm.OperPatern = Parm.Oper;
      Parm.Type = 0;                /* Платежеспосбные ресурсы */
      Parm.NumOper = CASHOP_CREDIT; /* Возврат в банк */
      Parm.ApplicationKind = SB_SAFECELLS;
      Parm.ApplicationKey = FormApplicationKey( Parm.ApplicationKind );
      operationObj.newCashDoc( Parm );

      StoreValue("doc:Ресурс@КодГлавного@Приход", Код_ресурса_ключ_от_сейфовой_ячейки(TYPERES_KEY, VALFORM_KEY, 0, "t_GroupValue"));
      StoreValue("doc:КоличКлючей@Приход", NumKeys + RetrieveValue("doc:КоличКлючей@Приход"));

      dsDoc = operationObj.newDsDoc(8);
      if(not operationObj.multipleClients)
        dsDoc.rec.ClientCode = operationObj.clientCode;
      end;
      dsDoc.rec.OpSafeID = safeid;
      dsDoc.rec.OpCellNumber = cellnumber;
      dsDoc.rec.ApplicationKind = Parm.ApplicationKind;
      dsDoc.rec.ApplicationKey = Parm.ApplicationKey;
      dsDoc.rec.InSum = NumKeys;
      operationObj.docList.insert(dsDoc);
    end;
  end;


  macro createDocuments()
    var dsDoc,payDoc,depDoc,contr;
    var RepDate, EndDate;
    var penaltyNDS=$0, penaltyWithoutNDS=$0;

    contr = operationObj.contract;
    dsDoc = operationObj.newDsDoc(1);
    operationObj.AddAgreement.SetAddAgreementDoc( dsDoc );

    if( operationObj.opNumber == OP_PROLONG )
      operationObj.AddAgreement.rec.BeginDate = contr.rec.EndDate + 1;
    else
      operationObj.AddAgreement.rec.BeginDate = contr.rec.OpenDate;
    end;   
    
    operationObj.AddAgreement.rec.EndDate = operationObj.NewEndProlongDate;
    
    dsDoc.rec.OldTermType = contr.rec.TermType;
    dsDoc.rec.OldTermValue = contr.rec.TermValue;
    dsDoc.rec.OldTermTail = contr.rec.TermTail;
    dsDoc.rec.OldBeginDate = contr.rec.OpenDate;
    dsDoc.rec.OldEndDate = contr.rec.EndDate;
    dsDoc.rec.OldProlongDate = contr.rec.ProlongDate;
    dsdoc.rec.OldGrntSum = OldGrntSum; //contr.rec.GrntSum;
    dsDoc.rec.PmntClient    = operationObj.pmntClient;
    dsDoc.rec.PmntSum       = operationObj.pmntSum;
    dsDoc.rec.NdsSum        = operationObj.pmntNds;
    
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;
    dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
    operationObj.docList.insert(dsDoc);

/* Заполнение записи договора новыми сроками */
    contr.rec.TermType   =  operationObj.AddAgreement.rec.NewTermType;
    contr.rec.TermValue  =  operationObj.AddAgreement.rec.NewTermValue;
    contr.rec.TermTail   =  operationObj.AddAgreement.rec.NewTermTail;
    contr.rec.ProlongDate =  contr.rec.EndDate+1;
    contr.rec.EndDate = operationObj.NewEndProlongDate;

/* Взятие штрафа за просрочку */
    if(operationObj.expPnltSum>0)
      dsDoc = operationObj.newDsDoc(2);
      penaltyNDS = round(operationObj.expPnltSum*NDS/(100+NDS),2);
      penaltyWithoutNDS = operationObj.expPnltSum - penaltyNDS;

      dsDoc.rec.InSum = penaltyWithoutNDS;
      dsDoc.rec.NdsSum = penaltyNDS;
      dsDoc.rec.CurrCode = operationObj.expPnltCurrCode;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.expPnltClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      dsDoc.rec.Ground = "Штраф за просрочку аренды " + (dsDoc.rec.InSum+dsDoc.rec.NdsSum) + " руб. (в т.ч. НДС " + dsDoc.rec.NdsSum + " руб. )";
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Валюта@Просрочка", dsDoc.rec.CurrCode);
      StoreValue("doc:Сумма@Просрочка", dsDoc.rec.InSum);

      if( operationObj.expPnltIsNonCash != DSPM_PUT )        
        if (operationObj.expPnltIsNonCash == DSPM_CASHLESS)
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          if( contr.rec.GuaranteeAccount != "" )
            payDoc.rec.PayAcc = contr.rec.GuaranteeAccount;
          end;
          payDoc.setVarPartFormat("pay_doc.ds");
          payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
          if (operationObj.isAddAgrmntInited)
            payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
          else
            payDoc.varPart.rec.AddAgrmntID = 0;
          end;
          payDoc.varPart.rec.StepNumber = 2;
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;

/* Залог */                                   
    if(operationObj.grntSum)
      dsDoc = operationObj.newDsDoc(3);
      if(operationObj.grntSum > 0)
        dsDoc.rec.InSum = operationObj.grntSum;
      else
        dsDoc.rec.OutSum = abs(operationObj.grntSum);
      end;
      dsDoc.rec.CurrCode = operationObj.grntCurrCode;
      if( operationObj.grntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.guaranteer;
      dsDoc.rec.Referenc = operationObj.grntFromAccount;
      dsDoc.rec.Ground = CreateGround(contr.rec.Number, dsDoc.rec.OpCellNumber, "");
      operationObj.docList.insert(dsDoc);

      contr.rec.Guaranteer = operationObj.guaranteer;
      contr.rec.GrntReferenc = operationObj.grntFromAccount;

      if( operationObj.grntIsNonCash != DSPM_PUT )
        if( (operationObj.grntIsNonCash == DSPM_CASHLESS) and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          if( contr.rec.GuaranteeAccount != "" )
            payDoc.rec.PayAcc = contr.rec.GuaranteeAccount;
          end;
          operationObj.docList.insert(payDoc);
        end;
      end;

      StoreValue("doc:Валюта@Залог", dsDoc.rec.CurrCode);
      if (dsDoc.rec.InSum > 0)
        StoreValue("doc:Сумма@Залог", dsDoc.rec.InSum);
      else
        StoreValue("doc:Сумма@ВозвратЗалога", dsDoc.rec.OutSum);
      end;
    end;
/* Взятие НДС */
    if(penaltyNDS>0)
      dsDoc = operationObj.newDsDoc(4);
      dsDoc.rec.InSum = penaltyNDS;
      dsDoc.rec.CurrCode = operationObj.pmntCurrCode;
      dsDoc.rec.NdsSum = operationObj.pmntNds;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Сумма@ПросрочкаНДС", dsDoc.rec.InSum);

      if (operationObj.expPnltIsNonCash != DSPM_PUT)
        if (operationObj.expPnltIsNonCash == DSPM_CASHLESS)
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          payDoc.setVarPartFormat("pay_doc.ds");
          payDoc.varPart.rec.ContractID = contr.rec.ContractID;
          if (operationObj.isAddAgrmntInited)
            payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
          else
            payDoc.varPart.rec.AddAgrmntID = 0;
          end;
          payDoc.varPart.rec.StepNumber = 2; /*Здесь именно 2, а не 4*/
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;

    if (operationObj.forfeitSum > 0)
      // 5 - Неустойка за нарушение договора
      dsDoc = operationObj.newDsDoc(5);
      penaltyNDS = round(operationObj.ForfeitSum*NDS/(100+NDS),2);
      penaltyWithoutNDS = operationObj.ForfeitSum - penaltyNDS;
      dsDoc.rec.InSum = penaltyWithoutNDS;
      dsDoc.rec.NdsSum = penaltyNDS;
      dsDoc.rec.CurrCode = operationObj.forfeitCurrCode;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.expPnltClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      dsDoc.rec.Ground = "Неустойка за нарушение договорных обязательств " + (dsDoc.rec.InSum+dsDoc.rec.NdsSum) + " руб. (в т.ч. НДС " + dsDoc.rec.NdsSum + " руб.)";
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Валюта@Неустойка", dsDoc.rec.CurrCode);
      StoreValue("doc:Сумма@Неустойка", dsDoc.rec.InSum);

      if( operationObj.expPnltIsNonCash != DSPM_PUT )
        if (operationObj.expPnltIsNonCash == DSPM_CASHLESS)
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          if( contr.rec.GuaranteeAccount != "" )
            payDoc.rec.PayAcc = contr.rec.GuaranteeAccount;
          end;
          payDoc.setVarPartFormat("pay_doc.ds");
          payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
          if (operationObj.isAddAgrmntInited)
            payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
          else
            payDoc.varPart.rec.AddAgrmntID = 0;
          end;
          payDoc.varPart.rec.StepNumber = 5;
          operationObj.docList.insert(payDoc);
        end;
      end;

      // 6 - НДС. Неустойка за нарушение договора
      dsDoc = operationObj.newDsDoc(6);
      dsDoc.rec.InSum = penaltyNDS;
      dsDoc.rec.CurrCode = operationObj.forfeitCurrCode;
      if( operationObj.expPnltIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.expPnltClient;
      dsDoc.rec.Referenc = operationObj.expPnltFromAccount;
      operationObj.docList.insert(dsDoc);

      StoreValue("doc:Сумма@НеустойкаНДС", dsDoc.rec.InSum);

      if( operationObj.expPnltIsNonCash != DSPM_PUT )
        if (operationObj.expPnltIsNonCash == DSPM_CASHLESS)
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          if( contr.rec.GuaranteeAccount != "" )
            payDoc.rec.PayAcc = contr.rec.GuaranteeAccount;
          end;
          payDoc.setVarPartFormat("pay_doc.ds");
          payDoc.varPart.rec.ContractID = contr.rec.ContractID;         
          if (operationObj.isAddAgrmntInited)
            payDoc.varPart.rec.AddAgrmntID = operationObj.AddAgreement.rec.AddAgrmntID;
          else
            payDoc.varPart.rec.AddAgrmntID = 0;
          end;
          payDoc.varPart.rec.StepNumber = 5; /* Тут именно 5, а не 6 */
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;

/* Взятие НДС */
    /*if(operationObj.nds)
      dsDoc = operationObj.newDsDoc(5);
      if(operationObj.nds > 0)
        dsDoc.rec.InSum = operationObj.nds;
      else
        dsDoc.rec.OutSum = abs(operationObj.nds);
      end;
      dsDoc.rec.CurrCode = NATIONAL_CURR;
      if( operationObj.pmntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      if( operationObj.pmntIsNonCash != DSPM_PUT )
        if( (operationObj.pmntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;*/
/* Взятие НcП */
    /*if(operationObj.salesTax)
      dsDoc = operationObj.newDsDoc(6);
      if(operationObj.salesTax > 0)
        dsDoc.rec.InSum = operationObj.salesTax;
      else
        dsDoc.rec.OutSum = abs(operationObj.salesTax);
      end;
      dsDoc.rec.CurrCode = NATIONAL_CURR;
      if( operationObj.pmntIsNonCash == DSPM_CASHLESS )
        dsDoc.rec.CashFlag = "X";
      else
        dsDoc.rec.CashFlag = "";
      end;
      dsDoc.rec.ClientCode = operationObj.pmntClient;
      dsDoc.rec.Referenc = operationObj.pmntFromAccount;
      operationObj.docList.insert(dsDoc);

      if( operationObj.pmntIsNonCash != DSPM_PUT )
        if( (operationObj.pmntIsNonCash == DSPM_CASHLESS)  and (operationObj.contractClientType != CT_LEGAL) )
          depDoc = operationObj.newDepDoc(dsDoc);
          operationObj.docList.insert(depDoc);
        else
          payDoc = operationObj.newPayDoc(dsDoc);
          operationObj.docList.insert(payDoc);
        end;
      end;
    end;*/

  operationObj.runNestedDSOperation(7);

/* Отражение платы на доходах банка */
    /*dsDoc = operationObj.newDsDoc(7);
    if(not operationObj.multipleClients)
      dsDoc.rec.ClientCode = operationObj.clientCode;
    end;
    operationObj.docList.insert(dsDoc);
    RepDate = GetReportDate( GetClientType(contr.rec.ContrTypeID), {curdate} );
    if( RepDate <= {curdate} )
      payDoc = operationObj.newAccrPayDoc(dsDoc);
      if( ValType(payDoc) != V_UNDEF )
        payDoc.varPart.rec.StartDate = dsDoc.rec.PayStartDate;
        EndDate = GetDateEnd( GetClientType(contr.rec.ContrTypeID), {curdate} );
        if( EndDate < dsDoc.rec.PayEndDate )
          payDoc.varPart.rec.EndDate = EndDate;
  else
          payDoc.varPart.rec.EndDate = dsDoc.rec.PayEndDate;
  end;
  payDoc.rec.InSum = dsDoc.rec.InSum * (double(GetNumDaysBetwen2Dates(payDoc.varPart.rec.StartDate, payDoc.varPart.rec.EndDate))/double(GetNumDaysBetwen2Dates(dsDoc.rec.PayStartDate, dsDoc.rec.PayEndDate)));
  payDoc.rec.NDSSum = dsDoc.rec.NdsSum * (double(GetNumDaysBetwen2Dates(payDoc.varPart.rec.StartDate, payDoc.varPart.rec.EndDate))/double(GetNumDaysBetwen2Dates(dsDoc.rec.PayStartDate, dsDoc.rec.PayEndDate)));
        operationObj.docList.insert(payDoc);
      else
        msgbox("Документ прочей операции не создан!");
      end;
    end;*/

/* Возврат ключей */
    /* Определяем количество ячеек для которых количество ключей больше 0 */
    var cellsWithKeys = 0;
    var cells = contr.CellList;
    var hasNext = cells.first();
    while (hasNext)
      if (cells.item.rec.isNeedCloseCell and (GetNumOfKeys(contr.rec.Branch, cells.item.rec.SafeID, cells.item.rec.CellNumber) > 0))
        cellsWithKeys = cellsWithKeys + 1;
      end;
      hasNext = cells.next();
    end;
    // если есть ячейки с ключами    
    if (cellsWithKeys > 0)
      if (not GetTrue(true, "Клиент возвращает ключи от ВСЕХ освобождаемых ячеек"))
        msgbox("Продление невозможно без возврата ключей");
        return false;
      end;

      hasNext = cells.first();
      while (hasNext)
        if (cells.item.rec.isNeedCloseCell and (GetNumOfKeys(contr.rec.Branch, cells.item.rec.SafeID, cells.item.rec.CellNumber) > 0))
          CreateDocForCell(contr.rec.Branch, cells.item.rec.SafeID, cells.item.rec.CellNumber);
        end;
        hasNext = cells.next();
      end;
    end;

    return true;
  end;

  InitTOperationExecutor( opObj );
end;
