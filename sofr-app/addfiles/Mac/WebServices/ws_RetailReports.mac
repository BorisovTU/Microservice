/*
$Name:               ws_RetailReports.mac
$Module:             WebEO
$Description:        web ®βη¥βλ retail etc.
*/
import DeprIntr, extract4, rstr113ibody, ws_ufo_classes, ws_utils, ws_file, rsd,"plan_trn.mac";

private macro HtmlStart( fileName )
  SetOutput( fileName + ".html", false );
  println( "<html>\n" + 
           "  <head>\n" +
           "    <meta http-equiv=\"Content-type\" CONTENT=\"text/html; charset=cp866\">\n" +
           "  </head>\n" +
           "  <body>\n" +
           "    <pre>\n" );
end;

private macro HtmlEnd

  println( "    </pre>\n" +
           "  </body>\n" +
           "</html>" );

  var prevName = SetOutput( null, true );
  var retVal = GetTextFile( prevName );
  DelFile( prevName );
  return retVal;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DepAccountExtract
(
  Referenc,
  DateFrom,
  DateTo,
  Client,
  FIO,
  isArchive
)
  var txtDir = GetRegVal( "BANK_INI\\™… €€…’›\\„…’\\TEXTDIR", true );
  var nameOut = ""; 
  var extNameOut = ""; 
  var retVal;
  var Date1, Date2;

  if ( SubStr( txtDir, StrLen( txtDir ), 1 ) != "\\" )
    txtDir = txtDir + "\\";
  end;

  nameOut = SetOutput( "TMP" );

  SplitFile( nameOut, null, extNameOut );

  nameOut = txtDir + "accextr" + extNameOut;

  HtmlStart( nameOut );

  DtTmSplit( DateFrom, Date1 );
  DtTmSplit( DateTo, Date2 );

  Extract( Referenc, Date1, Date2, Client, FIO, 1, isArchive );
             
  return HtmlEnd;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CurrencyReestr
(
  ReportDate,
  ReportOper
)
  var txtDir = GetRegVal( "BANK_INI\\™… €€…’›\\„…’\\TEXTDIR", true );
  var nameOut = ""; 
  var extNameOut = ""; 
  var retVal;
  var saveCurDate = GetCurDate( );

  if ( SubStr( txtDir, StrLen( txtDir ), 1 ) != "\\" )
    txtDir = txtDir + "\\";
  end;

  nameOut = SetOutput( "TMP" );

  SplitFile( nameOut, null, extNameOut );

  nameOut = txtDir + "currstr" + extNameOut;

  HtmlStart( nameOut );

  SetCurDate( ReportDate );

  PrintCurrReestr( ReportOper, ReportDate );

  SetCurDate( saveCurDate );
                
  return HtmlEnd;
end;
macro PrintPlanPay( ID  : integer  )
    var  dplanpay:Tbfile = TBFile("dplanpay.dbt");
    dplanpay.keynum = 3;
    dplanpay.rec.ref = Id;
    getEQ(dplanpay);

    var fileName = getTxtFileName( "PlanPayReport" );
    SetOutput(getTxtFileName(fileName));
    OpenDepFiles();
    Plan_Transfer(dplanpay,true);
    CloseDepFiles();

    setoutput( NULL, TRUE );
    fileName = ConvertTxt2Html ( fileName );
    return CreateFileContainer ( fileName ); 
end; 
