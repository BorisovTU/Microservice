/*
$Name:               ws_RetailDeposits.mac
$Module:             WebEO
$Description:        вклады retail etc.
*/
/*
*/

import ws_ufo_classes, ws_utils, rsd, ISSRVDOC, ic_comdata, rtutils, ws_datafilter, ws_orderbygen, deprintr, spCardInter,"trst_36.mac", ws_file,"print_trust.mac", "cpgiszkh.mac";
import ExchangeInter;
private const SB_WORKFLOW = "7000";
private const SB_DEPOSIT = "1";

private class RetOpState
  const OST_PUTOFF = 75;               // Отложенная операция
  const OST_FM_CONSIDERATION = 76;     // Операция отправлена на рассмотрение ФМ
  const OST_FM_VETO = 77;              // Операция запрещена ФМ к проводке
  const OST_FM_MANUAL_PROCESSING = 78; // Операция отправлена ФМ на ручную обработку
end;

private class OpContrCheckResult
  const OPCONTR_CHECK_OK         = 0; //  Выполнение операции разрешено                  
  const OPCONTR_CHECK_DEFER      = 1; //  Выполнение операции должно быть приостановлено 
  const OPCONTR_CHECK_STOP       = 2; //  Выполнение операции запрещено                  
  const OPCONTR_CHECK_FM_SUM     = 3; //  Сумма операция подпадает под условия ФМ
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro CharToBool(chr)
  if(strlen(chr))
    return true;
  else
    return false;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro FillPumpFields 
( 
  wsDepAccount : TWsDepAccount
)
  var cmd, rs;
  var name1, name2, name3;

  wsDepAccount.CurrencyCodeISO = "";
  wsDepAccount.ClientFIO = "";
  wsDepAccount.ClientFullFIO = "";

  cmd = RsdCommand( "select t_short_name as shortName from dcurrency_dbt where t_code_currency = ?" );

  cmd.AddParam( "codeCurrency", RSDBP_IN, wsDepAccount.CurrencyCode );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    wsDepAccount.CurrencyCodeISO = rs.value( "shortName" );
  end;

  cmd = RsdCommand( "select t_name1 as name1, t_name2 as name2, t_name3 as name3 from dpersn_dbt where t_personid = ?" );

  cmd.AddParam( "codeClient", RSDBP_IN, wsDepAccount.ClientCode );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    name1 = Trim( rs.value( "name1" ) );
    name2 = Trim( rs.value( "name2" ) );
    name3 = Trim( rs.value( "name3" ) );

    if ( name1 != "" )
      wsDepAccount.ClientFIO = name1;
      wsDepAccount.ClientFullFIO = name1;

      if ( name2 != "" )
        wsDepAccount.ClientFIO = wsDepAccount.ClientFIO + " " + SubStr( name2, 1, 1 ) + ".";
        wsDepAccount.ClientFullFIO = wsDepAccount.ClientFullFIO + " " + name2;

        if ( name3 != "" )
          wsDepAccount.ClientFIO = wsDepAccount.ClientFIO + SubStr( name3, 1, 1 ) + ".";
          wsDepAccount.ClientFullFIO = wsDepAccount.ClientFullFIO + " " + name3;
        end;
      end;
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetDepositAccount
(
  refAcc : integer
)
  var cmd, rs;
  var value = TWsDepAccount( );

  if ( ( ValType( refAcc ) != V_INTEGER ) or ( refAcc == 0 ) ) 
    runError( "Не задан счет вкладчика", 4848 );
  end;

  cmd = RsdCommand( "select * from ddepositr_dbt where t_referenc = ?" );

  cmd.AddParam( "Reference", RSDBP_IN, refAcc );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    value.Reference     = rs.value( "t_Referenc" );
    value.AccountNumber = rs.value( "t_Account" );
    value.CurrencyCode  = rs.value( "t_Code_Currency" );
    value.ClientCode    = rs.value( "t_CodClient" );
    value.Branch        = rs.value( "t_FNCash" );
    value.AccountType   = rs.value( "t_Type_Account" );
    value.OpenDate      = rs.value( "t_Open_Date" );
    value.CloseDate     = rs.value( "t_Close_Date" );

    FillPumpFields( value );
  else
    runError( "Счет не найден", 8524 );
  end;

  return value;

  // onError( e )
  //   println( e );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindDepositAccount
(
  numberAccount : string
)
  var cmd, rs;
  var value = TWsDepAccount( );
  var counter = 0;
  
  if ( ( ValType( numberAccount ) != V_STRING ) or ( numberAccount == "" ) ) 
    return null;
  end;

  cmd = RsdCommand( "select * from ddepositr_dbt where t_account = ?" );

  cmd.AddParam( "Account", RSDBP_IN, numberAccount );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  while ( rs.moveNext )
    counter = counter + 1;

    if ( counter == 1 )
      value.Reference     = rs.value( "t_Referenc" );
      value.AccountNumber = rs.value( "t_Account" );
      value.CurrencyCode  = rs.value( "t_Code_Currency" );
      value.ClientCode    = rs.value( "t_CodClient" );
      value.Branch        = rs.value( "t_FNCash" );
      value.AccountType   = rs.value( "t_Type_Account" );
      value.OpenDate      = rs.value( "t_Open_Date" );
      value.CloseDate     = rs.value( "t_Close_Date" );

      FillPumpFields( value );
    else
      break;
    end;
  end;

  if ( counter == 0 )
    return null;
  end;

  if ( counter > 1 )
    runError( "Найдено несколько счетов по заданному номеру счета" );
  end;

  return value;

  // onError( e )
  //   println( e );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetDepAccList
(
  clientCode,
  currencyCode,
  openClose,
  dprtCode,
  accountType,
  excludedReference,
  pageNumber,
  pageSize,
  FilterItems,
  OrderItems
)
  var value = TArray;
  var cmd, rs;
  var depAcc;
  var name1, name2, name3;
  var strCommand;

  if ( currencyCode > -1 )
	  strCommand = " SELECT   cur.t_code_currency  FROM dfininstr_dbt fi, dcurrency_dbt cur WHERE fi.t_fiid=? and cur.t_externalcode = fi.t_fi_code " ;
	  cmd = RsdCommand( strCommand );

	  cmd.addParam( "", RSDBP_IN, currencyCode );
	  
	  cmd.execute;

	  rs = RsdRecordSet( cmd );

	 if ( rs.moveNext )
		  currencyCode = rs.value("t_code_currency");
	  end;

  end;
  
  strCommand = "select dr.t_Referenc as Referenc, dr.t_Account as Account, dr.t_Code_Currency as Code_Currency, dr.t_CodClient as CodClient, " + 
                      "dr.t_FNCash as FNCash, dr.t_Type_Account as Type_Account, dr.t_Open_Date as Open_Date, dr.t_Close_Date as Close_Date, " + 
                      "currency.t_Short_Name as Short_Name, " + 
                      "persn.t_Name1 as Name1, persn.t_Name2 as Name2, persn.t_Name3 as Name3 " + 
               "from ddepositr_dbt dr, dcurrency_dbt currency, dpersn_dbt persn " +
               "where dr.t_Type_Account != 'Служебный' and " +
                     "dr.t_Type_Account != 'Неподвижный' and " +
                     "dr.t_Type_Account != 'Объединенный' and " +
                     "dr.t_Action != 2 and " +  // D_DELETE
                     "dr.t_Action != 11 and " + // D_STORN
                     "currency.t_Code_Currency = dr.t_Code_Currency and " +
                     "persn.t_personid = dr.t_CodClient";

  if ( clientCode > 0 )
    strCommand = strCommand + " and dr.t_CodClient = " + String( clientCode );
  end;

  if ( currencyCode > -1 )
    strCommand = strCommand + " and dr.t_Code_Currency = " + String( currencyCode );
  end;

  if ( openClose == 0 )
    strCommand = strCommand + " and dr.t_Open_Close = chr( 0 )";
  elif ( openClose == 1 )
    strCommand = strCommand + " and dr.t_Open_Close != chr( 0 )";
  end;

  if (dprtCode > 0)
	  strCommand = strCommand + " and dr.t_FNCash = " + String( dprtCode );
  end;
  
  if (accountType != "")
	  strCommand = strCommand + " and dr.t_type_account = '" + String( accountType ) + "' ";
  end;

  if (excludedReference > 0)
    strCommand = strCommand + " and dr.t_referenc <> " + String( excludedReference );
  end;
  
  if ((FilterItems != null) AND (FilterItems.Size > 0))
	  var FilterItemsCount = 0;
	  while( FilterItemsCount < FilterItems.Size )
		
		if (FilterItems[FilterItemsCount].id == 0)
			strCommand = strCommand + " and dr.t_CodClient " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + FilterItems[FilterItemsCount].Value[0].Partyid;
		elif (FilterItems[FilterItemsCount].id == 1)
			strCommand = strCommand + " and dr.t_type_account " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + " '" + FilterItems[FilterItemsCount].Value[0].Kind + "' ";
		elif (FilterItems[FilterItemsCount].id == 2)
			strCommand = strCommand + " and dr.t_FNCash " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + FilterItems[FilterItemsCount].Value[0].Code;
		elif ((FilterItems[FilterItemsCount].id == 3) AND (FilterItems[FilterItemsCount].Value[0].ID > -1))
			strCommand = strCommand + " and dr.t_Code_Currency " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + FilterItems[FilterItemsCount].Value[0].ID;
		end;
		FilterItemsCount = FilterItemsCount + 1;
	  
	  end;
  end;
  
  strCommand = SQL_WrapSelect(strCommand, pageNumber, pageSize);
  
  cmd = RsdCommand( strCommand );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  while ( rs.moveNext )
    depAcc = TWsDepAccount( );

    depAcc.Reference       	= rs.value( "Referenc" );
    depAcc.AccountNumber = rs.value( "Account" );
    depAcc.CurrencyCode   = rs.value( "Code_Currency" );
    depAcc.ClientCode      	= rs.value( "CodClient" );
    depAcc.Branch          		= rs.value( "FNCash" );
    depAcc.AccountType		= rs.value( "Type_Account" );
    depAcc.OpenDate        	= rs.value( "Open_Date" );
    depAcc.CloseDate       	= rs.value( "Close_Date" );

    if ( ValType( rs.value( "Short_Name" ) ) == V_STRING )
      depAcc.CurrencyCodeISO = rs.value( "Short_Name" );
    else
      depAcc.CurrencyCodeISO = "";
    end;

    if ( ValType( rs.value( "Name1" ) ) == V_STRING )
      name1 = rs.value( "Name1" );
    else
      name1 = "";
    end;

    if ( ValType( rs.value( "Name2" ) ) == V_STRING )
      name2 = rs.value( "Name2" );
    else
      name2 = "";
    end;

    if ( ValType( rs.value( "Name3" ) ) == V_STRING )
      name3 = rs.value( "Name3" );
    else
      name3 = "";
    end;

    if ( name1 != "" )
      depAcc.ClientFIO = name1;
      depAcc.ClientFullFIO = name1;

      if ( name2 != "" )
        depAcc.ClientFIO = depAcc.ClientFIO + " " + SubStr( name2, 1, 1 ) + ".";
        depAcc.ClientFullFIO = depAcc.ClientFullFIO + " " + name2;

        if ( name3 != "" )
          depAcc.ClientFIO = depAcc.ClientFIO + SubStr( name3, 1, 1 ) + ".";
          depAcc.ClientFullFIO = depAcc.ClientFullFIO + " " + name3;
        end;
      end;
    end;

    value[value.Size] = depAcc;
  end;

  return value;
end;

macro GetDepAccListCount
(
  clientCode,
  currencyCode,
  openClose,
  dprtCode,
  accountType,
  excludedReference,
  pageNumber,
  pageSize,
  FilterItems,
  OrderItems
)
 var value = TArray;
  var cmd, rs;
  var depAcc;
  var name1, name2, name3;
  var strCommand;

  if ( currencyCode > -1 )
	  strCommand = " SELECT   cur.t_code_currency  FROM dfininstr_dbt fi, dcurrency_dbt cur WHERE fi.t_fiid=? and cur.t_externalcode = fi.t_fi_code " ;
	  cmd = RsdCommand( strCommand );

	  cmd.addParam( "", RSDBP_IN, currencyCode );
	  
	  cmd.execute;

	  rs = RsdRecordSet( cmd );

	 if ( rs.moveNext )
		  currencyCode = rs.value("t_code_currency");
	  end;

  end;
  
  strCommand = " select COUNT(1) Count " + 
               " from ddepositr_dbt dr, dcurrency_dbt currency, dpersn_dbt persn " +
               " where dr.t_Type_Account != 'Служебный' and " +
                     "dr.t_Type_Account != 'Неподвижный' and " +
                     "dr.t_Type_Account != 'Объединенный' and " +
                     "dr.t_Action != 2 and " +  // D_DELETE
                     "dr.t_Action != 11 and " + // D_STORN
                     "currency.t_Code_Currency = dr.t_Code_Currency and " +
                     "persn.t_personid = dr.t_CodClient";

  if ( clientCode > 0 )
    strCommand = strCommand + " and dr.t_CodClient = " + String( clientCode );
  end;

  if ( currencyCode > -1 )
    strCommand = strCommand + " and dr.t_Code_Currency = " + String( currencyCode );
  end;

  if ( openClose == 0 )
    strCommand = strCommand + " and dr.t_Open_Close = chr( 0 )";
  elif ( openClose == 1 )
    strCommand = strCommand + " and dr.t_Open_Close != chr( 0 )";
  end;

  if (dprtCode > 0)
	  strCommand = strCommand + " and dr.t_FNCash = " + String( dprtCode );
  end;
  
  if (accountType != "")
	  strCommand = strCommand + " and dr.t_type_account = '" + String( accountType ) + "' ";
  end;

  if (excludedReference > 0)
    strCommand = strCommand + " and dr.t_referenc <> " + String( excludedReference );
  end;
  
  if ((FilterItems != null) AND (FilterItems.Size > 0))
	  var FilterItemsCount = 0;
	  while( FilterItemsCount < FilterItems.Size )
		
		if (FilterItems[FilterItemsCount].id == 0)
			strCommand = strCommand + " and dr.t_CodClient " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + FilterItems[FilterItemsCount].Value[0].Partyid;
		elif (FilterItems[FilterItemsCount].id == 1)
			strCommand = strCommand + " and dr.t_type_account " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + " '" + FilterItems[FilterItemsCount].Value[0].Kind + "' ";
		elif (FilterItems[FilterItemsCount].id == 2)
			strCommand = strCommand + " and dr.t_FNCash " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + FilterItems[FilterItemsCount].Value[0].Code;
		elif ((FilterItems[FilterItemsCount].id == 3) AND (FilterItems[FilterItemsCount].Value[0].ID > -1))
			strCommand = strCommand + " and dr.t_Code_Currency " + IIF( FilterItems[FilterItemsCount].IsNot == false, " = ", " != ") + FilterItems[FilterItemsCount].Value[0].ID;
		end;
		FilterItemsCount = FilterItemsCount + 1;
	  
	  end;
  end;
   
  cmd = RsdCommand( strCommand );

  cmd.execute;

  rs = RsdRecordSet( cmd );

  var count: integer;
  count = 0;
  
  if ( rs.moveNext )
	  count = rs.value("Count");
  end;

  return count;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro GetVidDocCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String

  var strSQLCond : String = "NVL( depdoc.t_viddoc, 0) = " + value[0];

  return strSQLCond;
end;

private macro GetNotConfirmCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String

  var strSQLCond : String = "NVL( depdoc.t_NotConfirm, chr(0) ) " + IIF( value[0], "!= chr(0)", "= chr(0)" );

  return strSQLCond;
end;

private macro GetOperHistListFilterCondition(
  FilterItems:TArray, id: integer
):String

  var fp = FilterParser( FilterItems );

  if (id == 0 )
    fp.AddFieldCondition( 0, "depdoc", "t_Date_Document" );
    fp.AddFieldCondition( 1, "depdoc", "t_VidDoc" );
    fp.AddUserFieldCondition( 2, @GetNotConfirmCondition);
    fp.AddFieldCondition( 3, "depdoc", "t_Ground " );
  else
    fp.AddFieldCondition( 0, "sccrddoc", "t_Date" );
    fp.AddUserFieldCondition( 1, @GetVidDocCondition);
    fp.AddUserFieldCondition( 2, @GetNotConfirmCondition);
    fp.AddFieldCondition( 3, "sccrddoc", "t_Ground " );
  end;

  return fp.GetFullSQLCondition();
end;

macro TWsOperHistoryListElement_AddChildren(parent:TWsOperHistoryListElement ,children:TWsOperHistoryListElement)
    if(not ValType(parent.Children)) parent.Children = Tarray();    
    end;  
    parent.Children[parent.Children.size] = children;  
    parent.InSum           = parent.InSum  + children.InSum;
    parent.OutSum          = parent.OutSum + children.OutSum;
    if(parent.NumDayDoc <= children.NumDayDoc)
        parent.Rest = children.rest;
    end;

end;

macro TWsOperHistoryListElement_AddToTree(list:Tarray,obj:TWsOperHistoryListElement)
    var i = 0 ;
    // найдем родительскую запись действия 
    while (i < list.size ) 
        if((obj.OperationKind == list[i].OperationKind) AND  (obj.OperationKey  == list[i].OperationKey))
           TWsOperHistoryListElement_AddChildren(list[i],obj);
           return ;
        end;
        i = i + 1;
    end;
    // если не нашли, добавим в список родительское

    var parent             = TWsOperHistoryListElement;
    parent.OperationName   = obj.OperationName;
    parent.Ground          = obj.OperationName;
    parent.OperationKind   = obj.OperationKind; 
    parent.OperationKey    = obj.OperationKey;
    parent.ApplicationKey  = obj.OperationKey;
    parent.ApplicationKind = obj.OperationKind;
    parent.Oper =  obj.Oper;
    parent.OperName =  obj.OperName;
    parent.Purpose =  obj.Purpose;
    parent.ClientName =  obj.ClientName;
    parent.ClientRole =  obj.ClientRole;
    parent.NumDayDoc = obj.NumDayDoc;

    var cmd = RsdCommand("Select* from dret_op_dbt r " +
                         "where r.T_APPLICATIONKIND = ? AND " + 
                         "r.T_APPLICATIONKEY = ?"); 

    var ret_op = RsdRecordSet( cmd );
    cmd.AddParam( "ApplicationKind", RSDBP_IN, obj.OperationKind );
    cmd.AddParam( "ApplicationKey" , RSDBP_IN, obj.OperationKey  );
    cmd.execute();
    if ( ret_op.moveNext() )
    
        parent.Date_Operation  = SQL_ConvTypeDate(ret_op.value("t_Date"));
        parent.Date_Document   = parent.Date_Operation ;
        if(ret_op.value("t_State")==50)  parent.NotConfirm   =  true;
        else                             parent.NotConfirm   = false;
        end;
    end;
    
    list[list.size] = parent;
    TWsOperHistoryListElement_AddChildren(list[list.size-1],obj);
    return;
end;
/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro getOperHistoryList
(
  objectType: integer,
  objectID  : string,
  TreeMode  :bool,
  pageNumber : integer,
  pageSize : integer,     
  filterList : TArray,    
  orderList : TArray     
)
  var cmd, rs, cmdIn, rsIn;
  var result = TArray;
  var query: string;
  var strAddWhere: string;
  var purposeNumber;
  var ClientCode;
 
  if ( ( ValType( objectID ) != V_STRING ) or ( objectID == "" ) ) 
    runError( "Не задан счет", 4848 );
  end;

  if ( objectType == 551 )
    query = "SELECT depdoc.*,l.T_APPLICATIONKIND1,l.T_APPLICATIONKEY1 FROM dsbdepdoc_dbt depdoc,  dsb_casln_dbt l "    + 
             "WHERE l.T_APPLICATIONKEY2 = depdoc.t_ApplicationKey and l.T_APPLICATIONKIND2 = depdoc.t_IApplicationKind and l.T_REFVALUE2 = 0 " +
             "AND l.T_REFVALUE2 = 0 AND depdoc.t_referenc = :Ref and depdoc.t_issuspended != chr(70) and " + IsServ_const;
 
    strAddWhere = GetOperHistListFilterCondition( filterList, 0 );
    if( strAddWhere != "" )  query = query + " AND " + strAddWhere;
    end;

    query = query + " ORDER BY " + SP_GetSortStr(orderList, "depdoc.t_date_document DESC");

    query = SQL_WrapSelect(query, pageNumber, pageSize);

    cmd = RsdCommand( query );

    cmd.nullConversion = true;

    cmd.AddParam( "Ref", RSDBP_IN, objectID );
    cmd.execute;

    rs = RsdRecordSet( cmd );

    while ( rs.moveNext )
      var itemDepDoc = TWsOperHistoryListElement;
      itemDepDoc.ApplicationKind = SQL_ConvTypeInteger( rs.value( "t_IApplicationKind" ) );
      itemDepDoc.ApplicationKey  = SQL_ConvTypeStr ( rs.value( "t_ApplicationKey" ) );
      itemDepDoc.Date_Operation  = SQL_ConvTypeDate( rs.value( "t_depdate_document" ) );
      itemDepDoc.Date_Document   = SQL_ConvTypeDate( rs.value( "t_Date_Document" ) );
      itemDepDoc.OperationKey    = SQL_ConvTypeStr(rs.value("t_ApplicationKey1"));
      itemDepDoc.OperationKind   = SQL_ConvTypeInteger(rs.value("t_ApplicationKind1"));
      itemDepDoc.NumDayDoc       = SQL_ConvTypeInteger(rs.value("t_NumDayDoc"));
      var cmd_casln = RsdCommand("SELECT* FROM dsb_casln_dbt LN where");

      cmdIn = RsdCommand( "SELECT PRCDEF.T_NAME FROM dwf_process_dbt prc, dwf_procdef_dbt prcdef " +
                          "WHERE prc.t_id IN " +
                                            "(SELECT  obj.t_objectRef FROM dopobject_dbt obj " +
                                            " WHERE  obj.t_opAppKind = ? AND obj.t_opAppKey =  ?  and  obj.t_objectType = ?) " +
                                            " AND PRCDEF.T_ID = PRC.T_DEFINITIONID" );

      cmdIn.AddParam( "ApplicationKind", RSDBP_IN, itemDepDoc.OperationKind );
      cmdIn.AddParam( "ApplicationKey" , RSDBP_IN, itemDepDoc.OperationKey );
      cmdIn.AddParam( "SB_WORKFLOW"    , RSDBP_IN, SB_WORKFLOW );
      cmdIn.execute;
      rsIn = RsdRecordSet( cmdIn );
      if ( rsIn.moveNext )
        itemDepDoc.OperationName = SQL_ConvTypeStr( rsIn.value( "T_NAME" ) );
        itemDepDoc.OperationNumber = -1;
      else
        cmdIn = RsdCommand( "SELECT t_cznamealg FROM dsb_typop_dbt WHERE t_iscur = ? AND t_kind = ? AND t_numopert = ?" );
        cmdIn.AddParam( "IsCur", RSDBP_IN, rs.value( "t_IsCur" ) );
        cmdIn.AddParam( "Kind", RSDBP_IN, rs.value( "t_Type_Account" ) );
        cmdIn.AddParam( "NumOpert", RSDBP_IN, rs.value( "t_TypeComplexOper" ) );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemDepDoc.OperationName = SQL_ConvTypeStr( rsIn.value( "t_cznamealg" ) );
          itemDepDoc.OperationNumber = SQL_ConvTypeInteger( rs.value( "t_TypeComplexOper" ) );
        else
          itemDepDoc.OperationName = "";
          itemDepDoc.OperationNumber = 0;
          cmdIn = RsdCommand( "SELECT t_cznamealg FROM dsb_typop_dbt WHERE t_iscur = ? AND t_kind = ? AND t_numopert = ?" );
          cmdIn.AddParam( "IsCur", RSDBP_IN, rs.value( "t_IsCur" ) );
          cmdIn.AddParam( "Kind", RSDBP_IN, "Шаблонный" );
          cmdIn.AddParam( "NumOpert", RSDBP_IN, rs.value( "t_TypeComplexOper" ) );
          cmdIn.execute;
          rsIn = RsdRecordSet( cmdIn );
          if ( rsIn.moveNext )
              itemDepDoc.OperationName = rsIn.value( "t_cznamealg" );
              itemDepDoc.OperationNumber = rs.value( "t_TypeComplexOper" );
          end;
         end;
      end;

      itemDepDoc.VidDoc = SQL_ConvTypeInteger( rs.value( "t_viddoc" ) );
      itemDepDoc.DocTypeOper = SQL_ConvTypeInteger( rs.value( "t_TypeOper" ) );
      
      cmdIn = RsdCommand( "SELECT t_cznamealg FROM dsb_typop_dbt WHERE t_iscur = ? AND t_kind = ? " +
            "AND t_numopert = ?" );
      cmdIn.AddParam( "IsCur", RSDBP_IN, rs.value( "t_IsCur" ) );
      cmdIn.AddParam( "Kind", RSDBP_IN, rs.value( "t_Type_Account" ) );
      cmdIn.AddParam( "NumOpert", RSDBP_IN, rs.value( "t_TypeOper" ) );
      cmdIn.execute;
      rsIn = RsdRecordSet( cmdIn );
      if ( rsIn.moveNext )
        itemDepDoc.DocTypeOperName = SQL_ConvTypeStr( rsIn.value( "t_cznamealg" ) );
      end;

      itemDepDoc.InSum = SQL_ConvTypeSum( rs.value( "t_InSum" ) );
      itemDepDoc.OutSum = SQL_ConvTypeSum( rs.value( "t_OutSum" ) );
      itemDepDoc.Rest = SQL_ConvTypeSum( rs.value( "t_Rest" ) );
      itemDepDoc.Oper = SQL_ConvTypeInteger( rs.value( "t_Oper" ) );

      cmdIn = RsdCommand( "SELECT t_name FROM dperson_dbt WHERE t_oper = ?" );
      cmdIn.AddParam( "Oper", RSDBP_IN, itemDepDoc.Oper );
      cmdIn.execute;
      rsIn = RsdRecordSet( cmdIn );
      if ( rsIn.moveNext )
        itemDepDoc.OperName = SQL_ConvTypeStr( rsIn.value( "t_name" ) );
      end;

      // Установку признака NotConfirm берем из изивина
      itemDepDoc.NotConfirm = CharToBool( rs.value( "t_NotConfirm" ) );
      itemDepDoc.IsStorn = CharToBool( rs.value( "t_flagstorn" ) );
      itemDepDoc.Ground = SQL_ConvTypeStr( rs.value( "t_Ground" ) );
      
      purposeNumber = SQL_ConvTypeInteger( rs.value( "t_ApplType" ) );
      GetLLValue( 3558, purposeNumber, itemDepDoc.Purpose );

      if ( (itemDepDoc.VidDoc != 0) and (itemDepDoc.NotConfirm == true) and ( (itemDepDoc.InSum != $0) or (itemDepDoc.OutSum != $0) ) )
        itemDepDoc.NotConfirm = true;
      else
        itemDepDoc.NotConfirm = false;
      end;
      
      ClientCode = SQL_ConvTypeInteger( rs.value( "t_codclient" ) );
      if ( ClientCode > 0 )
        // найдем ФИО клиента
        cmdIn = RsdCommand( "SELECT t_name FROM dparty_dbt WHERE t_partyid = ?" );
        cmdIn.AddParam( "ClientCode", RSDBP_IN, ClientCode );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemDepDoc.ClientName = SQL_ConvTypeStr( rsIn.value( "t_name" ) );
        end;

        // найдем роль клиента по объекту продукта
        cmdIn = RsdCommand( "select t_role from dprdclntrole_dbt where t_partyid = ? and t_clntprodobjid = " +
                            " (select dep.t_clntprodobjid from ddepositr_dbt dep where dep.t_referenc = ?)" );
        cmdIn.AddParam( "ClientCode", RSDBP_IN, ClientCode );
        cmdIn.AddParam( "Ref", RSDBP_IN, objectID );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemDepDoc.ClientRole = SQL_ConvTypeInteger( rsIn.value( "t_role" ) );
        else
          // роль для объекта не нашли. Тогда будем искать роль клиента по продукту
          cmdIn = RsdCommand( "select t_role from dprdclntrole_dbt where t_partyid = ? and t_clientproductid = " +
                              " (select con.t_clientproductid from ddepositr_dbt dep, drt_contract_dbt con where " +
                              " con.t_branch = dep.t_fncash and con.t_number = dep.t_svodaccount and dep.t_referenc = ?)" );
          cmdIn.AddParam( "ClientCode", RSDBP_IN, ClientCode );
          cmdIn.AddParam( "Ref", RSDBP_IN, objectID );
          cmdIn.execute;
          rsIn = RsdRecordSet( cmdIn );
          if ( rsIn.moveNext )
            itemDepDoc.ClientRole = SQL_ConvTypeInteger( rsIn.value( "t_role" ) );
          end;
        end;
      end;
      
      if(TreeMode)
          TWsOperHistoryListElement_AddToTree(result,itemDepDoc);
      else
          result.value(result.Size) = itemDepDoc;
      end;
    end;

  elif ( objectType == 554 )
    var slash = Index( objectId, "/" );
    var fnCash = SubStr( objectId, 1, slash - 1 );
    var cardRef = SubStr( objectId, slash + 1 );
    var mainAccLinkRef, mainSubAccLinkRef, accCardLinkRef;
    var typeAcc:string;
    var isCur: integer;

    cmd = RsdCommand( "SELECT LNK.T_ACCCARDLINKREF, LNK.T_MAINSUBACCLINKREF FROM dsclink_dbt lnk " +
        "WHERE LNK.T_CARDREF = ? AND LNK.T_FNCASH = ? ORDER BY LNK.T_ACCCARDLINKOPENCLOSE ASC, " + 
        "LNK.T_ACCCARDLINKOPENDATE DESC" );

    cmd.AddParam( "CardRef", RSDBP_IN, cardRef );
    cmd.AddParam( "FnCash", RSDBP_IN, fnCash );

    cmd.execute;

    rs = RsdRecordSet( cmd );

    if ( rs.moveNext )
      mainSubAccLinkRef = rs.value( "T_MAINSUBACCLINKREF" );
      accCardLinkRef = rs.value( "T_ACCCARDLINKREF" );
      MainAccLinkRef = IIF ( mainSubAccLinkRef > 0, mainSubAccLinkRef, accCardLinkRef );
      
      query = "SELECT sccrddoc.*, depdoc.t_Date_Document, depdoc.t_NotConfirm, depdoc.t_viddoc, depdoc.t_ApplType, depdoc.t_codclient " +
         "FROM dsccrddoc_dbt sccrddoc, dsbdepdoc_dbt depdoc " +
         "WHERE sccrddoc.t_fncash = :FnCash AND sccrddoc.t_acccardlinkref = :AccCardLinkRef AND sccrddoc.t_Action != 2 AND " +
         "sccrddoc.t_depdocappkind = depdoc.t_IApplicationKind(+) AND sccrddoc.t_depdocappkey = depdoc.t_ApplicationKey(+)";

      if ( mainSubAccLinkRef > 0)
        query = query + " AND sccrddoc.t_addcardref = " + cardRef;
      end;

      strAddWhere = GetOperHistListFilterCondition( filterList, 1 );
      if( strAddWhere != "" )
        query = query + " AND " + strAddWhere;
      end;

      query = query + " ORDER BY ";// + SP_GetSortStr(orderList, "t_date");
      if( ( orderList != null ) and ( orderList.Size > 0 ) )
        var i:integer = 0;
        while( i < orderList.size() )
          if ((orderList[i].Column == "VidDoc") or (orderList[i].Column == "NotConfirm"))
            query = query + " NVL(depdoc.t_" + orderList[i].Column + ", null) " + IIF(orderList[i].Direction == 0, "asc,", "desc,");
    	  elif ( orderList[i].Column == "Date_Document" )
    	      query = query + " sccrddoc.t_date " + IIF(orderList[i].Direction == 0, "asc,", "desc,");	
          else
            query = query + " sccrddoc.t_" + orderList[i].Column + " " + IIF(orderList[i].Direction == 0, "asc,", "desc,");
          end;
          i = i + 1;
        end;
	      query = SubStr(query, 1, StrLen(query) - 1); 
      else
        query = query + "t_date DESC";
      end;

      query = SQL_WrapSelect(query, pageNumber, pageSize);
   
      cmd = RsdCommand( query );
      cmd.AddParam( "FnCash", RSDBP_IN, fnCash );
      cmd.AddParam( "AccCardLinkRef", RSDBP_IN, MainAccLinkRef );
      cmd.execute;

      cmd.nullConversion = true;

      rs = RsdRecordSet( cmd );

      while ( rs.moveNext )
        var itemSccrdoc = TWsOperHistoryListElement;
        itemSccrdoc.ApplicationKind = rs.value( "t_ApplicationKind" );
        itemSccrdoc.ApplicationKey = rs.value( "t_ApplicationKey" );

        cmdIn = RsdCommand( "SELECT t_depdate_document, t_notconfirm, t_type_account, t_viddoc, t_flagstorn FROM dsbdepdoc_dbt WHERE t_IApplicationKind = ? AND t_ApplicationKey = ?" );
        cmdIn.AddParam( "DepDocAppKind", RSDBP_IN, rs.value( "t_DepDocAppKind" ) );
        cmdIn.AddParam( "DepDocAppKey ", RSDBP_IN, rs.value( "t_DepDocAppKey" ) );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemSccrdoc.Date_Operation = rsIn.value( "t_depdate_document" );
          itemSccrdoc.NotConfirm = CharToBool( rs.value( "t_NotConfirm" ) ); 
          itemSccrdoc.VidDoc = SQL_ConvTypeInteger( rsIn.value( "t_viddoc" ) );
          itemSccrdoc.IsStorn = CharToBool( rsIn.value( "t_flagstorn" ) );
          typeAcc = rsIn.value( "t_Type_Account" );
        else
          itemSccrdoc.Date_Operation = rs.value( "t_date" );
          itemSccrdoc.NotConfirm = false;  
          typeAcc = "Шаблонный";
          itemSccrdoc.IsStorn = false;
          itemSccrdoc.VidDoc = 0;     
        end;

        itemSccrdoc.Date_Document = rs.value( "t_Date" );

        isCur = IIF ( rs.value( "t_CurrCode" ), 1, 0 );    

        cmdIn = RsdCommand( "SELECT PRCDEF.T_NAME FROM dwf_process_dbt prc, dwf_procdef_dbt prcdef " +
            "WHERE prc.t_id IN " +
              "(SELECT obj.t_objectRef FROM dopobject_dbt obj, dsb_casln_dbt LN " +
                "WHERE LN.T_APPLICATIONKEY2 = ? AND LN.T_APPLICATIONKIND2 = ? AND LN.T_REFVALUE2 = 0 " +
                "AND obj.t_opAppKind = LN.T_APPLICATIONKIND1 AND obj.t_opAppKey = LN.T_APPLICATIONKEY1 " +
                "AND obj.t_objectType = ?) " +
            "AND PRCDEF.T_ID = PRC.T_DEFINITIONID" );
        cmdIn.AddParam( "ApplicationKey", RSDBP_IN, itemSccrdoc.ApplicationKey );
        cmdIn.AddParam( "ApplicationKind", RSDBP_IN, itemSccrdoc.ApplicationKind );
        cmdIn.AddParam( "SB_WORKFLOW", RSDBP_IN, SB_WORKFLOW );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemSccrdoc.OperationName = rsIn.value( "T_NAME" );
          itemSccrdoc.OperationNumber = -1;
        else
          itemSccrdoc.OperationName = "";
          itemSccrdoc.OperationNumber = 0;
          cmdIn = RsdCommand( "SELECT t_cznamealg FROM dsb_typop_dbt WHERE t_iscur = :IsCur AND t_kind = :Kind AND t_numopert = :NumOpert" );
          cmdIn.AddParam( "IsCur", RSDBP_IN, isCur );
          cmdIn.AddParam( "Kind", RSDBP_IN, typeAcc );
          cmdIn.AddParam( "NumOpert", RSDBP_IN, rs.value( "t_NumComplexOper" ) );
          cmdIn.execute;
          rsIn = RsdRecordSet( cmdIn );
          if ( rsIn.moveNext )
            itemSccrdoc.OperationName = rsIn.value( "t_cznamealg" );
            itemSccrdoc.OperationNumber = rs.value( "t_NumComplexOper" );
          elif ( typeAcc != "Шаблонный" )
            typeAcc = "Шаблонный";
            cmdIn = RsdCommand( "SELECT t_cznamealg FROM dsb_typop_dbt WHERE t_iscur = :IsCur AND t_kind = :Kind AND t_numopert = :NumOpert" );
            cmdIn.AddParam( "IsCur", RSDBP_IN, isCur );
            cmdIn.AddParam( "Kind", RSDBP_IN, typeAcc );
            cmdIn.AddParam( "NumOpert", RSDBP_IN, rs.value( "t_NumComplexOper" ) );
            cmdIn.execute;
            rsIn = RsdRecordSet( cmdIn );
            if ( rsIn.moveNext )
              itemSccrdoc.OperationName = rsIn.value( "t_cznamealg" );
              itemSccrdoc.OperationNumber = rs.value( "t_NumComplexOper" );
            end;
           end;
        end;

        itemSccrdoc.DocTypeOper = rs.value( "t_NumOper" );

        cmdIn = RsdCommand( "SELECT t_cznamealg FROM dsb_typop_dbt WHERE t_iscur = ? AND t_kind = ? AND t_numopert = ?" );
        cmdIn.AddParam( "IsCur", RSDBP_IN, isCur );
        cmdIn.AddParam( "Kind", RSDBP_IN, typeAcc );
        cmdIn.AddParam( "NumOpert", RSDBP_IN, rs.value( "t_NumOper" ) );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemSccrdoc.DocTypeOperName = rsIn.value( "t_cznamealg" );
        end;

        itemSccrdoc.InSum = rs.value( "t_InSum" );
        itemSccrdoc.OutSum = rs.value( "t_OutSum" );
        itemSccrdoc.Rest = rs.value( "t_Rest" );
        itemSccrdoc.Oper = rs.value( "t_Oper" );

        cmdIn = RsdCommand( "SELECT t_name FROM dperson_dbt WHERE t_oper = ?" );
        cmdIn.AddParam( "Oper", RSDBP_IN, itemSccrdoc.Oper );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          itemSccrdoc.OperName = rsIn.value( "t_name" );
        end;

        // Выполняющий клиент - владелец карты
        cmdIn = RsdCommand( "SELECT t_codclient FROM dsccard_dbt WHERE t_cardref = ? and t_fncash = ?" );
        cmdIn.AddParam( "CardRef", RSDBP_IN, cardRef );
        cmdIn.AddParam( "FnCash", RSDBP_IN, fnCash );
        cmdIn.execute;
        rsIn = RsdRecordSet( cmdIn );
        if ( rsIn.moveNext )
          ClientCode = SQL_ConvTypeInteger( rsIn.value( "t_codclient" ) );
          if ( ClientCode > 0 )
            // найдем ФИО клиента
            cmdIn = RsdCommand( "SELECT t_name FROM dparty_dbt WHERE t_partyid = ?" );
            cmdIn.AddParam( "ClientCode", RSDBP_IN, ClientCode );
            cmdIn.execute;
            rsIn = RsdRecordSet( cmdIn );
            if ( rsIn.moveNext )
              itemSccrdoc.ClientName = SQL_ConvTypeStr( rsIn.value( "t_name" ) );
            end;
            itemSccrdoc.ClientRole = 1; // операции по карточкам всегда выполняет владелец
          end;
        end;

        itemSccrdoc.Ground = rs.value( "t_Ground" );

        purposeNumber = SQL_ConvTypeInteger( rs.value( "t_ApplType" ) );
        GetLLValue( 3558, purposeNumber, itemSccrdoc.Purpose );

        // Установку признака NotConfirm берем из изивина
        if ( (itemSccrdoc.VidDoc != 0) and (itemSccrdoc.NotConfirm == true) and ( (itemSccrdoc.InSum != $0) or (itemSccrdoc.OutSum != $0) ) )
          itemSccrdoc.NotConfirm = true;
        else
          itemSccrdoc.NotConfirm = false;
        end;

        result.value(result.Size) = itemSccrdoc;
      end;
    //else
      //runError( "Счет не найден", 8524 );
    end; 
  end;
 
  return result;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro getOperHistoryListCount
(
  objectType : integer, 
  objectID : string,
  filterList : TArray
):integer
  var cmd, rs;
  var count = 0;
  var query;
  var strAddWhere: string;

  if ( objectType == 551 )
    query = "SELECT COUNT(t_referenc) count FROM dsbdepdoc_dbt depdoc WHERE t_referenc = :Ref AND  t_issuspended != chr(70) AND " + IsServ_const;
    
    strAddWhere = GetOperHistListFilterCondition( filterList, 0 );
    if( strAddWhere != "" )
      query = query + " AND " + strAddWhere;
    end;

    cmd = RsdCommand( query );
    cmd.AddParam( "Ref", RSDBP_IN, objectID );
    cmd.execute;

  elif ( objectType == 554 )
    var slash = Index( objectId, "/" );
    var fnCash = SubStr( objectId, 1, slash - 1 );
    var cardRef = SubStr( objectId, slash + 1 );
    var mainAccLinkRef, mainSubAccLinkRef, accCardLinkRef;
    var cmdLink, rsLink;

    cmdLink = RsdCommand( "SELECT LNK.T_ACCCARDLINKREF, LNK.T_MAINSUBACCLINKREF FROM dsclink_dbt lnk " +
        "WHERE LNK.T_CARDREF = ? AND LNK.T_FNCASH = ? ORDER BY LNK.T_ACCCARDLINKOPENCLOSE ASC, " + 
        "LNK.T_ACCCARDLINKOPENDATE DESC" );
    cmdLink.AddParam( "Card Ref", RSDBP_IN, cardRef );
    cmdLink.AddParam( "FnCash", RSDBP_IN, fnCash );
    cmdLink.execute;
    rsLink = RsdRecordSet( cmdLink );
    if ( rsLink.moveNext )
      mainSubAccLinkRef = rsLink.value( "T_MAINSUBACCLINKREF" );
      accCardLinkRef = rsLink.value( "T_ACCCARDLINKREF" );
      MainAccLinkRef = IIF ( mainSubAccLinkRef > 0, mainSubAccLinkRef, accCardLinkRef );

      query = "SELECT COUNT(t_acccardlinkref) count FROM dsccrddoc_dbt sccrddoc, dsbdepdoc_dbt depdoc " +
         "WHERE sccrddoc.t_fncash = :FnCash AND sccrddoc.t_acccardlinkref = :AccCardLinkRef AND sccrddoc.t_Action != 2 AND " +
         "sccrddoc.t_depdocappkind = depdoc.t_IApplicationKind(+) AND sccrddoc.t_depdocappkey = depdoc.t_ApplicationKey(+)";

      if ( mainSubAccLinkRef > 0)
        query = query + " AND sccrddoc.t_addcardref = " + cardRef;
      end;

      strAddWhere = GetOperHistListFilterCondition( filterList, 1 );
      if( strAddWhere != "" )
        query = query + " AND " + strAddWhere;
      end;

      cmd = RsdCommand( query );
      cmd.AddParam( "FnCash", RSDBP_IN, fnCash );
      cmd.AddParam( "AccCardLinkRef", RSDBP_IN, MainAccLinkRef );
      cmd.execute;

    else
      return 0;
    end;
  end;
  rs = RsdRecordSet( cmd );
  if ( rs.moveNext )
    count = rs.value ( "count" );
  end;  

  return count;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro getPMDList
(
   ApplicationKind : integer,   /* Вид БП документа */
   ApplicationKey : string,      /* ID документа */
   pageNumber : integer,  /* номер страницы */
   pageSize : integer,        /* размер страницы */
   filterList : TArray,    /* параметры фильтрации */
   orderList : TArray     /* параметры сортировки */
)
  var cmd, rs, cmdIn, rsIn;
  var listElement;
  var result = TArray;

  cmd = RsdCommand( "SELECT rdd.* from dsb_casln_dbt ln, drtdocument_dbt rdd WHERE LN.T_APPLICATIONKEY2= :appKey " +
      "AND LN.T_APPLICATIONKIND2= :appKind AND LN.T_REFVALUE2=0 AND RDD.T_OPAPPLICATIONKIND=LN.T_APPLICATIONKIND1 " +
      "AND RDD.T_OPAPPLICATIONKEY=LN.T_APPLICATIONKEY1 ORDER BY RDD.T_DOCUMENTID ASC" );
  cmd.AddParam( "appKey", RSDBP_IN, ApplicationKey );
  cmd.AddParam( "appKind", RSDBP_IN, ApplicationKind );
  cmd.execute;
  rs = RsdRecordSet( cmd );
  while ( rs.moveNext )
    listElement = TWsPMDListElement;

    listElement.Number = SQL_ConvTypeStr( rs.value( "t_DocumentNumber" ) );
    listElement.IsMultyDoc = IIF( SQL_ConvTypeStr( rs.value( "t_FoldSide" ) ), true, false );
    listElement.DebitAccount = SQL_ConvTypeStr( rs.value( "t_DebitAccount" ) );

    cmdIn = RsdCommand( "SELECT T_SHORT_NAME FROM dcurrency_dbt WHERE T_CODE_CURRENCY = ?" );
    cmdIn.AddParam( "debitCurrCode", RSDBP_IN, rs.value( "t_DebitCurrCode" ) );
    cmdIn.execute;
    rsIn = RsdRecordSet( cmdIn );
    if ( rsIn.moveNext )
      listElement.DebitCurrency = SQL_ConvTypeStr( rsIn.value( "T_SHORT_NAME" ) );
    end;

    listElement.DebitSum = SQL_ConvTypeSum( rs.value( "t_DebitAmount" ) );
    listElement.CreditAccount = SQL_ConvTypeStr( rs.value( "t_CreditAccount" ) );

    cmdIn = RsdCommand( "SELECT T_SHORT_NAME FROM dcurrency_dbt WHERE T_CODE_CURRENCY = ?" );
    cmdIn.AddParam( "creditCurrCode", RSDBP_IN, rs.value( "t_CreditCurrCode" ) );
    cmdIn.execute;
    rsIn = RsdRecordSet( cmdIn );
    if ( rsIn.moveNext )
      listElement.CreditCurrency = SQL_ConvTypeStr( rsIn.value( "T_SHORT_NAME" ) );
    end;

    listElement.CreditSum = SQL_ConvTypeSum( rs.value( "t_CreditAmount" ) );

    result.value(result.Size) =  listElement;
  end;

  return result;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro getPMDListCount
(
   ApplicationKind : integer,   /* Вид БП документа */
   ApplicationKey : string      /* ID документа */
) : integer
  var cmd, rs;
  var count = 0;

  cmd = RsdCommand( "SELECT COUNT(rdd.t_DocumentNumber) count from dsb_casln_dbt ln, drtdocument_dbt rdd " +
      "WHERE LN.T_APPLICATIONKEY2= :appKey AND LN.T_APPLICATIONKIND2= :appKind AND LN.T_REFVALUE2=0 " +
      "AND RDD.T_OPAPPLICATIONKIND=LN.T_APPLICATIONKIND1 AND RDD.T_OPAPPLICATIONKEY=LN.T_APPLICATIONKEY1" );
  cmd.AddParam( "appKey", RSDBP_IN, ApplicationKey );
  cmd.AddParam( "appKind", RSDBP_IN, ApplicationKind );
  cmd.execute;
  rs = RsdRecordSet( cmd );
  if ( rs.moveNext )
    count = rs.value ( "count" );
  end;

  return count;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro getRestSumClntProductObj
(
  ClientPrdObjID: integer /* ID объекта продукта клиента */
):TWsRestProdObj 
  var cmd, rs;
  var restProdObj:TWsRestProdObj;
  var oldFnCash, oldFlagCur;

  cmd = RSDCommand( "SELECT t_objecttype, t_objectid FROM dprdclientobj_dbt WHERE t_clntprodobjid = ?" );
  cmd.AddParam( "ClntPrdObjId", RSDBP_IN, ClientPrdObjID );
  cmd.execute;
  rs = RsdRecordSet( cmd );
  if ( rs.moveNext )
    var objectType = rs.value ( "t_objecttype" );
    var objectID = rs.value ( "t_objectid" );

    if ( objectType == 551 )
      cmd = RSDCommand( "SELECT t_code_currency, t_fncash, t_iscur FROM ddepositr_dbt WHERE t_referenc = ?" );
      cmd.AddParam( "Referenc", RSDBP_IN, Int(objectID) );
      cmd.execute;
      rs = RsdRecordSet( cmd );
      if ( rs.moveNext )
        oldFnCash = setFnCash(rs.value ( "t_fncash" ));
        oldFlagCur = setFlagCur(rs.value ( "t_iscur" ));

        restProdObj.Sum = GetRestForDate( Int(objectID), getCurDate );

        cmd = RSDCommand( "SELECT t_short_name FROM dcurrency_dbt WHERE t_code_currency = ?" );
        cmd.AddParam( "CodeCurr", RSDBP_IN, rs.value ( "t_code_currency" ) );
        cmd.execute;
        rs = RsdRecordSet( cmd );

        if ( rs.moveNext )
          restProdObj.CurrCode = rs.value ( "t_short_name" );
        end;

        setFlagCur(oldFlagCur);
        setFnCash(oldFnCash);        
      end;

    elif ( objectType == 554 )
      var slash = Index( objectId, "/" );
      var fnCash = SubStr( objectId, 1, slash - 1 );
      var cardRef = SubStr( objectId, slash + 1 );

      cmd = RsdCommand( "SELECT T_ACCCARDLINKREF, T_MAINSUBACCLINKREF, T_CODCUR, T_FLAGCUR FROM dsclink_dbt " +
        "WHERE T_CARDREF = ? AND T_FNCASH = ? ORDER BY T_ACCCARDLINKOPENCLOSE ASC, T_ACCCARDLINKOPENDATE DESC" );
      cmd.AddParam( "CardRef", RSDBP_IN, cardRef );
      cmd.AddParam( "FnCash", RSDBP_IN, fnCash );
      cmd.execute;
      rs = RsdRecordSet( cmd );
      if ( rs.moveNext )
        var mainSubAccLinkRef = rs.value( "T_MAINSUBACCLINKREF" );
        var accCardLinkRef = rs.value( "T_ACCCARDLINKREF" );
        var MainAccLinkRef = IIF ( mainSubAccLinkRef > 0, mainSubAccLinkRef, accCardLinkRef );

        oldFnCash = setFnCash( fnCash );
        oldFlagCur = setFlagCur( rs.value ( "t_flagcur" ) );

        restProdObj.Sum = GetCardSubAccRest( fnCash, MainAccLinkRef );

        cmd = RSDCommand( "SELECT t_short_name FROM dcurrency_dbt WHERE t_code_currency = ?" );
        cmd.AddParam( "CodeCurr", RSDBP_IN, rs.value ( "t_codcur" ) );
        cmd.execute;
        rs = RsdRecordSet( cmd );

        if ( rs.moveNext )
          restProdObj.CurrCode = rs.value ( "t_short_name" );
        end;

        setFlagCur(oldFlagCur);
        setFnCash(oldFnCash);
      end;
      
    else
      RunError("Функциональность не поддерживается");
    end;
  end;

  return restProdObj;
end;


macro GetReTrusterByRefID(	RefID : integer )
    
	var cmd = RsdCommand("select t_codclient from dsbtrast_dbt where t_refid=(select t_refidlink from dsbtrast_dbt where t_refid = ?)");
	
	cmd.addParam( "", RSDBP_IN, RefID );
	var rs = RsdRecordset(cmd);
	
	if (rs.movenext)
		return rs.value( "t_codclient" );
	end;
	
	return null;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetTrustList
(
   ObjectType : integer,   /* вид объекта */
   ObjectID   : string,    /* идентификатор объекта с видом objecttype в продукте/объекте продукта клиента */
   OnlyActive : bool,  /*True - отобрать только действующие доверенности.*/
   OnlyAllowReTrust : bool, /*True - отобрать доверенности с разрешенным передоверием.*/
   Type : integer,   /*Код роли клиента (по namealg 900), с которым нужно отобрать записи*/
   clientId : integer /* Код клиента, выполняющего операцию */
)
   var TrustList = Tarray();
   
   var cmd = RsdCommand(
   "SELECT trast.* "+
   "FROM DDEPOSITR_DBT dep, dsbtrast_dbt  trast, drt_contract_dbt cont "+
   "WHERE CONT.T_NUMBER = DEP.T_SVODACCOUNT AND CONT.T_BRANCH = DEP.T_FNCASH AND DEP.T_REFERENC = ? AND " + 
   "trast.T_FNCASH = dep.T_FNCASH   AND trast.T_VIDDOC = CHR(0)  AND TRAST.T_REFERENC = cont.T_ID" +
   IIF(OnlyActive == true, 
		" AND TRAST.T_BlockFlag = CHR(0)"+ 
		IIF((Type == 1) AND (OnlyAllowReTrust == false), " AND trast.t_CloseDate > ?"," AND trast.t_CloseDate>= ?"), 
	"") +
   IIF(Type!=0, " AND TRAST.T_Type = ?", "") +
   IIF(OnlyAllowReTrust==true, " AND TRAST.T_RETRAST != CHR(0)", "")+
   IIF(clientId > 0, " AND TRAST.T_CODCLIENT = ?", ""));
   
   cmd.AddParam( "REFERENC", RSDBP_IN, ObjectID );
   if (OnlyActive == true)
	   cmd.AddParam( "CLOSEDATE", RSDBP_IN, {curdate})
   end;
   if (Type != 0)
	   cmd.AddParam( "TYPE", RSDBP_IN,  StrFor(Type));
   end;
   if (clientId > 0)
	   cmd.AddParam( "T_CODCLIENT", RSDBP_IN,  clientId);
   end;
   cmd.nullConversion = true;
   cmd.execute();
   
   var sbtrast = RsdRecordSet( cmd );
   while ( sbtrast.moveNext() )
      var elem = TWsTrustListElement;
      elem.AccRefID   = ObjectID;
      elem.TrastRefID = sbtrast.value("T_RefID");
      elem.ClientId   = sbtrast.value("T_CodClient");
      elem.OpenDate   = sbtrast.value("T_DateOpen");
      elem.CloseDate  = sbtrast.value("T_CloseDate");

      var cmdFio = RsdCommand( "select t_Name1, t_name2, t_name3 from dpersn_dbt where t_personid = ?");
      cmdFio.AddParam("client",RSDBP_IN,elem.ClientId);
      cmdFio.nullConversion = true;
      cmdFio.execute();
      var FioRec = RsdRecordSet( cmdFio );
      if(FioRec.moveNext())
          elem.FullFio = FioRec.Value("t_Name1") + " " + FioRec.Value("t_Name2") + " " + FioRec.Value("t_Name3"); 
          var n2 = "";
          var n3 = "";
          if(strlen(FioRec.Value("t_Name2"))) 
              n2 = " " + SubStr(FioRec.Value("t_Name2"),1,1) + "."; 
          end;  
          if(strlen(FioRec.Value("t_Name3"))) 
              n3 = " " + SubStr(FioRec.Value("t_Name3"),1,1) + "."; 
          end; 
          elem.Fio =  FioRec.Value("t_Name1") + n2 + n3;
      end;
                                            
      elem.IsAttested = CharToBool(sbtrast.value("T_IsNotarial"));
      elem.IsBlocked  = CharToBool(sbtrast.value("T_BlockFlag"));
      elem.IsReTrust  = CharToBool(sbtrast.value("T_ReTrast"));
      
      var TNCmd = RsdCommand( "SELECT ALG.T_SZNAMEALG FROM dnamealg_dbt alg WHERE ALG.T_ITYPEALG = 900 AND  ALG.T_INUMBERALG = ?");
      TNCmd.AddParam("type",RSDBP_IN,CodeFor(sbtrast.value("T_Type")));
      TNcmd.nullConversion = true;
      TNCmd.execute();

      var kindrec = CodeFor(sbtrast.value("T_Type"));

      var TNRec = RsdRecordSet( TNCmd );
      if(TNRec.moveNext())
          elem.TypeName  = TNRec.value("T_SZNAMEALG");
      end;   

      var LimPeriodTypeCmd = RsdCommand( "SELECT ALG.T_SZNAMEALG FROM dnamealg_dbt alg WHERE ALG.T_ITYPEALG = 333 AND  ALG.T_INUMBERALG = ?");
      LimPeriodTypeCmd.AddParam("type",RSDBP_IN,sbtrast.value("T_LimPeriodType"));
      LimPeriodTypeCmd.nullConversion = true;
      LimPeriodTypeCmd.execute();

      var TypeRec = RsdRecordSet( LimPeriodTypeCmd );
      if(TypeRec.moveNext())
          elem.LimPeriodType  = TypeRec.value("T_SZNAMEALG");
      end;
      elem.LimSum         = sbtrast.value("T_LimSum");       
      elem.LimPeriodNum   = sbtrast.value("T_LimPeriodNum");
	  elem.RegNumber = SQL_ConvTypeStr(sbtrast.value("T_Number"));

      if((kindrec == 1) or (kindrec == 10))
         TrustList[TrustList.size] = elem;
      end;
   end;
   return TrustList; 
end;

macro GetTrustListCount
(
   ObjectType : integer,   /* вид объекта */
   ObjectID   : string,    /* идентификатор объекта с видом objecttype в продукте/объекте продукта клиента */
   OnlyActive : bool,  /*True - отобрать только действующие доверенности.*/
   OnlyAllowReTrust : bool, /*True - отобрать доверенности с разрешенным передоверием.*/
   Type : integer ,   /*Код роли клиента (по namealg 900), с которым нужно отобрать записи*/
   clientId : integer /* Код клиента, выполняющего операцию */
)
    return GetTrustList(ObjectType,ObjectID,OnlyActive,OnlyAllowReTrust,Type, clientId).size();
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintTrust
( 
  AccRefID   : integer,    /* референс счета */
  TrustRefID : integer   /* идентификатор доверенности */
)
    var  sbtrast:tbfile = Tbfile("sbtrast.dbt");
    sbtrast.KeyNum = 4;
    sbtrast.rec.RefID = TrustRefID;
    sbtrast.GetEQ(); 
    var depositr = Tbfile("DEPOSITR.DBT");
    ClearRecord( depositr );
    Copy(sbtrast_new,sbtrast);
    depositr.Rec.Referenc = AccRefID;
    depositr.KeyNum = 8;
    if ( GetEQ( depositr ) )
        Copy( ALG_DEPOSITOR, depositr );
    end;
    var fileName = getTxtFileName( "trst_3" );
    SetOutput(getTxtFileName(fileName));
    Print_nf_36();
    setoutput( NULL, TRUE );
    fileName = ConvertTxt2Html ( fileName );
    return CreateFileContainer ( fileName ); 
end;
/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro GetFncash(Fncash)
      var ddep = TRecHandler( "i_dp_dep.rec" );
      if (findDepartment(Fncash, null, ddep))
           var cmd = RsdCommand(
            "SELECT *"                    +
            "FROM  dparty_dbt  party "       +
            "WHERE party.t_PartyID = ?");
            var party = RsdRecordSet( cmd );
            cmd.AddParam( "t_PartyID", RSDBP_IN, ddep.rec.PartyID );
            cmd.nullConversion = true;
            cmd.execute();
            if(party.moveNext())
                return party;
            end;
      end;
return null;

end;
macro GetPlanPayList
(
   ObjectType : integer,  /* вид объекта */
   ObjectID   : string,    /* идентификатор объекта с видом objecttype в продукте/объекте продукта клиента */
   OpenClose  : integer   /*искать ДП: все - 0; только открытые - 1, закрытые - 2*/
)
   var PPList = Tarray();
   record ptRec("party.dbt");
   var cmd;
   var query;
   if(objectType == 551)
       query = "SELECT * FROM ddplanpay_dbt pp WHERE pp.T_REFERENCE = ? ";

       if ( OpenClose  == 1 )
         query = query + " and pp.t_open_close = chr(0) ";
       elif ( OpenClose  == 2 )
         query = query + " and pp.t_open_close <> chr(0) ";
       end;

       query = query + "ORDER BY pp.T_REF Desc";

       cmd = RsdCommand( query );
       cmd.AddParam( "T_REFERENCE", RSDBP_IN, ObjectID );
   elif(objectType == 554)
       var slash = Index( objectId, "/" );
       var fnCash = SubStr( objectId, 1, slash - 1 );
       var cardRef = SubStr( objectId, slash + 1 );

       query = "SELECT * FROM ddplanpay_dbt pp WHERE pp.t_fncash  = ? and pp.t_cardref = ? ";

       if ( OpenClose  == 1 )
         query = query + " and pp.t_open_close = chr(0) ";
       elif ( OpenClose  == 2 )
         query = query + " and pp.t_open_close <> chr(0) ";
       end;

       query = query + "ORDER BY pp.T_REF Desc";

       cmd = RsdCommand( query );
       cmd.AddParam( "tfncash" , RSDBP_IN, fnCash );
       cmd.AddParam( "tcardref", RSDBP_IN, cardRef );
   else
       return PPList; 
   end;
   
   cmd.nullConversion = true;
   cmd.execute();
   var pp = RsdRecordSet( cmd );
   while ( pp.moveNext() )
      var elem = TWsPlanPayListElement;
      elem.ref           = pp.value("t_ref");
      elem.numbercontract   = pp.value("T_NumberContract");
      if( pp.value("t_open_close"))
          elem.Open_close = true;
      else
          elem.Open_close = false;
      end;
      elem.sum              = pp.value("T_sum");
      elem.FNcash  = GetFncash(pp.value("T_FNcash")).value("t_shortname");
      PPList[PPList.size] = elem;
   end;
   return PPList;    
end;
macro GetPlanPay(Id:integer)
   var elem = TWsPlanPayListElement();
   var cmd = RsdCommand(
       "SELECT *"                    +
       "FROM  ddplanpay_dbt  pp "    +
       "WHERE pp.T_REF = ?");
       cmd.AddParam( "T_REF", RSDBP_IN, Id );
       var pp = RsdRecordSet( cmd );
       cmd.nullConversion = true;
       cmd.execute();
       if( pp.moveNext())
          elem.ref           = pp.value("t_ref");
          elem.numbercontract   = pp.value("T_NumberContract");
          if( pp.value("t_open_close"))
              elem.Open_close = true;
          else
              elem.Open_close = false;
          end;
          elem.sum              = pp.value("T_sum");
          elem.FNcash  = GetFncash(pp.value("T_FNcash")).value("t_shortname");
          var prt_reciver = GetFncash(pp.value("t_fncash_receiver"));
          elem.fncash_receiver  = pp.value("t_fncash_receiver");
          if(prt_reciver)
              elem.fncash_receiver_name  = prt_reciver.value("t_name");
          end;
          Get_Currency(pp.value("t_code_currency"), elem.shortName_currency );
          elem.code_Currency  = pp.value("t_code_currency");
          if( pp.value("t_editsumflag"))
              elem.editsumflag = true;
          else
              elem.editsumflag = false;
          end;
          elem.reference     = pp.value("t_reference");
          elem.iscur         = pp.value("t_iscur");
          elem.oper          = pp.value("t_oper");
          elem.kindpay       = pp.value("t_kindpay");
          elem.start_datepay = pp.value("t_start_datepay");
          elem.end_datepay   = pp.value("t_end_datepay");
          elem.sizeterm      = pp.value("t_sizeterm");
          elem.kindterm      = pp.value("t_kindterm");
          elem.mfo_receiver  = pp.value("t_mfo_receiver");
          elem.corAcc_Receiver = pp.value("t_coracc_receiver");
          elem.codclient_receiver = pp.value("t_codclient_receiver");        
          elem.cp_inn = pp.value("t_cp_inn");
          elem.cp_recip = pp.value("t_cp_recip");
          elem.uscreditnumber = pp.value("t_uscreditnumber"); 
          elem.kpp = pp.value("t_kpp");
          elem.account_receiver = pp.value("t_account_receiver");
          elem.bankreceivercodekind = pp.value("t_bankreceivercodekind");
          if( pp.value("t_subopkindflag"))
              elem.subopkindflag = true;
          else
              elem.subopkindflag = false;
          end;
          elem.BankPartyID       = ПолучитьКодСубъекта(elem.mfo_receiver,elem.bankreceivercodekind);
          elem.priority      = pp.value("t_priority");
          elem.nextpay       = pp.value("t_nextpay");
          elem.datelastpay   = pp.value("t_datelastpay");//!!!
          elem.namepay       = pp.value("t_namepay");
          elem.type_account  = pp.value("t_type_account");
          elem.typeoper      = pp.value("t_typeoper");
          elem.appltype      = pp.value("t_appltype");
          var cmdParam = RsdCommand(
             "SELECT T_CPACCOUNT account, T_PERSONID personId " +
             "FROM dpay_doc_cp_dbt " +
             "WHERE T_APPLKEY = ?");
              cmdParam.AddParam( "T_APPLKEY", RSDBP_IN, pp.value("t_applicationkey") );
              cmdParam.nullConversion = true;
              cmdParam.execute();
              var rsParam = RsdRecordSet( cmdParam );
              if( rsParam.moveNext() ) 
                 elem.cp_recipAccount = rsParam.value("account");
                 elem.personId = rsParam.value("personId");
              end;

          if ( ( elem.cp_recip <= 0 ) and ( elem.codclient_receiver <= 0 ) )
              var cmdReceiverName = RsdCommand(
             "SELECT * "                  +
             " FROM  DRTPAYMENTPROP_DBT "   +
             " WHERE T_DOCAPPLICATIONKIND = ? AND T_DOCAPPLICATIONKEY = ? ");
              cmdReceiverName.AddParam( "Kind", RSDBP_IN,pp.value("T_IAPPLICATIONKIND") );
              cmdReceiverName.AddParam( "Key", RSDBP_IN,pp.value("T_APPLICATIONKEY") );
              cmdReceiverName.nullConversion = true;
              cmdReceiverName.execute();
              var ReceiverName = RsdRecordSet( cmdReceiverName );
              if(ReceiverName.moveNext())
                  elem.codclient_receiver_name = ReceiverName.value("t_Name");
              end;
          end;

          elem.cp_kind = pp.value("t_cp_kind");
          if ( ( elem.cp_kind >= 0 ) and ( elem.typeoper == 64 ) )
            var  cmdcpkind = RsdCommand( "select * from drtcp_type_dbt where t_id = ?" );
            cmdcpkind.AddParam( "id" , RSDBP_IN, elem.cp_kind );
            cmdcpkind.nullConversion = true;
            cmdcpkind.execute();
            var rscpkind = RsdRecordSet( cmdcpkind );
            if(rscpkind.movenext)
              elem.cp_kindname = rscpkind.value("T_NAME");
            end;
          end;
          elem.errcode = pp.value("t_errcode");
          if(elem.errcode > 0)
              var cmdEC = RsdCommand(
             "SELECT * "                  +
             "FROM  dsbbank_msg  msg "   +
             "WHERE msg.T_NUMBER = ?");
              cmdEC.AddParam( "T_ID", RSDBP_IN,elem.errcode );
              cmdEC.nullConversion = true;
              cmdEC.execute();
              var msg = RsdRecordSet( cmdEC );
              if(msg.moveNext())
                  elem.errcodemsg  = "Ошибка:" +  msg.value("t_contents");
              end;
          else
              if(pp.value("t_datelastpay") == date(0,0,0))
                  elem.errcodemsg = "Перечисления не проводились";
              else
                  elem.errcodemsg = "Перечисление проведено успешно";
              end;
          end;  
       end;
   return elem; 
end;

macro GetPlanPayListCount
(
   ObjectType : integer,   /* вид объекта */
   ObjectID   : string,    /* идентификатор объекта с видом objecttype в продукте/объекте продукта клиента */
   OpenClose  : integer   /*искать ДП: все - 0; только открытые - 1, закрытые - 2*/
)
    return GetPlanPayList(ObjectType,ObjectID, OpenClose).size();
end;

macro GetCpRecipientList( filterFlag:integer, servType:integer, inBudget:BOOL, account:string, registerdate:date )
var CPList = Tarray();
 var req = CreateRequestCPRecipientSelect( filterFlag, servType, inBudget, account, registerdate );
 var  cmd = RsdCommand( req );
 cmd.nullConversion = true;
 cmd.execute();
 var cp_rec = RsdRecordSet( cmd );
 while(cp_rec.movenext)
   var elem = TWsCPRecieverElement();
   elem.Id               = cp_rec.value("t_Id");
   elem.ClientId         = cp_rec.value("t_ClientId");
   elem.Name             = cp_rec.value("t_Name");
   elem.BankCodeKind     = cp_rec.value("t_BankCodeKind");
   elem.BankCode         = cp_rec.value("t_BankCode");
   elem.BankName         = cp_rec.value("t_BankName");
   elem.CorrAccount      = cp_rec.value("t_CorrAccount");
   elem.Account          = cp_rec.value("t_Account");
   elem.INN              = cp_rec.value("t_INN");
   elem.KPP              = cp_rec.value("t_KPP");
   elem.OKTMO            = cp_rec.value("t_OKATO");
   elem.CreditAccount    = cp_rec.value("t_CreditAccount");
   elem.IsPayerNeeded	 = cp_rec.value("t_ispayerneeded");
   elem.Ground           = cp_rec.value("t_ground");   
    elem.IsElectronicReestr = cp_rec.value("t_IsElectronicReestr");
    elem.IsContractExist    = cp_rec.value("t_IsContractExist");   
    elem.IsContractClosed   = cp_rec.value("t_IsContractClosed");  
   CPList[CPList.size]   = elem;
 end;
 return CPList;
end;

macro GetCpRecipient(Id:integer)
 var elem = TWsCPRecieverElement();
 var  cmd = RsdCommand(
    "SELECT * "           +
    "FROM drtcp_recipient_dbt " +
    "WHERE t_Id = ?" );
 cmd.AddParam( "tId" , RSDBP_IN, Id );
 cmd.nullConversion = true;
 cmd.execute();
 var cp_rec = RsdRecordSet( cmd );
 if(cp_rec.movenext)
   elem.Id               = cp_rec.value("t_Id");
   elem.ClientId         = cp_rec.value("t_ClientId");
   elem.Name             = cp_rec.value("t_Name");
   elem.BankCodeKind     = cp_rec.value("t_BankCodeKind");
   elem.BankCode         = cp_rec.value("t_BankCode");
   elem.BankName         = cp_rec.value("t_BankName");
   elem.CorrAccount      = cp_rec.value("t_CorrAccount");
   elem.Account          = cp_rec.value("t_Account");
   elem.INN              = cp_rec.value("t_INN");
   elem.KPP              = cp_rec.value("t_KPP");
   elem.OKTMO            = cp_rec.value("t_OKATO");
   elem.CreditAccount    = cp_rec.value("t_CreditAccount");
   elem.IsPayerNeeded	 = cp_rec.value("t_ispayerneeded");
   elem.Ground           = cp_rec.value("t_ground");
    elem.IsElectronicReestr = cp_rec.value("t_IsElectronicReestr");
    elem.IsContractExist    = cp_rec.value("t_IsContractExist");   
    elem.IsContractClosed   = cp_rec.value("t_IsContractClosed");  
 end;
 return elem;
end;


macro GetCPRecipientListItem( 
    str: string, 
    filterFlag:integer, 
    servType:integer, 
    inBudget:BOOL, 
    account:string, 
    registerdate:date 
    )

  var CPList = Tarray();
  var temp_req = CreateRequestCPRecipientSelect( filterFlag, servType, inBudget, account, registerdate );
  var req = temp_req;
  if(str != "")
    var i = index(req, "order by");
    if (i > 0 )
      req = substr(temp_req, 1, i - 1);
      req = req + " and lower(t_name) like lower ('%' ||'"+ Str +"'|| '%') ";
      req = req + substr (temp_req, i ); 
    else
      req = req + " and lower(t_name) like lower ('%' ||'"+ Str +"'|| '%') ";
    end;
  end;

  var  cmd = RsdCommand( req );
  cmd.nullConversion = true;
  cmd.execute();
  var cp_rec = RsdRecordSet( cmd );
  while(cp_rec.movenext)
    var elem = TWsCPRecieverElement();
    elem.Id                 = cp_rec.value("t_Id");
    elem.ClientId           = cp_rec.value("t_ClientId");
    elem.Name               = cp_rec.value("t_Name");
    elem.BankCodeKind       = cp_rec.value("t_BankCodeKind");
    elem.BankCode           = cp_rec.value("t_BankCode");
    elem.BankName           = cp_rec.value("t_BankName");
    elem.CorrAccount        = cp_rec.value("t_CorrAccount");
    elem.Account            = cp_rec.value("t_Account");
    elem.INN                = cp_rec.value("t_INN");
    elem.KPP                = cp_rec.value("t_KPP");
    elem.OKTMO              = cp_rec.value("t_OKATO");
    elem.CreditAccount      = cp_rec.value("t_CreditAccount");
    elem.IsPayerNeeded	    = cp_rec.value("t_ispayerneeded");
    elem.Ground             = cp_rec.value("t_ground");   
    elem.IsElectronicReestr = cp_rec.value("t_IsElectronicReestr");
    elem.IsContractExist    = cp_rec.value("t_IsContractExist");   
    elem.IsContractClosed   = cp_rec.value("t_IsContractClosed");  
    CPList[CPList.size]   = elem;
  end;
  return CPList;
end;

macro GetTypOpList(isCur: integer, typeAccount: string)
  var list = Tarray();
  var  cmd = RsdCommand(
      "SELECT t_numopert, t_cznamealg " +
      "FROM dsb_typop_dbt " +
      "WHERE t_iscur = ? and t_kind = ? "+
      "ORDER BY t_numopert");
  cmd.AddParam( "t_iscur" , RSDBP_IN, isCur );
  cmd.AddParam( "t_kind" , RSDBP_IN, typeAccount );
  cmd.nullConversion = true;
  cmd.execute();
  var rs = RsdRecordSet( cmd );
  while(rs.movenext)
   var elem = TWsTypOp();
   elem.numOper               = rs.value("t_numopert");
   elem.nameOper         = rs.value("t_cznamealg");
   list[list.size]   = elem;
 end;
 return list;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
private var flagStateCondition = false;
private macro GetStateCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var str = "";
  var size = value.size;
  
  if (size > 0)
    flagStateCondition = true;

    var i = 0;
    str = "(";
    while (i < size )
      if (i > 0)
        str = str + " OR ";
      end;

      str = str + " RETOP.T_STATE = " + ( int(value[i]) + 75 );
      i = i + 1;
    end;
    str = str + ")";
  end;

  return str;
end;

private macro GetTypeOperCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String

  var str : String = GetSQLNameAlgConditionEx( "retop", "t_applicationkind", condition, value, type );
 
  return str;
end;

macro getDelayOperationList
(
   ClientID : integer,   /* id клиента */
   filterList : TArray    /* параметры фильтрации */
   //orderList : TArray     /* параметры сортировки */
)
  var cmd, rs, temp;
  var name, account;
  var result = TArray;

  flagStateCondition = false;

  var query = "SELECT retop.*, opobj_workfow.t_objectref wf_objectref, opobj_deposit.t_objectref dep_objectref " +
              "   FROM dret_op_dbt retop, " +
              "        dopobject_dbt opobj_workfow, " +
              "        dopobject_dbt opobj_deposit " +
              "   WHERE     RETOP.T_CODCLIENT = " + ClientID +
		          "         AND OPOBJ_WORKFOW.T_OPAPPKEY(+) = RETOP.T_APPLICATIONKEY " +
              "         AND OPOBJ_WORKFOW.T_OPAPPKIND(+) = RETOP.T_APPLICATIONKIND " +
              "         AND OPOBJ_WORKFOW.T_OBJECTTYPE(+) = " + SB_WORKFLOW +
              "         AND OPOBJ_deposit.T_OPAPPKEY(+) = RETOP.T_APPLICATIONKEY " +
              "         AND OPOBJ_deposit.T_OPAPPKIND(+) = RETOP.T_APPLICATIONKIND " +
              "         AND OPOBJ_deposit.T_OBJECTTYPE(+) = " + SB_DEPOSIT;

  if ( (filterList != null ) AND (filterList.size > 0) )
    var fp = FilterParser( filterList );
    fp.AddFieldCondition( 0, "retop", "t_Date" );
    fp.AddUserFieldCondition( 1, @GetStateCondition );
    fp.AddUserFieldCondition( 2, @GetTypeOperCondition );
 
    query = query + " AND " + fp.GetFullSQLCondition();
  end;

  if ( flagStateCondition == false )
    query = query + " AND RETOP.T_STATE IN (75,76,78) ";
  end;  

  query = query + " ORDER BY retop.t_date DESC";//SP_GetSortStr(orderList, "retop.t_date DESC");

  cmd = RsdCommand( query );
  cmd.nullConversion = true;
  cmd.execute;
  rs = RsdRecordSet( cmd );
  while ( rs.moveNext )
    var item = TWsDelayOperationListElement;

    item.ApplicationKind = rs.value( "t_ApplicationKind" );
    item.ApplicationKey = rs.value( "t_ApplicationKey" );
    item.DateDelay = rs.value( "t_Date" );
    item.FMOperID = rs.value( "t_FMOpID_online" );
    item.State = rs.value( "t_state" );
    item.TypeService = rs.value( "t_bankproduct" );

    if ( charToBool( rs.value( "wf_objectref" ) ) == false )
      item.OperationName = "Операция выполнена в EasyWin, обработка запрещена";
      item.PersistentID = "0";
    else
      cmd = RsdCommand( "SELECT prcdef.t_name " +
                        "   FROM dwf_process_dbt prc, dwf_procdef_dbt prcdef " +
                        "    WHERE prc.t_id = '" + 
                                      rs.value ( "wf_objectref" ) +
                        "'     AND prcdef.t_id = prc.t_definitionid" );
      cmd.execute;
      temp = RsdRecordSet( cmd );
      if ( temp.moveNext )
        item.OperationName = temp.value( "t_name" );
      end;

      if ( charToBool( rs.value( "dep_objectref" ) ) == true )
        cmd = RsdCommand( "SELECT t_account FROM ddepositr_dbt WHERE t_referenc = TO_NUMBER( " +
                                rs.value( "dep_objectref" ) + " )" );
        cmd.execute;
        temp = RsdRecordSet( cmd );
        if ( temp.moveNext )
          item.OperationName = item.OperationName + " " + temp.value( "t_account" );
        end;
      end;

      item.PersistentID = rs.value( "wf_objectref" );

      // проверка операции в ФМ
      if ( item.State == RetOpState.OST_FM_CONSIDERATION )
        var stat = FM_CheckOperation( item.FMOperID, false, false );

        if ( stat == OpContrCheckResult.OPCONTR_CHECK_OK )
          Op_ChangeState( item.ApplicationKind, item.ApplicationKey, RetOpState.OST_PUTOFF );
          item.State = RetOpState.OST_PUTOFF;
        elif ( stat == OpContrCheckResult.OPCONTR_CHECK_STOP )
          Op_ChangeState( item.ApplicationKind, item.ApplicationKey, RetOpState.OST_FM_VETO );
          item.State = RetOpState.OST_FM_VETO;
        end;
      end;
    end;

    cmd = RsdCommand( "SELECT t_sznamealg FROM dnamealg_dbt WHERE t_itypealg = 915 AND t_inumberalg = " +
                            string(item.State) );
    cmd.execute;
    temp = RsdRecordSet( cmd );
    if ( temp.moveNext )
      item.StateName = temp.value( "t_sznamealg" );
    end;

    cmd = RsdCommand( "SELECT t_sznamealg FROM dnamealg_dbt WHERE t_itypealg = 794 AND t_inumberalg = " +
                            rs.value( "t_bankproduct" ) );
    cmd.execute;
    temp = RsdRecordSet( cmd );
    if ( temp.moveNext )
      item.TypeServiceName = temp.value( "t_sznamealg" );
    end;

    if ( item.State != RetOpState.OST_FM_VETO )
      result.value(result.Size) = item;
    end;
  end;

  return result;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro isExistsDelayOperation
(
   ClientID : integer   /* id клиента */
)
  var cmd, rs;
  var stat;

  cmd = RsdCommand( "SELECT 1 " +
                    "   FROM dret_op_dbt retop " +
                    "   WHERE     RETOP.T_CODCLIENT = " + ClientID +
                    "         AND RETOP.T_STATE IN (75,78)" );
  cmd.execute;
  rs = RsdRecordSet( cmd );
  if ( rs.moveNext )
    return true;
  end;

  cmd = RsdCommand( "SELECT retop.*, opobj_workfow.t_objectref wf_objectref " +
                    "   FROM dret_op_dbt retop, " +
                    "        dopobject_dbt opobj_workfow " +
                    "   WHERE     RETOP.T_CODCLIENT = " + ClientID +
                    "         AND RETOP.T_STATE = 76 " +
                    "         AND OPOBJ_WORKFOW.T_OPAPPKEY(+) = RETOP.T_APPLICATIONKEY " +
                    "         AND OPOBJ_WORKFOW.T_OPAPPKIND(+) = RETOP.T_APPLICATIONKIND" +
                    "         AND OPOBJ_WORKFOW.T_OBJECTTYPE(+) = 7000" );
  cmd.execute;
  rs = RsdRecordSet( cmd );
  while ( rs.moveNext )
    if ( charToBool( rs.value( "wf_objectref" ) ) == false )
      return true;
    end;

    stat = FM_CheckOperation( int( rs.value("t_FMOpID_online") ), false, false );
    if ( stat == OpContrCheckResult.OPCONTR_CHECK_STOP )
      Op_ChangeState( int( rs.value("t_ApplicationKind") ), rs.value("t_ApplicationKey"), RetOpState.OST_FM_VETO );
    else
      return true;
    end;
  end;

  return false;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetDTLimitSum 
( 
  flagCur : integer,
  kind : string,
  codeCurr : integer
)
  var limitSum = $0L;
  var cmd, rs;
  var typeAccount = "";

  cmd = RsdCommand( "select t_kind as kind from dsb_dtyp_dbt where t_flagcur = ? and t_name = ?" );

  cmd.AddParam( "flagCur", RSDBP_IN, flagCur );
  cmd.AddParam( "nameTypeAccount", RSDBP_IN, kind );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    typeAccount = rs.value( "kind" );
  end;

  if ( ( typeAccount == "" ) and ( strlen( kind ) <= 12 ) )
    cmd = RsdCommand( "select t_kind as kind from dsb_dtyp_dbt where t_flagcur = ? and t_kind = ?" );

    cmd.AddParam( "flagCur", RSDBP_IN, flagCur );
    cmd.AddParam( "shortNameTypeAccount", RSDBP_IN, kind );

    cmd.NullConversion = true;
    cmd.execute;

    rs = RsdRecordSet( cmd );

    if ( rs.moveNext )
      typeAccount = rs.value( "kind" );
    end;
  end;

  if ( typeAccount != "" )
    limitSum = GetDepTypeLimitSum( flagCur, typeAccount, codeCurr );
  end;

  return limitSum;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro RecalcTerms
(
   FactDay : integer,       /* срок договора дней */
   FactMonth : integer,     /* срок договора месяцев */
   FactYear : integer,      /* срок договора лет */
   FactDayProl : integer,   /* срок пролонгации дней */
   FactMonthProl : integer, /* срок пролонгации месяцев */
   FactYearProl : integer,  /* срок пролонгации лет */
   TermEndDate : date       /* дата окончания договора */
)

  var retValue = TWsTermParam( );
  var startDate = {curdate};
  var Term = 0;
  var KindTerm = 0;
  var DateTmp = Date( 0, 0, 0 );
  var sDay, sMonth, sYear;
  var eDay, eMonth, eYear;
  var tDay, tMonth, tYear;

  retValue.TermKind = 0;
  retValue.TermValue = 0;
  retValue.TermExtraDays = 0;
  retValue.TermKindProl = 0;
  retValue.TermValueProl = 0;
  retValue.TermExtraDaysProl = 0;
  retValue.EndDate = Date( 0, 0, 0 );

  if ( ( FactDay != 0 ) or ( FactMonth != 0 ) or ( FactYear != 0 ) )
    Calc_DayMonthYear_DataBase( FactDay, FactMonth, FactYear, Term, KindTerm, startDate );

    retValue.TermKind = KindTerm;
    retValue.TermValue = Term;

    GetDateOff( startDate, KindTerm, Term, TermEndDate );

    retValue.EndDate = TermEndDate;

  elif ( ( ValType( TermEndDate ) != V_UNDEF ) and ( TermEndDate != Date( 0, 0, 0 ) ) )
    DateSplit( TermEndDate, eDay, eMonth, eYear );
    DateSplit( startDate, sDay, sMonth, sYear );

    FactYear = eYear - sYear;

    if ( ( eMonth < sMonth ) or ( ( eMonth == sMonth ) and ( eDay < sDay ) ) )
      FactYear = FactYear - 1;
    end;

    if ( FactYear < 0 )
      FactYear = 0;
    end;

    if ( eMonth == sMonth )
      if ( eDay >= sDay )
        FactMonth = 0;
      else
        FactMonth = 12;
      end;
    elif ( eMonth > sMonth )
      FactMonth = eMonth - sMonth;
    else
      FactMonth = 12 + eMonth - sMonth;
    end;

    if ( eDay < sDay )
      FactMonth = FactMonth - 1;
    end;

    if ( FactMonth < 0 )
      FactMonth = 0;
    end;

    DateTmp = startDate;

    DateSplit( DateTmp, tDay, tMonth, tYear );

    tYear = tYear + FactYear;
    tMonth = tMonth + FactMonth;

    if ( tMonth > 12 )
      tYear = tYear + 1;
      tMonth = tMonth - 12;
    end;

    DateTmp = Date( tDay, tMonth, tYear );

    FactDay = TermEndDate - DateTmp;

    if ( FactDay < 0 )
      FactDay = 0;
    end;

    Calc_DayMonthYear_DataBase( FactDay, FactMonth, FactYear, Term, KindTerm, startDate );

    retValue.TermKind = KindTerm;
    retValue.TermValue = Term;

  elif ( ( FactDayProl != 0 ) or ( FactMonthProl != 0 ) or ( FactYearProl != 0 ) )
    Calc_DayMonthYear_DataBase( FactDayProl, FactMonthProl, FactYearProl, Term, KindTerm );

    retValue.TermKindProl = KindTerm;
    retValue.TermValueProl = Term;
  end;

  return retValue;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindDepType
(
  bankProductId : integer,
  flagCur : integer,
  kind : string
)
  var cmd, rs;
  var value = TWsDepType( );
  
  if ( ( ValType( bankProductId ) == V_INTEGER ) and ( bankProductId > 0 ) )
    cmd = RsdCommand( "select * from dsb_dtyp_dbt where t_isbankproduct = 'X' and t_bankproductid = ?" );

    cmd.AddParam( "BankProductId", RSDBP_IN, bankProductId );
  elif ( ( ValType( flagCur ) == V_INTEGER ) and ( ValType( kind ) == V_STRING ) and ( kind != "" ) )
    cmd = RsdCommand( "select * from dsb_dtyp_dbt where t_flagcur = ? and t_kind = ?" );

    cmd.AddParam( "FlagCur", RSDBP_IN, flagCur );
    cmd.AddParam( "Kind", RSDBP_IN, kind );
  else
    return null;
  end;

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    value.FlagCur       = rs.value( "t_FlagCur" );
    value.Kind          = rs.value( "t_Kind" );
    value.Name          = rs.value( "t_Name" );
    value.BankProductId = rs.value( "t_bankproductid" );
  else
    return null;
  end;

  return value;

  // onError( e )
  //   println( e );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro IsAllowChangePercentConditions ()

  if ( GetRegVal( "RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\РАСШИРЕННЫЙ_НАБОР_ДЕЙСТВИЙ\\СМЕНА_УСЛОВИЙ_ПРОЦЕНТОВ", false ) != 0 )
    return true;
  else
    return false;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CheckKeyDigitAcc
(
  account : string,
  bank_code : string,
  code_kind : integer
)

  if ( CheckKeyDigit( account, bank_code, code_kind ) == 0 )
    return true;
  else
    return false;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetAccountTemplate ()

  var template: string;
  template = GetRegVal( "RS-RETAIL\\INI\\ПЕРЕМЕННЫЕ\\ШАБЛОНЫ_ПОЛЕЙ\\ACCOUNTTEMPLATE", false );

  return template;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetBankAccountTemplate ()

  var template: string;
  template = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ОТОБРАЖЕНИЕ ПОЛЕЙ\\ACCOUNTFORMATTEMPL", false );

  return template;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro FillLastWillElement
(
	rs : RsdRecordSet,
	result : TWsLWResult,
	ObjectID : integer,
	IsAllWill : bool,
	branch : integer,
	id : integer
)
	var cmd, cmdIn, rsIn;
	var listElement;
	var list = TArray;
					  
	while ( rs.moveNext )
		listElement = TWsWillListElement;
		listElement.Id = SQL_ConvTypeInteger(rs.value("t_RefID"));
		listElement.AccReference = ObjectID;
		listElement.RegNumber = SQL_ConvTypeInteger(rs.value("t_WillRegNum"));
		listElement.QPart = SQL_ConvTypeStr(rs.value("t_QPart_M")) + "/" + SQL_ConvTypeStr(rs.value("t_QPart_N"));
		listElement.ClientID = SQL_ConvTypeInteger(rs.value("t_CodClient"));
		if (SQL_ConvTypeInteger(rs.value("t_CodClient")) == 0)
			listElement.FIO = SQL_ConvTypeStr( rs.value( "t_name1")) + " " + SubStr(SQL_ConvTypeStr( rs.value( "t_name2")),1,1) + 
			". " + SubStr(SQL_ConvTypeStr( rs.value( "t_name3")),1,1) + ". ";
			listElement.FullFIO = SQL_ConvTypeStr( rs.value( "t_name1")) + " " + SQL_ConvTypeStr(rs.value( "t_name2")) + 
			" " + SQL_ConvTypeStr( rs.value( "t_name3")) + " ";
		else
			cmdIn = RsdCommand( "SELECT p.t_name1, p.t_name2, p.t_name3 " +
								"FROM dpersn_dbt p WHERE p.t_personid = " + rs.value("t_CodClient"));
			cmdIn.execute;
			rsIn = RsdRecordSet( cmdIn );
			if ( rsIn.moveNext )
			  listElement.FIO = SQL_ConvTypeStr(rsIn.value("t_name1")) + " " + 
								SubStr(SQL_ConvTypeStr(rsIn.value("t_name2")),1,1) + ". " + 
								SubStr(SQL_ConvTypeStr(rsIn.value("t_name3")),1,1) + ". ";
			  listElement.FullFIO = SQL_ConvTypeStr(rsIn.value("t_name1")) + " " + 
									SQL_ConvTypeStr(rsIn.value("t_name2")) + " " + 
									SQL_ConvTypeStr(rsIn.value("t_name3")) + " ";
			end;
		end;
		
		listElement.IsNotarial = CharToBool( rs.value("t_isNotarial" ) );
		listElement.IsExistsCondition = CharToBool( rs.value("t_conditionIs" ));
		listElement.Condition = SQL_ConvTypeStr(rs.value("t_conditionText"));
		listElement.ConditionClientID = SQL_ConvTypeInteger(rs.value("t_ConditionClient"));
		if (SQL_ConvTypeInteger(rs.value("t_ConditionClient")) == 0)
			listElement.ConditionFIO = SQL_ConvTypeStr( rs.value( "t_ConditionSurName")) + " " + 
									   SubStr(SQL_ConvTypeStr( rs.value( "t_ConditionName")),1,1) + ". " +
									   SubStr(SQL_ConvTypeStr( rs.value( "t_ConditionPatronymic")),1,1) + ". "; 
			listElement.ConditionFullFIO = SQL_ConvTypeStr( rs.value( "t_ConditionSurName")) + " " +
											" " + SQL_ConvTypeStr( rs.value( "t_ConditionName")) + " " +
										    " " + SQL_ConvTypeStr( rs.value("t_ConditionPatronymic")) + " ";
		else
			cmdIn = RsdCommand( "SELECT p.t_name1, p.t_name2, p.t_name3 " +
								"FROM dpersn_dbt p WHERE p.t_personid = " + rs.value("t_ConditionClient"));
			cmdIn.execute;
			rsIn = RsdRecordSet( cmdIn );
			if ( rsIn.moveNext )
			  listElement.ConditionFIO = SQL_ConvTypeStr(rsIn.value("t_name1")) + " " +
								SubStr(SQL_ConvTypeStr(rsIn.value("t_name2")),1,1) + ". " +
								SubStr(SQL_ConvTypeStr(rsIn.value("t_name3")),1,1) + ". ";
			  listElement.ConditionFIO = SQL_ConvTypeStr(rsIn.value("t_name1")) + " " +
									SQL_ConvTypeStr(rsIn.value("t_name2")) + " " +
									SQL_ConvTypeStr(rsIn.value("t_name3")) + " ";
			end;
		end;
		listElement.OpenDate = SQL_ConvTypeDate(rs.value("t_dateopen"));
		listElement.CloseDate = SQL_ConvTypeDate(rs.value("t_closedate"));
		listElement.IsRefused = IIF ( SQL_ConvTypeInteger(rs.value("t_complexoper"))==-1, true, false);
		
		cmdIn = RsdCommand( " SELECT t_date FROM drtnfopr_dbt WHERE t_objectid = '?' AND ROWNUM = 1 "
							" ORDER BY t_date DESC, t_time DESC ");
		cmdIn.AddParam( "objectID", RSDBP_IN, "502/" + rs.value("t_referenc") );					
		cmdIn.execute;
		rsIn = RsdRecordSet( cmdIn );
		if ( rsIn.moveNext )
			listElement.ChangeDate = SQL_ConvTypeDate(rsIn.value("t_date"));
		end;
		
		if (IsAllWill == true)
			cmdIn = RsdCommand( " SELECT t_cznamealg FROM dsb_typop_dbt " +
								" WHERE t_iscur = 0 AND t_kind = 'Шаблонный'"
								" AND t_numopert = " + rs.value("t_ComplexOper"));
			cmdIn.execute;
			rsIn = RsdRecordSet( cmdIn );
			
			if ( rsIn.moveNext )
			  listElement.ComplexOperName = SQL_ConvTypeStr(rsIn.value("t_cznamealg"));
			end;
			
			cmdIn = RsdCommand( " SELECT sum(t_qpart_m) as sumpart, t_qpart_n " +
								"  FROM  dsbtrast_dbt " +
								"  WHERE t_fncash = " + branch +
								"  AND t_referenc = " + id +
								"  AND t_viddoc = CHR (6) " +
								"  AND t_action != 2 " +
								"  AND t_action != 11 " +
								"  AND t_complexoper <> -1 " +
								"  GROUP BY t_qpart_n ");
			cmdIn.execute;
			rsIn = RsdRecordSet( cmdIn );
			
			if ( rsIn.moveNext )
				var sumpart = rsIn.value("sumpart");
				var bf = rsIn.value("t_qpart_n");
				if (sumpart<bf)
					result.FreePart = string((bf - sumpart):0:0) + "/" + bf;
				end;
			end;				
		end;
		
		list.value(list.Size) =  listElement;
	end;
  result.TWSWLEList = list;
  return result;
end;

macro GetWillList
(
   ObjectType : integer, 	/* Вид объекта */
   ObjectID : string, 		/* Идентификатор объекта */
   IsAllWill : bool,		/* true - все завещания, false - только невыданные и неотмененные */
   ListType : integer,      /* Тип формируемого списка: завещания или наследство. */
   ClientId : integer 		/* Id выполняющего клиента */
)
	var cmd, rs, cmdIn, rsIn;
	var listElement;
	var list = TArray;
	var result = TWsLWResult;
	var branch,id,clientCode;
	
	if ((objectType != 550) AND (objectType != 551) AND (objectType != 556))
		return result;
	end;
	
	if ((objectType == 550) OR (objectType == 556))
		var slash = Index( ObjectID, "/" );
		var contractBranch = SubStr( objectId, 1, slash - 1 );
		var contractId = SubStr( objectId, slash + 1 );

		cmd = RsdCommand(
         " SELECT ctr.t_branch, ctr.t_id, ctr.t_number, ctr.t_clientcode "
         " FROM drt_contract_dbt ctr " 
         " WHERE ctr.t_branch = ? "
         " AND   ctr.t_id = ?");
		cmd.AddParam( "contractBranch" , RSDBP_IN, contractBranch );
		cmd.AddParam( "contractId", RSDBP_IN, contractId );
	else
		var prmcmdtext = " SELECT ctr.t_branch, ctr.t_id, ctr.t_number, ctr.t_clientcode " 
						 " FROM   drt_contract_dbt ctr, ddepositr_dbt dep "
						 " WHERE  ctr.t_branch = dep.t_fncash " 
						 " AND    ctr.t_number = dep.t_svodaccount "
						 " AND    ctr.t_type = 3 "
						 " AND    dep.t_referenc = ?";
		
		cmd = RsdCommand( prmcmdtext );
		cmd.AddParam("accref", RSDBP_IN, ObjectID);
	end;

	cmd.execute;
	rs = RsdRecordSet( cmd );
	if ( rs.moveNext )
		branch = rs.value("t_branch");
		id     = rs.value("t_id");
		result.DepNumber = rs.value("t_number");
		clientCode = rs.value("t_clientcode");
	end;	
	
	prmcmdtext = " SELECT t_death " +
					 " FROM dpersn_dbt " +
					 " WHERE t_personid = ? ";
	
	cmd = RsdCommand( prmcmdtext );
	cmd.AddParam( "personid", RSDBP_IN, clientCode );
	cmd.execute;
	rs = RsdRecordSet( cmd );
	
	if ( rs.moveNext )
		if (SQL_ConvTypeDate(rs.value("t_death")) == Date( 0, 0, 0 ))
			result.IsDeadClient = false;
		else
			result.IsDeadClient = true;
		end;
	end;	
	
	if (ListType!=-1)
		result.ListType = ListType;
	else
		result.ListType = IIF ( result.IsDeadClient==false, 0, 1);
	end;
	
	var commandtext = " SELECT * " 
					  " FROM dsbtrast_dbt t  " 
					  " WHERE t.t_fncash = ? " 
					  " AND t.t_referenc = ? "
					  " AND t_action != 2  " 
					  " AND t_action != 11 " ;
	
	if (result.IsDeadClient == true)
		if (result.ListType==0)
			commandtext = commandtext + " AND t.t_viddoc = CHR (6) ";
		else
			commandtext = commandtext + " AND t.t_viddoc = CHR (1) ";
		end;
	else
		commandtext = commandtext + " AND t.t_viddoc = CHR (6) ";
	end;
					  
	if (IsAllWill == true)
		commandtext = commandtext + " ORDER BY DECODE(t.t_complexoper , 0, 0, -1, 2, 1), t.t_closedate, t.t_dateopen;";
	else
		commandtext = commandtext + " AND t.t_closedate = TO_DATE ('0101001', 'ddmmyyyy') AND t.t_complexoper = 0" +
					  " ORDER BY DECODE (t_codclient, ? , 0, 1), t_dateopen; ";
	end;				  

	cmd = RsdCommand( commandtext );
	cmd.AddParam( "branch", RSDBP_IN,  branch);
	cmd.AddParam( "id", RSDBP_IN,  id);
	if (IsAllWill == false)
		cmd.AddParam( "clientId", RSDBP_IN,  ClientId);
	end;
	cmd.execute;
       
	rs = RsdRecordSet( cmd );
	return FillLastWillElement(rs,result,objectID,IsAllWill,branch,id);
end;

macro GetWillListCount
(
   ObjectType : integer, 	/* Вид объекта */
   ObjectID : string, 		/* Идентификатор объекта */
   IsAllWill : bool,		/* true - все завещания, false - только невыданные и неотмененные */
   ListType : integer,      /* Тип формируемого списка: завещания или наследство. */
   ClientId : integer 		/* Id выполняющего клиента */
)
	return GetWillList(ObjectType,ObjectID,IsAllWill,ListType,ClientId).TWSWLEList.Size();
end;
/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintWill
(
	AccReference : integer, /*Референс счета, по которому оформлено завещание*/
	WillRefId    : integer  /*Идентификатор завещания*/
)
    var depositr:tbfile = Tbfile("depositr.dbt");
    depositr.KeyNum = 8;
    depositr.rec.referenc = AccReference;
    depositr.getEQ();
    
    var sbtrast:tbfile = Tbfile("sbtrast");
    sbtrast.rec.refid = WillRefId;
    sbtrast.KeyNum = 4;
    sbtrast.getEQ();
	
    var rtnfopr:tbfile = Tbfile("rtnfopr.dbt");
    rtnfopr.KeyNum = 7;
    rtnfopr.rec.objectid = "502/" + string(sbtrast.rec.referenc);
	
    while (rtnfopr.prev())
    	if ((rtnfopr.rec.objectType==232) OR (rtnfopr.rec.objectType==233) OR (rtnfopr.rec.objectType==235) OR (rtnfopr.rec.objectType==238))
    		break;
    	end;
    end;
    
    var fileName = getTxtFileName( "will_1" );
    SetOutput(getTxtFileName(fileName));
    Pr_Trast(depositr.rec.CodClient,depositr,sbtrast,rtnfopr);
    fileName = ConvertTxt2Html ( fileName );
    return CreateFileContainer ( fileName ); 
end;

macro GetWillData
(
	WillId : integer /* Идентификатор завещания */
)
	var cmd, rs;
	var result = TWsWillListElement;
	
	cmd = RsdCommand( " SELECT * FROM dsbtrast_dbt WHERE t_refid = ?");
	cmd.AddParam( "refid", RSDBP_IN,  WillId);
	cmd.execute;
	rs = RsdRecordSet( cmd );
	
	return FillLastWillElement(rs).TWSWLEList[0];
end;
macro GetClientDeathDate
(
	Id: integer /*Идентификатор клиента*/
)
	var cmd, rs;

	cmd = RsdCommand( " SELECT t_death   FROM dpersn_dbt  WHERE t_personid = ?" );
	
	cmd.AddParam( "Id", RSDBP_IN,  Id);
	
	cmd.execute;
       
	rs = RsdRecordSet( cmd );

	if (rs.moveNext)
		return SQL_ConvTypeDate(rs.value("t_death"));
	end;
	return null;
end;

macro IsExistsHeirs
(
 ObjectType: integer, /* тип объекта продукта клиента */
 ObjectId: string /* Id объекта продукта клиента */
)
   if (ObjectType == 551)
		var cmd, rs;
		cmd = RsdCommand( " SELECT 1 FROM DUAL WHERE EXISTS " 
			" 	(SELECT t.t_refid FROM dsbtrast_dbt t, drt_contract_dbt ctr, ddepositr_dbt dep "
			"    WHERE     t.t_fncash = ctr.t_branch "
			"       AND t.t_referenc = ctr.t_id "
			"       AND (t.t_viddoc = CHR (6)  OR t.t_viddoc = CHR(1)) "
			"       AND t.t_action <> 2 "
			"       AND t.t_action <> 11 "
			"       AND ctr.t_branch = dep.t_fncash "
			"       AND ctr.t_number = dep.t_svodaccount "
			"       AND ctr.t_type = 3 "
			"       AND dep.t_referenc = ?) ");
		
		cmd.AddParam( "ObjectId", RSDBP_IN,  ObjectId);
		
		cmd.execute;
		   
		rs = RsdRecordSet( cmd );

		if (rs.moveNext)
			return true;
		end;
	end;
	return false;
end;
macro LookupAccountByNum(sub, listLen,  partyID , Fiid, openClose, dprtCode, accountType)

  var cmd, rs;
  var Arr = TArray;
  var query;
  
  if ( Fiid > -1 )
	  query = " SELECT   cur.t_code_currency  FROM dfininstr_dbt fi, dcurrency_dbt cur WHERE fi.t_fiid=? and cur.t_externalcode = fi.t_fi_code " ;
	  cmd = RsdCommand( query );

	  cmd.addParam( "", RSDBP_IN, Fiid );
	  
	  cmd.execute;

	  rs = RsdRecordSet( cmd );

	 if ( rs.moveNext )
		  Fiid = rs.value("t_code_currency");
	  end;

  end;

  query = "  select * from ddepositr_dbt  WHERE 1=1 ";

  if(sub != "")
		query = query + " AND LOWER(t_account) LIKE LOWER ( ? ) ";
  end;

  if ( partyID > 0 )
    query = query + " and t_CodClient = " + String( partyID );
  end;

  if ( Fiid > -1 )
    query = query + " and t_Code_Currency = " + String( Fiid );
  end;

  if ( openClose == 0 )
    query = query + " and t_Open_Close = chr( 0 )";
  elif ( openClose == 1 )
    query = query + " and t_Open_Close != chr( 0 )";
  end;

  if (dprtCode > 0)
	  query = query + " and t_FNCash = " + String( dprtCode );
  end;
  
  if (accountType != "")
	  query = query + " and t_type_account = '" + String( accountType ) + "' ";
  end;
  
  if( listLen != 0 )
		query = query + " AND ROWNUM < " + string(listLen);
  end;
  
  query = query + " ORDER BY  t_referenc ";
  cmd = RsdCommand(query);
  
  if(sub != "")
		cmd.addParam( "", RSDBP_IN, sub );
  end;
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var value = TWsDepAccount;

    value.Reference     	 = rs.value( "t_Referenc" );
    value.AccountNumber = rs.value( "t_Account" );
    value.CurrencyCode  	 = rs.value( "t_Code_Currency" );
    value.ClientCode    	 = rs.value( "t_CodClient" );
    value.Branch        		 = rs.value( "t_FNCash" );
    value.AccountType   	 = rs.value( "t_Type_Account" );
    value.OpenDate     	 	 = rs.value( "t_Open_Date" );
    value.CloseDate     	 = rs.value( "t_Close_Date" );

    FillPumpFields( value );

    Arr[Arr.size] = value;

  end;
  
  return Arr;
  
end;

macro LookupPayKind(sub, isCurrenced, isBankProductOnly, listLen)
  var cmd, rs;
  var Arr = TArray;
  var query = "  SELECT * FROM dsb_dtyp_dbt  WHERE 1=1 ";

  if (sub != "")
		query = query + " AND LOWER(t_kind) LIKE LOWER ('%' || ? || '%') ";
  end;

  if (isCurrenced != null)
	  query = query + " and t_flagcur = " + IIF (isCurrenced == true,1,0);
  end;
  
  if (isBankProductOnly == true)
	  query = query + " and (T_PRODUCTKINDID = 50 or T_PRODUCTKINDID = 51 or T_PRODUCTKINDID = 53) "
  end;
  
  if( listLen != 0 )
		query = query + " AND ROWNUM < ?";
  end;
  
  query = query + " ORDER BY  t_kind";
  
  cmd = RsdCommand(query);
  
  if (sub != "")
		cmd.addParam( "", RSDBP_IN, sub );
  end;
  if( listLen != 0 )
		cmd.addParam( "", RSDBP_IN, listLen );
  end;
  
  rs = RsdRecordset(cmd);
  
  while(rs.movenext)

    var value = TWsPayKind;

    value.Kind     	 	= rs.value( "t_kind" );
    value.KindName 	= rs.value( "t_name" );
	
    Arr[Arr.size] = value;

  end;
  return Arr;
end;

macro GetPayKindList(isCurrenced, isBankProductOnly, pageNumber, pageSize, FilterItems, OrderItems)
  
  var cmd, rs;
  var Arr = TArray;
  var query = "  SELECT * FROM dsb_dtyp_dbt  WHERE 1=1 ";

  if (isCurrenced != null)
	  query = query + " and t_flagcur = " + IIF (isCurrenced == true,1,0);
  end;
  
  if (isBankProductOnly == true)
	  query = query + " and (T_PRODUCTKINDID = 50 or T_PRODUCTKINDID = 51 or T_PRODUCTKINDID = 53) "
  end;
  
  if ((FilterItems != null) AND (FilterItems.Size > 0))
	  var FilterItemsCount = 0;
	  while( FilterItemsCount < FilterItems.Size )
		
		if ((FilterItems[FilterItemsCount].id == 0) and (FilterItems[FilterItemsCount].Value[0] != null))
			query = query + " and t_flagcur = " + IIF ((FilterItems[FilterItemsCount].Value[0] == true),1,0);
		end;
		
		if (FilterItems[FilterItemsCount].id == 1)
			query = query + IIF(FilterItems[FilterItemsCount].Value[0] == true, " and (T_PRODUCTKINDID = 50 or T_PRODUCTKINDID = 51 or T_PRODUCTKINDID = 53)", "");
		end;
		
		FilterItemsCount = FilterItemsCount + 1;
	  
	  end;
  end;
  
  if (OrderItems.Size == 0)
	  query = query + " ORDER BY  t_kind";
  elif (OrderItems[0].Column == "KindName")
	  query = query + " ORDER BY t_name"
  elif (OrderItems[0].Column == "Kind")
	  query = query + " ORDER BY t_kind"
  end;
  
  query = SQL_WrapSelect(query, pageNumber, pageSize);
  
  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);
  
  while(rs.movenext)
		var value = TWsPayKind;
		value.Kind     	 		= rs.value( "t_kind" );
		value.KindName 	= rs.value( "t_name" );
		value.IsCurrenced  =  IIF ((rs.value( "t_flagcur") == 1), true, false);
		Arr[Arr.size] = value;
	end;
  return Arr;
end;

macro GetPayKindListCount(isCurrenced, isBankProductOnly, pageNumber, pageSize, FilterItems, OrderItems)
  
  var cmd, rs;
  var Arr = TArray;
  var query = "  SELECT Count(*) as Count FROM dsb_dtyp_dbt  WHERE 1=1 ";

  if (isCurrenced != null)
	  query = query + " and t_flagcur = " + IIF (isCurrenced == true,1,0);
  end;
  
  if (isBankProductOnly == true)
	  query = query + " and (T_PRODUCTKINDID = 50 or T_PRODUCTKINDID = 51 or T_PRODUCTKINDID = 53) "
  end;
  
  if ((FilterItems != null) AND (FilterItems.Size > 0))
	  var FilterItemsCount = 0;
	  while( FilterItemsCount < FilterItems.Size )
		
		if (FilterItems[FilterItemsCount].id == 0)
			query = query + " and t_flagcur = " + IIF ((FilterItems[FilterItemsCount].Value[0] == true),1,0);
		end;
		
		if (FilterItems[FilterItemsCount].id == 1)
			query = query + IIF(FilterItems[FilterItemsCount].Value[0] == true, " and (T_PRODUCTKINDID = 50 or T_PRODUCTKINDID = 51 or T_PRODUCTKINDID = 53)", "");
		end;
		
		FilterItemsCount = FilterItemsCount + 1;
	  
	  end;
  end;
  
  query = query + " ORDER BY  t_kind";
  
  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);
  
  var count : integer;
  count = 0;
  if (rs.movenext)
		count = rs.value("Count");
  end;
  
  return count;
  
end;

macro GetRetailCurrencyList(IsRubInList, IsViewAnyCurr, IsViewWithoutRate, IsViewIngot, pageNumber, pageSize, FilterItems, OrderItems)
  var cmd, rs;
  var Arr = TArray;
  var query = "  SELECT * FROM dcurrency_dbt  WHERE 1=1 ";

  if (IsRubInList == false)
	  query = query + " AND t_code_currency != 0 "
  end;
  
  if (IsViewAnyCurr == false)
	  query = query + " AND t_code_currency != -1 "
  end;
  if (IsViewWithoutRate == false)
	  query = query + " AND t_crdifrrate = 'X' "
  end;
  if (IsViewIngot == false)
	  query = query + " AND t_materialref = 0 "
  end;

  query = SQL_WrapSelect(query, pageNumber, pageSize);
  
  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);
  
  while(rs.movenext)
		var value 					= TWsRtlCurrency;
		value.CurrencyCode	= rs.value( "t_code_currency" );
		value.ShortName        = rs.value( "t_short_name" );
		value.ExternalCode 	= rs.value( "t_externalcode" );
		value.CurrencyName	= rs.value( "t_name_currency" );
		Arr[Arr.size] = value;
	end;
  return Arr;
end;

macro GetRetailCurrencyByID(curID)
  var cmd, rs;
  var query = "  SELECT * FROM dcurrency_dbt  WHERE t_code_currency = ? ";
  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, curID );
  rs = RsdRecordset(cmd);
  var value = TWsRtlCurrency;
  if (rs.movenext)
	value.CurrencyCode	 = rs.value( "t_code_currency" );
	value.ShortName       = rs.value( "t_short_name" );
	value.ExternalCode   = rs.value( "t_externalcode" );
	value.CurrencyName = rs.value( "t_name_currency" );
  end;
  return value;
end;

macro LookupRetailCurrency(sub, listLen)
  var cmd, rs;
  var Arr = TArray;
  var query = "  SELECT * FROM dcurrency_dbt  WHERE t_code_currency >= 0 ";

  if (sub != "")
		query = query + " AND LOWER(t_externalcode) LIKE LOWER ('%' || ? || '%') ";
  end;

  if( listLen != 0 )
		query = query + " AND ROWNUM < ?";
  end;
 
  cmd = RsdCommand(query);
  
	if (sub != "")
		cmd.addParam( "", RSDBP_IN, sub );
	end;
	if( listLen != 0 )
		cmd.addParam( "", RSDBP_IN, listLen );
	end;
  
	rs = RsdRecordset(cmd);
  
	while(rs.movenext)
		var value 					= TWsRtlCurrency;
		value.CurrencyCode	= rs.value( "t_code_currency" );
		value.ShortName        = rs.value( "t_short_name" );
		value.ExternalCode 	= rs.value( "t_externalcode" );
		value.CurrencyName	= rs.value( "t_name_currency" );
		Arr[Arr.size] = value;
	end;
	
	return Arr;
end;

macro GetTotalParts(contractID: integer, contractBranch: integer, docType: integer)
	return wf_GetTotalParts(contractID, contractBranch, docType);
end;

macro CheckUIP(account,chargeId)
    var stat = CheckChargeID(account,chargeId);
    var retval:string = "";
    var cmd = RsdCommand(
             "SELECT *"                  +
             "FROM  dsbbank_msg  msg "   +
             "WHERE msg.T_NUMBER = ?");
              cmd.AddParam( "T_ID", RSDBP_IN,stat);
              cmd.nullConversion = true;
              cmd.execute();
              var msg = RsdRecordSet( cmd );
              if((msg.moveNext()) and  (stat!=0))
                  retval = msg.value("t_contents");
              end;
   return retval;
end;

macro GetPlanPayKindList (
   ObjectType : integer,  /* вид объекта */
   ObjectID   : string    /* идентификатор объекта с видом objecttype в продукте/объекте продукта клиента */
)
   var PPKindList = Tarray();
   var cmd;
   var query;
   if(objectType == 551)
   
       query = " SELECT typ.T_NUMOPERT, typ.T_CZNAMEALG FROM dsb_typop_dbt typ, ddepositr_dbt dep " +
               " WHERE typ.T_KIND = dep.t_TYPE_ACCOUNT AND typ.T_ISCUR = dep.t_ISCUR AND typ.T_NUMOPERT >= 10 " +
               " AND typ.T_NUMOPERT <= 87 AND ( (typ.t_SysNumb = 0 OR typ.T_NUMOPERT = 64) AND ( /*typ.T_NUMOPERT = 44*/ " +
               " /*OR typ.T_NUMOPERT = 45 OR*/ typ.T_UPNUMOPERT = 34 OR typ.T_UPNUMOPERT = 61) AND typ.T_NUMOPERT <> 62) " +
               " AND dep.T_REFERENC = ? ORDER BY typ.T_NUMOPERT";
       cmd = RsdCommand( query );
       cmd.AddParam( "T_REFERENCE", RSDBP_IN, ObjectID );
   elif(objectType == 554)
       var slash = Index( objectId, "/" );
       var fnCash = SubStr( objectId, 1, slash - 1 );
       var cardRef = SubStr( objectId, slash + 1 );

       query = "SELECT typ.T_NUMOPERT, typ.T_CZNAMEALG FROM dsb_typop_dbt typ, dsccard_dbt crd, " +
               " ddepositr_dbt dep, dsclink_dbt lnk WHERE typ.T_KIND = dep.t_TYPE_ACCOUNT " +
               " AND typ.T_ISCUR = dep.t_ISCUR AND typ.T_NUMOPERT >= 10 AND typ.T_NUMOPERT <= 87 " +
               " AND ( (typ.t_SysNumb = 0 OR typ.T_NUMOPERT = 64) AND ( /*typ.T_NUMOPERT = 44*/ " +
               " /*OR typ.T_NUMOPERT = 45 OR*/ typ.T_UPNUMOPERT = 34 OR typ.T_UPNUMOPERT = 61) " +
               " AND typ.T_NUMOPERT <> 62) AND LNK.T_CARDACCREF = DEP.T_REFERENC AND LNK.T_FNCASH = CRD.T_FNCASH " +
               " AND LNK.T_CARDREF = CRD.T_CARDREF AND CRD.t_fncash = ? AND CRD.t_cardref = ? ORDER BY typ.T_NUMOPERT";

       cmd = RsdCommand( query );
       cmd.AddParam( "tfncash" , RSDBP_IN, fnCash );
       cmd.AddParam( "tcardref", RSDBP_IN, cardRef );
   else
       return PPKindList; 
   end;
   
   cmd.nullConversion = true;
   cmd.execute();
   var ppk = RsdRecordSet( cmd );
   while ( ppk.moveNext() )
      var elem = TWsTypOp;
      elem.numoper = ppk.value("T_NUMOPERT");
      elem.nameoper = ppk.value("T_CZNAMEALG");
      PPKindList[PPKindList.size] = elem;
   end;
   return PPKindList;  
end;

macro GetPlanPayKindListByTypeAccount(isCur: integer, typeAccount: string)
  var list = Tarray();
  var  cmd = RsdCommand(
      "SELECT t_numopert, t_cznamealg " +
      "FROM dsb_typop_dbt " +
      "WHERE t_iscur = ? and t_kind = ? "+
      " AND T_NUMOPERT >= 10 AND T_NUMOPERT <= 87 " +
      " AND ( (t_SysNumb = 0 OR T_NUMOPERT = 64) AND ( T_NUMOPERT = 44 " +
      " OR T_NUMOPERT = 45 OR T_UPNUMOPERT = 34 OR T_UPNUMOPERT = 61) AND T_NUMOPERT <> 62)" +
      "ORDER BY t_numopert");
  cmd.AddParam( "t_iscur" , RSDBP_IN, isCur );
  cmd.AddParam( "t_kind" , RSDBP_IN, typeAccount );
  cmd.nullConversion = true;
  cmd.execute();
  var rs = RsdRecordSet( cmd );
  while(rs.movenext)
   var elem = TWsTypOp();
   elem.numOper               = rs.value("t_numopert");
   elem.nameOper         = rs.value("t_cznamealg");
   list[list.size]   = elem;
 end;
 return list;
end;

macro PaymentPlanPay (Id : integer)
  var result : TWsRtlOperationResult;
  var applKind : integer = 0;
  var applKey : string = "";
  var oldBatchMode = setbatchmode(true);
  var stat = TreatOnePlanPayments(Id, applKind, applKey);
  setbatchmode(oldBatchMode);
  
  result.AppKind = applKind;
  result.AppKey = applKey;
  result.State = stat;

  if ( stat > 0 )
    RunError( ErrMessage( stat ), stat) ;
  elif ( stat < 0 )
    RunError("Ошибка при оплате длительного поручения");
  end;

  return result;
end;

macro GetRTCPTypeList ( findFlag : integer )
  var list = Tarray();
  var sql = "select * from drtcp_type_dbt";
  
  if ( findFlag == 1 )
    sql = sql + " where T_ISHIDDEN <> chr(88)";
  elif ( findFlag == 2 )
    sql = sql + " where T_ISHIDDEN = chr(88)";
  end;
  var  cmd = RsdCommand( sql );
  cmd.nullConversion = true;
  cmd.execute();
  var rs = RsdRecordSet( cmd );
  while(rs.movenext)
    var elem = TWsRTCPType();
    elem.Id = rs.value("T_ID");
    elem.code = rs.value("T_CODE");
    elem.name = rs.value("T_NAME");
    elem.inbudget = rs.value("T_INBUDGET");
    list[list.size] = elem;
  end;
  return list;
end;

macro GetRTCPType ( Id : integer )
  var retval = TWsRTCPType();
  var  cmd = RsdCommand( "select * from drtcp_type_dbt where t_id = ?" );
  cmd.AddParam( "id" , RSDBP_IN, Id );
  cmd.nullConversion = true;
  cmd.execute();
  var rs = RsdRecordSet( cmd );
  if(rs.movenext)
    retval.Id = rs.value("T_ID");
    retval.code = rs.value("T_CODE");
    retval.name = rs.value("T_NAME");
    retval.inbudget = rs.value("T_INBUDGET");
  end;
  return retval;
end;

macro GetPlanPayTransferTypeList ( accountID : Integer, planpayRef : Integer )
  var list = Tarray();
  var reallistppay = Tarray();
  var cmd;
  
  if ( accountID <= 0 )
    return list;
  end;
  
  if ( planpayRef > 0 )
    cmd = RsdCommand( "SELECT * FROM ddppaysub_dbt WHERE T_ACTION <> 2 AND T_REF = ?" );
    cmd.AddParam( "refID" , RSDBP_IN, planpayRef );
    cmd.nullConversion = true;
    cmd.execute();
    var rsref = RsdRecordSet( cmd );
    while(rsref.movenext)
      var el = TWsPlanPayTransferType();
      el.NumOper = rsref.value("t_NumOper");
      el.NumSubOper = rsref.value("t_NumSubOper");
      el.Name = "";
      el.IsInclude = true;
      reallistppay[reallistppay.size] = el;
    end;
  end;
  
  var sql = "SELECT sb_typop.* FROM dsb_typop_dbt sb_typop, ddepositr_dbt dep " +
            " WHERE sb_typop.t_ISCUR = DEP.T_ISCUR AND sb_typop.t_KIND = DEP.T_TYPE_ACCOUNT " +
            " AND sb_typop.T_NUMOPERT IN (3, 41, 42, 45, 47, 71, 72, 73, 74, 88) AND sb_typop.t_SysNumb = 0 " +
            " AND DEP.T_REFERENC = ?";
  cmd = RsdCommand( sql );
  cmd.AddParam( "accID" , RSDBP_IN, accountID );
  cmd.nullConversion = true;
  cmd.execute();
  var rs = RsdRecordSet( cmd );
  while(rs.movenext)
    var elem = TWsPlanPayTransferType();
    elem.NumOper = rs.value("T_NUMOPERT");
    elem.NumSubOper = 0;
    elem.Name = rs.value("T_CZNAMEALG");
    elem.IsInclude = false;

    if (reallistppay.size > 0)
    var j;
      for (j, 0,reallistppay.size-1)
        if ( (elem.NumSubOper == reallistppay(j).NumSubOper) and (elem.NumOper == reallistppay(j).NumOper) )
          elem.IsInclude = true;
        end;
      end;
    end;

    sql = "select * from dsuboper_dbt where t_iscur = ? and t_kind = ? and t_opertype = ? and T_HIDEFROMOPER <> 'X'";
    cmd = RsdCommand( sql );
    cmd.AddParam( "iscur" , RSDBP_IN, rs.value("t_ISCUR") );
    cmd.AddParam( "kind" , RSDBP_IN, rs.value("t_KIND") );
    cmd.AddParam( "opertype" , RSDBP_IN, elem.NumOper );
    cmd.nullConversion = true;
    cmd.execute();
    var rsSubOp = RsdRecordSet( cmd );
    while(rsSubOp.movenext)
      if(not ValType(elem.Children)) elem.Children = Tarray();    
      end;
      var children = TWsPlanPayTransferType();
      children.NumOper = elem.NumOper;
      children.NumSubOper = rsSubOp.value("T_TYPE");
      children.Name = rsSubOp.value("T_NAME");
      children.IsInclude = false;

      if (reallistppay.size > 0)
        var j1;
        for (j1, 0,reallistppay.size-1)
          if ( (children.NumSubOper == reallistppay(j).NumSubOper) and (children.NumOper == reallistppay(j).NumOper) )
            children.IsInclude = true;
          end;
        end;
      end;
      
      elem.Children[elem.Children.size] = children;  
    end;

    list[list.size] = elem;
  end;

  return list;
end;

macro GetPlanPayTransferTypeListCount ( accountID : Integer, planpayRef : Integer )
  var list = GetPlanPayTransferTypeList( accountID, planpayRef );
  var count = list.size();

  if (count > 0)
  var i;
    for (i, 0, count-1)
      if ( ValType(list(i).Children) )
        count = count + list(i).Children.size();
      end;
    end;
  end;

  return count;
end;

macro GetGISParam ( appkind, appkey )
  var retval = TWsGisZHKHParam;
  var cmdParam = RsdCommand( "SELECT * FROM dpay_doc_cp_dbt " +
                             " WHERE T_APPLKIND = ? AND T_APPLKEY = ?");
  cmdParam.AddParam( "appkind" , RSDBP_IN, -appkind );
  cmdParam.AddParam( "appkey" , RSDBP_IN, appkey );
  cmdParam.nullConversion = true;
  cmdParam.execute();
  var param = RsdRecordSet( cmdParam );
  if ( param.moveNext() )
    retval.month = param.value("t_month");
    retval.year = param.value("t_year");
    retval.isForGIS = IIF( param.value("t_isForGIS") == "X", true, false);
    retval.payerId = param.value("t_payerId");
    retval.serviceId = param.value("t_serviceId");
    retval.gisDocNumber = param.value("t_gisDocNumber");
    retval.houseId = param.value("t_houseId");
    retval.flatId = param.value("t_flatId");
    retval.nonLiving = IIF( param.value("t_nonLiving") == "X", true, false);
    retval.roomId = param.value("t_roomId");
    retval.consumerSurName = param.value("t_consumerSurName");
    retval.consumerFirstName = param.value("t_consumerFirstName");
    retval.consumerPatronymic = param.value("t_consumerPatronymic");
    retval.supplierINN = param.value("t_supplierINN");
    retval.supplierKPP = param.value("t_supplierKPP");
    retval.supplierName1 = param.value("t_supplierName1");
    retval.supplierName2 = param.value("t_supplierName2");
    retval.supplierName3 = param.value("t_supplierName3");
    retval.supplierShortName = param.value("t_supplierShortName");
    retval.personId = param.value("t_personId");
  end;
  return retval;
end;

macro GetPlanpayGISParam( planpayId )
  var retval = TWsGisZHKHParam;
  var sql = "SELECT * FROM ddplanpay_dbt pp WHERE pp.T_REF = ? ";
  var cmd = RsdCommand( sql );
  cmd.AddParam( "planpayId" , RSDBP_IN, planpayId );
  cmd.nullConversion = true;
  cmd.execute();
  var pp = RsdRecordSet( cmd );
  if ( pp.moveNext() )
    retval = GetGISParam ( pp.value("t_iapplicationkind"), pp.value("t_applicationkey") );
    
    cmd = RsdCommand ("select * from dpersn_dbt where t_personid = ?");
    cmd.AddParam( "person" , RSDBP_IN,  pp.value("t_codclient") );
    cmd.nullConversion = true;
    cmd.execute();
    var pname = RsdRecordSet( cmd );
    if ( pname.moveNext )
      retval.payerSurName = pname.value("t_name1");
      retval.payerFirstName = pname.value("t_name2");
      retval.payerPatronymic = pname.value("t_name3");
    end;
    if ( (retval.payerSurName == retval.consumerSurName) and
         (retval.payerFirstName == retval.consumerFirstName) and
         (retval.payerPatronymic == retval.consumerPatronymic) )
      retval.isConsumerLikePayer = true;
    else
      retval.isConsumerLikePayer = false;
    end;
  end;
  return retval;
end;

macro GetPlanPayPayerParam (clientId)
  var retVal = TWsGisZHKHParam;
  private var clientList = TClientList;
  if ( clientId > 0 )
    if ( clientList.GetRecord( clientId ) )
      if ( ( clientList.CurRec.rec.PaperSeries != "" ) or ( clientList.CurRec.rec.PaperNumber != "" ) )
        retVal.personId = MakePersonId( clientList.CurRec.rec.PaperKind, clientList.CurRec.rec.PaperSeries, clientList.CurRec.rec.PaperNumber );
      else
        retVal.personId = "0000000000000000000000000";
      end;
     end;
   
    var cmd = RsdCommand ("select * from dpersn_dbt where t_personid = ?");
    cmd.AddParam( "person" , RSDBP_IN,  clientId );
    cmd.nullConversion = true;
    cmd.execute();
    var pname = RsdRecordSet( cmd );
    if ( pname.moveNext )
      retVal.payerSurName = pname.value("t_name1");
      retVal.payerFirstName = pname.value("t_name2");
      retVal.payerPatronymic = pname.value("t_name3");
    end;
  end;  
  return retVal;
end;

macro WasTransferMoneySubOpKind ( planPayRef, dateDoc )

  var cmd, rs;
  var retVal = false;

  if ( ( dateDoc == NULL) or ( dateDoc < Date( 2, 1, 1 ) ) )
    dateDoc = {curdate};
  end;

  cmd = RsdCommand( "select sbdepdoc.t_typeoper as typeOper from ddplanpay_dbt dplanpay, dsbdepdoc_dbt sbdepdoc, ddppaysub_dbt dppaysub " +
                    "where dplanpay.t_ref = ? " +
                       "and sbdepdoc.t_referenc = dplanpay.t_reference " +
                       "and sbdepdoc.t_date_document = ? " +
                       "and sbdepdoc.t_action != 2 " +
                       "and exists ( select 1 from dual where dppaysub.t_ref = dplanpay.t_ref " +
                                                                       "and dppaysub.t_numoper =  sbdepdoc.t_typeoper  " +
                                                                       "and (dppaysub.t_numsuboper = sbdepdoc.t_appltype or dppaysub.t_numsuboper = 0 )  " +
                                                                       "and dppaysub.t_action != 2 )" );

  cmd.AddParam( "ref", RSDBP_IN, planPayRef );
  cmd.AddParam( "dateDoc", RSDBP_IN, dateDoc );

  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    retVal = true;
  end;

  return retVal;
end;


/**************************************************************************\
| Сервис проверки текста регулярным выражением                             |
\**************************************************************************/
macro CheckRegularExpression( text : String, expression : String)
  var cmd, rs;

  cmd = RsdCommand("SELECT 1 FROM DUAL WHERE REGEXP_LIKE (?, ?)");
  cmd.AddParam("text",       RSDBP_IN, text);
  cmd.AddParam("expression", RSDBP_IN, expression);
  cmd.nullConversion = true;
  cmd.execute();
  rs = RsdRecordSet(cmd);
  if ( rs.moveNext)
    return true;
  end;
  return false;
end;

macro GetFIIDByRtCurrency( CurrencyCode )
  var cmd;
  var rs;
  var outCurCode = CurrencyCode;
  var saveInCurCode = -2;
  var saveOutCurCode = 0;

  if ( saveInCurCode == CurrencyCode )
    return saveOutCurCode;
  end;

  cmd = RsdCommand( "SELECT FI.T_FIID FROM dfininstr_dbt fi, " +
                    "(SELECT CR.T_EXTERNALCODE ISO_CODE FROM dcurrency_dbt cr " +
					"WHERE CR.T_CODE_CURRENCY = ?) rtcur WHERE  FI.T_FI_KIND = 1 " +
					"AND (FI.T_ISO_NUMBER = rtcur.ISO_CODE OR FI.T_CODEINACCOUNT = rtcur.ISO_CODE)" );

  cmd.addParam( "curCode", RSDBP_IN, CurrencyCode );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "t_fiid" ) ) != V_UNDEF )
      outCurCode = Int( rs.value( "t_fiid" ) );
    end;
  end;

  saveInCurCode = CurrencyCode;
  saveOutCurCode = outCurCode;

  return outCurCode;
end;