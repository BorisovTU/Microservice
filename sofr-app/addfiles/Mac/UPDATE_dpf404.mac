/*update_dpf404.mac*/
/*заполнение примечания "счет владельца" на записях КДУ*/ 
/*определим перечень бумаг на дату*/
import RsbDataSet;
import FIInter, DPInter, secinter, BankInter; 

 var DataFIID;
 var m_end_date = date(31,12,2019);
 private var  m_Avoiriss = TRecHandler("avoiriss.dbt"),
              m_Fininstr = TRecHandler("fininstr.dbt");
/*
  private macro IIF(condition,value_true,value_false)
    if (condition)
        return value_true;
    else
        return value_false;
    end;
  end;


private macro CodeID (StrId: string)
var leng = StrLen (StrId);

return iif (leng,);
end;
*/

Macro ExtStr(Str, Len, Fill, Right)
   Var Add;
   if (not Fill)
      Fill = " ";
   end;
   Add = MkStr(String(Fill), Len - StrLen(Str = String(Str)));
   if (Right)
      Return Str + Add;
   else
      Return Add + Str;
   end;
end;

 var error = 0, sql, cmd, query,  query_FIID, NetData, sql_FIID, DataSet, Num = 0, IsErrPrint = false;
     sql_FIID = "select fin.t_FIID, issuer.t_partyid as Issuer, "
              + " (CASE WHEN fin.t_SumPrecision > 0 THEN 4 ELSE 0 END) as SumPrecision "
              + "  from dfininstr_dbt fin, dparty_dbt issuer "
              + " where FIN.T_FI_KIND = " + FIKIND_AVOIRISS
              /*сделки с варрантами попадать не должны (пропишу явно на всякий случай)*/
              + "   and fin.t_AvoirKind != "+AVOIRISSKIND_WARRANT
              + "   and issuer.t_partyid = "
              + "          (CASE"
              + "             WHEN RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, "+AVOIRISSKIND_DEPOSITORY_RECEIPT+", fin.t_AvoirKind) = 1 "
              + "             THEN NVL ((SELECT RSI_RSB_FIInstr.FI_GetIssuerOnDate( parentfin.t_FIID, ? ) "
              + "                          FROM dfininstr_dbt parentfin  "
              + "                         WHERE parentfin.t_FIID = fin.t_ParentFI), -1 ) "
              + "          ELSE  RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) "
              + "          END ) "
              + "   and issuer.t_NotResident = 'X' /*and fin.t_FIID = 1044*/";

       sql_FIID = sql_FIID + " and Exists(select 1 from dscqracc_dbt qr where qr.t_FIID = fin.t_FIID) ";

     sql_FIID = sql_FIID +
                " order by Issuer, fin.t_FIID ";

     query_FIID = DL_RSDCommand(sql_FIID);

     query_FIID.AddParam(date(m_end_date));
     query_FIID.AddParam(date(m_end_date));

        DataFIID = query_FIID.Execute();
        while( DataFIID.MoveNext() ) /*while2*/
		
          ПолучитьФинИн(DataFIID.FIID, m_Fininstr, m_Avoiriss);

          //1. выборка счетов (без закрытого хранения)
          cmd = DL_RSDCommand();

          query =   "with acc as (select account.* "
                  + "               from daccount_dbt account, dparty_dbt owner, ddp_dep_dbt dep, dparty_dbt depowner "
                  + "              where account.t_Chapter = 5" //+ CHAPT5 счета депо
                  + "                and instr(account.t_Type_Account, 'I') = 0 "
                  + "                and account.t_Kind_Account = 'П' "
                  + "                and account.t_Code_Currency = ? /*1*/"
                  + "                and owner.t_PartyID = account.t_Client "
                  + "                and dep.t_code = account.t_department "
                  + "                and depowner.t_partyid = dep.t_partyid "
                  + "                and depowner.t_NotResident = CHR(0)"
                  + "                and (depowner.t_NRCountry = CHR(1) or depowner.t_NRCountry = 'RUS') "
                  + "                and not exists (select 1 from dpartyown_dbt own where own.t_partyID = account.t_Client AND own.t_PartyKind = " + PTK_CENTRBANK + ") " // клиент не ЦБ
                  + "                and not exists (select 1 from dpartyown_dbt own where own.t_partyID = account.t_Client AND own.t_PartyKind = " + PTK_VEB + ") "; // клиент не Внешэкономбанк

          cmd.addParam(m_Fininstr.rec.FIID); /*1*/
            query = query + "        and account.t_Client = " + {OurBank};
            query = query
                  + ")select accA.t_Account, accA.t_Code_Currency, accA.t_Client, "
                  + "       QrAcc.t_DepoAccCode as AcntCode, QrAcc.t_StorageID, "
                  + "       ABS(rsi_rsb_account.restac( accA.T_ACCOUNT, accA.T_CODE_CURRENCY, ? /*2*/, accA.t_CHAPTER, null )) as RESTACC, "
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 1, ? /*3*/)), CHR(0)), CHR(0)) as IsPawn, "     //Залог
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 2, ? /*4*/)), CHR(0)), CHR(0)) as IsTrade, "    //Торговый/клиринговый счет
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 3, ? /*5*/)), CHR(0)), CHR(0)) as IsCorp, "     //Ограничение в связи с КД
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 4, ? /*6*/)), CHR(0)), CHR(0)) as IsOperBan, "  //Запрет на операции
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 5, ? /*7*/)), CHR(0)), CHR(0)) as IsArrest, "   //Арест
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 6, ? /*8*/)), CHR(0)), CHR(0)) as IsTrust, "    //Доверительное управление
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 8, ? /*9*/)), CHR(0)), CHR(0)) as IsRepo, "     //Переданы в РЕПО
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 9, ? /*10*/)), CHR(0)), CHR(0)) as IsAccOwn "   //Счет владельца
                  + "       ,QrAcc.t_QRID "
                  + "  from dscqracc_dbt QrAcc, daccount_dbt accA, "
                  + "       (select DISTINCT accdoc.t_Place, accdoc.t_Currency "
                  + "          from acc, dmcaccdoc_dbt accdoc"
                  + "         where accdoc.t_Account = acc.t_Account "
                  + "           and accdoc.t_Chapter = acc.t_Chapter "
                  + "           and accdoc.t_Currency = acc.t_Code_Currency "
                  + "       ) pl "
                  + " where QrAcc.t_StorageID = pl.t_Place "
                  + "   and QrAcc.t_FIID = pl.t_Currency "
                  + "   and accA.t_AccountID = QrAcc.t_AccountID ";

            cmd.addParam(date(m_end_date)); /*2*/
            cmd.addParam(date(m_end_date)); /*3*/
            cmd.addParam(date(m_end_date)); /*4*/
            cmd.addParam(date(m_end_date)); /*5*/
            cmd.addParam(date(m_end_date)); /*6*/
            cmd.addParam(date(m_end_date)); /*7*/
            cmd.addParam(date(m_end_date)); /*8*/
            cmd.addParam(date(m_end_date)); /*9*/
            cmd.addParam(date(m_end_date)); /*10*/
          query = query
                + " order by accA.t_Client ";

          DataSet = cmd.Execute(query);

          while( DataSet.moveNext() ) /*while3*/
		    if ((DataSet.IsAccOwn != SET_CHAR) or ((DataSet.IsPawn != SET_CHAR) and ( DataSet.IsRepo != SET_CHAR)
	                                   	  and (DataSet.IsCorp != SET_CHAR) and (DataSet.IsOperBan != SET_CHAR) 
	                                 	  and (DataSet.IsArrest!= SET_CHAR) and (DataSet.IsTrust != SET_CHAR) ))
//setrstrace (true);
               if( /*not*/ addNoteForObject( OBJTYPE_QRACC /*210*/,/*QrAcc*/ExtStr(DataSet.T_QRID,10,"0"), 9 /*счет владельца*/, "X", m_end_date) )
				  println ("Для  раздела "+  /*QrAcc*/DataSet.AcntCode + " счета "+ /*accA*/DataSet.Account + " не выполено заполнение примечание 'Счет владельца'" );
				else
				  println (" Для  раздела "+  /*QrAcc*/DataSet.AcntCode + " счета "+ /*accA*/DataSet.Account + " ВЫПОЛНЕНО заполнение примечание 'Счет владельца'" );
				end;
            else
                println ("Для  раздела "+  /*QrAcc*/DataSet.AcntCode + " счета "+ /*accA*/DataSet.Account + " НЕ ВЫПОЛНЯЛОСЬ заполнение примечание 'Счет владельца', т.к. он не соответствует условиям" );			
            end;
//setrstrace (false);			
          end;/*while3*/
		end;/*while2*/  
end;
		  
		
