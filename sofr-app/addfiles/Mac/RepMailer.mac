/*
$Name:         RepMailer.mac
$Module:       Отчетность
$Description:  Работа с e-mail
*/

import rcw;
import lib_str;
import Reporting;

private var m_smtpServer : String = null;
private var m_serverPort : Integer = null;
private var m_useSsl : Bool = null;
private var m_useSmtpAuth : Bool = null;

macro repMailerGetSmtpServer()
    return m_smtpServer;
end;

macro repMailerGetServerPort()
    return m_serverPort;
end;

macro repMailerUseSsl()
    return m_useSsl;
end;

macro repMailerUseSmtpAuth()
    return m_useSmtpAuth;
end;

macro repMailerSetSmtpServer(value)
    m_smtpServer = value;
end;

macro repMailerSetServerPort(value)
    m_serverPort = value;
end;

macro repMailerSetUseSsl(value)
    m_useSsl = value;
end;

macro repMailerSetUseSmtpAuth(value)
    m_useSmtpAuth = value;
end;

macro send(mailerId : Integer, sender : String, recipientList : Variant, subject : String, body : String, attachmentList : Variant, senderPassword : String) : bool
    var stat = 0;
    var email_to = "";
    var UserName = sender;

    var jvm = createObject( "rsjvm", "TJavaHost" );
    var RsMail = jvm.CreateJavaObject( "ru.softlab.core.mail.RsMail", "<init>" );
   
    if(RsMail != NULL)
       var StrUseSSL = "";
       if(repMailerUseSsl())
         StrUseSSL = "X";
       end;

       var StrUseSmtpAuth = "";
       if(repMailerUseSmtpAuth())
         StrUseSmtpAuth = "X";
       end;
        
       RsMail.Sender(UserName, senderPassword, repMailerGetSmtpServer(), String(repMailerGetServerPort()), StrUseSSL, StrUseSmtpAuth);
       RsMail.ClearListAttach();

       if (attachmentList != null)
           var list : Object;

           if (valType(attachmentList) == V_STRING)
             list = strCut(attachmentList, ";");
           else
             list = attachmentList;
           end;

           for (var i, list)
             RsMail.AddAttachment(i);
           end;
       end;

       if (valType(recipientList) == V_STRING)
         email_to = recipientList;
       else
         for (var iet, list)
           email_to = email_to + iet;
           email_to = email_to + ";";
         end;
       end;
         
       stat = RsMail.Send(subject, body, sender, "", email_to, ""/*email_bcc*/, ""/*email_cc*/);
    end;

    return true;
end;


