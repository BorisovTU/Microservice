/*
$Name:          JrReportGenerator.mac
$Module:        JasperReports
$Description:   "Обертка" API JasperReports
*/

import rcw;

class TJrReportGenerator()
    private var m_jvm : Object;
    private var m_generator : Object;
    private var m_virtualizer : Object;

    macro addParameter(name, value)
        m_generator.addParameter(name, value);
    end;

    macro setDataSource(collection)
        m_generator.setDataSource(collection);
    end;

    macro create(pattern)
        if (m_virtualizer != null)
            addParameter("REPORT_VIRTUALIZER", m_virtualizer);
            addParameter("IS_IGNORE_PAGINATION", false); 
        end; 
        m_generator.create(pattern);
    end;

    macro export(fileName, exportType)
        return m_generator.export(fileName, exportType);
    end;

    macro enableVirtualizer(maxSize)
        m_virtualizer = m_jvm.createJavaObject("net.sf.jasperreports.engine.fill.JRFileVirtualizer","<init>", maxSize);
    end;

    macro cleanupVirtualizer()
        if (m_virtualizer != null)
            m_virtualizer.cleanup();
        end;
    end;

    private macro constructorTJrReportGenerator()
        m_jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
        m_generator = m_jvm.createJavaObject("ru.softlab.rsreporting.jrtools.JrReportGenerator","<init>");
    end;

    constructorTJrReportGenerator();
end;
