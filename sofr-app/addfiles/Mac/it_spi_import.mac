/*
$Name: it_spi_import.mac 
$Module: Главная книга
$Description: BIQ-6664 / Загрузка справочника платежных инструкций СПИ из файла
*/
import  activex, oralib, likepy, globals;
import func_lib;
import "or_rep_h.mac";



private var TermPath = GetCurDir(true) + "\\Import";
private var FileName;

  

private macro SelectAndOpenFile()
  var FullNameFile, ExtName, DirName;

  /*Выбираем файл для обработки*/
  if(not SelectFile(FullNameFile, "$\\..\\..\\import\\*.xls*", "Выберите файл для загрузки", 0, true))
    MsgBox("Отказ от загрузки");
    return null;
  end;

  //Отделяем путь файла от имени
  splitfile(FullNameFile, FileName, ExtName);
  FileName = FileName + ExtName;
  DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

  TermPath = DirName;

  
  if(not OpenExcelFile(FileName, false, true, TermPath))
    MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
    EndAction(1);
    return null;
  end;  

  return ExcelApplication.Sheets(1);
end;
 
macro StartTrans()
  RslDefCon.BeginTrans();
end;

macro EndTrans(err)
  if(err)
    RslDefCon.RollbackTrans();
    println("При выполнении возникли ошибки!");
  else
    RslDefCon.CommitTrans();
    //RslDefCon.RollbackTrans();
    println("Обработка завершена");
  end;
end;

var    v_Timer = RslTimer;
/*~ml
const  Rep = CMakeReport();

macro PrintLine_Alg(a1)
  Rep.AddPrintCell(a1);
  Rep.AddStr();
end;

MACRO Last_Call()
  if(Rep.IsDataExist())
     Rep.PrintRep();
     Rep.PrintWinRep(1, "Sheet"); 
      Rep.ShowWinRep();   
  end;
END;/* Last_Call*/
ml~*/

macro LoadFile() 
  var sheet;
  var col = 1;
  var row = 1;
  var sql_str, cmd, rs;
  
  var v_parentgroup, v_groupname, v_fullname, v_account_name, v_instrument;
  var v_si_external, v_si_internal, v_is_default, v_disable;   
  var v_cur, v_acc, v_bank_name, v_bic, v_corr_acc, v_corr_bank_name, v_corr_bic;
  var v_swift, v_spi_id, v_asudr_id,v_cft_file_name;

  var res;
  var stat = false;
  var rec_id;
  var v_param;
  var v_error_msg;
 
  var v_xml_str;
  var v_Timer = RslTimer;

  sheet = SelectAndOpenFile();

  if (valtype(sheet) == V_UNDEF) //неопределено
    return;
  end;

  initprogress(-1,"Чтение файла","Чтение файла...");
  StartTrans();

  v_xml_str = "<XML>\n";
  v_xml_str = v_xml_str + "<FILE_DIR>"      + TermPath   + "</FILE_DIR>\n"
                        + "<FILE_NAME>" + FileName       + "</FILE_NAME>\n"
		          + "<CREATE_USER>"     + 1        + "</CREATE_USER>\n" 
                        + "<FROM_MODULE>" +"it_spi_import.mac"  + "</FROM_MODULE>\n" 
; // rsldefcon.user

  v_xml_str = v_xml_str + "<ROWSET>\n";


  BegAction(1, "Обработка файла \\" + TermPath + "\\" + FileName + "\". Ждите...");
		        
  if ((StrUpr(sheet.cells(2,20).value) != StrUpr("Корректный идентификатор СПИ")) or
      (StrUpr(sheet.cells(2,2).value) != StrUpr("GROUPNAME")) or
      (StrUpr(sheet.cells(2,7).value) != StrUpr("SI_INTERNAL")) or
      (StrUpr(sheet.cells(2,11).value) != StrUpr("Валюта счета")) or
      (StrUpr(sheet.cells(2,12).value) != StrUpr("Р/С (20 знаков)")) or
      (StrUpr(sheet.cells(2,14).value) != StrUpr("БИК")) or
      (StrUpr(sheet.cells(2,15).value) != StrUpr("К/С")) or
      (StrUpr(sheet.cells(2,18).value) != StrUpr("SWIFT")) 
      ) 
   println("Неверный формат файла");
   if (valtype(ExcelApplication) != V_UNDEF)
     ExcelApplication.ActiveWorkbook.Close;
   end;
   if ( rslDefCon.isInTrans() )
     rslDefCon.rollbackTrans();
   end;
   EndAction(1);
   return; 
  end;

  //rslDefCon.beginTrans();
  while ((valtype(sheet.cells(row, 1).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 2).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 3).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 4).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 5).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 6).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 7).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 8).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 9).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 10).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 11).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 12).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 13).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 14).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 15).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 16).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 17).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 18).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 19).value) != V_UNDEF)or
         (valtype(sheet.cells(row, 20).value) != V_UNDEF)
         )    
    v_parentgroup    = sheet.cells(row,1).value;
    v_groupname      = sheet.cells(row,2).value;
    v_fullname       = sheet.cells(row,3).value; 
    v_account_name   = sheet.cells(row,4).value; 
    v_instrument     = sheet.cells(row,5).value;
    v_si_external    = sheet.cells(row,6).value;    
    v_si_internal    = sheet.cells(row,7).value;
    v_is_default     = sheet.cells(row,8).value;
    v_disable        = sheet.cells(row,9).value;
    v_cft_file_name  = sheet.cells(row,10).value;
    v_cur  	       = sheet.cells(row,11).value;	
    v_acc            = sheet.cells(row,12).value; 
    v_bank_name      = sheet.cells(row,13).value;
    v_bic            = sheet.cells(row,14).value; 
    v_corr_acc       = sheet.cells(row,15).value; 
    v_corr_bank_name = sheet.cells(row,16).value;
    v_corr_bic       = sheet.cells(row,17).value;
    v_swift          = sheet.cells(row,18).value; 
    v_asudr_id       = sheet.cells(row,19).value;
    v_spi_id         = sheet.cells(row,20).value;

    if (StrLen(v_cur)+StrLen(v_groupname)+StrLen(v_si_internal)+StrLen(v_acc)+StrLen(v_bic)+
        StrLen(v_corr_acc)+StrLen(v_swift)+StrLen(v_spi_id) != 0)
      stat = true;
    else
      res = "Некорректный формат файла.";
      stat = false;
    end;//if

	if (stat)          //собираем XML
    v_xml_str = v_xml_str   
       + " <ROW excel_rownum = \""+ row + "\">\n"               
       + "  <PARENTGROUP>"    + replace(replace(replace(v_parentgroup,"&","&amp;"),"<","&lt;"),">","&gt;")     + "</PARENTGROUP>\n"  
	+ "  <GROUPNAME>"      + replace(replace(replace(v_groupname,"&","&amp;"),"<","&lt;"),">","&gt;")       + "</GROUPNAME>\n"     
	+ "  <FULLNAME>"       + replace(replace(replace(v_fullname,"&","&amp;"),"<","&lt;"),">","&gt;")        + "</FULLNAME>\n"      
       + "  <ACCOUNT_NAME>"   + replace(replace(replace(v_account_name,"&","&amp;"),"<","&lt;"),">","&gt;")    + "</ACCOUNT_NAME>\n"  
       + "  <INSTRUMENT>"     + replace(replace(replace(v_instrument,"&","&amp;"),"<","&lt;"),">","&gt;")      + "</INSTRUMENT>\n"    
	+ "  <SI_EXTERNAL>"    + replace(replace(replace(v_si_external,"&","&amp;"),"<","&lt;"),">","&gt;")     + "</SI_EXTERNAL>\n"   
       + "  <SI_INTERNAL>"    + replace(replace(replace(v_si_internal,"&","&amp;"),"<","&lt;"),">","&gt;")     + "</SI_INTERNAL>\n"  
       + "  <IS_DEFAULT>"     + replace(replace(replace(v_is_default,"&","&amp;"),"<","&lt;"),">","&gt;")      + "</IS_DEFAULT>\n"   
       + "  <DISABLED>"       + replace(replace(replace(v_disable,"&","&amp;"),"<","&lt;"),">","&gt;")         + "</DISABLED>\n"     
       + "  <CFT_FILE_NAME>"  + replace(replace(replace(v_cft_file_name,"&","&amp;"),"<","&lt;"),">","&gt;")   + "</CFT_FILE_NAME>\n" 
       + "  <CURRENCY>"       + replace(replace(replace(v_cur,"&","&amp;"),"<","&lt;"),">","&gt;")             + "</CURRENCY>\n"      
       + "  <ACCOUNT>"        + replace(replace(replace(v_acc,"&","&amp;"),"<","&lt;"),">","&gt;")             + "</ACCOUNT>\n"       
       + "  <BANK_NAME>"      + replace(replace(replace(v_bank_name,"&","&amp;"),"<","&lt;"),">","&gt;")       + "</BANK_NAME>\n"     
       + "  <BIC>"            + replace(replace(replace(v_bic,"&","&amp;"),"<","&lt;"),">","&gt;")             + "</BIC>\n"           
       + "  <CORR_ACCOUNT>"   + replace(replace(replace(v_corr_acc,"&","&amp;"),"<","&lt;"),">","&gt;")        + "</CORR_ACCOUNT>\n"  
       + "  <CORR_BANK_NAME>" + replace(replace(replace(v_corr_bank_name,"&","&amp;"),"<","&lt;"),">","&gt;")  + "</CORR_BANK_NAME>\n"
       + "  <CORR_BIC>"       + replace(replace(replace(v_corr_bic,"&","&amp;"),"<","&lt;"),">","&gt;")        + "</CORR_BIC>\n"      
       + "  <SWIFT>"          + replace(replace(replace(v_swift,"&","&amp;"),"<","&lt;"),">","&gt;")           + "</SWIFT>\n"         
       + "  <ASUDR>"          + replace(replace(replace(v_asudr_id,"&","&amp;"),"<","&lt;"),">","&gt;")        + "</ASUDR>\n"         
       + "  <SPI_ID>"         + replace(replace(replace(v_spi_id,"&","&amp;"),"<","&lt;"),">","&gt;")          + "</SPI_ID>\n"         
	+ " </ROW>\n";  
	       
         // useprogress(i = i + 1);
     
      end;//if (stat
    
       rs = sheet.cells(row,3).value;

    //   if (rs != 0)
    //    UseProgress(row = row + 1);
   //    //  UseProgress(row + 1);
    //    continue;
   //    end;
       row = row + 1;
     end;//while

     v_xml_str = v_xml_str + "</ROWSET>\n";
     v_xml_str = v_xml_str + "</XML>";
 
     var rslDefCon = RsdCommand("begin " + "\n\r" +
				    "  it_spi_import.execute_process(?,it_file.C_SOFR_RSBANK); " + "\n\r" +
				    "  ? := it_spi_import.get_result_length;" + "\n\r" +
			           "end;");
     rslDefCon.addParam("p_xml"       ,     RSDBP_IN,  v_xml_str);


     rslDefCon.addParam("result_length", RSDBP_OUT, V_INTEGER);
     rslDefCon.execute();
     var v_result_length = rslDefCon.value("result_length");
    
     //println(v_result_length);

     rslDefCon = RsdCommand("begin ? := it_spi_import.get_result_text; end;");
     rslDefCon.addParam("result_text",  RSDBP_OUT,  V_STRING, v_result_length);
     rslDefCon.execute();
     var v_result_text = rslDefCon.value("result_text"); 

   println(v_result_text);

   res = "OK";

   EndTrans();
   //rslDefCon.commitTrans();
   ExcelApplication.ActiveWorkbook.Close;
   RemProgress();

   EndAction(1);
   //PRINTLN("Отчет построен");
onerror(e)
   rslDefCon = null;
   if (valtype(ExcelApplication) != V_UNDEF)
     ExcelApplication.ActiveWorkbook.Close;
   end;
   if ( rslDefCon.isInTrans() )
     rslDefCon.rollbackTrans();
   end;
   EndAction(1);
   RemProgress();
   PRINTLN("Ошибка выполнения");
 
end;


LoadFile(); 
