import deprintr,alg_vars;
file dd(sbdepdoc) key 6;
private var Sum=$0,ApplTypeNeeded=2;
macro GetSumForOper
var
  stat,TypeOperNeeded;
  if(ALG_SBDEPDOC.TypeOper==48)
    TypeOperNeeded=56;
  else
    TypeOperNeeded=54;
  end;
  dd.Referenc=ALG_SBDEPDOC.Referenc;
  dd.Date_Document=ALG_SBDEPDOC.Date_Document;
  dd.NumDayDoc=32767;
  stat=GetLE(dd);
  while(stat and (dd.Referenc==ALG_SBDEPDOC.Referenc))
    if((dd.TypeOper==TypeOperNeeded) and (dd.ApplType==ApplTypeNeeded))
      Sum=Sum+dd.InSum+dd.OutSum;
    end;
    if((dd.TypeOper==ALG_SBDEPDOC.TypeOper) and (dd.ApplType==ApplTypeNeeded))
      Sum=Sum-dd.InSum-dd.OutSum;
    end;
    stat=Prev(dd);
  end;
  if((Sum<=$0) and (ALG_SBDEPDOC.TypeOper==49))
    ApplTypeNeeded=3;
    dd.Referenc=ALG_SBDEPDOC.Referenc;
    dd.Date_Document=ALG_SBDEPDOC.Date_Document;
    dd.NumDayDoc=32767;
    stat=GetLE(dd);
    while(stat and (dd.Referenc==ALG_SBDEPDOC.Referenc))
      if((dd.TypeOper==TypeOperNeeded) and (dd.ApplType==ApplTypeNeeded))
        Sum=Sum+dd.InSum+dd.OutSum;
      end;
      if((dd.TypeOper==ALG_SBDEPDOC.TypeOper) and (dd.ApplType==ApplTypeNeeded))
        Sum=Sum-dd.InSum-dd.OutSum;
      end;
      stat=Prev(dd);
    end;
  end;
  if(Sum<=$0)
    return false;
  else
    return true;
  end;
end;
/* entry point */
  SetOutput("NUL");
  if((ALG_SBDEPDOC.TypeOper==48) or (ALG_SBDEPDOC.TypeOper==49))
    ;
  else
    ALG_RESULT=ERR_RES;
    return;
  end;
  if(GetSumForOper)
    if(ALG_SBDEPDOC.TypeOper==48)
      ALG_SBDEPDOC.InSum=Sum;
      ALG_SBDEPDOC.OutSum=Sum;
      ALG_SBDEPDOC.ApplType=ApplTypeNeeded;
    else
      ALG_SBDEPDOC.InSum=Sum;
      ALG_SBDEPDOC.OutSum=Sum;
      ALG_SBDEPDOC.ApplType=ApplTypeNeeded;
    end;
    UpdateAlgRecords(4,true);
    ALG_RESULT=OK_RES;
  else
    if(StrFor(GetProgramID)!="П")
      MsgBox("Сумма операции не определена.|Операция отменяется!");
    end;
    ALG_RESULT=ERR_RES;
  end;
end;