/*
    VZ 07.10.98
    Макрос корректировки суммы, выдаваемой в операции "Выдача %%" по вкладу
    "Срочный пенсионный" в случае выдачи процентов за прошлые сроки хранения
    после выдачи процентов за полные месяцы хранения.
*/
import deprintr, DeskInter, opercode, srpenlib, IsSrvDoc;
Var delta;
record ALG_PARAM_SAVE("sb_algop.dbt");
record SBDEPDOC11    ("sbdepdoc.11");
file   TempFile      ("sbdepdoc.dbt");

private file tmp_sbdepdoc ( sbdepdoc );
record sbdepdoc_12 ( "sbdepdoc.12" );

const D_PUTP   = 6;
const D_CALCPC = 12;

var IsNonCash = False;

MACRO CalcReturnSum
  var flag;
  var DifferSum, PercSum;
  var PcPercSum1;
  /* Определяем дату обработки ДОб*/
  DefineAccParams;
  /* определяем количество полных месяцев, за которые вкладчику был выплачен
     доход */
  GetFullMonths(bDate,eDate);
/* KP 4.08.99 Это уже давно ненужно
  Результат = Выполнить_Операцию(ALG_DEPOSITOR.Account, ALG_DEPOSITOR.Type_Account,
              ALG_DEPOSITOR.Code_Currency, Расчет_Процентов);
*/
  /* с ДОб до ДННД начисляем проценты на выдаваемую сумму (без учета %% по
     довостребования) по основной ставке */
  PercSum = $0L;
  if (IsNonCash)
    PcPercSum1 = SBDEPDOC11.PcPercSum1;
  else
    Copy( tmp_sbdepdoc, ALG_SBDEPDOC );
    SetRecordAddr( sbdepdoc_12, tmp_sbdepdoc, 0, 0, true );
    PcPercSum1 = sbdepdoc_12.PcPercSum1;
  end;
  if( ProcessingDate+1 < bDate ) // Равенства быть не может, иначе будет считать на один день, а нам этого не надо
    Результат=Проценты_На_Операцию(ALG_DEPOSITOR.Account,
              ALG_DEPOSITOR.Type_Account,
              ALG_DEPOSITOR.Code_Currency,
              ALG_SBDEPDOC.OutSum - PcPercSum1,
              PercSum, ProcessingDate+1, bDate, 2001, 0);
  else
    Результат = 0;
  end; 
  if(Результат != 0)
    ErrMsg = "1.Ошибка при расчете %% = "+String(Результат);
    return;
  end;/* IF */
/*
    MsgBox (" На сумму ",ALG_SBDEPDOC.OutSum,"-",ALG_SBDEPDOC.PcPercSum1,
     " получили ",PercSum);
*/
/*****
  DifferSum =
     (ALG_DEPOSITOR.Sum_Rest - ALG_PARAM.prmD) /* Минимально возможный остаток после операции выдачи % */
   - (ALG_DEPOSITOR.Sum_Rest - (ALG_SBDEPDOC.OutSum - ALG_SBDEPDOC.PcPercSum1) -
      PercSum);   /* Фактический остаток без корректировок после операции */

  if (DifferSum > 0)
    ALG_SBDEPDOC.OutSum = ALG_SBDEPDOC.OutSum - DifferSum;
  end;
*********/
    ALG_SBDEPDOC.OutSum = ALG_SBDEPDOC.OutSum - PercSum;

  /* Отчисляем полученную сумму процентов */
  if( PercSum > 0)
    ClearRecord(tmpDoc);
    tmpDoc.Referenc = ALG_SBDEPDOC.Referenc;
    tmpDoc.IsCur=ALG_SBDEPDOC.IsCur;
    tmpDoc.FNCash = ALG_SBDEPDOC.FNCash;
    tmpDoc.Account = ALG_DEPOSITOR.Account;
    tmpDoc.Oper = {oper};
    tmpDoc.Type_Account = ALG_SBDEPDOC.Type_Account;
    tmpDoc.Code_Currency = ALG_SBDEPDOC.Code_Currency;
    tmpDoc.CodClient = ALG_SBDEPDOC.CodClient;
    tmpDoc.YesSbook = "X";
    tmpDoc.Date_Document = {curdate};
    tmpDoc.DepDate_Document = ALG_SBDEPDOC.DepDate_Document;
    tmpDoc.Author = ALG_SBDEPDOC.Author;
    tmpDoc.PercOprSum      = - PercSum;
    tmpDoc.ApplType        = Зач_За_Полные_Месяцы;
    tmpDoc.KindOp          = D_CALCPC;
    tmpDoc.TypeOper        = Расчет_Процентов;
    tmpDoc.TypeComplexOper = ALG_SBDEPDOC.TypeComplexOper;
    tmpDoc.ObjectPerc      = 2001;
    С_Панелью = 0;
    UseMaxDate = 1;
    NoPrint = 1;
/*
    Результат = Выполнить_Операцию(ALG_DEPOSITOR.Account, ALG_DEPOSITOR.Type_Account,
                ALG_DEPOSITOR.Code_Currency, Зачисление_Процентов,
                tmpDoc, С_Панелью, UseMaxDate, NoPrint, ALG_PARAM.NumOpert);
*/
    flag = InsertDocToGDDList(tmpDoc);
    if (flag)
      tmpDoc.TypeOper        = Зачисление_Процентов;
      tmpDoc.KindOp          = D_PUTP;
/*      tmpDoc.InSum           = - PercSum;  */
      tmpDoc.OutSum          = PercSum; 
      tmpDoc.PercOprSum      = 0;
      flag = InsertDocToGDDList(tmpDoc);
    end;
    if(NOT flag)
      ErrMsg = "Ошибка при отчислении PercSum = ";
      Результат = 1;
      return;
    else
      Результат = 0;
    end;  /* IF */
  end; /* IF */
  /* Корректируем поле сумму к выдаче */
/*  ALG_SBDEPDOC. PercOprSum = - PercSum; */
/*  ALG_SBDEPDOC. PcPercSum = ALG_SBDEPDOC. PcPercSum - PercSum;*/
  /*ALG_SBDEPDOC.OutSum = ALG_SBDEPDOC.OutSum - PercSum;*/
/*
  if((ALG_PARAM.prmD - PercSum) > ALG_SBDEPDOC.OutSum)
     ALG_SBDEPDOC.OutSum = ALG_SBDEPDOC.OutSum + PercSum;
  end;
*/
  ALG_UPDATE = 1;
end; /* macro */

macro TrnProc
  Результат = 0;
  ErrMsg = "";
  CalcReturnSum;
  //AbortTrn;
  /* if(Результат != 0)
    AbortTrn;
  end; */
end;

macro TrnCheckProc
  Результат = 0;
  ErrMsg = "";
  GetPercentsFromFullMonths;
  //AbortTrn;
end;

/*--- Точка входа в макрос ----------------------------------------------*/
ALG_RESULT = SKIP_RES;
ALG_UPDATE = 0;
//LoopInTrn(TRUE);
currentDate = ALG_SBDEPDOC.DepDate_Document;

if ((ALG_SBDEPDOC.TypeOper == 62)
 OR (ALG_SBDEPDOC.TypeOper == 63)
 OR (ALG_SBDEPDOC.TypeOper == 64)
 OR (ALG_SBDEPDOC.TypeOper == 65)
 OR (ALG_SBDEPDOC.TypeOper == 66)
 OR (ALG_SBDEPDOC.TypeOper == 67) )
  IsNonCash = True;
  Copy (TempFile,ALG_SBDEPDOC);
  SetRecordAddr (SBDEPDOC11,TempFile,0,0,True);
end;

if(ALG_SBDEPDOC.ApplType == Без_Подоперации)

  /* if(not (ProcessTrn(1, "TrnProc") and (Результат == 0)))
    ALG_RESULT = ERR_RES; /* Все Ok */
  end; */

  //ProcessTrn(1, "TrnProc");
  TrnProc();
  if(Результат == 0)
    /*ALG_SBDEPDOC. PcPercSum = ALG_SBDEPDOC. PcPercSum - PercSum;*/
    if (IsNonCash)
      SBDEPDOC11.typeOpPerc = 2001;
    else
      Copy( tmp_sbdepdoc, ALG_SBDEPDOC );
      SetRecordAddr( sbdepdoc_12, tmp_sbdepdoc, 0, 0, true );
      sbdepdoc_12.typeOpPerc = 2001;
      Copy( ALG_SBDEPDOC, tmp_sbdepdoc );
    end;
    /*ALG_SBDEPDOC. CommissCashFlag = "";
    ALG_SBDEPDOC. CommissSum = 0; */
    ALG_UPDATE = 1;
    ALG_RESULT = SKIP_RES; /* Все Ok */
  else
    ALG_RESULT = ERR_RES;  /* Ошибка */
  end;

  if((ErrMsg != "") and (not InFCGroupOpRun()))
    MsgBox(ErrMsg);
  end;
else
  if((ALG_SBDEPDOC.ApplType == За_Полные_Месяцы) or
     (ALG_SBDEPDOC.ApplType == За_Полные_Месяцы_Уст))
    /* VZ 07.12.98 Добавлена проверка на выдачу полной суммы */
    /* Заново расчитываем нужную сумму */
    /* сохраняем ALG_PARAM - он меняется в TrnCheckProc */
    Copy(ALG_PARAM_SAVE, ALG_PARAM);
    //ProcessTrn(1, "TrnCheckProc", doc, dr);
    TrnCheckProc();
    /* Обрубаем ненужные связки документов */
    if(StrFor(GetProgramID) != "П")
      InterDesk_EndDocBunch;
    end;
    if(Результат == 0)
      delta = ALG_PARAM.prmD-ALG_SBDEPDOC.OutSum;
      if(StrFor(GetProgramID) == "П")
        ALG_SBDEPDOC.OutSum = ALG_PARAM.prmD;
      else
        if( delta )
                ErrMsg = "Нельзя выдавать часть процентов";
          ALG_RESULT = ERR_RES; /* Ошибка */
        end;
      end;
    else
      ALG_RESULT = ERR_RES; /* Ошибка */
    end;
    Copy(ALG_PARAM, ALG_PARAM_SAVE );

    if((ErrMsg != "") and (not InFCGroupOpRun()))
      MsgBox(ErrMsg);
    end;
    if (IsNonCash)
      SBDEPDOC11.PcPercSum  = SBDEPDOC11.OutSum;
      SBDEPDOC11.PercOprSum = SBDEPDOC11.OutSum;
      SBDEPDOC11.OutSum     = SBDEPDOC11.OutSum - SBDEPDOC11.PcPercTax;
      SBDEPDOC11.typeOpPerc = 2001;
      SBDEPDOC11.Ground     = "Выдача процентов за срок "+
                                String(bDate)+" "+String(eDate);
    else
      Copy( tmp_sbdepdoc, ALG_SBDEPDOC );
      SetRecordAddr( sbdepdoc_12, tmp_sbdepdoc, 0, 0, true );
      sbdepdoc_12.PcPercSum   = ALG_SBDEPDOC. OutSum;
      sbdepdoc_12.typeOpPerc  = 2001;
      sbdepdoc_12.OutSum      = sbdepdoc_12.OutSum - sbdepdoc_12.PcPercTax;
      sbdepdoc_12.PercOprSum  = sbdepdoc_12.OutSum;
      sbdepdoc_12.Ground      = "Выдача процентов за срок " + String(bDate) + " " + String(eDate);
      Copy( ALG_SBDEPDOC, tmp_sbdepdoc );
      UpdateAlgRecords(4, true, false);
    end;
  elif (ALG_SBDEPDOC.ApplType == Выдача_Расчитанных_Проц)
    if (IsNonCash)
      SBDEPDOC11.PcPercSum  = SBDEPDOC11.OutSum; /* Для причисления процентов */
      SBDEPDOC11.typeOpPerc = 2001;
      SBDEPDOC11.Ground     = "Б\н выдача расчитанных (не оплаченных) процентов";
    else
      Copy( tmp_sbdepdoc, ALG_SBDEPDOC );
      SetRecordAddr( sbdepdoc_12, tmp_sbdepdoc, 0, 0, true );
      sbdepdoc_12.PcPercSum  = ALG_SBDEPDOC.OutSum; /* Для причисления процентов */
      sbdepdoc_12.typeOpPerc = 2001;
      sbdepdoc_12.Ground     = "Выдача расчитанных (не оплаченных) процентов";
      Copy( ALG_SBDEPDOC, tmp_sbdepdoc );
      UpdateAlgRecords(4, true, false);
    end;
  end;

/* В самую последнюю очередь */
  if (IsNonCash)
    Copy (ALG_SBDEPDOC,TempFile);
    UpdateAlgRecords(4, true, false);
  end;


end; /* if */
