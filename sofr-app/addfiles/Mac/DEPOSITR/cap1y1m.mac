// *********************************************************
// RS-Retail 6.00.004
// Капитализация для "До востреб. на 1 год и 1 мес." ("ДВС на 1г 1м")
// ( альтернативные условия для следующих видов вкладов:
//   - "Депозит 1г1м" 
//   - "ПенсПдеп1г1м" 
//   - "Накоп.на 2 г" 
//   - "Особ.н.1г_1м" 
//   - "Особый 1г_1м" 
//   - "П.депоз.1г1м" 
//   - "Пенс.деп.13м" 
//   - "Ср.пен.1г1м"  
//   - "Ср.пен.на 2г"  )
// ---------------------------------------------------------
// При закрытии счета необходимо реализовать капитализацию
// "Не учитывать прич.% до конца договора", в остальных случаях
// капитализация не выполняется
// *********************************************************
//
import DeprIntr;
// *** Обязательный компоненты для макроса капитализации ***
record PC_ACC_REC ("pc_alg.dbt"  );  // Текущие параметры процентов
record DEP_ACC_REC("depositr.dbt");  // Текущий счет
var SumCorRest:money,  // Итог - сумма для корректировки остатка
    NextCalc = 0;      // Выполнять ли корректировку для следующего периода
// *********************************************************

const RTPC_NO_CAPITAL = 1; // Капитализация на лицевом счете
const RTPC_NO_SUM_CAPIT_BeforEndDep = 5; // // Капитализация "Не учитывать прич.% до конца договора"


// *********************************************************

private macro isCloseAccount( FlagClosingWithMoveToAlt )
//
// true - счет закрывается или закрыт
// false - счет открыт и не закрывается
//
  var ret = false;

  if( (DEP_ACC_REC.Open_Close != StrFor(0)) and (DEP_ACC_REC.UseAlternate != 0) )
    ret = true;  // Счет закрыт
  else 
    ret = FlagClosingWithMoveToAlt;
  end;
  return ret;
end;


// ----- Головной макрос - точка входа -----

Macro CalcCorSum
( 
 CalcDate,       // Дата начала текущего (корректируемого) периода остатков
 Rest,           // Остаток, подлежащий корректировке
 PrevDelta,      // Сумма корректировки остатка при предыдущем вызове макроса
 FlagClosingWithMoveToAlt // Признак того, что идет закрытие 
                          // (глобальная переменная ClosingWithMoveToAlt)
)
  var Capital = 0;
  SumCorRest = $0;
  if( isCloseAccount( FlagClosingWithMoveToAlt ) )
    //  Если счет закрыт, то делаем капитализацию "Не учитывать прич.% до конца договора"
    Capital = RTPC_NO_SUM_CAPIT_BeforEndDep;
  else  
    Capital = RTPC_NO_CAPITAL;  // Капитализация на лицевом счете
  end;
  return Capital;
end;
// ----- Конец макроса -----
