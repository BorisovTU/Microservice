import deprintr, OperCode;

record ALG_DEPOSITOR("depositr.dbt");
file Curr("currency.dbt") key 1;

const
  OK_RES   =  0,  /* продолжать проводку */
  SKIP_RES =  1,  /* пропустить выполнение предопределенного модуля */
  END_RES  =  2,  /* завершить проводку */
  ERR_RES  = -1;  /* аваpийно завершить проводку */

var
  Branch = NumFNCash,
  {curdate},
  {oper},
  Stat;


macro TrnProc;

  record TmpDoc("sbdepdoc.dbt");
  var
    AccNumBuf = "до востреб.";
  var ScaleRate = 1;

  SetFlagCur(1);
  ClearRecord(TmpDoc);
  TmpDoc.IsCur=1;
  TmpDoc.FNCash = Branch;
  TmpDoc.Oper = {oper};
  TmpDoc.Code_Currency = Curr.Code_Currency;
  TmpDoc.CodClient = ALG_DEPOSITOR.CodClient;
  TmpDoc.YesSbook = "X";
  TmpDoc.Date_Document = {curdate};
  TmpDoc.DepDate_Document = {curdate};

  if (Curr.ScaleOfc != 0)
    ScaleRate = Curr.ScaleOfc;
  end;

  TmpDoc.InSum = Money(ALG_DEPOSITOR.Sum_Rest / (Curr.Sale_Rate / ScaleRate) * 100);
  Stat = not Выполнить_Операцию(
    AccNumBuf,
    null, 
    Curr.Code_Currency,
    Открытие_Безналичными,
    TmpDoc
  );
  if(Stat)
    Stat = not Выполнить_Операцию(
      AccNumBuf,
      null, 
      Curr.Code_Currency,
      Закрытие_Наличными,
      TmpDoc
    );
  end; 
  SetFlagCur(0);
  if(Stat)
    Stat = not Выполнить_Операцию(
      ALG_DEPOSITOR.Account,
      ALG_DEPOSITOR.Type_Account,
      0,
      Закрытие_Безналичными,
      TmpDoc
    );
  end; 

  if(not Stat)
    AbortTrn;
  end;
end;

  Curr.ExternalCode = "840";
  Stat = GetEQ(Curr);
  if(Stat)
    ProcessTrn(1, "TrnProc");
  end;
  if(Stat)
    ALG_RESULT = OK_RES;
  else
    ALG_RESULT = ERR_RES;
  end;

  Exit(1); /* Убрать вывод на экран */

end;  
