/*
$Name:               CHCKWILL.MAC
$Module:             DEPOSITR
$Description:        Операция 99: "Выдача наследства", Шаг "Проверки перед операцией"
*/

import alg_vars, issrvdoc;

private record ALG_TRAST( sbtrast );

  /*---------- Инициализируемые структуры -----------*/
  file trast ( "sbtrast.dbt"  ) key 0 write;
  file doc   ( "sbdepdoc.dbt" ) key 6;

  /*---------- Коды возврата макроса ----------*/
  const UPDATE_DEP  = 2,  /* Обновить счет */
        UPDATE_DOC  = 4;  /* Обновить документ   */

  const WILL_DOC    = StrFor(1);  // Наследство - выдачи
  const WILL_PAY    = StrFor(2);  // Наследство - выплаты
  const WILL_WISH   = StrFor(6);  // Завещания

  const WILL_PAY_RITUAL = StrFor(4);  /* На оплату ритуальных услуг */
  const WILL_PAY_COMPEN = StrFor(5);  /* Компенсация */

  const OP_PUTCOMP = 74;  /* Код операции зачисления компенсации */

  /* Коды подопераций зачисления наследства */
  const ApplTypeRitual = 26;  /* На уплату ритуальных услуг */
  const ApplType09 =  9;  /* Наследники 1 очереди инвалиды 1 группы */
  const ApplType19 = 19;  /* Наследники участников В.О.В. */
  const ApplType27 = 27;  /* Наследники 1 очереди по 1928 год рожд. */
  const ApplType28 = 28;  /* Наследники 1 очереди инв.2гр. по 1940 г.р. */
  const ApplType29 = 29;  /* Наследники 1 очереди - родители инвалидов */

  const MaxNumDayDoc = 32766;  /* Максимальный номер документа за день */

  var ErrCode, ErrText, wasFindDoc,stat;
  var Alter;
  var Sum;
  var bDay, bMon, bYear;  /* День, месяц, год рождения клиента */

  var TempStr = "";

  if (StrFor(GetProgramID) == "П")
    ALG_RESULT = OK_RES;
    return;
  end;

  if( Index( Trim( ALG_DEPOSITOR.UserTypeAccount ), "Т" ) != 0 )
     /* Счет арестован. Выдавать наследство нельзя */
     MsgBox( "Счет арестован! Выдавать наследство запрещено! ");
     /* Отмена операции */
     ALG_RESULT = END_RES;
     return;
  end;

  ClearRecord( trast );
  trast.FNCash    = ALG_DEPOSITOR.FNCash;
  trast.Referenc  = ALG_CONTRACT.ID;
  trast.VidDoc    = ALG_TRAST.VidDoc;
  trast.CodClient = ALG_COMDEPCLNT.rec.CodClient;
  if ( ( NOT getGE( trast ) )  OR
       ( trast.FNCash   != ALG_DEPOSITOR.FNCash )  OR
       ( trast.Referenc != ALG_CONTRACT.ID ) )
    msgbox("Ошибка при чтении записи по наследству");
    ErrCode = Status( ErrText );
    msgbox( ErrCode, ": ", ErrText );
    ALG_RESULT = ERR_RES;
    return;
  else
    if ( ( trast.VidDoc != ALG_TRAST.VidDoc )  OR
         ( trast.CodClient != ALG_COMDEPCLNT.rec.CodClient ) )
      ClearRecord( trast );
      trast.FNCash    = ALG_DEPOSITOR.FNCash;
      trast.Referenc  = ALG_CONTRACT.ID;
      trast.VidDoc    = WILL_PAY;
      trast.CodClient = ALG_COMDEPCLNT.rec.CodClient;
      if ( ( NOT getGE( trast ) )  OR
           ( trast.FNCash   != ALG_DEPOSITOR.FNCash )  OR
           ( trast.Referenc != ALG_CONTRACT.ID ) )
        msgbox("Ошибка при чтении записи по наследству");
        ErrCode = Status( ErrText );
        msgbox( ErrCode, ": ", ErrText );
        ALG_RESULT = ERR_RES;
        return;
      else
        if ( ( trast.VidDoc != WILL_PAY )  OR
             ( trast.CodClient != ALG_COMDEPCLNT.rec.CodClient ) )
          msgbox("Ошибка при чтении записи по наследству");
          ALG_RESULT = ERR_RES;
          return;
        end;
      end;
    end;
  end;

  /* Проверки для разовых выплат по компенсации */
  if ( ( trast.VidDoc == WILL_PAY )  AND
       ( ( trast.Type == WILL_PAY_RITUAL )  OR  /* На оплату ритуальных услуг */
         ( trast.Type == WILL_PAY_COMPEN ) ) )  /* Компенсация */
    ClearRecord( doc );
    doc.Referenc      = ALG_DEPOSITOR.Referenc;
    doc.Date_Document = {curdate};
    doc.NumDayDoc     = MaxNumDayDoc;

    wasFindDoc = false;
    stat = getLE( doc );
    while ( stat )
      if ( doc.Referenc == ALG_DEPOSITOR.Referenc )
        if ( IsServDoc( doc ) )
          wasFindDoc = true;
          stat = false;
        else
          stat = Prev( doc );
        end;
      else
        stat = false;
      end;
    end;



    if (
         NOT (wasFindDoc )  OR
         (
            wasFindDoc                          and
           ( doc.Date_Document != {curdate}  )  and
           ( doc.TypeOper      != OP_PUTCOMP )
         )
       )

      if ( trast.Type == WILL_PAY_RITUAL )
        MsgBox( "Перед выплатой на ритуальные услуги|необходимо выполнить|"+
                "зачисление компенсации" );
      else
        MsgBox( "Перед выплатой компенсации|необходимо выполнить|"+
                "зачисление компенсации" );
      end;
      ALG_RESULT = ERR_RES;
      return;
    else
      if (
//          (
          ( trast.Type   == WILL_PAY_RITUAL )   AND
//             ( doc.ApplType != ApplTypeRitual  ) )  OR
//           (
           ( trast.Type   == WILL_PAY_COMPEN )  // AND
//             ( doc.ApplType != ApplType09 )        AND
//             ( doc.ApplType != ApplType19 )        AND
//             ( doc.ApplType != ApplType27 )        AND
//             ( doc.ApplType != ApplType28 )        AND
//             ( doc.ApplType != ApplType29 )
             )
//             )
        MsgBox( "Подвид зачисления компенсации ", String(doc.ApplType),
                " за ", String({curdate}),
                "|не соответствует требемой выплате компенсации" );
        ALG_RESULT = ERR_RES;
        return;
      else
        /* Проверка года рождения наследника */
/*        if ( ( doc.ApplType == ApplType27 )  OR
             ( doc.ApplType == ApplType28 ) )
          DateSplit( ALG_COMDEPCLNT.rec.Born, bDay, bMon, bYear );
          if ( ( doc.ApplType == ApplType27 )  AND  ( bYear > 1928 ) )
            MsgBox( "Год рождения наследника позже 1928 года");
            ALG_RESULT = ERR_RES;
            return;
          end;
          if ( ( doc.ApplType == ApplType28 )  AND  ( bYear > 1940 ) )
            MsgBox( "Год рождения наследника позже 1940 года");
            ALG_RESULT = ERR_RES;
            return;
          end;
        end;
*/
        /* Проверка суммы компенсации */
        if ( doc.InSum != trast.Part )
//          Sum = Money( trast.Part );
          Sum = doc.InSum;
          GetMoney( Sum, "Укажите сумму выплаты в пределах " +
                    "суммы зачисления " + String(doc.InSum:a) );
          trast.Part = Sum;
          if ( doc.InSum >= trast.Part )
            if ( NOT Update( trast ) )
              MsgBox( "Невозможно обновить запись выплаты наследства" );
              ErrCode = Status( ErrText );
              MsgBox( ErrCode, ": ", ErrText );
              ALG_RESULT = ERR_RES;
              return;
            end;
          else
            MsgBox( "Сумма выплаты компенсации = ",
                    String( Money(trast.Part):a ),
                    "|превосходит сумму зачисления = ",
                    String( doc.InSum:a ) );
            ALG_RESULT = ERR_RES;
            return;
          end;
        end;
      end;
    end;
  end;

  /* Разборка ситуации со сберкнижкой */
  if ( ( ALG_CONTRACT.BookGiven == "X" )   AND
       ( trast.LoseSbook == StrFor(0) ) )
    /* Нет признака утери сберкнижки */
    if ( ConfDlg( "Наследник предъявил сберкнижку?", NULL, "Да", "Нет" ) == 1 )
      /* Не предъявил */
      Alter = ConfDlg( "Выдача возможна при наличиии подтверждения",
                       "остатков последконтролем.",
                       "Установить признак утери с\\кн и отложить выплату?",
                       NULL,
                       "Выплатить",
                       "Установить",
                       "Отложить" );
      if   ( Alter == 0 )
        /* Выплата без отметки утери сберкнижки */
        /* Ставится флаг "без сбркн.-по последконтр." */
        trast.NoSbook = "X";
        if ( NOT Update( trast ) )
          msgbox( "Ошибка при установке флага Без с\\кн." );
          ErrCode = Status( ErrText );
          msgbox( ErrCode, ": ", ErrText );
          ALG_RESULT = ERR_RES;
          return;
        end;
        ALG_DEPOSITOR.Givebook = StrFor(0);
        ALG_CONTRACT.BookGiven = StrFor(0);
        UpdateAlgRecords( UPDATE_DEP, TRUE );
        ALG_CONTRACT.Update;
      elif ( Alter == 1 )
        ALG_DEPOSITOR.Givebook = StrFor(0);
        ALG_CONTRACT.BookGiven = StrFor(0);
        if( Index( ALG_DEPOSITOR.UserTypeAccount, "Y" ) == 0 )
          ALG_DEPOSITOR.UserTypeAccount = Trim( ALG_DEPOSITOR.UserTypeAccount ) + "Y";
          ALG_CONTRACT.Set_AccountsFlagCh("Y");
        end;
        UpdateAlgRecords( UPDATE_DEP, TRUE );
        trast.LoseSbook = "X";
        if ( Update( trast ) )
          msgbox( "Признак утери сб\\книжки установлен.|"+
                  "Операция выплаты будет отменена." );
          /* Отмена операции */
          ALG_RESULT = END_RES;
          return;
        else
          msgbox( "Ошибка при установке признака утери с\\кн." );
          ErrCode = Status( ErrText );
          msgbox( ErrCode, ": ", ErrText );
          ALG_RESULT = ERR_RES;
          return;
        end;
      else
        /* Отмена операции */
        ALG_RESULT = END_RES;
        return;
      end;

    else

      ALG_DEPOSITOR.Givebook = "X";
      ALG_CONTRACT.BookGiven = "X";
      ALG_CONTRACT.Update;
      UpdateAlgRecords( UPDATE_DEP, TRUE );

    end;

  end;

  ALG_RESULT = OK_RES;

  end;