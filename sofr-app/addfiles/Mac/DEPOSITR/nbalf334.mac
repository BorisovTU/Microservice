/*
$Name: nbalf334.mac
$Module: Обслуживание физ лиц
$Description: Ведомость оборотов по внебалансовым счетам. Форма 334.
*/

/* закомментировано при удалении таблицы ddesk_rec_dbt по ##197859, 198467 */
/*
import DeprIntr, SqlConv, RSD, ResComm, Cur_Rate;

private var cmd, rs;
private var cmdD, rsD;

// Коды видов ресурсов кассы.
private const
  VT_CURRENCY =   1,
  VT_BLANKS   =   2,
  VT_CI       = 500;

private const cFNCash  = NumFNCash();           // Код подразделения.
private const cFlagCur = NumFlagCur();          // Валютность.
private const cOperBrigade = GetOperBrigade();  // Смена.

private file currency  ( "currency.dbt" ) key 0;
private file opr       ( "person.dbt"   ) key 0;
private file Desk_Subj ( "desksubj.dbt" ) key 0;
private file sb_casln  ( "sb_casln.dbt" ) key 1;
private file ci_doc    ( "ci_doc.dbt" )   key 3;
private file cv_balacc ( "cv_balac.dbt" ) key 0;

private file rep_f334 ( "rep_f334.tmp" ) key 1 write;

private var {Name_Bank};
private var {Oper};

private array aPaySertif;  // Массив идентификаторов ЦБ оплаченных сертификатов.
private var   sPaySertif;  // Размер массива aPaySertif.

private var vNameBranch = " ";

private var vAccName = " ";

private var vAccountKind = " ";

private var PrevRest  = $0, IPrevRest  = 0,
            CurRest   = $0, ICurRest   = 0,
            Deb       = $0, IDeb       = 0,
            Cred      = $0, ICred      = 0,  
            OtherDeb  = $0, IOtherDeb  = 0,
            OtherCred = $0, IOtherCred = 0;

private var vRestInDeb  = $0, vRestInCred  = $0;
private var vRestOutDeb = $0, vRestOutCred = $0;

private var vRest = $0, vTurnOver = $0;
private var vRURRest = $0, vRURTurnOver = $0;

private var vValueCurrency = 0;
private var vRURAccount = " ";

// Суммы в рублевом эквиваленте.
private var vRURRestInDeb      = $0;
private var vRURRestInCred     = $0;
private var vRURDebitTurnOver  = $0;
private var vRURCreditTurnOver = $0;
private var vRURRestOutDeb     = $0;
private var vRURRestOutCred    = $0;

// Итоговые суммы по счетам 2-го порядка.
private var vBalRestInDeb2      = $0;
private var vBalRestInCred2     = $0;
private var vBalDebitTurnOver2  = $0;
private var vBalCreditTurnOver2 = $0;
private var vBalRestOutDeb2     = $0;
private var vBalRestOutCred2    = $0;

// Итоговые суммы по счетам 3-го порядка.
private var vBalRestInDeb3      = $0;
private var vBalRestInCred3     = $0;
private var vBalDebitTurnOver3  = $0;
private var vBalCreditTurnOver3 = $0;
private var vBalRestOutDeb3     = $0;
private var vBalRestOutCred3    = $0;

// Общие итоговые суммы.
private var vTotalRestInDeb      = $0;
private var vTotalRestInCred     = $0;
private var vTotalRestOutDeb     = $0;
private var vTotalRestOutCred    = $0;

// Общие итоговые суммы по ошибкам.
private var vErrBalRestIn2   = $0;
private var vErrBalRestIn3   = $0;
private var vErrBalTurnOver  = $0;
private var vErrTotalRestIn  = $0;

private var vCV_BalAcc = " ";
private var vNameAcc   = " ";
private var vAcc_Kind  = " ";
private var vCodCurr = 0;  // Код валюты счета.

private var vDeb       = $0;
private var vCred      = $0;
private var vOtherDeb  = $0;
private var vOtherCred = $0;

private var i = 0;
private var nn = 1;

private var vBalAcc2  = "";  // Очередной счет 2-го порядка.
private var vBalAcc3  = "";  // Очередной счет 3-го порядка.
private var vSaveAcc2 = "";  // Последний счет 2-го порядка.
private var vSaveAcc3 = "";  // Последний счет 3-го порядка.

private var vErrCode = 0, vErrText = "";

private array aCurr, aRestID, aRestIC, aTurnD, aTurnC, aRestOD, aRestOC;


// ------------------------------------------------------------
//           Добавление суммы итогов в массив валют.
// ------------------------------------------------------------
private macro CurrSum( pCurr, pRestID, pRestIC, pTurnD, pTurnC, pRestOD, pRestOC )
  var ii = 0;
  var vSize = aSize( aCurr );
  var vNext = TRUE;
  while ( vNext  AND  ( ii < vSize ) )
    if ( aCurr( ii ) == pCurr )
      aRestID( ii ) = aRestID( ii ) + pRestID;
      aRestIC( ii ) = aRestIC( ii ) + pRestIC;
      aTurnD ( ii ) = aTurnD ( ii ) + pTurnD;
      aTurnC ( ii ) = aTurnC ( ii ) + pTurnC;
      aRestoD( ii ) = aRestOD( ii ) + pRestOD;
      aRestOC( ii ) = aRestOC( ii ) + pRestOC;
      vNext = FALSE;
    end;
    ii = ii + 1;
  end;
end;

// ------------------------------------------------------------
//        Определение ресурса кассы как ценного бланка 
//                оплаченного сертификата.
// ------------------------------------------------------------
private macro isPaySert( pRefValue )
  var ii = 0;
  var ret = FALSE;
  while ( ii < sPaySertif )
    if ( aPaySertif( ii ) == pRefValue )
      ret = TRUE;
      ii = sPaySertif;
    else
      ii = ii + 1;
    end;
  end;
  return ret;
end;

// ------------------------------------------------------------
//        Определение ресурса кассы как ценного бланка 
//                     дорожного чека.     
// ------------------------------------------------------------
private macro isTrevelCheque( pRefValue )
  var cmdR, rsR;
  var vRet = " ";
  cmdR = RsdCommand( "select 'r' " +
                    "from dsb_casvl_dbt cv, dsb_casvl_dbt templ " +
                    "where cv.T_REFVALUE = ? and " +
                          "cv.T_TYPEVALUE = 2 and " +       // Ценный бланк.
                          "cv.T_TYPE = 0 and " +            // Платежеспособный.
                          "cv.T_HASNOMINAL = 'X' and " + 
                          "cv.T_UNITMEAS in (1, 3) and " +  // Поштучно, штуки\стоимость.
                          "templ.T_REFVALUE = cv.T_TEMPLATEVALUE and " +
                          "templ.T_TYPEVALUE = 4" );        // Платежный документ ОП.
  cmdR.addParam( "RefVal", RSDBP_IN );
  cmdR.value( "RefVal" ) = pRefValue;
  cmdR.execute();
  rsR = RsdRecordset( cmdR );
  return rsR.moveNext();
end;

// -------------------------------------------------------------
//    Определение активности рублевого счета по его номеру.
// -------------------------------------------------------------
private macro GetAccountKindRub( pAcc )
  var cmdR, rsR;
  var vRet = " ";
  cmdR = RsdCommand( "select t_Kind_Account as rKind_Account " +
                     "from dbalance_dbt " +
                     "where t_Balance = ?" );
  cmdR.addParam( "balacc", RSDBP_IN );
  cmdR.value( "balacc" ) = SubStr( pAcc, 1, 5 );
  cmdR.execute();
  rsR = RsdRecordset( cmdR );
  if ( rsR.moveNext )
    vRet = rsR.value( "rKind_Account" );
  end;
  return vRet;
end;

// -------------------------------------------------------------
//    Определение активности валютного счета по его номеру.
// -------------------------------------------------------------
private macro GetAccountKindCur( pAcc )
  var cmdR, rsR;
  var vRet = " ";
  cmdR = RsdCommand( "select t_Kind_Account as rKind_Account " +
                     "from dbalance_dbt " +
                     "where t_Balance = ?" );
  cmdR.addParam( "balacc", RSDBP_IN );
  cmdR.value( "balacc" ) = SubStr( pAcc, 1, 5 );
  cmdR.execute();
  rsR = RsdRecordset( cmdR );
  if ( rsR.moveNext )
    vRet = rsR.value( "rKind_Account" );
  end;
  return vRet;
end;

// -------------------------------------------------------------
//         Определение активности счета по его номеру.
// -------------------------------------------------------------
private macro GetAccountKind( pAcc )
  var vRetKind = " ";
  if ( SubStr( pAcc, 6, 3 ) == "810" )
    vRetKind = GetAccountKindRub( pAcc );  // Рублевый счет.
  else
    vRetKind = GetAccountKindCur( pAcc );  // Валютный счет.
  end;
  return vRetKind;
end;

// ------------------------------------------------------------
//    Строка ведомости по  ресурсу бланка дорожного чека.
// ------------------------------------------------------------
private macro TrevelChequeIns( pAcc, pRest, pTurnDeb, pTurnCred, pKind, 
                               pRefValue, pNominal, pName )
  var vNameAcc = pName + ", номинал: " + pNominal;
  ClearRecord( rep_f334 );
  rep_f334.Account           = pAcc;
  rep_f334.AccountName       = vNameAcc;
  rep_f334.AccountKind       = pKind;
  rep_f334.ValueCurrency     = 0;
  rep_f334.InSum             = pRest;
  if ( pKind == "А" )
    rep_f334.DebitTurnOver     = pTurnDeb;
    rep_f334.CreditTurnOver    = pTurnCred;
  else
    rep_f334.DebitTurnOver     = pTurnCred;
    rep_f334.CreditTurnOver    = pTurnDeb;
  end;
  rep_f334.OutSum            = pRest + pTurnDeb - pTurnCred;
  rep_f334.InCol             = pRest;
  rep_f334.DebitTurnOverCol  = pTurnDeb;
  rep_f334.CreditTurnOverCol = pTurnCred;
  rep_f334.OutCol            = pRest + pTurnDeb - pTurnCred; 
  rep_f334.SortAccount       = SubStr( pAcc,  1, 5 ) +
                               SubStr( pAcc, 14, 2 );
  if ( NOT Insert( rep_f334 ) )
    println( "*** Ошибка записи в rep_f334.tmp: Счет=", pAcc, ", ", vNameAcc );
    vErrCode = Status( vErrText );
    println( "*** Ошибка " + String( vErrCode ) + ": " + vErrText );
  end;
end;

// ------------------------------------------------------------
//           Приход по ресурсу бланка дорожного чека.
// ------------------------------------------------------------
private macro TrevelChequeSumIn( pRefValue, pNominal, pAcc, pRest, rTurn )
  var cmdR, rsR;
  var nn;
  var vKind;
  var vTurn = 0; 
  // var vRet = " ";

  cmdR = RsdCommand( "select dc.T_VALUECOL as rCol " +
                     "from dsb_casdc_dbt dc " +
                     "where dc.T_BRANCH = ? and " +
                           "dc.T_CASHDATEDOC = ? and " +
                           "dc.T_TYPEDOC = 2 and " + 
                           "dc.T_REFVALUE = ? and " +
                           "( ( dc.T_CASHPATERN = ? and " +
                               "dc.T_APPLICATIONKIND = 150 and " +
                               "dc.T_FLAGDEBCREDOPER = 2 ) or " +
                             "( dc.T_BRIGADE = ? and " +
                               "dc.T_NUMOPER = 6 and " +
                               "dc.T_APPLICATIONKIND = 260 and " +
                               "dc.T_FLAGDEBCREDOPER = 1 ) ) and " +
                               "dc.T_NOMINAL = ?" );

  cmdR.addParam( "FNCash",  RSDBP_IN );
  cmdR.addParam( "Date",    RSDBP_IN );
  cmdR.addParam( "RefVal",  RSDBP_IN );
  cmdR.addParam( "Safe",    RSDBP_IN );
  cmdR.addParam( "Brigade", RSDBP_IN );
  cmdR.addParam( "Nominal", RSDBP_IN );

  cmdR.value( "FNCash" )  = cFNCash;
  cmdR.value( "Date" )    = {curdate};
  cmdR.value( "RefVal" )  = pRefValue;
  cmdR.value( "Safe" )    = Safe;
  cmdR.value( "Brigade" ) = cOperBrigade;
  cmdR.value( "Nominal" ) = pNominal;
  
  cmdR.execute;
  
  rsR = RsdRecordset( cmdR );

  nn = 1;

  while ( rsR.moveNext )

    // println( nn:5, " | ", rsR.value( "rCashOp" ), " | ", rsR.value( "rIncomeRest" ) );

    if ( ValType( rsR.value( "rCol" ) ) != V_UNDEF )
      // println( "Sum In:  ", nn:5, " | ", rsR.value( "rCol" ) );
      vTurn = vTurn + rsR.value( "rCol" );
    end;

    nn = nn + 1;

  end;

  SetParm( 4, vTurn );

end;

// ------------------------------------------------------------
//           Расход по ресурсу бланка дорожного чека.
// ------------------------------------------------------------
private macro TrevelChequeSumOut( pRefValue, pNominal, pAcc, pRest, rTurn )
  var cmdR, rsR;
  var nn;
  var vKind;
  var vTurn = 0; 
  // var vRet = " ";

  cmdR = RsdCommand( "select dc.T_VALUECOL as rCol " +
                     "from dsb_casdc_dbt dc " +
                     "where dc.T_BRANCH = ? and " +
                           "dc.T_CASHDATEDOC = ? and " +
                           "dc.T_TYPEDOC = 2 and " + 
                           "dc.T_REFVALUE = ? and " +
                           "( ( dc.T_CASHPATERN = ? and " +
                               "dc.T_APPLICATIONKIND = 150 and " +
                               "dc.T_FLAGDEBCREDOPER = 1 ) or " +
                             "( dc.T_BRIGADE = ? and " +
                               "dc.T_NUMOPER = 5 and " +
                               "dc.T_APPLICATIONKIND = 260 and " +
                               "dc.T_FLAGDEBCREDOPER = 2 ) ) and " +
                               "dc.T_NOMINAL = ?" );

  cmdR.addParam( "FNCash",  RSDBP_IN );
  cmdR.addParam( "Date",    RSDBP_IN );
  cmdR.addParam( "RefVal",  RSDBP_IN );
  cmdR.addParam( "Safe",    RSDBP_IN );
  cmdR.addParam( "Brigade", RSDBP_IN );
  cmdR.addParam( "Nominal", RSDBP_IN );

  cmdR.value( "FNCash" )  = cFNCash;
  cmdR.value( "Date" )    = {curdate};
  cmdR.value( "RefVal" )  = pRefValue;
  cmdR.value( "Safe" )    = Safe;
  cmdR.value( "Brigade" ) = cOperBrigade;
  cmdR.value( "Nominal" ) = pNominal;
  
  cmdR.execute;
  
  rsR = RsdRecordset( cmdR );

  nn = 1;

  while ( rsR.moveNext )

    // println( nn:5, " | ", rsR.value( "rCashOp" ), " | ", rsR.value( "rIncomeRest" ) );

    if ( ValType( rsR.value( "rCol" ) ) != V_UNDEF )
      // println( "Sum Out: ", nn:5, " | ", rsR.value( "rCol" ) );
      vTurn = vTurn + rsR.value( "rCol" );
    end;

    nn = nn + 1;

  end;

  SetParm( 4, vTurn );

end;

// ------------------------------------------------------------
//       Определение счета по учету бланка дорожного чека
//                      за предыдущий день.
// ------------------------------------------------------------
private macro TrevelChequeAccPrev( pRefValue, pNominal, pRest, pName )
  var cmdR, rsR;
  var nn;
  var vKind;
  var vTurnIn = 0, vTurnOut = 0;
  // var vRet = " ";

    cmdR = RsdCommand( "select distinct rn.T_ACCOUNT as rAcc " +
                    "from dreg_num_dbt rn " +
                    "where rn.T_BRANCH = ? and " +
                          "rn.T_CASHOPER = ? and " +
                          "rn.T_VALUEREF = ? and " +
                          "rn.T_NOMINAL = ? and " +
                          "rn.T_DATE = ( select prevdate " +
                                        "from ( select ac.T_DATE prevdate " +
                                               "from dsb_casac_dbt ac " +
                                               "where ac.T_BRANCH = ? and " +
                                                     "ac.T_CASHOPER = ? and " +
                                                     "ac.T_REFVALUE = ? and " +
                                                     "ac.T_DATE < ? " +
                                               "order by ac.T_DATE desc ) " +
                                        "where rownum = 1 ) and " +
                          "rn.T_SERIES = chr(7) and " +
                          "rn.T_ACCOUNT <> chr(1) " +
                    "order by rn.T_ACCOUNT desc" );

  cmdR.addParam( "FNCash1", RSDBP_IN );
  cmdR.addParam( "Safe1",   RSDBP_IN );
  cmdR.addParam( "RefVal1", RSDBP_IN );
  cmdR.addParam( "Nominal", RSDBP_IN );
  cmdR.addParam( "FNCash2", RSDBP_IN );
  cmdR.addParam( "Safe2",   RSDBP_IN );
  cmdR.addParam( "RefVal2", RSDBP_IN );
  cmdR.addParam( "Date",    RSDBP_IN );

  cmdR.value( "FNCash1" ) = cFNCash;
  cmdR.value( "Safe1" )   = Safe;
  cmdR.value( "RefVal1" ) = pRefValue;
  cmdR.value( "Nominal" ) = pNominal;
  cmdR.value( "FNCash2" ) = cFNCash;
  cmdR.value( "Safe2" )   = Safe;
  cmdR.value( "RefVal2" ) = pRefValue;
  cmdR.value( "Date" )    = {curdate};
 
  cmdR.execute;
  
  rsR = RsdRecordset( cmdR );

  nn = 1;

  while ( rsR.moveNext )

    if ( ValType( rsR.value( "rAcc" ) ) == V_UNDEF )
      // println( "ACC PREV UNDEF" );
    else
      // println( "AccPrev: ", nn:5, " | ", rsR.value( "rAcc" ) );

      TrevelChequeSumIn ( pRefValue, pNominal, rsR.value( "rAcc" ), pRest, vTurnIn );
      TrevelChequeSumOut( pRefValue, pNominal, rsR.value( "rAcc" ), pRest, vTurnOut );

      vKind = GetAccountKind( rsR.value( "rAcc" ) );
      TrevelChequeIns( rsR.value( "rAcc" ), pRest, vTurnIn, vTurnOut, vKind, 
                       pRefValue, pNominal, pName );
    end;

    nn = nn + 1;

  end;

end;

// ------------------------------------------------------------
//       Определение счета по учету бланка дорожного чека.
// ------------------------------------------------------------
private macro TrevelChequeAcc( pRefValue, pNominal, pRest, pName )
  var cmdR, rsR;
  var nn;
  var vKind;
  var NotFound = TRUE;
  var vTurnIn = 0, vTurnOut = 0;
  // var vRet = " ";

  cmdR = RsdCommand( "select distinct rn.T_ACCOUNT as rAcc " +
                     "from dreg_num_dbt rn " +
                     "where rn.T_BRANCH = ? and " +
                           "rn.T_CASHOPER = ? and " +
                           "rn.T_VALUEREF = ? and " +
                           "rn.T_NOMINAL = ? and " +
                           "rn.T_DATE = ? and " +
                           "rn.T_SERIES = chr(7) and " +
                           "rn.T_ACCOUNT <> chr(1) " +
                     "order by rn.T_ACCOUNT desc" );

  cmdR.addParam( "FNCash",  RSDBP_IN );
  cmdR.addParam( "Safe",    RSDBP_IN );
  cmdR.addParam( "RefVal",  RSDBP_IN );
  cmdR.addParam( "Nominal", RSDBP_IN );
  cmdR.addParam( "Date",    RSDBP_IN );

  cmdR.value( "FNCash" )  = cFNCash;
  cmdR.value( "Safe" )    = Safe;
  cmdR.value( "RefVal" )  = pRefValue;
  cmdR.value( "Nominal" ) = pNominal;
  cmdR.value( "Date" )    = {curdate};
  
  cmdR.execute;
  
  rsR = RsdRecordset( cmdR );

  nn = 1;

  while ( rsR.moveNext )

    if ( ValType( rsR.value( "rAcc" ) ) == V_UNDEF )
      // println( "ACC UNDEF" );
    else
      // println( "Acc:     ", nn:5, " | ", rsR.value( "rAcc" ) );

      TrevelChequeSumIn ( pRefValue, pNominal, rsR.value( "rAcc" ), pRest, vTurnIn );
      TrevelChequeSumOut( pRefValue, pNominal, rsR.value( "rAcc" ), pRest, vTurnOut );

      vKind = GetAccountKind( rsR.value( "rAcc" ) );
      TrevelChequeIns( rsR.value( "rAcc" ), pRest, vTurnIn, vTurnOut, vKind, 
                       pRefValue, pNominal, pName );

      NotFound = FALSE;
    end;

    nn = nn + 1;

  end;

  if ( NotFound )
    TrevelChequeAccPrev( pRefValue, pNominal, pRest, pName );
  end;

end;

// ------------------------------------------------------------
//          Входящий остаток (штуки) на начало дня по
//               ценному бланку дорожного чека.
// ------------------------------------------------------------
private macro TrevelChequeRestIn( pRefValue, pNominal, pName )
  var cmdR, rsR;
  var nn;
  var vRestIn = 0;

  cmdR = RsdCommand( "select sum( rn.T_MAX - rn.T_MIN + 1 ) as rIncomeRest " +
                     "from dreg_num_dbt rn " +
                     "where rn.T_BRANCH = ? and " +
                     "rn.T_CASHOPER = ? and " +
                     "rn.T_VALUEREF = ? and " +
                     "rn.T_NOMINAL = ? and " +
                     "rn.T_SERIES <> chr(7) and " +
                     "rn.T_DATE = ( select prevdate " +
                                   "from ( select ac.T_DATE prevdate " +
                                          "from dsb_casac_dbt ac " +
                                          "where ac.T_BRANCH = ? and " +
                                                "ac.T_CASHOPER = ? and " +
                                                "ac.T_REFVALUE = ? and " +
                                                "ac.T_DATE < ? " +
                                          "order by ac.T_DATE desc ) " +
                                   "where rownum = 1 )" );

  cmdR.addParam( "FNCash1", RSDBP_IN );
  cmdR.addParam( "Safe1",   RSDBP_IN );
  cmdR.addParam( "RefVal1", RSDBP_IN );
  cmdR.addParam( "Nominal", RSDBP_IN );
  cmdR.addParam( "FNCash2", RSDBP_IN );
  cmdR.addParam( "Safe2",   RSDBP_IN );
  cmdR.addParam( "RefVal2", RSDBP_IN );
  cmdR.addParam( "Date",    RSDBP_IN );

  cmdR.value( "FNCash1" ) = cFNCash;
  cmdR.value( "Safe1" )   = Safe;
  cmdR.value( "RefVal1" ) = pRefValue;
  cmdR.value( "Nominal" ) = pNominal;
  cmdR.value( "FNCash2" ) = cFNCash;
  cmdR.value( "Safe2" )   = Safe;
  cmdR.value( "RefVal2" ) = pRefValue;
  cmdR.value( "Date" )    = {curdate};

  cmdR.execute;
  
  rsR = RsdRecordset( cmdR );

  nn = 1;
  while ( rsR.moveNext )
    if ( ValType( rsR.value( "rIncomeRest" ) ) == V_DOUBLE )
      vRestIn = rsR.value( "rIncomeRest" );
    else
      vRestIn = 0;
    end;
    TrevelChequeAcc( pRefValue, pNominal, vRestIn, pName );
    nn = nn + 1;
  end;
end;

// ------------------------------------------------------------
//     Формирование строк для ценного бланка дорожного чека.
// ------------------------------------------------------------
private macro TrevelChequeNominals( pRefValue, pNameValue )
  var cmdR, rsR;
  var nn;
  // var vRet = " ";
  cmdR = RsdCommand( "select p.T_PAR as rPar " +
                     "from dpar_dbt p " +
                     "where p.T_VALUEREF = ( select cv.T_TEMPLATEVALUE " +
                                            "from dsb_casvl_dbt cv " +
                                            "where cv.T_REFVALUE = ? )" );
  cmdR.addParam( "RefVal", RSDBP_IN );
  cmdR.value( "RefVal" ) = pRefValue;
  cmdR.execute;
  rsR = RsdRecordset( cmdR );
  nn = 1;
  while ( rsR.moveNext )
    // println( "-------------------------------------------" );
    // println( "Nominal: ", nn:5, " | ", rsR.value( "rPar" ) );
    TrevelChequeRestIn( pRefValue, rsR.value( "rPar" ), pNameValue );
    nn = nn + 1;
  end;
end;

// ------------------------------------------------------------
//            Поиск балансового счета ресурса кассы.
// ------------------------------------------------------------
private macro find_CV_BalAcc( pTypeValue, pCodIntValue, pType, pVarName )
  var rAccount = " ";
  vCodCurr = 0;
  ClearRecord( cv_balacc );
  cv_balacc.Branch      = cFNCash;
  cv_balacc.TypeValue   = pTypeValue;
  cv_balacc.CodIntValue = pCodIntValue;
  cv_balacc.ValueState  = pType;
  cv_balacc.VarName     = pVarName;
  if ( getEQ( cv_balacc )  AND  ( StrLen( cv_balacc.Account ) > 0 ) )
    rAccount = cv_balacc.Account;
    vCodCurr = cv_balacc.CurCode;
  end;
  return rAccount;
end;

// -------------------------------------------------------------
//            Преобразование строки к формату SQL.
// -------------------------------------------------------------
private macro sql_String( s : string )
  if ( s == "" )
    return "chr(1)";
  else
    return "'" + s + "'";
  end;
end;

// -------------------------------------------------------------
//        Подсчет остатков и оборотов для ресурсов кассы, 
//    не являющихся ценными бланками оплаченного сертификата.
// -------------------------------------------------------------
private macro CalcNoPaySert( pRefValue )

   PrevRest =  CurRest =  Cred =  Deb =  OtherCred =  OtherDeb = $0;
  IPrevRest = ICurRest = ICred = IDeb = IOtherCred = IOtherDeb = 0;

  CalcTurns( pRefValue, Cred, ICred, Deb, IDeb );
  CalcOtherTurns( pRefValue, OtherCred, IOtherCred, OtherDeb, IOtherDeb );

  if ( IsKept )
    CashAcc.addFilter("t.t_Branch = " + string( cFNCash ) +
		      " and t.t_CashOper = "   + sql_String( Safe ) + 
		      " and t.t_SubAccount = " + sql_String("") +
		      " and t.t_RefValue = "   + string( pRefValue ) );
    CashAcc.KeyNum = 2;
    CashAcc.rec.Branch     = cFNCash;
    CashAcc.rec.CashOper   = Safe;
    CashAcc.rec.SubAccount = "";
    CashAcc.rec.RefValue   = pRefValue;
    CashAcc.rec.Date       = {curdate};
    if ( CashAcc.GetLT                            AND 
         ( CashAcc.rec.Branch     == cFNCash )    AND
         ( CashAcc.rec.RefValue   == pRefValue )  AND
         ( CashAcc.rec.CashOper   == Safe )       AND
         ( CashAcc.rec.SubAccount == "" ) )
      IPrevRest = CashAcc.rec.RestCol;
      if ( CashAcc.rec.RestMoney )
        PrevRest = CashAcc.rec.RestMoney;
      else
        PrevRest = $1 * CashAcc.rec.RestCol;
      end;
    end;
    CashAcc.dropFilter;
  else
    PrevRest = $0;
  end;

  CashAcc.KeyNum         = 1;
  CashAcc.rec.Branch     = cFNCash;
  CashAcc.rec.CashOper   = Safe;
  CashAcc.rec.SubAccount = "";
  CashAcc.rec.RefValue   = pRefValue;
  CashAcc.rec.Date       = {curdate};
  if( CashAcc.GetEQ )
    ICurRest = CashAcc.rec.RestCol;
    if ( CashAcc.rec.RestMoney )
      CurRest = CashAcc.rec.RestMoney;
    else
      CurRest = $1 * CashAcc.rec.RestCol;
    end;
  end;

  if ( Mode )
    PrevRest = CurRest;
    Deb = Cred = OtherDeb = OtherCred = $0;
    IPrevRest = ICurRest;
    IDeb = ICred = IOtherDeb = IOtherCred = 0;
  end;

end;

// -------------------------------------------------------------
//     Определение вида операции для userGetBookAccounts(). 
// -------------------------------------------------------------
private macro CI_MakeKind
  var Type7  = String( ci_doc.Type ),
      Issue4 = String( ci_doc.Issue );
  while ( StrLen( Type7 ) < 7 )
    Type7 = "0" + Type7;
  end;
  while ( StrLen( Issue4 ) < 4 )
    Issue4 = "0" + Issue4;
  end;
  return Type7 + "/" + Issue4;
end;

// -------------------------------------------------------------
//             Получение счета для сертификатов.
// -------------------------------------------------------------
private macro find_CertAccount( pApplKind, pApplKey )
  return " ";
end;

// ------------------------------------------------------------
//       Получение рублевого эквивалента валютной суммы. 
// ------------------------------------------------------------
private macro getRubEqu( pCodCurr, pCurrSum )
  var _CBRate =  0.0;
  var _RubSum = $0.0;
  var stat    =    0;
  if ( pCodCurr == 0 )
    _RubSum = pCurrSum;
  else
    stat = GetAllCurrRate( {curdate}, pCodCurr, _CBRate, null, null );
    if ( stat )
      _RubSum = SumConv( pCurrSum, _CBRate );
    else
      println( " *** Ошибка при определении курса ЦБ по валюте ", pCodCurr );
      _RubSum = $0.0;
    end;
  end;
  return _RubSum;
end;

// ------------------------------------------------------------
//             Получение буквенного кода валюты.
// ------------------------------------------------------------
private macro getCurrName( pCurrCode )
  var retCurrName = " ";
  ClearRecord( currency );
  currency.Code_Currency = pCurrCode;
  if ( GetEQ( currency ) )
    retCurrName = currency.Short_Name;
  end;
  return retCurrName;
end;

// ------------------------------------------------------------
//     Выделение триады для определения счетов 3-го порядка.
// ------------------------------------------------------------
private macro AccPoints( pAcc )
  return SubStr( pAcc, 1, 5 ) + "." + SubStr( pAcc, 6, 3 ) + "." + SubStr( pAcc, 9 );
end;

// ======================================================================================
//                                 Основная процедура.
// ======================================================================================

  Message( " Формирование Ведомости оборотов по внебалансовым счетам ..." );
  if ( GetProgramID != CodeFor( "П" )  )
    Safe = GetNativeSafe();
    Desk_Subj.Branch = cFNCash;
    Desk_Subj.Name = Safe;
    if ( not GetEQ( Desk_Subj ) )
      MsgBox( "Не найден субъект кассы: ", Safe );
      Exit( -1 );
    end;
  else
    ClearRecord( Desk_Subj );
    Desk_Subj.Reports = "A";
  end;

  // Находим запись по подразделению.
  if ( NOT findDepartment( NumFNcash, vNameBranch ) )
    vNameBranch = String( NumFNcash );
  end;

  // Чтение записи Операциониста.
  opr.Oper = {Oper};
  if ( NOT GetEQ( opr ) )
    opr.Name = " ";
  end;

  // --------------------------------------------------------------------
  //    Заполнение массива идентификаторов ЦБ оплаченных сертификатов.
  // --------------------------------------------------------------------

  cmd = RsdCommand( "select cv.T_REFVALUE as rRefValue " +
                    "from dcv_link_dbt cl, dsb_casvl_dbt cv " +
                    "where cl.T_TYPE = 3 and " +
                          "cl.T_CASHVALTYPE = 2 and " +
                          "cl.T_OPERATION in ( 2, 3 ) and " +
                          "cv.T_TYPEVALUE = 2 and " +
                          "cv.T_TYPE = 0 and " +
                          "cv.T_CODINTVALUE = cl.T_CASHVALCODE " +
                    "group by cv.T_REFVALUE " +
                    "order by cv.T_REFVALUE" );

  cmd.execute();

  rs = RsdRecordset( cmd );

  i = 0;

  while ( rs.moveNext )
    aPaySertif( i ) = rs.value( "rRefValue" );
    i = i + 1;
  end;

  sPaySertif = aSize( aPaySertif );

  cmd.Close();

  // -----------------------------------------------------------------------
  //                Очистка временной таблицы rep_f334.tmp.
  // -----------------------------------------------------------------------

  cmd = RsdCommand( "delete from drep_f334_tmp" );
  cmd.execute();
  cmd.Close();

  // -----------------------------------------------------------------------
  //                      Заполнение массива валют.
  // -----------------------------------------------------------------------

  i = 0;
  ClearRecord( currency );
  while ( Next( currency ) )
    aCurr( i ) = currency.Code_Currency;
    aRestID( i ) = $0;
    aRestIC( i ) = $0;
    aTurnD ( i ) = $0;
    aTurnC ( i ) = $0;
    aRestOD( i ) = $0;
    aRestOC( i ) = $0;
    i = i + 1;
  end;

  // -----------------------------------------------------------------------
  //    Этап 1. Отбор данных и заполнение временной таблицы rep_f334.tmp.
  // -----------------------------------------------------------------------

  cmd = RsdCommand( "select c.t_RefValue as rRefValue, " +
                           "c.t_TypeValue as rTypeValue, " +
                           "c.t_CodIntValue as rCodIntValue, " +
                           "c.t_NameValue as rNameValue, " +
                           "c.t_Type as rType " +
                    "from dsb_casvl_dbt c " +
                    "where ( ( c.T_TYPEVALUE not in (1, 504, 505) ) or " +
                          " ( c.T_TYPEVALUE = 1 and c.T_TYPE > 1 ) ) and " +
                          "exists (select 0 from dsb_casac_dbt ca where ca.t_branch = ? and ca.t_refvalue = c.t_refvalue) " +
                    "order by c.T_TYPEVALUE, c.T_CODINTVALUE" );

  cmd.addParam( "p_branch", RsdBp_In );
  cmd.value( "p_branch" ) = cFNCash;

  cmd.execute();

  rs = RsdRecordset( cmd );

  nn = 1;

  while ( rs.moveNext )

    if ( ( rs.value( "rTypeValue" ) != VT_BLANKS )  OR
         ( ( rs.value( "rTypeValue" ) == VT_BLANKS )     AND
           ( NOT isPaySert( rs.value( "rRefValue" ) ) )  AND
           ( NOT isTrevelCheque( rs.value( "rRefValue" ) ) ) ) )

      CalcNoPaySert( rs.value( "rRefValue" ) );

      if ( NOT ( ( PrevRest  == $0 )  AND  ( IPrevRest  == 0 )  AND
                 ( CurRest   == $0 )  AND  ( ICurRest   == 0 )  AND
                 ( Deb       == $0 )  AND  ( IDeb       == 0 )  AND
                 ( Cred      == $0 )  AND  ( ICred      == 0 )  AND
                 ( OtherDeb  == $0 )  AND  ( IOtherDeb  == 0 )  AND
                 ( OtherCred == $0 )  AND  ( IOtherCred == 0 ) ) )
        vCV_BalAcc = find_CV_BalAcc( rs.value( "rTypeValue" ), 
                                     rs.value( "rCodIntValue" ), 
                                     rs.value( "rType" ), 
                                     "УчетОстатковЦенности" );
        if ( vCV_BalAcc != " " )
          vNameAcc  = GetAccountName( 3, vCV_BalAcc, vCodCurr );
          vAcc_Kind = GetAccountKind( vCV_BalAcc );
        else
          vAcc_Kind = " ";
          if ( rs.value( "rType" ) == 0 )
            vNameAcc = rs.value( "rNameValue" );
          else
            vNameAcc = SubStr( rs.value( "rNameValue" ), 1, 60 ) + " (не платежеспособ.)"
          end;
        end;

        if ( StrLen( vNameAcc ) < 2 )
          vNameAcc = " ";
        end;

        if ( vAcc_Kind == "А" )
          vDeb       = Cred;
          vCred      = Deb;
          vOtherDeb  = OtherCred;
          vOtherCred = OtherDeb;
        else
          vDeb       = Deb;
          vCred      = Cred;
          vOtherDeb  = OtherDeb;
          vOtherCred = OtherCred;
        end;

        ClearRecord( rep_f334 );
        rep_f334.Account           = vCV_BalAcc;
        rep_f334.AccountName       = vNameAcc;
        rep_f334.AccountKind       = vAcc_Kind;
        rep_f334.ValueCurrency     = vCodCurr;
        rep_f334.InSum             = PrevRest;
        rep_f334.DebitTurnOver     = vDeb  + vOtherDeb;
        rep_f334.CreditTurnOver    = vCred + vOtherCred;
        rep_f334.OutSum            = CurRest;
        rep_f334.InCol             = IPrevRest;
        rep_f334.DebitTurnOverCol  = IDeb;
        rep_f334.CreditTurnOverCol = ICred;
        rep_f334.OutCol            = ICurRest;
        rep_f334.SortAccount       = SubStr( vCV_BalAcc,  1, 5 ) +
                                     SubStr( vCV_BalAcc, 14, 2 );

        if ( NOT Insert( rep_f334 ) )
          println( "*** Ошибка записи в rep_f334.tmp: Счет=", vCV_BalAcc, ", ", vNameAcc );
          vErrCode = Status( vErrText );
          println( "*** Ошибка " + String( vErrCode ) + ": " + vErrText );
        end;
        nn = nn + 1;
      end;
    end;

    // Сертификаты.

    if ( ( rs.value( "rTypeValue" ) == VT_BLANKS )  AND
         ( isPaySert( rs.value( "rRefValue" ) ) ) ) 

      cmdD = RsdCommand( "select t_ApplicationKind as rApplKind, " +
                                "t_ApplicationKey as rApplKey, " +
                                "t_ValueMoney as rValueMoney " +
                         "from dsb_casdc_dbt " +
                         "where t_Branch = ? and " +
                               "t_RefValue = ? and " +
                               "t_CashDateDoc = ? and " +
                               "t_Brigade = ? and " +
                               "t_NumOper = 6" );  // CASHOP_CREDIT = Приход.
 
      cmdD.addParam( "branch",  RSDBP_IN );
      cmdD.addParam( "refval",  RSDBP_IN );
      cmdD.addParam( "date",    RSDBP_IN );
      cmdD.addParam( "brigade", RSDBP_IN );

      cmdD.value( "branch" )  = cFNCash;
      cmdD.value( "refval" )  = rs.value( "rRefValue" );
      cmdD.value( "date" )    = {curdate};
      cmdD.value( "brigade" ) = cOperBrigade;

      cmdD.execute();

      rsD = RsdRecordset( cmdD );

      while ( rsD.moveNext )

        vCV_BalAcc = find_CertAccount( rsD.value( "rApplKind" ), rsD.value( "rApplKey" ) );

        if ( vCV_BalAcc != " " )
          vNameAcc = GetAccountName( 3, vCV_BalAcc, vCodCurr );
          vAcc_Kind = GetAccountKind( vCV_BalAcc );
        else
          vAcc_Kind = " ";
          if ( rs.value( "rType" ) == 0 )
            vNameAcc = rs.value( "rNameValue" );
          else
            vNameAcc = SubStr( rs.value( "rNameValue" ), 1, 60 ) + " (не платежеспособ.)"
          end;
        end;

        if ( StrLen( vNameAcc ) < 2 )
          vNameAcc = " ";
        end;

        ClearRecord( rep_f334 );
        rep_f334.Account           = vCV_BalAcc;
        rep_f334.AccountName       = vNameAcc;
        rep_f334.AccountKind       = vAcc_Kind;
        rep_f334.ValueCurrency     = vCodCurr;
        rep_f334.InSum             = $0;
        rep_f334.DebitTurnOver     = rsD.value( "rValueMoney" );
        rep_f334.CreditTurnOver    = rsD.value( "rValueMoney" );
        rep_f334.OutSum            = $0;
        rep_f334.InCol             = 0;
        rep_f334.DebitTurnOverCol  = 0;
        rep_f334.CreditTurnOverCol = 0;
        rep_f334.OutCol            = 0;
        rep_f334.SortAccount       = SubStr( vCV_BalAcc,  1, 5 ) +
                                     SubStr( vCV_BalAcc, 14, 2 );

        if ( NOT Insert( rep_f334 ) )
          println( "*** Ошибка записи в rep_f334.tmp: Счет=", vCV_BalAcc, ", ", vNameAcc );
          vErrCode = Status( vErrText );
          println( "*** Ошибка " + String( vErrCode ) + ": " + vErrText );
        end;
        nn = nn + 1;
      end;  
    end;

    // Ценные бланки дорожных чеков.

    if ( ( rs.value( "rTypeValue" ) == VT_BLANKS )  AND
         ( isTrevelCheque( rs.value( "rRefValue" ) ) ) )
      // println( "=======================================================" );
      // println( "Ценный бланк дорожных чеков = ", rs.value( "rRefValue" ) );
      TrevelChequeNominals( rs.value( "rRefValue" ), rs.value( "rNameValue" ) );
    end;
  end;

  cmd.Close();

  // println( "\n====================\n" );


  // -----------------------------------------------------------------------
  //    Этап 2. Печать ведомости по временной таблице rep_f334.tmp.
  // -----------------------------------------------------------------------

  [ ];
  [ ];
  [       #]( {Name_Bank} );
  [       Подразделение № #]( vNameBranch );
  [       ----------------------------];
  [               Составитель];
  [ ];
  [ ];
  [                                                             ВЕДОМОСТЬ ОБОРОТОВ ПО ВНЕБАЛАНСОВЫМ СЧЕТАМ];
  [ ];
  [ ];
  [ #####################################################################################################################################################################]
  ( {CurDate}:m:c );
  [ ];
  [ +-------------------------------------------------------------------------------------------------------------------------------------------------------------------+];
  [ |           Счет            |     Наименование    |           Входящие остатки          |               Обороты               |           Исходящие остатки         |];
  [ |                           |        счета        |------------------+------------------|------------------+------------------|------------------+------------------|];
  [ |                           |                     |       Дебет      |      Кредит      |       Дебет      |      Кредит      |       Дебет      |      Кредит      |];
  [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
  [ |             1             |          2          |         3        |         4        |         5        |         6        |         7        |         8        |];
  [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
  
  // Первая часть Ведомости: строки с заданными счетами.

  cmd = RsdCommand( "select t_Account as rAccount, " +
                           "t_SortAccount as rSortAcc, " +
                           "t_AccountName as rAccountName, " +
                           "t_AccountKind as rAccountKind, " +
                           "t_ValueCurrency as rValueCurrency, " +
                           "t_InSum as rInSum, " +
                           "t_DebitTurnOver as rDebitTurnOver, " +
                           "t_CreditTurnOver as rCreditTurnOver, " +
                           "t_OutSum as rOutSum, " +
                           "t_InCol as rInCol, " +
                           "t_DebitTurnOverCol as rDebitTurnOverCol, " +
                           "t_CreditTurnOverCol as rCreditTurnOverCol, " +
                           "t_OutCol as rOutCol " +
                    "from drep_f334_tmp " +
                    "where LENGTH( t_Account ) > 1 " +
                    "order by t_Account" );

  cmd.execute();

  rs = RsdRecordset( cmd );

  while ( rs.moveNext )

    vBalAcc2 = SubStr( rs.value( "rAccount" ),  1, 5 );
    vBalAcc3 = rs.value( "rSortAcc" );
               // SubStr( rs.value( "rAccount" ),  1, 5 ) +
               // SubStr( rs.value( "rAccount" ), 14, 2 );

    if ( StrLen( vSaveAcc3 ) == 0 )
      vSaveAcc3 = vBalAcc3;
    else
      if ( vSaveAcc3 != vBalAcc3 )  // Новый счет 3-го порядка.
        if ( ( vBalRestInDeb3      != $0 )  OR
             ( vBalRestInCred3     != $0 )  OR
             ( vBalDebitTurnOver3  != $0 )  OR
             ( vBalCreditTurnOver3 != $0 )  OR
             ( vBalRestOutDeb3     != $0 )  OR
             ( vBalRestOutCred3    != $0 ) )
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          [ | ######################### |                     | ################ | ################ | ################ | ################ | ################ | ################ |]
          ( ( "  Итого по б/сч " + vSaveAcc3 ):w,
              vBalRestInDeb3:a:z:17:2,
              vBalRestInCred3:a:z:17:2,
              vBalDebitTurnOver3:a:z:17:2,
              vBalCreditTurnOver3:a:z:17:2,
              vBalRestOutDeb3:a:z:17:2,
              vBalRestOutCred3:a:z:17:2 );
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          vBalRestInDeb3      = $0;
          vBalRestInCred3     = $0;
          vBalDebitTurnOver3  = $0;
          vBalCreditTurnOver3 = $0;
          vBalRestOutDeb3     = $0;
          vBalRestOutCred3    = $0;
        end;
        if ( vErrBalRestIn3 != $0 )
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          [ | Итого по ошибкам:         |                     |         ###################         |                                     |                                     |]
          ( vErrBalRestIn3:a:z:17:2 );
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          vErrBalRestIn3 = $0;
          // vRURTurnOver  = $0;
        end;
        vSaveAcc3 = vBalAcc3;
      end;
    end;

    if ( StrLen( vSaveAcc2 ) == 0 )
      vSaveAcc2 = vBalAcc2;
    else
      if ( vSaveAcc2 != vBalAcc2 )  // Новый счет 2-го порядка.
        if ( ( vBalRestInDeb2      != $0 )  OR
             ( vBalRestInCred2     != $0 )  OR
             ( vBalDebitTurnOver2  != $0 )  OR
             ( vBalCreditTurnOver2 != $0 )  OR
             ( vBalRestOutDeb2     != $0 )  OR
             ( vBalRestOutCred2    != $0 ) )
          // [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          [ | ######################### |                     | ################ | ################ | ################ | ################ | ################ | ################ |]
          ( ( "  Итого по б/сч " + vSaveAcc2 ):w,
              vBalRestInDeb2:a:z:17:2,
              vBalRestInCred2:a:z:17:2,
              vBalDebitTurnOver2:a:z:17:2,
              vBalCreditTurnOver2:a:z:17:2,
              vBalRestOutDeb2:a:z:17:2,
              vBalRestOutCred2:a:z:17:2 );
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          vBalRestInDeb2      = $0;
          vBalRestInCred2     = $0;
          vBalDebitTurnOver2  = $0;
          vBalCreditTurnOver2 = $0;
          vBalRestOutDeb2     = $0;
          vBalRestOutCred2    = $0;
        end;
        if ( vErrBalRestIn2 != $0 )
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          [ | Итого по ошибкам:         |                     |         ###################         |                                     |                                     |]
          ( vErrBalRestIn2:a:z:17:2 );
          [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
          vErrBalRestIn2 = $0;
          vRURTurnOver  = $0;
        end;
        vSaveAcc2 = vBalAcc2;
      end;
    end;

    vAccountKind = rs.value( "rAccountKind" );

    if ( ( vAccountKind == "А" )  OR  ( vAccountKind == "П" ) )

      if ( vAccountKind == "П" )  // Пассивный счет.
        vRestInDeb   = $0;
        vRestInCred  = rs.value( "rInSum" );
        vRestOutDeb  = $0;
        vRestOutCred = vRestInCred - rs.value( "rDebitTurnOver" ) + 
                                     rs.value( "rCreditTurnOver" );
      else                                      // Активный счет.
        vRestInDeb   = rs.value( "rInSum" );
        vRestInCred  = $0;
        vRestOutDeb  = vRestInDeb + rs.value( "rDebitTurnOver" ) -
                                    rs.value( "rCreditTurnOver" );
        vRestOutCred = $0;
      end;

      if ( NOT ( ( vRestInDeb                    == $0 )  AND
                 ( vRestInCred                   == $0 )  AND
                 ( rs.value( "rDebitTurnOver" )  == $0 )  AND
                 ( rs.value( "rCreditTurnOver" ) == $0 )  AND
                 ( vRestOutDeb                   == $0 )  AND
                 ( vRestOutCred                  == $0 ) ) )

        vValueCurrency = rs.value( "rValueCurrency" );
        if ( vValueCurrency == 0 )  // Рублевый счет.
          vAccName = rs.value( "rAccountName" );
        else                        // Счет в ин.валюте.
          vAccName = rs.value( "rAccountName" ) + 
                     " (" + getCurrName( vValueCurrency ) + ")";
        end;

        // Строка сумм в валюте счета.
        [ | ######################### | ################### | ################ | ################ | ################ | ################ | ################ | ################ |]
        ( AccPoints( rs.value( "rAccount" ) ),
          vAccName:w, 
          vRestInDeb:a:z:17:2,
          vRestInCred:a:z:17:2,
          rs.value( "rDebitTurnOver" ):a:z:17:2,
          rs.value( "rCreditTurnOver" ):a:z:17:2,
          vRestOutDeb:a:z:17:2,
          vRestOutCred:a:z:17:2 );

        // Суммы в рублевом эквиваленте.
        if ( vValueCurrency == 0 )  // Рублевый счет.
          vRURRestInDeb      = vRestInDeb;
          vRURRestInCred     = vRestInCred;
          vRURDebitTurnOver  = rs.value( "rDebitTurnOver" );
          vRURCreditTurnOver = rs.value( "rCreditTurnOver" );
          vRURRestOutDeb     = vRestOutDeb;
          vRURRestOutCred    = vRestOutCred;
        else                        // Счет в ин.валюте.

          vRURAccount = RSB_GetKey( SubStr( rs.value( "rAccount" ), 1, 5 ) + "810" +
                                    SubStr( rs.value( "rAccount" ), 9 ) );

          vRURRestInDeb      = getRubEqu( vValueCurrency, vRestInDeb );
          vRURRestInCred     = getRubEqu( vValueCurrency, vRestInCred );
          vRURDebitTurnOver  = getRubEqu( vValueCurrency, rs.value( "rDebitTurnOver" ) );
          vRURCreditTurnOver = getRubEqu( vValueCurrency, rs.value( "rCreditTurnOver" ) );
          vRURRestOutDeb     = getRubEqu( vValueCurrency, vRestOutDeb );
          vRURRestOutCred    = getRubEqu( vValueCurrency, vRestOutCred );

          [ | ######################### | ################### | ################ | ################ | ################ | ################ | ################ | ################ |]
          ( AccPoints( vRURAccount ),
            "Рублевый эквивалент":w,
            vRURRestInDeb:a:z:17:2,
            vRURRestInCred:a:z:17:2,
            vRURDebitTurnOver:a:z:17:2,
            vRURCreditTurnOver:a:z:17:2,
            vRURRestOutDeb:a:z:17:2,
            vRURRestOutCred:a:z:17:2 );
        end;

        CurrSum( vValueCurrency, 
                 vRestInDeb,
                 vRestInCred,
                 rs.value( "rDebitTurnOver" ),
                 rs.value( "rCreditTurnOver" ),
                 vRestOutDeb,
                 vRestOutCred );

        // Итоговые суммы по счетам 2-го порядка.
        vBalRestInDeb2      = vBalRestInDeb2      + vRURRestInDeb;
        vBalRestInCred2     = vBalRestInCred2     + vRURRestInCred;
        vBalDebitTurnOver2  = vBalDebitTurnOver2  + vRURDebitTurnOver;
        vBalCreditTurnOver2 = vBalCreditTurnOver2 + vRURCreditTurnOver;
        vBalRestOutDeb2     = vBalRestOutDeb2     + vRURRestOutDeb;
        vBalRestOutCred2    = vBalRestOutCred2    + vRURRestOutCred;

        // Итоговые суммы по счетам 3-го порядка.
        vBalRestInDeb3      = vBalRestInDeb3      + vRURRestInDeb;
        vBalRestInCred3     = vBalRestInCred3     + vRURRestInCred;
        vBalDebitTurnOver3  = vBalDebitTurnOver3  + vRURDebitTurnOver;
        vBalCreditTurnOver3 = vBalCreditTurnOver3 + vRURCreditTurnOver;
        vBalRestOutDeb3     = vBalRestOutDeb3     + vRURRestOutDeb;
        vBalRestOutCred3    = vBalRestOutCred3    + vRURRestOutCred;

        // Общие итоговые суммы.
        vTotalRestInDeb   = vTotalRestInDeb   + vRURRestInDeb;
        vTotalRestInCred  = vTotalRestInCred  + vRURRestInCred;
        vTotalRestOutDeb  = vTotalRestOutDeb  + vRURRestOutDeb;
        vTotalRestOutCred = vTotalRestOutCred + vRURRestOutCred;
      end;
    else
      vRest = rs.value( "rInSum" );

      if ( rs.value( "rDebitTurnOver" ) != $0 )
        vTurnOver = rs.value( "rDebitTurnOver" )
      else
        vTurnOver = rs.value( "rCreditTurnOver" )
      end;

      if ( ( vRest != $0 )  OR  ( vTurnOver != $0 ) )

        vValueCurrency = rs.value( "rValueCurrency" );
        if ( vValueCurrency == 0 )  // Рублевый счет.
          vAccName = rs.value( "rAccountName" );
        else                        // Счет в ин.валюте.
          vAccName = rs.value( "rAccountName" ) + 
                     " (" + getCurrName( vValueCurrency ) + ")";
        end;

        // Строка сумм в валюте счета.
        [ | ######################### | ################### |         ###################         |         ###################         |                                     |]
        ( ( " *** ОШИБКА настроек: не определена активность / пассивность счета \"" +
            rs.value( "rAccount" ) + "\"" ):w,
          vAccName:w, 
          vRest:a:z:17:2,
          vTurnOver:a:z:17:2 );

        // Суммы в рублевом эквиваленте.
        if ( vValueCurrency == 0 )  // Рублевый счет.
          vRURRest     = vRest;
          vRURTurnOver = vTurnOver;
        else                        // Счет в ин.валюте.
          vRURRest     = getRubEqu( vValueCurrency, vRest );
          vRURTurnOver = getRubEqu( vValueCurrency, vTurnOver );

          [ |                           | ################### |         ###################         |         ###################         |                                     |]
          ( "Рублевый эквивалент":w,
            vRURRest:a:z:17:2,
            vRURTurnOver:a:z:17:2 );
        end;

        // Итоговые суммы по счетам 2-го порядка.
        vErrBalRestIn2 = vErrBalRestIn2 + vRURRest;
        vErrBalRestIn3 = vErrBalRestIn3 + vRURRest;
        vErrBalTurnOver = vErrBalTurnOver + vRURTurnOver;

        // Общие итоговые суммы.      
        vErrTotalRestIn = vErrTotalRestIn + vRURRest;
      end;
    end;
  end;

  if ( StrLen( vSaveAcc3 ) != 0 )
    if ( ( vBalRestInDeb3      != $0 )  OR
         ( vBalRestInCred3     != $0 )  OR
         ( vBalDebitTurnOver3  != $0 )  OR
         ( vBalCreditTurnOver3 != $0 )  OR
         ( vBalRestOutDeb3     != $0 )  OR
         ( vBalRestOutCred3    != $0 ) )
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      [ | ######################### |                     | ################ | ################ | ################ | ################ | ################ | ################ |]
      ( ( "  Итого по б/сч " + vSaveAcc3 ):w,
          vBalRestInDeb3:a:z:17:2,
          vBalRestInCred3:a:z:17:2,
          vBalDebitTurnOver3:a:z:17:2,
          vBalCreditTurnOver3:a:z:17:2,
          vBalRestOutDeb3:a:z:17:2,
          vBalRestOutCred3:a:z:17:2 );
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      vSaveAcc3 = vBalAcc3;
      vBalRestInDeb3      = $0;
      vBalRestInCred3     = $0;
      vBalDebitTurnOver3  = $0;
      vBalCreditTurnOver3 = $0;
      vBalRestOutDeb3     = $0;
      vBalRestOutCred3    = $0;
    else
      [ |---------------------------+--------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
    end;
    if ( vErrBalRestIn3 != $0 )
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      [ | Итого по ошибкам:         |                     |         ###################         |                                     |                                     |]
      ( vErrBalRestIn3:a:z:17:2 );
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      vErrBalRestIn3 = $0;
    end;
    if ( vRURTurnOver != $0 )
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
    end;
  end;

  if ( StrLen( vSaveAcc2 ) != 0 )
    if ( ( vBalRestInDeb2      != $0 )  OR
         ( vBalRestInCred2     != $0 )  OR
         ( vBalDebitTurnOver2  != $0 )  OR
         ( vBalCreditTurnOver2 != $0 )  OR
         ( vBalRestOutDeb2     != $0 )  OR
         ( vBalRestOutCred2    != $0 ) )
      // [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      [ | ######################### |                     | ################ | ################ | ################ | ################ | ################ | ################ |]
      ( ( "  Итого по б/сч " + vSaveAcc2 ):w,
          vBalRestInDeb2:a:z:17:2,
          vBalRestInCred2:a:z:17:2,
          vBalDebitTurnOver2:a:z:17:2,
          vBalCreditTurnOver2:a:z:17:2,
          vBalRestOutDeb2:a:z:17:2,
          vBalRestOutCred2:a:z:17:2 );
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      vSaveAcc2 = vBalAcc2;
      vBalRestInDeb2      = $0;
      vBalRestInCred2     = $0;
      vBalDebitTurnOver2  = $0;
      vBalCreditTurnOver2 = $0;
      vBalRestOutDeb2     = $0;
      vBalRestOutCred2    = $0;
    else
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
    end;
    if ( vErrBalRestIn2 != $0 )
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      [ | Итого по ошибкам:         |                     |         ###################         |                                     |                                     |]
      ( vErrBalRestIn2:a:z:17:2 );
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
      vErrBalRestIn2 = $0;
    end;
    if ( vRURTurnOver != $0 )
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
    end;
  end;

  cmd.Close();
  vSaveAcc2 = "";
  vSaveAcc3 = "";

  // Вторая часть Ведомости: строки, где номер счета не задан.

  cmd = RsdCommand( "select t_Account as rAccount, " +
                           "t_SortAccount as rSortAcc, " +
                           "t_AccountName as rAccountName, " +
                           "t_AccountKind as rAccountKind, " +
                           "t_ValueCurrency as rValueCurrency, " +
                           "t_InSum as rInSum, " +
                           "t_DebitTurnOver as rDebitTurnOver, " +
                           "t_CreditTurnOver as rCreditTurnOver, " +
                           "t_OutSum as rOutSum, " +
                           "t_InCol as rInCol, " +
                           "t_DebitTurnOverCol as rDebitTurnOverCol, " +
                           "t_CreditTurnOverCol as rCreditTurnOverCol, " +
                           "t_OutCol as rOutCol " +
                    "from drep_f334_tmp " +
                    "where LENGTH( t_Account ) < 2 " +
                    "order by t_AccountName" );

  cmd.execute();

  rs = RsdRecordset( cmd );

  while ( rs.moveNext )

    vRest = rs.value( "rInSum" );

    if ( rs.value( "rDebitTurnOver" ) != $0 )
      vTurnOver = rs.value( "rDebitTurnOver" )
    else
      vTurnOver = rs.value( "rCreditTurnOver" )
    end;

    if ( ( vRest != $0 )  OR  ( vTurnOver != $0 ) )

      vValueCurrency = rs.value( "rValueCurrency" );
      if ( vValueCurrency == 0 )  // Рублевый счет.
        vAccName = rs.value( "rAccountName" );
      else                        // Счет в ин.валюте.
        vAccName = rs.value( "rAccountName" ) + 
                   " (" + getCurrName( vValueCurrency ) + ")";
      end;

      // Строка сумм в валюте счета.
      [ | ######################### | ################### |         ###################         |         ###################         |                                     |]
      ( " *** ОШИБКА настроек: не определен внебалансовый счет ценности":w,
        vAccName:w, 
        vRest:a:z:17:2,
        vTurnOver:a:z:17:2 );

      // Суммы в рублевом эквиваленте.
      if ( vValueCurrency == 0 )  // Рублевый счет.
        vRURRest     = vRest;
        vRURTurnOver = vTurnOver;
      else                        // Счет в ин.валюте.
        vRURRest     = getRubEqu( vValueCurrency, vRest );
        vRURTurnOver = getRubEqu( vValueCurrency, vTurnOver );

        [ |                           | ################### |         ###################         |         ###################         |                                     |]
        ( "Рублевый эквивалент":w,
          vRURRest:a:z:17:2,
          vRURTurnOver:a:z:17:2 );
      end;

      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];

      // Общие итоговые суммы.      
      vErrTotalRestIn = vErrTotalRestIn + vRURRest;
    end;
  end;

  cmd.Close();

  // Итоги по валютам
  i = 0;
  while ( i < aSize( aCurr ) )
    if ( ( aRestID( i ) != $0 )  OR
         ( aRestIC( i ) != $0 )  OR
         ( aTurnD ( i ) != $0 )  OR
         ( aTurnC ( i ) != $0 )  OR
         ( aRestoD( i ) != $0 )  OR
         ( aRestOC( i ) != $0 ) )
      [ | Итого (###):              |                     | ################ | ################ | ################ | ################ | ################ | ################ |]
      ( getCurrName( aCurr( i ) ), 
        aRestID( i ):a:z:17:2,
        aRestIC( i ):a:z:17:2,
        aTurnD ( i ):a:z:17:2,
        aTurnC ( i ):a:z:17:2,
        aRestoD( i ):a:z:17:2,
        aRestOC( i ):a:z:17:2 );
      if ( aCurr( i ) != 0 )
        [ | ######################### |                     | ################ | ################ | ################ | ################ | ################ | ################ |]
        ( ( "Итого (" + getCurrName( aCurr( i ) ) + ") в рублях по курсу:" ):w, 
          getRubEqu( aCurr( i ), aRestID( i ) ):a:z:17:2,
          getRubEqu( aCurr( i ), aRestIC( i ) ):a:z:17:2,
          getRubEqu( aCurr( i ), aTurnD ( i ) ):a:z:17:2,
          getRubEqu( aCurr( i ), aTurnC ( i ) ):a:z:17:2,
          getRubEqu( aCurr( i ), aRestoD( i ) ):a:z:17:2,
          getRubEqu( aCurr( i ), aRestOC( i ) ):a:z:17:2 );
      end;
      [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
    end;
    i = i + 1;
  end;

  // [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
  [ | Итого:                    |                     | ################ | ################ |                  |                  | ################ | ################ |]
  ( vTotalRestInDeb:a:z:17:2, 
    vTotalRestInCred:a:z:17:2,
    vTotalRestOutDeb:a:z:17:2,
    vTotalRestOutCred:a:z:17:2 );
  if ( vErrTotalRestIn != $0 )
    // [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
    [ | Итого по ошибкам:         |                     |         ###################         |                                     |                                     |]
    ( vErrTotalRestIn:a:z:17:2 );
  end;
  [ |---------------------------+---------------------+------------------+------------------+------------------+------------------+------------------+------------------|];
  [ ];
  [ ];
  [ ];
  [    Контролер (бухгалтер)  ___________________/ #]( opr.Name + " /" );

end;
*/