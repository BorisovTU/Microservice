import RSD, deprintr, issrvdoc;

var CommonBase = true,
    NoCutDownCompensSum = false,
    CompensCoef=0,
    RestOn20061991=0,
    RestOn20061991AllAcc=0;

 const
   AT04 =  4,  /* Инвалиды 1 группы */
   AT09 =  9,  /* Наследникам 1 очереди инвалидов 1 группы */
   AT25 = 25,  /* Родитель детей-инвалидов */
   AT63 = 63,  /* Владельцам детских целевых */
   AT67 = 67,  /* Родителям погибших воинов */
   AT73 = 73,
   AT74 = 74,
   AT75 = 75,
   AT76 = 76,
   AT77 = 77,
   AT78 = 78,
   AT79 = 79,
   AT80 = 80,
   AT81 = 81,
   AT82 = 82,
   AT83 = 83,
   AT84 = 84;


var ClientList = TClientList;
var Client;

var cmd, rs;

var FullSum = 0, SumCompensBefore = 0, PriorSum = 0, Sum = 0, flag_NOrest = false;

macro isSumOfDrobIsOne(array_M, array_N, count_Legacy)
   var i=0;
   if ( count_Legacy < 2 )
      return 0;
   end;
   while (i < (count_Legacy-1) )
       array_M(i+1) = array_M(i)*array_N(i+1) + array_M(i+1)*array_N(i);
       array_N(i+1) = array_N(i)*array_N(i+1);
       i = i+1;
   end;
   if ( array_M(i) == array_N(i))
      return 1;  // true
   elif ( array_M(i) >= array_N(i))
      return 2; // ошибка ввода долей
   else
      return 0;  // false
   end;
end;

macro mount_compensCoef(data)
 var temp_date, cDay, cMon, cYear;
     DtTmSplit( data, temp_date);
     DateSplit( temp_date, cDay, cMon, cYear );

     if ( cYear == 0001 )
        CompensCoef = 1;
     elif ( cYear >= 1996 )
        CompensCoef = 1;
     elif ( cYear == 1995 )
        CompensCoef = 0.9;
     elif ( cYear == 1994 )
        CompensCoef = 0.8;
     elif ( cYear == 1993 )
        CompensCoef = 0.7;
     elif ( cYear == 1992 )
        CompensCoef = 0.6;
     elif ( cYear == 1991 )
        CompensCoef = 0;
     elif ( cYear <  1991 )
        CompensCoef = 0;
     end;  
end;

macro RefreshComp_acc(compens)
           var cmd_1, rs_1, cmd_2, rs_2, cmd_3, rs_3, cmd_4, rs_4;
           var temp_date;
/* Получаем остатки для каждого счета участвующих в расчете компенсации */
           cmd = RsdCommand(" select t_referenc from ddepositr_dbt where t_codclient = ? and t_open_date <= ? and t_account <> ? ");
           cmd.addParam("t_codclient", RsdBp_in);
           cmd.value("t_codclient") = compens.rec.CodClient;
           cmd.addParam("t_date_document", RsdBp_in);
           cmd.value("t_date_document") = date(20,06,1991);
           cmd.addParam("t_account", RsdBp_in);
           cmd.value("t_account") = compens.rec.Account;
           cmd.execute;
          
           rs = RsdRecordset(cmd); 
           while ( rs.moveNext() )
               /*по конкретному референсу и коду клиента ищу мах значения даты документа и номеру в течение дня */
               cmd_1 = RsdCommand("select t_rest from (select T_DEPDATE_DOCUMENT, t_numdaydoc, t_rest from dsbdepdoc_dbt where t_codclient = ? and " 
                                  "t_referenc = ? and T_DEPDATE_DOCUMENT <= ? and " + IsServ_const + " order by T_DEPDATE_DOCUMENT DESC, t_numdaydoc DESC )"
                                  "where rownum =1 ");
               cmd_1.addParam("t_codeclient", RsdBp_in);
               cmd_1.value("t_codeclient") = compens.rec.CodClient;
               cmd_1.addParam("t_referenc", RsdBp_in);
               cmd_1.value("t_referenc") = rs.value(0);
               cmd_1.addParam("t_date_document", RsdBp_in);
               cmd_1.value("t_date_document") = date(20,06,1991);
               cmd_1.execute;
              
               rs_1 = RsdRecordset(cmd_1); 
               rs_1.moveNext(); 

               cmd_3 = RsdCommand(" select ddepositr_dbt.t_type_account, ddepositr_dbt.t_close_date "
                                  " from ddepositr_dbt where ddepositr_dbt.t_codclient = ?  and ddepositr_dbt.t_referenc = ? ");
               cmd_3.addParam("t_codeclient", RsdBp_in);
               cmd_3.value("t_codeclient") = compens.rec.CodClient;
               cmd_3.addParam("t_referenc", RsdBp_in);
               cmd_3.value("t_referenc") = rs.value(0);
               cmd_3.execute;
               rs_3 = RsdRecordset(cmd_3); 
               if ( rs_3.moveNext() )

                  cmd_2 = RsdCommand(" select * from dcomp_acc_dbt where t_fncash = ? and t_autokey = ? and t_referenc = ? " );
                  cmd_2.addParam("t_fncash", RsdBp_in);
                  cmd_2.value("t_fncash") = compens.rec.FNCash;
                  cmd_2.addParam("t_autokey", RsdBp_in);
                  cmd_2.value("t_autokey") = compens.rec.AutoKey;
                  cmd_2.addParam("t_referenc", RsdBp_in);
                  cmd_2.value("t_referenc") = rs.value(0);
                  cmd_2.execute;
                  rs_2 = RsdRecordset(cmd_2); 

                  if ( NOT(rs_2.moveNext()) )                
                      cmd_4 = RsdCommand("insert into dcomp_acc_dbt values(?, ?, ?, ?, ?, ?)");
                      cmd_4.addParam("t_fncash", RsdBp_in);
                      cmd_4.value("t_fncash") = compens.rec.FNCash;
                      cmd_4.addParam("t_autokey", RsdBp_in);
                      cmd_4.value("t_autokey") = compens.rec.AutoKey;
                      cmd_4.addParam("t_referenc", RsdBp_in);
                      cmd_4.value("t_referenc") = rs.value(0);
                      cmd_4.addParam("t_restln20061991", RsdBp_in);
                      cmd_4.value("t_restln20061991") = rs_1.value(0);
                      cmd_4.addParam("t_type_account", RsdBp_in);
                      cmd_4.value("t_type_account") = rs_3.value(0);
                      cmd_4.addParam("t_close_date", RsdBp_in);
                      cmd_4.value("t_close_date") = rs_3.value(1);
                      cmd_4.execute;
                  end;
               end;
           end;
    //------------------------------------------------------------------------------------------------------------
end;

macro DefinSumCompensBefore_ThisAccount(compens)
    cmd = RsdCommand(" select nvl(Sum(t_sum),0) from dcompens_dbt where t_account = ? and t_appltype in (82,83,84,17,26,56) and t_date <> '01.01.0001'" );
    cmd.addParam("T_ACCOUNT", RsdBp_in);
    cmd.value("T_ACCOUNT") = compens.rec.Account;

    cmd.execute;
   
    rs = RsdRecordset(cmd); 
    if ( rs.moveNext() ) 
       SumCompensBefore = rs.value(0);
    else
       SumCompensBefore = 0;
    end;
end;

macro DefinsumCompensBefore_AllAccount(compens)
    cmd = RsdCommand(" select nvl(Sum(dcompens_dbt.t_sum),0) from dcompens_dbt where dcompens_dbt.t_appltype in (82,83,84,17,26,56) " 
                     " and dcompens_dbt.t_codclient = ? and dcompens_dbt.t_date <> '01.01.0001' ");

    cmd.addParam("T_codclient", RsdBp_in);
    cmd.value("T_codclient") = compens.rec.CodClient;
    cmd.execute;
   
    rs = RsdRecordset(cmd); 
    if ( rs.moveNext() ) 
       SumCompensBefore = rs.value(0);
    else
       SumCompensBefore = 0;
    end;
end;

macro isAccountGoPay(compens, array_M, array_N, count_Legacy) 
   var Flag = false;

    cmd = RsdCommand(" select dcompens_dbt.t_legacyPart_m ,dcompens_dbt.t_legacyPart_n from dcomp_acc_dbt, dcompens_dbt where dcomp_acc_dbt.t_referenc = ( "
                     " select t_referenc from ddepositr_dbt where t_account = ? and t_fncash = ? ) and  "
                     " dcompens_dbt.t_fncash = dcomp_acc_dbt.t_fncash and dcompens_dbt.t_autokey = dcomp_acc_dbt.t_autokey ");
    cmd.addParam("T_referenc", RsdBp_in);
    cmd.value("T_referenc") = compens.rec.Account;
    cmd.addParam("T_fncash", RsdBp_in);
    cmd.value("T_fncash") = compens.rec.FNCash;
    cmd.execute;
    rs = RsdRecordset(cmd);
    while (rs.moveNext())
         if ( (rs.value(0) == 0) or (rs.value(1) == 0) )
            array_M(count_Legacy) = 1;
            array_N(count_Legacy) = 1;
         elif( (rs.value(0) != 0) and (rs.value(1) != 0) ) 
            array_M(count_Legacy) = rs.value(0);
            array_N(count_Legacy) = rs.value(1);
         end;
         count_Legacy = count_Legacy + 1;
         Flag = true;
    end;

    if (Flag)
       setparm(3, count_Legacy);
       return 1;
    else
       return 0;
    end;

end;

macro ifPartsNotNULL(compens, type)
   var count_Legacy=0;
   ARRAY array_M, array_N;
   var cDay, cMon, cYear, temp_date;
   var Flag = false; 
   var isSum = 0;

   if   (NOT CommonBase)
        if ( (type == AT83) or (type == AT81) )
            msgbox("Сумма на оплату ритуальных услуг определяется только по общей базе");
            return 2;

        else
            DefinSumCompensBefore_ThisAccount(compens);

            cmd = RsdCommand(" select t_legacyPart_m, t_legacyPart_n from dcompens_dbt where t_account = ? and t_appltype in (82,83,84,17,26,56) and t_date <> '01.01.0001'" );
            cmd.addParam("T_ACCOUNT", RsdBp_in);
            cmd.value("T_ACCOUNT") = compens.rec.Account;

            cmd.execute;
            rs = RsdRecordset(cmd);
            while ( rs.moveNext() )
                   if ( (rs.value(0) == 0) or (rs.value(1) == 0) )
                      array_M(count_Legacy) = 1;
                      array_N(count_Legacy) = 1;
                   elif( (rs.value(0) != 0) and (rs.value(1) != 0) ) 
                      array_M(count_Legacy) = rs.value(0);
                      array_N(count_Legacy) = rs.value(1);
                   end;
                   count_Legacy = count_Legacy + 1;
                   Flag = true;
            end;

            if ( isAccountGoPay(compens, array_M, array_N, count_Legacy) == 1 )
               Flag = true;
            end;
            if ( NOT(Flag) )
               array_M(count_Legacy) = compens.rec.LegacyPart_m;
               array_N(count_Legacy) = compens.rec.LegacyPart_n;
            end;

            isSum = isSumOfDrobIsOne(array_M, array_N, count_Legacy);
            if ( isSum == 1 )
               msgbox("Компенсация выплачена");
               return 1;
            elif (isSum == 2 )
               msgbox("Ошибка в назначение долей");
               return 1;
            end;            
       
            if (RestOn20061991 >= 1000)
               PriorSum = 1000*CompensCoef;
            elif ( RestOn20061991 < 1000 )
               PriorSum = RestOn20061991*CompensCoef;
            end; 

            if (count_Legacy > 1)
               array_M(count_Legacy) = compens.rec.LegacyPart_m;
               array_N(count_Legacy) = compens.rec.LegacyPart_n;
               //---------------------------------------------//
               array_M(count_Legacy) = array_M(count_Legacy-1)*array_N(count_Legacy) + array_M(count_Legacy)*array_N(count_Legacy-1);
               array_N(count_Legacy) = array_N(count_Legacy-1)*array_N(count_Legacy);
            end;

            if ( (array_M(count_Legacy) == array_N(count_Legacy)) and (array_M(count_Legacy) != NULL) and (array_N(count_Legacy) != NULL) )
               Sum = PriorSum - SumCompensBefore; 
            else
               Sum = compens.rec.LegacyPart_m*PriorSum/compens.rec.LegacyPart_n;
            end;
                FullSum = Priorsum;
            return 1;
       end;
   elif (CommonBase)

       DefinsumCompensBefore_AllAccount(compens);

       cmd = RsdCommand(" select t_legacyPart_m, t_legacyPart_n from dcompens_dbt where t_account = ? and t_appltype in (82,83,84,17,26,56) and t_date <> '01.01.0001'" );
       cmd.addParam("T_ACCOUNT", RsdBp_in);
       cmd.value("T_ACCOUNT") = compens.rec.Account;

       cmd.execute;
       rs = RsdRecordset(cmd); 

       while ( rs.moveNext() )
           if ( (rs.value(0) == 0) or (rs.value(1) == 0) )
              array_M(count_Legacy) = 1;
              array_N(count_Legacy) = 1;
           elif ( (rs.value(0) != 0) and (rs.value(1) != 0) ) 
              array_M(count_Legacy) = rs.value(0);
              array_N(count_Legacy) = rs.value(1);
           end;
           count_Legacy = count_Legacy + 1;
           Flag = true;
       end;

       if ( isAccountGoPay(compens, array_M, array_N, count_Legacy) == 1 )
          Flag = true;
       end;

       if ( NOT(Flag) )
          array_M(count_Legacy) = compens.rec.LegacyPart_m;
          array_N(count_Legacy) = compens.rec.LegacyPart_n;
       end;

       isSum = isSumOfDrobIsOne(array_M, array_N, count_Legacy);

       if (isSum == 1 )
          msgbox("Компенсация выплачена");
          return 1;
       elif (isSum == 2 )
          msgbox("Ошибка в назначение долей");
          return 1;
       end;

        if (type == AT82)
        /* В случае если в панели был введен номер счета не существующий или не содерж. информации на 20.06.91*/
          if (flag_NOrest)
              cmd = RsdCommand("select T_ACCCLSDATE from dcompens_dbt where T_ACCOUNT = ? and T_FNCASH = ? ");
              cmd.addParam("T_ACCOUNT", RsdBp_in);
              cmd.value("T_ACCOUNT") = compens.rec.Account;
              cmd.addParam("T_FNCASH", RsdBp_in);
              cmd.value("T_FNCASH") = compens.rec.FNCash;
              cmd.execute;
             
              rs = RsdRecordset(cmd); 
              if ( rs.moveNext() )
                   mount_compensCoef(rs.value(0));

                   if (RestOn20061991 >= 1000)
                      PriorSum = PriorSum + 1000*CompensCoef;
                   elif (RestOn20061991 < 1000)
                      PriorSum = PriorSum + RestOn20061991*CompensCoef;
                   end;
              end;   
          
          end;

           /*Вычисление PriorSum */
          cmd = RsdCommand("select T_CLOSE_DATE from ddepositr_dbt where T_CODCLIENT = ? and T_OPEN_DATE <= ? ");
          cmd.addParam("T_CODCLIENT", RsdBp_in);
          cmd.value("T_CODCLIENT") = compens.rec.CodClient;
          cmd.addParam("T_OPEN_DATE", RsdBp_in);
          cmd.value("T_OPEN_DATE") = date(20,06,1991);

          cmd.execute;
         
          rs = RsdRecordset(cmd); 
          while ( rs.moveNext() )
               mount_compensCoef(rs.value(0));

               if (RestOn20061991 >= 1000)
                  PriorSum  = PriorSum + 1000*CompensCoef;
               elif (RestOn20061991 < 1000)
                  PriorSum  = PriorSum + RestOn20061991*CompensCoef;
               end;
          end;   
        elif (type == AT83 )
          if (RestOn20061991AllAcc >= 400)
             PriorSum  = 6000;
          elif (RestOn20061991AllAcc < 400)
             PriorSum  = RestOn20061991AllAcc*15;
          end;

        elif (type == AT81 )
          if (RestOn20061991AllAcc >= 400)
             PriorSum  = 6000 - SumCompensBefore;
          elif (RestOn20061991 < 400)
             PriorSum  = RestOn20061991AllAcc*15 - SumCompensBefore;
          end;

        end;

          if (count_Legacy > 1)
             array_M(count_Legacy) = compens.rec.LegacyPart_m;
             array_N(count_Legacy) = compens.rec.LegacyPart_n;
             //---------------------------------------------//
             array_M(count_Legacy) = array_M(count_Legacy-1)*array_N(count_Legacy) + array_M(count_Legacy)*array_N(count_Legacy-1);
             array_N(count_Legacy) = array_N(count_Legacy-1)*array_N(count_Legacy);
          end;

       if ( (array_M(count_Legacy) == array_N(count_Legacy)) and (array_M(count_Legacy) != NULL) and (array_N(count_Legacy) != NULL) )
          if (type == AT81 )
             cmd = RsdCommand(" select nvl(Sum(dcompens_dbt.t_sum),0) from dcompens_dbt, ddepositr_dbt where dcompens_dbt.t_account = ddepositr_dbt.T_ACCOUNT "
                              " and dcompens_dbt.t_appltype = 81 and dcompens_dbt.t_codclient = ? and t_date <> '01.01.0001' ");

             cmd.addParam("T_codclient", RsdBp_in);
             cmd.value("T_codclient") = compens.rec.CodClient;
             cmd.execute;

             rs = RsdRecordset(cmd); 
             if ( rs.moveNext() )
                SumCompensBefore = rs.value(0);
             else
                SumCompensBefore = 0;
             end;

          end;

          Sum = PriorSum - SumCompensBefore; 
       else
          Sum = compens.rec.LegacyPart_m*PriorSum/compens.rec.LegacyPart_n;
       end;
          FullSum = Priorsum;
   return 0;  // Обновляем файл comp_acc.dbt
   end;
end;

macro take_close_date(compens) 
var cmd_1, rs_1,temp_date, Day, Mon, Year;
  var d,m,y;
  DateSplit( compens.rec.AccClsDate, d, m, y );

  if ( (( d == 1 ) and ( m == 1 ) and ( y == 1 )) or (( d == 0 ) and ( m == 0 ) and ( y == 0 )) )
    GetDate( compens.rec.AccClsDate, " Введите дату закрытия счета " );
  end;

/*     cmd_1 = RsdCommand(" select T_ACCCLSDATE from dcompens_dbt where t_autokey = ? and t_fncash = ? "  );
     cmd_1.addParam("t_autokey", RsdBp_in);
     cmd_1.value("t_autokey") = compens.rec.AutoKey;
     cmd_1.addParam("t_fncash", RsdBp_in);
     cmd_1.value("t_fncash") = compens.rec.FNCash;
     cmd_1.execute;
     rs_1 = RsdRecordset(cmd_1); 
     rs_1.moveNext();
     
     DtTmSplit(rs_1.value(0), temp_date);
     DateSplit( temp_date, Day, Mon, Year );

     if ( (Day==1) and (Mon==1) and (Year==1) )
        msgbox("Введите дату закрытия счета.");
        exit(1);
     end;
*/
end;

// проверка - существует ли счет в базе
macro check_and_mount_Rest(compens)

 var notInBase = false, rest = 0.0;

  if ( compens.rec.restin91 == 0 )
    // Пытаемся найти в базе
    cmd = RsdCommand(" select count(*) from ddepositr_dbt where t_account = ? and t_open_date <= ? "  );
    cmd.addParam("t_account", RsdBp_in);
    cmd.value("t_account") = compens.rec.Account;
    cmd.addParam("t_open_date", RsdBp_in );
    cmd.value("t_open_date") = date(20,06,1991);
    cmd.execute;
  
    rs = RsdRecordset(cmd); 
    rs.moveNext();
    if (rs.value(0) != 0)
      cmd = RsdCommand(" select t_referenc from ddepositr_dbt where t_account = ? and t_open_date <= ? "  );
      cmd.addParam("t_account", RsdBp_in);
      cmd.value("t_account") = compens.rec.Account;
      cmd.addParam("t_open_date", RsdBp_in);
      cmd.value("t_open_date") = date(20,06,1991);
      cmd.execute;
      rs = RsdRecordset(cmd); 
      if ( rs.moveNext() )      
        cmd = RsdCommand(" select count(*) from dsbdepdoc_dbt where t_referenc = ? and T_DEPDATE_DOCUMENT <= ? "  );
        cmd.addParam("t_account", RsdBp_in);
        cmd.value("t_account") = rs.value(0);
        cmd.addParam("t_open_date", RsdBp_in);
        cmd.value("t_open_date") = date(20,06,1991);
        cmd.execute;
        rs = RsdRecordset(cmd); 
        rs.moveNext();
        if (rs.value(0) == 0)
           // нету в базе, просим ввести остаток???
           notInBase = true;
           GetMoney(rest, "Уточните остаток на 20.06.1991");
           take_close_date(compens);
         else
           // а это типа есть в базе?
           notInBase = false;
           return notInBase;
         end;
      else
        // а это типа референс не нашли?
        // а мы сюда вообще когда нибудь заходим?
        notInBase = false;
        return notInBase;
      end;
    else
      // а это изначально ничего нету, просим ввести остаток.. так ведь?
      notInBase = true;
      GetMoney(rest, "Уточните остаток на 20.06.1991");
      take_close_date(compens); // установлена ли дата закрытия счета
    end;
  else 
    notInBase = true;
    rest = compens.rec.restin91;
  end;
  if (rest != 0)
     RestOn20061991 = rest;
  else
     msgbox("Невозможно определить остаток на 20.06.1991");
     exit(1);
  end;
  return notInBase;
end;

// Проверка - была ли компенсация 
macro Check_compens_pay(compens)
var day, mon, year;

  DateSplit( compens.rec.Date, day, mon, year );
  
  if ( compens.rec.Date != "" )
     msgbox("Повторный расчет зачисленной компенсации запрещен");
     exit(1);
  end;
end;

//----------------MAIN ---- функция непосредственного расчета

MACRO CheckCompensationType (compens)

  var DestCodeClient = compens.rec.DestClientCode,
      CodeClient = compens.rec.CodClient,
      CompensType = compens.rec.Kind,
      ClientType = compens.rec.Appltype,
      panel_compenscoef = 0;
      
  var dDay, dMon, dYear; /* День, месяц, год смерти клиента */
  var bDay, bMon, bYear; /* День, месяц, год рождения клиента */
  var cDay, cMon, cYear; /* День, месяц, год закрыие счета */
  var cmd_1, rs_1, cmd_2, rs_2, temp_date;

      Check_compens_pay(compens);
      flag_NOrest = check_and_mount_Rest(compens);
      Client = ClientList.CurRec;      

// ****************************************
// * Инициализация предварительных данных *
// ****************************************
     if (  ( ClientType == AT81 )  OR  
           ( ClientType == AT83 )  )
           if ( NOT CommonBase )
               msgbox("Сумма на оплату ритуальных услуг определяется только по общей базе");
               return 1;
           end;

           /*нахожу все референсы для конкретного кода клиента */
           cmd = RsdCommand(" select t_referenc from ddepositr_dbt where t_codclient = ? and t_open_date <= ? "  );
           cmd.addParam("t_codclient", RsdBp_in);
           cmd.value("t_codclient") = compens.rec.CodClient;
           cmd.addParam("t_open_date", RsdBp_in);
           cmd.value("t_open_date") = date(20,06,1991);
           cmd.execute;
          
           rs = RsdRecordset(cmd); 
           while ( rs.moveNext() )
               /*по конкретному референсу и коду клиента ищу мах значения даты документа и номеру в течение дня */
               cmd_1 = RsdCommand("select t_rest from (select t_numdaydoc, T_DEPDATE_DOCUMENT, t_rest from dsbdepdoc_dbt "
                                  "where t_codclient = ? and t_referenc = ? and T_DEPDATE_DOCUMENT <= ? and " + IsServ_const + " order by T_DEPDATE_DOCUMENT DESC, t_numdaydoc DESC ) "
                                  "where rownum =1 ");
               cmd_1.addParam("t_codeclient", RsdBp_in);
               cmd_1.value("t_codeclient") = compens.rec.CodClient;
               cmd_1.addParam("t_referenc", RsdBp_in);
               cmd_1.value("t_referenc") = rs.value(0);
               cmd_1.addParam("t_date_document", RsdBp_in);
               cmd_1.value("t_date_document") = date(20,06,1991);
               cmd_1.execute;
              
               rs_1 = RsdRecordset(cmd_1); 
               rs_1.moveNext(); 
               RestOn20061991AllAcc = RestOn20061991AllAcc + rs_1.value(0);           
           end;
           if (flag_NOrest)
              RestOn20061991AllAcc = RestOn20061991AllAcc + RestOn20061991;
           end;
           RestOn20061991 = RestOn20061991AllAcc;
     end;
     if (  ( ClientType == AT77 )  OR  
           ( ClientType == AT09 )  )
           if ( ClientList.GetRecord( CodeClient ) )
              DateSplit( Client.rec.DateDeath, dDay, dMon, dYear );

              if ( (dYear >= 1998) AND (dYear <= 2000))
                 if ( GetTrue( false, "Вкладчик является участником ВОВ?"  ) )
                    NoCutDownCompensSum = true;
                 end;  
              end;

              if ( (dYear >= 2001) AND (dYear <= 2004))
                 NoCutDownCompensSum = true;
              end;

    	   end;
     end;

// Если коэффициэнт не введен в панели, то пытаемся его определить
     if ( compens.rec.rate == 0 )
       if (flag_NOrest)
         cmd = RsdCommand("select T_ACCCLSDATE from dcompens_dbt where T_ACCOUNT = ? and T_FNCASH = ? ");
         cmd.addParam("T_ACCOUNT", RsdBp_in);
         cmd.value("T_ACCOUNT") = compens.rec.Account;
         cmd.addParam("T_FNCASH", RsdBp_in);
         cmd.value("T_FNCASH") = compens.rec.FNCash;
       else
         cmd = RsdCommand("select T_CLOSE_DATE from ddepositr_dbt where T_ACCOUNT = ? and T_FNCASH = ? and T_OPEN_DATE <= ? ");
         cmd.addParam("T_ACCOUNT", RsdBp_in);
         cmd.value("T_ACCOUNT") = compens.rec.Account;
         cmd.addParam("T_FNCASH", RsdBp_in);
         cmd.value("T_FNCASH") = compens.rec.FNCash;
         cmd.addParam("T_OPEN_DATE", RsdBp_in);
         cmd.value("T_OPEN_DATE") = date(20,06,1991);
       end;

       cmd.execute;
    
       rs = RsdRecordset(cmd); 
       if ( rs.moveNext() )
         mount_compensCoef(rs.value(0));
       else
         CompensCoef = 0;
       end;
     else
       CompensCoef = compens.rec.rate;
     end;

     panel_compenscoef = CompensCoef;
      

     if (  ( ClientType == AT73 )  OR  
           ( ClientType == AT04 )  OR
           ( ClientType == AT25 )  OR
           ( ClientType == AT76 )  OR                                    
           ( ClientType == AT63 )  OR
           ( ClientType == AT77 )  OR
           ( ClientType == AT09 )  OR
           ( ClientType == AT74 )  OR
           ( ClientType == AT75 )  OR
           ( ClientType == AT80 )  OR
           ( ClientType == AT67 )  OR
           ( ClientType == AT78 )  OR
           ( ClientType == AT79 )  OR
           ( ClientType == AT84 )  OR
           ( ClientType == AT82 )  )

	   
       // Если в панели не введена сумма остатка, то пытаемся ее определить  
       if ( compens.rec.restin91 == 0 )
         if  ( NOT( flag_NOrest ) ) 
           if ( compens.rec.Account != strfor(1))
              cmd = RsdCommand(" select t_rest from ("
                                   " select t_rest " // селектилось еще вот это "T_DEPDATE_DOCUMENT, t_numdaydoc, ", но, не вижу смысла делать это дальше 
                                   " from dsbdepdoc_dbt where t_codclient = ? and t_referenc = ("
                                             "select t_referenc "
                                             " from ddepositr_dbt where t_fncash = ? and t_account = ? "
                                   " and " + IsServ_const + 
                                   " and T_DEPDATE_DOCUMENT <= ?) "
                                   " order by T_DEPDATE_DOCUMENT DESC, t_numdaydoc DESC) "
                               " where rownum = 1 ");
              cmd.addParam("T_codclient", RsdBp_in);
              cmd.value("T_codclient") = compens.rec.CodClient;
              cmd.addParam("T_FNCASH", RsdBp_in);
              cmd.value("T_FNCASH") = compens.rec.FNCash;
              cmd.addParam("T_ACCOUNT", RsdBp_in);
              cmd.value("T_ACCOUNT") = compens.rec.Account;
              cmd.addParam("t_date_document", RsdBp_in);
              cmd.value("t_date_document") = date(20,06,1991);

              cmd.execute;
             
              rs = RsdRecordset(cmd); 
              if ( NOT(rs.moveNext()) )                
                 msgbox("Невозможно определить остаток на 20.06.1991");
                 return 1;
              end;
              RestOn20061991 = rs.value(0);
           else
              msgbox("Невозможно определить остаток на 20.06.1991");
              return 1;
           end;
         end;
       else
         RestOn20061991 = compens.rec.restin91;
       end;
     end;
//***********************************************************************************************
//-------------Расчет FullSum ----------------------------------------------------------------- *
//***********************************************************************************************

     if (  ( ClientType == AT73 )  OR  
           ( ClientType == AT04 )  )

           cmd = RsdCommand(" select nvl(Sum(t_sum),0) from dcompens_dbt where t_codclient = ? and t_account = ? and t_appltype not in (82,83,84,17,26,56) and t_date <> '01.01.0001' " );
           cmd.addParam("T_codclient", RsdBp_in);
           cmd.value("T_codclient") = compens.rec.CodClient;
           cmd.addParam("T_account", RsdBp_in);
           cmd.value("T_account") = compens.rec.Account;
           cmd.execute;
          
           rs = RsdRecordset(cmd); 
           if ( rs.moveNext())
              SumCompensBefore = rs.value(0);
           else
              SumCompensBefore = 0;
           end;
                            
           FullSum = RestOn20061991*CompensCoef - SumCompensBefore;
           Sum = FullSum;               
     end;
  //----------------------------------------------
     if ( ClientType == AT63 )
           cmd = RsdCommand(" select nvl(Sum(t_sum),0) from dcompens_dbt where t_codclient = ? and t_account = ? and t_appltype not in (82,83,84,17,26,56) and t_date <> '01.01.0001' " );
           cmd.addParam("T_codclient", RsdBp_in);
           cmd.value("T_codclient") = compens.rec.CodClient;
           cmd.addParam("T_account", RsdBp_in);
           cmd.value("T_account") = compens.rec.Account;
           cmd.execute;
          
           rs = RsdRecordset(cmd); 
           
           if ( rs.moveNext() ) 
             SumCompensBefore = rs.value(0);
           else 
             SumCompensBefore = 0;
           end;

           if (SumCompensBefore == 0)
              if (RestOn20061991 >= 1000)
                 FullSum = 1000*CompensCoef;
              elif ( RestOn20061991 < 1000 )
                 FullSum = RestOn20061991*CompensCoef;
              end; 

           else
              cmd = RsdCommand(" select count(*) from dcompens_dbt where t_codclient = ? and t_account = ? and t_appltype not in (82,83,84,17,26,56) "
                               " and t_kind < 6 and t_date <> '01.01.0001' " );
              cmd.addParam("T_codclient", RsdBp_in);
              cmd.value("T_codclient") = compens.rec.CodClient;
              cmd.addParam("T_account", RsdBp_in);
              cmd.value("T_account") = compens.rec.Account;
              cmd.execute;
             
              rs = RsdRecordset(cmd); 
              rs.moveNext();
              if (rs.value(0) == 1)

                 cmd = RsdCommand(" select count(*) from dcompens_dbt where t_codclient = ? and t_account = ? and t_appltype not in (82,83,84,17,26,56) "
                                  " and t_kind = 6 and t_date <> '01.01.0001' " );
                 cmd.addParam("T_codclient", RsdBp_in);
                 cmd.value("T_codclient") = compens.rec.CodClient;
                 cmd.addParam("T_account", RsdBp_in);
                 cmd.value("T_account") = compens.rec.Account;
                 cmd.execute;
                
                 rs = RsdRecordset(cmd); 
                 rs.moveNext();
                 if (rs.value(0) == 0)

                    if (RestOn20061991 >= 2000)
                       FullSum = 1000*CompensCoef;
                    elif ( (RestOn20061991 > 1000) AND (RestOn20061991 < 2000) )
                       FullSum = (RestOn20061991 - 1000)*CompensCoef;
                    end;
                 else
                    msgbox("Компенсация по этому счету была выполнена");
                    exit(1);
                 end;
              else
                 msgbox("Компенсация по этому счету была выполнена");
                 exit(1);                               
              end;
           end;
           Sum = FullSum;           
     end;
  //----------------------------------------------
     if (  ( ClientType == AT25 )  OR
           ( ClientType == AT76 )  )

           if (RestOn20061991 >= 2000)
              FullSum = 1000*CompensCoef;
           elif ( (RestOn20061991 > 1000) AND (RestOn20061991 < 2000) )
              FullSum = (RestOn20061991 - 1000)*CompensCoef;
           end;
           Sum = FullSum; 
     end;
  //-----------------------------------------------
     if (  ( ClientType == AT77 )  OR  
           ( ClientType == AT09 )  )

           if (NoCutDownCompenssum)
              cmd = RsdCommand(" select nvl(Sum(t_sum),0) from dcompens_dbt where t_codclient = ? and t_account = ? and t_appltype not in (81,83) and t_date <> '01.01.0001' " );
              cmd.addParam("T_codclient", RsdBp_in);
              cmd.value("T_codclient") = compens.rec.CodClient;
              cmd.addParam("T_account", RsdBp_in);
              cmd.value("T_account") = compens.rec.Account;             
           else
              cmd = RsdCommand(" select nvl(Sum(t_sum),0) from dcompens_dbt where t_codclient = ? and t_account = ? and t_date <> '01.01.0001' " );
              cmd.addParam("T_codclient", RsdBp_in);
              cmd.value("T_codclient") = compens.rec.CodClient;
              cmd.addParam("T_account", RsdBp_in);
              cmd.value("T_account") = compens.rec.Account;
           end;
           cmd.execute;
          
           rs = RsdRecordset(cmd); 
           if (rs.moveNext())
              SumCompensBefore = rs.value(0);
           else
              SumCompensBefore = 0;
           end;
                            
           FullSum = RestOn20061991*CompensCoef - SumCompensBefore;               

           Sum = FullSum;
     
     end;
//--------------------------------------------------
     if (  ( ClientType == AT74 )  OR
           ( ClientType == AT75 )  OR
           ( ClientType == AT80 )  OR
           ( ClientType == AT67 )  OR
           ( ClientType == AT78 )  OR
           ( ClientType == AT79 )  OR
           ( ClientType == AT84 )  )

           cmd = RsdCommand(" select nvl(Sum(t_sum),0) from dcompens_dbt where t_codclient = ? and t_account = ? and t_appltype not in (82,83,84,17,26,56) and t_date <> '01.01.0001' " );
           cmd.addParam("T_codclient", RsdBp_in);
           cmd.value("T_codclient") = compens.rec.CodClient;
           cmd.addParam("T_account", RsdBp_in);
           cmd.value("T_account") = compens.rec.Account;
           cmd.execute;
          
           rs = RsdRecordset(cmd); 
           if ( rs.moveNext() ) 
              SumCompensBefore = rs.value(0);      
           else
              SumCompensBefore = 0;
           end;

           if (SumCompensBefore == 0)
              if (RestOn20061991 >= 1000)
                 FullSum = 1000*CompensCoef;
              elif ( RestOn20061991 < 1000 )
                 FullSum = RestOn20061991*CompensCoef;
              end; 
           else
               msgbox("Компенсация по этому счету была выполнена");
               exit(1);
           end;
           Sum = FullSum;

     end;
//------------------------------------------------------
     if ( ClientType == AT82 )  

        if ( (compens.rec.LegacyPart_m == 0) and (compens.rec.LegacyPart_n == 0) )
           if   (NOT CommonBase )
      
                DefinSumCompensBefore_ThisAccount(compens);

                if (SumCompensBefore == 0)
                   if (RestOn20061991 >= 1000)
                      FullSum = 1000*CompensCoef;
                   elif ( RestOn20061991 < 1000 )
                      FullSum = RestOn20061991*CompensCoef;
                   end; 
                else
                   msgbox("Компенсация по этому счету была выполнена");
                   exit(1);
                end;


           elif (CommonBase)

               DefinsumCompensBefore_AllAccount(compens);
               if (SumCompensBefore == 0)
                  if (flag_NOrest)
                      cmd = RsdCommand("select T_ACCCLSDATE from dcompens_dbt where T_ACCOUNT = ? and T_FNCASH = ? ");
                      cmd.addParam("T_ACCOUNT", RsdBp_in);
                      cmd.value("T_ACCOUNT") = compens.rec.Account;
                      cmd.addParam("T_FNCASH", RsdBp_in);
                      cmd.value("T_FNCASH") = compens.rec.FNCash;
                      cmd.addParam("T_OPEN_DATE", RsdBp_in);
                      cmd.value("T_OPEN_DATE") = date(20,06,1991);
                      cmd.execute;
                     
                      rs = RsdRecordset(cmd); 
                      if ( rs.moveNext() )
                           mount_compensCoef(rs.value(0));

                           if (RestOn20061991 >= 1000)
                              FullSum = FullSum + 1000*CompensCoef;
                           elif (RestOn20061991 < 1000)
                              FullSum = FullSum + RestOn20061991*CompensCoef;
                           end;
                      end;   
                  
                  end;

                  cmd = RsdCommand("select T_CLOSE_DATE from ddepositr_dbt where T_CODCLIENT = ? and T_OPEN_DATE <= ? ");
                  cmd.addParam("T_CODCLIENT", RsdBp_in);
                  cmd.value("T_CODCLIENT") = compens.rec.CodClient;
                  cmd.addParam("T_OPEN_DATE", RsdBp_in);
                  cmd.value("T_OPEN_DATE") = date(20,06,1991);

                  cmd.execute;
                 
                  rs = RsdRecordset(cmd); 
                  while ( rs.moveNext() )
                       mount_compensCoef(rs.value(0));

                       if (RestOn20061991 >= 1000)
                          FullSum = FullSum + 1000*CompensCoef;
                       elif (RestOn20061991 < 1000)
                          FullSum = FullSum + RestOn20061991*CompensCoef;
                       end;
                  end;   
               else
                  msgbox("Компенсация по этому счету была выполнена");
                  exit(1);
               end;
           end;
        elif ( (compens.rec.LegacyPart_m != 0) and (compens.rec.LegacyPart_n != 0) )
             if ( ifPartsNotNULL(compens, AT82) == 0)
                 RefreshComp_acc(compens);
             end;
        end;
     end;

     if (  ClientType == AT83 )
        if ( (compens.rec.LegacyPart_m == 0) and (compens.rec.LegacyPart_n == 0) )
           if   ( NOT CommonBase )
                msgbox("Сумма на оплату ритуальных услуг определяется только по общей базе");
                return 1;
           elif (CommonBase)

               DefinsumCompensBefore_AllAccount(compens);
                
               if (SumCompensBefore == 0)
                   if (RestOn20061991AllAcc >= 400)
                      FullSum = 6000;
                   elif (RestOn20061991AllAcc < 400)
                      FullSum = RestOn20061991AllAcc*15;
                   end;
               else
                  msgbox("Компенсация по этому счету была выполнена");
                  exit(1);

               end;
           end;
        elif (( (compens.rec.LegacyPart_m != 0) and (compens.rec.LegacyPart_n != 0) ))
             if ( ifPartsNotNULL(compens, AT83) == 0)
                 RefreshComp_acc(compens);
             elif (ifPartsNotNULL(compens, AT83) == 2)
                 return 1;
             end;
        end;

     end;

     if (  ClientType == AT81 )
        if ( (compens.rec.LegacyPart_m == 0) and (compens.rec.LegacyPart_n == 0) )
           if   (NOT CommonBase )
                msgbox("Сумма на оплату ритуальных услуг определяется только по общей базе");
                return 1;
           elif (CommonBase)

               DefinsumCompensBefore_AllAccount(compens);
                
               if (SumCompensBefore == 0)
                   if (RestOn20061991AllAcc >= 400)
                      FullSum = 6000 - SumCompensBefore;
                   elif (RestOn20061991AllAcc < 400)
                      FullSum = RestOn20061991AllAcc*15 - SumCompensBefore;
                   end;
               else
                  msgbox("Компенсация по этому счету была выполнена");
                  exit(1);
               end;
           end;
        elif (( (compens.rec.LegacyPart_m != 0) and (compens.rec.LegacyPart_n != 0) ))
             if ( ifPartsNotNULL(compens, AT81) == 0)
                 RefreshComp_acc(compens);
             elif (ifPartsNotNULL(compens, AT81) == 2)
                 return 1;
             end;
        end;     
     end;

   if ( FullSum < 0 )
       FullSum = 0;
       msgbox("Сумма компенсации (без учета долей) получила отрицательное значение");
   end;
   if ( Sum < 0 )
       Sum = 0;
       msgbox("Сумма компенсации получила отрицательное значение");
   end;

   cmd = RsdCommand("update dcompens_dbt set T_FUllSUM = ?, t_restin91 = ?, T_rate = ?, t_sum = ?, t_AccClsDate = ?  where T_FNCASH = ? and T_AUTOKEY = ? ");
   cmd.addParam("t_fullsum", RsdBp_in);
   cmd.value("t_fullsum") = FullSum;
   cmd.addParam("t_restln91", RsdBp_in);
   cmd.value("t_restln91") = RestOn20061991;
   cmd.addParam("t_rate", RsdBp_in);
   cmd.value("t_rate") = panel_compenscoef;
   cmd.addParam("t_sum", RsdBp_in);
   cmd.value("t_sum") = Sum;
   cmd.addParam("t_date", RsdBp_in);  
   cmd.value("t_date") = compens.rec.AccClsDate;
   cmd.addParam("FNCash", RsdBp_in);
   cmd.value("FNCash") = compens.rec.FNCash;
   cmd.addParam("AutoKey",RsdBp_in);
   cmd.value("AutoKey") = compens.rec.AutoKey;
   cmd.execute;
      
  return 0;

  OnError ( e )
    // Ошибки
    println ("Произошла ошибка");
    var i = 0;
    while ( i < RslDefEnv.ErrorCount )
      println ( " Системная ошибка - " + RslDefEnv.Error(i).descr );
      i = i + 1;
    end;

end;