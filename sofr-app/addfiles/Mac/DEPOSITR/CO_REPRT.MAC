/***************************************************************************
*  ---------------------                                                   *
*  R-Style SoftWare Lab.                                                   *
*  ---------------------                                                   *
*  RS-Retail                                                               *
*                                                                          *
*  Список кассовых операций и коммунальных платежей                        *
*                                                                          *
*  Лебедев С.В.                                                            *
*  16.12.97                                                                *
***************************************************************************/
import deprintr;

file cp_type  ("rtcp_type.dbt" );/* Вид комплатежа */
file pay_kind ("pay_kind.dbt"); /* Виды платежей       */
file pay_csop ("pay_csop.dbt"); /* Подвиды платежей    */
file pay_doc  ("pay_doc.dbt" ); /* Документы платежей  */
file PmntProp ("RTPaymentProp.dbt"); /* реквизиты получателя */
file currency ("currency.dbt"); /* Справочник валют    */
private var person = TBFile("person.dbt", "R", 0, null, "bank.def");

var {curdate};                      /* Текущая дата */
var OperBrigade = GetOperBrigade(); /* Бригада      */

array ACur;     /* Массивы для подсчета сумм */
array ASum;

array AKind;    /* Массивы для группировки сумм по видам платежей */
array AKSum;

var FlagBegin = TRUE;

/* Значения кода режима работы */
const MODE_NORMAL = 0;       /* Нормальный режим */
const MODE_EOY = 1;          /* Конец периода */
const MODE_EOY_PRECALC = 2;  /* Конец периода - документы предварительного расчета */
const MODE_GZ = 4;     /* Группа зачисления */

/***************************************************************************
                          Поиск валюты по ее коду
***************************************************************************/
macro FindCurrency (Cod_Curr)

  KeyNum(currency,0);
  currency.Code_Currency = Cod_Curr;

  return GetEQ(currency);

end;


/***************************************************************************
                             Поиск вида комплатежа
***************************************************************************/
macro Find_CPType( id )

  KeyNum(cp_type,0);
  cp_type.Id = id;

  return GetEQ(cp_type);

end;


/***************************************************************************
                             Поиск вида платежа
***************************************************************************/
macro Find_PayKind

  KeyNum(pay_kind,0);
  pay_kind.IsCur      = pay_doc.IsCur;
  pay_kind.GroupOpert = pay_doc.GroupOpert;
  pay_kind.NumOperat  = pay_doc.NumOpert;

  return GetEQ(pay_kind);

end;


/***************************************************************************
                           Поиск подвида платежа
***************************************************************************/
macro Find_PayCsOp

  var stat = FALSE;

  if (pay_doc.ApplType > 0)
    KeyNum(pay_csop,0);
    pay_csop.IsCur     = pay_doc.IsCur;
    pay_csop.GroupType = pay_doc.GroupOpert;
    pay_csop.NumOperat = pay_doc.NumOpert;
    pay_csop.ApplType  = pay_doc.ApplType;
    stat = GetEQ(pay_csop);
  end;

  return stat;

end;


/***************************************************************************
                   Уровни доступа
***************************************************************************/
private MACRO DefTypePerson( )

  person.clear( );
  person.rec.Oper = GetOper();
  if( person.getEQ( ) )
    return person.rec.cTypePerson;
  else
    return "";
  end;

END;

/***************************************************************************
                    Формирование основания для отчета
***************************************************************************/
macro FormGround

  var Ground = "";

  /* ------------------- Коммунальные платежи ------------------- */
  if (pay_doc.GroupOpert == 1)
    /* Название получателя */
    Ground = PmntProp.Name;
  /* ------------- Наличные перечисления и выплаты -------------- */
  elif ((pay_doc.GroupOpert == 11) OR (pay_doc.GroupOpert == 41))
    /* Вид платежа */
    if (Find_PayKind())
      Ground = pay_kind.SzNameAlg + " ";
    end;
    /* Подвид платежа */
    if (Find_PayCsOp())
      Ground = Ground + "(" + pay_csop.NameCompType + ") ";
    end;
    /* Счет */
    Ground = Ground + Acc_Form(PmntProp.Account);
  /* ------------------------- Комиссии ------------------------- */
  elif (pay_doc.GroupOpert == 21)
    /* Вид платежа */
    if (Find_PayKind())
      Ground = pay_kind.SzNameAlg;
    end;
  /* ------------------------ Конверсии ------------------------- */
  elif (pay_doc.GroupOpert == 31)
    /* ФИО */
    Ground = pay_doc.ClientLastName;
    if (StrLen(pay_doc.ClientFirstName) > 0)
      Ground = Ground + " " + SubStr(pay_doc.ClientFirstName,1,1) + ".";
    end;
    if (StrLen(pay_doc.ClientSecondName) > 0)
      Ground = Ground + " " + SubStr(pay_doc.ClientSecondName,1,1) + ".";
    end;
  end;

  Ground = Trim(Ground);
  if (Ground == "")
    Ground = " "; /* Чтобы не ругалась StrSplit */
  end;

  return Ground;

end;


/***************************************************************************
              Печать заголовка отчета по коммунальным платежам
***************************************************************************/
macro HeadComPayReport (NumKKM)

  var str;
  var d,m,y;
  var Day,Month,Year;

  str = "                                                Ф. No 17";
  [#](str);
  str = " ";
  [#](str);
  str = "                           СПРАВКА";
  [#](str);
  str = "                   о сумме платежей по ККМ";
  [#](str);
        [                               #]( NumKKM:c );
  str = "                        поступивших за";
  [#](str);
  DateSplit({curdate},d,m,y);
  Day = String(d);
  while (StrLen(Day) < 2)
    Day = "0" + Day;
  end;
  if   (m ==  1) Month = "января  ";
  elif (m ==  2) Month = "февраля ";
  elif (m ==  3) Month = "марта   ";
  elif (m ==  4) Month = "апреля  ";
  elif (m ==  5) Month = "мая     ";
  elif (m ==  6) Month = "июня    ";
  elif (m ==  7) Month = "июля    ";
  elif (m ==  8) Month = "августа ";
  elif (m ==  9) Month = "сентября";
  elif (m == 10) Month = "октября ";
  elif (m == 11) Month = "ноября  ";
  elif (m == 12) Month = "декабря ";
  else           Month = "        ";
  end;
  Year = String(y);
  str = "                     " + "\"" + Day + "\" " + Month + " " + Year + "г.";
  [#](str);
  str = " ";
  [#](str);
  str = " 1. Показания суммирующих регистров контрольно-регистрирующей";
  [#](str);
  str = "    машины";
  [#](str);
  str = " ";
  [#](str);
  str = "    No__________";
  [#](str);
  str = " ";
  [#](str);
  str = "    ──────────────────────────┬──────────────────────────────";
  [#](str);
  str = "        Номер регистра        │  Принято за день; руб.,коп.";
  [#](str);
  str = "    ──────────────────────────┼──────────────────────────────";
  [#](str);

end;


/************************************************************
************************************************************/
macro BottomComPayReport (SumSum)

  var str;
  var Rub,Cop;

  str = String(SumSum:18:2:a);
  Rub = "";
  Cop = "00";
  if (Index(str,".") > 0)
    Rub = Trim(SubStr(str,1,Index(str,".") - 1));
    Cop = SubStr(str,Index(str,".") + 1);
  end;
  if (StrLen(Rub) == 0)
    Rub = "0";
  end;
  while (StrLen(Rub) < 10)
    Rub = Rub + " ";
  end;
  while (StrLen(Cop) < 2)
    Cop = Cop + " ";
  end;

  str = "    ──────────────────────────┼──────────────────────────────";
  [#](str);
  str = "       Итого..................│     " + String(SumSum:18:2:a);
  [#](str);
  str = "                              └──────────────────────────────";
  [#](str);
  str = " ";
  [#](str);
  str = " 2. Документы, неправильно отраженные";
  [#](str);
  str = "    в контрольной ленте контрольно-ре-";
  [#](str);
  str = "    гистрирующей машины (ошибки, при-";
  [#](str);
  str = "    ведшие к увеличению показаний сум-";
  [#](str);
  str = "    мирующих регистров)                  __________руб.__коп.";
  [#](str);
  str = " ";
  [#](str);
  str = " 3. Сумма платежей, принятых за день     " + Rub + "руб." + Cop + "коп.";
  [#](str);
  str = " ";
  [#](str);
  str = " 4. Показание контрольного регистра";
  [#](str);
  str = "    гашения суммирующих регистров        ____________________";
  [#](str);
  str = " ";
  [#](str);
  str = "                  Заведующий филиалом ______________________";
  [#](str);
  str = "                                            (подпись)";
  [#](str);
  str = " ";
  [#](str);
  str = "                               Кассир ______________________";
  [#](str);
  str = "                                            (подпись)";
  [#](str);
  str = " ";
  [#](str);
  str = "          Проверено: бухгалтер ______________________";
  [#](str);
  str = "                                      (подпись)";
  [#](str);
  [ ];
  [ ];
  [---------------------------------------------------------];
  [ ];
  [ ];

end;


/************************************************************
************************************************************/
macro PrintRepString

  var str;
  var i = 0;
  var f = false;
  var s = $0L;

  /* Поиск элемента массива видов платежей */
  if (ASize(AKind) > 0)
    while (i < ASize(AKind))
      if (AKind(i) == cp_type.Id)
        f = true;
        s = AKSum(i);
      end;
      i = i + 1;
    end;
  end;

  if (not f)
    return;
  end;

  if (FlagBegin)
    FlagBegin = FALSE;
  else
    str = "                              ├──────────────────────────────";
    [#](str);
  end;

  /* Название вида платежа */
  str = "       " + SubStr(cp_type.Name,1,23);
  while (StrLen(str) < 30)
    str = str + " ";
  end;
  str = str + "│     " + String(s:18:2:a);
  [#](str);

end;


/************************************************************
************************************************************/
macro KindComPay
(
 PrevNumOpert,
 SumNumOpert
)

  var i, j, num;

  if ( Find_CPType(PrevNumOpert) )
    num = cp_type.Id;
  else
    num = -1;
  end;

  if (Asize(AKind) == 0)
    AKind(0) = num;
    AKSum(0) = SumNumOpert;
  else
    i = 0;
    j = -1;
    while (i < Asize(AKind))
      if (AKind(i) == num)
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(AKind);
      AKind(j) = num;
      AKSum(j) = SumNumOpert;
    else
      AKSum(j) = AKSum(j) + SumNumOpert;
    end;
  end;

end;


/************************************************************
************************************************************/
macro ReportComPay

  var PrevNumKKM   = "???";
  var PrevNumOpert = -1;
  var SumNumOpert  = $0.0;
  var SumSum       = $0.0;
  var stat;
  var i;

  /* Цикл по документам */
  KeyNum(pay_doc,7);
  ReWind(pay_doc);
  pay_doc.IsCur         = NumFlagCur;
  pay_doc.FNCash        = NumFNCash;
  pay_doc.Date_Document = {curdate};
  pay_doc.KKMFactoryNum = "";
  pay_doc.CodCur        = -1;
  stat = GetGE(pay_doc);
  while (stat)
    if ((pay_doc.IsCur         == NumFlagCur) AND
        (pay_doc.FNCash        == NumFNCash ) AND
        (pay_doc.GroupOpert    == 1         ) AND
        (pay_doc.Date_Document == {curdate} ) AND
        (pay_doc.Mode          != MODE_GZ   ))
      if ( ( pay_doc.Action < 2 )  AND
           ( ( pay_doc.IsSuspended == "" ) or ( pay_doc.IsSuspended == "X" ) ) AND
           ( ( StrFor(GetProgramID()) == "Б"         )  OR
             ( pay_doc.Brigade        == OperBrigade ) ) )
        if (PrevNumKKM != pay_doc.KKMFactoryNum)
          if (PrevNumKKM != "???")
            if ((SumNumOpert != $0.0)  AND  (PrevNumOpert != -1))
              KindComPay(PrevNumOpert,SumNumOpert);
            end;
            if ((PrevNumKKM != "???")  AND  (SumSum != $0.0))
              /* Печать отчета */
              KeyNum(cp_type,0);
              ReWind(cp_type);
              cp_type.Id = 0;
              stat = GetGE(cp_type);
              while (stat)
                PrintRepString();
                stat = Next(cp_type);
              end;

              cp_type.Id = -1;
              cp_type.Name = "Регистр не определен";
              PrintRepString();

              BottomComPayReport(SumSum);

              FlagBegin = TRUE;

              /* Очистка массивов */
              i = 0;
              while (i < Asize(AKind))
                AKind(i) = 0;
                AKSum(i) = $0.0;
                i = i + 1;
              end;

            end;

            PrevNumOpert = -1;
            SumNumOpert  = $0.0;
            SumSum       = $0.0;
          end;

          PrevNumKKM = pay_doc.KKMFactoryNum;
          HeadComPayReport( PrevNumKKM );

        end;
        if (PrevNumOpert != pay_doc.NumOpert)
          if (PrevNumOpert != -1)
            KindComPay(PrevNumOpert,SumNumOpert);
          end;
          PrevNumOpert = pay_doc.NumOpert;
          SumNumOpert = $0.0;
        end;
        SumNumOpert = SumNumOpert + pay_doc.InSum;
        SumSum      = SumSum + pay_doc.InSum;
      end;
      stat = Next(pay_doc);
    else
      stat = FALSE;
    end;
  end;

  if (SumNumOpert != $0.0)
    if (PrevNumOpert != -1)
      KindComPay(PrevNumOpert,SumNumOpert);
    end;
  end;

  /* Печать отчета */
  KeyNum(cp_type,0);
  ReWind(cp_type);
  cp_type.Id = 0;
  stat = GetGE(cp_type);
  while (stat)
    PrintRepString();
    stat = Next(cp_type);
  end;

  cp_type.Id = -1;
  cp_type.Name = "Регистр не определен";
  PrintRepString();

  if ( SumSum == $0.0 )
    println( "\n За ", {curdate}:m, " коммунальных платежей не выполнялось." );
    println( " Дневник операций по коммунальным платежам пустой." );
  else
    BottomComPayReport(SumSum);
  end;

end;


/************************************************************
************************************************************/
macro HeadReport_ComPay

  var str;

  str = "          Список коммунальных платежей за " + String({curdate});
  [ #](str);
  [ ];
  str = "┌─────────────────────┬──────────┬──────────────────────┬────────────┐";
  [ #](str);
  str = "│ Название получателя │   Дата   │      Общая сумма     │Операционист│";
  [ #](str);
  str = "├─────────────────────┼──────────┼──────────────────────┼────────────┤";
  [ #](str);

end;


/************************************************************
************************************************************/
macro StringReport_ComPay

  var str;
  var StrTmp;
  var i,j;

  str = "│";
  /* Название получателя */
  StrTmp = SubStr(PmntProp.Name,1,21);
  while (StrLen(StrTmp) < 21)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Дата */
  str = str + String(pay_doc.Date_Document) + "│";
  /* Общая сумма */
  str = str + String(pay_doc.InSum:18:2:a) + " ";
  if (FindCurrency(pay_doc.CodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 3)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Операционист */
  StrTmp = "  " + String(pay_doc.Oper:4);
  while (StrLen(StrTmp) < 12)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";

  [ #](str);

  /* Подсчет сумм */
  i = 0;
  j = -1;
  if (Asize(ACur) == 0)
    ACur(0) = pay_doc.CodCur;
    ASum(0) = pay_doc.InSum;
  else
    while (i < Asize(ACur))
      if (pay_doc.CodCur == ACur(i))
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(ACur);
      ACur(j) = pay_doc.CodCur;
      ASum(j) = pay_doc.InSum;
    else
      ASum(j) = ASum(j) + pay_doc.InSum;
    end;
  end;

end;


/************************************************************
************************************************************/
macro BottomReport_ComPay

  var str;
  var i;
  var flag = TRUE;

  str = "└─────────────────────┴──────────┴──────────────────────┴────────────┘";
  [ #](str);
  if (Asize(ACur) > 0)
    [ ];
    i = 0;
    while (i < Asize(ACur))
      if (flag)
        str = " Итого: ";
        flag = FALSE;
      else
        str = "        ";
      end;
      if (FindCurrency(ACur(i)))
        str = str + currency.Short_Name;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str + String(ASum(i):22:2:a);
      [ #](str);
      i = i + 1;
    end;
  end;
  [ ];
  [ ];

end;


/************************************************************
************************************************************/
macro HeadReport_NalPer

  var str;

  str = "          Список наличных перечислений за " + String({curdate});
  [ #](str);
  [ ];
  str = "┌───────────────────────────────┬──────────────┬─────────────────┬──────┬─────────────────────────┐";
  [ #](str);
  str = "│              Вид              │    Подвид    │      Сумма      │Валюта│       Получатель        │";
  [ #](str);
  str = "├───────────────────────────────┼──────────────┼─────────────────┼──────┼─────────────────────────┤";
  [ #](str);

end;


/************************************************************
************************************************************/
macro StringReport_NalPer

  var str;
  var StrTmp;
  var i,j;

  str = "│";
  /* Вид платежа */
  if (Find_PayKind())
    StrTmp = pay_kind.SzNameAlg;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 31)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Подвид платежа */
  if (Find_PayCsOp())
    StrTmp = pay_csop.NameCompType;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 14)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Сумма */
  str = str + String(pay_doc.InSum:17:2:a) + "│";
  /* Валюта */
  if (FindCurrency(pay_doc.CodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = String(pay_doc.CodCur);
  end;
  StrTmp = " " + StrTmp;
  while (StrLen(StrTmp) < 6)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Корреспондент */
  StrTmp = Acc_Form(PmntProp.Account);
  while (StrLen(StrTmp) < 25)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";

  [ #](str);

  /* Подсчет сумм */
  i = 0;
  j = -1;
  if (Asize(ACur) == 0)
    ACur(0) = pay_doc.CodCur;
    ASum(0) = pay_doc.InSum;
  else
    while (i < Asize(ACur))
      if (pay_doc.CodCur == ACur(i))
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(ACur);
      ACur(j) = pay_doc.CodCur;
      ASum(j) = pay_doc.InSum;
    else
      ASum(j) = ASum(j) + pay_doc.InSum;
    end;
  end;

end;


/************************************************************
************************************************************/
macro BottomReport_NalPer

  var str;
  var i;
  var flag = TRUE;

  str = "└───────────────────────────────┴──────────────┴─────────────────┴──────┴─────────────────────────┘";
  [ #](str);
  if (Asize(ACur) > 0)
    [ ];
    i = 0;
    while (i < Asize(ACur))
      if (flag)
        str = " Итого: ";
        flag = FALSE;
      else
        str = "        ";
      end;
      if (FindCurrency(ACur(i)))
        str = str + currency.Short_Name;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str + String(ASum(i):22:2:a);
      [ #](str);
      i = i + 1;
    end;
  end;
  [ ];
  [ ];

end;


/************************************************************
************************************************************/
macro HeadReport_Comm

  var str;

  str = "          Список комиссий за " + String({curdate});
  [ #](str);
  [ ];
  str = "┌───────────────────────────────┬─────────────────┬──────┐";
  [ #](str);
  str = "│              Вид              │      Сумма      │Валюта│";
  [ #](str);
  str = "├───────────────────────────────┼─────────────────┼──────┤";
  [ #](str);

end;


/************************************************************
************************************************************/
macro StringReport_Comm

  var str;
  var StrTmp;
  var i,j;

  str = "│";
  /* Вид платежа */
  if (Find_PayKind())
    StrTmp = pay_kind.SzNameAlg;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 31)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Сумма */
  str = str + String(pay_doc.InSum:17:2:a) + "│";
  /* Валюта */
  if (FindCurrency(pay_doc.CodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = String(pay_doc.CodCur);
  end;
  StrTmp = " " + StrTmp;
  while (StrLen(StrTmp) < 6)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";

  [ #](str);

  /* Подсчет сумм */
  i = 0;
  j = -1;
  if (Asize(ACur) == 0)
    ACur(0) = pay_doc.CodCur;
    ASum(0) = pay_doc.InSum;
  else
    while (i < Asize(ACur))
      if (pay_doc.CodCur == ACur(i))
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(ACur);
      ACur(j) = pay_doc.CodCur;
      ASum(j) = pay_doc.InSum;
    else
      ASum(j) = ASum(j) + pay_doc.InSum;
    end;
  end;

end;


/************************************************************
************************************************************/
macro BottomReport_Comm

  var str;
  var i;
  var flag = TRUE;

  str = "└───────────────────────────────┴─────────────────┴──────┘";
  [ #](str);
  if (Asize(ACur) > 0)
    [ ];
    i = 0;
    while (i < Asize(ACur))
      if (flag)
        str = " Итого: ";
        flag = FALSE;
      else
        str = "        ";
      end;
      if (FindCurrency(ACur(i)))
        str = str + currency.Short_Name;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str + String(ASum(i):22:2:a);
      [ #](str);
      i = i + 1;
    end;
  end;
  [ ];
  [ ];

end;


/************************************************************
************************************************************/
macro HeadReport_Conv

  var str;

  str = "          Список конверсий за " + String({curdate});
  [ #](str);
  [ ];
  str = "┌──────────────────────────┬─────────────┬────────────────┬────────┬───────┐";
  [ #](str);
  str = "│       Фамилия И.О.       │    Сумма    │     Выдано     │  Курс  │Курс ЦБ│";
  [ #](str);
  str = "├──────────────────────────┼─────────────┼────────────────┼────────┼───────┤";
  [ #](str);

end;


/************************************************************
************************************************************/
macro StringReport_Conv

  record pay_doc_cnv ("pay_doc.cnv");
  var str;
  var StrTmp;
  var i,j;

  SetRecordAddr(pay_doc_cnv,pay_doc,0,0,TRUE);

  str = "│";
  /* ФИО */
  StrTmp = pay_doc.ClientLastName;
  if (StrLen(StrTmp) < 23)
    if (StrLen(pay_doc.ClientFirstName) > 0)
      StrTmp = StrTmp + " " + SubStr(pay_doc.ClientFirstName,1,1) + ".";
    end;
  end;
  if (StrLen(StrTmp) < 23)
    if (StrLen(pay_doc.ClientFirstName) == 0)
      StrTmp = StrTmp + " ";
    end;
    if (StrLen(pay_doc.ClientSecondName) > 0)
      StrTmp = StrTmp + SubStr(pay_doc.ClientSecondName,1,1) + ".";
    end;
  end;
  while (StrLen(StrTmp) < 26)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Сумма */
  str = str + String(pay_doc_cnv.KonvertSum:9:2:a) + " ";
  if (FindCurrency(pay_doc_cnv.KonvertCodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 3)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Выдано */
  str = str + String(pay_doc_cnv.VydachSum:12:2:a) + " ";
  if (FindCurrency(pay_doc_cnv.VydachCodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 3)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Курс */
  str = str + String(pay_doc_cnv.Rate:8:2) + "│";
  /* Курс ЦБ */
  str = str + String(pay_doc_cnv.CBRate:7:2) + "│";

  [ #](str);

  /* Подсчет сумм */
  i = 0;
  j = -1;
  if (Asize(ACur) == 0)
    ACur(0) = pay_doc_cnv.VydachCodCur;
    ASum(0) = pay_doc_cnv.VydachSum;
  else
    while (i < Asize(ACur))
      if (pay_doc_cnv.VydachCodCur == ACur(i))
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(ACur);
      ACur(j) = pay_doc_cnv.VydachCodCur;
      ASum(j) = pay_doc_cnv.VydachSum;
    else
      ASum(j) = ASum(j) + pay_doc_cnv.VydachSum;
    end;
  end;

end;


/************************************************************
************************************************************/
macro BottomReport_Conv

  var str;
  var i;
  var flag = TRUE;

  str = "└──────────────────────────┴─────────────┴────────────────┴────────┴───────┘";
  [ #](str);
  if (Asize(ACur) > 0)
    [ ];
    i = 0;
    while (i < Asize(ACur))
      if (flag)
        str = " Итого: ";
        flag = FALSE;
      else
        str = "        ";
      end;
      if (FindCurrency(ACur(i)))
        str = str + currency.Short_Name;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str + String(ASum(i):22:2:a);
      [ #](str);
      i = i + 1;
    end;
  end;
  [ ];
  [ ];

end;


/************************************************************
************************************************************/
macro HeadReport_Payed

  var str;

  str = "          Список выплат за " + String({curdate});
  [ #](str);
  [ ];
  str = "┌───────────────────────────────┬──────────────┬─────────────────┬──────┬─────────────────────────┐";
  [ #](str);
  str = "│              Вид              │    Подвид    │      Сумма      │Валюта│       Плательщик        │";
  [ #](str);
  str = "├───────────────────────────────┼──────────────┼─────────────────┼──────┼─────────────────────────┤";
  [ #](str);

end;


/************************************************************
************************************************************/
macro StringReport_Payed

  var str;
  var StrTmp;
  var i,j;

  str = "│";
  /* Вид платежа */
  if (Find_PayKind())
    StrTmp = pay_kind.SzNameAlg;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 31)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Подвид платежа */
  if (Find_PayCsOp())
    StrTmp = pay_csop.NameCompType;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 14)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Сумма */
  str = str + String(pay_doc.InSum:17:2:a) + "│";
  /* Валюта */
  if (FindCurrency(pay_doc.CodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = String(pay_doc.CodCur);
  end;
  StrTmp = " " + StrTmp;
  while (StrLen(StrTmp) < 6)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Корреспондент */
  StrTmp = Acc_Form(PmntProp.Account);
  while (StrLen(StrTmp) < 25)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";

  [ #](str);

  /* Подсчет сумм */
  i = 0;
  j = -1;
  if (Asize(ACur) == 0)
    ACur(0) = pay_doc.CodCur;
    ASum(0) = pay_doc.InSum;
  else
    while (i < Asize(ACur))
      if (pay_doc.CodCur == ACur(i))
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(ACur);
      ACur(j) = pay_doc.CodCur;
      ASum(j) = pay_doc.InSum;
    else
      ASum(j) = ASum(j) + pay_doc.InSum;
    end;
  end;

end;


/************************************************************
************************************************************/
macro BottomReport_Payed

  var str;
  var i;
  var flag = TRUE;

  str = "└───────────────────────────────┴──────────────┴─────────────────┴──────┴─────────────────────────┘";
  [ #](str);
  if (Asize(ACur) > 0)
    [ ];
    i = 0;
    while (i < Asize(ACur))
      if (flag)
        str = " Итого: ";
        flag = FALSE;
      else
        str = "        ";
      end;
      if (FindCurrency(ACur(i)))
        str = str + currency.Short_Name;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str + String(ASum(i):22:2:a);
      [ #](str);
      i = i + 1;
    end;
  end;
  [ ];
  [ ];

end;


/************************************************************
************************************************************/
macro HeadReport_BankPayed

  var str;

  str = "          Список банковских перечислений за " + String({curdate});
  [ #](str);
  [ ];
  str = "┌───────────────────────────────┬──────────────┬─────────────────┬──────┬─────────────────────────┐";
  [ #](str);
  str = "│              Вид              │    Подвид    │      Сумма      │Валюта│       Получатель        │";
  [ #](str);
  str = "├───────────────────────────────┼──────────────┼─────────────────┼──────┼─────────────────────────┤";
  [ #](str);

end;


/************************************************************
************************************************************/
macro StringReport_BankPayed

  var str;
  var StrTmp;
  var i,j;

  str = "│";
  /* Вид платежа */
  if (Find_PayKind())
    StrTmp = pay_kind.SzNameAlg;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 31)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Подвид платежа */
  if (Find_PayCsOp())
    StrTmp = pay_csop.NameCompType;
  else
    StrTmp = "";
  end;
  while (StrLen(StrTmp) < 14)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Сумма */
  str = str + String(pay_doc.InSum:17:2:a) + "│";
  /* Валюта */
  if (FindCurrency(pay_doc.CodCur))
    StrTmp = currency.Short_Name;
  else
    StrTmp = String(pay_doc.CodCur);
  end;
  StrTmp = " " + StrTmp;
  while (StrLen(StrTmp) < 6)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";
  /* Корреспондент */
  StrTmp = Acc_Form(PmntProp.Account);
  while (StrLen(StrTmp) < 25)
    StrTmp = StrTmp + " ";
  end;
  str = str + StrTmp + "│";

  [ #](str);

  /* Подсчет сумм */
  i = 0;
  j = -1;
  if (Asize(ACur) == 0)
    ACur(0) = pay_doc.CodCur;
    ASum(0) = pay_doc.InSum;
  else
    while (i < Asize(ACur))
      if (pay_doc.CodCur == ACur(i))
        j = i;
      end;
      i = i + 1;
    end;
    if (j == -1)
      j = Asize(ACur);
      ACur(j) = pay_doc.CodCur;
      ASum(j) = pay_doc.InSum;
    else
      ASum(j) = ASum(j) + pay_doc.InSum;
    end;
  end;

end;


/************************************************************
************************************************************/
macro BottomReport_BankPayed

  var str;
  var i;
  var flag = TRUE;

  str = "└───────────────────────────────┴──────────────┴─────────────────┴──────┴─────────────────────────┘";
  [ #](str);
  if (Asize(ACur) > 0)
    [ ];
    i = 0;
    while (i < Asize(ACur))
      if (flag)
        str = " Итого: ";
        flag = FALSE;
      else
        str = "        ";
      end;
      if (FindCurrency(ACur(i)))
        str = str + currency.Short_Name;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str + String(ASum(i):22:2:a);
      [ #](str);
      i = i + 1;
    end;
  end;
  [ ];
  [ ];

end;



/************************************************************
************************************************************/
macro Report_Doc (GroupOpert)

  var stat;
  var typePerson = DefTypePerson();

  Asize(ACur,0);
  Asize(ASum,0);

  /* Шапка отчета */
  if (GroupOpert == 1)
    HeadReport_ComPay();
  elif (GroupOpert == 11)
    HeadReport_NalPer();
  elif (GroupOpert == 21)
    HeadReport_Comm();
  elif (GroupOpert == 31)
    HeadReport_Conv();
  elif (GroupOpert == 41)
    HeadReport_Payed();
  elif (GroupOpert == 51)
    HeadReport_BankPayed();
  end;

  /* Цикл по документам */
  KeyNum(pay_doc,1);
  ReWind(pay_doc);
  pay_doc.IsCur         = NumFlagCur;
  pay_doc.FNCash        = NumFNCash;
  pay_doc.GroupOpert    = GroupOpert;
  pay_doc.Date_Document = {curdate};
  pay_doc.NumOpert      = 0;
  pay_doc.CodCur        = -1;
  stat = GetGE(pay_doc);
  while (stat)
    if ((pay_doc.IsCur         == NumFlagCur) AND
        (pay_doc.FNCash        == NumFNCash ) AND
        (pay_doc.GroupOpert    == GroupOpert) AND
        (pay_doc.Date_Document == {curdate} ) AND
        (pay_doc.Mode          != MODE_GZ   )    )
      if ((StrFor(GetProgramID()) == "Б"        ) OR
          (pay_doc.Brigade        == OperBrigade) OR 
          (typePerson == "Р"))
        if ( ( pay_doc.Action < 2 ) and
             ( ( pay_doc.IsSuspended == "" ) or ( pay_doc.IsSuspended == "X" ) ) )
          PmntProp.DocApplicationKind = pay_doc.iApplicationKind;
		  PmntProp.DocApplicationKey  = pay_doc.ApplicationKey;
          if (not GetGE(PmntProp) )
			   PmntProp.clear();
	      end;
          /* Строка отчета */
          if (GroupOpert == 1)
            StringReport_ComPay();
          elif (GroupOpert == 11)
            StringReport_NalPer();
          elif (GroupOpert == 21)
            StringReport_Comm();
          elif (GroupOpert == 31)
            StringReport_Conv();
          elif (GroupOpert == 41)
            StringReport_Payed();
          elif (GroupOpert == 51)
            StringReport_BankPayed();
          end;
        end;
      end;
      stat = Next(pay_doc);
    else
      stat = FALSE;
    end;
  end;

  /* Окончание отчета */
  if (GroupOpert == 1)
    BottomReport_ComPay();
  elif (GroupOpert == 11)
    BottomReport_NalPer();
  elif (GroupOpert == 21)
    BottomReport_Comm();
  elif (GroupOpert == 31)
    BottomReport_Conv();
  elif (GroupOpert == 41)
    BottomReport_Payed();
  elif (GroupOpert == 41)
    BottomReport_BankPayed();
  end;

end;


/************************************************************
************************************************************/
macro ReportCashOper (GroupOpert)

  /* Отчет по коммунальным платежам */
  if ((GroupOpert == 0) OR (GroupOpert == 1))
    ReportComPay();
  end;
  /* Отчет по наличным перечислениям */
  if ((GroupOpert == 0) OR (GroupOpert == 11))
    Report_Doc(11);
  end;
  /* Отчет по комиссии */
  if ((GroupOpert == 0) OR (GroupOpert == 21))
    Report_Doc(21);
  end;
  /* Отчет по конверсии */
  if ((GroupOpert == 0) OR (GroupOpert == 31))
    Report_Doc(31);
  end;
  /* Отчет по выплатам */
  if ((GroupOpert == 0) OR (GroupOpert == 41))
    Report_Doc(41);
  end;
  /* Отчет по банковским расчетам */
  if ((GroupOpert == 0) OR (GroupOpert == 51))
    Report_Doc(51);
  end;

end;
