/*
  ---------------------
  R-Style Software Lab.
  ---------------------
  RS-Retail
  ---------------------
  Макрос проверок для компенсаци 2004 года
  ---------------------
  Проверки при зачислениях компенсаций

*/

import deprintr, RSD;

 const
   AT04 =  4,  /* Инвалиды 1 группы */
   AT09 =  9,  /* Наследникам 1 очереди инвалидов 1 группы */
   AT25 = 25,  /* Родитель детей-инвалидов */
   AT63 = 63,  /* Владельцам детских целевых */
   AT67 = 67,  /* Родителям погибших воинов */
   AT73 = 73,
   AT74 = 74,
   AT75 = 75,
   AT76 = 76,
   AT77 = 77,
   AT78 = 78,
   AT79 = 79,
   AT80 = 80,
   AT81 = 81,
   AT82 = 82,
   AT83 = 83,
   AT84 = 84;

var ClientList = TClientList;
var Client;
var cmd, rs;

macro CheckCompensTypeCommon ( compens )

  var DestCodeClient = compens.rec.DestClientCode,
      CodeClient = compens.rec.CodClient,
      CompensType = compens.rec.Kind,
      ClientType = compens.rec.Appltype;


  var dDay, dMon, dYear; /* День, месяц, год смерти клиента */
  var bDay, bMon, bYear;  /* День, месяц, год рождения клиента */
  var burn_nasled, NaslDay, NaslMon, NaslYear; // дата рождения наследника пришедшего получить компенсацию с умершего вкладчика и не закрытого счета =))
  var retVal = 0;

  if (CodeClient == 0)
     msgbox("Не задан владелец компенсируемого счета");
     exit(1);
  end;

  cmd = RsdCommand("select count(*) from ddepositr_dbt where t_account = ? ");
  cmd.addParam("T_ACCOUNT", RsdBp_in);
  cmd.value("T_ACCOUNT") = compens.rec.Account;
  cmd.execute;
  rs = RsdRecordset(cmd); 
  if ( rs.moveNext() )
     if (rs.value(0) == 0)
         DateSplit( compens.rec.AccClsDate, dDay, dMon, dYear );
         if ( (dDay == 1) and (dMon == 1) and (dYear == 1) )
            msgbox("Не задана дата закрытия несуществуещего в базе счета");
            exit(1); 
         else
            if ( NOT(GetTrue( true, "Компенсируемого счета нет в базе данных. Выполнить зачисление компенсации?"  )) )
                exit(1);
            end; 
         end;
     end;
  end;
  
  if (ClientList.GetRecord( DestCodeClient ) )

    Client = ClientList.CurRec;
    DateSplit( Client.rec.Born, bDay, bMon, bYear );
    DateSplit( Client.rec.DateDeath, dDay, dMon, dYear );

    if (  ( ClientType == AT73 )  OR  
          ( ClientType == AT74 )  OR  
          ( ClientType == AT75 )      )
 // 1. НЕ было ли раньше выплат компенсации данной категории
          cmd = RsdCommand("select count(*) from dcompens_dbt where T_ACCOUNT = ? and T_KIND = ? and T_APPLTYPE = ? and t_date <> '01.01.0001' ");
          cmd.addParam("T_ACCOUNT", RsdBp_in);
          cmd.value("T_ACCOUNT") = compens.rec.Account;
          cmd.addParam("T_KIND", RsdBp_in);
          cmd.value("T_KIND") = compens.rec.Kind;
          cmd.addParam("T_APPLTYPE", RsdBp_in);
          cmd.value("T_APPLTYPE") = compens.rec.ApplType;
          cmd.execute;
         
          rs = RsdRecordset(cmd); 
          rs.moveNext();
          if (rs.value(0) != 0)
             retVal = 1;
             msgbox("Компенсация по этому счету была выполнена");
             return 1;
          end;  
// 2. Проверка года рождения по DestCodClient
          if ( ClientType == AT73 )  /* вкладчик до 1934 г.р. включительно */
            if ( (bYear > 1934) or (bYear == 0) )
               retVal = 1;
               msgbox("Г.р. вкладчик не соответствует виду компенсации");
            end;
          elif ( ClientType == AT74 )  /* вкладчик 1935 - 1947 г.р. включительно */
            if ( (bYear < 1935) OR (bYear >1947) )
               retVal = 1;
               msgbox("Г.р. вкладчик не соответствует виду компенсации");
            end;
          elif ( ClientType == AT75 )  /* вкладчик - инвалид 2 группы до 1955 г.р. включительно */
               if ( GetTrue( true, "Вкладчик является инвалидом 2 группы"  ) )
                 if ( ( bYear > 1955 ) or (bYear == 0) )
                    retVal = 1;
                    msgbox("Г.р. вкладчик не соответствует виду компенсации");
                 end;
               else
                    retVal = 1;
                    msgbox("Вкладчик не относится к выбранной категории");
               end;  
          end;


    end;
  end;
    if (  ( ClientType == AT77 )  OR  
          ( ClientType == AT78 )  OR  
          ( ClientType == AT09 )  OR  
          ( ClientType == AT79 )  OR  
          ( ClientType == AT81 )  OR  
          ( ClientType == AT82 )  OR  
          ( ClientType == AT83 )  )

//Счет вкладчика открыт - компенсация зачисляется на счет умершего вкладчика          
          if ( compens.rec.AccClsDate == Date(0,0,0) )
             if ( compens.rec.Account != compens.rec.DestAccount )
                retVal = 1;
                msgbox("Вкладчик не относится к выбранной категории");                 
                return 1;
             end;
//Счет вкладчика закрыт - компенсация зачисляется на счет наследника
          elif ( compens.rec.AccClsDate != Date(0,0,0) )
             if ( compens.rec.Account == compens.rec.DestAccount )
                retVal = 1;
                msgbox("Вкладчик не относится к выбранной категории");
                return 1;                
             end;
          end;
//Проверка на выплату компенсации ранее
          cmd = RsdCommand("select count(*) from dcompens_dbt where T_ACCOUNT = ? and T_KIND = ? and T_APPLTYPE = ? and t_date <> '01.01.0001' ");
          cmd.addParam("T_ACCOUNT", RsdBp_in);
          cmd.value("T_ACCOUNT") = compens.rec.Account;
          cmd.addParam("T_KIND", RsdBp_in);
          cmd.value("T_KIND") = compens.rec.Kind;
          cmd.addParam("T_APPLTYPE", RsdBp_in);
          cmd.value("T_APPLTYPE") = compens.rec.ApplType;
          cmd.execute;
          rs = RsdRecordset(cmd); 
          rs.moveNext();
          if (rs.value(0) != 0)
             if ( (compens.rec.LegacyPart_m != 0) AND (compens.rec.LegacyPart_n != 0) )
                if (compens.rec.Sum == compens.rec.FullSum)
                    retVal = 1;
                    msgbox("Вкладчик не относится к выбранной категории");                 
                    return 1;
                end;  
             else
                retVal = 1;
                msgbox("Компенсация по этому счету была выполнена");
                return 1;
             end;
          end;            

          if (retVal == 0)  

           if (ClientList.GetRecord( CodeClient ) )

             Client = ClientList.CurRec;
             DateSplit( Client.rec.Born, bDay, bMon, bYear );
             DateSplit( Client.rec.DateDeath, dDay, dMon, dYear );
// ---  
             if ( (compens.rec.CodClient != 0) AND (Client.rec.DateDeath == Date(0,0,0))  )
                GetDate( ClientList.CurRec.rec.DateDeath, "Укажите дату смерти вкладчика" );
                if ( ClientList.CurRec.rec.DateDeath == Date(0,0,0) )
                   MsgBox( "Дата смерти вкладчика не установлена" );
                   return 2;
                else
                   ClientList.Update;
                end;
             end;
          // Проверка в случае если вкладчик УМЕР, а счет - открыт и пришел наследник (77, 78, 79) ->  
             if (  ( ClientType == AT77 )  OR  
                   ( ClientType == AT78 )  OR  
                   ( ClientType == AT79 )  )
                   
                   if ( (compens.rec.DestClientCode == compens.rec.CodClient) AND ( compens.rec.AccClsDate == Date(0,0,0) ) )
                      getDate( burn_nasled, "Введите дату рождения наследника");
                      DateSplit( burn_nasled, NaslDay, NaslMon, NaslYear );

                      if ( ClientType == AT77 )  /* наследник до 1934 г.р. включительно */
                        if ( (NaslYear > 1934) or (NaslYear == 0) )
                           retVal = 1;
                           msgbox("Г.р. наследника не соответствует виду компенсации");
                           return 1;
                        end;
                      elif ( ClientType == AT78 )  /* наследник 1935 - 1947 г.р. включительно */
                        if ( (NaslYear < 1935) OR (NaslYear > 1947) )
                           retVal = 1;
                           msgbox("Г.р. наследника не соответствует виду компенсации");
                           return 1;
                        end;
                      elif ( ClientType == AT79 )  /* наследник - инвалид 2 группы до 1955 г.р. включительно */
                           if ( GetTrue( true, "Наследник является инвалидом 2 группы"  ) )
                             if ( (NaslYear > 1955) or (NaslYear == 0) )
                                retVal = 1;
                                msgbox("Г.р. наследника не соответствует виду компенсации");
                                return 1;
                             end;
                           else
                                retVal = 1;
                                msgbox("Вкладчик не относится к выбранной категории");
                                return 1;
                           end;  
                      end;
                   end;
             end;


// Дата смерти для 81, 82, 83 обязательна
             if (  ( ClientType == AT81 )  OR  
                   ( ClientType == AT82 )  OR  
                   ( ClientType == AT83 )  )
                   if ( ClientList.CurRec.rec.DateDeath == Date(0,0,0) )
                      GetDate( ClientList.CurRec.rec.DateDeath, "Укажите дату смерти вкладчика" );
                      if ( ClientList.CurRec.rec.DateDeath == Date(0,0,0) )
                         MsgBox( "Дата смерти вкладчика не установлена" );
                         return 2;
                      else
                         ClientList.Update;
                      end;
                   end;

                  if ( ClientType == AT83 )  
                     if ( (dYear < 2001) OR (dYear > 2004) )
                        retVal = 1;
                        msgbox("Вкладчик не относится к выбранной категории");
                        return 1;
                     end;
                   elif ( ClientType == AT82 )  
                     if ( (dYear < 1998) OR (dYear > 2000) )
                        retVal = 1;
                        msgbox("Вкладчик не относится к выбранной категории");
                        return 1;
                     end;
                   elif ( ClientType == AT81 ) 
                        if ( GetTrue( true, "Вкладчик является Участником ВОВ?"  ) )
                          if ( (dYear < 1998) OR (dYear > 2000)  )
                             retVal = 1;
                             msgbox("Вкладчик не относится к выбранной категории");
                             return 1;
                          end;
                        else
                              retVal = 1;
                              msgbox("Вкладчик не относится к выбранной категории");
                              return 1;
                         end;  
                   end;
             end;
           end;
           if (ClientList.GetRecord( DestCodeClient ) )

             Client = ClientList.CurRec;
             DateSplit( Client.rec.Born, bDay, bMon, bYear );
             DateSplit( Client.rec.DateDeath, dDay, dMon, dYear );
// Проверка года рождения
             if (  ( ClientType == AT77 )  OR  
                   ( ClientType == AT78 )  OR  
                   ( ClientType == AT79 )  )
                   if (compens.rec.DestClientCode != compens.rec.CodClient)

                      if ( ClientType == AT77 )  /* наследник до 1934 г.р. включительно */
                        if ( (bYear > 1934) or (bYear == 0) )
                           retVal = 1;
                           msgbox("Г.р. наследника не соответствует виду компенсации");
                           return 1;
                        end;
                      elif ( ClientType == AT78 )  /* наследник 1935 - 1947 г.р. включительно */
                        if ( (bYear < 1935) OR (bYear > 1947) )
                           retVal = 1;
                           msgbox("Г.р. наследника не соответствует виду компенсации");
                           return 1;
                        end;
                      elif ( ClientType == AT79 )  /* наследник - инвалид 2 группы до 1955 г.р. включительно */
                           if ( GetTrue( true, "Наследник является инвалидом 2 группы"  ) )
                             if ( (bYear > 1955) or (bYear == 0) )
                                retVal = 1;
                                msgbox("Г.р. наследника не соответствует виду компенсации");
                                return 1;
                             end;
                           else
                                retVal = 1;
                                msgbox("Вкладчик не относится к выбранной категории");
                                return 1;
                           end;  
                      end;

                   end;
             end;

             if ( ClientType == AT09 )  
                if ( GetTrue( true, "Наследник является инвалидом 1 группы"  ) == false )
                      retVal = 1;
                      msgbox("Вкладчик не относится к выбранной категории");
                      return 1;
                end;  
             end;
           end;
          end;
    end;
//
  if (ClientList.GetRecord( CodeClient ) )

    Client = ClientList.CurRec;
    DateSplit( Client.rec.Born, bDay, bMon, bYear );
    DateSplit( Client.rec.DateDeath, dDay, dMon, dYear );
                     
    if ( ClientType == AT04 )

       if ( GetTrue( true, "Наследник является инвалидом 1 группы"  ) == false )
          retVal = 1;
          msgbox("Вкладчик не относится к выбранной категории");
          return 1;
       end;

        cmd = RsdCommand("select count(*) from dcompens_dbt where T_ACCOUNT = ? and T_KIND = ? and T_APPLTYPE = ? and t_date <> '01.01.0001' ");
        cmd.addParam("T_ACCOUNT", RsdBp_in);
        cmd.value("T_ACCOUNT") = compens.rec.Account;
        cmd.addParam("T_KIND", RsdBp_in);
        cmd.value("T_KIND") = compens.rec.Kind;
        cmd.addParam("T_APPLTYPE", RsdBp_in);
        cmd.value("T_APPLTYPE") = compens.rec.ApplType;
        cmd.execute;
       
        rs = RsdRecordset(cmd); 
        rs.moveNext();
        if (rs.value(0) != 0)
            retVal = 1;
            msgbox("Компенсация по этому счету была выполнена");
            return 1;
        end;  
    end;
    if (  ( ClientType == AT63 )  OR
          ( ClientType == AT80 )  ) 
          if ( ClientList.CurRec.Rec.NotResident != StrFor( 0 ) ) /* Нерезидент */
              retVal = 1;
              msgbox("Компенсация этой категории выдается только резидентам");
              return 1;
          end;
          cmd = RsdCommand("select count(*) from dcompens_dbt where T_ACCOUNT = ? and T_KIND = ? and T_APPLTYPE = ? and t_date <> '01.01.0001' ");
          cmd.addParam("T_ACCOUNT", RsdBp_in);
          cmd.value("T_ACCOUNT") = compens.rec.Account;
          cmd.addParam("T_KIND", RsdBp_in);
          cmd.value("T_KIND") = compens.rec.Kind;
          cmd.addParam("T_APPLTYPE", RsdBp_in);
          cmd.value("T_APPLTYPE") = compens.rec.ApplType;
          cmd.execute;
         
          rs = RsdRecordset(cmd); 
          rs.moveNext();
          if (rs.value(0) != 0)
              retVal = 1;
              msgbox("Компенсация по этому счету была выполнена");
              return 1;
          end;  
    end;
  end;
 return retVal;

end;


MACRO CheckCompensationType (compens)

  var retVal=CheckCompensTypeCommon (compens);

  return retVal;

end;
