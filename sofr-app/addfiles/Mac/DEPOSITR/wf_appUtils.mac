/*
$Name: 	wf_appUtils.mac
$Module:       …Ž
$Description:  “â¨«¨âë ¤«ï BPMN-¯à¨«®¦¥­¨© ­  RSL
*/

import commonInter, wf_commonUtils;


private var inited = false;


private macro getRegValue(key: string)
  var prm;
  GetRegistryValue(key, 0, prm);
  return prm;
end;


private var textDir = getRegValue("BANK_INI\\Ž™ˆ… €€Œ…’›\\„ˆ…Š’Žˆˆ\\TEXTDIR");
private var cNum = getCNum;



class (DefaultSubsystem) RsRetailSubsystem

  macro commonInit
    if ((inited == null) or (not inited))
      if (not openDepFiles)
        runError(logError("Îøèáêà ïðè îòêðûòèè âèðòóàëüíûõ òàáëèö"));
      end;
      inited = true;
    end;
  end;

  macro commonDone
    interDesk_endDocBunch;
    if (inited)
      closeDepFiles;
      inited = false;
    end;
  end;

  macro getTopErrorMessage(): string
    var msg = "";
    topErrorMessage(msg);
    return msg;
  end;

end;


/*************************************************
 *  UI sessions
 ************************************************/

private macro newSessionId
  return formApplicationKey(0);
end;

macro uiCreateSession(formName : String, inParams : TParameters) : TParameters
  var sessionId = newSessionId;
  uiFormManager.setInfo(sessionId, formName, inParams);
  return singleResult("uiSessionId", sessionId);
end;


/*************************************************
 *  Document bunches
 ************************************************/

macro makeDocBunchCurrent(params : TParameters)
  var appKind = params.get("applicationKind");
  if ((appKind == null) or (appKind == 0));
    interDesk_endDocBunch;
  else
    var ok = interDesk_makeDocBunchCurrent(appKind, params.get("applicationKey"), false);
    if (not ok)
      runError(logError("Îøèáêà ïðè óñòàíîâêå òåêóùåé ñâÿçêè äîêóìåíòîâ"));
    end;
  end; 
end;

macro setBunchAppKindKey(params : TParameters)
  var appKind, appKey;
  interDesk_getBunchApplic(appKind, appKey);
  params.set("applicationKind", appKind); 
  params.set("applicationKey", appKey); 
end;

/*************************************************
 *  Utility functions
 ************************************************/


private macro readFile(name : String) : String
  file f() txt;
  var retVal = "";

  if (open(f, name))
    while (next(f))
      retVal = retVal + f.str + NEW_LINE;
    end;
    close(f); 
  end;
  return retVal; 
end;

private macro toBeExcluded(fileName : String)
  var fnLower = strLwr(fileName);
  return index(fnLower, "wf_rsl") == 1;
end;

private macro makeReportText(prefix : String) : String
  const PROCESSED_PREFIX = "_processed_";
  const PROCESSED_PREFIX_LEN = strLen(PROCESSED_PREFIX);

  private macro renameProcessedFile(name : String)
    var oldPathName = textDir + "\\" + name;
    var newPathName = textDir + "\\" + PROCESSED_PREFIX + name;

    removeFile(newPathName);
    renameFile(oldPathName, newPathName);
  end;

  var files = TDirList(textDir + "\\__" + prefix + "*." + string(cNum), "F");
  var retVal = null;
  var i;

  if (files.count > 0)
    for (i, 0, files.count - 1)
      if ((subStr(files.name(i), 1, PROCESSED_PREFIX_LEN) != PROCESSED_PREFIX) and 
          (not toBeExcluded(files.name(i))) and 
          (files.size(i) > 0))
        if (retVal != null) 
          retVal = retVal + NEW_LINE + NEW_LINE;
        else
          retVal = ""; 
        end;
        retVal = retVal + readFile(files.name(i));
        renameProcessedFile(files.name(i));
      end;
    end;
  end; 

  if (retVal == null)
    retVal = "";
  end;

  return retVal;
end;

macro issueReports_CreateData
(       
    AppKind: integer,
    AppKey: String
)
  var prefix = formApplicationKey(0);
  var oldPrefix = rtSetOutputPrefix(prefix);
  var oldUnique = rtSetUniqueOutputFiles(true);
  printReports(AppKind, AppKey);
  rtSetOutputPrefix(oldPrefix);
  rtSetUniqueOutputFiles(oldUnique);
  
  return makeReportText(prefix);
end;



Subsystem = RsRetailSubsystem; 
