/*
$Name:             firstlog.mac
$Module:           RS-Retail
$Description:      Макрос проверки первого вызова из шага по нефинансовой операции
*/

//
//   R-Style SoftLab.
//
//   RS-Retail.
//
//   Макрос проверки первого вызова из шага по нефинансовой операции -
//          для того, чтобы формы шага выпускались один раз
//          Пример вызова см. в макросе pr_trast.mac.
//

import deprintr, alg_vars;

private file sb_casln ( sb_casln ) key 0;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro IsFirstLog()

  var ret_flag       = false;
  var stat;
  var kind_main      = 0;
  var key_main       = "";
  var key_current    = "";
  var numDprt        = String( ALG_NFOPR.numDprt );
  var recID          = String( ALG_NFOPR.recID );

  while ( StrLen( numDprt ) < 5 )
    numDprt = "0" + numDprt;
  end;
  while ( StrLen( recID ) < 10 )
    recID = "0" + recID;
  end;
  key_current = "rtnfopr#" + numDprt + recID + "00";

  KeyNum( sb_casln, 1 );
  sb_casln.ApplicationKind2 = 3001;
  sb_casln.ApplicationKey2  = key_current;
  sb_casln.RefValue2        = 0;

  stat = GetEQ( sb_casln );

  if ( stat )
    ;
  else
    numDprt = String( ALG_NFOPR.numDprt );

    while ( StrLen( numDprt ) < 3 )
      numDprt = "0" + numDprt;
    end;

    key_current = "rtnfopr#" + numDprt + recID + "00";

    KeyNum( sb_casln, 1 );
    sb_casln.ApplicationKind2 = 3001;
    sb_casln.ApplicationKey2  = key_current;
    sb_casln.RefValue2        = 0;

    stat = GetEQ( sb_casln );
  end;

  if ( stat )
    kind_main = sb_casln.ApplicationKind1;
    key_main  = sb_casln.ApplicationKey1;

    KeyNum( sb_casln, 0 );
    sb_casln.ApplicationKind1 = kind_main;
    sb_casln.ApplicationKey1  = key_main;
    sb_casln.NumLinkDoc       = 0;

    stat = GetGE( sb_casln );
    while ( stat )
      if ( ( sb_casln.ApplicationKind1 == kind_main ) and
           ( sb_casln.ApplicationKey1  == key_main  )    )
        if ( sb_casln.ApplicationKind2 == 3001 )
          if ( sb_casln.ApplicationKey2 == key_current )
            ret_flag = true;
          end;
          stat = false;
        else
          stat = Next( sb_casln );
        end;
      else
        stat = false;
      end;
    end;
  end;

  return ret_flag;

end;
