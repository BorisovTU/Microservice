import alg_vars, cur_rate;

  file retOp( "ret_op.dbt" ) key 0 write;
  var summa = $0L;
  var rateKind = 1; /* Основной курс */
  var cbRate=0;
  var codes;
  var appkind, appkey;

  if ( ALG_SBDEPDOC.InSum > 0 )
    summa = ALG_SBDEPDOC.InSum;
  else
    summa = ALG_SBDEPDOC.OutSum;
  end;

  if ( ALG_SBDEPDOC.Code_Currency > 0 )
     if( (not FindCurrRate( ALG_SBDEPDOC.Code_Currency, rateKind, ALG_SBDEPDOC.Date_Document, cbRate, null, null, null )) OR (ValType(cbRate) == V_UNDEF) OR (cbRate <= 0) )
        MsgBox( "Не найден курс для валюты с кодом " + String( ALG_SBDEPDOC.Code_Currency ) + 
                "|за дату " + String( ALG_SBDEPDOC.Date_Document ) + " по виду " + String( RateKind ) );
        ALG_RESULT =  ERR_RES;       
        return;
     end;
    summa = summa * cbRate;
  end;

  if ( summa >= 3000000 )
    SelectFMCodes( codes );

    if ( codes != "")
      if( InterDesk_GetBunchApplic( appkind, appkey ) )
        retOp.ApplicationKind = appkind;
        retOp.ApplicationKey  = appkey;
        if( GetEQ( retOp ) )
            retOp.FMOpCode_Offline = codes;
            Update( retOp );
        end;

        else
        StoreValue( "OP_FM_CODES", codes);
      end;
    end;

  end;

  ALG_RESULT = OK_RES;
  
end;