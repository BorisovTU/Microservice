
/* Перенумерация счетов
   Внимание! Во избежание появления ошибки Btrieve - "файл заблокирован"
   значения параметров настройки Btrieve MaxHandles и MaxLocks должны
   быть как можно больше (e.g.: ""MaxHandles"= dword:000003E8"
                                ""MaxLocks"  = dword:00000064" )
*/

import deprintr;

file DepType("sb_dtyp.dbt") key 2;
file Curr("currency.dbt") key 0;
file Dep("depositr.dbt") key 1 write;
file NewDep("depositr.dbt") key 0 write;
file DepHistory("dephistr.dbt") key 0 write;
var ddep = TRecHandler( "i_dp_dep.rec" );

var
  NAccs = 0,
  Branch = NumFNCash,
  IsCur,
  {curdate},
  Stat = true;

var
  NoLnForCurr,
  NoLnForDType;

macro FindBranch

  if(not findDepartment(Branch, null, ddep))
    MsgBox("Филиал не найден в справочнике");
    Exit(1);
  end;
end;


/*
macro OutHead

  [ ];
  [####################################################################################]
  ("Ведомость по расчету наращенных процентов с " +
    String(StartDate) + " по " + String(EndDate):c);
  [ ];
  [------------------------------------------------------------------------------------];
  [| Вид вклада              |   Сумм. остаток   | Ставка %% | Кол.сч | Наращенные %% |];
  [------------------------------------------------------------------------------------];
end;

macro OutAccLine

  [ ######################### ################### ###########          ############### ]
  (
    Acc_Form(Dep.Account),
    AccRest,
    AccPcRate:0:2:z,
    AccPc
  );
end;

macro OutDepTypeLine

  if(VerboseMode)
    [------------------------------------------------------------------------------------];
  end;
  [ ######################### ################### ########### ######## ############### ]
  (
    DepType.Kind,
    DTRest,
    DTPcRate:0:2:z,
    DTNAccs:z,
    DTPc
  );
end;

macro OutTotals

  [------------------------------------------------------------------------------------];
  [ ######################### ###################             ######## ############### ]
  (
    "И т о г о :",
    TotRest,
    TotNAccs,
    TotPc
  );
end;
*/

macro GetNextNumber(NumGroup, CurCode)

  record SaveNewDep("depositr.dbt");
  var
    NextNum;

  Copy(SaveNewDep, NewDep);
  ClearRecord(NewDep);
  NewDep.FNCash = Branch;
  NewDep.GroupNumb = NumGroup;
  NewDep.Code_Currency = CurCode;
  NewDep.Number = 2000000000;
  if(GetLE(NewDep)
    and (NewDep.FNCash == Branch)
    and (NewDep.GroupNumb == NumGroup)
    and (NewDep.Code_Currency == CurCode))
    NextNum = NewDep.Number + 1;
  else
    NextNum = 1;
  end;
  Copy(NewDep, SaveNewDep);
  return NextNum;
end;

macro T_TreatAcc

  Copy(NewDep, Dep);
  DepHistory.PrevAccount = Dep.Account;
  DepHistory.PrevBranchName = DepHistory.BranchName = ddep.rec.Name;
  DepHistory.PrevBranch = Dep.FNCash;
  DepHistory.PrevNumGroup = Dep.GroupNumb;
  DepHistory.PrevNumber = Dep.Number;
  DepHistory.CurCode = Dep.Code_Currency;
  DepHistory.RenumDate = Dep.RenumDate = NewDep.RenumDate = {curdate};
  if((Dep.Open_Close == StrFor(0))
    and (Dep.Type_Account != "Неподвижный")
    and (Dep.Type_Account != "Объединенный"))
    NewDep.GroupNumb = DepType.NewGroupNumb;
    NewDep.Number = GetNextNumber(NewDep.GroupNumb, NewDep.Code_Currency);
    NewDep.Account = FormAccountNumber(
      NewDep.Code_Currency,
      NewDep.Type_Account,
      NewDep.Number, 0);
  end;
  DepHistory.Account = NewDep.Account;
  if(NewDep.Account == "")
    Stat = false;
  else
    NewDep.RenumDate = {curdate};
    Stat = Insert(NewDep);
    if(Stat)
      GetPos(Dep);
      GetDirect(Dep);
      Dep.RenumDate = NewDep.RenumDate;
      Stat = Update(Dep);
    end;
  end;
  if(Stat)
    Stat = Insert(DepHistory);
  end;
  if(not Stat)
    AbortTrn;
  end;
end;

macro TreatAcc

  var
    Pos;

  ProcessTrn(null, "T_TreatAcc", Dep, NewDep, DepHistory);
end;

macro SeekNDestroy(FNCash, Account)

  var
    RecFound;

  KeyNum(DepHistory,3);
  /* ReWind(DepHistory); */
  DepHistory.PrevBranch = FNCash;
  DepHistory.PrevAccount = Account;
  RecFound = getEQ(DepHistory);
  if(RecFound and (DepHistory.RenumDate == {curdate}))
    Delete(DepHistory,FALSE);
  end;
  KeyNum(DepHistory,0);
end;

macro TreatDepType;

  var
    RecFound;

  NoLnForDType = true;
  /* Сначала открытые счета вида вклада */
  ClearRecord(Dep);
  Dep.IsCur = IsCur;
  Dep.FNCash = Branch;
  Dep.Open_Close = StrFor(0);
  Dep.Type_Account = DepType.Kind;
  Dep.Code_Currency = Curr.Code_Currency;
  RecFound = GetGE(Dep);
  while(Stat and RecFound
    and (Dep.IsCur == IsCur)
    and (Dep.FNCash == Branch)
    and (Dep.Open_Close == StrFor(0))
    and (Dep.Type_Account == DepType.Kind)
    and (Dep.Code_Currency == Curr.Code_Currency))
    if(Dep.RenumDate < {curdate})
      SeekNDestroy(Dep.FNCash, Dep.Account);
/*
      if(NoLnForCurr)
        if(IsCur)
          PrintLn;
          PrintLn(Curr.Name_Currency);
          PrintLn(MkStr("-", StrLen(Curr.Name_Currency)));
        end;
        NoLnForCurr = false;
      end;
      if(NoLnForDType)
        if(VerboseMode)
          PrintLn;
          PrintLn(DepType.Name);
          PrintLn(MkStr("-", StrLen(DepType.Name)));
        end;
        NoLnForDType = false;
      end;
*/
      TreatAcc;
      NAccs = NAccs + 1;
      Message(" Обработано счетов: " + NAccs);
    end;
    RecFound = Next(Dep);
  end;
  /* Потом закрытые счета вида вклада */
  ClearRecord(Dep);
  Dep.IsCur = IsCur;
  Dep.FNCash = Branch;
  Dep.Open_Close = "З";
  Dep.Type_Account = DepType.Kind;
  Dep.Code_Currency = Curr.Code_Currency;
  RecFound = GetGE(Dep);
  while(Stat and RecFound
    and (Dep.IsCur == IsCur)
    and (Dep.FNCash == Branch)
    and (Dep.Open_Close == "З")
    and (Dep.Type_Account == DepType.Kind)
    and (Dep.Code_Currency == Curr.Code_Currency))
    if(Dep.RenumDate < {curdate})
      SeekNDestroy(Dep.FNCash, Dep.Account);
/*
      if(NoLnForCurr)
        if(IsCur)
          PrintLn;
          PrintLn(Curr.Name_Currency);
          PrintLn(MkStr("-", StrLen(Curr.Name_Currency)));
        end;
        NoLnForCurr = false;
      end;
      if(NoLnForDType)
        if(VerboseMode)
          PrintLn;
          PrintLn(DepType.Name);
          PrintLn(MkStr("-", StrLen(DepType.Name)));
        end;
        NoLnForDType = false;
      end;
*/
      TreatAcc;
      NAccs = NAccs + 1;
      Message(" Обработано счетов: " + NAccs);
    end;
    RecFound = Next(Dep);
  end;
/*
  if(Stat and (not NoLnForDType))
    TotRest = TotRest + DTRest;
    TotPc = TotPc + DTPc;
    TotNAccs = TotNAccs + DTNAccs;
    OutDepTypeLine;
  end;
*/
end;

macro TreatCurrency

  var
    RecFound;

/*
  TotRest = $0;
  TotPc = $0;
  TotNAccs = 0;
*/
  NoLnForCurr = true;
  ClearRecord(DepType);
  DepType.FlagCur = IsCur;
  RecFound = GetGE(DepType);
  while(Stat and RecFound and (DepType.FlagCur == IsCur))
    if(DepType.Kind != "Шаблонный")
      TreatDepType;
    end;
    RecFound = Next(DepType);
  end;
/*
  if(Stat and (not NoLnForCurr))
    OutTotals;
  end;
*/
end;

macro CreateOrOpenNewDep

  if(not Open(NewDep, "depositr.new"))
    if(not Clone(NewDep, "depositr.new"))
      Exit(1);
    end;
  end;
end;

macro RenameNewDep

  var
    ComSpec = GetEnv( "COMSPEC" ),
    DbDir = GetIniString("DATABASEDIR");

  Close(Dep);
  Close(NewDep);
  DelFile(DbDir + "depositr.old");
  Stat = not Run(ComSpec, "/C ren " + DbDir + "depositr.dbt depositr.old");
  if(Stat)
    Stat = not Run(ComSpec, "/C ren " + DbDir + "depositr.new depositr.dbt");
  end;
  DelFile(DbDir + "depositr.old");
end;

macro Confirm

  var
    Result = false;

  msgbox("Внимание !!!| Убедитесь, что Вы - единственый пользователь,|работающий в данный момент в системе");
  GetTrue(Result, "Продолжить выполнение ?");
  if(not Result)
    Exit(0);
  end;
end;

  var
    SaveFlagCur,
    RecFound;

  Confirm;
  CreateOrOpenNewDep;
  FindBranch;
/*
  OutHead;
*/
  IsCur = 0;
  SaveFlagCur = SetFlagCur(IsCur);
  Curr.Code_Currency = 0;
  if(GetEQ(Curr))
    TreatCurrency;
  end;
  if(Stat)
    IsCur = 1;
    SetFlagCur(IsCur);
    Curr.Code_Currency = 1;
    RecFound = GetEQ(Curr);
    while(Stat and RecFound)
      TreatCurrency;
      RecFound = Next(Curr);
    end;
  end;
  if(Stat)
    if(NAccs > 0)
      RenameNewDep;
      if(not Stat)
        MsgBox("Ошибка при переименовании файла.|Переименуйте depositr.new -> *.dbt");
      end;
    end;
  else
    MsgBox("Ошибка при перенумерации счетов.|Запустите макрос еще раз");
  end;
  SetFlagCur(SaveFlagCur);
end;
