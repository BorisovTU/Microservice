/*
$Name:               ic_aux.mac
$Module:             DEPOSITR
$Description:        ‡†ß≠Î• ·•‡¢®·Î
*/
/*
*/
import ic_comdata;

/********************************************************************************\
|                          äìêë ÇõèéãçÖçàü éèÖêÄñàà                              |
\********************************************************************************/
macro CalcRate( ExternalData )
  record r_sbdepdoc ("sbdepdoc.dbt");
  var InSum = $0L;
  var SourceAccount,findCur,rs_findCur;
  var RateOper = 0.;
  var RateType = "";
  var RateKind = 0;
  var findByAcc = false;
  var ConvCur = 0;
  var retVal = TCRRes;

  if ( ExternalData.ConvData.RateCalcType == 1 )



     if ( ValType(ExternalData.ConvData.Rate.Kind)==V_INTEGER )
        retVal.Rate.Kind = ExternalData.ConvData.Rate.Kind;
     end; 

     if ( ValType(ExternalData.OperData.Sum.Currency) == V_STRING )
        retVal.SumOut.Currency = ExternalData.OperData.Sum.Currency;
     end;
     if ( ValType(ExternalData.OperData.Sum.Sum) == V_MONEY )
        retVal.SumOut.Sum = ExternalData.OperData.Sum.Sum;
     end;

     if ( ValType(ExternalData.ConvData.Rate.WorkSum.Currency) == V_STRING )
        retVal.Rate.WorkSum.Currency = ExternalData.ConvData.Rate.WorkSum.Currency;
     end;
     if ( ValType(ExternalData.ConvData.Rate.WorkSum.Sum) == V_MONEY )
        retVal.Rate.WorkSum.Sum = ExternalData.ConvData.Rate.WorkSum.Sum;
     end;

     if ( ValType(ExternalData.ConvData.SumIn.Currency) == V_STRING )
        retVal.SumIn.Currency = ExternalData.ConvData.SumIn.Currency;
     end;
     if ( ValType(ExternalData.ConvData.SumIn.Sum) == V_MONEY )
        retVal.SumIn.Sum = ExternalData.ConvData.SumIn.Sum;
     end;

     if ( ValType(ExternalData.ConvData.Rate.BaseSum.Currency) == V_STRING )
        retVal.Rate.BaseSum.Currency = ExternalData.ConvData.Rate.BaseSum.Currency;
     end;
     if ( ValType(ExternalData.ConvData.Rate.BaseSum.Sum) == V_MONEY )
        retVal.Rate.BaseSum.Sum = ExternalData.ConvData.Rate.BaseSum.Sum;
     end;
     return retVal;

  end;

  if ( (ValType(ExternalData.ConvData.Rate.Kind)==V_INTEGER) and
       (ExternalData.ConvData.Rate.Kind>0) )
     RateKind = ExternalData.ConvData.Rate.Kind;
  end; 

  if ( (ValType(ExternalData.ConvData.SumIn.Currency) != V_STRING) or (ExternalData.ConvData.SumIn.Currency == "") )
    RunError( ErrMessage( 16522 ), 16522 );
  end;

  if ( (ValType(ExternalData.OperData.Source.ObjectType) == V_INTEGER) and (ExternalData.OperData.Source.ObjectType > 0) )
    findByAcc = true;
  else
    findByAcc = false;
  end;

  if ( findByAcc )
    var findParam : FindObjParm;
    findParam.Currency = RetRetailNatISO(ExternalData.OperData.Sum.Currency);
    findParam.IsFindMCD = true;
    findParam.FindOKCard = true;
    findParam.FindWithFncash = true;
    var fndstat = findReissueAccount ( SourceAccount, ExternalData.OperData.Source, findParam );
    if (fndstat)
      RunError( ErrMessage( fndstat ), fndstat );
    end;
    setFnCash(SourceAccount.value("T_FNCASH"));
    setFlagCur(SourceAccount.value("T_ISCUR"));
    {curdate} = getCurDate;


    if ( (ValType(ExternalData.OperData.Sum.Currency) == V_STRING) and (ExternalData.OperData.Sum.Currency != "") )
      rs_findCur = FindCurrency(FINDCURBYEXT_CODE, RetRetailNatISO(ExternalData.OperData.Sum.Currency));
    else
      rs_findCur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
    end;

    if ( (ValType(ExternalData.OperData.Sum.Currency) == V_STRING) and (ExternalData.OperData.Sum.Currency != "")
         and (SourceAccount.value("T_CODE_CURRENCY") != rs_findCur.value("T_CODE_CURRENCY")) )
      RunError( ErrMessage( 16542 ), 16542 );
    end;

    r_sbdepdoc.Referenc         = SourceAccount.value("t_referenc");
    r_sbdepdoc.Type_Account     = SourceAccount.value("t_type_account");
    r_sbdepdoc.Code_Currency    = SourceAccount.value("T_CODE_CURRENCY");

  else
    if ( (ValType(ExternalData.OperData.Sum.Currency) != V_STRING) or (ExternalData.OperData.Sum.Currency == "") )
      RunError( ErrMessage( 16504 ), 16504 );
    end;
    rs_findCur = FindCurrency(FINDCURBYEXT_CODE, RetRetailNatISO(ExternalData.OperData.Sum.Currency));
    r_sbdepdoc.Code_Currency = rs_findCur.value("T_CODE_CURRENCY");
  end;
  rs_findCur = FindCurrency(FINDCURBYEXT_CODE, RetRetailNatISO(ExternalData.ConvData.SumIn.Currency));
  ConvCur = rs_findCur.value("T_CODE_CURRENCY");
  r_sbdepdoc.DepDate_Document = {curdate};
  if ( (ValType(ExternalData.OperData.Sum.Sum) == V_MONEY) and (ExternalData.OperData.Sum.Sum > $0L) )
    r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
  else
    r_sbdepdoc.OutSum = $0L;
  end;
  if ( (ValType(ExternalData.ConvData.SumIn.Sum) == V_MONEY) and (ExternalData.ConvData.SumIn.Sum > $0L) )
    r_sbdepdoc.InSum = ExternalData.ConvData.SumIn.Sum;
  else
    r_sbdepdoc.InSum = $0L;
  end;

  var isMCD = false;
  if ((ValType(ExternalData.isMCD) == V_BOOL) and ExternalData.isMCD)
    isMCD = true;
  end;

  OpenDepFiles;
  var stat = GetDepRate(r_sbdepdoc, ConvCur, InSum,RateKind, isMCD, RateOper, RateType);
  if (stat)
    RunError( ErrMessage( stat ), stat );
  end;


  retVal.Rate.Kind = RateKind;

  rs_findCur = FindCurrency(FINDCURBYCODE_CUR, r_sbdepdoc.Code_Currency);
  retVal.SumOut.Currency = RetKernelNatISO(rs_findCur.value("T_EXTERNALCODE"));
  retVal.SumOut.Sum = r_sbdepdoc.OutSum;

  retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_findCur.value("T_EXTERNALCODE"));
  retVal.Rate.WorkSum.Sum = $1;

  rs_findCur = FindCurrency(FINDCURBYCODE_CUR, ConvCur);
  retVal.SumIn.Currency = RetKernelNatISO(rs_findCur.value("T_EXTERNALCODE"));
  retVal.SumIn.Sum = r_sbdepdoc.InSum;

  retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_findCur.value("T_EXTERNALCODE"));
  retVal.Rate.BaseSum.Sum = money(RateOper);
  return retVal;
end;




/********************************************************************************\
|                    éèêÖÑÖãÖçàÖ äéåàëëàà ( èé éèÖêÄñàà )                        |
\********************************************************************************/
macro CalcCommission ( ExternalData )
  record r_sbdepdoc ("sbdepdoc.dbt");
  var commissionSum = $0L;
  var DestAccount, SourceAccount;
  var findAccByProdId = false, findAccByNumber = false;
  var IsMunicipalPayment = false;
  var IsSourceObjTypeAcc = false, IsDestObjTypeAcc = false;
  var retVal : TCCRes;
  var DestType = -1;

  if ( (ValType(ExternalData.DestType) != V_INTEGER) or ((ExternalData.DestType < 0) or (ExternalData.DestType > 4)) )
    if ( (ValType(ExternalData.ServiceType ) == V_STRING) and (ExternalData.ServiceType  != "") )
      DestType = 4;
    elif ( ((ValType(ExternalData.OperData.Destination.ObjectType) == V_INTEGER) and (ExternalData.OperData.Destination.ObjectType > 0))
           and (ValType(ExternalData.OperData.Destination.IDType) == V_INTEGER)
           and (ValType(ExternalData.OperData.Destination.ID) == V_STRING) )
      DestType = 0;
    else
      var IsOurBank = true;
      if ( (ValType(ExternalData.Recipient.BankID) == V_INTEGER) and (ExternalData.Recipient.BankID != {OurBank}) )
        IsOurBank = false;
      elif ( (ValType(ExternalData.Recipient.BankCode) == V_STRING) and (ExternalData.Recipient.BankCode != "") )
        var BankName, CorAccount, Bank_INN, Bank_KPP, BankID;
        if ( (ValType(ExternalData.Recipient.BankCodeKind) != V_INTEGER) or (ExternalData.Recipient.BankCodeKind <= 0) )
          ExternalData.Recipient.BankCodeKind = 3;
        end;
        iFindBank( ExternalData.Recipient.BankCodeKind, ExternalData.Recipient.BankCode, BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
        if ( (ValType(BankID) == V_INTEGER) and (BankID != {OurBank}) )
          IsOurBank = false;
        end;
      end;
      if ( IsOurBank)
        DestType = 1;
      elif ( (not IsOurBank) and (ExternalData.inBudget) )
        DestType = 3;
      elif ( (not IsOurBank) and (not ExternalData.inBudget) )
        DestType = 2;
      end;
    end;
  else
    DestType = ExternalData.DestType;
  end;

  if ( DestType == 4 )
    IsMunicipalPayment = true;
  end;

  if ( DestType == -1 )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( not IsMunicipalPayment )

    var findParam : FindObjParm;
    findParam.Currency = null;
    findParam.IsFindMCD = false;
    findParam.FindOKCard = true;
    findParam.FindWithFncash = true;
    var fndstat = findReissueAccount ( SourceAccount, ExternalData.OperData.Source, findParam );
    if (fndstat)
      RunError( ErrMessage( fndstat ), fndstat );
    end;
    ß†§†§®¨_Ø†‡†¨•‚‡Î_°†≠™† (SourceAccount);
    if ( StrBrk("ä", SourceAccount.value("t_UserTypeAccount")) == 0 )
      IsSourceObjTypeAcc = true;
    end;
    if ( DestType == 0 )
      findParam.Currency = null;
      findParam.IsFindMCD = false;
      findParam.FindOKCard = true;
      findParam.FindWithFncash = false;
      fndstat = findReissueAccount ( DestAccount, ExternalData.OperData.Destination, findParam );
      if (fndstat)
        RunError( ErrMessage( fndstat ), fndstat );
      end;
      if ( StrBrk("ä", DestAccount.value("t_UserTypeAccount")) == 0 )
        IsDestObjTypeAcc = true;
      end;
    end;

    var NumOper = 0, NumSubOper = 0;
    if ( IsSourceObjTypeAcc )
      if ( DestType == 3 )
        NumOper = 63;
      elif ( DestType == 2 )
        NumOper = 63;
      elif ( DestType == 0 )
        if ( IsDestObjTypeAcc )
          var findKernelAcc = isfindKernelAcc( SourceAccount.value("T_ACCOUNT"), SourceAccount.value("T_FNCASH") );
          if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
             NumOper = 80;
             NumSubOper = 11;
          else
            if ( findKernelAcc )
              NumOper = 63;
              NumSubOper = 0;
            else
              NumOper = 65;
              NumSubOper = 0;
            end;
          end;
        else
          if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
             NumOper = 80;
             NumSubOper = 11;
          else
             NumOper = 63;
             NumSubOper = 0;
          end;
        end;
      elif ( DestType == 4 )
        NumOper = 64;
        NumSubOper = 49;
      elif ( DestType == 1 )
        NumOper = 63;
        NumSubOper = 0;
      end;
    else
      if ( DestType == 0 )
        if ( IsDestObjTypeAcc )
          if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
             NumOper = 80;
             NumSubOper = 11;
          elif ( DestAccount.value("T_CODCLIENT") != SourceAccount.value("T_CODCLIENT") )
             NumOper = 71;
             NumSubOper = 0;
          elif ( DestAccount.value("T_CODCLIENT") == SourceAccount.value("T_CODCLIENT") )
             NumOper = 71;
             NumSubOper = 0;
          end;
        else
          if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
             NumOper = 0;
             NumSubOper = 0;
          elif ( DestAccount.value("T_CODCLIENT") == SourceAccount.value("T_CODCLIENT") )
             NumOper = 0;
             NumSubOper = 0;
          else
             NumOper = 63;
             NumSubOper = 0;
          end;
        end;
      end;
    end;
    if ( (ValType(ExternalData.OperData.OperSubType) == V_INTEGER) and (ExternalData.OperData.OperSubType  > 0) )
      NumSubOper = ExternalData.OperData.OperSubType;
    end;

    if ( ((NumOper == 66) or (NumOper == 67)) and (DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY")) )
      NumSubOper = 11;
      NumOper = 80;
    end;
    if ( NumOper == 0 )
      RunError( ErrMessage( 16504 ), 16504 );
    end;

    if ( (ValType(ExternalData.OperData.Sum.Sum) != V_MONEY) or (ExternalData.OperData.Sum.Sum < $0L) )
      RunError( ErrMessage( 16521 ), 16521 );
    end;

    if ( (NumOper == 80) and (ValType(ExternalData.ConvData.SumIn.Sum) == V_MONEY) and (ExternalData.ConvData.SumIn.Sum != $0L) )
      OpenDepFiles;
      var exdata : TCRData;
      exdata.OperData.Source.ObjectType = ExternalData.OperData.Source.ObjectType;
      exdata.OperData.Source.IDType = ExternalData.OperData.Source.IDType;
      exdata.OperData.Source.ID = ExternalData.OperData.Source.ID;
      exdata.OperData.Source.Branch = ExternalData.OperData.Source.Branch;
      exdata.ConvData.SumIn.Sum = ExternalData.ConvData.SumIn.Sum;
      exdata.ConvData.SumIn.Currency = RetRetailNatISO(ExternalData.ConvData.SumIn.Currency);
      exdata.isMCD = false;
      var ret = CalcRate(exdata);
      ExternalData.OperData.Sum.Sum = ret.SumOut.Sum;
    end;

    r_sbdepdoc.Referenc         = SourceAccount.value("t_referenc");
    r_sbdepdoc.Type_Account     = SourceAccount.value("t_type_account");
    r_sbdepdoc.IsCur            = SourceAccount.value("t_iscur");
    r_sbdepdoc.CodClient        = SourceAccount.value("t_codclient");
    r_sbdepdoc.DepDate_Document = {curdate};
    r_sbdepdoc.Date_Document    = {curdate};
    r_sbdepdoc.TypeOper         = NumOper;
    r_sbdepdoc.ApplType         = NumSubOper;
    r_sbdepdoc.TypeComplexOper  = NumOper;
    r_sbdepdoc.OutSum           = ExternalData.OperData.Sum.Sum;
    OpenDepFiles;
    var statop = CalcCommissionOnOper(r_sbdepdoc, r_sbdepdoc.InSum, commissionSum, "");

    if (statop > 0)
      RunError( ErrMessage( statop ), statop );
    end;

    var rs_findCur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));

    retVal.Sum.Sum = commissionSum;
    retVal.Sum.Currency = RetKernelNatISO(rs_findCur.value("T_EXTERNALCODE"));

  elif ( IsMunicipalPayment )
    var PayerCommission = $0L, ReciverCommission = $0L;
    var SumOper;

    if ( (ValType(ExternalData.ServiceType) != V_STRING) or (ExternalData.ServiceType == "") )
      RunError( ErrMessage( 16504 ), 16504 );
    elif ( (ValType(ExternalData.RecipientID) != V_INTEGER) or (ExternalData.RecipientID < 0) )
      RunError( ErrMessage( 16504 ), 16504 );
    elif ( (ValType(ExternalData.OperData.Sum.Sum) != V_MONEY) or (ExternalData.OperData.Sum.Sum < $0L) )
      RunError( ErrMessage( 16521 ), 16521 );
    end;

    var findTypeCP =  rsdcommand("select * from drtcp_type_dbt where T_CODE = :tCode");
    findTypeCP.AddParam("tCode", RSDBP_IN, ExternalData.ServiceType);
    findTypeCP.nullConversion = true;
    findTypeCP.execute();
    var rs_findTypeCP = RsdRecordset(findTypeCP);
    if ( not rs_findTypeCP.moveNext() )
      RunError( ErrMessage( 16504 ), 16504 );
    end;

    var statcp = CalcCommissionOnCP (ExternalData.RecipientID, rs_findTypeCP.value("T_ID"), ExternalData.OperData.Sum.Sum, PayerCommission, ReciverCommission);
    if (statcp > 0)
      RunError( ErrMessage( statcp ), statcp );
    end;

    var rs_Cur = FindCurrency(FINDCURBYCODE_CUR, 0);
    retVal.Sum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));

    if ((ValType(ExternalData.Direction) != V_INTEGER) or ( (ExternalData.Direction == 0) or (ExternalData.Direction == 1) ))
      retVal.Sum.Sum = PayerCommission;
    elif (ExternalData.Direction == 2)
      retVal.Sum.Sum = ReciverCommission;
    else
      RunError( ErrMessage( 16504 ), 16504 );
    end;

  else
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  return retVal;
end;

/********************************************************************************\
|                       èÖêÖÑÄíú äìêëõ ÇÄãûí RS-RETAIL                           |
\********************************************************************************/
macro GetRate ( ExternalData )
  var branch = 0;
  var retVal = TArray;

  checkRateKind(ExternalData.RateKind);
  if ( (ValType(ExternalData.Branch) == V_STRING) and (ExternalData.Branch != "") )
    var findbranch = rsdcommand ("SELECT * FROM dlistfdep_dbt WHERE T_FNCASH = (select t_code from ddp_dep_dbt where t_name = :BranchID)");
    findbranch.AddParam("BranchID", RSDBP_IN, ExternalData.Branch);
    var rs_findbranch = RsdRecordset(findbranch);
    if ( not rs_findbranch.moveNext() )
      RunError( ErrMessage( 4720 ), 4720 );
    else
      var getbranch = rsdcommand(" select rsu_rtlexch.getbranchforrate(?) getbranch from dual ");
      getbranch.AddParam ("branch", RSDBP_IN, rs_findbranch.value("T_FNCASH"));
      getbranch.nullConversion = true;
      getbranch.execute();
      var rs_getbranch = RsdRecordset(getbranch);
      if ( rs_getbranch.moveNext() )
        branch = Int(rs_getbranch.value("getbranch"));
      else
      if (rs_findbranch.value("T_OWNCURRRATE") == StrFor(0))
        branch = 1;
      elif (rs_findbranch.value("T_OWNCURRRATE") == StrFor(1))
        branch = GetFilial (rs_findbranch.value("T_FNCASH"));
        findbranch = rsdcommand ("SELECT * FROM dlistfdep_dbt WHERE T_FNCASH = :Branch");
        findbranch.AddParam("Branch", RSDBP_IN, branch);
        rs_findbranch = RsdRecordset(findbranch);
        if ( not rs_findbranch.moveNext() )
          RunError( ErrMessage( 18075 ), 18075 );
        end;
      elif (rs_findbranch.value("T_OWNCURRRATE") == StrFor(2))
        branch = rs_findbranch.value("T_FNCASH");
      end;
    end;
  end;
  end;


  var findcursql = "SELECT DD.T_NAME name, CR.T_KIND_REF RateKind, RC.T_DICTATENUMBER DictateNumber, RC.T_DICTATEDATE DictateDate, "
                           " CUR1.T_EXTERNALCODE Currency, CUR2.T_EXTERNALCODE BaseCurrency, CR.T_BUYRATE curs, 1 CursType, RC.T_STARTDATE StartDate, "
                           " RC.T_STARTTIME StartTime, CR.T_MINSUM MinSum, CR.T_CHANGENOM ChangeNom, CR.T_OUTRATE OutRate "
                           " FROM dratekind_dbt RK, dratechng_dbt RC, dcur_rate_dbt CR, ddp_dep_dbt DD, dcurrency_dbt CUR1, dcurrency_dbt CUR2 "
                           " WHERE     CR.T_CHANGE_REF = RC.T_ID AND RC.T_BRANCH = DD.T_CODE AND CUR1.T_CODE_CURRENCY = CR.T_CURR_REF "
                           " AND CUR2.T_CODE_CURRENCY = RK.T_BASE_CODE_CURRENCY AND CR.T_KIND_REF = RK.T_ID ";

  if ( (ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != "") )
    findcursql = findcursql + " AND CUR1.T_EXTERNALCODE = :extCode1 ";
  end;
  if ( (ValType(ExternalData.RateKind) == V_INTEGER) and (ExternalData.RateKind > 0) )
    findcursql = findcursql + " AND RK.T_ID = :Ratekind1 ";
  end;
  if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) or
       ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
    findcursql = findcursql + " AND RC.T_STARTDATE BETWEEN :beginDate1 and :EndDate1 " ;
  end;
  if (branch)
    findcursql = findcursql + " AND RC.T_BRANCH = :branch1 " ;
  end;
  findcursql = findcursql + "UNION ALL SELECT DD.T_NAME name, CR.T_KIND_REF RateKind, RC.T_DICTATENUMBER DictateNumber, RC.T_DICTATEDATE DictateDate, "
                           " CUR1.T_EXTERNALCODE Currency, CUR2.T_EXTERNALCODE BaseCurrency, CR.T_SELLRATE curs, 2 CursType, RC.T_STARTDATE StartDate, "
                           " RC.T_STARTTIME StartTime, CR.T_MINSUM MinSum, CR.T_CHANGENOM ChangeNom, CR.T_OUTRATE OutRate "
                           " FROM dratekind_dbt RK, dratechng_dbt RC, dcur_rate_dbt CR, ddp_dep_dbt DD, dcurrency_dbt CUR1, dcurrency_dbt CUR2 "
                           " WHERE     CR.T_CHANGE_REF = RC.T_ID AND RC.T_BRANCH = DD.T_CODE AND CUR1.T_CODE_CURRENCY = CR.T_CURR_REF "
                           " AND CUR2.T_CODE_CURRENCY = RK.T_BASE_CODE_CURRENCY AND CR.T_KIND_REF = RK.T_ID ";

  if ( (ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != "") )
    findcursql = findcursql + " AND CUR1.T_EXTERNALCODE = :extCode2 ";
  end;
  if ( (ValType(ExternalData.RateKind) == V_INTEGER) and (ExternalData.RateKind > 0) )
    findcursql = findcursql + " AND RK.T_ID = :Ratekind2 ";
  end;
  if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) or
       ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
    findcursql = findcursql + " AND RC.T_STARTDATE BETWEEN :beginDate2 and :EndDate2 " ;
  end;
  if (branch)
    findcursql = findcursql + " AND RC.T_BRANCH = :branch2 " ;
  end;

  findcursql = findcursql + "UNION ALL SELECT DD.T_NAME name, CR.T_KIND_REF RateKind, RC.T_DICTATENUMBER DictateNumber, RC.T_DICTATEDATE DictateDate, "
                           " CUR1.T_EXTERNALCODE Currency, CUR2.T_EXTERNALCODE BaseCurrency, CR.T_CBRATE curs, 3 CursType, RC.T_STARTDATE StartDate, "
                           " RC.T_STARTTIME StartTime, CR.T_MINSUM MinSum, CR.T_CHANGENOM ChangeNom, CR.T_OUTRATE OutRate "
                           " FROM dratekind_dbt RK, dratechng_dbt RC, dcur_rate_dbt CR, ddp_dep_dbt DD, dcurrency_dbt CUR1, dcurrency_dbt CUR2 "
                           " WHERE     CR.T_CHANGE_REF = RC.T_ID AND RC.T_BRANCH = DD.T_CODE AND CUR1.T_CODE_CURRENCY = CR.T_CURR_REF "
                           " AND CUR2.T_CODE_CURRENCY = RK.T_BASE_CODE_CURRENCY AND CR.T_KIND_REF = RK.T_ID AND RK.T_ID = 1 AND CR.T_MINSUM = 0";

  if ( (ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != "") )
    findcursql = findcursql + " AND CUR1.T_EXTERNALCODE = :extCode3 ";
  else
    findcursql = findcursql + " AND CUR1.T_CODE_CURRENCY IN (SELECT DISTINCT CR.T_CURR_REF "
                             " FROM dratekind_dbt RK, dratechng_dbt RC, dcur_rate_dbt CR, ddp_dep_dbt DD "
                             " WHERE     CR.T_CHANGE_REF = RC.T_ID AND RC.T_BRANCH = DD.T_CODE "
                             " AND CR.T_KIND_REF = RK.T_ID ";
    if ( (ValType(ExternalData.RateKind) == V_INTEGER) and (ExternalData.RateKind > 0) )
      findcursql = findcursql + " AND RK.T_ID = :RatekindIN ";
    end;
    if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) or
         ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
      findcursql = findcursql + " AND RC.T_STARTDATE BETWEEN :beginDateIN and :EndDateIN " ;
    end;
    if (branch)
      findcursql = findcursql + " AND RC.T_BRANCH = :branchIN " ;
    end;
    findcursql = findcursql + " ) "
  end;
  if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) or
       ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
    findcursql = findcursql + " AND RC.T_STARTDATE BETWEEN :beginDate3 and :EndDate3 " ;
  end;
  if (branch)
    findcursql = findcursql + " AND RC.T_BRANCH = :branch3 " ;
  end;

  findcursql = findcursql + " ORDER BY CursType ASC; " ;

  if ( (ValType(ExternalData.BeginDate) != V_DATE) or (ExternalData.BeginDate == Date(0,0,0)) )
    findcursql = StrSubst (findcursql, ":beginDate1", "TO_DATE('01-01-0001', 'DD-MM-YYYY')" );
    findcursql = StrSubst (findcursql, ":beginDate2", "TO_DATE('01-01-0001', 'DD-MM-YYYY')" );
    findcursql = StrSubst (findcursql, ":beginDate3", "TO_DATE('01-01-0001', 'DD-MM-YYYY')" );
  end;

  var findCur = rsdcommand (findcursql);

  if ( (ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != "") )
    findCur.AddParam ("extCode1", RSDBP_IN, RetRetailNatISO(ExternalData.Currency));
  end;
  if ( (ValType(ExternalData.RateKind) == V_INTEGER) and (ExternalData.RateKind > 0) )
    findCur.AddParam ("Ratekind1", RSDBP_IN, ExternalData.RateKind);
  end;
  if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) and
       ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
    findCur.AddParam ("beginDate1", RSDBP_IN, ExternalData.BeginDate);
    findCur.AddParam ("EndDate1", RSDBP_IN, ExternalData.EndDate);
  elif ( (ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0)) )
    findCur.AddParam ("beginDate1", RSDBP_IN, ExternalData.BeginDate);
    findCur.AddParam ("EndDate1", RSDBP_IN,Date(1,1,2300));
  elif ( (ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0)) )
    findCur.AddParam ("EndDate1", RSDBP_IN, ExternalData.EndDate);
  end;
  if (branch)
    findCur.AddParam ("branch1", RSDBP_IN, branch);
  end;
  if ( (ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != "") )
    findCur.AddParam ("extCode2", RSDBP_IN, RetRetailNatISO(ExternalData.Currency));
  end;
  if ( (ValType(ExternalData.RateKind) == V_INTEGER) and (ExternalData.RateKind > 0) )
    findCur.AddParam ("Ratekind2", RSDBP_IN, ExternalData.RateKind);
  end;
  if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) and
       ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
    findCur.AddParam ("beginDate2", RSDBP_IN, ExternalData.BeginDate);
    findCur.AddParam ("EndDate2", RSDBP_IN, ExternalData.EndDate);
  elif ( (ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0)) )
    findCur.AddParam ("beginDate2", RSDBP_IN, ExternalData.BeginDate);
    findCur.AddParam ("EndDate2", RSDBP_IN,Date(1,1,2300));
  elif ( (ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0)) )
    findCur.AddParam ("EndDate2", RSDBP_IN, ExternalData.EndDate);
  end;
  if (branch)
    findCur.AddParam ("branch2", RSDBP_IN, branch);
  end;
  if ( (ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != "") )
    findCur.AddParam ("extCode3", RSDBP_IN, RetRetailNatISO(ExternalData.Currency));
  else
    if ( (ValType(ExternalData.RateKind) == V_INTEGER) and (ExternalData.RateKind > 0) )
      findCur.AddParam ("RatekindIN", RSDBP_IN, ExternalData.RateKind);
    end;
    if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) and
         ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
      findCur.AddParam ("beginDateIN", RSDBP_IN, ExternalData.BeginDate);
      findCur.AddParam ("EndDateIN", RSDBP_IN, ExternalData.EndDate);
    elif ( (ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0)) )
      findCur.AddParam ("beginDateIN", RSDBP_IN, ExternalData.BeginDate);
      findCur.AddParam ("EndDateIN", RSDBP_IN,Date(1,1,2300));
    elif ( (ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0)) )
      findCur.AddParam ("EndDateIN", RSDBP_IN, ExternalData.EndDate);
    end;
    if (branch)
      findCur.AddParam ("branchIN", RSDBP_IN, branch);
    end;
  end;
  if ( ((ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0))) and
       ((ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0))) )
    findCur.AddParam ("beginDate3", RSDBP_IN, ExternalData.BeginDate);
    findCur.AddParam ("EndDate3", RSDBP_IN, ExternalData.EndDate);
  elif ( (ValType(ExternalData.BeginDate) == V_DATE) and (ExternalData.BeginDate > Date(0,0,0)) )
    findCur.AddParam ("beginDate3", RSDBP_IN, ExternalData.BeginDate);
    findCur.AddParam ("EndDate3", RSDBP_IN, Date(1,1,2300));
  elif ( (ValType(ExternalData.EndDate) == V_DATE) and (ExternalData.EndDate > Date(0,0,0)) )
    findCur.AddParam ("EndDate3", RSDBP_IN, ExternalData.EndDate);
  end;
  if (branch)
    findCur.AddParam ("branch3", RSDBP_IN, branch);
  end;
  findCur.nullConversion = true;
  findCur.execute();
  var rs_findCur = RsdRecordset(findCur);
  while ( rs_findCur.moveNext() )
    var Curs = TGRres;
/*    if ( branch==1 )
       Curs.Branch = NULL;
    else*/
       Curs.Branch = convertNullStr ( rs_findCur.value("name") );
    //end;
    Curs.DictateNumber = convertNullStr( rs_findCur.value("DictateNumber") );
    Curs.DictateDate = convertNullDate( rs_findCur.value("DictateDate") );
    Curs.RateType = convertNullInt( rs_findCur.value("CursType") );
    Curs.StartDate = convertNullDate( rs_findCur.value("StartDate") );
    Curs.StartTime = rs_findCur.value("StartTime");
    Curs.MinSum = rs_findCur.value("MinSum");
    Curs.Rate.Kind = convertNullInt( rs_findCur.value("RateKind") );
    if (rs_findCur.value("OutRate")==StrFor(0))
      Curs.Rate.BaseSum.Currency = RetKernelNatISO(convertNullStr( rs_findCur.value("Currency") ));
      Curs.Rate.WorkSum.Currency = RetKernelNatISO(810); //convertNullStr( rs_findCur.value("BaseCurrency") );
      Curs.Rate.BaseSum.Sum = convertNullInt(rs_findCur.value("ChangeNom"));
      Curs.Rate.WorkSum.Sum = rs_findCur.value("curs");
    else
      Curs.Rate.WorkSum.Currency = RetKernelNatISO(convertNullStr( rs_findCur.value("Currency") ));
      Curs.Rate.BaseSum.Currency = RetKernelNatISO(810); //convertNullStr( rs_findCur.value("BaseCurrency") );
      Curs.Rate.WorkSum.Sum = convertNullInt(rs_findCur.value("ChangeNom"));
      Curs.Rate.BaseSum.Sum = rs_findCur.value("curs");
    end;
    retVal[retVal.size] = Curs;
  end;
  return retVal;
end;


/********************************************************************************\
|                                 éíåÖçàíú èãÄíÖÜ                                |
\********************************************************************************/
macro StornPayment ( ExternalData )
  if ( (ValType(ExternalData.OperationID) != V_STRING) or (ExternalData.OperationID == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var findDoc = rsdcommand("SELECT * FROM dsbdepdoc_dbt WHERE T_IAPPLICATIONKIND = 1 AND T_APPLICATIONKEY = :appKey");
  findDoc.AddParam("appKey", RSDBP_IN, ExternalData.OperationID);
  findDoc.nullConversion = true;
  findDoc.execute();
  var rs_findDoc = RsdRecordset(findDoc);
  if ( not rs_findDoc.moveNext() )
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  OpenDepFiles;
  var oldBatchMode = setbatchmode(true);
  var stat = 0, st = 0;
  stat = CheckStorn( 1, ExternalData.OperationID );
  if ( not stat )
    st = DeleteDocument (1, ExternalData.OperationID, true, stat);
  end;
  setbatchmode(oldBatchMode);
  if ((not st) and (stat))
    RunError( ErrMessage( 16533 ) +" "+ ErrMessage( stat ), 16533 );
    RunError( "", 16533 );
  end;
  return 0;
end;


private macro ReadServiceParams
  var ErrCode = 0;

  if (GetRegistryValue("RS-RETAIL\\ÇçÖòçàÖ_ëÖêÇàëõ\\ÑÇàÜÖçàÖ_èé_ëóÖíì\\íéóäÄ_ÇïéÑÄ", V_STRING, URL, ErrCode) != V_STRING)
    return ErrCode;
  end;

  if (GetRegistryValue("RS-RETAIL\\ÇçÖòçàÖ_ëÖêÇàëõ\\ÑÇàÜÖçàÖ_èé_ëóÖíì\\åÖíéÑ", V_STRING, Method, ErrCode) != V_STRING)
    return ErrCode;
  end;

  if (GetRegistryValue("RS-RETAIL\\ÇçÖòçàÖ_ëÖêÇàëõ\\ÑÇàÜÖçàÖ_èé_ëóÖíì\\íÄâåÄìí", V_INTEGER, Timeout, ErrCode) != V_INTEGER)
    return ErrCode;
  end;

  return ErrCode;
end;


/********************************************************************************\
|               ëééÅôÖçàü é ÑÇàÜÖçàà èé ëóÖíì Ç RS-RETAIL                        |
\********************************************************************************/
macro SendAccountInfo ( ExternalData )
  var reqId = CreateGUID();
  var outParams;
  var encoding;
  var outResponse;
  var errMsg :string;
  var soapParams = RslSoapPrm;
  var inParamsArray = TArray;
  var xml;
  //ConvertToXML(ExternalData, null, xml);
  xml = ConvertRslToIFX(ExternalData);
  soapParams.name  = "request";
  soapParams.value = xml;
  inParamsArray[inParamsArray.size] = soapParams;

  if (not URL)
    var err = ReadServiceParams();
    if (err != 0)
      RunError(ErrMessage(err), err);
    end;
  end;
  
  var res = TSAIRes;
  res.ReqId = "";
  res.ErrorText = "";
  res.Result = 0;
  var stat = CallSimpleExtService(reqID, URL, Method, inParamsArray,"", "", Timeout, outParams, encoding, outResponse, errMsg);
  if ( not stat )
    res.ReqId = reqId;

    var prm;
    for (prm, outParams)
      if (prm.Name == "Result")
        res.Result = prm.Value;
      elif (prm.Name == "ErrorText")
        res.ErrorText = prm.Value;
      end;
      //println("\"", prm.Name, "\" = \"", prm.Value, "\"");
    end;

  end;
  return res;
end;

/********************************************************************************\
|                            èéàëä éëíÄíäÄ èé ëóÖíì                              |
\********************************************************************************/
macro FindRestByOper (AppKind : integer, AppKey : string, Ref:integer)
  var findRest = rsdcommand("SELECT DC.T_REST rest FROM dsbdepdoc_dbt dc, dsb_casln_dbt cs, (  SELECT CAS.T_APPLICATIONKIND1, "
                            " CAS.T_APPLICATIONKEY1, MAX (CAS.T_NUMLINKDOC) AS T_NUMLINKDOC FROM dsbdepdoc_dbt doc, dsb_casln_dbt cas, dsb_casln_dbt cas2 "
                            " WHERE     DOC.T_IAPPLICATIONKIND = CAS.T_APPLICATIONKIND2 AND DOC.T_APPLICATIONKEY = CAS.T_APPLICATIONKEY2 "
                            " AND CAS.T_APPLICATIONKIND1 IN (1,5,110,111,3001) AND CAS.T_APPLICATIONKIND2 IN (1,110,111) AND DOC.T_ACTION = 0 "
                            " AND CAS.T_APPLICATIONKIND1 = CAS2.T_APPLICATIONKIND1 AND CAS.T_APPLICATIONKEY1 = CAS2.T_APPLICATIONKEY1 "
                            " AND CAS2.T_REFVALUE2 = 0 AND CAS.T_REFVALUE2 = 0 AND DOC.T_KINDOP <> 0 AND CAS2.T_APPLICATIONKIND2 = ? AND CAS2.T_APPLICATIONKEY2 = ? AND DOC.T_REFERENC = ? "
                            " GROUP BY CAS.T_APPLICATIONKIND1, CAS.T_APPLICATIONKEY1) ND WHERE     CS.T_APPLICATIONKIND2 = DC.T_IAPPLICATIONKIND "
                            " AND CS.T_APPLICATIONKEY2 = DC.T_APPLICATIONKEY AND CS.T_APPLICATIONKIND1 = nd.T_APPLICATIONKIND1 "
                            " AND CS.T_APPLICATIONKEY1 = nd.T_APPLICATIONKEY1 AND CS.T_NUMLINKDOC = nd.T_NUMLINKDOC "
                            " AND DC.T_TYPECOMPLEXOPER NOT IN (35, 38, 39)");
  findRest.AddParam("AppKind2",RSDBP_IN,AppKind);
  findRest.AddParam("AppKey",RSDBP_IN,AppKey);
  findRest.AddParam("Ref",RSDBP_IN,Ref);
  findRest.nullConversion = true;
  findRest.execute();
  var rs_findRest = RsdRecordset(findRest);
  if ( not rs_findRest.moveNext() )
    return $0;
  end;
  return rs_findRest.value("rest");
end;

/********************************************************************************\
|    áÄèéãçÖçàÖ èÄêÄåÖíêéÇ Ñãü ÑÇàÜÖçàü èé ëóÖíì Ç RS-RETAIL + ÇõáéÇ ëÖêÇàëÄ     |
\********************************************************************************/
macro ëÆÆ°È®‚Ï_Æ_§¢®¶•≠®®_ØÆ_·Á•‚„ (AppKind:integer,AppKey:string)
  var ErrRes = TSAIRes;
  ErrRes.ReqId = "";
  ErrRes.Result = 0;
  ErrRes.ErrorText = "";
  var findDepdoc = rsdcommand("SELECT * FROM dsbdepdoc_dbt WHERE T_IAPPLICATIONKIND = :AppKind AND T_APPLICATIONKEY = :AppKey");
  findDepdoc.AddParam("AppKind", RSDBP_IN, AppKind);
  findDepdoc.AddParam("AppKey", RSDBP_IN, AppKey);
  findDepdoc.nullConversion = true;
  findDepdoc.execute();
  var rs_findDepdoc = RsdRecordset(findDepdoc);
  rs_findDepdoc.moveNext();
  if ( rs_findDepdoc.value("T_ACTION") == 2 )
    ErrRes.Result = 16549;
    ErrRes.ErrorText = ErrMessage( 16549 );
    return ErrRes;
  end;

  var findAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_REFERENC = ?");
  findAcc.AddParam("Referenc",RSDBP_IN,rs_findDepdoc.value("T_REFERENC"));
  findAcc.nullConversion = true;
  findAcc.execute();
  var rs_findAcc = RsdRecordset(findAcc);
  if ( not rs_findAcc.moveNext() )
    ErrRes.Result = 16511;
    ErrRes.ErrorText = ErrMessage( 16511 );
    return ErrRes;
  end;

  var findDepType = rsdcommand("SELECT * FROM dsb_dtyp_dbt WHERE T_FLAGCUR = ? AND T_KIND = ?");
  findDepType.AddParam("FlagCur",RSDBP_IN,convertNullInt(rs_findAcc.value("T_ISCUR")));
  findDepType.AddParam("Kind",RSDBP_IN,convertNullStr(rs_findAcc.value("T_TYPE_ACCOUNT")));
  findDepType.nullConversion = true;
  findDepType.execute();
  var rs_findDepType = RsdRecordset(findDepType);
  if ( not rs_findDepType.moveNext() )
    ErrRes.Result = 16513;
    ErrRes.ErrorText = ErrMessage( 16513 );
    return ErrRes;
  end;

  var rs_findCur = FindCurrency(FINDCURBYCODE_CUR, rs_findDepdoc.value("T_CODE_CURRENCY"));

  var findKeyRest = rsdcommand (" SELECT doc2.* FROM dsbdepdoc_dbt doc1, dsbdepdoc_dbt doc2 WHERE DOC1.T_IAPPLICATIONKIND = ? AND DOC1.T_APPLICATIONKEY = ? "
                                " AND DOC2.T_REFERENC = DOC1.T_REFERENC AND DOC2.T_TYPECOMPLEXOPER NOT IN (35, 38, 39) AND DOC2.t_Mode <> 2 "
                                " AND DOC2.T_KINDOP NOT IN (8, 9, 14, 15, 16) AND DOC2.T_ACTION <> 2 AND BITAND (DOC2.t_flags, 131072) = 0 "
                                " AND ( DOC2.T_DATE_DOCUMENT < DOC1.T_DATE_DOCUMENT "
                                " OR ( DOC2.T_DATE_DOCUMENT = DOC1.T_DATE_DOCUMENT AND DOC2.T_NUMDAYDOC < DOC1.T_NUMDAYDOC)) AND (DOC2.T_APPLICATIONKEY, "
                                " DOC2.T_IAPPLICATIONKIND) NOT IN (SELECT CAS1.T_APPLICATIONKEY2, CAS1.T_APPLICATIONKIND2 FROM dsb_casln_dbt cas1, dsb_casln_dbt cas2 "
                                " WHERE CAS2.T_APPLICATIONKIND2 = ? AND CAS2.T_APPLICATIONKEY2 = ? AND CAS1.T_APPLICATIONKEY1 = CAS2.T_APPLICATIONKEY1 "
                                " AND CAS2.T_REFVALUE2 = 0 AND CAS1.T_REFVALUE2 = 0 "
                                " AND CAS1.T_APPLICATIONKIND1 = CAS2.T_APPLICATIONKIND1) ORDER BY DOC2.T_DATE_DOCUMENT DESC, DOC2.T_NUMDAYDOC DESC");
  findKeyRest.AddParam("appKind",RSDBP_IN,AppKind);
  findKeyRest.AddParam("appKey",RSDBP_IN,AppKey);
  findKeyRest.AddParam("appKind2",RSDBP_IN,AppKind);
  findKeyRest.AddParam("appKey2",RSDBP_IN,AppKey);
  findKeyRest.nullConversion = true;
  findKeyRest.execute();
  var rs_findKeyRest = RsdRecordset(findKeyRest);
  if ( not rs_findKeyRest.moveNext() )
    ErrRes.ErrorText = "ç• ≠†©§•≠Î Ø‡•§Î§„È®• ÆØ•‡†Ê®®";
    return ErrRes;
  end;

  var findSum = Rsdcommand("SELECT SUM (DOC.T_INSUM - DOC.T_OUTSUM) summa, COUNT(doc.t_numdaydoc) num FROM dsbdepdoc_dbt doc, dsb_casln_dbt cas1, dsb_casln_dbt cas2 "
                           " WHERE CAS1.T_APPLICATIONKIND1 = CAS2.T_APPLICATIONKIND1 AND CAS1.T_APPLICATIONKEY1 = CAS2.T_APPLICATIONKEY1 "
                           " AND DOC.T_IAPPLICATIONKIND = CAS1.T_APPLICATIONKIND2 AND DOC.T_APPLICATIONKEY = CAS1.T_APPLICATIONKEY2 "
                           " AND CAS2.T_APPLICATIONKIND2 = ? AND CAS2.T_APPLICATIONKEY2 = ? AND DOC.T_REFERENC = ? AND CAS2.T_REFVALUE2 = 0 AND CAS1.T_REFVALUE2 = 0");
  findSum.AddParam("appKind",RSDBP_IN,AppKind);
  findSum.AddParam("appKey",RSDBP_IN,AppKey);
  findSum.AddParam("Ref",RSDBP_IN,rs_findDepdoc.value("T_REFERENC"));
  findSum.nullConversion = true;
  findSum.execute();
  var rs_findSum = RsdRecordset(findSum);
  if ( not rs_findSum.moveNext() )
    ErrRes.ErrorText = "ç• ≠†©§•≠ Æ°Æ‡Æ‚ ØÆ ÆØ•‡†Ê®®";
    return ErrRes;
  end;

  var Data = TSAIData;

  Data.Client = rs_findDepdoc.value("T_CODCLIENT");

  var findcotr = rsdcommand (" select * from drt_contract_dbt where T_BRANCH = ? and T_NUMBER = ? and t_ClientCode = ? ");
  findcotr.AddParam("fncash",RSDBP_IN,convertNullInt(rs_findAcc.value("T_FNCASH")));
  findcotr.AddParam("number",RSDBP_IN,convertNullStr(rs_findAcc.value("T_SVODACCOUNT")));
  findcotr.AddParam("ClientCode",RSDBP_IN,convertNullInt(rs_findAcc.value("T_CODCLIENT")));
  findcotr.nullConversion = true;
  findcotr.execute();
  var rs_findcotr = RsdRecordset(findcotr);
  if ( not rs_findcotr.moveNext )
    ErrRes.Result = 16514;
    ErrRes.ErrorText = ErrMessage( 16514 );
    return ErrRes;
  end;
/*  
  if ( convertNullInt(rs_findcotr.value("T_CLIENTPRODUCTID")) > 0 )
    var findclnprod = rsdcommand("select * from DPRDCLIENT_DBT where T_CLIENTPRODUCTID = ?");
    findclnprod.AddParam("CLIENTPRODUCTID",RSDBP_IN,convertNullInt(rs_findcotr.value("T_CLIENTPRODUCTID")));
    findclnprod.nullConversion = true;
    findclnprod.execute();
    var rs_findclnprod = RsdRecordset(findclnprod);
    if ( rs_findclnprod.moveNext )
      Data.ObjectType = convertNullInt(rs_findclnprod.value("T_OBJECTTYPE"));
    end;
  elif ( StrBrk( convertNullStr(rs_findAcc.value("T_USERTYPEACCOUNT")), "ä" )  != 0 )
      Data.ObjectType = 556;
  end;

  if ((rs_findDepType.value("T_FORMCONTR") == 0) and (StrBrk(rs_findAcc.value("T_USERTYPEACCOUNT"),"ä") == 0))
    Data.ObjectType = 551;
  elif ((rs_findDepType.value("T_FORMCONTR") == 0) and (StrBrk(rs_findAcc.value("T_USERTYPEACCOUNT"),"ä") != 0))
    Data.ObjectType = 554;
  elif (rs_findDepType.value("T_FORMCONTR") != 0)
    Data.ObjectType = 550;
  end;
*/

  Data.ObjectType = 551;
  Data.ID = convertNullInt(rs_findDepdoc.value("T_REFERENC"));
  Data.OperationID = convertNullStr(rs_findDepdoc.value("T_APPLICATIONKEY"));
  if ( Int(SubStr(AppKey,3,4)) < 1000 )
  Data.OpDate = Date( Int(SubStr(AppKey,9,2)), Int(SubStr(AppKey,7,2)), Int(SubStr(AppKey,3,4))+1980 );
  else
    Data.OpDate = Date( Int(SubStr(AppKey,9,2)), Int(SubStr(AppKey,7,2))-1, Int(SubStr(AppKey,3,4))+80 );
  end;
  Data.OpTime = Time( Int(SubStr(AppKey,11,2)), Int(SubStr(AppKey,13,2)), Int(SubStr(AppKey,15,2)) );
  if ( convertNullInt(rs_findSum.value("num")) > 0)
    if (rs_findSum.value("summa")<$0)
      Data.OpType = "-";
    elif (rs_findSum.value("summa")>$0)
      Data.OpType = "+";
    else
      Data.OpType = "";
    end;
    Data.Sum = Abs(rs_findSum.value("summa"));
  else
    Data.Sum = $0;
  end;
  Data.Currency = RetKernelNatISO(rs_findCur.value("T_EXTERNALCODE"));
  Data.RestBefore = FindRestByOper(rs_findKeyRest.value("T_IAPPLICATIONKIND"),rs_findKeyRest.value("T_APPLICATIONKEY"),rs_findDepdoc.value("T_REFERENC"));
  Data.RestAfter = FindRestByOper(AppKind,AppKey,rs_findDepdoc.value("T_REFERENC"));

  Data.Ground = convertNullStr(rs_findDepdoc.value("T_GROUND"));

  return SendAccountInfo ( Data );
end;

/********************************************************************************\
|                íêÄçáÄäñàü èé ìëíÄçéÇäÖ/ëçüíàû éíåÖíäà çÄ ëóÖí                  |
\********************************************************************************/
var TrnParam;
var DataTrn;
macro SetFlag
  var j;
  var modifyOPObj;
  var numtrn = TrnParam.size;
  for ( j, 0, numtrn-1 )
    var SourceAccount;
    var findParam : FindObjParm;
    findParam.Currency = null;
    findParam.IsFindMCD = false;
    findParam.FindOKCard = true;
    findParam.FindWithFncash = true;
    var trnstat = findOpenAccount ( SourceAccount, TrnParam[j].Account, findParam );
    if (not trnstat)
      var needSend = rsdcommand("SELECT * FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 AND T_OBJECTREF = ?");
      needSend.AddParam("OBJECTREF",RSDBP_IN,string(SourceAccount.value("T_REFERENC")));
      needSend.nullConversion = true;
      needSend.execute();
      var rs_needSend = RsdRecordset(needSend);
      if ( (ValType(DataTrn.Action) == V_INTEGER) and (DataTrn.Action == 1) )
        if ( rs_needSend.moveNext() )
          TrnParam[j].Result = 1;
        else
          modifyOPObj = rsdcommand("INSERT INTO dopobject_dbt (T_BRANCH, "
                                       " T_DATE, "
               	                  " T_OPAPPKIND, "
                        		    " T_OPAPPKEY, "
                         		    " T_OBJECTTYPE, "
	                                " T_OBJECTREF, "
            		                  " T_SESSIONNUM, "
                        		    " T_NUMBER, "
  	   	                         " T_ISCUR) "
	      " VALUES (?, "
	              " ?, "
	              " 11001, "
	              " chr(0), "
	              " 1, "
	              " ?, "
	              " 0, "
	              " 0, "
	              "?)");

          modifyOPObj.AddParam("BRANCH",RSDBP_IN,SourceAccount.value("T_FNCASH"));
          modifyOPObj.AddParam("DATE",RSDBP_IN,{curdate});
          modifyOPObj.AddParam("OBJECTREF",RSDBP_IN,string(SourceAccount.value("T_REFERENC")));
          modifyOPObj.AddParam("ISCUR",RSDBP_IN,SourceAccount.value("T_ISCUR"));
          modifyOPObj.execute();
          TrnParam[j].Result = 1;
        end;
      elif ( (ValType(DataTrn.Action) == V_INTEGER) and (DataTrn.Action == 2) )
        if ( not rs_needSend.moveNext() )
          TrnParam[j].Result = 2;
        else
          modifyOPObj = rsdcommand("DELETE FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 AND T_OBJECTREF = ?");

          modifyOPObj.AddParam("OBJECTREF",RSDBP_IN,string(SourceAccount.value("T_REFERENC")));
          modifyOPObj.execute();
          TrnParam[j].Result = 2;
        end;
      else
        if ( rs_needSend.moveNext() )
          modifyOPObj = rsdcommand("DELETE FROM dopobject_dbt WHERE T_OPAPPKIND = 11001 AND T_OBJECTREF = ?");

          modifyOPObj.AddParam("OBJECTREF",RSDBP_IN,string(SourceAccount.value("T_REFERENC")));
          modifyOPObj.execute();
          TrnParam[j].Result = 2;
        else
          modifyOPObj = rsdcommand("INSERT INTO dopobject_dbt (T_BRANCH, "
                                       " T_DATE, "
               	                  " T_OPAPPKIND, "
                        		    " T_OPAPPKEY, "
                         		    " T_OBJECTTYPE, "
	                                " T_OBJECTREF, "
            		                  " T_SESSIONNUM, "
                        		    " T_NUMBER, "
  	   	                         " T_ISCUR) "
	      " VALUES (?, "
	              " ?, "
	              " 11001, "
	              " chr(0), "
	              " 1, "
	              " ?, "
	              " 0, "
	              " 0, "
	              "?)");

          modifyOPObj.AddParam("BRANCH",RSDBP_IN,SourceAccount.value("T_FNCASH"));
          modifyOPObj.AddParam("DATE",RSDBP_IN,{curdate});
          modifyOPObj.AddParam("OBJECTREF",RSDBP_IN,string(SourceAccount.value("T_REFERENC")));
          modifyOPObj.AddParam("ISCUR",RSDBP_IN,SourceAccount.value("T_ISCUR"));
          modifyOPObj.execute();
          TrnParam[j].Result = 1;
        end;
      end;
    end;
  end;

end;

/********************************************************************************\
|                      ìëíÄçéÇàíú/ëçüíú éíåÖíäì çÄ ëóÖíÄ                         |
\********************************************************************************/
macro SetInfoFlag ( ExternalData )
  var i;
  var isAnyAcc = false;
  var num = ExternalData.Accounts.size;
  var RetVal = TArray;
  DataTrn = ExternalData;
  for ( i, 0, num-1 )
    if ( (ValType(ExternalData.Accounts[i].ID) == V_STRING) and (ExternalData.Accounts[i].ID != "") )
      isAnyAcc = true;
    end;
  end;
  if (not isAnyAcc)
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  for ( i, 0, num-1 )
    var AccRes = TSIFRes;
    var SourceAccount;
    var findParam : FindObjParm;
    findParam.Currency = null;
    findParam.IsFindMCD = false;
    findParam.FindOKCard = true;
    findParam.FindWithFncash = true;
    var fndstat = findOpenAccount ( SourceAccount, ExternalData.Accounts[i], findParam );
    if (not fndstat)
      AccRes.Result = 0;
    else
      AccRes.Result = 3;
    end;

    if ( (fndstat > 0) and ((ExternalData.Accounts[i].ObjectType == 550) or (ExternalData.Accounts[i].ObjectType == 556)) )
      var finddeptyp, rs_finddeptyp, MType, neednextRec = false;
      var findAccByProdId = false, findAccByNumber = false;
      var findAccount, rs_findAccount;
      if ( ExternalData.Accounts[i].IDType == 1 )
         findAccByProdId = true;
      elif ( ExternalData.Accounts[i].IDType == 2 )
         findAccByNumber = true;
      else
        return 16531;
      end;

      if ( findAccByNumber )
        finddeptyp = rsdcommand("select T_MCTYPE from dsb_dtyp_dbt where t_kind = (select T_ACCOUNTTYPE from "
                                " drtdepcontract_dbt where t_branch = (select t_code from ddp_dep_dbt where t_name = :BranchID) "
                                " and t_id = (select t_id from drt_contract_dbt "
                                " where t_branch = (select t_code from ddp_dep_dbt where t_name = :conBranchID)"
                                " and T_NUMBER = :conNumber ))");
        finddeptyp.AddParam("BranchID", RSDBP_IN, ExternalData.Accounts[i].Branch);
        finddeptyp.AddParam("conBranchID", RSDBP_IN, ExternalData.Accounts[i].Branch);
        finddeptyp.AddParam("conNumber", RSDBP_IN, ExternalData.Accounts[i].ID);
        finddeptyp.nullConversion = true;
        finddeptyp.execute();
        rs_finddeptyp = RsdRecordset(finddeptyp);
        if ( rs_finddeptyp.moveNext() )
          MType = rs_finddeptyp.value("T_MCTYPE");
          if ( MType > 0 )
            findAccount = rsdcommand("select dep.* from ddepositr_dbt dep where dep.t_fncash = (select t_code from "
                                     " ddp_dep_dbt where t_name = :BranchID) and dep.T_SVODACCOUNT = :ContrNumber "
                                     " AND dep.T_OPEN_CLOSE = CHR (0) AND dep.T_ACTION <> 2 AND dep.T_ACTION <> 11 order by dep.t_account");
            findAccount.AddParam("BranchID", RSDBP_IN, ExternalData.Accounts[i].Branch);
            findAccount.AddParam("ContrNumber", RSDBP_IN, ExternalData.Accounts[i].ID);
            findAccount.nullConversion = true;
            findAccount.execute();
            rs_findAccount = RsdRecordset(findAccount);
            if ( not rs_findAccount.moveNext() )
              AccRes.Account = ExternalData.Accounts[i];
              RetVal[RetVal.size] = AccRes;
            else
              neednextRec = true
            end;
            while ( neednextRec )
              var MAccResnN = TSIFRes;
              var MAccN = TObjectID;
              MAccN.ObjectType = 551;
              MAccN.IDType = 1;
              MAccN.ID = convertNullStr(rs_findAccount.value("T_REFERENC"));
              MAccResnN.Result = 0;
              MAccResnN.Account = MAccN;
              RetVal[RetVal.size] = MAccResnN;
              neednextRec = rs_findAccount.moveNext();
            end;
          end;
        else
          AccRes.Account = ExternalData.Accounts[i];
          RetVal[RetVal.size] = AccRes;
        end;
      elif ( findAccByProdId )
        var ExtBranch = int(SubStr(ExternalData.Accounts[i].ID, 1, StrBrk(ExternalData.Accounts[i].ID,"/")));
        var ExtContrID = int(SubStr(ExternalData.Accounts[i].ID, StrBrk(ExternalData.Accounts[i].ID,"/") + 1));
        finddeptyp = rsdcommand("select T_MCTYPE from dsb_dtyp_dbt where t_kind = (select depcon.T_ACCOUNTTYPE from "
                                " drtdepcontract_dbt depcon, drt_contract_dbt con where depcon.t_branch = con.t_branch "
                                " and depcon.t_id = con.t_id and con.t_id = :ID and con.t_branch = :branch )");
        finddeptyp.AddParam("ID", RSDBP_IN, ExtContrID);
        finddeptyp.AddParam("branch", RSDBP_IN, ExtBranch);
        finddeptyp.nullConversion = true;
        finddeptyp.execute();
        rs_finddeptyp = RsdRecordset(finddeptyp);
        if ( rs_finddeptyp.moveNext() )
          MType = rs_finddeptyp.value("T_MCTYPE");
          if ( MType > 0 )
            findAccount = rsdcommand("select dep.* from ddepositr_dbt dep, drt_contract_dbt con where con.t_id = :ID and con.t_branch = :branch and"
                                     " con.T_NUMBER = dep.T_SVODACCOUNT and con.T_BRANCH = dep.T_FNCASH "
                                     " AND dep.T_OPEN_CLOSE = CHR (0) AND dep.T_ACTION <> 2 AND dep.T_ACTION <> 11 order by dep.t_account");
            findAccount.AddParam("ID", RSDBP_IN, ExtContrID);
            findAccount.AddParam("branch", RSDBP_IN, ExtBranch);
            findAccount.nullConversion = true;
            findAccount.execute();
            rs_findAccount = RsdRecordset(findAccount);
            if ( not rs_findAccount.moveNext() )
              AccRes.Account = ExternalData.Accounts[i];
              RetVal[RetVal.size] = AccRes;
            else
              neednextRec = true
            end;
            while ( neednextRec )
              var MAccResnI = TSIFRes;
              var MAccI = TObjectID;
              MAccI.ObjectType = 551;
              MAccI.IDType = 1;
              MAccI.ID = convertNullStr(rs_findAccount.value("T_REFERENC"));
              MAccResnI.Result = 0;
              MAccResnI.Account = MAccI;
              RetVal[RetVal.size] = MAccResnI;
              neednextRec = rs_findAccount.moveNext();
            end;
          end;
        else
          AccRes.Account = ExternalData.Accounts[i];
          RetVal[RetVal.size] = AccRes;
        end;
      end;
    else
      AccRes.Account = ExternalData.Accounts[i];
      RetVal[RetVal.size] = AccRes;
    end;
  end;
  
  TrnParam = RetVal;
  LoopInTrn(TRUE);
  if ( ProcessTrn (1,"SetFlag") )
    RetVal = TrnParam;
  end;

  i = 0;
  while (i < RetVal.size)
    if ( (RetVal(i).Account.ObjectType == 551) and (RetVal(i).Account.IDType == 2) )
	  RetVal(i).Account.ID = SubStr(convertNullStr(RetVal(i).Account.ID),1,20);
	end;
    i = i + 1;
  end;
  
  return RetVal;
end;
