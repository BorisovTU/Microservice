/****************************************************************\

  R-Style Software Lab.

\*****************************************************************/

import DeprIntr, OperCode, IsSrvDoc, GetDocs, ExchangeInter, SqlConv, RSD, cur_rate;

var date_cur = {curdate};
//const SB_DEPOSIT = 1;


macro exec_extract_metal(sTypeBank, Name_Bank, sFilial, dep, dtp, sPeriod, depclnt, doc, Date1 , Date2 )
      var cmd, rs, name_met="", CBcurs=0, last_date="", in_rest = 0, korr_account="", Shifr_Oper = "", count = 1, temp_date;
      file rt_pay("rt_paym.dbt");
      record rt_payStruct("rt_paym.2");
      file auxinfo("auxinfo.dbt");
      record auxinfoStruct("auxinfo.11");


      var
        Op,
        alldebet=0.0, 
        allcredit=0.0,
        rt_outsum = 0.0,
        rt_insum  = 0.0,
        rt_rest   = 0.0,
        allrt_outsum =0,
        allrt_insum  =0;        

  cmd = RsdCommand("select t_Name_Currency from dcurrency_dbt where t_code_currency = ? ");
  cmd.AddParam("code_currency",RsdBp_in );
  cmd.value("code_currency") = dep.rec.Code_Currency;
  cmd.execute();
  rs = RsdRecordset(cmd);
  if (rs.movenext)
      name_met = rs.value(0);
  end;

  cmd = RsdCommand(" select t_depdate_document, t_rest from (select T_DEPDATE_DOCUMENT, t_numdaydoc, t_rest from dsbdepdoc_dbt where t_codclient = ? and "
     "t_referenc = ? and T_DEPDATE_DOCUMENT < ? and " + IsServ_const + " order by T_DEPDATE_DOCUMENT DESC, t_numdaydoc DESC) where rownum = 1");
  cmd.AddParam("codclient",RsdBp_in );
  cmd.value("codclient") = dep.rec.CodClient;
  cmd.AddParam("referenc",RsdBp_in );
  cmd.value("referenc") = dep.rec.Referenc;
  cmd.AddParam("depdate_doc",RsdBp_in );
  cmd.value("depdate_doc") = Date1;
  cmd.execute();
  rs = RsdRecordset(cmd);
  if (rs.movenext)
      DtTmSplit(rs.value(0), last_date);
      in_rest = rs.value(1);
  else
      last_date = "  -";
      in_rest = 0.0;
  end;

 GetAllCurrRate(doc.rec.Date_Document, doc.rec.Code_Currency, CBcurs, null, null, null);

  [
    #
    #
    Филиал № #



                                   ВЫПИСКА ИЗ ЛИЦЕВОГО СЧЕТА
                                               #

                                                  #
   
    ФИО клиента #
    Счет № #                                 #

    Дата предыдущей операции по счету  ##########
    Входящий остаток  ###############      Учетная цена Банка России  #

  ]
  (
   sTypeBank,
   Name_Bank,
   sFilial,
   ("за период с " + sPeriod):c,
   "Дата " + date_cur,
   depclnt.CurRec.rec.Name1 + " " + depclnt.CurRec.rec.Name2 + " " + depclnt.CurRec.rec.Name3,
   Acc_Form(dep.rec.Account):f,    name_met,
   last_date,
   in_rest:a:15:2,
   CBcurs + " руб./грамм"

  );
        cmd = RsdCommand(" select t_date from (select T_DATE from dauxinfo_dbt where t_infotype = ? and "
                "t_reference = ? and T_DATE < ? order by T_DATE DESC) where rownum = 1");
        cmd.AddParam("infotype",RsdBp_in );
        cmd.value("infotype") = 30; //AI_PHYSMETAL
        cmd.AddParam("referenc",RsdBp_in );
        cmd.value("referenc") = dep.rec.Referenc;
        cmd.AddParam("depdate_doc",RsdBp_in );
        cmd.value("depdate_doc") = Date1;
        cmd.execute();
        rs = RsdRecordset(cmd);
        if (rs.movenext)
            DtTmSplit(rs.value(0), last_date);
            clearRecord(auxinfo);
            auxinfo.Reference = dep.rec.Referenc;
            auxinfo.InfoType = 30; //AI_PHYSMETAL
            auxinfo.Date = last_date;            
            GetEQ(auxinfo);
            SetRecordAddr( auxinfoStruct, auxinfo, 0, 0, true ); // FldOffset( auxinfo, "Info" )
            rt_rest   = auxinfoStruct.SumIn - auxinfoStruct.SumOut;
        end;


    [    
     +--------+-----------+-----------+----------+--------------------+------------+------------+------------+++--------------------------------------+
     | № опе- |   Дата    |   Номер   |   Шифр   |       Номер        |            |            |            ||| В том числе в физической форме       |
     | рации  | операции  | документа | операции | корреспондирующего |    Дебет   |    Кредит  |   Остаток  ||+--------------------------------------+
     |        |           |           |          |       счета        |            |            |            |||   Дебет    |   Кредит   | Остаток    |
     +--------+-----------+-----------+----------+--------------------+------------+------------+------------+|+------------+------------+------------+
     |        |                       Входящие остатки                                          |############|||            |            |############|
     +--------+-----------+-----------+----------+--------------------+------------+------------+------------+|+------------+------------+------------+ ]
     ( in_rest:a:15:2,  rt_rest:15:2);

  cmd = RsdCommand(" select T_DEPDATE_DOCUMENT, T_OUTSUM, T_INSUM, T_REST, t_appltype, t_typeoper, t_type_account, t_fncash, t_iscur, t_code_currency, "
                   " t_numdaydoc, t_date_document from dsbdepdoc_dbt where t_codclient = ? and t_referenc = ? and T_DEPDATE_DOCUMENT between ? and ? "
                   "and " + IsServ_const + " order by T_DEPDATE_DOCUMENT ASC "
                  );
  cmd.AddParam("codclient",RsdBp_in );
  cmd.value("codclient") = dep.rec.CodClient;
  cmd.AddParam("referenc",RsdBp_in );
  cmd.value("referenc") = dep.rec.Referenc;
  cmd.AddParam("depdate_doc_1",RsdBp_in );
  cmd.value("depdate_doc_1") = Date1;
  cmd.AddParam("depdate_doc_2",RsdBp_in );
  cmd.value("depdate_doc_2") = Date2;
  cmd.execute();
  rs = RsdRecordset(cmd);
  while (rs.movenext)

      if ( rs.value(4) != 0 )
        Op = rs.value(5) * 1000 + rs.value(5);
      else
        Op = rs.value(5);
      end;

      clearRecord(doc);
      doc.rec.Referenc = dep.rec.Referenc;
      DtTmSplit(rs.value(0), temp_date);
      doc.rec.DepDate_Document = temp_date;
      DtTmSplit(rs.value(11), temp_date);
      doc.rec.Date_Document = temp_date;
      doc.rec.NumDayDoc = rs.value(10);
      getEQ(doc);
      
      clearRecord(rt_pay);
      rt_pay.iApplicationKind = doc.rec.iApplicationKind;
      rt_pay.ApplicationKey = doc.rec.ApplicationKey;
      rt_pay.AttrID = "DEP_PHYSMETAL";
      if ( GetEQ( rt_pay ) )
         SetRecordAddr( rt_payStruct, rt_pay);
         rt_outsum = rt_payStruct.OutSum;
         rt_insum  = rt_payStruct.InSum;
         rt_rest   = rt_rest + rt_payStruct.InSum - rt_payStruct.OutSum;
      else
         rt_outsum = 0;
         rt_insum  = 0;
         rt_rest   = 0;

      end;

      DtTmSplit(rs.value(0), temp_date);


      [|########|###########|###########|##########|####################|############|############|############|||############|############|############|]
       (count,   temp_date, 0, Shifr_Oper, korr_account,rs.value(1) , rs.value(2)  , rs.value(3), rt_outsum:15:2, rt_insum:15:2, rt_rest:15:2 );
  
  
   allrt_outsum = allrt_outsum + rt_outsum; 
   allrt_insum  = allrt_insum  + rt_insum ; 

   alldebet  = alldebet  + rs.value(1);
   allcredit = allcredit + rs.value(2);

   count = count + 1;
  
  end;

      [+--------+-----------+-----------+----------+--------------------+------------+------------+------------+|+------------+------------+------------+
       |           Обороты за период. Исходящие остатки                 |############|############|############|||############|############|############|
       +--------+-----------+-----------+----------+--------------------+------------+------------+------------+++------------+------------+------------+]
       (alldebet:15:2, allcredit:15:2, rs.value(3):15:2, allrt_outsum:15:2, allrt_insum:15:2, rt_rest:15:2 );



end;











