/* ¥ç âì ®âç¥â  (prj937) */
import indebt;
private var {curdate};

macro Print_IndebtReport( _Data )
  var cmdstr = "";
  var cmd, rs;
  var numrec = 0, numtabrec = 0;
  var ClientName, CardNumber, IndebtKindName;
  var IndebtKind = 0, TypeAcc = "";
  var IndebtRest = 0.0;
 
  cmdstr  = "SELECT indebt.t_IndebtID as IndebtID, indebt.t_IndebtKind as IndebtKind, "
            " depos.t_Account as Account, depos.t_SpecialAccess as SpecialAccess, depos.t_Type_Account as TypeAcc, depos.t_isCur as isCur, "
            " card.t_CardRef as CardRef, dtyp.t_Name as TypeAccName "
            " FROM ddpindebt_dbt indebt, ddepositr_dbt depos, dsccard_dbt card, dsb_dtyp_dbt dtyp "
            " WHERE card.t_FNcash = ? AND card.t_CardMaturityDate < ? AND card.t_CardStateCode = 'BLKJ_' "
            " AND depos.t_Referenc = indebt.t_Reference "
            " AND indebt.t_Branch = card.t_FNcash "
            " AND indebt.t_CardRef = card.t_CardRef "
            " AND indebt.t_Action <> 11 AND indebt.t_Action <> 2 "
            " AND dtyp.t_FlagCur(+) = depos.t_isCur "
            " AND dtyp.t_Kind(+) = depos.t_Type_Account "
            " ORDER BY indebt.t_IndebtKind, depos.t_Type_Account, indebt.t_Date";
  cmd = RsdCommand(cmdstr);

  cmd.addParam("Branch", RsdBp_in);
  cmd.addParam("Date", RsdBp_in);
  cmd.value("Branch") = _Data.Branch;
  cmd.value("Date") = _Data.RepDate;
  cmd.execute();
  rs = RsdRecordset(cmd);

  while( rs.moveNext() )
    ClientName = "";
    CardNumber = "";
    IndebtRest = GetIndebtRestForDate(_Data.Branch, rs.value("IndebtID"), _Data.RepDate);

    if( IndebtRest > 0 )
        numrec = numrec + 1;
        if( numrec == 1 )
          _Data.RepNumber = _Data.RepNumber + 1;
          [  
             ‘âàãªâãà­®¥ ¯®¤à §¤¥«¥­¨¥ ‘¡¥à¡ ­ª  ®áá¨¨ < ########## >]( _Data.NameBranch );
          [      < ##########   ######## >]( Date({curdate}), Time() );
          [  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
             (¤ â  ¨ ¢à¥¬ï ä®à¬¨à®¢ ­¨ï ®âç¥â )

             
                     ’—…’  ‘ˆ‘€ˆˆ ‘“ŒŒ ‡€„‹†…‘’…‰  ‹€’€Œ ‡€ ‘‹“†ˆ‚€ˆ… €Š‚‘Šˆ• Š€’                 
                                     ‘ ‘—…’€ …‡…‚€ € ‚‡Œ†›… ’…ˆ];                                           
        end;

        if( IndebtKind != rs.value("IndebtKind") )
          IndebtKind = rs.value("IndebtKind");
          TypeAcc = rs.value("TypeAcc");
          IndebtKindName = GetIndebtName(rs.value("isCur"), IndebtKind, rs.value("TypeAcc"));

          if( numtabrec > 0 )
            [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
          end;
          [ ];
          [ ‚¨¤ ¯« âë §  ®¡á«ã¦¨¢ ­¨¥:       ####################]( IndebtKindName );
          [                          ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
          [ 
           ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
           ³       ®¬¥à áç¥â         ³    ®¬¥à ª àâë     ³       ”ˆ ¤¥à¦ â¥«ï       ³ ‘ã¬¬  § ¤®«¦¥­­®áâ¨ ³
           ³                          ³                    ³                           ³                     ³
           ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
          [ ‚¨¤ ¢ª« ¤ :       ########################################]( rs.value("TypeAccName") );
          [           ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
          numtabrec = 0;

        elif( TypeAcc != rs.value("TypeAcc") )
          TypeAcc = rs.value("TypeAcc");
          [ ‚¨¤ ¢ª« ¤ :       ########################################]( rs.value("TypeAccName") );
          [           ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
        end;

        sccard.FNcash = _Data.Branch;
        sccard.cardRef = rs.value("CardRef");
        if( GetEQ(sccard) )
          CardNumber = sccard.CardNumber;
          ClientName = GetClientName( sccard.CodClient, rs.value("SpecialAccess") )
        end;

        [³##########################³####################³###########################³#####################³](
        rs.value("Account"),
        CardNumber,
        ClientName:w,
        IndebtRest
        );

        numtabrec = numtabrec + 1;
    end;

  end;

  if( numrec > 0 )
    [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ



    ];
    [®¤¯¨áì: < ###################### >]( GetOperatorName() );
    [        ____________________________________________________
    
    
    ];
  end;
end;

macro IndebtReport( Branch, RepDate, DateFrom, DateTo, NeedStructFile )
  var cmdstr = "";
  var cmd, rs;
  var Data = IndebtReportData(Branch, RepDate, DateFrom, DateTo, NeedStructFile);

  cmdstr = "SELECT t_code, t_name FROM ddp_dep_dbt";
  if( Data.Branch < 0 )
    Data.Branch = getFilialNum();
    cmdstr = cmdstr + " START WITH t_code = ? CONNECT BY PRIOR t_code=t_parentcode AND t_nodetype!=1"
                      " ORDER BY t_parentcode, t_code";
  else
    cmdstr = cmdstr + " WHERE t_code = ?";
  end;

  cmd = RsdCommand(cmdstr);
  cmd.addParam("Code", RsdBp_in);
  cmd.value("Code") = Data.Branch;
  cmd.execute();
  rs = RsdRecordset(cmd);
  /* âç¥â ¤«ï ª ¦¤®£® ¯®¤à §¤¥«¥­¨ï */
  while( rs.moveNext() )
    Data.Branch = rs.value("t_code");
    Data.NameBranch = rs.value("t_name");
    Print_IndebtReport(Data);
  end;
end;

END;