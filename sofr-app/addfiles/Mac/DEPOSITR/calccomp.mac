
/* Расчет суммы компенсации */

import deprintr,opercode,denomin,issrvdoc;

const AT_Compensation = 10;


file doc      ("sbdepdoc.dbt"); /* файл документов */
file AUXINFO  ("auxinfo.dbt");    /* Доп.информация по счету */

record AUXINFO_2("auxinfo.2");    /* Доп.информация по компенсациям */

Var
  found,
  sum=$0;

ALG_RESULT = ERR_RES; /* Возврат в случае ошибки */

/**********************************************************/

Macro MakeAuxInfo
/*
  Получение информации по сумме к получению в AuxInfo
  Ромодин А.В.
  18.08.99
*/
  var stat = False;

  KeyNum (AUXINFO,0);
  AUXINFO.Reference = ALG_DEPOSITOR.Referenc;
  AUXINFO.InfoType = 3;
  AUXINFO.Date     = Date(0,0,0);
  if (GetEQ(AUXINFO))
    stat = True;
    SetRecordAddr(AUXINFO_2,AUXINFO,0,0,TRUE);
    sum  = AUXINFO_2.Rest;
  end;
  return stat;
end;
/**********************************************************/

macro MakeDepDoc
  CheckDenom(ALG_DEPOSITOR.Referenc);
  KeyNum(doc,1);
  doc.Referenc = ALG_DEPOSITOR.Referenc;
  doc.TypeOper = Зачисление_В_Пак_Режиме;
  doc.DepDate_Document = ALG_DEPOSITOR.Open_Date; /* дата открытия счета */
  if(GetGE(doc))
    found=True;
    while((doc.Referenc == ALG_DEPOSITOR.Referenc) AND
          (doc.TypeOper == Зачисление_В_Пак_Режиме) AND
          (found == True))
      if((doc.ApplType==AT_Compensation)
          AND IsServDoc(doc))
        Sum=Sum+Den(doc.InSum,doc.DepDate_Document);
      end;
      if (not Next(doc))
        found=False;
      end;/* IF */
    end; /* WHILE */
  end; /* IF */

  doc.Referenc = ALG_DEPOSITOR.Referenc;
  doc.TypeOper = Открытие_Безналичными;
  doc.DepDate_Document = ALG_DEPOSITOR.Open_Date; /* дата открытия счета */
  if(GetGE(doc))
    found=True;
    while((doc.Referenc == ALG_DEPOSITOR.Referenc) AND
          (doc.TypeOper == Открытие_Безналичными) AND
          (found == True))
      if((doc.ApplType==AT_Compensation)
          AND IsServDoc(doc))
        Sum=Sum+Den(doc.InSum,doc.DepDate_Document);
      end;
      if (not Next(doc))
        found=False;
      end;/* IF */
    end; /* WHILE */
  end; /* IF */

  doc.Referenc = ALG_DEPOSITOR.Referenc;
  doc.TypeOper = Зачисление_Компенсации;
  doc.DepDate_Document = ALG_DEPOSITOR.Open_Date; /* дата открытия счета */
  if(GetGE(doc))
    found=True;
    while((doc.Referenc == ALG_DEPOSITOR.Referenc) AND
          (doc.TypeOper == Зачисление_Компенсации) AND
          (found == True))
      if(IsServDoc(doc))
        Sum=Sum+Den(doc.InSum,doc.DepDate_Document);
      end;
      if (not Next(doc))
        found=False;
      end;/* IF */
    end; /* WHILE */
  end; /* IF */

  doc.Referenc = ALG_DEPOSITOR.Referenc;
  doc.TypeOper = Выдача_Компенсации;
  doc.DepDate_Document = ALG_DEPOSITOR.Open_Date; /* дата открытия счета */
  if(GetGE(doc))
    found=True;
    while((doc.Referenc == ALG_DEPOSITOR.Referenc) AND
          (doc.TypeOper == Выдача_Компенсации) AND
          (found == True))
      if(IsServDoc(doc))
        Sum=Sum-Den(doc.OutSum,doc.DepDate_Document);
      end;/* IF */
      if (not Next(doc))
        found=False;
      end;/* IF */
    end; /* WHILE */
  end; /* IF */
end;
/**********************************************************
**********************************************************/

if (NOT MakeAuxInfo()) /* Если нет данных в AuxInfo, смотрим историю по счетку */
  MakeDepDoc ();
end;

ALG_PARAM.prmD = Sum;
ALG_UPDATE = 1;
ALG_RESULT = SKIP_RES; /* Все Ok */

return;
