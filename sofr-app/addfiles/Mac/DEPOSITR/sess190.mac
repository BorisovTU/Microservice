import CommonInter;

private var ComSpec = GetEnv( "COMSPEC" );
private var ImportDir = GetRegVal( "RS-RETAIL\\INI\\ДИРЕКТОРИИ\\IMPORTMESDIR", true );
var ErrCode, ErrText;

macro ConvertRtSign():bool

  file old ( "rtsign.old", "sess190.def" ) key 9999;
  file new ( "rtsign.dbt", "sess190.def" ) write;
  var Name = "";

  GetParm( 0, Name );

  message( "Конвертация файла rtsign" );
  println( "Конвертация файла rtsign" );

  DelFile( ImportDir + Name + ".old" );
  if ( Run( ComSpec, "/C ren " + ImportDir + Name + ".dbt " + Name + ".old" ) )
    println( "Не удалось переименовать файл " + Name );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось создать файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( old, ImportDir + Name + ".old" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  macro CopyVarPart
  
    record OldB ( "byte.rec", "bank.def" );
    record B    ( "byte.rec", "bank.def" );
  
    var
      ofs = 0, 
      size = GetVarSize( old );
  
    while ( ofs < size )
      SetRecordAddr( OldB, old, ofs );
      SetRecordAddr( B, new, ofs );
      Copy( B, OldB ); 
      ofs = ofs + 1;
    end;
                 
    return size;
  end;

  var i = 0;
 
  InitProgress( NRecords( old ) );
  Rewind( old );
  while ( Next( old ) )
    new.PrimRef = "c:" + old.Cod;
    new.Lengs = old.Lengs;
    new.FNCash = old.FNCash;
    new.NumSession = old.NumSession;
    new.Action = old.Action;
    Insert( new, CopyVarPart );
    UseProgress( i = i + 1 );
  end;                               
  RemProgress;
end;