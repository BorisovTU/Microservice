
/* Сторнирование выдачи %% */

import deprintr,IsSrvDoc,opercode;

record SBDEPDOC11 ("sbdepdoc.11");
record SBDEPDOC12 ("sbdepdoc.12");
file   TempFile   ("sbdepdoc.dbt");

file PcDRest( "pc_drest.dbt" ) key 0 write;
file DepDoc ( "sbdepdoc.dbt" ) key 2;
file AlgOp  ( "sb_algop.dbt" ) key 0;
file casln  ( "sb_casln.dbt" );
PRIVATE file Depos ("depositr.dbt") key 8;

record doc ("sbdepdoc.dbt");

var NonCash = False;

ALG_RESULT = -1;

macro GetEndDate

  var
    Dd = ALG_SBDEPDOC.DepDate_Document - 1;

  AlgOp.IsCur = ALG_DEPOSITOR.IsCur;
  AlgOp.Kind = ALG_DEPOSITOR.Type_Account;
  AlgOp.NumOpert = ALG_SBDEPDOC.TypeOper;
  AlgOp.NumStepAlg = 245;
  AlgOp.BegDate = ALG_SBDEPDOC.DepDate_Document;
  if ( GetLE( AlgOp ) 
    and ( AlgOp.IsCur == ALG_DEPOSITOR.IsCur )
    and ( AlgOp.Kind == ALG_DEPOSITOR.Type_Account )
    and ( AlgOp.NumOpert == 6 )
/*    and ( AlgOp.NumOpert == ALG_SBDEPDOC.TypeOper ) */
    and ( AlgOp.NumStepAlg == 245 ) )
    if ( AlgOp.prmC != StrFor( 0 ) )
      Dd = Dd + 1;
    end;
  end;
  return Dd;
end;
/*********************************************************/

macro GetMainDocument
/*
  Получить главный документ по некоторому
  (из списка)
*/
  var n,y, f;
  keynum (casln, 1);
  casln.ApplicationKind2 = ALG_SBDEPDOC.iApplicationKind;
  casln.ApplicationKey2  = ALG_SBDEPDOC.ApplicationKey;
  casln.RefValue2 = 0;
  if (getEQ(casln))
    n = casln.ApplicationKind1;
    y = casln.ApplicationKey1;
    keynum (casln, 0);
    casln.ApplicationKind1 = n;
    casln.ApplicationKey1 = y;
    casln.NumLinkDoc = 0;
    f = getGE( casln );
    while (f and ( casln.ApplicationKind1 == n ) and ( casln.ApplicationKey1 == y ))
      if (casln.RefValue2 == 0) 
        KeyNum (DepDoc,3);
        DepDoc.iApplicationKind = casln.ApplicationKind2;
        DepDoc.ApplicationKey = casln.ApplicationKey2;
        if( getEQ( DepDoc ) )
          if(IsServDoc(DepDoc))
            if (DepDoc.TypeOper == 6)  /* Для наличной выдачи процентов */
              NonCash = False;
              return true;
            elif ((DepDoc.TypeOper == 62) /* Для безналичной выдачи процентов */
               OR (DepDoc.TypeOper == 63)
               OR ((DepDoc.TypeOper == 65) AND (DepDoc.KindOp != 5)/*(DepDoc.ApplType != 11)*/)
               OR (DepDoc.TypeOper == 66)
               OR (DepDoc.TypeOper == 67) )
              NonCash = True;
              return true;
            end;
          end;
        end;
      end;
      f = next( casln );
     end;
  end;
  return false;
end;
/*********************************************************/

macro TrnProc;

  var
    EndDate,
    Storn,
    RecFound,
    TrnStatus = False,
    Sum = $0L;
  var DateInfo = {curdate};
  var Info_Date;
  var TypeOpPerc = 2002;

  TrnStatus = GetMainDocument ();
  if (TrnStatus)
    Copy(ALG_SBDEPDOC, DepDoc);
    if (ALG_SBDEPDOC.Referenc != ALG_DEPOSITOR.Referenc)
      Depos.Referenc = ALG_SBDEPDOC.Referenc;
      TrnStatus = GetEQ (Depos);
      if (TrnStatus)
        Copy (ALG_DEPOSITOR, Depos);
      else
        AbortTrn;
        return;
      end;
    end;
  else
    AbortTrn;
    return;
  end;

  if (NonCash)
    Copy (TempFile,ALG_SBDEPDOC);
    SetRecordAddr (SBDEPDOC11,TempFile,0,0,True);
    Sum = SBDEPDOC11.saveOutPcSum;
    Info_Date = SBDEPDOC11.Date;
    TypeOpPerc = SBDEPDOC11.TypeOpPerc;
  else
    Copy (TempFile,ALG_SBDEPDOC);
    SetRecordAddr (SBDEPDOC12,TempFile,0,0,True);
    Info_Date = SBDEPDOC12.Info_Date;
    Sum = SBDEPDOC12.saveOutPcSum;
    TypeOpPerc = SBDEPDOC12.TypeOpPerc;
  end;
  /*if (Info_Date == date(0, 0, 0))
    Info_Date = ALG_SBDEPDOC.DepDate_Document;
  end;*/

  if (ALG_SBDEPDOC.ApplType == 4)
/*    Sum = ALG_SBDEPDOC.OutSum - ALG_SBDEPDOC.PcPercSum; */ /* За полный масяц */
    Sum = 0;
  end;
  EndDate = GetEndDate;

  if ( ALG_PARAM.PrmC )
    Storn = true;
  else
    Storn = false;
  end;

  if (ALG_SBDEPDOC.ApplType != Выдача_Расчитанных_Проц)
    if (ALG_SBDEPDOC.FlagStorn == StrFor(0))
      DateInfo = Info_Date + 1;
      ClearRecord( PcDRest );
      PcDRest.Referenc = ALG_DEPOSITOR.Referenc;
      PcDRest.Type_Object = TypeOpPerc;
      PcDRest.Date_Rest = Info_Date;
      RecFound = GetGE( PcDRest );
      while ( RecFound
        and ( PcDRest.Referenc == ALG_DEPOSITOR.Referenc )
        and ( PcDRest.Type_Object == TypeOpPerc )
        and ( PcDRest.Date_Rest < EndDate ) )
        PcDRest.Rest = PcDRest.Rest - Sum;
        if ( not Update( PcDRest ) )
          AbortTrn;
          return;
        end;
        RecFound = Next( PcDRest );
      end;

      ClearRecord( PcDRest );
      PcDRest.Referenc = ALG_DEPOSITOR.Referenc;
      PcDRest.Type_Object = 2001;
      PcDRest.Date_Rest = Info_Date;
      RecFound = GetGE( PcDRest );
      while ( RecFound
        and ( PcDRest.Referenc == ALG_DEPOSITOR.Referenc )
        and ( PcDRest.Type_Object == 2001 )
        and ( PcDRest.Date_Rest < EndDate ) )
    /*    and ( PcDRest.Date_Rest <= ALG_SBDEPDOC.DepDate_Document - 1 ) ) */
        PcDRest.Rest = PcDRest.Rest + Sum;
        if ( not Update( PcDRest ) )
          AbortTrn;
          return;
        end;
        RecFound = Next( PcDRest );
      end;
    end;
  end;

    if ( not DeleteDocument(
      ALG_SBDEPDOC.iApplicationKind,
      ALG_SBDEPDOC.ApplicationKey,
      Storn ) )
      AbortTrn;
      return;
    end;

/*
  Расчет процентов
*/
  doc.Referenc         = ALG_DEPOSITOR.Referenc;
  doc.IsCur            = ALG_DEPOSITOR.IsCur;
  doc.FNCash           = ALG_DEPOSITOR.FNCash;
  doc.Account          = ALG_DEPOSITOR.Account;
  doc.Oper             = {oper};
  doc.Type_Account     = ALG_DEPOSITOR.Type_Account;
  doc.Code_Currency    = ALG_DEPOSITOR.Code_Currency;
  doc.CodClient        = ALG_DEPOSITOR.CodClient;
  doc.YesSbook         = "X";
  doc.Date_Document    = {curdate};
  doc.DepDate_Document = DateInfo;
  doc.Author           = 0;
  doc.iApplicationKind = 1;
  Выполнить_Операцию  (    ALG_DEPOSITOR.Account,
                           ALG_DEPOSITOR.Type_Account,
                           ALG_DEPOSITOR.Code_Currency,
                           35,
                           doc,
                           0,
                           1,
                           1,
                           35,
                           0,
                           ALG_DEPOSITOR.CodClient,
                           "",
                           "",
                           DateInfo,
                           0,
                           Date(0,0,0),
                           1 );

  ALG_RESULT = END_RES;
end;

  LoopInTrn(TRUE);
  ProcessTrn( 1, "TrnProc", PcDRest, AlgOp, DepDoc );
end;
