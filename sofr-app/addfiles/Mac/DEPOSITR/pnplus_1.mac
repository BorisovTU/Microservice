/*
               **************************
               *  R-Style SoftWare Lab. *  
               **************************  

    RS-Retail 2.0
    Сбербанк
 Вклад "Пенсионный + на 3 года" 

 Определение процентной ставки по альтернативным условиям
 (при нарушении) для Пенсионного + на 3 года
------------------------------------------------------------
  Цель:
  обеспечить взятие различных ставок при закрытии договора
  либо при условном закрытии договора (завещание)
  в зависимости от того, кто закрывает вклад: вкладчик или наследник 
- для вкладчика и 1-го наследника - по основной ставке,
- для 2-го наследника и остальных наследников -  ставка До востребования


  В случае, если операция отлична от закрытия счета,
  берется основная ставка 
----------------
  Ромодин Александр Васильевич
  23.10.2003
*/
Import DeprIntr,srpnrt_0;
/*
  Структуры
*/
record PC_ALG   (pc_alg);     /* Параметры расчета процентов */
record DEPOSITR_SRPNRT_1 (depositr);   /* Текущий счет вкладчика      */
private record SBDEPDOC (sbdepdoc);   /* Текущий документ вкладчика  */

file PC_RATE (pc_rate) key 0; /* Справочник ставок           */
file TRUSTWILL(sbtrast) key 0;

/**********************************************************/

macro NeedSpecific (NumOper)
/*
  Возвращает True в случае, если ставка определяется
  по специфическим условиям
*/
  var stat;
  var ClosedAcc = False;
  var StartDate;
  var LimitDate;
  var TestDate;
  var RecFound;

  ClearRecord( TRUSTWILL );
  TRUSTWILL.Referenc = DEPOSITR_SRPNRT_1.Referenc;
  TRUSTWILL.VidDoc   = StrFor( 1 );
  RecFound = GetGE( TRUSTWILL );
  while ( RecFound 
    and ( TRUSTWILL.Referenc == DEPOSITR_SRPNRT_1.Referenc )
    and ( TRUSTWILL.VidDoc   == StrFor( 1 ) ) )
    if ( TRUSTWILL.CloseDate != Date( 0, 0, 0 ) )
      return false;
    end;
    RecFound = Next( TRUSTWILL ); 
  end;
  return true;
end;
/**********************************************************/

macro GetAltRate (alg,dr,BeginDate,EndDate,doc)
  var ResRate:doublel = 0.0l;
  var RateDate; /* Ставка фиксированная, действует с начала договора */

  setbuff (PC_ALG,alg); 
  setbuff (DEPOSITR_SRPNRT_1,dr); 
  setbuff (SBDEPDOC,doc); 

  if ( DEPOSITR_SRPNRT_1.UseAlternate == 0 )
    return 0;
  elif (NeedSpecific(SBDEPDOC.TypeComplexOper))
/*
    Вычисление ставки как части от ставки по основным условиям
    (ради чего писался макрос)
*/
    if (DEPOSITR_SRPNRT_1.Prol_DateDep != Date(0,0,0))
      RateDate = DEPOSITR_SRPNRT_1.Prol_DateDep;
    else
      RateDate = DEPOSITR_SRPNRT_1.Start_DateDep;
    end;
    ClearRecord (PC_RATE);
    ResRate = PercRateAL (DEPOSITR_SRPNRT_1.Referenc,2001,RateDate);
    if (ResRate > 0)
      MacroError = 0;    /* Ставка определена */
    else
      MacroError = 3649; /* Ошибка при определении процентной ставки */
    end;
  else /* Ставка- по условиям "До востребования" (стандартным образом) */
    MacroError = -999;   /* Ставка будет определена из условий в настройке параметров процентов */
  end;
  return doubleL(ResRate);
end;
