/*
**  Операционный дневник.
**  Валютообменные операции. Отчет по базам ОП.
**  Операции, по по которым есть реестры
*/
import ExchangeInter, "od_ex_al.mac", /*"rstrfunc.mac",*/ "opertdy2.mac";

/***************************************************************************
                       Формирование сумм для строки отчета
                        по одному валютообменному реестру
***************************************************************************/
MACRO Заполнить_суммы_по_реестру( R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out )

  var OldKey, stat;
  var IncomeCurr_Ref, OutCurr_Ref;

  OldKey = KeyNum( Reestr, 0 );
  ClearRecord( Reestr );

  Reestr.Branch = TmpOperat.Branch;
  Reestr.ID     = TmpOperat.ID;

  stat = GetEQ( Reestr );
  KeyNum( Reestr, OldKey );

  IncomeCurr_Ref = FindCodCurByRefVal( Реестр.IncomeRefVal );
  OutCurr_Ref    = FindCodCurByRefVal( Реестр.OutRefVal );

  /* Покупка платежеспособной валюты за рубли   */
  if( Reestr.Kind_Oper == CDF_OperCurrBuy      )
    if( TmpOperat.IsIncome == ON )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      C_In  = Reestr.IncomeSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    else
      R_Out = Reestr.OutSum;
    end;
  /* Покупка неплатежеспособной валюты за рубли */
  /* Покупка платежного документа за рубли      */
  elif( ( Reestr.Kind_Oper == CDF_OperUnpayCurrBuy ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocBuy    ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocBuyAcc )  )
    if( TmpOperat.IsIncome == ON )
      UR_In = Cur2Rub( Reestr.IncomeSum );
      UC_In = Reestr.IncomeSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    else
      R_Out = Reestr.OutSum;
    end;
  /* Продажа платежного документа за рубли */
  elif( ( Reestr.Kind_Oper == CDF_OperPayDocSale    ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocSaleAcc )  )
    if( TmpOperat.IsIncome == OFF )
      R_In  = Cur2Rub( Reestr.OutSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      C_In  = Reestr.OutSum;
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    else
      R_In  = Reestr.IncomeSum;
    end;
  /* Продажа платежеспособной валюты за рубли */
  elif( Reestr.Kind_Oper == CDF_OperCurrSale )
    if( TmpOperat.IsIncome == OFF )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    else
      R_In  = Reestr.IncomeSum;
    end;
  /* Начисление на карту                    */
  /*
  elif( Reestr.Kind_Oper == CDF_OperCardTake )
    if( ( IsCur ) and ( Reestr.IncomeCurr_Ref != {NationalCur} ) )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      C_In  = Reestr.IncomeSum;
      /*Q_Out = money(Reestr.NumberSprv*100); - справки считать не так !!!*/
    elif( Reestr.IncomeCurr_Ref == {NationalCur} )
      R_In  = Reestr.IncomeSum;
      /*Q_Out = money(Reestr.NumberSprv*100); - справки считать не так !!!*/
    end;
  */
  /* Снятие с карты                         */
  /*
  elif( Reestr.Kind_Oper == CDF_OperCardGive )
    if( ( IsCur ) and ( Reestr.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
      /*Q_Out = money(Reestr.NumberSprv*100); - справки считать не так !!!*/
    elif( Reestr.OutCurr_Ref == {NationalCur} )
      R_Out = Reestr.OutSum;
      /*Q_Out = money(Reestr.NumberSprv*100); - справки считать не так !!!*/
    end;
  */
  /* Прием на экспертизу                    */
  /* Прием на инкассо                       */
  /* Прием ПД на экспертизу                 */
  /* Прием ПД на инкассо                    */
  elif( ( Reestr.Kind_Oper == CDF_OperExpert        ) or
        ( Reestr.Kind_Oper == CDF_OperIncasso       ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocExpert  ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocIncasso )  )
    if( TmpOperat.IsIncome == ON )
      UQ_In = Reestr.IncomeSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  /* Конверсия                              */
  elif( Reestr.Kind_Oper == CDF_OperCurrConversion )
    if( TmpOperat.IsIncome == ON )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      C_In  = Reestr.IncomeSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    else
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
    end;
  /* Покупка платежного документа за валюту */
  elif( ( Reestr.Kind_Oper == CDF_OperPayDocBuyCurr    ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocBuyCurrAcc ) )
    if( TmpOperat.IsIncome == ON )
      UR_In = Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      UC_In = Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  /* Продажа платежного документа за валюту */
  elif( ( Reestr.Kind_Oper == CDF_OperPayDocSaleCurr    ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocSaleCurrAcc )  )
    if( TmpOperat.IsIncome == OFF )
      R_In  = 2*Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      C_In  = 2*Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  /* Замена неплатежеспособной валюты       */
  elif( Reestr.Kind_Oper == CDF_OperChange )
    if( TmpOperat.IsIncome == ON )
      UR_In = Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      UC_In = Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  /* Размен валюты                          */
  elif( Reestr.Kind_Oper == CDF_OperSplit )
    if( TmpOperat.IsIncome == ON )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      C_In  = Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  /* Возврат с инкассо                      */
  /* Возврат ПД с инкассо                   */
  elif( ( Reestr.Kind_Oper == CDF_OperReturnIncasso       ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocReturnIncasso )  )
    if( IsCur and ( OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    elif( OutCurr_Ref == {NationalCur} )
      R_Out = Reestr.OutSum;
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  /* Возврат с экспертизы                   */
  /* Возврат ПД с экспертизы                */
  elif( ( Reestr.Kind_Oper == CDF_OperReturnExpert        ) or
        ( Reestr.Kind_Oper == CDF_OperPayDocReturnExpert  )  )
    /* Возврат денежного эквивалента */
    if( ( Reestr.OutTypeValue == TYPERES_CURRENCY ) and
        ( Reestr.OutType      == TYPE_RES_PAY  )  )
      if( IsCur and ( OutCurr_Ref != {NationalCur} ) )
        R_Out = Cur2Rub( Reestr.OutSum );
        C_Out = Reestr.OutSum;
        CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
      elif( OutCurr_Ref == {NationalCur} )
        R_Out = Reestr.OutSum;
        CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
      end;
    /* Возврат принятой ценности */
    else
      if( IsCur )
        CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
        UQ_Out= Reestr.OutSum;
      end;
    end;
  /* Проверка на подлинность                */
  elif( Reestr.Kind_Oper == CDF_OperCheck )
    if( TmpOperat.IsIncome == ON )
      CalcValuesTurnsByReestr( Reestr.Branch, Reestr.ID, Q_In, Q_Out );
    end;
  end;

  SetParm(  0, R_In   );
  SetParm(  1, R_Out  );
  SetParm(  2, MR_In  );
  SetParm(  3, MR_Out );
  SetParm(  4, C_In   );
  SetParm(  5, C_Out  );
  SetParm(  6, MC_In  );
  SetParm(  7, MC_Out );
  SetParm(  8, Q_In   );
  SetParm(  9, Q_Out  );
  SetParm( 10, UR_In  );
  SetParm( 11, UR_Out );
  SetParm( 12, UC_In  );
  SetParm( 13, UC_Out );
  SetParm( 14, UQ_In  );
  SetParm( 15, UQ_Out );
END;


/*             пока весь файл не нужен

/***************************************************************************
                       Формирование сумм для строки отчета
                        по одному валютообменному реестру
***************************************************************************/
macro Заполнить_суммы_по_реестру( R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out )

  var
  КурсЦБ     = 0,
  PayDoc_Ref = 0,
  Колич      = 0,
  КодВалюты  = int (Curr.ExternalCode);

  /* Покупка платежеспособной валюты за рубли   */
  if( Reestr.Oper_Ref == CDF_OperCurrBuy      )
    if( IsCur )
      R_In  = Cur2Rub( Reestr.IncomeSum ); 
      C_In  = Reestr.IncomeSum;
      Q_Out = money(Reestr.NumberSprv*100);
    else
      R_Out = Reestr.OutSum + Reestr.IncTaxSum;
    end;
/*  Согласно ТЗ 622-01 мемориальные обороты не нужны
    if( C_In > R_Out )
      MR_In = C_In - R_Out;
    else
      MR_Out = R_Out - C_In;
    end;
    Количество ценностей не нужно
    ПолучитьСтрокуСерийНомеровПД( Operat.ID, Q_In ); /* вычислим количество */
    Q_In = money( Q_In * 100 );
*/
  /* Покупка неплатежеспособной валюты за рубли */
  /* Покупка платежного документа за рубли      */
  elif( ( Reestr.Oper_Ref == CDF_OperUnpayCurrBuy ) or
        ( Reestr.Oper_Ref == CDF_OperPayDocBuy    )  )      
    if( IsCur )
      UR_In = Cur2Rub( Reestr.IncomeSum ); 
      UC_In = Reestr.IncomeSum;
      Q_Out = money(Reestr.NumberSprv*100);
    else
      R_Out = Reestr.OutSum + Reestr.IncTaxSum;
    end;
  /* Продажа платежного документа за рубли */
  elif( Reestr.Oper_Ref == CDF_OperPayDocSale )
    if( IsCur )
      R_In  = Cur2Rub( Reestr.OutSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      C_In  = Reestr.OutSum;
      C_Out = Reestr.OutSum;
      Q_Out = money( (Reestr.NumberSprv + Reestr.OutQuantum)*100);
    else
      R_In  = Reestr.IncomeSum - Reestr.IncTaxSum;
    end;
  /* Продажа платежеспособной валюты за рубли */
  elif( Reestr.Oper_Ref == CDF_OperCurrSale )
    if( IsCur )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    else
      R_In  = Reestr.IncomeSum - Reestr.IncTaxSum;
    end;
/*  Согласно ТЗ 622-01 мемориальные обороты не нужны
    if( R_In > C_Out )
      MR_In = R_In - C_Out;
    else
      MR_Out = C_Out - R_In;
    end;
    Количество ценностей не нужно
    ПолучитьСтрокуСерийНомеровПД( Operat.ID, Q_Out ); /* вычислим количество */
    Q_Out = money( Q_Out * 100 );
*/
  /* Начисление на карту                    */
  elif( Reestr.Oper_Ref == CDF_OperCardTake )
    if( ( IsCur ) and ( Reestr.IncomeCurr_Ref != {NationalCur} ) )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      C_In  = Reestr.IncomeSum;
      Q_Out = money(Reestr.NumberSprv*100);
    elif( Reestr.IncomeCurr_Ref == {NationalCur} )
      R_In  = Reestr.IncomeSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Снятие с карты                         */
  elif( Reestr.Oper_Ref == CDF_OperCardGive )
    if( ( IsCur ) and ( Reestr.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    elif( Reestr.OutCurr_Ref == {NationalCur} )
      R_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Прием на экспертизу                    */
  /* Прием на инкассо                       */
  /* Прием ПД на экспертизу                 */
  /* Прием ПД на инкассо                    */
  elif( ( Reestr.Oper_Ref == CDF_OperExpert        ) or
        ( Reestr.Oper_Ref == CDF_OperIncasso       ) or
        ( Reestr.Oper_Ref == CDF_OperPayDocExpert  ) or
        ( Reestr.Oper_Ref == CDF_OperPayDocIncasso )  )
    if( IsCur )
      UQ_In = Reestr.IncomeSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
/*  Количество ценностей не нужно
      ПолучитьСтрокуСерийНомеровПД( Operat.ID, Q_In ); /* вычислим количество */
      Q_In = money( Q_In * 100 );
*/
  /* Конверсия                              */
  elif( Reestr.Oper_Ref == CDF_OperCurrConversion )
    if( IsCur )
      if( Reestr.IncomeCurr_Ref == КодВалюты )
        R_In  = Cur2Rub( Reestr.IncomeSum );
        C_In  = Reestr.IncomeSum;
        Q_Out = money(Reestr.NumberSprv*100);
      elif( Reestr.OutCurr_Ref == КодВалюты )
        R_Out = Cur2Rub( Reestr.OutSum );
        C_Out = Reestr.OutSum;
      end;  
    end;
  /* Покупка платежного документа за валюту */
  elif( Reestr.Oper_Ref == CDF_OperPayDocBuyCurr )
    if( IsCur )
      UR_In = Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      UC_In = Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Продажа платежного документа за валюту */
  elif( Reestr.Oper_Ref == CDF_OperPayDocSaleCurr )
    if( IsCur )
      R_In  = 2*Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      C_In  = 2*Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      Q_Out = money( (Reestr.NumberSprv + Reestr.OutQuantum)*100 );
    end;
  /* Замена неплатежеспособной валюты       */
  elif( Reestr.Oper_Ref == CDF_OperChange )
    if( IsCur )
      UR_In = Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      UC_In = Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Размен валюты                          */
  elif( Reestr.Oper_Ref == CDF_OperSplit )
    if( IsCur )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      R_Out = Cur2Rub( Reestr.OutSum );
      C_In  = Reestr.IncomeSum;
      C_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Возврат с инкассо                      */
  /* Возврат ПД с инкассо                   */
  elif( ( Reestr.Oper_Ref == CDF_OperReturnIncasso       ) or
        ( Reestr.Oper_Ref == CDF_OperPayDocReturnIncasso )  )
    if( IsCur and ( Reestr.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    elif( Reestr.OutCurr_Ref == {NationalCur} )
      R_Out = Reestr.OutSum;
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Возврат с экспертизы                   */
  /* Возврат ПД с экспертизы                */
  elif( ( Reestr.Oper_Ref == CDF_OperReturnExpert        ) or
        ( Reestr.Oper_Ref == CDF_OperPayDocReturnExpert  )  )
    /* Возврат денежного эквивалента */
    if( ( Reestr.OutTrs_Ref == TrsCash  ) or
        ( Reestr.OutTrs_Ref == TrsMonet )  )
      if( IsCur and ( Reestr.OutCurr_Ref != {NationalCur} ) )
        R_Out = Cur2Rub( Reestr.OutSum );
        C_Out = Reestr.OutSum;
        Q_Out = money(Reestr.NumberSprv*100);
      elif( Reestr.OutCurr_Ref == {NationalCur} )
        R_Out = Reestr.OutSum;
        Q_Out = money(Reestr.NumberSprv*100);
      end;
    /* Возврат принятой ценности */
    else
      if( IsCur )
        Q_Out = money(Reestr.NumberSprv*100);
        UQ_Out= Reestr.OutSum;
      end;
    end;
  /* Проверка на подлинность                */
  elif( Reestr.Oper_Ref == CDF_OperCheck )
    if( IsCur )
      Q_Out = money(Reestr.NumberSprv*100);
    end;
  /* Отражение излишков                     */
  /* Возмещение недостачи                   */
  elif( ( Reestr.Oper_Ref == CDF_OperDetectOverplus    ) or
        ( Reestr.Oper_Ref == CDF_OperCompensateDeficit )  )
    if( IsCur and ( Reestr.IncomeCurr_Ref != {NationalCur} ) )
      R_In  = Cur2Rub( Reestr.IncomeSum );
      C_In  = Reestr.IncomeSum;
    elif( Reestr.IncomeCurr_Ref == {NationalCur} )
      R_In  = Reestr.IncomeSum;
    end;
  /* Отражение недостачи                    */
  /* Выдача излишков                        */
  elif( ( Reestr.Oper_Ref == CDF_OperDetectDeficit   ) or
        ( Reestr.Oper_Ref == CDF_OperGiveOutOverplus )  )
    if( IsCur and ( Reestr.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Reestr.OutSum );
      C_Out = Reestr.OutSum;
    elif( Reestr.OutCurr_Ref == {NationalCur} )
      R_Out = Reestr.OutSum;
    end;

  end;
  SetParm(  0, R_In   );
  SetParm(  1, R_Out  );
  SetParm(  2, MR_In  );
  SetParm(  3, MR_Out );
  SetParm(  4, C_In   );
  SetParm(  5, C_Out  );
  SetParm(  6, MC_In  );
  SetParm(  7, MC_Out );
  SetParm(  8, Q_In   );
  SetParm(  9, Q_Out  );
  SetParm( 10, UR_In  );
  SetParm( 11, UR_Out );
  SetParm( 12, UC_In  );
  SetParm( 13, UC_Out );
  SetParm( 14, UQ_In  );
  SetParm( 15, UQ_Out );

end;

/***************************************************************************
                       Формирование и печать строк отчета
                        по одному валютообменному реестру
***************************************************************************/
macro OutLinesOnReestr()
  var
  КурсЦБ,
  NameOperation,
  Sprv31Amount,
  КодВалюты,
  R_In,  R_Out,  MR_In, MR_Out, C_In,  C_Out, MC_In, MC_Out, Q_In,  Q_Out,
  UR_In, UR_Out,                UC_In, UC_Out,               UQ_In, UQ_Out,
  ConvCurr, ConvSum, ConvSumRUR;

  macro ClearSums()
    NameOperation = "";
    R_In   = $0.0;  UR_In   = $0.0;
    R_Out  = $0.0;  UR_Out  = $0.0;
    MR_In  = $0.0;
    MR_Out = $0.0;
    C_In   = $0.0;  UC_In   = $0.0;
    C_Out  = $0.0;  UC_Out  = $0.0;
    MC_In  = $0.0;
    MC_Out = $0.0;
    Q_In   = $0.0;  UQ_In   = $0.0;
    Q_Out  = $0.0;  UQ_Out  = $0.0;
  end;

  macro GetCnvCoinsTurns( ConvCurr, ConvSum, ConvSumRUR )

    ConvCurr   = ANY_CURR;
    ConvSum    = $0;
    ConvSumRUR = $0;

    if( GetTurnReestr( CDF_TurnCnvCoins ) )
      if  (   (TurnReestr.Cash     == UNSET_CHAR   )
          AND (TurnReestr.Curr_Ref != {NationalCur})
          )
        ConvSum    = abs(TurnReestr.Sum);
        ConvCurr   = abs(TurnReestr.Curr_Ref);
      elif(   (TurnReestr.Cash     == SET_CHAR     )
          AND (TurnReestr.Curr_Ref == {NationalCur})
          )
        ConvSumRUR = abs(TurnReestr.Sum);
      end;
      if( GetNextTurnReestr( CDF_TurnCnvCoins ) )
        if  (   (TurnReestr.Cash     == UNSET_CHAR   )
            AND (TurnReestr.Curr_Ref != {NationalCur})
            )
          ConvSum    = abs(TurnReestr.Sum);
          ConvCurr   = abs(TurnReestr.Curr_Ref);
        elif(   (TurnReestr.Cash     == SET_CHAR     )
            AND (TurnReestr.Curr_Ref == {NationalCur})
            )
          ConvSumRUR = abs(TurnReestr.Sum);
        end;
      end;
    end;

    SetParm( 0, ConvCurr   );
    SetParm( 1, ConvSum    );
    SetParm( 2, ConvSumRUR );

    if(   ( ConvCurr   != ANY_CURR )
       AND( ConvSum    != $0       )
       AND( ConvSumRUR != $0       )
      )
      return true;
    else
      return false;
    end;

  end;


  КодВалюты = int(Curr.ExternalCode);
  ClearSums();
  NameOperation = GetNameCodif( Reestr.Oper_Ref, CDF_Oper );

  /* некоторым функциям нужен Реестр */
  Copy( Реестр, Reestr );

  Sprv31Amount = Reestr.NumberSprv31;

  /* Восстанавливаем исходные суммы по операции */
  УчетНекассовыхОборотов( "По реестру", Reestr.IncomeSum, Reestr.OutSum );

  /* Заполнить суммы R_In, R_Out, MR_In, MR_Out, C_In ..... */
  Заполнить_суммы_по_реестру( R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  
  if( R_In or R_Out or MR_In or MR_Out or C_In or C_Out or MC_In or MC_Out or Q_In or Q_Out or UR_In or UR_Out or UC_In or UC_Out or UQ_In or UQ_Out )
    OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  end;

  if( ( Reestr.Oper_Ref == CDF_OperCurrConversion ) and
      ( Reestr.OutCurr_Ref == КодВалюты )
    )
    /* для конверсии при отработке второй валюты */
    /* не нужны комисси и налоги                 */
    return;
  end;

  if( GetTurnReestr( CDF_TurnPComInc ) ) /* процентная от полученной суммы */
    ClearSums();
    NameOperation = "Процентная комиссия";
    if( (TurnReestr.Curr_Ref == КодВалюты) and IsCur )
      Get_Curr_Rate( TurnReestr.Curr_Ref, КурсЦБ ); - использовать GetCurrRate()
      R_In = money( abs(TurnReestr.Sum) * КурсЦБ );
      C_In = abs(TurnReestr.Sum);
    elif( (TurnReestr.Curr_Ref == {NationalCur}) and (not IsCur) )
      R_In = abs(TurnReestr.Sum);
    end;
    if( ( C_In or R_In ) and Sprv31Amount )
      Q_Out = money( 100 * Sprv31Amount );
      Sprv31Amount = 0;
    end;
    if( C_In or R_In )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

  if( GetTurnReestr( CDF_TurnPComOut ) ) /* процентная от выданной суммы */
    ClearSums();
    NameOperation = "Процентная комиссия";
    if( (TurnReestr.Curr_Ref == КодВалюты) and IsCur )
      Get_Curr_Rate( TurnReestr.Curr_Ref, КурсЦБ ); - использовать GetCurrRate()
      R_In = money( abs(TurnReestr.Sum) * КурсЦБ );
      C_In = abs(TurnReestr.Sum);
    elif( (TurnReestr.Curr_Ref == {NationalCur}) and (not IsCur) )
      R_In = abs(TurnReestr.Sum);
    end;
    if( ( C_In or R_In ) and Sprv31Amount )
/*      Q_Out = $1;
      Sprv31Amount = Sprv31Amount - 1; */
      Q_Out = money( 100 * Sprv31Amount );
      Sprv31Amount = 0;
    end;
    if( C_In or R_In )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

  if( GetTurnReestr( CDF_TurnFix ) )
    ClearSums();
    NameOperation = "Фиксированная комиссия";
    if( (TurnReestr.Curr_Ref == КодВалюты) and IsCur )
      Get_Curr_Rate( TurnReestr.Curr_Ref, КурсЦБ ); - использовать GetCurrRate()
      R_In = money( abs(TurnReestr.Sum) * КурсЦБ );
      C_In = abs(TurnReestr.Sum);
    elif( (TurnReestr.Curr_Ref == {NationalCur}) and (not IsCur) )
      R_In = abs(TurnReestr.Sum);
    end;
    if( ( C_In or R_In ) and Sprv31Amount )
/*      ???Q_Out = $1;
      ???Sprv31Amount = Sprv31Amount - 1; */
      Q_Out = money( 100 * Sprv31Amount );
      Sprv31Amount = 0;
    end;
    if( C_In or R_In )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

  if( Reestr.TaxSum and (not IsCur) )
    ClearSums();
    NameOperation = "Налог";
    R_In = Reestr.TaxSum;
    OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  end;

  if( Reestr.IncTaxSum and (not IsCur) )
    ClearSums();
    NameOperation = "Подоходный налог";
    R_In = Reestr.IncTaxSum;
    OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  end;

  if( GetCnvCoinsTurns( ConvCurr, ConvSum, ConvSumRUR ) )
    ClearSums();
    NameOperation = "Б\\Н конверсия валютной мелочи";
    if( (ConvCurr == КодВалюты) and IsCur )
      Get_Curr_Rate( ConvCurr, КурсЦБ ); - использовать GetCurrRate()
      MR_In = money( ConvSum * КурсЦБ );
      MC_In = ConvSum;
    elif( not IsCur )
      R_Out = ConvSumRUR;
    end;
    if( MR_In or MC_In or R_Out )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

end;

/***************************************************************************
                   Отчет по одному виду валютообменных операций
                   ( по реестру )
***************************************************************************/
macro ReportOnOneExchangeReestr( TypeOperation )

  var OutCurr, IncCurr,
      Loop;
  var КодВалюты; /* Код валюты ОП */

  ClearRecord(Reestr);
  Reestr.ExchangeNumber = {ExBankNumber};
  Reestr.Emp_Ref        = Session.Emp_Ref;
  Reestr.Sess_Ref       = Session.Number;
  Reestr.Type_Ref       = RstTypes.Type;
  Reestr.OutCurr_Ref    = ANY_CURR;
  Reestr.IncomeCurr_Ref = ANY_CURR;
  Reestr.Rate_Ref       = 0;

  КодВалюты = int(Curr.ExternalCode);

  /* покупка валюты, ПД и неплатежеспособной валюты */
  if(   ( TypeOperation == CDF_OperCurrBuy        ) OR
        ( TypeOperation == CDF_OperPayDocBuy      ) OR
        ( TypeOperation == CDF_OperUnpayCurrBuy   ) )
     Reestr.OutCurr_Ref    = OutCurr = {NationalCur};
     Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
  /* продажа валюты и ПД за рубли */
  elif( ( TypeOperation == CDF_OperCurrSale       ) OR
        ( TypeOperation == CDF_OperPayDocSale     ) )
     Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
     Reestr.IncomeCurr_Ref = IncCurr = {NationalCur};
  /* покупка/продажа ПД за валюту */
  elif( ( TypeOperation == CDF_OperPayDocSaleCurr ) OR
        ( TypeOperation == CDF_OperPayDocBuyCurr  ) OR
  /* проверка на подлинность */
        ( TypeOperation == CDF_OperCheck          ) OR
  /* замена неплатежной валюты */
        ( TypeOperation == CDF_OperChange         ) OR
  /* размен валюты */
        ( TypeOperation == CDF_OperSplit        ) )
     Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
     Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
  /* принятие на инкассо и экспертизу */
  elif( ( TypeOperation == CDF_OperExpert         ) OR
        ( TypeOperation == CDF_OperIncasso        ) OR
        ( TypeOperation == CDF_OperPayDocExpert   ) OR
        ( TypeOperation == CDF_OperPayDocIncasso  ) OR
  /* получение по пластиковым картам */
        ( TypeOperation == CDF_OperCardTake     ) )
     Reestr.OutCurr_Ref    = OutCurr = ANY_CURR;
     Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
  /* конверсия */
  elif  ( TypeOperation == CDF_OperCurrConversion ) 
     Reestr.OutCurr_Ref    = OutCurr = ANY_CURR;
     Reestr.IncomeCurr_Ref = IncCurr = ANY_CURR;
  /* возврат с инкассо и экспертизы */
  elif( ( TypeOperation == CDF_OperReturnExpert        ) OR
        ( TypeOperation == CDF_OperReturnIncasso       ) OR
        ( TypeOperation == CDF_OperPayDocReturnExpert  ) OR
        ( TypeOperation == CDF_OperPayDocReturnIncasso ) OR
  /* выдача по пластиковым картам */
        ( TypeOperation == CDF_OperCardGive       ) )
     Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
     Reestr.IncomeCurr_Ref = IncCurr = ANY_CURR;
  end;
  
  Loop = GetGE( Reestr );

  While( ( Loop == True ) AND
         (Reestr.ExchangeNumber == {ExBankNumber})          AND
         (Reestr.Emp_Ref        == Session.Emp_Ref)         AND
         (Reestr.Sess_Ref       == Session.Number)          AND
         (Reestr.Type_Ref       == RstTypes.Type)
       )

    if( (
          ( (OutCurr != ANY_CURR) AND (Reestr.OutCurr_Ref == OutCurr) )  OR
          ( OutCurr == ANY_CURR )
        )
         AND
        (
          ( (IncCurr != ANY_CURR) AND (Reestr.IncomeCurr_Ref == IncCurr) ) OR
          ( IncCurr == ANY_CURR )
        )
      )

      if( ( TypeOperation != CDF_OperCurrConversion ) OR   /* или не Конверсия */
          ( Reestr.IncomeCurr_Ref == КодВалюты ) OR        /* или вал. прихода нужная */
          ( Reestr.OutCurr_Ref    == КодВалюты )           /* или вал. расхода нужная */
        )
        /* напечатаем заголовки (если надо) */
        OutExchangeHeaders( TypeOperation );
  
        /* начечатаем строку (несколько строк) по реестру */
        OutLinesOnReestr();

      end;

    end;

    Loop = Next( Reestr );

  end;

end;

*/