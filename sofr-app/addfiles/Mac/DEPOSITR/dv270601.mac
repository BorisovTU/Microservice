import deprintr, RSD;

file pd( "pay_doc.dbt" ) key 7;

private var   {curdate};
private const FNCash = NumFNCash;

var
    Name = "",
    CorrINN = "",
    Account = "",
    BankName = "",
    BankCode = "",
    CorrAccount = "",
    InSum,
    ClientLastName = "", ClientFirstName = "", ClientSecondName = "",
    Ground_rsd = "",
/* темповые переменны, используются для сравенения, инициализируется "1" для того чтобы первый раз рисовалась шапка */
    tmp_Name = "1",
    tmp_CorrINN = "1",
    tmp_Account = "1",
    tmp_BankName = "1",
    tmp_BankCode = "1",
    tmp_CorrAccount = "1";

/* Значения кода режима работы */
const MODE_NORMAL = 0;       /* Нормальный режим */
const MODE_EOY = 1;          /* Конец периода */
const MODE_EOY_PRECALC = 2;  /* Конец периода - документы предварительного расчета */
const MODE_GZ = 4;           /* Группа зачисления */
 
macro PrintHead;

 [
                                            РАСПОРЯЖЕНИЕ
                          на списание средств с корреспондентского счета


    Операция: Перевод средств без открытия счета
    Получатель: ####################        ИНН: #####################
    Расчетный счет:  #############################
    Банк получателя: #############################     БИК: ########################
    Кор.счет: ####################################

    ------------------------------------------------------------------------------------------------------
    | Сумма, руб |      Ф.И.О. плательщика        |      Основание       |       Назначение платежа      |
    ------------------------------------------------------------------------------------------------------
 ]
 (
    Name, CorrINN, Acc_Form(Account),
    BankName, BankCode, Acc_Form(CorrAccount)
 );

end;

macro PrintLine;
var Osnov, Ground, numpos;

 numpos = Index( Ground_rsd, "г." );
 if ( numpos != 0 )
   Osnov  = SubStr( Ground_rsd, 1, numpos+1 );
   Ground = SubStr( Ground_rsd, numpos+2 );
 else
   Ground = Ground_rsd;
   Osnov = "";
 end;

 [  |############|################################|######################|###############################|
    ------------------------------------------------------------------------------------------------------
 ]
 (  InSum,
    ClientLastName + " " + ClientFirstName + " " + ClientSecondName,
    Osnov:w,
    Ground:w
 );

end;

macro PrintFoot;

 [

     Главный бухгалтер                   /                  /

     Исполнитель                                             /                  /

                                                            Поставлено на позицию____________________
 ];
 print("");
end;

var 
   cmd_1,  
   rs_1,
   NoData=true;

cmd_1 = RsdCommand(
"select dRTPaymentProp_dbt.T_NAME,"+
"  dpay_doc_dbt.T_CORRINN,"+
"  dRTPaymentProp_dbt.T_ACCOUNT,"+
"  dRTPaymentProp_dbt.T_BANKNAME,"+
"  dRTPaymentProp_dbt.T_BANKCODE,"+
"  dRTPaymentProp_dbt.T_CORRACCOUNT,"+
"  dpay_doc_dbt.T_INSUM,"+
"  dpay_doc_dbt.T_CLIENTLASTNAME,"+
"  dpay_doc_dbt.T_CLIENTFIRSTNAME,"+
"  dpay_doc_dbt.T_CLIENTSECONDNAME,"+
"  dpay_doc_dbt.T_GROUND "+
" from dpay_doc_dbt, dRTPaymentProp_dbt "+
" where dpay_doc_dbt.T_GROUPOPERT = 11 "+
"  and dpay_doc_dbt.T_NUMOPERT = 42 "+
"  and dpay_doc_dbt.T_DATE_DOCUMENT = ? "+
"  and dpay_doc_dbt.T_FNCASH = ? "+
"  and dpay_doc_dbt.T_ISCUR = 0 "+
                     " and dpay_doc_dbt.T_CODCUR = 0" +  
                     " and dpay_doc_dbt.t_Mode != " + String(MODE_GZ) +
" order by  dRTPaymentProp_dbt.T_NAME,"+
"  dpay_doc_dbt.T_CORRINN,"+
"  dRTPaymentProp_dbt.T_ACCOUNT,"+
"  dRTPaymentProp_dbt.T_BANKNAME,"+
"  dRTPaymentProp_dbt.T_BANKCODE,"+
"  dRTPaymentProp_dbt.T_CORRACCOUNT"
);
 
  cmd_1.addParam("dpay_doc_dbt.T_DATE_DOCUMENT", RsdBp_in);
  cmd_1.value("dpay_doc_dbt.T_DATE_DOCUMENT") =  {curdate};

  cmd_1.addParam("dpay_doc_dbt.T_FNCASH", RsdBp_in);
  cmd_1.value("dpay_doc_dbt.T_FNCASH")=NumFNCash;

 cmd_1.execute;
 
rs_1 = RsdRecordset(cmd_1); 
 
  while( rs_1.moveNext )
         NoData=false;
    if(rs_1.value(0) != strFor(1) )
        Name = rs_1.value(0);
    else
        Name = ""; 
    end;

    if(rs_1.value(1) != strFor(1) ) 
        CorrINN = rs_1.value(1);
    else
        CorrINN = "";      
    end;
 
    if(rs_1.value(2) != strFor(1) )
        Account = rs_1.value(2);
    else
        Account = "";
    end;

    if(rs_1.value(3) != strFor(1) )
        BankName = rs_1.value(3);
    else
        BankName = "";
    end;

    if(rs_1.value(4) != strFor(1) )
        BankCode = rs_1.value(4);
    else
        BankCode = "";
    end;

    if(rs_1.value(5) != strFor(1) )
        CorrAccount = rs_1.value(5);
    else
        CorrAccount = "";     
    end;

    if(rs_1.value(6) != strFor(1) )
        InSum = rs_1.value(6);
    else
        InSum = "";
    end;

    if(rs_1.value(7) != strFor(1) )
        ClientLastName = rs_1.value(7);
    else
        ClientLastName = "";
    end;

    if(rs_1.value(8) != strFor(1) )
        ClientFirstName = rs_1.value(8); 
    else
        ClientFirstName = ""; 
    end;

    if(rs_1.value(9) != strFor(1) )
        ClientSecondName = rs_1.value(9);
    else
        ClientSecondName = "";
    end;

    if(rs_1.value(10) != strFor(1) )
        Ground_rsd = rs_1.value(10);
    else
        Ground_rsd = "";
    end;

if ( (tmp_Name != Name) OR
     (tmp_CorrINN != CorrINN) OR
     (tmp_Account != Account) OR
     (tmp_BankName != BankName) OR
     (tmp_BankCode != BankCode) OR
     (tmp_CorrAccount != CorrAccount) )
   PrintHead;
end;

   PrintLine;

    tmp_Name = Name;
    tmp_CorrINN = CorrINN;
    tmp_Account = Account;
    tmp_BankName = BankName;
    tmp_BankCode = BankCode;
    tmp_CorrAccount = CorrAccount;


 end;

if (not NoData)
PrintFoot;
end;

End.
