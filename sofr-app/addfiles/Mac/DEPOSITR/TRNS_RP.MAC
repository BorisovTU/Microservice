/**************************************************************************\
*  ---------------------                                                   *
*  R-Style Software Lab.                                                   *
*  ---------------------                                                   *
*  RS-Retail                                                               *
*                                                                          *
*  Налично-кассовые операции                                               *
*                                                                          *
*  Отчеты при приеме наличных денег для перевода                           *
*                                                                          *
*  Лебедев С.В.                                                            *
*  28.11.2000                                                              *
\**************************************************************************/

import BankInter, DeprIntr, DeskInter, InputRN, rtpm_lib, commclnt;

private record OC_PAY_DOC  ("pay_doc.n40" ); /* Глобальная переменная */
private record OC_PAY_DOC_PMNT_PROP("RTPaymentProp.dbt"); /* Глобальная переменная */
private record OC_PAY_KIND ("pay_kind.dbt"); /* Глобальная переменная */

private record pay_doc     ("pay_doc.dbt" );

private record rt_paym_fpm ("rt_paym.fpm");

record Parm        ( CashParm );

file   prsn        ( "person.dbt"   ) key 0;

file   sb_dtyp     ( "sb_dtyp.dbt"  ) key 2;
file   currency    ( "currency.dbt" ) key 0;
file   pay_corr    ( "pay_corr.dbt" ) key 0;

file   paprkind    ( "paprkind.dbt", "bank.def" ) key 0;
file   namealg     ( "namealg.dbt",  "bank.def" ) key 0;

var i_ddep  = TRecHandler( "i_dp_dep.rec" );
var i_party = TRecHandler( "i_party.rec" );

private var partcode = TBFile( "partcode.dbt", "r", 1 );
private var party    = TBFile( "party.dbt",    "r", 0 );
private var dp_dep   = TBFile( "dp_dep.dbt",   "r", 2 );
private var bankdprt = TBFile( "bankdprt.dbt", "r", 0 );
private var address  = TBFile( "adress.dbt",   "r", 1 );

private var country  = TBFile( "country.dbt", "R", 2, null, "bank.def" );

var Bank_Standart = GetBankStandart();

record dlg_inf ( "P_ADD143", "sbbank.lbr" ) dialog;

var {CNum};
var {curdate};
var OperBrigade = GetOperBrigade();

const CO_CommPay = 1;  /* Тип получателя: Коммунальные платежи */

const CASHOP_DEBET    = 5;
const TYPERES_VALFORM = 2;
const VALFORM_SPR31   = 31;

/* Коды клавиш. */
const KEY_F2    = 316;  /* Код нажатия клавиши F2. */
const KEY_F3    = 317;  /* Код нажатия клавиши F3. */
const KEY_F9    = 323;  /* Код нажатия клавиши F9. */
const KEY_SPACE =  32;  /* Код нажатия клавиши "Пробел". */
const KEY_ESC   =  27;  /* Код нажатия клавиши Esc. */

const RegP_RNT = "RS-RETAIL\\СЕРВИСНЫЕ\\АВТОНУМЕРАЦИЯ\\СЧЕТЧИК\\ЗАЯВЛЕНИЕ_О_ПЕРЕВОДЕ";

private var mark_RtPaym = FALSE;

private var vCodeKind = 3;  // Вид кода банка получателя.

private var flag_Order = 0;


macro MoneyToStr( CurrCode, Sum )
  file Curr( "currency.dbt" ) key 0;
  Curr.Code_Currency = CurrCode;
  if( GetEQ( Curr ) );
    return CurToStrAlt( Sum, null, null, Int( Curr.ExternalCode ) );
  end;
  return "";
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DateToStr( pDate )

  var d, m, y, Day, Month, Year;

  DateSplit( pDate, d, m, y );
  Day = String( d );

  if   (m ==  1) Month = " января ";
  elif (m ==  2) Month = " февраля ";
  elif (m ==  3) Month = " марта ";
  elif (m ==  4) Month = " апреля ";
  elif (m ==  5) Month = " мая ";
  elif (m ==  6) Month = " июня ";
  elif (m ==  7) Month = " июля ";
  elif (m ==  8) Month = " августа ";
  elif (m ==  9) Month = " сентября ";
  elif (m == 10) Month = " октября ";
  elif (m == 11) Month = " ноября ";
  elif (m == 12) Month = " декабря ";
  else           Month = "  ";
  end;

  Year = String(y);

  return Day + Month + Year + " г.";

end;

/**************************************************************************\
|                               Получение телефона                         |
\**************************************************************************/

macro GetPhoneNumberTrnsRp(ClntCode)
  var DepClnt = TClientList;
  var AddrTypes = TArray;
  var i = 0;
  var PhoneNumber = "";
  var PhoneNumber2 = "";
  
  if (DepClnt.GetRecord (clntCode))
    AddrTypes(0) = COMMCLNT_PTADDR_LEGAL;
    AddrTypes(1) = COMMCLNT_PTADDR_REAL;
    AddrTypes(2) = COMMCLNT_PTADDR_POST;

    while ((i < AddrTypes.Size) and (PhoneNumber == ""))
      PhoneNumber = commclnt_GetAddressField(DepClnt, AddrTypes(i), "PhoneNumber");
      PhoneNumber2 = commclnt_GetAddressField(DepClnt, AddrTypes(i), "PhoneNumber2");
      if ((PhoneNumber != "") and (PhoneNumber2 != ""))
        PhoneNumber = PhoneNumber + ", ";
      end;
      PhoneNumber = PhoneNumber + PhoneNumber2;
      i = i + 1;
    end;
  end;
  return PhoneNumber;
end;


/**************************************************************************\
|   Выпуск Заявления о переводе вклада для стандарта "Коммерческий банк"   |
\**************************************************************************/
macro PrintFormKB

 file rep_kb () txt write;

 var namefile = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true);

 array ASummaWr;
 array AConditions;

 var sBranchName = "";

 var FirstName     = "";
 var Name          = "";
 var Branch        = "";
 var CorAcc        = "";
 var BIK           = "";
 var rSummaWr      = "";
 var SummaWr       = "";
 var FirstNameRecp = "";
 var NameRecp      = "";
 var AddrRecp      = "";
 var Conditions    = "";
 var SummaComm     = "";
 var sISO          = "";
 var NamePass      = "";
 var i,j;

 /* Аттрибуты получателя */
 var sRecipName = "";
 var sRecipINN  = "";
 var sRecipKPP  = "";
 var sRecipAcc  = "";
 var sRecipBank = "";
 var sRecipBIC  = "";
 var sRecipCorr = "";

 var sOper = "";

 /* Поиск записи о подразделении */
 if ( findDepartment(OC_PAY_DOC.FNCash, null, i_ddep, i_party) )
   sBranchName = "В " + Trim( i_party.rec.Name ) + ", № " +
                        Trim( i_ddep.rec.Name );
 else
   sBranchName = "???";
 end;

 FirstName = StrUpr(Trim(OC_PAY_DOC.ClientLastName));
 Name = Trim(OC_PAY_DOC.ClientFirstName) + " " +
        Trim(OC_PAY_DOC.ClientSecondName);

 Branch = "_";
 CorAcc = "_";
 if (OC_PAY_DOC_PMNT_PROP.CorrAccount != "")
   if ((StrLen(OC_PAY_DOC_PMNT_PROP.CorrAccount   ) >= 20) AND
       (Index(OC_PAY_DOC_PMNT_PROP.CorrAccount,"/") ==  0)    )
     CorAcc = OC_PAY_DOC_PMNT_PROP.CorrAccount;
   else
     Branch = OC_PAY_DOC_PMNT_PROP.Branch;
   end;
 end;

 BIK = Trim(OC_PAY_DOC_PMNT_PROP.BankCode);
 if (BIK == "")
   BIK = "_";
 end;

 rSummaWr = String( OC_PAY_DOC.InSum:a );
 SummaWr = MoneyToStr( OC_PAY_DOC.CodCur, OC_PAY_DOC.InSum );
 StrSplit(SummaWr,ASummaWr,80,39,2);
 i = 0;
 while (i < 2)
   j = 1;
   while (j <= StrLen(ASummaWr(i)))
     if (SubStr(ASummaWr(i),j,1) == " ")
       StrSet(ASummaWr(i),j,"_");
     end;
     j = j + 1;
   end;
   if (ASummaWr(i) == "")
     ASummaWr(i) = "_";
   end;
   i = i + 1;
 end;

 if (OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc))
   FirstNameRecp = StrUpr(Trim(OC_PAY_DOC.FNameRecp));
   NameRecp = Trim(OC_PAY_DOC.NameRecp) + " " + Trim(OC_PAY_DOC.SNameRecp);
   AddrRecp = Trim(OC_PAY_DOC.AddrRecp);
   if (OC_PAY_DOC.PhoneRecp != "")
     AddrRecp = AddrRecp + "__тел." + OC_PAY_DOC.PhoneRecp
   end;

   if ((OC_PAY_DOC.TypeAccRecp != "") OR (OC_PAY_DOC_PMNT_PROP.Account != ""))
     Conditions = "При невостребовании перевода в течении одного месяца зачислите сумму";
     if (OC_PAY_DOC.TypeAccRecp != "")
       Conditions = Conditions + " на вклад ";
       sb_dtyp.FlagCur = NumFlagCur();
       sb_dtyp.Kind    = OC_PAY_DOC.TypeAccRecp;
       if (GetEQ(sb_dtyp))
         Conditions = Conditions + sb_dtyp.Name;
       else
         Conditions = Conditions + OC_PAY_DOC.TypeAccRecp;
       end;
     end;
     if (OC_PAY_DOC_PMNT_PROP.Account != "")
       Conditions = Conditions + " на счет " + OC_PAY_DOC_PMNT_PROP.Account;
     else
       Conditions = Conditions + " на \"новый\" счет";
     end;
     Conditions = Conditions + " на имя получателя."
   end;
   if ((OC_PAY_DOC.NotifPayer != "") AND (OC_PAY_DOC.NotifRecp != ""))
     Conditions = Conditions + " Прошу уведомить получателя и отправителя о поступлении перевода";
   elif (OC_PAY_DOC.NotifPayer != "")
     Conditions = Conditions + " Прошу уведомить отправителя о поступлении перевода";
   elif (OC_PAY_DOC.NotifRecp != "")
     Conditions = Conditions + " Прошу уведомить получателя о поступлении перевода";
   end;
 end;

 StrSplit(Conditions,AConditions,80,65,3);
 i = 0;
 while (i < 3)
   j = 1;
   while (j <= StrLen(AConditions(i)))
     if (SubStr(AConditions(i),j,1) == " ")
       StrSet(AConditions(i),j,"_");
     end;
     j = j + 1;
   end;
   if (AConditions(i) == "")
     AConditions(i) = "_";
   end;
   i = i + 1;
 end;

 SummaComm = OC_PAY_DOC.CommSum;
 if (OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc))
   SummaComm = SummaComm + OC_PAY_DOC.ComisNotifPayer +
                           OC_PAY_DOC.ComisNotifRecp +
                           OC_PAY_DOC.ComisRecpMessage;
 end;
 if (SummaComm == 0)
   SummaComm = " ";
 else
   /* Определение суммы прописью */
   if ( OC_PAY_DOC.CodCur )
     currency.Code_Currency = OC_PAY_DOC.CodCur;
     if ( GetEQ( currency ) )
       sISO = currency.Short_Name;
     else
       sISO = String( OC_PAY_DOC.CodCur );
     end;
   else
     sISO = "рублей";
   end;
   SummaComm = Trim(String(SummaComm:20:2:a)) + " " + sISO;
 end;

 namealg.iTypeAlg   = 938;
 namealg.iNumberAlg = OC_PAY_DOC.PersIDType;
 if (GetEQ(namealg))
   NamePass = namealg.szNameAlg;
 else
   NamePass = "Документ";
 end;
 if (StrLen(OC_PAY_DOC.PassportSer) > 0)
   NamePass = NamePass + "_серия_" + OC_PAY_DOC.PassportSer;
 end;
 if (StrLen(OC_PAY_DOC.PasportNumb) > 0)
   NamePass = NamePass + "_номер_" + OC_PAY_DOC.PasportNumb;
 end;

 if (StrLen(namefile) > 0)
   if (SubStr(namefile,StrLen(namefile),1) != "\\")
     namefile = namefile + "\\";
   end;
 end;

 namefile = namefile + "trns_kb." + String({CNum});

 Open(rep_kb,namefile);

 SetOutput(namefile,TRUE);

 /* Получение реквизитов получателя */
 ClearRecord( pay_corr );
 pay_corr.IsCur    = OC_PAY_DOC.IsCur;
 pay_corr.NumGroup = OC_PAY_DOC.GroupOpert;
 /* pay_corr.NumOper */
 /* pay_corr.CodCur */
 if ( GetGE( pay_corr )  AND
      ( pay_corr.IsCur    == OC_PAY_DOC.IsCur )  AND
      ( pay_corr.NumGroup == OC_PAY_DOC.GroupOpert ) )
   sRecipName = pay_corr.CorrName;
   sRecipINN  = pay_corr.CorrINN;
   /* sRecipKPP */
   sRecipAcc  = pay_corr.Account;
   sRecipBank = pay_corr.BankName;
   sRecipBIC  = pay_corr.BIK;
   sRecipCorr = pay_corr.CorrAccount;
 end;

 /* Чтение записи Операциониста */
 prsn.Oper = OC_PAY_DOC.Oper;
 if ( GetEQ( prsn ) )
   sOper = Trim( prsn.Name );
 else
   sOper = "???";
 end;

[
 #######################################  ##########################################
                                                    (фамилия, имя, отчество)
                                          ##########################################
                                                             (адрес)


                З А Я В Л Е Н И Е   О   П Е Р Е В О Д Е   В К Л А Д А

 ###################################################################################
                                     (цифрами и прописью)
 ###################################################################################
 - внесенную мною наличными деньгами

      Переведенную сумму
 - зачислите на счет №                          на имя
 ###################################################################################

 Реквизиты получателя:
 ##########################################  #######################################
 ##########################################  #######################################
 ##########################################
 ###################################################################################

 Доп. информация по переводу                 │  Если плата за перевод подлежит
                                             │   удержанию, то спишите ее с моего
                                             │   счета.
 __________________________________________  │  Плату за перевод вношу наличными
                                             │   ###################################
 __________________________________________  │

 Порядок взимания платы мне известен
 К заявлению прилагаю

 ___________________________________________________________________________________

 ___________________________________________________________________________________

 Подпись вкладчика или лица, внесшего наличные деньги за перевод ___________________
  ##############################################


 ------------------------------------------- ---------------------------------------
 Счет N                             │  Принято ____________/####################################
                             РАСЧЕТ │           контролер(оператор)
 Остаток вклада по счету:      по   │  ############
 Присоединено %%:           ПЕРЕВОДУ│
 ###################################│###############################################
 Сумма перевода: ###################                      ############
 ОСТАТКИ (после списания):
       вклада
       процентов
]
(
 sBranchName:w,
 ( "От гр. " + FirstName + " " + Name ):w,
 ( "проживающего: " + OC_PAY_DOC.ClientAddress ):w,
 ( "  Прошу перевести сумму  " + rSummaWr + "   " + SummaWr ):w,
 /* ( "- списав со счета №           " + FirstName + " " + Name ):w, */
 ( "- списав со счета №           " ),
 ( "- выдайте наличными деньгами гр. " + FirstNameRecp + " " + NameRecp ):w,
 ( "НАИМЕНОВАНИЕ: " + sRecipName ):w,
 ( "ИНН\\КПП " + sRecipINN + " \\ " + sRecipKPP ),
 ( "БАНК ПОЛУЧАТЕЛЯ: " + sRecipBank ):w,
 ( "БИК: " + sRecipBIC ),
 ( "КОР.СЧЕТ БАНКА: " + String(Acc_Form(sRecipCorr):f) ):w,
 ( "НАЗНАЧЕНИЕ ПЛАТЕЖА: " + OC_PAY_DOC.Ground ):w,
 ( "деньгами  в сумме " + SummaComm ):w,
 DateToStr( {curdate} ),
 sOper + "/",
 String( {curdate} ),
 ( "Удержана\\внесена наличными плата: " + String( OC_PAY_DOC.CommSum:a ) ):w,
 ( "Выписано платежное поручение № " ):w,
 String( OC_PAY_DOC.InSum:a ),
 String( OC_PAY_DOC.Date_Document )
);

 SetOutput(NULL);

 Close(rep_kb);

 ViewFile(rep_kb);

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetPaperKind ( paperCode )

  var retValue = "Документ";

  ClearRecord( paprkind );
  ReWind( paprkind );
  paprkind.PaperKind = paperCode;

  if ( GetEQ( paprkind ) )
    retValue = paprkind.Name;
  end;

  return retValue;

end;


/**************************************************************************\
|                        Разделение строки наклонными                      |
\**************************************************************************/
macro Str_Select( _Str )

 var i = 0, l = StrLen( _Str );
 var str = "/";

 while ( i < l )
   i = i + 1;
   str = str + SubStr( _Str, i, 1 ) + "/";
 end;

 return str;

end;

/****************************************************************/
/*             Проверка сообщения: не более 10 слов.            */
/****************************************************************/
macro Check_Words_10( SI )
  var Ret = CM_SAVE;
  var i = 1, k = 0, l = StrLen( SI );
  var sSymbol;
  var mBlank = TRUE, mCopy = TRUE;
  while ( ( i <= l )  AND  mCopy )
    sSymbol = SubStr( SI, i, 1 );
    if ( sSymbol == " " )
      mBlank = TRUE;
    else
      if ( mBlank )
        k = k + 1;
        if ( k == 11 )
          mCopy = FALSE;
          Ret = CM_IGNORE;
          MsgBox( "Текстовое сообщение не должно содержать более 10 слов." );
        end;
      end;
      mBlank = FALSE;
    end;
    i = i + 1;
  end;
  return Ret;
end;

/****************************************************************/
/*                   Обработка событий панели.                  */
/****************************************************************/
macro EventProcPr( dlg, cmd, id, key )

  if ( cmd == DLG_KEY )
    /* msgbox(key); */
    if   ( key == KEY_F2 )
      return Check_Words_10( dlg.Text );
      // CM_SAVE;
    //elif ( key == KEY_F9 )
    //  return CM_IGNORE;
    elif ( key == KEY_ESC )
      // panEscape = TRUE;
      return CM_CANCEL;
    end;
  end;
end;

/****************************************************************/
/*              Сокращение сообщения до 10 слов.                */
/****************************************************************/
macro Words_10( SI )
  var SO = "";
  var i = 1, k = 0, l = StrLen( SI );
  var sSymbol;
  var mBlank = TRUE, mCopy = TRUE;
  while ( ( i <= l )  AND  mCopy )
    sSymbol = SubStr( SI, i, 1 );
    if ( sSymbol == " " )
      mBlank = TRUE;
    else
      if ( mBlank )
        k = k + 1;
        if ( k == 11 )
          mCopy = FALSE;
        end;
      end;
      mBlank = FALSE;
    end;
    if ( mCopy )
      SO = SO + sSymbol;
    end;
    i = i + 1;
  end;
  return SO;
end;

/**************************************************************************\
|                        Атрибуты банка получателя.                        |
\**************************************************************************/
macro getRecipBank( pPartyID )
  // if ( BankVersion == 510 )
    party.rec.PartyID = pPartyID;
    return party.GetEQ();
  // end;
end;

/**************************************************************************\
|                        Атрибуты банка получателя.                        |
\**************************************************************************/
macro getRecipientBank( pPartyID )
  var stat = TRUE;
  // if ( BankVersion == 510 )
    dp_dep.rec.PartyID = pPartyID;
    dp_dep.rec.Code    = 0;
    stat = dp_dep.GetGE();
    if ( stat  AND  ( dp_dep.rec.PartyID != pPartyID ) )
      stat = FALSE;
    end;
  // end;
  return stat;
end;

/**************************************************************************\
|                        Атрибуты банка получателя.                        |
\**************************************************************************/
macro getRecipientBankAddr( pPartyID )
  var stat = TRUE;
  // if ( BankVersion == 510 )
    address.rec.Type    = 1;  // Юридический адрес.
    address.rec.PartyID = pPartyID;
    stat = address.GetEQ();
    if ( NOT stat )
      address.rec.Type    = 2;  // Фактический адрес.
      address.rec.PartyID = pPartyID;
      stat = address.GetEQ();
    end;
    if ( NOT stat )
      address.rec.Type    = 3;  // Почтовый адрес.
      address.rec.PartyID = pPartyID;
      stat = address.GetEQ();
    end;
  // end;
  return stat;
end;

/**************************************************************************\
|          Получение регистрационного номера заявления о переводе.         |
\**************************************************************************/
macro getRegNumTransf()
  var stat = 0;

  return stat;
end;

/**************************************************************************\
|       Выпуск формы 143 для стандарта работы "Сберегательный Банк РФ"     |
\**************************************************************************/
macro PrintForm143()

 file rep_143 () txt write;

 var namefile = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true );

 var depclnt = TClientList; /* Справочник вкладчиков */

 var sAddressF = "";
 var sAddressR = "";

 var sDeclarer = "";
 var sDeclPhone = "";
 var sPaper = "";
 var sPaperWho = "";
 var sPaperWhere = "";
 var sPaperSeries = "";
 var sPaperNumber = "";

 var sBranchName = "";
 var sBranchAddress = "";

 var sINN = "";

 var mResident = " ", mNotResident = " ";

 var sOper = "";

 var SummaComm = OC_PAY_DOC.CommSum;

 var mSummaNal, sSummaNal;

 var sRecipBankNum = "", sRecipBankAddr = "";

 /* Отметка способа получения перевода */
 var mPayAcc = " ", mPayOpen = " ", mPayNal = " ";
 /* Ф.И.О. получателя для разных способов получения перевода */
 var rPayAcc = "", rPayOpen = "", rPayNal = "";

 var sRecipAcc = "", sRecipTypeAcc = "";

 var NameRecp = "";

 var noUrgent = " ";
 var yesUrgent = " ";

 var mMessage = " ";

 // Атрибуты уведомления получателя\отправителя.
 var sText = "";
 // Получатель.
 var mR_PH = " ",
     mR_P  = " ",
     mR_S  = " ",
     mR_E  = " ";
 var sR_PHCOD = "", sR_PHNUM = "";
 var sR_PCOD  = "", sR_PNUM  = "", sR_PAB = "";
 var sR_SCOD  = "", sR_SNUM  = "";
 var sR_E     = "";
 // Отправитель.
 var mP_PH = " ",
     mP_P  = " ",
     mP_S  = " ",
     mP_E  = " ";
 var sP_PHCOD = "", sP_PHNUM = "";
 var sP_PCOD  = "", sP_PNUM  = "", sP_PAB = "";
 var sP_SCOD  = "", sP_SNUM  = "";
 var sP_E     = "";

 if ( OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc) )
   SummaComm = SummaComm + OC_PAY_DOC.ComisNotifPayer +
                           OC_PAY_DOC.ComisNotifRecp +
                           OC_PAY_DOC.ComisRecpMessage;
 end;

 /* mSummaNal = OC_PAY_DOC.InSum + SummaComm; */
 mSummaNal = OC_PAY_DOC.InSum;

 sSummaNal = MoneyToStr( OC_PAY_DOC.CodCur, mSummaNal );

 if ( OC_PAY_DOC.CodClient != 0 )
   if ( not depclnt.GetRecord( OC_PAY_DOC.CodClient ) )
     MsgBox( "Не найдена запись вкладчика с CodClient = ",
             OC_PAY_DOC.CodClient );
     Exit( 0 );
   end;
 end;

 if ( StrLen( namefile ) > 0 )
   if ( SubStr( namefile, StrLen(namefile), 1 ) != "\\" )
     namefile = namefile + "\\";
   end;
 end;

 namefile = namefile + "trns_143." + String({CNum});

 Open( rep_143, namefile );

 SetOutput( namefile, TRUE );

/*****  Лицевая сторона  *****/

 /* Аттрибуты Заявителя (Плательщика) */
 sDeclarer = StrUpr( Trim( OC_PAY_DOC.ClientLastName ) ) + " " +
             Trim( OC_PAY_DOC.ClientFirstName ) + " " +
             Trim( OC_PAY_DOC.ClientSecondName );

 if ( OC_PAY_DOC.CodClient != 0 )
   depclnt.CurRec.AdressType = 2;
   sAddressF = depclnt.CurRec.rec.Address;
   sAddressR = depclnt.CurRec.MakeFullStrAddress( );
   sDeclPhone = GetPhoneNumberTrnsRp(depclnt.CurRec.rec.CodClient );

   sPaperWho = depclnt.CurRec.rec.PaperIssuer;  /* Кем выдан паспорт */
   sPaperWhere = String( depclnt.CurRec.rec.PaperIssuedDate );  /* Когда выдан паспорт */
   sPaper = GetPaperKind( depclnt.CurRec.rec.PaperKind );
   sPaperSeries = Trim( depclnt.CurRec.rec.PaperSeries );
   sPaperNumber = Trim( depclnt.CurRec.rec.PaperNumber );

   sINN = Str_Select( depclnt.CurRec.rec.INN );
 else
   sAddressF = "";
   sAddressR = OC_PAY_DOC.ClientAddress;
   sDeclPhone = OC_PAY_DOC.ClientPhone;

   sPaperWho = OC_PAY_DOC.PassportIssuer;  /* Кем выдан паспорт */
   sPaperWhere = String( OC_PAY_DOC.PassportDate:m );  /* Когда выдан паспорт */
   sPaper = GetPaperKind( OC_PAY_DOC.PersIDType );
   sPaperSeries = Trim( OC_PAY_DOC.PassportSer );
   if ( FldIndex( OC_PAY_DOC, "PasportNumb") > 0 )
     sPaperNumber = Trim( OC_PAY_DOC.PasportNumb );
   else
     sPaperNumber = Trim( OC_PAY_DOC.PassportNumb );
   end;

   sINN = Str_Select( OC_PAY_DOC.INN_Payer );
 end;

 // Резидентность.
 if ( depclnt.CurRec.rec.NotResident == "" )  // Резидент.
   mResident = "V";
   mNotResident = " ";
 else
   mResident = " ";
   mNotResident = "V";
 end;

 /* Поиск записи о подразделении */
 if ( findDepartment(OC_PAY_DOC.FNCash, null, i_ddep, i_party) )
   sBranchName = Trim( i_ddep.rec.Name );
   sBranchAddress = Trim( i_party.rec.Address );
 else
   sBranchName = "???";
   sBranchAddress = "???";
 end;

 //  ************ Аттрибуты получателя.  **********************
 if ( OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc) )
   NameRecp = StrUpr(Trim(OC_PAY_DOC.FNameRecp)) + " " +
                     Trim(OC_PAY_DOC.NameRecp) + " " +
                     Trim(OC_PAY_DOC.SNameRecp);
 end;

 // Банк получателя.
 if ( getRecipientBank( rt_paym_fpm.PartyID ) )
   sRecipBankNum  = dp_dep.rec.Name;
 else
   sRecipBankNum  = "";
 end;

 // Адрес банка получателя.
 if ( getRecipientBankAddr( rt_paym_fpm.PartyID ) )
   sRecipBankAddr = address.rec.Adress;
 else
   sRecipBankAddr = "";
 end;

 /* Заполнение полей для разных способов получения перевода */
 if ( OC_PAY_DOC.ApplType == 2 )  /* Подоперация: без открытия счета */
   mPayAcc  = " ";
   mPayOpen = " ";
   mPayNal  = "V";
   rPayAcc  = "";
   rPayOpen = "";
   rPayNal  = NameRecp;
   sRecipAcc = "";
   sRecipTypeAcc = "";
 else  /* Подоперация: Во вклад банка */
   if   ( StrLen( Trim( OC_PAY_DOC_PMNT_PROP.Account ) ) > 0 )
     mPayAcc  = "V";
     mPayOpen = " ";
     mPayNal  = " ";
     rPayAcc  = NameRecp;
     rPayOpen = "";
     rPayNal  = "";
     sRecipAcc = Str_Select( Acc_Form( OC_PAY_DOC_PMNT_PROP.Account ) );
     sRecipTypeAcc = "";
   elif ( StrLen( Trim( OC_PAY_DOC.TypeAccRecp ) ) > 0 )
     mPayAcc  = " ";
     mPayOpen = "V";
     mPayNal  = " ";
     rPayAcc  = "";
     rPayOpen = NameRecp;
     rPayNal  = "";
     sRecipAcc = "";
     sRecipTypeAcc = Trim( OC_PAY_DOC.TypeAccRecp );
   else
     mPayAcc  = " ";
     mPayOpen = " ";
     mPayNal  = "V";
     rPayAcc  = "";
     rPayOpen = "";
     rPayNal  = NameRecp;
     sRecipAcc = "";
     sRecipTypeAcc = "";
   end;
 end;

 if ( GetBitFlag( OC_PAY_DOC.Flags, 4 ) )
   yesUrgent = "V";
 else
   noUrgent = "V";
 end;

[
                                                                                              ф.№ 143

##############################     ####################################################################


                                   ЗАЯВЛЕНИЕ О ПЕРЕВОДЕ

                               ┌─┐          ┌─┐
Категория перевода (выбрать): │#│ Простой  │#│ Срочный
                               └─┘          └─┘
    Прошу перевести в структурное подразделение Сбербанка России № ##########################################
#############################################################################################################
                                    (город, посёлок и т.п.)

+------+-----------------------------------------------------------------------------------------------------+
|      | ##################################################################################################  |
|      | ┌─┐                                (цифрами и прописью)                                             |
|      | │#│ ##############################################################################################  |
|      | └─┘                                                                                                 |
|      | ##################################################################################################  |
|      |                               (Ф.И.О. вкладчика полностью)                                          |
|      | ┌─┐                                                                                                 |
|  II  | │#│ ##############################################################################################  |
|      | └─┘                           (Ф.И.О. получателя полностью)                       ┌─┐               |
|      |                                                                                   │ │ резидент      |
|      |                                                                                   ├─┤               |
|      |                                                                                   │ │ нерезидент    |
|      |                                                                                   └─┘               |
+------+-----------------------------------------------------------------------------------------------------+

Назначение платежа (заполняется при переводе между резидентом и нерезидентом) ________________________________
                                                                                 (дарение; пожертвование;
______________________________________________________________________________________________________________
     алименты или выплаты на содержание детей; выплаты или компенсации, связанные с возмещением ущерба)
]
(
 ( "В структурное подразделение\nСбербанка России\n\n" +
   "№ " + sBranchName + ",\n" +
   "находящееся в: " + sBranchAddress + "\n" +
   "(место нахождения структурного подразделения - город, посёлок и т.д., " +
   "в котором находится вклад, или в котором вносятся наличные деньги " +
   "для перевода)\n\n\n" +
   "Регистрационный номер заявления " + String( getRegNumTransf() ) + "." ):w,

 ( "От: " + sDeclarer + "\n" +
   "\t(Ф.И.О. вкладчика/отправителя/наследника полностью)\n" +
   "адрес регистрации: " + sAddressR + "\n" +
   "адрес фактического проживания: " + sAddressF + "\n" +
   "телефон: " + sDeclPhone + "\n" +
   "ИНН (при наличии) " + sINN + "\n" +
   "┌─┐                    ┌─┐\n" +
   "│" + mResident + "│ резидент           │" + mNotResident + "│ нерезидент\n" +
   "└─┘                    └─┘\n" +
   "От имени вкладчика/отправителя/наследника по __________\n" +
   "_______________________________________________________\n" +
   "\t\t(реквизиты доверенности и т.п.)\n" +
   "_______________________________________________________\n" +
   "\t\t(Ф.И.О. представителя полностью)\n" +
   "документ, удостоверяющий личность отправителя / представителя /\n" +
   "наследника (вид): " + sPaper + "\n" +
   "серия " + sPaperSeries + " № " + sPaperNumber +
   "  выдан " + sPaperWho + ", " + sPaperWhere + "\n" +
   "\t\t\t\t(кем, когда)" ):w,

  noUrgent, yesUrgent,

  Trim( sRecipBankNum ) + ", находящееся",
  ( "в " + sRecipBankAddr ):w,

 ( "Внесённую наличными рублями сумму " + String( mSummaNal:a ) +
   "   " + sSummaNal ):w,

 mPayAcc,
 ( "зачислить на счёт № " + sRecipAcc ):w,
 rPayAcc:w,

 mPayNal,
 ( "выдать наличными рублями: " + rPayNal ):w
);

print("\f");  /* Разделитель страниц - сторон Заявления */

/*****  Оборотная сторона  *****/

 /* Чтение записи Операциониста */
 prsn.Oper = OC_PAY_DOC.Oper;
 if ( GetEQ( prsn ) )
   sOper = Trim( prsn.Name );
 else
   sOper = "???";
 end;

 // Атрибуты уведомления получателя\отправителя.

 if ( StrLen( OC_PAY_DOC.RecpMessage ) > 0 )
   mMessage = "V";
 else
   mMessage = " ";
 end;

 if ( ( flag_Order == 0 )  OR  // Первый выпуск формы.
      ( NOT mark_RtPaym ) )    // Запись rt_paym.fpm не прочитана.
   dlg_inf.Text = OC_PAY_DOC.RecpMessage;
   dlg_inf.R_PHNUM = OC_PAY_DOC.PhoneRecp;
   dlg_inf.P_PHNUM = sDeclPhone;

   if ( RunDialog( dlg_inf, "EventProcPr" ) )
     sText = Words_10( dlg_inf.Text );
     // Получатель.
     sR_PHCOD = dlg_inf.R_PHCOD;
     sR_PHNUM = dlg_inf.R_PHNUM;
     sR_PCOD  = dlg_inf.R_PCOD;
     sR_PNUM  = dlg_inf.R_PNUM;
     sR_PAB   = dlg_inf.R_PAB;
     sR_SCOD  = dlg_inf.R_SCOD;
     sR_SNUM  = dlg_inf.R_SNUM;
     sR_E     = dlg_inf.R_E;
     // Отправитель.
     sP_PHCOD = dlg_inf.P_PHCOD;
     sP_PHNUM = dlg_inf.P_PHNUM;
     sP_PCOD  = dlg_inf.P_PCOD;
     sP_PNUM  = dlg_inf.P_PNUM;
     sP_PAB   = dlg_inf.P_PAB;
     sP_SCOD  = dlg_inf.P_SCOD;
     sP_SNUM  = dlg_inf.P_SNUM;
     sP_E     = dlg_inf.P_E;
   end;

   // Уведомление получателя.
   if ( OC_PAY_DOC.NotifRecp != "" )
     if ( StrLen( sR_PHNUM ) > 0 )
       mR_PH = "V";
     end;
     if ( StrLen( sR_PNUM ) > 0 )
       mR_P  = "V";
     end;
     if ( StrLen( sR_SNUM ) > 0 )
       mR_S  = "V";
     end;
     if ( StrLen( sR_E ) > 0 )
       mR_E  = "V";
     end;
   else  // Уведомление получателя не требуется.
     mR_PH = " ";
     mR_P  = " ";
     mR_S  = " ";
     mR_E  = " ";
     sR_PHCOD = "";
     sR_PHNUM = "";
     sR_PCOD  = "";
     sR_PNUM  = "";
     sR_PAB   = "";
     sR_SCOD  = "";
     sR_SNUM  = "";
     sR_E     = "";
   end;

   // Уведомление отправителя.
   if ( OC_PAY_DOC.NotifPayer != "" )
     if ( StrLen( sP_PHNUM ) > 0 )
       mP_PH = "V";
     end;
     if ( StrLen( sP_PNUM ) > 0 )
       mP_P  = "V";
     end;
     if ( StrLen( sP_SNUM ) > 0 )
       mP_S  = "V";
     end;
     if ( StrLen( sP_E ) > 0 )
       mP_E  = "V";
     end;
   else  // Уведомление отправителя не требуется.
     mP_PH = " ";
     mP_P  = " ";
     mP_S  = " ";
     mP_E  = " ";
     sP_PHCOD = "";
     sP_PHNUM = "";
     sP_PCOD  = "";
     sP_PNUM  = "";
     sP_PAB   = "";
     sP_SCOD  = "";
     sP_SNUM  = "";
     sP_E     = "";
   end;

   if ( mark_RtPaym )
     rt_paym_fpm.Message = sText;
     // Получатель.
     rt_paym_fpm.R_PH_C  = sR_PHCOD;
     rt_paym_fpm.R_PH_N  = sR_PHNUM;
     rt_paym_fpm.R_P_C   = sR_PCOD;
     rt_paym_fpm.R_P_N   = sR_PNUM;
     rt_paym_fpm.R_AB    = sR_PAB;
     rt_paym_fpm.R_S_C   = sR_SCOD;
     rt_paym_fpm.R_S_N   = sR_SNUM;
     rt_paym_fpm.R_E     = sR_E;
     // Отправитель.
     rt_paym_fpm.P_PH_C  = sP_PHCOD;
     rt_paym_fpm.P_PH_N  = sP_PHNUM;
     rt_paym_fpm.P_P_C   = sP_PCOD;
     rt_paym_fpm.P_P_N   = sP_PNUM;
     rt_paym_fpm.P_AB    = sP_PAB;
     rt_paym_fpm.P_S_C   = sP_SCOD;
     rt_paym_fpm.P_S_N   = sP_SNUM;
     rt_paym_fpm.P_E     = sP_E;
     update( rt_paym );
   end;

 else  // Повторный выпуск формы.
   sText = rt_paym_fpm.Message;
   // Получатель.
   // Уведомление получателя.
   if ( OC_PAY_DOC.NotifRecp != "" )
     sR_PHCOD = rt_paym_fpm.R_PH_C;
     sR_PHNUM = rt_paym_fpm.R_PH_N;
     sR_PCOD  = rt_paym_fpm.R_P_C;
     sR_PNUM  = rt_paym_fpm.R_P_N;
     sR_PAB   = rt_paym_fpm.R_AB;
     sR_SCOD  = rt_paym_fpm.R_S_C;
     sR_SNUM  = rt_paym_fpm.R_S_N;
     sR_E     = rt_paym_fpm.R_E;
     if ( StrLen( sR_PHNUM ) > 0 )
       mR_PH = "V";
     end;
     if ( StrLen( sR_PNUM ) > 0 )
       mR_P  = "V";
     end;
     if ( StrLen( sR_SNUM ) > 0 )
       mR_S  = "V";
     end;
     if ( StrLen( sR_E ) > 0 )
       mR_E  = "V";
     end;
   else
     sR_PHCOD = "";
     sR_PHNUM = "";
     sR_PCOD  = "";
     sR_PNUM  = "";
     sR_PAB   = "";
     sR_SCOD  = "";
     sR_SNUM  = "";
     sR_E     = "";
     mR_PH = " ";
     mR_P  = " ";
     mR_S  = " ";
     mR_E  = " ";
   end;

   // Уведомление отправителя.
   if ( OC_PAY_DOC.NotifPayer != "" )
     sP_PHCOD = rt_paym_fpm.P_PH_C;
     sP_PHNUM = rt_paym_fpm.P_PH_N;
     sP_PCOD  = rt_paym_fpm.P_P_C;
     sP_PNUM  = rt_paym_fpm.P_P_N;
     sP_PAB   = rt_paym_fpm.P_AB;
     sP_SCOD  = rt_paym_fpm.P_S_C;
     sP_SNUM  = rt_paym_fpm.P_S_N;
     sP_E     = rt_paym_fpm.P_E;
     if ( StrLen( sP_PHNUM ) > 0 )
       mP_PH = "V";
     end;
     if ( StrLen( sP_PNUM ) > 0 )
       mP_P  = "V";
     end;
     if ( StrLen( sP_SNUM ) > 0 )
       mP_S  = "V";
     end;
     if ( StrLen( sP_E ) > 0 )
       mP_E  = "V";
     end;
   else
     sP_PHCOD = "";
     sP_PHNUM = "";
     sP_PCOD  = "";
     sP_PNUM  = "";
     sP_PAB   = "";
     sP_SCOD  = "";
     sP_SNUM  = "";
     sP_E     = "";
     mP_PH = " ";
     mP_P  = " ";
     mP_S  = " ";
     mP_E  = " ";
   end;

 end;

[

┌─┐
│#│ Передать следующее текстовое сообщение получателю/вкладчику (не более 10 слов):
└─┘
####################################################################################################

Уведомить о поступлении суммы перевода:

Получателя (вкладчика)                                   Отправителя (вкладчика)
┌─┐                                                      ┌─┐
│#│ по телефону:                                         │#│ по телефону:
└─┘                                                      └─┘
код ########## № #########################               код ########## № #########################
┌─┐                                                      ┌─┐
│#│ на пейджер: по телефону                              │#│ на пейджер: по телефону
└─┘                                                      └─┘
(код) ######## № #########################               (код) ######## № #########################
для абонента ##########################                  для абонента #######################
┌─┐                                                      ┌─┐
│#│ SMS-сообщением по телефону:                          │#│ SMS-сообщением по телефону:
└─┘                                                      └─┘
(код) ######## № ##########################              (код) ######## № #########################
┌─┐                                                      ┌─┐
│#│ на E-mail: #############################             │#│ на E-mail: #############################
└─┘                                                      └─┘

С установленными в Сбербанке России условиями совершения переводов, тарифами и порядком взимания платы
ознакомлен и согласен.

Плату за перевод, за передачу текстового сообщения и/или за уведомления о поступлении суммы перевода:

┌─┐
│V│ вношу наличными деньгами;
└─┘
┌─┐                    ┌─┐
│ │ списать со счёта:  │ │ с которого осуществляется перевод;
└─┘                    └─┘
                   ┌─┐
                   │ │ № /__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/.
                   └─┘

К заявлению прилагаю_____________________________________________________________________________________________
                     (доверенность, сберегательную книжку, документы, подтверждающие право на наследство и т.д.)

Сберегательную книжку, изъятую банком при переводе части вклада (новую, оформленную взамен
исписанной), хочу получить:
┌─┐
│ │ в структурном подразделении Сбербанка России, в котором принято настоящее заявление;
└─┘
┌─┐
│ │ в структурном подразделении Сбербанка России, где ведётся счёт по вкладу.
└─┘


                                                   ___________________________________________________________
                                                     (подпись вкладчика/отправителя/наследника/представителя)

                                                   ###########################################################

______________________________________________________________________________________________________________

Заявление проверено и принято к исполнению.


Контролер _____________________________ / #
                      подпись                   Ф.И.О.

                   "____" час. "____" мин. "____"_________________20___г.

М.П. (штамп)

]
(
 mMessage,
 sText:w,
 mR_PH,
 mP_PH,
 sR_PHCOD,
 sR_PHNUM,
 sP_PHCOD,
 sP_PHNUM,
 mR_P,
 mP_P,
 sR_PCOD,
 sR_PNUM,
 sP_PCOD,
 sP_PNUM,
 sR_PAB,
 sP_PAB,
 mR_S,
 mP_S,
 sR_SCOD,
 sR_SNUM,
 sP_SCOD,
 sP_SNUM,
 mR_E,
 sR_E,
 mP_E,
 sP_E,
 DateToStr( {curdate} ):c,
 sOper + " /"
);

 SetOutput( NULL );

 Close( rep_143 );

 ViewFile( rep_143 );

end;

/**************************************************************************\
|                             Название страны.                             |
\**************************************************************************/
private MACRO CountryName( CodeLat3 )

  var sCodeLat3;

  country.keynum( 2 );

  if ( StrLen( CodeLat3 ) > 0 )
    sCodeLat3 = CodeLat3;
  else
    sCodeLat3 = "RUS";
  end;

  country.clear();
  country.rec.CodeLat3 = sCodeLat3;
  if( country.getEQ() )
    return country.rec.Name;
  end;

  return "";

END;

/**************************************************************************\
|                             Название страны.                             |
\**************************************************************************/
/*
private MACRO CountryNameCyr( CodeCyr3 )

  var sCodeCyr3;

  country.keynum( 0 );

  if ( StrLen( CodeCyr3 ) > 0 )
    sCodeCyr3 = CodeCyr3;
  else
    sCodeCyr3 = "RUS";
  end;

  country.clear();
  country.rec.CodeCyr3 = sCodeCyr3;
  if( country.getEQ() )
    return country.rec.Name;
  end;

  return "";

END;
*/

/**************************************************************************\
|       Выпуск формы 364 для стандарта работы "Сберегательный Банк РФ"     |
\**************************************************************************/
macro PrintForm364()

 file rep_364 () txt write;

 var namefile = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true );

 var depclnt = TClientList; /* Справочник вкладчиков */

 var sDeclarerRUS = "", sDeclarerLAT = "";

 var L1 = "1                                                                                                                                                                                                                                  ";
 var L2 = "2                                                                                                                                                                                                                                  ";
 var L3 = "3                                                                                                                                                                                                                                  ";

 var sBranchNum = "", sBranchName = "", sBranchAddress = "";

 var sSum, lSum, sSumma;

 var sISO = "";

 var sAddressF    = "";
 var sAddressR    = "";
 var sDeclPhone   = "";
 var sPaperWho    = "";
 var sPaperWhere  = "";
 var sPaper       = "";
 var sPaperSeries = "";
 var sPaperNumber = "";
 var sINN         = "";

 var mResident = " ", mNotResident = " ";

 // Аттрибуты получателя.
 var sRecipName   = "";
 var sRecipINN    = "";
 var sRecipKPP    = "";
 var sRecipAcc    = "";
 var sRecipBank   = "";
 var sRecBankAddr = "";
 var sRecBankCity = "";
 var sRecBankCntr = "";
 var sRecipBIC    = "";
 var sRecipCorr   = "";

 var sOper = "";

 if ( StrLen( namefile ) > 0 )
   if ( SubStr( namefile, StrLen(namefile), 1 ) != "\\" )
     namefile = namefile + "\\";
   end;
 end;

 namefile = namefile + "trns_143." + String({CNum});

 Open( rep_364, namefile );

 SetOutput( namefile, TRUE );

 if ( OC_PAY_DOC.CodClient != 0 )
   if ( not depclnt.GetRecord( OC_PAY_DOC.CodClient ) )
     MsgBox( "Не найдена запись вкладчика с CodClient = ",
             OC_PAY_DOC.CodClient );
     Exit( 0 );
   end;
 end;

 /* Поиск записи о подразделении */
 if ( findDepartment(OC_PAY_DOC.FNCash, null, i_ddep, i_party) )
   sBranchNum = Trim( i_ddep.rec.Name );
   sBranchName = Trim( i_party.rec.Name );
   sBranchAddress = Trim( i_party.rec.Address );
 else
   sBranchName = "???";
   sBranchAddress = "???";
 end;

 /* Аттрибуты Заявителя (Плательщика) */
 sDeclarerRUS = StrUpr( Trim( OC_PAY_DOC.ClientLastName ) ) + " " +
                Trim( OC_PAY_DOC.ClientFirstName ) + " " +
                Trim( OC_PAY_DOC.ClientSecondName );

 if ( TransLiteration( Trim( OC_PAY_DOC.ClientLastName ),
                       Trim( OC_PAY_DOC.ClientFirstName ),
                       Trim( OC_PAY_DOC.ClientSecondName ),
                       L1, L2, L3 ) == 0 )
   sDeclarerLAT = L1 + " " + L2 + " " + L3;
 else
   sDeclarerLAT = "";
 end;

 if ( OC_PAY_DOC.CodClient != 0 )
   depclnt.CurRec.AdressType = 2;
   sAddressF = depclnt.CurRec.rec.Address;
   sAddressR = depclnt.CurRec.MakeFullStrAddress( );
   sDeclPhone = GetPhoneNumberTrnsRp(depclnt.CurRec.rec.CodClient );

   sPaperWho = depclnt.CurRec.rec.PaperIssuer;  /* Кем выдан паспорт */
   sPaperWhere = String( depclnt.CurRec.rec.PaperIssuedDate:m );  /* Когда выдан паспорт */
   sPaper = GetPaperKind( depclnt.CurRec.rec.PaperKind );
   sPaperSeries = Trim( depclnt.CurRec.rec.PaperSeries );
   sPaperNumber = Trim( depclnt.CurRec.rec.PaperNumber );

   sINN = Str_Select( depclnt.CurRec.rec.INN );
 else
   sAddressF = "";
   sAddressR = OC_PAY_DOC.ClientAddress;
   sDeclPhone = OC_PAY_DOC.ClientPhone;

   sPaperWho = OC_PAY_DOC.PassportIssuer;  /* Кем выдан паспорт */
   sPaperWhere = String( OC_PAY_DOC.PassportDate:m );  /* Когда выдан паспорт */
   sPaper = GetPaperKind( OC_PAY_DOC.PersIDType );
   sPaperSeries = Trim( OC_PAY_DOC.PassportSer );
   if ( FldIndex( OC_PAY_DOC, "PasportNumb") > 0 )
     sPaperNumber = Trim( OC_PAY_DOC.PasportNumb );
   else
     sPaperNumber = Trim( OC_PAY_DOC.PassportNumb );
   end;

   sINN = Str_Select( OC_PAY_DOC.INN_Payer );
 end;

 // Сумма.
 sSum = String(OC_PAY_DOC.InSum:a);
 lSum = StrLen( sSum );
 sSumma = SubStr( sSum, 1, lSum-3 ) + "=" + SubStr( sSum, lSum-1, 2 );

 // Код валюты.
 currency.Code_Currency = OC_PAY_DOC.CodCur;
 if ( GetEQ( currency ) )
   sISO = currency.Short_Name + " (" + currency.Name_Currency + ")";
 else
   sISO = String( OC_PAY_DOC.CodCur );
 end;

 // Резидентность.
 if ( depclnt.CurRec.rec.NotResident == "" )  // Резидент.
   mResident = "V";
   mNotResident = " ";
 else
   mResident = " ";
   mNotResident = "V";
 end;

 /* Получение реквизитов получателя */
 ClearRecord( pay_corr );
 pay_corr.IsCur    = OC_PAY_DOC.IsCur;
 pay_corr.NumGroup = OC_PAY_DOC.GroupOpert;
 /* pay_corr.NumOper */
 /* pay_corr.CodCur */
 if ( GetGE( pay_corr )  AND
      ( pay_corr.IsCur    == OC_PAY_DOC.IsCur )  AND
      ( pay_corr.NumGroup == OC_PAY_DOC.GroupOpert ) )
   sRecipName = pay_corr.CorrName;
   sRecipINN  = pay_corr.CorrINN;
   /* sRecipKPP */
   sRecipAcc  = Acc_Form(pay_corr.Account);
   sRecipBank = pay_corr.BankName;
   sRecipBIC  = pay_corr.BIK;
   sRecipCorr = pay_corr.CorrAccount;
 end;

 if ( getRecipBank( rt_paym_fpm.PartyID ) )
   sRecipBank = party.rec.Name;
 end;

 if ( getRecipientBankAddr( rt_paym_fpm.PartyID ) )
   sRecBankAddr = address.rec.Adress;
   sRecBankCity = address.rec.Place;
   sRecBankCntr = CountryName( address.rec.Country );
 end;

 // Чтение записи операциониста.
 prsn.Oper = OC_PAY_DOC.Oper;
 if ( GetEQ( prsn ) )
   sOper = Trim( prsn.Name );
 else
   sOper = "???";
 end;

 [
                                                                                       ф. №364

  В структурное подразделение Сбербанка России
  № #################################             Регистрационный номер заявления #################
  #######################################
  (наименование филиала Сбербанка России)


                                 Заявление о международном переводе

  __________________________________________________________________________________________
  Перечислите сумму

  1. Сумма цифрами  ####################   2. Вид валюты #######################################
                                                                    (наименование валюты)
  ┌─┐
  │ │ - списав с моего счета №
  └─┘
  ┌─┐
  │V│ - перевод без открытия счета
  └─┘

  __________________________________________________________________________________________
  Отправитель
  ┌─┐                                                      ┌─┐
  │#│ - Резидент    3. ИНН (при наличии) ##############    │#│ - Нерезидент
  └─┘                                                      └─┘

  ##########################################################################################

  ##########################################################################################

  6. Фамилия, имя и отчество (при его наличии) представителя русскими буквами ______________

  __________________________________________________________________________________________

  7. Реквизиты доверенности представителя __________________________________________________

  __________________________________________________________________________________________

  ##########################################################################################

  ##########################################################################################
  __________________________________________________________________________________________

  ########################################################################################

  ########################################################################################

  14. Адрес представителя

  15. Телефон

                  код страны              код региона             номер телефона
  __________________________________________________________________________________________
  Получатель

  16. Фамилия, имя и отчество (при его наличии) или наименование (для юр. лица) получателя
  ########################################################################################

  17. ИНН (при наличии)

  ┌─┐
  │ │ - на счет  № /__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/__/
  └─┘
  __________________________________________________________________________________________

  ┌─┐
  │V│ - выдать наличными деньгами     18. Документ, удостоверяющий личность  _______________
  └─┘

  19.Серия                20.Номер                21.Выдан

  22. Адрес
                                    ( с обязательным указанием города, страны)
  __________________________________________________________________________________________
  Банк получателя

  23. SWIFT-код ############                24. Клиринговый код банка ______________________

  25. Номер корреспонденского счета ########################################################

  ##########################################################################################

  ##########################################################################################

  ##########################################################################################
 ]
 (
   sBranchNum,
   String( getRegNumTransf() ),
   sBranchName:w,
   sSumma,
   sISO:w,
   mResident,
   sINN,
   mNotResident,
   ( "4. Фамилия, имя и отчество (при его наличии) отправителя русскими буквами  " +
     sDeclarerRUS ):w,
   ( "5. Фамилия, имя и отчество (при его наличии) отправителя латинскими буквами  " +
     sDeclarerLAT ):w,
   ( "8. Документ, удостоверяющий личность (отправителя/представителя)  " +
     sPaper ):w,
   ( "9.Серия " + sPaperSeries +
     "  10.Номер " + sPaperNumber +
     "  11.Выдан " + sPaperWho + ", " + sPaperWhere ):w,
   ( "12. Адрес отправителя  " + sAddressR ):w,
   ( "13. Город, страна  " + CountryName( OC_PAY_DOC.ClientCountry ) ):w,
   Trim( OC_PAY_DOC_PMNT_PROP.Name ),
   Trim( OC_PAY_DOC_PMNT_PROP.BankCode ),
   Acc_Form( OC_PAY_DOC_PMNT_PROP.CorrAccount ),
   ( "26. Наименование банка " + Trim( sRecipBank ) ):w,
   ( "27. Адрес " + Trim( sRecBankAddr ) ):w,
   ( "28. Город, страна " + Trim( sRecBankCity ) + ", " + Trim( sRecBankCntr ) ):w
 );

 // print("\f");  /* Разделитель страниц - сторон Заявления */

 [
  __________________________________________________________________________________________
  Банк посредник (при наличии)

  29. SWIFT-код ________                    30. Клиринговый код банка ______________________

  31. Наименование банка _______________

  32. Адрес _______________

  33. Город, страна

  __________________________________________________________________________________________
  Цель перевода


  Подтверждаю, что данный перевод не связан с осуществлением мною предпринимательской деятельности,
  не связан с расчетами в иностранной валюте между резидентами (за исключением переводов без
  открытия счета, со счета в сумме не превышающей эквивалента 5.000 долларов США, а также дарения
  валютных ценностей супругу и близким родственникам, Российской Федерации, субъекту Российской
  Федерации и/или мунициальному образованию) и не требует проведения операции по специальному
  банковскому счету "Ф".


  Код валютной операции (заполняется при переводе нерезидентом)  {                     }
  __________________________________________________________________________________________
  Дополнительные услуги

  ┌─┐
  │ │ - осуществить перевод суммы платежа в полном объеме (услуга FULLPAY)
  └─┘
  ┌─┐
  │ │ - осуществить международный  срочный перевод
  └─┘
  ┌─┐
  │ │ - проконвертировать иностранную валюту перевода в валюту счета получателя (при срочном
  └─┘   переводе не заполняется)
  ┌─┐
  │ │ - уведомить получателя по телефону  _________________
  └─┘
  ┌─┐
  │ │ - уведомить получателя с помощью средств элетронной связи   ______________________________
  └─┘
  ┌─┐
  │ │ -  _________________
  └─┘
  __________________________________________________________________________________________
  Расходы по переводу

                 ПОРЯДОК ВЗИМАНИЯ ПЛАТЫ ЗА ПЕРЕВОД МНЕ ИЗВЕСТЕН. ПЛАТУ ЗА ПЕРЕВОД:

  ┌─┐
  │ │ - спишите с моего счета №
  └─┘
  ┌─┐
  │ │ - вношу наличными деньгами
  └─┘
  ┌─┐
  │ │ - удержать из суммы перевода
  └─┘

  ДОПОЛНИТЕЛЬНУЮ ПЛАТУ, ВЗИМАЕМУЮ ДРУГИМИ БАНКАМИ ПРИ ПРОХОЖДЕНИИ ЧЕРЕЗ НИХ ПЕРЕВОДА, ПРОШУ:

  ┌─┐
  │ │ - списать с моего счета №
  └─┘
  ┌─┐
  │ │ - получить с получателя перевода (обязательно указывается при переводе без открытия счета)
  └─┘

  ПРИ НЕВОЗМОЖНОСТИ ВОЗМЕЩЕНИЯ ДОПОЛНИТЕЛЬНОЙ ПЛАТЫ С ПОЛУЧАТЕЛЯ ПЕРЕВОДА ИЛИ С МОЕГО
  СЧЕТА, ОБЯЗУЮСЬ УПЛАТИТЬ ЕЁ НАЛИЧНЫМИ ДЕНЬГАМИ.

  __________________________________________________________________________________________

  Согласен с тем, что банк не отвечает за действия и размер удержанного комиссионного вознаграждения
  банков-корреспондентов и банков-посредников, за последствия ошибочных указаний в тексте данного
  заявления, а также за другие обстоятельства, не зависящие от банка и могущие повлечь за собой
  непоступление перевода по назначению.


  С условиями совершения Сбербанком России данного перевода ознакомлен и согласен.

  К заявлению прилагаю следующие документы: ________________________________________________

  __________________________________________________________________________________________

  "___________" __________________ _______________ г. ______________________________________
                                                       (подпись отправителя/представителя)

  __________________________________________________________________________________________
  Отметки банка

  Заявление проверено и принято к исполнению.  Контролер

                                               ______________  / ##############################################
                                                 (подпись)                (Ф.И.О.)

                  М. П.                         "_____" _______________________ __________ г.

  Время приема заявления (только для международных срочных переводов)

  Контроль перевода осуществлен. Уполномоченный работник

                                               ______________  /  __________________________
                                                 (подпись)                (Ф.И.О.)

 ]
 (
   sOper + " /"
 );

 SetOutput( NULL );

 Close( rep_364 );

 ViewFile( rep_364 );

end;


/**************************************************************************\
|                             Печать формы 31                              |
\**************************************************************************/
macro PrintForm31

  var SumF31    = $0L;
  var Day,Month,Year;
  var d,m,y;
  var KvitFrom    = "";
  var KvitFor     = "";
  var KvitForAppl = "";
  var KvitType    = "Наличные деньги";
  var SumRub, SumCop, SumWr;
  var strTmp, rub = "",kop = "" ,sRub = "", sKop = "";

  DateSplit(OC_PAY_DOC.Date_Document,d,m,y);
  /* День */
  Day = String(d);
  /* Год */
  if (y < 2000)
    y = y - 1900;
  else
    y = y - 2000;
  end;
  Year = String(y);
  if (StrLen(Year) < 2)
    Year = "0" + Year;
  end;
  /* Месяц */
  if (m == 1)
    Month = "января";
  elif (m == 2)
    Month = "февраля";
  elif (m == 3)
    Month = "марта";
  elif (m == 4)
    Month = "апреля";
  elif (m == 5)
    Month = "мая";
  elif (m == 6)
    Month = "июня";
  elif (m == 7)
    Month = "июля";
  elif (m == 8)
    Month = "августа";
  elif (m == 9)
    Month = "сентября";
  elif (m == 10)
    Month = "октября";
  elif (m == 11)
    Month = "ноября";
  elif (m == 12)
    Month = "декабря";
  else
    Month = "???";
  end;
  /* Принято от */
  KvitFrom = OC_PAY_DOC.ClientLastName + " " + OC_PAY_DOC.ClientFirstName + " " +
             OC_PAY_DOC.ClientSecondName;
  /* Принято для */
  if (OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc))
    KvitFor = "Перевод ";
    if (StrLen(OC_PAY_DOC_PMNT_PROP.BankName) > 0)
      KvitFor = KvitFor + "в " + OC_PAY_DOC_PMNT_PROP.BankName;
    end;
    if (OC_PAY_DOC.FNameRecp != "")
      KvitFor = KvitFor + "для " + OC_PAY_DOC.FNameRecp;
      if (StrLen(OC_PAY_DOC.NameRecp) > 0)
        KvitFor = KvitFor + " " + SubStr(OC_PAY_DOC.NameRecp,1,1) + ".";
        if (StrLen(OC_PAY_DOC.SNameRecp) > 0)
          KvitFor = KvitFor + SubStr(OC_PAY_DOC.SNameRecp,1,1) + ".";
        end;
      end;
    end;
  end;

  if (OC_PAY_DOC.InSum > 0)
    KvitForAppl = KvitForAppl + "Перевод "  + String(OC_PAY_DOC.InSum:0:2:a) + " ";
  end;
  if (OC_PAY_DOC.CommSum > 0)
    KvitForAppl = KvitForAppl + "Плата "  + String(OC_PAY_DOC.CommSum:0:2:a) + " ";
  end;
  if ((OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc)) AND (OC_PAY_DOC.ComisNotifPayer > 0))
    KvitForAppl = KvitForAppl + "За увед.плат. "  + String(OC_PAY_DOC.ComisNotifPayer:0:2:a) + " ";
  end;
  if ((OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc)) AND (OC_PAY_DOC.ComisNotifRecp > 0))
    KvitForAppl = KvitForAppl + "За увед.пол. "  + String(OC_PAY_DOC.ComisNotifRecp:0:2:a) + " ";
  end;
  if ((OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc)) AND (OC_PAY_DOC.ComisRecpMessage > 0))
    KvitForAppl = KvitForAppl + "За текст.сооб. "  + String(OC_PAY_DOC.ComisRecpMessage:0:2:a) + " ";
  end;

  if (OC_VARLEN == GetRecordSize(OC_PAY_DOC) - GetRecordSize(pay_doc))
    SumF31 = OC_PAY_DOC.InSum           +
             OC_PAY_DOC.CommSum         +
             OC_PAY_DOC.ComisNotifPayer +
             OC_PAY_DOC.ComisNotifRecp  +
             OC_PAY_DOC.ComisRecpMessage;

  else
    SumF31 = OC_PAY_DOC.InSum + OC_PAY_DOC.CommSum;
  end;

  /* Определение суммы прописью */
  currency.Code_Currency = OC_PAY_DOC.CodCur;
  if ( GetEQ( currency ) )

    strTmp = CurToStrAlt( SumF31, rub, kop, Int( currency.ExternalCode ) );

    if ( ( StrLen( kop ) > 0 ) and ( Index( strTmp, kop ) > 0 ) )
      sKop = Trim( SubStr( strTmp, Index( strTmp, kop ) + StrLen( kop ) ) );
      if ( Index( sKop, "?" ) > 0 )
        sKop = "";
      end;
    end;

    sRub = currency.Short_Name;
    if ( StrUpr( currency.Short_Name ) == "RUR" )
      sRub = "руб.";
      sKop = "коп.";
    end;
  else
    strTmp = RubToStr( SumF31, rub, kop );
    sRub = "   ";
    sKop = "";
  end;

  if ( SumF31 < $1.0 )
    rub = "Ноль";
  end;

  SumWr = rub + " " + sRub + " " + kop + " " + sKop;

  SumCop = kop;
  SumRub = String( SumF31 );
  if ( Index( SumRub, "." ) > 0 )
    SumRub = SubStr( SumRub, 1, Index( SumRub, "." ) - 1 );
  end;


  print( "\x1b0" ); /* Режим печати - 8 строк на дюйм */
  [

                    #   #              #

      #
    #
    #

    #


                #                     #

    #
  ]
  (Day:l,Month:l,Year:l,KvitFrom:l,KvitFor:l,KvitForAppl:l,KvitType:l,SumRub:l,SumCop:l,SumWr:l);
  print(""); /* End of page */

end;


/**************************************************************************\
|                          Получить связанного кассира                     |
\**************************************************************************/
macro GetPatern (Oper)

  file GroupMem (groupmem) key 0;

  GroupMem.Branch = NumRealFNCash;
  GroupMem.Date   = {curdate};
  GroupMem.Group  = OperBrigade;
  GroupMem.Oper   = Oper;
  if (GetEQ(GroupMem))
    return GroupMem.Linked;
  else
    return 0;
  end;

end;


/**************************************************************************\
|                       Расход ресурса БСО ф.31 по кассе                   |
\**************************************************************************/
macro OutDeskResource31

  var stat     = TRUE;
  var ExitFlag = FALSE;
  var Retry    = FALSE;

  ClearRecord(Parm);
  Parm.Type             = 0;       /* Платежеспосбные ресурсы */
  Parm.TypeValue        = TYPERES_VALFORM;
  Parm.CodIntValue      = VALFORM_SPR31;
  Parm.Oper             = OC_PAY_DOC.Oper;
  Parm.CashDateDoc      = OC_PAY_DOC.Date_Document;
  Parm.NumOper          = CASHOP_DEBET;
  Parm.ValueCol         = 1;
  Parm.NumbDocumCash    = OC_PAY_DOC.NDoc;
  Parm.ApplicationKind  = OC_PAY_DOC.iApplicationKind;
  Parm.ApplicationKey   = OC_PAY_DOC.ApplicationKey;
  Parm.Series           = "";
  Parm.MinRegistrNumber = 0;
  Parm.OperPatern       = GetPatern(OC_PAY_DOC.Oper);
  while (not ExitFlag)
    /* Для перечислений номер ф.31 попытаемся взять из записи */
    if ((OC_PAY_DOC.GroupOpert == 11) OR (OC_PAY_DOC.GroupOpert == 41))
      if ((StrLen(Trim(OC_PAY_DOC.KvitSer )) > 0) OR
          (StrLen(Trim(OC_PAY_DOC.KvitNumb)) > 0)   )
        Parm.Series           = OC_PAY_DOC.KvitSer;
        Parm.MinRegistrNumber = OC_PAY_DOC.KvitNumb;
      end;
    end;
    if (Parm.MinRegistrNumber == 0)
      stat = InputRegNum(OC_PAY_DOC.Oper,
                         Parm.Oper,
                         TYPERES_VALFORM,
                         VALFORM_SPR31,
                         "Введите номер справки ф.31:",
                         Parm.Series,
                         Parm.MinRegistrNumber);
    end;
    if (stat)
      stat = InitCashDoc(Parm);
    end;
    if (stat)
      ExitFlag = TRUE;
    else
      Retry = FALSE;
      GetTrue(Retry,"Ошибка при расходе. Повторить ?");
      if (Retry)
        Parm.MinRegistrNumber = 0;
      else
        ExitFlag = true;
      end;
    end;
  end;

  return stat;

end;

/**************************************************************************\
|     Определение кода типа банка - Сбербанк, АКБ, РКЦ или что-то еще      |
\**************************************************************************/
macro is_SB( BIK )
  var stat = TRUE;
  var flag;

  // if ( BankVersion == 510 )
    partcode.rec.CodeKind = vCodeKind;
    partcode.rec.Code     = BIK;
    flag = partcode.GetEQ();
    if ( flag )
      bankdprt.rec.PartyID = partcode.rec.PartyID;
      flag = bankdprt.GetEQ();
      if ( flag )
        if ( bankdprt.rec.UERType != 3 )  // Не Сбербанк РФ.
          stat = FALSE;
        end;
      end;
    end;
  // end;

  return stat;
end;


/**************************************************************************\
|                    Г Л А В Н А Я    П Р О Г Р А М М А                    |
\**************************************************************************/

  var stat = TRUE;

  OC_RESULT = 1;

  if ( rtpaymFindByAttrID( OC_PAY_DOC.iApplicationKind,
                           OC_PAY_DOC.ApplicationKey, "ПЕРЕВОД" ) == TRUE )
    setRecordAddr( rt_paym_fpm, rt_paym );
    mark_RtPaym = TRUE;
    vCodeKind   = rt_paym_fpm.BankCodeKind;
    flag_Order  = rt_paym_fpm.FlagOrder;
    rt_paym_fpm.FlagOrder = rt_paym_fpm.FlagOrder + 1;
  end;

  if (NOT ((OC_PAY_DOC.GroupOpert == 41) AND (OC_PAY_DOC.NumOpert == 26) AND (OC_PAY_DOC.ApplType == 1)))
    if ( Bank_Standart == 0 )
      if ( ( OC_PAY_DOC.NumOpert == 20 )  OR
           ( ( ( OC_PAY_DOC.NumOpert == 40 )  OR
               ( OC_PAY_DOC.NumOpert == 42 ) )  AND
             ( ( vCodeKind ==  6 )  OR
               ( vCodeKind == 10 )  OR
               ( vCodeKind == 11 )  OR
               ( vCodeKind == 12 )  OR
               ( vCodeKind == 19 ) ) ) )
        Message( " Форма 364 ..." );
        PrintForm364();
      else
        if ( is_SB( OC_PAY_DOC_PMNT_PROP.BankCode ) )
          Message( " Форма 143 ..." );
          PrintForm143( );
        else
          Message( " Заявление о переводе вклада ..." );
          PrintFormKB( );
        end;
      end;
    else
      Message( " Заявление о переводе вклада ..." );
      PrintFormKB( );
    end;
  end;

  if( OC_PAY_DOC.VidDoc == 0 ) /* Только для наличной операции */
    Message( " Форма 31 ..." );
    stat = OutDeskResource31( );
    if (stat)
      PrintForm31( );
    else
      MsgBox( "Ошибка при расходе справки ф.31" );
    end;
  end;

  if ( stat )
    OC_RESULT = 0;
  end;

end;
