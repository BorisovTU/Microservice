
import rsd, Acc_Form;

private var {CNum};
private var {curdate};
var Count = 0;
var SN = 0;

const InVSP = 1;    // à®áâ® ¢ë¢®¤¨¬ ®âç¥â
const InFilial_Delete = 2;
const InFilial_New = 3; // ‚ë¢®¤¨¬ ®âç¥â ® á¨­åà®­¨§¨à®¢ ­­ëå ¤®ªã¬¥­â å
const InFilial_Transact = 4;

macro PrintReportHeader
 printLn( strFor( 12 ) );  /* “¯à ¢«ïîé¨© á¨¬¢®« ª®­æ  áâà ­¨æë */
[


                    à®â®ª®« ­¥¯à¨­ïâëå ®¯¥à æ¨© ¯® § ªàëâë¬ áç¥â ¬ 
                           ‘¥áá¨ïü ###### ®â ##########  ]
( SN,
  {curdate} );

[
 ÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
   N N ³          ®¬¥à           ³ Š®¤  ³   „ â     ³    „ â    ³ ®¬¥à  ³   ‘ã¬¬     ³    ’¨¯ ®¯¥à æ¨¨/     ³               
   ¯/¯ ³      «¨æ¥¢®£® áç¥â       ³¢ «îâë³  ãç¥â     ³  ®¯¥à æ¨¨ ³®¯¥à. ¢ ³  ®¯¥à æ¨¨  ³â¨¯ ¨áå®¤­®© ®¯¥à æ¨¨/³  Š®¬¬¥­â à¨©  
       ³                          ³      ³           ³           ³â¥ç. ¤­ï³            ³     ¯®¤®¯¥à æ¨ï      ³                     ];

end;

macro GetComment( comment )
  if ( comment == InVSP )
    return " áç¥â § ªàëâ";
  elif ( comment == InFilial_Delete )
    return " ­¥ ¯à¨­ïâ ";
  elif ( comment == InFilial_New )
    return " ¯à®¢¥¤¥­ ";
  elif ( comment == InFilial_Transact )
    return " ";
  end;  
end;

macro PrintReportString( rs )
  [##### ³######################### ³##### ³###########³###########³####### ³############³    ### / ### / ###   ³ ################## ]
  ( Count: r,
    Acc_Form(String(rs.value("DocAcc"))) :25: r,
    rs.value("DocCur") :4:r,
    date(rs.value("DateDoc")),
    date(rs.value("DepDate")),
    rs.value("DocNum"):4,
    rs.value("DocSum") :12:2,
    rs.value("TypeOp"):4 , rs.value("TypeCompOp"):4, rs.value("ApplType"):4,
    GetComment(rs.value("DocCom")): 14
  );
end;

macro PrintReportDelimiter
[ÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
end;

macro PrintReportFooter
[ÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
end;

macro PrintCloseAccountReport
  var cmdRep, rsRep;
  var cmdNewRep, rsNewRep;
  var printRep = false;
  var cur_ref, prev_ref = 0;


  cmdRep = RsdCommand(" select d.t_account as DocAcc, cur.t_ExternalCode as DocCur, " +
                             " r.t_date_document as DateDoc, r.t_depdate_document as DepDate, r.t_numdaydoc as DocNum, " +
   	                          " r.t_typeoper as TypeOp, r.t_typecomplexoper as TypeCompOp, r.t_appltype as ApplType, " +
   	                          " r.t_sumoperation as DocSum, r.t_comment as DocCom, r.t_referenc as ref " +
	                   " from drepclose_tmp r, ddepositr_dbt d, dcurrency_dbt cur " +
	                   " where r.t_referenc = d.t_referenc " +
	                   "   and cur.t_Code_Currency = d.t_code_currency " +
	                   " order by r.t_referenc, r.t_comment ");
  
  cmdRep.execute();

  rsRep = RsdRecordset( cmdRep );
  while ( rsRep.moveNext )
    if ( not printRep )
      PrintReportHeader;
      printRep = true;
    end;
    Count = Count + 1;
    cur_ref = rsRep.value("ref");
    if ( cur_ref != Prev_ref ) // and ( prev_ref != 0 ))
      PrintReportDelimiter;       
      prev_ref = cur_ref;  
    end;

    if (rsRep.value("DocCom") == InVSP )
      PrintReportString( rsRep );
    elif (rsRep.value("DocCom") == InFilial_Delete )
      PrintReportString( rsRep );
    elif (rsRep.value("DocCom") == InFilial_Transact )
      PrintReportString( rsRep );
    elif (rsRep.value("DocCom") == InFilial_New )
      PrintReportString( rsRep );
 //  ¤® ¡ã¤¥â ¤«ï 20-ª¨
      cmdNewRep = RsdCommand(" select s.t_account as DocAcc, cur.t_ExternalCode as DocCur, " 
                                    " s.t_date_document as DateDoc, s.t_depdate_document as DepDate, s.t_numdaydoc as DocNum, " 
                                    " s.t_typeoper as TypeOp, s.t_typecomplexoper as TypeCompOp, s.t_appltype as ApplType, "
                                    " s.t_InSum - s.t_OutSum as DocSum, t_comment as DocCom, r.t_referenc as ref " 
                             " from drepclose_tmp r, dsbdepdoc_dbt s, dcurrency_dbt cur " 
                             " where r.t_referenc = s.t_referenc " 
                               " and r.t_depdate_document = s.t_depdate_document "
                               " and s.t_referenc = ? " 
                               " and r.t_comment = 3 "
                               " and cur.t_Code_Currency = s.t_code_currency "
                            );

      cmdNewRep.addParam("p_ref", RsdBp_in );
      cmdNewRep.value("p_ref") = rsRep.value("ref");    

      cmdNewRep.execute();

      rsNewRep = RsdRecordset( cmdNewRep );
      while( rsNewRep.MoveNExt )
        PrintReportString( rsNewRep );
        Count = Count + 1;		
      end;                
      Count = Count - 1;
    end;
  end;

  if ( Count > 0 )     
    PrintReportFooter;
  end; 

end;

macro CheckAndPrint( SessnNumber )

  var cmdCheck;
  var rsCheck;
  SN = SessnNumber;

  cmdCheck = RsdCommand("select count(*) as RecCount from drepclose_tmp");
  cmdCheck.execute();

  rsCheck = RsdRecordset( cmdCheck );
  if ( rsCheck.moveNext )
    if ( rsCheck.value("RecCount") > 0 )
      println("");
      PrintCloseAccountReport;
    end;
  end;
end;



//CheckAndPrint( 3 );
