/***************************************************************************\

                           RS-Bank ( ë°•‡°†≠™ )
                      é°·´„¶®¢†≠®• °•ß≠†´®Á≠ÎÂ Ø´†‚•¶•©

                         å†™‡Æ· ØÆ§£Æ‚Æ¢™® Ø‡Æ¢Æ§™®
                        ß†Á®·´•≠®Ô ≠† ·Á•‚ ¢™´†§Á®™†

\***************************************************************************/
import deprintr, spCardInter;

CONST
  _èÖçëàü              =  2,
  _èÖçëàü_åé           =  5,
  _èÖçëàü_åÇÑ          =  6,
  _èÖçëàü_îëÅ          =  7,
  _èÖçëàü_îëçè         =  8,
  _èÖçëàü_èêéäìêÄíìêõ  =  9;

private record trn_doc ( "trn_doc.dbt" );   /* ê†·Ë®‰‡Æ¢™† ØÆ ‰®´®†´„ */

file cdoc_scAcc    ( scAcc,  "spcard.def" ) key 0;
file cdoc_scCard   ( scCard, "spcard.def" ) key 0;
file cdoc_scLink   ( scLink, "spcard.def" ) write;
file depos    ( depositr             ) key 8;

file currency_dep ( currency ) key 0;

var type_crd_dep : TBFile;
var credit_c_dep : TBFile;
var party_dep    : TBFile;
var fininstr_dep : TBFile;

private var wasOpenBankFiles = false;

private var rtWorkWithLoans = GetRegVal( "RS-RETAIL\\ëÖêÇàëçõÖ\\êÄÅéíÄ_ë_RS-LOANS" );
private var rtWorkWithRetail = GetRegVal( "COMMON\\WORK_MODE\\WORK_WITH_RETAIL" );

private var {curdate};
private var {oper};


/**************************************************************************\
|                                                                          |
\**************************************************************************/
MACRO Prepare( Addr )

  SetBuff( trn_doc, Addr );

  if ( ( StrLen( trn_doc.Account ) == 0 )         AND   /* é‚™‡Î¢†•‚·Ô ·Á•‚ */
       ( trn_doc.Type_Account == "Ñé ÇéëíêÖÅ." )  AND   /* Ç®§ ¢™´†§† */
       ( trn_doc.TypeOper == 73 )                 AND   /* á†Á®·´•≠®• */
       ((trn_doc.ApplType == _èÖçëàü)              OR    /* è•≠·®®     */
        (trn_doc.ApplType == _èÖçëàü_åé)           OR
        (trn_doc.ApplType == _èÖçëàü_åÇÑ)          OR
        (trn_doc.ApplType == _èÖçëàü_îëÅ)          OR
        (trn_doc.ApplType == _èÖçëàü_îëçè)         OR
        (trn_doc.ApplType == _èÖçëàü_èêéäìêÄíìêõ)))
    trn_doc.Type_Account = "è•≠·®Æ≠≠Î©";
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro OpenOneBankFile ( id_file, path_file, name_file, num_key, dic_name )

  var stat      = true;

  id_file = Tbfile( name_file, "r", num_key );
  if ( id_file )
    ;
  else
    stat = false;
  end;

  if ( stat )
    SetParm( 0, id_file );
  end;

  return stat;

end;


/**************************************************************************\
|                          é‚™‡Î‚®• ‰†©´Æ¢ RS-Bank                         |
\**************************************************************************/
macro OpenBankFiles

  var Path          = "";
  var PathDic       = "";
  var PathDicLoans  = "";
  var PathFile      = "";
  var stat          = true;
  var Len           = 0;

  if ( stat )
    stat = OpenOneBankFile( type_crd_dep, Path, "type_crd.dbt", 2, PathDicLoans );
  end;

  if ( stat )
    stat = OpenOneBankFile( credit_c_dep, Path, "credit_c.dbt", 8, PathDicLoans );
  end;

  if ( stat )
    stat = OpenOneBankFile( fininstr_dep, Path, "fininstr.dbt", 12, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( party_dep, Path, "party.dbt", 0, PathDic );
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindFininstr

  var stat;

  currency_dep.Code_Currency = depos.Code_Currency;

  stat = GetEQ( currency_dep );

  if ( stat )
    if ( Trim( currency_dep.ExternalCode ) == "" )
      stat = false;
    else
      fininstr_dep.Clear;
      fininstr_dep.rec.ISO_Number = Int( Trim( currency_dep.ExternalCode ) );

      stat = fininstr_dep.GetEQ;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindParty

  var stat;

  party_dep.Clear;
  party_dep.rec.PartyID = depos.CodClient;

  stat = party_dep.GetEQ;

  if ( stat )
    if ( party_dep.rec.LegalForm == 2 ) /* î®ß®Á•·™Æ• ´®ÊÆ */
      ;
    else
      stat = false;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindTypeCred

  const ovApplicCode = 1;

  type_crd_dep.Clear;
  type_crd_dep.rec.Crd_kind = ovApplicCode;
  type_crd_dep.rec.Kind     = depos.Type_Account;
  type_crd_dep.rec.CurCode  = fininstr_dep.rec.FIID;

  return type_crd_dep.GetEQ;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindDepInAccCrd

  credit_c_dep.Clear;
  credit_c_dep.rec.AccountKarta     = depos.Account;
  credit_c_dep.rec.CreditTypeID_Ref = type_crd_dep.rec.CreditTypeID;

  return credit_c_dep.GetEQ;

end;


/**************************************************************************\
|              éØ‡•§•´®‚Ï §†‚„ Æ™Æ≠Á†≠®Ô ™‡•§®‚≠Æ£Æ §Æ£Æ¢Æ‡†               |
\**************************************************************************/
macro getEndDate ( start_date )

  var year = 0;
  var mon  = 0;
  var day  = 0;
  var end_date;

  DateSplit( start_date, day, mon, year );

  year = year + 1;

  end_date = Date( day, mon, year );

  return end_date;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PostCarry ( Addr )

  var find_acc;
  var find_card;
  var flag_main_card;

  SetBuff( trn_doc, Addr );

  if ( ( trn_doc.ErrorCode == 0 ) and ( trn_doc.Referenc > 0 ) and ( trn_doc.CardRef > 0 ) )

    cdoc_scAcc.Referenc = trn_doc.Referenc;
    find_acc = GetEQ( cdoc_scAcc );

    cdoc_scCard.FNCash  = trn_doc.FNCash;
    cdoc_scCard.cardRef = trn_doc.CardRef;
    find_card = GetEQ( cdoc_scCard );

    if ( find_acc and find_card )
      if ( cdoc_scCard.psRef == cdoc_scAcc.psRef )
        KeyNum( cdoc_scLink, 2 );
        cdoc_scLink.FNCash     = cdoc_scCard.FNCash;
        cdoc_scLink.cardRef    = cdoc_scCard.cardRef;
        cdoc_scLink.cardAccRef = cdoc_scAcc.Referenc;
        if ( not GetEQ( cdoc_scLink ) )
          KeyNum(cdoc_scLink,6);
          cdoc_scLink.cardAccRef = cdoc_scAcc.Referenc;
          cdoc_scLink.mainCard   = "X";
          if ( GetEQ( cdoc_scLink ) )
            flag_main_card = false;
          else
            flag_main_card = true;
          end;
          ClearRecord( cdoc_scLink );
          cdoc_scLink.accCardLinkRef        = scDefReferLink( );
          cdoc_scLink.accCardLinkType       = "EXT__";
          cdoc_scLink.accCardLinkState      = "OK___";
          cdoc_scLink.oper                  = {oper};
          cdoc_scLink.cardAccRef            = cdoc_scAcc.Referenc;
          cdoc_scLink.cardRef               = cdoc_scCard.cardRef;
          cdoc_scLink.FNCash                = cdoc_scCard.FNCash;
          cdoc_scLink.FlagCur               = cdoc_scAcc.FlagCur;
          cdoc_scLink.CodCur                = cdoc_scAcc.CodCur;
          cdoc_scLink.psRef                 = cdoc_scAcc.psRef;
          if ( flag_main_card )
            cdoc_scLink.mainCard            = "X";
          end;
          cdoc_scLink.mainAcc               = "";
          cdoc_scLink.accCardLinkCreateDate = {curdate};
          cdoc_scLink.accCardLinkOpenDate   = {curdate};
          cdoc_scLink.accCardLinkNotes      = "è‡Æ¢Æ§™† °•ß≠†´®Á≠ÎÂ Ø´†‚•¶•©";
          cdoc_scLink.accCardLinkStatusDate = {curdate};
          cdoc_scLink.accCardLinkStatusOper = {oper};
          Insert( cdoc_scLink );
        end;
      end;
    end;

  end;

end;
