/*
$Name:             ic_comdata.mac
$Module:           ‘¥à¢¨áë
$Description:      ¡é¥¥ ¤«ï á¥à¢¨á®¢
*/

import rsd,ServiceAction;
import DeprIntr, stb_val, pm_tools, BankInter, XmlRpcInter;
import "rpchkaddress_lib.mac";
import vector;

const V_SPECVAL = 26;
const FINDCURBYCODE_CUR = 1;
const FINDCURBYEXT_CODE = 2;
const FINDBRANCH_BY_NUMBER = 1;
const FINDBRANCH_BY_NAME = 2;
const V_ACCSPECNAME = " áç¥âë®Š30232";
private var {curdate};
private var {OurBank};
private var {BatchMode};

 const
    ACCOUTN_OWNER       = StrFor( 0 ),    /* ‚« ¤¥«¥æ áç¥â       */
    ACCOUTN_PROXY       = StrFor( 1 ),    /* „®¢¥à¥­­®¥ «¨æ®     */
    ACCOUTN_HEIR        = StrFor( 2 ),    /*  á«¥¤­¨ª - ¢ë¤ ç¨  */
    ANONIMUS_CLIENT     = StrFor( 3 ),    /* €­®­¨¬­ë© ª«¨¥­â    */
    ACCOUNT_IMPORTER    = StrFor( 4 ),    /* ‚­®á¨â¥«ì           */
    ACCOUNT_TUTOR       = StrFor( 5 ),    /* ¯¥ªã­              */
    ACCOUNT_OBLIGATOR   = StrFor( 6 ),    /* ®¤ ®¡ï§ â¥«ìáâ¢®   */
    ACCOUTN_HEIR_PAY    = StrFor( 7 ),    /*  á«¥¤­¨ª - ¢ë¯« âë */
    ACCOUNT_UNDER_TRIAL = StrFor( 8 ),    /* ® áã¤ã             */
    ACCOUNT_PARENT      = StrFor( 9 );    /* ®¤¨â¥«ì            */

/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TClientCardItem
  var Branch : integer;
  var BranchName : string;
  var CardID : integer;
  var CardNumber : string;
  var Person : string;
  var PSCode : string;
  var TypeName : string;
  var isSupplement : string;
  var isClosed : string;
  var OpenDate : date;
  var IssueDate : date;
  var EndDate : date;
  var CloseDate : date;
  var Account : string;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TCardCompactInfoItem
  var PersonID : integer;
  var Person : string;
  var PersonMCID : integer;
  var PersonMC : string;
  var Sum : moneyL;
end;



/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TCardLimitsItem
  var Level : string;
  var LimitType : string;
  var OperKind : string;
  var Period : string;
  var BeginDate : date;
  var EndDate : date;
  var LimitValue : integer;
end;



/**************************************************************************\
|                               ™ˆ… ‘’“Š’“›                            |
\**************************************************************************/
class TObjectID
  var ObjectType : Integer;
  var IDType : Integer;
  var ID : String;
  var Branch : String;
end;

class FindObjParm
  var Currency : integer;
  var IsFindMCD : bool;
  var FindOKCard : bool;
  var FindWithFncash : bool;
end;

class TMoney
  var Sum : Money;
  var Currency : String;
end;

class TRate
  var Kind : Integer;
  var BaseSum : TMoney;
  var WorkSum : TMoney;
end;

class TOperationResult
 var OperationID : String;
 var DocumentIDs = Tarray;
 var OperDate : Date;
 var SumOut : TMoney;
 var SumIn : TMoney;
 var ComissionOut : TMoney;
 var ComissionIn : TMoney;
 var Rate : TRate;
end;

class TOperCommonData
  var DateDocument : Date;
  var DateValue : Date;
  var Client : Integer;
  var Source : TObjectID;
  var Destination : TObjectID;
  var Sum : TMoney;
  var Ground : String;
  var ComissionType : Integer;
  var ComissionOut : TMoney;
  var ComissionIn : TMoney;
  var ExternalSystem : String;
  var ExternalPayCode : String;
  var OperSubType : Integer;
  var NumberSrcDoc : String;
end;

private class TContract
  var ID : String;
  var Number : String;
  var OpenDate : Date;
end;

class Operation
  var ExternalSystem : string;
  var ExternalPayCode : string;
  var ComissionType : integer;
  var ComissionKind : integer;
  var ComissionOut : TMoney;
  var ComissionIn : TMoney;
  var OperSubType : integer;
  var Account : integer;
end;

class TAccount
  var ID : String;
  var Number : String;
  var Currency : String;
  var OpenDate : Date;
end;

class TConvData
  var SumIn : TMoney;
  var Rate : TRate;
  var RateCalcType : Integer;
end;

// ª«¨¥­â-¤ã¡«¥à
class TDoublerClient
  var TypeID: string;   // Š®¤ ¢¨¤  ¨¤¥­â¨ä¨ª â®à  ª«¨¥­â 
  var LocalID: string;  // ˆ„ ª«¨¥­â  - ¤ã¡«¥à  (®¡ï§ â¥«ì­ë© ¯ à ¬¥âà)
end;

/**************************************************************************\
|         ‘’“Š’“› „‹Ÿ …„…‹…ˆŸ ŠŒˆ‘‘ˆˆ (  …€–ˆˆ )               |
\**************************************************************************/
class TCCRes
  var Sum : TMoney;
end;

class TExtRecipient
  var Name : String;
  var INN : String;
  var KPP : String;
  var BankID : Integer;
  var BankCodeKind : Integer;
  var BankCode : String;
  var BankName : String;
  var CorAccount : String;
  var Account : String;
  var PartyID : Integer;
end;

class TCCData
  var OperData : TOperCommonData;
  var ConvData : TConvData;
  var ServiceType : string;
  var DestType : Integer;
  var RecipientID : Integer;
  var Recipient : TExtRecipient;
  var inBudget : Bool;
  var Direction : Integer;
end;

/**************************************************************************\
|         ‘’“Š’“› „‹Ÿ …„…‹…ˆŸ Š“‘‚ ‚›‹…ˆŸ …€–ˆˆ             |
\**************************************************************************/
class TCRRes
  var Rate : TRate;
  var SumOut : TMoney;
  var SumIn : TMoney;
end;

class TCRData
  var OperData : TOperCommonData;
  var ConvData : TConvData;
  var OperType : integer;
  var ServiceType : string;
  var isMCD : bool;
end;

/********************************************************************************\
|                       ……„€’œ Š“‘› ‚€‹’ RS-RETAIL                           |
\********************************************************************************/
class TGRData
  var Branch : string;
  var RateKind : integer;
  var Currency : string;
  var BeginDate : date;
  var EndDate : date;
end;

class TGRres
  var Branch : String;
  var DictateNumber : String;
  var DictateDate : Date;
  var RateType : Integer;
  var StartDate : Date;
  var StartTime : Time;
  var MinSum : Money;
  var Rate : TRate;
end;


/********************************************************************************\
|                    ……‚„ ‘’€‚™ˆŠ“ “‘‹“ƒ (‚…˜ˆ‰ ‹€’…†)                   |
\********************************************************************************/
class TTaxData
  var DocAuthorState : String;
  var OKATO : String;
  var KBK : String;
  var NalType : String;
  var NalPeriod : String;
  var NalDocNumber : String;
  var NalDocDate : Date;
  var ChargeID : String;
  var DocIndex : String;
  var PersonID : String;
  var Comment : String;
end;

class TZHKHData
  var SupplierID : String;
  var RecINN : String;
  var RecKPP : String;
  var RecSurname : String;
  var RecFirstName : String;
  var RecPatronymic : String;
  var RecName : String;
  var PaymentDocumentNumber : String;
  var PaymentDocumentID : String;
  var Year : integer;
  var Month : integer;
  var UnifiedAccountNumber : String;
  var CPAccount : String;
  var ServiceID : String;
  var FIASHouseGuid : String;
  var Apartment : String;
  var Placement : String;
  var IsNonLiving : Bool;
  var Surname : String;
  var FirstName : String;
  var Patronymic : String;
  var INN : String;
end;

class TETCPData
  var Client : integer;
  var ExternalPayCode : string;
  var ExternalSystem : string;
  var OperSubType : integer;
  var NumberSrcDoc : string;
  var OperData : TOperCommonData;
  var DestType : integer;
  var Recipient : TExtRecipient;
  var TaxParameters : TTaxData;
end;


/********************************************************************************\
|               ……‚„ ˆ‡‚‹œŒ“ ‹“—€’…‹ (‚…˜ˆ‰ ‹€’…†)                |
\********************************************************************************/
class TExtPaymData
  var OperData : TOperCommonData;
  var DestType : integer;
  var Recipient : TExtRecipient;
  var TaxParameters : TTaxData;
  var ZHKHData;// TZHKHData
end;

/********************************************************************************\
|             ‹€’…† ‹“—€’…‹ “‘‹“ƒ (ŠŒŒ“€‹œ›‰ ‹€’…†) ‘ ‘—…’€             |
\********************************************************************************/
class TCPRecipientInfo
  var RecipientID : Integer;
  var CPAccount : String;
end;

class TAuxData
  var Code : String;
  var Value : String;
end;

class TExtPaymCPData
  var ServiceType : string;
  var OperData : TOperCommonData;
  var Recipient : TCPRecipientInfo;
  var TaxParameters : TTaxData;
  var ZHKHData;// TZHKHData
  var AuxInfo = TArray;
end;


/**************************************************************************\
|                  ‘’“Š’“› „‹Ÿ ’Œ…› ‹€’…†€                            |
\**************************************************************************/
class TSPData
  var OperationID : string;
end;

/**************************************************************************\
|     ‘’“Š’“› „‹Ÿ ‘™…ˆŸ  „‚ˆ†…ˆˆ  ‘—…’“ ‚ RS-RETAIL              |
\**************************************************************************/
class TSAIData
  var Client : Integer;
  var ObjectType : Integer;
  var ID : String;
  var OperationID : string;
  var OpDate : Date;
  var OpTime : Time;
  var OpType : String;
  var Currency : String;
  var Sum : Money;
  var RestBefore : Money;
  var RestAfter : Money;
  var Ground : String;
end;

class TSAIRes
  var Result : Integer;
  var ErrorText : String;
  var ReqID : String;
end;

  var URL, Method, TimeOut;
/********************************************************************************\
|            ‘’“Š’“› „‹Ÿ “‘’€‚Šˆ/‘Ÿ’ˆŸ ’Œ…’Šˆ € ‘—…’€                     |
\********************************************************************************/
class TSIFData
  var Action : Integer;
  var Accounts = TArray;
end;

class TSIFRes
 var Account;
 var Result : Integer;
end;

/**************************************************************************\
|      ‘’“Š’“› „‹Ÿ ˆ”Œ€–ˆˆ  ‘—…’… (AccountInfo)                      |
\**************************************************************************/
class TAccData
  var InfoType : string;
  var Accounts = TArray;
  var InteractType : integer;
end;

class TAccPersonData
  var Part : string;
  var Client : integer;
end;

class TAccountData
 var Currency : String;
 var AccNumber : String;
 var UserType : String;
 var DateOpen : Date;
 var DateClose : Date;
 var IsDebitAllowed : Bool;
 var IsCreditAllowed : Bool;
 var IsOpen : Bool;
 var IsBlocked : Bool;
end;

class TAccFinData
 var IsOverdraftAllowed : Bool;
 var CreditContractID : String;
 var Rest : Money;
 var Available : Money;
 var LastOperDate : Date;
end;

class TAccRes
  var AccountID : string;
  var AccountData : TAccountData;
  var Contract : TContract;
  var FinInfo : TAccFinData;
  var PersonInfo : TArray;
end;

/**************************************************************************\
|            ‘’“Š’“› „‹Ÿ ˆ”Œ€–ˆˆ  ‚Š‹€„…                             |
\**************************************************************************/
class TDepositData
  var InfoType : string;
  var Deposits = TArray;
  var InteractType : integer;
end;

class TPercRatesData
  var Type : Integer;
  var Currency : String;
  var Rate : Double;
end;

class TDepFinData
  var Currency : String;
  var Sum : Money;
  var PercSum : Money;
  var OutPercSum :  Money;
  var LastPercPay : Date;
  var NextPercPay : Date;
end;

class TAccDepData
  var Account : TAccount;
  var Type : Integer;
  var PercRates = TArray; // of TPercRatesData
  var FinancialInfo : TDepFinData;
end;

class TDepPersonData
  var Part : String;
  var ID : Integer;
  var Name : String;
  var OperCodes : String;
end;

class TDepositCommonData
  var Kind : String;
  var KindName : String;
  var Currency : String;
  var StartDate : Date;
  var ProlDate : Date;
  var EndDate : Date;
  var CloseDate : Date;
  var Branch : String;
  var IsClosed : Bool;
  var Number : String;
  var OpenDate : Date;
  var LimSum = TArray;
  var IsProlonging : Bool;
  var ProlPeriod : Integer;
  var IsCreditAllowed : Bool;
  var CreditLimits = TArray;
  var IsDebitAllowed : Bool;
  var DebitLimits = TArray;
end;

class TDIDData
  var Deposit : TObjectID;
  var Currency : integer;
end;

class TDIRes
  var ID : string;
  var DepositData : TDepositCommonData;
  var Accounts = TArray;
  var PersonInfo = TArray;

  macro findAccountData(id : string) : TAccDepData
    var acc = null;
    
    var i;
    for (i, 0, Accounts.size - 1)
      if (Accounts[i].Account.ID == id)
        acc = Accounts[i];
        break;
      end;
    end;
    
    return acc;
  end;
  
end;

/**************************************************************************\
|                 ‘’“Š’“› „‹Ÿ ˆ”Œ€–ˆˆ  Š€’€•                        |
\**************************************************************************/
class TCIData
  var InfoType : string;
  var Cards = TArray;
end;

class TPrevCardData
  var ID : String;
  var Number : String;
  var Branch : String;
  var OpenDate : Date;
end;

class TMainCardData
  var ID : String;
  var Number : String;
  var Currency : String;
  var Branch : String;
  var OpenDate : Date;
  var PersonID : Integer;
  var Person : String;
end;

class TCardCommonData
  var CardNumber : String;
  var Branch : String;
  var BranchName : String;
  var Currency : String;
  var PSCode : String;
  var PSName : String;
  var SourceType : String;
  var TypeName : String;
  var isSupplement : Bool;
  var StateCode : String;
  var StateName : String;
  var isClosed : Bool;
  var OpenDate : Date;
  var IssueDate : Date;
  var EndDate : Date;
  var CloseDate : Date;
  var PrevCard : TPrevCardData;
  var CanReIssue : Bool;
  var IsLimited : Bool;
  var Contract : TContract;
  var Account : TAccount;
  var MainCard : TMainCardData;
end;

class TLimitData
  var Object : String;
  var Type : String;
  var OperType : String;
  var PeriodType : Integer;
  var BeginDate : Date;
  var EndDate : Date;
  var Sum : TMoney;
  var Quantity : Integer;
end;

class TCardFinData
  var Rest : TMoney;
  var CreditContractID : String;
  var Limits = TArray;
end;

class TCardPersonData
  var PersonID : Integer;
  var Person : String;
  var EmbossingText : String;
end;

class TCIRes
  var CardID : String;
  var CardData : TCardCommonData;
  var FinInfo : TCardFinData;
  var PersonInfo : TCardPersonData;
end;

/**************************************************************************\
|                 ‘’“Š’“› „‹Ÿ „. Š€’ Š ‘‚‰                       |
\**************************************************************************/
class SCLData
  var Card : TObjectID;
  var Filter : String;
end;

class TSCLRes
  var Branch : String;
  var BranchName : String;
  var CardID : String;
  var CardNumber : String;
  var Currency : String;
  var Account : String;
  var AccountID : String;
  var PersonID : Integer;
  var PersonName : String;
  var PSCode : String;
  var TypeName : String;
  var StateCode : String;
  var IsClosed : Bool;
  var OpenDate : Date;
  var IssueDate : Date;
  var EndDate : Date;
  var CloseDate : Date;
end;

/**************************************************************************\
|          ‘’“Š’“› „‹Ÿ …Š‚ˆ‡ˆ’‚ ‚…˜…ƒ ‹€’…†€(€ Š€’“)             |
\**************************************************************************/
class TIncrementDetailsItem
  var BankID : integer;
  var BankCodeKind : integer;
  var BankCode : string;
  var BankName : string;
  var CorAccount : string;
  var Account : string;
  var PersonName : string;
  var Ground : string;
end;

/********************************************************************************\
|         ……‚„ ‘ Š€’› € ’…Š“™ˆ‰ ‘—…’ Š‹ˆ…’€ (‚ „‰ ‚€‹’…)               |
\********************************************************************************/
class TITCAData
  var OperData : TOperCommonData;
  var AuthCode : string;
end;

/********************************************************************************\
|         ……‚„ Œ…†„“ ’…Š“™ˆŒˆ ‘—…’€Œˆ „ƒ Š‹ˆ…’€ (‚ €‡›• ‚€‹’€•)       |
\********************************************************************************/
class TIConvAAData
  var OperData : TOperCommonData;
  var ConvData : TConvData;
end;

/**************************************************************************\
|                ‘’“Š’“› „‹Ÿ ‚›ˆ‘Šˆ  ‚Š‹€„“/‘—…’“                     |
\**************************************************************************/
class AccDetailData
  var Object : TObjectID;
  var StartDate : Date;
  var EndDate : Date;
  var InfoType : integer;
  var OperCodes : String;
  var Quantity : integer;
end;

class TOperationData
  var OperDate : Date;
  var RestIn : Money;
  var TypeOper : String;
  var Sum : Money;
  var RestOut : Money;
  var Ground : String;
  var OperationID : String;
  var OperType : Integer;
  var OperName : String;
  var OperSubType : Integer;
  var OperSubName : String;
  var CorSum : TMoney;
  var Recipient : TExtRecipient;

end;

class TAccountExtract
  var AccountID : String;
  var Number : String;
  var Branch : String;
  var Currency : String;
  var RestIn : money;
  var DebitSum : money;
  var CreditSum : money;
  var RestOut : money;
  var LastOperDate : Date;
  var Quantity : Integer;
  var Operations = TArray;
end;

/**************************************************************************\
|                    ‘’“Š’“› „‹Ÿ ‚›ˆ‘Šˆ  Š€’…                        |
\**************************************************************************/
class TCODData
  var Card : TObjectID;
  var BeginDate : date;
  var EndDate : date;
  var TypeInfo : integer;
  var ShowAuxCard : Bool;
  var Quantity : integer;
end;

//¢ ¯à®¥ªâ¥ áâ®¨â áâàãªâãà  TOperationData, ­® â ª ï ã¦¥ § ¢¥¤¥­ 
class TCardOperationData
  var OperDate : Date;
  var NDoc : Integer;
  var RestIn : Money;
  var TypeOper : String;
  var Sum : Money;
  var RestOut : Money;
  var OperationID : String;
  var Ground : String;
  var OperType : Integer;
  var OperName : String;
  var OperSubType : Integer;
  var OperSubName : String;
  var Number : String;
end;

class TCODRes
  var BeginDate : Date;
  var EndDate : Date;
  var Currency : String;
  var RestIn : Money;
  var RestOut : Money;
  var LastOperDate : Date;
  var Operations = TArray;
end;

class TCIKContractor
  var FIO : String;
  var Phone : String;
end;

class TCIKAccountData
  var AccountType : String;
  var Acc : String;
  var PersonalAcc : String;
  var AccountName : String;
  var BicBank : String;
  var BankOGRN : String;
  var BankINN : String;
  var BankKPP : String;
  var BankRegionCode : String;
  var BankAddress : String;
  var DeptCode : String;
  var ContractNumber : String;
  var ContractStartDate : Date;
  var ContractFinDate : Date;
  var CurrencyCode : String;
  var DateMove : Date;
  var SummaVal : Money;
  var SummaRUB : Money;
  var RealRestVal : Money;
  var RealRestRUB : Money;
  var SummaArestVal : Money;
  var SummaArestRUB : Money;
  var DateChange : Date;
  var BaseCurRate : Money;
  var RubRate : Money;
end;

class TCIKAccountListResult
  var ReqID : String;
  var SenderID : String;
  var RealDateTime : DateTime;
  var Contractor : TCIKContractor;
  var CountClient : Integer;
  var ClientID : Integer;
  var ClientFullName : String;
  var Vip : Bool;
  var CountAcc : Integer;
  var Accounts = TArray;
end;

/**************************************************************************\
|                    ‘’“Š’“› „‹Ÿ ‚›ˆ‘Šˆ  ‘—ğ’“                        |
\**************************************************************************/
class TAccOperationResult
  var ReqID : String;
  var SenderID : String;
  var RealDateTime : DateTime;
  var BIC : String;
  var Account : String;
  var Currency : Integer;
  var ClientFullName : String;
  var INN : String;
  var AccountTransactions = TArray;
end;

class TAccTransactionData
  var TType : Integer;
  var Date : Date;
  var Amount : Money;
  var BIC : String;
  var Account : String;
  var Grounds : String;
end;

/**************************************************************************\
|        ‘’“Š’“› „‹Ÿ ‹“—…ˆŸ ‘‚…„…ˆ‰  ƒ€ˆ—…ˆŸ•  ‘—ğ’“         |
\**************************************************************************/
class TAccClaimResult
  var ReqID : String;
  var SenderID : String;
  var RealDateTime : DateTime;
  var BIC : String;
  var Account : String;
  var Currency : Integer;
  var ClientFullName : String;
  var INN : String;
  var AccountEncumbranceDatum = TArray;
end;

class TAccEncumbranceData
  var Type : Integer;
  var OrgName : String;
  var OrgINN : String;
  var Amount : Money;
  var Date : Date;
  var Priority : String;
  var IPNumber : String;
  var DocNumber : String;
  var OSPCode : String;
  var InternalKey : String;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro convertNullStr ( val )

  if ( ( ValType( val ) == V_SPECVAL ) or ( ValType( val ) == V_UNDEF ) )
    return "";
  else
    if ( val == StrFor( 1 ) )
      return "";
    else
      return val;
    end;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro convertNullDate ( val )

  if ( ( ValType( val ) == V_DATE ) or ( ValType( val ) == V_DTTM ) )
    return val;
  else
    return Date( 0, 0, 0 );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro convertNullInt ( val )

  if ( ( ValType( val ) == V_INTEGER ) or ( ValType( val ) == V_DOUBLE ) or ( ValType( val ) == V_DOUBLEL ) or ( ValType( val ) == V_MONEY ) or ( ValType( val ) == V_MONEYL ) )
    return val;
  else
    return 0;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ErrMessage ( errCode )

  var errMsg = "";
  var cmd = RsdCommand( "select t_Contents from dsbbank_msg "
                        "where t_Number = ? " );

  cmd.addParam( "p_number", RSDBP_IN, errCode );

  cmd.execute( );

  var rs = RsdRecordset( cmd );

  if ( rs.moveNext( ) )
    errMsg = convertNullStr( rs.value( 0 ) );
  end;

  if ( errMsg == "" )
    errMsg = String( errCode );
  end;

  return errMsg;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkDateParam(val, errCode : integer)
  if ((ValType(val) != V_DATE) or (val == Date(0,0,0)))
    if (not errCode)
      errCode = 16504;
    end;
    
    RunError(ErrMessage(errCode), errCode);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkMoneyParam(val, errCode : integer)
  if (ValType(val) != V_MONEY)
    if (not errCode)
      errCode = 16504;
    end;
    
    RunError(ErrMessage(errCode), errCode);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkRealSum(val, errCodeType : integer, errCodeSum : integer)
  checkMoneyParam(val, errCodeType);
  if (val  < $0.01L)
    if (not errCodeSum)
      errCodeSum = 4702;
    end;
    
    RunError(ErrMessage(errCodeSum), errCodeSum);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkIntegerParam(val, errCode : integer)
  if (ValType(val) != V_INTEGER)
    if (not errCode)
      errCode = 16504;
    end;
    
    RunError(ErrMessage(errCode), errCode);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkIntegerRangeParam(val, min : integer, max : integer, errCode : integer)
  if ((ValType(val) != V_INTEGER) or (val  < min) or (val > max))
    if (not errCode)
      errCode = 16504;
    end;
    
    RunError(ErrMessage(errCode), errCode);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkIntegerIdParam(val, errCode : integer)
  if ((ValType(val) != V_INTEGER) or (val  < 0))
    if (not errCode)
      errCode = 16504;
    end;
    
    RunError(ErrMessage(errCode), errCode);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro validateIntegerIdParam(val, defVal : integer)
  if ((ValType(val) != V_INTEGER) or (val  < 0))
    val = defVal;
  end;
  return val;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkStringParam(val, errCode : integer)
  if ((ValType(val) != V_STRING) or (val == ""))
    if (not errCode)
      errCode = 16504;
    end;
    
    RunError(ErrMessage(errCode), errCode);
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkDeathClient(CodClient : integer, errCode : integer)
  var findpersn = rsdcommand("SELECT * FROM dpersn_dbt WHERE T_PERSONID = ?");
  findpersn.AddParam("clntcode",RSDBP_IN,CodClient);
  findpersn.nullConversion = true;
  findpersn.execute();
  var rs_findpersn = RsdRecordset(findpersn);
  if (rs_findpersn.moveNext)
    if (SQL_ConvTypeDate(rs_findpersn.value("t_death"))>Date(0,0,0))
      RunError(ErrMessage(errCode), errCode);
    end;
  else
    RunError(ErrMessage(4661), 4661);
  end;
end;

/**************************************************************************\
|                          ‹“—…ˆ… ”ˆ Š‹ˆ…’€                           |
\**************************************************************************/
macro getClientFIO(CodClient : integer, FIO : string, specialAccess : bool)
  var findpersn = rsdcommand("SELECT * FROM dpersn_dbt WHERE T_PERSONID = ?");
  findpersn.AddParam("clntcode",RSDBP_IN,CodClient);
  findpersn.nullConversion = true;
  findpersn.execute();
  var rs_findpersn = RsdRecordset(findpersn);

  if (rs_findpersn.moveNext)
    FIO = rs_findpersn.value("t_name1") + " " + rs_findpersn.value("t_name2") + " " + rs_findpersn.value("t_name3");
    if (rs_findpersn.value("t_SpecialAccess") != strfor(0))
      specialAccess = true;
    else
      specialAccess = false;
    end;

    SetParm(1, FIO);
    SetParm(2, specialAccess);
  else
    RunError(ErrMessage(4661), 4661);
  end;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro checkRateKind(ID : integer, errCode : integer)
  if ((ValType(ID) == V_INTEGER) and (ID  > 0))
    if (not errCode)
      errCode = 16524;
    end;
   
    var findRateKind = rsdcommand("select * from dRateKind_dbt where t_id = ?");
    findRateKind.AddParam("id",RSDBP_IN,ID);
    findRateKind.nullConversion = true;
    findRateKind.execute();
    var rs_findRateKind = RsdRecordset(findRateKind);
    if ( not rs_findRateKind.moveNext)
      RunError(ErrMessage(errCode), errCode);
    end;
  end;
end;

/********************************************************************************\
|            ˆ‘Š ‚€‹’› (‚‡‚€™€…’ ‘’“Š’““ DCURRENCY_DBT)                   |
\********************************************************************************/
macro FindCurrency ( searchParam, curParam : string )
  var findCur;
  if  ( searchParam == FINDCURBYEXT_CODE )
    findCur =  rsdcommand("select * from dcurrency_dbt where T_EXTERNALCODE = :ISOcode");
    findCur.AddParam("ISOcode", RSDBP_IN, curParam);
  elif ( searchParam == FINDCURBYCODE_CUR )
    findCur =  rsdcommand("select * from dcurrency_dbt where T_CODE_CURRENCY = :codeCur");
    findCur.AddParam("codeCur", RSDBP_IN, Int(curParam));
  else
    RunError( ErrMessage( 19007 ), 19007 );
  end;
  findCur.nullConversion = true;
  findCur.execute();
  var rs_findCur = RsdRecordset(findCur);
  if ( not rs_findCur.moveNext() )
    RunError( ErrMessage( 18009 ), 18009 );
  end;
  return rs_findCur;

end;

/********************************************************************************\
|             ‚‡‚€™€…Œ ISO Š„ €–ˆ€‹œ‰ ‚€‹’› ˆ‡ Ÿ„€                     |
\********************************************************************************/
macro RetKernelNatISO( iso : string )
  if (iso != "810")
    return iso;
  end;

  var kernelISO = rsdcommand("SELECT FI.T_FIID kernel_code_currency, FI.T_ISO_NUMBER kernel_iso FROM dfininstr_dbt fi, (SELECT CR.T_EXTERNALCODE ISO_CODE "
                             " FROM dcurrency_dbt cr WHERE CR.T_CODE_CURRENCY = 0) rtcur WHERE FI.T_FI_KIND = 1 AND ( FI.T_ISO_NUMBER = rtcur.ISO_CODE "
                             " OR FI.T_CODEINACCOUNT = rtcur.ISO_CODE)");
  kernelISO.nullConversion = true;
  kernelISO.execute();
  var rs_kernelISO = RsdRecordset(kernelISO);
  if ( rs_kernelISO.moveNext )
    return convertNullStr(rs_kernelISO.value("kernel_iso"));
  else
    return iso;
  end;
end;

/********************************************************************************\
|             ‚‡‚€™€…Œ ISO Š„ €–ˆ€‹œ‰ ‚€‹’› ˆ‡ RETAIL                   |
\********************************************************************************/
macro RetRetailNatISO( iso : string )
  if (iso != "643")
    return iso;
  end;

  var RetailISO = rsdcommand("SELECT CR.T_CODE_CURRENCY retail_code_currency, CR.T_EXTERNALCODE retail_iso FROM dcurrency_dbt cr, "
                             " (SELECT FI.T_FI_CODE ISO_CODE, FI.T_CODEINACCOUNT CODEINACC FROM dfininstr_dbt fi WHERE FI.T_FIID = 0 "
                             " AND FI.T_FI_KIND = 1) kerncur WHERE CR.T_EXTERNALCODE = kerncur.ISO_CODE or CR.T_EXTERNALCODE = kerncur.CODEINACC");
  RetailISO.nullConversion = true;
  RetailISO.execute();
  var rs_RetailISO = RsdRecordset(RetailISO);
  if ( rs_RetailISO.moveNext )
    return convertNullStr(rs_RetailISO.value("retail_iso"));
  else
    return iso;
  end;
end;

/********************************************************************************\
|  à®¢¥àª  á®®â¢¥âáâ¢¨ï ¢ «îâ­®áâ¨ ¢ ä®à¬ â¥ extCode ¨ codeCur á®®â¢¥âáâ¢¥­­®   |
\********************************************************************************/
macro checkCurrency ( extCode, codeCur, errMsg )
  var findCur = FindCurrency(FINDCURBYEXT_CODE, RetRetailNatISO(extCode));
  if ( findCur.value("T_CODE_CURRENCY") != codeCur )
    RunError( ErrMessage( errMsg ), errMsg );
  end;
end;


/********************************************************************************\
|                                 “‘’€‚ˆŒ €Š                                 |
\********************************************************************************/
macro § ¤ ¤¨¬_¯ à ¬¥âàë_¡ ­ª  ( param )
  setFnCash(param.value("T_FNCASH"));
  setFlagCur(param.value("T_ISCUR"));
  setRealFNcash(param.value("T_FNCASH"));
  {curdate} = getCurDate;
  setOperBrigade(getOperBrigade);
end;
/********************************************************************************\
|                   …„…‹…ˆ… „ƒ‚€  ……„€›Œ €€Œ…’€Œ                |
\********************************************************************************/
macro findAnyContract ( rs_findContract, TObjectID )
    var findContr;
    var findConByProdId = false, findConByNumber = false;
    var AccReference, ExtBranch, ExtContrID, ExtCardRef;
    var findCurr, code_cur;
    var stat = false;

    if ( (ValType(TObjectID.ID) != V_STRING) or (TObjectID.ID == "") )
      return 16520;
    end;
    if ( (TObjectID.IDType == 2) and ((ValType(TObjectID.Branch) != V_STRING) or (TObjectID.Branch == "")) )
      return 16520;
    end;

    if ( TObjectID.ObjectType == 551 )  // áç¥â ä¨§. «¨æ 
      if ( TObjectID.IDType == 1 )
         findConByProdId = true;
      elif ( TObjectID.IDType == 2 )
         findConByNumber = true;
      else
        return 16531;
      end;

      if ( findConByNumber )
        findContr = rsdcommand("SELECT con.* FROM drt_contract_dbt con, ddepositr_dbt dep WHERE CON.T_NUMBER = DEP.T_SVODACCOUNT "
                                 " AND CON.T_BRANCH = DEP.T_FNCASH AND DEP.T_ACCOUNT = :AccNumber AND DEP.T_FNCASH = (SELECT t_code "
                                 " FROM ddp_dep_dbt WHERE t_name = :BranchID)");
        findContr.AddParam("AccNumber", RSDBP_IN, TObjectID.ID);
        findContr.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
        findContr.nullConversion = true;
        findContr.execute();
        rs_findContract = RsdRecordset(findContr);
        stat = rs_findContract.moveNext();
        if ( (stat == false) and (StrLen(TObjectID.ID) >= 20) ) // ®¨áª ¡¥§ ãçñâ  ¯®á«¥¤­¨å 2 á¨¬¢®«®¢ ¢ ­®¬¥à¥ áç¥â 
          findContr = rsdcommand("SELECT con.* FROM drt_contract_dbt con, ddepositr_dbt dep WHERE CON.T_NUMBER = DEP.T_SVODACCOUNT "
                                   " AND CON.T_BRANCH = DEP.T_FNCASH AND DEP.T_ACCOUNT LIKE :AccNumber AND DEP.T_FNCASH = (SELECT t_code "
                                   " FROM ddp_dep_dbt WHERE t_name = :BranchID)");
          findContr.AddParam("AccNumber", RSDBP_IN, SubStr(TObjectID.ID,1,20) + "%");
          findContr.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
          findContr.nullConversion = true;
          findContr.execute();
          rs_findContract = RsdRecordset(findContr);
          stat = rs_findContract.moveNext();
        end;
        if ( stat == false )
          return 16511;
        end;
      elif ( findConByProdId )
        AccReference = Int(TObjectID.ID);
        findContr = rsdcommand("SELECT con.* FROM drt_contract_dbt con, ddepositr_dbt dep WHERE CON.T_NUMBER = DEP.T_SVODACCOUNT "
                                 " AND CON.T_BRANCH = DEP.T_FNCASH AND DEP.T_REFERENC = :Reference");
        findContr.AddParam("Reference", RSDBP_IN, AccReference);
        findContr.nullConversion = true;
        findContr.execute();
        rs_findContract = RsdRecordset(findContr);
        if ( not rs_findContract.moveNext() )
          return 16511;
        end;
        if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
          if ( rs_findContract.value("T_BRANCH") != TObjectID.Branch )
            return 16554;
          end;
        end;
      end;
    elif ( (TObjectID.ObjectType == 550) or (TObjectID.ObjectType == 556) )  // ¤®£®¢®à ¢ª« ¤  ä¨§.«¨æ 
      if ( TObjectID.IDType == 1 )
         findConByProdId = true;
      elif ( TObjectID.IDType == 2 )
         findConByNumber = true;
      else
        return 16531;
      end;

      if ( findConByNumber )
        findContr = rsdcommand("SELECT con.* FROM drt_contract_dbt con WHERE CON.T_BRANCH = (SELECT t_code FROM ddp_dep_dbt "
                               " WHERE t_name = :BranchID) AND CON.T_NUMBER = :ContrNumber");
        findContr.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
        findContr.AddParam("ContrNumber", RSDBP_IN, TObjectID.ID);
        findContr.nullConversion = true;
        findContr.execute();
        rs_findContract = RsdRecordset(findContr);
        if ( not rs_findContract.moveNext() )
          return 16550;
        end;
      elif ( findConByProdId )
        ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
        ExtContrID = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
        findContr = rsdcommand("SELECT con.* FROM drt_contract_dbt con WHERE CON.T_ID = :ID AND CON.T_BRANCH = :branch");
        findContr.AddParam("ID", RSDBP_IN, ExtContrID);
        findContr.AddParam("branch", RSDBP_IN, ExtBranch);
        findContr.nullConversion = true;
        findContr.execute();
        rs_findContract = RsdRecordset(findContr);
        if ( not rs_findContract.moveNext() )
           return 16550;
        end;
        if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
          if ( rs_findContract.value("T_BRANCH") != TObjectID.Branch )
            return 16554;
          end;
        end;
      end;
    elif ( (TObjectID.ObjectType == 554) or (TObjectID.ObjectType == 552) )  // ¡ ­ª®¢áª ï ª àâ  retail ¨«¨ ¤®£®¢®à ¡ ­ª®¢áª®© ª àâë
      if ( TObjectID.IDType == 1 )
         findConByProdId = true;
      elif ( TObjectID.IDType == 2 )
         findConByNumber = true;
      else
        return 16531;
      end;

      if ( TObjectID.ObjectType == 552 )
        if ( findConByNumber )
          var findCardByNum = rsdcommand("select crd.* from dsccard_dbt crd, drt_contract_dbt con where "
                                         " CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH AND "
                                         " CON.T_BRANCH = (select t_code from ddp_dep_dbt where t_name = :branch) AND CON.T_NUMBER = :ConNumber ");
          findCardByNum.AddParam("branch", RSDBP_IN, TObjectID.Branch);
          findCardByNum.AddParam("ConNumber", RSDBP_IN, TObjectID.ID);
          findCardByNum.nullConversion = true;
          findCardByNum.execute();
          var rs_findCardByNum = RsdRecordset(findCardByNum);
          if ( not rs_findCardByNum.moveNext() )
            return 16551;
          end;
          TObjectID.ID = rs_findCardByNum.value("T_CARDNUMBER");
          findConByNumber = true;
        elif ( findConByProdId )
          ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
          ExtContrID = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
          var findCardByID = rsdcommand("select crd.* from dsccard_dbt crd, drt_contract_dbt con where "
                                        " CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH AND"
                                        " CON.T_BRANCH = :branch AND CON.T_ID = :ConId ");
          findCardByID.AddParam("branch", RSDBP_IN, ExtBranch);
          findCardByID.AddParam("ConId", RSDBP_IN, ExtContrID);
          findCardByID.nullConversion = true;
          findCardByID.execute();
          var rs_findCardById = RsdRecordset(findCardByID);
          if ( not rs_findCardById.moveNext() )
            return 16551;
          end;
          if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
            if ( rs_findCardById.value("T_FNCASH") != TObjectID.Branch )
              return 16554;
            end;
          end;
          TObjectID.ID = String(ExtBranch) + "/" + rs_findCardById.value("T_CARDREF");
          findConByProdId = true;
      end;
      end;

      if ( findConByNumber )
        var strfindAcc = "SELECT con.* FROM dsccard_dbt crd, ddepositr_dbt dep, dsclink_dbt lnk, drt_contract_dbt con WHERE "
                         " CRD.T_CARDNUMBER = :cardNum AND LNK.T_FNCASH = CRD.T_FNCASH AND LNK.T_CARDREF = CRD.T_CARDREF "
                         " AND LNK.T_CARDACCREF = DEP.T_REFERENC AND CON.T_BRANCH = CRD.T_FNCASH AND CON.T_NUMBER = DEP.T_SVODACCOUNT ";
        if ((ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != ""))
          strfindAcc = strfindAcc +" AND CRD.T_FNCASH = (select t_code from ddp_dep_dbt where t_name = :branch) ";
        end;
        findContr = rsdcommand( strfindAcc );
        findContr.AddParam("cardNum", RSDBP_IN, TObjectID.ID);
        if ((ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != ""))
          findContr.AddParam("branch", RSDBP_IN, TObjectID.Branch);
        end;
        findContr.nullConversion = true;
        findContr.execute();
        rs_findContract = RsdRecordset(findContr);
        if ( not rs_findContract.moveNext() )
          return 16526;
        end;
      elif ( findConByProdId )
        ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
        ExtCardRef = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
        findContr = rsdcommand("SELECT con.* FROM dsccard_dbt crd, ddepositr_dbt dep, dsclink_dbt lnk, drt_contract_dbt con WHERE "
                               " CRD.T_CARDREF = :cardRef AND CRD.T_FNCASH = :branch AND LNK.T_FNCASH = CRD.T_FNCASH AND LNK.T_CARDREF = CRD.T_CARDREF "
                               " AND LNK.T_CARDACCREF = DEP.T_REFERENC AND CON.T_BRANCH = CRD.T_FNCASH AND CON.T_NUMBER = DEP.T_SVODACCOUNT");
        findContr.AddParam("cardRef", RSDBP_IN, ExtCardRef);
        findContr.AddParam("branch", RSDBP_IN, ExtBranch);
        findContr.nullConversion = true;
        findContr.execute();
        rs_findContract = RsdRecordset(findContr);
        if ( not rs_findContract.moveNext() )
          return 16526;
        end;
        if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
          if ( rs_findContract.value("T_BRANCH") != TObjectID.Branch )
            return 16554;
          end;
        end;
      end;
   else
     return 16530;
   end;

   SetParm (0,rs_findContract);
   return 0;
end;

/********************************************************************************\
|                    …„…‹…ˆ… š…Š’€  ……„€›Œ €€Œ…’€Œ                |
\********************************************************************************/
macro findOpenAccount ( rs_findAccount, TObjectID, FindParam )
    var findAccount;
    var findAccByProdId = false, findAccByNumber = false;
    var AccReference, ExtBranch, ExtContrID, ExtCardRef;
    var findCurr, code_cur;
    var stat = false;

    if ( (ValType(TObjectID.ID) != V_STRING) or (TObjectID.ID == "") )
      return 16504;
    end;
    if ( (TObjectID.IDType == 2) and ((ValType(TObjectID.Branch) != V_STRING) or (TObjectID.Branch == "")) )
      if ( (TObjectID.ObjectType == 551) and (not FindParam.FindWithFncash) )
        ;
      else
        return 16504;
      end;
    end;

    if ( TObjectID.ObjectType == 551 )  // áç¥â ä¨§. «¨æ 
      if ( TObjectID.IDType == 1 )
         findAccByProdId = true;
      elif ( TObjectID.IDType == 2 )
         findAccByNumber = true;
      else
        return 16531;
      end;
      if ( findAccByNumber )
        var strfindAccBranch = "";
        if (FindParam.FindWithFncash)
          strfindAccBranch = " and t_fncash = (select t_code from ddp_dep_dbt where t_name = :BranchID)";
        end;
        findAccount = rsdcommand("select * from ddepositr_dbt where t_account = :AccNumber " + strfindAccBranch);
        findAccount.AddParam("AccNumber", RSDBP_IN, TObjectID.ID);
        if (FindParam.FindWithFncash)
          findAccount.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
        end;
        findAccount.nullConversion = true;
        findAccount.execute();
        rs_findAccount = RsdRecordset(findAccount);
        stat = rs_findAccount.moveNext();
		if ( (stat == false) and (StrLen(TObjectID.ID) >= 20) ) // ®¨áª ¡¥§ ãçñâ  ¯®á«¥¤­¨å 2 á¨¬¢®«®¢ ¢ ­®¬¥à¥ áç¥â 
          findAccount = rsdcommand("select * from ddepositr_dbt where t_account like :AccNumber " + strfindAccBranch);
          findAccount.AddParam("AccNumber", RSDBP_IN, SubStr(TObjectID.ID,1,20) + "%");
          if (FindParam.FindWithFncash)
            findAccount.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
          end;
          findAccount.nullConversion = true;
          findAccount.execute();
          rs_findAccount = RsdRecordset(findAccount);
          stat = rs_findAccount.moveNext();
        end;
        if ( stat == false )
          return 16511;
        else
          if ( (not FindParam.FindWithFncash) and (rs_findAccount.moveNext()) )
            return 16532;
          end;
        end;
        if ( (rs_findAccount.value("t_open_close") != strfor(0))
             or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
          SetParm (0,rs_findAccount);
          return 16512;
        end;
      elif ( findAccByProdId )
        AccReference = Int(TObjectID.ID);
        findAccount = rsdcommand("select * from ddepositr_dbt where T_REFERENC = :Reference");
        findAccount.AddParam("Reference", RSDBP_IN, AccReference);
        findAccount.nullConversion = true;
        findAccount.execute();
        rs_findAccount = RsdRecordset(findAccount);
        if ( not rs_findAccount.moveNext() )
          return 16511;
        end;
        if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
          if ( rs_findAccount.value("T_FNCASH") != TObjectID.Branch )
            return 16554;
          end;
        end;
        if ( (rs_findAccount.value("t_open_close") != strfor(0))
             or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
          SetParm (0,rs_findAccount);
          return 16512;
        end;
      end;
    elif ( (TObjectID.ObjectType == 550) or (TObjectID.ObjectType == 556) )  // ¤®£®¢®à ¢ª« ¤  ä¨§.«¨æ 
      var finddeptyp, rs_finddeptyp, MType;

      if ( TObjectID.IDType == 1 )
         findAccByProdId = true;
      elif ( TObjectID.IDType == 2 )
         findAccByNumber = true;
      else
        return 16531;
      end;

      if ( findAccByNumber )
        finddeptyp = rsdcommand("select T_MCTYPE from dsb_dtyp_dbt where t_kind = (select T_ACCOUNTTYPE from "
                                " drtdepcontract_dbt where t_branch = (select t_code from ddp_dep_dbt where t_name = :BranchID) "
                                " and t_id = (select t_id from drt_contract_dbt "
                                " where t_branch = (select t_code from ddp_dep_dbt where t_name = :conBranchID)"
                                " and T_NUMBER = :conNumber ))");
        finddeptyp.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
        finddeptyp.AddParam("conBranchID", RSDBP_IN, TObjectID.Branch);
        finddeptyp.AddParam("conNumber", RSDBP_IN, TObjectID.ID);
        finddeptyp.nullConversion = true;
        finddeptyp.execute();
        rs_finddeptyp = RsdRecordset(finddeptyp);
        if ( not rs_finddeptyp.moveNext() )
          return 16550;
        else
          MType = rs_finddeptyp.value("T_MCTYPE");
          if ( not MType )
            findAccount = rsdcommand("select dep.* from ddepositr_dbt dep where dep.t_fncash = (select t_code from "
                                     " ddp_dep_dbt where t_name = :BranchID) and dep.T_SVODACCOUNT = :ContrNumber");
            findAccount.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
            findAccount.AddParam("ContrNumber", RSDBP_IN, TObjectID.ID);
            findAccount.nullConversion = true;
            findAccount.execute();
            rs_findAccount = RsdRecordset(findAccount);
            if ( not rs_findAccount.moveNext() )
              return 16550;
            end;
            if ( (rs_findAccount.value("t_open_close") != strfor(0))
                 or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
              SetParm (0,rs_findAccount);
              return 16512;
            end;
          elif ( (Mtype > 0) and (FindParam.IsFindMCD) )
              if ( (ValType(FindParam.Currency) != V_INTEGER) or (FindParam.Currency <= 0) )
                return 16504;
              else
                findCurr = FindCurrency(FINDCURBYEXT_CODE, FindParam.Currency);
                code_cur = findCurr.value("T_CODE_CURRENCY");
                findAccount = rsdcommand("select dep.* from ddepositr_dbt dep where dep.t_fncash = (select t_code from "
                                         " ddp_dep_dbt where t_name = :BranchID) and "
                                         " dep.T_SVODACCOUNT = :ContrNumber and dep.T_CODE_CURRENCY = :CODE_CURRENCY");
                findAccount.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
                findAccount.AddParam("ContrNumber", RSDBP_IN, TObjectID.ID);
                findAccount.AddParam("CODE_CURRENCY", RSDBP_IN, code_cur);
                rs_findAccount = RsdRecordset(findAccount);
                if ( not rs_findAccount.moveNext() )
                  return 16550;
                end;
                if ( (rs_findAccount.value("t_open_close") != strfor(0))
                     or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
                  SetParm (0,rs_findAccount);
                  return 16512;
                end;
              end;
          else
            return 16535;
          end;
        end;
      elif ( findAccByProdId )
        ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
        ExtContrID = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
        finddeptyp = rsdcommand("select T_MCTYPE from dsb_dtyp_dbt where t_kind = (select depcon.T_ACCOUNTTYPE from "
                                " drtdepcontract_dbt depcon, drt_contract_dbt con where depcon.t_branch = con.t_branch "
                                " and depcon.t_id = con.t_id and con.t_id = :ID and con.t_branch = :branch )");
        finddeptyp.AddParam("ID", RSDBP_IN, ExtContrID);
        finddeptyp.AddParam("branch", RSDBP_IN, ExtBranch);
        finddeptyp.nullConversion = true;
        finddeptyp.execute();
        rs_finddeptyp = RsdRecordset(finddeptyp);
        if ( not rs_finddeptyp.moveNext() )
          return 16550;
        else
          MType = rs_finddeptyp.value("T_MCTYPE");
          if ( not MType )
            findAccount = rsdcommand("select dep.* from ddepositr_dbt dep, drt_contract_dbt con where con.t_id = :ID and con.t_branch = :branch and"
                                     " con.T_NUMBER = dep.T_SVODACCOUNT and con.T_BRANCH = dep.T_FNCASH ");
            findAccount.AddParam("ID", RSDBP_IN, ExtContrID);
            findAccount.AddParam("branch", RSDBP_IN, ExtBranch);
            findAccount.nullConversion = true;
            findAccount.execute();
            rs_findAccount = RsdRecordset(findAccount);
            if ( not rs_findAccount.moveNext() )
              return 16550;
            end;
            if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
              if ( rs_findAccount.value("T_FNCASH") != TObjectID.Branch )
                return 16554;
              end;
            end;
            if ( (rs_findAccount.value("t_open_close") != strfor(0))
                 or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
              SetParm (0,rs_findAccount);
              return 16512;
            end;
          elif ( (Mtype > 0) and (FindParam.IsFindMCD) )
              if ( (ValType(FindParam.Currency) != V_INTEGER) or (FindParam.Currency <= 0) )
                return 16504;
              else
                findCurr = FindCurrency(FINDCURBYEXT_CODE, FindParam.Currency);
                code_cur = findCurr.value("T_CODE_CURRENCY");
                findAccount = rsdcommand("select dep.* from ddepositr_dbt dep, drt_contract_dbt con where con.t_id = :ID and con.t_branch = :branch and"
                                         " con.T_NUMBER = dep.T_SVODACCOUNT and con.T_BRANCH = dep.T_FNCASH and "
                                         " dep.T_CODE_CURRENCY = :CODE_CURRENCY ");
                findAccount.AddParam("ID", RSDBP_IN, ExtContrID);
                findAccount.AddParam("branch", RSDBP_IN, ExtBranch);
                findAccount.AddParam("CODE_CURRENCY", RSDBP_IN, code_cur);
                rs_findAccount = RsdRecordset(findAccount);
                if ( not rs_findAccount.moveNext() )
                  return 16550;
                end;
                if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
                  if ( rs_findAccount.value("T_FNCASH") != TObjectID.Branch )
                   return 16554;
                  end;
                end;
                if ( (rs_findAccount.value("t_open_close") != strfor(0))
                     or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
                  SetParm (0,rs_findAccount);
                  return 16512;
                end;
              end;
          else
            return 16535;
          end;
        end;
      end;
    elif ( (TObjectID.ObjectType == 554) or (TObjectID.ObjectType == 552) )  // ¡ ­ª®¢áª ï ª àâ  retail ¨«¨ ¤®£®¢®à ¡ ­ª®¢áª®© ª àâë
      if ( TObjectID.IDType == 1 )
         findAccByProdId = true;
      elif ( TObjectID.IDType == 2 )
         findAccByNumber = true;
      else
        return 16531;
      end;

      if ( TObjectID.ObjectType == 552 )
        if ( findAccByNumber )
          var findCardByNum = rsdcommand("select crd.* from dsccard_dbt crd, drt_contract_dbt con where "
                                         " crd.t_currentcntrcard = 'X' AND "
                                         " CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH AND "
                                         " CON.T_BRANCH = (select t_code from ddp_dep_dbt where t_name = :branch) AND CON.T_NUMBER = :ConNumber ");
          findCardByNum.AddParam("branch", RSDBP_IN, TObjectID.Branch);
          findCardByNum.AddParam("ConNumber", RSDBP_IN, TObjectID.ID);
          findCardByNum.nullConversion = true;
          findCardByNum.execute();
          var rs_findCardByNum = RsdRecordset(findCardByNum);
          if ( not rs_findCardByNum.moveNext() )
            return 16551;
          end;
          TObjectID.ID = rs_findCardByNum.value("T_CARDNUMBER");
          findAccByNumber = true;
        elif ( findAccByProdId )
          ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
          ExtContrID = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
          var findCardByID = rsdcommand("select crd.* from dsccard_dbt crd, drt_contract_dbt con where "
                                        " crd.t_currentcntrcard = 'X' AND "
                                        " CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH AND"
                                        " CON.T_BRANCH = :branch AND CON.T_ID = :ConId ");
          findCardByID.AddParam("branch", RSDBP_IN, ExtBranch);
          findCardByID.AddParam("ConId", RSDBP_IN, ExtContrID);
          findCardByID.nullConversion = true;
          findCardByID.execute();
          var rs_findCardById = RsdRecordset(findCardByID);
          if ( not rs_findCardById.moveNext() )
            return 16551;
          end;
          if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
            if ( rs_findCardById.value("T_FNCASH") != TObjectID.Branch )
              return 16554;
            end;
          end;
          TObjectID.ID = String(ExtBranch) + "/" + rs_findCardById.value("T_CARDREF");
          findAccByProdId = true;
        end;
      end;

      if ( findAccByNumber )
        var strfindAcc = "select dep.* from dsccard_dbt crd, ddepositr_dbt dep, dsclink_dbt lnk where "
                         " CRD.T_CARDNUMBER = :cardNum AND "
                         " LNK.T_FNCASH = CRD.T_FNCASH AND LNK.T_CARDREF = CRD.T_CARDREF AND LNK.T_CARDACCREF = DEP.T_REFERENC ";
        if ((ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != ""))
          strfindAcc = strfindAcc +" AND CRD.T_FNCASH = (select t_code from ddp_dep_dbt where t_name = :branch) ";
        end;
        if (FindParam.FindOKCard)
        /*
          strfindAcc = strfindAcc + " AND CRD.T_CARDSTATECODE in (select t_codcode from dsccodif_dbt " +
                                    " where t_codtype = 6 and (t_psref in (0, crd.t_psref) and t_codcode = :state or t_similarcodcode = :state)) ";*/
          strfindAcc = strfindAcc + " AND T_CARDOPENCLOSE <> CHR (1)";
        end;
        findAccount = rsdcommand( strfindAcc );
        findAccount.AddParam("cardNum", RSDBP_IN, TObjectID.ID);
        if ((ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != ""))
          findAccount.AddParam("branch", RSDBP_IN, TObjectID.Branch);
        end;
/*        if (FindParam.FindOKCard)
          findAccount.AddParam("state", RSDBP_IN, VCardState_OK);
        end;*/
        findAccount.nullConversion = true;
        findAccount.execute();
        rs_findAccount = RsdRecordset(findAccount);
        if ( not rs_findAccount.moveNext() )
          return 16526;
        end;
        if ( (rs_findAccount.value("t_open_close") != strfor(0))
             or ((rs_findAccount.value("t_action") == 2) or (rs_findAccount.value("t_action") == 11)) )
          SetParm (0,rs_findAccount);
          return 16512;
        end;
      elif ( findAccByProdId )
        ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
        ExtCardRef = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
        var strfindAccID = "select dep.* from dsccard_dbt crd, ddepositr_dbt dep, dsclink_dbt lnk where "
                           " CRD.T_CARDREF = :cardRef AND CRD.T_FNCASH = :branch AND "
                           " LNK.T_FNCASH = CRD.T_FNCASH AND LNK.T_CARDREF = CRD.T_CARDREF AND LNK.T_CARDACCREF = DEP.T_REFERENC ";
        if (FindParam.FindOKCard)
          /*strfindAccID = strfindAccID + " AND CRD.T_CARDSTATECODE in (select t_codcode from dsccodif_dbt " +
                                        " where t_codtype = 6 and (t_psref in (0, crd.t_psref) and t_codcode = :state or t_similarcodcode = :state)) ";*/
          strfindAccID = strfindAccID + " AND T_CARDOPENCLOSE <> CHR (1)";
        end;
        findAccount = rsdcommand(strfindAccID);
        findAccount.AddParam("cardRef", RSDBP_IN, ExtCardRef);
        findAccount.AddParam("branch", RSDBP_IN, ExtBranch);
/*        if (FindParam.FindOKCard)
          findAccount.AddParam("state", RSDBP_IN, VCardState_OK);
        end;*/
        findAccount.nullConversion = true;
        findAccount.execute();
        rs_findAccount = RsdRecordset(findAccount);
        if ( not rs_findAccount.moveNext() )
          return 16526;
        end;
        if ( (ValType(TObjectID.Branch) == V_STRING) and (TObjectID.Branch != "") )
          if ( rs_findAccount.value("T_FNCASH") != TObjectID.Branch )
            return 16554;
          end;
        end;
      end;
   else
     return 16530;
   end;

   if ( (ValType(FindParam.Currency) == V_INTEGER) and (FindParam.Currency > 0) )
     findCurr = FindCurrency(FINDCURBYEXT_CODE, FindParam.Currency);
     code_cur = findCurr.value("T_CODE_CURRENCY");
     if ( rs_findAccount.value("T_CODE_CURRENCY") != code_cur )
       return 16520;
     end;
   end;
   if ( rs_findAccount.moveNext() )
     return 16532;
   end;

   SetParm (0,rs_findAccount);
   return 0;
end;


/********************************************************************************\
|                          ˆ‘Š ……”Œ‹…›• ‘—…’‚                          |
\********************************************************************************/
macro findReissueAccount ( rs_findAccount, TObjectID, FindParam )
var stat = findOpenAccount ( rs_findAccount, TObjectID, FindParam );
if ( stat == 16512 )
  var FindReissueAcc = rsdcommand("select dep.* from ddepositr_dbt dep where dep.t_fncash = ? and "
                                       " dep.T_SVODACCOUNT = ? and dep.T_CODE_CURRENCY = ? "
                                       " and dep.t_open_close = chr(0) and dep.t_action <> 2 and dep.t_action <> 11 ");
  FindReissueAcc.AddParam("BranchID", RSDBP_IN, rs_findAccount.value("t_fncash"));
  FindReissueAcc.AddParam("ContrNumber", RSDBP_IN, rs_findAccount.value("T_SVODACCOUNT"));
  FindReissueAcc.AddParam("CODE_CURRENCY", RSDBP_IN, rs_findAccount.value("T_CODE_CURRENCY"));
  FindReissueAcc.nullConversion = true;
  FindReissueAcc.execute();
  var rs_FindReissueAcc = RsdRecordset(FindReissueAcc);
  if (rs_FindReissueAcc.moveNext)
    SetParm (0,rs_FindReissueAcc);
    return 0;
  else 
    stat = 16545;
  end;
elif ( stat > 0 )
  return stat;
end;
SetParm (0,rs_findAccount);
return stat;
end;
/********************************************************************************\
|                           ˆ‘Š ‘—…’€ ‚ €‡… Ÿ„€                              |
\********************************************************************************/
macro isfindKernelAcc( Number : string, Branch : integer )
    var findAccount, rs_findAccount;
    var IsFind = false;
    findAccount = rsdcommand("select * from daccount_dbt where T_ACCOUNT = :AccNumber and "
                             " T_BRANCH = :BranchID and T_OPEN_CLOSE = chr(0)");
    findAccount.AddParam("AccNumber", RSDBP_IN, Number);
    findAccount.AddParam("BranchID", RSDBP_IN, Branch);
    findAccount.nullConversion = true;
    findAccount.execute();
    rs_findAccount = RsdRecordset(findAccount);
    if ( rs_findAccount.moveNext() )
      IsFind = true;
    end;
    return IsFind;
end;

/********************************************************************************\
|                          ‹“—ˆ’œ ˆŠ ‘“š…Š’€                                 |
\********************************************************************************/
macro ®«ãç¨âì¨ª( PartyID:integer, CodeKind:integer ):string
  var select:string = "select t_Code from dpartcode_dbt where t_CodeKind=:CodeKind and t_PartyID =:PartyID";
  if ( PartyID == 0 )
      PartyID = {OurBank};
  end;
  if ( (ValType(CodeKind) != V_INTEGER) or (CodeKind == 0) )
    CodeKind = 3;
  end;
  var params:TArray = makeArray( SQLParam( "CodeKind", CodeKind ),
                                 SQLParam( "PartyID" , PartyID ) );
  var rset:RsdRecordset = execSQLselect( select, params, FALSE );
  if( rset and rset.moveNext() )
    return rset.Value( 0 );
  end;

  return "";
end;

/********************************************************************************\
|                   ™ˆ… „€’Šˆ ˆ ‚›‹…ˆˆ …€–ˆ‰                      |
\********************************************************************************/
macro ‡ ¯®«­¥­¨¥_ƒ€• ( Data )

  if ( ValType(Data.ComissionOut.Sum) == V_MONEY )
     if ( (Data.ComissionOut.Sum != $0L) and (Data.ComissionOut.Sum < $0.01L) )
       RunError( ErrMessage( 16547 ), 16547 );
     end;
  elif ( ValType(Data.ComissionOut.Sum) != V_UNDEF )
     RunError( ErrMessage( 16547 ), 16547 );
  end;

  if ( ValType(Data.ComissionIn.Sum) == V_MONEY )
     if ( (Data.ComissionIn.Sum != $0L) and (Data.ComissionIn.Sum < $0.01L) )
       RunError( ErrMessage( 16547 ), 16547 );
     end;
  elif ( ValType(Data.ComissionIn.Sum) != V_UNDEF )
     RunError( ErrMessage( 16547 ), 16547 );
  end;


  StoreValue("EXTPROCMSG_CODE", Data.ExternalSystem + "/" + Data.ExternalPayCode);
  if ( (ValType(Data.ComissionType) == V_INTEGER) and (Data.ComissionType > 0) )
    StoreValue("Operation:’¨¯@Š®¬¨áá¨ï", Data.ComissionType);
  elif ( (ValType(Data.ComissionType) != V_INTEGER) )
    if ( ((ValType(Data.ComissionOut.Sum) == V_MONEY) and (Data.ComissionOut.Sum >= $0.01L)) or
         ((ValType(Data.ComissionIn.Sum) == V_MONEY) and (Data.ComissionIn.Sum >= $0.01L)) )
      StoreValue("Operation:’¨¯@Š®¬¨áá¨ï", 1);
    else
      StoreValue("Operation:’¨¯@Š®¬¨áá¨ï", 2);
    end;
  end;
  if ( (ValType(Data.ComissionKind) == V_INTEGER) and (Data.ComissionKind > 0 ) )
    StoreValue("Operation:‚¨¤@Š®¬¨áá¨ï", Data.ComissionKind);
  else
    StoreValue("Operation:‚¨¤@Š®¬¨áá¨ï", 0);
  end;
  if ( (ValType(Data.ComissionOut.Sum) == V_MONEY) and (Data.ComissionOut.Sum > $0L) )
    StoreValue("Operation:‘ã¬¬ @Š®¬¨áá¨ï", Data.ComissionOut.Sum);
  elif ( (ValType(Data.ComissionIn.Sum) == V_MONEY) and (Data.ComissionIn.Sum > $0L) )
    StoreValue("Operation:‘ã¬¬ @Š®¬¨áá¨ï", Data.ComissionIn.Sum);
  else
    StoreValue("Operation:‘ã¬¬ @Š®¬¨áá¨ï", $0);
  end;

  if ( (ValType(Data.ComissionOut.Currency) == V_STRING) and (Data.ComissionOut.Currency != "") )
    StoreValue("Operation:‚ «îâ @Š®¬¨áá¨ï", Data.ComissionOut.Currency);
  elif ( (ValType(Data.ComissionIn.Currency) == V_STRING) and (Data.ComissionIn.Currency != "") )
    StoreValue("Operation:‚ «îâ @Š®¬¨áá¨ï", Data.ComissionIn.Currency);
  else
    StoreValue("Operation:‚ «îâ @Š®¬¨áá¨ï", "");
  end;

  if ( (ValType(Data.OperSubType) == V_INTEGER) and (Data.OperSubType > 0) )
    StoreValue("Operation:‚¨¤‘¯¨á ­¨ï@Š®¬¨áá¨ï", Data.OperSubType);
  else
    StoreValue("Operation:‚¨¤‘¯¨á ­¨ï@Š®¬¨áá¨ï", 0);
  end;

  if ( (ValType(Data.Account) == V_INTEGER) and (Data.Account != 0) )
    StoreValue("Operation:‘ç¥â@Š®¬¨áá¨ï", Data.Account);
  else
    StoreValue("Operation:‘ç¥â@Š®¬¨áá¨ï", 0);
  end;
end;

/********************************************************************************\
|                         ‹“—…ˆ… €€Œ…’‚ „€‡„…‹…ˆŸ                     |
\********************************************************************************/
macro FindBranch (SearchParam : integer, Data)
  var sql = "select * from ddp_dep_dbt where ";
  var FindFncash, rs_FindFncash;
  if ( SearchParam == FINDBRANCH_BY_NUMBER )
    sql = sql + " T_CODE = ? ";
    FindFncash = rsdcommand(sql);
    FindFncash.AddParam("branch", RSDBP_IN, Int(Data));
  elif ( SearchParam == FINDBRANCH_BY_NAME )
    sql = sql + " T_NAME = ? ";
    FindFncash = rsdcommand(sql);
    FindFncash.AddParam("name", RSDBP_IN, string(Data));
  else
   ;
  end;
  FindFncash.nullConversion = true;
  FindFncash.execute;
  rs_FindFncash = RsdRecordset(FindFncash);
  if ( rs_FindFncash.moveNext )
    return rs_FindFncash;
  else
    RunError( ErrMessage( 16504 ), 16504 );
  end;
end;


/********************************************************************************\
|                         ‹“—…ˆ… ’…Š“™…ƒ ”ˆ‹ˆ€‹€                             |
\********************************************************************************/
macro GetFilial (branch : integer)
  var NodeType = 0;
  var findFilial = rsdcommand("select * from ddp_dep_dbt where T_CODE = :branch");
  findFilial.AddParam( "branch", RSDBP_IN, branch );
  findFilial.nullConversion = true;
  findFilial.execute();
  var rs_findFilial = RsdRecordset(findFilial);
  rs_findFilial.moveNext();
  NodeType = rs_findFilial.value("T_NODETYPE");
  while ( NodeType != 1 )
    branch = rs_findFilial.value("T_PARENTCODE");
    findFilial = rsdcommand("select * from ddp_dep_dbt where T_CODE = :branch");
    findFilial.AddParam( "branch", RSDBP_IN, branch );
    rs_findFilial = RsdRecordset(findFilial);
    rs_findFilial.moveNext();
    NodeType = rs_findFilial.value("T_NODETYPE");
  end;
  return rs_findFilial.value("T_CODE");
end;


macro fillBankInfo(Fncash : integer, isNationalCur : bool ,item:TIncrementDetailsItem)
  var ourBank_BIC_SWIFT = "";
  var ourBank_Name = "";
  var ourBank_CorrAcc = "";
  var ourBank_INN = "";
  var ourBank_KPP = "";
  var ourBankID = 0;
  var stat = 0;
  var filcode = GetFilial( Fncash );
  var needNextFind = true;
  var ddep =  TRecHandler( "i_dp_dep.rec" ), party = TRecHandler( "i_party.rec" );

  while (needNextFind)
    stat = findDepartment(filcode, NULL, ddep, party);
    if (stat)
      if ( (ourBankID <= 0) and (ourBank_Name == "") )
        ourBank_Name = party.rec.Name;
        ourBankID  = party.rec.partyID;
      end;
      if (ourBank_CorrAcc == "")
        var findCorAcc = rsdcommand("select * from dbankdprt_dbt where T_PARTYID = ?");
        findCorAcc.AddParam( "ID", RSDBP_IN, party.rec.partyID );
        findCorAcc.nullConversion = true;
        findCorAcc.execute();
        var rs_findCorAcc = RsdRecordset(findCorAcc);
        if (rs_findCorAcc.moveNext)
          ourBank_CorrAcc = rs_findCorAcc.value("T_CORACC");
        end;
      end;
      if ((isNationalCur) and (ourBank_BIC_SWIFT == "") )
        ourBank_BIC_SWIFT = findPartyCode( party.rec.partyID, I_PTCK_BIC );
      elif ((not isNationalCur) and (ourBank_BIC_SWIFT == "") )
        ourBank_BIC_SWIFT = findPartyCode( party.rec.partyID, 6 );
      end;
      if ( (ourBank_BIC_SWIFT != "") and (ourBank_CorrAcc != "") )
        needNextFind = false;
      end;
      filcode = ddep.rec.ParentCode;
      if (ddep.rec.ParentCode == 0)
        needNextFind = false;
      end;
    else
      needNextFind = false;
    end;
  end;

  item.BankID = ourBankID;
  if (isNationalCur)
    item.BankCodeKind = 3;
  else
    item.BankCodeKind = 6;
  end;
  item.BankCode = ourBank_BIC_SWIFT;
  item.BankName = ourBank_Name;
  item.CorAccount = ourBank_CorrAcc;
end;


macro findAccountByContract ( rs_findAccount, TObjectID )
  var findConByProdId = false, findConByNumber = false;
  var sqlfindAcc = "SELECT DEP.* " +
                   " FROM ddepositr_dbt dep, drt_contract_dbt con " +
                   " WHERE DEP.T_SVODACCOUNT = CON.T_NUMBER AND DEP.T_FNCASH = CON.T_BRANCH ";
  if ( (ValType(TObjectID.ID) != V_STRING) or (TObjectID.ID == "") )
    return 16520;
  end;
  if ( (TObjectID.IDType == 2) and ((ValType(TObjectID.Branch) != V_STRING) or (TObjectID.Branch == "")) )
    return 16520;
  end;
  if ( (TObjectID.ObjectType == 550) or (TObjectID.ObjectType == 556) )
    if ( TObjectID.IDType == 1 )
       findConByProdId = true;
    elif ( TObjectID.IDType == 2 )
       findConByNumber = true;
    else
      return 16531;
    end;
    
    var ExtBranch, ExtContrID;    
    if ( findConByProdId )
      ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
      ExtContrID = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
      sqlfindAcc = sqlfindAcc + " AND CON.T_ID = ? AND CON.T_BRANCH = ? "
    elif ( findConByNumber )
      sqlfindAcc = sqlfindAcc + " AND CON.T_BRANCH = (SELECT t_code FROM ddp_dep_dbt "
                               " WHERE t_name = ?) AND CON.T_NUMBER = ? "
    else
      return 16504;
    end;
    sqlfindAcc = sqlfindAcc + " ORDER BY DEP.T_OPEN_DATE ASC, DEP.T_CODE_CURRENCY ASC ";
    
    var findAcc = Rsdcommand(sqlfindAcc);
    if ( findConByProdId )
      ExtBranch = int(SubStr(TObjectID.ID, 1, StrBrk(TObjectID.ID,"/")));
      ExtContrID = int(SubStr(TObjectID.ID, StrBrk(TObjectID.ID,"/") + 1));
      findAcc.AddParam("ID", RSDBP_IN, ExtContrID);
      findAcc.AddParam("branch", RSDBP_IN, ExtBranch);
    elif ( findConByNumber )
      findAcc.AddParam("BranchID", RSDBP_IN, TObjectID.Branch);
      findAcc.AddParam("ContrNumber", RSDBP_IN, TObjectID.ID);
    else
      return 16504;
    end;

    findAcc.nullConversion = true;
    findAcc.execute();
    rs_findAccount = RsdRecordset(findAcc);
    if ( not rs_findAccount.moveNext )
      if ( findConByProdId )
        return 16505;
      elif ( findConByNumber )
        return 16529;
      else
        return 16511;
      end;
    end;
    
  else
    return 16530;
  end;
  SetParm (0,rs_findAccount);
  return 0;
end;

/*******************************************************************************************************************\
|€‘ˆƒ ‘’Šˆ …€–ˆ‰   âà®ª  ¢ ¢¨¤¥ <{<®¯¥à æ¨ï>[/{<¯®¤¢¨¤>}]} {;<®¯¥à æ¨ï>[/{<¯®¤¢¨¤>}]}> à¨¬¥à:  <3/1;4;10/2>|
\*******************************************************************************************************************/
class OperCod
  var Oper : integer;
  var SubOper : integer;
end;
macro ParseOperCodes ( ExData )

  var retCode = TArray;
  var Data = trimallspace_str( ExData );
  if ( (ValType(Data) != V_STRING) or (Data == "") )
    return 0;
  end;
  var len = StrLen(Data);
  var i = 0;
  for ( i, 1, len )
    if ( SubStr(Data,i,1) == "/" )
      if ( (i < len) and (SubStr(Data,i+1,1) == "/") );
        RunError( ErrMessage( 16539 ), 16539 );
      end;
    elif ( SubStr(Data,i,1) == ";" )
      if ( (i < len) and (SubStr(Data,i+1,1) == ";") );
        RunError( ErrMessage( 16539 ), 16539 );
      end;
    elif ( StrIsNumber(SubStr(Data,i,1)) == false )
      RunError( ErrMessage( 16539 ), 16539 );
    end;
  end;
  var op = "", subop = "";
  var oper = 0,suboper = 0;
  for ( i, 1, len )
    var codes = OperCod;
    if ( StrIsNumber(SubStr(Data,i,1)) == true )
      if ( oper == 0 )
        op = op + SubStr(Data,i,1);
      else
        subop = subop + SubStr(Data,i,1);
      end;    
    end;

    if ( SubStr(Data,i,1) == "/" )
      oper = int(op);
    end;
    if ( (SubStr(Data,i,1) == ";") and (oper > 0) )
      suboper = int(subop);
      codes.Oper = oper;
      codes.SubOper = suboper;
      oper = 0; suboper = 0; op = ""; subop = "";
      retCode[retCode.size] = codes;
    elif ( (SubStr(Data,i,1) == ";") and (oper == 0) )
      oper = int(op);
      codes.Oper = oper;
      codes.SubOper = null;
      oper = 0; suboper = 0; op = ""; subop = "";
      retCode[retCode.size] = codes;
    elif ( i == len )
      if ( op == "" )
        oper = 0;
      else
        oper = int(op);
      end;
      if ( subop == "" )
        suboper = null;
      else
        suboper = int(subop);
      end;
      codes.Oper = oper;
      codes.SubOper = suboper;
      oper = 0; suboper = 0; op = ""; subop = "";
      retCode[retCode.size] = codes;
    end;

  end;
  return retCode;
end;

/********************************************************************************\
|             ‹“—…ˆ… Š„€ €Š€ (€—ˆ€Ÿ ‘ „€‡„…‹…ˆŸ)                     |
\********************************************************************************/
macro findBankCode( BankKodeKind : integer, Fncash : integer, item : TIncrementDetailsItem )
  var ourBankCode = "";
  var ourBankID = 0;
  var ourBank_Name = "";
  var stat = 0;
  var filFNcash = Fncash;
  var needNextFind = true;
  var ddep =  TRecHandler( "i_dp_dep.rec" ), party = TRecHandler( "i_party.rec" );

  stat = findDepartment(GetFilial( Fncash ), NULL, ddep, party);
  if (stat)
    ourBank_Name = party.rec.Name;
    ourBankID  = party.rec.partyID;
  end;

  while (needNextFind)
    stat = findDepartment(filFNcash, NULL, ddep, party);
    if (stat)
      if ( ourBankCode == "" )
        ourBankCode = findPartyCode( party.rec.partyID, BankKodeKind );
      end;
      if (ourBankCode != "")
        needNextFind = false;
      end;
      if (ddep.rec.ParentCode == 0)
        needNextFind = false;
      end;
      if (needNextFind)
        filFNcash = ddep.rec.ParentCode;
      end;
    else
      needNextFind = false;
    end;
  end;
  item.BankID = ourBankID;
  item.BankCodeKind = BankKodeKind;
  item.BankCode = ourBankCode;
  item.BankName = ourBank_Name;
end;

/********************************************************************************\
|               ‹“—…ˆ… Œ…€ ’…Š“™…‰ Š€’›  …”……‘“ ‘—ğ’€                |
\********************************************************************************/
macro getCardNumberByAccRef(cardAccRef : integer) : string
  var number = "";
  
  var cmd = RsdCommand(
      "select CRD.T_CARDNUMBER from dsccard_dbt crd, dsclink_dbt lnk "
      "where LNK.T_CARDACCREF = ? "
      "  and LNK.T_ACCCARDLINKOPENCLOSE = chr(0) "
      "  and CRD.T_FNCASH = LNK.T_FNCASH "
      "  and CRD.T_CARDREF = LNK.T_CARDREF "
      "  and CRD.T_CARDOPENCLOSE = chr(0) "
      "  and CRD.T_CURRENTCNTRCARD = 'X' "
  );
  cmd.addParam("cardAccRef", RsdBp_In, cardAccRef);
  cmd.nullConversion = true;
  cmd.execute;

  var rs = RsdRecordset(cmd);
  if (rs.moveNext())
    number = rs.value("T_CARDNUMBER");
  end;

  return number;
end;

/********************************************************************************\
|             ‚…Š€ €€Œ…’‚ ŠŒ. ‹€’…†€, €€‚‹Ÿ…Œƒ ‚ ƒˆ‘ †Š•          |
\********************************************************************************/
macro checkZHKHData( ZHKHData /* : TZHKHData */ )
  if( (ValType(ZHKHData.CPAccount) == V_STRING) and (ZHKHData.CPAccount != "") )
  ;
  elif( (ValType(ZHKHData.PaymentDocumentID) == V_STRING) and (ZHKHData.PaymentDocumentID != "") )
  ;
  elif ( (ValType(ZHKHData.PaymentDocumentNumber) == V_STRING) and (ZHKHData.PaymentDocumentNumber != "") )
  ;
  elif ( (ValType(ZHKHData.UnifiedAccountNumber) == V_STRING) and (ZHKHData.UnifiedAccountNumber != "") )
  ;
  elif ( (ValType(ZHKHData.ServiceID) == V_STRING) and (ZHKHData.ServiceID != "") )
  ;
  elif ( (ValType(ZHKHData.FIASHouseGuid) == V_STRING) and (ZHKHData.FIASHouseGuid != "") and
            (
                ( (ValType(ZHKHData.Surname) == V_STRING) and (ZHKHData.Surname != "") and
                  (ValType(ZHKHData.FirstName) == V_STRING) and (ZHKHData.FirstName != "") ) or
                ( (ValType(ZHKHData.INN) == V_STRING) and (ZHKHData.INN != "") )
            )
       )
  ;
  else
    RunError(ErrMessage(6197), 6197);
  end;  
end;


/********************************************************************************\
|             ˆ‘Š ‘—…’€, ’Š›’ƒ ‚ “Š€‡€Œ ”ˆ‹ˆ€‹…                         |
\********************************************************************************/
macro findAccountByFilial(number : string, filialId : integer, rs_account)
  var whereFncashCond =
      " AND t_fncash IN ("
            " SELECT t_code FROM ddp_dep_dbt"
            " START WITH t_partyid = ?"
            " CONNECT BY PRIOR t_code = t_parentcode)";
  var cmd = RsdCommand( "SELECT * FROM ddepositr_dbt WHERE t_account = ?" + whereFncashCond );
  cmd.addParam("account", RsdBp_In, number);
  cmd.addParam("filialId", RsdBp_In, filialId);
  cmd.nullConversion = true;
  cmd.execute;
  rs_account = RsdRecordset(cmd);
  var stat = rs_account.moveNext();

  // „®¯®«­¨â¥«ì­ë© ¯®¨áª ¡¥§ ãçñâ  ¯®á«¥¤­¨å 2 á¨¬¢®«®¢ ¢ ­®¬¥à¥ áç¥â 
  if ( (stat == false) and (StrLen(number) >= 20) )
    cmd = RsdCommand( "SELECT * FROM ddepositr_dbt WHERE t_account LIKE ?" + whereFncashCond );
    cmd.addParam("account", RsdBp_In, SubStr(number,1,20) + "%");
    cmd.addParam("filialId", RsdBp_In, filialId);
    cmd.nullConversion = true;
    cmd.execute;
    rs_account = RsdRecordset(cmd);
    stat = rs_account.moveNext();
  end;

  if ( stat == false )
    return 16511;
  end;

  if ( (rs_account.value("t_action") == 2) or (rs_account.value("t_action") == 11) )
    SetParm ( 2, rs_account );
    return 16512;
  end;

  SetParm ( 2, rs_account );
  return 0;
end;

/********************************************************************************\
|             ˆ‘Š Š€’›, ’Š›’‰ ‚ “Š€‡€Œ ”ˆ‹ˆ€‹…                          |
\********************************************************************************/
macro findCardByFilial(number : string, filialId : integer, rs_card)
  var cmd = RsdCommand(
    "SELECT * FROM dsccard_dbt"
    " WHERE t_cardnumber = ?"
      " AND t_fncash IN ("
            " SELECT t_code FROM ddp_dep_dbt"
            " START WITH t_partyid = ?"
            " CONNECT BY PRIOR t_code = t_parentcode)" );
  cmd.addParam("cardnumber", RsdBp_In, number);
  cmd.addParam("filialId", RsdBp_In, filialId);
  cmd.nullConversion = true;
  cmd.execute;
  rs_card = RsdRecordset(cmd);

  if ( not rs_card.moveNext() )
    return 16561;
  end;

  SetParm ( 2, rs_card );
  return 0;
end;

/********************************************************************************\
|                           ˆ‘Š ‘‚Ÿ‡ˆ Š€’›-‘—ğ’                               |
\********************************************************************************/
macro findCardAccLink(fncash : integer, cardref : integer, accountRef : integer, rs_link)
  var cmdtext = "SELECT * FROM dsclink_dbt WHERE t_fncash = ? AND t_cardref = ?";
  if ( accountRef != 0 )
    cmdtext = cmdtext + " AND t_cardaccref = ?";
  end;

  var cmd = RsdCommand( cmdtext );
  cmd.addParam("fncash", RsdBp_In, fncash);
  cmd.addParam("cardref", RsdBp_In, cardref);
  if ( accountRef != 0 )
    cmd.addParam("cardaccref", RsdBp_In, accountRef);
  end;
  cmd.nullConversion = true;
  cmd.execute;
  rs_link = RsdRecordset(cmd);

  if ( not rs_link.moveNext() )
    return 16562;
  end;

  SetParm ( 3, rs_link );
  return 0;
end;

/********************************************************************************\
|                               ˆ‘Š ‘—ğ’€                                      |
\********************************************************************************/
macro findDepAccount(accountRef : integer, account : string, branch : integer, rs_account)
  var cmdtext = "SELECT * FROM ddepositr_dbt WHERE";
  if ( accountRef > 0 )
    cmdtext = cmdtext + " t_referenc = ?";
  else
    cmdtext = cmdtext + " t_account = ?";
    if ( branch > 0 )
      cmdtext = cmdtext + " AND t_fncash = ?";
    end;
  end;
  
  var cmd = RsdCommand( cmdtext );
  if ( accountRef > 0 )
    cmd.addParam("referenc", RsdBp_In, accountRef);
  else
    cmd.addParam("account", RsdBp_In, account);
    if ( branch > 0 )
      cmd.addParam("fncash", RsdBp_In, branch);
    end;
  end;
  cmd.nullConversion = true;
  cmd.execute;
  rs_account = RsdRecordset(cmd);

  if ( not rs_account.moveNext() )
    return 16511;
  end;

  if ( rs_account.moveNext() )
    return 16532;
  end;

  SetParm ( 3, rs_account );
  return 0;
end;

/********************************************************************************\
|                  …„…‹…ˆ… €€Œ…’‚ ‹“—€’…‹Ÿ ……‚„€                    |
\********************************************************************************/
macro getRecipientParam(appkind : integer, appkey : string)
  var stat = 0, retval : TExtRecipient;
  var findexpendParam = RsdCommand( "SELECT * FROM drtpaymentprop_dbt WHERE t_DOCAPPLICATIONKIND = ? AND t_DOCAPPLICATIONKEY = ?" );
  findexpendParam.addParam("appkind", RsdBp_In, appkind);
  findexpendParam.addParam("appkey", RsdBp_In, appkey);
  findexpendParam.nullConversion = true;
  findexpendParam.execute;
  var rs_findexpendParam = RsdRecordset(findexpendParam);
  retval.Name = "";
  retval.INN = "";
  retval.KPP = "";
  retval.BankID = 0;
  retval.BankCodeKind = 0;
  retval.BankCode = "";
  retval.BankName = "";
  retval.CorAccount = "";
  retval.Account = "";
  retval.PartyID = 0;

  if ( rs_findexpendParam.moveNext() )
    var rs_FndAcc, account = "", destbranch = 0, accRef = 0;
    var partyid = 0, partyName = "";
    var destINN = "", destKPP = "";
    var isDepositTransfer = false;

    var SBDEPDOC_SPEC  = TBFile( "sbdepdoc.dbt", "r" );
    SBDEPDOC_SPEC.KeyNum = 3;
    ClearRecord(SBDEPDOC_SPEC);
    SBDEPDOC_SPEC.rec.IAPPLICATIONKIND = convertNullInt(appkind);
    SBDEPDOC_SPEC.rec.APPLICATIONKEY = convertNullStr(appkey);
    SBDEPDOC_SPEC.rec.TypeOper = 0;
    if ( GetEQ (SBDEPDOC_SPEC) )
      if ( (SBDEPDOC_SPEC.rec.TypeOper == 65) or (SBDEPDOC_SPEC.rec.TypeOper == 80) or (SBDEPDOC_SPEC.rec.TypeOper == 45) )
        var SBDEPDOC_1_SPEC = TRecHandler("sbdepdoc.1");
        SBDEPDOC_1_SPEC.SetRecordAddr(SBDEPDOC_SPEC,0,0,True);
        accRef = SBDEPDOC_1_SPEC.rec.CorrAcc_Referenc;
        isDepositTransfer = true;
      end;
    end;

    if ( convertNullInt( rs_findexpendParam.value("T_BRANCH") ) > 0 )
      destbranch = convertNullInt( rs_findexpendParam.value("T_BRANCH") );
    end;
    if (convertNullStr( rs_findexpendParam.value("T_ACCOUNT") ) != "")
      account = convertNullStr( rs_findexpendParam.value("T_ACCOUNT") );
    end;
    if ( convertNullInt( rs_findexpendParam.value("T_PARTYID") ) > 0 )
      partyid = convertNullInt( rs_findexpendParam.value("T_PARTYID") );
    end;

    if ( account != "" )
      stat = findDepAccount( 0, account, destbranch, rs_FndAcc );
      if ( stat == 0 )
        destbranch = convertNullInt(rs_FndAcc.value("T_FNCASH"));
        partyid = convertNullInt(rs_FndAcc.value("T_CODCLIENT"));
      end;
      if ( partyid == 0 )
        var FndAcc = rsdcommand("select * from daccount_dbt where t_account = ?");
        FndAcc.AddParam("number", RSDBP_IN, account);
        FndAcc.nullConversion = true;
        FndAcc.execute;
        rs_FndAcc = RsdRecordset(FndAcc);
        if ( rs_FndAcc.moveNext )
          partyid = convertNullInt(rs_FndAcc.value("T_CLIENT"));
          destbranch = convertNullInt(rs_FndAcc.value("T_BRANCH"));
        end;
      end;
    end;
    if ( ((partyid == 0) or (account == "")) and (accRef > 0) )
      stat = findDepAccount( accRef, 0, 0, rs_FndAcc );    
      if ( stat == 0 )
        if ( (account == "") or (account == convertNullStr(rs_FndAcc.value("T_ACCOUNT"))) )
          destbranch = convertNullInt(rs_FndAcc.value("T_FNCASH"));
          partyid = convertNullInt(rs_FndAcc.value("T_CODCLIENT"));
        end;
      end;
    end;

    if ( partyid > 0 )
      var partyparm = rsdcommand("select * from dparty_dbt where T_PARTYID = ?");
      partyparm.AddParam("id", RSDBP_IN, partyid);
      partyparm.nullConversion = true;
      partyparm.execute;
      var rs_partyparm = RsdRecordset(partyparm);
      if ( rs_partyparm.moveNext )
        partyName = convertNullStr(rs_partyparm.value("T_NAME"));
      end;
      var PartyCode = getPartyINN(partyid, 1);
      SplitFullINN(PartyCode, destINN, destKPP);
    end;

    if (convertNullStr( rs_findexpendParam.value("T_INN") ) != "")
      retval.INN = convertNullStr( rs_findexpendParam.value("T_INN") );
    else
      retval.INN = destINN;
    end;

    if (convertNullStr( rs_findexpendParam.value("T_KPP") ) != "")
      retval.KPP = convertNullStr( rs_findexpendParam.value("T_KPP") );
    else
      retval.KPP = destKPP;
    end;
    
    if ( isDepositTransfer )
      retval.Account = SubStr(account,1,20);
    else
      retval.Account = account;    
    end;

    var BankName = "", CorAccount = "", Bank_INN, Bank_KPP, BankID = 0;
    if ( convertNullStr( rs_findexpendParam.value("T_BANKCODE") ) != "" )
      iFindBank( convertNullInt( rs_findexpendParam.value("T_BANKCODEKIND") ),
                 convertNullStr( rs_findexpendParam.value("T_BANKCODE") ), 
                 BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
      retval.BankID = convertNullInt(BankID);
      retval.BankCodeKind = convertNullInt( rs_findexpendParam.value("T_BANKCODEKIND") );
      retval.BankCode = convertNullStr( rs_findexpendParam.value("T_BANKCODE") );
    elif ( destbranch > 0 )
      var item = TIncrementDetailsItem;
      findBankCode( PTCK_BIC, destbranch, item );
      retval.BankID = item.BankID;
      retval.BankCodeKind = item.BankCodeKind;
      retval.BankCode = item.BankCode;
      BankName = item.BankName;
      var bankinfo = TIncrementDetailsItem;
      fillBankInfo(destbranch, true, bankinfo);
      CorAccount = bankinfo.CorAccount;
    else
      retval.BankID = 0;
      retval.BankCodeKind = 0;
      retval.BankCode = "";
    end;

    if (convertNullStr( rs_findexpendParam.value("T_BANKNAME") ) != "")
      retval.BankName = convertNullStr( rs_findexpendParam.value("T_BANKNAME") );
    else
      retval.BankName = BankName;
    end;

    if (convertNullStr( rs_findexpendParam.value("T_CORRACCOUNT") ) != "")
      retval.CorAccount = convertNullStr( rs_findexpendParam.value("T_CORRACCOUNT") );
    else
      retval.CorAccount = CorAccount;
    end;

    if ( convertNullStr( rs_findexpendParam.value("T_NAME") ) != "" )
      retval.Name = convertNullStr( rs_findexpendParam.value("T_NAME") );
    else
      retval.Name = partyName;
    end;

    if ( convertNullInt( rs_findexpendParam.value("T_PARTYID") ) != 0 )
      retval.PartyID = convertNullInt( rs_findexpendParam.value("T_PARTYID") );
    else
      retval.PartyID = partyid;
    end;

    if ( (SBDEPDOC_SPEC.rec.TypeOper == 65) or (SBDEPDOC_SPEC.rec.TypeOper == 80) or (SBDEPDOC_SPEC.rec.TypeOper == 45)  )
      var specfind = rsdcommand( "select * from ddepositr_dbt where t_account = ? and t_type_account = ? and t_code_currency = ?");
      specfind.AddParam("acc", RSDBP_IN, convertNullStr( rs_findexpendParam.value("T_ACCOUNT")));
      specfind.AddParam("type_acc", RSDBP_IN, convertNullStr( rs_findexpendParam.value("T_CORRACCOUNT")));
      specfind.AddParam("code_cur", RSDBP_IN, convertNullInt( rs_findexpendParam.value("T_ACCOUNT_CURRCODE")));
      specfind.nullConversion = true;
      var rs_specfind = rsdRecordset(specfind);
      if ( rs_specfind.moveNext )
        var specbankinfo = TIncrementDetailsItem;
        fillBankInfo(convertNullInt( rs_specfind.value("T_FNCASH") ), true, specbankinfo);
        retval.CorAccount = specbankinfo.CorAccount;
      end;
    end;
  end;

  return retval;
end;

/********************************************************************************\
|                           …„…‹…ˆ… ‘’€’Š€  ‘—ğ’“                         |
\********************************************************************************/
macro getAccountRest(accountRef : integer, pdate : date) : money
  var cmdtext = "SELECT T_REST FROM dsbdepdoc_dbt WHERE T_REFERENC = ?";

  if ( (ValType(pdate) != V_UNDEF) and (pdate != date(0,0,0)) )
    cmdtext = cmdtext + " AND T_DATE_DOCUMENT <= ? ";
  end;

  cmdtext = cmdtext + 
      " AND t_Action <> 2" +
      " AND t_Action <> 11" +
      " AND t_KindOp <> 8" +
      " AND t_KindOp <> 9" +
      " AND t_KindOp <> 14" +
      " AND t_KindOp <> 15" +
      " AND t_KindOp <> 16" +
      " AND t_TypeOper <> 38" +
      " AND t_TypeOper <> 39" +
      " AND t_Mode <> 2" +
      " AND bitand(t_flags, 131072) = 0" + // BIT_FLAG_HIDDEN
      " AND ROWNUM = 1" +
    " ORDER BY T_REFERENC, T_DATE_DOCUMENT DESC, T_NUMDAYDOC DESC";
    
  var cmd = RsdCommand(cmdtext);
  cmd.addParam("referenc", RsdBp_In, accountRef);
  
  if ( (ValType(pdate) != V_UNDEF) and (pdate != date(0,0,0)) )
    cmd.addParam("pdate", RsdBp_In, pdate);
  end;
  
  cmd.nullConversion = true;
  cmd.execute;
  var rs = RsdRecordset(cmd);
  if ( rs.moveNext() )
    return rs.value(0);
  end;
  return 0;
end;

/********************************************************************************\
|                    …„…‹…ˆ… ‘’€’Š€  ‘“‘—ğ’“ Š€’›                       |
\********************************************************************************/
macro getCardRest(linkRef : integer, branch : integer, pdate : date) : money
  var cmdtext = "SELECT T_REST FROM dsccrddoc_dbt WHERE T_acccardlinkref = ? AND T_fncash = ?";
  
  if ( (ValType(pdate) != V_UNDEF) and (pdate != date(0,0,0)) )
    cmdtext = cmdtext + " AND T_DATE <= ? ";
  end;

  cmdtext = cmdtext + 
      " AND t_Action <> 2" +
      " AND t_Action <> 11" +
      " AND ROWNUM = 1" +
    " ORDER BY T_FNCASH, T_ACCCARDLINKREF, T_DATE DESC, T_NUMDAYDOC DESC";
    
  var cmd = RsdCommand(cmdtext);
  cmd.addParam("linkRef", RsdBp_In, linkRef);
  cmd.addParam("branch", RsdBp_In, branch);
  
  if ( (ValType(pdate) != V_UNDEF) and (pdate != date(0,0,0)) )
    cmd.addParam("pdate", RsdBp_In, pdate);
  end;
  
  cmd.nullConversion = true;
  cmd.execute;
  var rs = RsdRecordset(cmd);
  if ( rs.moveNext() )
    return rs.value(0);
  end;
  return 0;
end;

/********************************************************************************\
|      …„…‹…ˆ… €‹ˆ—ˆŸ Š€’, ‚ ’Š›’Œ ‘‘’Ÿˆˆ € ‡€„€“ „€’“           |
\********************************************************************************/
macro isExistsOpenCards(accountRef : integer, pdate : date)
  var cmd = RsdCommand( 
    "SELECT 1 FROM DUAL WHERE EXISTS("
      " SELECT t.t_cardref FROM dsccard_dbt t, dsclink_dbt lnk"
      " WHERE lnk.t_cardref = t.t_cardref"
        " AND lnk.t_cardaccref = ?"
        " AND lnk.t_fncash = t.t_fncash"
        " AND t.T_CardOpenDate <= ?"
        " AND (t.T_CardOpenClose = CHR (0) OR t.T_CardCloseDate > ?))" );
  cmd.addParam("referenc", RsdBp_In, accountRef);
  cmd.addParam("opendate", RsdBp_In, pdate);
  cmd.addParam("closedate", RsdBp_In, pdate);
  cmd.nullConversion = true;
  cmd.execute;
  var rs = RsdRecordset(cmd);
  if ( rs.moveNext() )
    return true;
  end;
  return false;
end;


macro checkDoublerClientList(list): bool
  if (list)
    var clnt;
    for (clnt, list)
      if ((ValType(clnt.LocalID) != V_STRING) or (clnt.LocalID == "") or (clnt.LocalID == "0"))
        return false;
      end;
    end;
  end;

  return true;
end;

