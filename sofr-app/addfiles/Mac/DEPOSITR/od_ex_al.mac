/*
**  Операционный дневник.
**  Валютообменные операции. Отчет по базам ОП.
**  Общие функции
*/
import ExchangeInter, "define.mac", /*"rstrfunc.mac",*/ "opertdy2.mac";

file Session  ( "session.dbt",  "exchange.def" ) key 1;
file Operat   ( "exoperat.dbt", "exchange.def" ) key 4;
file Reestr   ( "reestr.dbt",   "exchange.def" ) key 4;
file TmpOperat( "exop_tmp.dbt", "exchange.def" ) key 0 write;
file Operset  ( "exopset.dbt",  "exchange.def" ) key 0;
const NameTmpOperat = "exop_tmp.dbt";
/*file RstTypes ( "rsttypes.dbt","exchange.def" ) key 1;RA 07-03-01 - не нужен */
record RetIncass ( "retincas.str", "exchange.def" );

const ON = 1, OFF = 0;

/***************************************************************************
 Подсчитать штучные ценности
 ( вспомогательный макрос для CalcValuesTurnsByReestr )
***************************************************************************/
MACRO CalcPieceValues( Credit, Debet )
  if(     ( TmpCashVal.UnitMeas != RESMESUNIT_MIXED )
      AND ( TmpCashVal.UnitMeas != RESMESUNIT_POINT )
    )
    Credit = 0;
    Debet  = 0;
  end;
  /* RA 18-11-01 для ПД учет только по сумме независимо от настройки ресурса */
  if( TmpCashVal.TypeValue == TYPERES_PAYDOC )
    Credit = 0;
    Debet  = 0;
  end;
  SetParm( 0, Credit );
  SetParm( 1, Debet  );
END;

/***************************************************************************
      Подсчет количества полученных и выданных ценностей по реестру
***************************************************************************/
MACRO CalcValuesTurnsByReestr( Branch, ID, Q_In, Q_Out )

  var OldKey, loop;
  var In, Out;

  Q_In  = 0;
  Q_Out = 0;

  OldKey = KeyNum( Operat, 6 );
  ClearRecord( Operat );

  Operat.Branch     = Branch;
  Operat.Reestr_Ref = ID;

  loop = GetEQ( Operat );

  while(       loop
         AND ( Operat.Branch     == Branch )
         AND ( Operat.Reestr_Ref == ID     )
       )

      if( not Operat.NotConfirmed )
        In = Out = 0;
        CalcValuesTurnsEx( Operat.ApplicationKind,
                           Operat.ApplicationKey,
                           In, Out, 0, @CalcPieceValues );
        Q_In  = Q_In  + In;
        Q_Out = Q_Out + Out;
      end;

      loop = Next( Operat );
  end;

  KeyNum( Operat, OldKey );

  SetParm( 2, Q_In  );
  SetParm( 3, Q_Out );

END;

/***************************************************************************
                        Получить курс ЦБ для валюты
                        код валюты - как в ОП
***************************************************************************/
/*                      RA 07-03-01 нужно использовать GetCurrRate()
macro Get_Curr_Rate( Exch_CodeCurr, CBRate )
  var OldKeyNum = KeyNum( RtlCurr, 1 );
  RtlCurr.ExternalCode = string(Exch_CodeCurr);
  while (StrLen(RtlCurr.ExternalCode) < 3)
    RtlCurr.ExternalCode = "0" + RtlCurr.ExternalCode;
  end;
  if( not GetEQ( RtlCurr ) )
    MsgBox("Ошибка при определении курса валюты ", RtlCurr.ExternalCode );
    Exit(1);
  end;    
  if( not GetAllCurrRate( {curdate}, RtlCurr.Code_Currency, CBRate, BuyRate, SellRate ) )
    MsgBox("Ошибка при определении курса валюты ", RtlCurr.ExternalCode );
    Exit(1);
  end;
  KeyNum( RtlCurr, OldKeyNum );
  SetParm( 1, CBRate );
end;
*/
/***************************************************************************
                   Печатает заголовки по валютообменным операции
***************************************************************************/
macro OutExchangeHeaders ( TypeOperation )

  var Str, Line;
  if( IsCur and (not CurrNameDisplayed) )
    [ ];
    PrintnNameCur();
    CurrNameDisplayed  = true;
    SomethingDisplayed = true;
  end;
  if( not HeaderDisplayed )
    OutSubTitle("Валютообменные операции",GetDiaryNumber);
    OutHead();
    HeaderDisplayed    = true;
    SomethingDisplayed = true;
  end;
  if( not OpHeaderDisplayed )
    Заголовок_по_операционисту_ОП;
    OpHeaderDisplayed = true;
    SomethingDisplayed = true;
  end;
  /*
  if( not TypeOperationDisplayed )
    Str = GetNameCodif( TypeOperation, CDF_Oper );
    PrintLn;
    PrintLn(Str);
    Line = MkStr( "-", StrLen(Str) );
    PrintLn(Line);
    PrintLn;
    TypeOperationDisplayed = true;
    SomethingDisplayed = true;
  end;
  */
end;
