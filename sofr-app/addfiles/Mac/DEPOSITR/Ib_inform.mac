/***************************************************************************\
| Ib_inform.mac Система:RS-Retail Автор: Войновский М.                      |
| Информирование внешней системы (повторно)                                 |
| В планировщике или напрямую                                               |
\***************************************************************************/
 import deprintr, rsd, alg_vars, ic_aux;
/*---------- Инициализируемые структуры ---------------------------------*/
private var {curdate};
FILE ResExt ("ResInformExtSystem") txt write;

var needSendAccInf = rsdcommand("SELECT * FROM dopobject_dbt WHERE T_OBJECTTYPE = 11002 AND T_OBJECTREF = CHR(0)");
needSendAccInf.execute();
var rs_needSendAccInf = RsdRecordset(needSendAccInf);
if (not rs_needSendAccInf.moveNext())
  ALG_RESULT=SKIP_RES;
else
  var filestat = open(ResExt);
  var needSend = true;
  while (needSend)
    var res = Сообщить_о_движении_по_счету(rs_needSendAccInf.value("T_OPAPPKIND"), rs_needSendAccInf.value("T_OPAPPKEY"));
    if ((res.ReqID != "") and (res.Result == 0))
      var insertOPObj = rsdcommand("UPDATE dopobject_dbt SET T_OBJECTREF = ? WHERE T_OBJECTTYPE = 11002 AND T_OBJECTREF = CHR(0) AND T_OPAPPKIND = ? AND T_OPAPPKEY = ?");
      insertOPObj.AddParam("OBJECTREF",RSDBP_IN, res.ReqID);
      insertOPObj.AddParam("OPAPPKIND",RSDBP_IN,rs_needSendAccInf.value("T_OPAPPKIND"));
      insertOPObj.AddParam("OPAPPKEY",RSDBP_IN,rs_needSendAccInf.value("T_OPAPPKEY"));
      insertOPObj.execute();
    end;
    needSend = rs_needSendAccInf.moveNext();
    ALG_RESULT=OK_RES;
    if (filestat)
      ResExt.str ="Kind/Key:"+string(rs_needSendAccInf.value("T_OPAPPKIND"))+"/"+rs_needSendAccInf.value("T_OPAPPKEY") + "   ReqID:"+res.ReqID
                   + "   Result:"+string(res.Result) + "   ErrorText:"+string(res.ErrorText) ;
      insert(ResExt);
    end;
  end;
  if (filestat)
    close (ResExt);
  end;
end;
OnError
ALG_RESULT=ERR_RES;

return;
