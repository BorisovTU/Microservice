/*

  ---------------------
  R-Style Software Lab.
  ---------------------
  RS-Retail
  ---------------------
  Макрос проверок для компенсаций 2001 года
  ---------------------
  Проверки при зачислениях компенсаций
  ---------------------
  Шаг операции "Проверки для зачислений"

*/

 import Alg_Vars;

 file compens ( compens ) key 0;

 const
   UPDATE_ALL  = 1,
   UPDATE_DEP  = 2,
   UPDATE_DOC  = 4;

 /* Подвиды операции 74 "Зачисление компенсации" */
 const
   AT01 =  1,  /* Старше 1916 г.р. */
   AT02 =  2,  /* С 1917 по 1929 г.р. */
   AT03 =  3,  /* Насл.1 очереди 1920г */
   AT04 =  4,  /* Инвалиды 1 группы */
   AT05 =  5,  /* Насл.влад.гарант.сб. */
   AT06 =  6,  /* Вкладч.старше 1924г. */
   AT07 =  7,  /* Участники ВОВ */
   AT08 =  8,  /* Насл.1оч. ст.1924г. */
   AT09 =  9,  /* Наследникам 1 очереди инвалидов 1 группы */
   AT10 = 10,  /* Насл.1оч. участн.ВОВ */
   AT11 = 11,  /* Инвал.2гр. ст.1940г. */
   AT12 = 12,  /* Вкладчикам до 16г.р. */
   AT13 = 13,  /* Вкладчикам 17-20г.р. */
   AT14 = 14,  /* Вкладчикам 21-22г.р. */
   AT15 = 15,  /* Вкладчикам 23-24 г.р. */
   AT16 = 16,  /* Инвалидам 1 группы */
   AT17 = 17,  /* На погребение */
   AT18 = 18,  /* Участникам В.О.В. */
   AT19 = 19,  /* Наследникам участников В.О.В. */
   AT20 = 20,  /* Наследн.инвалидов 1г */
   AT21 = 21,  /* Наследникам 1очереди */
   AT22 = 22,  /* Инвалидам 2 группы до 40 г.р. */
   AT23 = 23,  /* 1922 г.р. и старше */
   AT24 = 24,  /* С 1925 по 1928 г.р. */
   AT25 = 25,  /* Родитель детей-инвалидов */
   AT26 = 26,  /* На уплату ритуальных услуг */
   AT27 = 27,  /* Наследникам 1 очереди по 1928 г.р. */
   AT28 = 28,  /* Наследникам 1 очереди инвалидов 2 группы по 1940 г.р. */
   AT29 = 29,  /* Наследникам 1 очереди родителей инвалидов */
   AT51 = 51,  /* Вкладчикам до 16 г р */
   AT52 = 52,  /* Вкладчикам 17-20 г р */
   AT53 = 53,  /* Вкладчикам 21-22 г р */
   AT54 = 54,  /* Вкладчикам 23-24 г р */
   AT55 = 55,  /* Инвалидам 1 группы */
   AT56 = 56,  /* На погребение */
   AT57 = 57,  /* Участникам ВОВ */
   AT58 = 58,  /* Наследн участников В */
   AT59 = 59,  /* Наследн инвалидов 1г */
   AT60 = 60,  /* Наследникам 1 очереди  1932 г.р. */
   AT61 = 61,  /* Инв 2группы до 40 г */
   AT62 = 62,  /* Вкладчикам 29-32 г.р. */
   AT63 = 63,  /* Владельцам детских целевых */
   AT64 = 64,  /* Вкладчикам по 1945 г.р. */
   AT65 = 65,  /* Инвалидам 2-й группы по 1950 г.р. */
   AT66 = 66,  /* Бывшим узникам */
   AT67 = 67,  /* Родителям погибших воинов */
   AT68 = 68,  /* Наследникам 1-й очереди по 1945 г.р. */
   AT69 = 69,  /* Наследникам 1-й очереди - инвалидам 2-й группы по 1950 г.р. */
   AT70 = 70,  /* Наследникам 1-й очереди - бывшим узникам */
   AT71 = 71,  /* Вкладчикам по 1932 г. р. */
   AT72 = 72;  /* Наследникам 1-й очереди по 1932 г.р. */

 const
   Compensation1997 = 0,    /* Компенсация 1997 года */
   Compensation1998 = 1,    /* Компенсация 1998 года */
   Compensation2000 = 2,    /* Компенсация 2000 года */
   Compensation2001 = 3,    /* Компенсация 2001 года */
   Compensation2003 = 4,    /* Компенсация 2003 года */
   CompensationCash = 999,  /* Внесена наличными     */
   Compensation2004 = 6;    /* Компенсация 2004 года */
 const
   Limit1 = $6000.00,
   Limit2 = $1000.00, 
   Limit3 = $1000.00;

 const
   sNoCategoria = "Вкладчик не относится к выбранной категории",
   sLimit1 = "Максимальная сумма компенсации за ритуал.услуги = 6000 руб.",
   sLimit2 = "Максимальная сумма компенсации = 1000 руб.", 
   sLimit3 = "Максимальная сумма компенсации = 1000 руб.";

 var ClientList = TClientList;

macro GetAccOwner;

  if ( not ClientList.GetRecord( compens.CodClient ) )
    MsgBox( "Не найден клиент-владелец счета" );
  end;
end;

 var bDay, bMon, bYear;  /* День, месяц, год рождения клиента */

 DateSplit( ALG_COMDEPCLNT.rec.Born, bDay, bMon, bYear );

 ALG_RESULT = OK_RES;

if (compens.Kind == Compensation2004)
 /* Проверка для "Детского целевого" */
 if   ( ALG_SBDEPDOC.ApplType == AT63 )  /* Владельцам детских целевых */
   if ( ALG_COMDEPCLNT.rec.NotResident != StrFor( 0 ) )  /* Не резидент */
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 /* Проверки года рождения */
 elif ( ALG_SBDEPDOC.ApplType == AT01 )  /* Старше 1916 г.р. */
   if ( bYear >= 1916 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT02 )  /* С 1917 по 1929 г.р. */
   if ( ( bYear < 1917 )  OR  ( bYear > 1929 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT03 )  /* Насл.1 очереди 1920г */
   if ( bYear != 1920 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT06 )  /* Вкладч.старше 1924г. */
   if ( bYear >= 1924 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT08 )  /* Насл.1оч. ст.1924г. */
   if ( bYear >= 1924 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT11 )  /* Инвал.2гр. ст.1940г. */
   if ( bYear >= 1940 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT12 )  /* Вкладчикам до 16г.р. */
   if ( bYear >= 1916 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT13 )  /* Вкладчикам 17-20г.р. */
   if ( ( bYear < 1917 )  OR  ( bYear > 1920 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT14 )  /* Вкладчикам 21-22г.р. */
   if ( ( bYear < 1921 )  OR  ( bYear > 1922 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT15 )  /* Вкладчикам 23-24 г.р. */
   if ( ( bYear < 1923 )  OR  ( bYear > 1924 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT22 )  /* Инвалидам 2 группы до 40 г.р. */
   if ( bYear > 1940 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT23 )  /* 1922 г.р. и старше */
   if ( bYear > 1922 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT24 )  /* С 1925 по 1928 г.р. */
   if ( ( bYear < 1925 )  OR  ( bYear > 1928 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT27 )  /* Наследникам 1 очереди по 1928 г.р. */
   if ( bYear > 1928 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT28 )  /* Наследникам 1 очереди инвалидов 2 группы по 1940 г.р. */
   if ( bYear > 1940 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT51 )  /* Вкладчикам до 16 г р */
   if ( bYear >= 1916 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT52 )  /* Вкладчикам 17-20 г р */
   if ( ( bYear < 1917 )  OR  ( bYear > 1920 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT53 )  /* Вкладчикам 21-22 г р */
   if ( ( bYear < 1921 )  OR  ( bYear > 1922 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT54 )  /* Вкладчикам 23-24 г р */
   if ( ( bYear < 1923 )  OR  ( bYear > 1924 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT60 )  /* Наследникам 1 очереди  1932 г.р. */
   if ( bYear > 1932 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT61 )  /* Инв 2группы до 40 г */
   if ( bYear > 1940 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;  
 elif ( ALG_SBDEPDOC.ApplType == AT62 )  /* С 1929 по 1932 г.р. */
   if ( ( bYear < 1929 )  OR  ( bYear > 1932 ) )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT64 )  /* Вкладчикам по 1945 г.р. */
   if ( bYear > 1945 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT65 )  /* Инвалидам 2-й группы по 1950 г.р. */
   if ( bYear > 1950 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT68 )  /* Наследникам 1-й очереди по 1945 г.р. */
   if ( bYear > 1945 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT69 )  /* Наследникам 1-й очереди - инвалидам 2-й группы по 1950 г.р. */
   if ( bYear > 1950 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT71 )  /* Вкладчикам по 1932 г.р. */
   if ( bYear > 1932 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 elif ( ALG_SBDEPDOC.ApplType == AT72 )  /* Наследникам 1-й очереди по 1932 г.р. */
   if ( bYear > 1932 )
     MsgBox( sNoCategoria );
     ALG_RESULT = ERR_RES;
     return;
   end;
 end;

 /* Для документа зачисления по компенсации */
 if ( ( ALG_SBDEPDOC.ListTransfer != 0 )  AND
      ( GetBitFlag( ALG_SBDEPDOC.Flags, 30 ) == 1 ) )
   /* Чтение записи компенсации */
   ClearRecord( compens );
   compens.FNCash  = ALG_SBDEPDOC.FNCash;
   compens.AutoKey = ALG_SBDEPDOC.ListTransfer;
   if ( NOT GetEQ( compens ) )
     MsgBox( "Невозможно прочитать запись по компенсации" );
     ALG_RESULT = ERR_RES;
     return;
   end;

   /* Проверки для компенсаций наследникам */
   if (   ( ALG_SBDEPDOC.ApplType == AT09 )  OR  /* Наследникам 1 очереди инвалидов 1 группы */
          ( ALG_SBDEPDOC.ApplType == AT19 )  OR  /* Наследникам участников В.О.В. */
          ( ALG_SBDEPDOC.ApplType == AT26 )  OR  /* На уплату ритуальных услуг */
          ( ALG_SBDEPDOC.ApplType == AT27 )  OR  /* Наследникам 1 очереди по 1928 г.р. */
          ( ALG_SBDEPDOC.ApplType == AT28 )  OR  /* Наследникам 1 очереди инвалидов 2 группы по 1940 г.р. */
          ( ALG_SBDEPDOC.ApplType == AT29 )  OR  /* Наследникам 1 очереди родителей инвалидов */
          ( ALG_SBDEPDOC.ApplType == AT68 )  OR  /* Наследникам 1-й очереди по 1945 г.р. */
          ( ALG_SBDEPDOC.ApplType == AT69 )  OR  /* Наследникам 1-й очереди - инвалидам 2-й группы по 1950 г.р. */
          ( ALG_SBDEPDOC.ApplType == AT70 )  OR  /* Наследникам 1-й очереди - бывшим узникам */
          ( ALG_SBDEPDOC.ApplType == AT72 ) )    /* Наследникам 1-й очереди по 1932 г.р. */
     GetAccOwner; 
     if ( ClientList.CurRec.rec.DateDeath == Date(0,0,0) )
       GetDate( ClientList.CurRec.rec.DateDeath, "Укажите дату смерти вкладчика" );
       if ( ClientList.CurRec.rec.DateDeath == Date(0,0,0) )
         MsgBox( "Дата смерти вкладчика не установлена" );
         ALG_RESULT = ERR_RES;
         return;
       else
         ClientList.Update;
       end;
     end;
     if ( ALG_SBDEPDOC.ApplType == AT26 )  /* На уплату ритуальных услуг */
       DateSplit( ClientList.CurRec.rec.DateDeath, bDay, bMon, bYear );
       if ( compens.Kind == Compensation2003 )
         if ( ( bYear < 2001 )  OR  ( bYear > 2003 ) )
           MsgBox( sNoCategoria );
           ALG_RESULT = ERR_RES;
           return;
         end;
       else
         if ( ( bYear < 1998 )  OR  ( bYear > 2001 ) )
           MsgBox( sNoCategoria );
           ALG_RESULT = ERR_RES;
           return;
         end;
       end;
     end;
   end;
 end;

 if ( ( ALG_SBDEPDOC.ApplType == AT26 )  AND  /* На уплату ритуальных услуг */
      ( compens.Kind == Compensation2001 ) )  /* Компенсация 2001 года */
   if ( ALG_SBDEPDOC.InSum > Limit1 )
     MsgBox( sLimit1 );
     ALG_RESULT = ERR_RES;
   end;
 elif ( ( ( ALG_SBDEPDOC.ApplType == AT60 ) 
       OR ( ALG_SBDEPDOC.ApplType == AT62 ) 
       OR ( ALG_SBDEPDOC.ApplType == AT09 ) 
       OR ( ALG_SBDEPDOC.ApplType == AT04 ) 
       OR ( ALG_SBDEPDOC.ApplType == AT25 ) 
       OR ( ALG_SBDEPDOC.ApplType == AT55 ) )  AND  
      ( compens.Kind == Compensation2003 ) )  
   if ( ALG_SBDEPDOC.InSum > Limit3 )
     MsgBox( sLimit3 );
     ALG_RESULT = ERR_RES;
   end;
 else
   if ( ALG_SBDEPDOC.InSum > Limit2 )
     MsgBox( sLimit2 );
     ALG_RESULT = ERR_RES;
   end;
 end;
end;
end;
