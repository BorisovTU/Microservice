/***************************************************************************\
| CLOSEDE5.MAC - макрос закрытия счета для вида вклада "Школьный"           |
|                                                     Зубов В.Ю. 28-11-97   |
\***************************************************************************/
/* При закрытии счета ранее даты конца договора, стираем дату конца договора */
/* чтобы отключить переход на альтернативные условия */
import deprintr, getpcli2, IsSrvDoc, alg_vars, PmPropUtil;

record FINISH_SBDEPDOC ("sbdepdoc.1"  );
record tmpDoc          ("sbdepdoc.1"  );
file   dr              ("depositr.dbt");
record save_SBDEPDOC   (sbdepdoc      );
record save_DEPOSITOR  (depositr      );

const ОТКАТ_С_РЕЗУЛЬТАТОМ = -777; /* Откат с получением процентов */

const НЕ_ОБНОВЛЯТЬ =  0;

const OnlyInputSum_Commission  =  1;
const OnlyInsertDoc_Commission =  2;

var IsFirst   = TRUE;
var Результат = 0;
var ErrMsg    = "";

var SummaComm = $0L;
var TypeComm  = "";
var NumOpert  = 0;

ALG_RESULT = OK_RES;  /* заранее инициализируем код возврата */
ALG_UPDATE = НЕ_ОБНОВЛЯТЬ;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CloseDep

  var
    errorCode, found,
    MinDate,
    NullDate = Date(0,0,0),
    PercSum1 = $0L,
    findOper,
    С_Панелью,
    UseMaxDate,
    NoPrint,
    Operation,
    st, stat;

  /* 1. Действия, специфичные для вида вклада "Школьный" -------------- */
  if ((ALG_DEPOSITOR.End_DateDep != NullDate) AND (ALG_PARAM.prmC != "X"))
    ALG_DEPOSITOR.End_DateDep = {curdate} - 1;
    ALG_UPDATE = 1; /* Обновить запись */
  end;

  /* 2. Расчет_Процентов ---------------------------------------------- */
  ClearRecord(tmpDoc);
  tmpDoc.Referenc         = ALG_SBDEPDOC.Referenc;
  tmpDoc.IsCur            = ALG_SBDEPDOC.IsCur;
  tmpDoc.FNCash           = ALG_SBDEPDOC.FNCash;
  tmpDoc.RealFNCash       = ALG_SBDEPDOC.RealFNCash;
  tmpDoc.Account          = ALG_DEPOSITOR.Account;
  tmpDoc.Oper             = {oper};
  tmpDoc.Type_Account     = ALG_SBDEPDOC.Type_Account;
  tmpDoc.Code_Currency    = ALG_SBDEPDOC.Code_Currency;
  tmpDoc.CodClient        = ALG_SBDEPDOC.CodClient;
  tmpDoc.YesSbook         = "X";
  tmpDoc.Date_Document    = ALG_SBDEPDOC.Date_Document;
  tmpDoc.DepDate_Document = ALG_SBDEPDOC.DepDate_Document;
  tmpDoc.Author           = ALG_SBDEPDOC.Author;
  tmpDoc.InSum            = $0L;
  tmpDoc.TypeComplexOper  = ALG_PARAM.NumOpert;

  С_Панелью  = 0;
  UseMaxDate = 1;
  NoPrint    = 1;

  Результат = Выполнить_Операцию(ALG_DEPOSITOR.Account,ALG_DEPOSITOR.Type_Account,
                                 ALG_DEPOSITOR.Code_Currency,Расчет_Процентов,
                                 tmpDoc,С_Панелью, UseMaxDate,NoPrint,ALG_PARAM.NumOpert );

  if (Результат != 0)
    ErrMsg = "2.Ошибка при расчете процентов = " + String(Результат);
    return;
  end;

  /* 3. --------------------------------------------------------------- */
  Результат = Проценты_Налог_К_Оплате(ALG_DEPOSITOR.Referenc,0,NullDate,PercSum1);

  if (Результат != 0)
    ErrMsg = "3.Ошибка при определении PercSum1 = "+String(Результат);
    return;
  end;

  /* Выходим, если не нужно править данные */
  if ((ALG_PARAM.prmC == "X") AND (Результат == 0))
    ALG_PARAM.prmD = PercSum1;
    Результат      = ОТКАТ_С_РЕЗУЛЬТАТОМ;
    return;
  end;

  /* 4. Причисляем PercSum1 ------------------------------------------- */
  ClearRecord(tmpDoc);
  tmpDoc.Referenc         = ALG_SBDEPDOC.Referenc;
  tmpDoc.IsCur            = ALG_SBDEPDOC.IsCur;
  tmpDoc.FNCash           = ALG_SBDEPDOC.FNCash;
  tmpDoc.RealFNCash       = ALG_SBDEPDOC.RealFNCash;
  tmpDoc.Account          = ALG_DEPOSITOR.Account;
  tmpDoc.Oper             = {oper};
  tmpDoc.Type_Account     = ALG_SBDEPDOC.Type_Account;
  tmpDoc.Code_Currency    = ALG_SBDEPDOC.Code_Currency;
  tmpDoc.CodClient        = ALG_SBDEPDOC.CodClient;
  tmpDoc.YesSbook         = "X";
  tmpDoc.Date_Document    = ALG_SBDEPDOC.Date_Document;
  tmpDoc.DepDate_Document = ALG_SBDEPDOC.DepDate_Document;
  tmpDoc.Author           = ALG_SBDEPDOC.Author;
  tmpDoc.InSum            = PercSum1;
  tmpDoc.TypeComplexOper  = ALG_PARAM.NumOpert;

  С_Панелью  = 0;
  UseMaxDate = 1;
  NoPrint    = 1;

  Результат = Выполнить_Операцию(ALG_DEPOSITOR.Account,ALG_DEPOSITOR.Type_Account,
                                 ALG_DEPOSITOR.Code_Currency,Зачисление_Процентов,
                                 tmpDoc,С_Панелью,UseMaxDate,NoPrint,ALG_PARAM.NumOpert );

  if (Результат != 0)
    ErrMsg = "4.Ошибка при зачислении PercSum1 = " + String(Результат);
    return;
  end;

  /* 5. Списываем весь остаток ---------------------------------------- */
  KeyNum(dr,8);
  dr.Referenc = ALG_DEPOSITOR.Referenc;
  if (NOT GetEQ(dr))
    ErrMsg = "Не найдена запись по счету";
    Результат = -1;
    return;
  end;

  Copy(ALG_DEPOSITOR,dr);
  ALG_DEPOSITOR.End_DateDep = NullDate;

  if ((ALG_DEPOSITOR.Sum_Rest != 0) OR (StrFor(GetProgramID) == "П"))
    ClearRecord(tmpDoc);
    tmpDoc.Referenc         = ALG_SBDEPDOC.Referenc;
    tmpDoc.IsCur            = ALG_SBDEPDOC.IsCur;
    tmpDoc.FNCash           = ALG_SBDEPDOC.FNCash;
    tmpDoc.RealFNCash       = ALG_SBDEPDOC.RealFNCash;
    tmpDoc.Account          = ALG_DEPOSITOR.Account;
    tmpDoc.Oper             = {oper};
    tmpDoc.Type_Account     = ALG_SBDEPDOC.Type_Account;
    tmpDoc.Code_Currency    = ALG_SBDEPDOC.Code_Currency;
    tmpDoc.CodClient        = ALG_SBDEPDOC.CodClient;
    tmpDoc.YesSbook         = "X";
    tmpDoc.Date_Document    = ALG_SBDEPDOC.Date_Document;
    tmpDoc.DepDate_Document = ALG_SBDEPDOC.DepDate_Document;
    tmpDoc.Author           = ALG_SBDEPDOC.Author;
    tmpDoc.OutSum           = GetLastFCDocRest(ALG_DEPOSITOR.Referenc, {curdate});
    tmpDoc.TypeComplexOper  = ALG_PARAM.NumOpert;
    tmpDoc.ApplType         = FINISH_SBDEPDOC.ApplType;
    //tmpDoc.Account_Receiver = FINISH_SBDEPDOC.Account_Receiver;
    //tmpDoc.CodeCur_Receiver = FINISH_SBDEPDOC.CodeCur_Receiver;
    //tmpDoc.MFO_Receiver     = FINISH_SBDEPDOC.MFO_Receiver;
    //tmpDoc.CorAcc_Receiver  = FINISH_SBDEPDOC.CorAcc_Receiver;
    tmpDoc.IsControl        = StrFor(1); /* Признак главного документа */

    if ((FINISH_SBDEPDOC.TypeOper != 0                 ) AND 
        (FINISH_SBDEPDOC.TypeOper != ALG_PARAM.NumOpert)    )
      Operation = FINISH_SBDEPDOC.TypeOper;
    elif (ALG_PARAM.NumOpert == Закрытие_Наличными)
      Operation = Расход;
    else
      Operation = Списание_По_Раз_Поруч;
    end;

    tmpDoc.TypeOper = Operation;

    if (IsFirst)
      Результат = ОТКАТ_С_РЕЗУЛЬТАТОМ;
      InterDesk_EndDocBunch();
      return;
    elif (SummaComm > 0)
      Результат = GetCommissionOnOper(tmpDoc,tmpDoc.OutSum,OnlyInsertDoc_Commission,SummaComm,TypeComm,NumOpert,ALG_PARAM.NumOpert);
      if (Результат != 0)
        ErrMsg = "Ошибка при вставке документа на комиссию " + String(Результат);
        return;
      end;
    end;

    С_Панелью  = 0;
    UseMaxDate = 1;
    NoPrint    = 1;

    ClearRecord(ALG_OPERPRM);
    ALG_OPERPRM.Account           = ALG_DEPOSITOR.Account;
    ALG_OPERPRM.Type_Account      = ALG_DEPOSITOR.Type_Account;
    ALG_OPERPRM.Code_Currency     = ALG_DEPOSITOR.Code_Currency;
    ALG_OPERPRM.Type_Oper         = Operation;
    ALG_OPERPRM.Show_Panel        = С_Панелью;
    ALG_OPERPRM.UseMaxDate        = UseMaxDate;
    ALG_OPERPRM.NoPrint           = NoPrint;
    ALG_OPERPRM.NonCashCommission = ALG_PARAM.prmI;
    ALG_OPERPRM.TypeComplexOper   = ALG_PARAM.NumOpert;
    ALG_OPERPRM.DocumentAuthor    = CodeFor(tmpDoc.Author);
    if (Operation == Списание_Переводом)
      ALG_OPERPRM.CorrAcc         = PMNT_PROP_REC_BUF.Account;
      ALG_OPERPRM.CorrType        = PMNT_PROP_REC_BUF.CorrAccount;
    end;

    Результат = Выполнение_Операции(ALG_OPERPRM,tmpDoc);

    if (Результат != 0)
     ErrMsg = "5. Ошибка при расходе "+String(Результат);
     return;
    end;

  else
    if (IsFirst)
      ClearRecord(tmpDoc);
      Результат = ОТКАТ_С_РЕЗУЛЬТАТОМ;
      InterDesk_EndDocBunch();
      return;
    end;
  end;

  ALG_RESULT = END_RES; /* Все Ok */

  return;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro TrnProc

  CloseDep();

  if (Результат != 0)
    if (Результат == ОТКАТ_С_РЕЗУЛЬТАТОМ)
      ALG_UPDATE = 0;
    else
      ALG_RESULT = ERR_RES;
    end;
    AbortTrn();
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/

  LoopInTrn(TRUE);

  ClearRecord(tmpDoc);

  Copy(save_DEPOSITOR,ALG_DEPOSITOR);
  Copy(save_SBDEPDOC,ALG_SBDEPDOC);
  Copy(FINISH_SBDEPDOC,ALG_SBDEPDOC);

  /* Нужно взять комиссию - для этого предварительно определим сумму расхода */
  IsFirst = TRUE;
  if ((ALG_PARAM.prmI2 >   0 ) AND 
      (ALG_PARAM.prmC  != "X")    )
    if ((StrFor(GetProgramID) == "П") AND (ALG_PARAM.prmI > 0))
      ;
    else
      if ( not ProcessTrn( 1, "TrnProc" ) )
        if (Результат != ОТКАТ_С_РЕЗУЛЬТАТОМ)
          ALG_RESULT = ERR_RES;
          Результат = 4714;
        end;
      end;
      Copy(ALG_DEPOSITOR,save_DEPOSITOR);
      Copy(ALG_SBDEPDOC,save_SBDEPDOC);
      Copy(FINISH_SBDEPDOC,ALG_SBDEPDOC);
    end;
  end;

  /* Проведем собственно операцию закрытия счета */
  IsFirst = FALSE;
  if (ALG_RESULT != ERR_RES)
    Результат = 0;
    if ((ALG_PARAM.prmI2 >   0 ) AND 
        (ALG_PARAM.prmC  != "X") AND
        (tmpDoc.OutSum   >   0 )    )
      if ((StrFor(GetProgramID) == "П") AND (ALG_PARAM.prmI > 0))
        ;
      else
        Результат = GetCommissionOnOper(tmpDoc,tmpDoc.OutSum,OnlyInputSum_Commission,SummaComm,TypeComm,NumOpert);
        if (Результат == 2)
          MsgBox("Отказались от проведения операции");
          ALG_RESULT = ERR_RES;
        elif (Результат != 0)
          ErrMsg = "Ошибка при взятии комиссии = " + String(Результат);
          ALG_RESULT = ERR_RES;
        end;
      end;
    end;
    if (Результат == 0)
      if ( not ProcessTrn( 1, "TrnProc" ) )
        if (Результат != ОТКАТ_С_РЕЗУЛЬТАТОМ)
          ALG_RESULT = ERR_RES;
          Результат = 4714;
        end;
      end;
    end;
  end;

  if ((ALG_PARAM.prmC == "X") AND (Результат == ОТКАТ_С_РЕЗУЛЬТАТОМ))
    ALG_RESULT = END_RES;
    ALG_UPDATE = 0;
  end;

  if ((ErrMsg != "") AND (NOT InFCGroupOpRun()))
    MsgBox(ErrMsg);
  end;

end;
