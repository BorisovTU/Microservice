
/* Запись счетов в реестр accreg.dbt*/

import deprintr;

file dr      ("depositr.dbt");           /* Счета   */
file accreg  ("accreg.dbt") write;       /* Реестр  */

const OLD = 100;
const NEW = 200;

/*************************************************************************/
macro Colontitle
  [ ------- #################### ------------------ ########## ------ ######## ---------
  ] (GetRetailVersion(),Date(),Time());
end;


/*************************************************************************/
macro AddAccNumber()

  var stat, res = 1;

  KeyNum(accreg,1);
  ReWind(accreg);
  accreg.IsCur = dr.IsCur;
  accreg.FNCash = dr.FNCash;
  accreg.GroupNumb = dr.GroupNumb;
  accreg.Code_Currency = dr.Code_Currency;
  accreg.Number = dr.Number;

  stat = getEQ(accreg);
  if(stat)
    accreg.Account = dr.Account;
    accreg.CodClient = dr.CodClient;
    accreg.OpenDate = dr.Open_Date;
    accreg.CloseDate = dr.Close_Date;
    res = Update(accreg);

    if(res)
      /*MsgBox("Updating!");*/
      res = OLD;
    end;
   else
    accreg.Autokey = 0;
    accreg.Account = dr.Account;
    accreg.IsCur = dr.IsCur;
    accreg.FNCash = dr.FNCash;
    accreg.GroupNumb = dr.GroupNumb;
    accreg.Code_Currency = dr.Code_Currency;
    accreg.Number = dr.Number;
    accreg.CodClient = dr.CodClient;
    accreg.OpenDate = dr.Open_Date;
    accreg.CloseDate = dr.Close_Date;
    res = Insert(accreg);

    if(res)
      /*MsgBox("Inserting!");*/
      res = NEW;
    end;

  end;

  return res;

end;


/*************************************************************************/
/*                                                                       */
/*************************************************************************/
macro AddAccounts2Reg()

  var stat;
  var res;
  var count = 0;             /* Кол-во счетов прорегистрированных */
  var recordsCount = 0;      /* Кол-во счетов просмотренных */
  var text = "Регистрация открытых счетов ...";
  var str;

  initProgress(NRecords(dr), text);
  KeyNum(dr, 8);
  ReWind(dr);
  dr.Referenc = 0;

  stat = getGE(dr);
  while (stat)
    UseProgress(recordsCount);
    Message("Обрабатываем счет " + dr.Number);
       res = AddAccNumber();
       if(res == NEW)
         count = count + 1;
       end;
    stat = Next(dr);
    recordsCount = recordsCount + 1;
  end;

  remProgress();
  str = " Добавлено в книгу регистрации " + String(count) + " счетов";
  [#](str);


end;





/************** Г О Л О В Н О Й   М А К Р О С ***************************/
macro RegisterAccounts()


  Colontitle();
  [ ];

  AddAccounts2Reg();

  [ ];
  Colontitle();
end;

/*************** О К О Н Ч А Н И Е ** М А К Р О С А ********************/




AddAccounts2Reg();
End.