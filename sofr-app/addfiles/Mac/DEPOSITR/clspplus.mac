// виды вкладов, у которых есть срок, после которого не производится перевод
// на альтернативные условия
private var TypeAccountsToCheck = TArray;
private var MinimumDaysToDep    = TArray;
TypeAccountsToCheck(0) = "Накопитель";  // Накопительный Сбербанка России
MinimumDaysToDep(0)    = 181;


Import DeprIntr, Alg_Vars;

//file TRUSTWILL(sbtrast) key 0;

  const UPDATE_DEP  = 2,  /* Обновить счет */
        UPDATE_DOC  = 4;  /* Обновить документ   */

  var RecFound;


private macro GetFirstWillDate(BegDate, ref, doc)
/*
  Дата первой выдачи наследства по счету
*/

  const ACCOUTN_HEIR     = 2; /* Наследник - выдачи */
  const ACCOUTN_HEIR_PAY = 7; /* Наследник - выплаты */

  file SRPNRT_0_SBTRAST (sbtrast) key 0;
  var WillDate = BegDate;
  var st;

  SRPNRT_0_SBTRAST.FNCash    = doc.FNCash;
  SRPNRT_0_SBTRAST.Referenc  = ref;
  SRPNRT_0_SBTRAST.VidDoc    = "\x01";
  SRPNRT_0_SBTRAST.CodClient = 0;
  st = GetGE (SRPNRT_0_SBTRAST);
  while (st
   AND   (SRPNRT_0_SBTRAST.Referenc == ref)
   AND   ( (SRPNRT_0_SBTRAST.VidDoc == "\x01") OR (SRPNRT_0_SBTRAST.VidDoc == "\x02") ) )
    if ( (SRPNRT_0_SBTRAST.CloseDate != Date(0,0,0))
     AND (SRPNRT_0_SBTRAST.CloseDate < WillDate))
      WillDate = SRPNRT_0_SBTRAST.CloseDate;
    end;
    st = Next (SRPNRT_0_SBTRAST);
  end;    
// Возможно, первая выдача наследства только идет, и записи в sb_trast еще нет
  if ( (WillDate == BegDate)
   AND ((doc.Author == StrFor(ACCOUTN_HEIR    )) 
     OR (doc.Author == StrFor(ACCOUTN_HEIR_PAY))
       ) )
    WillDate = doc.DepDate_Document;
  end;
  return WillDate;
end;

// срок, который должен отлежать вклад, чтобы остаться на основных условиях
private macro DaysToDep(Type_Account)
  var i = 0;
  while (i < TypeAccountsToCheck.size())
    if (Type_Account == TypeAccountsToCheck(i))
      return MinimumDaysToDep(i);
    end;
    i = i + 1;
  end;
  return 0;
end;

// нужно ли оставлять счет на основных условиях
private macro StayOnDep
  var days_to_dep;
  var start_date;
  var check_date;

  days_to_dep = DaysToDep(ALG_DEPOSITOR.Type_Account);
  if (days_to_dep == 0)
    return true;
  end;

  // дата начала срока договора
  if (ALG_DEPOSITOR.Prol_DateDep != Date(0,0,0))
    start_date = ALG_DEPOSITOR.Prol_DateDep;
  else
    start_date = ALG_DEPOSITOR.Start_DateDep;
  end;

  // дата первой выдачи наследства 
  // либо дата документа, если выдачи наследства не было
  check_date = GetFirstWillDate(ALG_SBDEPDOC.DepDate_Document, ALG_CONTRACT.Id, ALG_SBDEPDOC);

  if ((start_date + days_to_dep) <= check_date)
    return true;
  end;

  return false;
end;

  ALG_RESULT = SKIP_RES;

  if ( ALG_DEPOSITOR.UseAlternate )
    return;
  end;
/* РАВ SCR 101345 На альтернатив не переводим не зависимо от того,
   какая по счету выплата наследства
  if ( ALG_SBDEPDOC.TypeComplexOper != 99 )
    ClearRecord( TRUSTWILL );
    TRUSTWILL.Referenc = ALG_DEPOSITOR.Referenc;
    TRUSTWILL.VidDoc   = StrFor( 1 );
    RecFound = GetGE( TRUSTWILL );
    while ( RecFound 
      and ( TRUSTWILL.Referenc == ALG_DEPOSITOR.Referenc )
      and ( TRUSTWILL.VidDoc   == StrFor( 1 ) ) )
      if ( TRUSTWILL.CloseDate != Date( 0, 0, 0 ) )
        return;
      end;
      RecFound = Next( TRUSTWILL ); 
    end;
  end;
*/

  if (StayOnDep())
    SetBitFlag( ALG_SBDEPDOC.Flags, 9, 1 );
    ALG_UPDATE = UPDATE_DOC;
  end;
end;
