/****************************************************************************
   RS-Retail 1.0                 (СБЕРБАНК)
   Subsystem:   АРМ Бухгалтера
                ~~~~~~~~~~~~~~
   Description: Макропроцедуры формирования отчётов
                по коммунальным платежам
   ------------------------------------------------------------------------
   1998(c)R-Style SoftWare Lab.
****************************************************************************/

import deprintr, CommonInter, rsd;
import PmPropUtil;

file doc    ("pay_doc.dbt");                   /* Документы         */
file PmntProp ("RTPaymentProp.dbt") key 0;
/*file listfd ("listfdep.dbt") key 0;*/            /* Филиалы           */

/* Файлы RS-Bank */
var   bankdprt : TBFile;
var   partcode : TBFile;
var   party    : TBFile;
var   OpenBankFiles = FALSE;
const BankVersion   = BankVer();

const CO_CommPay = 1;
const FNcash = NumFNCash();

/*     Действия над записями файлов    */
const D_DELETE =  2,  /* Удаление      */
      D_STORN  = 11;  /* Сторнирование */

const NDS = $0L;

var   BranchName;

private var {curdate};
private var {MFO_Bank};
private var {Name_Bank};
private var {CNum};

var TxtDir = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true );

/*************************************************************************\
|                     Начало-конец отчета                                 |
\*************************************************************************/
macro Colontitle
  [ ---------------------RS-Retail ------- ########## -----------------########---
    ](Date(), Time());
end;


/*************************************************************************\
|                         Открыть файл банков                             |
\*************************************************************************/
macro OpenBankDprt

  var stat = FALSE;

  partcode = Tbfile("partcode.dbt","r",1);
  party    = Tbfile("party.dbt",   "r",0);
  if ((partcode) AND (party))
    OpenBankFiles = TRUE;
    stat          = TRUE;
  end;

  return stat;

end;


/*************************************************************************\
|                     Найти банк       (Seek and destroy!)                |
\*************************************************************************/
macro FindBank (BIK)

  var stat = FALSE;
  var name = "Банк не определен";

  if ( StrLen(Trim(BIK)) == 0 )
    return {Name_Bank};
  end;

  /* Откроем файлы RS-Bank */
  if (NOT OpenBankFiles)
    if (NOT OpenBankDprt())
      Exit(1);
    end;
  end;

  if (BankVersion == 510)
    partcode.rec.CodeKind = 3;
    partcode.rec.Code     = BIK;
    stat = partcode.GetEQ;
    if (stat)
      party.rec.PartyID = partcode.rec.PartyID;
      stat = party.GetEQ;
      if (stat)
        name = party.rec.Name;
      end;
    end;
  else
    bankdprt.rec.MFO_Depart = BIK;
    bankdprt.rec.Corr_Acc   = "";
    stat = bankdprt.GetGE;
    if (stat and (bankdprt.rec.MFO_Depart == BIK))
      name = bankdprt.rec.Name_Depart;
    end;
  end;

  return Trim(name);

end;


/*************************************************************************\
|        Опись платёжных поручений                                        |
\*************************************************************************/
macro Report1()

end;


/*************************************************************************\
|        Въдомость по коммунальным платежам                               |
\*************************************************************************/
macro Report2()

  var    str, stat;
  var    save_KKM = "", markKKM = false;
  var    markGroupOpert = false;
  var    sum_KKM = $0L; /* , sum_FNCash = $0L; */
  var    totsum = $0L;

  [                         Ведомость по ОСБ №  ############  ]
  (BranchName:c);
  [                                 за  ########## г.         ]
  ({curdate});
  [ ];

  [┌────────┬──────────┬──────────────┬─────────────┬─────────────────────────┬──────────┐];
  [│ Филиал │   Дата   │     № ККМ    │ Идент.банка │      Расчётный счёт     │   Сумма  │];
  [├────────┼──────────┼──────────────┼─────────────┼─────────────────────────┼──────────┤];


  /* KeyNum(listfd, 0);
  ReWind(listfd); */
  KeyNum(doc, 7);
  ReWind(doc);

  /* while( Next(listfd) ) */

    /* doc.FNCash = listfd.FNCash; */
    doc.FNCash = FNCash;
    doc.Date_Document = {curdate};
    doc.KKMFactoryNum = "";
    doc.IsCur = 0;
    doc.CodCur = 0;
    /*doc.RecipientBankMFO = "";
    doc.Account_Recipient = "";*/
    stat = getGE(doc);

    markKKM = false;
    markGroupOpert = false;

    /* sum_FNCash = $0L; */

    /* while ( stat and (doc.FNCash == listfd.FNCash ) */
    while ( stat and (doc.FNCash == FNCash )
                 and (doc.Date_Document == {curdate}) )
      /* Коммунальные платежи */
      if ( ( doc.GroupOpert == CO_CommPay )  AND
           ( doc.Action != D_DELETE )  AND
           ( doc.Action != D_STORN ) and
           ( ( doc.IsSuspended == "" ) or ( doc.IsSuspended == "X" ) ) )
    FindPmntProp(PmntProp, doc.iApplicationKind, doc.ApplicationKey);
        markGroupOpert = true;

        if( (not markKKM) or (doc.KKMFactoryNum != save_KKM) )
          if (markKKM)
            [│ Итого по касс. аппарату № ##########################                      ##########│]
              (  String(save_KKM), sum_KKM );
            [│                                                                                     │];
          else
            markKKM = true;
          end;
          sum_KKM = $0L;
          save_KKM = doc.KKMFactoryNum;
        end;
        sum_KKM = sum_KKM + doc.InSum;

        /* sum_FNCash = sum_FNCash + doc.InSum; */

        totsum = totsum + doc.InSum;
        str = "│" + String(doc.FNCash:8:c) +         "│";
        str = str + String(doc.Date_Document:10:c) + "│";
        str = str + String(doc.KKMFactoryNum:14:c) + "│";
        str = str + String(PmntProp.BankCode:13:c) + "│";
        str = str + String(Acc_Form(String(PmntProp.Account)):25) + "│";
        str = str + String(doc.InSum:10) + "│";
        [#](str);
      end;
      stat = Next(doc);
    end;  /* Перебор документов по филиалу */

    if (markGroupOpert)
      [│ Итого по касс. аппарату № ##########################                      ##########│]
        (  String(save_KKM), sum_KKM );

      /*
      [│                                                                                     │];
      [│ Всего по филиалу №  ########################                              ##########│]
        (  String(listfd.FNCash), sum_FNCash );
      [│                                                                                     │]; */

    end;

  /* end; */  /* Перебор филиалов */

  /*
  if (markGroupOpert)
    [│                                                                                     │];
    [│ Всего по филиалу №  ########################                              ##########│]
      (  String(listfd.FNCash), sum_FNCash );
  end; */

  [└────────┴──────────┴──────────────┴─────────────┴─────────────────────────┴──────────┘];

  [ ];
  [ Всего:                                                                     ##########]
  ( totsum );

end;


/************************************************************************\
|                        Запускалка отчётовъ                             |
\************************************************************************/
macro RunReport
(
  report_number
)         
  var name;

  Colontitle();
  [ ];
  /* Определим номер и БИК отделения */
  if (not findDepartment(FNcash, name))
    [ Нет филиала, соответствующего FNcash = # ](FNcash);
    BranchName = "Не определен";
  else
    BranchName = String(name); /* Номер филиала */
  end;

  /* Получение наименования Банка */
  if   (report_number == 1)  Report1();
  elif (report_number == 2)  Report2();
  end;
  [ ];
  Colontitle();
end;


/*----------------------------------------------------------------------*\
                          Проверка макросов
\*----------------------------------------------------------------------*/
/*
  RunReport(5);
  End.
*/
