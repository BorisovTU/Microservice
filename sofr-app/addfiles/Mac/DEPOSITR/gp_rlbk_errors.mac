//
// âçñâ ®¡ ®è¨¡ª å ¯ ª¥â­®£® áâ®à­¨à®¢ ­¨ï/ã¤ «¥­¨ï
//

import rsd;

private const
  retprod_all      = 0,
  retprod_depositr = 1;

//----------------------------------------------------------------------------
// ã¦­® «¨ ¯¥ç â âì ®âçñâ
//----------------------------------------------------------------------------
private macro NeedPrint()
  var cmd = RsdCommand(
      "select 1 from drsbedref_tmp "
      "where rownum = 1 "
  );
  cmd.execute();
  
  var rs = RsdRecordset(cmd);
  if (rs.moveNext())
    return true;
  end;

  return false;
end;


//----------------------------------------------------------------------------
// ®«ãç¨âì ¢ë¡®àªã § ¯¨á¥© ¤«ï ®âçñâ 
//----------------------------------------------------------------------------
private macro MakeSample(kind)
  var cmd = RsdCommand(
      "select t_ApplicationKind, t_ApplicationKey, t_ErrCode from drsbedref_tmp "
      "where t_SignRec = ? "
      "order by t_IsCur, t_Code_Currency, t_SignRec, t_ApplicationKind, t_ApplicationKey "
  );
  cmd.addParam("SignRec", RSDBP_IN, kind);
  cmd.execute();
  
  var rs = RsdRecordset(cmd);
  return rs;
end;

private macro PrintOperHead()
  [ ];
  [     ‘¯¨á®ª ®¯¥à æ¨© ¯® áç¥â ¬ ¢ª« ¤ç¨ª®¢, ¯® ª®â®àë¬ ­¥ ¢ë¯®«­¥­® £àã¯¯®¢®¥ áâ®à­¨à®¢ ­¨¥/ã¤ «¥­¨¥ ];
  [ ];
  [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
  [³                          ³   ³                     ³   ³                                                             ³];
  [³ ®¬¥à áç¥â               ³¯.³ ‘ã¬¬                ³‚ «³ Š®¤/¯¨á ­¨¥ ®è¨¡ª¨                                         ³];
  [³                          ³   ³                     ³   ³                                                             ³];
  [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
end;


private macro PrintOperLine(rep_rs)
  var cmd = RsdCommand(
    "select d.t_Account, d.t_TypeOper, d.t_InSum + d.t_OutSum t_Sum, nvl(c.t_Short_Name, d.t_Code_Currency) t_Short_Name, "
    "  nvl(m.t_Contents, chr(1)) t_Contents "
    "from dsbdepdoc_dbt d, dcurrency_dbt c, dsbbank_msg m, ( "
    "  select DocAppKind, DocAppKey "
    "  from ( "
    "    select ln.t_ApplicationKind2 DocAppKind, ln.t_ApplicationKey2 DocAppKey "
    "    from dsb_casln_dbt ln "
    "    where ln.t_ApplicationKind1 = ? "
    "      and ln.t_ApplicationKey1 = ? "
    "      and ln.t_ApplicationKind2 in (1, 110, 111) "
    "      and ln.t_RefValue2 = 0 "
    "    order by ln.t_NumLinkDoc "
    "  ) "
    "  where rownum = 1 "
    ") ll "
    "where d.t_iApplicationKind = ll.DocAppKind "
    "and  d.t_ApplicationKey = ll.DocAppKey "
    "  and c.t_Code_Currency(+) = d.t_Code_Currency "
    "  and m.t_Number(+) = ? "
  );
  cmd.addParam("t_ApplicationKind1", RSDBP_IN, rep_rs.value("t_ApplicationKind"));
  cmd.addParam("t_ApplicationKey1", RSDBP_IN, rep_rs.value("t_ApplicationKey"));
  cmd.addParam("Number", RSDBP_IN, rep_rs.value("t_ErrCode"));
  cmd.nullConversion = true;
  cmd.execute();
  
  var rs = RsdRecordset(cmd);
  if (rs.moveNext())
    [³##########################³###³#####################³###³#############################################################³]
    (rs.value("t_Account"), rs.value("t_TypeOper"), rs.value("t_Sum"), rs.value("t_Short_Name"), 
     string(rep_rs.value("t_ErrCode")) + " - " + rs.value("t_Contents"));
  end;
end;


private macro PrintOperFoot()
  [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
end;


//----------------------------------------------------------------------------
// ¥ç âì ®âçñâ  ¯® ¢ª« ¤­ë¬ ®¯¥à æ¨ï¬
//----------------------------------------------------------------------------
private macro PrintOperReport()
  var head_printed = false;
  
  var rs = MakeSample(retprod_depositr);
  while (rs.moveNext())
    if (not head_printed)
      PrintOperHead();
      head_printed = true;
    end;

    PrintOperLine(rs);
  end;

  if (head_printed)
    PrintOperFoot();
  end;
end;


//----------------------------------------------------------------------------
// ¥ç âì ®âçñâ 
//----------------------------------------------------------------------------
macro PrintReport()
  PrintOperReport();
end;


if (NeedPrint())
  PrintReport();
end;

