/*
$Name:               secrest3.mac
$Module:             DEPOSITR
$Description:        Действия при сторнировании операции дополнительного взноса для вклада "Особый номерной на 2 года"
*/
/*
  RS-Retail 5.1
  Шаг "Сторнирование/Удаление" 
  операции "Доп.взнос"
------------------------------------------------------------
  Вид вклада- "Особый номерной на 2 года"
------------------------------------------------------------
   Процентная ставка зависит от неснижаемого остатка, 
  который может поменяться в течение 30 дней.
   Макрос меняет местами значения в полях DEPOSITR.StaticRest 
  и DEPOSITR.Limit в случае, если остаток превысил новое
  значение неснижаемого остатка при выполнении операции,
  которая в настоящий момент сторнируется
------------------------------------------------------------
    Ромодин Александр Васильевич
    13 августа 2002 г.
*/
Import deprintr, alg_vars;

const UPDATE_DEP        = 2;

file depositr (depositr);

/* ****************************************************** */

macro TrnProc

  var OldRest;
  var stat = true;
  var Storn;

  OldRest = ALG_DEPOSITOR.StaticRest;
  ALG_DEPOSITOR.StaticRest = ALG_DEPOSITOR.Limit;
  ALG_DEPOSITOR.Limit      = OldRest;
  UpdateAlgRecords (UPDATE_DEP, TRUE);

  if (ALG_PARAM.PrmC)
    Storn = true;
  else
    Storn = false;
  end;
    stat = DeleteDocument (ALG_SBDEPDOC.iApplicationKind,
                           ALG_SBDEPDOC.ApplicationKey, Storn);
  if (NOT stat)
    AbortTrn();
  end;

end;

/* ##### Точка входа ##### */

  var DifDate;
  ALG_RESULT = SKIP_RES;  /* Выполнить стандартное сторнирование/удаление */

  DifDate = ALG_SBDEPDOC.DepDate_Document - ALG_DEPOSITOR.Open_Date;

  if ( (DifDate <= 30)                                  /* Прошло меньше 30 дней от открытия счета */
   AND (ALG_DEPOSITOR.StaticRest > 0)                   /* Второй лимит определен */ 
   AND (ALG_DEPOSITOR.StaticRest < ALG_DEPOSITOR.Limit) /* Новый лимит был установлен */
   AND ((ALG_SBDEPDOC.Rest-ALG_SBDEPDOC.InSum)<ALG_DEPOSITOR.Limit) ) /* Остаток после сторна будет меньше лимита */
    if (ProcessTrn(1,"TrnProc",depositr))
      ALG_RESULT = END_RES;
    else
        MsgBox("Ошибка во время проведения операции");
      ALG_RESULT = ERR_RES;
    end;
  end;
end;
/* ----- Конец файла ----- */
