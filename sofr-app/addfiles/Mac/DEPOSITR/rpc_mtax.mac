/*
 $Name:   rpc_mtax.mac 
 $Module: RS-Retail
 $Description: Выпуск налоговой карточки
*/
/*
  RS-Retail

  Выпуск налоговой карточки
  "Филиал Сбербанка"

  Ромодин Александр Васильевич
  29.12.99
============================================================
  04.09.01  Ромодин Александр Васильевич
  Выпуск налоговой карточки переработан в соответствии
  с ТЗ 693-01-1,2-НДФЛ
  Заполняются разделы: 2,3,5,6
============================================================
*/
Import cur_rate,DeprIntr,rtkladr;
/* ---------------------------------------------------------
  Заполните реквизиты
*/
var PF_PayerNumber = ""; /* Номер плательщика страховых взносов в пенсионный фонд */
var CodeTaxAgency  = ""; /* Код налогового органа, где налоговый агент состоит на учете */
private var {Bank_INN};  /* ИНН банка */
private var {Name_Bank}; /* Название банка  */
                      /* Ответственный за ведение налоговой карточки */
var Job_Respons = ""; /* Должность */
var FIO_Respons = ""; /* Ф.И.О. */
                      /* Правильность заполнения налоговой карточки проверил */
var Post_Boss   = ""; /* Должность */
var FIO_Boss    = ""; /* Ф.И.О. */
/* ------------------------------------------------------ */
var    COMCLNT = TClientList;  /* Единый клиент */
file   TAX_CARD   ("pc_tax.dbt"      ) write;
file   NAMEALG    (namealg,"bank.def") key 0;
file   DEPOSITR   (depositr          ) key 8;
file   CURRENCY   (currency          ) key 0;
record TAX_CARD_2 ("pc_tax2"         );

var pct = TBFile( "pc_tax.dbt", "r", 1 );

const RPCB_TAX_SBDEPR_RETAIL = 2;   /* Филиал RS-Retail */
const VeryBigDate = Date(31,12,9999);

var {curdate};
var year;
var mon;
record InputPanel (rpc_mtax) dialog;
var ne_IdentClient = 0;
var ne_fio         = 1;
var ne_Year_InAll  = 2;
var ne_LastField   = 2;

var TheOnlySole;
var BeginDate, EndDate;  /* Период выборки данных из файла налоговой карточки */
var IdentClient;
var Code_Currency = -1;
var BoolLastCurrencyForClient = True;

InputPanel.IdentClient = "";
DateSplit({curdate},null,mon,year);
if (mon < 7)
  InputPanel.Year_InAll = year - 1;
else
  InputPanel.Year_InAll = year;
end;
/***********************************************************
 Переменные в соответствии с ТЗ                           */
/* Переменные для таблицы 3 */
var p_1_25 = $0l,
    p_1_27 = $0l,
    p_1_29 = $0l,
    p_1_31 = $0l,
    p_1_33 = $0l,
    p_1_35 = $0l,
    p_1_37 = $0l,
    p_1_39 = $0l;
array p_1_24,
      p_1_26,
      p_1_28,
      p_1_30,
      p_1_32,
      p_1_34,
      p_1_36,
      p_1_38;
/* Переменные для таблицы 5 */
var p_1_41 = $0l,
    p_1_43 = $0l,
    p_1_45 = $0l,
    p_1_47 = $0l,
    p_1_49 = $0l,
    p_1_51 = $0l,
    p_1_53 = $0l;
array p_1_40,
      p_1_42,
      p_1_44,
      p_1_46,
      p_1_48,
      p_1_50,
      p_1_52;
/* Переменные для итоговой записи */
var SummaTaxCalc    = $0l,
    SummaTaxPay     = $0l,
    SummaTaxCalcRUR = $0l,
    SummaTaxPayRUR  = $0l,
    SumPercent      = $0l,
    SumReFin        = $0l,
    Income          = $0l,
    IncomeRUR       = $0l;

/**********************************************************/

class CLastTaxPayDate
  var DateTaxPay;
  var ApplicationKind;
  var ApplicationKey;

  DateTaxPay = date(0, 0, 0);
  ApplicationKind = 0;
  ApplicationKey = "";

  macro CheckLastTaxPayDate(MaxDateTaxPay) 
    var cur_pos;
    var CodeModule, IdentClient, ObjectTax_Add;
    var stat = true;
    var pay_exists = false;

    if (TAX_CARD.SummaTaxPay != 0)
      return true;
    end;

    if ((TAX_CARD.DateTaxPay < DateTaxPay) or
        ((TAX_CARD.DateTaxPay == DateTaxPay) and (TAX_CARD.ApplicationKind < ApplicationKind)) or
        ((TAX_CARD.DateTaxPay == DateTaxPay) and (TAX_CARD.ApplicationKind == ApplicationKind) and (TAX_CARD.ApplicationKey < ApplicationKey)))
      return true;
    end;

    CodeModule = TAX_CARD.CodeModule;
    IdentClient = TAX_CARD.IdentClient;
    ObjectTax_Add = TAX_CARD.ObjectTax_Add;
    cur_pos = GetPos(TAX_CARD);

    while (stat and 
           (TAX_CARD.CodeModule == CodeModule) and
           (TAX_CARD.IdentClient == IdentClient) and
           (TAX_CARD.ObjectTax_Add == ObjectTax_Add) /*and
           (TAX_CARD.DateTaxPay < MaxDateTaxPay)*/)
      DateTaxPay = TAX_CARD.DateTaxPay;
      ApplicationKind = TAX_CARD.ApplicationKind;
      ApplicationKey = TAX_CARD.ApplicationKey;

      if (TAX_CARD.SummaTaxPay != 0)
        pay_exists = true;
        break;
      end;

      stat = Next(TAX_CARD);
    end;

    GetDirect(TAX_CARD, cur_pos);

    return pay_exists;
  end;
end;

/***********************************************************
***********************************************************/

macro Заполнение_Данных_По_Клиенту_И_Валюте
/*
  Просмотр записей по клиенту и заполнение переменных
*/
  var stat = True;
  var mon;
  var m,y;
  var CBRate, BuyRate, SellRate;
  var st;
  var last_pay = CLastTaxPayDate();
/*
  Цикл по данному вкладчику, заполнение данных
*/
  mon = 1;
  while (mon <= 12)
    KeyNum (TAX_CARD,1);
    TAX_CARD.CodeModule    = RPCB_TAX_SBDEPR_RETAIL;
    TAX_CARD.IdentClient   = IdentClient;
    TAX_CARD.ObjectTax_Add = Code_Currency;
    TAX_CARD.DateTaxPay    = Date(1,mon,InputPanel.Year_InAll);
    if (mon < 12)
      y = InputPanel.Year_InAll;
      m = mon+1;
    else
      y = InputPanel.Year_InAll + 1;
      m = 1;
    end;
    st = GetGE (TAX_CARD);
    while (st   AND (TAX_CARD.CodeModule    == RPCB_TAX_SBDEPR_RETAIL) AND
                    (TAX_CARD.IdentClient   == IdentClient) AND
                    (TAX_CARD.ObjectTax_Add == Code_Currency) AND
                    (TAX_CARD.DateTaxPay    <  Date(1,m,y)) AND 
                    (last_pay.CheckLastTaxPayDate(Date(1,m,y))))
      SetRecordAddr (TAX_CARD_2,TAX_CARD,0,0,True);
/*    Уточнение рублевых эквивалентов сумм */
      if ( ( (TAX_CARD.SummaTaxCalc != 0) AND (TAX_CARD.SummaTaxCalcRUR == 0))
        OR ( (TAX_CARD.SummaTaxPay  != 0) AND (TAX_CARD.SummaTaxPayRUR  == 0))
        OR   (TAX_CARD_2.IncomeRUR  == 0) )
        if (TAX_CARD.ObjectTax_Add > 0) /* Валюту- в рубли по курсу ЦБ */
          st = GetAllCurrRate (TAX_CARD.DateTaxPay,TAX_CARD.ObjectTax_Add,CBRate,BuyRate,SellRate);
        else
          CBRate = 1; /* Рубли */
        end;
        if (st)
          if (TAX_CARD.SummaTaxCalcRUR == 0)
            TAX_CARD.SummaTaxCalcRUR = MoneyL(TAX_CARD.SummaTaxCalc * CBRate);
          end;
          if (TAX_CARD.SummaTaxPayRUR == 0)
            TAX_CARD.SummaTaxPayRUR = MoneyL(TAX_CARD.SummaTaxPay * CBRate);
          end;
          if (TAX_CARD_2.IncomeRUR == 0)
            if (TAX_CARD_2.Income == 0)
              TAX_CARD_2.Income = TAX_CARD_2.SumPercent - TAX_CARD_2.SumReFin;
            end;
            TAX_CARD_2.IncomeRUR = MoneyL(TAX_CARD_2.Income * CBRate);
          end;
        else
          [ !!! ОШИБКА !!! при определении ставки ЦБ];
        end;
      end;
/*    Заполнение переменных для налоговой карточки */
      if (COMCLNT.CurRec.rec.NotResident == StrFor(0)) /* Резиденты */
        p_1_40(mon-1) = p_1_40(mon-1) + TAX_CARD_2.IncomeRUR; /* Мат.выгода */
        p_1_41        = p_1_41        + TAX_CARD_2.IncomeRUR;
        p_1_42(mon-1) = p_1_40(mon-1);                        /* Мат.выгода минус вычеты */
        p_1_43        = p_1_41;
        p_1_44(mon-1) = p_1_44(mon-1) + TAX_CARD.SummaTaxCalcRUR; /* Расчитанный налог */
        p_1_45        = p_1_45        + TAX_CARD.SummaTaxCalcRUR;
        if (TAX_CARD.SummaTaxPayRUR > 0)
          p_1_46(mon-1) = p_1_46(mon-1) + TAX_CARD.SummaTaxPayRUR; /* Удержаный налог */
          p_1_47        = p_1_47        + TAX_CARD.SummaTaxPayRUR;
        else
          p_1_52(mon-1) = p_1_52(mon-1) - TAX_CARD.SummaTaxPayRUR; /* Возвращенный налог */
          p_1_53        = p_1_53        - TAX_CARD.SummaTaxPayRUR;
        end;
        /* Долг за налогоплательщиком: Расчет минус вычет */
        if (p_1_44(mon-1) > p_1_46(mon-1))
          p_1_48(mon-1) = p_1_44(mon-1) - p_1_46(mon-1);
        else
          p_1_48(mon-1) = 0;
        end;
        /* Долг за банком */
        if (p_1_44(mon-1) < p_1_46(mon-1))
          p_1_50(mon-1) = p_1_46(mon-1) - p_1_44(mon-1);
        else
          p_1_50(mon-1) = 0;
        end;
      else /* Для нерезидентов */
        p_1_24(mon-1) = p_1_24(mon-1) + TAX_CARD_2.IncomeRUR; /* Мат.выгода */
        p_1_25        = p_1_25        + TAX_CARD_2.IncomeRUR;
        p_1_26(mon-1) = p_1_24(mon-1);                        /* Мат.выгода минус вычеты */
        p_1_27        = p_1_25;
        p_1_28(mon-1) = p_1_26(mon-1);                        /* Мат.выгода минус стандартные вычеты */
        p_1_29        = p_1_27;
        p_1_30(mon-1) = p_1_30(mon-1) + TAX_CARD.SummaTaxCalcRUR; /* Расчитанный налог */
        p_1_31        = p_1_31        + TAX_CARD.SummaTaxCalcRUR;
        if (TAX_CARD.SummaTaxPayRUR > 0)
          p_1_32(mon-1) = p_1_32(mon-1) + TAX_CARD.SummaTaxPayRUR; /* Удержаный налог */
          p_1_33        = p_1_33        + TAX_CARD.SummaTaxPayRUR;
        else
          p_1_38(mon-1) = p_1_38(mon-1) - TAX_CARD.SummaTaxPayRUR; /* Возвращенный налог */
          p_1_39        = p_1_39        - TAX_CARD.SummaTaxPayRUR;
        end;
        /* Долг за налогоплательщиком: Расчет минус вычет */
        if (p_1_30(mon-1) > p_1_32(mon-1))
          p_1_34(mon-1) = p_1_30(mon-1) - p_1_32(mon-1);
        else
          p_1_34(mon-1) = 0;
        end;
        /* Долг за банком */
        if (p_1_30(mon-1) < p_1_32(mon-1))
          p_1_36(mon-1) = p_1_32(mon-1) - p_1_30(mon-1);
        else
          p_1_36(mon-1) = 0;
        end;
      end;
      Income          = Income          + TAX_CARD_2.Income;
      IncomeRUR       = IncomeRUR       + TAX_CARD_2.IncomeRUR;
      SumPercent      = SumPercent      + TAX_CARD_2.SumPercent;
      SumReFin        = SumReFin        + TAX_CARD_2.SumReFin;
      SummaTaxCalc    = SummaTaxCalc    + TAX_CARD.SummaTaxCalc;
      SummaTaxCalcRUR = SummaTaxCalcRUR + TAX_CARD.SummaTaxCalcRUR;
      SummaTaxPay     = SummaTaxPay     + TAX_CARD.SummaTaxPay;
      SummaTaxPayRUR  = SummaTaxPayRUR  + TAX_CARD.SummaTaxPayRUR;
      stat = st;
      if (st)
        st = Next (TAX_CARD);
      end;
    end; /* ЦИКЛ по одному месяцу */
    p_1_35 = p_1_35 + p_1_34(mon-1);
    p_1_37 = p_1_37 + p_1_36(mon-1);
    p_1_49 = p_1_49 + p_1_48(mon-1);
    p_1_51 = p_1_51 + p_1_50(mon-1);
    mon = mon + 1;
  end;   /* ЦИКЛ по месяцам (в течение одного года- года выпуска налоговой карточки */
  return stat;
end;
/**********************************************************/

macro Раздел_3
/*
  Выпуск таблицы для нерезидента
*/
  var p_1_23 = "3020"; /* Код дохода */
  var stat = True;
[
 Раздел 3. Расчет налоговой базы и налога на доходы физического лица
 (кроме дивидендов и доходов, облагаемых по ставке 35 %)
  ];
[+---------------+---------+---------------------+--------------------+------------+---------------------+-------------------------------------------------------------------------------+];
[|На начало налогового     |Долг по налогу       |                    |Перенесено  |Долг по налогу       |                                                                               |];
[|периода                  |за налогоплательщиком|                    |в налоговую |за налогоплательщиком|                                                                               |];
[|                         +---------------------+--------------------+карточку    +---------------------+-------------------------------------------------------------------------------+];
[|                         |Долг по налогу       |                    |следующего  |Долг по налогу       |                                                                               |];
[|                         |за налоговым агентом |                    |года        |за налоговым агентом |                                                                               |];
[+-------------------------+---------------------+--------------------+------------+---------------------+-------------------------------------------------------------------------------+];
[|Наименование (код) дохода| Январь    | Февраль   | Март      | Апрель    | Май       | Июнь      | Июль      | Август    | Сентябрь  | Октябрь   | Ноябрь    | Декабрь   |   Итого     |];
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|    ##########           |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_23,p_1_24(0),p_1_24(1),p_1_24(2),p_1_24(3),p_1_24(4),p_1_24(5),p_1_24(6),p_1_24(7),p_1_24(8),p_1_24(9),p_1_24(10),p_1_24(11),p_1_25);
[+---------------+---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Вычеты,        | Код     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|предусмотренные|         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|пунктом 28     |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|ст.217         |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|подпунктами    |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|2, 3 ст.221    |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|НК РФ          |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+---------------+---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Общая сумма    |За месяц |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_26(0),p_1_26(1),p_1_26(2),p_1_26(3),p_1_26(4),p_1_26(5),p_1_26(6),p_1_26(7),p_1_26(8),p_1_26(9),p_1_26(10),p_1_26(11),p_1_27);
[|доходов за     +---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|минусом        |С начала |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|вычетов (п.28  |года     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|ст.217, п.2,   |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|3 ст.221 НК РФ |         |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+---------------+---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|               |За месяц |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               |(код)    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               +---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|               |За месяц |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               |(код)    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|Стандартные    +---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|вычеты (ст.218 |За месяц |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|НК РФ)         |(код)    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               +---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|               |Общая    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               |сумма    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               |с начала |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|               |года     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+---------------+---------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Налоговая база (с начала |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_28(0),p_1_28(1),p_1_28(2),p_1_28(3),p_1_28(4),p_1_28(5),p_1_28(6),p_1_28(7),p_1_28(8),p_1_28(9),p_1_28(10),p_1_28(11),p_1_29);
[|года)                    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Налог исчисленный        |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_30(0),p_1_30(1),p_1_30(2),p_1_30(3),p_1_30(4),p_1_30(5),p_1_30(6),p_1_30(7),p_1_30(8),p_1_30(9),p_1_30(10),p_1_30(11),p_1_31);
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Налог удержанный         |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_32(0),p_1_32(1),p_1_32(2),p_1_32(3),p_1_32(4),p_1_32(5),p_1_32(6),p_1_32(7),p_1_32(8),p_1_32(9),p_1_32(10),p_1_32(11),p_1_33);
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Долг по налогу           |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_34(0),p_1_34(1),p_1_34(2),p_1_34(3),p_1_34(4),p_1_34(5),p_1_34(6),p_1_34(7),p_1_34(8),p_1_34(9),p_1_34(10),p_1_34(11),p_1_35);
[|за налогоплательщиком    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Долг по налогу за        |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_36(0),p_1_36(1),p_1_36(2),p_1_36(3),p_1_36(4),p_1_36(5),p_1_36(6),p_1_36(7),p_1_36(8),p_1_36(9),p_1_36(10),p_1_36(11),p_1_37);
[|налоговым агентом        |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Сумма налога, переданная |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|на взыскание в налоговый |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|орган                    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|Возвращена налоговым     |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_38(0),p_1_38(1),p_1_38(2),p_1_38(3),p_1_38(4),p_1_38(5),p_1_38(6),p_1_38(7),p_1_38(8),p_1_38(9),p_1_38(10),p_1_38(11),p_1_39);
[|агентом излишне          |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|удержанная сумма налога  |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+-------------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
  return stat;
end;
/**********************************************************/

macro Раздел_5
/*
  Выпуск таблицы для резидентов
*/
  var stat = True;
[
 Раздел 5. Расчет налога с доходов, облагаемых по ставке 35 %
  ];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[| N|Наименование (код)| Январь    | Февраль   | Март      | Апрель    | Май       | Июнь      | Июль      | Август    | Сентябрь  | Октябрь   | Ноябрь    | Декабрь   |   Итого     |];
[|  |дохода            |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|1 |Сумма выигрышей   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |призов в целях    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |рекламы           |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|2 |Выигрыши от       |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |лотерей,          |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |тотализаторов и   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |других основанных |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |на риске игр      |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|3 |Сумма разницы     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |страховой выплаты |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |по договорам      |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |добровольного     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |страхования       |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|4 |Налогооблагаемый  |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_40(0),p_1_40(1),p_1_40(2),p_1_40(3),p_1_40(4),p_1_40(5),p_1_40(6),p_1_40(7),p_1_40(8),p_1_40(9),p_1_40(10),p_1_40(11),p_1_41);
[|  |процент по вкладам|           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |в банках          |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|5 |Мат.выгода по     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |заемным средствам |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|6 |Вычет,            |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |предусмотренный   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |п.28 ст.217 по    |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |выигрышам и призам|           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |в целях рекламы   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|7 |Налоговая база    |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_42(0),p_1_42(1),p_1_42(2),p_1_42(3),p_1_42(4),p_1_42(5),p_1_42(6),p_1_42(7),p_1_42(8),p_1_42(9),p_1_42(10),p_1_42(11),p_1_43);
[|  |(стр.1-стр.4)     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |+ стр.2 + стр.3   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |+ стр.4 + стр.5   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|8 |Сумма налога      |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_44(0),p_1_44(1),p_1_44(2),p_1_44(3),p_1_44(4),p_1_44(5),p_1_44(6),p_1_44(7),p_1_44(8),p_1_44(9),p_1_44(10),p_1_44(11),p_1_45);
[|  |исчисленная       |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|9 |Сумма налога      |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_46(0),p_1_46(1),p_1_46(2),p_1_46(3),p_1_46(4),p_1_46(5),p_1_46(6),p_1_46(7),p_1_46(8),p_1_46(9),p_1_46(10),p_1_46(11),p_1_47);
[|  |удержанная        |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|10|Долг по налогу за |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_48(0),p_1_48(1),p_1_48(2),p_1_48(3),p_1_48(4),p_1_48(5),p_1_48(6),p_1_48(7),p_1_48(8),p_1_48(9),p_1_48(10),p_1_48(11),p_1_49);
[|  |налогоплательщиком|           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|11|Долг по налогу за |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_50(0),p_1_50(1),p_1_50(2),p_1_50(3),p_1_50(4),p_1_50(5),p_1_50(6),p_1_50(7),p_1_50(8),p_1_50(9),p_1_50(10),p_1_50(11),p_1_51);
[|  |налоговым агентом |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|12|Сумма налога,     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |переданная на     |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |взыскание в       |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |налоговый орган   |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
[|13|Возвращена        |###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|###########|#############|]
 (p_1_52(0),p_1_52(1),p_1_52(2),p_1_52(3),p_1_52(4),p_1_52(5),p_1_52(6),p_1_52(7),p_1_52(8),p_1_52(9),p_1_52(10),p_1_52(11),p_1_53);
[|  |налоговым агентом |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |излишне удержанная|           |           |           |           |           |           |           |           |           |           |           |           |             |];
[|  |сумма налога      |           |           |           |           |           |           |           |           |           |           |           |           |             |];
[+--+------------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-------------+];
  return stat;
end;
/**********************************************************/

macro Раздел_6
/*
  Выпуск итоговой таблицы
*/
  var stat = True;
/* переменные для таблицы по ТЗ */
  var p_1_54 = p_1_31,
      p_1_55 = p_1_33,
      p_1_56 = p_1_35,
      p_1_57 = p_1_37,
      p_1_58 = p_1_39,
      p_1_59 = p_1_45,
      p_1_60 = p_1_47,
      p_1_61 = p_1_49,
      p_1_62 = p_1_51,
      p_1_63 = p_1_53,
      p_1_64 = p_1_54 + p_1_59,
      p_1_65 = p_1_55 + p_1_60,
      p_1_66 = p_1_56 + p_1_61,
      p_1_67 = p_1_57 + p_1_62,
      p_1_68 = p_1_58 + p_1_63;
[
 Раздел 6. Общая сумма налога по итогам налогового периода
  ];
[+-------------+---------------------------------------------------------------------------------------------------+];
[|Показатели   |Общая сумма налога                                                                                 |];
[|             +-------------+-------------+---------------------------+-------------+-----------------------------+];
[|             |Исчисленная  |Удержанная   |     Долг по налогу        |Перенесена на|По перерасчету зв предшеству-|];
[|             |             |             +-------------+-------------+взыскание в  |ющий налоговый период        |];
[|             |             |             |за налогопла-|за налоговым |налоговый    +-------------+---------------+];
[|             |             |             |тельщиком    |агентом      |орган        |возвращено   |зачтено в счет |];
[|             |             |             |             |             |             |             |налоговых обя- |];
[|             |             |             |             |             |             |             |зательств      |];
[|             |             |             |             |             |             |             |отчетного года |];
[+-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------------+];
[|по ставке 13%|             |             |             |             |             |             |               |];
[+-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------------+];
[|По ставке 30%|#############|#############|#############|#############|             |#############|               |]
 (p_1_54,p_1_55,p_1_56,p_1_57,p_1_58);
[+-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------------+];
[|По ставке 35%|#############|#############|#############|#############|             |#############|               |]
 (p_1_59,p_1_60,p_1_61,p_1_62,p_1_63);
[+-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------------+];
[|Итого        |#############|#############|#############|#############|             |#############|               |]
 (p_1_64,p_1_65,p_1_66,p_1_67,p_1_68);
[+-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------------+];
  return stat;
end;
/**********************************************************/

macro Хвостовик_по_клиенту
  var stat = True;
[


  Правильность заполнения налоговой карточки проверена:
  ########## ##############################  ##############################
  ---------- ------------------------------  ------------------------------  ----------
     Дата             Должность                  Фамилия, Имя, Отчество        Подпись
]
(
  {curdate}:c, Post_Boss:c,  FIO_Boss:c
);
  return stat;
end;
/**********************************************************/

macro Заголовок_по_клиенту
/*
  Заголовок по вкладчику
*/
  var stat = True;
  ARRAY org_a, adr_a, prev_a;
  var   Citizenship = 1; /* Пока резидент */
  var m,y, i;
  var st = True;
  var IDType = "";

  stat = COMCLNT.GetRecord(IdentClient);
  if (stat)

[                                                                  Форма 1-НДФЛ];
[
                              НАЛОГОВАЯ КАРТОЧКА
              ПО УЧЕТУ ДОХОДОВ И НАЛОГА НА ДОХОДЫ ФИЗИЧЕСКИХ ЛИЦ
                             ЗА #### ГОД N ______ ](InputPanel.Year_InAll);
[
 Раздел 1. Сведения о налоговом агенте (источнике доходов)
  ];
[1.1 ИНН/КПП (для организации или ИНН для налогового агента-индивидуального предпринимателя) ###############]( {Bank_INN} );
[1.2 Номер плательщика страховых взносов в ПФ РФ ########## 1.3 Код налогового органа ##########](PF_PayerNumber,CodeTaxAgency);
[1.4 Наименование налогового агента ########################################################################]( {Name_Bank} );
[1.5 Сведения о лице, ответственном за ведение налоговой карточки ##########################################
     #######################################################################################################](Job_Respons,FIO_Respons);
[
 Раздел 2. Сведения о налогоплательщике (получателе дохода)
  ];
[2.1 ИНН ###############  2.2 Номер страхового свидетельства ПФ РФ ](COMCLNT.CurRec.rec.INN);
[2.3 Код налогового органа, где налогоплательщик состоит на налоговом учете];
[2.4 Фамилия, имя, отчество ######################## ######################## ########################](COMCLNT.CurRec.rec.Name1,COMCLNT.CurRec.rec.Name2,COMCLNT.CurRec.rec.Name3);
  NAMEALG.iTypeAlg = 938;
  NAMEALG.iNumberAlg = COMCLNT.CurRec.rec.PaperKind;
  if (GetEQ(NAMEALG))
    IDType = NAMEALG.szNameAlg;
  end;
[2.5 Вид документа, удостоверяющего личность ######################  Код <*> ](IDType);
[2.6 Серия, номер документа ############ ################ 2.7 Дата рождения (число,месяц,год) ##########]
 (COMCLNT.CurRec.rec.PaperSeries,COMCLNT.CurRec.rec.PaperNumber,COMCLNT.CurRec.rec.Born);
if (COMCLNT.CurRec.rec.Address != "")
  StrSplit (COMCLNT.CurRec.rec.Address, adr_a, 50, 50, 2);
[2.8 Адрес постоянного места жительства (в старом формате) ##################################################](adr_a(0));
if (adr_a(1) != "")
[    ##################################################](adr_a(1));
end
else
[2.8 Адрес постоянного места жительства: Код страны ### Индекс ###### Код региона #####](COMCLNT.CurRec.rec.Country,COMCLNT.CurRec.rec.PostIndex,getRegionNumber(COMCLNT.CurRec));
end;
if (COMCLNT.CurRec.rec.NotResident == StrFor(0))
  Citizenship = 1;
else
  Citizenship = 2;
end;
[2.9 Статус (1-резидент,2-нерезидент) # Реквизиты документа, подтверждающего статус ###################### ############ ################]
 (Citizenship, IDType, COMCLNT.CurRec.rec.PaperSeries, COMCLNT.CurRec.rec.PaperNumber);
[2.10 Стандартные вычеты заявлены (1), не заявлены (2)  2];
[2.11 Занимаемая должность                              Дата назначения];
  else
    [ ];
    [ Не найден клиент ###############]( pct.rec.IdentClient );
  end;
  return stat;
end;
/**********************************************************/

macro Последняя_запись_по_клиенту
/*
  Получение последней записи по текущему клиенту
*/
  var stat = True;

  pct.rec.CodeModule    = RPCB_TAX_SBDEPR_RETAIL;
  pct.rec.IdentClient   = IdentClient;
  pct.rec.ObjectTax_Add = Code_Currency;
  pct.rec.DateTaxPay    = VeryBigDate;
  stat = pct.GetLE();
  return stat;
end;
/**********************************************************/

macro ЕстьЗаписиКлиентаПоДругойВалюте
/*
  True, если для клиента в PcTax имеются
  записи по валюте, отличной от Code_Currency
*/
  var RetVal = False;
  var pos = pct.GetPos();
  if ( Последняя_запись_по_клиенту() )
    if ( pct.Next() )
      if ( ( pct.rec.CodeModule  == RPCB_TAX_SBDEPR_RETAIL )
       AND ( pct.rec.IdentClient == IdentClient ) )
        RetVal = True;
      end;
    end;
  end;  
  pct.GetDirect( pos );
  return RetVal;
end;
/***********************************************************
***********************************************************/

macro Выпуск_налоговой_карточки
/*
  Выпуск налоговой карточки- цикл по записям файла
  карточки одного клиента
*/
  var stat;
  var Num = 0;
  var LastIdentClient = "",
      BoolNextClient = True;
  var mon;

  pct.addFilter( "t.t_CodeModule = " + string( RPCB_TAX_SBDEPR_RETAIL ) );
  pct.rec.IdentClient   = Int( InputPanel.IdentClient );
  pct.rec.CodeModule    = RPCB_TAX_SBDEPR_RETAIL;
  pct.rec.ObjectTax_Add = 0;
  pct.rec.DateTaxPay    = Date(0,0,0);
  stat = pct.GetGE();
  while (stat AND (pct.rec.CodeModule == RPCB_TAX_SBDEPR_RETAIL))
    Num = Num + 1;
    if (TheOnlySole AND (pct.rec.IdentClient != InputPanel.IdentClient))
      if (Num == 1)
        MsgBox ("Нет данных по клиенту для выпуска налоговой карточки");
      end;
      stat = False;
    else
/*    Стоим на первой записи по вкладчику */
      IdentClient   = pct.rec.IdentClient;
      Code_Currency = pct.rec.ObjectTax_Add;
      Message (" Обрабатывается клиент ",IdentClient," Валюта ",Code_Currency);
      if (IdentClient != LastIdentClient)
        BoolNextClient  = True;
        LastIdentClient = IdentClient;
      else
        BoolNextClient  = False;
      end;
/*    Если ли записи по клиенту с другой валютой ? */
      BoolLastCurrencyForClient = NOT ЕстьЗаписиКлиентаПоДругойВалюте ();
/*    Начинаем выпуск карточки */
      if (BoolNextClient)
        Заголовок_по_клиенту();
      end;
      if (stat)
        if (BoolNextClient)
/*        Итоговые переменные для таблицы 3 */
          p_1_25 = $0l;
          p_1_27 = $0l;
          p_1_29 = $0l;
          p_1_31 = $0l;
          p_1_33 = $0l;
          p_1_35 = $0l;
          p_1_37 = $0l;
          p_1_39 = $0l;
          mon = 0;
          while (mon < 12)
            p_1_24(mon) = $0l;
            p_1_26(mon) = $0l;
            p_1_28(mon) = $0l;
            p_1_30(mon) = $0l;
            p_1_32(mon) = $0l;
            p_1_34(mon) = $0l;
            p_1_36(mon) = $0l;
            p_1_38(mon) = $0l;
            mon = mon + 1;
          end;
/*        Итоговые переменные для таблицы 5 */
          p_1_41 = $0l;
          p_1_43 = $0l;
          p_1_45 = $0l;
          p_1_47 = $0l;
          p_1_43 = $0l;
          p_1_49 = $0l;
          p_1_51 = $0l;
          p_1_53 = $0l;
          mon = 0;
          while (mon < 12)
            p_1_40(mon) = $0l;
            p_1_42(mon) = $0l;
            p_1_44(mon) = $0l;
            p_1_46(mon) = $0l;
            p_1_48(mon) = $0l;
            p_1_50(mon) = $0l;
            p_1_52(mon) = $0l;
            mon = mon + 1;
          end;
        end;
/*      Переменные для итоговой записи */
        SummaTaxCalc    = $0l;
        SummaTaxPay     = $0l;
        SummaTaxCalcRUR = $0l;
        SummaTaxPayRUR  = $0l;
        SumPercent      = $0l;
        SumReFin        = $0l;
        Income          = $0l;
        IncomeRUR       = $0l;
      end;
      if (stat)
        stat = Заполнение_Данных_По_Клиенту_И_Валюте ();
      end;
      if (stat AND BoolLastCurrencyForClient)
        if (COMCLNT.CurRec.rec.NotResident == StrFor(0))
          stat = Раздел_5 ();  /* Для резидентов   */
        else
          stat = Раздел_3 ();  /* Для нерезидентов */
        end;
      end;
      if (stat AND BoolLastCurrencyForClient)
        stat = Раздел_6 ();
      end;
      if (stat AND BoolLastCurrencyForClient)
        stat = Хвостовик_по_клиенту ();
      end;
      if (stat)
        stat = Последняя_запись_по_клиенту();
      end;
      if (stat)
        stat = pct.Next();
      else
        [ ];
        [ Возникла ошибка при обработке налоговой карточки по клиенту ###############]
         (pct.rec.IdentClient);
        [ Работа прекращена];
      end;
    end;
  end; /* Конец цикла по файлу налоговой карточки */
end;
/**********************************************************/
/*               ВВОД ИСХОДНЫХ ДАННЫХ                     */
/**********************************************************/
                   
macro Проверка_данных
  var stat = True;
/*
  Год выпуска карточки
*/
  if (stat)
    if (InputPanel.Year_InAll < 1900)
      MsgBox ("Введите год, за который будет выпущена карточка (например, 1999) ");
      stat = False;
    else
      BeginDate = Date ( 1, 1,InputPanel.Year_InAll);
      EndDate   = Date (31,12,InputPanel.Year_InAll);
    end;
  end;
/*
  Код клиента
*/
  if (stat)
    InputPanel.IdentClient = Trim(InputPanel.IdentClient);
    if (InputPanel.IdentClient == "")
      TheOnlySole = False;
      stat = GetTrue(True,"Выпускать налоговые карточки по всем вкладчикам?");
    else
      TheOnlySole = True;
      if (NOT COMCLNT.GetRecord(Int(InputPanel.IdentClient)))
        MsgBox ("Не найден вкладчик с заданным кодом");
        stat = False;
      end;
    end;
  end;
  return stat;
end;
/**********************************************************/

macro Подкачка_полей
(
 id,     /* Номер подкачиваемого поля */
 IP      /* Идентификатор панели */
)
  var stat = True;

  if (id == ne_IdentClient)   /* Вкладчик */
    InputPanel.IdentClient = Trim(InputPanel.IdentClient);
    if (InputPanel.IdentClient != "")
      if (COMCLNT.GetRecord(Int(InputPanel.IdentClient)))
        InputPanel.fio = COMCLNT.CurRec.rec.Name1 + " "+
         SubStr(COMCLNT.CurRec.rec.Name2,1,1)+"."+
         SubStr(COMCLNT.CurRec.rec.Name3,1,1)+".";
      else
        InputPanel.fio = "";
      end;
    else
      InputPanel.fio = "";
    end;
    UpdateFields (IP);
  end;
end;
/**********************************************************/

macro WorkDialog (IP, cmd, id, key)
/*
  Обработка нажатия клавишей в панели диалога
*/
  var stat = CM_DEFAULT;
  var Num;

  if (cmd == DLG_KEY)
    if (key == 13)
      Подкачка_полей(id,IP);
      if (id == ne_LastField) /* Enter */
	SetFocus (IP, 0);
	stat = CM_IGNORE;
      end;
    elif (key == 27)	/* Esc - Отказ от выпуска отчета */
      stat = CM_CANCEL;
    elif (key == 323)	/* F9 - пропустить               */
      stat = CM_IGNORE;
    elif (key == 321)	/* F7 - Выпуск отчета            */
      if (Проверка_данных())
        stat = CM_SAVE;
      end;
    end;
  end;
  return stat;
end;
/**********************************************************/

macro Ввод_исходных_данных
/*
*/
  var stat = TRUE;

  if (NOT RunDialog (InputPanel, "WorkDialog"))
    [ Отказались от выпуска налоговой карточки ];
    stat = FALSE;
  end;
  return stat;
end;
/***********************************************************
************************************************************
***********************************************************/

macro rpc_MakeTaxCard
/*
  Головной макрос
*/
  if (Ввод_исходных_данных ())
    Выпуск_налоговой_карточки();
  end;
end;
/* --- */
rpc_MakeTaxCard ();
