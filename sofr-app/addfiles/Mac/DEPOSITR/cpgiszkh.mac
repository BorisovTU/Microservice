/*
  $Name:         cpgiszkh.mac
  $Module:       äÆ¨¨„≠†´Ï≠Î• Ø´†‚•¶®
  $Description:  Çß†®¨Æ§•©·‚¢®• ¨•¶§„ ·®·‚•¨Æ© ™Æ¨¨„≠†´Ï≠ÎÂ Ø´†‚•¶•© ¢ RS-Retail ® Éàë Üäï ¢ RS-Connect
*/

import DeprIntr, BankInter, XmlRpcInter, ServiceAction, RSD, ws_rsconnectclasses, sqlconv, ws_integrationrsconnect, common_service_caller;


private var sb_casln = TBFile( "sb_casln.dbt", "r", 1 );
private var ret_op = TBFile( "ret_op.dbt", "r",  0 );
private var person = TBFile( "person.dbt", "r", 0, null, "bank.def" );
private var namealg = TBFile( "namealg.dbt", "r", 0, "namealg.dbt", "bank.def" );
private var clientList = TClientList;

private var {oper};
private var {BatchMode};

private var urlAddress = "";
private var senderId = "";
private var DateReport = Date( );
private var TimeReport = Time( );

private var globalErrorGIS = false;

GetRegistryValue( "RS-CONNECT\\Éàë_Üäï\\URL", V_STRING, urlAddress );
GetRegistryValue( "RS-CONNECT\\SENDERID\\RETAIL", V_STRING, senderId );

CLASS CApplDoc
  var applKind : integer;
  var applKey : string;
  var statusCode : integer;
  var errText : string;
end;


/**************************************************************************\
|                   èÆ®·™ ≠†ß¢†≠®Ô †´£Æ‡®‚¨† ØÆ •£Æ ™Æ§„                   |
\**************************************************************************/
private macro GetNameAlg( typeAlg, numberAlg )

  namealg.Clear;
  namealg.rec.iTypeAlg   = typeAlg;
  namealg.rec.iNumberAlg = numberAlg;

  if ( namealg.GetEQ )
    return namealg.rec.szNameAlg;
  else
    return "";
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro GetTypePerson( oper )

  person.clear( );
  person.rec.Oper = oper;
  if ( person.getEQ( ) )
    return person.rec.cTypePerson;
  else
    return "";
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro MakePersonId( passType, passSer, passNum )

  var persId = "";
  var str1_2 = "";
  var str3_22 = "";
  var str23_25 = "643";
  var tmpPassSer = Trim( passSer );
  var passSerNew = "";
  var numSymb = 0;

  if ( passType == 0 )
    str1_2 = "01";
  elif ( passType == 1 ) 
    str1_2 = "04";
  elif ( passType == 4 )
    str1_2 = "02";
  elif ( passType == 2 )  
    str1_2 = "05";
  elif ( passType == 14 ) 
    str1_2 = "06";
  elif ( passType == 9 )  
    str1_2 = "07";
  elif ( passType == 11 ) 
    str1_2 = "08";
  elif ( passType ==  5)  
    str1_2 = "09";
  elif ( passType == 20 ) 
    str1_2 = "10";
  elif ( passType == 13 ) 
    str1_2 = "11";
  elif ( passType == 23 ) 
    str1_2 = "12";
  elif ( passType == 7 )  
    str1_2 = "13";
  elif ( passType == 15 ) 
    str1_2 = "03";
  else
    str1_2 = "00";
  end;

  while ( numSymb < StrLen( tmpPassSer ) )
    if ( SubStr( tmpPassSer, numSymb + 1, 1 ) == " " )
      ;
    else
      passSerNew = passSerNew + SubStr( tmpPassSer, numSymb + 1, 1 );
    end;
    numSymb = numSymb + 1;
  end;

  str3_22 = passSerNew + passNum;
  if ( StrLen( str3_22 ) < 20 )
    str3_22 = MkStr( "0", 20 - StrLen( str3_22 ) ) + str3_22; 
  end;

  persId = str1_2 + str3_22 + str23_25;

  return persId;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro IsConfirmOp( applKind, applKey )

  var stat = false;

  sb_casln.KeyNum = 1;
  sb_casln.Clear;
  sb_casln.rec.ApplicationKind2 = applKind;
  sb_casln.rec.ApplicationKey2  = applKey;

  if ( sb_casln.GetEQ )
    ret_op.KeyNum = 0;
    ret_op.Clear;
    ret_op.rec.ApplicationKind = sb_casln.rec.ApplicationKind1;
    ret_op.rec.ApplicationKey = sb_casln.rec.ApplicationKey1;

    if ( ret_op.GetEQ )
      if ( ret_op.rec.State == 50 ) /* OST_CONFIRMED */
        stat = true;
      end;
    end;
  end;

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro IsRetOp( applKind, applKey )

  var stat = false;

  sb_casln.KeyNum = 1;
  sb_casln.Clear;
  sb_casln.rec.ApplicationKind2 = applKind;
  sb_casln.rec.ApplicationKey2  = applKey;

  if ( sb_casln.GetEQ )
    ret_op.KeyNum = 0;
    ret_op.Clear;
    ret_op.rec.ApplicationKind = sb_casln.rec.ApplicationKind1;
    ret_op.rec.ApplicationKey = sb_casln.rec.ApplicationKey1;

    if ( ret_op.GetEQ )
      stat = true;
    end;
  end;

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro IsEmptyPersonId ( personId )
  var stat = true;
  var i = 1;

  if ( ValType( personId ) == V_UNDEF )
    ;
  elif ( personId == "" )
    ;
  elif ( personId == StrFor( 1 ) )
    ;
  else
    while ( i <= StrLen( personId ) )
      if ( SubStr( personId, i, 1 ) != "0" )
        stat = false;
        break;
      end;

      i = i + 1;
    end;
  end;

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintReportGIS( aOrders, aApplDocs )

  var countDocs = aOrders.Size;
  var i = 0;
  var statusZKH = "";
  var fioPayer = "";

  [                                    é‚Á•‚ Æ ·Æß§†≠®® ‡†·ØÆ‡Ô¶•≠®© ≠† ÆØ´†‚„ Üäï];
  [                                               #]( String( DateReport:f ) + " " + String( TimeReport ) );
  [ ];
  [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
  [≥    ë‚†‚„·     ≥    îàé Ø´†‚•´ÏÈ®™†     ≥ Ö§®≠Î© ãë ≥     Üäì     ≥     ë„¨¨†     ≥          è‡®¨•Á†≠®•           ≥];
  [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
  
  while ( i < countDocs )
    statusZKH = GetNameAlg( 1073, aApplDocs[i].statusCode );

    fioPayer = aOrders[i].Charges[0].AddressAndConsumer.Surname;

    if ( ( fioPayer != "" ) and ( aOrders[i].Charges[0].AddressAndConsumer.FirstName != "" ) )
      fioPayer = fioPayer + " " + SubStr( aOrders[i].Charges[0].AddressAndConsumer.FirstName, 1, 1 ) + ".";
      if ( aOrders[i].Charges[0].AddressAndConsumer.Patronymic != "" )
        fioPayer = fioPayer + SubStr( aOrders[i].Charges[0].AddressAndConsumer.Patronymic, 1, 1 ) + ".";
      end;
    end;

    [≥###############≥########################≥###########≥#############≥###############≥###############################≥]
    ( statusZKH:w, fioPayer:w, aOrders[i].Charges[0].UnifiedAccountNumber, aOrders[i].Charges[0].ServiceID, aOrders[i].Amount:15:2:a, aApplDocs[i].errText:w );
    i = i + 1;
  end;

  [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintReportRollbackGIS( aOrders, aApplDocs )

  var cmd, rs;
  var countDocs = aOrders.Size;
  var i = 0;
  var statusZKH = "";
  var fioPayer = "";
  var payerId = "";
  var serviceId = "";
  var paySum = $0L;
  var codClient = 0;

  [ ];
  [                                é‚Á•‚ Æ° †≠≠„´®‡Æ¢†≠®® ‡†·ØÆ‡Ô¶•≠®© ≠† ÆØ´†‚„ Üäï];
  [                                               #]( String( DateReport:f ) + " " + String( TimeReport ) );
  [ ];
  [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
  [≥    ë‚†‚„·     ≥    îàé Ø´†‚•´ÏÈ®™†     ≥ Ö§®≠Î© ãë ≥     Üäì     ≥     ë„¨¨†     ≥          è‡®¨•Á†≠®•           ≥];
  [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
  
  while ( i < countDocs )

    cmd = RsdCommand( "select pay_doc_cp.* from dpay_doc_cp_dbt pay_doc_cp " +
                      "where pay_doc_cp.t_ApplKind = :applKind " +
                        "and pay_doc_cp.t_ApplKey = :applKey" );

    cmd.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
    cmd.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

    cmd.execute;

    rs = RsdRecordset( cmd );

    if ( rs.moveNext( ) )
      payerId = rslString( rs.value( "t_PayerId" ) );
      serviceId = rslString( rs.value( "t_ServiceId" ) );
      paySum = rs.value( "t_PaySum" ) + rs.value( "t_PennySum" );
    else
      payerId = "";
      serviceId = "";
      paySum = $0L;
    end;

    fioPayer = "";
    if ( aApplDocs[i].applKind == 20 )
      cmd = RsdCommand( "select pay_doc.* from dpay_doc_dbt pay_doc " +
                        "where pay_doc.t_iApplicationKind = :applKind " +
                          "and pay_doc.t_ApplicationKey = :applKey" );

      cmd.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
      cmd.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

      cmd.execute;

      rs = RsdRecordset( cmd );

      if ( rs.moveNext( ) )
        fioPayer = rslString( rs.value( "t_ClientLastName" ) );

        if ( ( fioPayer != "" ) and ( rslString( rs.value( "t_ClientFirstName" ) ) != "" ) )
          fioPayer = fioPayer + " " + SubStr( rslString( rs.value( "t_ClientFirstName" ) ), 1, 1 ) + ".";
          if ( rslString( rs.value( "t_ClientSecondName" ) ) != "" )
            fioPayer = fioPayer + SubStr( rslString( rs.value( "t_ClientSecondName" ) ), 1, 1 ) + ".";
          end;
        end;
      end;
    else
      cmd = RsdCommand( "select sbdepdoc.* from dsbdepdoc_dbt sbdepdoc " +
                        "where sbdepdoc.t_iApplicationKind = :applKind " +
                          "and sbdepdoc.t_ApplicationKey = :applKey" );

      cmd.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
      cmd.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

      cmd.execute;

      rs = RsdRecordset( cmd );

      if ( rs.moveNext( ) )
        codClient = rs.value( "t_CodClient" );

        if ( codClient > 0 )
          if ( clientList.GetRecord( codClient ) )
            fioPayer = clientList.CurRec.rec.Name1;

            if ( ( fioPayer != "" ) and ( clientList.CurRec.rec.Name2 != "" ) )
              fioPayer = fioPayer + " " + SubStr( clientList.CurRec.rec.Name2, 1, 1 ) + ".";
              if ( clientList.CurRec.rec.Name3 != "" )
                fioPayer = fioPayer + SubStr( clientList.CurRec.rec.Name3, 1, 1 ) + ".";
              end;
            end;
          end;
        end;
      end;
    end;

    statusZKH = GetNameAlg( 1073, aApplDocs[i].statusCode );

    [≥###############≥########################≥###########≥#############≥###############≥###############################≥]
    ( statusZKH:w, fioPayer:w, payerId, serviceId, paySum:15:2:a, aApplDocs[i].errText:w );
    i = i + 1;
  end;

  [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintHeadReportChargesReq( )

  [                                            é‚Á•‚ Æ ·Æß§†≠®® ß†Ø‡Æ·† ≠†Á®·´•≠®© Üäï];
  [                                                     #]( String( DateReport:f ) + " " + String( TimeReport ) );
  [ ];
  [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
  [≥    îàé Ø´†‚•´ÏÈ®™†     ≥ Ö§®≠Î© ãë ≥     Üäì     ≥              à§•≠‚®‰®™†‚Æ‡              ≥           è‡®¨•Á†≠®•           ≥];
  [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintLineReportChargesReq( docCP, rscQuery, res )

  var fioPayer = "";
  var payerId = "";
  var serviceId = "";
  var sendID = "";
  var errText = ""; 

  fioPayer = rscQuery.surname;

  if ( ( fioPayer != "" ) and ( rscQuery.firstName != "" ) )
    fioPayer = fioPayer + " " + SubStr( rscQuery.firstName, 1, 1 ) + ".";
    if ( rscQuery.patronymic != "" )
      fioPayer = fioPayer + SubStr( rscQuery.patronymic, 1, 1 ) + ".";
    end;
  end;

  payerId = rscQuery.unifiedAccountNumber = docCP.value( "t_PayerId" );
  serviceId = rscQuery.serviceID = docCP.value( "t_ServiceId" );

  if ( ( res.errorCode == "" ) and ( res.errorText == "" ) )
     sendID = res.messageSendID;
  else
    if ( res.errorCode != "" )
      errText = res.errorCode + ": " + res.errorText;
    else
      errText = res.errorText;
    end;
  end;

  [≥########################≥###########≥#############≥#########################################≥################################≥]
  ( fioPayer:w, payerId, serviceId, sendID, errText:w );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintTailReportChargesReq( )

  [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FillCancelOrderGISZKH( aOrders, aApplDocs, rs )

  var applKind = rs.value( "t_ApplKind" );
  var applKey = rslString( rs.value( "t_ApplKey" ) );
  var connectObjectId = rslString( rs.value( "t_ConnectObjectId" ) );
  var numElem = aOrders.Size;

  ret_op.Clear( );

  sb_casln.KeyNum = 1;
  sb_casln.Clear( );
  sb_casln.rec.ApplicationKind2 = applKind;
  sb_casln.rec.ApplicationKey2 = applKey;

  sb_casln.addFilter( "t.t_ApplicationKind2 = " + String( applKind ) + " and " +
                      "t.t_ApplicationKey2 = " + GetSQLString( applKey )         );

  if ( sb_casln.GetGE( ) and ( sb_casln.rec.ApplicationKind2 == applKind ) and ( sb_casln.rec.ApplicationKey2 == applKey ) )
    ret_op.KeyNum = 0;
    ret_op.rec.ApplicationKind = sb_casln.rec.ApplicationKind1;
    ret_op.rec.ApplicationKey = sb_casln.rec.ApplicationKey1;

    if ( ret_op.GetEQ( ) )
      ;
    else
      ret_op.Clear( );
    end;
  end;

  sb_casln.dropFilter;
    
  if ( ( ValType( connectObjectId ) == V_STRING ) and ( connectObjectId != "" ) )
    aApplDocs[numElem] = CApplDoc( );
    aApplDocs[numElem].applKind = applKind;
    aApplDocs[numElem].applKey = applKey;
    aApplDocs[numElem].statusCode = rs.value( "StatusGIS" );
    aApplDocs[numElem].errText = "";

    aOrders[numElem] = RSCCancelOrder( );
    aOrders[numElem].OrderID = ret_op.rec.ApplicationKey;
    aOrders[numElem].ObjectID = connectObjectId;    
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FillOrderGISZKH( aOrders, aApplDocs, rs )

  var applKind = rs.value( "t_ApplKind" );
  var applKey = rslString( rs.value( "t_ApplKey" ) );
  var codClient;
  var docNumber = "";
  var cmdDocNumber, rsDocNumber;
  var cmdProp, rsProp;
  var numElem = aOrders.Size;

  ret_op.Clear( );

  sb_casln.KeyNum = 1;
  sb_casln.Clear( );
  sb_casln.rec.ApplicationKind2 = applKind;
  sb_casln.rec.ApplicationKey2 = applKey;

  sb_casln.addFilter( "t.t_ApplicationKind2 = " + String( applKind ) + " and " +
                      "t.t_ApplicationKey2 = " + GetSQLString( applKey )         );

  if ( sb_casln.GetGE( ) and ( sb_casln.rec.ApplicationKind2 == applKind ) and ( sb_casln.rec.ApplicationKey2 == applKey ) )
    ret_op.KeyNum = 0;
    ret_op.rec.ApplicationKind = sb_casln.rec.ApplicationKind1;
    ret_op.rec.ApplicationKey = sb_casln.rec.ApplicationKey1;

    if ( ret_op.GetEQ( ) )
      cmdDocNumber = RsdCommand( "select t.t_documentNumber as docNumber " +
                                 "from drtdocument_dbt t " +
                                 "where t.t_opApplicationKind = :applKind " +
                                   "and t.t_opApplicationKey = :applKey " +
                                   "and rownum = 1 " +
                                 "order by t.t_documentid" );

      cmdDocNumber.addParam( "applKind", RSDBP_IN, ret_op.rec.ApplicationKind );
      cmdDocNumber.addParam( "applKey", RSDBP_IN, ret_op.rec.ApplicationKey );

      cmdDocNumber.NullConversion = true;
      cmdDocNumber.execute;

      rsDocNumber = RsdRecordset( cmdDocNumber );

      if ( rsDocNumber.moveNext( ) )
        docNumber = rsDocNumber.value( "docNumber" );
      end;
    else
      ret_op.Clear( );
    end;
  end;

  sb_casln.dropFilter;

  cmdProp = RsdCommand( "select rtpaymentprop.* from drtpaymentprop_dbt rtpaymentprop " + 
                        "where rtpaymentprop.t_DocApplicationKind = :applKind " +
                          "and rtpaymentprop.t_DocApplicationKey = :applKey" );

  cmdProp.addParam( "applKind", RSDBP_IN, applKind );
  cmdProp.addParam( "applKey", RSDBP_IN, applKey );

  cmdProp.execute;

  rsProp = RsdRecordset( cmdProp );

  aApplDocs[numElem] = CApplDoc( );
  aApplDocs[numElem].applKind = applKind;
  aApplDocs[numElem].applKey = applKey;
  aApplDocs[numElem].statusCode = rs.value( "StatusGIS" );
  aApplDocs[numElem].errText = "";

  aOrders[numElem] = RSCOrder( );
  // aOrders[numElem].StateID = 0;
  // aOrders[numElem].Format = "";
  // aOrders[numElem].Error = "";
  // aOrders[numElem].UID = "";
  aOrders[numElem].SupplierID = "";
  aOrders[numElem].SupplierName = "";
  aOrders[numElem].RecINN = rslString( rs.value( "t_SupplierINN" ) );
  if ( rslString( rs.value( "t_SupplierShortName" ) ) != "" )
    aOrders[numElem].RecKPP = rslString( rs.value( "t_SupplierKPP" ) );
    aOrders[numElem].RecName = rslString( rs.value( "t_SupplierShortName" ) );
    aOrders[numElem].RecSurname = "";
    aOrders[numElem].RecFirstName = "";
    aOrders[numElem].RecPatronymic = "";
  else
    aOrders[numElem].RecKPP = "";
    aOrders[numElem].RecName = "";
    aOrders[numElem].RecSurname = rslString( rs.value( "t_SupplierName1" ) );
    aOrders[numElem].RecFirstName = rslString( rs.value( "t_SupplierName2" ) );
    aOrders[numElem].RecPatronymic = rslString( rs.value( "t_SupplierName3" ) );
  end;

  if ( rsProp.moveNext( ) )
    aOrders[numElem].RecipientINN = rslString( rsProp.value( "t_INN" ) );
    aOrders[numElem].RecipientKPP = rslString( rsProp.value( "t_KPP" ) );
    aOrders[numElem].RecipientBankName = rslString( rsProp.value( "t_BankName" ) );
    aOrders[numElem].PaymentRecipient = rslString( rsProp.value( "t_Name" ) );
    aOrders[numElem].RecipientBIK = rslString( rsProp.value( "t_BankCode" ) );
    aOrders[numElem].RecipientAccount = rslString( rsProp.value( "t_Account" ) );
    aOrders[numElem].RecipientCorrBankAccount = rslString( rsProp.value( "t_CorrAccount" ) );
  else
    aOrders[numElem].RecipientINN = "";
    aOrders[numElem].RecipientKPP = "";
    aOrders[numElem].RecipientBankName = "";
    aOrders[numElem].PaymentRecipient = "";
    aOrders[numElem].RecipientBIK = "";
    aOrders[numElem].RecipientAccount = "";
    aOrders[numElem].RecipientCorrBankAccount = "";
  end;

  if ( ( aOrders[numElem].RecINN        == "" ) and
       ( aOrders[numElem].RecSurname    == "" ) and
       ( aOrders[numElem].RecFirstName  == "" ) and
       ( aOrders[numElem].RecPatronymic == "" ) and
       ( aOrders[numElem].RecKPP        == "" ) and
       ( aOrders[numElem].RecName       == "" )    ) // ç• ß†§†≠Î Ø†‡†¨•‚‡Î ®·ØÆ´≠®‚•´Ô, ·Á®‚†•¨, Á‚Æ Æ≠ ·Æ¢Ø†§†•‚ · ØÆ´„Á†‚•´•¨
    aOrders[numElem].RecINN = aOrders[numElem].RecipientINN;
    aOrders[numElem].RecKPP = aOrders[numElem].RecipientKPP;
    aOrders[numElem].RecName = aOrders[numElem].PaymentRecipient;
  end;

  aOrders[numElem].OrderID = ret_op.rec.ApplicationKey;
  aOrders[numElem].OrderDate = ret_op.rec.Date;
  aOrders[numElem].OrderNum = docNumber;
  aOrders[numElem].Amount = rs.value( "t_PaySum" ) + rs.value( "t_PennySum" );

  if ( applKind == 20 )
    aOrders[numElem].PaymentPurpose = rslString( rs.value( "t_Ground" ) );
  else
    aOrders[numElem].PaymentPurpose = rslString( rs.value( "t_Ground" ) );
  end;

  aOrders[numElem].Comment = rslString( rs.value( "t_Comment" ) );
  aOrders[numElem].PaymentDocumentID = rslString( rs.value( "t_GISDocNumber" ) );
  aOrders[numElem].PaymentDocumentNumber = rslString( rs.value( "t_PaymentDocumentNumber" ) );

  aOrders[numElem].Charges = TArray( );
  aOrders[numElem].Charges[0] = RSCCharge( );
  aOrders[numElem].Charges[0].Year = rs.value( "t_Year" );
  aOrders[numElem].Charges[0].Month = rs.value( "t_Month" );
  aOrders[numElem].Charges[0].AccountNumber = rslString( rs.value( "t_CPAccount" ) );
  aOrders[numElem].Charges[0].ServiceID = rslString( rs.value( "t_ServiceId" ) );
  aOrders[numElem].Charges[0].UnifiedAccountNumber = rslString( rs.value( "t_PayerId" ) );

  aOrders[numElem].Charges[0].AddressAndConsumer = RSCAddressAndConsumer( );
  aOrders[numElem].Charges[0].AddressAndConsumer.FIASHouseGUID = rslString( rs.value( "t_HouseId" ) );
  aOrders[numElem].Charges[0].AddressAndConsumer.Apartment = rslString( rs.value( "t_FlatId" ) );
  aOrders[numElem].Charges[0].AddressAndConsumer.Placement = rslString( rs.value( "t_RoomId" ) );

  if ( rslString( rs.value( "t_NonLiving" ) ) == "" )
    aOrders[numElem].Charges[0].AddressAndConsumer.isNonLiving = "0";
  else
    aOrders[numElem].Charges[0].AddressAndConsumer.isNonLiving = "1";
  end;

  if ( applKind == 20 )
    aOrders[numElem].SupplierID = rslString( rs.value( "t_PersonId" ) );
    if ( aOrders[numElem].SupplierID == "" )
      aOrders[numElem].SupplierID = "0000000000000000000000000";
    end;
    aOrders[numElem].SupplierName = Trim( rslString( rs.value( "t_ClientLastName" ) ) + " " + rslString( rs.value( "t_ClientFirstName" ) ) + " " + rslString( rs.value( "t_ClientSecondName" ) ) );

    if ( ( rslString( rs.value( "t_ConsumerSurName" ) ) != "" ) or ( rslString( rs.value( "t_ConsumerFirstName" ) ) != "" ) or ( rslString( rs.value( "t_ConsumerPatronymic" ) ) != "" ) )
      aOrders[numElem].Charges[0].AddressAndConsumer.Surname = rslString( rs.value( "t_ConsumerSurName" ) );
      aOrders[numElem].Charges[0].AddressAndConsumer.FirstName = rslString( rs.value( "t_ConsumerFirstName" ) );
      aOrders[numElem].Charges[0].AddressAndConsumer.Patronymic = rslString( rs.value( "t_ConsumerPatronymic" ) );
    else
      aOrders[numElem].Charges[0].AddressAndConsumer.Surname = rslString( rs.value( "t_ClientLastName" ) );
      aOrders[numElem].Charges[0].AddressAndConsumer.FirstName = rslString( rs.value( "t_ClientFirstName" ) );
      aOrders[numElem].Charges[0].AddressAndConsumer.Patronymic = rslString( rs.value( "t_ClientSecondName" ) );
    end;
    aOrders[numElem].Charges[0].AddressAndConsumer.INN = ""; // rslString( rs.value( "t_INN_Payer" ) )
  else
    codClient = rs.value( "t_CodClient" );
    aOrders[numElem].Charges[0].AddressAndConsumer.Surname = "";
    aOrders[numElem].Charges[0].AddressAndConsumer.FirstName = "";
    aOrders[numElem].Charges[0].AddressAndConsumer.Patronymic = "";
    aOrders[numElem].Charges[0].AddressAndConsumer.INN = "";
    if ( codClient > 0 )
      if ( clientList.GetRecord( codClient ) )
        if ( not IsEmptyPersonId( rs.value( "t_PersonId" ) ) )
          aOrders[numElem].SupplierID = rslString( rs.value( "t_PersonId" ) );
        elif ( ( clientList.CurRec.rec.PaperSeries != "" ) or ( clientList.CurRec.rec.PaperNumber != "" ) )
          aOrders[numElem].SupplierID = MakePersonId( clientList.CurRec.rec.PaperKind, clientList.CurRec.rec.PaperSeries, clientList.CurRec.rec.PaperNumber );
        else
          aOrders[numElem].SupplierID = "0000000000000000000000000";
        end;
        aOrders[numElem].SupplierName = Trim( clientList.CurRec.rec.Name1 + " " + clientList.CurRec.rec.Name2 + " " + clientList.CurRec.rec.Name3 );

        if ( ( rslString( rs.value( "t_ConsumerSurName" ) ) != "" ) or ( rslString( rs.value( "t_ConsumerFirstName" ) ) != "" ) or ( rslString( rs.value( "t_ConsumerPatronymic" ) ) != "" ) )
          aOrders[numElem].Charges[0].AddressAndConsumer.Surname = rslString( rs.value( "t_ConsumerSurName" ) );
          aOrders[numElem].Charges[0].AddressAndConsumer.FirstName = rslString( rs.value( "t_ConsumerFirstName" ) );
          aOrders[numElem].Charges[0].AddressAndConsumer.Patronymic = rslString( rs.value( "t_ConsumerPatronymic" ) );
        else
          aOrders[numElem].Charges[0].AddressAndConsumer.Surname = clientList.CurRec.rec.Name1;
          aOrders[numElem].Charges[0].AddressAndConsumer.FirstName = clientList.CurRec.rec.Name2;
          aOrders[numElem].Charges[0].AddressAndConsumer.Patronymic = clientList.CurRec.rec.Name3;
        end;
        aOrders[numElem].Charges[0].AddressAndConsumer.INN = ""; // clientList.CurRec.rec.INN;
      end;
    end;
  end;

  if ( ( ValType( aOrders[numElem].SupplierName ) == V_UNDEF ) or ( aOrders[numElem].SupplierName == "" ) )
    aOrders[numElem].SupplierID = "";
  end;

  // aOrders[numElem].IsCancel = "";
  // aOrders[numElem].CancelBankLogId = null;
  // aOrders[numElem].CancelDate = Date( 0, 0, 0 );
  // aOrders[numElem].CancelTime = Time( 0, 0, 0 );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private class ( CServiceCallerBase ) CSendZKHToGISCaller( _Param, _url )
  private var m_param = _Param;
  private var m_url = _url;

  private macro SetRequestParameters( request : @TXRRequest )
     request.Parms = m_param;
  end;
  
  private macro GetSystemURL() : String
    var m_systemURL;

    if ( ( ValType( m_url ) == V_STRING ) and ( m_url != "" ) )
      m_systemURL = m_url;
    else
      GetRegistryValue( "RS-CONNECT\\Éàë_Üäï\\URL", V_STRING, m_systemURL );
    end;

    return m_systemURL;
  end;

  InitCServiceCallerBase( CreateGUID( ), GetSystemURL( ), "ws_rsconnect_srv", "ReceiveCommonOrder", 300000 );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro CallExtServiceSendZKHToGIS( aOrders, aApplDocs, isOneDoc, isPlanPay )

  var stat = 0;
  var paramArray = TArray;
  var header = RSCOrderHeader( );
  var propFaultString;
  var errMsg;
  var cmdUpdate;
  var cmdError;
  var countDocs;
  var i;
   
  header.SenderID = senderId;
  header.MessageID = CreateGUID( );
  header.SenderPointID = NumFNCash( );
    
  paramArray[0] = header;
  paramArray[1] = aOrders.Size;
  paramArray[2] = aOrders;

  var caller = CSendZKHToGISCaller( paramArray, urlAddress );
  var answer;
  var callService_stat = caller.CallService( @answer );

  if ( not callService_stat )
    stat = 1;
    globalErrorGIS = true;
    errMsg = "éË®°™† Ø‡® ¢ÎßÆ¢• ‚‡†≠·ØÆ‡‚≠Æ© ™Æ¨ØÆ≠•≠‚Î";

    if ( isOneDoc and ( not {BatchMode} ) )
      MsgBox( "éË®°™† ‡•£®·‚‡†Ê®® Ø´†‚•¶† ¢ Éàë Üäï:|" + errMsg );
    else
      println( "éË®°™† ‡•£®·‚‡†Ê®® Ø´†‚•¶† ¢ Éàë Üäï: " + errMsg );
    end;

    countDocs = aApplDocs.Size;
    i = 0;
    while ( i < countDocs )
      // è‡Æ·‚†¢®¨ „ §Æ™„¨•≠‚† ™Æ¨¨„≠†´Ï≠Æ£Æ Ø´†‚•¶† ÆË®°™„ Ø•‡•§†Á® ®≠‰Æ‡¨†Ê®® ¢ Éàë
      if ( ValType( errMsg ) == V_STRING )
        aApplDocs[i].errText = SubStr( errMsg, 1, 255 );
      end;
      aApplDocs[i].statusCode = 3;

      cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " +
                              "set pay_doc_cp.t_Status = 3, " +
                                  "pay_doc_cp.t_Error = :errText " +
                              "where pay_doc_cp.t_ApplKind = :applKind " +
                                "and pay_doc_cp.t_ApplKey = :applKey" );

      if ( ValType( errMsg ) == V_STRING )
        cmdUpdate.addParam( "errText", RSDBP_IN, SubStr( errMsg, 1, 255 ) );
      else
        cmdUpdate.addParam( "errText", RSDBP_IN, "" );
      end;
      cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
      cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

      cmdUpdate.execute;

      if ( isPlanPay )
        cmdError = RsdCommand( "update drsbedref_tmp rsbedref " +
                               "set rsbedref.t_Error = :errText " +
                               "where rsbedref.t_ApplicationKind = :applKind " +
                                 "and rsbedref.t_ApplicationKey = :applKey" );

        if ( ValType( errMsg ) == V_STRING )
          cmdError.addParam( "errText", RSDBP_IN, SubStr( errMsg, 1, 255 ) );
        else
          cmdError.addParam( "errText", RSDBP_IN, "" );
        end;
        cmdError.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
        cmdError.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

        cmdError.execute;
      end;

      i = i + 1;
    end;
  else
    propFaultString = GenPropID( answer, "faultString" ); 

    if ( propFaultString != -1 )
      globalErrorGIS = true;
      if ( isOneDoc and ( not {BatchMode} ) )
        MsgBox( "éË®°™† ‡•£®·‚‡†Ê®® Ø´†‚•¶† ¢ Éàë Üäï:|" + answer.faultString );
      else
        println( "éË®°™† ‡•£®·‚‡†Ê®® Ø´†‚•¶† ¢ Éàë Üäï: " + answer.faultString );
      end;

      countDocs = aApplDocs.Size;
      i = 0;
      while ( i < countDocs )
        // è‡Æ·‚†¢®¨ „ §Æ™„¨•≠‚† ™Æ¨¨„≠†´Ï≠Æ£Æ Ø´†‚•¶† ÆË®°™„ Ø•‡•§†Á® ®≠‰Æ‡¨†Ê®® ¢ Éàë
        if ( ValType( answer.faultString ) == V_STRING )
          aApplDocs[i].errText = SubStr( answer.faultString, 1, 255 );
        end;
        aApplDocs[i].statusCode = 3;

        cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " +
                                "set pay_doc_cp.t_Status = 3, " +
                                    "pay_doc_cp.t_Error = :errText " +
                                "where pay_doc_cp.t_ApplKind = :applKind " +
                                  "and pay_doc_cp.t_ApplKey = :applKey" );

        if ( ValType( answer.faultString ) == V_STRING )
          cmdUpdate.addParam( "errText", RSDBP_IN, SubStr( answer.faultString, 1, 255 ) );
        else
          cmdUpdate.addParam( "errText", RSDBP_IN, "" );
        end;
        cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
        cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

        cmdUpdate.execute;
            
        if ( isPlanPay )
          cmdError = RsdCommand( "update drsbedref_tmp rsbedref " +
                                 "set rsbedref.t_Error = :errText " +
                                 "where rsbedref.t_ApplicationKind = :applKind " +
                                   "and rsbedref.t_ApplicationKey = :applKey" );

          if ( ValType( answer.faultString ) == V_STRING )
            cmdError.addParam( "errText", RSDBP_IN, SubStr( answer.faultString, 1, 255 ) );
          else
            cmdError.addParam( "errText", RSDBP_IN, "" );
          end;
          cmdError.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdError.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdError.execute;
        end;

        i = i + 1;
      end;
    else
      countDocs = answer.Result.Size;
      i = 0;
      while ( i < countDocs )
        if ( ( ValType( answer.Result[i].ErrorCode ) != V_UNDEF ) and ( answer.Result[i].ErrorCode == 40002 ) )
          cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " + 
                                  "set t_ConnectObjectID = :objectId, t_Status = 2, t_Error = chr( 1 ) " +
                                  "where pay_doc_cp.t_ApplKind = :applKind " +
                                    "and pay_doc_cp.t_ApplKey = :applKey" );

          cmdUpdate.addParam( "objectId", RSDBP_IN, answer.Result[i].ObjectID );
          cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdUpdate.execute;

          aApplDocs[i].statusCode = 2;
        elif ( ( ( ValType( answer.Result[i].ErrorCode ) != V_UNDEF ) and ( answer.Result[i].ErrorCode != 0 ) ) or 
               ( ( ValType( answer.Result[i].Error     ) != V_UNDEF ) and ( answer.Result[i].Error != ""    ) )   )
          // è‡Æ·‚†¢®¨ „ §Æ™„¨•≠‚† ™Æ¨¨„≠†´Ï≠Æ£Æ Ø´†‚•¶† ÆË®°™„ Ø•‡•§†Á® ®≠‰Æ‡¨†Ê®® ¢ Éàë
          if ( answer.Result[i].Error != "" )
            aApplDocs[i].errText = SubStr( answer.Result[i].Error, 1, 255 );
          else
            aApplDocs[i].errText = "äÆ§ ÆË®°™® " + String( answer.Result[i].ErrorCode );
          end;
          aApplDocs[i].statusCode = 3;

          cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " +
                                  "set pay_doc_cp.t_Status = 3, " +
                                      "pay_doc_cp.t_Error = :errText " +
                                  "where pay_doc_cp.t_ApplKind = :applKind " +
                                    "and pay_doc_cp.t_ApplKey = :applKey" );

          cmdUpdate.addParam( "errText", RSDBP_IN, aApplDocs[i].errText );
          cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdUpdate.execute;                      

          if ( isOneDoc and ( not {BatchMode} ) )
            if ( answer.Result[i].Error != "" )
              MsgBox( "éË®°™† ‡•£®·‚‡†Ê®® Ø´†‚•¶† ¢ Éàë Üäï:|" + answer.Result[i].Error );
            else
              MsgBox( "éË®°™† ‡•£®·‚‡†Ê®® Ø´†‚•¶† ¢ Éàë Üäï: ™Æ§ " + String( answer.Result[i].ErrorCode ) );
            end;
          end;

          if ( isPlanPay )
            cmdError = RsdCommand( "update drsbedref_tmp rsbedref " +
                                   "set rsbedref.t_Error = :errText " +
                                   "where rsbedref.t_ApplicationKind = :applKind " +
                                     "and rsbedref.t_ApplicationKey = :applKey" );

            cmdError.addParam( "errText", RSDBP_IN, aApplDocs[i].errText );
            cmdError.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
            cmdError.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

            cmdError.execute;
          end;
        else
          cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " + 
                                  "set t_ConnectObjectID = :objectId, t_Status = 2, t_Error = chr( 1 ) " +
                                  "where pay_doc_cp.t_ApplKind = :applKind " +
                                    "and pay_doc_cp.t_ApplKey = :applKey" );

          cmdUpdate.addParam( "objectId", RSDBP_IN, answer.Result[i].ObjectID );
          cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdUpdate.execute;

          aApplDocs[i].statusCode = 2;
        end;

        i = i + 1;
      end;
    end;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private class ( CServiceCallerBase ) CRollbackZKHInGISCaller( _Param, _url )
  private var m_param = _Param;
  private var m_url = _url;

  private macro SetRequestParameters( request : @TXRRequest )
     request.Parms = m_param;
  end;
  
  private macro GetSystemURL() : String
    var m_systemURL;

    if ( ( ValType( m_url ) == V_STRING ) and ( m_url != "" ) )
      m_systemURL = m_url;
    else
      GetRegistryValue( "RS-CONNECT\\Éàë_Üäï\\URL", V_STRING, m_systemURL );
    end;

    return m_systemURL;
  end;

  InitCServiceCallerBase( CreateGUID( ), GetSystemURL( ), "ws_rsconnect_srv", "ReceiveCancelOrder", 300000 );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro CallExtServiceRollbackZKHInGIS( aOrders, aApplDocs, isOneDoc )

  var retValue = true;
  var stat = 0;
  var paramArray = TArray;
  var header = RSCOrderHeader( );
  var propFaultString;
  var errMsg;
  var cmdUpdate;
  var countDocs;
  var i;
   
  header.SenderID = senderId;
  header.MessageID = CreateGUID( );
  header.SenderPointID = NumFNCash( );
    
  paramArray[0] = header;
  paramArray[1] = aOrders.Size;
  paramArray[2] = aOrders;

  var caller = CRollbackZKHInGISCaller( paramArray, urlAddress );
  var answer;
  var callService_stat = caller.CallService( @answer );

  if ( not callService_stat )
    stat = 1;
    globalErrorGIS = true;
    errMsg = "éË®°™† Ø‡® ¢ÎßÆ¢• ‚‡†≠·ØÆ‡‚≠Æ© ™Æ¨ØÆ≠•≠‚Î";

    if ( isOneDoc )
      retValue = false;
    end; 

    if ( isOneDoc and ( not {BatchMode} ) )
      MsgBox( "éË®°™† Æ‚¨•≠Î Ø´†‚•¶† ¢ Éàë Üäï:|" + errMsg );
    else
      println( "éË®°™† Æ‚¨•≠Î Ø´†‚•¶† ¢ Éàë Üäï: " + errMsg );
    end;

    countDocs = aApplDocs.Size;
    i = 0;
    while ( i < countDocs )
      // è‡Æ·‚†¢®¨ „ §Æ™„¨•≠‚† ™Æ¨¨„≠†´Ï≠Æ£Æ Ø´†‚•¶† ÆË®°™„ †≠≠„´®‡Æ¢†≠®Ô ¢ Éàë
      cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " +
                              "set pay_doc_cp.t_Status = 6, " +
                                  "pay_doc_cp.t_Error = :errText " +
                              "where pay_doc_cp.t_ApplKind = :applKind " +
                                "and pay_doc_cp.t_ApplKey = :applKey" );

      if ( ValType( errMsg ) == V_STRING )
        cmdUpdate.addParam( "errText", RSDBP_IN, SubStr( errMsg, 1, 255 ) );
      else
        cmdUpdate.addParam( "errText", RSDBP_IN, "" );
      end;
      cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
      cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

      cmdUpdate.execute;

      i = i + 1;
    end;
  else
    propFaultString = GenPropID( answer, "faultString" ); 

    if ( propFaultString != -1 )
      globalErrorGIS = true;
      if ( isOneDoc )
        retValue = false;
      end; 
      if ( isOneDoc and ( not {BatchMode} ) )
        MsgBox( "éË®°™† Æ‚¨•≠Î Ø´†‚•¶† ¢ Éàë Üäï:|" + answer.faultString );
      else
        println( "éË®°™† Æ‚¨•≠Î Ø´†‚•¶† ¢ Éàë Üäï: " + answer.faultString );
      end;

      countDocs = aApplDocs.Size;
      i = 0;
      while ( i < countDocs )
        // è‡Æ·‚†¢®¨ „ §Æ™„¨•≠‚† ™Æ¨¨„≠†´Ï≠Æ£Æ Ø´†‚•¶† ÆË®°™„ †≠≠„´®‡Æ¢†≠®Ô ¢ Éàë
        cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " +
                                "set pay_doc_cp.t_Status = 6, " +
                                    "pay_doc_cp.t_Error = :errText " +
                                "where pay_doc_cp.t_ApplKind = :applKind " +
                                  "and pay_doc_cp.t_ApplKey = :applKey" );

        if ( ValType( answer.faultString ) == V_STRING )
          cmdUpdate.addParam( "errText", RSDBP_IN, SubStr( answer.faultString, 1, 255 ) );
        else
          cmdUpdate.addParam( "errText", RSDBP_IN, "" );
        end;
        cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
        cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

        cmdUpdate.execute;

        i = i + 1;
      end;
    else
      countDocs = answer.Result.Size;
      i = 0;
      while ( i < countDocs )
        if ( ( ValType( answer.Result[i].ErrorCode ) != V_UNDEF ) and ( answer.Result[i].ErrorCode == 40005 ) )
          cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " + 
                                  "set t_Status = 5, t_Error = chr( 1 ) " +
                                  "where pay_doc_cp.t_ApplKind = :applKind " +
                                    "and pay_doc_cp.t_ApplKey = :applKey" );

          cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdUpdate.execute;

          aApplDocs[i].statusCode = 5;
        elif ( ( ( ValType( answer.Result[i].ErrorCode ) != V_UNDEF ) and ( answer.Result[i].ErrorCode != 0 ) ) or 
               ( ( ValType( answer.Result[i].Error     ) != V_UNDEF ) and ( answer.Result[i].Error != ""    ) )   )
          // è‡Æ·‚†¢®¨ „ §Æ™„¨•≠‚† ™Æ¨¨„≠†´Ï≠Æ£Æ Ø´†‚•¶† ÆË®°™„ †≠≠„´®‡Æ¢†≠®Ô ¢ Éàë
          if ( answer.Result[i].Error != "" )
            aApplDocs[i].errText = SubStr( answer.Result[i].Error, 1, 255 );
          else
            aApplDocs[i].errText = "äÆ§ ÆË®°™® " + String( answer.Result[i].ErrorCode );
          end;
          aApplDocs[i].statusCode = 6;

          cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " +
                                  "set pay_doc_cp.t_Status = 6, " +
                                      "pay_doc_cp.t_Error = :errText " +
                                  "where pay_doc_cp.t_ApplKind = :applKind " +
                                    "and pay_doc_cp.t_ApplKey = :applKey" );

          cmdUpdate.addParam( "errText", RSDBP_IN, aApplDocs[i].errText );
          cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdUpdate.execute;

          if ( isOneDoc )
            retValue = false;
          end; 

          if ( isOneDoc and ( not {BatchMode} ) )
            if ( answer.Result[i].Error != "" )
              MsgBox( "éË®°™† Æ‚¨•≠Î Ø´†‚•¶† ¢ Éàë Üäï:|" + answer.Result[i].Error );
            else
              MsgBox( "éË®°™† Æ‚¨•≠Î Ø´†‚•¶† ¢ Éàë Üäï: ™Æ§ " + String( answer.Result[i].ErrorCode ) );
            end;
          end;
        else
          cmdUpdate = RsdCommand( "update dpay_doc_cp_dbt pay_doc_cp " + 
                                  "set t_Status = 5, t_Error = chr( 1 ) " +
                                  "where pay_doc_cp.t_ApplKind = :applKind " +
                                    "and pay_doc_cp.t_ApplKey = :applKey" );

          cmdUpdate.addParam( "applKind", RSDBP_IN, aApplDocs[i].applKind );
          cmdUpdate.addParam( "applKey", RSDBP_IN, aApplDocs[i].applKey );

          cmdUpdate.execute;

          aApplDocs[i].statusCode = 5;
        end;

        i = i + 1;
      end;
    end;
  end;
  
  return retValue;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro SendZKHToGIS( branch, startDate, endDate )

  var aOrders = TArray;
  var aApplDocs = TArray;
  var cmd, rs;
  var strCommand;
  var typePerson = GetTypePerson( {oper} );

  Message2( " ÇÎØÆ´≠Ô•‚·Ô ‡•£®·‚‡†Ê®Ô Ø´†‚•¶•© ¢ Éàë Üäï..." );

  strCommand = "select /*+ LEADING( pay_doc_cp ) INDEX( pay_doc_cp DPAY_DOC_CP_DBT_IDX4 ) */ pay_doc_cp.*, pay_doc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, dpay_doc_dbt pay_doc " +
               "where pay_doc_cp.t_ApplKind = 20 " +
                 // "and pay_doc_cp.t_Date_Document >= :startDate " +
                 // "and pay_doc_cp.t_Date_Document <= :endDate " +
                 "and pay_doc.t_iApplicationKind = pay_doc_cp.t_ApplKind " +
                 "and pay_doc.t_ApplicationKey = pay_doc_cp.t_ApplKey " +
                 "and pay_doc.t_IsSuspended = chr( 0 ) " +
                 "and pay_doc.t_Status = 0 " +
                 "and pay_doc.t_Action not in ( 2, 11 ) " +
                 "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                 "and pay_doc_cp.t_Status in ( 1, 3 )";

  if ( branch > 0 )
    strCommand = strCommand + " and pay_doc_cp.t_Branch = :branch";
  end;

  /*
  if ( typePerson == "é" )
    strCommand = strCommand + " and pay_doc.t_Oper = :oper";
  end;
  */

  cmd = RsdCommand( strCommand );

  // cmd.addParam( "startDate", RSDBP_IN, startDate );
  // cmd.addParam( "endDate", RSDBP_IN, endDate );
  if ( branch > 0 )
    cmd.addParam( "branch", RSDBP_IN, branch );
  end;
  /*
  if ( typePerson == "é" )
    cmd.addParam( "oper", RSDBP_IN, {oper} );
  end;
  */

  cmd.execute;

  rs = RsdRecordset( cmd );

  while ( rs.moveNext( ) )
    if ( IsConfirmOp( rs.value( "t_ApplKind" ), rs.value( "t_ApplKey" ) ) )
      FillOrderGISZKH( aOrders, aApplDocs, rs );
    end;
  end;

  strCommand = "select /*+ LEADING( pay_doc_cp ) INDEX( pay_doc_cp DPAY_DOC_CP_DBT_IDX4 ) */ pay_doc_cp.*, sbdepdoc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, dsbdepdoc_dbt sbdepdoc " +
               "where pay_doc_cp.t_ApplKind > 0 " +
                 "and pay_doc_cp.t_ApplKind != 20 " +
                 // "and pay_doc_cp.t_Date_Document >= :startDate " +
                 // "and pay_doc_cp.t_Date_Document <= :endDate " +
                 "and sbdepdoc.t_iApplicationKind = pay_doc_cp.t_ApplKind " +
                 "and sbdepdoc.t_ApplicationKey = pay_doc_cp.t_ApplKey " +
                 "and sbdepdoc.t_IsSuspended = chr( 0 ) " +
                 "and sbdepdoc.t_Action not in ( 2, 11 ) " +
                 "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                 "and pay_doc_cp.t_Status in ( 1, 3 )"; // èÆ§£Æ‚Æ¢´•≠ ®´® éË®°™† Ø•‡•§†Á®

  if ( branch > 0 )
    strCommand = strCommand + " and pay_doc_cp.t_Branch = :branch";
  end;

  /*
  if ( typePerson == "é" )
    strCommand = strCommand + " and pay_doc.t_Oper = :oper";
  end;
  */

  cmd = RsdCommand( strCommand );

  // cmd.addParam( "startDate", RSDBP_IN, startDate );
  // cmd.addParam( "endDate", RSDBP_IN, endDate );
  if ( branch > 0 )
    cmd.addParam( "branch", RSDBP_IN, branch );
  end;
  /*
  if ( typePerson == "é" )
    cmd.addParam( "oper", RSDBP_IN, {oper} );
  end;
  */

  cmd.execute;

  rs = RsdRecordset( cmd );

  while ( rs.moveNext( ) )
    if ( IsConfirmOp( rs.value( "t_ApplKind" ), rs.value( "t_ApplKey" ) ) )
      FillOrderGISZKH( aOrders, aApplDocs, rs );
    end;
  end;

  if ( aOrders.Size > 0 )
    CallExtServiceSendZKHToGIS( aOrders, aApplDocs, false, false );
  end;

  if ( not globalErrorGIS )
    PrintReportGIS( aOrders, aApplDocs );
  end;

  // Ä≠≠„´®‡Æ¢†≠®• Ø´†‚•¶•© ¢ Éàë Üäï
  if ( not globalErrorGIS )
    Message2( " ÇÎØÆ´≠Ô•‚·Ô †≠≠„´®‡Æ¢†≠®• Ø´†‚•¶•© ¢ Éàë Üäï..." );

    aOrders = TArray;
    aApplDocs = TArray;

    strCommand = "select /*+ LEADING( pay_doc_cp ) INDEX( pay_doc_cp DPAY_DOC_CP_DBT_IDX4 ) */ pay_doc_cp.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp " +
                 "where pay_doc_cp.t_ApplKind > 0 " +
                   // "and pay_doc_cp.t_Date_Document >= :startDate " +
                   // "and pay_doc_cp.t_Date_Document <= :endDate " +
                   "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                   "and pay_doc_cp.t_Status in ( 4, 6 )"; // ä †≠≠„´®‡Æ¢†≠®Ó ®´® éË®°™† †≠≠„´®‡Æ¢†≠®Ô

    cmd = RsdCommand( strCommand );

    cmd.execute;

    rs = RsdRecordset( cmd );

    while ( rs.moveNext( ) )
      FillCancelOrderGISZKH( aOrders, aApplDocs, rs );
    end;

    if ( aOrders.Size > 0 )
      CallExtServiceRollbackZKHInGIS( aOrders, aApplDocs, false );
    end;

    if ( not globalErrorGIS )
      PrintReportRollbackGIS( aOrders, aApplDocs );
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro SendPlanPayZKHToGIS

  var aOrders = TArray;
  var aApplDocs = TArray;
  var cmd, rs;
  var applKind;

  Message2( " ÇÎØÆ´≠Ô•‚·Ô ‡•£®·‚‡†Ê®Ô Ø´†‚•¶•© ¢ Éàë Üäï..." );

  cmd = RsdCommand( "select pay_doc_cp.*, sbdepdoc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, drsbedref_tmp rsbedref, dsbdepdoc_dbt sbdepdoc " + 
                    "where rsbedref.t_applicationkind in ( 1, 110, 111 ) " +
                      "and pay_doc_cp.t_ApplKind = rsbedref.t_ApplicationKind " +
                      "and pay_doc_cp.t_ApplKey = rsbedref.t_ApplicationKey " + 
                      "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                      "and pay_doc_cp.t_Status in ( 1, 3 ) " +
                      "and sbdepdoc.t_iApplicationKind = pay_doc_cp.t_ApplKind " +
                      "and sbdepdoc.t_ApplicationKey = pay_doc_cp.t_ApplKey" );

  cmd.execute;

  rs = RsdRecordset( cmd );

  while ( rs.moveNext( ) )
    FillOrderGISZKH( aOrders, aApplDocs, rs );
  end;

  if ( aOrders.Size > 0 )
    CallExtServiceSendZKHToGIS( aOrders, aApplDocs, false, true );
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro SendOneZKHToGIS( applKind, applKey )

  var aOrders = TArray;
  var aApplDocs = TArray;
  var cmd, rs;

  Message2( " ÇÎØÆ´≠Ô•‚·Ô ‡•£®·‚‡†Ê®Ô Ø´†‚•¶† ¢ Éàë Üäï..." );

  if ( applKind == 20 )
    cmd = RsdCommand( "select pay_doc_cp.*, pay_doc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, dpay_doc_dbt pay_doc " +
                      "where pay_doc.t_iApplicationKind = :applKind " +
                        "and pay_doc.t_ApplicationKey = :applKey " +
                        "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                        "and pay_doc_cp.t_Status in ( 1, 3 ) " +
                        "and pay_doc_cp.t_ApplKind = pay_doc.t_iApplicationKind " +
                        "and pay_doc_cp.t_ApplKey = pay_doc.t_ApplicationKey" );
  else
    cmd = RsdCommand( "select pay_doc_cp.*, sbdepdoc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, dsbdepdoc_dbt sbdepdoc " +
                      "where sbdepdoc.t_iApplicationKind = :applKind " +
                        "and sbdepdoc.t_ApplicationKey = :applKey " +
                        "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                        "and pay_doc_cp.t_Status in ( 1, 3 ) " +
                        "and pay_doc_cp.t_ApplKind = sbdepdoc.t_iApplicationKind " +
                        "and pay_doc_cp.t_ApplKey = sbdepdoc.t_ApplicationKey" );
  end;

  cmd.addParam( "applKind", RSDBP_IN, applKind );
  cmd.addParam( "applKey", RSDBP_IN, applKey );

  cmd.execute;

  rs = RsdRecordset( cmd );

  if ( rs.moveNext( ) )
    if ( IsRetOp( applKind, applKey ) )
      FillOrderGISZKH( aOrders, aApplDocs, rs );
      if ( aOrders.Size > 0 )
        CallExtServiceSendZKHToGIS( aOrders, aApplDocs, true, false );
      end;
    end;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro RollbackOneZKHInGIS( applKind, applKey )

  var aOrders = TArray;
  var aApplDocs = TArray;
  var cmd, rs;
  var stat = true;

  Message2( " ÇÎØÆ´≠Ô•‚·Ô †≠≠„´®‡Æ¢†≠®• Ø´†‚•¶† ¢ Éàë Üäï..." );

  if ( applKind == 20 )
    cmd = RsdCommand( "select pay_doc_cp.*, pay_doc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, dpay_doc_dbt pay_doc " +
                      "where pay_doc.t_iApplicationKind = :applKind " +
                        "and pay_doc.t_ApplicationKey = :applKey " +
                        "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                        "and pay_doc_cp.t_Status in ( 2, 4, 6 ) " +
                        "and pay_doc_cp.t_ApplKind = pay_doc.t_iApplicationKind " +
                        "and pay_doc_cp.t_ApplKey = pay_doc.t_ApplicationKey" );
  else
    cmd = RsdCommand( "select pay_doc_cp.*, sbdepdoc.*, pay_doc_cp.t_Status as StatusGIS from dpay_doc_cp_dbt pay_doc_cp, dsbdepdoc_dbt sbdepdoc " +
                      "where sbdepdoc.t_iApplicationKind = :applKind " +
                        "and sbdepdoc.t_ApplicationKey = :applKey " +
                        "and pay_doc_cp.t_IsForGIS != chr( 0 ) " +
                        "and pay_doc_cp.t_Status in ( 2, 4, 6 ) " +
                        "and pay_doc_cp.t_ApplKind = sbdepdoc.t_iApplicationKind " +
                        "and pay_doc_cp.t_ApplKey = sbdepdoc.t_ApplicationKey" );
  end;

  cmd.addParam( "applKind", RSDBP_IN, applKind );
  cmd.addParam( "applKey", RSDBP_IN, applKey );

  cmd.execute;

  rs = RsdRecordset( cmd );

  if ( rs.moveNext( ) )
    FillCancelOrderGISZKH( aOrders, aApplDocs, rs );
    if ( aOrders.Size > 0 )
      stat = CallExtServiceRollbackZKHInGIS( aOrders, aApplDocs, true );
    end;
  end;

  stat = true; // é‚™†‚Î¢†‚Ï ¨Æ¶≠Æ §†¶• ¢ ·´„Á†• ÆË®°™®

  return stat;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ReqGISGKH
( 
  PaymentDocumentID,
  Year,
  Month,
  UnifiedAccountNumber,
  ServiceID,
  FIASHouseGuid,
  PaymentDocumentNumber,
  AccountNumber,
  Surname,
  FirstName,
  Patronymic,
  INN,
  KPP
)

  if ( (urlAddress == "") or (senderId == "") )
    if ( {BatchMode} )
      println( "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect" );
    end;
    return "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect";
  end;

  var rscOrderHeader = CreateRscOrderHeaderJava();
  rscOrderHeader.messageID = CreateGUID( );
  rscOrderHeader.senderID = senderId;
  rscOrderHeader.senderPointID = NumFNCash( );

  var rscQuery = CreateRscQueryJava();
  rscQuery.paymentDocumentID = PaymentDocumentID;
  rscQuery.year = Year;
  rscQuery.month = Month;
  rscQuery.unifiedAccountNumber = UnifiedAccountNumber;
  rscQuery.serviceID = ServiceID;
  rscQuery.FIASHouseGuid = FIASHouseGuid;
  rscQuery.paymentDocumentNumber = PaymentDocumentNumber;
  rscQuery.accountNumber = AccountNumber;
  rscQuery.surname = Surname;
  rscQuery.firstName = FirstName;
  rscQuery.patronymic = Patronymic;
  rscQuery.INN = INN;
  rscQuery.KPP = KPP;

  var res = callhsSendPaymQueryToSMEV(rscOrderHeader, rscQuery, urlAddress);
  if ( (res.errorCode != "") or (res.errorText != "") )
    return res.errorText;
  end;

  rscOrderHeader.messageID = CreateGUID( );
  var count = 0;
  InitProgress (7, "èÆ´„Á•≠®• ·Ø®·™† ≠†Á®·´•≠®©", "äÆ´®Á•·‚¢Æ ß†Ø‡Æ·Æ¢ ¢ Éàë Üäï §´Ô ØÆ´„Á•≠®Ô ·Ø®·™† ≠†Á®·´•≠®©");
  //BegAction();
  while ( count != 7 )
    count = count + 1;
    UseProgress (count);
    Delay(10000);
    var rescall = callhsResultPaymQueryFromSMEV(rscOrderHeader, res.messageSendID, res.queryID, urlAddress);

    if ( Int(rescall.statusCode) == 4 )
      RemProgress();
      //EndAction();
      break;
    elif ( (Int(rescall.statusCode) == 3) or (rescall.statusCode == "") )
      RemProgress();
      //EndAction();
      return rescall.errorText;
    end;

  end;

  file chargeslist ("rt_chargeslistgisgkh.tmp") key 0 write;
  if ( rescall.countPayments > 0 )
    var resList = rescall.charges.toArray;
    var item;
    
    for (item, resList)
      ClearRecord( chargeslist );
      
      chargeslist.ErrorCode = rescall.errorCode;
      chargeslist.ErrorText = rescall.errorText;
      chargeslist.RecINN = item.recINN;
      chargeslist.RecSurname = item.recSurname;
      chargeslist.RecFirstName = item.recFirstName;
      chargeslist.RecPatronymic = item.recPatronymic;
      chargeslist.RecKPP = item.recKPP;
      chargeslist.RecName = item.recName;
      chargeslist.RecepientINN = item.recepientINN;
      chargeslist.RecepientKPP = item.recepientKPP;
      chargeslist.RecepientBankBIK = item.recepientBankBIK;
      chargeslist.RecepientBankName = item.recepientBankName;
      chargeslist.RecepientCorrBankAccount = item.recepientCorrBankAccount;
      chargeslist.PaymentRecepient = item.paymentRecepient;
      chargeslist.RecepientAccount = item.recepientAccount;
      chargeslist.MailingAddress = item.mailingAddress;
      chargeslist.Amount = item.amount;
      chargeslist.DebtAmount = item.debtAmount;
      chargeslist.PaymentPurpose = item.paymentPurpose;
      chargeslist.PaymentDocumentID = item.paymentDocumentID;
      chargeslist.PaymentDocumentNumber = item.paymentDocumentNumber;
      chargeslist.Year = item.year;
      chargeslist.Month = item.month;
      chargeslist.AccountNumber = item.accountNumber;
      chargeslist.ServiceID = item.serviceID;
      chargeslist.ServiceName = item.serviceName;
      chargeslist.UnifiedAccountNumber = item.unifiedAccountNumber;
      chargeslist.FIASHouseGuid = item.FIASHouseGuid;
      chargeslist.Apartment = item.apartment;
      chargeslist.Placement = item.placement;
      chargeslist.AddressString = item.addressString;
      chargeslist.Name = item.name;
      chargeslist.INN = item.INN;
      chargeslist.KPP = item.KPP;
      chargeslist.IsPay = "";
      Insert( chargeslist );
    end;

    var cmd = RsdCommand("DELETE FROM drt_chargeslistgisgkh_tmp WHERE (t_month, t_year, t_UnifiedAccountNumber, t_ServiceId, t_FIASHouseGuid, t_PaymentDocumentID) IN " +
                         " (SELECT t_month, t_year, t_PayerId, t_ServiceId, t_HouseId, t_GISDocNumber FROM dpay_doc_cp_tmp)");
    cmd.execute;

  end;
  
  return "";
  
end;

macro CreateChargesReq
(
  planpayID,
  fncash,
  isCurrency
)

  if ( (urlAddress == "") or (senderId == "") )
    if ( not {BatchMode} )
      MsgBox( "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect" );
    else
      println( "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect" );
    end;
    return "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect";
  end;

  private var {CurDate};
  var sql;

  Message2( " ÇÎØÆ´≠Ô•‚·Ô Ø‡•§¢†‡®‚•´Ï≠Î© ß†Ø‡Æ· ≠†Á®·´•≠®© ¢ Éàë Üäï..." );

  PrintHeadReportChargesReq( );

  if ( planpayID > 0 )
    sql = " select * from ddplanpay_dbt where t_sum = '{á†Ø‡Æ·ÉàëÜäï}' and t_ref = ? ";
  else
    sql = "select * from ddplanpay_dbt where t_fncash = ? and t_iscur = ? and t_sum = '{á†Ø‡Æ·ÉàëÜäï}' and t_nextpay <= ? and t_open_close = chr(0)";
  end;

  var cmd = RsdCommand( sql );
  cmd.nullConversion = true;

  if ( planpayID > 0 )
    cmd.addParam( "ref", RSDBP_IN, planpayID );
  else
    cmd.addParam( "fncash", RSDBP_IN, fncash );
    cmd.addParam( "iscur", RSDBP_IN, isCurrency );
    cmd.addParam( "nextpay", RSDBP_IN, {curdate} );
  end;

  cmd.execute;

  var rs = RsdRecordset( cmd );

  while ( rs.moveNext( ) )
    var rscOrderHeader = CreateRscOrderHeaderJava();
    rscOrderHeader.messageID = CreateGUID( );
    rscOrderHeader.senderID = senderId;
    rscOrderHeader.senderPointID = NumFNCash( );
    
    var rscQuery = CreateRscQueryJava();

    if ( rs.value( "T_CodClient" ) > 0 )
      sql = "select * from dpersn_dbt where t_personId = ? ";
    elif ( rs.value( "t_Account" ) != "" )
      sql = "select * from dpersn_dbt where t_personId = (select T_CodClient from ddepositr_dbt where t_fncash = ? and t_account = ?) ";
    end;

    cmd = RsdCommand( sql );
    cmd.nullConversion = true;

    if ( rs.value( "T_CodClient" ) > 0 )
      cmd.addParam( "CodClient", RSDBP_IN, rs.value( "T_CodClient" ) );
    elif ( rs.value( "t_Account" ) != "" )
      cmd.addParam( "fncash", RSDBP_IN, fncash );
      cmd.addParam( "account", RSDBP_IN, rs.value( "t_Account" ) );
    end;

    cmd.execute;
    var persn = RsdRecordset( cmd );
    
    if ( persn.moveNext )
      rscQuery.surname = persn.value( "t_Name1" );
      rscQuery.firstName = persn.value( "t_Name2" );
      rscQuery.patronymic = persn.value( "t_Name3" );
    end;


    sql = "select * from dpay_doc_cp_dbt where t_applkind = ? and t_applkey = ?";
    cmd = RsdCommand( sql );
    cmd.nullConversion = true;
    cmd.addParam( "aplpkind", RSDBP_IN, -rs.value( "T_IAPPLICATIONKIND" ) );
    cmd.addParam( "applkey", RSDBP_IN, rs.value( "T_APPLICATIONKEY" ) );
    cmd.execute;

    var docCP = RsdRecordset( cmd );
    if ( docCP.moveNext )
      var day;
      var mon;
      var year;
      DateSplit ( {curdate}, day, mon, year );

      rscQuery.paymentDocumentID = docCP.value( "t_GISDocNumber" );

      if ( docCP.value( "t_month" ) == -1 )
        if ( mon == 1 )
          mon = 12;
          year = year - 1;
        else
          mon = mon - 1;
        end;
      end;
      rscQuery.month = mon;
      rscQuery.year = year;
      
      rscQuery.unifiedAccountNumber = docCP.value( "t_PayerId" );
      rscQuery.serviceID = docCP.value( "t_ServiceId" );
      rscQuery.FIASHouseGuid = docCP.value( "t_HouseId" );
      rscQuery.paymentDocumentNumber = docCP.value( "t_PaymentDocumentNumber" );
      rscQuery.accountNumber = docCP.value( "T_CPACCOUNT" );
      rscQuery.INN = "";  //docCP.value( "t_INN_Payer" );
      rscQuery.KPP = "";
      
      var res = callhsSendPaymQueryToSMEV(rscOrderHeader, rscQuery, urlAddress);
      
      if ( (res.errorCode == "") and (res.errorText == "") )
        sql = "update dpay_doc_cp_dbt set t_ChargeRecID = ? where t_applkind = ? and t_applkey = ?";
        var insQuery = RsdCommand( sql );
        insQuery.nullConversion = true;
        insQuery.addParam( "ChargeRecID", RSDBP_IN, res.messageSendID );
        insQuery.addParam( "applkind", RSDBP_IN, docCP.value( "t_applkind" ) );
        insQuery.addParam( "applkey", RSDBP_IN, docCP.value( "t_applkey" ) );
        insQuery.execute;
      end;

      PrintLineReportChargesReq( docCP, rscQuery, res );
    end;

  end;

  PrintTailReportChargesReq( );

end;

private macro FindChargeReqID ( applkind, applkey )
  var chargeReqID = "";
  var sql = "select * from dpay_doc_cp_dbt where t_applkind = ? and t_applkey = ?";
  var cmd = RsdCommand( sql );
  cmd.nullConversion = true;
  cmd.addParam( "aplpkind", RSDBP_IN, -applkind );
  cmd.addParam( "applkey", RSDBP_IN, applkey );
  cmd.execute;  cmd.execute;
  var rs = RsdRecordset( cmd );
  if ( rs.moveNext( ) )
    chargeReqID = rs.value("t_ChargeRecID");
  end;
  return chargeReqID;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ProcPPayChargeReqListGISGKH
( 
  planpayID
)

  if ( (urlAddress == "") or (senderId == 0) )
    if ( not {BatchMode} )
      MsgBox( "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect" );
    else
      println( "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect" );
    end;
    return "ç• ß†§†≠Î Ø†‡†¨•‚‡Î ·Æ•§®≠•≠®Ô · rs-connect";
  end;

  var sql = " select * from ddplanpay_dbt where t_sum = '{á†Ø‡Æ·ÉàëÜäï}' and t_ref = ? ";
  file chargeslist ("rt_chargeslistgisgkh.tmp") key 0 write;  
  var cmd = RsdCommand( sql );
  cmd.nullConversion = true;
  cmd.addParam( "ref", RSDBP_IN, planpayID );
  cmd.execute;
  var rs = RsdRecordset( cmd );
  if ( rs.moveNext( ) )
    var chargeReqID = FindChargeReqID (rs.value( "T_IAPPLICATIONKIND" ), rs.value( "T_APPLICATIONKEY" ));

    if ( chargeReqID == "" )
      CreateChargesReq( planpayID, 0, 0 );
      chargeReqID = FindChargeReqID (rs.value( "T_IAPPLICATIONKIND" ), rs.value( "T_APPLICATIONKEY" ));
    end;

    if ( chargeReqID != "" )
      var count = 0;
      var rscOrderHeader = CreateRscOrderHeaderJava();
      rscOrderHeader.senderID = senderId;
      rscOrderHeader.senderPointID = NumFNCash( );
      
      while ( count != 7 )
        rscOrderHeader.messageID = CreateGUID( );
        count = count + 1;
        var rescall = callhsResultPaymQueryFromSMEV(rscOrderHeader, chargeReqID, 0, urlAddress);

        if ( Int(rescall.statusCode) == 4 )
          break;
        elif ( (Int(rescall.statusCode) == 3) or (rescall.statusCode == "") )
          return rescall.errorText;
        elif ( (Int(rescall.statusCode) == 1) or (Int(rescall.statusCode) == 2) )
          Delay(10000);
        end;
      end;
    end;


  if ( (Int(rescall.statusCode) == 4) and (rescall.countPayments > 0) )
    var resList = rescall.charges.toArray;
    var item;

    for (item, resList)
      ClearRecord( chargeslist );
      
      chargeslist.ErrorCode = rescall.errorCode;
      chargeslist.ErrorText = rescall.errorText;
      chargeslist.RecINN = item.recINN;
      chargeslist.RecSurname = item.recSurname;
      chargeslist.RecFirstName = item.recFirstName;
      chargeslist.RecPatronymic = item.recPatronymic;
      chargeslist.RecKPP = item.recKPP;
      chargeslist.RecName = item.recName;
      chargeslist.RecepientINN = item.recepientINN;
      chargeslist.RecepientKPP = item.recepientKPP;
      chargeslist.RecepientBankBIK = item.recepientBankBIK;
      chargeslist.RecepientBankName = item.recepientBankName;
      chargeslist.RecepientCorrBankAccount = item.recepientCorrBankAccount;
      chargeslist.PaymentRecepient = item.paymentRecepient;
      chargeslist.RecepientAccount = item.recepientAccount;
      chargeslist.MailingAddress = item.mailingAddress;
      chargeslist.Amount = item.amount;
      chargeslist.DebtAmount = item.debtAmount;
      chargeslist.PaymentPurpose = item.paymentPurpose;
      chargeslist.PaymentDocumentID = item.paymentDocumentID;
      chargeslist.PaymentDocumentNumber = item.paymentDocumentNumber;
      chargeslist.Year = item.year;
      chargeslist.Month = item.month;
      chargeslist.AccountNumber = item.accountNumber;
      chargeslist.ServiceID = item.serviceID;
      chargeslist.ServiceName = item.serviceName;
      chargeslist.UnifiedAccountNumber = item.unifiedAccountNumber;
      chargeslist.FIASHouseGuid = item.FIASHouseGuid;
      chargeslist.Apartment = item.apartment;
      chargeslist.Placement = item.placement;
      chargeslist.AddressString = item.addressString;
      chargeslist.Name = item.name;
      chargeslist.INN = item.INN;
      chargeslist.KPP = item.KPP;
      chargeslist.IsPay = "";
      Insert( chargeslist );
    end;
  end;
end;
  return "";
  
onError( e )
  if ( not {BatchMode} )
    MsgBox( e.message );
  else
    println( e.message );
  end;
  return e.message;
end;