
/****************************************************************

  R-Style Software Lab.

  RS-Retail 2.1.203.00

  Выписка из обезличенного металического счета

*****************************************************************/

import extract4;

private record p_accstat( "P_ACSTAT", "rtusrmac" ) dialog;

private var IntervalErrorMsg    = "Начальная дата больше даты окончания выписки.";
private var nullBegDateErrorMsg = "Не заданна дата начала периода выписки.";
private var nullEndDateErroMsg  = "Не заданна дата конца периода выписки.";

macro Check( condition, message )
  if( condition )
    MsgBox( message );
    return false;
  end;
  return true;
end;

macro PHandler( dlg, cmd, id, key )
  var nulDate = Date( 0, 0, 0 );

  if( cmd == DLG_INIT )
    p_accstat.BeginDate = {curdate};
    p_accstat.EndDate   = {curdate};
    
    UpdateFields( dlg );
    SetFocus( p_accstat, "BeginDate" );
    
    return CM_IGNORE;
  end;

  // F7
  if( (key == 321) or (key == 13) )
    // Проверка введенных данных
    if( ( Check( p_accstat.BeginDate == nulDate,          nullBegDateErrorMsg   ) ) AND
        ( Check( p_accstat.EndDate   == nulDate,          nullEndDateErroMsg    ) ) AND
        ( Check( p_accstat.BeginDate > p_accstat.EndDate, IntervalErrorMsg      ) )      )

          // Собственно печать
          Extract( /*170003541*/ ALG_SBDEPDOC.referenc, 
                    p_accstat.BeginDate, p_accstat.EndDate, "", "", GetBankStandart(), false );
                    
          return CM_CANCEL;
    end;
    
    return CM_IGNORE;
  end;

  // Блокируем работу F8 и F9
  if( ( key == 322 ) OR ( key == 323 ) )
    return CM_IGNORE;
  end;

  return CM_DEFAULT;
end;

RunDialog( p_accstat, "PHandler" );

ALG_RESULT = 0;
