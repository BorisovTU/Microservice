
/* Отчет по плановым перечислениям, для которых подошел срок платежа */

import DeprIntr, rsd;

var SpecialAccess = GetSpecialAccess(); /*имеет ли операционист спецдоступ к счетам*/
var OperMayListSpecialAccounts = GetShowSpecialAccessAccounts() and GetBankStandart(); /* может ли операционист просматривать спец счета ,не имея спец. доступа*/

var depclnt = TClientList;
var rs;

const
  TERM_DAY = 1,   /* в днях */
  TERM_MONTH = 2, /* в месяцах */
  TERM_MON3 = 3,  /* в кварталах */
  TERM_YEAR = 4;  /* в годах */

var
  {curdate},
  Branch = NumFNCash,
  IsCur = NumFlagCur;

macro Modd(n, m)

  return n - Int(n / m) * m;
end;

macro Check

  var mm : integer;
  var dd : integer;
  var yy : integer;
  var tmp_mm : integer;
  var SizeTerm : integer;
  var KindTerm : integer;

  yy = 0;   
  dd = 0;
  mm = 0;

  SizeTerm = rs.value("SizeTerm");
  KindTerm = rs.value("KindTerm");

  if(({curdate} < rs.value("Start_DatePay")) or ({curdate} > rs.value("End_DatePay")))
    return false;
  elif(rs.value("NextPay") == Date(0,0,0))
    return true;
  end;

  DateSplit(rs.value("NextPay"), dd, mm, yy);

  if(KindTerm == TERM_DAY)
    if(Date(rs.value("NextPay")) + SizeTerm <= {curdate})
      return true;
    end;
  elif(KindTerm == TERM_MONTH)
    tmp_mm = mm + SizeTerm;
    mm = Modd(tmp_mm, 12);
    yy = yy + Int(tmp_mm / 12);
    if(yy and mm and dd)  
    if(Date(dd, mm, yy) <= {curdate})
      return true;
    end;
    end;
  elif(KindTerm == TERM_MON3)
    tmp_mm = mm + SizeTerm * 3;
    mm = Modd(tmp_mm, 12);
    yy = yy + Int(tmp_mm / 12);
    if(yy and mm and dd)  
    if(Date(dd, mm, yy) <= {curdate})
      return true;
    end;
    end;
  elif(KindTerm == TERM_YEAR)
    yy = yy + SizeTerm;       
    if(yy and mm and dd)  
    if(Date(dd, mm, yy) <= {curdate})
      return true;
    end;
  end;
  end;
  return false;
end;

macro GetClientName

  if ( depclnt.GetRecord( rs.value("CodClient") ) )
    return Trim( depclnt.CurRec.rec.Name1 + " " +
                 depclnt.CurRec.rec.Name2 + " " + 
                 depclnt.CurRec.rec.Name3        );
  else
    return "";
  end;
end;

macro OutHead;

  [         Плановые платежи, для которых наступил срок выплаты            #####################  ]
  ({curdate}:m);
  [ ];
  [---------------------------------------------------------------------------------------------];
  [|       Номер счета       |                        Ф И О   вкладчика                        |];
  [---------------------------------------------------------------------------------------------];
end;

macro OutLine;

  var fio;
  if(  (not SpecialAccess) and OperMayListSpecialAccounts and rs.value("SpecialAccess"))
   fio = "XXXXXX X.X.";
  else
   fio = GetClientName;
  end;
  [ ######################### ################################################################# ]
  (Acc_Form(String(rs.value("Account"))), fio);
end;

macro ReportOnPlanPays;

  var cmd;

  OutHead;
  cmd = RsdCommand( "select pp.t_Account as Account, pp.t_CodClient as CodClient, pp.t_SizeTerm as SizeTerm, " +
                    " pp.t_KindTerm as KindTerm, pp.t_NextPay as NextPay, pp.t_Start_DatePay as Start_DatePay, " + 
                    " pp.t_End_DatePay as End_DatePay, dep.t_SpecialAccess as SpecialAccess "+
                    " from ddplanpay_dbt pp, ddepositr_dbt dep" +
                    " where pp.t_IsCur = " + String(IsCur) + " and "+
                    " pp.t_Open_Close = chr(0) and"
      //              " pp.t_FNCash = " +String(Branch) + " and " +
                    " pp.t_reference = dep.t_referenc"
                    );

  rs = RsdRecordset( cmd );

  cmd.execute;

  while ( rs.moveNext() )
    if(Check)
      OutLine;
    end;
  end;
end;

  ReportOnPlanPays;
end;

