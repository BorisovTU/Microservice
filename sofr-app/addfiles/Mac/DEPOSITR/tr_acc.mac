
/* Транспорт одного счета */

import deprintr, TrAc_Cmn;

const
  SB_DEPOSIT  =  1;

const
  FULL_UNLOAD             = 0,
  FULL_UPLOAD             = 1,
  UNLOAD_TO_FORM_DEP_BASE = 2,
  UPLOAD_TO_FORM_DEP_BASE = 3, 

  S_UNDEF        = 0, 
  S_QUERY_USER   = 1, 
  S_REWRITE_ALL  = 2, 
  S_SKIP_ALL     = 3;

var
  ErrorsOccured = 0, 
  UpdateExistingStrategy = S_UNDEF, 
  TrnStat; 

macro TrnProc;
                        
  TrnStat=false; 
  if(CopyDep)
    TrnStat=true;  
  else
    AbortTrn;
  end;
end;

macro DoCopyTransaction();

    return ProcessTrn(1,"TrnProc",
      From(I_Dep),To(I_Dep),
      From(I_DepDoc),To(I_DepDoc),
      From(I_DepRest),To(I_DepRest),
      From(I_TrWill),To(I_TrWill),
      From(I_DepClient),To(I_DepClient),
      From(I_AuxInfo),To(I_AuxInfo),
      From(I_ConGet),To(I_ConGet),
      From(I_PcCalc),To(I_PcCalc),
      From(I_PcEstim),To(I_PcEstim),
      From(I_CashLink),To(I_CashLink),
      From(I_AccReg),To(I_AccReg),
      From(I_TextInfo),To(I_TextInfo),
      From(I_PcRDate),To(I_PcRDate),
      From(I_DepHistr),To(I_DepHistr),
      From(I_ScAcc),To(I_ScAcc),
      From(I_ScLink),To(I_ScLink),
      From(I_ScCard),To(I_ScCard),
      From(I_ScTran),To(I_ScTran),
      From(I_PcTax),To(I_PcTax), 
      From(I_RetOp),To(I_RetOp), 
      From(I_OpObject),To(I_OpObject));
  end;

private macro UnloadAcc(Acc,OpenFlag,Kind,InForwBase);

  var
    Continue = true;

  Direction=Unload;

  From(I_Dep)=Dep;
  To(I_Dep)=T_Dep;
  From(I_DepDoc)=DepDoc;
  To(I_DepDoc)=T_DepDoc;
  From(I_DepRest)=DepRest;
  To(I_DepRest)=T_DepRest;
  From(I_TrWill)=TrWill;
  To(I_TrWill)=T_TrWill;
  From(I_DepClient)=DepClient;
  To(I_DepClient)=T_DepClient;
  From(I_AuxInfo)=AuxInfo;
  To(I_AuxInfo)=T_AuxInfo;
  From(I_ConGet)=ConGet;
  To(I_ConGet)=T_ConGet;
  From(I_PcCalc)=PcCalc;
  To(I_PcCalc)=T_PcCalc;
  From(I_PcEstim)=PcEstim;
  To(I_PcEstim)=T_PcEstim;
  From(I_CashLink)=CashLink;
  To(I_CashLink)=T_CashLink;
  From(I_AccReg)=AccReg;
  To(I_AccReg)=T_AccReg;
  From(I_TextInfo)=TextInfo;
  To(I_TextInfo)=T_TextInfo;
  From(I_PcRDate)=PcRDate;
  To(I_PcRDate)=T_PcRDate;
  From(I_DepHistr)=DepHistr;
  To(I_DepHistr)=T_DepHistr;
  From(I_ScAcc)=ScAcc;
  To(I_ScAcc)=T_ScAcc;
  From(I_ScLink)=ScLink;
  To(I_ScLink)=T_ScLink;
  From(I_ScCard)=ScCard;
  To(I_ScCard)=T_ScCard;
  From(I_ScTran)=ScTran;
  To(I_ScTran)=T_ScTran;
  From(I_PcTax)=PcTax;
  To(I_PcTax)=T_PcTax;
  From(I_RetOp)=RetOp;
  To(I_RetOp)=T_RetOp;
  From(I_OpObject)=OpObject;
  To(I_OpObject)=T_OpObject;
               
  if(OpenFlag)
    if(InForwBase)
      OpenForwFiles;
    else
      OpenTransFiles;
    end;
  end;

  Account=Acc;
  if(Account!="")
    ClearRecord(To(I_Dep));
    To(I_Dep).Referenc=Account;
    if(GetEQ(To(I_Dep)))
      if ( ( UpdateExistingStrategy == S_UNDEF ) or ( UpdateExistingStrategy == S_QUERY_USER ) )
        if ( not GetTrue( false, "Счет " + To(I_Dep).Account + " уже выгружен. Продолжить ?" ) ) 
          Continue = false;
        end;
      elif ( UpdateExistingStrategy == S_SKIP_ALL )
        Continue = false;
      end;
      if ( UpdateExistingStrategy == S_UNDEF )
        if ( Continue )
          if ( GetTrue( true, "Обновить все уже выгруженные счета?" ) )
            UpdateExistingStrategy = S_REWRITE_ALL;
          else
            UpdateExistingStrategy = S_QUERY_USER;
          end;     
        else
          if ( GetTrue( true, "Пропустить все уже выгруженные счета?" ) )
            UpdateExistingStrategy = S_SKIP_ALL;
          else
            UpdateExistingStrategy = S_QUERY_USER;
          end;     
        end;
      end;
    end;
    if ( Continue )
      if(Kind == FULL_UNLOAD)
        DoCopyTransaction();
      else
        DoCopyTransaction();
      end;
      if(not TrnStat)
        PrintLn("Ошибка при выгрузке счета: "+AccountNo);
        ErrorsOccured = ErrorsOccured + 1; 
      end;
    end;
  end;
end;
   
private macro UploadAcc(Acc,OpenFlag,Kind);

  var
    Continue = true;

  Direction=Upload;

  From(I_Dep)=T_Dep;
  To(I_Dep)=Dep;
  From(I_DepDoc)=T_DepDoc;
  To(I_DepDoc)=DepDoc;
  From(I_DepRest)=T_DepRest;
  To(I_DepRest)=DepRest;
  From(I_TrWill)=T_TrWill;
  To(I_TrWill)=TrWill;
  From(I_DepClient)=T_DepClient;
  To(I_DepClient)=DepClient;
  From(I_AuxInfo)=T_AuxInfo;
  To(I_AuxInfo)=AuxInfo;
  From(I_ConGet)=T_ConGet;
  To(I_ConGet)=ConGet;
  From(I_PcCalc)=T_PcCalc;
  To(I_PcCalc)=PcCalc;
  From(I_PcEstim)=T_PcEstim;
  To(I_PcEstim)=PcEstim;
  From(I_CashLink)=T_CashLink;
  To(I_CashLink)=CashLink;
  From(I_AccReg)=T_AccReg;
  To(I_AccReg)=AccReg;
  From(I_TextInfo)=T_TextInfo;
  To(I_TextInfo)=TextInfo;
  From(I_PcRDate)=T_PcRDate;
  To(I_PcRDate)=PcRDate;
  From(I_DepHistr)=T_DepHistr;
  To(I_DepHistr)=DepHistr;
  From(I_ScAcc)=T_ScAcc;
  To(I_ScAcc)=ScAcc;
  From(I_ScLink)=T_ScLink;
  To(I_ScLink)=ScLink;
  From(I_ScCard)=T_ScCard;
  To(I_ScCard)=ScCard;
  From(I_ScTran)=T_ScTran;
  To(I_ScTran)=ScTran;
  From(I_PcTax)=T_PcTax;
  To(I_PcTax)=PcTax;
  From(I_RetOp)=T_RetOp;
  To(I_RetOp)=RetOp;
  From(I_OpObject)=T_OpObject;
  To(I_OpObject)=OpObject;

  if(OpenFlag) 
    OpenTransFiles;
  end;

  Account=Acc;
  if(Account!="")
    ClearRecord(To(I_Dep));
    To(I_Dep).Referenc=Account;
    if(GetEQ(To(I_Dep)))
      if ( ( UpdateExistingStrategy == S_UNDEF ) or ( UpdateExistingStrategy == S_QUERY_USER ) )
        if ( not GetTrue( false, "Счет " + To(I_Dep).Account + " уже загружен. Продолжить ?" ) ) 
          Continue = false;
        end;
      elif ( UpdateExistingStrategy == S_SKIP_ALL )
        Continue = false;
      end;
      if ( UpdateExistingStrategy == S_UNDEF )
        if ( Continue )
          if ( GetTrue( true, "Обновить все уже загруженные счета?" ) )
            UpdateExistingStrategy = S_REWRITE_ALL;
          else
            UpdateExistingStrategy = S_QUERY_USER;
          end;     
        else
          if ( GetTrue( true, "Пропустить все уже загруженные счета?" ) )
            UpdateExistingStrategy = S_SKIP_ALL;
          else
            UpdateExistingStrategy = S_QUERY_USER;
          end;     
        end;
      end;
    end;
    if ( Continue )
      if(Kind == FULL_UPLOAD)
        DoCopyTransaction(true);
      else
        DoCopyTransaction(false);
      end;
      if(not TrnStat)
        PrintLn("Ошибка при загрузке счета: "+AccountNo);
        ErrorsOccured = ErrorsOccured + 1; 
      end;
    end;
  end;
end;

macro UnloadAccount(Acc);
  
  PrintLn( "Выгрузка одного счета" );
  PrintLn( "=====================\n" );

  UpdateExistingStrategy = S_QUERY_USER;

  UnloadAcc(Acc,True,FULL_UNLOAD,False);

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", 1 );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;      

macro UploadAccount(Acc);
  
  PrintLn( "Загрузка одного счета" );
  PrintLn( "=====================\n" );

  UpdateExistingStrategy = S_QUERY_USER;

  UploadAcc(Acc,True,FULL_UPLOAD);

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", 1 );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;      
  
macro UnloadAll(Kind);

  var
    NAccs = 0,
    Pos,
    RecFound;

  PrintLn( "Выгрузка счетов" );
  PrintLn( "===============\n" );

  OpenTransFiles;

  KeyNum(Dep,7);
  ClearRecord(Dep);
  Dep.FNCash=FNCash;
  RecFound=GetGE(Dep);
  while(RecFound and (Dep.FNCash==FNCash))
    if(Dep.Type_Account!="Служебный")
      Pos = GetPos(Dep);
      KeyNum(Dep,8);
      UnloadAcc(Dep.Referenc,false,Kind,false);
      KeyNum(Dep,7);
      GetDirect(Dep,Pos);
      NAccs = NAccs + 1;
      Message(" Обработано счетов: ", NAccs);
    end;
    RecFound=Next(Dep);
  end;

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", NAccs );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;

macro UploadAll(Kind);

  var
    NAccs = 0,
    Pos,
    RecFound;

  PrintLn( "Загрузка счетов" );
  PrintLn( "===============\n" );

  OpenTransFiles;

  KeyNum(T_Dep,7);
  ClearRecord(T_Dep);
  T_Dep.FNCash=FNCash;
  RecFound=GetGE(T_Dep);
  while(RecFound and (T_Dep.FNCash==FNCash))
    Pos = GetPos(T_Dep);
    KeyNum(T_Dep,8);
    UploadAcc(T_Dep.Referenc,false,Kind);
    KeyNum(T_Dep,7);
    GetDirect(T_Dep,Pos);
    NAccs = NAccs + 1;
    Message(" Обработано счетов: ", NAccs);
    RecFound=Next(T_Dep);
  end;

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", NAccs );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;

/*
   НИЖЕСЛЕДУЮЩИЕ МАКРОФУНКЦИИ ИСПОЛЬЗУЮТСЯ В ПОСЛЕДКОНТРОЛЕ
   ДЛЯ ОБНОВЛЕНИЯ БАЗЫ ПРОГНОЗА
*/
macro CopyMiscFiles;

  var
    ComSpec = GetEnv( "COMSPEC" ),
    i = 0, 
    Stat = true; 

  array FileList;

  /* Add your shitty files here! */
  FileList(0) = "compens.dbt";
  FileList(1) = "sb_depst.dbt";
  FileList(2) = "trn_doc.dbt";
  FileList(3) = "trn_payf.dbt";
  FileList(4) = "eoychkp.dbt";
  FileList(5) = "sb_dpchk.dbt";
  FileList(6) = "willdoc.dbt";
  FileList(7) = "listfdep.dbt";
  FileList(8) = "depclus.dbt";

  while ( Stat and ( i < ASize( FileList ) ) )
    Stat = not Run(ComSpec, "/C if exist " + ForwDir + FileList( i ) + " del " +
                   ForwDir + FileList( i ) + " > nul" );
    if(Stat)
      i = i + 1;
    end;
  end;
  if ( not Stat )
    MsgBox( "Ошибка при удалении файла " + FileList( i ) );
    Exit;
  end;
  i = 0;
  while ( Stat and ( i < ASize( FileList ) ) )
    Stat = not Run(ComSpec, "/C copy " + DbDir + FileList( i ) +
                   " " +  ForwDir + FileList( i ) + " > nul" );
    if(Stat)
      i = i + 1;
    end;
  end;
  if ( not Stat )
    MsgBox( "Ошибка при копировании файла " + FileList( i ) );
    Exit;
  end;

end;

macro UpdateForwAccount(Acc);

  CopyForw = true;

  PrintLn( "Формирование базы прогноза (конкретный счет)" );
  PrintLn( "============================================\n" );

  UpdateExistingStrategy = S_QUERY_USER;

  OpenForwFiles;

  UnloadAcc(Acc,True,FULL_UNLOAD,True);
  CopyMiscFiles;

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", 1 );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;  

macro UpdateForwTypeAccount(Type_Account);

  var
    NAccs = 0,
    Pos,
    RecFound;

  CopyForw = true;

  PrintLn( "Формирование базы прогноза (вид вклада)" );
  PrintLn( "=======================================\n" );

  OpenForwFiles;

  KeyNum(Dep,6);
  ClearRecord(Dep);
  Dep.IsCur=0;
  Dep.FNCash=FNCash;
  Dep.Type_Account=Type_Account;
  RecFound=GetGE(Dep);
  while(RecFound and (Dep.IsCur==0) and (Dep.FNCash==FNCash) and (Dep.Type_Account==Type_Account))
    Pos = GetPos(Dep);
    KeyNum(Dep,8);
    UnloadAcc(Dep.Referenc,False,FULL_UNLOAD,True);
    KeyNum(Dep,6);
    GetDirect(Dep,Pos);
    NAccs = NAccs + 1;
    Message(" Обработано счетов: ", NAccs);
    RecFound=Next(Dep);
  end;
  ClearRecord(Dep);
  Dep.IsCur=1;
  Dep.FNCash=FNCash;
  Dep.Type_Account=Type_Account;
  RecFound=GetGE(Dep);
  while(RecFound and (Dep.IsCur==1) and (Dep.FNCash==FNCash) and (Dep.Type_Account==Type_Account))
    Pos = GetPos(Dep);
    KeyNum(Dep,8);
    UnloadAcc(Dep.Referenc,False,FULL_UNLOAD,True);
    KeyNum(Dep,6);
    GetDirect(Dep,Pos);
    NAccs = NAccs + 1;
    Message(" Обработано счетов: ", NAccs);
    RecFound=Next(Dep);
  end;
  CopyMiscFiles;

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", NAccs );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;

macro UpdateForwBranch;

  var
    NAccs = 0,
    Pos,
    RecFound;

  CopyForw = true;

  PrintLn( "Формирование базы прогноза (конкретное подразделение)" );
  PrintLn( "=====================================================\n" );

  OpenForwFiles;

  KeyNum(Dep,7);
  ClearRecord(Dep);
  Dep.FNCash=FNCash;
  RecFound=GetGE(Dep);
  while(RecFound and (Dep.FNCash==FNCash))
    if(Dep.Type_Account!="Служебный")
      Pos = GetPos(Dep);
      KeyNum(Dep,8);
      UnloadAcc(Dep.Referenc,False,FULL_UNLOAD,True);
      KeyNum(Dep,7);
      GetDirect(Dep,Pos);
      NAccs = NAccs + 1;
      Message(" Обработано счетов: ", NAccs);
    end;
    RecFound=Next(Dep);
  end;
  CopyMiscFiles;

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", NAccs );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;

macro CleanupForwBase

  CreateForwFiles;
end;

macro UpdateForwFreshAccounts(Date_Document,Type_Account);

  var
    NAccs = 0,
    Referenc=0,
    Pos,
    RecFound;

  CopyForw = true;

  PrintLn( "Формирование базы прогноза (последние изменения)" );
  PrintLn( "================================================\n" );

  OpenForwFiles;

  KeyNum(DepDoc,0);
  ClearRecord(DepDoc);
  DepDoc.IsCur=0;
  DepDoc.FNCash=FNCash;
  DepDoc.Date_Document=Date_Document;
  DepDoc.Type_Account=Type_Account;
  RecFound=GetGE(DepDoc);
  while(RecFound and (DepDoc.IsCur==0) and (DepDoc.FNCash==FNCash) and (DepDoc.Date_Document>=Date_Document))
    if((Type_Account=="") or (DepDoc.Type_Account==Type_Account))
      if(Referenc!=DepDoc.Referenc)
        Referenc=DepDoc.Referenc;
        Pos = GetPos(DepDoc);
        KeyNum(DepDoc,2);
        UnloadAcc(DepDoc.Referenc,False,FULL_UNLOAD,True);
        KeyNum(DepDoc,0);
        GetDirect(DepDoc,Pos);
        NAccs = NAccs + 1;
        Message(" Обработано счетов: ", NAccs);
      end;
    end;
    RecFound=Next(DepDoc);
  end;
  ClearRecord(DepDoc);
  DepDoc.IsCur=1;
  DepDoc.FNCash=FNCash;
  DepDoc.Date_Document=Date_Document;
  DepDoc.Type_Account=Type_Account;
  RecFound=GetGE(DepDoc);
  while(RecFound and (DepDoc.IsCur==0) and (DepDoc.FNCash==FNCash) and (DepDoc.Date_Document>=Date_Document))
    if((Type_Account=="") or (DepDoc.Type_Account==Type_Account))
      if(Referenc!=DepDoc.Referenc)
        Referenc=DepDoc.Referenc;
        Pos = GetPos(DepDoc);
        KeyNum(DepDoc,2);
        UnloadAcc(DepDoc.Referenc,False,FULL_UNLOAD,True);
        KeyNum(DepDoc,0);
        GetDirect(DepDoc,Pos);
        NAccs = NAccs + 1;
        Message(" Обработано счетов: ", NAccs);
      end;
    end;
    RecFound=Next(DepDoc);
  end;
  CopyMiscFiles;

  PrintLn( "\n--------------------------------------------" );
  Print( "Процедура завершилась " );
  if ( ErrorsOccured > 0 )
    PrintLn( "с ошибками" );
  else
    PrintLn( "успешно" );
  end;
  PrintLn;
  PrintLn( "Обработано счетов: ", NAccs );
  PrintLn( "Возникло ошибок:   ", ErrorsOccured );
end;

