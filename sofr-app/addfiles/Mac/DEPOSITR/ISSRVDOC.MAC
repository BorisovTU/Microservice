/**************************************************************************

    R-Style Software Lab Ltd
    RS-Retail 2.01

    Проверка вида документа
    и другие вспомогательные макрофункции

***************************************************************************/

import deprintr, alg_vars;

const                      /* Виды документов:       */
  DD_AR            =  8,   /* Проводка в архиве      */
  DD_ARC           =  9,   /* Корректировка в архиве */
  DD_AUDIT_STORN   = 14,   /* Сторнирование операции */
  DD_AUDIT_DELETE  = 15,   /* Удаление операции      */
  DD_AUDIT_CORRECT = 16,   /* Корректировка операции */
  DD_DELETE        =  2;

var  ddd = TDepFile( "sbdepdoc.dbt", "r", 6 );
/*file ddd("sbdepdoc.dbt") key 6;*/

/* для использования в RSD запрсах!  */
const 
    IsServ_const = " t_KindOp <> 8 AND t_KindOp <> 9 AND t_KindOp <> 14 AND t_KindOp <> 15 AND t_KindOp <> 16 AND t_Action <> 2 and t_TypeOper <> 38 AND t_TypeOper <> 39 AND t_Mode <> 2 and bitand(t_flags,131072 ) = 0 ";

macro IsServDoc( doc_rec, ProgramID )

  var isDoc = true;  /* Результат проверки */

  isDoc =
  (
    ( doc_rec.KindOp != DD_AR            )  AND  /* проводка в архиве      */
    ( doc_rec.KindOp != DD_ARC           )  AND  /* корректировка в архиве */
    ( doc_rec.KindOp != DD_AUDIT_STORN   )  AND  /* Сторнирование операции */
    ( doc_rec.KindOp != DD_AUDIT_DELETE  )  AND  /* Удаление операции      */
    ( doc_rec.KindOp != DD_AUDIT_CORRECT )  AND  /* Корректировка операции */
    ( doc_rec.Action != DD_DELETE        )
  );

  /* Непроведенный документ */
  if ( isDoc )
    isDoc = 
    (
      ( doc_rec.IsSuspended == ""  ) or 
      ( doc_rec.IsSuspended == "X" ) or
      ( doc_rec.IsSuspended == "C" )
    )
  end;

  if (isDoc)
    isDoc = 
    (
      ( doc_rec.TypeOper != 38 ) AND
      ( doc_rec.TypeOper != 39 )    
    );
  end;

  if (isDoc)
    isDoc = ( GetBitFlag( doc_rec.Flags, 17 ) == 0 );   /* BIT_FLAG_HIDDEN */
  end;

  if ( isDoc )
    isDoc = doc_rec.Mode != 2;
  end;

  return isDoc;

end;


// Для удобства использования с RSD, когда использование константы затруднено. Становов Артём 20.02.09
macro IsServDocForRSD( rs, ProgramID )

  var isDoc = true;  /* Результат проверки */

  isDoc =
  (
    ( rs.value("t_KindOp") != DD_AR            )  AND  /* проводка в архиве      */
    ( rs.value("t_KindOp") != DD_ARC           )  AND  /* корректировка в архиве */
    ( rs.value("t_KindOp") != DD_AUDIT_STORN   )  AND  /* Сторнирование операции */
    ( rs.value("t_KindOp") != DD_AUDIT_DELETE  )  AND  /* Удаление операции      */
    ( rs.value("t_KindOp") != DD_AUDIT_CORRECT )  AND  /* Корректировка операции */
    ( rs.value("t_Action") != DD_DELETE        )
  );

  /* Непроведенный документ */
  if ( isDoc )
    isDoc = 
    (
      ( rs.value("t_IsSuspended") == ""  ) or 
      ( rs.value("t_IsSuspended") == "X" ) or
      ( rs.value("t_IsSuspended") == "C" )
    )
  end;

  if (isDoc)
    isDoc = 
    (
      ( rs.value("t_TypeOper") != 38 ) AND
      ( rs.value("t_typeOper") != 39 )    
    );
  end;

  if (isDoc)
    isDoc = ( GetBitFlag( rs.value("t_Flags"), 17 ) == 0 );   /* BIT_FLAG_HIDDEN */
  end;

  if ( isDoc )
    isDoc = rs.value("t_Mode") != 2;
  end;

  return isDoc;

end;


/* Для использования в макросах закрытия счетов */
macro GetLastFCDocRest( referenc, cdate )


  var rest = $0,stat;

  ddd.addFilter("t.t_Referenc = " + string( referenc ) +
		" and t.t_Date_Document <= to_date('" + string( cdate ) + "')");
  ddd.clear;
  ddd.rec.Referenc = referenc;
  ddd.rec.Date_Document = cdate;
  ddd.rec.NumDayDoc = 32767;
  stat = ddd.getLE;
  ddd.dropFilter;
  if( stat )
     rest = ddd.rec.Rest;
  else
/*     ddd.addFilter("t.t_Referenc = " + string( referenc ) +
  		   " and t.t_Date_Document = to_date('" + string( cdate-1 ) + "')" );*/
     ddd.clear;
     ddd.rec.Referenc = referenc;
     ddd.rec.Date_Document = cdate - 1;
     stat = ddd.getLE;
/*     ddd.dropFilter;*/
     if( stat )
        rest = ddd.rec.Rest;
     end;
  end;

  return rest;
end;

/* Проверка на выполнение групповой проверки РПК */
macro InFCGroupOpRun( void )

   file Semaphore() txt;

   return Open(Semaphore, GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true ) + "fcgrupop.run");
end;