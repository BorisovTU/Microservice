/*
$Name:           NUM_STRN.mac
$Module:         RETAIL
$Description:    Сторнирование переоформления договора для "Номерных"
*/

/**************************************************************************\
*  ---------------                                                         *
*  R-Style Softlab                                                         *
*  ---------------                                                         *
*  RS-Retail                                                               *
*                                                                          *
*  Вклады                                                                  *
*                                                                          *
*  Сторнирование переоформления договора для "Номерных"                    *
*                                                                          *
\**************************************************************************/

import deprintr, alg_vars;

file depositr     ( depositr ) key 8 write;
file depstat      ( sb_depst ) key 0 write;
file CDTpcestim   ( pcestim )  key 0;

const
  UPDATE_ALL  = 1,
  UPDATE_DEP  = 2,
  UPDATE_DOC  = 4,
  UPDATE_CLNT = 8;

/* ALG_RESULT = ERR_RES; */

const
  D_IN = 1,         /* Приход */
  D_OUT = 2,        /* Расход */
  D_GET = 3,        /* Списание */
  D_PUT = 5;        /* Зачисление */

const OP_REFNUM = 508;  /* Операция переоформления номерных вкладов */

const Binsert = 2;

const n_DepKind = 4;  /* Количество переоформляемых видов вкладов */

array DepKindOld;  /* Старые виды вкладов - "Особые номерные" */
array DepKindNew;  /* Новые виды вкладов - "Особые" */

var Mode = GetCurrentMode();

var oldType_Account;  /* Старый вид вклада */
var newType_Account;  /* Новый вид вклада */
var SaveLimit;        /* Чтобы не было 679 ошибки, на время операции лимит по счету обнулим */

var FlagFindKind = FALSE;

var i = 0;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
/*
macro NewDepDoc ( Doc )

  ClearRecord( Doc );
  Doc.Referenc         = ALG_DEPOSITOR.Referenc;
  Doc.IsCur            = ALG_DEPOSITOR.IsCur;
  Doc.FNCash           = ALG_DEPOSITOR.FNCash;
  Doc.Account          = ALG_DEPOSITOR.Account;
  Doc.Oper             = {oper};
  Doc.Type_Account     = ALG_DEPOSITOR.Type_Account;
  Doc.Code_Currency    = ALG_DEPOSITOR.Code_Currency;
  Doc.CodClient        = ALG_DEPOSITOR.CodClient;
  Doc.YesSbook         = "X";
  Doc.Date_Document    = {curdate};
  Doc.DepDate_Document = {curdate};

end; */

/**************************************************************************\
|           Поиск последнего документа по накопленным процентам            |
\**************************************************************************/
macro GetLastPcEstim

  var stat;
  var find_last = FALSE;

  CDTpcestim.Referenc   = ALG_DEPOSITOR.Referenc;
  CDTpcestim.DateOperat = Date(31,12,9999);
  CDTpcestim.NumDayDoc  = 32000;
  stat = GetLE(CDTpcestim);
  while (stat)
    if (CDTpcestim.Referenc != ALG_DEPOSITOR.Referenc)
      stat = FALSE;
    else
      if (CDTpcestim.Action < 2)
        find_last = TRUE;
        stat = FALSE;
      else
        stat = Prev(CDTpcestim);
      end;
    end;
  end;

  return find_last;

end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_StornForReformDepType

  var appl_key;
  var str_tmp;

  /* Смена вида вклада и сброс SpecialAccess и GiveBook */
  ALG_DEPOSITOR.NumSession       = 0;
  ALG_DEPOSITOR.Action           = 1;
  ALG_DEPOSITOR.Type_Account     = newType_Account;
  ALG_DEPOSITOR.SpecialAccess    = 0;
  ALG_DEPOSITOR.Limit            = SaveLimit;

  if ( ALG_DEPOSITOR.NCurLine != 0 )
    ALG_DEPOSITOR.GiveBook = "X";
    ALG_CONTRACT.BookGiven = "X";
    ALG_CONTRACT.Update;
  end;
end;

/**************************************************************************\
|                    Г Л А В Н А Я   П Р О Г Р А М М А                     |
\**************************************************************************/

var
    Storn,
  Stat;

  ALG_RESULT = OK_RES;

  SaveLimit = ALG_DEPOSITOR.Limit;
  ALG_DEPOSITOR.Limit = 0;
  Stat = UpdateAlgRecords (UPDATE_DEP, true, true);
  if (not Stat)
    ALG_RESULT = ERR_RES;
  end;
  /* Поиск счета */
  if ( ALG_RESULT == OK_RES )
    ClearRecord( depositr );
    depositr.Referenc = ALG_DEPOSITOR.Referenc;
    if ( not GetEQ( depositr ) )
        MsgBox( "Не найден счет с референсом " + String( ALG_DEPOSITOR.Referenc ) );
      ALG_RESULT = ERR_RES;
    end;
  end;

  /* Заполнение массивов соответствия видов вкладов */
  /* Старые виды вкладов - "Особые номерные" */
  DepKindOld(0) = "Особый на 3м";
  DepKindOld(1) = "Особый 1г_1м";
  DepKindOld(2) = "Особый на 2г";
  DepKindOld(3) = "Особый на 2г";  /* KIN -добавлено для вал на 2 года*/
  /* Новые виды вкладов - "Особые" */
  DepKindNew(0) = "Особый номер";
  DepKindNew(1) = "Особ.н.1г_1м";
  DepKindNew(2) = "Особ.ном.2 г";
  DepKindNew(3) = "Особ.ном. 2г";  /* KIN -добавлено для вал на 2 года*/

  /* Если новые виды вклада, то возвращаться и ничего не делать */
  i = 0;
  while ( i < n_DepKind )
    if ( depositr.Type_Account == DepKindNew(i) )
    msgbox(depositr.Type_Account);
      MsgBox( "Переоформление уже сторнировано. Операция отменяется" );
      Exit(0);
    end;
    i = i + 1;
  end;

  /* 1. Определить соответствие вида нового вклада старому */
  i = 0;
  while ((NOT FlagFindKind) AND (i < n_DepKind) )
    if ( depositr.Type_Account == DepKindOld(i) )
      oldType_Account = depositr.Type_Account;
      newType_Account = DepKindNew(i);
      FlagFindKind = TRUE;
    end;
    i = i + 1;
  end;

  if ( NOT FlagFindKind )
    MsgBox( "Вклад не \"Особый\". Операция отменяется" );
    Exit(0);
  end;

  /* Из-за совпадения DepKindOld(2) и DepKindOld(3) */
  if ( ( newType_Account == DepKindNew(2) ) and (depositr.IsCur != 0) )
    newType_Account = DepKindNew(3);
  end;
  if ( ALG_PARAM.PrmC )
    Storn = true;
  else
    Storn = false;
  end;

    Stat = DeleteDocument( ALG_SBDEPDOC.iApplicationKind,
                           ALG_SBDEPDOC.ApplicationKey, Storn );

  if ( Stat )
    UpdateAlgRecords( UPDATE_DEP );

    /* Транзакция переоформления вида вклада */
    if ( ALG_RESULT == OK_RES )
      T_StornForReformDepType;
      ALG_UPDATE = UPDATE_DEP;
      ALG_RESULT = END_RES;
    end;
  end;

end;
