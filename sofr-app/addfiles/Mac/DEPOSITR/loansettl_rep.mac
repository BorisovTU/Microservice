import DeprIntr, all_vars, RSD;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PrintHeadLoansSettlReport

  var d, m, y;
  var timeReport = Trim( String( Time( ):f ) );
  var branchName = "";

  if ( not findDepartment( NumFNCash( ), branchName ) )
    branchName = String( NumFNCash( ) );
  end;

  DateSplit( {curdate}, d, m, y );

  d = String( d );
  while ( StrLen( d ) < 2 )
    d = "0" + d;
  end;

  if ( m == 1 )
    m = "января";
  elif ( m == 2 )
    m = "февраля";
  elif ( m == 3 )
    m = "марта";
  elif ( m == 4 )
    m = "апреля";
  elif ( m == 5 )
    m = "мая";
  elif ( m == 6 )
    m = "июня";
  elif ( m == 7 )
    m = "июля";
  elif ( m == 8 )
    m = "августа";
  elif ( m == 9 )
    m = "сентября";
  elif ( m == 10 )
    m = "октября";
  elif ( m == 11 )
    m = "ноября";
  elif ( m == 12 )
    m = "декабря";
  else
    m = String( m );
  end;

  y = String( y );
        
  while ( StrLen( timeReport ) < 8 )
    timeReport = "0" + timeReport;
  end;

  [ ];
  [                 Отчет о выполнении процедуры Кредитного урегулирования];
  [ ];
  [    Подразделение  __#_____________________]
  ( branchName );
  [ ];
  [    Дата выполнения процедуры  < #  > ____#_________________#___ г.   ___#___________]
  ( d, m, y, timeReport );
                                                                                                   
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PrintHeadLoansSettlReport1
      
  [ ];
  [ Выдан кредит:];
  [ ---------------------------------------------------------------------------------------------------];
  [ | № счета                             |  Комментарий                                              |];
  [ ---------------------------------------------------------------------------------------------------];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PrintHeadLoansSettlReport2
      
  [ ];
  [ Погашен кредит:];
  [ ---------------------------------------------------------------------------------------------------];
  [ | № счета                             |  Комментарий                                              |];
  [ ---------------------------------------------------------------------------------------------------];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro GetErrorMessage( errCode )

  var errMsg = "Ok";
  var cmd, rs;

  if ( errCode != 0 )
    errMsg = String( errCode );
  
    if ( errCode > 0 )
      cmd = RsdCommand( "select t_Contents from dsbbank_msg "
                        "where t_Number = ? " );

      cmd.addParam( "Number", RSDBP_IN, errCode );

      cmd.execute( );

      rs = RsdRecordset( cmd );

      if ( rs.moveNext( ) )
        errMsg = Trim( errMsg + " " + rs.value( 0 ) );
      end;
    end;
  end;
  
  return errMsg;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PrintLinesLoansSettlReport1

  var cmd, rs;
  var account = "";
  var errCode = 0;
  var errText = "";

  cmd = RsdCommand( "select SC.T_AUTHCODE, SC.T_ERRORCODE " +
                    "from dscsvdwrk_tmp SC " +
                    "where SC.T_AUTHNUMCODE = 93 " // OP_ADD_FOROVER
                    "order by 1, 2" );

  rs = RsdRecordset( cmd );

  cmd.execute;

  while ( rs.moveNext( ) )
    account = rs.value( "T_AUTHCODE" );
    errCode = rs.value( "T_ERRORCODE" );

    errText = GetErrorMessage( errCode );

    [ | #                                   | ######################################################### |]
    ( account:f, errText:w );
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PrintLinesLoansSettlReport2

  var cmd, rs;
  var account = "";
  var errCode = 0;
  var errText = "";

  cmd = RsdCommand( "select SC.T_AUTHCODE, SC.T_ERRORCODE " +
                    "from dscsvdwrk_tmp SC " +
                    "where SC.T_AUTHNUMCODE = 92 " // OP_GET_FOROVER
                    "order by 1, 2" );

  rs = RsdRecordset( cmd );

  cmd.execute;

  while ( rs.moveNext( ) )
    account = rs.value( "T_AUTHCODE" );
    errCode = rs.value( "T_ERRORCODE" );

    errText = GetErrorMessage( errCode );

    [ | #                                   | ######################################################### |]
    ( account:f, errText:w );
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PrintBottomLoansSettlReport

  [ ---------------------------------------------------------------------------------------------------];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintLoansSettlReport

  PrintHeadLoansSettlReport( );
  PrintHeadLoansSettlReport1( );
  PrintLinesLoansSettlReport1( );
  PrintBottomLoansSettlReport( );
  PrintHeadLoansSettlReport2( );
  PrintLinesLoansSettlReport2( );
  PrintBottomLoansSettlReport( );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/

  PrintLoansSettlReport( );

end;
