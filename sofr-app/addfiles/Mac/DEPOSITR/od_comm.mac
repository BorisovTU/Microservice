
/* Опердневник ф. 24 - глобализм */

import all_vars, CVSettng, CommonInter;

file DepParm  ("depparm.dbt")  key 0;
file Curr     ("currency.dbt")  key 0;
file CIDoc    ("ci_doc.dbt")    key 2;
file CIRec    ("ci_rec.dbt")    key 1;
file CapIssue ("capissue.dbt")  key 0;
file CashDoc  ("sb_casdc.dbt")  key 0;
file CashLink ("sb_casln.dbt")  key 1;
file BagDoc   ("bag_doc.dbt")  key 1;
file PayDoc   ("pay_doc.dbt")   key 5;
file CashVal  ("sb_casvl.dbt")  key 1;
file CashAcc  ("sb_casac.dbt")  key 2;
file CIOper   ("ci_oper.dbt")   key 0;
file pay_kind ("pay_kind.dbt");             /* Виды платежей       */
file pay_csop ("pay_csop.dbt");             /* Подвиды платежей    */
file doc      ("sbdepdoc.dbt") key 0;
file dr       ("depositr.dbt");
file drest    ("sb_drest.dbt");
file dtyp     ("sb_dtyp.dbt");
file Alg      ("namealg.dbt", "bank.def" )   key 0;
file DocIdx   ("sbdepdoc.idx") key 0 write;
file DocIdx1  ("sbdd1.idx") key 0 write;
var DeskSubj = TBFile ("desksubj.dbt","r",0);
file GroupMember ("groupmem.dbt") key 0;
file Group    ("rtgroup.dbt") key 1;
file prs      ("person.dbt","bank.def") key 0;
file DskSubOp ("dsuboper.dbt") key 0;
file Bag      ("bag.dbt") key 1;
file CIMisc   ("ci_misc.dbt") key 0;
file PD       ( "paydoc.dbt",  "exchange.def" ) key 0;

record TmpCashVal ("sb_casvl.dbt");

/* Файлы RS-Bank */
var   bankdprt : TBFile;
var   partcode : TBFile;
var   party    : TBFile;
var   OpenBankFiles = FALSE;
var   ClientList    = TClientList;
const BankVersion   = BankVer();

const
  TOO_COMM_CONV = 1, 
  TOO_ALL_OTHER = 0;

const ALG_CASH_VAL_TYPE = 811;    /* Типы ресурсов кассы в namealg.dbt */

const
  BS_BRANCH       = 0,    /* Филиал                 */
  BS_DEP          = 1,    /* Отделение              */
  BS_EXCH         = 2,    /* Обменный пункт         */
  BS_OPERDEP      = 3;    /* Оперчасть              */

const
  DST_IO          = 1,    /* Инкассация */
  DST_SAFE        = 2,    /* Сейф */
  DST_WORKDESK    = 3,    /* Рабочий стол кассира */
  DST_RDESK       = 4,    /* Касса пересчета */
  DST_PANTRY      = 5,    /* Кладовая отделения */
  DST_EDESK       = 6;    /* Вечерняя касса */

const
  CK_NEW          = 0, 
  CK_OLD          = 1;

const
  CP_FLAG = 2;  /* Флаг варианта группировки отчета по коммунальным платежам     */
                /* CP_FLAG = 0 - по получателям без группировки (старый вариант) */
                /* CP_FLAG = 1 - группировка по получателям                      */
                /* CP_FLAG = 2 - группировка по видам платежей                   */

const
  GROUP_CURR_NATIVE = 0, /* Рублевая группа (бригада) */
  GROUP_CURR_OTHER  = 1, /* Валютная группа (бригада) */
  GROUP_CURR_ALL    = 3; /* Смешная  группа (бригада) */

var
  {DeskOpen},
  {MakeDeskDocs},
  {CNum},
  Safe,
  SafeType,
  OperBrigade      = GetOperBrigade(),
  Branch           = NumFNCash(),
  BranchStatus     = GetBranchStatus(),
  IsCur            = NumFlagCur(),
  Mode             = GetCurrentMode(),
  IsConv           = 0,
  BrigadeCur       = GetOperBrigadeCur();

const
  TxtDir = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true ),
  IdxName =  TxtDir + "doc" + String({CNum}) + ".idx",
  Idx1Name = TxtDir + "d1_" + String({CNum}) + ".idx";

const
  ExternPantry       = false,  /* Если true, отчет для внешней кладовой */
  ShowBagInfo        = true,   /* Если true, печатать название клиента КО */
  ShowRblInCurrDiary = false;  /* Если true, отражать рубли в валютном ОД */

const
  RDesk            = "К. пересчета",
  EDesk            = "Вечер. касса";

const
  OPCONT_FLD_LEN   = 31;

const
  CI_OGSZ          = 1,
  CI_LOTTERY       = 2,
  CI_CERT          = 3,
  CI_COIN          = 4,
  CI_INGOT         = 5,
  CI_ORVVZ         = 6,
  CI_MISC          = 10,

  O_OGSZ_SELL      = 1,
  O_OGSZ_BUY       = 2,
  O_OGSZ_PAYWARR   = 3,
  O_OGSZ_KEEP      = 4,
  O_OGSZ_RETURN    = 5,
  O_OGSZ_SELL_ACC  = 6,

  O_LOTTERY_SELL   = 1,
  O_LOTTERY_PAYWIN = 2,
  O_LOTTERY_BUY    = 3,
  O_LOTTERY_KEEP   = 4,
  O_LOTTERY_RETURN = 5,
  O_LOTTERY_SELL_ACC = 6,

  O_CERT_SELL      = 1,
  O_CERT_PAY       = 2,
  O_CERT_PAYALN    = 3,
  O_CERT_KEEP      = 4,
  O_CERT_RETURN    = 5,
  O_CERT_SELL_ACC  = 6,

  O_MISC_SELL      = 1,         /* Для монет и прочих */
  O_MISC_BUY       = 2,
  O_MISC_KEEP      = 3,
  O_MISC_RETURN    = 4,
  O_MISC_SELL_ACC  = 5,

  O_INGOT_SELL     = 1,
  O_INGOT_BUY      = 2,
  O_INGOT_KEEP     = 3,
  O_INGOT_RETURN   = 4,
  O_INGOT_SELL_ACC = 5,

  TYPERES_CURRENCY    =   1, /* Деньги (из справочника валют)           */
  TYPERES_VALFORM     =   2, /* Ценные бланки                           */
  TYPERES_VALUABLES   =   3, /* Др. ценности (из справочника ценностей) */ 
  TYPERES_PAYDOC      =   4, /* Платежные документы ОП                  */
  TYPERES_CARD        =  10, /* Пластиковые карточки                    */
  TYPERES_MINCAPISSUE = 500, /* Минимально возможный код ЦБ             */

  TYPEDOC_CARRYOFF = 1,  /* Отложен (не подтвержден) */
  TYPEDOC_CARRYON  = 2,  /* Проведен (подтвержден) */

  FLAGDEBCRED_IN   = 1,  /* Кредит */
  FLAGDEBCRED_OUT  = 2,  /* Дебет */

  CASHOP_REINFORCE = 1,  /* Подкрепление кассира */
  CASHOP_RETURN    = 2,  /* Возврат средств в кладовую */
  CASHOP_COLLECT   = 3,  /* Инкассация */
  CASHOP_ADVANCE   = 4,  /* Аванс */
  CASHOP_DEBIT     = 5,  /* Расход */
  CASHOP_CREDIT    = 6,  /* Приход */
  CASHOP_REMOVE    = 7,  /* Внутреннее подкрепление (Расход) */
  CASHOP_REMOVE_1  = 8,  /* Внутреннее подкрепление (Приход) */
  CASHOP_CHVALUE   = 9,  /* Перевод на другой ресурс той же группы (Расход) */
  CASHOP_CHVALUE_1 = 10, /* Перевод на другой ресурс той же группы (Приход) */
  CASHOP_REMOVE_SAFE   = 11,  /* Внутреннее подкрепление сейфа (Расход) */
  CASHOP_REMOVE_SAFE_1 = 12,  /* Внутреннее подкрепление сейфа (Приход) */
  CASHOP_DEBET_SAFE = 13,  /* Расход из сейфа */
  CASHOP_CREDIT_SAFE = 14, /* Приход в сейф */
  CASHOP_REVAL_POS = 18, /* Переоценка (+) */
  CASHOP_REVAL_NEG = 19, /* Переоценка (-) */
  CASHOP_PANT_RI   = 20, /* Подкрепление филиала */
  CASHOP_PANT_RET  = 21, /* Возврат из филиала */
  CASHOP_PANT_RIO  = 22, /* Подкрепление оперчасти */
  CASHOP_PANT_RETO = 23, /* Возврат из оперчасти */
  CASHOP_PANT_COL  = 24, /* Инкассация */
  CASHOP_PANT_ADV  = 25, /* Аванс */
  CASHOP_PANT_RDEB = 30, /* Расход по кассе пересчета */
  CASHOP_PANT_RCRD = 31, /* Приход по кассе пересчета */
  CASHOP_PANT_RDRT = 32, /* Сдача ресурса в кладовую из Кассы пересчета */
  CASHOP_PANT_ECRD = 41, /* Приход по вечерней кассе */
  CASHOP_PANT_EDRT = 42, /* Сдача ресурса из вечерней кассы */

  CO_COMMISSION    = 21,
  CO_CONVERSION    = 31,
  CO_PAYED         = 41,
  CVT_NONCASH      = 2,

  SB_INCASH        = 100,
  SB_EXTCASH       = 150,

  CL_DEP = 0,                /* Отделение ( филиал, о/ч ) СБ */
  CL_BANK = 1,               /* Банк */
  CL_LEGAL = 2;              /* Юр. лицо */

const
  CV_Currency = 1,
  CV_ValForm = 2,
  CV_MinCI = 500;

const
  RESMESUNIT_POINT = 1,  /* Поштучно   */
  RESMESUNIT_MONEY = 2,  /* Стоимость  */
  RESMESUNIT_MIXED = 3;  /* Cмешанный учет  */

const
  OP_SELL_BUY_CURR = 101;

const
  CV_SELL_BUY_CURR = 3;

const
  TYPE_RES_PAY    = 0, /* Платежеспособные ресурсы                     */
  TYPE_RES_NOPAY  = 1, /* Неплатежеспособные ресурсы                   */
  TYPE_RES_DOUBT  = 2, /* Сомнительные ресурсы                         */
  TYPE_RES_SAVE   = 3, /* На хранении                                  */
  TYPE_RES_EXP    = 4, /* На экспертизу                                */
  TYPE_RES_INCASS = 5, /* На инкассо                                   */
  TYPE_RES_PDNAT  = 20,/* ПД, оплаченные рублями(национальной валютой) */
  TYPE_RES_PDCUR  = 21,/* ПД, оплаченные валютой                       */
  TYPE_RES_PD     = 22;/* оплаченные ПД                                */

const
  D_INSERT  = 0,     /* Вставка      */
  D_UPDATE  = 1,     /* Обновить     */
  D_DELETE  = 2,     /* Удалить      */
  D_STORN   = 11;    /* Сторнировать */

var
  TotCashDebet     = $0, TotCashDebetU   = $0,
  TotCashCredit    = $0, TotCashCreditU  = $0,
  TotMemDebet      = $0,
  TotMemCredit     = $0,
  TotCashDebetR    = $0, TotCashDebetRU  = $0,
  TotCashCreditR   = $0, TotCashCreditRU = $0,
  TotMemDebetR     = $0,
  TotMemCreditR    = $0,
  TotDebetV        = $0, TotDebetVU      = $0, TotDebetV_2  = $0,
  TotCreditV       = $0, TotCreditVU     = $0, TotCreditV_2 = $0,
  TotCashDebetCn   = $0,
  TotCashCreditCn  = $0,
  TotMemDebetCn    = $0,
  TotMemCreditCn   = $0,
  CentsBought      = $0,
  TotConvYield     = $0;
var
  TotCvDebet       = $0,
  TotCvCredit      = $0,
  TotCvMemDebet    = $0,
  TotCvMemCredit   = $0,
  TotCvDebetR      = $0,
  TotCvCreditR     = $0,
  TotCvMemDebetR   = $0,
  TotCvMemCreditR  = $0,
  TotCvDebetV      = $0,                       TotCvDebetV_2  = $0,
  TotCvCreditV     = $0,                       TotCvCreditV_2 = $0;

var /* Для ОП  RA 18-07-00 */
  TotExDebet       = $0, TotExDebetU   = $0,
  TotExCredit      = $0, TotExCreditU  = $0,
  TotExMemDebet    = $0, 
  TotExMemCredit   = $0, 
  TotExDebetR      = $0, TotExDebetRU  = $0,
  TotExCreditR     = $0, TotExCreditRU = $0,
  TotExMemDebetR   = $0, 
  TotExMemCreditR  = $0, 
  TotExDebetV      = $0, TotExDebetVU  = $0,   TotExDebetV_2  = $0,
  TotExCreditV     = $0, TotExCreditVU = $0,   TotExCreditV_2 = $0;

var
  CurrNameDisplayed      = false,
  HeaderDisplayed        = false,
  OpHeaderDisplayed      = false,
  LinesDisplayed         = false,
  SafeIDDisplayed        = false,
  SomethingDisplayed     = false,
  ShowSecondRefVal       = true,
  TypeOperationDisplayed = false; /* RA 18-07-00 */

array
  OpContArr;


const MaxLenFIO = 15;
const ServAcntName = "Служебный";

var ValFormIn;            /* Приход ценных бланков */
var ValFormOut;           /* Расход ценных бланков */
var FormNo;               /* Номер справки */

var SumOperIn;       /* Сумма по операционистам Наличные.Приход */
var SumOperOut;      /*                         Наличные.Расход */
var SumBeznIn;       /*                         Безналичные.Зачисление */
var SumBeznOut;      /*                         Безналичные.Списание */
var SumOstVkl;       /*                         Остаток.По вкладу */
var SumOstProc;      /*                         Остаток.Проценты */
var SumValFormIn;    /*                         Приход цен. бланков*/
var SumValFormOut;   /*                         Расход цен. бланков*/
var SumValFormIn_2  =0;/* Итог по ф.24 + ф.24-в Приход цен. бланков*/
var SumValFormOut_2 =0;/* Итог по ф.24 + ф.24-в Расход цен. бланков*/

var SumOperInE;
var SumOperOutE;
var SumBeznInE;
var SumBeznOutE;

var SumOperInAT;     /* Сумма по виду вклада    Наличные.Приход */
var SumOperOutAT;    /*                         Наличные.Расход */
var SumBeznInAT;     /*                         Безналичные.Зачисление */
var SumBeznOutAT;    /*                         Безналичные.Списание */
var SumOstVklAT;     /*                         Остаток.По вкладу */
var SumOstProcAT;    /*                         Остаток.Проценты */
var SumValFormInAT;  /*                         Приход цен. бланков*/
var SumValFormOutAT; /*                         Расход цен. бланков*/

var SumOperInATE;
var SumOperOutATE;
var SumBeznInATE;
var SumBeznOutATE;

var SumOperInO;      /* Сумма по операционисту  Наличные.Приход */
var SumOperOutO;     /*                         Наличные.Расход */
var SumBeznInO;      /*                         Безналичные.Зачисление */
var SumBeznOutO;     /*                         Безналичные.Списание */
var SumOperInOE;     /* Сумма по операционисту  Наличные.Приход */
var SumOperOutOE;    /*                         Наличные.Расход */
var SumBeznInOE;     /*                         Безналичные.Зачисление */
var SumBeznOutOE;    /*                         Безналичные.Списание */
var SumOstVklO;      /*                         Остаток.По вкладу */
var SumOstProcO;     /*                         Остаток.Проценты */
var SumValFormInO;   /*                         Приход цен. бланков*/
var SumValFormOutO;  /*                         Расход цен. бланков*/

var Isx_Ost;              /* Исходящий остаток */
var Vx_Ost;               /* Входящий остаток */
var Sum_KO_Pr;            /* Сумма кассовых операций приходная */
var Sum_KO_Ras;           /*                         расходная */

var CBRate;
var BuyRate;
var SellRate;
var ScaleRate;

array opName;

array mKind, mCreditM, mCreditN, mCreditV, mDebetV;
var   mSize = 0;
var   sFormGround = "";
var   DepGround;

macro IsShown

  if ( not FindCVSettings( TmpCashVal ) )
    return true;
  end;
  return CVSettings.Form24 != StrFor( 0 );
end;

macro IsKept

  if ( not FindCVSettings( TmpCashVal ) )
    return true;
  end;
  return CVSettings.KeepRests != StrFor( 0 );
end;

macro ShouldAddRest( IsPrev )

  var
    Shown,
    Kept;

  if ( not FindCVSettings( TmpCashVal ) )
    return true;
  end;

  Shown = CVSettings.Form24 != StrFor( 0 );
  Kept  = CVSettings.KeepRests != StrFor( 0 ); 

  if ( not Shown )
    return false;
  end;

  if ( Kept )
    return true;
  else
    if ( IsPrev )
      return false;
    else
      return true;
    end; 
  end;
end;              

macro FindCIMisc( Type, IssueID )

  CIMisc.Type = Type;
  CIMisc.IssueID = IssueID;
  return GetEQ( CIMisc );
end;

macro CoinHasWeight( Issue )

 FindCIMisc( CI_COIN, Issue );
 return CIMisc.KindOfCoin == CK_OLD; 
end;

macro CoinMoney( Issue, NumItems )

  FindCIMisc( CI_COIN, Issue );
  return Money( NumItems * CIMisc.Par );
end;

macro GetBranchName

  var
    RetVal;

  if (not findDepartment(Branch, RetVal))
    RetVal=String(Branch);
  end;
  return RetVal;
end;

macro Cur2Rub(Sum)

  return SumConv( Sum, CBRate/ScaleRate );
end;

/***************************************************************************
***************************************************************************/
macro CIOperIsCreditM(Type, Number)

  if(Type == CI_OGSZ)
    if((Number == O_OGSZ_SELL) or (Number == O_OGSZ_SELL_ACC)
      or (Number == O_OGSZ_RETURN))
      return true;
    else
      return false;
    end;
  elif((Type == CI_LOTTERY) or (Type == CI_ORVVZ))
    if((Number == O_LOTTERY_SELL) or (Number == O_LOTTERY_SELL_ACC)
      or (Number == O_LOTTERY_RETURN))
      return true;
    else
      return false;
    end;
  elif(Type == CI_CERT)
    if((Number == O_CERT_SELL) or (Number == O_CERT_SELL_ACC)
      or (Number == O_CERT_RETURN))
      return true;
    else
      return false;
    end;
  elif((Type == CI_MISC) or (Type == CI_COIN))
    if((Number == O_MISC_SELL) or (Number == O_MISC_SELL_ACC)
      or (Number == O_MISC_RETURN))
      return true;
    else
      return false;
    end;
  elif(Type == CI_INGOT)
    if((Number == O_INGOT_SELL) or (Number == O_INGOT_SELL_ACC)
      or (Number == O_INGOT_RETURN))
      return true;
    else
      return false;
    end;
  end;
  return false;
end;

macro CIIsCashOper(Type, Number)

  if(Type == CI_OGSZ)
    if(Number == O_OGSZ_SELL_ACC)
      return false;
    else
      return true;
    end;
  elif((Type == CI_LOTTERY) or ( Type == CI_ORVVZ ))
    if(Number == O_LOTTERY_SELL_ACC)
      return false;
    else
      return true;
    end;
  elif(Type == CI_CERT)
    if(Number == O_CERT_SELL_ACC)
      return false;
    else
      return true;
    end;
  elif((Type == CI_MISC) or (Type == CI_COIN))
    if(Number == O_MISC_SELL_ACC)
      return false;
    else
      return true;
    end;
  elif(Type == CI_INGOT)
    if(Number == O_INGOT_SELL_ACC)
      return false;
    else
      return true;
    end;
  end;
  return false;
end;

macro CheckConfirm( IsConfirmed )

  return ( not {MakeDeskDocs} ) or IsConfirmed;
end;

macro GetCashVal(RefValue)

  var
    Pos,
    SaveKey = KeyNum(CashVal, 0);

  Pos = GetPos(CashVal);
  CashVal.RefValue = RefValue;
  if(GetEQ(CashVal))
    Copy(TmpCashVal, CashVal);
  else
    ClearRecord(TmpCashVal);
  end;
  GetDirect(CashVal, Pos);
  KeyNum(CashVal, SaveKey);
end;

macro ThereAreNoBetterPrimary( AppKind, AppKey );

  var
    Result = true,
    SK,
    Pos;

  Pos = GetPos( CashLink );
  SK = KeyNum( CashLink, 1 );

  CashLink.ApplicationKind2 = AppKind;
  CashLink.ApplicationKey2 = AppKey;
  CashLink.RefValue2 = 0;
  if ( GetEQ( CashLink ) )
    Result = false;
  end;  

  KeyNum( CashLink, SK );
  GetDirect( CashLink, Pos );
  return Result;
end;

macro CalcValuesTurnsEx(AppKind, AppKey, Credit, Debet, CalcChVals, Proc )

  var
    HeadAppKind,
    HeadAppKey,
    RecFound,
    Cred = $0,
    Deb  = $0, 
    C, D;

  if ( ValType( CalcChVals ) == V_UNDEF )
    CalcChVals = -1;
  end;

  KeyNum(CashDoc,7);

  KeyNum( CashLink, 1 );
  ClearRecord( CashLink );
  CashLink.ApplicationKind2=AppKind;
  CashLink.ApplicationKey2=AppKey;
  if ( GetEQ( CashLink ) )
    HeadAppKind = CashLink.ApplicationKind1;
    HeadAppKey = CashLink.ApplicationKey1;
    KeyNum( CashLink, 0 );
    CashLink.NumLinkDoc = 0;
    RecFound = GetGE( CashLink ); 
    while ( RecFound
      and ( CashLink.ApplicationKind1 == HeadAppKind )
      and ( CashLink.ApplicationKey1 == HeadAppKey ) )
      if ( CashLink.RefValue2 > 0 )
        CashDoc.ApplicationKind = CashLink.ApplicationKind2;
        CashDoc.ApplicationKey = CashLink.ApplicationKey2;
        CashDoc.RefValue = CashLink.RefValue2;
        if(GetEQ(CashDoc))
          if((CashDoc.TypeDoc == TYPEDOC_CARRYON)
             and (CashDoc.ApplicationKind == AppKind)
             and ( ( ( CashDoc.ApplicationKind == AppKind ) and ( CashDoc.ApplicationKey == AppKey ) ) or ThereAreNoBetterPrimary( CashDoc.ApplicationKind, CashDoc.ApplicationKey ) )
             and (CashDoc.RefValue != CashVal.RefValue))
            GetCashVal(CashDoc.RefValue);
            if ( IsShown )
              if ( ( ( CalcChVals == 0 )     /* Только НЕ чвалью */
                      and ( CashDoc.NumOper != CASHOP_CHVALUE )
                      and ( CashDoc.NumOper != CASHOP_CHVALUE_1 ) )
                or ( ( CalcChVals == 1 )     /* Только чвалью */
                      and ( ( CashDoc.NumOper == CASHOP_CHVALUE )
                         or ( CashDoc.NumOper == CASHOP_CHVALUE_1 ) ) ) 
                or ( CalcChVals == -1 ) )  /* Все */
                C = D = $0;
                if(CashDoc.FlagDebCredOper == FLAGDEBCRED_IN)
                  if(TmpCashVal.TypeValue == CV_Currency)
                    C = CashDoc.ValueMoney;
                  else
/*                    if(TmpCashVal.UnitMeas == RESMESUNIT_MIXED)
                      C = $1 * CashDoc.ValueCol;
                    el*/
                    if(TmpCashVal.UnitMeas == RESMESUNIT_POINT)
                      C = Money( CashDoc.ValueCol );
                    else
                      C = CashDoc.ValueMoney;
                    end;
                  end;
                else
                  if(TmpCashVal.TypeValue == CV_Currency)
                    D = CashDoc.ValueMoney;
                  else
/*                    if(TmpCashVal.UnitMeas == RESMESUNIT_MIXED)
                      D = $1 * CashDoc.ValueCol;
                    el */
                    if(TmpCashVal.UnitMeas == RESMESUNIT_POINT)
                      D = Money( CashDoc.ValueCol );
                    else
                      D = CashDoc.ValueMoney;
                    end;
                  end;
                end;
                if ( ValType( Proc ) != V_UNDEF )
                  ExecMacro( Proc, C, D ); 
                end;
                Cred = Cred + C;  /* RA 13-03-01 перенес после ExecMacro */
                Deb = Deb + D;
              end;
            end;
          end;
        end;
      end; 
      RecFound = Next(CashLink);
    end;
  end;
  SetParm(2, Cred);
  SetParm(3, Deb);
end;

macro CalcValuesTurns( AppKind, AppKey, Credit, Debet, CalcChVals )

  CalcValuesTurnsEx( AppKind, AppKey, Credit, Debet, CalcChVals, null );
  SetParm( 2, Credit );
  SetParm( 3, Debet );
end;

macro GetCIDocTurns( DebetM, CreditM, DebetV, CreditV )

  record MiscInfo("ci_doc.2");

  if(CIOperIsCreditM(CIDoc.Type, CIDoc.Operation))
    CreditM = CIDoc.Sum;
  else
    DebetM = CIDoc.Sum;
  end;
  if( ( CIDoc.Type == CI_COIN ) and ( not CoinHasWeight( CIDoc.Issue ) ) )
    SetRecordAddr(MiscInfo, CIDoc, 0, FldOffset(CIDoc, "Info"), true);
    if((CIDoc.Operation == O_MISC_SELL)
      or (CIDoc.Operation == O_MISC_SELL_ACC))
      DebetM = MiscInfo.Par * MiscInfo.NumItems;
    elif(CIDoc.Operation == O_MISC_BUY)
      CreditM = MiscInfo.Par * MiscInfo.NumItems;
    end;
  else
    CalcValuesTurns(CIDoc.ApplicationKind, CIDoc.ApplicationKey,
      CreditV, DebetV);
  end;
  SetParm( 0, DebetM );
  SetParm( 1, CreditM );
  SetParm( 2, DebetV );
  SetParm( 3, CreditV );
end;

macro CheckCIDoc

  var _retValue = true;

  if ( ( CIDoc.Action == D_STORN ) or ( CIDoc.Action == D_DELETE ) )
    _retValue = false;
  end;

  /* Непроведенный документ */
  if ( ( CIDoc.IsSuspended != "" ) and ( CIDoc.IsSuspended != "X" ) )
    _retValue = false;
  end;

  return _retValue;

end;

macro GetCIRecTurns( DebetM, CreditM, DebetV, CreditV )

  var
    RecFound,
    DM = $0, CM = $0, DV = $0, CV = $0;

  CIDoc.RecApplicKind = CIRec.ApplicationKind;
  CIDoc.RecApplicKey = CIRec.ApplicationKey;
  RecFound = GetGE( CIDoc );
  while ( RecFound
    and ( CIDoc.RecApplicKind == CIRec.ApplicationKind )
    and ( CIDoc.RecApplicKey == CIRec.ApplicationKey ) )
    if ( CheckConfirm( not CIDoc.IsConfirmed ) and CheckCIDoc )
      GetCIDocTurns( DM, CM, DV, CV );
      DebetM = DebetM + DM;
      CreditM = CreditM + CM;
      DebetV = DebetV + DV;
      CreditV = CreditV + CV;
    end;    
    RecFound = Next( CIDoc );
  end;
  SetParm( 0, DebetM );
  SetParm( 1, CreditM );
  SetParm( 2, DebetV );
  SetParm( 3, CreditV );
end;

macro IsDeskOpen

  Group.Branch = Branch;
  Group.Type   = 1;     /* GT_BRIGADE */
  Group.Date   = {curdate};
  Group.IsActive = "X";
  Group.ID     = OperBrigade;
  return GetEQ( Group ); 
end;

macro FindGroup( Brigade )

  var
    Stat,
    OldKey = KeyNum( Group, 0 );

  Group.Branch = Branch;
  Group.Type   = 1;     /* GT_BRIGADE */
  Group.Date   = {curdate};
  Group.ID     = Brigade;
  Stat = GetEQ( Group ); 
  KeyNum( Group, OldKey );
  return Stat;
end;