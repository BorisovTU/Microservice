/*
   Макрос-пример пользовательской расходной операции для РПК
*/

import deprintr, OperCode;

record ALG_DEPOSITOR("depositr.dbt");
record ALG_SBDEPDOC( "sbdepdoc.dbt" );
record ALG_PARAM( "sb_algop.dbt" );

const
  UPDATE_ALL  = 1,
  UPDATE_DEP  = 2,
  UPDATE_DOC  = 4;

const
  OK_RES   =  0,  /* продолжать проводку */
  SKIP_RES =  1,  /* пропустить выполнение предопределенного модуля */
  END_RES  =  2,  /* завершить проводку */
  ERR_RES  = -1;  /* аваpийно завершить проводку */

const
  D_IN = 1,         /* Приход */
  D_OUT = 2,        /* Расход */
  D_GET = 3,        /* Списание */
  D_PUT = 5;        /* Зачисление */

const
  SIGNNORMAL = -1;  /* обычный документ введённый с проверкой */

var
  Branch = NumFNCash(),
  {curdate},
  {oper},
  Stat = True;


macro InsertDoc( void )

end;

macro TrnProc( void )

  record tmpDoc("sbdepdoc.dbt");
  var
    С_Панелью, UseMaxDate, NoPrint;

  ClearRecord(tmpDoc);
  tmpDoc.Referenc = ALG_SBDEPDOC.Referenc;
  tmpDoc.IsCur = ALG_SBDEPDOC.IsCur;
  tmpDoc.FNCash = ALG_SBDEPDOC.FNCash;
  tmpDoc.Account = ALG_DEPOSITOR.Account;
  tmpDoc.Oper = {oper};
  tmpDoc.Type_Account = ALG_SBDEPDOC.Type_Account;
  tmpDoc.Code_Currency = ALG_SBDEPDOC.Code_Currency;
  tmpDoc.CodClient = ALG_SBDEPDOC.CodClient;
  tmpDoc.YesSbook = "X";
  tmpDoc.Date_Document = {curdate};
  tmpDoc.DepDate_Document = {curdate};
  tmpDoc.Author = ALG_SBDEPDOC.Author;
  tmpDoc.ApplType = 0;
  tmpDoc.OutSum = ALG_SBDEPDOC.OutSum;

  С_Панелью = 0;
  UseMaxDate = 1;
  NoPrint = 1;

  Stat = not  Выполнить_Операцию(ALG_DEPOSITOR.Account, ALG_DEPOSITOR.Type_Account,
              ALG_DEPOSITOR.Code_Currency, Расход,
              tmpDoc,С_Панелью, UseMaxDate, NoPrint, ALG_PARAM.NumOpert);

  if(not Stat)
    AbortTrn;
  end;
end;

  /* Точка входа */

  if ( ALG_PARAM.PrmC )
     InsertDoc();
     if(Stat)
       UpdateAlgRecords( UPDATE_DOC ); 
       ALG_UPDATE = UPDATE_DOC;
     end;
  else
     ProcessTrn(1, "TrnProc");
  end;
  if(Stat)
    ALG_RESULT = OK_RES;
  else
    ALG_RESULT = ERR_RES;
  end;

  Exit(1); /* Убрать вывод на экран */

end;  
