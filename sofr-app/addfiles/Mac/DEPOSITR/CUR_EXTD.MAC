/*

  R-Style SoftLab.

  RS-Retail.

  Текущие счета вкладчиков.

  Выписки по Текущим и Специальным счетам при закрытии операционного дня.

*/

import Cur_Extc, sign_rep, RSD, SqlConv;

file d_dep ( "depositr.dbt" ) key 8;

const d_FlagCur = NumFlagCur(),
      d_FNCash  = NumFNCash();

var d_first = TRUE;

var d_stdt, d_stdc;

var cdt = RsdCommand( "select t_Kind as Kind from dsb_dtyp_dbt" +
                      " where t_FlagCur = " + String( d_FlagCur ) + " AND " +
                      "  t_UserTypeAccount like '%Щ%'" );

var rsdt = RsdRecordset( cdt );

var cdd;

var rsdd;

cdt.execute;

while ( rsdt.moveNext )

  cdd = RsdCommand( "select distinct t_Referenc as Ref, t_Account as Acc from dsbdepdoc_dbt" +
                    " where t_IsCur = " + String( d_FlagCur ) + " AND " +
                    "  t_FNCash = " + String( d_FNCash ) + " AND " +
                    "  t_Date_Document = " + sqlDateToStr( {CurDate} ) + " AND " +
                    "  t_Type_Account = \'" + rsdt.value( "Kind" ) + "\'" );

  cdd.execute;

  rsdd = RsdRecordset( cdd );

  while ( rsdd.moveNext )

    ClearRecord( d_dep );
    d_dep.Referenc = rsdd.value( "Ref" );

    if ( getEQ( d_dep ) )
      if ( d_first )
        d_first = FALSE;
      else
        printLn( strFor( 12 ) );  /* Разделение страниц для нового счета */
      end;
      Current_Extract( d_dep, FALSE, TRUE );
    end;

  end;

end;

ElectronDigitalSignReport( );
