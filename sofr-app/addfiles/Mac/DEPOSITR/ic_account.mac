/*
 $Name: ic_account.mac
 $Module: UFO
 $Description: сервисы УФО
*/
/*
*/

import ic_comdata, Календарь, cpgiszkh, PTInter, spCardInter;


private macro GetArrestedSum(reference: integer, branch: integer, dateRate: date, timeRate: time, arrestDate: date)
  var sum:money = $0;

  var cmd = rsdcommand("select rsu_rtldeposit.GetArrestedSum(?, ?, ?, ?, ?) t_Sum from dual");
  cmd.AddParam("reference", RSDBP_IN, reference);
  cmd.AddParam("branch", RSDBP_IN, branch);
  cmd.AddParam("dateRate", RSDBP_IN, dateRate);
  cmd.AddParam("timeRate", RSDBP_IN, timeRate);
  cmd.AddParam("arrestDate", RSDBP_IN, arrestDate);
  cmd.nullConversion = true;
  cmd.execute();

  var rs = RsdRecordset(cmd);
  if (rs.moveNext())
    sum = rs.value("t_Sum");
  end;

  return sum;
end; 


/********************************************************************************\
|        ПЕРЕВОД МЕЖДУ ТЕКУЩИМИ СЧЕТАМИ ОДНОГО КЛИЕНТА (В ОДНОЙ ВАЛЮТЕ)          |
\********************************************************************************/
macro ITransAA ( ExternalData /* : TOperCommonData */ )
  record r_sbdepdoc ("sbdepdoc.1");
  record r_operprm ("oper_prm.1");
  record pmnt_prop("rtpaymentprop.dbt");
  var DestAccount, SourceAccount;
  var OperSubType = 0;

  checkRealSum(ExternalData.Sum.Sum);
  if ( (ValType(ExternalData.Client) != V_INTEGER) or (ExternalData.Client < 0) )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ValType(ExternalData.ExternalPayCode) != V_STRING) or (ExternalData.ExternalPayCode == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( (ValType(ExternalData.OperSubType) != V_INTEGER) or (ExternalData.OperSubType < 0) );
    OperSubType = 0;
  else
    OperSubType = ExternalData.OperSubType;
  end;

  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  var fndstat = findReissueAccount ( SourceAccount, ExternalData.Source, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16552; // некорректно заполнены данные источника
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  if ( (ValType(ExternalData.Sum.Currency) == V_STRING) and (ExternalData.Sum.Currency != "") )
    checkCurrency( ExternalData.Sum.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16555 );
  end;
  зададим_параметры_банка (SourceAccount);

  var findCurr = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  findParam.Currency = Int(findCurr.value("T_EXTERNALCODE"));
  findParam.IsFindMCD = true;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = false;
  fndstat = findReissueAccount ( DestAccount, ExternalData.Destination, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16553; // некорректно заполнены данные получателя
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;

  /*if ( DestAccount.value("T_CODCLIENT") != SourceAccount.value("T_CODCLIENT") )
    RunError( ErrMessage( 16527 ), 16527 );
  el*/
  /*if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
    RunError( ErrMessage( 16528 ), 16528 );
  end;*/
  if ( (ValType(ExternalData.Sum.Currency) == V_STRING) and (ExternalData.Sum.Currency != "") )
    checkCurrency( ExternalData.Sum.Currency, DestAccount.value("T_CODE_CURRENCY"), 16557 );
  end;

  if ( (ValType(ExternalData.ComissionOut.Currency) == V_STRING) and (ExternalData.ComissionOut.Currency != "") )
    checkCurrency( ExternalData.ComissionOut.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16558 );
  end;
  if ( (ValType(ExternalData.ComissionIn.Currency) == V_STRING) and (ExternalData.ComissionIn.Currency != "") )
    checkCurrency( ExternalData.ComissionIn.Currency, DestAccount.value("T_CODE_CURRENCY"), 16559 );
  end;

  var OpData : Operation;
  OpData.ExternalSystem = ExternalData.ExternalSystem;
  OpData.ExternalPayCode = ExternalData.ExternalPayCode;
  OpData.ComissionType = ExternalData.ComissionType;
  OpData.ComissionOut.Sum = ExternalData.ComissionOut.Sum;
  OpData.ComissionOut.Currency = RetRetailNatISO(ExternalData.ComissionOut.Currency);
  OpData.OperSubType = ExternalData.OperSubType;
  OpData.Account = SourceAccount.value("T_REFERENC");

  Заполнение_ГАХ( OpData );
  r_sbdepdoc.Referenc = SourceAccount.value("T_REFERENC");
  r_sbdepdoc.NumDayDoc = 0;
  r_sbdepdoc.IsCur = SourceAccount.value("T_ISCUR");
  r_sbdepdoc.FNCash = SourceAccount.value("T_FNCASH");
  r_sbdepdoc.RealFNCash = SourceAccount.value("T_FNCASH");
  if (ExternalData.Client > 0)
    r_sbdepdoc.CodClient = ExternalData.Client;
  else
    r_sbdepdoc.CodClient = SourceAccount.value("T_CODCLIENT");
  end;
  r_sbdepdoc.Account = SourceAccount.value("T_ACCOUNT");
  r_sbdepdoc.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.DateDocument) != V_DATE) or (ExternalData.DateDocument == Date(0,0,0)) )
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = {curdate};
  else
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = ExternalData.DateDocument;
  end;
  r_sbdepdoc.TypeOper = 65;
  r_sbdepdoc.ApplType = OperSubType;
  r_sbdepdoc.TypeComplexOper = 65;
  r_sbdepdoc.IsControl = StrFor(1);
  r_sbdepdoc.Author = StrFor(0);
  r_sbdepdoc.YesSbook = "X";
  r_sbdepdoc.Oper = {oper};
  r_sbdepdoc.VIDDOC = 0;
  r_sbdepdoc.KINDOP = 3;
  r_sbdepdoc.OBJECTPERC = 2001;
  if ( (ValType(ExternalData.Ground) == V_STRING) and (ExternalData.Ground != "") )
    r_sbdepdoc.Ground = ExternalData.Ground;
  else
    r_sbdepdoc.Ground = "Перевод между текущими счетами (ИКФЛ)";
  end;
  r_sbdepdoc.OutSum = ExternalData.Sum.Sum;
  r_sbdepdoc.iApplicationKind = 1;
  r_sbdepdoc.ApplicationKey = FormApplicationKey(1);
  r_sbdepdoc.CorrAcc_Referenc = DestAccount.value("T_REFERENC");
  r_sbdepdoc.FNcash_Receiver = DestAccount.value("T_FNCASH");

  r_operprm.Account = SourceAccount.value("T_ACCOUNT");
  r_operprm.Type_Account = SourceAccount.value("T_TYPE_ACCOUNT");
  r_operprm.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  r_operprm.Type_Oper = 65;
  r_operprm.Show_Panel = 0;
  r_operprm.UseMaxDate = 1;
  r_operprm.NoPrint = 1;
  r_operprm.TypeComplexOper = 65;
  r_operprm.CorrAcc = DestAccount.value("T_ACCOUNT");
  r_operprm.CorrType = DestAccount.value("T_TYPE_ACCOUNT");

  pmnt_prop.bankcodekind = 3;
  pmnt_prop.BankCode = Trim( getRegNumOurBank( PTCK_BIC ) );
  pmnt_prop.BankName = getFilialName();
  pmnt_prop.PartyID = DestAccount.value("T_CODCLIENT");
  pmnt_prop.Account = DestAccount.value("T_ACCOUNT");
  pmnt_prop.CorrAccount = DestAccount.value("T_TYPE_ACCOUNT");
  pmnt_prop.account_currcode = DestAccount.value("T_CODE_CURRENCY");
  pmnt_prop.Branch = DestAccount.value("T_FNCASH");

  OpenDepFiles;
  var oldBatchMode = setbatchmode(true);
  AddStackGuard();
  var stat = Выполнение_Операции(r_operprm,r_sbdepdoc);
  setbatchmode(oldBatchMode);
  var errstackmes: string = "";
  var errstackerr: integer = GetErrorMessage(errstackmes);
  RemoveStackGuard();
  if (stat > 0)
    if ( errstackmes != "" )
      errstackmes = SubStr( (ErrMessage( stat ) + "|" + StrSubst (errstackmes , ErrMessage( stat ), "")), 1 , 241 );
      RunError( errstackmes , stat );
    else
    RunError( ErrMessage( stat ), stat );
  end;
  end;

  OpData.ComissionOut.Sum = RetrieveValue("Operation:Сумма@Комиссия");
  OpData.ComissionOut.Currency = RetrieveValue("Operation:Валюта@Комиссия");
  OpData.OperSubType = RetrieveValue("Operation:ВидСписания@Комиссия");
  OpData.Account = RetrieveValue("Operation:Счет@Комиссия");

  InterDesk_EndDocBunch();

  var retVal : TOperationResult;
  retVal.OperationID = r_operprm.ApplicationKey;
  retVal.OperDate = r_operprm.Date_Document;
  var rs_Cur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  retVal.SumOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.SumIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));

  retVal.SumIn.Sum = ExternalData.Sum.Sum;
  retVal.ComissionOut.Sum =  OpData.ComissionOut.Sum;
  retVal.SumOut.Sum = retVal.ComissionOut.Sum + ExternalData.Sum.Sum;

  var findDocID = rsdcommand("select * from drtdocument_dbt where T_OPAPPLICATIONKEY = :appkey and T_OPAPPLICATIONKIND = :appkind");
  findDocID.AddParam("appkey", RSDBP_IN, r_operprm.ApplicationKey);
  findDocID.AddParam("appkind", RSDBP_IN, r_operprm.ApplicationKind);
  findDocID.nullConversion = true;
  findDocID.execute();
  var rs_findDocID = RsdRecordset(findDocID);
  while ( rs_findDocID.moveNext() )
    retVal.DocumentIDs[retVal.DocumentIDs.size] = rs_findDocID.value("T_DOCUMENTID");
  end;

  retVal.Rate.Kind = 1;
  retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.BaseSum.Sum = $1;
  retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.WorkSum.Sum = $1;

  return retVal;
end;

/********************************************************************************\
|       ПЕРЕВОД С ТЕКУЩЕГО СЧЕТА НА КАРТУ КЛИЕНТА (В ОДНОЙ ВАЛЮТЕ)               |
\********************************************************************************/
macro ITransAC ( ExternalData )
  record r_sbdepdoc ("sbdepdoc.1");
  record r_operprm ("oper_prm.1");
  record pmnt_prop("rtpaymentprop.dbt");
  var DestAccount, SourceAccount;
  var OperSubType = 0;

  checkRealSum(ExternalData.Sum.Sum);
  if ( (ValType(ExternalData.Client) != V_INTEGER) or (ExternalData.Client < 0) )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ValType(ExternalData.ExternalPayCode) != V_STRING) or (ExternalData.ExternalPayCode == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  
  if ( (ValType(ExternalData.OperSubType) != V_INTEGER) or (ExternalData.OperSubType < 0) );
    OperSubType = 50;
  else
    OperSubType = ExternalData.OperSubType;
  end;

  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  var fndstat = findReissueAccount ( SourceAccount, ExternalData.Source, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16552; //некорректно заполнены данные источника
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  if ( (ValType(ExternalData.Sum.Currency) == V_STRING) and (ExternalData.Sum.Currency != "") )
    checkCurrency( ExternalData.Sum.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16555 );
  end;

  зададим_параметры_банка (SourceAccount);

  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  fndstat = findReissueAccount ( DestAccount, ExternalData.Destination, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16553; // некорректно заполнены данные получателя
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;

  /*if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
    RunError( ErrMessage( 16528 ), 16528 );
  end;*/
  if ( (ValType(ExternalData.Sum.Currency) == V_STRING) and (ExternalData.Sum.Currency != "") )
    checkCurrency( ExternalData.Sum.Currency, DestAccount.value("T_CODE_CURRENCY"), 16557 );
  end;

  checkDeathClient( convertNullInt(SourceAccount.value("T_CODCLIENT")), 19035 );

  if ( (ValType(ExternalData.ComissionOut.Currency) == V_STRING) and (ExternalData.ComissionOut.Currency != "") )
    checkCurrency( ExternalData.ComissionOut.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16558 );
  end;
  if ( (ValType(ExternalData.ComissionIn.Currency) == V_STRING) and (ExternalData.ComissionIn.Currency != "") )
    checkCurrency( ExternalData.ComissionIn.Currency, DestAccount.value("T_CODE_CURRENCY"), 16559 );
  end;

  var OpData : Operation;
  OpData.ExternalSystem = ExternalData.ExternalSystem;
  OpData.ExternalPayCode = ExternalData.ExternalPayCode;
  OpData.ComissionType = ExternalData.ComissionType;
  OpData.ComissionOut.Sum = ExternalData.ComissionOut.Sum;
  OpData.ComissionOut.Currency = RetRetailNatISO(ExternalData.ComissionOut.Currency);
  OpData.OperSubType = OperSubType;
  OpData.Account = SourceAccount.value("T_REFERENC");

  Заполнение_ГАХ( OpData );

  r_sbdepdoc.Referenc = SourceAccount.value("T_REFERENC");
  r_sbdepdoc.NumDayDoc = 0;
  r_sbdepdoc.IsCur = SourceAccount.value("T_ISCUR");
  r_sbdepdoc.FNCash = SourceAccount.value("T_FNCASH");
  r_sbdepdoc.RealFNCash = NumRealFNCash();
  if (ExternalData.Client > 0)
    r_sbdepdoc.CodClient = ExternalData.Client;
  else
    r_sbdepdoc.CodClient = SourceAccount.value("T_CODCLIENT");
  end;
  r_sbdepdoc.Account = SourceAccount.value("T_ACCOUNT");
  r_sbdepdoc.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.DateDocument) != V_DATE) or (ExternalData.DateDocument == Date(0,0,0)) )
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = {curdate};
  else
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = ExternalData.DateDocument;
  end;
  r_sbdepdoc.TypeOper = 63;
  r_sbdepdoc.ApplType = OperSubType;
  r_sbdepdoc.TypeComplexOper = 63;
  r_sbdepdoc.IsControl = StrFor(1);
  r_sbdepdoc.Author = StrFor(0);
  r_sbdepdoc.YesSbook = "X";
  r_sbdepdoc.Oper = {oper};
  r_sbdepdoc.VIDDOC = 0;
  r_sbdepdoc.KINDOP = 3;
  r_sbdepdoc.OBJECTPERC = 2001;
  if ( (ValType(ExternalData.Ground) == V_STRING) and (ExternalData.Ground != "") )
    r_sbdepdoc.Ground = ExternalData.Ground;
  else
    r_sbdepdoc.Ground = "Перечисление средств на карту " + getCardNumberByAccRef(DestAccount.value("T_REFERENC"));
  end;
  r_sbdepdoc.OutSum = ExternalData.Sum.Sum;
  r_sbdepdoc.iApplicationKind = 1;
  r_sbdepdoc.ApplicationKey = FormApplicationKey(1);

  r_operprm.Account = SourceAccount.value("T_ACCOUNT");
  r_operprm.Type_Account = SourceAccount.value("T_TYPE_ACCOUNT");
  r_operprm.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  r_operprm.Type_Oper = 63;
  r_operprm.Show_Panel = 0;
  r_operprm.UseMaxDate = 1;
  r_operprm.NoPrint = 1;
  r_operprm.TypeComplexOper = 63;

  var item = TIncrementDetailsItem;
  //findBankCode( PTCK_BIC, DestAccount.value("T_FNCASH"), item );
  if (DestAccount.value("T_CODE_CURRENCY") != 0)
    fillBankInfo(DestAccount.value("T_FNCASH"), false, item);
  else
    fillBankInfo(DestAccount.value("T_FNCASH"), true, item);
  end;

  pmnt_prop.bankcodekind = item.BankCodeKind;
  pmnt_prop.BankCode = item.BankCode;
  pmnt_prop.BankName = item.BankName;
  pmnt_prop.CorrAccount = item.CorAccount;
  pmnt_prop.account = DestAccount.value("T_ACCOUNT");
  pmnt_prop.account_currcode = DestAccount.value("T_CODE_CURRENCY");
  pmnt_prop.Branch = r_sbdepdoc.FnCash;
  pmnt_prop.Ground = r_sbdepdoc.Ground;
  
  var findName = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = ?");
  findName.AddParam ("ID",RSDBP_IN,convertNullInt(DestAccount.value("T_CODCLIENT")));
  findName.nullConversion = true;
  findName.execute();
  var rs_findName = RsdRecordset(findName);
  if (rs_findName.moveNext())
    pmnt_prop.Name = convertNullStr(rs_findName.value("T_NAME"));
    pmnt_prop.PartyID = convertNullInt(rs_findName.value("T_PARTYID"));
  else
    RunError( ErrMessage( 4661 ), 4661 );
  end;

/*
  var result;
  var findBankAcc = rsdcommand("begin ? := RSU_RTLBOOK.getDepartmentAccount( ?,?,?,?,?); end;");
  findBankAcc.addParam( "result", RSDBP_RETVAL, V_INTEGER );
  findBankAcc.addParam("varName", RSDBP_IN, V_ACCSPECNAME);
  findBankAcc.addParam("currencyCode", RSDBP_IN, DestAccount.value("T_CODE_CURRENCY"));
  findBankAcc.addParam("branch", RSDBP_IN, DestAccount.value("T_FNCASH"));
  if ( convertNullStr(rs_findName.value("T_NOTRESIDENT")) == "X" )
    findBankAcc.addParam("flagNonResident", RSDBP_IN, 1);
  else
    findBankAcc.addParam("flagNonResident", RSDBP_IN, 0);
  end;
  findBankAcc.addParam( "DepartmentAccount", RSDBP_OUT, V_STRING );
  findBankAcc.execute;
  result = findBankAcc.value("result");
  if ( result != 0 )
    findBankAcc = rsdcommand("begin ? := RSU_RTLBOOK.GetLastErrorMessage(); end;");
    findBankAcc.addParam( "result", RSDBP_RETVAL, V_STRING, 100000 );
    findBankAcc.execute;
    var ErrMes = findBankAcc.value("result"); 
    findBankAcc = rsdcommand("begin ? := RSU_RTLBOOK.GetLastErrorCode(); end;");
    findBankAcc.addParam( "result", RSDBP_RETVAL, V_INTEGER );
    findBankAcc.execute;
    var ErrCode = findBankAcc.value("result");
    RunError( ErrMes, ErrCode );
  else
    pmnt_prop.account = convertNullStr(findBankAcc.value("DepartmentAccount"));
  end;
*/  


  OpenDepFiles;
  var oldBatchMode = setbatchmode(true);
  AddStackGuard();
  var stat = Выполнение_Операции(r_operprm, r_sbdepdoc, pmnt_prop);
  setbatchmode(oldBatchMode);
  var errstackmes: string = "";
  var errstackerr: integer = GetErrorMessage(errstackmes);
  RemoveStackGuard();
  if (stat > 0)
    if ( errstackmes != "" )
      errstackmes = SubStr( (ErrMessage( stat ) + "|" + StrSubst (errstackmes , ErrMessage( stat ), "")), 1 , 241 );
      RunError( errstackmes , stat );
    else
    RunError( ErrMessage( stat ), stat );
  end;
  end;

  OpData.ComissionOut.Sum = RetrieveValue("Operation:Сумма@Комиссия");
  OpData.ComissionOut.Currency = RetrieveValue("Operation:Валюта@Комиссия");
  OpData.OperSubType = RetrieveValue("Operation:ВидСписания@Комиссия");
  OpData.Account = RetrieveValue("Operation:Счет@Комиссия");

  InterDesk_EndDocBunch();

  var retVal : TOperationResult ;
  retVal.OperationID = r_operprm.ApplicationKey;
  retVal.OperDate = r_operprm.Date_Document;
  var rs_Cur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  retVal.SumOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.SumIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));

  retVal.SumIn.Sum = ExternalData.Sum.Sum;
  retVal.ComissionOut.Sum =  OpData.ComissionOut.Sum;
  retVal.SumOut.Sum = retVal.ComissionOut.Sum + ExternalData.Sum.Sum;
  retVal.ComissionIn.Sum = $0L;

  retVal.Rate.Kind = 1;
  retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.BaseSum.Sum = $1;
  retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.WorkSum.Sum = $1;

  var findDocID = rsdcommand("select * from drtdocument_dbt where T_OPAPPLICATIONKEY = :appkey and T_OPAPPLICATIONKIND = :appkind");
  findDocID.AddParam("appkey", RSDBP_IN, r_operprm.ApplicationKey);
  findDocID.AddParam("appkind", RSDBP_IN, r_operprm.ApplicationKind);
  findDocID.nullConversion = true;
  findDocID.execute();
  var rs_findDocID = RsdRecordset(findDocID);
  while ( rs_findDocID.moveNext() )
    retVal.DocumentIDs[retVal.DocumentIDs.size] = rs_findDocID.value("T_DOCUMENTID");
  end;

  return retVal;
end;


/********************************************************************************\
|               ПЕРЕВОД ПРОИЗВОЛЬНОМУ ПОЛУЧАТЕЛЮ (ВНЕШНИЙ ПЛАТЕЖ)                |
\********************************************************************************/
macro ExtPayment ( ExternalData /* : TExtPaymData*/)
  record r_sbdepdoc ("sbdepdoc.dbt");
  record r_paypdoccp ("pay_doc_cp.dbt");
  record r_operprm ("oper_prm.1");
  record pmnt_prop("rtpaymentprop.dbt");

  checkRealSum(ExternalData.OperData.Sum.Sum);
  checkIntegerIdParam(ExternalData.OperData.Client);
  checkStringParam(ExternalData.OperData.ExternalPayCode);
  checkStringParam(ExternalData.Recipient.BankName);
  
  //Вынужденные меры по ограничению реализации
  if ( ((ValType(ExternalData.Recipient.BankID) != V_INTEGER) or (ExternalData.Recipient.BankID <= 0)) 
       and ((ValType(ExternalData.Recipient.BankCode) != V_STRING) or (ExternalData.Recipient.BankCode == "")) )
    RunError( ErrMessage( 17666 ), 17666 );
  end;
  
  
  checkIntegerRangeParam(ExternalData.DestType, 1, 3);
  var NumSubOper = 0;
  if ((ValType(ExternalData.OperData.OperSubType) == V_INTEGER) and (ExternalData.OperData.OperSubType  > 0) )
    NumSubOper = ExternalData.OperData.OperSubType;
  end;
  if (ExternalData.DestType == 3)
    checkStringParam(ExternalData.TaxParameters.DocAuthorState);
  end;
  
  var SourceAccount;
  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  var fndstat = findReissueAccount ( SourceAccount, ExternalData.OperData.Source, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16552; // некорректно заполнены данные источника
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  if ( (ValType(ExternalData.OperData.Sum.Currency) == V_STRING) and (ExternalData.OperData.Sum.Currency != "") )
    checkCurrency( ExternalData.OperData.Sum.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16555 );
  end;

  зададим_параметры_банка (SourceAccount);

  var IsOurBank = true;
  var BankName, CorAccount, Bank_INN, Bank_KPP, BankID;
  var BankCodeKind, BankCode;
  if ( (ValType(ExternalData.Recipient.BankCodeKind) == V_INTEGER) and (ExternalData.Recipient.BankCodeKind > 0) )
    BankCodeKind = ExternalData.Recipient.BankCodeKind;
  end;
  if ( (ValType(ExternalData.Recipient.BankCode) == V_STRING) and (ExternalData.Recipient.BankCode != "") )
    BankCode = ExternalData.Recipient.BankCode;
  end;
  if (ExternalData.DestType == 1)
    if ( (ValType(ExternalData.Recipient.BankID) == V_INTEGER) and (ExternalData.Recipient.BankID != {OurBank}) )
      RunError( ErrMessage( 16538 ), 16538 );
    elif ( (ValType(ExternalData.Recipient.BankID) == V_INTEGER) and (ExternalData.Recipient.BankID == {OurBank}) )
      if ( (ValType(ExternalData.Recipient.BankCode) == V_STRING) and (ExternalData.Recipient.BankCode != "") )
        if ( ExternalData.Recipient.BankCode != Trim( getRegNumOurBank( PTCK_BIC ) ) )
          RunError( ErrMessage( 16538 ), 16538 );
        end;
      else
        ExternalData.Recipient.BankCode = Trim( getRegNumOurBank( PTCK_BIC ) );
        BankCode = Trim( getRegNumOurBank( PTCK_BIC ) );
      end;
      if ( (ValType(ExternalData.Recipient.BankCodeKind) == V_INTEGER) and (ExternalData.Recipient.BankCodeKind > 0) )
        if ( ExternalData.Recipient.BankCodeKind != 3 )
          RunError( ErrMessage( 16538 ), 16538 );
        end;
      else
        ExternalData.Recipient.BankCodeKind = 3;
        BankCodeKind = 3;
      end;
      iFindBank( BankCodeKind, BankCode, BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
    elif ( (ValType(ExternalData.Recipient.BankCode) == V_STRING) and (ExternalData.Recipient.BankCode != "") )
        if ( (ValType(ExternalData.Recipient.BankCodeKind) != V_INTEGER) or (ExternalData.Recipient.BankCodeKind <= 0) )
          ExternalData.Recipient.BankCodeKind = 3;
          BankCodeKind = 3;
        end;
        iFindBank( BankCodeKind, BankCode, BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
        if ( (ValType(BankID) == V_INTEGER) and (BankID != {OurBank}) )
          RunError( ErrMessage( 16538 ), 16538 );
        end;
    ExternalData.Recipient.BankID = {OurBank};
    end;
  elif ((ExternalData.DestType == 2) or (ExternalData.DestType == 3))
    if ( (ValType(ExternalData.Recipient.BankID) == V_INTEGER) and (ExternalData.Recipient.BankID == {OurBank}) )
      RunError( ErrMessage( 16538 ), 16538 );
    elif ( (ValType(ExternalData.Recipient.BankID) == V_INTEGER) and (ExternalData.Recipient.BankID != {OurBank}) )
      if ( (ValType(ExternalData.Recipient.BankCodeKind) != V_INTEGER) or (ExternalData.Recipient.BankCodeKind <= 0) )
        ExternalData.Recipient.BankCodeKind = 3;
        BankCodeKind = 3;
      end;
      if ( (ValType(ExternalData.Recipient.BankCode) == V_STRING) and (ExternalData.Recipient.BankCode != "") )
        if ( ExternalData.Recipient.BankCode != ПолучитьБИК (ExternalData.Recipient.BankID, ExternalData.Recipient.BankCodeKind) )
          RunError( ErrMessage( 16538 ), 16538 );
        end;
      else
        ExternalData.Recipient.BankCode = ПолучитьБИК (ExternalData.Recipient.BankID, ExternalData.Recipient.BankCodeKind);
        BankCode = ПолучитьБИК (ExternalData.Recipient.BankID, ExternalData.Recipient.BankCodeKind);
      end;
      iFindBank( BankCodeKind, BankCode, BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
    elif ( (ValType(ExternalData.Recipient.BankCode) == V_STRING) and (ExternalData.Recipient.BankCode != "") )
      if ( (ValType(ExternalData.Recipient.BankCodeKind) != V_INTEGER) or (ExternalData.Recipient.BankCodeKind <= 0) )
        ExternalData.Recipient.BankCodeKind = 3;
        BankCodeKind = 3;
      end;
      iFindBank( BankCodeKind, BankCode, BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
      if ( (ValType(BankID) == V_INTEGER) and (BankID == {OurBank}) )
        RunError( ErrMessage( 16538 ), 16538 );
      end;
      ExternalData.Recipient.BankID = BankID;
    end;
  end;
  if ( (ValType(ExternalData.Recipient.BankName) == V_STRING) and (ExternalData.Recipient.BankName != "") and (ExternalData.Recipient.BankName != BankName))
    RunError( ErrMessage( 16538 ), 16538 );
  end;
  if ( (ValType(ExternalData.Recipient.CorAccount) == V_STRING) and (ExternalData.Recipient.CorAccount != "") and (ExternalData.Recipient.CorAccount != CorAccount))
    RunError( ErrMessage( 16538 ), 16538 );
  end;

  if (ExternalData.DestType == 1)
    var typeDest = rsdcommand("select * from dparty_dbt where T_PARTYID = :ID");
    typeDest.AddParam("ID", RSDBP_IN, ExternalData.Recipient.BankID);
    typeDest.nullConversion = true;
    typeDest.execute();
    var rs_typeDest = RsdRecordset(typeDest);
    if ( (not rs_typeDest.moveNext()) or (rs_typeDest.value("T_LEGALFORM") != 1) )
      RunError( ErrMessage( 16537 ), 16537 );
    end;
    if ( (ValType(ExternalData.Recipient.INN) != V_STRING) or (ExternalData.Recipient.INN == "") )
      RunError( ErrMessage( 16546 ), 16546 );
    end;
    if ( (ValType(ExternalData.Recipient.KPP) != V_STRING) or (ExternalData.Recipient.KPP == "") )
      RunError( ErrMessage( 16546 ), 16546 );
    end;
    
    if ( (ValType(ExternalData.Recipient.Account) != V_STRING) or (ExternalData.Recipient.Account == "") )
      RunError( ErrMessage( 16504 ), 16504 );
    end;
    
    var findExtcurAcc = rsdcommand("SELECT * FROM daccount_dbt WHERE T_OPEN_CLOSE = CHR (0) AND T_ACCOUNT = :AccNumber "
                            " AND T_CODE_CURRENCY = (SELECT T_FIID FROM dfininstr_dbt WHERE T_FI_CODE = "
                            " (SELECT T_EXTERNALCODE FROM dcurrency_dbt WHERE T_CODE_CURRENCY = :codeCur))");
    findExtcurAcc.AddParam("AccNumber", RSDBP_IN, ExternalData.Recipient.Account);
    findExtcurAcc.AddParam( "codeCur", RSDBP_IN, SourceAccount.value("T_CODE_CURRENCY") );
    findExtcurAcc.nullConversion = true;
    findExtcurAcc.execute();
    var rs_findExtcurAcc = RsdRecordset(findExtcurAcc);
    if ( not rs_findExtcurAcc.moveNext() )
      var findKernelAccount = rsdcommand("select * from daccount_dbt where T_ACCOUNT = :AccNumber and T_OPEN_CLOSE = chr(0) ORDER BY T_CODE_CURRENCY DESC");
      findKernelAccount.AddParam("AccNumber", RSDBP_IN, ExternalData.Recipient.Account);
      findKernelAccount.nullConversion = true;
      findKernelAccount.execute();
      var rs_findKernelAccount = RsdRecordset(findKernelAccount);
      if ( not rs_findKernelAccount.moveNext() )
        RunError( ErrMessage( 16536 ), 16536 );
      else
        var rs_findSourceCur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
        var codeCurr = GKBO_FindFinInstrCurr(rs_findKernelAccount.value("T_CODE_CURRENCY"));
        if ( rs_findSourceCur.value("t_Code_Currency") != codeCurr)
          RunError( ErrMessage( 16528 ), 16528 );
        end;
      end;
    end;
  end;

  if ( (ValType(ExternalData.OperData.ComissionOut.Currency) == V_STRING) and (ExternalData.OperData.ComissionOut.Currency != "") )
    checkCurrency( ExternalData.OperData.ComissionOut.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16558 );
  end;

  var OpData : Operation;
  OpData.ExternalSystem = ExternalData.OperData.ExternalSystem;
  OpData.ExternalPayCode = ExternalData.OperData.ExternalPayCode;
  OpData.ComissionType = ExternalData.OperData.ComissionType;
  OpData.ComissionOut.Sum = ExternalData.OperData.ComissionOut.Sum;
  OpData.ComissionOut.Currency = RetRetailNatISO(ExternalData.OperData.ComissionOut.Currency);
  OpData.OperSubType = NumSubOper;
  OpData.Account = SourceAccount.value("T_REFERENC");

  Заполнение_ГАХ( OpData );

  pmnt_prop.bankcodekind = BankCodeKind;
  pmnt_prop.BankCode = BankCode;
  pmnt_prop.BankName = BankName;
  if ( (ValType(ExternalData.Recipient.BankID) == V_INTEGER) and (ExternalData.Recipient.BankID > 0) )
//    pmnt_prop.BankID = ExternalData.Recipient.BankID;
  end; 
  pmnt_prop.PartyID = 0;
  if ( (ValType(ExternalData.Recipient.CorAccount) == V_STRING) and (ExternalData.Recipient.CorAccount != "") )
    pmnt_prop.CorrAccount = ExternalData.Recipient.CorAccount;
  end;
  if ( (ValType(ExternalData.Recipient.Account) == V_STRING) and (ExternalData.Recipient.Account != "") )
    pmnt_prop.account = ExternalData.Recipient.Account;
  end;
  pmnt_prop.account_currcode = SourceAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.Recipient.INN) == V_STRING) and (ExternalData.Recipient.INN != "") )
    pmnt_prop.INN = ExternalData.Recipient.INN;
  end;
  if ( (ValType(ExternalData.Recipient.KPP) == V_STRING) and (ExternalData.Recipient.KPP != "") )
    pmnt_prop.KPP = ExternalData.Recipient.KPP;
  end;
  if ( (ValType(ExternalData.Recipient.Name) == V_STRING) and (ExternalData.Recipient.Name != "") )
    pmnt_prop.Name = ExternalData.Recipient.Name;
  end;

  r_sbdepdoc.Referenc = SourceAccount.value("T_REFERENC");
  r_sbdepdoc.NumDayDoc = 0;
  r_sbdepdoc.IsCur = SourceAccount.value("T_ISCUR");
  r_sbdepdoc.FNCash = SourceAccount.value("T_FNCASH");
  r_sbdepdoc.RealFNCash = SourceAccount.value("T_FNCASH");
  if (ExternalData.OperData.Client > 0)
    r_sbdepdoc.CodClient = ExternalData.OperData.Client;
  else
    r_sbdepdoc.CodClient = SourceAccount.value("T_CODCLIENT");
  end;
  r_sbdepdoc.Account = SourceAccount.value("T_ACCOUNT");
  r_sbdepdoc.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.OperData.DateDocument) != V_DATE) or (ExternalData.OperData.DateDocument == Date(0,0,0)) )
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = {curdate};
  else
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = ExternalData.OperData.DateDocument;
  end;
  r_sbdepdoc.TypeOper = 63;
  r_sbdepdoc.ApplType = NumSubOper;
  r_sbdepdoc.TypeComplexOper = 63;
  r_sbdepdoc.IsControl = StrFor(1);
  r_sbdepdoc.Author = StrFor(0);
  r_sbdepdoc.YesSbook = "X";
  r_sbdepdoc.Oper = {oper};
  r_sbdepdoc.VIDDOC = 0;
  r_sbdepdoc.KINDOP = 3;
  r_sbdepdoc.OBJECTPERC = 2001;
  if ( (ValType(ExternalData.OperData.Ground) == V_STRING) and (ExternalData.OperData.Ground != "") )
    r_sbdepdoc.Ground = ExternalData.OperData.Ground;
  else
    r_sbdepdoc.Ground = "Перевод внешнему получателю (ИКФЛ)";
  end;
  r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
  r_sbdepdoc.iApplicationKind = 1;
  r_sbdepdoc.ApplicationKey = FormApplicationKey(1);

  
  if ( ExternalData.DestType == 3 )
    //r_paypdoccp.ApplKind = 20;
    //r_paypdoccp.ApplKey = r_sbdepdoc.ApplicationKey;
    r_paypdoccp.PaySum = ExternalData.OperData.Sum.Sum;
    r_paypdoccp.Account = SourceAccount.value("T_ACCOUNT");
    r_paypdoccp.AccountKind = SourceAccount.value("T_TYPE_ACCOUNT");
   
    if ( (ValType(ExternalData.TaxParameters.KBK) == V_STRING) and (ExternalData.TaxParameters.KBK != "") )
      r_paypdoccp.KBK = ExternalData.TaxParameters.KBK;
    end;
    if ( (ValType(ExternalData.TaxParameters.OKATO) == V_STRING) and (ExternalData.TaxParameters.OKATO != "") )
      r_paypdoccp.OKATO = ExternalData.TaxParameters.OKATO;
    end;
    if ( (ValType(ExternalData.TaxParameters.DocAuthorState) == V_STRING) and (ExternalData.TaxParameters.DocAuthorState != "") )
      r_paypdoccp.PayDocAuthorStatus = ExternalData.TaxParameters.DocAuthorState;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalType) == V_STRING) and (ExternalData.TaxParameters.NalType != "") )
      r_paypdoccp.nalType = ExternalData.TaxParameters.NalType;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalPeriod) == V_STRING) and (ExternalData.TaxParameters.NalPeriod != "") )
      r_paypdoccp.NalPeriod = ExternalData.TaxParameters.NalPeriod;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalDocNumber) == V_STRING) and (ExternalData.TaxParameters.NalDocNumber != "") )
      r_paypdoccp.NalDocNumber = ExternalData.TaxParameters.NalDocNumber;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalDocDate) == V_DATE) and (ExternalData.TaxParameters.NalDocDate != Date(0,0,0)) )
      r_paypdoccp.NalDocDate = ExternalData.TaxParameters.NalDocDate;
    end;
    if ( (ValType(ExternalData.TaxParameters.ChargeID) == V_STRING) and (ExternalData.TaxParameters.ChargeID != "") )
      r_paypdoccp.ChargeID = ExternalData.TaxParameters.ChargeID;
    end;
    if ( (ValType(ExternalData.TaxParameters.DocIndex) == V_STRING) and (ExternalData.TaxParameters.DocIndex != "") )
      r_paypdoccp.DocIndex = ExternalData.TaxParameters.DocIndex;
    end;
    if ( (ValType(ExternalData.TaxParameters.PersonID) == V_STRING) and (ExternalData.TaxParameters.PersonID != "") )
      r_paypdoccp.PersonID = ExternalData.TaxParameters.PersonID;
    end;
    if ( (ValType(ExternalData.TaxParameters.Comment) == V_STRING) and (ExternalData.TaxParameters.Comment != "") )
      r_paypdoccp.NalAssignment = substr(ExternalData.TaxParameters.Comment,1,2);
    end;
  else
    r_operprm.Account = SourceAccount.value("T_ACCOUNT");
    r_operprm.Type_Account = SourceAccount.value("T_TYPE_ACCOUNT");
    r_operprm.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
    r_operprm.Type_Oper = 63;
    r_operprm.Show_Panel = 0;
    r_operprm.UseMaxDate = 1;
    r_operprm.NoPrint = 1;
    r_operprm.TypeComplexOper = 63;

    r_paypdoccp.PaySum = ExternalData.OperData.Sum.Sum;
    r_paypdoccp.Account = SourceAccount.value("T_ACCOUNT");
    r_paypdoccp.AccountKind = SourceAccount.value("T_TYPE_ACCOUNT");
  end;

  // Заполнение параметров для ГИС ЖКХ, могут идти вместе с бюджетным платежом
  if ( ExternalData.ZHKHData != null )
    checkZHKHData( ExternalData.ZHKHData );

    r_paypdoccp.IsForGIS = "X";
    r_paypdoccp.Status = 1;
    if ( (ValType(ExternalData.ZHKHData.SupplierID) == V_STRING) and (ExternalData.ZHKHData.SupplierID != "") )
      r_paypdoccp.PersonID = ExternalData.ZHKHData.SupplierID;
    else
      var clientList = TClientList;
      if ( clientList.GetRecord( r_sbdepdoc.CodClient ) )
        if ( ( clientList.CurRec.rec.PaperSeries != "" ) or ( clientList.CurRec.rec.PaperNumber != "" ) )
          r_paypdoccp.PersonID = MakePersonId( clientList.CurRec.rec.PaperKind, clientList.CurRec.rec.PaperSeries, clientList.CurRec.rec.PaperNumber );
        else
          r_paypdoccp.PersonID = "0000000000000000000000000";
        end;
      end;
    end;

    // Если задано поле RecINN, то брать его в качестве ИНН исполнителя
    if ( (ValType(ExternalData.ZHKHData.RecINN) == V_STRING) and (ExternalData.ZHKHData.RecINN != "") )
      r_paypdoccp.SupplierINN = ExternalData.ZHKHData.RecINN;
    // Если хотя бы один из параметров исполнителя платежа заполнен, то требуется обязательное заполнение поля RecINN
    elif ( ( (ValType(ExternalData.ZHKHData.RecKPP) == V_STRING) and (ExternalData.ZHKHData.RecKPP != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecSurname) == V_STRING) and (ExternalData.ZHKHData.RecSurname != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecFirstName) == V_STRING) and (ExternalData.ZHKHData.RecFirstName != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecPatronymic) == V_STRING) and (ExternalData.ZHKHData.RecPatronymic != "") ) or
           ( (GenPropID(ExternalData.ZHKHData, "RecName") >= 0) and (ValType(ExternalData.ZHKHData.RecName) == V_STRING) and (ExternalData.ZHKHData.RecName != "") ) )
      RunError( ErrMessage( 16504 ), 16504 );
    // Иначе брать ИНН получателя платежа в качестве ИНН исполнителя
    else
      r_paypdoccp.SupplierINN = pmnt_prop.INN;
    end;

    if ( (ValType(ExternalData.ZHKHData.RecKPP) == V_STRING) and (ExternalData.ZHKHData.RecKPP != "") )
      r_paypdoccp.SupplierKPP = ExternalData.ZHKHData.RecKPP;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecSurname) == V_STRING) and (ExternalData.ZHKHData.RecSurname != "") )
      r_paypdoccp.SupplierName1 = ExternalData.ZHKHData.RecSurname;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecFirstName) == V_STRING) and (ExternalData.ZHKHData.RecFirstName != "") )
      r_paypdoccp.SupplierName2 = ExternalData.ZHKHData.RecFirstName;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecPatronymic) == V_STRING) and (ExternalData.ZHKHData.RecPatronymic != "") )
      r_paypdoccp.SupplierName3 = ExternalData.ZHKHData.RecPatronymic;
    end;
    if ( (GenPropID(ExternalData.ZHKHData, "RecName") >= 0) and (ValType(ExternalData.ZHKHData.RecName) == V_STRING) and (ExternalData.ZHKHData.RecName != "") )
      r_paypdoccp.SupplierShortName = ExternalData.ZHKHData.RecName;
    end;
    if ( (ValType(ExternalData.ZHKHData.PaymentDocumentNumber) == V_STRING) and (ExternalData.ZHKHData.PaymentDocumentNumber != "") )
      r_paypdoccp.PaymentDocumentNumber = ExternalData.ZHKHData.PaymentDocumentNumber;
    end;
    if ( (ValType(ExternalData.ZHKHData.PaymentDocumentID) == V_STRING) and (ExternalData.ZHKHData.PaymentDocumentID != "") )
      r_paypdoccp.GISDocNumber = ExternalData.ZHKHData.PaymentDocumentID;
    end;
    if ( ValType(ExternalData.ZHKHData.Year) == V_INTEGER )
      r_paypdoccp.Year = ExternalData.ZHKHData.Year;
    end; 
    if ( ValType(ExternalData.ZHKHData.Month) == V_INTEGER )
      r_paypdoccp.Month = ExternalData.ZHKHData.Month;
    end; 
    if ( (ValType(ExternalData.ZHKHData.UnifiedAccountNumber) == V_STRING) and (ExternalData.ZHKHData.UnifiedAccountNumber != "") )
      r_paypdoccp.PayerId = ExternalData.ZHKHData.UnifiedAccountNumber;
    end;
    if ( (ValType(ExternalData.ZHKHData.CPAccount) == V_STRING) and (ExternalData.ZHKHData.CPAccount != "") )
      r_paypdoccp.CPAccount = ExternalData.ZHKHData.CPAccount;
    end;
    if ( (ValType(ExternalData.ZHKHData.ServiceID) == V_STRING) and (ExternalData.ZHKHData.ServiceID != "") )
      r_paypdoccp.ServiceId = ExternalData.ZHKHData.ServiceID;
    end;
    if ( (ValType(ExternalData.ZHKHData.FIASHouseGuid) == V_STRING) and (ExternalData.ZHKHData.FIASHouseGuid != "") )
      r_paypdoccp.HouseId = ExternalData.ZHKHData.FIASHouseGuid;
    end;
    if ( (ValType(ExternalData.ZHKHData.Apartment) == V_STRING) and (ExternalData.ZHKHData.Apartment != "") )
      r_paypdoccp.FlatId = ExternalData.ZHKHData.Apartment;
    end;
    if ( (ValType(ExternalData.ZHKHData.Placement) == V_STRING) and (ExternalData.ZHKHData.Placement != "") )
      r_paypdoccp.RoomId = ExternalData.ZHKHData.Placement;
    end;
    if ( ValType(ExternalData.ZHKHData.IsNonLiving) == V_BOOL )
      if ( ExternalData.ZHKHData.IsNonLiving )
        r_paypdoccp.NonLiving = "X";
      else
        r_paypdoccp.NonLiving = "";
      end;
    end;
    if ( (ValType(ExternalData.ZHKHData.Surname) == V_STRING) and (ExternalData.ZHKHData.Surname != "") )
      r_paypdoccp.ConsumerSurname = ExternalData.ZHKHData.Surname;
    end;
    if ( (ValType(ExternalData.ZHKHData.FirstName) == V_STRING) and (ExternalData.ZHKHData.FirstName != "") )
      r_paypdoccp.ConsumerFirstName = ExternalData.ZHKHData.FirstName;
    end;
    if ( (ValType(ExternalData.ZHKHData.Patronymic) == V_STRING) and (ExternalData.ZHKHData.Patronymic != "") )
      r_paypdoccp.ConsumerPatronymic = ExternalData.ZHKHData.Patronymic;
    end;
    if ( (ValType(ExternalData.ZHKHData.INN) == V_STRING) and (ExternalData.ZHKHData.INN != "") )
//      r_paypdoccp.ConsumerINN = ExternalData.ZHKHData.INN; // нет поля ConsumerINN в таблице
    end;
  end;  
  
  OpenDepFiles;
  var oldBatchMode = setbatchmode(true);
  var stat = 0;
  AddStackGuard();
  if ( (ExternalData.DestType == 3) or (r_paypdoccp.IsForGIS == "X")  )
    stat = CP_Carry(r_sbdepdoc, r_paypdoccp, pmnt_prop, NULL);
  else
    stat = Выполнение_Операции(r_operprm, r_sbdepdoc, pmnt_prop);
  end;
  setbatchmode(oldBatchMode);
  var errstackmes: string = "";
  var errstackerr: integer = GetErrorMessage(errstackmes);
  RemoveStackGuard();
  if (stat > 0)
    if ( errstackmes != "" )
      errstackmes = SubStr( (ErrMessage( stat ) + "|" + StrSubst (errstackmes , ErrMessage( stat ), "")), 1 , 241 );
      RunError( errstackmes , stat );
    else
    RunError( ErrMessage( stat ), stat );
  end;
  end;
  
  if ( r_paypdoccp.IsForGIS == "X" )
    SendOneZKHToGIS(r_sbdepdoc.iApplicationKind, r_sbdepdoc.ApplicationKey);
  end;

  OpData.ComissionOut.Sum = RetrieveValue("Operation:Сумма@Комиссия");
  OpData.ComissionOut.Currency = RetrieveValue("Operation:Валюта@Комиссия");
  OpData.OperSubType = RetrieveValue("Operation:ВидСписания@Комиссия");
  OpData.Account = RetrieveValue("Operation:Счет@Комиссия");

  InterDesk_EndDocBunch();

  var retVal : TOperationResult;
  retVal.OperationID = r_sbdepdoc.ApplicationKey;
  retVal.OperDate = r_sbdepdoc.Date_Document;
  var rs_Cur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  retVal.SumOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.SumIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));

  retVal.SumIn.Sum = ExternalData.OperData.Sum.Sum;
  retVal.ComissionOut.Sum = OpData.ComissionOut.Sum;
  retVal.SumOut.Sum = retVal.ComissionOut.Sum + ExternalData.OperData.Sum.Sum;
  retVal.ComissionIn.Sum = $0L;

  var findDocID = rsdcommand("select * from drtdocument_dbt where T_OPAPPLICATIONKEY = :appkey and T_OPAPPLICATIONKIND = :appkind");
  findDocID.AddParam("appkey", RSDBP_IN, r_sbdepdoc.ApplicationKey);
  findDocID.AddParam("appkind", RSDBP_IN, r_sbdepdoc.iApplicationKind);
  findDocID.nullConversion = true;
  findDocID.execute();
  var rs_findDocID = RsdRecordset(findDocID);
  while ( rs_findDocID.moveNext() )
    retVal.DocumentIDs[retVal.DocumentIDs.size] = rs_findDocID.value("T_DOCUMENTID");
  end;

  retVal.Rate.Kind = 1;
  retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.BaseSum.Sum = $1;
  retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.WorkSum.Sum = $1;

  return retVal;

end;


/********************************************************************************\
|             ПЛАТЕЖ ПОЛУЧАТЕЛЮ УСЛУГ (КОММУНАЛЬНЫЙ ПЛАТЕЖ) СО СЧЕТА             |
\********************************************************************************/
macro ExtPaymentCP ( ExternalData )
  record r_sbdepdoc ("sbdepdoc.1");
  record r_paypdoccp ("pay_doc_cp.dbt");
  record r_operprm ("oper_prm.1");
  record pmnt_prop("rtpaymentprop.dbt");
  var SourceAccount;
  var sql;

  if ( (ValType(ExternalData.OperData.Client) != V_INTEGER) or (ExternalData.OperData.Client < 0) )
    RunError( ErrMessage( 16504 ), 16504 );  
  elif ( (ValType(ExternalData.OperData.ExternalPayCode) != V_STRING) or (ExternalData.OperData.ExternalPayCode == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ValType(ExternalData.OperData.Sum.Sum) != V_MONEY) or (ExternalData.OperData.Sum.Sum <= $0L) );
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ValType(ExternalData.Recipient.RecipientID) != V_INTEGER) or (ExternalData.Recipient.RecipientID < 1) )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var NeedRepID = false;
  sql = "select * from drtcp_recipient_dbt where T_ID = ?";
  var findRecip = rsdcommand(sql);
  findRecip.AddParam( "id", RSDBP_IN, ExternalData.Recipient.RecipientID );
  findRecip.nullConversion = true;
  findRecip.execute();
  var rs_findRecip = RsdRecordset(findRecip);
  if (rs_findRecip.moveNext)
    if ( convertNullStr(rs_findRecip.value("T_ISCPACCOUNTUSING")) == "X" )
      NeedRepID = true;
    end;
  else
      RunError( ErrMessage( 16504 ), 16504 );
  end;
  if ( (NeedRepID) and ( (ValType(ExternalData.Recipient.CPAccount) != V_STRING) or (ExternalData.Recipient.CPAccount == "") ) )
    if ( (ValType(ExternalData.ZHKHData.CPAccount) == V_STRING) and (ExternalData.ZHKHData.CPAccount != "") )
      ExternalData.Recipient.CPAccount = ExternalData.ZHKHData.CPAccount;
    else
      RunError( ErrMessage( 16504 ), 16504 );
    end;
  end;

  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  var fndstat = findReissueAccount ( SourceAccount, ExternalData.OperData.Source, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16552; // некорректно заполнены данные источника
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  if ( SourceAccount.value("T_CODE_CURRENCY") != 0 )
    RunError( ErrMessage( 16543 ), 16543 );
  elif ( ExternalData.OperData.Sum.Currency != 0 )
    RunError( ErrMessage( 16555 ), 16555 );
  elif (ExternalData.OperData.Sum.Sum < $0.01)
    RunError( ErrMessage( 4702 ), 4702 );
  end;
  
  зададим_параметры_банка (SourceAccount);

  var isFindRtcp_type = false, FindRtcp_type, rs_FindRtcp_type;
  if ( (ValType(ExternalData.ServiceType) == V_STRING) and (ExternalData.ServiceType != "") )
    sql = "select * from drtcp_type_dbt where t_code = ?";
    FindRtcp_type = rsdcommand(sql);
    FindRtcp_type.AddParam( "code", RSDBP_IN, ExternalData.ServiceType );
    FindRtcp_type.nullConversion = true;
    FindRtcp_type.execute();
    rs_FindRtcp_type = RsdRecordset(FindRtcp_type);
    if ( not rs_FindRtcp_type.moveNext )
      RunError( ErrMessage( 16544 ), 16544 );
    end;
    isFindRtcp_type = true;
  end;
  
  sql = "select * from drtcp_link_dbt where T_RECIPIENTID = ? and  T_TYPEID <> 0 ";
  var FindRtcp_link, rs_FindRtcp_link;
  if (isFindRtcp_type)
    sql = sql + " and  T_TYPEID = ? ";
  end;
  FindRtcp_link = rsdcommand(sql);
  FindRtcp_link.AddParam( "RepId", RSDBP_IN, ExternalData.Recipient.RecipientID );
  if (isFindRtcp_type)
    FindRtcp_link.AddParam( "TypeId", RSDBP_IN, convertNullInt(rs_FindRtcp_type.value("T_ID")) );
  end;
  FindRtcp_link.nullConversion = true;
  FindRtcp_link.execute();
  rs_FindRtcp_link = RsdRecordset(FindRtcp_link);
  if ( not rs_FindRtcp_link.moveNext )
    RunError( ErrMessage( 16544 ), 16544 );
  elif ( rs_FindRtcp_link.moveNext )
    RunError( ErrMessage( 5680 ), 5680 );
  end;

  if ( convertNullStr(rs_FindRtcp_link.value("T_ISHIDDEN")) == "X" )
    RunError( ErrMessage( 6183 ), 6183 );
  end;
  
  if ( isFindRtcp_type )
    if ( (convertNullStr(rs_FindRtcp_type.value("T_INBUDGET")) == "X" ) AND
       ( (ValType(ExternalData.TaxParameters.KBK) != V_STRING) OR
         (ExternalData.TaxParameters.KBK == "") OR
         (ValType(ExternalData.TaxParameters.DocAuthorState) != V_STRING) OR
         (ExternalData.TaxParameters.DocAuthorState == "") ) )
        RunError( ErrMessage( 16544 ), 16544 );
    end;
  end;
  if ( ExternalData.AuxInfo.size > 0 )
    ;
  end;
  
  var IsInfoRep = false, FindInfoRep, rs_FindInfoRep;
  if ( convertNullStr(rs_findRecip.value("T_ISCPACCOUNTUSING")) == "X" )
    sql  = "select * from drtcp_account_dbt where t_linkid = ? and t_account = ?";
    FindInfoRep = rsdcommand(sql);
    FindInfoRep.AddParam( "LinkId", RSDBP_IN, convertNullInt(rs_FindRtcp_link.value("T_ID")) );
    FindInfoRep.AddParam( "Account", RSDBP_IN, ExternalData.Recipient.CPAccount );
    FindInfoRep.nullConversion = true;
    FindInfoRep.execute();
    rs_FindInfoRep = RsdRecordset(FindInfoRep);
    if (not rs_FindInfoRep.moveNext )
      sql  = "select * from drtcp_account_dbt where t_linkid IN (select T_ID from drtcp_link_dbt where T_RECIPIENTID = ? and  T_TYPEID = 0) " +
                 " and t_account = ?";
      FindInfoRep = rsdcommand(sql);
      FindInfoRep.AddParam( "LinkId", RSDBP_IN, ExternalData.Recipient.RecipientID );
      FindInfoRep.AddParam( "Account", RSDBP_IN, ExternalData.Recipient.CPAccount );
      FindInfoRep.nullConversion = true;
      FindInfoRep.execute();
      rs_FindInfoRep = RsdRecordset(FindInfoRep);
      if ( rs_FindInfoRep.moveNext )
        IsInfoRep = true;
      end;
    end;
  end;

  if ( (ValType(ExternalData.OperData.ComissionOut.Currency) == V_STRING) and (ExternalData.OperData.ComissionOut.Currency != "") )
    checkCurrency( ExternalData.OperData.ComissionOut.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16558 );
  end;
  
  var OpData : Operation;
  OpData.ExternalSystem = ExternalData.OperData.ExternalSystem;
  OpData.ExternalPayCode = ExternalData.OperData.ExternalPayCode;
  OpData.ComissionType = ExternalData.OperData.ComissionType;
  OpData.ComissionOut.Sum = ExternalData.OperData.ComissionOut.Sum;
  OpData.ComissionOut.Currency = RetRetailNatISO(ExternalData.OperData.ComissionOut.Currency);
  OpData.OperSubType = 7;
  OpData.Account = SourceAccount.value("T_REFERENC");

  Заполнение_ГАХ( OpData );

/*  pmnt_prop.bankcodekind = ExternalData.Recipient.BankCodeKind;
  pmnt_prop.BankCode = ExternalData.Recipient.BankCode;
  pmnt_prop.BankName = BankName;
  pmnt_prop.PartyID = 0;
  pmnt_prop.account_currcode = SourceAccount.value("T_CODE_CURRENCY");
  pmnt_prop.account = ExternalData.Recipient.Account;*/

  r_sbdepdoc.Referenc = SourceAccount.value("T_REFERENC");
  r_sbdepdoc.NumDayDoc = 0;
  r_sbdepdoc.IsCur = SourceAccount.value("T_ISCUR");
  r_sbdepdoc.FNCash = SourceAccount.value("T_FNCASH");
  r_sbdepdoc.RealFNCash = NumFNCash();
  if (ExternalData.OperData.Client > 0)
    r_sbdepdoc.CodClient = ExternalData.OperData.Client;
  else
    r_sbdepdoc.CodClient = SourceAccount.value("T_CODCLIENT");
  end;
  r_sbdepdoc.Account = SourceAccount.value("T_ACCOUNT");
  r_sbdepdoc.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.OperData.DateDocument) != V_DATE) or (ExternalData.OperData.DateDocument == Date(0,0,0)) )
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = {curdate};
  else
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = ExternalData.OperData.DateDocument;
  end;
  r_sbdepdoc.TypeOper = 64;
  if ( (ValType(ExternalData.OperData.OperSubType) != V_INTEGER) or (ExternalData.OperData.OperSubType < 0) )
    r_sbdepdoc.ApplType = 49;
  else
    r_sbdepdoc.ApplType = ExternalData.OperData.OperSubType;
  end;
  r_sbdepdoc.TypeComplexOper = 64;
  r_sbdepdoc.IsControl = StrFor(1);
  r_sbdepdoc.Author = StrFor(0);
  r_sbdepdoc.YesSbook = "X";
  r_sbdepdoc.Oper = {oper};
  r_sbdepdoc.VIDDOC = 0;
  r_sbdepdoc.KINDOP = 3;
  r_sbdepdoc.OBJECTPERC = 2001;
  if ( (ValType(ExternalData.OperData.Ground) == V_STRING) and (ExternalData.OperData.Ground != "") )
    r_sbdepdoc.Ground = ExternalData.OperData.Ground;
  else
    r_sbdepdoc.Ground = "Списание по коммунальному платежу (ИКФЛ)";
  end;
  r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
  r_sbdepdoc.iApplicationKind = 1;
  r_sbdepdoc.ApplicationKey = FormApplicationKey(1);

  //r_paypdoccp.ApplKind = 20;
  //r_paypdoccp.ApplKey = r_sbdepdoc.ApplicationKey;
  r_paypdoccp.PaySum = ExternalData.OperData.Sum.Sum;
  r_paypdoccp.Account = SourceAccount.value("T_ACCOUNT");
  r_paypdoccp.AccountKind = SourceAccount.value("T_TYPE_ACCOUNT");
  if (IsInfoRep)
    r_paypdoccp.CPAccountID = convertNullInt( rs_FindInfoRep.value("T_ID") );
  end;
  if ( (ValType(ExternalData.Recipient.CPAccount) == V_STRING) and (ExternalData.Recipient.CPAccount != "") )
  r_paypdoccp.CPAccount = ExternalData.Recipient.CPAccount;
  end;
  r_paypdoccp.CpLinkID = convertNullInt(rs_FindRtcp_link.value("T_ID"));

  if ( isFindRtcp_type and convertNullStr(rs_FindRtcp_type.value("T_INBUDGET")) == "X" )
    if ( (ValType(ExternalData.TaxParameters.KBK) == V_STRING) and (ExternalData.TaxParameters.KBK != "") )
      r_paypdoccp.KBK = ExternalData.TaxParameters.KBK;
    end;
    if ( (ValType(ExternalData.TaxParameters.OKATO) == V_STRING) and (ExternalData.TaxParameters.OKATO != "") )
      r_paypdoccp.OKATO = ExternalData.TaxParameters.OKATO;
    end;
    if ( (ValType(ExternalData.TaxParameters.DocAuthorState) == V_STRING) and (ExternalData.TaxParameters.DocAuthorState != "") )
      r_paypdoccp.PayDocAuthorStatus = ExternalData.TaxParameters.DocAuthorState;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalType) == V_STRING) and (ExternalData.TaxParameters.NalType != "") )
      r_paypdoccp.nalType = ExternalData.TaxParameters.NalType;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalPeriod) == V_STRING) and (ExternalData.TaxParameters.NalPeriod != "") )
      r_paypdoccp.NalPeriod = ExternalData.TaxParameters.NalPeriod;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalDocNumber) == V_STRING) and (ExternalData.TaxParameters.NalDocNumber != "") )
      r_paypdoccp.NalDocNumber = ExternalData.TaxParameters.NalDocNumber;
    end;
    if ( (ValType(ExternalData.TaxParameters.NalDocDate) == V_DATE) and (ExternalData.TaxParameters.NalDocDate != Date(0,0,0)) )
      r_paypdoccp.NalDocDate = ExternalData.TaxParameters.NalDocDate;
    end;
    if ( (ValType(ExternalData.TaxParameters.ChargeID) == V_STRING) and (ExternalData.TaxParameters.ChargeID != "") )
      r_paypdoccp.ChargeID = ExternalData.TaxParameters.ChargeID;
    end;
    if ( (ValType(ExternalData.TaxParameters.DocIndex) == V_STRING) and (ExternalData.TaxParameters.DocIndex != "") )
      r_paypdoccp.DocIndex = ExternalData.TaxParameters.DocIndex;
    end;
    if ( (ValType(ExternalData.TaxParameters.PersonID) == V_STRING) and (ExternalData.TaxParameters.PersonID != "") )
      r_paypdoccp.PersonID = ExternalData.TaxParameters.PersonID;
    end;
    if ( (ValType(ExternalData.TaxParameters.Comment) == V_STRING) and (ExternalData.TaxParameters.Comment != "") )
      r_paypdoccp.NalAssignment = substr(ExternalData.TaxParameters.Comment,1,2);
    end;
  end;

  if ( ExternalData.ZHKHData != null )

    if ( (ValType(ExternalData.ZHKHData.CPAccount) == V_STRING) and (ExternalData.ZHKHData.CPAccount != "") )
      if ( (ValType(ExternalData.Recipient.CPAccount) == V_STRING) and (ExternalData.Recipient.CPAccount != "") and 
           (ExternalData.Recipient.CPAccount != ExternalData.ZHKHData.CPAccount) )
        RunError( ErrMessage( 16544 ), 16544 );
      else
        r_paypdoccp.CPAccount = ExternalData.ZHKHData.CPAccount;
      end;
    else
      ExternalData.ZHKHData.CPAccount = ExternalData.Recipient.CPAccount;
    end;

    checkZHKHData( ExternalData.ZHKHData );

    r_paypdoccp.IsForGIS = "X";
    r_paypdoccp.Status = 1;

    if ( (ValType(ExternalData.ZHKHData.SupplierID) == V_STRING) and (ExternalData.ZHKHData.SupplierID != "") )
      r_paypdoccp.PersonID = ExternalData.ZHKHData.SupplierID;
    else
      var clientList = TClientList;
      if ( clientList.GetRecord( r_sbdepdoc.CodClient ) )
        if ( ( clientList.CurRec.rec.PaperSeries != "" ) or ( clientList.CurRec.rec.PaperNumber != "" ) )
          r_paypdoccp.PersonID = MakePersonId( clientList.CurRec.rec.PaperKind, clientList.CurRec.rec.PaperSeries, clientList.CurRec.rec.PaperNumber );
        else
          r_paypdoccp.PersonID = "0000000000000000000000000";
        end;
      end;
    end;

    // Если задано поле RecINN, то брать его в качестве ИНН исполнителя
    if ( (ValType(ExternalData.ZHKHData.RecINN) == V_STRING) and (ExternalData.ZHKHData.RecINN != "") )
      r_paypdoccp.SupplierINN = ExternalData.ZHKHData.RecINN;
    // Если хотя бы один из параметров исполнителя платежа заполнен, то требуется обязательное заполнение поля RecINN
    elif ( ( (ValType(ExternalData.ZHKHData.RecKPP) == V_STRING) and (ExternalData.ZHKHData.RecKPP != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecSurname) == V_STRING) and (ExternalData.ZHKHData.RecSurname != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecFirstName) == V_STRING) and (ExternalData.ZHKHData.RecFirstName != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecPatronymic) == V_STRING) and (ExternalData.ZHKHData.RecPatronymic != "") ) or
           ( (ValType(ExternalData.ZHKHData.RecName) == V_STRING) and (ExternalData.ZHKHData.RecName != "") ) )
      RunError( ErrMessage( 16504 ), 16504 );
    // Иначе брать ИНН получателя платежа в качестве ИНН исполнителя
    else
      r_paypdoccp.SupplierINN = rslString(rs_findRecip.value("T_INN"));
    end;

    if ( (ValType(ExternalData.ZHKHData.RecKPP) == V_STRING) and (ExternalData.ZHKHData.RecKPP != "") )
      r_paypdoccp.SupplierKPP = ExternalData.ZHKHData.RecKPP;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecSurname) == V_STRING) and (ExternalData.ZHKHData.RecSurname != "") )
      r_paypdoccp.SupplierName1 = ExternalData.ZHKHData.RecSurname;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecFirstName) == V_STRING) and (ExternalData.ZHKHData.RecFirstName != "") )
      r_paypdoccp.SupplierName2 = ExternalData.ZHKHData.RecFirstName;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecPatronymic) == V_STRING) and (ExternalData.ZHKHData.RecPatronymic != "") )
      r_paypdoccp.SupplierName3 = ExternalData.ZHKHData.RecPatronymic;
    end;
    if ( (ValType(ExternalData.ZHKHData.RecName) == V_STRING) and (ExternalData.ZHKHData.RecName != "") )
      r_paypdoccp.SupplierShortName = ExternalData.ZHKHData.RecName;
    end;
    if ( (ValType(ExternalData.ZHKHData.PaymentDocumentNumber) == V_STRING) and (ExternalData.ZHKHData.PaymentDocumentNumber != "") )
      r_paypdoccp.PaymentDocumentNumber = ExternalData.ZHKHData.PaymentDocumentNumber;
    end;
    if ( (ValType(ExternalData.ZHKHData.PaymentDocumentID) == V_STRING) and (ExternalData.ZHKHData.PaymentDocumentID != "") )
      r_paypdoccp.GISDocNumber = ExternalData.ZHKHData.PaymentDocumentID;
    end;
    if ( ValType(ExternalData.ZHKHData.Year) == V_INTEGER )
      r_paypdoccp.Year = ExternalData.ZHKHData.Year;
    end; 
    if ( ValType(ExternalData.ZHKHData.Month) == V_INTEGER )
      r_paypdoccp.Month = ExternalData.ZHKHData.Month;
    end; 
    if ( (ValType(ExternalData.ZHKHData.UnifiedAccountNumber) == V_STRING) and (ExternalData.ZHKHData.UnifiedAccountNumber != "") )
      r_paypdoccp.PayerId = ExternalData.ZHKHData.UnifiedAccountNumber;
    end;
    if ( (ValType(ExternalData.ZHKHData.ServiceID) == V_STRING) and (ExternalData.ZHKHData.ServiceID != "") )
      r_paypdoccp.ServiceId = ExternalData.ZHKHData.ServiceID;
    end;
    if ( (ValType(ExternalData.ZHKHData.FIASHouseGuid) == V_STRING) and (ExternalData.ZHKHData.FIASHouseGuid != "") )
      r_paypdoccp.HouseId = ExternalData.ZHKHData.FIASHouseGuid;
    end;
    if ( (ValType(ExternalData.ZHKHData.Apartment) == V_STRING) and (ExternalData.ZHKHData.Apartment != "") )
      r_paypdoccp.FlatId = ExternalData.ZHKHData.Apartment;
    end;
    if ( (ValType(ExternalData.ZHKHData.Placement) == V_STRING) and (ExternalData.ZHKHData.Placement != "") )
      r_paypdoccp.RoomId = ExternalData.ZHKHData.Placement;
    end;
    if ( ValType(ExternalData.ZHKHData.IsNonLiving) == V_BOOL )
      if ( ExternalData.ZHKHData.IsNonLiving )
        r_paypdoccp.NonLiving = "X";
      else
        r_paypdoccp.NonLiving = "";
      end;
    end;
    if ( (ValType(ExternalData.ZHKHData.Surname) == V_STRING) and (ExternalData.ZHKHData.Surname != "") )
      r_paypdoccp.ConsumerSurname = ExternalData.ZHKHData.Surname;
    end;
    if ( (ValType(ExternalData.ZHKHData.FirstName) == V_STRING) and (ExternalData.ZHKHData.FirstName != "") )
      r_paypdoccp.ConsumerFirstName = ExternalData.ZHKHData.FirstName;
    end;
    if ( (ValType(ExternalData.ZHKHData.Patronymic) == V_STRING) and (ExternalData.ZHKHData.Patronymic != "") )
      r_paypdoccp.ConsumerPatronymic = ExternalData.ZHKHData.Patronymic;
    end;
    if ( (ValType(ExternalData.ZHKHData.INN) == V_STRING) and (ExternalData.ZHKHData.INN != "") )
//      r_paypdoccp.ConsumerINN = ExternalData.ZHKHData.INN; // нет поля ConsumerINN в таблице
    end;
  end;

  var AttrValue = "";
  if ( ExternalData.AuxInfo.size > 0 )
    var i = 0;
    for (i,0,ExternalData.AuxInfo.size-1)
      AttrValue = AttrValue + string(ExternalData.AuxInfo[i].Code) + "=" + string(ExternalData.AuxInfo[i].Value)
    end;
  end;
  
  OpenDepFiles;
  var oldBatchMode = setbatchmode(true);
  AddStackGuard();
  var stat = CP_Carry(r_sbdepdoc, r_paypdoccp, pmnt_prop, AttrValue);
  setbatchmode(oldBatchMode);
  var errstackmes: string = "";
  var errstackerr: integer = GetErrorMessage(errstackmes);
  RemoveStackGuard();
  if (stat > 0)
    if ( errstackmes != "" )
      errstackmes = SubStr( (ErrMessage( stat ) + "|" + StrSubst (errstackmes , ErrMessage( stat ), "")), 1 , 241 );
      RunError( errstackmes , stat );
    else
    RunError( ErrMessage( stat ), stat );
  end;
  end;

  if ( r_paypdoccp.IsForGIS == "X" )
    SendOneZKHToGIS(r_sbdepdoc.iApplicationKind, r_sbdepdoc.ApplicationKey);
  end;

  OpData.ComissionOut.Sum = RetrieveValue("Operation:Сумма@Комиссия");
  OpData.ComissionOut.Currency = RetrieveValue("Operation:Валюта@Комиссия");
  OpData.OperSubType = RetrieveValue("Operation:ВидСписания@Комиссия");
  OpData.Account = RetrieveValue("Operation:Счет@Комиссия");

  InterDesk_EndDocBunch();

  var retVal : TOperationResult;
  retVal.OperationID = r_sbdepdoc.ApplicationKey;
  retVal.OperDate = r_sbdepdoc.Date_Document;
  var rs_Cur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  retVal.SumOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.SumIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));

  retVal.SumIn.Sum = ExternalData.OperData.Sum.Sum;
  retVal.ComissionOut.Sum =  OpData.ComissionOut.Sum;
  retVal.SumOut.Sum = retVal.ComissionOut.Sum + ExternalData.OperData.Sum.Sum;
  retVal.ComissionIn.Sum = $0L;

  var findDocID = rsdcommand("select * from drtdocument_dbt where T_OPAPPLICATIONKEY = :appkey and T_OPAPPLICATIONKIND = :appkind");
  findDocID.AddParam("appkey", RSDBP_IN, r_sbdepdoc.ApplicationKey);
  findDocID.AddParam("appkind", RSDBP_IN, r_sbdepdoc.iApplicationKind);
  findDocID.nullConversion = true;
  findDocID.execute();
  var rs_findDocID = RsdRecordset(findDocID);
  while ( rs_findDocID.moveNext() )
    retVal.DocumentIDs[retVal.DocumentIDs.size] = rs_findDocID.value("T_DOCUMENTID");
  end;

  retVal.Rate.Kind = 1;
  retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.BaseSum.Sum = $1;
  retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.WorkSum.Sum = $1;

  return retVal;

end;

/**************************************************************************\
|                     ИНФОРМАЦИЯ О СЧЕТЕ                                   |
\**************************************************************************/
macro AccountInfo ( ExternalData )

  if ((ValType(ExternalData.InfoType) != V_STRING) or (ExternalData.InfoType == ""))
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  var i = 1;
  while ( i <= StrLen( ExternalData.InfoType ) )
    if ( SubStr( ExternalData.InfoType, i, 1 ) == "F" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "I" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "S" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "C" )
      ;
    else
      RunError( ErrMessage( 16509 ), 16509 );
    end;

    i = i + 1;
  end;
  var InteractType;
  if ((ValType(ExternalData.InteractType) != V_INTEGER) or ((ExternalData.InteractType < 0) and  (ExternalData.InteractType > 2)))
    InteractType = 1;
  else
    InteractType = ExternalData.InteractType;
  end;

  var num = ExternalData.Accounts.size;
  var retVal = TArray;
  for ( i, 0, num-1 )
    var Account;
    var AccountData = TAccountData, FinInfo = TAccFinData, PersonInfo = TArray;

    var findParam : FindObjParm;
    findParam.Currency = null;
    findParam.IsFindMCD = false;
    findParam.FindOKCard = false;
    findParam.FindWithFncash = true;
    var fndstat = findOpenAccount ( Account, ExternalData.Accounts[i], findParam );
    if ( fndstat == 16529 )
      RunError( ErrMessage( 16511 ), 16511 );
    elif ((fndstat) and (fndstat != 16512) )
      RunError( ErrMessage( fndstat ), fndstat );
    end;

    var findcontract = rsdcommand("SELECT * FROM drt_contract_dbt WHERE T_NUMBER = ? AND T_BRANCH = ?");
    findcontract.AddParam ("Number",RSDBP_IN,Account.value("T_SVODACCOUNT"));
    findcontract.AddParam ("branch",RSDBP_IN,Account.value("T_FNCASH"));
    findcontract.nullConversion = true;
    findcontract.execute();
    var rs_findcontract = RsdRecordset(findcontract);
    rs_findcontract.moveNext();

    if ( (StrBrk(ExternalData.InfoType, "I") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      var findparty = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = (SELECT T_PARTYID FROM ddp_dep_dbt WHERE T_CODE = ?)");
      findparty.AddParam ("id",RSDBP_IN,Account.value("T_FNCASH"));
      findparty.nullConversion = true;
      findparty.execute();
      var rs_findparty = RsdRecordset(findparty);
      rs_findparty.moveNext();

      var isSysNumbCred = true, isSysNumbDeb = true;
      var findtypOp = rsdcommand("SELECT * FROM dsb_typop_dbt WHERE T_KIND = ?");
      findtypOp.AddParam ("kind",RSDBP_IN,Account.value("T_TYPE_ACCOUNT"));
      findtypOp.nullConversion = true;
      findtypOp.execute();
      var rs_findtypOp = RsdRecordset(findtypOp);
      while ( rs_findtypOp.moveNext() )
        if ((InteractType == 2) or (InteractType == 0))
          if ( ( rs_findtypOp.value("T_NUMOPERT") == 3 ) and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbCred = false;
          end;
        end;
        if ((InteractType == 1) or (InteractType == 0))
          if ( ( rs_findtypOp.value("T_NUMOPERT") == 73 ) and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbCred = false;
          end;
        end;
        if ((InteractType == 2) or (InteractType == 0))
          if ( ( rs_findtypOp.value("T_NUMOPERT") == 4 ) and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbDeb = false;
          end;
        end;
        if ((InteractType == 1) or (InteractType == 0))
          if ( ( (rs_findtypOp.value("T_NUMOPERT") == 62) or (rs_findtypOp.value("T_NUMOPERT") == 63) or (rs_findtypOp.value("T_NUMOPERT") == 64)
                or (rs_findtypOp.value("T_NUMOPERT") == 65) or (rs_findtypOp.value("T_NUMOPERT") == 66) or (rs_findtypOp.value("T_NUMOPERT") == 67)
                or (rs_findtypOp.value("T_NUMOPERT") == 80) or (rs_findtypOp.value("T_NUMOPERT") == 84) or (rs_findtypOp.value("T_NUMOPERT") == 87) )
               and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbDeb = false;
          end;
        end;
      end;

      var rs_findCur = FindCurrency(FINDCURBYCODE_CUR, Account.value("T_CODE_CURRENCY"));

      var findpersn = rsdcommand("SELECT * FROM dpersn_dbt WHERE T_PERSONID = ?");
      findpersn.AddParam("clntcode",RSDBP_IN,Account.value("T_CODCLIENT"));
      findpersn.nullConversion = true;
      findpersn.execute();
      var rs_findpersn = RsdRecordset(findpersn);
      rs_findpersn.moveNext();

      AccountData.Currency = RetKernelNatISO(convertNullStr(rs_findCur.value("T_EXTERNALCODE")));
      AccountData.AccNumber = SubStr(convertNullStr(Account.value("T_ACCOUNT")),1,20);
      AccountData.UserType = convertNullStr(Account.value("T_USERTYPEACCOUNT"));
      AccountData.DateOpen = convertNullDate(Account.value("T_OPEN_DATE"));
      if ( SQL_ConvTypeDate(Account.value("T_CLOSE_DATE")) == Date(0,0,0) )
        AccountData.DateClose = date(0,0,0);
      else
        AccountData.DateClose = convertNullDate(Account.value("T_CLOSE_DATE"));
      end;
      if ( ( (Account.value("t_open_close") == strfor(0)) and ((Account.value("t_action") != 2) and (Account.value("t_action") != 11)) )
       and ( (StrBrk(Account.value("T_USERTYPEACCOUNT"), "Т") == 0) and (StrBrk(Account.value("T_USERTYPEACCOUNT"), "И") == 0) and (not isSysNumbDeb) ) )
        AccountData.isDebitAllowed = true;
      else
        AccountData.isDebitAllowed = false;
      end;
      if ( ( (Account.value("t_open_close") == strfor(0)) and ((Account.value("t_action") != 2) and (Account.value("t_action") != 11)) )
         and (not isSysNumbCred) and (StrBrk(Account.value("T_USERTYPEACCOUNT"), "И") == 0) )
        AccountData.isCreditAllowed = true;
      else
        AccountData.isCreditAllowed = false;
      end;
      if ( (Account.value("t_open_close") == strfor(0)) and ((Account.value("t_action") != 2) and (Account.value("t_action") != 11)) )
        AccountData.isOpen = true;
      else
        AccountData.isOpen = false;
      end;

      var BlockCardAcc = false;
      if ( StrBrk("К", Account.value("t_UserTypeAccount")) != 0 )
        var IsBlockAcc = rsdcommand("select * from dscacc_dbt scacc where SCACC.T_REFERENC = ? and SCACC.T_CARDACCSTATECODE in (select t_codcode from dsccodif_dbt "
                                    " where t_codtype = 2 and (t_psref in (0, SCACC.t_psref) and t_codcode = :state or t_similarcodcode = :state))");
        IsBlockAcc.AddParam("Referenc",RSDBP_IN,Account.value("T_REFERENC"));
        IsBlockAcc.AddParam("state",RSDBP_IN,VAccState_NA);
        IsBlockAcc.nullConversion = true;
        IsBlockAcc.execute();
        var rs_IsBlockAcc = RsdRecordset(IsBlockAcc);
        if (rs_IsBlockAcc.moveNext)
          BlockCardAcc = true;
        end;
      end;

      if ( (Account.value("t_open_close") == "З")
           or (SQL_ConvTypeDate(rs_findpersn.value("t_death"))>Date(0,0,0)) 
           or ((StrBrk(Account.value("T_USERTYPEACCOUNT"), "Т") != 0) or (StrBrk(Account.value("T_USERTYPEACCOUNT"), "И") != 0))
           or ( BlockCardAcc ) )
        AccountData.IsBlocked = true;
      else
        AccountData.IsBlocked = false;
      end;
    end;

    if ( (StrBrk(ExternalData.InfoType, "S") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      var findLastOp = rsdcommand("SELECT * FROM dsbdepdoc_dbt " + 
                                  "WHERE T_REFERENC = ? " + 
                                    "AND T_TYPEOPER not in ( 38, 39 ) " +
                                    "AND T_ACTION not in ( 2, 11 ) " + // D_DELETE и D_STORN
                                    "AND T_KINDOP not in ( 8, 9, 14, 15, 16 ) " +
                                    "AND T_MODE <> 2 AND bitand( T_FLAGS, 131072 ) = 0 " + // MODE_EOY_PRECALC документ предварительного расчета и BIT_FLAG_HIDDEN
                                  "ORDER BY T_DATE_DOCUMENT DESC, T_NUMDAYDOC DESC");
      findLastOp.AddParam ("Ref",RSDBP_IN,Account.value("T_REFERENC"));
      findLastOp.nullConversion = true;
      findLastOp.execute();
      var rs_findLastOp = RsdRecordset(findLastOp);


      var findCredID = rsdcommand("SELECT cardcon.* FROM drt_contract_dbt con, ddepositr_dbt dep, drtcardcontract_dbt cardcon "
                                  " WHERE CARDCON.T_BRANCH = CON.T_BRANCH AND DEP.T_FNCASH = CON.T_BRANCH AND CON.T_ID = CARDCON.T_DEPRCNTRID "
                                  " and CON.T_NUMBER = DEP.T_SVODACCOUNT AND DEP.T_REFERENC = ?");
      findCredID.AddParam ("Ref",RSDBP_IN,Account.value("T_REFERENC"));
      findCredID.nullConversion = true;
      findCredID.execute();
      var rs_findCredID = RsdRecordset(findCredID);
      if ( not rs_findCredID.moveNext() )
        FinInfo.CreditContractID = "";
      else
        FinInfo.CreditContractID = convertNullStr(rs_findCredID.value("T_CREDITCNTRID"));
      end;

      if ( StrBrk(Account.value("T_USERTYPEACCOUNT"), "О") != 0 )
        FinInfo.IsOverdraftAllowed = true;
      else
        FinInfo.IsOverdraftAllowed = false;
      end;

      FinInfo.Rest = Account.value("T_SUM_REST");

      var arrestedSum = GetArrestedSum(Account.value("T_REFERENC"), NumFNcash(), {curdate}, time(), Date(0,0,0));

      var findSCAcc = rsdcommand("SELECT * FROM dscacc_dbt WHERE T_REFERENC = ?");
      findSCAcc.AddParam ("Ref",RSDBP_IN,Account.value("T_REFERENC"));
      findSCAcc.nullConversion = true;
      findSCAcc.execute();
      var rs_findSCAcc = RsdRecordset(findSCAcc);
      if ( rs_findSCAcc.moveNext() )
        FinInfo.Available = Account.value("T_SUM_REST") - arrestedSum - rs_findSCAcc.value("T_BLOCKSUM");
      else
        FinInfo.Available = Account.value("T_SUM_REST") - arrestedSum;
      end;
      if (FinInfo.Available < 0)
        FinInfo.Available = $0;
      end;

      if (rs_findLastOp.moveNext())
        FinInfo.LastOperDate = convertNullDate(rs_findLastOp.value("T_DATE_DOCUMENT"));
      else
        FinInfo.LastOperDate = Date(0,0,0);
      end;
    end;

    if ( (StrBrk(ExternalData.InfoType, "C") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )

      var AccOwner = TAccPersonData;
      AccOwner.Part = "ВЛД";
      AccOwner.Client = Account.value("T_CODCLIENT");
      PersonInfo[PersonInfo.size] = AccOwner;
/*
      var AccPayer = TAccPersonData;
      AccPayer.Part = "ВНС";
      AccPayer.Client = Account.value("T_OPENCLIENT");
      PersonInfo[PersonInfo.size] = AccPayer;
*/
      var findtrast = rsdcommand("SELECT trast.* FROM dsbtrast_dbt trast WHERE TRAST.T_FNCASH = ? AND TRAST.T_REFERENC = ?");
      findtrast.AddParam ("fncash",RSDBP_IN,rs_findcontract.value("T_BRANCH"));
      findtrast.AddParam ("id",RSDBP_IN,rs_findcontract.value("T_ID"));
      findtrast.nullConversion = true;
      findtrast.execute();
      var rs_findtrast = RsdRecordset(findtrast);
      while ( rs_findtrast.moveNext() )
        var clntTrast = TAccPersonData;
        if ( (rs_findtrast.value("T_VIDDOC") == StrFor( 0 )) and (rs_findtrast.value("T_TYPE") == ACCOUTN_PROXY) )
          clntTrast.Part = "ДВЛ";
          clntTrast.Client = convertNullInt( rs_findtrast.value("T_CODCLIENT") );
        elif ( (rs_findtrast.value("T_VIDDOC") == StrFor(1)) or (rs_findtrast.value("T_VIDDOC") == StrFor(2)) or 
               (rs_findtrast.value("T_TYPE") == ACCOUTN_HEIR) or (rs_findtrast.value("T_TYPE") == ACCOUTN_HEIR_PAY) )
          clntTrast.Part = "НСЛ";
          clntTrast.Client = convertNullInt( rs_findtrast.value("T_CODCLIENT") );
        elif ( (rs_findtrast.value("T_VIDDOC") == StrFor( 0 )) and (rs_findtrast.value("T_TYPE") == ACCOUNT_TUTOR) )
          clntTrast.Part = "ОПК";
          clntTrast.Client = convertNullInt( rs_findtrast.value("T_CODCLIENT") );
        elif ( (rs_findtrast.value("T_VIDDOC") == StrFor( 0 )) and (rs_findtrast.value("T_TYPE") == ACCOUNT_IMPORTER) )
          clntTrast.Part = "ВНС";
          clntTrast.Client = convertNullInt( rs_findtrast.value("T_CODCLIENT") );
        else
          clntTrast.Part = "";
          clntTrast.Client = convertNullInt( rs_findtrast.value("T_CODCLIENT") );
        end;
        PersonInfo[PersonInfo.size] = clntTrast;
      end;
    end;
    var res = TAccRes;
    res.AccountID = string(Account.value("T_REFERENC"));

    res.Contract.ID = string(rs_findcontract.value("T_BRANCH"))+"/"+string(rs_findcontract.value("T_ID"));
    res.Contract.Number = rs_findcontract.value("T_NUMBER");
    res.Contract.OpenDate = rs_findcontract.value("T_OPENDATE");

    res.AccountData = AccountData;
    res.FinInfo = FinInfo;
    res.PersonInfo = PersonInfo;
    retVal[retVal.size] = res;
  end;

  return retVal;
end;

/**************************************************************************\
|                     ИНФОРМАЦИЯ О ВКЛАДЕ                                  |
\**************************************************************************/
macro DepositInfo ( ExternalData )

  if ((ValType(ExternalData.InfoType) != V_STRING) or (ExternalData.InfoType == ""))
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  var i = 1;
  while ( i <= StrLen( ExternalData.InfoType ) )
    if ( SubStr( ExternalData.InfoType, i, 1 ) == "F" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "I" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "S" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "C" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "A" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "P" )
      ;
    else
      RunError( ErrMessage( 16509 ), 16509 );
    end;

    i = i + 1;
  end;
  if ((ValType(ExternalData.InteractType) != V_INTEGER) or ((ExternalData.InteractType < 0) and  (ExternalData.InteractType > 2)))
    ExternalData.InteractType = 1;
  end;

   record alg (pc_alg);
  var num = ExternalData.Deposits.size;
  var retVal = TArray;
  for ( i, 0, num-1 )
    var Contract;
    var ResContract = TDIRes;
    var fndstat = findAnyContract ( Contract, ExternalData.Deposits[i] );
    if ((fndstat))
      RunError( ErrMessage( fndstat ), fndstat );
    end;

    var fndDepCon = rsdcommand("SELECT * FROM drtdepcontract_dbt WHERE T_BRANCH = ? AND T_ID = ?");
    fndDepCon.AddParam("branch",RSDBP_IN,Contract.value("T_BRANCH"));
    fndDepCon.AddParam("id",RSDBP_IN,Contract.value("T_ID"));
    fndDepCon.nullConversion = true;
    fndDepCon.execute();
    var rs_fndDepCon = RsdRecordset(fndDepCon);
    rs_fndDepCon.moveNext();

    var ConFlag = 0;
    if ( not rs_fndDepCon.value("T_CURRCODE") )
      ConFlag = 0;
    else
      ConFlag = 1;
    end;

    var fndType = rsdcommand("SELECT * FROM dsb_dtyp_dbt WHERE T_KIND = ? AND T_FLAGCUR = ?");
    fndType.AddParam("kind",RSDBP_IN,rs_fndDepCon.value("T_ACCOUNTTYPE"));
    fndType.AddParam("flag",RSDBP_IN,ConFlag);
    fndType.nullConversion = true;
    fndType.execute();
    var rs_fndType = RsdRecordset(fndType);
    rs_fndType.moveNext();

    var findBaseAcc, rs_findBaseAcc;
    if ( rs_fndType.value("T_MCTYPE") != 0 )
      findBaseAcc = RsdCommand("SELECT dep.* FROM ddepositr_dbt dep, drt_contract_dbt con, dsb_dtcurr_dbt curr "
                                   " WHERE DEP.T_SVODACCOUNT = CON.T_NUMBER AND DEP.T_FNCASH = CON.T_BRANCH AND CURR.T_KIND = DEP.T_TYPE_ACCOUNT "
                                   " AND CURR.T_ISBASECURRENCY <> CHR (0) AND CON.T_NUMBER = ? AND CON.T_BRANCH = ? ORDER BY DEP.T_CLOSE_DATE ASC");
      findBaseAcc.AddParam("Number",RSDBP_IN,Contract.value("T_NUMBER"));
      findBaseAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      findBaseAcc.nullConversion = true;
      findBaseAcc.execute();
      rs_findBaseAcc = rsdRecordSet(findBaseAcc);
      if ( rs_findBaseAcc.moveNext() )
        if ( (rs_findBaseAcc.value("t_open_close") != strfor(0))
             or ((rs_findBaseAcc.value("t_action") == 2) or (rs_findBaseAcc.value("t_action") == 11)) )
          rs_findBaseAcc.moveLast();
        end;
      else
        RunError( ErrMessage( 16511 ), 16511 );
      end;
    else
      findBaseAcc = rsdcommand("SELECT dep.* FROM ddepositr_dbt dep, drt_contract_dbt con, drtdepcontract_dbt depcon WHERE DEP.T_SVODACCOUNT = CON.T_NUMBER "
                               " AND DEP.T_FNCASH = CON.T_BRANCH AND DEP.T_TYPE_ACCOUNT = DEPCON.T_ACCOUNTTYPE AND DEPCON.T_BRANCH = CON.T_BRANCH"
                               " AND DEPCON.T_ID = CON.T_ID AND CON.T_NUMBER = ? AND CON.T_BRANCH = ? ORDER BY DEP.T_CLOSE_DATE ASC");
      findBaseAcc.AddParam("svodAcc",RSDBP_IN,Contract.value("T_NUMBER"));
      findBaseAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      findBaseAcc.nullConversion = true;
      findBaseAcc.execute();
      rs_findBaseAcc = rsdRecordSet(findBaseAcc);
      if ( rs_findBaseAcc.moveNext() )
        if ( (rs_findBaseAcc.value("t_open_close") != strfor(0))
             or ((rs_findBaseAcc.value("t_action") == 2) or (rs_findBaseAcc.value("t_action") == 11)) )
          rs_findBaseAcc.moveLast();
        end;
      else
        RunError( ErrMessage( 16511 ), 16511 );
      end;
    end;

    if ( (StrBrk(ExternalData.InfoType, "I") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      ResContract.DepositData.Kind = rs_fndType.value("T_KIND");
      ResContract.DepositData.KindName = rs_fndType.value("T_NAME");

      if ( rs_fndType.value("T_MCTYPE") == 0 )
        var rs_findCurCon = FindCurrency(FINDCURBYCODE_CUR, rs_findBaseAcc.value("T_CODE_CURRENCY"));
        ResContract.DepositData.Currency = RetKernelNatISO(rs_findCurCon.value("T_EXTERNALCODE"));
      else
        ResContract.DepositData.Currency = "0";
      end;

      ResContract.DepositData.StartDate = SQL_ConvTypeDate(rs_findBaseAcc.value("T_PROL_DATEDEP"));
      if (ResContract.DepositData.StartDate == date(0,0,0))
        ResContract.DepositData.StartDate = SQL_ConvTypeDate(Contract.value("T_OPENDATE"));
      end;
      ResContract.DepositData.ProlDate = SQL_ConvTypeDate(rs_findBaseAcc.value("T_PROL_DATEDEP")) - 1;
      ResContract.DepositData.EndDate = SQL_ConvTypeDate(rs_findBaseAcc.value("T_END_DATEDEP"));
      ResContract.DepositData.CloseDate = SQL_ConvTypeDate(rs_findBaseAcc.value("T_CLOSE_DATE"));

      var fndBranchName = rsdcommand("SELECT * FROM ddp_dep_dbt WHERE T_CODE = ?");
      fndBranchName.AddParam("code",RSDBP_IN,Contract.value("T_BRANCH"));
      fndBranchName.nullConversion = true;
      fndBranchName.execute();
      var rs_fndBranchName = RsdRecordset(fndBranchName);
      rs_fndBranchName.moveNext();
      ResContract.DepositData.Branch = rs_fndBranchName.value("T_NAME");


      if ( Contract.value("T_STATE") == 10 )
        ResContract.DepositData.IsClosed = false;
      else
        ResContract.DepositData.IsClosed = true;
      end;
      ResContract.DepositData.Number = Contract.value("T_NUMBER");
      ResContract.DepositData.OpenDate = SQL_ConvTypeDate(Contract.value("T_OPENDATE"));

      if (ResContract.DepositData.IsClosed )
        ResContract.DepositData.IsProlonging = false;
      elif (rs_fndType.value("T_FORMCONTR") < 30)
        ResContract.DepositData.IsProlonging = false;
      elif ( rs_findBaseAcc.value("T_USEALTERNATE") != 0 )
        ResContract.DepositData.IsProlonging = false;
      elif ( SQL_ConvTypeDate(rs_findBaseAcc.value("T_END_DATEDEP")) == Date(0,0,0) )
        ResContract.DepositData.IsProlonging = false;
      else
        ResContract.DepositData.IsProlonging = true;
      end;

      if ( ResContract.DepositData.IsClosed == false )
        if ( rs_fndType.value("T_MCTYPE") != 0 )
          var fndAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_SVODACCOUNT = ? AND T_FNCASH = ? AND T_OPEN_CLOSE = CHR (0) AND T_ACTION <> 2 AND T_ACTION <> 11");
          fndAcc.AddParam("svodAcc",RSDBP_IN,Contract.value("T_NUMBER"));
          fndAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
          fndAcc.nullConversion = true;
          fndAcc.execute();
          var rs_fndAcc = rsdRecordSet(fndAcc);
          while ( rs_fndAcc.moveNext() )
            if ( rs_fndAcc.value("T_LIMIT") != $0 )
              var LimSum = TMoney;
              var fndLimAcc = FindCurrency(FINDCURBYCODE_CUR, rs_fndAcc.value("T_CODE_CURRENCY"));
              LimSum.Sum = rs_fndAcc.value("T_LIMIT");
              LimSum.Currency = RetKernelNatISO(fndLimAcc.value("T_EXTERNALCODE"));
              ResContract.DepositData.LimSum[ResContract.DepositData.LimSum.size] = LimSum;
            end;
          end;
        else
          if ( rs_findBaseAcc.value("T_LIMIT") != $0 )
            var LimSumOne = TMoney;
            var fndLimCur = FindCurrency(FINDCURBYCODE_CUR, rs_findBaseAcc.value("T_CODE_CURRENCY"));
            LimSumOne.Sum = rs_findBaseAcc.value("T_LIMIT");
            LimSumOne.Currency = RetKernelNatISO(fndLimCur.value("T_EXTERNALCODE"));
            ResContract.DepositData.LimSum[ResContract.DepositData.LimSum.size] = LimSumOne;
          end;
        end;
      end;

      if ( not ResContract.DepositData.IsProlonging );
      else
        var Term_Prol = 0, KindTerm_Prol = 0 ,enddate = 0;
        var prolstat = GetRealTermForDepositor(SQL_ConvTypeDate(rs_findBaseAcc.value("T_END_DATEDEP")), rs_findBaseAcc.value("T_TERM"), string(rs_findBaseAcc.value("T_KINDTERM")),
        rs_fndType.value("T_TERM_PROL"), string(rs_fndType.value("T_KINDTERM_PROL")),
        rs_fndType.value("T_TERM_MAX"),string(rs_fndType.value("T_KINDTERM_PROL")), rs_fndType.value("T_TREATHOLIDAYS"),  Term_Prol, KindTerm_Prol,enddate);
        if( not prolstat )
          ResContract.DepositData.ProlPeriod = enddate - SQL_ConvTypeDate(rs_findBaseAcc.value("T_END_DATEDEP"));
        end;
      end;

      var isSysNumbCred = true, isSysNumbDeb = true;
      var findtypOp = rsdcommand("SELECT * FROM dsb_typop_dbt WHERE T_KIND = ?");
      findtypOp.AddParam ("kind",RSDBP_IN,rs_findBaseAcc.value("T_TYPE_ACCOUNT"));
      findtypOp.nullConversion = true;
      findtypOp.execute();
      var rs_findtypOp = RsdRecordset(findtypOp);
      while ( rs_findtypOp.moveNext() )
        if ((ExternalData.InteractType == 2) or (ExternalData.InteractType == 0))
          if ( ( rs_findtypOp.value("T_NUMOPERT") == 3 ) and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbCred = false;
          end;
        end;
        if ((ExternalData.InteractType == 1) or (ExternalData.InteractType == 0))
          if ( ( rs_findtypOp.value("T_NUMOPERT") == 73 ) and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbCred = false;
          end;
        end;
        if ((ExternalData.InteractType == 2) or (ExternalData.InteractType == 0))
          if ( ( rs_findtypOp.value("T_NUMOPERT") == 4 ) and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbDeb = false;
          end;
        end;
        if ((ExternalData.InteractType == 1) or (ExternalData.InteractType == 0))
          if ( ( (rs_findtypOp.value("T_NUMOPERT") == 62) or (rs_findtypOp.value("T_NUMOPERT") == 63) or (rs_findtypOp.value("T_NUMOPERT") == 64)
                or (rs_findtypOp.value("T_NUMOPERT") == 65) or (rs_findtypOp.value("T_NUMOPERT") == 66) or (rs_findtypOp.value("T_NUMOPERT") == 67)
                or (rs_findtypOp.value("T_NUMOPERT") == 80) or (rs_findtypOp.value("T_NUMOPERT") == 84) or (rs_findtypOp.value("T_NUMOPERT") == 87) )
               and ( rs_findtypOp.value("T_SYSNUMB") == 0 ) )
            isSysNumbDeb = false;
          end;
        end;
      end;

      if (ResContract.DepositData.IsClosed )
        ResContract.DepositData.IsCreditAllowed = false;
      else
        if ( ( (rs_findBaseAcc.value("t_open_close") == strfor(0)) and ((rs_findBaseAcc.value("t_action") != 2) and (rs_findBaseAcc.value("t_action") != 11)) )
           and (not isSysNumbCred) )
          ResContract.DepositData.IsCreditAllowed = true;
        else
          ResContract.DepositData.IsCreditAllowed = false;
        end;
      end;

      var sqlfndMinSum, fndMinSum, rs_fndMinSum;
      var findRealOpKind, rs_findRealOpKind, needfindNextKind = false;
      var findAllAccCur, rs_findAllAccCur, isfindAllAccCur = false ;

      if ( not ResContract.DepositData.IsCreditAllowed )
        ;
     else
        if ( convertNullInt(rs_fndType.value("T_OPFROMOTHERDEPTYPE")) > 0 )
          needfindNextKind = true;
          while ( needfindNextKind )
            findRealOpKind = rsdcommand("SELECT typ.* FROM dpc_apltp_dbt apl, dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = APL.T_ISCUR AND TYP.T_KIND = APL.T_APTYPE "
                                        " AND APL.T_TYPEREC = 1003 AND APL.T_APPLTYPE = 3010 AND APL.T_ISCUR = ? AND APL.T_TYPE = ?");
            findRealOpKind.AddParam ("isCur",RSDBP_IN,rs_fndType.value("T_FLAGCUR"));
            findRealOpKind.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
            findRealOpKind.nullConversion = true;
            findRealOpKind.execute();
            rs_findRealOpKind = RsdRecordset(findRealOpKind);
            if ( rs_findRealOpKind.moveNext )
              if ( convertNullInt(rs_findRealOpKind.value("T_OPFROMOTHERDEPTYPE")) == 0 )
                needfindNextKind = false;
              end;
            else
              RunError( ErrMessage( 16513 ), 16513 );
            end;
          end;
        else
          findRealOpKind = rsdcommand("SELECT typ.* FROM dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = ? AND TYP.T_KIND = ? ");
          findRealOpKind.AddParam ("isCur",RSDBP_IN,rs_fndType.value("T_FLAGCUR"));
          findRealOpKind.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
          findRealOpKind.nullConversion = true;
          findRealOpKind.execute();
          rs_findRealOpKind = RsdRecordset(findRealOpKind);
          if ( not rs_findRealOpKind.moveNext )
            RunError( ErrMessage( 16513 ), 16513 );
          end;
        end;

        findAllAccCur = rsdcommand("SELECT DISTINCT T_CODE_CURRENCY codcur FROM ddepositr_dbt WHERE T_ISCUR = ? AND T_FNCASH = ? AND T_SVODACCOUNT = ? "
                                   " AND T_OPEN_CLOSE = CHR (0) AND T_ACTION <> 2 AND T_ACTION <> 11");
        findAllAccCur.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
        findAllAccCur.AddParam ("fncash",RSDBP_IN,rs_findBaseAcc.value("T_FNCASH"));
        findAllAccCur.AddParam ("svodacc",RSDBP_IN,rs_findBaseAcc.value("T_SVODACCOUNT"));
        findAllAccCur.nullConversion = true;
        findAllAccCur.execute();
        rs_findAllAccCur = RsdRecordset(findAllAccCur);
        if ( rs_findAllAccCur.moveNext )
          isfindAllAccCur = true;
        end;
        
        if ((ExternalData.InteractType == 2))
          sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240, 242) AND T_NUMOPERT IN (3) "
                         " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD ASC";
          fndMinSum = rsdcommand(sqlfndMinSum);
          fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
          fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          fndMinSum.nullConversion = true;
          fndMinSum.execute();
          rs_fndMinSum = RsdRecordset(fndMinSum);
          if ( rs_fndMinSum.moveNext() )
            while (isfindAllAccCur)
              var MinCredCashSum = TMoney;
              MinCredCashSum.Sum = rs_fndMinSum.value("T_PRMD");
              var codCredCash = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
              if ( convertNullStr(codCredCash.value("T_EXTERNALCODE")) == "---" )
                var codCredCashM = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                MinCredCashSum.Currency = RetKernelNatISO(convertNullStr(codCredCashM.value("T_EXTERNALCODE")));
                ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredCashSum;
              else
                MinCredCashSum.Currency = RetKernelNatISO(convertNullStr(codCredCash.value("T_EXTERNALCODE")));
                ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredCashSum;
                break;
              end;
              isfindAllAccCur = rs_findAllAccCur.moveNext;
            end;
          else
            var NullCredCashSum = TMoney;
            NullCredCashSum.Sum = $0;
            NullCredCashSum.Currency = "0";
            ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = NullCredCashSum;
          end;
        elif ((ExternalData.InteractType == 1))
          sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240, 242) AND T_NUMOPERT IN (73) "
                         " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD ASC";
          fndMinSum = rsdcommand(sqlfndMinSum);
          fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
          fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          fndMinSum.nullConversion = true;
          fndMinSum.execute();
          rs_fndMinSum = RsdRecordset(fndMinSum);
          if ( rs_fndMinSum.moveNext() )
            while (isfindAllAccCur)
              var MinCredNoCashSum = TMoney;
              MinCredNoCashSum.Sum = rs_fndMinSum.value("T_PRMD");
              var codCredNoCash = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
              if ( convertNullStr(codCredNoCash.value("T_EXTERNALCODE")) == "---" )
                var codCredNoCashM = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                MinCredNoCashSum.Currency = RetKernelNatISO(convertNullStr(codCredNoCashM.value("T_EXTERNALCODE")));
                ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredNoCashSum;
              else
                MinCredNoCashSum.Currency = RetKernelNatISO(convertNullStr(codCredNoCash.value("T_EXTERNALCODE")));
                ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredNoCashSum;
                break;
              end;
              isfindAllAccCur = rs_findAllAccCur.moveNext;
            end;              
          else
            var NullCredNoCashSum = TMoney;
            NullCredNoCashSum.Sum = $0;
            NullCredNoCashSum.Currency = "0";
            ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = NullCredNoCashSum;
          end;
        elif ((ExternalData.InteractType == 0))
          sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240, 242) AND T_NUMOPERT IN (73,3) "
                         " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD ASC";
          fndMinSum = rsdcommand(sqlfndMinSum);
          fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
          fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          fndMinSum.nullConversion = true;
          fndMinSum.execute();
          rs_fndMinSum = RsdRecordset(fndMinSum);
          if ( rs_fndMinSum.moveNext() )
            while (isfindAllAccCur)
              var MinCredALLSum = TMoney;
              MinCredALLSum.Sum = rs_fndMinSum.value("T_PRMD");
              var codCredALLCash = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
              if ( convertNullStr(codCredALLCash.value("T_EXTERNALCODE")) == "---" )
                var codCredALLCashM = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                MinCredALLSum.Currency = RetKernelNatISO(convertNullStr(codCredALLCashM.value("T_EXTERNALCODE")));
                ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredALLSum;
              else
                MinCredALLSum.Currency = RetKernelNatISO(convertNullStr(codCredALLCash.value("T_EXTERNALCODE")));
                ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredALLSum;
                break;
              end;
              isfindAllAccCur = rs_findAllAccCur.moveNext;
            end;
          else
            var NullCredAllSum = TMoney;
            NullCredAllSum.Sum = $0;
            NullCredAllSum.Currency = "0";
            ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = NullCredAllSum;
          end;
        end;

        if ( rs_fndType.value("T_MCTYPE") != 0 )
          var newCurCred;
          if (rs_fndType.value("T_FLAGCUR") != 0)
            newCurCred = 0;
          else
            newCurCred = 1;
          end;

          needfindNextKind = false;
          isfindAllAccCur = false;
          findRealOpKind = rsdcommand("SELECT typ.* FROM dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = ? AND TYP.T_KIND = ? ");
          findRealOpKind.AddParam ("isCur",RSDBP_IN,newCurCred);
          findRealOpKind.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
          findRealOpKind.nullConversion = true;
          findRealOpKind.execute();
          rs_findRealOpKind = RsdRecordset(findRealOpKind);
          if ( not rs_findRealOpKind.moveNext )
            RunError( ErrMessage( 16513 ), 16513 );
          end;
          if ( convertNullInt(rs_findRealOpKind.value("T_OPFROMOTHERDEPTYPE")) > 0 )
            needfindNextKind = true;
            while ( needfindNextKind )
              findRealOpKind = rsdcommand("SELECT typ.* FROM dpc_apltp_dbt apl, dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = APL.T_ISCUR AND TYP.T_KIND = APL.T_APTYPE "
                                          " AND APL.T_TYPEREC = 1003 AND APL.T_APPLTYPE = 3010 AND APL.T_ISCUR = ? AND APL.T_TYPE = ?");
              findRealOpKind.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
              findRealOpKind.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
              findRealOpKind.nullConversion = true;
              findRealOpKind.execute();
              rs_findRealOpKind = RsdRecordset(findRealOpKind);
              if ( rs_findRealOpKind.moveNext )
                if ( convertNullInt(rs_findRealOpKind.value("T_OPFROMOTHERDEPTYPE")) == 0 )
                  needfindNextKind = false;
                end;
              else
                RunError( ErrMessage( 16513 ), 16513 );
              end;
            end;
          end;

          findAllAccCur = rsdcommand("SELECT DISTINCT T_CODE_CURRENCY codcur FROM ddepositr_dbt WHERE T_ISCUR = ? AND T_FNCASH = ? AND T_SVODACCOUNT = ? "
                                     " AND T_OPEN_CLOSE = CHR (0) AND T_ACTION <> 2 AND T_ACTION <> 11");
          findAllAccCur.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          findAllAccCur.AddParam ("fncash",RSDBP_IN,rs_findBaseAcc.value("T_FNCASH"));
          findAllAccCur.AddParam ("svodacc",RSDBP_IN,rs_findBaseAcc.value("T_SVODACCOUNT"));
          findAllAccCur.nullConversion = true;
          findAllAccCur.execute();
          rs_findAllAccCur = RsdRecordset(findAllAccCur);
          if ( rs_findAllAccCur.moveNext )
            isfindAllAccCur = true;
          end;
          
          if ((ExternalData.InteractType == 2))
            sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240, 242) AND T_NUMOPERT IN (3) "
                           " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD ASC";
            fndMinSum = rsdcommand(sqlfndMinSum);
            fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
            fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
            fndMinSum.nullConversion = true;
            fndMinSum.execute();
            rs_fndMinSum = RsdRecordset(fndMinSum);
            if ( rs_fndMinSum.moveNext() )
              while (isfindAllAccCur)
                var MinCredCashSumM = TMoney;
                MinCredCashSumM.Sum = rs_fndMinSum.value("T_PRMD");
                var codCredCashM2 = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
                if ( convertNullStr(codCredCashM2.value("T_EXTERNALCODE")) == "---" )
                  var codCredCashM3 = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                  MinCredCashSumM.Currency = RetKernelNatISO(convertNullStr(codCredCashM3.value("T_EXTERNALCODE")));
                  ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredCashSumM;
                else
                  MinCredCashSumM.Currency = RetKernelNatISO(convertNullStr(codCredCashM2.value("T_EXTERNALCODE")));
                  ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredCashSumM;
                  break;
                end;
                isfindAllAccCur = rs_findAllAccCur.moveNext;
              end;
            else
              var NullCredCashSumM = TMoney;
              NullCredCashSumM.Sum = $0;
              NullCredCashSumM.Currency = "0";
              ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = NullCredCashSumM;
            end;
          elif ((ExternalData.InteractType == 1))
            sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240, 242) AND T_NUMOPERT IN (73) "
                           " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD ASC";
            fndMinSum = rsdcommand(sqlfndMinSum);
            fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
            fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
            fndMinSum.nullConversion = true;
            fndMinSum.execute();
            rs_fndMinSum = RsdRecordset(fndMinSum);
            if ( rs_fndMinSum.moveNext() )
              while (isfindAllAccCur)
                var MinCredNoCashSumM = TMoney;
                MinCredNoCashSumM.Sum = rs_fndMinSum.value("T_PRMD");
                var codCredNoCashM2 = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
                if ( convertNullStr(codCredNoCashM2.value("T_EXTERNALCODE")) == "---" )
                  var codCredNoCashM3 = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                  MinCredNoCashSumM.Currency = RetKernelNatISO(convertNullStr(codCredNoCashM3.value("T_EXTERNALCODE")));
                  ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredNoCashSumM;
                else
                  MinCredNoCashSumM.Currency = RetKernelNatISO(convertNullStr(codCredNoCashM2.value("T_EXTERNALCODE")));
                  ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredNoCashSumM;
                  break;
                end;
                isfindAllAccCur = rs_findAllAccCur.moveNext;
              end;
            else
              var NullCredNoCashSumM = TMoney;
              NullCredNoCashSumM.Sum = $0;
              NullCredNoCashSumM.Currency = "0";
              ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = NullCredNoCashSumM;
            end;
          elif ((ExternalData.InteractType == 0))
            sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240, 242) AND T_NUMOPERT IN (73,3) "
                           " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD ASC";
            fndMinSum = rsdcommand(sqlfndMinSum);
            fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
            fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
            fndMinSum.nullConversion = true;
            fndMinSum.execute();
            rs_fndMinSum = RsdRecordset(fndMinSum);
            if ( rs_fndMinSum.moveNext() )
              while (isfindAllAccCur)
                var MinCredALLSumM = TMoney;
                MinCredALLSumM.Sum = rs_fndMinSum.value("T_PRMD");
                var codCredALLCashM2 = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
                if ( convertNullStr(codCredALLCashM2.value("T_EXTERNALCODE")) == "---" )
                  var codCredALLCashM3 = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                  MinCredALLSumM.Currency = RetKernelNatISO(convertNullStr(codCredALLCashM3.value("T_EXTERNALCODE")));
                  ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredALLSumM;
                else
                  MinCredALLSumM.Currency = RetKernelNatISO(convertNullStr(codCredALLCashM2.value("T_EXTERNALCODE")));
                  ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = MinCredALLSumM;
                  break;
                end;
                isfindAllAccCur = rs_findAllAccCur.moveNext;
              end;
            else
              var NullCredAllSumM = TMoney;
              NullCredAllSumM.Sum = $0;
              NullCredAllSumM.Currency = "0";
              ResContract.DepositData.CreditLimits[ResContract.DepositData.CreditLimits.size] = NullCredAllSumM;
            end;
          end;
        end;
      end;

      if (ResContract.DepositData.IsClosed )
        ResContract.DepositData.IsDebitAllowed = false;
      else
        if ( ( (rs_findBaseAcc.value("t_open_close") == strfor(0)) and ((rs_findBaseAcc.value("t_action") != 2) and (rs_findBaseAcc.value("t_action") != 11)) )
         and (StrBrk(rs_findBaseAcc.value("T_USERTYPEACCOUNT"), "Т") == 0) and (StrBrk(rs_findBaseAcc.value("T_USERTYPEACCOUNT"), "И") == 0) and (not isSysNumbDeb) )
          ResContract.DepositData.IsDebitAllowed = true;
        else
          ResContract.DepositData.IsDebitAllowed = false;
        end;
      end;

      if ( not ResContract.DepositData.IsDebitAllowed )
        ;
      else
        needfindNextKind = false;
        isfindAllAccCur = false;
        if ( convertNullInt(rs_fndType.value("T_OPFROMOTHERDEPTYPE")) > 0 )
          needfindNextKind = true;
          while ( needfindNextKind )
            findRealOpKind = rsdcommand("SELECT typ.* FROM dpc_apltp_dbt apl, dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = APL.T_ISCUR AND TYP.T_KIND = APL.T_APTYPE "
                                        " AND APL.T_TYPEREC = 1003 AND APL.T_APPLTYPE = 3010 AND APL.T_ISCUR = ? AND APL.T_TYPE = ?");
            findRealOpKind.AddParam ("isCur",RSDBP_IN,rs_fndType.value("T_FLAGCUR"));
            findRealOpKind.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
            findRealOpKind.nullConversion = true;
            findRealOpKind.execute();
            rs_findRealOpKind = RsdRecordset(findRealOpKind);
            if ( rs_findRealOpKind.moveNext )
              if ( convertNullInt(rs_findRealOpKind.value("T_OPFROMOTHERDEPTYPE")) == 0 )
                needfindNextKind = false;
              end;
            else
              RunError( ErrMessage( 16513 ), 16513 );
            end;
          end;
        else
          findRealOpKind = rsdcommand("SELECT typ.* FROM dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = ? AND TYP.T_KIND = ? ");
          findRealOpKind.AddParam ("isCur",RSDBP_IN,rs_fndType.value("T_FLAGCUR"));
          findRealOpKind.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
          findRealOpKind.nullConversion = true;
          findRealOpKind.execute();
          rs_findRealOpKind = RsdRecordset(findRealOpKind);
          if ( not rs_findRealOpKind.moveNext )
            RunError( ErrMessage( 16513 ), 16513 );
          end;
        end;

        findAllAccCur = rsdcommand("SELECT DISTINCT T_CODE_CURRENCY codcur FROM ddepositr_dbt WHERE T_ISCUR = ? AND T_FNCASH = ? AND T_SVODACCOUNT = ? "
                                   " AND T_OPEN_CLOSE = CHR (0) AND T_ACTION <> 2 AND T_ACTION <> 11");
        findAllAccCur.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
        findAllAccCur.AddParam ("fncash",RSDBP_IN,rs_findBaseAcc.value("T_FNCASH"));
        findAllAccCur.AddParam ("svodacc",RSDBP_IN,rs_findBaseAcc.value("T_SVODACCOUNT"));
        findAllAccCur.nullConversion = true;
        findAllAccCur.execute();
        rs_findAllAccCur = RsdRecordset(findAllAccCur);
        if ( rs_findAllAccCur.moveNext )
          isfindAllAccCur = true;
        end;

        if ((ExternalData.InteractType == 2))
          sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240) AND T_NUMOPERT IN (4) "
                         " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD DESC";
          fndMinSum = rsdcommand(sqlfndMinSum);
          fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
          fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          fndMinSum.nullConversion = true;
          fndMinSum.execute();
          rs_fndMinSum = RsdRecordset(fndMinSum);
          if ( rs_fndMinSum.moveNext() )
            while (isfindAllAccCur)
              var MinDebCashSum = TMoney;
              MinDebCashSum.Sum = rs_fndMinSum.value("T_PRMD");
              var codDebCash = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
              if ( convertNullStr(codDebCash.value("T_EXTERNALCODE")) == "---" )
                var codDebCashM = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                MinDebCashSum.Currency = RetKernelNatISO(convertNullStr(codDebCashM.value("T_EXTERNALCODE")));
                ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebCashSum;
              else
                MinDebCashSum.Currency = RetKernelNatISO(convertNullStr(codDebCash.value("T_EXTERNALCODE")));
                ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebCashSum;
                break;
              end;
              isfindAllAccCur = rs_findAllAccCur.moveNext;
            end;
          else
            var NullDebCashSum = TMoney;
            NullDebCashSum.Sum = $0;
            NullDebCashSum.Currency = "0";
            ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = NullDebCashSum;
          end;
        elif ((ExternalData.InteractType == 1))
          sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240) AND T_NUMOPERT IN (62,63,64,65,66,67,80,84,87) "
                         " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD DESC";
          fndMinSum = rsdcommand(sqlfndMinSum);
          fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
          fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          fndMinSum.nullConversion = true;
          fndMinSum.execute();
          rs_fndMinSum = RsdRecordset(fndMinSum);
          if ( rs_fndMinSum.moveNext() )
            while (isfindAllAccCur)
              var MinDebNoCashSum = TMoney;
              MinDebNoCashSum.Sum = rs_fndMinSum.value("T_PRMD");
              var codDebNoCash = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
              if ( convertNullStr(codDebNoCash.value("T_EXTERNALCODE")) == "---" )
                var codDebNoCashM = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                MinDebNoCashSum.Currency = RetKernelNatISO(convertNullStr(codDebNoCashM.value("T_EXTERNALCODE")));
                ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebNoCashSum;
              else
                MinDebNoCashSum.Currency = RetKernelNatISO(convertNullStr(codDebNoCash.value("T_EXTERNALCODE")));
                ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebNoCashSum;
                break;
              end;
              isfindAllAccCur = rs_findAllAccCur.moveNext;
            end;
          else
            var NullDebNoCashSum = TMoney;
            NullDebNoCashSum.Sum = $0;
            NullDebNoCashSum.Currency = "0";
            ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = NullDebNoCashSum;
          end;
        elif ((ExternalData.InteractType == 0))
          sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240) AND T_NUMOPERT IN (4,62,63,64,65,66,67,80,84,87) "
                         " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD DESC";
          fndMinSum = rsdcommand(sqlfndMinSum);
          fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
          fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          fndMinSum.nullConversion = true;
          fndMinSum.execute();
          rs_fndMinSum = RsdRecordset(fndMinSum);
          if ( rs_fndMinSum.moveNext() )
            while (isfindAllAccCur)
              var MinDebALLSum = TMoney;
              MinDebALLSum.Sum = rs_fndMinSum.value("T_PRMD");
              var codDebALLCash = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
              if ( convertNullStr(codDebALLCash.value("T_EXTERNALCODE")) == "---" )
                var codDebALLCashM = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                MinDebALLSum.Currency = RetKernelNatISO(convertNullStr(codDebALLCashM.value("T_EXTERNALCODE")));
                ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebALLSum;
              else
                MinDebALLSum.Currency = RetKernelNatISO(convertNullStr(codDebALLCash.value("T_EXTERNALCODE")));
                ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebALLSum;
                break;
              end;
              isfindAllAccCur = rs_findAllAccCur.moveNext;
            end;
          else
            var NullDebAllSum = TMoney;
            NullDebAllSum.Sum = $0;
            NullDebAllSum.Currency = "0";
            ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = NullDebAllSum;
          end;
        end;

        if ( rs_fndType.value("T_MCTYPE") != 0 )
          var newCurDeb;
          if (rs_fndType.value("T_FLAGCUR") != 0)
            newCurDeb = 0;
          else
            newCurDeb = 1;
          end;

          needfindNextKind = false;
          isfindAllAccCur = false;
          findRealOpKind = rsdcommand("SELECT typ.* FROM dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = ? AND TYP.T_KIND = ? ");
          findRealOpKind.AddParam ("isCur",RSDBP_IN,newCurDeb);
          findRealOpKind.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
          findRealOpKind.nullConversion = true;
          findRealOpKind.execute();
          rs_findRealOpKind = RsdRecordset(findRealOpKind);
          if ( not rs_findRealOpKind.moveNext )
            RunError( ErrMessage( 16513 ), 16513 );
          end;
          if ( convertNullInt(rs_findRealOpKind.value("T_OPFROMOTHERDEPTYPE")) > 0 )
            needfindNextKind = true;
            while ( needfindNextKind )
              findRealOpKind = rsdcommand("SELECT typ.* FROM dpc_apltp_dbt apl, dsb_dtyp_dbt typ WHERE TYP.T_FLAGCUR = APL.T_ISCUR AND TYP.T_KIND = APL.T_APTYPE "
                                          " AND APL.T_TYPEREC = 1003 AND APL.T_APPLTYPE = 3010 AND APL.T_ISCUR = ? AND APL.T_TYPE = ?");
              findRealOpKind.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
              findRealOpKind.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
              findRealOpKind.nullConversion = true;
              findRealOpKind.execute();
              rs_findRealOpKind = RsdRecordset(findRealOpKind);
              if ( rs_findRealOpKind.moveNext )
                if ( convertNullInt(rs_findRealOpKind.value("T_OPFROMOTHERDEPTYPE")) == 0 )
                  needfindNextKind = false;
                end;
              else
                RunError( ErrMessage( 16513 ), 16513 );
              end;
            end;
          end;

          findAllAccCur = rsdcommand("SELECT DISTINCT T_CODE_CURRENCY codcur FROM ddepositr_dbt WHERE T_ISCUR = ? AND T_FNCASH = ? AND T_SVODACCOUNT = ? "
                                     " AND T_OPEN_CLOSE = CHR (0) AND T_ACTION <> 2 AND T_ACTION <> 11");
          findAllAccCur.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
          findAllAccCur.AddParam ("fncash",RSDBP_IN,rs_findBaseAcc.value("T_FNCASH"));
          findAllAccCur.AddParam ("svodacc",RSDBP_IN,rs_findBaseAcc.value("T_SVODACCOUNT"));
          findAllAccCur.nullConversion = true;
          findAllAccCur.execute();
          rs_findAllAccCur = RsdRecordset(findAllAccCur);
          if ( rs_findAllAccCur.moveNext )
            isfindAllAccCur = true;
          end;

          if ((ExternalData.InteractType == 2))
            sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240) AND T_NUMOPERT IN (4) "
                           " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD DESC";
            fndMinSum = rsdcommand(sqlfndMinSum);
            fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
            fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
            fndMinSum.nullConversion = true;
            fndMinSum.execute();
            rs_fndMinSum = RsdRecordset(fndMinSum);
            if ( rs_fndMinSum.moveNext() )
              while (isfindAllAccCur)
                var MinDebCashSumM = TMoney;
                MinDebCashSumM.Sum = rs_fndMinSum.value("T_PRMD");
                var codDebCashM2 = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
                if ( convertNullStr(codDebCashM2.value("T_EXTERNALCODE")) == "---" )
                  var codDebCashM3 = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                  MinDebCashSumM.Currency = RetKernelNatISO(convertNullStr(codDebCashM3.value("T_EXTERNALCODE")));
                  ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebCashSumM;
                else
                  MinDebCashSumM.Currency = RetKernelNatISO(convertNullStr(codDebCashM2.value("T_EXTERNALCODE")));
                  ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebCashSumM;
                  break;
                end;
                isfindAllAccCur = rs_findAllAccCur.moveNext;
              end;
            else
              var NullDebCashSumM = TMoney;
              NullDebCashSumM.Sum = $0;
              NullDebCashSumM.Currency = "0";
              ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = NullDebCashSumM;
            end;
          elif ((ExternalData.InteractType == 1))
            sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240) AND T_NUMOPERT IN (62,63,64,65,66,67,80,84,87) "
                           " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD DESC";
            fndMinSum = rsdcommand(sqlfndMinSum);
            fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
            fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
            fndMinSum.nullConversion = true;
            fndMinSum.execute();
            rs_fndMinSum = RsdRecordset(fndMinSum);
            if ( rs_fndMinSum.moveNext() )
              while (isfindAllAccCur)
                var MinDebNoCashSumM = TMoney;
                MinDebNoCashSumM.Sum = rs_fndMinSum.value("T_PRMD");
                var codDebNoCashM2 = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
                if ( convertNullStr(codDebNoCashM2.value("T_EXTERNALCODE")) == "---" )
                  var codDebNoCashM3 = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                  MinDebNoCashSumM.Currency = RetKernelNatISO(convertNullStr(codDebNoCashM3.value("T_EXTERNALCODE")));
                  ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebNoCashSumM;
                else
                  MinDebNoCashSumM.Currency = RetKernelNatISO(convertNullStr(codDebNoCashM2.value("T_EXTERNALCODE")));
                  ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebNoCashSumM;
                  break;
                end;
                isfindAllAccCur = rs_findAllAccCur.moveNext;
              end;
            else
              var NullDebNoCashSumM = TMoney;
              NullDebNoCashSumM.Sum = $0;
              NullDebNoCashSumM.Currency = "0";
              ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = NullDebNoCashSumM;
            end;
          elif ((ExternalData.InteractType == 0))
            sqlfndMinSum = "SELECT * FROM DSB_ALGOP_DBT WHERE T_KIND = ? AND T_ISCUR = ? AND T_NUMSTEPALG IN (240) AND T_NUMOPERT IN (4,62,63,64,65,66,67,80,84,87) "
                           " AND T_PRMD > 0 AND T_FLAGEXE <> CHR (0) ORDER BY T_PRMD DESC";
            fndMinSum = rsdcommand(sqlfndMinSum);
            fndMinSum.AddParam ("kind",RSDBP_IN,rs_findRealOpKind.value("T_KIND"));
            fndMinSum.AddParam ("isCur",RSDBP_IN,rs_findRealOpKind.value("T_FLAGCUR"));
            fndMinSum.nullConversion = true;
            fndMinSum.execute();
            rs_fndMinSum = RsdRecordset(fndMinSum);
            if ( rs_fndMinSum.moveNext() )
              while (isfindAllAccCur)
                var MinDebALLSumM = TMoney;
                MinDebALLSumM.Sum = rs_fndMinSum.value("T_PRMD");
                var codDebALLCashM2 = FindCurrency(FINDCURBYCODE_CUR, rs_fndMinSum.value("T_PRMI"));
                if ( convertNullStr(codDebALLCashM2.value("T_EXTERNALCODE")) == "---" )
                  var codDebALLCashM3 = FindCurrency(FINDCURBYCODE_CUR, rs_findAllAccCur.value("codcur"));
                  MinDebALLSumM.Currency = RetKernelNatISO(convertNullStr(codDebALLCashM3.value("T_EXTERNALCODE")));
                  ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebALLSumM;
                else
                  MinDebALLSumM.Currency = RetKernelNatISO(convertNullStr(codDebALLCashM2.value("T_EXTERNALCODE")));
                  ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = MinDebALLSumM;
                  break;
                end;
                isfindAllAccCur = rs_findAllAccCur.moveNext;
              end;
            else
              var NullDebAllSumM = TMoney;
              NullDebAllSumM.Sum = $0;
              NullDebAllSumM.Currency = "0";
              ResContract.DepositData.DebitLimits[ResContract.DepositData.DebitLimits.size] = NullDebAllSumM;
            end;
          end;
        end;
      end;
    end;

    var acc;
    if ( (StrBrk(ExternalData.InfoType, "A") != 0) or  (StrBrk(ExternalData.InfoType, "S") != 0) or 
        (StrBrk(ExternalData.InfoType, "P") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      var fndDepAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_SVODACCOUNT = ? AND T_FNCASH = ?");
      fndDepAcc.AddParam("svodAcc",RSDBP_IN,Contract.value("T_NUMBER"));
      fndDepAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      fndDepAcc.nullConversion = true;
      fndDepAcc.execute();
      var rs_fndDepAcc = rsdRecordSet(fndDepAcc);
      while ( rs_fndDepAcc.moveNext() )
        acc = TAccDepData;
        acc.Account.ID = rs_fndDepAcc.value("T_REFERENC");
        acc.Account.Number = SubStr(rs_fndDepAcc.value("T_ACCOUNT"),1,20);
        ResContract.Accounts[ResContract.Accounts.size] = acc;
      end;
    end;
    
    if ( (StrBrk(ExternalData.InfoType, "S") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) and (not ResContract.DepositData.IsClosed ) )
      var fndFinAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_SVODACCOUNT = ? AND T_FNCASH = ?");
      fndFinAcc.AddParam("svodAcc",RSDBP_IN,Contract.value("T_NUMBER"));
      fndFinAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      fndFinAcc.nullConversion = true;
      fndFinAcc.execute();
      var rs_fndFinAcc = rsdRecordSet(fndFinAcc);
      while ( rs_fndFinAcc.moveNext() )
        var FinancialInfo = TDepFinData;
        var fndFinCurAcc = FindCurrency(FINDCURBYCODE_CUR, rs_fndFinAcc.value("T_CODE_CURRENCY"));
        FinancialInfo.Currency = RetKernelNatISO(fndFinCurAcc.value("T_EXTERNALCODE"));
        FinancialInfo.Sum = rs_fndFinAcc.value("T_SUM_REST");

        var findOutPercSum = rsdcommand("SELECT DECODE (SUM (T_INSUM), NULL, 0, SUM (T_INSUM)) Allmoney FROM dsbdepdoc_dbt " + 
                                        "WHERE T_REFERENC = ? AND T_TYPEOPER = 72 AND T_DATE_DOCUMENT <= ? " +
                                          "AND T_ACTION not in ( 2, 11 ) " + // D_DELETE и D_STORN
                                          "AND T_KINDOP not in ( 8, 9, 14, 15, 16 ) " +
                                          "AND T_MODE <> 2 AND bitand( T_FLAGS, 131072 ) = 0" );
        findOutPercSum.AddParam("Ref",RSDBP_IN,rs_fndFinAcc.value("T_REFERENC"));
        findOutPercSum.AddParam("date",RSDBP_IN,{curdate});
        findOutPercSum.nullConversion = true;
        findOutPercSum.execute();
        var rs_findOutPercSum = RsdRecordset(findOutPercSum);
        if (rs_findOutPercSum.moveNext())
          FinancialInfo.OutPercSum = rs_findOutPercSum.value("Allmoney");
        else
          FinancialInfo.OutPercSum = $0;
        end;

        var findLastPerc = rsdcommand("SELECT * FROM dsbdepdoc_dbt " + 
                                      "WHERE T_REFERENC = ? AND T_TYPEOPER IN (72,82) AND T_DATE_DOCUMENT <= ? " +
                                        "AND T_ACTION not in ( 2, 11 ) " + // D_DELETE и D_STORN
                                        "AND T_KINDOP not in ( 8, 9, 14, 15, 16 ) " +
                                        "AND T_MODE <> 2 AND bitand( T_FLAGS, 131072 ) = 0 " + // MODE_EOY_PRECALC документ предварительного расчета и BIT_FLAG_HIDDEN
                                      "ORDER BY T_DATE_DOCUMENT DESC, T_NUMDAYDOC DESC");
        findLastPerc.AddParam("Ref",RSDBP_IN,rs_fndFinAcc.value("T_REFERENC"));
        findLastPerc.AddParam("date",RSDBP_IN,{curdate});
        findLastPerc.nullConversion = true;
        findLastPerc.execute();
        var rs_findLastPerc = RsdRecordset(findLastPerc);
        if (rs_findLastPerc.moveNext())
          FinancialInfo.LastPercPay = rs_findLastPerc.value("T_DATE_DOCUMENT");
        else
          FinancialInfo.LastPercPay = date(0,0,0);
        end;

        var fndPCAlg, rs_fndPCAlg, fndpcCalc, rs_fndpcCalc;
        if ( rs_fndFinAcc.value("T_USEALTERNATE") == 0 )
          fndPCAlg = rsdcommand("SELECT pcalg.* FROM dpc_apltp_dbt apl, dpc_alg_dbt pcalg WHERE APL.T_ISCUR = pcalg.T_FLAGCUR "
                                    " AND APL.T_APTYPE = pcalg.T_REFERENC AND APL.T_TYPEREC = pcalg.T_OBJECTTYPE AND APL.T_TYPE = ? "
                                    " AND APL.T_ISCUR = ? AND APL.T_TYPEREC = 1003 AND APL.T_APPLTYPE = 2001 ORDER BY PCALG.T_BEGDATE DESC");
          fndPCAlg.AddParam("kind",RSDBP_IN,rs_fndFinAcc.value("T_TYPE_ACCOUNT"));
          fndPCAlg.AddParam("iscur",RSDBP_IN,rs_fndFinAcc.value("T_ISCUR"));
          rs_fndPCAlg = RsdRecordset(fndPCAlg);
          if ( (rs_fndPCAlg.moveNext()) and (rs_fndPCAlg.value("T_STRATCALC") <= 0) )
            ;
          else
            if ( rs_fndPCAlg.value("T_PERCPAYLIM") )
              FinancialInfo.NextPercPay = rs_fndFinAcc.value("T_END_DATEDEP");
            else
              alg.DAYPAY = rs_fndPCAlg.value("T_DAYPAY");
              alg.GRAFPAY = rs_fndPCAlg.value("T_GRAFPAY");
              var datePerc = Date(0,0,0);
              var Daystat = GetPayDate(datePerc, alg );
              if ( (not Daystat) and (datePerc != date(0,0,0)) )
                FinancialInfo.NextPercPay = datePerc;
              else
                fndpcCalc = rsdcommand("SELECT * FROM dpc__calc_dbt WHERE T_REFERENC = ? AND T_OBJECTTYPE = 1003 AND T_ENDDATE >= ? ORDER BY T_ENDDATE ASC");
                fndpcCalc.AddParam("Ref",RSDBP_IN,rs_fndFinAcc.value("T_REFERENC"));
                fndpcCalc.AddParam("endDate",RSDBP_IN,{curdate});
                rs_fndpcCalc = RSdRecordset(fndpcCalc);
                if (rs_fndpcCalc.moveNext())
                  FinancialInfo.NextPercPay = rs_fndpcCalc.value("T_ENDDATE");
                end;
              end;
            end;
          end;
        else
          fndPCAlg = rsdcommand("SELECT pcalg.* FROM dpc_apltp_dbt apl, dpc_alg_dbt pcalg WHERE APL.T_ISCUR = pcalg.T_FLAGCUR "
                                    " AND APL.T_APTYPE = pcalg.T_REFERENC AND APL.T_TYPEREC = pcalg.T_OBJECTTYPE AND APL.T_TYPE = ? "
                                    " AND APL.T_ISCUR = ? AND APL.T_TYPEREC = 1003 AND APL.T_APPLTYPE = 2002 ORDER BY PCALG.T_BEGDATE DESC");
          fndPCAlg.AddParam("kind",RSDBP_IN,rs_fndFinAcc.value("T_TYPE_ACCOUNT"));
          fndPCAlg.AddParam("iscur",RSDBP_IN,rs_fndFinAcc.value("T_ISCUR"));
          rs_fndPCAlg = RsdRecordset(fndPCAlg);
          if ( (rs_fndPCAlg.moveNext()) and (rs_fndPCAlg.value("T_STRATCALC") <= 0) )
            ;
          else
            if ( rs_fndPCAlg.value("T_PERCPAYLIM") )
              FinancialInfo.NextPercPay = rs_fndFinAcc.value("T_END_DATEDEP");
            else
              alg.DAYPAY = rs_fndPCAlg.value("T_DAYPAY");
              alg.GRAFPAY = rs_fndPCAlg.value("T_GRAFPAY");
              var datePercSec = Date(0,0,0);
              var DaystatSec = GetPayDate(datePercSec, alg );
              if ( (not DaystatSec) and (datePercSec != date(0,0,0)) )
                FinancialInfo.NextPercPay = datePerc;
              else
                fndpcCalc = rsdcommand("SELECT * FROM dpc__calc_dbt WHERE T_REFERENC = ? AND T_OBJECTTYPE = 1003 AND T_ENDDATE >= ? ORDER BY T_ENDDATE ASC");
                fndpcCalc.AddParam("Ref",RSDBP_IN,rs_fndFinAcc.value("T_REFERENC"));
                fndpcCalc.AddParam("endDate",RSDBP_IN,{curdate});
                rs_fndpcCalc = RSdRecordset(fndpcCalc);
                if (rs_fndpcCalc.moveNext())
                  FinancialInfo.NextPercPay = rs_fndpcCalc.value("T_ENDDATE");
                end;
              end;
            end;
          end;

        end;
        var SumPerc = $0;
        OpenDepFiles;
        var Finstat = SimpleCalcPcEstim({curdate}, rs_fndFinAcc.value("T_REFERENC"), SumPerc);
        if ( not Finstat)
          FinancialInfo.PercSum = SumPerc;
          ResContract.findAccountData(rs_fndFinAcc.value("T_REFERENC")).FinancialInfo = FinancialInfo;
        end;
      end;

    end;

    if ( (StrBrk(ExternalData.InfoType, "A") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      var fndAllAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_SVODACCOUNT = ? AND T_FNCASH = ?");
      fndAllAcc.AddParam("svodAcc",RSDBP_IN,Contract.value("T_NUMBER"));
      fndAllAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      fndAllAcc.nullConversion = true;
      fndAllAcc.execute();
      var rs_fndAllAcc = rsdRecordSet(fndAllAcc);
      while ( rs_fndAllAcc.moveNext() )
        acc = ResContract.findAccountData(rs_fndAllAcc.value("T_REFERENC"));

        if (acc == null)
          acc = TAccDepData;
          acc.Account.ID = rs_fndAllAcc.value("T_REFERENC");
          acc.Account.Number = SubStr(rs_fndAllAcc.value("T_ACCOUNT"),1,20);
          ResContract.Accounts[ResContract.Accounts.size] = acc;
        end;
        
        acc.Account.OpenDate = SQL_ConvTypeDate(rs_fndAllAcc.value("T_OPEN_DATE"));
        var fndCurAcc = FindCurrency(FINDCURBYCODE_CUR, rs_fndAllAcc.value("T_CODE_CURRENCY"));
        acc.Account.Currency = RetKernelNatISO(fndCurAcc.value("T_EXTERNALCODE"));
        if ( (rs_fndAllAcc.value("t_open_close") != strfor(0))
             or ((rs_fndAllAcc.value("t_action") == 2) or (rs_fndAllAcc.value("t_action") == 11)) )
          acc.Type = 2;
        else
          acc.Type = 1;
        end;

        var fndAllProcAcc = rsdcommand("SELECT * FROM dsb_congt_dbt WHERE T_REFERENCACC = ? AND T_GETTYPE = 3");
        fndAllProcAcc.AddParam("Ref",RSDBP_IN,rs_fndAllAcc.value("T_REFERENC"));
        fndAllProcAcc.nullConversion = true;
        fndAllProcAcc.execute();
        var rs_fndAllProcAcc = RsdRecordset(fndAllProcAcc);
        while ((rs_fndAllProcAcc.moveNext()) and ( (rs_fndAllProcAcc.value("T_PARTACCOUNT") == 4) or (rs_fndAllProcAcc.value("T_PARTACCOUNT") == 5) ))
          var fndProcAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_ACCOUNT = ? AND T_FNCASH = ?");
          fndProcAcc.AddParam("Account",RSDBP_IN,rs_fndAllProcAcc.value("T_AC_TYPE_GET"));
          fndProcAcc.AddParam("fncash",RSDBP_IN,rs_fndAllProcAcc.value("T_FNCASH"));
          fndProcAcc.nullConversion = true;
          fndProcAcc.execute();
          var rs_fndProcAcc = rsdRecordSet(fndProcAcc);
          if ( rs_fndProcAcc.moveNext() )
            var ProcAcc = TAccDepData;
            ProcAcc.Account.ID = rs_fndProcAcc.value("T_REFERENC");
            ProcAcc.Account.Number = SubStr(rs_fndProcAcc.value("T_ACCOUNT"),1,20);
            ProcAcc.Account.OpenDate = SQL_ConvTypeDate(rs_fndProcAcc.value("T_OPEN_DATE"));
            var fndProcCurAcc = FindCurrency(FINDCURBYCODE_CUR, rs_fndProcAcc.value("T_CODE_CURRENCY"));
            ProcAcc.Account.Currency = RetKernelNatISO(fndProcCurAcc.value("T_EXTERNALCODE"));
            if ( rs_fndAllProcAcc.value("T_PARTACCOUNT") == 4 )
              ProcAcc.Type = 3;
            elif ( rs_fndAllProcAcc.value("T_PARTACCOUNT") == 5 )
              ProcAcc.Type = 5;
            end;
            ResContract.Accounts[ResContract.Accounts.size] = ProcAcc;
          end;
        end;

        var fndAllEndAcc = rsdcommand("SELECT * FROM dsb_congt_dbt WHERE T_REFERENCACC = ? AND T_GETTYPE = 2");
        fndAllEndAcc.AddParam("Ref",RSDBP_IN,rs_fndAllAcc.value("T_REFERENC"));
        fndAllEndAcc.nullConversion = true;
        fndAllEndAcc.execute();
        var rs_fndAllEndAcc = RsdRecordset(fndAllEndAcc);
        while (rs_fndAllEndAcc.moveNext())
          var fndEndAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_ACCOUNT = ? AND T_FNCASH = ?");
          fndEndAcc.AddParam("Account",RSDBP_IN,rs_fndAllEndAcc.value("T_AC_TYPE_GET"));
          fndEndAcc.AddParam("fncash",RSDBP_IN,rs_fndAllEndAcc.value("T_FNCASH"));
          fndEndAcc.nullConversion = true;
          fndEndAcc.execute();
          var rs_fndEndAcc = rsdRecordSet(fndEndAcc);
          if ( rs_fndEndAcc.moveNext() )
            var EndAcc = TAccDepData;
            EndAcc.Account.ID = rs_fndEndAcc.value("T_REFERENC");
            EndAcc.Account.Number = SubStr(rs_fndEndAcc.value("T_ACCOUNT"),1,20);
            EndAcc.Account.OpenDate = SQL_ConvTypeDate(rs_fndEndAcc.value("T_OPEN_DATE"));
            var fndEndCurAcc = FindCurrency(FINDCURBYCODE_CUR, rs_fndEndAcc.value("T_CODE_CURRENCY"));
            EndAcc.Account.Currency = RetKernelNatISO(fndEndCurAcc.value("T_EXTERNALCODE"));
            EndAcc.Type = 4;
            ResContract.Accounts[ResContract.Accounts.size] = EndAcc;
          end;
        end;

      end;
    end;

    if ( (StrBrk(ExternalData.InfoType, "C") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      var AccOwner = TDepPersonData;
      AccOwner.Part = "ВЛД";
      AccOwner.ID = rs_findBaseAcc.value("T_CODCLIENT");
      var findName = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = ?");
      findName.AddParam ("name",RSDBP_IN,rs_findBaseAcc.value("T_CODCLIENT"));
      findName.nullConversion = true;
      findName.execute();
      var rs_findName = RsdRecordset(findName);
      rs_findName.moveNext();
      AccOwner.Name = rs_findName.value("T_NAME");
      var findPersonOp = rsdcommand("SELECT * FROM dsb_typop_dbt WHERE T_KIND = ? AND T_SYSNUMB = 0");
      findPersonOp.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
      findPersonOp.nullConversion = true;
      findPersonOp.execute();
      var rs_findPersonOp = RsdRecordset(findPersonOp);
      AccOwner.OperCodes = "";
      while ( rs_findPersonOp.moveNext() )
        AccOwner.OperCodes = AccOwner.OperCodes + rs_findPersonOp.value("T_NUMOPERT") + ";"
      end;
      ResContract.PersonInfo[ResContract.PersonInfo.size] = AccOwner;

/*      if ( rs_findBaseAcc.value("T_OPENCLIENT") > 0 )
        var AccPayer = TDepPersonData;
        AccPayer.Part = "ВНС";
        AccPayer.ID = rs_findBaseAcc.value("T_OPENCLIENT");
        findName = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = ?");
        findName.AddParam ("name",RSDBP_IN,rs_findBaseAcc.value("T_OPENCLIENT"));
        findName.nullConversion = true;
        findName.execute();
        rs_findName = RsdRecordset(findName);
        rs_findName.moveNext();
        AccPayer.Name = rs_findName.value("T_NAME");
        findPersonOp = rsdcommand("SELECT * FROM dsb_typop_dbt WHERE T_KIND = ? AND T_SYSNUMB = 0 AND T_REGIMES LIKE '%Д%'");
        findPersonOp.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
        findPersonOp.nullConversion = true;
        findPersonOp.execute();
        rs_findPersonOp = RsdRecordset(findPersonOp);
        AccPayer.OperCodes = "";
        while ( rs_findPersonOp.moveNext() )
          AccPayer.OperCodes = AccPayer.OperCodes + rs_findPersonOp.value("T_NUMOPERT") + ";"
        end;
        ResContract.PersonInfo[ResContract.PersonInfo.size] = AccPayer;
      end;
*/
      var findtrast = rsdcommand("SELECT trast.* FROM dsbtrast_dbt trast WHERE TRAST.T_FNCASH = ? AND TRAST.T_REFERENC = ?");
      findtrast.AddParam ("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      findtrast.AddParam ("id",RSDBP_IN,Contract.value("T_ID"));
      findtrast.nullConversion = true;
      findtrast.execute();
      var rs_findtrast = RsdRecordset(findtrast);
      while ( rs_findtrast.moveNext() )
        var clntTrast = TDepPersonData;
        if ( (rs_findtrast.value("T_VIDDOC") == StrFor( 0 )) and (rs_findtrast.value("T_TYPE") == ACCOUTN_PROXY) )
          clntTrast.Part = "ДВЛ";
          clntTrast.ID = rs_findtrast.value("T_CODCLIENT");
        elif ( (rs_findtrast.value("T_VIDDOC") == StrFor(1)) or (rs_findtrast.value("T_VIDDOC") == StrFor(2)) or 
               (rs_findtrast.value("T_TYPE") == ACCOUTN_HEIR) or (rs_findtrast.value("T_TYPE") == ACCOUTN_HEIR_PAY) )
          clntTrast.Part = "НСЛ";
          clntTrast.ID = rs_findtrast.value("T_CODCLIENT");
        elif ( (rs_findtrast.value("T_VIDDOC") == StrFor( 0 )) and (rs_findtrast.value("T_TYPE") == ACCOUNT_TUTOR) )
          clntTrast.Part = "ОПК";
          clntTrast.ID = rs_findtrast.value("T_CODCLIENT");
        elif ( (rs_findtrast.value("T_VIDDOC") == StrFor( 0 )) and (rs_findtrast.value("T_TYPE") == ACCOUNT_IMPORTER) )
          clntTrast.Part = "ВНС";
          clntTrast.ID = rs_findtrast.value("T_CODCLIENT");
        else
          clntTrast.Part = "";
          clntTrast.ID = rs_findtrast.value("T_CODCLIENT");
        end;
        findName = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = ?");
        findName.AddParam ("name",RSDBP_IN,rs_findtrast.value("T_CODCLIENT"));
        findName.nullConversion = true;
        findName.execute();
        rs_findName = RsdRecordset(findName);
        rs_findName.moveNext();
        clntTrast.Name = rs_findName.value("T_NAME");
        clntTrast.OperCodes = "";
        if ( (rs_findtrast.value("T_VIDDOC") == StrFor(1)) or (rs_findtrast.value("T_VIDDOC") == StrFor(2)) or 
             (rs_findtrast.value("T_TYPE") == ACCOUTN_HEIR) or (rs_findtrast.value("T_TYPE") == ACCOUTN_HEIR_PAY) )
          findPersonOp = rsdcommand("SELECT * FROM dsb_typop_dbt WHERE T_KIND = ? AND T_SYSNUMB = 0 AND T_REGIMES LIKE '%D%'");
          findPersonOp.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
          findPersonOp.nullConversion = true;
          findPersonOp.execute();
          rs_findPersonOp = RsdRecordset(findPersonOp);
          while ( rs_findPersonOp.moveNext() )
            clntTrast.OperCodes = clntTrast.OperCodes + rs_findPersonOp.value("T_NUMOPERT") + ";"
          end;
        else
          findPersonOp = rsdcommand("SELECT * FROM dsb_typop_dbt WHERE T_KIND = ? AND T_SYSNUMB = 0 AND T_REGIMES LIKE '%Д%'");
          findPersonOp.AddParam ("kind",RSDBP_IN,rs_fndType.value("T_KIND"));
          findPersonOp.nullConversion = true;
          findPersonOp.execute();
          rs_findPersonOp = RsdRecordset(findPersonOp);
          while ( rs_findPersonOp.moveNext() )
            clntTrast.OperCodes = clntTrast.OperCodes + rs_findPersonOp.value("T_NUMOPERT") + ";"
          end;
        end;

        ResContract.PersonInfo[ResContract.PersonInfo.size] = clntTrast;
      end;
    end;

    if ( (StrBrk(ExternalData.InfoType, "P") != 0) or (StrBrk(ExternalData.InfoType, "F") != 0) )
      var fndAllOpenAcc = rsdcommand("SELECT * FROM ddepositr_dbt WHERE T_SVODACCOUNT = ? AND T_FNCASH = ? AND T_OPEN_CLOSE = CHR (0) AND T_ACTION <> 2 AND T_ACTION <> 11 ");
      fndAllOpenAcc.AddParam("svodAcc",RSDBP_IN,Contract.value("T_NUMBER"));
      fndAllOpenAcc.AddParam("fncash",RSDBP_IN,Contract.value("T_BRANCH"));
      fndAllOpenAcc.nullConversion = true;
      fndAllOpenAcc.execute();
      var rs_fndAllOpenAcc = rsdRecordSet(fndAllOpenAcc);
      while ( rs_fndAllOpenAcc.moveNext() )
        var percAcc = ResContract.findAccountData(rs_fndAllOpenAcc.value("T_REFERENC"));
        
        var fndPc_Rate, rs_fndPc_Rate, fndApltp, rs_fndApltp, fndPercCur;
        if ( rs_fndAllOpenAcc.value("T_USEALTERNATE") != 0 )
          fndApltp = rsdcommand("SELECT * FROM dpc_apltp_dbt WHERE T_TYPEREC = 1003 AND T_APPLTYPE IN (2002, 2004) AND T_TYPE = ? AND T_ISCUR = ?");
          fndApltp.AddParam("kind",RSDBP_IN,rs_fndAllOpenAcc.value("T_TYPE_ACCOUNT"));
          fndApltp.AddParam("ISCUR",RSDBP_IN,rs_fndAllOpenAcc.value("T_ISCUR"));
          rs_fndApltp = RsdRecordset(fndApltp);
          while ( rs_fndApltp.moveNext() )
            var Perc = TPercRatesData;
            Perc.Type = rs_fndApltp.value("T_APPLTYPE");
            fndPc_Rate = rsdcommand("SELECT * FROM dpc_rate_dbt WHERE T_REFERENC = ? AND T_FLAGCUR = ? AND T_OBJECTTYPE = 1003 ORDER BY T_BEGINDATE DESC");
            fndPc_Rate.AddParam("kind",RSDBP_IN,rs_fndAllOpenAcc.value("T_TYPE_ACCOUNT"));
            fndPc_Rate.AddParam("ISCUR",RSDBP_IN,rs_fndAllOpenAcc.value("T_ISCUR"));
            rs_fndPc_Rate = RsdRecordset(fndPc_Rate);
            if ( rs_fndPc_Rate.moveNext() )
              Perc.Rate = rs_fndPc_Rate.value("T_PERCENT1");
            end;
            fndPercCur = FindCurrency(FINDCURBYCODE_CUR, rs_fndAllOpenAcc.value("T_CODE_CURRENCY"));
            Perc.Currency = RetKernelNatISO(fndPercCur.value("T_EXTERNALCODE"));
            percAcc.PercRates[percAcc.PercRates.size] = Perc;
          end;
        elif ( rs_fndAllOpenAcc.value("T_USEALTERNATE") == 0 )
          fndApltp = rsdcommand("SELECT * FROM dpc_apltp_dbt WHERE T_TYPEREC = 1003 AND T_APPLTYPE IN (2001, 2004) AND T_TYPE = ? AND T_ISCUR = ?");
          fndApltp.AddParam("kind",RSDBP_IN,rs_fndAllOpenAcc.value("T_TYPE_ACCOUNT"));
          fndApltp.AddParam("ISCUR",RSDBP_IN,rs_fndAllOpenAcc.value("T_ISCUR"));
          rs_fndApltp = RsdRecordset(fndApltp);
          while ( rs_fndApltp.moveNext() )
            var Percen = TPercRatesData;
            Percen.Type = rs_fndApltp.value("T_APPLTYPE");
            fndPc_Rate = rsdcommand("SELECT * FROM dpc_rate_dbt WHERE T_REFERENC = ? AND T_FLAGCUR = ? AND T_OBJECTTYPE = 1003 ORDER BY T_BEGINDATE DESC");
            fndPc_Rate.AddParam("kind",RSDBP_IN,rs_fndAllOpenAcc.value("T_TYPE_ACCOUNT"));
            fndPc_Rate.AddParam("ISCUR",RSDBP_IN,rs_fndAllOpenAcc.value("T_ISCUR"));
            rs_fndPc_Rate = RsdRecordset(fndPc_Rate);
            if ( rs_fndPc_Rate.moveNext() )
              Percen.Rate = rs_fndPc_Rate.value("T_PERCENT1");
            end;
            fndPercCur = FindCurrency(FINDCURBYCODE_CUR, rs_fndAllOpenAcc.value("T_CODE_CURRENCY"));
            Percen.Currency = RetKernelNatISO(fndPercCur.value("T_EXTERNALCODE"));
            percAcc.PercRates[percAcc.PercRates.size] = Percen;
          end;
        end;
      end;
    end;

    ResContract.ID = string(Contract.value("T_BRANCH")) +"/"+ string(Contract.value("T_ID") );
    retVal[retVal.size] = ResContract;
  end;
  return retVal;
end;


/********************************************************************************\
|         ПЕРЕВОД МЕЖДУ ТЕКУЩИМИ СЧЕТАМИ ОДНОГО КЛИЕНТА (В РАЗНЫХ ВАЛЮТАХ)       |
\********************************************************************************/
macro IConvertAA ( ExternalData )
  record r_sbdepdoc ("sbdepdoc.1");
  record r_operprm ("oper_prm.1");
  record pmnt_prop("rtpaymentprop.dbt");
  var DestAccount, SourceAccount;
  var SumByRateKind = false, SumByBaseWork = false;

  if ( (ValType(ExternalData.OperData.Client) != V_INTEGER) or (ExternalData.OperData.Client < 0) )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ValType(ExternalData.OperData.ExternalPayCode) != V_STRING) or (ExternalData.OperData.ExternalPayCode == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( ((ValType(ExternalData.OperData.Sum.Sum) != V_MONEY) or (ExternalData.OperData.Sum.Sum <= $0L))
         or ((ValType(ExternalData.OperData.Sum.Currency) != V_STRING) or (ExternalData.OperData.Sum.Currency == "")) );
    if ( ((ValType(ExternalData.ConvData.SumIn.Sum) != V_MONEY) or (ExternalData.ConvData.SumIn.Sum <= $0L))
         or ((ValType(ExternalData.ConvData.SumIn.Currency) != V_STRING) or (ExternalData.ConvData.SumIn.Currency == "")) );
      RunError( ErrMessage( 16504 ), 16504 );
    end;
  elif ( (ValType(ExternalData.ConvData.RateCalcType) != V_INTEGER) or (ExternalData.ConvData.RateCalcType < 0) )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  var fndstat = findReissueAccount ( SourceAccount, ExternalData.OperData.Source, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16552; // некорректно заполнены данные источника
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  if ( (ValType(ExternalData.OperData.Sum.Currency) == V_STRING) and (ExternalData.OperData.Sum.Currency != "") )
    checkCurrency( ExternalData.OperData.Sum.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16555 );
  end;

  зададим_параметры_банка (SourceAccount);
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  fndstat = findReissueAccount ( DestAccount, ExternalData.OperData.Destination, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16553; // некорректно заполнены данные получателя
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;

  if ( DestAccount.value("T_CODE_CURRENCY") == SourceAccount.value("T_CODE_CURRENCY") )
    RunError( ErrMessage( 16540 ), 16540 );
  end;
  if ( (ValType(ExternalData.ConvData.SumIn.Currency) == V_STRING) and (ExternalData.ConvData.SumIn.Currency != "") )
    checkCurrency( ExternalData.ConvData.SumIn.Currency, DestAccount.value("T_CODE_CURRENCY"), 16556 );
  end;
  if ( DestAccount.value("T_CODCLIENT") != SourceAccount.value("T_CODCLIENT") )
    RunError( ErrMessage( 16527 ), 16527 );
  end;

  if ( (ValType(ExternalData.OperData.ComissionOut.Currency) == V_STRING) and (ExternalData.OperData.ComissionOut.Currency != "") )
    checkCurrency( ExternalData.OperData.ComissionOut.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16558 );
  end;
  if ( (ValType(ExternalData.OperData.ComissionIn.Currency) == V_STRING) and (ExternalData.OperData.ComissionIn.Currency != "") )
    checkCurrency( ExternalData.OperData.ComissionIn.Currency, DestAccount.value("T_CODE_CURRENCY"), 16559 );
  end;
  
  var OpData : Operation;
  OpData.ExternalSystem = ExternalData.OperData.ExternalSystem;
  OpData.ExternalPayCode = ExternalData.OperData.ExternalPayCode;
  OpData.ComissionType = ExternalData.OperData.ComissionType;
  OpData.ComissionOut.Sum = ExternalData.OperData.ComissionOut.Sum;
  OpData.ComissionOut.Currency = RetRetailNatISO(ExternalData.OperData.ComissionOut.Currency);
  OpData.OperSubType = ExternalData.OperData.OperSubType;
  OpData.Account = SourceAccount.value("T_REFERENC");

  Заполнение_ГАХ( OpData );

  record convdepdoc ("sbdepdoc.1");
  var stat = 0;
  var InSum = $0L;
  var RateOper = 0.;
  var RateType = "";
  var RateKind = 0;
  var buff;
  OpenDepFiles;
  var IsOperDataSum = false, IsConvDataSum = false, IsRateKind = false, IsWorkSumSum = false, IsBaseSumSum = false;
  if ((ValType(ExternalData.OperData.Sum.Sum) == V_MONEY) and (ExternalData.OperData.Sum.Sum > $0))
    IsOperDataSum = true;
  end;
  if ((ValType(ExternalData.ConvData.SumIn.Sum) == V_MONEY) and (ExternalData.ConvData.SumIn.Sum > $0))
    IsConvDataSum = true;
  end;
  if ((ValType(ExternalData.ConvData.Rate.WorkSum.Sum) == V_MONEY) and (ExternalData.ConvData.Rate.WorkSum.Sum > $0))
    IsWorkSumSum = true;
  end;
  if ((ValType(ExternalData.ConvData.Rate.BaseSum.Sum) == V_MONEY) and (ExternalData.ConvData.Rate.BaseSum.Sum > $0))
    IsBaseSumSum = true;
  end;
  if ((ValType(ExternalData.ConvData.Rate.Kind) == V_INTEGER) and (ExternalData.ConvData.Rate.Kind > 0))
    IsRateKind = true;
  end;

  if( (ExternalData.ConvData.RateCalcType == 1) and (IsOperDataSum) and (IsConvDataSum) )
    r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
    r_sbdepdoc.CurrencyBought = ExternalData.ConvData.SumIn.Sum;
    if ( /*ExternalData.OperData.Sum.Currency == "810"*/
        SourceAccount.value("T_CODE_CURRENCY") == 0 )
      r_sbdepdoc.PercTrnRest = ExternalData.OperData.Sum.Sum / ExternalData.ConvData.SumIn.Sum;
    else
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.SumIn.Sum / ExternalData.OperData.Sum.Sum;
    end;
  elif( (ExternalData.ConvData.RateCalcType == 2) and (IsOperDataSum) )
    r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
  elif( (ExternalData.ConvData.RateCalcType == 2) and (IsConvDataSum) )
    convdepdoc.Referenc         = SourceAccount.value("t_referenc");
    convdepdoc.Type_Account     = SourceAccount.value("t_type_account");
    convdepdoc.Code_Currency    = SourceAccount.value("T_CODE_CURRENCY");
    convdepdoc.DepDate_Document = {curdate};
    convdepdoc.InSum = ExternalData.ConvData.SumIn.Sum;
    stat = GetDepRate(convdepdoc, DestAccount.value("T_CODE_CURRENCY"), InSum,RateKind, true, RateOper, RateType);
    if (stat)
      RunError( ErrMessage( stat ), stat );
    end;
    r_sbdepdoc.OutSum = convdepdoc.OutSum;
    r_sbdepdoc.CurrencyBought = ExternalData.ConvData.SumIn.Sum;
    r_sbdepdoc.PercTrnRest = RateOper;
  elif( (ExternalData.ConvData.RateCalcType == 1) and (IsOperDataSum) and (IsRateKind) )
    convdepdoc.Referenc         = SourceAccount.value("t_referenc");
    convdepdoc.Type_Account     = SourceAccount.value("t_type_account");
    convdepdoc.Code_Currency    = SourceAccount.value("T_CODE_CURRENCY");
    convdepdoc.DepDate_Document = {curdate};
    convdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
    stat = GetDepRate(convdepdoc, DestAccount.value("T_CODE_CURRENCY"), InSum,ExternalData.ConvData.Rate.Kind, true, RateOper, RateType);
    if (stat)
      RunError( ErrMessage( stat ), stat );
    end;
    r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
    r_sbdepdoc.CurrencyBought = convdepdoc.InSum;;
    r_sbdepdoc.PercTrnRest = RateOper;
    SumByRateKind = true;
  elif( (ExternalData.ConvData.RateCalcType == 1) and (IsConvDataSum) and (IsRateKind) )
    convdepdoc.Referenc         = SourceAccount.value("t_referenc");
    convdepdoc.Type_Account     = SourceAccount.value("t_type_account");
    convdepdoc.Code_Currency    = SourceAccount.value("T_CODE_CURRENCY");
    convdepdoc.DepDate_Document = {curdate};
    convdepdoc.InSum = ExternalData.ConvData.SumIn.Sum;
    stat = GetDepRate(convdepdoc, DestAccount.value("T_CODE_CURRENCY"), InSum,ExternalData.ConvData.Rate.Kind, true, RateOper, RateType);
    if (stat)
      RunError( ErrMessage( stat ), stat );
    end;
    r_sbdepdoc.OutSum = convdepdoc.OutSum;
    r_sbdepdoc.CurrencyBought = ExternalData.ConvData.SumIn.Sum;
    r_sbdepdoc.PercTrnRest = RateOper;
    SumByRateKind = true;
  elif( (ExternalData.ConvData.RateCalcType == 1) and (IsBaseSumSum) and (IsWorkSumSum)
  and (IsOperDataSum) )
    r_sbdepdoc.OutSum = ExternalData.OperData.Sum.Sum;
    if ( SourceAccount.value("T_CODE_CURRENCY") == 0 )
      r_sbdepdoc.CurrencyBought = (ExternalData.OperData.Sum.Sum) * (ExternalData.ConvData.Rate.BaseSum.Sum/ExternalData.ConvData.Rate.WorkSum.Sum);
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.Rate.BaseSum.Sum/ExternalData.ConvData.Rate.WorkSum.Sum;
    elif ( DestAccount.value("T_CODE_CURRENCY") == 0 )
      r_sbdepdoc.CurrencyBought = (ExternalData.OperData.Sum.Sum) * (ExternalData.ConvData.Rate.WorkSum.Sum/ExternalData.ConvData.Rate.BaseSum.Sum);
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.Rate.WorkSum.Sum/ExternalData.ConvData.Rate.BaseSum.Sum;
    else
      if ( ExternalData.ConvData.Rate.WorkSum.Currency != ExternalData.OperData.Sum.Currency )
        buff = ExternalData.ConvData.Rate.WorkSum;
        ExternalData.ConvData.Rate.WorkSum = ExternalData.ConvData.Rate.BaseSum;
        ExternalData.ConvData.Rate.BaseSum = buff;
      end;

      r_sbdepdoc.CurrencyBought = (ExternalData.OperData.Sum.Sum) * (ExternalData.ConvData.Rate.BaseSum.Sum/ExternalData.ConvData.Rate.WorkSum.Sum);
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.Rate.BaseSum.Sum/ExternalData.ConvData.Rate.WorkSum.Sum;
    end;
    SumByBaseWork = true;
  elif( (ExternalData.ConvData.RateCalcType == 1) and (IsBaseSumSum) and (IsWorkSumSum)
  and (IsConvDataSum) )
    r_sbdepdoc.CurrencyBought = ExternalData.ConvData.SumIn.Sum;
    if ( SourceAccount.value("T_CODE_CURRENCY") == 0 )
      r_sbdepdoc.OutSum = (ExternalData.ConvData.SumIn.Sum) * (ExternalData.ConvData.Rate.WorkSum.Sum/ExternalData.ConvData.Rate.BaseSum.Sum);
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.Rate.BaseSum.Sum/ExternalData.ConvData.Rate.WorkSum.Sum;      
    elif ( DestAccount.value("T_CODE_CURRENCY") == 0 )
      r_sbdepdoc.OutSum = (ExternalData.ConvData.SumIn.Sum) * (ExternalData.ConvData.Rate.BaseSum.Sum/ExternalData.ConvData.Rate.WorkSum.Sum);
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.Rate.WorkSum.Sum/ExternalData.ConvData.Rate.BaseSum.Sum;
    else
      if ( ExternalData.ConvData.Rate.BaseSum.Currency != ExternalData.ConvData.SumIn.Currency )
        buff = ExternalData.ConvData.Rate.WorkSum;
        ExternalData.ConvData.Rate.WorkSum = ExternalData.ConvData.Rate.BaseSum;
        ExternalData.ConvData.Rate.BaseSum = buff;
      end;

      r_sbdepdoc.OutSum = (ExternalData.ConvData.SumIn.Sum) * (ExternalData.ConvData.Rate.WorkSum.Sum/ExternalData.ConvData.Rate.BaseSum.Sum);
      r_sbdepdoc.PercTrnRest = ExternalData.ConvData.Rate.WorkSum.Sum/ExternalData.ConvData.Rate.BaseSum.Sum;
    end;
    SumByBaseWork = true;
  else
    RunError( ErrMessage( 16541 ), 16541 );
  end; 
  
  r_sbdepdoc.Referenc = SourceAccount.value("T_REFERENC");
  r_sbdepdoc.NumDayDoc = 0;
  r_sbdepdoc.IsCur = SourceAccount.value("T_ISCUR");
  r_sbdepdoc.FNCash = SourceAccount.value("T_FNCASH");
  r_sbdepdoc.RealFNCash = SourceAccount.value("T_FNCASH");
  if (ExternalData.OperData.Client > 0)
    r_sbdepdoc.CodClient = ExternalData.OperData.Client;
  else
    r_sbdepdoc.CodClient = SourceAccount.value("T_CODCLIENT");
  end;
  r_sbdepdoc.Account = SourceAccount.value("T_ACCOUNT");
  r_sbdepdoc.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.OperData.DateDocument) != V_DATE) or (ExternalData.OperData.DateDocument == Date(0,0,0)) )
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = {curdate};
  else
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = ExternalData.OperData.DateDocument;
  end;
  r_sbdepdoc.TypeOper = 80;
  if ( (ValType(ExternalData.OperData.OperSubType) != V_INTEGER) or (ExternalData.OperData.OperSubType < 0) )
    r_sbdepdoc.ApplType = 0;
  else
    r_sbdepdoc.ApplType = ExternalData.OperData.OperSubType;
  end;
  r_sbdepdoc.TypeComplexOper = 80;
  r_sbdepdoc.IsControl = StrFor(1);
  r_sbdepdoc.Author = StrFor(0);
  r_sbdepdoc.YesSbook = "X";
  r_sbdepdoc.Oper = {oper};
  r_sbdepdoc.VIDDOC = 0;
  r_sbdepdoc.KINDOP = 3;
  r_sbdepdoc.OBJECTPERC = 2001;
  if ( (ValType(ExternalData.OperData.Ground) == V_STRING) and (ExternalData.OperData.Ground != "") )
    r_sbdepdoc.Ground = ExternalData.OperData.Ground;
  else
    r_sbdepdoc.Ground = "Перевод между текущими счетами (ИКФЛ)";
  end;
  r_sbdepdoc.iApplicationKind = 1;
  r_sbdepdoc.ApplicationKey = FormApplicationKey(1);
  r_sbdepdoc.CorrAcc_Referenc = DestAccount.value("T_REFERENC");
  r_sbdepdoc.FNcash_Receiver = DestAccount.value("T_FNCASH");


  r_operprm.Account = SourceAccount.value("T_ACCOUNT");
  r_operprm.Type_Account = SourceAccount.value("T_TYPE_ACCOUNT");
  r_operprm.Code_Currency = SourceAccount.value("T_CODE_CURRENCY");
  r_operprm.Type_Oper = 80;
  r_operprm.Show_Panel = 0;
  r_operprm.UseMaxDate = 1;
  r_operprm.NoPrint = 1;
  r_operprm.TypeComplexOper = 80;
  r_operprm.CorrAcc = DestAccount.value("T_ACCOUNT");
  r_operprm.CorrType = DestAccount.value("T_TYPE_ACCOUNT");


  var BankName, CorAccount, Bank_INN, Bank_KPP, BankID;
  iFindBank( PTCK_BIC, Trim( getRegNumOurBank( PTCK_BIC ) ), BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
  var findBankAcc = rsdcommand("select * from dsb_acdep_dbt where T_ISCUR = :iscur and T_FNCASH = :branch and "
                               " T_CODCUR = :codcur and T_CONTMODE = 0 and T_SPECVARIABLE = :specval");
  findBankAcc.AddParam("iscur", RSDBP_IN, SourceAccount.value("T_ISCUR"));
  findBankAcc.AddParam("branch", RSDBP_IN, DestAccount.value("T_FNCASH"));
  findBankAcc.AddParam("codcur", RSDBP_IN, SourceAccount.value("T_CODE_CURRENCY"));
  findBankAcc.AddParam("specval", RSDBP_IN, V_ACCSPECNAME);
  findBankAcc.nullConversion = true;
  findBankAcc.execute();
  var rs_findBankAcc = RsdRecordset(findBankAcc);
  if ( not rs_findBankAcc.moveNext() )
    pmnt_prop.account = "";
  else
    pmnt_prop.account = rs_findBankAcc.value("t_account");
  end;

  pmnt_prop.bankcodekind = 3;
  pmnt_prop.BankCode = Trim( getRegNumOurBank( PTCK_BIC ) );
  pmnt_prop.BankName = BankName;
  pmnt_prop.PartyID = DestAccount.value("T_CODCLIENT");
  pmnt_prop.Account = DestAccount.value("T_ACCOUNT");
  pmnt_prop.CorrAccount = DestAccount.value("T_TYPE_ACCOUNT");
  pmnt_prop.account_currcode = DestAccount.value("T_CODE_CURRENCY");
  pmnt_prop.Branch = DestAccount.value("T_FNCASH");

  var oldBatchMode = setbatchmode(true);
  AddStackGuard();
  stat = Выполнение_Операции(r_operprm, r_sbdepdoc, pmnt_prop);
  setbatchmode(oldBatchMode);
  var errstackmes: string = "";
  var errstackerr: integer = GetErrorMessage(errstackmes);
  RemoveStackGuard();
  if (stat > 0)
    if ( errstackmes != "" )
      errstackmes = SubStr( (ErrMessage( stat ) + "|" + StrSubst (errstackmes , ErrMessage( stat ), "")), 1 , 241 );
      RunError( errstackmes , stat );
    else
    RunError( ErrMessage( stat ), stat );
  end;
  end;

  OpData.ComissionOut.Sum = RetrieveValue("Operation:Сумма@Комиссия");
  OpData.ComissionOut.Currency = RetrieveValue("Operation:Валюта@Комиссия");
  OpData.OperSubType = RetrieveValue("Operation:ВидСписания@Комиссия");
  OpData.Account = RetrieveValue("Operation:Счет@Комиссия");

  InterDesk_EndDocBunch();

  var retVal : TOperationResult ;
  retVal.OperationID = r_operprm.ApplicationKey;
  retVal.OperDate = r_operprm.Date_Document;
  var rs_SourceCur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  var rs_DestCur = FindCurrency(FINDCURBYCODE_CUR, DestAccount.value("T_CODE_CURRENCY"));
  retVal.SumOut.Currency = RetKernelNatISO(rs_SourceCur.value("T_EXTERNALCODE"));
  retVal.SumIn.Currency = RetKernelNatISO(rs_DestCur.value("T_EXTERNALCODE"));
  retVal.ComissionOut.Currency = RetKernelNatISO(rs_SourceCur.value("T_EXTERNALCODE"));
  retVal.ComissionIn.Currency = RetKernelNatISO(rs_DestCur.value("T_EXTERNALCODE"));

  retVal.ComissionOut.Sum =  OpData.ComissionOut.Sum;
  retVal.ComissionIn.Sum = $0L;

  var SBDEPDOC  = TBFile( "sbdepdoc.dbt", "r" );
  var SBDEPDOC_1 = TRecHandler("sbdepdoc.1");
  SBDEPDOC.KeyNum = 3;
  ClearRecord(SBDEPDOC);
  SBDEPDOC.rec.IAPPLICATIONKIND = r_operprm.ApplicationKind;
  SBDEPDOC.rec.APPLICATIONKEY = r_operprm.ApplicationKey;
  var st = GetEQ (SBDEPDOC);
  if (st)
    SBDEPDOC_1.SetRecordAddr(SBDEPDOC,0,0,True);
    retVal.SumIn.Sum = SBDEPDOC_1.rec.CurrencyBought;
    retVal.SumOut.Sum = retVal.ComissionOut.Sum + SBDEPDOC_1.rec.OutSum;
  else
    retVal.SumIn.Sum = r_sbdepdoc.CurrencyBought;
    retVal.SumOut.Sum = retVal.ComissionOut.Sum + ExternalData.OperData.Sum.Sum;
  end;

  if ( SumByRateKind == true )
    retVal.Rate.Kind = ExternalData.ConvData.Rate.Kind;
  else
    retVal.Rate.Kind = 1;
  end;

  var _Rate, _Changenom, cmd;
  if ( SourceAccount.value("T_CODE_CURRENCY") == 0 )
    cmd = rsdcommand("begin RSU_RTLEXCH.alc_GetRateOfExchange( ?, ?, ?, ?, ?, ?, ?, ?, ? ); end;");
    cmd.addParam( "p_CodeCurrency", RSDBP_IN, rs_DestCur.value("T_CODE_CURRENCY") );
    cmd.addParam( "p_Branch", RSDBP_IN, SourceAccount.value("T_FNCASH") );
    cmd.addParam( "p_DateRate", RSDBP_IN, {curdate} );
    cmd.addParam( "p_TimeRate", RSDBP_IN, Time() );
    if ( SumByRateKind == true )
      cmd.addParam( "p_RateKind", RSDBP_IN, ExternalData.ConvData.Rate.Kind );
    else
      cmd.addParam( "p_RateKind", RSDBP_IN, 1 );
    end;
    cmd.addParam( "p_Sum", RSDBP_IN, $1 );
    cmd.addParam( "p_RateType", RSDBP_IN, 3 );
    cmd.addParam( "Rate", RSDBP_OUT, V_DOUBLE );
    cmd.addParam( "Changenom", RSDBP_OUT, V_DOUBLE );
    cmd.execute;
    _Rate = cmd.value("Rate"); 
    _Changenom = cmd.value("Changenom");

    retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_DestCur.value("T_EXTERNALCODE"));
    retVal.Rate.BaseSum.Sum = $1 * _Changenom;
    retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_SourceCur.value("T_EXTERNALCODE"));
    retVal.Rate.WorkSum.Sum = _Rate;
  elif ( DestAccount.value("T_CODE_CURRENCY") == 0 )
    cmd = rsdcommand("begin RSU_RTLEXCH.alc_GetRateOfExchange( ?, ?, ?, ?, ?, ?, ?, ?, ? ); end;");
    cmd.addParam( "p_CodeCurrency", RSDBP_IN, rs_SourceCur.value("T_CODE_CURRENCY") );
    cmd.addParam( "p_Branch", RSDBP_IN, SourceAccount.value("T_FNCASH") );
    cmd.addParam( "p_DateRate", RSDBP_IN, {curdate} );
    cmd.addParam( "p_TimeRate", RSDBP_IN, Time() );
    if ( SumByRateKind == true )
      cmd.addParam( "p_RateKind", RSDBP_IN, ExternalData.ConvData.Rate.Kind );
    else
      cmd.addParam( "p_RateKind", RSDBP_IN, 1 );
    end;
    cmd.addParam( "p_Sum", RSDBP_IN, $1 );
    cmd.addParam( "p_RateType", RSDBP_IN, 2 );
    cmd.addParam( "Rate", RSDBP_OUT, V_DOUBLE );
    cmd.addParam( "Changenom", RSDBP_OUT, V_DOUBLE );
    cmd.execute;
    _Rate = cmd.value("Rate"); 
    _Changenom = cmd.value("Changenom");

    retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_SourceCur.value("T_EXTERNALCODE"));
    retVal.Rate.BaseSum.Sum = $1 * _Changenom;
    retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_DestCur.value("T_EXTERNALCODE"));
    retVal.Rate.WorkSum.Sum = _Rate;
  else
    retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_DestCur.value("T_EXTERNALCODE"));
    retVal.Rate.BaseSum.Sum = $1;
    retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_SourceCur.value("T_EXTERNALCODE"));
    retVal.Rate.WorkSum.Sum = (retVal.SumOut.Sum - retVal.ComissionOut.Sum)/retVal.SumIn.Sum;
  end;

  var findDocID = rsdcommand("select * from drtdocument_dbt where T_OPAPPLICATIONKEY = :appkey and T_OPAPPLICATIONKIND = :appkind");
  findDocID.AddParam("appkey", RSDBP_IN, r_operprm.ApplicationKey);
  findDocID.AddParam("appkind", RSDBP_IN, r_operprm.ApplicationKind);
  findDocID.nullConversion = true;
  findDocID.execute();
  var rs_findDocID = RsdRecordset(findDocID);
  while ( rs_findDocID.moveNext() )
    retVal.DocumentIDs[retVal.DocumentIDs.size] = rs_findDocID.value("T_DOCUMENTID");
  end;

  return retVal;
end;


private macro getClientName(clientId:integer) : string
  var name = "";
  
  var findName = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = ?");
  findName.AddParam ("name", RSDBP_IN, clientId);
  findName.nullConversion = true;
  findName.execute();
  var rs_findName = RsdRecordset(findName);
  if (rs_findName.moveNext())
    name = rs_findName.value("T_NAME");
  end;

  return name;
end;


/**************************************************************************\
|                   РЕКВИЗИТЫ ВНЕШНЕГО ПЛАТЕЖА (НА СЧЕТ)                   |
\**************************************************************************/
macro AccountIncData(Account)
  var rsAccount;
  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = false;
  findParam.FindWithFncash = true;
  var fndstat = findOpenAccount(rsAccount, Account, findParam);
  if (fndstat)
    RunError( ErrMessage( fndstat ), fndstat );
  end;

  var item = TIncrementDetailsItem;

  if (rsAccount.value("T_CODE_CURRENCY") != 0)
    fillBankInfo(rsAccount.value("T_FNCASH"), false, item);
  else
    fillBankInfo(rsAccount.value("T_FNCASH"), true, item);
  end;

  item.Account = SubStr(rsAccount.value("T_ACCOUNT"),1,20);
  item.PersonName = getClientName(rsAccount.value("T_CodCLIENT"));
  item.Ground = "";

  return item;
end;


/**************************************************************************\
|                   РЕКВИЗИТЫ ВНЕШНЕГО ПЛАТЕЖА (НА ВКЛАД)                  |
\**************************************************************************/
macro DepositIncData(ExternalData)
  var currency = null;
  if ((ValType(ExternalData.Currency) == V_STRING) and (ExternalData.Currency != ""))
    currency = RetRetailNatISO(ExternalData.Currency);
  end;

  var rsAccount;
  var findParam : FindObjParm;
  findParam.Currency = currency;
  findParam.IsFindMCD = true;
  findParam.FindOKCard = false;
  findParam.FindWithFncash = true;
  var fndstat = findOpenAccount(rsAccount, ExternalData.Deposit, findParam);
  if (fndstat)
    RunError( ErrMessage( fndstat ), fndstat );
  end;

  var item = TIncrementDetailsItem;

  if (rsAccount.value("T_CODE_CURRENCY") != 0)
    fillBankInfo(rsAccount.value("T_FNCASH"), false, item);
  else
    fillBankInfo(rsAccount.value("T_FNCASH"), true, item);
  end;

  item.Account = SubStr(rsAccount.value("T_ACCOUNT"),1,20);
  item.PersonName = getClientName(rsAccount.value("T_CodCLIENT"));
  item.Ground = "";

  return item;
end;

/**************************************************************************\
|                         ВЫПИСКА ПО ВКЛАДУ/СЧЕТУ                          |
\**************************************************************************/
macro AccountOperDetail ( ExternalData )
  var SBDEPDOC  = TBFile( "sbdepdoc.dbt", "r" );
  var SBDEPDOC_1 = TRecHandler("sbdepdoc.1");
  var stat = 0;
  var FindByAccount = false; var FindByContract = false;
  var Accounts, Contract;
  var retVal = TArray;
  
  if ( ValType(ExternalData.InfoType) != V_INTEGER )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ExternalData.InfoType < 0) or (ExternalData.InfoType > 1) )
    RunError( ErrMessage( 16509 ), 16509 );
  end;
  if ( (ExternalData.Object.ObjectType == 550) or (ExternalData.Object.ObjectType == 556) )
    FindByContract = true;
    stat = findAccountByContract( Accounts, ExternalData.Object );
    if (stat)
      RunError( ErrMessage( stat ), stat );
    end;
	stat = findAnyContract (Contract, ExternalData.Object);
    if (stat)
      RunError( ErrMessage( stat ), stat );
    end;
  elif ( ExternalData.Object.ObjectType == 551 )
    FindByAccount = true;
    var findParam : FindObjParm;
    findParam.Currency = null;
    findParam.IsFindMCD = false;
    findParam.FindOKCard = false;
    findParam.FindWithFncash = true;
    stat = findOpenAccount ( Accounts, ExternalData.Object, findParam );
    if ( (stat != 0) and (stat != 16512) )
      RunError( ErrMessage( stat ), stat );
    end;
  else
    RunError( ErrMessage( 16530 ), 16530 );
  end;
  var StartDate,EndDate;
  if ( ValType(ExternalData.EndDate) != V_DATE )
    if ( FindByContract )
      if ( (convertNullDate(Contract.value("T_CLOSEDATE")) != Date(0,0,0)) )
        EndDate = min ({curdate},convertNullDate(Contract.value("T_CLOSEDATE")));
      else
        EndDate = {curdate};
      end
    elif ( FindByAccount )
      if ( (convertNullDate(Accounts.value("T_CLOSE_DATE")) != Date(0,0,0)) )
        EndDate = min ({curdate},convertNullDate(Accounts.value("T_CLOSE_DATE")));
      else
        EndDate = {curdate};
      end
    end;
  else
    EndDate = ExternalData.EndDate;
  end;
  if ( ValType(ExternalData.StartDate) != V_DATE )
    if ( FindByContract )
      StartDate = max(convertNullDate(Contract.value("T_OPENDATE")), DateAfterWorkMonths( EndDate, -1 ));
    elif ( FindByAccount )
      StartDate = max(convertNullDate(Accounts.value("T_OPEN_DATE")), DateAfterWorkMonths( EndDate, -1 ));
    end;
  else
    StartDate = ExternalData.StartDate;
  end; 

  var runnextAcc = false;
  if (FindByAccount)
    runnextAcc = true;
  elif (FindByContract)
    if ( (convertNullDate(Accounts.value("T_OPEN_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) )
      runnextAcc = true;
    elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_OPEN_DATE")) <= EndDate) )
      runnextAcc = true;
    elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) != Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) >= StartDate) )
      runnextAcc = true;
    end;
	while ( (not runnextAcc) and (Accounts.moveNext) )
      if ( (convertNullDate(Accounts.value("T_OPEN_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) )
        runnextAcc = true;
      elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_OPEN_DATE")) <= EndDate) )
        runnextAcc = true;
      elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) != Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) >= StartDate) )
        runnextAcc = true;
      end;
    end;
  end;
  var isQuantity = true, Quantity = 0;
  if ( (ValType(ExternalData.Quantity) != V_INTEGER) or (ExternalData.Quantity <= 0) )
    isQuantity = false;
  else
    Quantity = ExternalData.Quantity;
  end;
  while ( runnextAcc  )
    var AccDetail = TAccountExtract;
	AccDetail.AccountID = convertNullInt(Accounts.value("T_REFERENC"));
    AccDetail.Number = SubStr(convertNullStr(Accounts.value("T_ACCOUNT")),1,20);
	var branch = FindBranch(FINDBRANCH_BY_NUMBER, convertNullInt(Accounts.value("T_FNCASH")));
    AccDetail.Branch = convertNullStr(branch.value("T_NAME"));
	var Cur = FindCurrency(FINDCURBYCODE_CUR, convertNullInt(Accounts.value("T_CODE_CURRENCY")));
    AccDetail.Currency = RetKernelNatISO(convertNullStr(Cur.value("T_EXTERNALCODE")));
    AccDetail.Quantity = 0;

    var sql = "SELECT CL.T_APPLICATIONKEY1 OpAppKey, " +
               " DOC.T_REFERENC Referenc, " +
               " DOC.T_TYPE_ACCOUNT Kind, " +
               " DOC.T_ISCUR isCur, " +
               " DOC.T_DATE_DOCUMENT OperDate, " +
               " DOC.T_INSUM CreditSum, " +
               " DOC.T_OUTSUM DebitSum, " +
               " DOC.T_REST RestSum, " +
               " DOC.T_GROUND Ground, " +
               " DOC.T_TYPEOPER TypeOper, " +
               " DOC.T_APPLTYPE OperSubType, " +
               " DOC.T_IAPPLICATIONKIND appkind, " +
               " DOC.T_APPLICATIONKEY appkey " +
               " FROM dsbdepdoc_dbt doc, dsb_casln_dbt cl " +
               " WHERE     DOC.T_ACTION <> 2 " +
               " AND DOC.t_KindOp <> 8 " +
               " AND DOC.t_KindOp <> 9 " +
               " AND DOC.t_KindOp <> 14 " +
               " AND DOC.t_KindOp <> 15 " +
               " AND DOC.t_KindOp <> 16 " +
               " AND DOC.t_Action <> 2 " +
               " AND DOC.t_TypeOper <> 38 " +
               " AND DOC.t_TypeOper <> 39 " +
               " AND DOC.t_Mode <> 2 " +
               " AND BITAND (DOC.t_flags, 131072) = 0 " +
               " AND CL.T_APPLICATIONKIND2 = DOC.T_IAPPLICATIONKIND " +
               " AND CL.T_APPLICATIONKEY2 = DOC.T_APPLICATIONKEY " +
               " AND CL.T_REFVALUE2 = 0 " +
               " AND DOC.T_REFERENC = ? " +
               " and DOC.T_DATE_DOCUMENT between ? and ? ";
    var operCode = ParseOperCodes(ExternalData.OperCodes);
    if (ValType(operCode) == V_INTEGER)
     ;
    else
      sql = sql + " AND ( (DOC.T_TYPEOPER = ? ";
      if (ValType(operCode[0].SubOper) == V_INTEGER)
        sql = sql + " AND DOC.T_APPLTYPE = ? ";
      end;
      sql = sql + " ) ";
      if (operCode.size > 1)
        var i = 1;
        for( i,2,operCode.size )
          sql = sql + " OR ( DOC.T_TYPEOPER = ? ";
          if (ValType(operCode[i-1].SubOper) == V_INTEGER)
            sql = sql + " AND DOC.T_APPLTYPE = ? ";
          end;
          sql = sql + " ) ";
        end;
      end;
      sql = sql + " ) "
    end;
    sql = sql + " ORDER BY DOC.T_REFERENC, DOC.T_DATE_DOCUMENT, DOC.T_NUMDAYDOC ";
    var Detail = rsdcommand (sql);
    Detail.addParam( "Referenc", RsdBp_In, convertNullInt(Accounts.value("T_REFERENC")) );
    Detail.addParam( "begindate", RsdBp_In, StartDate );
    Detail.addParam( "enddate", RsdBp_In, EndDate );
    if (ValType(operCode) == V_INTEGER)
     ;
    else
      Detail.addParam( "numOp", RsdBp_In, operCode[0].Oper );
      if (ValType(operCode[0].SubOper) == V_INTEGER)
        Detail.addParam( "numSubOp", RsdBp_In, operCode[0].SubOper );
      end;
      if (operCode.size > 1)
        var j = 1;
        for( j,1,operCode.size-1 )
          var numop = "numOp" + string(j);
          Detail.addParam( numOp, RsdBp_In, operCode[j].Oper );
          if (ValType(operCode[j].SubOper) == V_INTEGER)
            var numSubOp = "numSubOp" + string(j);
            Detail.addParam( numSubOp, RsdBp_In, operCode[j].SubOper );
          end;
        end;
      end;
    end;
    Detail.nullConversion = true;
    Detail.execute;
    
    var rs_Detail = RsdRecordset(Detail, null, RSDVAL_STATIC);
    while ( (rs_Detail.moveNext) and 
     ( ( (isQuantity) and ( (AccDetail.Quantity < Quantity) or ( (AccDetail.Operations.size >= 1) and 
            ( AccDetail.Operations[AccDetail.Operations.size-1].OperDate == convertNullDate(rs_Detail.value("OperDate")) ) ) ) ) or 
            ( not isQuantity ) ) )
      var Operations = TOperationData;
      Operations.OperDate = convertNullDate( rs_Detail.value("OperDate") );
      Operations.RestIn = rs_Detail.value("RestSum") - rs_Detail.value("CreditSum") + rs_Detail.value("DebitSum");
      if (rs_Detail.value("CreditSum") < rs_Detail.value("DebitSum"))
        Operations.TypeOper = "-";
      elif (rs_Detail.value("CreditSum") > rs_Detail.value("DebitSum"))
        Operations.TypeOper = "+";
      else
        Operations.TypeOper = "";
      end;
      Operations.Sum = abs(rs_Detail.value("CreditSum") - rs_Detail.value("DebitSum"));
      Operations.RestOut = rs_Detail.value("RestSum");
      Operations.Ground = convertNullStr(rs_Detail.value("Ground"));
      Operations.OperationID = convertNullStr(rs_Detail.value("OpAppKey"));
      
      if (ExternalData.InfoType == 1)
      
        var expendParam = " SELECT OP.T_CZNAMEALG OperName, OP.T_NUMOPERT NumOper " + 
                          " FROM dsb_typop_dbt op, dsbdepdoc_dbt doc " +
                          " WHERE OP.T_KIND = DOC.T_TYPE_ACCOUNT AND OP.T_NUMOPERT = DOC.T_TYPEOPER AND OP.T_ISCUR = DOC.T_ISCUR " +
                          " AND DOC.T_APPLICATIONKEY = ? AND DOC.T_IAPPLICATIONKIND = ? ";
        var findexpendParam = rsdcommand(expendParam);
        findexpendParam.AddParam("appKey", RSDBP_IN, convertNullStr(rs_Detail.value("appkey")));
        findexpendParam.AddParam("appKind", RSDBP_IN, convertNullInt(rs_Detail.value("appkind")));
        findexpendParam.nullConversion = true;
        findexpendParam.execute;
        var rs_findexpendParam = RsdRecordset(findexpendParam);
        if ( rs_findexpendParam.moveNext )
          Operations.OperName = convertNullStr(rs_findexpendParam.value("OperName"));
          Operations.OperType = convertNullInt(rs_findexpendParam.value("NumOper"));
        else
          Operations.OperName = "";
          Operations.OperType = 0;
        end;
     
        expendParam = " SELECT SUBOP.T_NAME SubopName, SUBOP.T_TYPE SubopNum " + 
                          " FROM dsuboper_dbt subop, dsbdepdoc_dbt doc " +
                          " WHERE SUBOP.T_KIND = DOC.T_TYPE_ACCOUNT AND SUBOP.T_OPERTYPE = DOC.T_TYPEOPER " +
                          " AND SUBOP.T_ISCUR = DOC.T_ISCUR AND SUBOP.T_TYPE = DOC.T_APPLTYPE " +
                          " AND DOC.T_APPLICATIONKEY = ? AND DOC.T_IAPPLICATIONKIND = ? ";
        findexpendParam = rsdcommand(expendParam);
        findexpendParam.AddParam("appKey", RSDBP_IN, convertNullStr(rs_Detail.value("appkey")));
        findexpendParam.AddParam("appKind", RSDBP_IN, convertNullInt(rs_Detail.value("appkind")));
        findexpendParam.nullConversion = true;
        findexpendParam.execute;
        rs_findexpendParam = RsdRecordset(findexpendParam);
        if ( rs_findexpendParam.moveNext )
          Operations.OperSubName = convertNullStr(rs_findexpendParam.value("SubopName"));
          Operations.OperSubType = convertNullInt(rs_findexpendParam.value("SubopNum"));
        else
          Operations.OperSubName = "";
          Operations.OperSubType = 0;
        end;
      
        Operations.OperType = convertNullInt(rs_Detail.value("TypeOper"));
        Operations.OperSubType = convertNullInt(rs_Detail.value("OperSubType"));
        if ( Operations.OperType == 80 )
          SBDEPDOC.KeyNum = 3;
          ClearRecord(SBDEPDOC);
          SBDEPDOC.rec.IAPPLICATIONKIND = convertNullInt(rs_Detail.value("appkind"));
          SBDEPDOC.rec.APPLICATIONKEY = convertNullStr(rs_Detail.value("appkey"));
          var st = GetEQ (SBDEPDOC);
          if (st)
            SBDEPDOC_1.SetRecordAddr(SBDEPDOC,0,0,True);
            var Sum = SBDEPDOC_1.rec.CurrencyBought;
            Operations.CorSum.Sum = Sum;
            var findcorSumCur = rsdcommand("SELECT CUR.T_EXTERNALCODE EXTERNALCODE FROM ddepositr_dbt dep, dcurrency_dbt cur "
                                            " WHERE DEP.T_CODE_CURRENCY = CUR.T_CODE_CURRENCY AND DEP.T_REFERENC = ?");
            findcorSumCur.addParam( "Referenc", RsdBp_In, SBDEPDOC_1.rec.CorrAcc_Referenc );
            findcorSumCur.nullConversion = true;
            findcorSumCur.execute;
            var rs_findcorSumCur = RsdRecordset(findcorSumCur);
            if ( rs_findcorSumCur.moveNext )
              Operations.CorSum.Currency = RetKernelNatISO(convertNullStr(rs_findcorSumCur.value("EXTERNALCODE")));
            else
              Operations.CorSum.Currency = "";
            end;
          end;
        end;
        if ( (Operations.OperType == 62) 
          or (Operations.OperType == 63) 
          or (Operations.OperType == 64)
          or (Operations.OperType == 65)
          or (Operations.OperType == 66)
          or (Operations.OperType == 67)
          or (Operations.OperType == 80)
          or (Operations.OperType == 87)
          or (Operations.OperType == 92) )
          Operations.Recipient = getRecipientParam(convertNullInt(rs_Detail.value("appkind")), convertNullStr(rs_Detail.value("appkey")));
          if ( (Operations.Recipient.BankID <= 0) and (Operations.Recipient.BankCode == "") ) //на крайний случай
            var NullRecipient = TExtRecipient;
            Operations.Recipient = NullRecipient;
          end;
        end;
      end;
      AccDetail.Quantity = AccDetail.Quantity + 1;
      AccDetail.Operations[AccDetail.Operations.size] = Operations;
    end;

    var findLastOperDate = rsdcommand("SELECT * FROM dsbdepdoc_dbt " + 
                                      "WHERE T_REFERENC = ? AND T_DATE_DOCUMENT < ? " + 
                                        "AND T_TYPEOPER not in ( 38, 39 ) " +
                                        "AND T_ACTION not in ( 2, 11 ) " + // D_DELETE и D_STORN
                                        "AND T_KINDOP not in ( 8, 9, 14, 15, 16 ) " +
                                        "AND T_MODE <> 2 AND bitand( T_FLAGS, 131072 ) = 0 " + // MODE_EOY_PRECALC документ предварительного расчета и BIT_FLAG_HIDDEN
                                      "ORDER BY T_DATE_DOCUMENT DESC");
    findLastOperDate.addParam( "Referenc", RsdBp_In, convertNullInt(Accounts.value("T_REFERENC")) );
    findLastOperDate.addParam( "Date", RsdBp_In, StartDate );
    findLastOperDate.nullConversion = true;
    findLastOperDate.execute;
    var rs_findLastOperDate = RsdRecordset(findLastOperDate);
    if ( rs_findLastOperDate.moveNext )
      AccDetail.LastOperDate = convertNullDate( rs_findLastOperDate.value("T_DATE_DOCUMENT") )
    else
      AccDetail.LastOperDate = convertNullDate( Accounts.value("T_OPEN_DATE") )
    end;

    if (rs_Detail.moveLast)
      AccDetail.RestOut =  rs_Detail.value("RestSum");
      AccDetail.DebitSum = rs_Detail.value("DebitSum");
      AccDetail.CreditSum = rs_Detail.value("CreditSum");
    else
      AccDetail.RestOut =  $0;
      AccDetail.DebitSum = $0;
      AccDetail.CreditSum = $0;
    end;
    while (rs_Detail.movePrev)
      AccDetail.DebitSum = AccDetail.DebitSum + rs_Detail.value("DebitSum");
      AccDetail.CreditSum = AccDetail.CreditSum + rs_Detail.value("CreditSum");
    end;
    if (rs_Detail.moveFirst)
      AccDetail.RestIn = rs_Detail.value("RestSum") - rs_Detail.value("CreditSum") + rs_Detail.value("DebitSum");
    else
      AccDetail.RestIn = $0;
    end;
    retVal[retVal.size] = AccDetail;
    if ( not Accounts.moveNext )
      runnextAcc = false;
      continue;
    end;
    runnextAcc = false;
    if (FindByContract)
      if ( (convertNullDate(Accounts.value("T_OPEN_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) )
        runnextAcc = true;
      elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_OPEN_DATE")) <= EndDate) )
        runnextAcc = true;
      elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) != Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) >= StartDate) )
        runnextAcc = true;
      end;
	  while ((not runnextAcc) and (Accounts.moveNext) )
        if ( (convertNullDate(Accounts.value("T_OPEN_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) )
          runnextAcc = true;
        elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) == Date(0,0,0)) and (convertNullDate(Accounts.value("T_OPEN_DATE")) <= EndDate) )
          runnextAcc = true;
        elif( (convertNullDate(Accounts.value("T_CLOSE_DATE")) != Date(0,0,0)) and (convertNullDate(Accounts.value("T_CLOSE_DATE")) >= StartDate) )
          runnextAcc = true;
        end;
      end;
    end;
  end;
  return retVal;
end;

private class LastOperOnDateInfo
  var OperationDate : Date;
  var SummaVal : Money;
  var SummaRUB : Money;
end;
private macro FindLastOperOnDate ( objectType : Integer, objectID : String, opDate : Date, CodeCurrencyAccount : Integer, TypeCurRate : Integer )
  var retVal;
  record convdata("convert_cum_data.rsl");
  var findLastOpsql = "";

  if ( objectType == 551 )
    findLastOpsql = "SELECT * FROM dsbdepdoc_dbt " + 
                    "WHERE T_REFERENC = ? " + 
                      "AND T_DATE_DOCUMENT <= ? " + 
                      "AND T_TYPEOPER not in ( 38, 39 ) " +
                      "AND T_ACTION not in ( 2, 11 ) " + // D_DELETE и D_STORN
                      "AND T_KINDOP not in ( 8, 9, 14, 15, 16 ) " +
                      "AND T_MODE <> 2 AND bitand( T_FLAGS, 131072 ) = 0 " + // MODE_EOY_PRECALC документ предварительного расчета и BIT_FLAG_HIDDEN
                    "ORDER BY T_DATE_DOCUMENT DESC, T_NUMDAYDOC DESC";
  else
    findLastOpsql = "  SELECT * FROM dsccrddoc_dbt WHERE t_Action <> 2 AND t_fncash = ? AND t_acccardlinkref = ? AND t_date <= ? ORDER BY t_date DESC, t_numdaydoc DESC";
  end;

  var findLastOp = rsdcommand(findLastOpsql);
  if ( objectType == 551 )
    findLastOp.AddParam ("Ref",RSDBP_IN,Int(objectID));
  else
    var ExtBranch = int(SubStr(objectID, 1, StrBrk(objectID,"/")));
    var ExtLinkRef = int(SubStr(objectID, StrBrk(objectID,"/") + 1));
    findLastOp.AddParam ("fncash",RSDBP_IN,ExtBranch);
    findLastOp.AddParam ("linkRef",RSDBP_IN,ExtLinkRef);
  end;
  
  findLastOp.AddParam ("DateDoc",RSDBP_IN, opDate);
  findLastOp.nullConversion = true;
  findLastOp.execute();
  var rs_findLastOp = RsdRecordset(findLastOp);
  if ( rs_findLastOp.moveNext )
    retVal = LastOperOnDateInfo;
    if ( objectType == 551 )
      retVal.OperationDate = rs_findLastOp.value("t_Date_Document");
    else
      retVal.OperationDate = rs_findLastOp.value("t_Date");
    end;
    
    retVal.SummaVal = rs_findLastOp.value("t_Rest");
    retVal.SummaRUB = $0;

    if ( (CodeCurrencyAccount > 0) and (retVal.SummaVal > $0) )
      var cdata;
      var stat = ConvertSumEx(CodeCurrencyAccount, 0, retVal.SummaVal, opDate, 1, 0, TypeCurRate, -1, false, cdata );
      if ( stat == 0 )
        SetBuff(convdata,cdata);
        retVal.SummaRUB = convdata.ToSumma;
      end;
    else
      retVal.SummaRUB = retVal.SummaVal;
    end;
  end;
  return retVal;
end;
private macro IsFullArrestAccountOnDate ( accountID : Integer, opDate : Date )
  var accountArrest = false;
  var findFullArrestBegin = rsdcommand("SELECT op.* FROM dret_op_dbt ret, dopobject_dbt op WHERE ret.t_operation = 252 "
                                       " AND ret.t_applicationkind = 3001 AND ret.t_applicationkind = op.t_opappkind "
                                       " AND ret.t_applicationkey = op.t_opappkey AND op.T_OBJECTTYPE = 1 AND op.T_DATE <= ? "
                                       " AND op.T_OBJECTREF = ? ORDER BY op.t_date DESC");
  findFullArrestBegin.AddParam ("dateop",RSDBP_IN,opDate);
  findFullArrestBegin.AddParam ("Ref",RSDBP_IN,String(accountID));
  findFullArrestBegin.nullConversion = true;
  findFullArrestBegin.execute();
  var rs_findFullArrestBegin = RsdRecordset(findFullArrestBegin);
  if ( rs_findFullArrestBegin.moveNext )
    var datebegin = rs_findFullArrestBegin.value("T_DATE");
    var findFullArrestEnd = rsdcommand("SELECT op.* FROM dret_op_dbt ret, dopobject_dbt op WHERE ret.t_operation = 255 "
                                       " AND ret.t_applicationkind = 3001 AND ret.t_applicationkind = op.t_opappkind  "
                                       " AND ret.t_applicationkey = op.t_opappkey AND op.T_OBJECTTYPE = 1 AND op.T_DATE <= ? AND op.T_DATE >= ?"
                                       " AND op.T_OBJECTREF = ? ORDER BY op.t_date DESC");
    findFullArrestEnd.AddParam ("dateop",RSDBP_IN,opDate);
    findFullArrestEnd.AddParam ("datebegin",RSDBP_IN,datebegin);
    findFullArrestEnd.AddParam ("Ref",RSDBP_IN,String(accountID));
    findFullArrestEnd.nullConversion = true;
    findFullArrestEnd.execute();
    var rs_findFullArrestEnd = RsdRecordset(findFullArrestEnd);
    if ( rs_findFullArrestEnd.movenext )
      accountArrest = false;
    else
      accountArrest = true;
    end;
  else
    accountArrest = false;
  end;
  return accountArrest;
end;

private macro FindPartArestInfo ( accountID : Integer, opDate : Date, CodeCurrencyAccount : Integer, TypeCurRate : Integer )
  var retVal;
  record convdataArest("convert_cum_data.rsl");

  var arrestedSum = GetArrestedSum(accountID, NumFNcash(), opDate, time(), opDate);

  retVal = LastOperOnDateInfo;
  retVal.SummaVal = arrestedSum;
  if ( (retVal.SummaVal) and (CodeCurrencyAccount > 0) )
    var cdataArest;
    var stat = ConvertSumEx(CodeCurrencyAccount, 0, retVal.SummaVal, opDate, 1, 0, TypeCurRate, -1, false, cdataArest );
    if ( stat == 0 )
      SetBuff(convdataArest,cdataArest);
      retVal.SummaRUB = convdataArest.ToSumma;
    end;
  else
    retVal.SummaRUB = retVal.SummaVal;
  end;
  return retVal;
end;

private class CIKBankInfo
  var BIC : String;
  var OGRN : String;
  var INN : String;
  var KPP : String;
  var RegionCode : String;
  var Address : String;
  var DeptCode : String;
end;

private macro CIKFillBankInfo ( FnCash : Integer, AccountNumber : String )
  var retVal = CIKBankInfo;
  var item = TIncrementDetailsItem;
  var item2 = TIncrementDetailsItem;

  fillBankInfo(FnCash, true, item);
  retVal.BIC = item.BankCode;
  var BankName, CorAccount, Bank_INN, Bank_KPP, BankID;
  iFindBank( item.BankCodeKind, item.BankCode, BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
  findBankCode( 27/*ОГРН*/, FnCash, item2 );
  retVal.OGRN = item2.BankCode;
  retVal.INN = Bank_INN;
  retVal.KPP = Bank_KPP;

  var filcode = GetFilial( Fncash );
  var ddep =  TRecHandler( "i_dp_dep.rec" ), party = TRecHandler( "i_party.rec" );
  if ( findDepartment(filcode, NULL, ddep, party) )
    var findBankAddr = rsdcommand("SELECT * FROM dadress_dbt WHERE t_partyid = ? and t_type in (3,1,2) order by decode ( t_type, 3,1,1,2,3 )");
    findBankAddr.AddParam ("BankID",RSDBP_IN,party.rec.partyID);
    findBankAddr.nullConversion = true;
    findBankAddr.execute();
    var rsfindBankAddr = RsdRecordset(findBankAddr);
    if ( rsfindBankAddr.moveNext() )
      retVal.RegionCode = rsfindBankAddr.value("T_REGIONNUM");
      retVal.Address = rsfindBankAddr.value("T_ADRESS");
    end;
  end;
  retVal.DeptCode = SubStr( AccountNumber, 10, 4 ); // начинается с 10 символа
  
  return retVal;
end;


class TCIKAccListData
  var ReqID;
  var OrigReq;
  var TypeID;
  var ClientID;
  var ReqFindClient;
  var DataReq;
  var TypeCloseAcc;
  var TypeCurRate;
  var NoVip;
  var Twins;
end;


/**************************************************************************\
|                         ЗАПРОС О НАЛИЧИИ СЧЕТОВ                          |
\**************************************************************************|
ReqID
OrigReq
TypeID
ClientID
ReqFindClient
DataReq
TypeCloseAcc
TypeCurRate
NoVip
*/
private macro RetailAccountListPrv ( ExternalData: TCIKAccListData )
  var stat = 0;
  var TypeCloseAcc = "O";
  var TypeCurRate = 1;
  var DateReq = date();
  var retVal : TCIKAccountListResult;
  var CodClient = 0;
  record convdataRate("convert_cum_data.rsl");
  var cdataRate;

  if ( (ValType( ExternalData.ClientID ) != V_STRING) or (ExternalData.ClientID == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  
  if ( (ValType( ExternalData.TypeID ) != V_STRING) or (ExternalData.TypeID == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( (ValType( ExternalData.TypeCloseAcc ) == V_STRING) and (ExternalData.TypeCloseAcc != "") )
    TypeCloseAcc = ExternalData.TypeCloseAcc;
  end;

  if ( (ValType( ExternalData.TypeCurRate ) == V_STRING) and ( (Int(ExternalData.TypeCurRate) > 0) and (Int(ExternalData.TypeCurRate) < 4) ) )
    TypeCurRate = Int(ExternalData.TypeCurRate);
  end;

  if ( (ValType( ExternalData.DataReq ) == V_DATE) and ( ExternalData.DataReq != Date(0,0,0) ) )
    DateReq = ExternalData.DataReq;
  end;

  if ( Int(ExternalData.TypeID) == 0 )
    var findClntCount = rsdcommand("select count (*) clntcount FROM dparty_dbt WHERE T_PARTYID = ?");
    findClntCount.AddParam("CodClient", RSDBP_IN, Int(ExternalData.ClientID));
    findClntCount.nullConversion = true;
    findClntCount.execute();
    var clntCount = RsdRecordset(findClntCount);
    if ( clntCount.moveNext() )
      retVal.CountClient = clntCount.value("clntcount");
    end;

    if ( retVal.CountClient == 1 )
      CodClient = Int(ExternalData.ClientID);
    end;
  elif ( Int(ExternalData.TypeID) > 0 )
    CodClient = GetCodeParty( ExternalData.ClientID, Int(ExternalData.TypeID) );
    if ( CodClient <= 0 )
      retVal.CountClient = 0;
    elif ( CodClient > 0 )
      retVal.CountClient = 1;
    end;
  end;

  if ( retVal.CountClient == 1 )
    retVal.ClientID = Int(CodClient);

    var findClntByPartyID = rsdcommand("SELECT * FROM dparty_dbt WHERE T_PARTYID = ? ");
    findClntByPartyID.AddParam("CodClient", RSDBP_IN, Int(CodClient));
    findClntByPartyID.nullConversion = true;
    findClntByPartyID.execute();
    var rsfindClntByPartyID = RsdRecordset(findClntByPartyID);
    if ( rsfindClntByPartyID.moveNext() )
      if (rsfindClntByPartyID.value("t_LegalForm") == 1)
        retVal.ClientFullName = rsfindClntByPartyID.value("t_Name");
        retVal.Vip = false;
      else
        getClientFIO( Int(CodClient), retVal.ClientFullName, retVal.Vip );
      end;
    end;
  end;  

  retVal.ReqID = ExternalData.ReqID;
  GetRegistryValue( "RS-CONNECT\\SENDERID\\RETAIL", V_STRING, retVal.SenderID, stat );
  retVal.RealDateTime = DtTm( date(), time() );

  // параметры операциониста
  var contractor = 0;
  GetRegistryValue( "RS-CONNECT\\ЦИК\\RETAIL\\CONTRACTOR", V_INTEGER, contractor, stat );
  var findOperPartyID = rsdcommand("SELECT * FROM dperson_dbt WHERE T_Oper = ? ");
  findOperPartyID.AddParam("oper", RSDBP_IN, contractor);
  findOperPartyID.nullConversion = true;
  findOperPartyID.execute();
  var rsfindOperPartyID = RsdRecordset(findOperPartyID);
  if ( rsfindOperPartyID.moveNext() )
    var CodOper = Int(rsfindOperPartyID.value("t_partyID"));
    retVal.Contractor.FIO = getClientName( CodOper );
    var Value = "";
    FindAdressContactValue(CodOper, PTADDR_LEGAL, CNTADR_PHONENUMBER, Value); // определяем телефон
    retVal.Contractor.Phone = Value;
  end;

  if ( retVal.CountClient != 1 )
    return retVal;
  end;

  // Основной запрос по отбору счетов по заданным параметрам
  var strfindAcc = "select d.* from ddepositr_dbt d where d.t_codclient = ? and d.T_USERTYPEACCOUNT not like '%S%' ";
  
  if ( TypeCloseAcc == "C" )
    strfindAcc = strfindAcc + " and d.t_close_date <= ? ";
    strfindAcc = strfindAcc + "and d.t_open_close = 'З' and d.t_action <> 2 and d.t_action <> 11 ";
  elif ( TypeCloseAcc == "A" )
    strfindAcc = strfindAcc + " and d.t_open_date <= ? ";
    strfindAcc = strfindAcc + " and d.t_action <> 2 and d.t_action <> 11 ";
  elif ( TypeCloseAcc == "O" )
    strfindAcc = strfindAcc + " and d.t_open_date <= ? ";
    strfindAcc = strfindAcc + " and ( d.t_open_close = chr(0) or d.t_close_date > ? ) ";
    strfindAcc = strfindAcc + " and d.t_action <> 2 and d.t_action <> 11 ";
  end;

  var fndAccounts = rsdcommand ( strfindAcc );
  fndAccounts.AddParam("CodClient", RSDBP_IN, Int(CodClient));
  fndAccounts.AddParam("DateReq", RSDBP_IN, DateReq);

  if ( TypeCloseAcc == "O" )
    fndAccounts.AddParam("DateClose", RSDBP_IN, DateReq);
  end;

  fndAccounts.nullConversion = true;
  fndAccounts.execute();
  var Account = RsdRecordset(fndAccounts);
  while ( Account.moveNext() )
    var Data = TCIKAccountData;
    var NROrest = $0;

    // Если запрашиваются счета с TypeCloseAcc = "O" || "A", то из карточных счетов отбираем только те, которые удовлетворяют следующим условиям:
    // - либо все карты, связанные с карточным счетом, закрыты (выполнено <окончательное закрытие> карт)
    // - либо по карточному счету имеется не нулевой нераспределенный (по субсчетам карт) остаток
    if ( (TypeCloseAcc != "C") and (Index( convertNullStr(Account.value("T_USERTYPEACCOUNT")), "К" ) > 0) )
      if ( isExistsOpenCards( Account.value("T_REFERENC"), DateReq ) )
        NROrest = GetCardUndividedRest( Account.value("T_REFERENC"), DateReq );
        if ( NROrest == $0 )
          continue;
        end;
      end;
    end;

    if ( StrBrk(Account.value("T_USERTYPEACCOUNT"), "Щ") > 0 ) // счет типа "Т"
      Data.AccountType = "02";
    elif ( StrBrk(Account.value("T_USERTYPEACCOUNT"), "М") > 0 ) // Счет типа "М"
      Data.AccountType = "17";
    elif ( StrBrk(Account.value("T_USERTYPEACCOUNT"), "К") > 0 ) // Спецкарточный счет
      Data.AccountType = "08";
    else
      Data.AccountType = "03";
    end;

    Data.Acc = SubStr(Account.value("T_ACCOUNT"),1,20);

    //Data.PersonalAcc // номер карты не указывается
    // AccountName не указывается

    // ищем параметры банка
    var accBankInfo = CIKFillBankInfo ( Account.value("T_FNCASH"), Data.Acc );
    Data.BicBank = accBankInfo.BIC;
    Data.BankOGRN = accBankInfo.OGRN;
    Data.BankINN = accBankInfo.INN;
    Data.BankKPP = accBankInfo.KPP;
    Data.BankRegionCode = accBankInfo.RegionCode;
    Data.BankAddress = accBankInfo.Address;
    Data.DeptCode = accBankInfo.DeptCode;

    var findcontract = rsdcommand("SELECT * FROM drt_contract_dbt WHERE t_branch = ? and t_number = ?");
    findcontract.AddParam ("fncash",RSDBP_IN,Account.value("t_fncash"));
    findcontract.AddParam ("Number",RSDBP_IN,Account.value("T_SvodAccount"));
    findcontract.nullConversion = true;
    findcontract.execute();
    var rsfindcontract = RsdRecordset(findcontract);
    if ( rsfindcontract.moveNext() )
      Data.ContractNumber = rsfindcontract.value("t_number");
      Data.ContractStartDate = rsfindcontract.value("t_opendate");
    end;

    Data.ContractFinDate = Account.value("t_end_datedep");

    var findCurr = FindCurrency(FINDCURBYCODE_CUR, Account.value("T_CODE_CURRENCY"));
    Data.CurrencyCode = String(findCurr.value("T_EXTERNALCODE"));

    // определим остаток на счете
    var acclastoper = FindLastOperOnDate( 551, String(Account.value("T_REFERENC")), DateReq, Account.value("T_CODE_CURRENCY"), TypeCurRate );
    if ( ValType(acclastoper) != V_UNDEF )
      Data.DateMove = acclastoper.OperationDate;
      Data.SummaVal = acclastoper.SummaVal;
      Data.SummaRUB = acclastoper.SummaRUB;
    else
      Data.DateMove = Data.ContractStartDate;
      Data.SummaVal = $0;
      Data.SummaRUB = $0;
    end;
    if ( NROrest > $0 )
      Data.SummaVal = NROrest;
      Data.SummaRUB = $0;
      if ( Account.value("T_CODE_CURRENCY") > 0 )
        stat = ConvertSumEx(Account.value("T_CODE_CURRENCY"), 0, Data.SummaVal, DateReq, 1, 0, TypeCurRate, -1, false, cdataRate );
        if ( stat == 0 )
          SetBuff(convdataRate,cdataRate);
          Data.SummaRUB = convdataRate.ToSumma;
        end;
      else
        Data.SummaRUB = NROrest;
      end;
    end;

    //определение полного ареста счета
    var needfindpartarrest = false;
    var accountIsArrest = IsFullArrestAccountOnDate( Account.value("T_REFERENC"), DateReq );
    if ( accountIsArrest )
      Data.SummaArestVal = Data.SummaVal;
      Data.SummaArestRUB = Data.SummaRUB;
      Data.RealRestVal = $0;
      Data.RealRestRUB = $0;
    else
      needfindpartarrest = true;
    end;

    // найдем сумму частичного ареста
    if ( needfindpartarrest )
      var partArestAcc = FindPartArestInfo( Account.value("T_REFERENC"), DateReq, Account.value("T_CODE_CURRENCY"), TypeCurRate );
      if ( ValType(partArestAcc) == V_UNDEF )
        Data.SummaArestVal = $0;
        Data.SummaArestRUB = $0;
        Data.RealRestVal = Data.SummaVal;
        Data.RealRestRUB = Data.SummaRUB;
      else
        Data.SummaArestVal = partArestAcc.SummaVal;
        Data.SummaArestRUB = partArestAcc.SummaRUB;
      
        if ( Data.SummaArestVal > Data.SummaVal )
          Data.RealRestVal = $0;
          Data.RealRestRUB = $0;
        else
          Data.RealRestVal = Data.SummaVal - Data.SummaArestVal;
          Data.RealRestRUB = Data.SummaRUB - Data.SummaArestRUB;
        end;
      end;
    end;
    
    Data.DateChange = DateReq;

    Data.BaseCurRate = $1;
    Data.RubRate = $1;

    if ( Account.value("T_CODE_CURRENCY") > 0 )
      stat = ConvertSumEx(Account.value("T_CODE_CURRENCY"), 0, $1, DateReq, 1, 0, TypeCurRate, -1, false, cdataRate );
      if ( stat == 0 )
        SetBuff(convdataRate,cdataRate);
        Data.RubRate = convdataRate.ToSumma;
      end;
    end;
    
    retVal.Accounts[retVal.Accounts.size] = Data;
  end;

  var findAllCardsql = "select * from dsccard_dbt where t_codclient = ?";

  if ( TypeCloseAcc == "C" )
    findAllCardsql = findAllCardsql + " and t_cardclosedate <= ? ";
    findAllCardsql = findAllCardsql + "and T_CARDOPENCLOSE = CHR (1) ";
  elif ( TypeCloseAcc == "A" )
    findAllCardsql = findAllCardsql + " and t_cardopendate <= ? ";
  elif ( TypeCloseAcc == "O" )
    findAllCardsql = findAllCardsql + " and t_cardopendate <= ? ";
    findAllCardsql = findAllCardsql + "and T_CARDOPENCLOSE = CHR (0) ";
  end;
  var findAllCard = rsdcommand(findAllCardsql);
  findAllCard.AddParam ("CodClient",RSDBP_IN,CodClient);
  findAllCard.AddParam ("DateReq",RSDBP_IN,DateReq);
  findAllCard.nullConversion = true;
  findAllCard.execute();
  var Card = RsdRecordset(findAllCard);
  while ( Card.movenext )
    fndAccounts = rsdcommand("SELECT dep.* FROM dsclink_dbt lnk, ddepositr_dbt dep WHERE lnk.t_fncash = ? AND lnk.t_cardref = ? AND lnk.t_cardaccref = dep.t_referenc");
    fndAccounts.AddParam ("fncash",RSDBP_IN,Card.value("t_fncash"));
    fndAccounts.AddParam ("cardref",RSDBP_IN,Card.value("t_cardref"));
    fndAccounts.nullConversion = true;
    fndAccounts.execute();
    Account = RsdRecordset(fndAccounts);
    if ( Account.movenext )
      var CardData = TCIKAccountData;

      CardData.AccountType = "08"; //Карточный счет
      CardData.Acc = SubStr(Account.value("T_ACCOUNT"),1,20);
      CardData.PersonalAcc = Card.value("t_cardnumber");
      // AccountName не указывается

      var cardBankInfo = CIKFillBankInfo ( Account.value("T_FNCASH"), CardData.Acc );
      CardData.BicBank = cardBankInfo.BIC;
      CardData.BankOGRN = cardBankInfo.OGRN;
      CardData.BankINN = cardBankInfo.INN;
      CardData.BankKPP = cardBankInfo.KPP;
      CardData.BankRegionCode = cardBankInfo.RegionCode;
      CardData.BankAddress = cardBankInfo.Address;
      CardData.DeptCode = cardBankInfo.DeptCode;

      var findcardcontract = rsdcommand("SELECT * FROM drt_contract_dbt WHERE t_branch = ? and t_id = ?");
      findcardcontract.AddParam ("fncash",RSDBP_IN,Card.value("t_fncash"));
      findcardcontract.AddParam ("contractid",RSDBP_IN,Card.value("t_contractid"));
      findcardcontract.nullConversion = true;
      findcardcontract.execute();
      var rsfindcardcontract = RsdRecordset(findcardcontract);
      if ( rsfindcardcontract.moveNext() )
        CardData.ContractNumber = rsfindcardcontract.value("t_number");
        CardData.ContractStartDate = rsfindcardcontract.value("t_opendate");
        CardData.ContractFinDate = rsfindcardcontract.value("t_enddate");
      end;

      var findCardCurr = FindCurrency(FINDCURBYCODE_CUR, Account.value("T_CODE_CURRENCY"));
      CardData.CurrencyCode = String(findCardCurr.value("T_EXTERNALCODE"));

      // ищем остаток на скс
      var needfindlastcardop = true;
      var MainCard = RsdCommand( "select * from drtcardcontract_dbt cntr where cntr.t_branch = ? and cntr.t_id = ?" );
      MainCard.addParam( "p_Branch", RsdBp_In, convertNullInt(Card.value("T_FNCASH")) );
      MainCard.addParam( "p_CntrId", RsdBp_In, convertNullInt(Card.value("T_CONTRACTID")) );
      MainCard.nullConversion = true;
      MainCard.execute;
      var rs_MainCard = RsdRecordset( MainCard );
      if ( rs_MainCard.moveNext )
        if ( ( convertNullInt( rs_MainCard.value( "T_MAINCARDCNTRID" ) ) > 0 ) and ( rs_MainCard.value( "T_ADDCARDOWNACC" ) == StrFor(0) ) )
          var fndMainCardClientCode = RsdCommand( "select t_codclient from dsccard_dbt where t_fncash = ? and t_contractid = ? and t_currentcntrcard = 'X'" );
          fndMainCardClientCode.addParam( "p_Branch", RsdBp_In, Card.value("T_FNCASH") );
          fndMainCardClientCode.addParam( "p_ContractId", RsdBp_In, convertNullInt( rs_MainCard.value( "T_MAINCARDCNTRID" ) ) );
          fndMainCardClientCode.nullConversion = true;
          fndMainCardClientCode.execute();
          var MainCardClientCode = RsdRecordset( fndMainCardClientCode );
          if ( (MainCardClientCode.moveNext()) and (MainCardClientCode.value("t_codclient") == CodClient) )
            needfindlastcardop = false;
            CardData.SummaVal = $0;
            CardData.SummaRUB = $0;
          end;
        end;
      end;

      if ( needfindlastcardop )
        var sclinkCmd = RsdCommand( "select case t_MainSubAccLinkRef when 0 then t_acccardlinkref else t_MainSubAccLinkRef end linkRef "
                                    "from dsclink_dbt "
                                    "where T_FNCASH = ? "
                                    "  and T_CARDREF = ? "
                                    "  and T_ACCCARDLINKOPENCLOSE = chr(0) ");
        sclinkCmd.addParam("fncash", RsdBp_In, convertNullInt(Card.value("t_fncash")));
        sclinkCmd.addParam("CARDREF", RsdBp_In, convertNullInt(Card.value("t_cardRef")));
        sclinkCmd.nullConversion = true;
        sclinkCmd.execute();
        var rs_sclink = RsdRecordset(sclinkCmd);
        if (rs_sclink.MoveNext())
          var lastoper = FindLastOperOnDate( 554, String(Card.value("t_fncash"))+"/"+String(Int(rs_sclink.value("linkRef"))), DateReq, Account.value("T_CODE_CURRENCY"), TypeCurRate );
           if ( ValType(lastoper) != V_UNDEF )
             CardData.DateMove = lastoper.OperationDate;
             CardData.SummaVal = lastoper.SummaVal;
             CardData.SummaRUB = lastoper.SummaRUB;
           else
             CardData.DateMove = CardData.ContractStartDate;
             CardData.SummaVal = $0;
             CardData.SummaRUB = $0;
           end;
        end;

      end;


      //определение полного ареста счета
      var needfindpartarrestcard = false;
      var cardAccountIsArrest = IsFullArrestAccountOnDate( Account.value("T_REFERENC"), DateReq );
      if ( cardAccountIsArrest )
        CardData.SummaArestVal = CardData.SummaVal;
        CardData.SummaArestRUB = CardData.SummaRUB;
        CardData.RealRestVal = $0;
        CardData.RealRestRUB = $0;
      else
        needfindpartarrestcard = true;
      end;

      // найдем сумму частичного ареста
      if ( needfindpartarrest )
        var partArest = FindPartArestInfo( Account.value("T_REFERENC"), DateReq, Account.value("T_CODE_CURRENCY"), TypeCurRate );
        if ( ValType(partArest) == V_UNDEF )
          CardData.SummaArestVal = $0;
          CardData.SummaArestRUB = $0;
          CardData.RealRestVal = CardData.SummaVal;
          CardData.RealRestRUB = CardData.SummaRUB;
        else
          CardData.SummaArestVal = partArest.SummaVal;
          CardData.SummaArestRUB = partArest.SummaRUB;

          if ( CardData.SummaArestVal > CardData.SummaVal )
            CardData.RealRestVal = $0;
            CardData.RealRestRUB = $0;
          else
            CardData.RealRestVal = CardData.SummaVal - CardData.SummaArestVal;
            CardData.RealRestRUB = CardData.SummaRUB - CardData.SummaArestRUB;
          end;
        end;
      end;

      CardData.DateChange = DateReq;

      CardData.BaseCurRate = $1;
      CardData.RubRate = $1;

      if ( Account.value("T_CODE_CURRENCY") > 0 )
        stat = ConvertSumEx(Account.value("T_CODE_CURRENCY"), 0, $1, DateReq, 1, 0, TypeCurRate, -1, false, cdataRate );
        if ( stat == 0 )
          SetBuff(convdataRate,cdataRate);
          CardData.RubRate = convdataRate.ToSumma;
        end;
      end;
    end;

    retVal.Accounts[retVal.Accounts.size] = CardData;
  end;

  retVal.CountAcc = retVal.Accounts.size;

  return retval;
end;

/**************************************************************************\
|                         ЗАПРОС О НАЛИЧИИ СЧЕТОВ                          |
\**************************************************************************|
ReqID
OrigReq
TypeID
ClientID
ReqFindClient
DataReq
TypeCloseAcc
TypeCurRate
NoVip
Twins
*/
macro RetailAccountList ( ExternalData )
  if (not checkDoublerClientList(ExternalData.Twins))
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var prm = TCIKAccListData;
  prm.ReqID = ExternalData.ReqID;
  prm.OrigReq = ExternalData.OrigReq;
  prm.TypeID = ExternalData.TypeID;
  prm.ClientID = ExternalData.ClientID;
  prm.ReqFindClient = ExternalData.ReqFindClient;
  prm.DataReq = ExternalData.DataReq;
  prm.TypeCloseAcc = ExternalData.TypeCloseAcc;
  prm.TypeCurRate = ExternalData.TypeCurRate;
  prm.NoVip = ExternalData.NoVip;

  var retval = RetailAccountListPrv(prm);

  if ((ExternalData.Twins != null) and (ExternalData.Twins.size() > 0))
    var clnt;
    for (clnt, ExternalData.Twins)
      prm.ClientID = clnt.LocalID;
      prm.TypeID = clnt.TypeID;

      var ret2 = RetailAccountListPrv(prm);

      var acc;
      for (acc, ret2.Accounts)
        retval.Accounts[retval.Accounts.size()] = acc;
        retval.CountAcc = retval.CountAcc + 1;
      end;
    end;

    /*retval.CountClient = retval.CountClient + ExternalData.Twins.size();
    retval.ClientID = null;
    retval.ClientFullName = null;
    retval.Vip = null;*/
  end;

  return retval;
end;


/**************************************************************************\
|                         ВЫПИСКА ПО СЧЁТУ (КАРТЕ)                         |
\**************************************************************************/
macro RetailAccountOperation ( ExternalData )
  var stat = 0;
  var retVal : TAccOperationResult;
  var DateReqIn = {curdate}, DateReqEnd = {curdate};
  var cmd;
  var SenderID;

  GetRegistryValue( "RS-CONNECT\\SENDERID\\RETAIL", V_STRING, SenderID );

  if ( (ValType( ExternalData.ReqID ) != V_STRING) or (ExternalData.ReqID == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( (ValType( ExternalData.BIC ) != V_STRING) or (ExternalData.BIC == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( (ValType( ExternalData.Account ) != V_STRING) or (ExternalData.Account == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var BankName, CorAccount, Bank_INN, Bank_KPP, BankId;
  iFindBank( PTCK_BIC, ExternalData.BIC, BankName, CorAccount, Bank_INN, Bank_KPP, BankId );  

  var rs_Account;
  stat = findAccountByFilial( ExternalData.Account, BankId, rs_Account );
  if( stat )
    RunError( ErrMessage( stat ), stat );
  end;

  if ( (ValType( ExternalData.DateReqIn ) == V_DATE) and ( ExternalData.DateReqIn != Date(0,0,0) ) )
    DateReqIn = ExternalData.DateReqIn;
  else
    DateReqIn = convertNullDate(rs_Account.value("T_OPEN_DATE"));
  end;

  if ( (ValType( ExternalData.DateReqEnd ) == V_DATE) and ( ExternalData.DateReqEnd != Date(0,0,0) ) )
    DateReqEnd = ExternalData.DateReqEnd;
  end;
  
  if ( DateReqIn > DateReqEnd )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( (ValType( ExternalData.PersonalAccount ) == V_STRING) and (ExternalData.PersonalAccount != "") )
  // SQL-запрос для выписки по карте
    var rs_Card, rs_CardLink;
    var accCardLinkRef;

    stat = findCardByFilial( ExternalData.PersonalAccount, BankId, rs_Card );
    if ( stat )
      RunError( ErrMessage( stat ), stat );
    end;
    
    stat = findCardAccLink( rs_Card.value("T_FNCASH"), rs_Card.value("T_CARDREF"), rs_Account.value("T_REFERENC"), rs_CardLink );
    if ( stat )
      RunError( ErrMessage( stat ), stat );
    end;

    if ( rs_CardLink.value("T_MainSubAccLinkRef") == 0 )    // карта имеет собственный субсчёт
      accCardLinkRef = rs_CardLink.value("T_AccCardLinkRef");
    else                                                    // карта пользуется субсчётом главной карты
      accCardLinkRef = rs_CardLink.value("T_MainSubAccLinkRef");
    end;
    
    cmd = RsdCommand( 
      "SELECT T_DATE OperDate,"
            " T_INSUM CreditSum,"
            " T_OUTSUM DebitSum,"
            " T_REST RestSum,"
            " T_GROUND Ground,"
            " T_NUMOPER TypeOper,"
            " T_DEPDOCAPPKIND DepDocAppkind,"
            " T_DEPDOCAPPKEY DepDocAppkey"
       " FROM dsccrddoc_dbt"
      " WHERE T_acccardlinkref = ?"
        " AND T_fncash = ?"
        " AND T_DATE BETWEEN ? AND ?"
        " AND t_Action <> 2"
        " AND t_Action <> 11"
      " ORDER BY T_FNCASH, T_ACCCARDLINKREF, T_DATE, T_NUMDAYDOC" );
    cmd.addParam("acccardlinkref", RsdBp_In, accCardLinkRef);
    cmd.addParam("fncash", RsdBp_In, rs_CardLink.value("T_FNCash"));
    cmd.addParam("dateReqIn", RsdBp_In, DateReqIn);
    cmd.addParam("dateReqEnd", RsdBp_In, DateReqEnd);
    cmd.nullConversion = true;
    cmd.execute;
    retVal.Account = ExternalData.PersonalAccount;
  else
  // SQL-запрос для выписки по счёту
    cmd = RsdCommand( 
      "SELECT T_DATE_DOCUMENT OperDate,"
            " T_INSUM CreditSum,"
            " T_OUTSUM DebitSum,"
            " T_REST RestSum,"
            " T_GROUND Ground,"
            " T_TYPEOPER TypeOper,"
            " T_IAPPLICATIONKIND DepDocAppkind,"
            " T_APPLICATIONKEY DepDocAppkey"
       " FROM dsbdepdoc_dbt"
      " WHERE T_REFERENC = ?"
        " AND T_DATE_DOCUMENT BETWEEN ? AND ?"
        " AND t_Action <> 2"
        " AND t_Action <> 11"
        " AND t_KindOp <> 8"
        " AND t_KindOp <> 9"
        " AND t_KindOp <> 14"
        " AND t_KindOp <> 15"
        " AND t_KindOp <> 16"
        " AND t_TypeOper <> 38"
        " AND t_TypeOper <> 39"
        " AND t_Mode <> 2"
        " AND bitand(t_flags, 131072) = 0" // BIT_FLAG_HIDDEN
      " ORDER BY T_REFERENC, T_DATE_DOCUMENT, T_NUMDAYDOC" );
    cmd.addParam("referenc", RsdBp_In, rs_Account.value("T_REFERENC"));
    cmd.addParam("dateReqIn", RsdBp_In, DateReqIn);
    cmd.addParam("dateReqEnd", RsdBp_In, DateReqEnd);
    cmd.nullConversion = true;
    cmd.execute;
    retVal.Account = SubStr(convertNullStr(rs_Account.value("T_ACCOUNT")),1,20);
  end;

  retVal.ReqID = ExternalData.ReqID;
  retVal.SenderID = SenderID;
  retVal.RealDateTime = DtTm( date(), time() );
  retVal.BIC = ExternalData.BIC;
  retVal.Currency = rs_Account.value("T_CODE_CURRENCY");
  retVal.INN = getPartyINN( rs_Account.value("T_CODCLIENT") );
  var SpecialAccess;
  getClientFIO( rs_Account.value("T_CODCLIENT"), retVal.ClientFullName, SpecialAccess );

  // первая запись выписки  
  var Data = TAccTransactionData;
  Data.TType = 3;
  Data.Date = DateReqIn;
  Data.BIC = "";
  Data.Account = "";
  Data.Grounds = "";
  if ( (ValType( ExternalData.PersonalAccount ) == V_STRING) and (ExternalData.PersonalAccount != "") )
    Data.Amount = getCardRest(accCardLinkRef, rs_CardLink.value("T_FNCash"), date(DateReqIn)-1);
  else
    Data.Amount = getAccountRest(rs_Account.value("T_REFERENC"), date(DateReqIn)-1);
  end;
  retVal.AccountTransactions[retVal.AccountTransactions.size] = Data;
  
  // заполнение выписки операциями
  var CreditSum, DebitSum, RestSum, TypeOper, DepDocAppkind, DepDocAppkey;
  var rs = RsdRecordset(cmd);
  while ( rs.moveNext() )
    Data = TAccTransactionData;
    CreditSum = rs.value("CreditSum");
    DebitSum = rs.value("DebitSum");
    RestSum = rs.value("RestSum");
    TypeOper = rs.value("TypeOper");
    DepDocAppkind = rs.value("DepDocAppkind");
    DepDocAppkey = rs.value("DepDocAppkey");
    Data.Grounds = rs.value("Ground");
    Data.Date = rs.value("OperDate");
    Data.BIC = ExternalData.BIC;
    Data.Account = "";

    if ( DebitSum > 0 )
      Data.TType = 2;         // операция уменьшает остаток по счету
      Data.Amount = DebitSum;
      if ( makeVector(44,45,63,65,67,80).contains(TypeOper) == true )
        var recipient = getRecipientParam( DepDocAppkind, DepDocAppkey );
        if( recipient.BankCodeKind == PTCK_BIC )
          Data.BIC = recipient.BankCode;
        else
          Data.BIC = findPartyCode( recipient.BankID, PTCK_BIC );
        end;
        Data.Account = recipient.Account;
      end;
    else
      Data.TType = 1;         // операция увеличивает остаток по счету
      Data.Amount = CreditSum;
    end;

    retVal.AccountTransactions[retVal.AccountTransactions.size] = Data;
  end;

  // последняя запись выписки
  Data = TAccTransactionData;
  Data.TType = 4;
  Data.Date = DateReqEnd;
  Data.BIC = "";
  Data.Account = "";
  Data.Grounds = "";
  if ( (ValType( ExternalData.PersonalAccount ) == V_STRING) and (ExternalData.PersonalAccount != "") )
    Data.Amount = getCardRest(accCardLinkRef, rs_CardLink.value("T_FNCash"), DateReqEnd);
  else
    Data.Amount = getAccountRest(rs_Account.value("T_REFERENC"), DateReqEnd);
  end;
  retVal.AccountTransactions[retVal.AccountTransactions.size] = Data;
  
  return retval;
end;

/**************************************************************************\
|                   СВЕДЕНИЯ ПО ОГРАНИЧЕНИЯМ ПО СЧЁТУ                      |
\**************************************************************************/
macro RetailAccountClaim ( ExternalData )
  var stat = 0;
  var rs_Account = null;
  var SenderID;
  record convdataArest("convert_cum_data.rsl");

  GetRegistryValue( "RS-CONNECT\\SENDERID\\RETAIL", V_STRING, SenderID );

  if ( (ValType( ExternalData.ReqID ) != V_STRING) or (ExternalData.ReqID == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( (ValType( ExternalData.BIC ) != V_STRING) or (ExternalData.BIC == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( ( (ValType( ExternalData.Account ) != V_STRING) or (ExternalData.Account == "") ) and
       ( (ValType( ExternalData.PersonalAccount ) != V_STRING) or (ExternalData.PersonalAccount == "") ) )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var BankName, CorAccount, Bank_INN, Bank_KPP, BankId;
  iFindBank( PTCK_BIC, ExternalData.BIC, BankName, CorAccount, Bank_INN, Bank_KPP, BankId );  

  // поиск счёта
  if ( (ValType( ExternalData.Account ) == V_STRING) and (ExternalData.Account != "") ) 
    stat = findAccountByFilial( ExternalData.Account, BankId, rs_Account );
    if( stat )
      RunError( ErrMessage( stat ), stat );
    end;
  end;

  // поиск карты и счёта по карте
  if ( (ValType( ExternalData.PersonalAccount ) == V_STRING) and (ExternalData.PersonalAccount != "") )
    var rs_Card, rs_CardLink;
    var accountRef = 0;

    stat = findCardByFilial( ExternalData.PersonalAccount, BankId, rs_Card );
    if ( stat )
      RunError( ErrMessage( stat ), stat );
    end;
    
    if ( rs_Account != null)
      accountRef = rs_Account.value("T_REFERENC");
    end;
    
    stat = findCardAccLink( rs_Card.value("T_FNCASH"), rs_Card.value("T_CARDREF"), accountRef, rs_CardLink );
    if ( stat )
      RunError( ErrMessage( stat ), stat );
    end;
    
    if ( rs_Account == null)
      stat = findDepAccount( rs_CardLink.value("t_cardaccref"), 0, 0, rs_Account );
      if( stat )
        RunError( ErrMessage( stat ), stat );
      end;
    end;
  end;  

  setFlagCur(rs_Account.value("T_ISCUR"));
  {curdate} = getCurDate;
  
  var retVal : TAccClaimResult;
  var UserTypeAccount = convertNullStr(rs_Account.value("t_UserTypeAccount"));
  var cmd, rs, Data;
  retVal.ReqID = ExternalData.ReqID;
  retVal.SenderID = SenderID;
  retVal.RealDateTime = DtTm( date(), time() );
  retVal.BIC = ExternalData.BIC;
  retVal.Account = SubStr(rs_Account.value("T_ACCOUNT"),1,20);
  retVal.Currency = rs_Account.value("T_CODE_CURRENCY");
  retVal.INN = getPartyINN( rs_Account.value("T_CODCLIENT") );
  var SpecialAccess;
  getClientFIO( rs_Account.value("T_CODCLIENT"), retVal.ClientFullName, SpecialAccess );
  
  if ( Index( UserTypeAccount, "Т" ) > 0 )      // полный арест по счёту
    var LastArrestdate = date(0,0,0);
    cmd = RsdCommand( 
      "SELECT t_date FROM dret_op_dbt"
      " WHERE t_operation = 252"
        " AND (t_applicationkind, t_applicationkey) IN"
               " (SELECT obj.t_opappkind, obj.t_opappkey"
                  " FROM dopobject_dbt obj"
                 " WHERE obj.t_objecttype = 1"
                   " AND obj.t_objectref = ?)"
        " AND ROWNUM = 1"
      " ORDER BY t_date DESC" );
    cmd.addParam("referenc", RsdBp_In, String(rs_Account.value("T_REFERENC")));
    cmd.nullConversion = true;
    cmd.execute;
    rs = RsdRecordset(cmd);
    if ( rs.moveNext() )
      LastArrestdate = convertNullDate(rs.value(0));
    end;
    
    Data = TAccEncumbranceData;
    Data.Type = 1;
    Data.Amount = getAccountRest( rs_Account.value("T_REFERENC") );
    Data.Date = LastArrestdate;
    Data.OrgName = "";
    Data.OrgINN = "";
    Data.Priority = "";
    Data.IPNumber = "";
    Data.DocNumber = "";
    Data.OSPCode = "";
    Data.InternalKey = "";
    retVal.AccountEncumbranceDatum[0] = Data;

  elif ( Index( UserTypeAccount, "Д" ) > 0 )    // частичные аресты по счёту
    cmd = RsdCommand( 
      "SELECT t_sumin - t_sumout AS arrestSum, t_date, t_comment, t_currencycode FROM dsb_arrest_dbt"
      " WHERE t_reference = ?"
        " AND t_opnum = 253"
        " AND t_sumin - t_sumout > 0"
        " AND t_action <> 2"
        " AND t_action <> 11"
      " ORDER BY t_date, t_id" );
    cmd.addParam("referenc", RsdBp_In, rs_Account.value("T_REFERENC"));
    cmd.nullConversion = true;
    cmd.execute;
    rs = RsdRecordset(cmd);

    while ( rs.moveNext() )
      var arrestSum: money = rs.value("arrestSum");

      if (retVal.Currency != rs.value("t_currencycode"))
        var cdataArest;
        stat = ConvertSumEx(rs.value("t_currencycode"), retVal.Currency, arrestSum, {curdate}, 1, 0, 1, -1, false, cdataArest );
        if( stat )
          RunError( ErrMessage( stat ), stat );
        end;

        SetBuff(convdataArest,cdataArest);
        arrestSum = convdataArest.ToSumma;
      end;

      Data = TAccEncumbranceData;
      Data.Type = 1;
      Data.Amount = arrestSum;
      Data.Date = convertNullDate(rs.value("t_date"));
      Data.OrgName = convertNullStr(rs.value("t_comment"));
      Data.OrgINN = "";
      Data.Priority = "";
      Data.IPNumber = "";
      Data.DocNumber = "";
      Data.OSPCode = "";
      Data.InternalKey = "";
      retVal.AccountEncumbranceDatum[retVal.AccountEncumbranceDatum.size] = Data;
    end;
  end;
  
  return retval;
end;
