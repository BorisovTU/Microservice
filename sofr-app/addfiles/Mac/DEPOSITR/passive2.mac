import DeprIntr, IsSrvDoc, Cur_Rate, cbRep, sqlconv;

/*
file DepType( "sb_dtyp.dbt" ) key 4;
file Dep( "depositr.dbt" );
file Doc( "sbdepdoc.dbt" ) key 6;
*/
file Curr( "currency.dbt" ) key 0;

file
  aptype("pc_apltp.dbt") key 0;
file
  pcrate("pc_rate.dbt")  key 0;
file
  depdoc("sbdepdoc.dbt") key 0;

var  DepType = TBFile( "sb_dtyp.dbt", "r", 2 );
var  Dep = TBFile( "depositr.dbt", "r", 0 );
var  Doc = TBFile( "sbdepdoc.dbt", "r", 6 );

const DateNull = Date( 0, 0, 0);

const MAX_INT16 = 32767;

const
    PC_ACCOUNT_DEP  = 2001,   /* Счет (частный вклад)       */
    PC_ACCOUNT_ALT  = 2002;   /* = AlterPercType            */

const
  PC_YEAR_RPERIOD  = 0,     /* годовая                     */
  PC_CONTR_RPERIOD = 2,     /* за сpок договоpа            */
  PC_MONTH_RPERIOD = 3,     /* месячная                    */
  PC_DAYS_RPERIOD  = 4;     /* дневная(за количество дней) */

private var {curdate}, {oper};
private var {Name_Bank};
var NameBranch;

array Branches;

array MonthName;
MonthName( 0) = "январь ";    MonthName( 1) = "февраль ";
MonthName( 2) = "март ";      MonthName( 3) = "апрель ";
MonthName( 4) = "май ";       MonthName( 5) = "июнь ";
MonthName( 6) = "июль ";      MonthName( 7) = "август ";
MonthName( 8) = "сентябрь ";  MonthName( 9) = "октябрь ";
MonthName(10) = "ноябрь ";    MonthName(11) = "декабрь ";

var MonthNumber;
var StartDate, EndDate;
var DepID, NumBranch;
var CBRate, Scale, BuckCBRate, BuckScale;

var TermInDays;

/* Массивы */
array TotalSumsRub, TotalSumsUSD;
array NomForTermRub, NomForTermUSD;
array NomForPercRub, NomForPercUSD;
/* Индекс массивов */
var i;

macro GetCBRate

  Scale = 1;
  CBRate = 0.0;

  if (Curr.ScaleOfc != 0)
    Scale = Curr.ScaleOfc;
  end;

/*
  ExchCurr.ID = Curr.ExternalCode;
  if ( not GetEQ( ExchCurr ) )
    CBRate = 0;
  end;
*/
  Copy( RtlCurr, Curr );
  CBRate = GetCurrRate( EndDate );
end;

macro GetBuckCBRate

  Curr.Code_Currency = 1;
  GetEQ( Curr );
  GetCBRate;
  BuckCBRate = CBRate;
  BuckScale = Scale;
  if ( BuckCBRate == 0 )
    MsgBox( "Не задан курс доллара США" );
    Exit( 1 );
  end;
end;

macro Cur2Rub( Sum )

  if ( Sum == 0.0 )
    return Sum;
  end;
  if( DepType.rec.FlagCur )
    return Money( CBRate * Sum );
  else
    return Sum;
  end;
end;

macro Hand1er( IP, cmd, id, key )

  var stat = CM_DEFAULT, i;
  var d,y;
  /* =================================================================== */
  if (cmd == DLG_KEY)
    /* Enter --------------------------------------------------------- */
    if (key == 13)
      if (id == 0)
        SetFocus(IP,1);
        stat = CM_IGNORE;
      end;
    /* Esc ----------------------------------------------------------- */
    elif (key == 523)
      stat = CM_CANCEL;
    /* F3 ------------------------------------------------------------ */
    elif (key == 317)
      if (id == 0)
        i = Menu(MonthName," ~ESC~ Отказ  ~ENTER~ Выбор","Месяц");
        if (i >= 0)
          IP.Month = MonthName(i);
          MonthNumber = i + 1;
        end;
      end;
    end;
  /* =================================================================== */
  elif (cmd == DLG_SAVE)
    ;
  end;

  return stat;

end;

macro DefDates

  var stat;
  var d,y;
  record Period (MNTHYEAR) dialog;

  DateSplit({curdate},d,MonthNumber,y);
  if(MonthNumber == 1)
    MonthNumber = 12;
    y=y-1;
  else
    MonthNumber = MonthNumber - 1;
  end;

  Period.Month = MonthName(MonthNumber-1);
  Period.Year = y;

  stat = RunDialog(Period, "Hand1er");
  if (stat)
    StartDate = Date(1, MonthNumber, Period.Year);
    if (MonthNumber == 12)
      EndDate = Date(31, MonthNumber, Period.Year);
    else
      EndDate = Date(1, MonthNumber + 1, Period.Year) - 1;
    end;
  end;
  return stat;
end;

macro ChooseBranchAndDateForWork

  file operdep  (operdep);  /* С какими филиалами может работать операционист */

  array ACash, ANameBr, ANameMenu;

  var stat,d,m,y,yy;
  var i        = 0;
  var FullName = "";
  var RetCode  = FALSE;
  var ddep = TRecHandler( "i_dp_dep.rec" );
  var dpDepList = TdpDepList;

  macro GetDepId

    DepId = dpDepList.getFilialID(NumFNCash());
  end;

  GetDepId;

  ACash    (i) = -1;
  ANameBr  (i) = "";
  ANameMenu(i) = " По всем филиалам";

  KeyNum(operdep,0);
  operdep.Oper   = {oper};
  operdep.FNCash = 0;
  stat = GetGE(operdep);
  while (stat)
    if (operdep.Oper == {oper})
      i = i + 1;
      ACash(i) = operdep.FNCash;
      ANameBr(i) = "Не найден";
      FullName = "";
      if (findDepartment(operdep.FNCash, null, ddep))
        ANameBr(i) = ddep.rec.Name;
        FullName   = "";
      end;
      ANameMenu(i) = " " + String(ACash(i):2) + "  " + SubStr(ANameBr(i) + MkStr(" ",12),1,12) + "  " + FullName;
      stat = Next(operdep);
    else
      stat = FALSE;
    end;
  end;

  i = Menu(ANameMenu," ~ENTER~ Печать отчета  ~ESC~ Выход","Выберите филиал");
  if (i < 0)
    [ ];
    [ Отказались от выпуска отчета];
  else
    NumBranch  = ACash(i);
    NameBranch = "Филиал: "+ANameBr(i);
    if ( DefDates )
         DateSplit(StartDate,d,m,yy);
         DateSplit({curdate},d,m,y);
         if(((MonthNumber == m)and(yy == y))and
           (not GetTrue( False,"Внимание!Месяц еще не закончился.Вы все равно хотите продолжить?")))
          exit(1);
         end;

      RetCode = TRUE;
      if (NumBranch > -1)
        Branches(0) = NumBranch;
      else
        dpDepList.SetFilter(dpDepList.getFilialID(NumFNCash()));
        i = 0;
        while (dpDepList.next())
          if (dpDepList.rec.Code == NumFNCash)
            NameBranch = "Банк: "+ {Name_Bank};
          end;
          Branches(i) = dpDepList.rec.Code;
          i = i + 1;
        end;
      end;
    else
      [ ];
      [ Отказались от выпуска отчета];
    end;
  end;

  return RetCode;
end;

macro PrintHeader


  [ ];
  [ ];
  [ #                                                                                       ]
  ( NameBranch );
  [ ];
  [                           Средневзвешенные процентные ставки по вкладам                        ];
  [                     ############################################################               ]
  ( ( "за период с " + String( StartDate:m ) + " по " + String( EndDate:m ) ):c );
  [ ];
  [                                                                                                ];
  [------------------------------------------------------------------------------------------------];
  [|                |             В к л а д ы  и   д е п о з и т ы  ф и з.  л и ц                 |];
  [|     Сроки      |-----------------------------------------------------------------------------|];
  [|                |    Средний процент      |        Средний срок     |        Общая сумма      |];
  [|                |-------------------------|-------------------------|-------------------------|];
  [|                |   Рубли    |   Валюта   |   Рубли    |   Валюта   |   Рубли    |   Валюта   |];
  [|----------------|------------|------------|------------|------------|------------|------------|];
end;

macro GetTermInDays

  var
    TmpDate = {curdate};

   GetDateOff( TmpDate, DepType.rec.KindTerm, DepType.rec.Term, TmpDate );
   return TmpDate - {curdate};
end;

macro getPcRate(dep,doc,applType)

  var
    stat,
    stavka = 0,
    value;

  var pc_rates_line;

  ClearRecord(aptype);
  aptype.IsCur=dep.rec.IsCur;
  aptype.TypeRec=1003;
  aptype.Type=doc.rec.Type_Account;
  aptype.ApplType=applType;

  stat=GetEQ(aptype);

  if(stat)
    rewind(pcrate);
    pcrate.FlagCur = dep.rec.IsCur;
    pcrate.ObjectType = 1003;
    pcrate.Referenc = aptype.ApType;
    pcrate.Code_Currency = dep.rec.Code_Currency;
    pcrate.BeginDate=dep.rec.Open_Date;
    pcrate.DatePeriodType=MAX_INT16;
    pcrate.DatePeriod=MAX_INT16;

    stat=GetLE(pcrate);

/*if(i == 3)
msgbox(dep.Open_Date,"|",
       aptype.ApType,"|",
       stat,"|",
       pcrate.FlagCur,"|",
       pcrate.ObjectType,"|",
       pcrate.Referenc,"|",
       pcrate.Code_Currency);
end;
*/

    if(stat
      and ( pcrate.FlagCur == dep.rec.IsCur )
      and ( pcrate.ObjectType == 1003 )
      and ( pcrate.Referenc == aptype.ApType )
      and ( pcrate.Code_Currency == dep.rec.Code_Currency ) )
      stat = true;
    else
      stat=false;
    end;
  end;

  if(stat)
    if(pcrate.PeriodRate==PC_YEAR_RPERIOD)
      SetParm(3,"годовая");
    elif(pcrate.PeriodRate==PC_CONTR_RPERIOD)
      SetParm(3,"за срок договора");
    elif(pcrate.PeriodRate==PC_MONTH_RPERIOD)
      SetParm(3,"месячная");
    elif(pcrate.PeriodRate==PC_DAYS_RPERIOD)
      SetParm(3,"за "+String(pcrate.DaysPeriod)+" дней");
    end;

    if(applType == PC_ACCOUNT_DEP)
      pc_rates_line = "     " + pcrate.Percent1*100 + "% " +
                      "     " + pcrate.Percent2*100 + "% " +
                      "     " + pcrate.Percent3*100 + "% " +
                      "     " + pcrate.Percent4*100 + "% " +
                      "     " + pcrate.Percent5*100 + "%";
    end;

    value=0;
    if((pcrate.RestCount==20) and (pcrate.Rest20<=doc.rec.Rest))
      stavka=pcrate.Percent20;
    end;
    if((pcrate.RestCount>=19) and (value==0) and (pcrate.Rest19<=doc.rec.Rest))
      stavka=pcrate.Percent19;
    end;
    if((pcrate.RestCount>=18) and (value==0) and (pcrate.Rest18<=doc.rec.Rest))
      stavka=pcrate.Percent18;
    end;
    if((pcrate.RestCount>=17) and (value==0) and (pcrate.Rest17<=doc.rec.Rest))
      stavka=pcrate.Percent17;
    end;
    if((pcrate.RestCount>=16) and (value==0) and (pcrate.Rest16<=doc.rec.Rest))
      stavka=pcrate.Percent16;
    end;
    if((pcrate.RestCount>=15) and (value==0) and (pcrate.Rest15<=doc.rec.Rest))
      stavka=pcrate.Percent15;
    end;
    if((pcrate.RestCount>=14) and (value==0) and (pcrate.Rest14<=doc.rec.Rest))
      stavka=pcrate.Percent14;
    end;
    if((pcrate.RestCount>=13) and (value==0) and (pcrate.Rest13<=doc.rec.Rest))
      stavka=pcrate.Percent13;
    end;
    if((pcrate.RestCount>=12) and (value==0) and (pcrate.Rest12<=doc.rec.Rest))
      stavka=pcrate.Percent12;
    end;
    if((pcrate.RestCount>=11) and (value==0) and (pcrate.Rest11<=doc.rec.Rest))
      stavka=pcrate.Percent11;
    end;
    if((pcrate.RestCount>=10) and (value==0) and (pcrate.Rest10<=doc.rec.Rest))
      stavka=pcrate.Percent10;
    end;
    if((pcrate.RestCount>=9) and (value==0) and (pcrate.Rest9<=doc.rec.Rest))
      stavka=pcrate.Percent9;
    end;
    if((pcrate.RestCount>=8) and (value==0) and (pcrate.Rest8<=doc.rec.Rest))
      stavka=pcrate.Percent8;
    end;
    if((pcrate.RestCount>=7) and (value==0) and (pcrate.Rest7<=doc.rec.Rest))
      stavka=pcrate.Percent7;
    end;
    if((pcrate.RestCount>=6) and (value==0) and (pcrate.Rest6<=doc.rec.Rest))
      stavka=pcrate.Percent6;
    end;
    if((pcrate.RestCount>=5) and (value==0) and (pcrate.Rest5<=doc.rec.Rest))
      stavka=pcrate.Percent5;
    end;
    if((pcrate.RestCount>=4) and (value==0) and (pcrate.Rest4<=doc.rec.Rest))
      stavka=pcrate.Percent4;
    end;
    if((pcrate.RestCount>=3) and (value==0) and (pcrate.Rest3<=doc.rec.Rest))
      stavka=pcrate.Percent3;
    end;
    if((pcrate.RestCount>=2) and (value==0) and (pcrate.Rest2<=doc.rec.Rest))
      stavka=pcrate.Percent2;
    end;

    if(value==0)
      stavka=pcrate.Percent1;
    end;
/*    SetParm(4,stavka);*/
  end;
  return stavka;
end;

macro TreatAccount

  var
    RecFound,
    ObjectType,
    DepTermInDays,
    insum = $0,
    СуммаКоммисии = $0;

  /* Определение срока договора в днях */

  /* msgbox( dep.Account, ": ", String(dep.End_DateDep) ); */

  if ( dep.rec.End_DateDep == DateNull )
    DepTermInDays = 0;  /* До востребования */
  else
    /* Депозиты */
    if( dep.rec.Prol_DateDep != DateNull )
        DepTermInDays = dep.rec.End_DateDep - dep.rec.Prol_DateDep + 1;
    else
        DepTermInDays = dep.rec.End_DateDep - dep.rec.Start_DateDep;
    end;
  end;

  TermInDays = DepTermInDays;

  i = 0;
  if( ( TermInDays == 0 ) or ( TermInDays <= 30 ) )
    if( TermInDays == 0 )
      i = 7;
    elif( ( TermInDays >= 2 ) and ( TermInDays <= 7 ) )
      i = 1;
    end;
  elif( ( TermInDays >= 30 ) and ( TermInDays <= 90 ) )
     i = 2;
  elif( ( TermInDays >= 91 ) and ( TermInDays <= 180 ) )
     i = 3;
  elif( ( TermInDays >= 181 ) and ( TermInDays < 365 ) )
     i = 4;
  elif( ( TermInDays >= 365 ) and ( TermInDays <= 3 * 365 ) )
     i = 5;
  elif( ( TermInDays > 3 * 365 ) )
     i = 6;
  else
     i = 0;
     [ Ошибка для #######################  не определен срок ##### ]
      ( Acc_Form(dep.rec.Account), TermInDays );
  end;

  /* msgbox( dep.Account, ": ", String(TermInDays), " | ", String(i) ); */

  if( Dep.rec.UseAlternate )
    ObjectType = 2002;
  else
    ObjectType = 2001;
  end;
  Doc.rec.Referenc = Dep.rec.Referenc;
  Doc.rec.Date_Document = StartDate;
  Doc.rec.NumDayDoc = 0;
  Doc.addFilter("t.t_Referenc = " + string(Dep.rec.Referenc) + 
		" and t.t_Date_Document >= " + sqlDateToStr(StartDate) + 
		" and t.t_Date_Document <= " + sqlDateToStr(EndDate) );
  RecFound = Doc.GetGE();
  while( RecFound and ( Doc.rec.Referenc == Dep.rec.Referenc ) )
    if( ( Doc.rec.Date_Document >= StartDate ) and ( Doc.rec.Date_Document <= EndDate ) )
      if( IsServDoc( Doc.rec ) )
        if( Doc.rec.Code_Currency )

          insum = Doc.rec.InSum;

          if ( ( Doc.rec.TypeOper == 72 ) or  /* Причисление %% */
               ( Doc.rec.TypeOper == 88 ) or  /* Выдача кредита */
               ( Doc.rec.TypeOper == 93 )   ) /* Пополнение для овердрафта */
            insum = $0L;
          end;

          if( ( Doc.rec.TypeOper == 62 ) AND ( Doc.rec.ApplType == 14 ) )
             /* налог с мат выгоды */
             СуммаКоммисии   = Doc.rec.OutSum;
          elif( Doc.rec.TypeOper  == 72 )
              if( Doc.rec.TypeComplexOper == 82 )
                /*Проценты при пролонгаци */
                 insum = Doc.rec.Rest;
              end;

              if( Doc.rec.DepDate_document == ( dep.rec.Prol_DateDep - 1 )  )
                 insum = Doc.rec.Rest;
              end;

              if( ( Doc.rec.TypeComplexOper == 10 ) or
                  ( Doc.rec.TypeComplexOper == 81 ) ) /* закрытие */
                 insum = $0;
              end;

          end;

          /* [## ####################### ########## ########### ]( i, dep.Account, insum, СуммаКоммисии); */

          TotalSumsUSD(i)  = TotalSumsUSD(i) + Cur2Rub( insum ) - Cur2Rub( СуммаКоммисии );
          NomForTermUSD(i) = NomForTermUSD(i) + ( Cur2Rub( insum ) - Cur2Rub( СуммаКоммисии ) ) * TermInDays;
          NomForPercUSD(i) = NomForPercUSD(i) + ( Cur2Rub( insum ) - Cur2Rub( СуммаКоммисии ) ) * getPcRate( dep, doc,ObjectType );
          if( ( i == 1 ) or ( i == 7 ) )
            TotalSumsUSD(0) = TotalSumsUSD(0) + Cur2Rub( insum );
            NomForTermUSD(0) = NomForTermUSD(0) + ( Cur2Rub( insum ) - Cur2Rub( СуммаКоммисии ) ) * TermInDays;
            NomForPercUSD(0) = NomForPercUSD(0) + ( Cur2Rub( insum ) - Cur2Rub( СуммаКоммисии ) ) * getPcRate( dep, doc,ObjectType );
          end;
        else
          insum = Doc.rec.InSum;

          if ( ( Doc.rec.TypeOper == 72 ) or  /* Причисление %% */
               ( Doc.rec.TypeOper == 88 ) or  /* Выдача кредита */
               ( Doc.rec.TypeOper == 93 )   ) /* Пополнение для овердрафта */
            insum = $0L;
          end;

          if( ( Doc.rec.TypeOper == 62 ) AND ( Doc.rec.ApplType == 14 ) )
             /* налог с мат выгоды */
              СуммаКоммисии   = Doc.rec.OutSum;
          elif( ( Doc.rec.TypeOper        == 72 ) and ( Doc.rec.TypeComplexOper != 10 ) and
                ( Doc.rec.TypeComplexOper != 81 ) )

              if( Doc.rec.TypeComplexOper == 82 )
                /*Проценты при пролонгаци */
                 insum = Doc.rec.Rest;
              end;

              if( Doc.rec.DepDate_document == ( dep.rec.Prol_DateDep - 1 )  )
                 insum = Doc.rec.Rest;
              end;
              if( ( Doc.rec.TypeComplexOper == 10 ) or
                  ( Doc.rec.TypeComplexOper == 81 ) ) /* закрытие */
                 insum = $0;
              end;
          end;

          TotalSumsRub ( i ) = TotalSumsRub( i ) + insum - СуммаКоммисии;
          NomForTermRub( i ) = NomForTermRub( i ) + ( insum - СуммаКоммисии ) * TermInDays;
          NomForPercRub( i ) = NomForPercRub( i ) + ( insum - СуммаКоммисии ) * getPcRate( dep, doc,ObjectType );
          if( ( i == 1 ) or ( i == 7 ) )
            TotalSumsRub( 0 ) = TotalSumsRub( 0 ) + insum;
            NomForTermRub( 0 ) = NomForTermRub( 0 ) + ( insum - СуммаКоммисии ) * TermInDays;
            NomForPercRub( 0 ) = NomForPercRub( 0 ) + ( insum - СуммаКоммисии ) * getPcRate( dep, doc,ObjectType );
          end;
        end;

      end;
    end;
    СуммаКоммисии = $0;
    RecFound = Doc.Next();
  end;
  Doc.dropFilter();
end;

macro ProcessDepType

  var
    j = 0,
    RecFound;

  while ( j < ASize( Branches ) )
    Dep.KeyNum =  6;
    Dep.Clear;
    Dep.rec.IsCur = DepType.rec.FlagCur;
    Dep.rec.FNCash = Branches( j );
    Dep.rec.Type_Account = DepType.rec.Kind;
    Dep.addFilter("t.t_IsCur = " + string(DepType.rec.FlagCur) +
		  " and t.t_FNCash = " + string(Branches( j )) + 
		  " and t.t_Type_Account = " + GetSQLString(DepType.rec.Kind) );
    RecFound = Dep.GetGE();
    while( RecFound
      and( Dep.rec.IsCur == DepType.rec.FlagCur )
      and( Dep.rec.FNCash == Branches( j ) )
      and( Dep.rec.Type_Account == DepType.rec.Kind ) )
      if( ( Dep.rec.Code_Currency == 0 ) or ( Dep.rec.Code_Currency == 1 ) )
        if( Dep.rec.Open_Close == "" )
           TreatAccount();
        end;
        if( Dep.rec.Close_Date >= StartDate )
           TreatAccount();  /* Счет закрыт в текущем месяце */
        end;
      end;
      RecFound = Dep.Next();
    end;
    Dep.dropFilter;
    j = j + 1;
  end;
end;

macro ZerofyArrays

  var
    j = 0;

  while( j <= 9 )
    TotalSumsRub(j) = TotalSumsUSD(j) = $0.0L;
    NomForTermRub(j) = NomForTermUSD(j) = $0.0L;
    NomForPercRub(j) = NomForPercUSD(j) = $0.0L;
    j = j + 1;
  end;
end;

macro safediv( a, b )

  if( not b )
    return $0.0L;
  else
    return a / b;
  end;
end;

macro Report

  var
    br,
    RecFound,
    cbRepFile;

  if ( NumBranch > -1 )
    br = NumBranch;
  else
    br = DepID;
  end;
  cbRepFile = TCBReportFile( 2, cbSch_bankToBranch, cbPt_month, br, EndDate );
  cbRepFile.setPeriodStart( StartDate );
  cbRepFile.setPeriodEnd( EndDate );

  PrintHeader;

  ZerofyArrays;
  DepType.addFilter("t_UserTypeAccount not like '%К%'");/* + 
                    " and exists ( select 0 from ddepositr_dbt d where d.t_Type_Account = t.t_Kind )" );*/
  DepType.rewind();
  while( DepType.next() )
    if( index( DepType.rec.UserTypeAccount, "К" ) == 0 )
      /*
      if( DepType.rec.Term )
        TermInDays = GetTermInDays;
      else
        TermInDays = 0;
      end;
      i = 0;
      if( ( TermInDays == 0 ) or ( TermInDays <= 30 ) )
        if( TermInDays == 0 )
          i = 7;
        elif( ( TermInDays >= 2 ) and ( TermInDays <= 7 ) )
          i = 1;
        end;
      elif( ( ( TermInDays >= 31 ) and ( TermInDays <= 90 ) ) or ( DepType.rec.BalAcc == "42303"  ) )
        i = 2;
      elif( ( ( TermInDays >= 91 ) and ( TermInDays <= 180 ) ) or ( DepType.rec.BalAcc == "42304"  ) )
        i = 3;
      elif( ( ( TermInDays >= 181 ) and ( TermInDays <= 365 ) ) or ( DepType.rec.BalAcc == "42305"  ) )
        i = 4;
      elif( ( ( TermInDays > 365 ) and ( TermInDays <= 3 * 365 ) ) or ( DepType.rec.BalAcc == "42306" ) )
        i = 5;
      elif( ( TermInDays > 3 * 365 ) or ( DepType.rec.BalAcc == "42307" ) )
        i = 6;
      end;
      */
      ProcessDepType;
    end;
  end;
  DepType.dropFilter;
  [|1. до 30 дней,  |############|############|############|############|############|############|
   |  в том числе:  |            |            |            |            |            |            |]
  ( safediv( NomForPercRub(0), TotalSumsRub(0) ),
    safediv( NomForPercUSD(0), TotalSumsUSD(0) ),
    safediv( NomForTermRub(0), TotalSumsRub(0) ),
    safediv( NomForTermUSD(0), TotalSumsUSD(0) ),
    TotalSumsRub(0), TotalSumsUSD(0)
  );
  cbRepFile.addParameter( "2100A1", safediv( NomForPercRub(0), TotalSumsRub(0) ), cbFmt_percent );
  cbRepFile.addParameter( "2100A2", safediv( NomForPercUSD(0), TotalSumsUSD(0) ), cbFmt_percent );
  cbRepFile.addParameter( "3100A1", safediv( NomForTermRub(0), TotalSumsRub(0) ) );
  cbRepFile.addParameter( "3100A2", safediv( NomForTermUSD(0), TotalSumsUSD(0) ) );
  cbRepFile.addParameter( "1100A1", TotalSumsRub(1) );
  cbRepFile.addParameter( "1100A2", TotalSumsUSD(1) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|  1.1  до востр.|############|############|      X     |      X     |############|############|]
  ( safediv( NomForPercRub(7), TotalSumsRub(7) ),
    safediv( NomForPercUSD(7), TotalSumsUSD(7) ),
    TotalSumsRub(7), TotalSumsUSD(7)
  );
  cbRepFile.addParameter( "210011", safediv( NomForPercRub(7), TotalSumsRub(7) ), cbFmt_percent );
  cbRepFile.addParameter( "210012", safediv( NomForPercUSD(7), TotalSumsUSD(7) ), cbFmt_percent );
  cbRepFile.addParameter( "110011", TotalSumsRub(7) );
  cbRepFile.addParameter( "110012", TotalSumsUSD(7) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|  1.2  2-7 дней |############|############|############|############|############|############|]
  ( safediv( NomForPercRub(1), TotalSumsRub(1) ),
    safediv( NomForPercUSD(1), TotalSumsUSD(1) ),
    safediv( NomForTermRub(1), TotalSumsRub(1) ),
    safediv( NomForTermUSD(1), TotalSumsUSD(1) ),
    TotalSumsRub(1), TotalSumsUSD(1)
  );
  cbRepFile.addParameter( "210031", safediv( NomForPercRub(1), TotalSumsRub(1) ), cbFmt_percent );
  cbRepFile.addParameter( "210032", safediv( NomForPercUSD(1), TotalSumsUSD(1) ), cbFmt_percent );
  cbRepFile.addParameter( "310031", safediv( NomForTermRub(1), TotalSumsRub(1) ) );
  cbRepFile.addParameter( "310032", safediv( NomForTermUSD(1), TotalSumsUSD(1) ) );
  cbRepFile.addParameter( "110031", TotalSumsRub(1) );
  cbRepFile.addParameter( "110032", TotalSumsUSD(1) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|2. 31-90   дней |############|############|############|############|############|############|]
  ( safediv( NomForPercRub(2), TotalSumsRub(2) ),
    safediv( NomForPercUSD(2), TotalSumsUSD(2) ),
    safediv( NomForTermRub(2), TotalSumsRub(2) ),
    safediv( NomForTermUSD(2), TotalSumsUSD(2) ),
    TotalSumsRub(2), TotalSumsUSD(2)
  );
  cbRepFile.addParameter( "210051", safediv( NomForPercRub(2), TotalSumsRub(2) ), cbFmt_percent );
  cbRepFile.addParameter( "210052", safediv( NomForPercUSD(2), TotalSumsUSD(2) ), cbFmt_percent );
  cbRepFile.addParameter( "310051", safediv( NomForTermRub(2), TotalSumsRub(2) ) );
  cbRepFile.addParameter( "310052", safediv( NomForTermUSD(2), TotalSumsUSD(2) ) );
  cbRepFile.addParameter( "110051", TotalSumsRub(2) );
  cbRepFile.addParameter( "110052", TotalSumsUSD(2) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|3. 91-180  дней |############|############|############|############|############|############|]
  ( safediv( NomForPercRub(3), TotalSumsRub(3) ),
    safediv( NomForPercUSD(3), TotalSumsUSD(3) ),
    safediv( NomForTermRub(3), TotalSumsRub(3) ),
    safediv( NomForTermUSD(3), TotalSumsUSD(3) ),
    TotalSumsRub(3), TotalSumsUSD(3)
  );
  cbRepFile.addParameter( "210061", safediv( NomForPercRub(3), TotalSumsRub(3) ), cbFmt_percent );
  cbRepFile.addParameter( "210062", safediv( NomForPercUSD(3), TotalSumsUSD(3) ), cbFmt_percent );
  cbRepFile.addParameter( "310061", safediv( NomForTermRub(3), TotalSumsRub(3) ) );
  cbRepFile.addParameter( "310062", safediv( NomForTermUSD(3), TotalSumsUSD(3) ) );
  cbRepFile.addParameter( "110061", TotalSumsRub(3) );
  cbRepFile.addParameter( "110062", TotalSumsUSD(3) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|4. 181-1 год    |############|############|############|############|############|############|]
  ( safediv( NomForPercRub(4), TotalSumsRub(4) ),
    safediv( NomForPercUSD(4), TotalSumsUSD(4) ),
    safediv( NomForTermRub(4), TotalSumsRub(4) ),
    safediv( NomForTermUSD(4), TotalSumsUSD(4) ),
    TotalSumsRub(4), TotalSumsUSD(4)
  );
  cbRepFile.addParameter( "210071", safediv( NomForPercRub(4), TotalSumsRub(4) ), cbFmt_percent );
  cbRepFile.addParameter( "210072", safediv( NomForPercUSD(4), TotalSumsUSD(4) ), cbFmt_percent );
  cbRepFile.addParameter( "310071", safediv( NomForTermRub(4), TotalSumsRub(4) ) );
  cbRepFile.addParameter( "310072", safediv( NomForTermUSD(4), TotalSumsUSD(4) ) );
  cbRepFile.addParameter( "110071", TotalSumsRub(4) );
  cbRepFile.addParameter( "110072", TotalSumsUSD(4) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|5. от 1 до 3 лет|############|############|############|############|############|############|]
  ( safediv( NomForPercRub(5), TotalSumsRub(5) ),
    safediv( NomForPercUSD(5), TotalSumsUSD(5) ),
    safediv( NomForTermRub(5), TotalSumsRub(5) ),
    safediv( NomForTermUSD(5), TotalSumsUSD(5) ),
    TotalSumsRub(5), TotalSumsUSD(5)
  );
  cbRepFile.addParameter( "210081", safediv( NomForPercRub(5), TotalSumsRub(5) ), cbFmt_percent );
  cbRepFile.addParameter( "210082", safediv( NomForPercUSD(5), TotalSumsUSD(5) ), cbFmt_percent );
  cbRepFile.addParameter( "310081", safediv( NomForTermRub(5), TotalSumsRub(5) ) );
  cbRepFile.addParameter( "310082", safediv( NomForTermUSD(5), TotalSumsUSD(5) ) );
  cbRepFile.addParameter( "110081", TotalSumsRub(5) );
  cbRepFile.addParameter( "110082", TotalSumsUSD(5) );
  [|----------------|------------|------------|------------|------------|------------|------------|];
  [|6. свыше 3 лет  |############|############|############|############|############|############|]
  ( safediv( NomForPercRub(6), TotalSumsRub(6) ),
    safediv( NomForPercUSD(6), TotalSumsUSD(6) ),
    safediv( NomForTermRub(6), TotalSumsRub(6) ),
    safediv( NomForTermUSD(6), TotalSumsUSD(6) ),
    TotalSumsRub(6), TotalSumsUSD(6)
  );
  cbRepFile.addParameter( "210091", safediv( NomForPercRub(6), TotalSumsRub(6) ), cbFmt_percent );
  cbRepFile.addParameter( "210092", safediv( NomForPercUSD(6), TotalSumsUSD(6) ), cbFmt_percent );
  cbRepFile.addParameter( "310091", safediv( NomForTermRub(6), TotalSumsRub(6) ) );
  cbRepFile.addParameter( "310092", safediv( NomForTermUSD(6), TotalSumsUSD(6) ) );
  cbRepFile.addParameter( "110091", TotalSumsRub(6) );
  cbRepFile.addParameter( "110092", TotalSumsUSD(6) );
  [|-----------------------------------------------------------------------------------------------];

  if ( NumBranch > -1 )
    ;
  else
    cbRepFile.write;
  end;
end;

/* Голова */

  if( ChooseBranchAndDateForWork )
    if( StartDate > {curdate} )
      MsgBox( "Дата начала периода отчёта не должна превышать текущую!" );
      Exit( -1 );
    end;
    OpenDepFiles;
    GetBuckCBRate;
    Report;
    CloseDepFiles;
  end;
end;
