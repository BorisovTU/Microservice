/*
$Name:             form_36.mac
$Module:           RS-Retail
$Description:      Печать формы 36
*/

import deprintr, commclnt, alg_vars;

/****************************************************************/
/*                 Константы для пользователей                  */
/****************************************************************/
const PhoneType = 4;     /* Вид номера телефона для ф.0401026:  */
                         /*  4 - домашний телефон,              */
                         /*  5 - рабочий телефон.               */
const FlagDate = FALSE;  /* Флаг простановки даты операционного */
                         /* дня в поле "Дата заполнения".       */

file namealg  ( namealg  ) key 0;
file opr      ( person   ) key 0;
file sb_casln ( sb_casln ) key 0;
file ret_op   ( ret_op   ) key 0;
file depositr ( depositr ) key 8;
file sb_dtyp  ( sb_dtyp  ) key 2;
file sb_typop ( sb_typop ) key 0;
file rtnfopr  ( rtnfopr  ) key 1;
file aux      ( auxinfo  ) key 0;  /* доп.информ. о вкладе */

var i_dp_dep = TRecHandler( "i_dp_dep.rec" );

var  clnt = TClientList;

record ret_op_dep  ( "ret_op.dep" );
record sbtrast_new ( sbtrast );

private var {Name_Bank};

var Branch = NumFNCash( );

var sFIO_Trast = "";  // Ф.И.О. доверенного лица.

Var sCheckInfo = "";

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FindNFOpr

  var numDprt = 0;
  var recID   = 0;
  var stat;

  if ( ALG_NFOPR.objectType == 224 )
    Next( sb_casln );
  end;

  if ( StrLen( sb_casln.ApplicationKey2 ) >= 12 )
    numDprt = Int( SubStr( sb_casln.ApplicationKey2,  9,  5 ) );
    recID   = Int( SubStr( sb_casln.ApplicationKey2, 14, 10 ) );
  end;

  rtnfopr.numDprt = numDprt;
  rtnfopr.recID   = recID;

  stat = GetEQ( rtnfopr );

  if ( stat  AND  ( rtnfopr.TableName != "sbtrast.dbt" ) )
    stat = Next( rtnfopr );
  end;

  return stat;

end;

/**************************************************************************\
|                               Получение телефона                         |
\**************************************************************************/

macro GetPhoneNumberF36(ClntCode)
  var DepClnt = TClientList;
  var AddrTypes = TArray;
  var i = 0;
  var PhoneNumber = "";
  var PhoneNumber2 = "";
  
  if (DepClnt.GetRecord (clntCode))
    AddrTypes(0) = COMMCLNT_PTADDR_LEGAL;
    AddrTypes(1) = COMMCLNT_PTADDR_REAL;
    AddrTypes(2) = COMMCLNT_PTADDR_POST;

    while ((i < AddrTypes.Size) and (PhoneNumber == ""))
      PhoneNumber = commclnt_GetAddressField(DepClnt, AddrTypes(i), "PhoneNumber");
      PhoneNumber2 = commclnt_GetAddressField(DepClnt, AddrTypes(i), "PhoneNumber2");
      if ((PhoneNumber != "") and (PhoneNumber2 != ""))
        PhoneNumber = PhoneNumber + ", ";
      end;
      PhoneNumber = PhoneNumber + PhoneNumber2;
      i = i + 1;
    end;
  end;
  return PhoneNumber;
end;


/**************************************************************************\
|                       Получение Ф.И.О. доверенного лица.                 |
\**************************************************************************/
macro FillFIOForTrast()
  if ( FindNFOpr( ) )
    SetRecordAddr( sbtrast_new, rtnfopr, 0, 2, false );
    if ( sbtrast_new.CodClient != 0 )
      if ( clnt.GetRecord( sbtrast_new.CodClient ) )
        sFIO_Trast = clnt.CurRec.ConvertFIOFull();
      end;
    end;
  end;
end;

/*************************************************************************
               Получение наименования подразделения.
*************************************************************************/
macro get_Branch_Name()
  var s_Branch_Name = getFilialName();
  /*
  if ( FindDepartment( Branch, NULL, i_dp_dep ) )
    s_Branch_Name = i_dp_dep.rec.Name;
  else
    s_Branch_Name = String( Branch );
  end;
  */
  return s_Branch_Name;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro Print_nf_36

  var v_FIO;
  // var sOper = "";

  if ( clnt.GetRecord( ALG_DEPOSITOR.CodClient ) )
    v_FIO = clnt.CurRec.ConvertFIOFull();
  end;

  FillFIOForTrast();

  /*
  opr.Oper = {oper};
  if ( GetEQ( opr ) )
    sOper = opr.Name;
  else
    sOper = "";
  end;
  */

  [
     Сбербанк России                                           ф.№ 322
    ##################################################################
    --------------------------------
      (наименование подразделения
          Сбербанка России)

      Доверяю получать суммы со вклада по счету № #######################################################
    с ######################################################
    ##################################################################




    ##################################################################



    ________________________/##################################################################]
  (
    get_Branch_Name(),
    Acc_Form(ALG_DEPOSITOR.Account):f,
    String( sbtrast_new.DateOpen:m ) + " по " + String( sbtrast_new.CloseDate:m ),
    ( "клиенту: " + sFIO_Trast ):w,
    {curdate}:m,
    v_FIO + "/"
  );

end;

/**************************************************************************\
|               Проверка вида вклада: "Специальный счет" ?                 |
\**************************************************************************/
macro Check_Special_DepType()

 var ret_val = FALSE;

 ClearRecord( ret_op );
 ret_op.ApplicationKind = ALG_RET_OP.ApplicationKind;
 ret_op.ApplicationKey  = ALG_RET_OP.ApplicationKey;

 if ( GetEQ( ret_op ) )
   SetRecordAddr( ret_op_dep, ret_op, 0, FldOffset( ret_op, "Extra" ), true );
   if ( ret_op_dep.accRef > 0 )

     ClearRecord( depositr );
     depositr.Referenc = ret_op_dep.accRef;

     if ( GetEQ( depositr ) )
       if ( Index( depositr.UserTypeAccount, "Щ" ) > 0 )
         ret_val = TRUE;
       end;
     end;
   end;
 end;

 return ret_val;

end;

/**************************************************************************\
|                       Выпуск карточки формы 0401026                      |
\**************************************************************************/
macro Form_0401026()

 var
   v_FIO      = "",
   v_FIO_Sign = "",
   v_Owner    = "",
   v_Address  = "",
   v_Phone    = "",
   v_BankName = {Name_Bank},
   v_Account  = ALG_DEPOSITOR.Account,
   v_DateSet  = "";

   if ( clnt.GetRecord( depositr.CodClient ) )
     v_FIO   = clnt.CurRec.ConvertFIOFull();
     v_Owner = v_FIO + ", дата рождения: " +
       String( clnt.CurRec.rec.Born:m ) + ", " +
       clnt.CurRec.MakeDocStr();
     // v_Address  = clnt.CurRec.rec.AddressF;
     v_Address = commclnt_Получить_Поле_Address_Фактического_Адреса( clnt.CurRec );
     v_Phone   = GetPhoneNumberF36(clnt.CurRec.rec.CodClient);
   end;

   if ( ( ALG_NFOPR.objectType == 222 )  OR  // Ввод новой доверенности.
        ( ALG_NFOPR.objectType == 224 )  OR  // Продление доверенности.
        ( ALG_NFOPR.objectType == 226 )  OR  // Ввод передоверия.
        ( ALG_NFOPR.objectType == 228 ) )    // Отмена передоверия.
     FillFIOForTrast();
     v_FIO_Sign = sFIO_Trast;
   else
     v_FIO_Sign = v_FIO;
   end;

   if ( FlagDate )  /* Проставить значение в поле "Дата заполнения". */
     v_DateSet  = String( {curdate}:m );
   end;

 [
                                                           ------------------
                                                           |    Код формы   |
                                                           |    документа   |
                                                           |     по ОКУД    |
                                                           ------------------
                                                           |     0401026    |
                                                           ------------------

                Карточка
   с образцами подписей и оттиска печати

                                               |----------------------------|
                                               |        Отметка банка       |
   ########################################### |                            |
                                               | -------------------------- |
                                               |          (подпись)         |
                                               | "___" ____________ 20___г. |
   ------------------------------------------- |                            |
        Место нахождения (место жительства)    |----------------------------|
    ########################################## |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    _тел. N (_______) ######################## |                            |
     ######################################### |                            |
    ------------------------------------------ |----------------------------|
                                               |  Прочие отметки            |
    ------------------------------------------ |                            |
                                               |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    ------------------------------------------ |----------------------------|
                                               |                            |
    -------------------------------------------------------------------------]
    (
      ("Владелец счета " + v_Owner):w,
      v_Address:w,
      v_Phone,
      ("Банк " + "\"" +  v_BankName + "\""):w
    );
 [#](MkStr(12,1));  /* Переход к новой странице */
 [
    #########################################################################
    -------------------------------------------------------------------------
      (краткое наименование владельца счета)
    N банковского счета #####################################################
    -------------------------------------------------------------------------
       Должность   |       Фамилия, имя,      | Образец |Срок полномочий лиц,
                   |          отчество        | подписи |      временно
                   |                          |         |пользующихся правом
                   |                          |         |      подписи
    -------------------------------------------------------------------------
    #######|       |##########################|         |
           |       |--------------------------|---------|
           |       |                          |         |
           |       |--------------------------|---------|
           |       |                          |         |
           |       |--------------------------|---------|
           |       |                          |         |
    -------------------------------------------------------------------------
    вторая |       |                          |         |
    подпись|       |--------------------------|---------|
           |       |                          |         |
           |       |--------------------------|---------|
           |       |                          |         |
           |       |--------------------------|---------|
           |       |                          |         |
    -------------------------------------------------------------------------
    Дата           |####################################| Образец оттиска
    заполнения     |                                    | печати
    ----------------------------------------------------|
    Подпись        |                                    |
    клиента        |                                    |
    -------------------------------------------------------------------------
                                  |                                         |
                                  |            Выданы денежные чеки         |
    ------------------------------|                                         |
    Место для удостоверительной   |-----------------------------------------|
    надписи о свидетельствовании  | Дата | с N  | по N | Дата | с N  | по N |
    подлинностей подписей         |------|------|------|------|------|------|
                                  |      |      |      |      |      |      |
                                  |------|------|------|------|------|------|
                                  |      |      |      |      |      |      |
                                  |------|------|------|------|------|------|
                                  |      |      |      |      |      |      |
                                  |------|------|------|------|------|------|
                                  |      |      |      |      |      |      |
                                  |------|------|------|------|------|------|
                                  |      |      |      |      |      |      |
    ------------------            |------|------|------|------|------|------|]
    (
      v_FIO,
      Acc_Form(v_Account):f,
      "первая подпись":w,
      v_FIO_Sign:w,
      v_DateSet
    );
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintForm_nf_36

  if ( Check_Special_DepType() )  /* Если счет вида "Специальный счет", то ... */
    Form_0401026();                /* ... выпускается карточка ф. 0401026.  */
  else
    Print_nf_36();
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro IsFirstLog

  var ret_flag       = false;
  var stat;
  var kind_main      = 0;
  var key_main       = "";
  var key_current    = "";
  var numDprt        = String( ALG_NFOPR.numDprt );
  var recID          = String( ALG_NFOPR.recID );

  while ( StrLen( numDprt ) < 5 )
    numDprt = "0" + numDprt;
  end;
  while ( StrLen( recID ) < 10 )
    recID = "0" + recID;
  end;
  key_current = "rtnfopr#" + numDprt + recID + "00";

  KeyNum( sb_casln, 1 );
  sb_casln.ApplicationKind2 = 3001;
  sb_casln.ApplicationKey2  = key_current;
  sb_casln.RefValue2        = 0;

  stat = GetEQ( sb_casln );

  if ( stat )
    ;
  else
    numDprt = String( ALG_NFOPR.numDprt );

    while ( StrLen( numDprt ) < 3 )
      numDprt = "0" + numDprt;
    end;

    key_current = "rtnfopr#" + numDprt + recID + "00";

    KeyNum( sb_casln, 1 );
    sb_casln.ApplicationKind2 = 3001;
    sb_casln.ApplicationKey2  = key_current;
    sb_casln.RefValue2        = 0;

    stat = GetEQ( sb_casln );
  end;

  if ( stat )
    kind_main = sb_casln.ApplicationKind1;
    key_main  = sb_casln.ApplicationKey1;

    KeyNum( sb_casln, 0 );
    sb_casln.ApplicationKind1 = kind_main;
    sb_casln.ApplicationKey1  = key_main;
    sb_casln.NumLinkDoc       = 0;

    stat = GetGE( sb_casln );
    while ( stat )
      if ( ( sb_casln.ApplicationKind1 == kind_main ) and
           ( sb_casln.ApplicationKey1  == key_main  )    )
        if ( sb_casln.ApplicationKind2 == 3001 )
          if ( sb_casln.ApplicationKey2 == key_current )
            ret_flag = true;
          end;
          stat = false;
        else
          stat = Next( sb_casln );
        end;
      else
        stat = false;
      end;
    end;
  end;

  return ret_flag;

end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/

  ALG_RESULT = OK_RES;

  if ( IsFirstLog( ) )
    PrintForm_nf_36( );
  else
    Exit( 1 );
  end;

end;
