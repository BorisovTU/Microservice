/***************************************************************************\
| AGEVER.MAC Система:RS-Retail Автор: Саввин Д.                             |
| Для вида вклада "Целевой на детей" устанавливает дату окончания договора  |
| Для шага "Ограничение на сумму прихода" операции открытия                 |
\***************************************************************************/
 import deprintr;
/*---------- Инициализируемые структуры ---------------------------------*/
 record ALG_DEPOSITOR("depositr.dbt");
 record ALG_SBDEPDOC("sbdepdoc.dbt");
 record ALG_PARAM("sb_algop.dbt");
 var    DC = TClientList;

/*---------- Коды возврата макроса --------------------------------------*/
 const  OK_RES   =  0,  /* продолжать проводку */
        SKIP_RES =  1,  /* пропустить выполнение предопределенного модуля */
        END_RES  =  2,  /* завершить проводку */
        ERR_RES  = -1;  /* аваpийно завершить проводку */
/*-----------------------------------------------------------------------*/
 var 
     {curdate},
     Dat1=date(0,0,0), Dat2=date(0,0,0),
     day=0, mon=0, year=0;

 macro BD(CodClient)
   if (DC.GetRecord (CodClient))
     return DC.CurRec.rec.Born;
   else
     msgbox("Не найден клиент счета");
     ALG_RESULT=ERR_RES;
     exit(1);
   end;
 end;

 macro MaxDate(date1,date2)
   if(date1>=date2)
     return date1
   else
     return date2
   end;
 end;

/*-----------------------------------------------------------------------*/

DateSplit(ALG_DEPOSITOR.Start_DateDep,day,mon,year);
/* Для рублевого срок мин.10 лет, а для валютного - 3 года*/
IF(ALG_DEPOSITOR.Code_Currency == 0)
  Dat1=date(day,mon,year+10);
ELSE
  Dat1=date(day,mon,year+3);
END;/* IF */
DateSplit(BD(ALG_DEPOSITOR.CodClient),day,mon,year);
IF ( ( day == 0 )  OR  ( mon == 0 )  OR  ( year == 0 ) )
    MsgBox( "Не задана дата рождения.|Открыть счет невозможно" );
    ALG_RESULT=ERR_RES;
    return;
END;
Dat2=date(day,mon,year+16);
ALG_DEPOSITOR.End_DateDep=maxdate(Dat1,Dat2);
/* VZ В счете %% по основным условиям устанавливаем дату окончания начисления
равной дате конца договора. Это делается для того, чтобы после окончания
договора на проценты начисленные по основным условиям, проценты не начислялись */
/*ALG_DEPOSITOR.DateEndPerc = ALG_DEPOSITOR.End_DateDep;*/
ALG_RESULT=OK_RES;
ALG_UPDATE=1;
return;
