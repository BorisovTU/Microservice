/*
     R-Style Software Lab.

     RS-Retail 2.01.

     Заявление на конверсию средств в иностранной валюте

*/

import deprintr, BankInter, brparm, ChkPrn;

/*-------------- Используемые файлы ---------------*/
var DepClient = TClientList;

/*---------- Инициализируемые структуры -----------*/
record ALG_DEPOSITOR("depositr.dbt");
record ALG_SBDEPDOC ("sbdepdoc.dbt");
file   TempFile   ("sbdepdoc.dbt");
file   Curr       ("currency.dbt") key 0;

record doc1 ( "sbdepdoc.1" );

/*---------- Коды возврата макроса ----------*/
const  OK_RES   =  0,  /* продолжать проводку */
       SKIP_RES =  1,  /* пропустить выполнение предопределенного модуля */
       END_RES  =  2,  /* завершить проводку */
       ERR_RES  = -1;  /* аваpийно завершить проводку */

const UPDATE_ALL  = 1;
const UPDATE_DEP  = 2;
const UPDATE_DOC  = 4;


 private var {curdate};

 var CBRate   = 0.0;
 var BuyRate  = 0.0;
 var SellRate = 0.0;

 private var {Name_Bank};
 var Num_Ord = 0;
 var str_sum;
 var CountValue : DOUBLEL;


 macro MoneyToStr( CurrCode, Sum )
   Curr.Code_Currency = CurrCode;
   if( GetEQ( Curr ) );
     return CurToStrAlt( Sum, null, null, Int( Curr.ExternalCode ) );
   end;
   return "";
 end;

 /******************************************************************/
 macro CheckPrn

   var
     /*
     RegPath = "RS-RETAIL\\ПЕЧАТИ\\ВКЛАДЫ\\СПРАВКА_О_РАСХ_ПО_СЧЕТУ_Ф";
     */
    RegPath = "RS-RETAIL\\ПЕЧАТИ\\ВКЛАДЫ\\ДОГОВОРА";

    CheckPrinter(RegPath, StrFor(0));
 end;

 /******************************************************************/
 macro GetClientName(code)

  if (DepClient.GetRecord (code))
    return DepClient.CurRec.ConvertFIOFull();
  else
    return "";
  end;
end;

 /******************************************************************/
 macro Declaration( )
 [&l0o(s0p12.00h12)

                                            в #


                                ЗАЯВЛЕНИЕ № K - #
                     на конверсию средств в иностранной валюте
                                #

         Прошу списать сумму средств с моего счета № #
      #####################################################################
      и провести датой подачи настоящего заявления конверсию данной суммы в
      рубли Российской Федерации по курсу #
      Рублевый эквивалент указанной суммы прошу зачислить датой подачи насто-
      ящего заявления на мой рублевый счет № #
      в #

          Ф.И.О. клиента: #

                                    Подпись _________________________________


          Отметка Банка о приеме







  






 ]
 (
   {Name_Bank}, Num_Ord,
   String(ALG_SBDEPDOC.Date_Document:f:m),
   Acc_Form(ALG_SBDEPDOC.Account):f,
   ( "в размере " + String(ALG_SBDEPDOC.OutSum) + " " + Curr.Short_Name 
      + " " +  str_sum ):w,
   String(BuyRate:7:4) + " курс б\\н покупки руб./" + Curr.Short_Name,
   Acc_Form(Doc1.Account_Receiver):f,
   {Name_Bank} + ".",
   getClientName( ALG_DEPOSITOR.CodClient )
 );

 end;

 /******************************************************************/
 /*                          Основная процедура                    */
 /******************************************************************/

 /*if ( NOT GetAllCurrRate( {curdate}, ALG_DEPOSITOR.Code_Currency,
                          CBRate, BuyRate, SellRate ) )
    MsgBox("Ошибка при определении курса валюты");
    Exit(1);
   end;*/

  /*
  else
    CBRate   = CBRate   * 100.0;
    BuyRate  = BuyRate  * 100.0;
    SellRate = SellRate * 100.0; */

 Copy (TempFile,ALG_SBDEPDOC);
 SetRecordAddr( Doc1, TempFile, 0, 0, true );

 str_sum = MoneyToStr( ALG_SBDEPDOC.Code_Currency, ALG_SBDEPDOC.OutSum );

 Copy (TempFile,ALG_SBDEPDOC);
 SetRecordAddr( doc1, TempFile, 0, 0, true );
 BuyRate = doc1.PercTrnRest;
 CheckPrn();
 Declaration();
 [ ];
 [ ];
 Declaration();
 [];

 ALG_RESULT = OK_RES;
 if ( MacroOutput == "PRN" )
    Exit( 1 );
 end;

end;
