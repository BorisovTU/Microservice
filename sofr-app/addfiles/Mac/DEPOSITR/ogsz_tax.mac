/*

  Расчет подоходного налога по ОГСЗ

*/

import DeprIntr;

file   Doc    ( "ci_doc.dbt" ) key 8;
file   PcTax  ( "pc_tax.dbt" ) key 1 write;
record ThisDoc( "ci_doc.dbt" );
record OGSZDocInfo( "ci_doc.1" );
record PcTaxVar( "pc_tax6.dbt" );

const
  MinSalaryx1000 = $200 * 1000; 

const
  CI_OGSZ = 1,
  RPCB_TAX_PAPERS_RETAIL = 6;

array
  RangeTops, Rates, Constant;

/*
RangeTops( 0 ) = $50000; Rates( 0 ) = 12.0; Constant( 0 ) = $0;
RangeTops( 1 ) = $50000; Rates( 1 ) = 12.0; Constant( 1 ) = $0;
RangeTops( 2 ) = $150000; Rates( 2 ) = 20.0; Constant( 2 ) = $6000; 
RangeTops( 3 ) = $0; Rates( 3 ) = 30.0; Constant( 3 ) = $26000; 
*/
RangeTops( 0 ) = $0; Rates( 0 ) = 13.0; Constant( 0 ) = $0; 

const
  O_OGSZ_BUY = 2;

const
  M_DOCS_SHOWN = 1,
  M_NO_DOCS    = 2;

var
  {curdate},
  Year,
  Tax = $0,
  TaxRate = 0.0,
  TaxBase = $0,
  TaxRateIndex,
  ComClient = TClientList;

macro ApplyRate( Sum )

  TaxRateIndex = 0;

  if ( Sum <= $0 )
    return 0;
  end;
  while ( ( TaxRateIndex < ASize( RangeTops ) - 1 ) and ( Sum > RangeTops( TaxRateIndex ) ) )
    TaxRateIndex = TaxRateIndex + 1;
  end;
  if ( TaxRateIndex != 0 )
    Sum = Sum - RangeTops( TaxRateIndex - 1 );
  end;
  if( ComClient.CurRec.rec.NotResident == StrFor(0) ) /* резиденты - 13%   */
    TaxRate = 13.0;
  else                                                /* нерезиденты - 30% */
    TaxRate = 30.0;
  end;
  /*TaxRate = Rates( TaxRateIndex );*/
  return Money( Sum * TaxRate / 100.0 ) + Constant( TaxRateIndex );
end;

macro GetMethod

  file DocTmp( "ci_doc.dbt" ) key 8;

  var
    ClientSoldThisIssueInCurrentYear = false, 
    RecFound,
    Found = false;

  ClearRecord( DocTmp );
  DocTmp.ClientCode = ThisDoc.ClientCode;
  DocTmp.Date = Date( 01, 01, Year );
  RecFound = GetGE( DocTmp );
  while ( RecFound and ( not ClientSoldThisIssueInCurrentYear ) 
    and ( DocTmp.ClientCode == ThisDoc.ClientCode ) )
    if (  ( DocTmp.Type == CI_OGSZ )
      and ( DocTmp.Issue == ThisDoc.Issue )
      and ( DocTmp.Operation == O_OGSZ_BUY ) )
      ClientSoldThisIssueInCurrentYear = true;
    end;
    if ( not ClientSoldThisIssueInCurrentYear )
      RecFound = Next( DocTmp );
    end
  end;

  if ( not ClientSoldThisIssueInCurrentYear )
    return;
  end;
  
  ClearRecord( PcTax );
  PcTax.IdentClient = ThisDoc.ClientCode;
  PcTax.CodeModule = RPCB_TAX_PAPERS_RETAIL;
  PcTax.ObjectTax_Add = CI_OGSZ;
  PcTax.DateTaxPay = Date( 1, 1, Year );
  RecFound = GetGE( PcTax );
  while ( RecFound and ( not Found ) 
    and ( PcTax.IdentClient == ThisDoc.ClientCode )
    and ( PcTax.CodeModule == RPCB_TAX_PAPERS_RETAIL )
    and ( PcTax.ObjectTax_Add == CI_OGSZ )
    and ( PcTax.DateTaxPay == Date( 1, 1, Year ) ) )
    if ( PcTax.ObjectTax == ThisDoc.Issue )
      Found = true; 
      SetRecordAddr( PcTaxVar, PcTax );
      OGSZDocInfo.IncomeTaxMethod = PcTaxVar.IncomeTaxMethod;
    end;
    if ( not Found )
      RecFound = Next( PcTax );
    end;
  end;  
end;

macro SaveMethod
/*
  SetRecordAddr( PcTaxVar, PcTax );
  PcTax.IdentClient = ThisDoc.ClientCode;
  PcTax.CodeModule = RPCB_TAX_PAPERS_RETAIL;
  PcTax.ObjectTax_Add = CI_OGSZ;
  PcTax.ObjectTax = ThisDoc.Issue; 
  PcTax.DateTaxPay = Date( 1, 1, Year );
  PcTaxVar.IncomeTaxMethod = OGSZDocInfo.IncomeTaxMethod;
  Insert( PcTax, GetRecordSize( PcTaxVar ) );*/
end;

macro CalcIncomeTax( DocAddr )

  var
    TotalSum = $0,
    TotalSpentSum = $0,
    TotalTax = $0,
    TmpSum,
    RecFound;

  Tax = $0;

  SetBuff( ThisDoc, DocAddr );
  Copy( Doc, ThisDoc );
  SetRecordAddr( OGSZDocInfo, Doc, 0, FldOffset( Doc, "Info"),true);

  DateSplit( ThisDoc.Date, null, null, Year );

  ComClient.GetRecord( ThisDoc.ClientCode );
  
  if ( OGSZDocInfo.IncomeTaxMethod == 0 )
    GetMethod;
    if ( OGSZDocInfo.IncomeTaxMethod == 0 )
      if ( GetTrue( false, "Клиент предъявил документы, подтверждающие приобретение ценных бумаг?" ) )
        OGSZDocInfo.IncomeTaxMethod = M_DOCS_SHOWN;
      else
        OGSZDocInfo.IncomeTaxMethod = M_NO_DOCS;
      end;
      SaveMethod;
    end;
    if ( OGSZDocInfo.IncomeTaxMethod == M_DOCS_SHOWN )
      GetMoney( OGSZDocInfo.PrevSpentSum, "Введите сумму, потраченную клиентом на покупку ОГСЗ (Без учета НКД)" );
    end;
    Copy( ThisDoc, Doc );
  end;

  TotalSum = TotalSum + OGSZDocInfo.Par * OGSZDocInfo.NumItems + OGSZDocInfo.Commission; 
  if ( OGSZDocInfo.IncomeTaxMethod == M_DOCS_SHOWN )
    TotalSpentSum = TotalSpentSum + OGSZDocInfo.PrevSpentSum;
  end; 

  if ( OGSZDocInfo.IncomeTaxMethod == M_NO_DOCS )
    TotalSpentSum = MinSalaryx1000;
  end;                                       

  ClearRecord( Doc );
  Doc.ClientCode = ThisDoc.ClientCode;
  Doc.Date = Date( 01, 01, Year );
  RecFound = GetGE( Doc );
  while ( RecFound and ( Doc.ClientCode == ThisDoc.ClientCode ) )
    if (  ( Doc.Type == CI_OGSZ )
      and ( Doc.Issue == ThisDoc.Issue )
      and ( Doc.Operation == O_OGSZ_BUY ) )
      TotalSum = TotalSum + OGSZDocInfo.Par * OGSZDocInfo.NumItems + OGSZDocInfo.Commission;
      if ( OGSZDocInfo.IncomeTaxMethod == M_DOCS_SHOWN )
        TotalSpentSum = TotalSpentSum + OGSZDocInfo.PrevSpentSum;
      end; 
      TotalTax = TotalTax + OGSZDocInfo.IncomeTax;
    end;
    RecFound = Next( Doc );
  end;
          
  Tax = $0;
  if ( TotalSum > TotalSpentSum )
    TaxBase = TotalSum - TotalSpentSum - TotalTax;
    Tax = ApplyRate( TotalSum - TotalSpentSum ) - TotalTax;
    if ( Tax < $0 )
      Tax = $0;
    end;
  end;
end;

