private record grdrec( "ground.rec" );

const IN_OUT_SKS  = 36000,
      PAY_NO_ACC  = 42000,
      GOOD_NO_ACC = 93000,
      PAY_PLATA   = 40000;

/* поиск записи в файле ret_op */
macro GetRet_OP( iApplicationKind, ApplicationKey, ret_op )
   var stat;
   FILE fil_sb_casln( sb_casln );

   KeyNum(fil_sb_casln,1);
   Rewind(fil_sb_casln);
   ClearRecord(fil_sb_casln);

   fil_sb_casln.ApplicationKind2 = iApplicationKind;
   fil_sb_casln.ApplicationKey2  = ApplicationKey;
   fil_sb_casln.RefValue2=0;

   stat = ( GetLE( fil_sb_casln ) and
            ( fil_sb_casln.ApplicationKey2  == ApplicationKey   ) and
            ( fil_sb_casln.ApplicationKind2 == iApplicationKind ) );
   if( stat )
      ret_op.ApplicationKey  = fil_sb_casln.ApplicationKey1;
      ret_op.ApplicationKind = fil_sb_casln.ApplicationKind1;
   end;
   return GetEQ( ret_op );
end;

macro GetMain_PayDoc ( iApplicationKind, ApplicationKey, ret_pay_doc )
   var stat;
   FILE fil_sb_casln( sb_casln );

   KeyNum(ret_pay_doc,2);

   KeyNum(fil_sb_casln,1);
   Rewind(fil_sb_casln);
   ClearRecord(fil_sb_casln);

   fil_sb_casln.ApplicationKind2 = iApplicationKind;
   fil_sb_casln.ApplicationKey2  = ApplicationKey;
   fil_sb_casln.RefValue2=0;

   stat = ( GetLE( fil_sb_casln ) and
            ( fil_sb_casln.ApplicationKey2  == ApplicationKey   ) and
            ( fil_sb_casln.ApplicationKind2 == iApplicationKind ) );
   if( stat )
      ret_pay_doc.ApplicationKey  = fil_sb_casln.ApplicationKey1;
      ret_pay_doc.iApplicationKind = fil_sb_casln.ApplicationKind1;
   end;
   return GetEQ( ret_pay_doc );
end;

macro GetPrevDoc( pay_doc, prev_doc )
   var stat = True;
   var pos  = 0L;

   FILE fil_sb_casln( sb_casln );

   KeyNum(fil_sb_casln,1);
   Rewind(fil_sb_casln);
   ClearRecord(fil_sb_casln);

   fil_sb_casln.ApplicationKind2 = pay_doc.iApplicationKind;
   fil_sb_casln.ApplicationKey2  = pay_doc.ApplicationKey;
   fil_sb_casln.RefValue2=0;

   stat = ( GetLE( fil_sb_casln ) and
            ( fil_sb_casln.ApplicationKey2  == pay_doc.ApplicationKey   ) and
            ( fil_sb_casln.ApplicationKind2 == pay_doc.iApplicationKind ) );
   if( stat )
      pos = GetPos( fil_sb_casln );
      KeyNum( fil_sb_casln, -1 );
      Rewind( fil_sb_casln );

      GetDirect( fil_sb_casln, pos ); /* встали на документ*/
      prev( fil_sb_casln ); /* перешли на предыдущий */
      /* Ищем в pay_doc */
      keynum( prev_doc, 2 );
      rewind( prev_doc );

      prev_doc.iApplicationKind = fil_sb_casln.ApplicationKind2;
      prev_doc.ApplicationKey   = fil_sb_casln.ApplicationKey2;

      stat = GetEQ( prev_doc );
   end;

   return stat;
end;

/* Наименование прочей операции с подопреацией */
macro GetNamePAY_DOC( pay_doc, Oper, SubOper );
   var fOperat = "";

   file pay_kind( pay_kind );
   file pay_csop( pay_csop );

   if( pay_doc.Numopert == Oper )
      /* Напечать операцию с подоперацией */
      KeyNum( pay_kind, 0 );
      rewind( pay_kind    );
      ReWind( pay_kind    );

      pay_kind.IsCur      = pay_doc.IsCur;
      pay_kind.GroupOpert = pay_doc.GroupOpert;
      pay_kind.NumOperat  = Oper;
      if( GetEQ( pay_kind ) )
         fOperat = pay_kind.SzNameAlg;
      else
         fOperat = " ";
      end;
      if( SubOper > 0 )
         KeyNum( pay_csop, 0 );
         ReWind( pay_csop    );
         pay_csop.IsCur     = pay_doc.IsCur;
         pay_csop.GroupType = pay_doc.GroupOpert;
         pay_csop.NumOperat = Oper;
         pay_csop.ApplType  = SubOper;
         if( GetEQ( pay_csop ) )
            fOperat = fOperat + " (" + pay_csop.NameCompType + ")";
         end;
      end;
   else
     fOperat = "";
   end;

   return fOperat;
end;

macro SetOsnov_Dep( depdoc )
   var Osnov  = "";
   var pos    = 0;
   var CountValue : DOUBLEL;

   file ret_op ( ret_op ) write;
   file dep ( depositr ) key 8;

   array Dep_Osnov;

   Osnov = "Договор банковского счета № _DOG_ от _DATE_";

   GetRet_Op( depdoc.iApplicationKind, depdoc.ApplicationKey, ret_op );
   dep.Referenc = depdoc.Referenc;
   GetEQ( dep );

   /*MsgBox( depdoc.Account, " ", dep.Account );*/

   Osnov = StrSubst( Osnov, "_DOG_" ,  Trim( dep.SvodAccount ) );
   Osnov = StrSubst( Osnov, "_DATE_" , String( ret_op.Date:f:m ) );

   return Osnov;
end;

macro SetOsnov_Pay( pay_doc )
   var Osnov  = "";
   var pos    = 0;
   var NumOpert = 0;
   var CountValue : DOUBLEL;

   file ret_op ( ret_op );
   file prev_doc( pay_doc );

   /*
   NumOpert = pay_doc.NumOpert * 1000 + pay_doc.ApplType;
   */

   GetRet_Op( pay_doc.iApplicationKind, pay_doc.ApplicationKey, ret_op );

   NumOpert = pay_doc.NumOpert * 1000;

   If( NumOpert == IN_OUT_SKS )
      if( pay_doc.GroupOpert == 11 )
         Osnov = "Взнос денежных средств на СКС";
      else
         Osnov = "Выдача денежных средств с СКС";
      end;
   elif( ( NumOpert == GOOD_NO_ACC ) or ( NumOpert == PAY_NO_ACC ) )
      /* Передача параметров через файл операций не проходит для однотипных операций,
         связанных в одну

      GetRet_Op( pay_doc.iApplicationKind, pay_doc.ApplicationKey, ret_op );
      if( Trim( ret_op.Extra ) == "" )
         if( GetCountValueEx( 2, 12, NumFNCash, CountValue ) );
            ret_op.Extra = Int( CountValue );
            Update( ret_op );
         end;
      end;
      */
      if( Trim( pay_doc.UserField ) == "" )
         if( GetCountValueEx( 2, 12, NumFNCash, CountValue ) );
            pay_doc.UserField = Int( CountValue );
            Update( pay_doc );
         end;
      end;

      Osnov  = "Заявление № _ZAV_ от _DATE_ _GRND_";

   elif( pay_doc.GroupOpert == 21 ) /* платы */
      /* В основание платы пишем из основания главного документа */
      If( GetPrevDoc( pay_doc, prev_doc ) )
         pay_doc.Ground = prev_doc.Ground;
         Update( pay_doc );
         Osnov = pay_doc.Ground;
      else
         Osnov  = "_NMOP_ ";
      end;
   else
      Osnov  = "_NMOP_ ";
   end;

   Osnov = StrSubst( Osnov, "_ZAV_" , String( ret_op.Branch, " - ",Int( pay_doc.UserField ) ) );
   Osnov = StrSubst( Osnov, "_DATE_" , String( ret_op.Date:f:m ) );
   Osnov = StrSubst( Osnov, "_NMOP_" , GetNamePAY_DOC( pay_doc, ret_op.Operation, ret_op.SubOp ) );
   Osnov = StrSubst( Osnov, "_GRND_" ,  Trim( pay_doc.Ground ) );

   return Osnov;
end;

macro SetOsnov_Cas( casdoc )
   array Desk_Osnov;

end;

macro InsToPayMent( iApplicationKind, ApplicationKey, Payment )
   var stat = True;

   file paym ( rt_paym ) write;

   paym.iApplicationKind = iApplicationKind;
   paym.ApplicationKey   = ApplicationKey;
   SetRecordAddr( grdrec, paym, 0, FldOffset( paym, "Payment" ), true );
//   paym.Payment          = Payment;
   grdrec.ground = Payment;

   insert( paym );

   return stat;
end;


macro GetPayMent( iApplicationKind, ApplicationKey, payment )
   var stat = True;

   file paym ( rt_paym ) write;

   paym.iApplicationKind = iApplicationKind;
   paym.ApplicationKey   = ApplicationKey;

   SetRecordAddr( grdrec, paym, 0, FldOffset( paym, "Payment" ), true );

   if( stat = GetEQ( paym ) )
      if( Trim( grdrec.ground ) != "" )
         Setparm( 2, grdrec.ground );
      else
         delete( paym );
         stat = False;
      end;
   end;

   return stat;
end;

macro SetPayMent_Dep( depdoc )
   var Payment = "";

   if( depdoc.Insum != $0 )
      if( depdoc.VidDoc == 1 )
         Payment = "Взнос денежных средств на л/счет № ";
      else
         Payment = "Зачисление денежных средств на л/счет № ";
      end;
   else
      if( depdoc.VidDoc == 1 )
         Payment = "Выдача денежных средств с л/счета № ";
      else
         Payment = "Списание денежных средств с л/счета № ";
      end;
   end;

   Payment = Payment + depdoc.Account;

   InsToPayMent( depdoc.iApplicationKind, depdoc.ApplicationKey, Payment );

   return Payment;
end;

macro SetPayMent_Pay( pay_doc )
   var Payment = "";
   var NumOpert = 0L;
   var CardNumber = "";

   record card_pay ( "pay_doc.n36" );
   file pay_doc_tmp (pay_doc);

   /*
   NumOpert = pay_doc.NumOpert * 1000 + pay_doc.ApplType;
   */

   NumOpert = pay_doc.NumOpert * 1000;

   If(  NumOpert == IN_OUT_SKS )
      if (GetMain_PayDoc(pay_doc.iApplicationKind,pay_doc.ApplicationKey,pay_doc_tmp))
        if (GetVarSize(pay_doc_tmp) >= 0)
          SetRecordAddr( card_pay, pay_doc_tmp, 0, 0, true );
          CardNumber = card_pay.CardNumber;
        end;
      end;
      if( pay_doc.GroupOpert == 11 )
         Payment = "Пополнение СКС по карте № _NKART_";
      else
         Payment = "Выдача c СКС по карте № _NKART_";
      end;
   elif( ( NumOpert == PAY_NO_ACC ) or ( NumOpert == GOOD_NO_ACC) )
      Payment = "Перевод денежных средств без открытия счета";
   elif( NumOpert == PAY_PLATA )
      Payment = "Комиссия за перевод денежных средств без открытия счета";
   else
      Payment = GetNamePAY_DOC( pay_doc, pay_doc.NumOpert, pay_doc.ApplType );
   end;

   Payment = StrSubst( Payment, "_NKART_" , CardNumber );

   InsToPayMent( pay_doc.iApplicationKind, pay_doc.ApplicationKey, Payment );

   return Payment;
end;


macro SetPayMent_Cas( casdoc )
end;


macro SetOsnov
(
  Type, /*
           0 - вклады,   sbdepdoc
           1 - прочие,   pay_doc
           2 - кассовые, sb_casdc
        */
  buff
)
   if  ( Type == 0 )
      return SetOsnov_Dep( buff );
   elif( Type == 1 )
      return SetOsnov_Pay( buff );
   elif( Type == 2 )
      return SetOsnov_Cas( buff );
   end;

end;

// Пропуск кода валютной операции по 117-И.
/*
macro delVO( s )

  var ind = Index( s, "{VO" );
  var r, i;

  if ( ind == 0 )
    r = s;
  else
    i = ind;
    while ( ( SubStr(s,i,1) != "}" )  AND  ( i < 12 ) )
      i = i + 1;
    end;
    if ( i < 11 )
      r = SubStr( s, i + 2 );
    else
      r = SubStr( s, ind + 12 );
    end;
  end;
  return r;
end;
*/

macro SetPayMent
(
  Type, /*
           0 - вклады,   sbdepdoc
           1 - прочие,   pay_doc
           2 - кассовые, sb_casdc
        */
  Type_Acc,  // Тип вида вклада: 1 - текущие, спец.счета, 0 - другие виды.
  buff
)
   var paym;

   if  ( Type == 0 )
      if ( ( Type_Acc == 1 )  AND  ( StrLen( buff.Ground ) > 0 ) )
        return buff.Ground;
        // return delVO( buff.Ground );
      else
        if( GetPayMent( buff.iApplicationKind, buff.ApplicationKey, paym ) )
           return paym;
        else
           return SetPayMent_Dep( buff );
        end;
      end;
   elif( Type == 1 )
      if( GetPayMent( buff.iApplicationKind, buff.ApplicationKey, paym ) )
         return paym;
      else
         return SetPayMent_Pay( buff );
      end;
   elif( Type == 2 )
      if( GetPayMent( buff.ApplicationKind, buff.ApplicationKey, paym ) )
         return paym;
      else
         return SetPayMent_Cas( buff );
      end;
   end;

end;
