/*
  ---------------------
  R-Style SoftWare Lab.
  ---------------------
  RS-Retail

  Список-ордер на ЗАЧИСЛЕНИЕ средств на счета по вкладу (ф.210-с)
  Список-ордер на СПИСАНИЕ   средств со счета по вкладу (ф.245-с)

*/

import CommonInter, BankInter, DeprIntr, rsd, acc_form;

file dtp ( "sb_dtyp.dbt"  ) key 2;        /* Справочник видов вкладов */

file cur ( "currency.dbt" ) key 0;        /* Справочник валют */
var cmdcur = RsdCommand;
var rscur=RsdRecordSet(cmdcur);

//file sop ( "suboper.dbt"  ) key 1;        /* Справочник подопераций */
//var cmdsop = RsdCommand;
//var rssop=RsdRecordSet(cmdsop);

//file dog ( "trn_cntr.dbt" ) key 0;        /* Договора по безнал.платежам */
var cmddog = RsdCommand;
var rsdog = RsdRecordset (cmddog);

//file pay ( "trn_paym.dbt" ) key 0;        /* Платежное поручение по Договору */
var cmdpay = RsdCommand;
var rspay = RsdRecordset (cmdpay);

//file doc ( "trn_doc.dbt"  ) key 0;        /* Документы по безнал.платежам */
var cmddoc1 = RsdCommand;
var rsdoc1 = RsdRecordset(cmddoc1);
var cmddoc2 = RsdCommand;
var rsdoc2 = RsdRecordset(cmddoc2);

file sbd ( "sbdepdoc.dbt" ) key 3;        /* Документы по безнал.платежам */
//var cmdsbd = RsdCommand;
//var rssbd=RsdRecordSet(cmdsbd);

var cmdGetDocs, docsRs;

record PayFil( "trn_payf.dbt" );  /* Расшифровка по филиалу */

var sbd_TypeComplexOper_;

var   sbd_Account_ ;
var   sbd_Rest_ ;
var   sbd_PercOprSum_;
var   sbd_PercRest_ ;

/* Количество строк в листе */
const ListLineNum = 18;

/* Значение поля SignRec файла sb_edref.dbt  */
const SIGNORDER      = 2,
      SIGNPRINTORDER = 3,
      SIGN_NOFOUND   = 4;

const
  OP_OPENCAS =  1,  /* Открытие наличными */
  OP_OPENNCS = 51,  /* Открытие безналичными */
  OP_OPENTRN = 58;  /* Открытие переводом */

/* Значения полей операции ( TypeOper и TypeComplexOper ) */
const
  // "Приходные" операции
  OP_FIND        =     2,  /* Поиск счета */
  OP_INDOP       =     3,  /* Дополнительный взнос */
  OP_PUTCON      =    71,  /* Зачисление по данным последконтроля */
  OP_PUTPR       =    72,  /* Зачисление процентов */
  OP_PUTPAC      =    73,  /* Зачисление в пакетном режиме */
  OP_PUTCOMP     =    74,  /* Зачисление компенсации */
  OP_PAYM_CRED   =    88,  /* Выдача кредита */
  OP_ADD_CARDACC =    95,  /* Пополнение карт.счета при оплате транзакции */
  OP_ADD_FOROVER =    93,  /* Пополнение для погашения овердрафта */
  OP_INCACS      =   999,  /* Подкрепление служ. счета */
  OP_FIX_IN      = 10000,  /* Оставлена для совместимости */
  OP_FIX_PUT     = 10001,  /* Оставлена для совместимости */
  OP_TRN_SMP     =    91;  /* Проводка зачисления */

  // "Расходные" операции
const
  OP_OUT         =     4,  /* Расход */
  OP_GET         =    61,  /* Списание */
  OP_GETCON      =    62,  /* Простое списание */
  OP_GETPOR      =    63,  /* Списание по поручению */
  OP_GETLPR      =    64,  /* Списание по поручению длительному */
  OP_GETOWN      =    66,  /* Списание в свой филиал */
  OP_GETALIEN    =    67,  /* Списание в чужой филиал */
  OP_REPAYM_CRED =    87,  /* Погашение кредита */
  OP_OUTPR       =     6,  /* Выдача процентов */
  OP_CALCPR      =    35,  /* Расчет процентов */
  OP_PCESTIM     =    38,  /* Накопленные проценты */
  OP_GETPCES     =    39,  /* Накопленные проценты */
  OP_CLCAH       =    10,  /* Закрытие счета наличными */
  OP_CLNCAS      =    81,  /* Закрытие счета безналичными */
  OP_PRLDEP      =    82,  /* Пролонгация депозитов */
  OP_PAYTR       =    84,  /* Карточки: Оплата транзакции */
  OP_TRCOMM      =    94,  /* Карточки: Оплата комиссии по транзакции */
  OP_GET_FOROVER =    92,  /* Списание для погашения овердрафта */
  OP_CLSTRN      =    96,  /* Закрытие переводом */
  OP_OTHER       =    40,  /* Прочие операции */
  OP_OUTCASH     =   998,  /* Инкассация служ.счета */
  OP_CLDAY0      =    27,  /* Операция закрытия дня */
  OP_OPNDAY0     =    28,  /* Операция откpытия дня */
  OP_EOY         =   995,  /* Завершение года */
  OP_CASCOM      =     5,  /* Наличная комиссия */
  OP_FCCORR      =    50,  /* Корректировка по данным последконтроля */
  OP_FCEXEC      =    52,  /* Исполнение акта ПК */
  OP_OVERPAY     =    54,  /* Переплата вклада */
  OP_OVERPERC    =    55,  /* Переплата % */
  OP_UNDERPAY    =    56,  /* Недоплата вклада */
  OP_UNDERPERC   =    57,  /* Недоплата % */
  OP_EDITDOC     =    60,  /* Корректировка документа */
  OP_FCQUIT      =    53,  /* Расчет со вкладчиком */
  OP_OVERFIX     =    49,  /* Возмещение переплаты */
  OP_OVERPRFIX   =    79,  /* Возмещение переплаты % */
  OP_UNDERFIX    =    48,  /* Возмещение недоплаты */
  OP_FIX_OUT     = 10002,  /* Расход (п/к) */
  OP_FIX_GET     = 10003,  /* Списание (п/к) */
  OP_UNDRPRFIX   =    69,  /* Возмещение недоплаты % */
  OP_2_ALT       =    85,  /* Перевод вклада в ALT состояние */
  OP_2_DEP       =    86,  /* Перевод вклада в DEP состояние */
  OP_OUTCOMP     =    15,  /* Выдача компенсации */
  OP_CHDTYPE     =    78,  /* Перевод в другой вид вклада */
  OP_COURT_ORDER =    98,  /* Судебные взыскания */
  OP_WILL_GIVE   =    99,  /* Выдача наследства */
  OP_AREST_SET   =   502,  /* Установка ареста */
  OP_AREST_OFF   =   503;  /* Снятие ареста */

const SB_DEPOSIT = 1;

// Виды операций
const
  IN_OPER = 0,    // Приходная
  OUT_OPER = 1,   // Расходная
  XXX_OPER = -1;  // Неопознанная

private var {curdate};
private var {Name_Bank};
private var {CNum};

var flag_Cur = NumFlagCur();
var _FNCash   = NumFNCash();

var nnn, num, numDoc, list;
var saveList = -777;
var AllLists = 0;
var _sFilial;
var saveTypeAcc = "???";
var saveCodCurr  = -1;
var saveTypeOper = -1;
var saveApplType = -1;
var savePaymentID = 0;
var saveFNCash   = -1;
var saveResident = "???";
var DateB = {curdate};
var NameBusines = "";
var TableFlag = FALSE;

var SumI, SumICom;
var SumL, SumLCom;
var StrCount;

var depclnt = TClientList;

var SpecialAccess = GetSpecialAccess(); /*имеет ли операционист спецдоступ к счетам*/
var OperMayListSpecialAccounts = GetShowSpecialAccessAccounts() and GetBankStandart(); /* может ли операционист просматривать спец счета ,не имея спец. доступа*/

private file dep ( "depositr.dbt" ) key 8;

private var ddep  = TRecHandler( "i_dp_dep.rec" );
private var party = TRecHandler( "i_party.rec" );

// =================================
//
// =================================
private macro getOurBankPartyID( pFNCash )
  var vID = 0;
  if ( findDepartment( pFNCash, NULL, ddep, party ) )
    vID = party.rec.PartyID;
  end;
  return vID;
end;

//-------------------------------------------------------------------------------------------------
/* Получение Ф.И.О. клиента */
macro getFIO()
 var fio = "???";
 if ( depclnt.GetRecord( docsRs.value( "doc_codClient" ) ) )
   if(  (not SpecialAccess) and OperMayListSpecialAccounts and docsRs.value( "SpecialAccess" ))
      FIO = "XXXXXX X.X.";
   else
         fio = Trim( depclnt.CurRec.rec.Name1 );      
         if ( StrLen( Trim( depclnt.CurRec.rec.Name2 ) ) > 0 )
         fio = fio + " " + SubStr( depclnt.CurRec.rec.Name2, 1, 1 ) + ".";
         if ( StrLen( Trim( depclnt.CurRec.rec.Name3 ) ) > 0 )
            fio = fio + SubStr( depclnt.CurRec.rec.Name3, 1, 1 ) + ".";
         end;
         end;
      end;
 end;
 return fio;
end;

/**************************************************************************/
/*                Получение полного наименования вида вклада              */
/**************************************************************************/
macro getDepTypeName( _Curr, _Kind )
 var sName = _Kind;
 var cmddtp = RsdCommand;
 var rsdtp = RsdRecordset(cmddtp);

 cmddtp.CmdText=
 " SELECT * FROM  dsb_dtyp_dbt "+
 " WHERE "+
 " t_FlagCur = " + String(_Curr)+" AND "+
 " t_Kind    = '" + String(_Kind) +"'";

//MsgBox("cmddtp.CmdText= "+cmddtp.CmdText);

 cmddtp.execute;

 if ( rsdtp.moveNext  )
   sName = rsdtp.Fld("t_Name").Value;
 end;
 return "\"" + sName + "\"";


/*Old
 var sName = _Kind;
 ClearRecord( dtp );
 dtp.FlagCur = _Curr;
 dtp.Kind    = _Kind;
 if ( getEQ( dtp ) )
   sName = dtp.Name;
 end;
 return "\"" + sName + "\"";
*/
end;

/**************************************************************************/
/*                    Получение названия подоперации                      */
/**************************************************************************/
macro GetSubOpName( IsCurDoc, Kind, OpNum, SubOper )

 var cmdsop = RsdCommand;
 var rssop=RsdRecordSet(cmdsop);

 cmdsop.CmdText=
    " SELECT t_Name  "+
    " FROM dsuboper_dbt  "+
    " WHERE  "+
    " t_IsCur = ?  AND "+
    " t_Kind = ? AND "+
    " t_OperType = ? AND "+
    " t_Type = ? ";

 cmdsop.AddParam("",RSDBP_IN, IsCurDoc);
 cmdsop.AddParam("",RSDBP_IN, Kind);
 cmdsop.AddParam("",RSDBP_IN, OpNum);
 cmdsop.AddParam("",RSDBP_IN, SubOper);

//MsgBox("GetSubOpName:"+String(cmdsop.CmdText));

// rssop.Close(); rssop.Open();
 cmdsop.execute;

 if(rssop.MoveNext)
    return rssop.Fld("t_Name").Value;
 else
    return "";
 end;

 rssop.Close();


/*Old
 Rewind( sop );
 ClearRecord( sop );
 sop.IsCur    = IsCurDoc;
 sop.Kind     = Kind;
 sop.OperType = OpNum;
 sop.Type     = SubOper;
 if ( GetEQ( sop ) )
   return sop.Name;
 else
   return "";
 end;
*/
end;

/**************************************************************************/
/*                       Получение вида зачисления                        */
/**************************************************************************/
macro getApplType( in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper )
 var ttt;
// if ( rsdoc.Fld("t_ApplType").Value >= 0 )
 if ( in_docApplType >= 0 )
   ttt = GetSubOpName( in_docIsCur,        //rsdoc.Fld("t_IsCur").Value,
                       in_docType_Account, //rsdoc.Fld("t_Type_Account").Value,
                       in_docTypeOper,     //rsdoc.Fld("t_TypeOper").Value,
                       in_docApplType);    //rsdoc.Fld("t_ApplType").Value );
   if ( StrLen( ttt ) != 0 )
     ttt = "\"" + ttt + "\"";
   end;
 else
   ttt = "???";
 end;
 return ttt;

/*Old
 var ttt;
 if ( doc.ApplType >= 0 )
   ttt = GetSubOpName( doc.IsCur,
                       doc.Type_Account,
                       doc.TypeOper,
                       doc.ApplType);
   if ( StrLen( ttt ) != 0 )
     ttt = "\"" + ttt + "\"";
   end;
 else
   ttt = "???";
 end;
 return ttt;

*/
end;

/**************************************************************************/
/*                        Получение названия валюты                       */
/**************************************************************************/
macro getISO( in_docCode_Currency )

 var  rscurin = RsdRecordset(cmdcur);

 var sISO = "???";

 if ( in_docCode_Currency == 0 )
   return "руб.";
 end;

 cmdcur.CmdText=
   " SELECT t_Short_Name"+
   " FROM  dcurrency_dbt   "+
   " WHERE  "+
   " t_Code_Currency = ?  ";

 cmdcur.AddParam("",RSDBP_IN, in_docCode_Currency );//rsdoc.Fld("t_Code_Currency").Value);

// rscur.Close(); rscur.Open();
 cmdcur.execute;

 if(rscurin.MoveNext)
    sISO = rscurin.Fld("t_Short_Name").Value;
 end;
 return sISO;

/*Old
 var sISO = "???";
 if ( flag_Cur == 0 )
   return "";
 end;
 ReWind( cur );
 ClearRecord( cur );
 cur.Code_Currency = //rsdoc.Fld("t_Code_Currency").Value;//doc.Code_Currency;
 if ( GetEQ( cur ) )
   sISO = cur.Short_Name;
 end;
 return "(" + sISO + ")";

*/
end;


/****************************************************************************/
/* Найти документ по счету вкладчика, связанный с документом безнал.платежа */
/****************************************************************************/
macro FindSBDepDoc( in_dociApplicationKind, in_docApplicationKey )
/*
 var ret;
 var rssbdin = RsdRecordset(cmdsbd);

 MsgBox("!!!!!!!  ret="+String(ret)+"   rssbdin.RecCount="+String(rssbdin.RecCount));

 sbd_TypeComplexOper_ =0;//инициализация глобального флага промаха

 MsgBox("in_dociApplicationKind="+String(in_dociApplicationKind)+"  in_docApplicationKey="+String(in_docApplicationKey) );

 //Поиск GetEQ
 cmdsbd.CmdText=
    " SELECT * "+
    " FROM dsbdepdoc_dbt "+
    " WHERE  "+
    " t_iApplicationKind = "+String(in_dociApplicationKind)+" AND "+
    " t_ApplicationKey = '"+String(in_docApplicationKey)+"'";
//   " t_iApplicationKind = ? AND "+
//    " t_ApplicationKey = ? ";
// cmdsbd.AddParam("",RSDBP_IN,in_dociApplicationKind);
// cmdsbd.AddParam("",RSDBP_IN,in_docApplicationKey);

// rssbd.Close(); //rssbd.Open();
// rssbdin.Close(); //rssbdin.Open();
 cmdsbd.execute;

 if(rssbd.MoveNext())
    ret= true;
 else
    ret= false;
 end;

//MsgBox("ret="+String(ret)+"   rssbd.RecCount="+String(rssbd.RecCount));
MsgBox("ret="+String(ret)+"   rssbdin.RecCount="+String(rssbdin.RecCount));

 //если запись не найдена
 if ( NOT ret )
   sbd_TypeComplexOper_ = -777; //global var
   println( " Не найден документ в sbdepdoc.dbt (", in_dociApplicationKind, ", ",
                                                    in_docApplicationKey, ")" );
 end;
 return ret;
*/


 var ret;
 sbd_TypeComplexOper_ =0;//инициализация глобального флага промаха
 ReWind( sbd );
 ClearRecord( sbd );
 sbd.iApplicationKind = in_dociApplicationKind;
 sbd.ApplicationKey   = in_docApplicationKey;
 ret = getEQ( sbd );
 if ( NOT ret ) //error
   sbd_TypeComplexOper_ = -777; //global var
   sbd_Account_ = "";
   sbd_Rest_ = 0;
   sbd_PercOprSum_ = 0;
   sbd_PercRest_ = 0;
   //sbd.TypeComplexOper = -777;
   //   println( " Не найден документ в sbdepdoc.dbt (", doc.iApplicationKind, ", ", doc.ApplicationKey, ")" );
 else  //OK
   sbd_Account_ = sbd.Account;
   sbd_Rest_ = sbd.Rest;
   sbd_PercOprSum_ = sbd.PercOprSum;
   sbd_PercRest_ = sbd.PercRest;
   sbd_TypeComplexOper_ = sbd.TypeComplexOper; //global var
 end;

 return ret;


/*Old
 var ret;
 ReWind( sbd );
 ClearRecord( sbd );
 sbd.iApplicationKind = doc.iApplicationKind;
 sbd.ApplicationKey   = doc.ApplicationKey;
 ret = getEQ( sbd );
 if ( NOT ret )
   sbd.TypeComplexOper = -777;
   //   println( " Не найден документ в sbdepdoc.dbt (", doc.iApplicationKind, ", ", doc.ApplicationKey, ")" );
 end;
 return ret;
*/
end;


/**************************************************************************/
/*                   Заголовок списка-ордера ф.N 210-c                    */
/**************************************************************************/
macro Order_title210( in_dogNameBusines ,  in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper,in_docCode_Currency  )
 var sNumPayMess = "";

 if ( ValType( rspay.Fld("T_NUM_PAYMESSAGE").Value ) == V_STRING )
   sNumPayMess = rspay.Fld("T_NUM_PAYMESSAGE").Value;
 else
   sNumPayMess = "";
 end;

 [
    Сбербанк России                                                ф.N 210-c
    #

        Список-ордер на ЗАЧИСЛЕНИЕ средств на счета по вкладу N #####

    Филиал #                                                  #

    Зачисление #

    за период ###########################################   Лист #
                                                            Листов #
    Наименование (шифр) организации #

    Вклад #
    _________________________________________________________________________________________________________________________________________________________
    |    N N   |           Номер           |           Фамилия,            |               |      Остаток       |  Начислен-  |   Остаток   |    Причина    |
    |    п/п   |         лицевого          |             имя,              |     Сумма     |       вклада       |     ные     |  процентов  | незачисления  |
    |          |           счета           |           отчество            |               |                    |   проценты  |             |               |
    +----------+---------------------------+-------------------------------+---------------+--------------------+-------------+-------------+---------------+]
  ( {Name_Bank},
     0,
    _sFilial, //var
    {curdate}:m,
    getApplType(  in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper  ) + " п/п № " + sNumPayMess + " от " + substr(String( DateB ),1,10),
    "с " + String( DateB ) + " по " + String( {curdate} ),
    list, //var
    AllLists, //var
    "\"" + in_dogNameBusines + "\"",   // var      /* Договора по безнал.платежам */
//    "\"" + dog.NameBusines + "\"",   //"trn_cntr.dbt" ) key 0;        /* Договора по безнал.платежам */
//    "\"" + in_docType_Account + "\"" + getISO(in_docCode_Currency)   //record PayFil( "trn_payf.dbt" );  /* Расшифровка по филиалу */  getISO( in_docCode_Currency )
    getDepTypeName( in_docCode_Currency, in_docType_Account )

  );
  TableFlag = TRUE;
end;

/**************************************************************************/
/*                   Заголовок списка-ордера ф.N 245-c                    */
/**************************************************************************/
macro Order_title245( in_dogNameBusines ,  in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper,in_docCode_Currency )
 [
    Сбербанк России                                                ф.N 245-c
    #

        Список-ордер на СПИСАНИЕ средств со счетов по вкладу N ___________

    Филиал #                                                  #

    Списание #

    за период ###########################################   Лист #
                                                            Листов #
    Наименование (шифр) организации #

    Вклад #
    _________________________________________________________________________________________________________________________________________________________
    |    N N   |           Номер           |           Фамилия,            |               |      Остаток       |  Отчислен-  |   Остаток   |    Причина    |
    |    п/п   |         лицевого          |             имя,              |     Сумма     |       вклада       |     ные     |  процентов  |  невыполнения |
    |          |           счета           |           отчество            |               |                    |   проценты  |             |    списания   |
    +----------+---------------------------+-------------------------------+---------------+--------------------+-------------+-------------+---------------+]
  ( {Name_Bank},
    _sFilial,
    {curdate}:m,
    getApplType(  in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper  ),
    "с " + String( DateB ) + " по " + String( {curdate} ),
    list,
    AllLists,
    "\"" + in_dogNameBusines + "\"",  // var
//    "\"" + dog.NameBusines + "\"",
//    "\"" + in_docType_Account + "\"" + getISO(in_docCode_Currency)
    getDepTypeName( in_docCode_Currency, in_docType_Account )
  );
  TableFlag = TRUE;
end;

/**************************************************************************/
/*            Заголовок списка-ордера для неопознанных операций           */
/**************************************************************************/
macro Order_titleXXX( in_dogNameBusines,  in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper, in_docCode_Currency )
 [
    Сбербанк России                                                ф.N XXX-c
    #

        Список-ордер на ДВИЖЕНИЕ средств по счетам по вкладу N #####

    Филиал #                                                  #

    Операция #

    за период ###########################################   Лист #
                                                            Листов #
    Наименование (шифр) организации #

    Вклад #

    _________________________________________________________________________________________________________________________________________________________
    |    N N   |           Номер           |           Фамилия,            |               |      Остаток       |   Проценты  |   Остаток   |    Причина    |
    |    п/п   |         лицевого          |             имя,              |     Сумма     |       вклада       |             |  процентов  |  невыполнения |
    |          |           счета           |           отчество            |               |                    |             |             |    операции   |
    +----------+---------------------------+-------------------------------+---------------+--------------------+-------------+-------------+---------------+]
  ( {Name_Bank},
    0,
    _sFilial,
    {curdate}:m,
    getApplType(  in_docApplType ,in_docIsCur, in_docType_Account, in_docTypeOper  ) + " п/п № " + rspay.Fld("T_NUM_PAYMESSAGE").Value + " от " + substr(String( DateB ),1,10),
    "с " + substr(String( DateB ),1,10) + " по " + String( {curdate} ),
    saveList,
    AllLists,
    "\"" + in_dogNameBusines + "\"", // var
//    "\"" + dog.NameBusines + "\"",
//    "\"" + PayFil.Type_Account + "\"" + getISO(in_docCode_Currency)
    getDepTypeName( in_docCode_Currency, PayFil.Type_Account )
  );
  TableFlag = TRUE;
end;

//---------------------------------------------------------------------------------------------------------------------
/*  Заголовок протокола */
macro Protocol_Title()

  [
           Протокол сумм зачислений на карточные счета, не зачисленных на карты.

    #
    Дата зачисления #


                                                            Лист #####
                                                            Листов #####
    Зачислено на карточный счет, но не зачислено на карту:
    Вид вклада #
   +-----+-------------------------+-------------------------------+-----------+---------------+
   | N N |    Номер счета          |           Фамилия,            |  Сумма    |     Причина   |
   | п/п |        СКС              |        имя, отчество          |           |  незачисления |
   +-----+-------------------------+-------------------------------+-----------+---------------+]
     ( {Name_Bank},
      /*sFilial,*/
      {curdate},
      list:l,
      AllLists:l,
      "\"" + saveTypeAcc + "\" " + " Валюта вклада " + String(docsRs.value( "ExternalCode" ))
      );
end;

//---------------------------------------------------------------------------------------------------------------------
/*  Закрытие листа протокола */
macro Protocol_Table()
   var total = "Итого: не зачислены суммы на карты по вкладу \"" + saveTypeAcc +"\" общей суммой "+ 
                                          String(SumI)+" на субсчета "+String(StrCount) + " карт";
   if(StrCount == 1)
      total = total + "ы";
   end;

   [+-----+-------------------------+-------------------------------+-----------+---------------+
     
      #
      
      Требуется выполнить распределение нераспределенной части счета СКС в размере зачисленной суммы]
//      Итого: не зачислены суммы на карты по вкладу # общей суммой - ############ на субсчета карты]
//  ( saveTypeAcc, SumI:12:2 );
    (total);
end;

//---------------------------------------------------------------------------------------------------------------------
/*  Строка протокола */
macro ProtocolString( sum )
  [|#####|#########################|###############################|########## |               |]
  ( num:5,
    docsRs.value( "doc_account" ):25,
    getFIO():31,
    sum:10:2);
    SumI = SumI + sum;
    StrCount = StrCount + 1;
end;

/**************************************************************************/
/*                             Строка ордера                              */
/**************************************************************************/
macro OrderString(
                     in_num,
                     in_sbd_Account,
                     in_doc_Sname,
                     in_doc_Nname,
                     in_doc_Pname,
                     in_doc_Sum,
                     in_sbd_Rest,
                     in_sbd_PercOprSum,
                     in_sbd_PercRest
                 )
//  [  | ### | ######################### | ############################# | ########### | ################ | ######### | ######### |               |]
  [  | ######## | ######################### | ############################# | ############# | ################## | ########### | ########### |               |]
  ( in_num:8,                               //num:3,
    Acc_Form(in_sbd_Account):25,                      //sbd.Account:25,
    in_doc_Sname + " " +                    //doc.Sname + " " +
      SubStr( in_doc_Nname, 1, 1 ) + "." +
      SubStr( in_doc_Pname, 1, 1 ) + ".",
    in_doc_Sum:a:12:2,                      //doc.Sum:a:2:10,
    in_sbd_Rest:a:18:2,                     //sbd.Rest:a:2:16,
    in_sbd_PercOprSum:a:11:2,                //sbd.PercOprSum:a:2:9,
    in_sbd_PercRest:a:11:2 );                //sbd.PercRest:a:2:9 );
    SumL = SumL + in_doc_Sum;               //SumL = SumL + doc.Sum;
end;//macro

/**************************************************************************/
/*                         Закрытие листа ордера                          */
/**************************************************************************/
macro Order_Table()
  [  +----------+---------------------------+-------------------------------+---------------+--------------------+-------------+-------------+---------------+
                                                           Итого по листу:  | ############# |
                                                                            +---------------+
                                                          Итого по списку:  | ############# |
                                                                            +---------------+]
  ( SumI:a:12:2, SumICom:a:12:2 );

end;

/**************************************************************************/
/*                        Закрытие списка ордеров                         */
/**************************************************************************/
macro Order_Table_List()
  [
                    Всего листов: ####################
       Итого зачислено по листам: ####################]
  ( AllLists:20, SumLCom:a:20:2 );

end;

/*****************************************************************
                Получение корреспондирующих счетов.
******************************************************************/
macro GetCorrAccount( _DbCr, _Curr, _Kind, _TypeOper, _ApplType, _Branch, _Resident )
  return " ";
end;

/*macro Order_Table()
  [  +-----+---------------------------+-------------------------------+-------------+------------------+-----------+-----------+---------------+
                                                      Итого по листу:  | ########### |
                                                                       +-------------+
                                                     Итого по списку:  | ########### |
                                                                       +-------------+
                                            Итого зачислено по листу:  | ########### |
                                                                       +-------------+
                                           Итого зачислено по списку:  | ########### |
                                                                       +-------------+]
  ( SumI:a:2:10, SumICom:a:2:10, SumL:a:2:10, SumLCom:a:2:10 );

end;
*/
/**************************************************************************/
/*                              Подвал ордера                             */
/**************************************************************************/
macro Order_end( _Curr, _Kind, _TypeOper, _ApplType, _OperType, _PaymentID, _Branch, _Resident )

  var AccFromPP = "";  /* Счет, определяемый из платежного поручения */
  var cmdpm = RsdCommand;
  var rspm  = RsdRecordset( cmdpm );
  var rs, IsCreditPaym;
  var accDebet = "";
  var accCredit = "";

  /* Номера в T_DOCKIND для платежа из АРМ Позиционера */
  const ARM_POS1 = 320;
  const ARM_POS2 = 322;


  /* Определение счетов дебета и кредита */
  if ( (_OperType == IN_OPER) OR (_OperType == OUT_OPER) )

    if ( _PaymentID == 0 )

      if ( StrLen( Trim( rsdog.Fld("t_CorAcc_Busines").Value ) ) > 1 )
        AccFromPP = rsdog.Fld("t_CorAcc_Busines").Value;
      elif ( StrLen( Trim( rsdog.Fld("t_Account_Busines").Value ) ) > 1 )
        AccFromPP = rsdog.Fld("t_Account_Busines").Value;
      else
        AccFromPP = "";
      end;

    else
      rs = RsdRecordset( string("select pmprop.t_IsSender, pmprop.t_DebetCredit from dpmprop_dbt pmprop where ",
                            "pmprop.t_PaymentID = ", _PaymentID ) );

      IsCreditPaym = false;
      if ( rs.MoveNext() )
         if ( rs.value(0)!="X" )
            if ( rs.value(1)==1 )
               IsCreditPaym = true;
            end;
         else
            if ( rs.value(1)==0 )
               IsCreditPaym = true;
            end;
         end;
      else
         IsCreditPaym = true;
      end;

      cmdpm.CmdText = " SELECT t_futurePayerAccount, t_futureReceiverAccount FROM dpmpaym_dbt WHERE t_PaymentID = " +
                         String( _PaymentID );
      cmdpm.execute;
      if ( rspm.moveNext )
        if ( IsCreditPaym )
           AccFromPP = rspm.Value(0);
        else
           AccFromPP = rspm.Value(1);
        end;
      end;
    end;

    if ( _OperType == IN_OPER )
      accDebet = AccFromPP;
      accCredit = GetCorrAccount( FALSE, _Curr, _Kind, _TypeOper, _ApplType, _Branch, _Resident );
    else
      accDebet  = GetCorrAccount( TRUE,  _Curr, _Kind, _TypeOper, _ApplType, _Branch, _Resident );
      accCredit = AccFromPP;
    end;

  else

    accDebet  = GetCorrAccount( TRUE,  _Curr, _Kind, _TypeOper, _ApplType, _Branch, _Resident );
    accCredit = GetCorrAccount( FALSE, _Curr, _Kind, _TypeOper, _ApplType, _Branch, _Resident );

  end;

  [


     Проверено [                 ] ______________________________
                                              (подпись)
     __________________________________________________________________________________________
          Отметки бухгалтерии:                        |       Отметки филиала:
                                                      |
      Дебет счета  N ##############################   |  Проведено по операционному дневнику
                                                      |
      Кредит счета N ##############################   |        "___"_________________ 200__г.
                                                      |
      Бухгалтер __________________                    |  Контролер ________________________
                    (подпись)                         |                    (подпись)

  ]
  ( Acc_Form(accDebet):f, Acc_form(accCredit):f );
  printLn( strFor( 12 ) );
end;

/*macro Order_end()
  [


     Проверено [                 ] ______________________________
                                              (подпись)
     ________________________________________________________________________
          Отметки бухгалтерии:       |       Отметки филиала:
                                     |
      Дебет счета N_______________   |  Проведено по операционному дневнику
                                     |
      Кредит счета N______________   |        "___"_________________ 200__г.
                                     |
      Бухгалтер __________________   |  Контролер ________________________
                    (подпись)        |                    (подпись)


   _____________________________________________________________________________________


  ];
end;
*/

/*************************************************************************/
/*      Проверить строку на null                                         */
/*************************************************************************/
macro CheckString(str)
  if (str == StrFor(1))
    return "..";
  else
    return str;
  end;
end;
// *******************************************************************

macro ReadFNCash
//
// Чтение записи о Подразделении
//
  if ( not findDepartment( _FNCash, _sFilial ) )
    _sFilial = "???";
  end;
end;

/**************************************************************************/
/*                            Головная процедура                          */
/**************************************************************************/
macro Order( Addr, PaymentID, Branch )  /* Если Branch задан, то ордер печатается только по
                                           подразделению с FNcash = Branch */
 var line_num;
 var stat;
 var cmd, rs;
 var OperType = XXX_OPER;
 var isDebet = TRUE;
 var commonSum = $0;

 if ( Branch == 0 )
   Branch = -1;
 end;

 //MsgBox("Addr="+String(Addr));

  SetBuff( PayFil, Addr );   /*Второй параметр,
 представляющий собой переменную с типом, соответствующим
 константе V_MEMADDR, должен содержать адрес памяти, переданный из
 программы на языке C.*/


 //------------------------------------
 if (PaymentID == 0)
   _FNCash = PayFil.FNCash;
    
  /* Чтение записи о Подразделении */
   if (not findDepartment(_FNCash, _sFilial) )
     _sFilial = "???";
   end;
 elif ( PayFil.NumberContract == "" )
   ClearRecord (PayFil);
 end;

 if ( Branch != -1 )
   _FNCash = Branch;
 end;
  
 ReadFNCash ();

 /* Old
 Rewind( fil );
 ClearRecord( fil );
 fil.FNCash = _FNCash;
 if ( GetEQ( fil ) )
   _sFilial = fil.NameBranch;
 else
   _sFilial = "???";
 end;
 */

 /* Чтение записи о договоре */
 cmddog.CmdText="SELECT * FROM dtrn_cntr_dbt WHERE t_NumberContract='"+String(PayFil.NumberContract)+"'";
// MsgBox("SELECT * FROM dtrn_cntr_dbt WHERE t_NumberContract='"+String(PayFil.NumberContract)+"'" );
// rsdog.Close(); rsdog.Open();
 cmddog.execute;
 if(rsdog.moveNext)
   DateB = rsdog.Fld("t_DateContract").Value;       /* Дата ввода Договора */
   NameBusines = rsdog.Fld("t_NameBusines").Value;
 end;

 /*Old
 Rewind( dog );
 ClearRecord( dog );
 dog.NumberContract = PayFil.NumberContract;
 if ( GetEQ( dog ) )
   DateB = dog.DateContract;       // Дата ввода Договора
 end;
 */



 /* Чтение записи о платежном поручении по договору */
 cmdpay.CmdText=
   " SELECT * FROM dtrn_paym_dbt WHERE "+
//   " t_NumberContract = '" + String( PayFil.NumberContract )+"' AND "+
//   " t_Num_PayMessage = "  + String( PayFil.Num_PayMessage );
   " t_iApplicationKind = " + String(  PayFil.PaymAppKind )+" AND "+
   " t_ApplicationKey = '" + String( PayFil.PaymAppKey ) + "'";


//   " t_NumberContract = ? AND "+
//   " t_Num_PayMessage = ? ";
// cmdpay.Value("t_NumberContract")=PayFil.NumberContract;
// cmdpay.Value("t_Num_PayMessage")=PayFil.Num_PayMessage;
 cmdpay.execute;
 if(rspay.moveNext)
    DateB = rspay.Fld("t_DateInputDocument").Value;
    //MsgBox("2 DateB="+String(DateB));
 end;

 /*Old
 Rewind( pay );
 ClearRecord( pay );
 pay.NumberContract = PayFil.NumberContract;
 pay.Num_PayMessage = PayFil.Num_PayMessage;
 if ( GetEQ( pay ) )
   DateB = pay.DateInputDocument;  /* Дата ввода платежного поручения */
 end;
 */

 /*** Первый проход. Подсчет общих сумм и числа листов ***/
 /*
 num = 1;
 list = 0;
 AllLists = 0;
 SumI = $0;
 SumICom = $0;
 SumL = $0;
 SumLCom = $0;

 if (PaymentID == 0)
    cmddoc1.CmdText=
     " SELECT d.*, p.t_notresident, s.t_type_account realtype_acc "
     " from dtrn_doc_dbt d, dparty_dbt p, dsbdepdoc_dbt s where "
     " d.t_FNCash       =  "+ String(_FNCash)+" and "+
     " d.t_ListTransfer = " + String(PayFil.AutoKey) + " and "
     " d.T_CODCLIENT = p.T_PARTYID and "
     " d.T_IAPPLICATIONKIND = s.T_IAPPLICATIONKIND and "
     " d.T_APPLICATIONKEY = s.T_APPLICATIONKEY " 
     " ORDER BY realtype_acc, p.t_notresident "
 else
   if ( Branch != -1 )
   cmddoc1.CmdText=
     " SELECT d.*, p.t_notresident, s.t_type_account realtype_acc "
     " from dtrn_doc_dbt d, dparty_dbt p, dsbdepdoc_dbt s where "
     " d.t_FNCash       = "+ String(_FNCash)+" and "+
     " d.t_PaymentID  = " + String(PaymentID) +
     " and d.T_CODCLIENT = p.T_PARTYID and "
     " d.T_IAPPLICATIONKIND = s.T_IAPPLICATIONKIND and "
     " d.T_APPLICATIONKEY = s.T_APPLICATIONKEY " 
     " ORDER BY d.t_FNCash, realtype_acc, p.t_notresident";
  else
   cmddoc1.CmdText=
     " SELECT d.*, p.t_notresident, s.t_type_account realtype_acc "
     " from dtrn_doc_dbt d, dparty_dbt p, dsbdepdoc_dbt s where "
     " d.t_PaymentID  = " + String(PaymentID) +
     " and d.T_CODCLIENT = p.T_PARTYID and "
     " d.T_IAPPLICATIONKIND = s.T_IAPPLICATIONKIND and "
     " d.T_APPLICATIONKEY = s.T_APPLICATIONKEY " 
     " ORDER BY d.t_FNCash, realtype_acc, p.t_notresident";
  end;
 end;

 cmddoc1.execute;
 */

 /*Old
 Rewind( doc );
 ClearRecord( doc );
 doc.FNCash       = _FNCash;
 doc.ListTransfer = PayFil.AutoKey;
 stat = GetGE( doc );
 */

 /*
 InitProgress(  rsdoc1.RecCount ,
               " Идет перебор документов по безналичным перечислениям. Ждите..."
               "Подсчет общих сумм" );

 while ( rsdoc1.moveNext )
   FindSBDepDoc( rsdoc1.Fld("t_iApplicationKind").Value , rsdoc1.Fld("t_ApplicationKey").Value );
   if ( ( ( sbd_TypeComplexOper_ != -777 )  AND
        ( sbd_TypeComplexOper_ != OP_OPENNCS ) )  OR //( rssbd.Fld("t_TypeComplexOper").Value != OP_OPENNCS ) )  OR
        ( ( sbd_TypeComplexOper_ == -777 )  AND
          ( rsdoc1.Fld("t_Referenc").Value != 0 ) ) )
     SumICom = SumICom + rsdoc1.Fld("t_Sum").Value;
     if ( ( saveTypeAcc  != rsdoc1.Fld( "realtype_acc" ).Value )   OR
          ( saveCodCurr  != rsdoc1.Fld( "t_code_currency" ).Value )  OR
          ( saveTypeOper != rsdoc1.Fld( "t_typeoper" ).Value )       OR
          ( saveApplType != rsdoc1.Fld( "t_appltype" ).Value )       OR
          ( saveFNCash   != rsdoc1.Fld( "t_fncash"   ).Value )       OR
          ( saveResident != rsdoc1.Fld( "t_notresident"   ).Value ) )
       saveTypeAcc  = rsdoc1.Fld( "realtype_acc" ).Value;
       saveCodCurr  = rsdoc1.Fld( "t_code_currency" ).Value;
       saveTypeOper = rsdoc1.Fld( "t_typeoper" ).Value;
       saveApplType = rsdoc1.Fld( "t_appltype" ).Value;
       saveFNCash   = rsdoc1.Fld( "t_fncash"   ).Value;
       saveResident = rsdoc1.Fld( "t_notresident" ).Value;
       AllLists = AllLists + 1;
     end;
     if ( rsdoc1.Fld("t_Status").Value == "X" )
       SumLCom  = SumLCom + rsdoc1.Fld("t_Sum").Value;
     end;
     num = num + 1;
     UseProgress( num );
   end;
 end;
 RemProgress();
 */

 /*Old
 InitProgress( Nrecords( doc ),
               " Идет перебор документов по безналичным перечислениям. Ждите..."
               "Подсчет общих сумм" );

 while ( stat                                    AND
         ( doc.FNCash       == _FNCash         )  AND
         ( doc.ListTransfer == PayFil.AutoKey ) )
   FindSBDepDoc();
   if ( ( ( sbd.TypeComplexOper != -777 )  AND
          ( sbd.TypeComplexOper != OP_OPENNCS ) )  OR
        ( ( sbd.TypeComplexOper == -777 )  AND
          ( doc.Referenc != 0 ) ) )
     SumICom = SumICom + doc.Sum;
     if ( saveList != doc.NList )
       saveList = doc.NList;
       AllLists = AllLists + 1;
     end;
     if ( doc.Status == "X" )
       SumLCom  = SumLCom + doc.Sum;
     end;
     num = num + 1;
     UseProgress( num );
   end;
   stat = Next( doc );
 end;
 RemProgress();
 */

 if ( SumICom == $0 )
   PrintLn( "\n\n  Документов зачислений на ранее открытые счета не найдено" );
   Exit(0);
 end;

 /*** Основной цикл. Выпуск ордеров на зачисление ***/
 num = 1;
 numDoc = num;
 list = 0;
 SumI = $0;
 saveTypeAcc  = "";
 saveCodCurr  = -1;
 saveTypeOper = -1;
 saveApplType = -1;
 saveFNCash   = -1;
 saveResident = "???";

 /* SumICom = $0; */

/*
 if (PaymentID == 0)
    cmddoc2.CmdText=
     " SELECT d.*, p.t_notresident, s.t_type_account realtype_acc, "
     "  s.T_ACCOUNT as rAcc, " +
     "  s.T_Code_Currency as rCurr, " +
     "  s.T_CODCLIENT as rClient, " +
     "  s.T_INSUM as rInSum, " +
     "  s.T_OUTSUM as rOutSum, " +
     "  s.T_Referenc as rRef, " +
     "  s.T_Date_Document as rDateDoc, " +
     "  s.T_NumDayDoc as rNumDayDoc, " +
     "  s.T_Type_Account as rKind, " +
     "  s.T_TypeOper as rTypeOper, " +
     "  s.T_ApplType as rApplType " +
     " from dtrn_doc_dbt d, dparty_dbt p, dsbdepdoc_dbt s where "
     " d.t_FNCash       =  "+ String(_FNCash)+" and "+
     " d.t_ListTransfer = " + String(PayFil.AutoKey) + " and "
     " d.T_CODCLIENT = p.T_PARTYID and "
     " d.T_IAPPLICATIONKIND = s.T_IAPPLICATIONKIND and "
     " d.T_APPLICATIONKEY = s.T_APPLICATIONKEY " 
     " ORDER BY realtype_acc, p.t_notresident "
 else
   if ( Branch != -1 )
   cmddoc2.CmdText=
     " SELECT d.*, p.t_notresident, s.t_type_account realtype_acc, "
     "  s.T_ACCOUNT as rAcc, " +
     "  s.T_Code_Currency as rCurr, " +
     "  s.T_CODCLIENT as rClient, " +
     "  s.T_INSUM as rInSum, " +
     "  s.T_OUTSUM as rOutSum, " +
     "  s.T_Referenc as rRef, " +
     "  s.T_Date_Document as rDateDoc, " +
     "  s.T_NumDayDoc as rNumDayDoc, " +
     "  s.T_Type_Account as rKind, " +
     "  s.T_TypeOper as rTypeOper, " +
     "  s.T_ApplType as rApplType " +
     " from dtrn_doc_dbt d, dparty_dbt p, dsbdepdoc_dbt s where "
     " d.t_FNCash       = "+ String(_FNCash)+" and "+
     " d.t_PaymentID  = " + String(PaymentID) +
     " and d.T_CODCLIENT = p.T_PARTYID and "
     " d.T_IAPPLICATIONKIND = s.T_IAPPLICATIONKIND and "
     " d.T_APPLICATIONKEY = s.T_APPLICATIONKEY " 
     " ORDER BY d.t_FNCash, realtype_acc, p.t_notresident";
  else
   cmddoc2.CmdText=
     " SELECT d.*, p.t_notresident, s.t_type_account realtype_acc, "
     "  s.T_ACCOUNT as rAcc, " +
     "  s.T_Code_Currency as rCurr, " +
     "  s.T_CODCLIENT as rClient, " +
     "  s.T_INSUM as rInSum, " +
     "  s.T_OUTSUM as rOutSum, " +
     "  s.T_Referenc as rRef, " +
     "  s.T_Date_Document as rDateDoc, " +
     "  s.T_NumDayDoc as rNumDayDoc, " +
     "  s.T_Type_Account as rKind, " +
     "  s.T_TypeOper as rTypeOper, " +
     "  s.T_ApplType as rApplType " +
     " from dtrn_doc_dbt d, dparty_dbt p, dsbdepdoc_dbt s where "
     " d.t_PaymentID  = " + String(PaymentID) +
     " and d.T_CODCLIENT = p.T_PARTYID and "
     " d.T_IAPPLICATIONKIND = s.T_IAPPLICATIONKIND and "
     " d.T_APPLICATIONKEY = s.T_APPLICATIONKEY " 
     " ORDER BY d.t_FNCash, realtype_acc, p.t_notresident";
  end;
 end;

 cmddoc2.execute;
 rsdoc2.Move(0,0);
*/

/*Old
 Rewind( doc );
 ClearRecord( doc );
 doc.FNCash       = _FNCash;
 doc.ListTransfer = PayFil.AutoKey;
 stat = GetGE( doc );
*/

 /*
 InitProgress( numDoc,
               " Идет перебор документов по безналичным перечислениям. Ждите..."
               "Формирование ордеров на зачисление средств" );

 while ( rsdoc2.moveNext )
   FindSBDepDoc( rsdoc2.Fld("t_iApplicationKind").Value , rsdoc2.Fld("t_ApplicationKey").Value );
   if ( ( ( sbd_TypeComplexOper_ != -777 )  AND
          ( sbd_TypeComplexOper_ != OP_OPENNCS ) )  OR //( rssbd.Fld("t_TypeComplexOper").Value != OP_OPENNCS ) )  OR
        ( ( sbd_TypeComplexOper_ == -777 )  AND
          ( rsdoc2.Fld("t_Referenc").Value != 0 ) ) )

     if ( ( saveTypeAcc  != rsdoc2.Fld( "realtype_acc" ).Value )     OR
          ( saveCodCurr  != rsdoc2.Fld( "t_code_currency" ).Value )  OR
          ( saveTypeOper != rsdoc2.Fld( "t_typeoper" ).Value )       OR
          ( saveApplType != rsdoc2.Fld( "t_appltype" ).Value )       OR
          ( saveFNCash   != rsdoc2.Fld( "t_fncash"  ).Value )        OR
          ( saveResident != rsdoc2.Fld( "t_notresident" ).Value ) )
       list = list + 1;
       num = 1;
       if (_FNCash != rsdoc2.Fld("t_fncash").Value)
         _FNCash = rsdoc2.Fld("t_fncash").Value;
         ReadFNCash();
       end;
       if ( ( saveTypeAcc  != "" )  AND
            ( saveCodCurr  != -1 )  AND
            ( saveTypeOper != -1 )  AND
            ( saveApplType != -1 )  AND
            ( saveFNCash   != -1 )  AND
            ( saveResident != "???" ) )
         Order_Table();
         Order_end( saveCodCurr, saveTypeAcc, saveTypeOper, saveApplType, OperType, savePaymentID, saveFNCash, saveResident );
       end;

       saveTypeAcc   = rsdoc2.Fld( "realtype_acc" ).Value;
       saveCodCurr   = rsdoc2.Fld( "t_code_currency" ).Value;
       saveTypeOper  = rsdoc2.Fld( "t_typeoper" ).Value;
       saveApplType  = rsdoc2.Fld( "t_appltype" ).Value;
       savePaymentID = rsdoc2.Fld( "t_PaymentID" ).Value;
       saveFNCash    = rsdoc2.Fld( "t_fncash"    ).Value;
       saveResident  = rsdoc2.Fld( "t_notresident"    ).Value;
       SumI = $0;
       SumL = $0;

       if   ( ( rsdoc2.Fld("t_TypeOper").Value == OP_PUTPAC      )  OR  /* "Приходные" операции */
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OPENCAS     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OPENNCS     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OPENTRN     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FIND        )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_INDOP       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PUTCON      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PUTPR       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PUTPAC      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PUTCOMP     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PAYM_CRED   )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_ADD_CARDACC )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_ADD_FOROVER )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_INCACS      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FIX_IN      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FIX_PUT     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_TRN_SMP     ) )
         Order_title210(
                  NameBusines ,
                  rsdoc2.FLd("t_ApplType").Value ,
                  rsdoc2.Fld("t_IsCur").Value,
                  rsdoc2.Fld("realtype_acc").Value,
                  rsdoc2.Fld("t_TypeOper").Value,
                  rsdoc2.Fld("t_Code_Currency").Value );  /* Зачисление */
         OperType = IN_OPER;
       elif ( ( rsdoc2.Fld("t_TypeOper").Value == OP_OUT         )  OR  /* "Расходные" операции */
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GET         )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GETCON      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GETPOR      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GETLPR      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GETOWN      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GETALIEN    )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_REPAYM_CRED )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OUTPR       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CALCPR      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PCESTIM     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GETPCES     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CLCAH       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CLNCAS      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PRLDEP      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_PAYTR       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_TRCOMM      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_GET_FOROVER )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CLSTRN      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OTHER       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OUTCASH     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CLDAY0      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OPNDAY0     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_EOY         )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CASCOM      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FCCORR      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FCEXEC      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OVERPAY     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OVERPERC    )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_UNDERPAY    )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_UNDERPERC   )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_EDITDOC     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FCQUIT      )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OVERFIX     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OVERPRFIX   )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_UNDERFIX    )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FIX_OUT     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_FIX_GET     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_UNDRPRFIX   )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_2_ALT       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_2_DEP       )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_OUTCOMP     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_CHDTYPE     )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_COURT_ORDER )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_WILL_GIVE   )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_AREST_SET   )  OR
              ( rsdoc2.Fld("t_TypeOper").Value == OP_AREST_OFF   ) )
         Order_title245( NameBusines ,  rsdoc2.FLd("t_ApplType").Value , rsdoc2.Fld("t_IsCur").Value, rsdoc2.Fld("realtype_acc").Value, rsdoc2.Fld("t_TypeOper").Value, rsdoc2.Fld("t_Code_Currency").Value );  /* Списание */
         OperType = OUT_OPER;
       else
         Order_titleXXX( NameBusines ,  rsdoc2.FLd("t_ApplType").Value , rsdoc2.Fld("t_IsCur").Value, rsdoc2.Fld("realtype_acc").Value, rsdoc2.Fld("t_TypeOper").Value, rsdoc2.Fld("t_Code_Currency").Value );  /* Заголовок для неопознанных операций */
         OperType = XXX_OPER;
       end;
     end;
     SumI = SumI + rsdoc2.Fld("t_Sum").Value;
     if ( rsdoc2.Fld("t_Status").Value == "X" )
       OrderString(
           num,
           Acc_Form(sbd_Account_),      //rssbd.Fld("t_Account").Value,
           rsdoc2.Fld("t_Sname").Value,
           rsdoc2.Fld("t_Nname").Value,
           rsdoc2.Fld("t_Pname").Value,
           rsdoc2.Fld("t_Sum").Value,
           sbd_Rest_,         //rssbd.Fld("t_Rest").Value,
           sbd_PercOprSum_,   //rssbd.Fld("t_PercOprSum").Value,
           sbd_PercRest_      //rssbd.Fld("t_PercRest").Value
       );
     end;
     num = num + 1;
     UseProgress( num );
   end;
 end;
 RemProgress();
 */

 /*
 if ( TableFlag )
   Order_Table();
   Order_end( rsdoc2.Fld("t_Code_Currency").Value,
    rsdoc2.Fld("realtype_acc").Value,
          rsdoc2.Fld("t_TypeOper").Value,
          rsdoc2.Fld("t_ApplType").Value,
              OperType,
              rsdoc2.Fld("t_PaymentID").Value,
              rsdoc2.Fld("t_FNcash").Value, 
              rsdoc2.Fld("t_notresident").Value );
    Order_Table_List();
 end;
 */

 /*** Отчет по проведенным ***/

 list = 0;
 num = 1;

 /*
 cmd = RsdCommand( "select d.t_account, "
                   " (select t_sname "
                   " from dtrn_doc_dbt t "
                   " where e.t_accnumber = t.t_referenc "
                   "  and rownum = 1), "
                   " e.t_errcode, m.t_contents "
                   "from dsb_edref_tmp e "
                   "left outer join ddepositr_dbt d "
                   "  on d.t_referenc = e.t_accnumber "
                   "left outer join dsbbank_msg m "
                   "  on e.t_errcode = m.t_number "
                   "where nvl(e.t_errcode, 0) <> 0 "
                   );
 */

 /*                  
 cmd = RsdCommand( "select t.t_account, "  // 0
                         " t.t_Sname, "    // 1
                         " t.t_Nname, "    // 2
                         " t.t_Pname, "    // 3
                         " e.t_errcode, "  // 4
                         " m.t_contents "  // 5
                   "from dsb_edref_tmp e "
                   "left outer join dtrn_doc_dbt t "
                   "  on t.t_iApplicationKind = e.t_ApplicationKind "
                   " and t.t_ApplicationKey = e.t_ApplicationKey "
                   "left outer join dsbbank_msg m "
                   "  on m.t_number = e.t_errcode "
                   "where nvl(e.t_errcode, 0) <> ? " );
 */

 if ( ( PayFil.AutoKey != 0 ) and ( paymentid == 0 ) )
   cmd = RsdCommand( "select count(t.t_autokey), "  // 0
                           " sum(t.t_Sum) "         // 1
                     "from dtrn_doc_dbt t "
                     "where ( t.t_fncash = ? and t.t_ListTransfer = ? ) and " 
                           "t.t_errorcode = 0 and  "
                           "t.t_status = \'X\'" ); 

   cmd.addParam( "branch", RSDBP_IN, PayFil.FNCash );
   cmd.addParam( "lt", RSDBP_IN, PayFil.AutoKey);
 elif ( ( PayFil.AutoKey == 0 ) and ( paymentid != 0 ) )
   cmd = RsdCommand( "select count(t.t_autokey), "  // 0
                           " sum(t.t_Sum) "         // 1
                     "from dtrn_doc_dbt t "
                     "where t.t_paymentid = ? and " 
                           "t.t_errorcode = 0 and  "
                           "t.t_status = \'X\'" ); 

   cmd.addParam( "pi", RSDBP_IN, paymentid);
 else
   cmd = RsdCommand( "select count(t.t_autokey), "  // 0
                           " sum(t.t_Sum) "         // 1
                     "from dtrn_doc_dbt t "
                     "where ( ( t.t_fncash = ? and t.t_ListTransfer = ? and ? <> 0 ) or t.t_paymentid = ? ) and " 
                           "t.t_errorcode = 0 and  "
                           "t.t_status = \'X\'" ); 

   cmd.addParam( "branch", RSDBP_IN, PayFil.FNCash );
   cmd.addParam( "lt", RSDBP_IN, PayFil.AutoKey);
   cmd.addParam( "lt_", RSDBP_IN, PayFil.AutoKey);
   cmd.addParam( "pi", RSDBP_IN, paymentid);
 end;

 cmd.execute();
 rs = RsdRecordset( cmd );

 commonSum = $0;

 var com_sum = $0;

 if ( rs.moveNext )
     if ( ValType( rs.value(1) ) == V_DOUBLE )
       com_sum = rs.value(1);
     end;
     [
         Успешно проведенные документы.

         #

         #]
      ( "Договор: " + PayFil.NumberContract + ", платежное поручение: " + PayFil.Num_PayMessage,
        "Количество проведенных документов: " + String( rs.value(0):0:0 ) + ", на общую сумму " + String( com_sum:0:2:a ) + " " + getISO( PayFil.Code_Currency ) );
 end;

 /*** Отчет по ошибках ***/

 list = 0;
 num = 1;

 /*
 cmd = RsdCommand( "select d.t_account, "
                   " (select t_sname "
                   " from dtrn_doc_dbt t "
                   " where e.t_accnumber = t.t_referenc "
                   "  and rownum = 1), "
                   " e.t_errcode, m.t_contents "
                   "from dsb_edref_tmp e "
                   "left outer join ddepositr_dbt d "
                   "  on d.t_referenc = e.t_accnumber "
                   "left outer join dsbbank_msg m "
                   "  on e.t_errcode = m.t_number "
                   "where nvl(e.t_errcode, 0) <> 0 "
                   );
 */

 /*                  
 cmd = RsdCommand( "select t.t_account, "  // 0
                         " t.t_Sname, "    // 1
                         " t.t_Nname, "    // 2
                         " t.t_Pname, "    // 3
                         " e.t_errcode, "  // 4
                         " m.t_contents "  // 5
                   "from dsb_edref_tmp e "
                   "left outer join dtrn_doc_dbt t "
                   "  on t.t_iApplicationKind = e.t_ApplicationKind "
                   " and t.t_ApplicationKey = e.t_ApplicationKey "
                   "left outer join dsbbank_msg m "
                   "  on m.t_number = e.t_errcode "
                   "where nvl(e.t_errcode, 0) <> ? " );
 */

 if ( ( PayFil.AutoKey != 0 ) and ( paymentid == 0 ) )
   cmd = RsdCommand( "select t.t_account, "    // 0
                           " t.t_Sname, "      // 1
                           " t.t_Nname, "      // 2
                           " t.t_Pname, "      // 3
                           " t.t_errorcode, "  // 4
                           " m.t_contents, "   // 5
                           " t.t_ground "      // 6
                     "from dtrn_doc_dbt t "
                     "left outer join dsbbank_msg m "
                     "  on m.t_number = t.t_errorcode "
                     "where ( t.t_fncash = ? and t.t_ListTransfer = ?) and "  
                           "t.t_status <> \'X\'" ); 

   cmd.addParam( "branch", RSDBP_IN, PayFil.FNCash);
   cmd.addParam( "lt", RSDBP_IN, PayFil.AutoKey);
 elif ( ( PayFil.AutoKey == 0 ) and ( paymentid != 0 ) )
   cmd = RsdCommand( "select t.t_account, "    // 0
                           " t.t_Sname, "      // 1
                           " t.t_Nname, "      // 2
                           " t.t_Pname, "      // 3
                           " t.t_errorcode, "  // 4
                           " m.t_contents, "   // 5
                           " t.t_ground "      // 6
                     "from dtrn_doc_dbt t "
                     "left outer join dsbbank_msg m "
                     "  on m.t_number = t.t_errorcode "
                     "where t.t_paymentid = ? and "  
                           "t.t_status <> \'X\'" ); 

   cmd.addParam( "pi", RSDBP_IN, paymentid);
 else
   cmd = RsdCommand( "select t.t_account, "    // 0
                           " t.t_Sname, "      // 1
                           " t.t_Nname, "      // 2
                           " t.t_Pname, "      // 3
                           " t.t_errorcode, "  // 4
                           " m.t_contents, "   // 5
                           " t.t_ground "      // 6
                     "from dtrn_doc_dbt t "
                     "left outer join dsbbank_msg m "
                     "  on m.t_number = t.t_errorcode "
                     "where ( ( t.t_fncash = ? and t.t_ListTransfer = ? and ? <> 0 ) or t.t_paymentid = ? ) and "  
                           "t.t_status <> \'X\'" ); 

   cmd.addParam( "branch", RSDBP_IN, PayFil.FNCash);
   cmd.addParam( "lt", RSDBP_IN, PayFil.AutoKey);
   cmd.addParam( "lt_", RSDBP_IN, PayFil.AutoKey);
   cmd.addParam( "pi", RSDBP_IN, paymentid);
 end;

 cmd.execute();
 rs = RsdRecordset( cmd );
 var errortext = "";

 while ( rs.moveNext )
   if (list == 0)
     [
                               Список непроведенных операций

     ____________________________________________________________________________________________________________________________________________
     |   N N  |           Номер           |           Фамилия,            |                            Причина                                  |
     |   п/п  |         лицевого          |             имя,              |                          невыполнения                               |
     |        |           счета           |           отчество            |                            операции                                 |
     +--------+---------------------------+-------------------------------+---------------------------------------------------------------------+];
     list = 1;
   end;

   if( rs.value( 4 ) == 0 )
     errortext = CheckString(rs.value( 6 ));
   else
     errortext = CheckString(rs.value( 5 ));
   end;

    [| ###### | ######################### | ############################# | ########### ########################################################|]
   (
   num:8,
   rs.value( 0 ) : 25,
   ( CheckString(rs.value( 1 )) + " " +
     CheckString(rs.value( 2 )) + " " +
     CheckString(rs.value( 3 )) ):29:w,
     "Ош.№ " + String( rs.value( 4 ) : 5 ) + ":",
     errortext
   );
   num = num + 1;

 end;

 if ( list == 1)
   [+--------+---------------------------+-------------------------------+---------------------------------------------------------------------+];

 end;

 /**********************************************************************************/
 /* Подсчет листов по протоколу сумм процентов по вкладам, не зачисленных на карты */
 /**********************************************************************************/

   line_num = 0;
   AllLists = 0;
   SumICom = $0;
   saveTypeAcc = "???";
   saveCodCurr = -1;

   Message( " Протокол сумм процентов по вкладам, подсчет листов" );

   cmdGetDocs = RsdCommand( "select doc.t_Type_Account as doc_type_account, doc.t_Code_Currency as doc_code_currency " +
                            "from dsb_edref_tmp ref, dsbdepdoc_dbt doc, DDEPOSITR_DBT dep " +
                            "where ref.t_isCur = ? " +
                            "and ref.t_signRec in (" + string( SIGNORDER ) + ", " + string( SIGNPRINTORDER ) + ") " +
                            "and ref.t_Operation = " + string( OP_PUTPAC ) + " " +
                            "and doc.t_iApplicationKind = ref.t_ApplicationKind " +
                            "and doc.t_ApplicationKey = ref.t_ApplicationKey " +
                            "and doc.t_typeOper = " + string( OP_PUTPAC ) + " " +
                            "and doc.t_inSum <> 0 " +
                            "AND dep.t_referenc = doc.t_referenc " +
                            "AND BITAND( doc.t_flags2, 1 ) = 0 " +
                            "AND INSTR(dep.T_USERTYPEACCOUNT, 'К') <> 0 " +
                            "order by doc.t_Code_Currency, doc.t_Type_Account" );

   cmdGetDocs.addParam( "isCur", RSDBP_IN );
   cmdGetDocs.value( "isCur" ) = flag_Cur;
   cmdGetDocs.execute;

   docsRs = RsdRecordset( cmdGetDocs );

   while ( docsRs.moveNext )
     if ( ( saveTypeAcc != docsRs.value( "doc_type_account" ) )  OR
          ( saveCodCurr != docsRs.value( "doc_code_currency" ) ) )
       if ( saveTypeAcc != docsRs.value( "doc_type_account" ) )
         saveTypeAcc = docsRs.value( "doc_type_account" );
       end;
       if ( saveCodCurr != docsRs.value( "doc_code_currency" ) )
         saveCodCurr = docsRs.value( "doc_code_currency" );
       end;
       if ( ( saveTypeAcc != "???" )  AND
            ( saveCodCurr != -1 ) )
         AllLists = AllLists + 1;
       end;
       line_num = 0;
       num = 0;
     else
       if ( line_num >= ListLineNum )
         line_num = 0;
         AllLists = AllLists + 1;
       end;
     end;
     line_num = line_num + 1;
   end;
   Message( "" );

 /*****************************************************************************/
 /*       Выпуск протокола сумм процентов по вкладам, не зачисленных на карты */
 /*****************************************************************************/

   list = 0;
   line_num = 0;
   num = 0;
   SumI = $0;
   saveTypeAcc = "";
   saveCodCurr = -1;

   Message( " Формирование протокола сумм процентов по вкладам, подсчет листов" );

   cmdGetDocs = RsdCommand( "select doc.t_Type_Account as doc_type_account, doc.t_Code_Currency as doc_code_currency, " +
                            "doc.t_CodClient as doc_codClient, " +
                            "doc.t_InSum as doc_inSum, " +
                            "doc.t_Account as doc_account, " +
                            "cur.t_ExternalCode as ExternalCode, " +
                            "dep.t_SpecialAccess as SpecialAccess " +
                            "from dsb_edref_tmp ref, dsbdepdoc_dbt doc, DDEPOSITR_DBT dep, dcurrency_dbt cur " +
                            "where ref.t_isCur = ? " +
                            "and ref.t_signRec in (" + string( SIGNORDER ) + ", " + string( SIGNPRINTORDER ) + ") " +
                            "and ref.t_Operation = " + string( OP_PUTPAC ) + " " +
                            "and doc.t_iApplicationKind = ref.t_ApplicationKind " +
                            "and doc.t_ApplicationKey = ref.t_ApplicationKey " +
                            "and doc.t_typeOper = " + string( OP_PUTPAC ) + " " +
                            "and doc.t_inSum <> 0 " +
                            "and cur.t_code_currency = doc.t_Code_Currency " +
                            "AND dep.t_referenc = doc.t_referenc " +
                            "AND BITAND( doc.t_flags2, 1 ) = 0 " +
                            "AND INSTR(dep.T_USERTYPEACCOUNT, 'К') <> 0 " +
                            "order by doc.t_Code_Currency, doc.t_Type_Account" );

   cmdGetDocs.addParam( "isCur", RSDBP_IN );
   cmdGetDocs.value( "isCur" ) = flag_Cur;
   cmdGetDocs.execute;

   docsRs = RsdRecordset( cmdGetDocs );

   while ( docsRs.moveNext )
     if ( ( saveTypeAcc != docsRs.value( "doc_type_account" ) ) OR
          ( saveCodCurr != docsRs.value( "doc_code_currency" ) ) )
       line_num = 0;
       list = list + 1;
       num = 0;
       if ( ( saveCodCurr != -1 ) and ( saveTypeAcc != "" ) )
         Protocol_Table();
       end;
       if ( saveTypeAcc != docsRs.value( "doc_type_account" ) )
         saveTypeAcc = docsRs.value( "doc_type_account" );
       end;
       if ( saveCodCurr != docsRs.value( "doc_code_currency" ) )
         saveCodCurr = docsRs.value( "doc_code_currency" );
       end;
       Protocol_Title();
       SumI = $0;
       StrCount = 0;
     end;
     if ( line_num >= ListLineNum )
       line_num = 0;
       list = list + 1;
       num = 0;
       Protocol_Table();
       Protocol_Title();
       SumI = $0;
       StrCount = 0;
     end;
     line_num = line_num + 1;
     num = num + 1;
     ProtocolString( docsRs.value( "doc_inSum" ) );
   end;

   if ( AllLists != 0 )
     /* Были листы, закрыть таблицу */
     Protocol_Table();
   end;

   Message( "" );

end;

