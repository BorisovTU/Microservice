/***************************************************************************\
| GETPCSUM.MAC - расчет суммы к выдаче %% для вида вклада "Срочный с ежеме- |
| сячной выдачей %%"                                  Зубов В.Ю. 15.07.97   |
\***************************************************************************/
import deprintr,denomin,getpcli4,alg_vars/*,opercode*/;


file doc("sbdepdoc.dbt"); /* файл документов */
Var found,
    Зачислено_Всего = $0L,
    Выдано_Всего = $0L,
    За_последний_месяц_по_допвзносам = $0L,
    За_последний_месяц_по_оснвкладу = $0L,
    Отчислено = $0L,Сумма_К_Выдаче = $0L,
    СуммаДВ = $0L,
    /*{curdate},  текущая дата */
    Дата_последнего_расчета, MinDate, MaxDate,
    day,mon,year,tmp, Результат;

/* VZ 09.02.98 Для деноминированной базы*/
CheckDenom(ALG_DEPOSITOR.Referenc);

ALG_RESULT = ERR_RES; /* Возврат в случае ошибки */

Дата_последнего_расчета =Последний_День_Предыдущего_Месяца({curdate});
/*
/*Перебираем документы о причислении %% за всю историю счета*/
KeyNum(doc,1);
doc.Referenc = ALG_DEPOSITOR.Referenc;
doc.TypeOper = Зачисление_Процентов;
doc.DepDate_Document = ALG_DEPOSITOR.Open_Date; /* дата открытия счета */
if(GetGE(doc))
  Зачислено_Всего=$0;
  found=True;
  while((doc.Referenc == ALG_DEPOSITOR.Referenc) AND
        (doc.TypeOper == Зачисление_Процентов) AND
        (found == True))
    if( (doc.KindOp != 9)) /* не архивный документ */
      Зачислено_Всего = Зачислено_Всего + Den(doc.InSum,doc.DepDate_Document);
/*
    if(doc.DepDate_Document == Дата_последнего_расчета)
      if(doc.KindOpSave == 2001) /*по основному вкладу*/
        За_последний_месяц_по_оснвкладу = Den(doc.InSum,doc.DepDate_Document);
      end; /* IF */
      if(doc.KindOpSave == 2004) /*по доп. взносам */
        За_последний_месяц_по_допвзносам = Den(doc.InSum,doc.DepDate_Document);
      end; /* IF */
    end; /* IF */
*/
    end; /* IF */
    if (not Next(doc))
      found=False;
    end;/* IF */
  end; /* WHILE */
end; /* IF */

/*Перебираем документы о выдаче %% за всю историю счета*/
KeyNum(doc,1);
doc.Referenc = ALG_DEPOSITOR.Referenc;
doc.TypeOper = Выдача_Процентов;
doc.DepDate_Document = ALG_DEPOSITOR.Open_Date; /* дата открытия счета */
if(GetGE(doc))
  Выдано_Всего=$0;
  found=True;
  while((doc.Referenc == ALG_DEPOSITOR.Referenc) AND
        (doc.TypeOper == Выдача_Процентов) AND
        (found == True))
     if( (doc.KindOp != 9)) /* не архивный документ */
       Выдано_Всего = Выдано_Всего + Den(doc.OutSum,doc.DepDate_Document);
     end; /* IF */
    if (not Next(doc))
      found=False;
    end;/* IF */
  end; /* WHILE */
end; /* IF */
*/
Результат = Процентов_К_Выдаче(ALG_DEPOSITOR.Account,ALG_DEPOSITOR.Type_Account,
                               ALG_DEPOSITOR.Code_Currency,Зачислено_Всего);
if(Результат)
  MsgBox("Ошибка при расчете %% к выдаче. Результат = ",Результат);
  Exit(1); /* Убрать вывод на экран */
  return;
end;

/* Перебираем операции приходные операции за месяц(c MinDate до MaxDate),*/
/* по которому было последнее зачисление %% */
Результат = Расчет_Излишков_Процентов(ALG_DEPOSITOR.Referenc,Отчислено,СуммаДВ,doc);
if(Результат)
  MsgBox("Ошибка при расчете %%");
  Exit(1); /* Убрать вывод на экран */
  return;
end;/* IF */
/*MsgBox("Отчислено"+String(Отчислено));*/
/*
MSGBOX("Зачислено_Всего="+String(Зачислено_Всего)+
       "|Выдано_Всего"+String(Выдано_Всего)+
       "|Отчислено"+String(Отчислено));
*/
Сумма_К_Выдаче = Зачислено_Всего - Выдано_Всего - Отчислено;
ALG_PARAM.prmD = Сумма_К_Выдаче;
/*[ Зачислено_Всего #
  Выдано_Всего    #
  Сумма_К_Выдаче  #](Зачислено_Всего:l,Выдано_Всего:l,Сумма_К_Выдаче:l);*/
ALG_UPDATE = 1;
ALG_RESULT = SKIP_RES; /* Все Ok */
Exit(1); /* Убрать вывод на экран */
return;
