/*
$Name:               DEP_F31.MAC
$Module:             DEPOSITR
$Description:        Печать справки ф.31
*/

import CommonInter,BankInter,deprintr,DeskInter,OperCode,InputRN,ChkPrn,IsSrvDoc,sbk_titl,getdocs,QueryRes,Alg_Vars;

 private file GroupMem( "groupmem.dbt" ) key 0;
 private file regnum("reg_num.dbt") key 0;
 private file cashval("sb_casvl.dbt") key 1;
 private file cashdoc("sb_casdc.dbt") key 4;

/*---------- Инициализируемые структуры ---------------------------------*/
 private record Parm(CashParm);

 private const
    ACCOUTN_OWNER       = StrFor( 0 ),    /* Владелец счета      */
    ACCOUTN_PROXY       = StrFor( 1 ),    /* Доверенное лицо     */
    ACCOUTN_HEIR        = StrFor( 2 ),    /* Наследник - выдачи  */
    ANONIMUS_CLIENT     = StrFor( 3 ),    /* Анонимный клиент    */
    ACCOUNT_IMPORTER    = StrFor( 4 ),    /* Вноситель           */
    ACCOUNT_TUTOR       = StrFor( 5 ),    /* Опекун              */
    ACCOUNT_OBLIGATOR   = StrFor( 6 ),    /* Под обязательство   */
    ACCOUTN_HEIR_PAY    = StrFor( 7 ),    /* Наследник - выплаты */
    ACCOUNT_UNDER_TRIAL = StrFor( 8 ),    /* По суду             */
    ACCOUNT_PARENT      = StrFor( 9 );    /* Родитель            */

 private const CASHOP_DEBIT          = 5;
 private const CASHOP_CHVALUE        = 9;
 private const TYPERES_VALFORM       = 2;
 private const VALFORM_31            = 31;

 private const
   RegPath = "RS-RETAIL\\ПЕЧАТИ\\ФОРМА_31";

 private var
   OperBrigade = GetOperBrigade,
   Branch = NumFNCash;

 private macro GetPatern(Oper)

   GroupMem.Branch = NumRealFNCash;
   GroupMem.Date = {curdate};
   GroupMem.Group = OperBrigade;
   GroupMem.Oper = Oper;
   if ( GetEQ( GroupMem ) )
     return GroupMem.Linked;
   else
     return 0;
   end;
 end;

 private macro GetRefValue(Type, IntCode)



   cashval.TypeValue = Type;
   cashval.CodIntValue = IntCode;
   if(GetEQ(cashval))
     return cashval.RefValue;
   else
     return 0;
   end;
 end;

 private macro Form31NumberForOper(ValueRef, Oper)

   ClearRecord(regnum);
   regnum.Branch = Branch;
   regnum.CashOper = String(Oper);
   regnum.ValueRef = ValueRef;
   regnum.Date = {curdate};
   if(GetGE(regnum)
     and (regnum.Branch == Branch)
     and (regnum.CashOper == String(Oper))
     and (regnum.SubAccount == "")
     and (regnum.ValueRef == ValueRef)
     and (regnum.Date == {curdate}))
     if(regnum.Series == "")
       return String(regnum.Min);
     else
       return regnum.Series + "-" + String(regnum.Min);
     end;
   end;
   return "";
 end;

 private macro Form31Number(ValueRef)

   var
     Num = Form31NumberForOper(ValueRef, ALG_SBDEPDOC.Oper);

   if(Num == "")
     Num = Form31NumberForOper(ValueRef, GetPatern(ALG_SBDEPDOC.Oper))
   end;
   return Num;
 end;

 /*******************************************************************
                           Печать справки
 *******************************************************************/
 macro Form31( Day, Month, Year, KvitFrom, KvitKNF,
               KvitFor, KvitAcc, KvitType,
               SumRub, SumCop, SumWr )

   print("\x1b0"); /* Режим печати - 8 строк на дюйм */
   [

                     #   #              #

       #
     #
     #
     по счету #

     #


                 #                     #

     #
   ]
   ( Day:l, Month:l, Year:l, KvitFrom:l, KvitKNF,
     KvitFor:l, KvitAcc:l, KvitType:l,
     SumRub:l, SumCop:l, SumWr:l );
   print(""); /* End of page */

 end;

 macro CarryForm31( PrintForm31 )


   ALG_RESULT = OK_RES;
   return true;	//trap: ф. 31 устарела(по запросу # 209781)



   var
     stat,
     Retry = false,
     ExitFlag = false,
     dDay, dMon, dYear, sMon, sFIO, sKNF, sAcc, sSum, dRub, sRub, sCop,
     sRegNum, tRegNum, lRegNum;

   ALG_RESULT = ERR_RES;/*заранее инициализируем код возврата*/
   CheckPrinter( RegPath, alg_param.prmC );
   ALG_RESULT = OK_RES;/*заранее инициализируем код возврата*/

   /* Проверка - не выдавалась ли уже справка ф.31 для данного документа */
   if ( CheckCashLink( 0, TYPERES_VALFORM, VALFORM_31,
                       ALG_SBDEPDOC.iApplicationKind,
                       ALG_SBDEPDOC.ApplicationKey ) )
     MsgBox( "Справка ф.31 для данного документа|уже выдавалась" );
     return;
   end;

   ClearRecord(Parm);
   Parm.Type=0;       /* Платежеспосбные ресурсы */
   Parm.TypeValue=TYPERES_VALFORM;
   Parm.CodIntValue=VALFORM_31;
   Parm.Oper=ALG_SBDEPDOC.Oper;
   Parm.CashDateDoc={curdate};
   Parm.NumOper=CASHOP_DEBIT;
   Parm.ValueCol=1;
   Parm.NumbDocumCash=ALG_SBDEPDOC.NDoc;
   Parm.ApplicationKind=ALG_SBDEPDOC.iApplicationKind;
   Parm.ApplicationKey=ALG_SBDEPDOC.ApplicationKey;
   Parm.OperPatern=ALG_SBDEPDOC.Oper;
   Parm.MinRegistrNumber=
     Form31Number(GetRefValue(TYPERES_VALFORM, VALFORM_31));
   while(not ExitFlag)
   stat = InputRegNum(
     ALG_SBDEPDOC.Oper,
     Parm.Oper,
     TYPERES_VALFORM,
     VALFORM_31,
     "Введите номер справки ф.31:",
     Parm.Series, Parm.MinRegistrNumber);
     stat=InitCashDoc(Parm);
     if(stat)
       ExitFlag = true;
     else
       Retry = false;
       GetTrue(Retry, "Ошибка при расходе. Повторить ?");
       if(not Retry)
         ExitFlag = true;
       end;
     end;
   end;
   if ( stat )
     DateSplit( ALG_SBDEPDOC.Date_Document, dDay, dMon, dYear );
     /* Получение названия месяца */
     if (dMon == 1)
       sMon = "января";
     elif (dMon == 2)
       sMon = "февраля";
     elif (dMon == 3)
       sMon = "марта";
     elif (dMon == 4)
       sMon = "апреля";
     elif (dMon == 5)
       sMon = "мая";
     elif (dMon == 6)
       sMon = "июня";
     elif (dMon == 7)
       sMon = "июля";
     elif (dMon == 8)
       sMon = "августа";
     elif (dMon == 9)
       sMon = "сентября";
     elif (dMon == 10)
       sMon = "октября";
     elif (dMon == 11)
       sMon = "ноября";
     elif (dMon == 12)
       sMon = "декабря";
     else
       sMon = "???";
     end;
     if ( dYear < 2000 )
       dYear = dYear - 1900;
     else
       dYear = dYear - 2000;
     end;
     sFIO = ALG_COMDEPCLNT.ConvertFIOFull ();
     sAcc = Acc_Form(ALG_DEPOSITOR.Account);
     if ( ALG_SBDEPDOC.Author == ACCOUTN_PROXY )
       sAcc = sAcc + " (Доп.взнос сделан доверенным лицом)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUTN_HEIR )
       sAcc = sAcc + " (Доп.взнос сделан наследником)";
     end;
     if ( ALG_SBDEPDOC.Author == ANONIMUS_CLIENT )
       sAcc = sAcc + " (Доп.взнос сделан анонимным клиентом)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUNT_IMPORTER )
       sAcc = sAcc + " (Доп.взнос сделан вносителем)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUNT_TUTOR )
       sAcc = sAcc + " (Доп.взнос сделан опекуном)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUNT_OBLIGATOR )
       sAcc = sAcc + " (Доп.взнос сделан под обязательство)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUTN_HEIR_PAY )
       sAcc = sAcc + " (Доп.взнос сделан наследником)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUNT_UNDER_TRIAL )
       sAcc = sAcc + " (Доп.взнос сделан по суду)";
     end;
     if ( ALG_SBDEPDOC.Author == ACCOUNT_PARENT )
       sAcc = sAcc + " (Доп.взнос сделан родителем)";
     end;

     dRub = String( Int( DoubleL( ALG_SBDEPDOC.InSum ) ):a );
     sSum = RubToStr( ALG_SBDEPDOC.InSum, sRub, sCop );

     if ( Index( ALG_DEPOSITOR.UserTypeAccount, "Ф" ) != 0 )  /* Счета типа "Ф" */
       sKNF = "KNF" + String( ALG_SBDEPDOC.KNFCode );
     else
       sKNF = "";
     end;

     if( PrintForm31 )
       Form31( dDay, sMon, dYear, sFIO, sKNF,
               "Прием наличных денежных средств во вклад без сберкнижки",
               sAcc, "Наличные деньги",
               dRub, sCop, sSum );
     end;
     sRegNum = String( Parm.MinRegistrNumber );
     lRegNum = StrLen( sRegNum );
     tRegNum = SubStr( "0000000", 1, 7 - lRegNum ) + sRegNum;
     ALG_SBDEPDOC.Ground = ALG_SBDEPDOC.Ground + " (выдана ф.31 № " +
                           SubStr( Parm.Series, 1, 1 ) + " " +
                           tRegNum + ")";
     ALG_UPDATE=1;
   else
     MsgBox("Ошибка при расходе справки ф.31");
   end;
   if ( stat )
     QueryResult( "Форма №31 была напечатана?" );
     if ( ALG_RESULT == ERR_RES )
       stat = false;
     end;
   end;
   return stat;
 end;

