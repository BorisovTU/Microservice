/**************************************************************************\
*  ---------------------                                                   *
*  R-Style Software Lab.                                                   *
*  ---------------------                                                   *
*  RS-Retail                                                               *
*                                                                          *
*  Вклады                                                                  *
*                                                                          *
*  Взятие комиссии при закрытии счета с утеренной сберкнижкой              *
*                                                                          *
*  Лебедев С.В.                                                            *
*  12.07.2000                                                              *
\**************************************************************************/

import deprintr, alg_vars, issrvdoc, cur_rate;
import rsd;

file depositr   ( depositr );
file sbdepdoc   ( sbdepdoc ) key 1;
file sb_casln   ( sb_casln );
file pay_doc_c  ( pay_doc  ) key 2;
file currency   ( currency ) key 0;
file tarif      ( sb_tarif ) key 0;
file tarif_plus ( sb_tarpl ) key 0;
file ret_op     ( ret_op   ) key 0;

var depclnt = TClientList;

const TarifSbook  = 17; /* Код тарифа за утерю сберкнижки */
const TarifSbookP = 19; /* Код тарифа за утерю сберкнижки */

const MinRestNat  = $100L;
const MinRestBase = $10L;

var NumTarif   = 0;
var ComisSum   = $0L;
var IsNalComis = true;
var KindPay    = 0;
var MinRest    = $0L;
var CBRateCur  = 0;
var CBRateBase = 0;

var OpNum    = 0;
var SubOpNum = 0;


/**************************************************************************\
|                               Поиск тарифа                               |
\**************************************************************************/
macro FindTarif ( isCur, Num, _Date, _Sum )

  var stat;

  tarif.IsCur    = isCur;
  tarif.NumTarif = Num;

  stat = GetEQ( tarif );

  if ( stat and ( tarif.TarifPlus ) )
    tarif_plus.IsCur    = isCur;
    tarif_plus.NumTarif = Num;
    tarif_plus.Date     = _Date;
    tarif_plus.SumOper  = _Sum;
    if ( ( GetGE( tarif_plus )          ) and
         ( tarif_plus.IsCur    == isCur ) and
         ( tarif_plus.NumTarif == Num   ) and
         ( tarif_plus.Date     == _Date )    )
      tarif.PerSent = tarif_plus.Percent;
      tarif.MinSum  = tarif_plus.MinSum;
      tarif.MaxSum  = tarif_plus.MaxSum;
      tarif.Summa   = tarif_plus.Summa;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |  //rsd - scr#86752
\**************************************************************************/  //call IsServDoc() leave
macro WasPayedComisForLostBookBefore

  var MainAppKind;
  var MainAppKey;
  var stat = false;
  var flag;
  var flag2;

  var cmd_sb_casln;
  var rs_sb_casln;

  var cmd_ret_op;
  var rs_ret_op;

  var cmd_pay_doc_c;
  var rs_pay_doc_c;

//////msgbox("enter to WasPayedComisForLostBookBefore   ALG_DEPOSITOR.Referenc="+String(ALG_DEPOSITOR.Referenc));

  sbdepdoc.Referenc         = ALG_DEPOSITOR.Referenc;
  sbdepdoc.TypeOper         = 62;
  sbdepdoc.DepDate_Document = Date(0,0,0);

  flag = GetGE( sbdepdoc );
  while ( flag )
    if ( ( sbdepdoc.Referenc == ALG_DEPOSITOR.Referenc ) and
         ( sbdepdoc.TypeOper == 62                     )    )
      if ( ( IsServDoc( sbdepdoc )    ) and         
           ( sbdepdoc.FlagStorn == "" ) and
           ( sbdepdoc.ApplType  == 30 )    )
        
        //new
        cmd_sb_casln = RsdCommand;
        cmd_sb_casln.CmdText = 
          " SELECT * FROM dsb_casln_dbt " +
          " WHERE " +
          " t_ApplicationKind2="+String( sbdepdoc.iApplicationKind )+" AND " +
          " t_ApplicationKey2='"+String( sbdepdoc.ApplicationKey )+"' AND " +
          " t_RefValue2 >= 0 "
        ;
        cmd_sb_casln.execute;
        rs_sb_casln = RsdRecordset(cmd_sb_casln);
        /*old
        KeyNum( sb_casln, 1 );
        sb_casln.ApplicationKind2 = sbdepdoc.iApplicationKind;
        sb_casln.ApplicationKey2  = sbdepdoc.ApplicationKey;
        sb_casln.RefValue2        = 0;
        */
        if ( ( rs_sb_casln.moveNext ) and                                   //( GetGE( sb_casln ) ) and
             ( rs_sb_casln.Fld("t_ApplicationKind2").Value == sbdepdoc.iApplicationKind ) and //( sb_casln.ApplicationKind2 == sbdepdoc.iApplicationKind ) and
             ( rs_sb_casln.Fld("t_ApplicationKey2").Value  == sbdepdoc.ApplicationKey ) ) //( sb_casln.ApplicationKey2  == sbdepdoc.ApplicationKey   )    )
          MainAppKind = rs_sb_casln.Fld("t_ApplicationKind1").Value;
          MainAppKey  = rs_sb_casln.Fld("t_ApplicationKey1").Value;

          //new
          cmd_ret_op = RsdCommand;
          cmd_ret_op.CmdText =
            " SELECT * FROM dret_op_dbt "+
            " WHERE "+
            " t_ApplicationKind="+String(MainAppKind)+" AND "+
            " t_ApplicationKey='"+String(MainAppKey)+"' "
          ;
          cmd_ret_op.execute;
          rs_ret_op = RsdRecordset(cmd_ret_op);
          if ( rs_ret_op.moveNext )
            if ( rs_ret_op.Fld("t_Operation").Value > 200 )
              OpNum    = rs_ret_op.Fld("t_Operation").Value;
              SubOpNum = rs_ret_op.Fld("t_SubOp").Value;
            end;
          end;
          /*old
          ret_op.ApplicationKind = MainAppKind;
          ret_op.ApplicationKey  = MainAppKey;
          if ( GetEQ( ret_op ) )
            if ( ret_op.Operation > 200 )
              OpNum    = ret_op.Operation;
              SubOpNum = ret_op.SubOp;
            end;
          end;
          */

          if ( sbdepdoc.OutSum != 0 ) //( sbdepdoc.OutSum != 0 ) /* Была безналичная плата */
            stat = true;
          else /* Проверим была ли наличная плата */
            //new
            cmd_sb_casln = RsdCommand;
            cmd_sb_casln.CmdText=
              " SELECT * FROM dsb_casln_dbt " +
              " WHERE " +
              " t_ApplicationKind1="+String(MainAppKind)+" AND " +
              " t_ApplicationKey1='"+String(MainAppKey)+"' AND " +
              " t_NumLinkDoc >= 0 "
              ;
            cmd_sb_casln.execute;
            rs_sb_casln = RsdRecordset(cmd_sb_casln);
            flag2=rs_sb_casln.moveNext;
            //old
            //KeyNum( sb_casln, 0 );
            //sb_casln.ApplicationKind1 = MainAppKind;
            //sb_casln.ApplicationKey1  = MainAppKey;
            //sb_casln.NumLinkDoc       = 0;
            //flag2 = GetGE( sb_casln );
            while ( flag2 
               and ( rs_sb_casln.Fld("t_ApplicationKind1").Value == MainAppKind )   //( sb_casln.ApplicationKind1 == MainAppKind )
               and ( rs_sb_casln.Fld("t_ApplicationKey1").Value  == MainAppKey  ) ) //( sb_casln.ApplicationKey1  == MainAppKey  ) )
                if ( rs_sb_casln.Fld("t_RefValue2").Value == 0 )                    //( sb_casln.RefValue2        == 0 )    
                  if ( rs_sb_casln.Fld("t_ApplicationKind2").Value == 200 )         //( sb_casln.ApplicationKind2 == 200 )
                    //new
                    cmd_pay_doc_c = RsdCommand;
                    cmd_pay_doc_c.CmdText = 
                      " SELECT * FROM dpay_doc_dbt "+
                      " WHERE "                     +
                      " t_iApplicationKind = "+ String(rs_sb_casln.Fld("t_ApplicationKind2").Value) +" AND "+
                      " t_ApplicationKey = '"+String(rs_sb_casln.Fld("t_ApplicationKey2").Value)+"' "      ;
                    cmd_pay_doc_c.execute;
                    rs_pay_doc_c = RsdRecordset(cmd_pay_doc_c);
                    if( (rs_pay_doc_c.moveNext) AND
                        (rs_pay_doc_c.Fld("t_GroupOpert").Value == 21)
                      )
                      stat = true;
                      flag2 = false;
                    end;
                    /*
                    pay_doc_c.iApplicationKind = sb_casln.ApplicationKind2;
                    pay_doc_c.ApplicationKey   = sb_casln.ApplicationKey2;
                    if ( GetEQ( pay_doc_c ) and ( pay_doc_c.GroupOpert == 21 ) )
                      stat = true;
                      flag2 = false;
                    end;
                    */

                  end;//if ==200
                end;//if ==0
                if ( flag2 )
                  flag2 = rs_sb_casln.moveNext; //Next( sb_casln );
                end;
            end;//while
          end;//else
        end;//if
        if ( stat )
          flag = false;
        else
          flag = Next( sbdepdoc );
        end;
      else
        flag = Next( sbdepdoc );
      end;
    else
      flag = false;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro NewDepDoc ( Doc )

  ClearRecord( Doc );
  Doc.Referenc         = ALG_DEPOSITOR.Referenc;
  Doc.IsCur            = ALG_DEPOSITOR.IsCur;
  Doc.FNCash           = ALG_DEPOSITOR.FNCash;
  Doc.RealFNCash       = NumRealFNCash( );
  Doc.Account          = ALG_DEPOSITOR.Account;
  Doc.Oper             = {oper};
  Doc.Type_Account     = ALG_DEPOSITOR.Type_Account;
  Doc.Code_Currency    = ALG_DEPOSITOR.Code_Currency;
  Doc.CodClient        = ALG_DEPOSITOR.CodClient;
  Doc.YesSbook         = "X";
  Doc.Date_Document    = {curdate};
  Doc.DepDate_Document = {curdate};

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro TrnProc

  record pay_doc  ( pay_doc  );
  record sbdepdoc ( sbdepdoc );

  var stat = true;

  if ( stat AND ( KindPay == 0 ) )
    ClearRecord( pay_doc );
    pay_doc.FNCash           = NumRealFNCash( );
    pay_doc.IsCur            = ALG_DEPOSITOR.IsCur;
    pay_doc.NumOpert         = 5;
    pay_doc.GroupOpert       = 21; /* Комиссия */
    pay_doc.Date_Document    = {curdate};
    pay_doc.CodCur           = 0;
    pay_doc.Oper             = {oper};
    pay_doc.InSum            = ComisSum;
    pay_doc.ClientLastName   = depclnt.CurRec.rec.Name1;
    pay_doc.ClientFirstName  = depclnt.CurRec.rec.Name2;
    pay_doc.ClientSecondName = depclnt.CurRec.rec.Name3;
    pay_doc.FlagRez          = depclnt.CurRec.rec.NotResident;
    pay_doc.CodClient        = depclnt.CurRec.rec.CodClient;
    pay_doc.iApplicationKind = 200;
    pay_doc.ApplicationKey   = FormApplicationKey( 200 );
    pay_doc.Ground           = "Плата за утерю сберкнижки по счету " + 
                               Acc_Form(ALG_DEPOSITOR.Account);

    stat = InsertPayDocToGDDList( pay_doc );
  end;

  if ( stat )
    NewDepDoc( sbdepdoc );
    if (OpNum == 205)
      sbdepdoc.TypeComplexOper = 62/*205*/;
    else
      sbdepdoc.TypeComplexOper = 62/*501*/;
    end;
    sbdepdoc.TypeOper         = 62;
    sbdepdoc.ApplType         = 30;
    sbdepdoc.DepDate_Document = {curdate};
    sbdepdoc.IsControl        = StrFor( 1 ); /* Признак главного документа */
    if ( KindPay == 1 )
      sbdepdoc.OutSum         = ComisSum;
    end;
    if ( KindPay == 0 )
      sbdepdoc.Ground         = "Взятие платы за утерю сберкнижки (налично)";
    else
      sbdepdoc.Ground         = "Взятие платы за утерю сберкнижки (безналично)";
    end;
    stat = not Выполнить_операцию( sbdepdoc.Account, sbdepdoc.Type_Account,
                                   sbdepdoc.Code_Currency, 62, sbdepdoc    );
  end;

  if ( not stat )
    AbortTrn( );
  end;

end;


/**************************************************************************\
|                    Г Л А В Н А Я   П Р О Г Р А М М А                     |
\**************************************************************************/

  ALG_RESULT = OK_RES;

  if ( ALG_RESULT == OK_RES )
    if ( StrFor( GetProgramID( ) ) == "П" )
      ALG_RESULT = SKIP_RES;
    end;
  end;
         

  if ( ALG_RESULT == OK_RES )
    if ( Index( ALG_DEPOSITOR.UserTypeAccount, "Y" ) == 0 )
      ALG_RESULT = SKIP_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    if ( not depclnt.GetRecord( ALG_DEPOSITOR.CodClient ) )
      MsgBox( "Не найден клиент с кодом " + String( ALG_DEPOSITOR.CodClient ) );
      ALG_RESULT = ERR_RES;
    end;
  end;

  /* Определение минимальной суммы, с которой не берется плата */
  if ( ALG_RESULT == OK_RES )
    if ( ALG_DEPOSITOR.Code_Currency == 0 )
      MinRest = MinRestNat;
    elif ( ALG_DEPOSITOR.Code_Currency == 1 )
      MinRest = MinRestBase;
    else
      if ( not GetAllCurrRate( {curdate}, ALG_DEPOSITOR.Code_Currency, CBRateCur ) )
        ALG_RESULT = ERR_RES;
        if ( StrFor( GetProgramID( ) ) != "П" )
          MsgBox( "Ошибка при определении курса валюты счета" );
        end;
      else
        if ( not GetAllCurrRate( {curdate}, 1, CBRateBase ) )
          ALG_RESULT = ERR_RES;
          if ( StrFor( GetProgramID( ) ) != "П" )
            MsgBox( "Ошибка при определении курса базовой валюты" );
          end;
        end;
      end;
      if ( ALG_RESULT == OK_RES )
        MinRest = Money( MinRestBase * CBRateBase / CBRateCur );
      end;
    end;
  end;
  
  /* Чтение тарифа платы за утерю сберкнижки */
  if ( ALG_RESULT == OK_RES )
    if ( not FindTarif( ALG_DEPOSITOR.IsCur, TarifSbook, Date(0,0,0), $0L) )
      MsgBox( "Не найден тариф за утерю сберкнижки" );
      ALG_RESULT = ERR_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    if ( WasPayedComisForLostBookBefore( ) )
      ALG_RESULT = SKIP_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    if ( ALG_DEPOSITOR.Sum_Rest <= MinRest )
      ALG_RESULT = SKIP_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    if ( ( OpNum == 205 ) AND ( SubOpNum == 2 ) )
      ALG_RESULT = SKIP_RES;
    end;
  end;
  
  if ( ALG_RESULT == OK_RES )
    if ( depclnt.CurRec.rec.DateDeath != Date( 0, 0, 0 ) )
      ALG_RESULT = SKIP_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    NumTarif = TarifSbook;
    depclnt.CurRec.GetPersnCard();
    if ( ( OpNum == 205 ) AND ( SubOpNum == 1 ) )
      NumTarif = TarifSbookP;
    elif ( ( depclnt.CurRec.rec.Kategor == 3 ) OR ( depclnt.CurRec.rec.SocialNumber != "" ) )
      NumTarif = TarifSbookP;
    else
      if ( StrFor( GetProgramID( ) ) != "П" )
        /* А вдруг всё-таки пенсионер? */
        if ( GetTrue( false, "Взятие платы за утерю сберкнижки|Вкладчик принадлежит к категории \"ПЕНСИОНЕР\" ?" ) )
          ExecMacroFile( "setpensn.mac" );
          if ( ALG_RESULT == OK_RES )
            NumTarif = TarifSbookP;
          end;
        end;
      end;
    end;

    if ( FindTarif( ALG_DEPOSITOR.IsCur, NumTarif, Date( 0, 0, 0 ), $0L ) )
      ComisSum = tarif.Summa;
      if ( ComisSum == 0 )
        ALG_RESULT = SKIP_RES;
      end;
    else
      MsgBox( "Не найден тариф за утерю сберкнижки" );
      ALG_RESULT = ERR_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    currency.Code_Currency = 0;
    if ( not GetEQ( currency ) )
      ClearRecord( currency );
    end;
    if ( ALG_DEPOSITOR.IsCur )
      KindPay = ConfDlg( "Плата за утерю сберкнижки в размере " + String( ComisSum:0:2:a ) + " " + currency.Short_Name + " берется ?", NULL, "Наличными", "Не берется" );
      if ( KindPay == 1 )
        KindPay = 2;
      end;
    else
      KindPay = ConfDlg( "Плата за утерю сберкнижки в размере " + String( ComisSum:0:2:a ) + " " + currency.Short_Name + " берется ?", NULL, "Наличными", "Безналичными", "Не берется" );
    end;

    if ( KindPay == 2 )
      MsgBox( "Счет нельзя закрыть без платы за утерю сберкнижки" );
      ALG_RESULT = END_RES;
    end;
  end;

  if ( ALG_RESULT == OK_RES )
    if ( ProcessTrn( 1, "TrnProc", depositr ) )
      ALG_RESULT = OK_RES;
    else
      MsgBox( "Ошибка во время проведения операции" );
      ALG_RESULT = ERR_RES;
    end;
  end;

end;
