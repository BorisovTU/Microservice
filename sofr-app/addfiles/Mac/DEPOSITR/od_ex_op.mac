/*
**  Операционный дневник.
**  Валютообменные операции. Отчет по базам ОП.
**  Операции, по по которым нет реестров
*/
import ExchangeInter, "od_ex_al.mac", "rstrfunc.mac", "opertdy2.mac";

const RefValueBSO = 6; /* код ценности "справки БСО" */

/***************************************************************************
                       Формирование сумм для строки отчета
                        по одной валютообменной операции
***************************************************************************/
MACRO Заполнить_суммы_по_операции( R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out )

  var OldKey, stat;
  var Q_OutBSO = 0, Q_OutBlank = 0;
  var IncomeCurr_Ref, OutCurr_Ref;

  OldKey = KeyNum( Operat, 0 );
  ClearRecord( Operat );

  Operat.Branch = TmpOperat.Branch;
  Operat.ID     = TmpOperat.ID;

  stat = GetEQ( Operat );
  KeyNum( Operat, OldKey );

  IncomeCurr_Ref = FindCodCurByRefVal( Operat.IncomeRefVal );
  OutCurr_Ref    = FindCodCurByRefVal( Operat.OutRefVal );

  /* Покупка платежеспособной валюты за рубли   */
  if( Operat.Kind_Oper == CDF_OperCurrBuy      )
    if( TmpOperat.IsIncome == ON )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      C_In  = Operat.IncomeAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    else
      R_Out = Operat.OutAmount;
    end;
  /* Покупка неплатежеспособной валюты за рубли */
  /* Покупка платежного документа за рубли      */
  elif( ( Operat.Kind_Oper == CDF_OperUnpayCurrBuy ) or
        ( Operat.Kind_Oper == CDF_OperPayDocBuy    ) or 
        ( Operat.Kind_Oper == CDF_OperPayDocBuyAcc )  )
    if( TmpOperat.IsIncome == ON )
      UR_In = Cur2Rub( Operat.IncomeAmount );
      UC_In = Operat.IncomeAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    else
      R_Out = Operat.OutAmount;
    end;
  /* Продажа платежного документа за рубли */
  elif( ( Operat.Kind_Oper == CDF_OperPayDocSale    ) or
        ( Operat.Kind_Oper == CDF_OperPayDocSaleAcc )  )
    if( TmpOperat.IsIncome == OFF )
      R_In  = Cur2Rub( Operat.OutAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      C_In  = Operat.OutAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_OutBSO );
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  Operat.OutRefVal,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_OutBlank );
      Q_Out = Q_OutBSO + Q_OutBlank;
    else
      R_In  = Operat.IncomeAmount;
    end;
  /* Продажа платежеспособной валюты за рубли */
  elif( Operat.Kind_Oper == CDF_OperCurrSale )
    if( TmpOperat.IsIncome == OFF )
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    else
      R_In  = Operat.IncomeAmount;
    end;
  /* Начисление на карту                    */
  /*
  elif( Operat.Kind_Oper == CDF_OperCardTake )
    if( ( IsCur ) and ( Operat.IncomeCurr_Ref != {NationalCur} ) )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      C_In  = Operat.IncomeAmount;
      /*Q_Out = money(Operat.NumberSprv*100); - справки считать не так !!!*/
    elif( Operat.IncomeCurr_Ref == {NationalCur} )
      R_In  = Operat.IncomeAmount;
      /*Q_Out = money(Operat.NumberSprv*100); - справки считать не так !!!*/
    end;
  */
  /* Снятие с карты                         */
  /*
  elif( Operat.Kind_Oper == CDF_OperCardGive )
    if( ( IsCur ) and ( Operat.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
      /*Q_Out = money(Operat.NumberSprv*100); - справки считать не так !!!*/
    elif( Operat.OutCurr_Ref == {NationalCur} )
      R_Out = Operat.OutAmount;
      /*Q_Out = money(Operat.NumberSprv*100); - справки считать не так !!!*/
    end;
  */
  /* Прием на экспертизу                    */
  /* Прием на инкассо                       */
  /* Прием ПД на экспертизу                 */
  /* Прием ПД на инкассо                    */
  elif( ( Operat.Kind_Oper == CDF_OperExpert        ) or
        ( Operat.Kind_Oper == CDF_OperIncasso       ) or
        ( Operat.Kind_Oper == CDF_OperPayDocExpert  ) or
        ( Operat.Kind_Oper == CDF_OperPayDocIncasso )  )
    if( TmpOperat.IsIncome == ON )
      UQ_In = Operat.IncomeAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    end;
  /* Конверсия                              */
  elif( Operat.Kind_Oper == CDF_OperCurrConversion )
    if( TmpOperat.IsIncome == ON )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      C_In  = Operat.IncomeAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    else
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
    end;
  /* Покупка платежного документа за валюту */
  elif( ( Operat.Kind_Oper == CDF_OperPayDocBuyCurr    ) or
        ( Operat.Kind_Oper == CDF_OperPayDocBuyCurrAcc ) )
    if( TmpOperat.IsIncome == ON )
      UR_In = Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      UC_In = Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    end;
  /* Продажа платежного документа за валюту */
  elif( ( Operat.Kind_Oper == CDF_OperPayDocSaleCurr    ) or
        ( Operat.Kind_Oper == CDF_OperPayDocSaleCurrAcc )  )
    if( TmpOperat.IsIncome == OFF )
      R_In  = 2*Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      C_In  = 2*Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_OutBSO );
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  Operat.OutRefVal,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_OutBlank );
      Q_Out = Q_OutBSO + Q_OutBlank;
    end;
  /* Замена неплатежеспособной валюты       */
  elif( Operat.Kind_Oper == CDF_OperChange )
    if( TmpOperat.IsIncome == ON )
      UR_In = Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      UC_In = Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    end;
  /* Размен валюты                          */
  elif( Operat.Kind_Oper == CDF_OperSplit )
    if( TmpOperat.IsIncome == ON )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      C_In  = Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    end;
  /* Возврат с экспертизы                   */
  /* Возврат ПД с экспертизы                */
  /* Возврат с инкассо                      */
  /* Возврат ПД с инкассо                   */
  elif( ( Operat.Kind_Oper == CDF_OperReturnExpert        ) or
        ( Operat.Kind_Oper == CDF_OperPayDocReturnExpert  ) or 
        ( Operat.Kind_Oper == CDF_OperReturnIncasso       ) or
        ( Operat.Kind_Oper == CDF_OperPayDocReturnIncasso )  )
    /* Возврат денежного эквивалента */
    if( ( Operat.OutTypeValue == TYPERES_CURRENCY ) and
        ( Operat.OutType      == TYPE_RES_PAY  )  )
      if( IsCur and ( OutCurr_Ref != {NationalCur} ) )
        R_Out = Cur2Rub( Operat.OutAmount );
        C_Out = Operat.OutAmount;
        ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                    Operat.ApplicationKey, 
                                    RefValueBSO,
                                    CASHOP_DEBIT,  /* Расход */
                                    Q_Out );
      elif( OutCurr_Ref == {NationalCur} )
        R_Out = Operat.OutAmount;
        ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                    Operat.ApplicationKey, 
                                    RefValueBSO,
                                    CASHOP_DEBIT,  /* Расход */
                                    Q_Out );
      end;
    /* Возврат принятой ценности */
    else
      if( IsCur )
        ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                    Operat.ApplicationKey, 
                                    RefValueBSO,
                                    CASHOP_DEBIT,  /* Расход */
                                    Q_Out );
        UQ_Out= Operat.OutAmount;
      end;
    end;
  /* Проверка на подлинность                */
  elif( Operat.Kind_Oper == CDF_OperCheck )
    if( TmpOperat.IsIncome == ON )
      ПолучитьСтрокуСерийНомеров( Operat.ApplicationKind, 
                                  Operat.ApplicationKey, 
                                  RefValueBSO,
                                  CASHOP_DEBIT,  /* Расход */
                                  Q_Out );
    end;
  end;

  Q_In  = money( Q_In *100 );
  Q_Out = money( Q_Out*100 );

  SetParm(  0, R_In   );
  SetParm(  1, R_Out  );
  SetParm(  2, MR_In  );
  SetParm(  3, MR_Out );
  SetParm(  4, C_In   );
  SetParm(  5, C_Out  );
  SetParm(  6, MC_In  );
  SetParm(  7, MC_Out );
  SetParm(  8, Q_In   );
  SetParm(  9, Q_Out  );
  SetParm( 10, UR_In  );
  SetParm( 11, UR_Out );
  SetParm( 12, UC_In  );
  SetParm( 13, UC_Out );
  SetParm( 14, UQ_In  );
  SetParm( 15, UQ_Out );
END;

/*             пока весь файл не нужен

/***************************************************************************
                       Формирование сумм для строки отчета
                        по одной валютообменной операции
***************************************************************************/
macro Заполнить_суммы_по_операции( R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out )

  var
  КурсЦБ     = 0,
  PayDoc_Ref = 0,
  Колич      = 0,
  КодВалюты  = int (Curr.ExternalCode);

  /* Покупка платежеспособной валюты за рубли   */
  if( Operat.Oper_Ref == CDF_OperCurrBuy      )
    if( IsCur )
      R_In  = Cur2Rub( Operat.IncomeAmount ); 
      C_In  = Operat.IncomeAmount;
      Q_Out = money(Operat.SprvAmount*100);
    else
      R_Out = Operat.OutAmount + Operat.IncTaxValue;
    end;
/*  Согласно ТЗ 622-01 мемориальные обороты не нужны
    if( C_In > R_Out )
      MR_In = C_In - R_Out;
    else
      MR_Out = R_Out - C_In;
    end;
    Количество ценностей не нужно
    ПолучитьСтрокуСерийНомеровПД( Operat.ID, Q_In ); /* вычислим количество */
    Q_In = money( Q_In * 100 );
*/
  /* Покупка неплатежеспособной валюты за рубли */
  /* Покупка платежного документа за рубли      */
  elif( ( Operat.Oper_Ref == CDF_OperUnpayCurrBuy ) or
        ( Operat.Oper_Ref == CDF_OperPayDocBuy    )  )
    if( IsCur )
      UR_In = Cur2Rub( Operat.IncomeAmount ); 
      UC_In = Operat.IncomeAmount;
      Q_Out = money(Operat.SprvAmount*100);
    else
      R_Out = Operat.OutAmount + Operat.IncTaxValue;
    end;
  /* Продажа платежного документа за рубли */
  elif( Operat.Oper_Ref == CDF_OperPayDocSale )
    if( IsCur )
      R_In  = Cur2Rub( Operat.OutAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      C_In  = Operat.OutAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеровПД( Operat.ID, Колич ); /* вычислим количество */
      Q_Out = money( (Operat.SprvAmount + Колич)*100);
    else
      R_In  = Operat.IncomeAmount - Operat.IncTaxValue;
    end;
  /* Продажа платежеспособной валюты за рубли */
  elif( Operat.Oper_Ref == CDF_OperCurrSale )
    if( IsCur )
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    else
      R_In  = Operat.IncomeAmount - Operat.IncTaxValue;
    end;
/*  Согласно ТЗ 622-01 мемориальные обороты не нужны
    if( R_In > C_Out )
      MR_In = R_In - C_Out;
    else
      MR_Out = C_Out - R_In;
    end;
    Количество ценностей не нужно
    ПолучитьСтрокуСерийНомеровПД( Operat.ID, Q_Out ); /* вычислим количество */
    Q_Out = money( Q_Out * 100 );
*/
  /* Начисление на карту                    */
  elif( Operat.Oper_Ref == CDF_OperCardTake )
    if( ( IsCur ) and ( Operat.IncomeCurr_Ref != {NationalCur} ) )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      C_In  = Operat.IncomeAmount;
      Q_Out = money(Operat.SprvAmount*100);
    elif( Operat.IncomeCurr_Ref == {NationalCur} )
      R_In  = Operat.IncomeAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Снятие с карты                         */
  elif( Operat.Oper_Ref == CDF_OperCardGive )
    if( ( IsCur ) and ( Operat.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    elif( Operat.OutCurr_Ref == {NationalCur} )
      R_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Прием на экспертизу                    */
  /* Прием на инкассо                       */
  /* Прием ПД на экспертизу                 */
  /* Прием ПД на инкассо                    */
  elif( ( Operat.Oper_Ref == CDF_OperExpert        ) or
        ( Operat.Oper_Ref == CDF_OperIncasso       ) or
        ( Operat.Oper_Ref == CDF_OperPayDocExpert  ) or
        ( Operat.Oper_Ref == CDF_OperPayDocIncasso )  )
    if( IsCur )
      UQ_In = Operat.IncomeAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
/*  Количество ценностей не нужно
      ПолучитьСтрокуСерийНомеровПД( Operat.ID, Q_In ); /* вычислим количество */
      Q_In = money( Q_In * 100 );
*/
  /* Конверсия                              */
  elif( Operat.Oper_Ref == CDF_OperCurrConversion )
    if( IsCur )
      if( Operat.IncomeCurr_Ref == КодВалюты )
        R_In  = Cur2Rub( Operat.IncomeAmount );
        C_In  = Operat.IncomeAmount;
        Q_Out = money(Operat.SprvAmount*100);
      elif( Operat.OutCurr_Ref == КодВалюты )
        R_Out = Cur2Rub( Operat.OutAmount );
        C_Out = Operat.OutAmount;
      end;  
    end;
  /* Покупка платежного документа за валюту */
  elif( Operat.Oper_Ref == CDF_OperPayDocBuyCurr )
    if( IsCur )
      UR_In = Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      UC_In = Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Продажа платежного документа за валюту */
  elif( Operat.Oper_Ref == CDF_OperPayDocSaleCurr )
    if( IsCur )
      R_In  = 2*Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      C_In  = 2*Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      ПолучитьСтрокуСерийНомеровПД( Operat.ID, Колич ); /* вычислим количество */
      Q_Out = money( (Operat.SprvAmount + Колич)*100);
    end;
  /* Замена неплатежеспособной валюты       */
  elif( Operat.Oper_Ref == CDF_OperChange )
    if( IsCur )
      UR_In = Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      UC_In = Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Размен валюты                          */
  elif( Operat.Oper_Ref == CDF_OperSplit )
    if( IsCur )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      R_Out = Cur2Rub( Operat.OutAmount );
      C_In  = Operat.IncomeAmount;
      C_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Возврат с инкассо                      */
  /* Возврат ПД с инкассо                   */
  elif( ( Operat.Oper_Ref == CDF_OperReturnIncasso       ) or
        ( Operat.Oper_Ref == CDF_OperPayDocReturnIncasso )  )
    if( IsCur and ( Operat.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    elif( Operat.OutCurr_Ref == {NationalCur} )
      R_Out = Operat.OutAmount;
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Возврат с экспертизы                   */
  /* Возврат ПД с экспертизы                */
  elif( ( Operat.Oper_Ref == CDF_OperReturnExpert        ) or
        ( Operat.Oper_Ref == CDF_OperPayDocReturnExpert  )  )
    /* Возврат денежного эквивалента */
    if( ( Operat.OutTrs_Ref == TrsCash  ) or
        ( Operat.OutTrs_Ref == TrsMonet )  )
      if( IsCur and ( Operat.OutCurr_Ref != {NationalCur} ) )
        R_Out = Cur2Rub( Operat.OutAmount );
        C_Out = Operat.OutAmount;
        Q_Out = money(Operat.SprvAmount*100);
      elif( Operat.OutCurr_Ref == {NationalCur} )
        R_Out = Operat.OutAmount;
        Q_Out = money(Operat.SprvAmount*100);
      end;
    /* Возврат принятой ценности */
    else
      if( IsCur )
        Q_Out = money(Operat.SprvAmount*100);
        UQ_Out= Operat.OutAmount;
      end;
    end;
  /* Проверка на подлинность                */
  elif( Operat.Oper_Ref == CDF_OperCheck )
    if( IsCur )
      Q_Out = money(Operat.SprvAmount*100);
    end;
  /* Отражение излишков                     */
  /* Возмещение недостачи                   */
  elif( ( Operat.Oper_Ref == CDF_OperDetectOverplus    ) or
        ( Operat.Oper_Ref == CDF_OperCompensateDeficit )  )
    if( IsCur and ( Operat.IncomeCurr_Ref != {NationalCur} ) )
      R_In  = Cur2Rub( Operat.IncomeAmount );
      C_In  = Operat.IncomeAmount;
    elif( Operat.IncomeCurr_Ref == {NationalCur} )
      R_In  = Operat.IncomeAmount;
    end;
  /* Отражение недостачи                    */
  /* Выдача излишков                        */
  elif( ( Operat.Oper_Ref == CDF_OperDetectDeficit   ) or
        ( Operat.Oper_Ref == CDF_OperGiveOutOverplus )  )
    if( IsCur and ( Operat.OutCurr_Ref != {NationalCur} ) )
      R_Out = Cur2Rub( Operat.OutAmount );
      C_Out = Operat.OutAmount;
    elif( Operat.OutCurr_Ref == {NationalCur} )
      R_Out = Operat.OutAmount;
    end;

  end;
  SetParm(  0, R_In   );
  SetParm(  1, R_Out  );
  SetParm(  2, MR_In  );
  SetParm(  3, MR_Out );
  SetParm(  4, C_In   );
  SetParm(  5, C_Out  );
  SetParm(  6, MC_In  );
  SetParm(  7, MC_Out );
  SetParm(  8, Q_In   );
  SetParm(  9, Q_Out  );
  SetParm( 10, UR_In  );
  SetParm( 11, UR_Out );
  SetParm( 12, UC_In  );
  SetParm( 13, UC_Out );
  SetParm( 14, UQ_In  );
  SetParm( 15, UQ_Out );

end;

/***************************************************************************
                       Формирование и печать строк отчета
                        по одной валютообменной операции
***************************************************************************/
macro OutLinesOnOperation()
  var
  КурсЦБ,
  NameOperation,
  Sprv31Amount,
  КодВалюты,
  R_In,  R_Out,  MR_In, MR_Out, C_In,  C_Out, MC_In, MC_Out, Q_In,  Q_Out,
  UR_In, UR_Out,                UC_In, UC_Out,               UQ_In, UQ_Out,
  ConvCurr, ConvSum, ConvSumRUR;

  macro ClearSums()
    NameOperation = "";
    R_In   = $0.0;  UR_In   = $0.0;
    R_Out  = $0.0;  UR_Out  = $0.0;
    MR_In  = $0.0;
    MR_Out = $0.0;
    C_In   = $0.0;  UC_In   = $0.0;
    C_Out  = $0.0;  UC_Out  = $0.0;
    MC_In  = $0.0;
    MC_Out = $0.0;
    Q_In   = $0.0;  UQ_In   = $0.0;
    Q_Out  = $0.0;  UQ_Out  = $0.0;
  end;

  macro GetCnvCoinsTurns( ConvCurr, ConvSum, ConvSumRUR )

    ConvCurr   = ANY_CURR;
    ConvSum    = $0;
    ConvSumRUR = $0;

    if( GetTurnover( CDF_TurnCnvCoins ) )
      if  (   (Turn.Cash     == UNSET_CHAR   )
          AND (Turn.Curr_Ref != {NationalCur})
          )
        ConvSum    = abs(Turn.Sum);
        ConvCurr   = abs(Turn.Curr_Ref);
      elif(   (Turn.Cash     == SET_CHAR     )
          AND (Turn.Curr_Ref == {NationalCur})
          )
        ConvSumRUR = abs(Turn.Sum);
      end;
      if( GetNextTurnover( CDF_TurnCnvCoins ) )
        if  (   (Turn.Cash     == UNSET_CHAR   )
            AND (Turn.Curr_Ref != {NationalCur})
            )
          ConvSum    = abs(Turn.Sum);
          ConvCurr   = abs(Turn.Curr_Ref);
        elif(   (Turn.Cash     == SET_CHAR     )
            AND (Turn.Curr_Ref == {NationalCur})
            )
          ConvSumRUR = abs(Turn.Sum);
        end;
      end;
    end;

    SetParm( 0, ConvCurr   );
    SetParm( 1, ConvSum    );
    SetParm( 2, ConvSumRUR );

    if(   ( ConvCurr   != ANY_CURR )
       AND( ConvSum    != $0       )
       AND( ConvSumRUR != $0       )
      )
      return true;
    else
      return false;
    end;

  end;


  КодВалюты = int(Curr.ExternalCode);
  ClearSums();
  NameOperation = GetNameCodif( Operat.Oper_Ref, CDF_Oper );

  /* некоторым функциям нужен СоставРеестра */
  Copy( СоставРеестра, Operat );

  Sprv31Amount = Operat.Sprv31Amount;

  /* Восстанавливаем исходные суммы по операции */
  УчетНекассовыхОборотов( "По операции", Operat.IncomeAmount, Operat.OutAmount );

  /* Заполнить суммы R_In, R_Out, MR_In, MR_Out, C_In ..... */
  Заполнить_суммы_по_операции( R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  
  if( R_In or R_Out or MR_In or MR_Out or C_In or C_Out or MC_In or MC_Out or Q_In or Q_Out or UR_In or UR_Out or UC_In or UC_Out or UQ_In or UQ_Out )
    OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  end;

  if( ( Operat.Oper_Ref == CDF_OperCurrConversion ) and
      ( Operat.OutCurr_Ref == КодВалюты )
    )
    /* для конверсии при отработке второй валюты */
    /* не нужны комисси и налоги                 */
    return;
  end;

  if( GetTurnover( CDF_TurnPComInc ) ) /* процентная от полученной суммы */
    ClearSums();
    NameOperation = "Процентная комиссия";
    if( (Turn.Curr_Ref == КодВалюты) and IsCur )
      Get_Curr_Rate( Turn.Curr_Ref, КурсЦБ ); - использовать GetCurrRate()
      R_In = money( abs(Turn.Sum) * КурсЦБ );
      C_In = abs(Turn.Sum);
    elif( (Turn.Curr_Ref == {NationalCur}) and (not IsCur) )
      R_In = abs(Turn.Sum);
    end;
    if( ( C_In or R_In ) and Sprv31Amount )
      Q_Out = $1;
      Sprv31Amount = Sprv31Amount - 1;
    end;
    if( C_In or R_In )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

  if( GetTurnover( CDF_TurnPComOut ) ) /* процентная от выданной суммы */
    ClearSums();
    NameOperation = "Процентная комиссия";
    if( (Turn.Curr_Ref == КодВалюты) and IsCur )
      Get_Curr_Rate( Turn.Curr_Ref, КурсЦБ ); - использовать GetCurrRate()
      R_In = money( abs(Turn.Sum) * КурсЦБ );
      C_In = abs(Turn.Sum);
    elif( (Turn.Curr_Ref == {NationalCur}) and (not IsCur) )
      R_In = abs(Turn.Sum);
    end;
    if( ( C_In or R_In ) and Sprv31Amount )
      Q_Out = $1;
      Sprv31Amount = Sprv31Amount - 1;
    end;
    if( C_In or R_In )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

  if( GetTurnover( CDF_TurnFix ) )
    ClearSums();
    NameOperation = "Фиксированная комиссия";
    if( (Turn.Curr_Ref == КодВалюты) and IsCur )
      Get_Curr_Rate( Turn.Curr_Ref, КурсЦБ ); - использовать GetCurrRate()
      R_In = money( abs(Turn.Sum) * КурсЦБ );
      C_In = abs(Turn.Sum);
    elif( (Turn.Curr_Ref == {NationalCur}) and (not IsCur) )
      R_In = abs(Turn.Sum);
    end;
    if( ( C_In or R_In ) and Sprv31Amount )
      Q_Out = $1;
      Sprv31Amount = Sprv31Amount - 1;
    end;
    if( C_In or R_In )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

  if( Operat.TaxValue and (not IsCur) )
    ClearSums();
    NameOperation = "Налог";
    R_In = Operat.TaxValue;
    OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  end;

  if( Operat.IncTaxValue and (not IsCur) )
    ClearSums();
    NameOperation = "Подоходный налог";
    R_In = Operat.IncTaxValue;
    OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
  end;

  if( GetCnvCoinsTurns( ConvCurr, ConvSum, ConvSumRUR ) )
    ClearSums();
    NameOperation = "Б\\Н конверсия валютной мелочи";
    if( (ConvCurr == КодВалюты) and IsCur )
      Get_Curr_Rate( ConvCurr, КурсЦБ ); - использовать GetCurrRate()
      MR_In = money( ConvSum * КурсЦБ );
      MC_In = ConvSum;
    elif( not IsCur )
      R_Out = ConvSumRUR;
    end;
    if( MR_In or MC_In or R_Out )
      OutLineExch( NameOperation, R_In, R_Out, MR_In, MR_Out, C_In, C_Out, MC_In, MC_Out, Q_In, Q_Out, UR_In, UR_Out, UC_In, UC_Out, UQ_In, UQ_Out );
    end;
  end;

end;

/***************************************************************************
                   Отчет по одному виду валютообменных операций
                   ( по операциям )
***************************************************************************/
macro ReportOnOneExchangeOperation( TypeOperation )

  var OutCurr, IncCurr,
      Loop;
  var КодВалюты; /* Код валюты ОП */

  КодВалюты = int(Curr.ExternalCode);

  ClearRecord(Operat);
  Operat.Emp_Ref        = Session.Emp_Ref;
  Operat.Sess_Ref       = Session.Number;
  Operat.Oper_Ref       = TypeOperation;
  Operat.State_Ref      = CDF_OperCompleted;/* завершена */
  Operat.OutCurr_Ref    = ANY_CURR;
  Operat.IncomeCurr_Ref = ANY_CURR;
  Operat.Rate_Ref       = 0;

  /* покупка валюты, ПД и неплатежеспособной валюты */
  if(   ( TypeOperation == CDF_OperCurrBuy        ) OR
        ( TypeOperation == CDF_OperPayDocBuy      ) OR
        ( TypeOperation == CDF_OperUnpayCurrBuy   ) )
     Operat.OutCurr_Ref    = OutCurr = {NationalCur};
     Operat.IncomeCurr_Ref = IncCurr = КодВалюты;
  /* продажа валюты и ПД за рубли */
  elif( ( TypeOperation == CDF_OperCurrSale       ) OR
        ( TypeOperation == CDF_OperPayDocSale     ) )
     Operat.OutCurr_Ref    = OutCurr = КодВалюты;
     Operat.IncomeCurr_Ref = IncCurr = {NationalCur};
  /* покупка/продажа ПД за валюту */
  elif( ( TypeOperation == CDF_OperPayDocSaleCurr ) OR
        ( TypeOperation == CDF_OperPayDocBuyCurr  ) OR
  /* проверка на подлинность */
        ( TypeOperation == CDF_OperCheck          ) OR
  /* замена неплатежной валюты */
        ( TypeOperation == CDF_OperChange         ) OR
  /* размен валюты */
        ( TypeOperation == CDF_OperSplit        ) )
     Operat.OutCurr_Ref    = OutCurr = КодВалюты;
     Operat.IncomeCurr_Ref = IncCurr = КодВалюты;
  /* принятие на инкассо и экспертизу */
  elif( ( TypeOperation == CDF_OperExpert         ) OR
        ( TypeOperation == CDF_OperIncasso        ) OR
        ( TypeOperation == CDF_OperPayDocExpert   ) OR
        ( TypeOperation == CDF_OperPayDocIncasso  ) OR
  /* получение по пластиковым картам */
        ( TypeOperation == CDF_OperCardTake     ) )
     Operat.OutCurr_Ref    = OutCurr = ANY_CURR;
     Operat.IncomeCurr_Ref = IncCurr = КодВалюты;
  /* конверсия */
  elif  ( TypeOperation == CDF_OperCurrConversion ) 
     Operat.OutCurr_Ref    = OutCurr = ANY_CURR;
     Operat.IncomeCurr_Ref = IncCurr = ANY_CURR;
  /* возврат с инкассо и экспертизы */
  elif( ( TypeOperation == CDF_OperReturnExpert        ) OR
        ( TypeOperation == CDF_OperReturnIncasso       ) OR
        ( TypeOperation == CDF_OperPayDocReturnExpert  ) OR
        ( TypeOperation == CDF_OperPayDocReturnIncasso ) OR
  /* выдача по пластиковым картам */
        ( TypeOperation == CDF_OperCardGive       ) )
     Operat.OutCurr_Ref    = OutCurr = КодВалюты;
     Operat.IncomeCurr_Ref = IncCurr = ANY_CURR;
  end;

  Loop = GetGE( Operat );

  While( ( Loop == True ) AND
         (Operat.Emp_Ref        == Session.Emp_Ref)         AND
         (Operat.Sess_Ref       == Session.Number)          AND
         ( ( Operat.State_Ref   == CDF_OperCompleted )  OR
           ( Operat.State_Ref   == CDF_OperInReestr  ) )    AND
         (Operat.Oper_Ref       == TypeOperation)
       )

    if( (
          ( (OutCurr != ANY_CURR) AND (Operat.OutCurr_Ref == OutCurr) )  OR
          ( OutCurr == ANY_CURR )
        )
         AND
        (
          ( (IncCurr != ANY_CURR) AND (Operat.IncomeCurr_Ref == IncCurr) ) OR
          ( IncCurr == ANY_CURR )
        )
      )

      if( ( Operat.Oper_Ref != CDF_OperCurrConversion ) OR /* или не Конверсия */
          ( Operat.IncomeCurr_Ref == КодВалюты ) OR        /* или вал. прихода нужная */
          ( Operat.OutCurr_Ref    == КодВалюты )           /* или вал. расхода нужная */
        )
        /* напечатаем заголовки (если надо) */
        OutExchangeHeaders( TypeOperation );
  
        /* начечатаем строку (несколько строк) по валютообменной операции */
        OutLinesOnOperation();

      end;

    end;

    Loop = Next( Operat );

  end;

end;

*/