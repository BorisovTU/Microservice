/*
$Name:               wf_common.mac
$Module:             ÅÎ
$Description:        Îáùèå ôóíêöèè
*/


import rcw, BankInter;

private file person(person) key 0;

private const TP_DEP = "",
              TP_OPER = "",
              TP_SHIFT_CHIEF = "‘";

private const TP_DESK_NO = "";

private const CONEXT_ROLES = "roles";

private const ROLE_OPER = "oper",
              ROLE_CASHIER = "cashier",
              ROLE_REVIEWER = "reviewer";
   
private macro getRegValue(key: string)
  var prm;
  GetRegistryValue(key, 0, prm);
  return prm;
end;


const xpdlDir = getRegValue("BANK_INI\\™ˆ… €€Œ…’›\\„ˆ…Š’ˆˆ\\XMLDICDIR");
private const textDir = getRegValue("BANK_INI\\™ˆ… €€Œ…’›\\„ˆ…Š’ˆˆ\\TEXTDIR");
private const workDir = getRegValue("BANK_INI\\™ˆ… €€Œ…’›\\„ˆ…Š’ˆˆ\\WORKDIR");
private const scriptDir = xpdlDir + "\\..\\Script";

private var jvm = createObject("rsjvm", "TJavaHost");
private var {oper};

private macro isIn(value)
  var i = 1;
  var anotherValue;
  while (getParm(i, anotherValue))
    if (value == anotherValue)
      return true;
    end;
    i = i + 1; 
  end;
  return false;
end;

private macro findPerson
  person.oper = {oper};
  if (not getEq(person))
    runError("’¥ªãé¨© ¯®«ì§®¢ â¥«ì ®âáãâáâ¢ã¥â ¢ á¯à ¢®ç­¨ª¥");
  end;
end;

private macro createDefaultContext
  var builder = jvm.CreateJavaObject("ru.softlab.rsretail.workflow.util.ContextBuilder");

  findPerson;
  if (isIn(person.cTypePerson, TP_DEP, TP_OPER, TP_SHIFT_CHIEF))
    builder.setMultipleString(CONEXT_ROLES, ROLE_OPER);
    if (person.cTypeInDesk != TP_DESK_NO)
      builder.setMultipleString(CONEXT_ROLES, ROLE_CASHIER);
    end;
  else
    builder.setMultipleString(CONEXT_ROLES, ROLE_REVIEWER);
  end;

  return builder.getContext;
end;

private macro createFacade
  const wfSubDir = "\\Workflow";

  var facade = jvm.CreateJavaObject("ru.softlab.rsretail.workflow.util.WorkflowFacade");
  facade.setPersistenceManager("ru.softlab.rsretail.workflow.util.RetailPersistenceManager");
  facade.setCommonEventHandler("ru.softlab.rsretail.workflow.util.RetailWorkflowEventHandler");
  facade.setXpdlDirectory(xpdlDir);
  facade.setScriptDirectory(scriptDir);
  facade.setSourceDirectory(workDir + wfSubDir + "\\src");
  facade.setClassFileDirectory(workDir + wfSubDir + "\\classes");
  facade.setLogDirectory(textDir + wfSubDir);

  return facade;
end;

private macro createSpringContext
  return jvm.CreateJavaObject("ru.softlab.rsretail.workflow.spring.WorkerProcessContextLoader").getContext;
end;

//
// ÎÁùèå ôóíêöèè
//

macro createProcess(className)
  return jvm.CreateJavaObject(className);
end;

macro getJvm
  return jvm;
end;

macro reportRsComError(error)
  if (isEqClass("TRsComErr", error))
    var count = error.count; 
    var s = "";
    var first = 0;
    if (count > 1)
      first = 1;      // à®¯ãáâ¨âì áâà®ªã " áè¨à¥­­ ï ®è¨¡ª  RS-COM"
    end;
    var i;
    for (i, first, count)
      if (i > 0)
        s = s + "|";
      end;
      s = s + error.message(i);
    end;

    msgBox(s);
  end;
end;

//
// Èíèöèàëèçàöèÿ
//

var springContext = createSpringContext;

//
// Îáùèå ïåğåìåííûå
//


var wf = createFacade;
//var wfDefaultContext = createDefaultContext;
macro wfDefaultContext
  return createDefaultContext;
end;
