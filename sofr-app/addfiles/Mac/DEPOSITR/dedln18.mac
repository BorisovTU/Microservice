/***************************************************************************\
| DEDLN18.MAC  RS-Retail Автор: Саввин Д.                                   |
| Для шага "Ограничения при приходе"(?) операций открытия вкладов школьни-  |
| ков.                                                                      |
\***************************************************************************/
 import deprintr;
/* Макрос устанавливает дату окончания школьного договора равной дате
 рождения + 18 лет */

 var {curdate};

/*---------- Инициализируемые структуры ---------------------------------*/
 record ALG_DEPOSITOR("depositr.dbt");
 record ALG_SBDEPDOC("sbdepdoc.dbt");
 record ALG_PARAM("sb_algop.dbt");
 var    DC = TClientList;

/*---------- Коды возврата макроса --------------------------------------*/
 const  OK_RES   =  0,  /* продолжать проводку */
        SKIP_RES =  1,  /* пропустить выполнение предопределенного модуля */
        END_RES  =  2,  /* завершить проводку */
        ERR_RES  = -1;  /* аваpийно завершить проводку */

/*-----------------------------------------------------------------------*/
 var DatGR=date(0,0,0), day=0, mon=0, year=0;

 macro BD(CodClient)
   if (DC.GetRecord (CodClient))
     return DC.CurRec.rec.Born;
   else
     msgbox("Не найден клиент счета");
     ALG_RESULT=ERR_RES;
     exit(1);
   end;
 end;

/*-----------------------------------------------------------------------*/
DateSplit(BD(ALG_DEPOSITOR.CodClient),day,mon,year);
if ( ( day == 0 )  OR  ( mon == 0 )  OR  ( year == 0 ) )
    MsgBox( "Не задана дата рождения.|Открыть счет невозможно" );
    ALG_RESULT=ERR_RES;
    return;
end;
DatGR=date(day,mon,year+18);
if ( DatGR <= {curdate} )
    MsgBox( "Дата совершеннолетия меньше даты открытия счета.|Открыть счет невозможно" );
    ALG_RESULT=ERR_RES;
    return;
end;
ALG_DEPOSITOR.End_DateDep=DatGR;
ALG_DEPOSITOR.DateEndPerc=DatGR;
ALG_RESULT=OK_RES;
ALG_UPDATE=1;

return;
