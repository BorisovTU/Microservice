/******************************************************************************

  MacroProgram:  CheckBal.mac
  Created:       02/13/2004 9:36
  Author:        LAA

  Requested:     Вспомогательный макрос для контроля за окрытием счетов с
                 измененными балансовыми счетами. Ругается при неверной дате и несовпадения
                 дат
  Comments:  Должен вернуться в параметр ALG_RESULT значения
             618 - Открытие счетов в последе для вида вклада запрещено
             OK_RES   продолжать проводку                            
             SKIP_RES пропустить выполнение предопределенного модуля 
             END_RES  завершить проводку                             
             ERR_RES  аваpийно завершить проводку                    

  *****************************************************************************
  History:

  13-02-2004 LAA created this macros
******************************************************************************/
import deprintr,alg_vars;

var day  = 0,
    mon  = 0,
    year = 0;

/* :) позаимствовано с большинства дистрибутивных макросов*/
macro DaysInYear( Year )
    if ( Year / 4.0 == Int( Year / 4 ) )   /* Ламерство, знаю, но если этот макрос */
      return 366;                          /* доживет до 2100 года, править его уже */
    else                                   /* явно буду не я */
      return 365;
    end;
end;

macro ThisDate_BigBag( Year )
    if (mon == 2)
        RETURN TRUE;
    else
        if ((year == 365) and (mon == 12) and ((day == 30) OR (day == 31)))
            RETURN TRUE;
        elif ((year == 366) and (mon == 12) and (day == 31))
            RETURN TRUE;
        end;
    end;
    RETURN FALSE;
end;

macro Check_code(code)
    if (StrFor(GetProgramID) == "П")
        Return 618;
    else
        Return ERR_RES;
    end;
end;

macro Check_Bal_Account(SB_DTYP)

var CODE;

    /*дата операции*/
    DateSplit(ALG_DEPOSITOR.Open_Date, day, mon, year);
    year = DaysInYear(year); /*определение высокосности*/
    /* отладка
    MsgBox("ThisDate_BigBag(year) = ",ThisDate_BigBag(year));
    */
    
    /*рубли*/
    if   ((sb_dtyp.Kind == "Депоз.Фв 1 м") and not ThisDate_BigBag(year))
        if ( StrFor(GetProgramID) != "П" )
          MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Депозит Сбербанка на 1 мес. и 1 день|-----------------------------------------|                  ESC - отмена операции");
        end;
        Code = Check_code(CODE);

    elif ((sb_dtyp.Kind == "Депоз.на 1 м") and ThisDate_BigBag(year))
        if ( StrFor(GetProgramID) != "П" )
          MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Депозит Сбербанка на 1 месяц|-----------------------------------------|                  ESC - отмена операции");
        end;
        Code = Check_code(CODE);

/*    elif ((sb_dtyp.Kind == "Депоз.Фв 3 м") and not ThisDate_BigBag(year))*/
    elif (sb_dtyp.Kind == "Депоз.Фв 3 м")
        if ((mon == 2) and (year == 365))
            []
        else
            if ( StrFor(GetProgramID) != "П" )
              MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Депозит Сбербанка на 3 мес. и 1 день|-----------------------------------------|                  ESC - отмена операции");
            end;
            Code = Check_code(CODE);
        end;

/*    elif ((sb_dtyp.Kind == "Депоз.на 3 м") and ThisDate_BigBag(year))*/
    elif (sb_dtyp.Kind == "Депоз.на 3 м")
         if ((mon == 2) and (year == 365))
            if ( StrFor(GetProgramID) != "П" )
              MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Депозит Сбербанка на 3 месяца|-----------------------------------------|                  ESC - отмена операции");
            end;
            Code = Check_code(CODE);
         end;

/*    elif ((sb_dtyp.Kind == "Пенс.депФв3м") and not ThisDate_BigBag(year))*/
    elif (sb_dtyp.Kind == "Пенс.депФв3м")
        if ((mon == 2) and (year == 365))
            [];
        else
            if ( StrFor(GetProgramID) != "П" )
              MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Пенсионный депозит Сбербанка на 3 мес. и 1 день|-----------------------------------------|                  ESC - отмена операции");
            end;
            Code = Check_code(CODE);
        end;

/*    elif ((sb_dtyp.Kind == "Пенс.деп. 3м") and ThisDate_BigBag(year))*/
    elif (sb_dtyp.Kind == "Пенс.деп. 3м")
        if ((mon == 2) and (year == 365))
            if ( StrFor(GetProgramID) != "П" )
              MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Пенсионный депозит Сбербанка на 3 месяца|-----------------------------------------|                  ESC - отмена операции");
            end;
            Code = Check_code(CODE);
        end;

    /*валюта*/
    elif ((sb_dtyp.Kind == "Дол.деп.фв1м") and not ThisDate_BigBag(year))
        if ( StrFor(GetProgramID) != "П" )
          MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Доллар депозит Сбербанка на 1 мес. и 1 день|-----------------------------------------|                  ESC - отмена операции");
        end;
        Code = Check_code(CODE);

    elif ((sb_dtyp.Kind == "Дол.депоз 1м") and ThisDate_BigBag(year))
        if ( StrFor(GetProgramID) != "П" ) 
          MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Доллар депозит Сбербанка на 1 месяц|-----------------------------------------|                  ESC - отмена операции");
        end;
        Code = Check_code(CODE);

    elif ((sb_dtyp.Kind == "ЕВРО-депФв1м") and not ThisDate_BigBag(year))
        if ( StrFor(GetProgramID) != "П" )
          MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Евро депозит Сбербанка на 1 мес. и 1 день|-----------------------------------------|                  ESC - отмена операции");
        end;
        Code = Check_code(CODE);

    elif ((sb_dtyp.Kind == "ЕВРО-деп. 1м") and ThisDate_BigBag(year))
        if ( StrFor(GetProgramID) != "П" )
          MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name, "|запрещено! Воспользуйтесь вкладом:| Евро депозит Сбербанка на 1 месяц|-----------------------------------------|                  ESC - отмена операции");
        end;
        Code = Check_code(CODE);
    end;

    Return Code;
END;