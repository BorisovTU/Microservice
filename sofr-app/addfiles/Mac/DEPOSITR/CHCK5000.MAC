/**************************************************************************\
*  ---------------                                                         *
*  R-Style Softlab                                                         *
*  ---------------                                                         *
*  RS-Retail                                                               *
*                                                                          *
*  Определение курса валюты за число                                       *
*                                                                          *
*  Лебедев С.В.                                                            *
*  18.07.2006                                                              *
\**************************************************************************/

import DeprIntr, alg_vars, cur_rate;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro defineResidentAccount( code )

  var ClientList = TClientList;

  if ( ClientList.GetRecord( code ) )
    return ClientList.CurRec.Rec.NotResident;
  else
    return "";
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/

  var summaOut = $0L;
  var cbRate = 1.0;
  var usdCbRate = 1.0;

  if ( ( ALG_SBDEPDOC.TypeOper == 63 ) and 
       ( ALG_SBDEPDOC.ApplType == 32 ) and 
       ( ALG_SBDEPDOC.OutSum > 0 ) and 
       ( defineResidentAccount( ALG_DEPOSITOR.CodClient ) == "" ) )

    if ( ALG_SBDEPDOC.Code_Currency == 0 )
      FindCurrRate( 1, 1 /* Основной курс*/, ALG_SBDEPDOC.Date_Document, usdCbRate, null, null, null );
      summaOut = Round( Money( ALG_SBDEPDOC.OutSum / usdCbRate ), 2 );
    elif ( ALG_SBDEPDOC.Code_Currency == 1 )
      summaOut = ALG_SBDEPDOC.OutSum;
    elif ( ALG_SBDEPDOC.Code_Currency > 1 )
      FindCurrRate( ALG_SBDEPDOC.Code_Currency, 1 /* Основной курс*/, ALG_SBDEPDOC.Date_Document, cbRate, null, null, null );
      FindCurrRate( 1, 1 /* Основной курс*/, ALG_SBDEPDOC.Date_Document, usdCbRate, null, null, null );
      summaOut = Round( Money( ALG_SBDEPDOC.OutSum * cbRate / usdCbRate ), 2 );
    end;

    if ( summaOut > 5000 )
      MsgBox( "Сумма больше 5000 долларов США|Проверьте подтверждающие документы" );
    end;

  end;

  ALG_RESULT = OK_RES;

end;
