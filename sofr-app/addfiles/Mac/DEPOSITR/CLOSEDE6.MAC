/***************************************************************************\
| CLOSEDE6.MAC - макрос закрытия счета для вида вклада "Спец.рублевый"      |
|                                                     Зубов В.Ю. 03-12-97   |
\***************************************************************************/
/* При закрытии счета вычисляем сумму компенсации по специальной формуле */

import deprintr,opercode,IsSrvDoc,alg_vars, PmPropUtil;


/*---------- Инициализируемые структуры ---------------------------------*/
 record FINISH_SBDEPDOC ("sbdepdoc.1");


/*---------- Коды возврата макроса --------------------------------------*/
 const  ОТКАТ_С_РЕЗУЛЬТАТОМ = -777; /* Откат с получением процентов */

Var
   Результат = 0,
   ErrMsg = "";

file       doc("sbdepdoc.dbt");
record  tmpDoc("sbdepdoc.1");
ALG_RESULT = ERR_RES; /* Заранее инициализируем код возврата */

var dRate = $0L;
var rateUSD = $0L;
/* Запрашиваем курс ЦБ */
// if(not GetMoney(rateUSD,"Введите курс USD на "+String({curdate})))
if( GetDouble(dRate,"Введите курс USD на "+String({curdate})))
  rateUSD = MoneyL( dRate );
else
  return;
end; /* IF */


macro CloseDep
Var NullDate = Date(0,0,0),
    RestDate = Date(27,11,1995),
    С_Панелью, UseMaxDate, NoPrint,
    rest = $0L, CompSum = $0L;
  /*MSGBOX("Rate="+String(RateUSD));*/
  /* Ищем остаток вклада на RestDate */
  /* В сконвертированной базе все равно его не найдем. Берем остаток по счету */
  Rest = ALG_DEPOSITOR.Sum_Rest;
  /*
  KeyNum(doc,2);
  doc.Referenc = ALG_DEPOSITOR.REferenc;
  2doc.DepDate_Document = RestDate;
  doc.NumDayDoc = 0;

  if( GetGE(doc) AND (doc.Referenc == ALG_DEPOSITOR.Referenc))
    rest = doc.Rest;
  else
    Результат = -1;
    ErrMsg = "Не найден остаток на "+String(restDate);
    return;
  end;
  */
  /*MSGBOX("Rest="+String(Rest));*/
  /* Рассчитываем сумму компенсации */
  CompSum = Money(Rest * RateUSD / 467.964L);
  /*MSGBOX("CompSum="+String(CompSum));*/
  /* Причисляем сумму */
  ClearRecord(tmpDoc);
  tmpDoc.Referenc         = ALG_SBDEPDOC.Referenc;
  tmpDoc.IsCur            = ALG_SBDEPDOC.IsCur;
  tmpDoc.FNCash           = ALG_SBDEPDOC.FNCash;
  tmpDoc.RealFNCash       = ALG_SBDEPDOC.RealFNCash;
  tmpDoc.Account          = ALG_DEPOSITOR.Account;
  tmpDoc.Oper             = {oper};
  tmpDoc.Type_Account     = ALG_SBDEPDOC.Type_Account;
  tmpDoc.Code_Currency    = ALG_SBDEPDOC.Code_Currency;
  tmpDoc.CodClient        = ALG_SBDEPDOC.CodClient;
  tmpDoc.YesSbook         = "X";
  tmpDoc.Date_Document    = ALG_SBDEPDOC.Date_Document;
  tmpDoc.DepDate_Document = ALG_SBDEPDOC.DepDate_Document;
  tmpDoc.Author           = ALG_SBDEPDOC.Author;
  tmpDoc.ApplType         = 10; /* Зачисление компенсации */
  tmpDoc.InSum            = CompSum;

  С_Панелью  = 0;
  UseMaxDate = 1;
  NoPrint    = 1;

  ClearRecord(ALG_OPERPRM);
  ALG_OPERPRM.Account         = ALG_DEPOSITOR.Account;
  ALG_OPERPRM.Type_Account    = ALG_DEPOSITOR.Type_Account;
  ALG_OPERPRM.Code_Currency   = ALG_DEPOSITOR.Code_Currency;
  ALG_OPERPRM.Type_Oper       = Зачисление_В_Пак_Режиме;
  ALG_OPERPRM.Show_Panel      = С_Панелью;
  ALG_OPERPRM.UseMaxDate      = UseMaxDate;
  ALG_OPERPRM.NoPrint         = NoPrint;
  ALG_OPERPRM.NonCashCommission = ALG_PARAM.prmI;
  ALG_OPERPRM.TypeComplexOper = ALG_PARAM.NumOpert;

  Результат = Выполнение_Операции(ALG_OPERPRM,tmpDoc);

  if(Результат != 0)
    ErrMsg = "2. Ошибка при списании "+String(Результат);
    return;
  end; /* IF */

  /*MSGBOX("Ok!!!");*/
  ALG_RESULT = OK_RES; /* Все Ok */
  if((ALG_PARAM.prmC=="X") and (Результат==0))
    ALG_PARAM.prmD=$0L;
    Результат=ОТКАТ_С_РЕЗУЛЬТАТОМ;
  end;
end;

macro TrnProc

  CloseDep;
  if(Результат != 0)
    ALG_RESULT = ERR_RES;
    AbortTrn;
  end;
end;

  LoopInTrn(TRUE);
  Copy(FINISH_SBDEPDOC,ALG_SBDEPDOC);
  if (NOT ProcessTrn( 1, "TrnProc", doc))
    if (Результат != ОТКАТ_С_РЕЗУЛЬТАТОМ)
      ALG_RESULT = ERR_RES;
      Результат = 4714;
    end;
  end;
  if((ALG_PARAM.prmC=="X") and (Результат==ОТКАТ_С_РЕЗУЛЬТАТОМ))
    ALG_RESULT = OK_RES;
    ALG_UPDATE = 0;
  end;
  if((ErrMsg != "") and (not InFCGroupOpRun()))
    MsgBox(ErrMsg);
  end;

end;
