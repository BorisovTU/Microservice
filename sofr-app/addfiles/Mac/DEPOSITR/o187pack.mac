
/* Пакетная ф.187 */

import F187Comm, OperCode;

file Ref                  ("rsbedref.tmp") key 1;
file Doc                  ("sbdepdoc.dbt") key 3 write;
file Dep                  ("depositr.dbt") key 8;
record Doc1               ("sbdepdoc.1");


const
  SIGNORDER         = 2,    /* значение поля sb_edref.sign */
  PROCESS_ORDERS      = "Обрабатываем ордера...";

MACRO getFirstOrder(docNumber,ordersCount,ref,doc)

 var stat;

 docNumber   = 1;  SetParm(0,docNumber);
 ordersCount = 0;  SetParm(1,ordersCount);

 ReWind(ref);

 ClearRecord(ref);
 ref.IsCur = NumFlagCur;
 ref.SignRec = SIGNORDER;
 stat = GetGE(ref);
 if (stat)
   if ((ref.IsCur   == NumFlagCur) AND
       (ref.SignRec == SIGNORDER )     )
     doc.iApplicationKind = ref.ApplicationKind;
     doc.ApplicationKey = ref.ApplicationKey;
     stat = GetEQ(doc);
   else
     stat = False;
   end;
 end;

 return stat;

END;

MACRO getNextOrder(docNumber,ordersCount,ref,doc)

 var stat;

 SetParm(0,docNumber);

 stat = Next(ref);
 if (stat)
   if ((ref.IsCur   == NumFlagCur) AND
       (ref.SignRec == SIGNORDER ) )
     doc.iApplicationKind = ref.ApplicationKind;
     doc.ApplicationKey = ref.ApplicationKey;
     stat = GetEQ(doc);
     if (stat)
       if (((doc.OutSum ==0 )      AND (doc.inSum == 0)) OR
           ((doc.OutSum !=0 )      AND (doc.inSum != 0)) OR
           ( doc.VidDoc != 0                           )   )
       else
         docNumber = docNumber +1; SetParm(0,docNumber);
       end;
     end;
   else
     stat = False;
   end;
 end;

 return stat;

END;

MACRO printForm187OrdersPack

 var
    numberOfRecords,
    ordersCount = 0,
    docNumber   = 1,
    thereIsOrder,
    lastOrderProcessed = False;
 var RecCount = 0;
 var stat;

 /* Подсчет количества записей */
 ReWind(ref);
 ref.IsCur = NumFlagCur;
 ref.SignRec = SIGNORDER;
 stat = GetEQ(ref);
 while (stat)
   if ((ref.IsCur   == NumFlagCur) AND
       (ref.SignRec == SIGNORDER ) )
     doc.iApplicationKind = ref.ApplicationKind;
     doc.ApplicationKey = ref.ApplicationKey;
     if (GetEQ(doc))
       if (((doc.OutSum ==0 )      AND (doc.inSum == 0)) OR
           ((doc.OutSum !=0 )      AND (doc.inSum != 0)))
       else
         RecCount = RecCount + 1;
       end;
     end;
     stat = Next(ref);
   else
     stat = False;
   end;
 end;

 initProgress(RecCount,PROCESS_ORDERS,PROCESS_ORDERS);
 thereIsOrder = getFirstOrder(docNumber,ordersCount,ref,doc);
 docNumber = 0;
 while (thereIsOrder)
    if (((doc.OutSum ==0 )      AND (doc.inSum == 0)) OR
        ((doc.OutSum !=0 )      AND (doc.inSum != 0)))
    else
      UseProgress(docNumber);
    end;
    if (( ( Doc.TypeOper == Списание_По_Раз_Поруч ) or ( Doc.TypeOper == Списание_По_Длит_Поруч ) )
        and NeedPrintOrder187(Doc))
      Dep.Referenc=Doc.Referenc;
      if ( not GetEQ(Dep) )
        Dep.Account = "*** Не найден ! ***";
      end;
      DefOutputFields;

      if ( Index( Dep.UserTypeAccount, "Ф" ) != 0 )  /* Счета типа "Ф" */
        sKNF = "KNF" + String( Doc.KNFCode );
      else
        sKNF = "";
      end;

      INN = plan.CP_INN;

      PrintOrder;
      PrintLn( StrFor( 12 ) );
      doc.YesForm="X";
      Update(doc);
    end;
    thereIsOrder = getNextOrder(docNumber,ordersCount,ref,doc);
 end;
 remProgress();

END;

  var
    TxtDir=GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true );

  Open ( Ref, "rsbedref.tmp" );
  CheckPrn;
  SetRecordAddr( Doc1, Doc, 0, 0, true );
  Init( Dep, Doc1 );
  printForm187OrdersPack;
  ExitMacro;
end;
