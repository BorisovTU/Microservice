/*
$Name: sess179.mac
$Module: Обслуживание физ лиц
$Description: выгрузка/загрузка
*/
import CommonInter;

private var ComSpec;
private var ImportDir = GetRegVal( "RS-RETAIL\\INI\\ДИРЕКТОРИИ\\IMPORTMESDIR", true );
var ErrCode, ErrText;

macro ConvertClient():bool

  file old ( "depclnt.old", "sess179.def" ) key 9999;
  file new ( "depclnt.dbt", "sess179.def" ) write;
  var Name = "";

  GetParm( 0, Name );

  message( "Конвертация файла depclnt" );
  println( "Конвертация файла depclnt" );

  DelFile( ImportDir + Name + ".old" );
  if ( Run( ComSpec, "/C ren " + ImportDir + Name + ".dbt " + Name + ".old" ) )
    println( "Не удалось переименовать файл " + Name );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось создать файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( old, ImportDir + Name + ".old" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  var rec = 0;

  ReWind( old );
  while ( Next( old ) )
    Copy( new, old );
    if ( new.PersIDType == 8 )  /* Временное удостоверение личности */
      new.PersIDType = 14;      /* Новое значение вида удостоверения */
    end;
    if ( new.PersIDType == 9 )  /* Прочее */
      new.PersIDType = 17;      /* Новое значение вида удостоверения */
    end;
    if ( Insert( new ) )
      rec = rec + 1;
    else
      println( "\n Ошибка при копировании: ",
               old.CodClient, " - ",
               old.Sname, " - ",
               old.Name, " - ",
               old.Pname );
      ErrCode = Status( ErrText );
      println( ErrCode, ": ", ErrText );
    end;
  end;

  if ( rec == 0 )
    println( "\n Не скопировано ни одной записи в файле " );
  else
    println( "\n Скопировано записей: ", rec );
  end;
  println( "" );
  message( "" );
end;

macro ConvertTrust():bool

  file old ( "sbtrast.old", "sess179.def" ) key 9999;
  file new ( "sbtrast.dbt", "sess179.def" ) write;
  var Name = "";

  GetParm( 0, Name );

  message( "Конвертация файла sbtrast" );
  println( "Конвертация файла sbtrast" );

  DelFile( ImportDir + Name + ".old" );
  if ( Run( ComSpec, "/C ren " + ImportDir + Name + ".dbt " + Name + ".old" ) )
    println( "Не удалось переименовать файл " + Name );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось создать файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( old, ImportDir + Name + ".old" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  var rec = 0, refID;

  macro FormFirstTrastRef():integer
  
   file trast( "sbtrast.dbt" ) key 4;
   var ref = 1;
   
   trast.RefID = 1000000000;
   if( getLE( trast ) )
     ref = trast.RefID + 1;
   end;
   return ref;
  end;

  refID = FormFirstTrastRef();
  ReWind( old );
  while ( Next( old ) )
    Copy( new, old );
    new.RefID = refID;  /* Уникальный идентификатор */
    new.RefIDLink = 0;
    new.ReTrast   = StrFor(0);
    if ( Insert( new ) )
      refID = refID + 1;
      rec = rec + 1;
    else
      println( "\n Ошибка при копировании: ",
               old.Referenc, " - ", old.VidDoc, " - ", old.CodClient );
      ErrCode = Status( ErrText );
      println( ErrCode, ": ", ErrText );
    end;
  end;

  if ( rec == 0 )
    println( "\n Не скопировано ни одной записи в файле " );
  else
    println( "\n Скопировано записей: ", rec );
  end;
  println( "" );
  message( "" );
end;

macro ConvertTrnf():bool

  file cntr( "trn_cntr.dbt" ) key 0 write;

  file old ( "trn_payf.old", "sess179.def" ) key 9999;
  file new ( "trn_payf.dbt", "sess179.def" ) write;
  var Name = "";

  GetParm( 0, Name );

  message( "Конвертация файла trn_payf" );
  println( "Конвертация файла trn_payf" );

  DelFile( ImportDir + Name + ".old" );
  if ( Run( ComSpec, "/C ren " + ImportDir + Name + ".dbt " + Name + ".old" ) )
    println( "Не удалось переименовать файл " + Name );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось создать файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( old, ImportDir + Name + ".old" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  var rec = 0;

  ReWind( old );
  while ( Next( old ) )
    ClearRecord( cntr );
    cntr.NumberContract = old.NumberContract;
    if ( NOT getEQ( cntr ) )
      /*
      println( "Не найден договор ", old.NumberContract );
      ErrCode = Status( ErrText );
      println( ErrCode, ": ", ErrText ); */
      cntr.GroupID         =  0;
      cntr.CodClientRepres =  0;
      cntr.NameBusines     = "";
      cntr.AdressBusines   = "";
      cntr.NumberTaxPayer  = "";
      cntr.MFO_Busines     = "";
      cntr.CorAcc_Busines  = "";
      cntr.Account_Busines = "";
    end;
    Copy( new, old );
    new.GroupID         = cntr.GroupID;
    new.CodClientRepres = cntr.CodClientRepres;
    new.TrustFlag       = StrFor(0);
    new.NameBusines     = cntr.NameBusines;
    new.AddressBusines  = cntr.AdressBusines;
    new.NumberTaxPayer  = cntr.NumberTaxPayer;
    new.MFO_Busines     = cntr.MFO_Busines;
    new.CorAcc_Busines  = cntr.CorAcc_Busines;
    new.Account_Busines = cntr.Account_Busines;
    if ( Insert( new ) )
      rec = rec + 1;
    else
      println( "\n Ошибка при копировании: ",
               old.NumberContract, " - ",
               old.Num_PayMessage, " - ",
               old.AutoKey );
      ErrCode = Status( ErrText );
      println( ErrCode, ": ", ErrText );
    end;
  end;

  if ( rec == 0 )
    println( "\n Не скопировано ни одной записи в файле " );
  else
    println( "\n Скопировано записей: ", rec );
  end;
  println( "" );
  message( "" );
end;

// закомментировано при удалении таблицы ddesk_rec_dbt по ##197859, 198467
/*
macro ConvertDeskRec():bool

  file new ( "desk_rec.dbt", "sess179.def" ) write;
  var Name = "";

  GetParm( 0, Name );

  message( "Конвертация файла desk_rec" );
  println( "Конвертация файла desk_rec" );

  DelFile( ImportDir + Name + ".old" );
  if ( Run( ComSpec, "/C ren " + ImportDir + Name + ".dbt " + Name + ".old" ) )
    println( "Не удалось переименовать файл " + Name );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось создать файл " + Name );
    return FALSE;
  end;

  Run( ComSpec, "/C butil -copy " + ImportDir + Name + ".old " + ImportDir + Name + ".dbt > nul" );
  println( "" );
  message( "" );
end;
*/

macro ConvertDepDoc():bool

  file old ( "sbdepdoc.dbt", "sess179.def" ) key 9999;
  file new ( "sbdepdoc.dbt" ) write;
  const OP_PUTCOMP = 74;  /* Компенсации */
  
  const BIT_FLAG_UNCASH  = 31,  /* Флаг безналичного платежа */
        BIT_FLAG_COMPENS = 30;  /* Флаг компенсации          */
  var Name = "";

  GetParm( 0, Name );

  message( "Конвертация файла sbdepdoc" );
  println( "Конвертация файла sbdepdoc" );

  DelFile( ImportDir + Name + ".old" );
  if ( Run( ComSpec, "/C ren " + ImportDir + Name + ".dbt " + Name + ".old" ) )
    println( "Не удалось переименовать файл " + Name );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось создать файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( old, ImportDir + Name + ".old" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  if ( NOT Open( new, ImportDir + Name + ".dbt" ) )
    println( "Не удалось открыть файл " + Name );
    return FALSE;
  end;

  var rec = 0;

  /* Конвертация файла sbdepdoc.dbt:проставляются флаги исп. поля ListTransfer */
  ReWind( old );
  while ( Next( old ) )
    Copy( new, old );
    if ( new.ListTransfer != 0 )
      if ( new.TypeOper == OP_PUTCOMP )
        /* Компенсация */
        SetBitFlag( new.Flags, BIT_FLAG_COMPENS, 1 );
      else
        /* Безналичные перечисления */
        SetBitFlag( new.Flags, BIT_FLAG_UNCASH, 1 );
      end;
    end;
    if ( Insert( new ) )
      rec = rec + 1;
    else
      println( " Ошибка при копировании: ",
               old.iApplicationKind, " - ", old.ApplicationKey );
      ErrCode = Status( ErrText );
      println( ErrCode, ": ", ErrText );
    end;
  end;

  if ( rec == 0 )
    println( "\n Не скопировано ни одной записи в файле " );
  else
    println( "\n Скопировано записей: ", rec );
  end;
  println( "" );
  message( "" );
end;

macro CreateOperations():bool

  file lnk ( "sb_casln.dbt", "sess179.def" ) key 9999;
  file doc ( "sbdepdoc.dbt" ) key 3;
  file op  ( "ret_op.dbt", "sess179.def"   ) write;
  file ob  ( "opobject.dbt", "sess179.def" ) write;
  file old ( "sbdepdoc.old", "sess179.def" ) key 9999;
  file new ( "sbdepdoc.dbt", "sess179.def" ) write;
  var NameLnk = "", NameDoc = "", NameRtOp = "", NameOpOb = "";

  GetParm( 0, NameLnk );
  GetParm( 1, NameDoc );
  GetParm( 2, NameRtOp );
  GetParm( 3, NameOpOb );

  message( "Создание/заполнение файлов ret_op и opobject" );
  println( "Создание/заполнение файлов ret_op и opobject" );

  if ( NOT Create( op, ImportDir + NameRtOp + ".dbt" ) )
    println( "Не удалось создать файл " + NameRtOp );
    return FALSE;
  end;
  if ( NOT Create( ob, ImportDir + NameOpOb + ".dbt" ) )
    println( "Не удалось создать файл " + NameOpOb );
    return FALSE;
  end;

  if ( NOT Open( lnk, ImportDir + NameLnk + ".dbt" ) )
    println( "Не удалось открыть файл " + NameLnk );
    return FALSE;
  end;

  if ( NOT Open( doc, ImportDir + NameDoc + ".dbt" ) )
    println( "Не удалось открыть файл " + NameDoc );
    return FALSE;
  end;

  if ( NOT Open( op, ImportDir + NameRtOp + ".dbt" ) )
    println( "Не удалось открыть файл " + NameRtOp );
    return FALSE;
  end;
  if ( NOT Open( ob, ImportDir + NameOpOb + ".dbt" ) )
    println( "Не удалось открыть файл " + NameOpOb );
    return FALSE;
  end;

  var OpNRecs = 0, ObNRecs = 0;

  ReWind( lnk );
  while ( Next( lnk ) )
    if( ( lnk.ApplicationKind1 == lnk.ApplicationKind2 ) AND
        ( lnk.ApplicationKey1 == lnk.ApplicationKey2 ) )
      doc.iApplicationKind = lnk.ApplicationKind1;
      doc.ApplicationKey = lnk.ApplicationKey1;
      if( getEQ( doc ) )
        clearrecord( op );
        op.Branch = doc.FNCash;
        op.IsCur = doc.IsCur;
        op.ApplicationKind = doc.iApplicationKind;
        op.ApplicationKey = doc.ApplicationKey;
        op.Date = doc.Date_Document;
        op.Operation = doc.TypeComplexOper;
        op.SubOp = doc.ApplType;
        op.ObjectRef = string( doc.Referenc );
        op.State = 1; /* CONFIRMED */
        op.SessionNum = doc.NumSession;
        op.Oper = doc.Oper;
        op.TokenID = string( doc.NDoc );
        if ( Insert( op ) )
          OpNRecs = OpNRecs + 1;
        else
          println( " Ошибка при формировании записи операции для : ",
                   doc.iApplicationKind, " - ", doc.ApplicationKey );
          ErrCode = Status( ErrText );
          println( ErrCode, ": ", ErrText );
        end;
        clearrecord( ob );
        ob.Branch = doc.FNCash;
        ob.IsCur = doc.IsCur;
        ob.OpAppKind = doc.iApplicationKind;
        ob.OpAppKey = doc.ApplicationKey;
        ob.Date = doc.Date_Document;
        ob.ObjectType = 1; /* SB_DEPOSIT */
        ob.ObjectRef = string( doc.Referenc );
        ob.SessionNum = doc.NumSession;
        ob.Number = doc.NumDayDoc;
        if ( Insert( ob ) )
          ObNRecs = ObNRecs + 1;
        else
          println( " Ошибка при формировании записи по связи операция/объект для : ",
                   doc.iApplicationKind, " - ", doc.ApplicationKey );
          ErrCode = Status( ErrText );
          println( ErrCode, ": ", ErrText );
        end;
      end;
    end;
  end;

  if ( OpNRecs == 0 )
    println( "\n Записей по операциям не сформировано." );
  else
    println( "\n Сформировано записей по операциям: ", OpNRecs );
  end;

  if ( ObNRecs == 0 )
    println( "\n Записей по связи операция/объект не сформировано." );
  else
    println( "\n Сформировано записей по связи операция/объект: ", ObNRecs );
  end;

  println( "" );
  message( "Удаление ключей файла документов" );

  DelFile( ImportDir + NameDoc + ".old" );
  Close( doc );
  if ( Run( ComSpec, "/C ren " + ImportDir + NameDoc + ".dbt " + NameDoc + ".old" ) )
    println( "Не удалось переименовать файл " + NameDoc );
    return FALSE;
  end;

  if ( NOT Create( new, ImportDir + NameDoc + ".dbt" ) )
    println( "Не удалось создать файл " + NameDoc );
    return FALSE;
  end;

  if ( NOT Open( old, ImportDir + NameDoc + ".old" ) )
    println( "Не удалось открыть файл " + NameDoc );
    return FALSE;
  end;

  if ( NOT Open( new, ImportDir + NameDoc + ".dbt" ) )
    println( "Не удалось открыть файл " + NameDoc );
    return FALSE;
  end;

  var rec = 0;

  ReWind( old );
  while ( Next( old ) )
    Copy( new, old );
    if ( Insert( new ) )
      rec = rec + 1;
    else
      println( " Ошибка при вставке в транс. файл: ",
               old.iApplicationKind, " - ", old.ApplicationKey );
      ErrCode = Status( ErrText );
      println( ErrCode, ": ", ErrText );
    end;
  end;
  println( "" );
  message( "" );
end;

macro CreateEntriesInSessInfo():bool

  file inf ( "infss.dbt", "sess179.def"   ) write;
  file op  ( "ret_op.dbt", "sess179.def"   );
  file ob  ( "opobject.dbt", "sess179.def" );
  var Name = "000000", Branch, SessionNum, BrStr, NumStr;

  GetParm( 0, Branch );
  GetParm( 1, SessionNum );

  BrStr = String( Branch );
  NumStr = String( SessionNum );

  StrSet( Name, 3 - StrLen( BrStr ), BrStr );
  StrSet( Name, 7 - StrLen( NumStr ), NumStr );

  if ( NOT Open( inf, ImportDir + Name + "99.dbt" ) )
    println( "Не удалось открыть файл " + Name + "99.dbt" );
    return FALSE;
  end;

  if ( NOT Open( op, ImportDir + Name + "31.dbt" ) )
    println( "Не удалось открыть файл " + Name + "31.dbt" );
    return FALSE;
  end;

  if ( NOT Open( ob, ImportDir + Name + "32.dbt" ) )
    println( "Не удалось открыть файл " + Name + "32.dbt" );
    return FALSE;
  end;

  var rec = 0;

  if( NRecords( op ) )
    clearrecord( inf );
    inf.FNCash = Branch;
    inf.NumSession = SessionNum;
    inf.NumFile = 31;
    inf.DBTNameFile = "ret_op.dbt";
    inf.TR_NameFile = Name + "31.dbt";
    inf.ColRecord = NRecords( op );
    inf.FileDescription = "Проведенные операции";
    if( Insert( inf ) )
      rec = rec + 1;
    else
      println( "Ошибка при вставке в " + Name + "99.dbt" );
    end;
  end;

  if( NRecords( ob ) )
    clearrecord( inf );
    inf.FNCash = Branch;
    inf.NumSession = SessionNum;
    inf.NumFile = 32;
    inf.DBTNameFile = "opobject.dbt";
    inf.TR_NameFile = Name + "32.dbt";
    inf.ColRecord = NRecords( ob );
    inf.FileDescription = "Связь операций и объектов";
    if( Insert( inf ) )
      rec = rec + 1;
    else
      println( "Ошибка при вставке в " + Name + "99.dbt" );
    end;
  end;

  if ( rec == 0 )
    println( "\n Не сформировано ни одной записи в файле информации о сесии " );
  else
    println( "\n Сформировано записей в файле информации о сесии: ", rec );
  end;
  println( "" );
end;
