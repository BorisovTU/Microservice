/*
$Name:               pr___dda.mac
$Module:             DEPOSITR
$Description:        //
*/
/******************************************************************************

Список символов разметки и подставляемых значений
-------------------------------------------------

Cимвол    Накладываемый
разметки  текст
--------  -------------------------------
Общие символы разметки:
  02      Левая граница абзаца
  03      Правая граница абзаца

  11      Сегодняшняя дата (ЧЧ месяц ГГГГ)
  12      Фамилия Имя Отчество вкладчика
  13      Представитель Банка
  26      Паспортные данные вкладчика
  27      Адрес проживания вкладчика
  28      Адрес прописки вкладчика
  33      Дата рождения вкладчика
  34      Номер филиала
  45      Адрес филиала (длинный)
  46      Продолжение адреса филиала (длинного)
  50      Название города
  51      Наименование банка - с центровкой для заголовка
  52      Наименование банка с запятой для начала текста
  53      Наименование банка - строка без преобразований
  65      Адрес филиала (короткий)
  66      Продолжение адреса филиала (короткого)
  68      БИК банка
  69      Корр.счет банка
  70      ИНН банка
  77      Номер пенсионного удостоверения
  78      Дата выдачи пенсионного удостоверения

Вкладные:

  10      Номер счета
  14      Сумма вклада цифрами
  15      Сумма вклада прописью
  16      Имя валюты прописью
  17      Имя валюты краткое
  18      Срок вклада цифрами (месяцы)
  19      Срок вклада прописью (месяцы)
  20      Годовые проценты цифрами
  21      Годовые проценты прописью
  22      Срок перечисления суммы цифрами (дни)
  23      Срок перечисления суммы прописью (дни)
  24      Срок возврата вклада цифрами (дни)
  25      Срок возврата вклада прописью (дни)
  35      Дата окончания срока хранения вклада
  36      Процентная ставка по основным условиям
  37      Вид процентной ставки по основным условиям (годовая, в месяц etc.)
  38      Процентная ставка по альтернативным условиям
  39      Вид процентной ставки по альт. условиям (годовая, в месяц etc.)
  40      Процентная ставка по овердрафту
  41      Вид процентной ставки по овердрафту (годовая, в месяц etc.)
  42      Процентная ставка по дополнительным взносам
  43      Вид процентной ставки по доп. взносам  (годовая, в месяц etc.)
  44      Срок вклада (лет, месяцев, дней)
  55      Дата возврата вклада
  60      Данные вносителя для заголовка
  61      Данные вносителя для завершающей части договора-1
  62      Данные вносителя для завершающей части договора-2
  63      Данные вносителя для завершающей части договора-3
  64      Данные вносителя для завершающей части договора-4
  71      Счет для "Конверсионного" в валюте
  72      Счет для "Конверсионного" в рублях РФ
  73      Номер договора для "Конверсионного"
  74      Название валюты "Конверсионного" счета
  79      Лимит на допвзнос
  80      Минимальный остаток
  81      Вид вклада исходного счета для операции 78 "Переофомл.договора"
  82      Номер исходного счета для операции 78 "Переофомл.договора"
  83      Дата открытия старого счета для операции 78 "Переофомл.договора"
  84      Дата переоформления счета для операции 78 "Переофомл.договора"
  85      Серия сертификата ГЖС
  86      Номер сертификата ГЖС
  87      Сумма сертификата ГЖС - строкой
  88      Сумма сертификата ГЖС - цифрами
  89      Номер договора по вкладам
  90      Сумма остатка прописью
  91      Гражданство клиента
  92      Старый Вид вклада для договоров от 16.02.2006
  93      Номер счета до 16.02.2006 для доп.соглашения
  94      Дата ГЖС
  4       Место рождения
  5       домашний телефон
  6       рабочий телефон
  8       Код подразделения ОМ
  101     Номер счета(не форматированый)
  102     Критическая дата
  103     Дата начала срока хранения вклада
  104     ИНН вкладчика
  105     Паспортные данные:вид документа
  106     Паспортные данные:серия номер
  107     Паспортные данные:кем, где, когда выдан
  108     Паспортные данные:код подразделения
  109     Вноситель ФИО
  110     Вноситель Адрес1
  111     Вноситель Адрес2
  112     Вноситель ИНН
  113     Вноситель Гражданство
  114     Вноситель ВидДокумента
  115     Вноситель Серия Номер
  116     Вноситель Кем выдан
  117     Вноситель Код Подразделения
  118     Вноситель Дата рождения
  119     Вноситель Место рождения
  120     Вноситель Телефон
  121     Вноситель Факс
  122     Номер исходного счета для операции 78 "Переофомл.договора"(не форматированный)
  123     Номер счета до 16.02.2006 для доп.соглашения(не форматированный)
  124     данные миграционной карты

  99      Все ставки (для СРОЧНОГО с доп.взносами)

Карточные:
  95      Номер договора
  96      Дата открытия договора
  97      Наименование платёжной системы карты по договору

******************************************************************************/

/***********************************************************************/
/*              Параметры, настраиваемые ВАМИ:                         */
/***********************************************************************/

import DeprIntr, BankInter, depType, commclnt, dlwReps, rsd,  alg_vars, SqlConv, dlreptls;

 const
    delimiter = "находится в";

 var TxtDir = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", TRUE );
 
 array WordBlnk;
    /* бланк для типа вклада               местонахождение бланка */
    WordBlnk( 0) = "СР.ДЕП. 4 МП находится в pr__d4mp.doc";
    WordBlnk( 1) = "Текущий счет находится в pr___tac.doc";
    WordBlnk( 2) = "СР.ДЕП. 12МП находится в pr_d12mp.doc";
    WordBlnk( 3) = "Пенс.деп. 2г находится в pr__pn2y.doc";
    WordBlnk( 4) = "Фикс-6       находится в pr___ddf.doc";
    WordBlnk( 5) = "ДО ВОСТРЕБ.  находится в pr___ddv.doc";
    WordBlnk( 6) = "Пенсионный   находится в pr___dpn.doc";
    WordBlnk( 7) = "Ср.пенсион.  находится в pr___dsp.doc";
    WordBlnk( 8) = "СРОЧНЫЙ      находится в pr___dsr.doc";
    WordBlnk( 9) = "Целев. дети  находится в pr___dcd.doc";
    WordBlnk(10) = "НОМЕРНОЙ     находится в pr___dnm.doc";
    WordBlnk(11) = "Ср.1мес.выпл находится в pr___dse.doc";
    WordBlnk(12) = "СБЕРЕГ.1МЕС. находится в pr___dsb.doc";
    WordBlnk(13) = "СБЕРЕГ.2МЕС. находится в pr___dsb.doc";
    WordBlnk(14) = "СБЕРЕГ.3МЕС. находится в pr___dsb.doc";
    WordBlnk(15) = "ЮБИЛЕЙНЫЙ    находится в pr___dju.doc";
    WordBlnk(16) = "Компнес. 2   находится в pr___dcp.doc";
    WordBlnk(17) = "НОВОДЕНЕЖНЫЙ находится в pr___dnd.doc";
    WordBlnk(18) = "до востреб. вал. находится в pr___ddv.doc";
    WordBlnk(19) = "СРОЧНЫЙ С ЕЖ вал. находится в pr__vdse.doc";
    WordBlnk(20) = "Ср.с доп.взн вал. находится в pr___sdv.doc";
    WordBlnk(21) = "СР. ДЕП.12МП вал. находится в prvald12.doc";
    WordBlnk(22) = "Обезл.золото вал. находится в pr_metal.doc";
    WordBlnk(23) = "СР. ДЕП. 9МП вал. находится в prvald12.doc";
    WordBlnk(24) = "СР. ДЕП. 6МП вал. находится в prvaldd3.doc";
    WordBlnk(25) = "Целевой на д вал. находится в prvaldcd.doc";
    WordBlnk(26) = "ВЕСЕННИЙ     находится в pr___vs1.doc";
    WordBlnk(27) = "ВЕСЕННИЙ+    находится в pr___vs2.doc";
    WordBlnk(28) = "Молодежный   находится в pr___dml.doc";
    WordBlnk(29) = "Пополн.на 3М вал. находится в pr___p3m.doc";
    WordBlnk(30) = "Пополн.на 6М вал. находится в pr___p3m.doc";
    WordBlnk(31) = "ОСОБЫЙ       вал. находится в pr___spc.doc";
    WordBlnk(32) = "СБ-60 дней   находится в pr__60sb.doc";
    WordBlnk(33) = "СБ-100 дней  находится в pr_100sb.doc";
    WordBlnk(34) = "СБ-15 дней   находится в pr__15sb.doc";
    WordBlnk(35) = "СБ-60 дней   вал. находится в pr__60sb.doc";
    WordBlnk(36) = "СБ- 100 дней вал. находится в pr_100sb.doc";
    WordBlnk(37) = "Особый номер находится в pr___dSN.doc";
    WordBlnk(38) = "Особый номер вал. находится в prvaldSN.doc";
    WordBlnk(39) = "СБ-30 дней   вал. находится в pr__30sb.doc";
    WordBlnk(40) = "НОВОГОДНИЙ_  находится в pr___NYe.doc";
    WordBlnk(41) = "Избир.кандид находится в pr___izk.doc";
    WordBlnk(42) = "Избир.объед. находится в pr___izo.doc";
    WordBlnk(43) = "НОВОГОДНИЙ + находится в pr___NYP.doc";
    WordBlnk(44) = "НОВОГОДНИЙ_  вал. находится в pr___NYe.doc";
    WordBlnk(45) = "НОВОГОДНИЙ + вал. находится в pr___NYP.doc";
    WordBlnk(46) = "Ср.пенс.6мес находится в pr___sp6.doc";
    WordBlnk(47) = "СБЕРЕГ.6МЕС. находится в pr___sb6.doc";
    WordBlnk(48) = "Особ.н.1г_1м находится в pr__sn13.doc";
    WordBlnk(49) = "Особ.н.1г_1м вал. находится в pr__sn13.doc";
    WordBlnk(50) = "Ср.пен.1г1м  находится в pr__sp13.doc";
    WordBlnk(51) = "СБ-501       находится в pr___501.doc";
    WordBlnk(52) = "Счет типа Ф  находится в pr___dtf.doc";
    WordBlnk(53) = "Conversion   находится в pr___cnv.doc";
    WordBlnk(54) = "Conversion   вал. находится в pr___cnv.doc";
    WordBlnk(55) = "Пенсионный + находится в pr___pnp.doc";
    WordBlnk(56) = "Пенсионный 1 находится в pr__dop1.doc";
    WordBlnk(57) = "Пенсионный 2 находится в pr__dop2.doc";
    WordBlnk(58) = "Зарплатный   находится в pr___zrp.doc";
    WordBlnk(59) = "Зарплатный 1 находится в pr_zdop1.doc";
    WordBlnk(60) = "Зарплатный 2 находится в pr_zdop2.doc";
    WordBlnk(61) = "Ср.пен.на 2г находится в pr__sp2y.doc";
    WordBlnk(62) = "Накоп.на 2 г находится в pr__nk2y.doc";
    WordBlnk(63) = "Европейский  вал. находится в pr___eur.doc";
    WordBlnk(64) = "ЦЕЛЕВОЙ      находится в pr___gzs.doc";
    WordBlnk(65) = "Особ.ном.2 г находится в pr__sn2y.doc";
    WordBlnk(66) = "Особ.ном.2 г вал. находится в pr__sn2y.doc";
    WordBlnk(67) = "П.депоз.1г1м находится в pr__pd13.doc";
    WordBlnk(68) = "Дол.депоз 3м вал. находится в pr___d3m.doc";
    WordBlnk(69) = "Дол.депоз 6м вал. находится в pr___d3m.doc";
    WordBlnk(70) = "ЕВРО-деп. 3м вал. находится в pr___e3m.doc";
    WordBlnk(71) = "ЕВРО-деп. 6м вал. находится в pr___e3m.doc";
    WordBlnk(72) = "Нов.европ.2г вал. находится в pr__ne2y.doc";
    WordBlnk(73) = "Юбил.рента   вал. находится в pr__jur2.doc";
    WordBlnk(74) = "Нов.европ.1г вал. находится в pr__ne13.doc";
    WordBlnk(75) = "Юб.рен.1г_1м вал. находится в pr_jur13.doc";
    WordBlnk(76) = "Универсальн. находится в pr__univ.doc";
    WordBlnk(77) = "Универсальн. вал. находится в pr__univ.doc";
    WordBlnk(78) = "Особый на 2г находится в pr___s2y.doc";
    WordBlnk(79) = "Особый на 2г вал. находится в pr___s2y.doc";
    WordBlnk(80) = "Особый 1г_1м вал. находится в pr___s13.doc";
    WordBlnk(81) = "Особый 1г_1м находится в pr___s13.doc";
    WordBlnk(82) = "Особый на 3м находится в pr___dS3.doc";
    WordBlnk(83) = "Особый на 3м вал. находится в pr___dS3.doc";
    WordBlnk(84) = "Обезл.металл вал. находится в pr___oms.doc";
    WordBlnk(85) = "Универсал. 1 находится в pr_udop1.doc";
    WordBlnk(86) = "Универсал. 1 вал. находится в pr_udop1.doc";
    WordBlnk(87) = "Счет типа А  находится в pr___dta.doc";
    WordBlnk(88) = "Счет типа В1 находится в pr__dtb1.doc";
    WordBlnk(89) = "Счет типа В2 находится в pr__dtb2.doc";
    WordBlnk(90) = "Счет типа С  находится в pr___dtc.doc";
    WordBlnk(91) = "Счет типа О  находится в pr___dto.doc";
    WordBlnk(92) = "Счет Н 40820 находится в pr___dth.doc";
    WordBlnk(93) = "Счет типа Ф  вал. находится в pr___dcf.doc";
    WordBlnk(94) = "Депоз.на 1 м находится в pr___dep.doc";
    WordBlnk(95) = "Депоз.на 3 м находится в pr___dep.doc";
    WordBlnk(96) = "Депоз.на 6 м находится в pr___dep.doc";
    WordBlnk(97) = "Пенс.деп. 3м находится в pr___pd6.doc";
    WordBlnk(98) = "Пенс.деп. 6м находится в pr___pd6.doc";
    WordBlnk(99) = "Пенс.деп.13м находится в pr__pn13.doc";
    WordBlnk(100) = "Дол.депоз 1м вал. находится в pr___d3m.doc";
    WordBlnk(101) = "ЕВРО-деп. 1м вал. находится в pr___e3m.doc";
    WordBlnk(102) = "Депоз.Фв 1 м находится в pr___dep.doc";
    WordBlnk(103) = "Депоз.Фв 3 м находится в pr___dep.doc";
    WordBlnk(104) = "Пенс.депФв3м находится в pr___pd3.doc";
    WordBlnk(105) = "Дол.деп.фв1м вал. находится в pr___d3m.doc";
    WordBlnk(106) = "ЕВРО-депФв1м вал. находится в pr___e3m.doc";
    WordBlnk(107) = "Обезл.серебр вал. находится в pr_metal.doc";
    WordBlnk(108) = "END_OF_LIST";

 array Бланки;
    /* бланк для типа вклада               местонахождение бланка */
    Бланки( 0) = "СР.ДЕП. 4 МП находится в pr__d4mp.bln";
    Бланки( 1) = "Текущий счет находится в pr___tac.bln";
    Бланки( 2) = "СР.ДЕП. 12МП находится в pr_d12mp.bln";
    Бланки( 3) = "Пенс.деп. 2г находится в pr__pn2y.bln";
    Бланки( 4) = "Фикс-6       находится в pr___ddf.bln";
    Бланки( 5) = "ДО ВОСТРЕБ.  находится в pr___ddv.bln";
    Бланки( 6) = "Пенсионный   находится в pr___dpn.bln";
    Бланки( 7) = "Ср.пенсион.  находится в pr___dsp.bln";
    Бланки( 8) = "СРОЧНЫЙ      находится в pr___dsr.bln";
    Бланки( 9) = "Целев. дети  находится в pr___dcd.bln";
    Бланки(10) = "НОМЕРНОЙ     находится в pr___dnm.bln";
    Бланки(11) = "Ср.1мес.выпл находится в pr___dse.bln";
    Бланки(12) = "СБЕРЕГ.1МЕС. находится в pr___dsb.bln";
    Бланки(13) = "СБЕРЕГ.2МЕС. находится в pr___dsb.bln";
    Бланки(14) = "СБЕРЕГ.3МЕС. находится в pr___dsb.bln";
    Бланки(15) = "ЮБИЛЕЙНЫЙ    находится в pr___dju.bln";
    Бланки(16) = "Компнес. 2   находится в pr___dcp.bln";
    Бланки(17) = "НОВОДЕНЕЖНЫЙ находится в pr___dnd.bln";
    Бланки(18) = "до востреб. вал. находится в pr___ddv.bln";
    Бланки(19) = "СРОЧНЫЙ С ЕЖ вал. находится в pr__vdse.bln";
    Бланки(20) = "Ср.с доп.взн вал. находится в pr___sdv.bln";
    Бланки(21) = "СР. ДЕП.12МП вал. находится в prvald12.bln";
    Бланки(22) = "Обезл.золото вал. находится в pr_metal.bln";
    Бланки(23) = "СР. ДЕП. 9МП вал. находится в prvald12.bln";
    Бланки(24) = "СР. ДЕП. 6МП вал. находится в prvaldd3.bln";
    Бланки(25) = "Целевой на д вал. находится в prvaldcd.bln";
    Бланки(26) = "ВЕСЕННИЙ     находится в pr___vs1.bln";
    Бланки(27) = "ВЕСЕННИЙ+    находится в pr___vs2.bln";
    Бланки(28) = "Молодежный   находится в pr___dml.bln";
    Бланки(29) = "Пополн.на 3М вал. находится в pr___p3m.bln";
    Бланки(30) = "Пополн.на 6М вал. находится в pr___p3m.bln";
    Бланки(31) = "ОСОБЫЙ       вал. находится в pr___spc.bln";
    Бланки(32) = "СБ-60 дней   находится в pr__60sb.bln";
    Бланки(33) = "СБ-100 дней  находится в pr_100sb.bln";
    Бланки(34) = "СБ-15 дней   находится в pr__15sb.bln";
    Бланки(35) = "СБ-60 дней   вал. находится в pr__60sb.bln";
    Бланки(36) = "СБ- 100 дней вал. находится в pr_100sb.bln";
    Бланки(37) = "Особый номер находится в pr___dSN.bln";
    Бланки(38) = "Особый номер вал. находится в prvaldSN.bln";
    Бланки(39) = "СБ-30 дней   вал. находится в pr__30sb.bln";
    Бланки(40) = "НОВОГОДНИЙ_  находится в pr___NYe.bln";
    Бланки(41) = "Избир.кандид находится в pr___izk.bln";
    Бланки(42) = "Избир.объед. находится в pr___izo.bln";
    Бланки(43) = "НОВОГОДНИЙ + находится в pr___NYP.bln";
    Бланки(44) = "НОВОГОДНИЙ_  вал. находится в pr___NYe.bln";
    Бланки(45) = "НОВОГОДНИЙ + вал. находится в pr___NYP.bln";
    Бланки(46) = "Ср.пенс.6мес находится в pr___sp6.bln";
    Бланки(47) = "СБЕРЕГ.6МЕС. находится в pr___sb6.bln";
    Бланки(48) = "Особ.н.1г_1м находится в pr__sn13.bln";
    Бланки(49) = "Особ.н.1г_1м вал. находится в pr__sn13.bln";
    Бланки(50) = "Ср.пен.1г1м  находится в pr__sp13.bln";
    Бланки(51) = "СБ-501       находится в pr___501.bln";
    Бланки(52) = "Счет типа Ф  находится в pr___dtf.bln";
    Бланки(53) = "Conversion   находится в pr___cnv.bln";
    Бланки(54) = "Conversion   вал. находится в pr___cnv.bln";
    Бланки(55) = "Пенсионный + находится в pr___pnp.bln";
    Бланки(56) = "Пенсионный 1 находится в pr__dop1.bln";
    Бланки(57) = "Пенсионный 2 находится в pr__dop2.bln";
    Бланки(58) = "Зарплатный   находится в pr___zrp.bln";
    Бланки(59) = "Зарплатный 1 находится в pr_zdop1.bln";
    Бланки(60) = "Зарплатный 2 находится в pr_zdop2.bln";
    Бланки(61) = "Ср.пен.на 2г находится в pr__sp2y.bln";
    Бланки(62) = "Накоп.на 2 г находится в pr__nk2y.bln";
    Бланки(63) = "Европейский  вал. находится в pr___eur.bln";
    Бланки(64) = "ЦЕЛЕВОЙ      находится в pr___gzs.bln";
    Бланки(65) = "Особ.ном.2 г находится в pr__sn2y.bln";
    Бланки(66) = "Особ.ном.2 г вал. находится в pr__sn2y.bln";
    Бланки(67) = "П.депоз.1г1м находится в pr__pd13.bln";
    Бланки(68) = "Дол.депоз 3м вал. находится в pr___d3m.bln";
    Бланки(69) = "Дол.депоз 6м вал. находится в pr___d3m.bln";
    Бланки(70) = "ЕВРО-деп. 3м вал. находится в pr___e3m.bln";
    Бланки(71) = "ЕВРО-деп. 6м вал. находится в pr___e3m.bln";
    Бланки(72) = "Нов.европ.2г вал. находится в pr__ne2y.bln";
    Бланки(73) = "Юбил.рента   вал. находится в pr__jur2.bln";
    Бланки(74) = "Нов.европ.1г вал. находится в pr__ne13.bln";
    Бланки(75) = "Юб.рен.1г_1м вал. находится в pr_jur13.bln";
    Бланки(76) = "Универсальн. находится в pr__univ.bln";
    Бланки(77) = "Универсальн. вал. находится в pr__univ.bln";
    Бланки(78) = "Особый на 2г находится в pr___s2y.bln";
    Бланки(79) = "Особый на 2г вал. находится в pr___s2y.bln";
    Бланки(80) = "Особый 1г_1м вал. находится в pr___s13.bln";
    Бланки(81) = "Особый 1г_1м находится в pr___s13.bln";
    Бланки(82) = "Особый на 3м находится в pr___dS3.bln";
    Бланки(83) = "Особый на 3м вал. находится в pr___dS3.bln";
    Бланки(84) = "Обезл.металл вал. находится в pr___oms.bln";
    Бланки(85) = "Универсал. 1 находится в pr_udop1.bln";
    Бланки(86) = "Универсал. 1 вал. находится в pr_udop1.bln";
    Бланки(87) = "Счет типа А  находится в pr___dta.bln";
    Бланки(88) = "Счет типа В1 находится в pr___dtb1.bln";
    Бланки(89) = "Счет типа В2 находится в pr___dtb2.bln";
    Бланки(90) = "Счет типа С  находится в pr___dtc.bln";
    Бланки(91) = "Счет типа О  находится в pr___dto.bln";
    Бланки(92) = "Счет Н 40820 находится в pr___dth.bln";
    Бланки(93) = "Счет типа Ф  вал. находится в pr___dcf.bln";
    Бланки(94) = "Депоз.на 1 м находится в pr___dep.bln";
    Бланки(95) = "Депоз.на 3 м находится в pr___dep.bln";
    Бланки(96) = "Депоз.на 6 м находится в pr___dep.bln";
    Бланки(97) = "Пенс.деп. 3м находится в pr___pd3.bln";
    Бланки(98) = "Пенс.деп. 6м находится в pr___pd6.bln";
    Бланки(99) = "Пенс.деп.13м находится в pr__pn13.bln";
    Бланки(100) = "Дол.депоз 1м вал. находится в pr___d3m.bln";
    Бланки(101) = "ЕВРО-деп. 1м вал. находится в pr___e3m.bln";
    Бланки(102) = "Депоз.Фв 1 м находится в pr___dep.bln";
    Бланки(103) = "Депоз.Фв 3 м находится в pr___dep.bln";
    Бланки(104) = "Пенс.депФв3м находится в pr___pd3.bln";
    Бланки(105) = "Дол.деп.фв1м вал. находится в pr___d3m.bln";
    Бланки(106) = "ЕВРО-депФв1м вал. находится в pr___e3m.bln";
    Бланки(107) = "Обезл.серебр вал. находится в pr_metal.bln";
    Бланки(108) = "END_OF_LIST";

 const
    Годовые_проценты               = $0,
    Срок_перечисления_дни          = 0,
    Срок_возврата_вклада_дни       = 0;

 const
    decimalSet = "0123456789";

 const
    OP_INDOP = 3;  /* Операция: дополнительный взнос */

 const
    ALGCHIK = 240;

 const
    PrintToWORD = False;

 const OP_GETCON =  62;  /* Списание простое */
 const OP_REFNUM = 508;  /* Операция переоформления номерных вкладов */

 const blankSpecialNumber = "pr_sdop1.bln";

 var {CNum};

 var flagWord = FALSE;  // Флаг формата бланка MS-Word.

 var flagAddContract = FALSE;  // Флаг выпуска доп.соглашения.

/*-----------------------------------------------------------------------

                                             14 мар. 1997, Клепиков С.А.
 Описание: заполнение макета договора.

-----------------------------------------------------------------------*/
/***************Внешние данные   ***************************************/

/***************Глобальные данные***************************************/
 file
    cntry("country.dbt","rsrfdb.def") key 2;
 file
    person("person.dbt","bank.def") key 0;
 file
    cur("currency.dbt")  key 0;
 file
    dd("depositr.dbt")   key 5;
 file
    sn("sbdepdoc.dbt")   key 1;  /* Для "Особых Номерных" */

 file Rt_contract("Rt_contract.dbt") key 0;   /* Для карточных договоров */
 file CardProduct("cardproduct.dbt") key 0;

 var dt = TBfile( "sb_dtyp.dbt", "r", 2 );
 var
    Срок_вклада_месяцы          = 0,
    Вклад_наличными             = True,
    Сегодняшняя_дата            = "дата не известна",
    Срок_окончания_договора     = "не известен",
    Срок_вклада_словами         = "не известен",
    Срок_вклада_годы_месяцы_дни = "не известен",
    pc_rates_line               = "";
 const
    MAX_INSERTERS_TYPES    = 125,
    START_OF_BLANK_MARKER  = "<НАЧАЛО МАКЕТА>",
    END_OF_BLANK_MARKER    = "<КОНЕЦ МАКЕТА>",
    MAX_INT16              = 32767;
 const
    PC_ACCOUNT_TYPE = 1003,   /* Тип вклада (частного)      */
    PC_ACCOUNT_DEP  = 2001,   /* Счет (частный вклад)       */
    PC_ACCOUNT_ALT  = 2002,   /* = AlterPercType            */
    PC_ACCOUNT_OVER = 2003,   /* = OverdPercType            */
    PC_ACCOUNT_DOP  = 2004;   /* = DopInsPercType           */
 const
    PC_YEAR_RPERIOD  = 0,     /* годовая                    */
    PC_CONTR_RPERIOD = 2,     /* за сpок договоpа           */
    PC_MONTH_RPERIOD = 3,     /* месячная                   */
    PC_DAYS_RPERIOD  = 4;     /* дневная(за количество дней)*/
 var
    sRub = "руб.", sCop = "коп.";

 private var {MFO_Bank};
 private var {CORAC_Bank};
 private var {Bank_INN};
 private var {CurDate};
 private var {Oper};

/**********************************************************************/

macro getPcRate( dep, doc, applType, rateType, rateVal )

  file
    aptype("pc_apltp.dbt") key 0;
  file
    pcrate("pc_rate.dbt")  key 0;
  file
    depdoc("sbdepdoc.dbt") key 0;
  var
    stat,
    valueRate = $0.0;

  ClearRecord(aptype);
  aptype.IsCur=dep.IsCur;
  aptype.TypeRec=1003;
  aptype.Type=doc.Type_Account;
  aptype.ApplType=applType;

  stat=GetEQ(aptype);

  if(stat)
    pcrate.FlagCur = dep.IsCur;
    pcrate.ObjectType = 1003;
    pcrate.Referenc = aptype.ApType;
    pcrate.Code_Currency = dep.Code_Currency;
    pcrate.BeginDate=dep.Open_Date;
    pcrate.DatePeriodType=MAX_INT16;
    pcrate.DatePeriod=MAX_INT16;

    stat=GetLE(pcrate);

    // Выбор действующих ставок по виду вклада.
    while ( stat  AND
            ( pcrate.FlagCur == dep.IsCur )                AND
            ( pcrate.ObjectType == 1003 )                  AND
            ( pcrate.Referenc == aptype.ApType )           AND
            ( pcrate.Code_Currency == dep.Code_Currency )  AND
            ( pcrate.Action > 1 ) )
      stat = Prev( pcrate );
    end;

    if(stat and
      ( pcrate.FlagCur != dep.IsCur )
      or ( pcrate.ObjectType != 1003 )
      or ( pcrate.Referenc != aptype.ApType )
      or ( pcrate.Code_Currency != dep.Code_Currency ) )
      stat=false;
    end;
  end;

  if(stat)
    if(pcrate.PeriodRate==PC_YEAR_RPERIOD)
      SetParm(3,"годовая");
    elif(pcrate.PeriodRate==PC_CONTR_RPERIOD)
      SetParm(3,"за срок договора");
    elif(pcrate.PeriodRate==PC_MONTH_RPERIOD)
      SetParm(3,"месячная");
    elif(pcrate.PeriodRate==PC_DAYS_RPERIOD)
      SetParm(3,"за "+String(pcrate.DaysPeriod)+" дней");
    end;
  end;

  if ( OpenDepFiles() )
    valueRate = PercRateAL( dep.Referenc, applType, {curdate}, dep.Sum_Rest );
  end;

  SetParm( 4, String(valueRate:0:2) );

  CloseDepFiles();

  return stat;
end;

/**********************************************************************/
MACRO byWords(value)      /* value - INT */

 var
    tmp,
    words;

 RubToStr(Money(value),words,tmp);
 return words

END;
/**********************************************************************/
MACRO percentsByWords(value)

 var
    wholePart,
    handredsPart,
    wholeEmpty,
    handredsEmpty,
    andWord      = " целых ",
    handredsWord = " сотых ";

 RubToStr(Money(value),wholePart,handredsPart);
 if(Strlen(wholePart)==0)   wholeEmpty   =True;else wholeEmpty   =False; end;
 if(StrLen(handredsPart)==0)handredsEmpty=True;else handredsEmpty=False; end;
 if(  (    wholeEmpty) AND (    handredsEmpty ))
   wholePart = "ноль "; andWord = ""; handredsWord = "";
 end;
 if(  (NOT wholeEmpty) AND (    handredsEmpty) )
   andWord = ""; handredsWord = "";
 end;
 if(  (    wholeEmpty) AND (NOT handredsEmpty) )
   wholePart = "ноль целых "; andWord = "";
 end;

 return wholePart + andWord +  handredsPart + handredsWord;

END;

/**********************************************************************/
/*  Название валюты  */
MACRO CurName( code )
 cur.Code_Currency = code;
 if ( getEQ( cur ) )
   sRub = cur.Short_Name;
 else
   sRub = "???";
 end;
 if   (sRub == "RUR")
   sRub = "руб.";
   sCop = "коп.";
 elif (sRub == "руб." )
   sCop = "коп.";
 elif (sRub == "USD")
   sCop = "центов";
 elif ((sRub == "DM") OR (sRub == "DEM"))
   sCop = "пфен.";
 elif (sRub == "FFR")
   sCop = "сант.";
 elif (sRub == "GBP")
   sCop = "пен.";
 else
   sCop = "";
 end;

END;

/**********************************************************************/
MACRO moneyByDigitsRub( sum )

 var
    wholePart    = String( ( Int( sum ) ):a ),
    tmp,
    words;

 RubToStr(sum,words,tmp);
 return wholePart + " " + sRub + " " + tmp + " " + sCop;

END;
/**********************************************************************/
MACRO moneyByDigits( isCur, sum, code )
  if ( isCur == 0 )
    CurName(0);
  else
    CurName(code);
  end;
  return moneyByDigitsRub( sum );
END;
/**********************************************************************/
MACRO moneyByWords(isCur,value,code)

 var
    wholePart    = byWords(value),
    wholeEmpty   = (Strlen(wholePart)==0),
    handredsEmpty,
    handredsPart,
    tmp;

 if ( isCur == 0 )
   CurName(0);
 else
   CurName(code);
 end;

 RubToStr(Money(value),tmp,handredsPart);
 handredsEmpty = (StrLen(handredsPart)==0);
 if( wholeEmpty)    wholePart    = "Ноль"; end;
 if( handredsEmpty) handredsPart = "00";   end;

 return wholePart + " " + sRub + " " + handredsPart + " " + sCop;

END;

MACRO getAddress( cln )
  var str;
  if ( ( StrLen( cln.rec.Address ) != 0 )  OR
       ( cln.rec.NotResident == 0 ) )  /* Для резидента */
    str = cln.rec.Address;
  else
    str = commclnt_Получить_Поле_Address_Фактического_Адреса (cln);
  end;
  return str;
END;

/**************************************************************
           Получить полное наименование вида вклада.
**************************************************************/
MACRO getDepTypeName( pFlagCur, pKind )
 var vDT_Name = pKind;
 ClearRecord( dt );
 dt.rec.FlagCur = pFlagCur;
 dt.rec.Kind    = pKind;
 if ( dt.GetEQ() )
   vDT_Name = dt.rec.Name;
 end;
 return vDT_Name;
end;

/**************************************************************
          Вид вклада при переоформлении договора
**************************************************************/
MACRO getTypeAccReformContract( dep, ta, do )
 var vta = "", vdo = "";
 var stat = FALSE;
 var saveKeyNum = KeyNum( dd, 5 );
 ReWind( dd );
 ClearRecord( dd );
 dd.FNCash  = dep.FNCash;
 dd.SvodAccount = dep.SvodAccount;
 stat = GetGE( dd );
 while ( stat  AND
         ( dd.FNCash == dep.FNCash )  AND
         ( dd.SvodAccount == dep.SvodAccount )  AND
         ( dd.Open_Close == StrFor(0) ) )
   stat = Next( dd );
 end;
 if ( stat  AND
      ( dd.FNCash == dep.FNCash )  AND
      ( dd.SvodAccount == dep.SvodAccount )  AND
      ( dd.Open_Close != StrFor(0) ) )
   if   ( Index( StrUpr(dep.Type_Account), "УНИВЕР" ) > 0 )
     vta = "\"До востребования Сбербанка России\"";
   elif ( Index( StrUpr(dep.Type_Account), "ЗАРПЛА" ) > 0 )
     vta = "\"До востребования Сбербанка России\"";
   else
     vta = "\"Пенсионный Сбербанка России\"";
   end;
   vdo = String( dd.Open_Date:m );
 else
   if   ( Index( StrUpr(dep.Type_Account), "УНИВЕР" ) > 0 )
     vta = "\"Универсальный Сбербанка России\"";
   elif ( Index( StrUpr(dep.Type_Account), "ЗАРПЛА" ) > 0 )
     vta = "\"Зарплатный Сбербанка России\"";
   else
     vta = "\"Пенсионный-плюс Сбербанка России\"";
   end;
   vdo = String( dep.Open_Date:m );
 end;
 KeyNum( dd, saveKeyNum );
 SetParm( 1, vta );
 SetParm( 2, vdo );
END;

/**************************************************************
 16.02.2006  Вид вклада при переоформлении договора (для новых)
**************************************************************/
MACRO getTypeAccContractNew( dep, ta, na )
 var vta = "", vdo = "";
 var cmd, rs, q;

 vta = "\"" + getDepTypeName( dep.IsCur, dep.Type_Account ) + " Сбербанка России\"";
 vdo = String(dep.Account:f);

 q = "SELECT t_Type_Account, t_Account FROM dsbdepdoc_dbt " +
       "WHERE t_Referenc = " + String( dep.Referenc ) + " AND " +
             "t_Date_Document = " + sqlDateToStr( dep.Open_Date ) +
             " ORDER BY t_referenc, t_date_document, t_numdaydoc";
 cmd = RsdCommand( q );
 rs = RsdRecordSet( cmd );
 if ( rs.MoveNext() )
   vta = "\"" + getDepTypeName( dep.IsCur, rs.Fld("t_Type_Account").Value ) + " Сбербанка России\"";
   vdo = string(rs.Fld("t_Account").Value:f);
 end;

 SetParm( 1, vta );
 SetParm( 2, vdo );
END;

/**************************************************************
             Определение даты доп.соглашения.
**************************************************************/
MACRO getDateAddEnd( dep )
 var vDateAE = dep.Open_Date;
 var cmd, rs, q;
 var depRef = dep.Referenc;
 var lastDaySeparator = 
    GetRegVal( "RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\ОПЕРАЦИИ\\ОБРАБОТКА_ДОГОВОРОВ\\ПОСЛЕДНИЙ_ДЕНЬ_СРОКА\\ГРАНИЦА", false );

 q = "SELECT t_DepDate_Document FROM dsbdepdoc_dbt doc " +
       "WHERE doc.t_Referenc = :DepRefParam AND " +
             "doc.t_DepDate_Document >= to_date(:LastDaySeparatorParam,'dd.mm.yyyy') AND " +
             "(doc.t_TypeOper = 82 OR doc.t_TypeComplexOper = 82) AND " +
             "doc.t_KindOp <> 8 AND doc.t_KindOp <> 9 AND " +
             "doc.t_KindOp <> 14 AND doc.t_KindOp <> 15 AND " +
             "doc.t_KindOp <> 16 AND doc.t_Action <> 2 AND " +
             "doc.t_TypeOper <> 38 AND doc.t_TypeOper <> 39 AND " +
             "doc.t_Mode <> 2 and bitand(doc.t_flags,131072 ) = 0" +
             " ORDER BY t_DepDate_Document";
 cmd = RsdCommand( q );
 cmd.AddParam( "DepRefParam", RSDBP_IN, depRef );
 cmd.AddParam( "LastDaySeparatorParam", RSDBP_IN, lastDaySeparator );
 rs = RsdRecordSet( cmd );
 if ( rs.MoveNext() )
   vDateAE = Date(rs.Fld("t_DepDate_Document").Value);
 else
   if ( dep.Prol_DateDep != Date(0,0,0) ) 
     vDateAE = ( dep.Prol_DateDep - 1 );
   else
     vDateAE = dep.Open_Date;
   end;
 end;
 return vDateAE;
END;


/**************************************************************
          Вид вклада при переоформлении договора
**************************************************************/
/*
MACRO getTypeAccReformContract( dep, ta, do )
 var vta = "", vdo = "";
 var saveKeyNum = KeyNum( dd, 7 );
 ReWind( dd );
 dd.FNCash  = dep.FNCash;
 dd.Account = dep.SvodAccount;
 if ( GetEQ( dd ) )
   vta = "\"" + dd.Type_Account + "\"";
   vdo = String( dd.Open_Date:m );
 end;
 KeyNum( dd, saveKeyNum );
 SetParm( 1, vta );
 SetParm( 2, vdo );
END;
*/

/**************************************************************************\
|         Получение названия страны гражданства клиента-нерезидента.       |
\**************************************************************************/
macro GetClientCountry( cln )
 var ret_name  = "";

 cntry.CodeLat3 = cln.rec.NRCountry;
 if ( GetEQ( cntry ) )
   ret_name = cntry.Name;
 else
   if ( cln.rec.NRCountry == "" )
     // ret_name = "Россия";
     ret_name = "";
   end;
 end;

 return ret_name;

end;

/**********************************************************************/
/*         Получение строки атрибутов удостоверения личнтости.        */
/*          С учетом гражданства и даты выдачи. - SCR #75305.         */
/**********************************************************************/
MACRO getContractPaperStr( cln )
 var sPaperRet  = "";
 var sPaperTail = "";
 var sCountry   = "";
 var sPapKind   = GetNameOfPAPRKIND( cln.rec.PaperKind );
 var pComma     = 0;

 sPaperRet = sPapKind;

 sPaperTail = "серия " +
              cln.rec.PaperSeries + " № " +
              cln.rec.PaperNumber + ", выдан " +
              cln.rec.PaperIssuer + ", " +
              cln.rec.PaperIssuedDate;

 if ( cln.rec.NotResident == "" )  // Клиент - резидент.
   sPaperRet = sPaperRet + " ";
 else                              // Клиент - нерезидент.
   sCountry = GetClientCountry( cln );
   if ( StrLen( sCountry ) > 0 )  // Гражданство задано.
     sPaperRet = sPaperRet + ", " + sCountry + ", ";
   else                           // Гражданство не задано.
     sPaperRet = sPaperRet + " ";
   end;
 end;
 return sPaperRet + sPaperTail;
END;

/**********************************************************************/
MACRO getCommonItems(data,filled,cln)
 var ddep = TRecHandler( "i_dp_dep.rec" );
 var party = TRecHandler( "i_party.rec" );
 file
    OpStep ( sb_algop ) key 0;
 file
    AI     ( auxinfo  ) key 0;  /* Доп.информация счета */
 private const AI_GJS = 18;  /* Тип для auxinfo.dbt для ГЖС */

 var
    i, pos=60,
    ФИО_вкладчика                   = cln.ConvertFIOFull(),
    Сегодняшняя_дата                = String( {curdate}:m),
    Представитель_Банка             = "",
    Паспортные_данные_вкладчика     = getContractPaperStr( cln ),
    Адрес_проживания_вкладчика      = SubStr(commclnt_Получить_Поле_Address_Фактического_Адреса(cln),1,90),
    Адрес_прописки_вкладчика        = getAddress( cln ),
    Дата_рождения_вкладчика         = String(cln.rec.Born:m),
    Номер_филиала                   = "????????????",
    Адрес_филиала                   = "???????????????????????",
    Продолжение_адреса_филиала      = "_",
    Адрес_филиала_кор               = "???????????????????????",
    Продолжение_адреса_филиала_кор  = "_",
    БИК_банка                       = "",
    Корр_счет_банка                 = "",
    ИНН_банка                       = "",
    Наименование_Банка              = getBankName(),
    Наименован_Банка                = getBankName(),
    Наименование_Банка_с_запятой    = "",
    Номер_пенсионн_удостоверения    = "",
    Город                           = "????????",
    Дата_пенсионн_удостоверения     = "";

 var
    tmpStr, tmpInd,
    RegPath = "RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\ПАРАМЕТРЫ_ДОГОВОРОВ\\НАЗВ_ГОРОДА",
    Type = V_STRING,
    ErrCode,
    Value;

 if(GetRegistryValue(RegPath, Type, Value, ErrCode) == V_STRING)
    Город = Value;
 end;

 БИК_банка       = {MFO_Bank};
 Корр_счет_банка = {CORAC_Bank};
 ИНН_банка       = {Bank_INN};

  /* Получение ФИО операциониста */
  person.Oper = {oper};
  if ( getEQ( person ) )
    Представитель_Банка = person.Name;
  else
    Представитель_Банка = "";
  end;

 /* Получение данных о подразделении и банке */
 if(findDepartment(NumFNCash, null, ddep, party))
    Номер_филиала=ddep.rec.Name;
    /*  Длинные маркеры  */
    if(strlen(party.rec.address)>64)
      i = 64;
      while( i > 30 )
        if(    ( substr(party.rec.address,i,1) == "." )
            or ( substr(party.rec.address,i,1) == "," )
            or ( substr(party.rec.address,i,1) == "-" )
            or ( substr(party.rec.address,i,1) == " " )
          )
            pos = i;
            i = 29;
        end;
        i = i - 1;
      end;
      Адрес_филиала=substr(party.rec.address,1,pos);
      Продолжение_адреса_филиала=substr(party.rec.address,pos+1,62);
    else
      Адрес_филиала=party.rec.address
    end;
    if ( Наименование_Банка == "Сбербанк России" )
      Наименование_Банка =
        "Акционерный коммерческий Сберегательный банк Российской Федерации";
    end;
    Наименование_Банка_с_запятой = StrUpr( Наименование_Банка ) + " (ОТКРЫТОЕ АКЦИОНЕРНОЕ ОБЩЕСТВО),";
    /* Центрирование наименования банка */
    if ( StrLen( Наименование_Банка ) < 65 )
      tmpInd = ( 75 - StrLen( Наименование_Банка ) ) / 2;
      tmpStr = "";
      while ( tmpInd > 0 )
        tmpStr = tmpStr + " ";
        tmpInd = tmpInd - 1;
      end;
      tmpStr = tmpStr + Наименование_Банка;
      Наименование_Банка = tmpStr;
    end;
    /* Центрирование наименования банка с запятой */
    if ( StrLen( Наименование_Банка_с_запятой ) < 72 )
      tmpInd = ( 72 - StrLen( Наименование_Банка_с_запятой ) ) / 2;
      tmpStr = "";
      while ( tmpInd > 0 )
        tmpStr = tmpStr + " ";
        tmpInd = tmpInd - 1;
      end;
      tmpStr = tmpStr + Наименование_Банка_с_запятой;
      Наименование_Банка_с_запятой = tmpStr;
    end;
    /*  Короткие маркеры  */
    if(strlen(party.rec.address)>20)
      i = 21;
      while( i > 9 )
        if(    ( substr(party.rec.address,i,1) == "." )
            or ( substr(party.rec.address,i,1) == "," )
            or ( substr(party.rec.address,i,1) == "-" )
            or ( substr(party.rec.address,i,1) == " " )
          )
            pos = i;
            i = 8;
        end;
        i = i - 1;
      end;
      Адрес_филиала_кор=substr(party.rec.address,1,pos);
      Продолжение_адреса_филиала_кор=substr(party.rec.address,pos+1,27);
    else
      Адрес_филиала_кор=party.rec.address
    end;
 end;

 Дата_пенсионн_удостоверения = String(cln.rec.SocialDate:m);
 Номер_пенсионн_удостоверения = cln.rec.SocialNumber;

 i=02; filled(i)=True; data(i)= "    ";
 i=03; filled(i)=True; data(i)= "    ";
 // i=04; filled(i)=True; data(i)= trim(Место_рождения);
 // i=05; filled(i)=True; data(i)= trim(Дом_тел);
 // i=06; filled(i)=True; data(i)= trim(Раб_тел);
 i=07; filled(i)=True; data(i)= "    ";
 i=08; filled(i)=True; data(i)= "    ";
 i=09; filled(i)=True; data(i)= "    ";
 i=11; filled(i)=True; data(i)= Сегодняшняя_дата;
 i=12; filled(i)=True; data(i)= ФИО_вкладчика;
 i=13; filled(i)=True; data(i)= Представитель_Банка;
 i=26; filled(i)=True; data(i)= Паспортные_данные_вкладчика;
 i=27; filled(i)=True; data(i)= Адрес_проживания_вкладчика;
 i=28; filled(i)=True; data(i)= Адрес_прописки_вкладчика;
 i=33; filled(i)=True; data(i)= Дата_рождения_вкладчика;
 i=34; filled(i)=True; data(i)= Номер_филиала;
 i=45; filled(i)=True; data(i)= Адрес_филиала;
 i=46; filled(i)=True; data(i)= Продолжение_адреса_филиала;
 i=50; filled(i)=True; data(i)= Город;
 i=51; filled(i)=True; data(i)= Наименование_Банка;
 i=52; filled(i)=True; data(i)= Наименование_Банка_с_запятой;
 i=53; filled(i)=True; data(i)= Наименован_Банка;
 i=65; filled(i)=True; data(i)= Адрес_филиала_кор;
 i=66; filled(i)=True; data(i)= Продолжение_адреса_филиала_кор;
 i=68; filled(i)=True; data(i)= БИК_банка;
 i=69; filled(i)=True; data(i)= Корр_счет_банка;
 i=70; filled(i)=True; data(i)= ИНН_банка;
 i=77; filled(i)=True; data(i)= Номер_пенсионн_удостоверения;
 i=78; filled(i)=True; data(i)= Дата_пенсионн_удостоверения;
END;

// Печатаем гражданство в договорах
macro FindCountry( code )
  file country ("country.dbt","sbbank.def") key 2;
  var ret_name  = "";
  var statrec;
   // KIN Для заведенных ранее клиентов
   if((code == "RUR") OR (code == "RU"))
      code = "RUS";
   end;
   clearrecord(country);
   rewind(country);
//   country.CodLat2 = code;
   country.CodeLat3 = Code;
   statrec = GetEQ(country);
   if(statrec)
     ret_name = Country.Name;
   else
      if ( code == "" )
      ret_name = "Россия";
      end;
   end;
  return ret_name;
end;

/**********************************************************************/

macro GetAddFilelds(cc, num)
var
  prop = TClientList;

  if (prop.GetRecord(cc))
    return prop.CurRec.GetProperty(num);
  else
    return "";
  end;
end;

/**********************************************************************/
MACRO getRequestedItems(data,filled,dep,doc,cln,payer)

 var ddep = TRecHandler( "i_dp_dep.rec" );
 var party = TRecHandler( "i_party.rec" );
 file
    OpStep ( sb_algop ) key 0;
 file
    AI     ( auxinfo  ) key 0;  /* Доп.информация счета */
 private const AI_GJS = 18;  /* Тип для auxinfo.dbt для ГЖС */;

 private var ClientList = TClientList;

 private var SQL, rsm1;

 var
    i, pos=60,

    Номер_счета   = String(Acc_Form(dep.Account):f),

    Сумма_вклада  = Double(doc.InSum),
    Дата_окончания_срока            = String(dep.End_DateDep:m),
    Дата_доп_соглашения             = String(dep.Open_Date:m),
    Дата_возврата_вклада            = String((dep.End_DateDep+1):m),
    Лимит_на_допвзнос               = $0,
    Минимальный_остаток             = String(dep.Limit),
    Номер_счета_при_переоформлении  = String(Acc_Form(dep.SvodAccount):f),
    Вид_вклада_при_переоформлении   = "",
    Вид_вклада_16_02_2006           = "",
    Номер_счета_до_16_02_2006       = "",
    Дата_открытия_при_переоформлен  = "",
    Дата_переоформления             = String( ( {curdate} + 1 ):m),
    Процентная_ставка_осн           = "",
    Вид_процентной_ставки_осн       = "????????????",
    Процентная_ставка_альт          = "",
    Вид_процентной_ставки_альт      = "????????????",
    Процентная_ставка_овер          = 0,
    Вид_процентной_ставки_овер      = "????????????",
    Процентная_ставка_доп           = 0,
    Вид_процентной_ставки_доп       = "????????????",
    Счет_в_долларах_США             = "",
    Валюта_Конверсионного           = "",
    Счет_в_рублях                   = "",
    Номер_Договора                  = "",
    Телефон_филиала                 = " ",
    Имя_валюты_прописью             = "??????????",
    Имя_валюты_краткое              = "???",
    Серия_ГЖС                       = "",
    Номер_ГЖС                       = 0,
    Дата_ГЖС                        = "",
    Сумма_ГЖС_цифрами               = $0,
    Сумма_ГЖС_строкой               = "",
    Кто_выдал_свидетельство         = "",
    ПаспортныеДанныеВид             = "",
    ПаспортныеДанныеНомер           = "",
    ПаспортныеДанныеКем             = "",
    ПаспортныеДанныеКодПодр         = "",
    Номер_договора_МО               = "",
    Наименование_МО                 = "",
    Дом_тел                         = "   ",
    Раб_тел                         = "   ",
    ИНН_Клиента                     = "",
    ВносительФИО                    = "",
    ВносительАдрес1                 = "",
    ВносительАдрес2                 = "",
    ВносительИНН                    = "",
    ВносительГражданство            = "",
    ВносительДокВид                 = "",
    ВносительДокНомер               = "",
    ВносительДокКем                 = "",
    ВносительДокПодр                = "",
    ВносительДатаРожд               = "",
    ВносительМестоРожд              = "",
    ВносительТел                    = "",
    ВносительФакс                   = "",
    Место_рождения                  = "   ",
    Данные_вносителя_0              = "     ",
    Данные_вносителя_1              = "     ",
    Данные_вносителя_2              = "     ",
    Данные_вносителя_3              = "     ",
    Данные_вносителя_4              = "     ";
    
    if ( ValType( ALG_CONTRACT ) == V_UNDEF )
      Номер_договора = String(dep.SvodAccount);
    else
      Номер_договора = ALG_CONTRACT.Number;
    end;

  var
    sDatePens,
    depType = TDepType( dep.IsCur, doc.Type_Account ),
    opDepType = depType.inheritsOperationsFrom,
    sn1, sn2, sn3, sumgjs;

    cln.GetPersnCard();
    sDatePens = String(cln.rec.SocialDate);

  /* Дата_пенсионн_удостоверения = SubStr(sDatePens,1,6)+SubStr(sDatePens,9,2); */
  

  if ( payer.rec.CodClient != 0 )
/* Убрано, по результатам аттестации 15.08.2001.
    Данные_вносителя_0 = "Вклад открыл вноситель " +
                                          payer.Sname + " " +
                                          payer.Name + " " +
                                          payer.Pname;
*/
    Данные_вносителя_0              = "     ";
    Данные_вносителя_1 = "ВНОСИТЕЛЬ:  " + payer.ConvertFIOFull();
    Данные_вносителя_2 = "адрес:   " +    payer.rec.Address;
    Данные_вносителя_3 = "дата рождения:   " + String( payer.rec.Born:m );
    Данные_вносителя_4 = getContractPaperStr( payer );

  end;

  getTypeAccReformContract( dep,
                            Вид_вклада_при_переоформлении,
                            Дата_открытия_при_переоформлен );

  getTypeAccContractNew( dep, Вид_вклада_16_02_2006, Номер_счета_до_16_02_2006);

  Дата_доп_соглашения = getDateAddEnd( dep );

  if ( Trim( doc.Type_Account ) == "ЦЕЛЕВОЙ" )
    ReWind( AI );
    ClearRecord( AI );
    AI.Reference = dep.Referenc;
    AI.InfoType  = AI_GJS;
    AI.Date      = dep.Open_Date;
    if ( GetEQ( AI ) )
      sn1 = Index( AI.Info, "SER.=" );
      sn2 = Index( AI.Info, "NUM.=" );
      sn3 = Index( AI.Info, "SUM.=" );
      Серия_ГЖС = SubStr( AI.Info, sn1 + 5, sn2 - sn1 - 6 );
      Номер_ГЖС = SubStr( AI.Info, sn2 + 5, sn3 - sn2 - 6 );
      sumgjs = Money( SubStr( AI.Info, sn3 + 5 ) );
      Сумма_ГЖС_строкой = String( sumgjs:m );
      Сумма_ГЖС_цифрами = String( sumgjs:a );
    end;
  end;

 getPcRate(dep,doc,PC_ACCOUNT_DEP,Вид_процентной_ставки_осн,
   Процентная_ставка_осн);
 getPcRate(dep,doc,PC_ACCOUNT_ALT,Вид_процентной_ставки_альт,
   Процентная_ставка_альт);
 getPcRate(dep,doc,PC_ACCOUNT_OVER,Вид_процентной_ставки_овер,
   Процентная_ставка_овер);
 getPcRate(dep,doc,PC_ACCOUNT_DOP,Вид_процентной_ставки_доп,
   Процентная_ставка_доп);
 cur.Code_Currency = dep.Code_Currency;
 if(getEQ(cur))
    Имя_валюты_прописью            = cur.Name_Currency;
    Имя_валюты_краткое             = cur.Short_Name;
 end;

 if(findDepartment(NumFNCash, null, ddep, party))
    /* Определение лимита на доп.взнос */
    ClearRecord( OpStep );
    OpStep.IsCur      = doc.IsCur;
    OpStep.Kind       = opDepType;
    OpStep.NumOpert   = OP_INDOP;
    OpStep.NumStepAlg = ALGCHIK;
    if ( GetGE( OpStep )                            AND
         ( OpStep.IsCur      == doc.IsCur )         AND
         ( OpStep.Kind       == opDepType )         AND
         ( OpStep.NumOpert   == OP_INDOP )          AND
         ( OpStep.NumStepAlg == ALGCHIK ) )
      Лимит_на_допвзнос = OpStep.prmD;
    end;
 end;

 Номер_Договора = dep.SvodAccount;

 Счет_в_долларах_США = SubStr( Номер_счета, 1, 5 ) + "." +
                       String( cur.ExternalCode:3 ) +
                       SubStr( Номер_счета, 10 );

 Валюта_Конверсионного = cur.Short_Name + " (" + cur.Name_Currency + ")";

 Счет_в_рублях = Номер_счета;

 if ( strLen( Номер_Договора ) != 0 )
   /* Чтение первого счета из пары */
   ClearRecord( dd );
   dd.FNCash        = dep.FNCash;
   dd.SvodAccount   = dep.SvodAccount;
   dd.Code_Currency = 0;
   if ( GetGE( dd )                             AND
        ( dd.FNCash       == dep.FNCash )       AND
        ( dd.SvodAccount  == dep.SvodAccount )  AND
        ( dd.Type_Account == dep.Type_Account ) )
     if ( dep.IsCur == 0 )
       /* Поиск парного валютного счета для "Конверсионного" */
       if ( dd.Code_Currency == 0 )
         if ( Next( dd )                               AND
              ( dd.FNCash        == dep.FNCash )       AND
              ( dd.SvodAccount   == dep.SvodAccount )  AND
              ( dd.Code_Currency != 0 )                AND
              ( dd.Type_Account  == dep.Type_Account ) )
           Счет_в_долларах_США = String(Acc_Form(dd.Account):f);
           CurName( dd.Code_Currency );
           Валюта_Конверсионного = cur.Short_Name + " (" +
                                   cur.Name_Currency + ")";
         end;
       end;
     else
       /* Поиск парного рублевого счета для "Конверсионного" */
       if ( dd.Code_Currency == 0 )
         Счет_в_рублях = String(Acc_Form(dd.Account):f);
       end;
     end;
   end;
 end;

 Место_рождения = GetAddFilelds(Cln.rec.CodClient, 1);
 Дом_тел        = GetAddFilelds(Cln.rec.CodClient, 4);
 Раб_тел        = GetAddFilelds(Cln.rec.CodClient, 5);

 // Паспортные данные по формату Вид Серия Номер кем,где, когда выдан, код подразделения

  SQL = " SELECT NVL(dp.t_name,' ') NameClient "+
        "        ,NVL((SELECT t_code FROM dpartcode_dbt WHERE t_partyid = " + dep.CodClient + " AND t_codekind = 16),' ') Inn "
        "        ,DECODE(dpk.t_name,NULL,'__________',chr(1),'__________',dpk.t_name) pKind              "+
        "        ,DECODE(di.t_paperSeries,NULL,'____',CHR(1),'____',di.t_paperSeries) pSer   "+
        "        ,DECODE(di.t_paperNumber,NULL,'______',CHR(1),'_______',di.t_paperNumber) pNum   "+
        "        ,DECODE(di.t_paperIssuedDate,to_date('01.01.0001','dd.mm.yyyy'),' ',NULL,' ',TO_CHAR(di.t_paperIssuedDate,'dd.mm.yyyy')) IssDate "+
        "        ,DECODE(di.t_paperIssuer,NULL,'__________',CHR(1),'__________',di.t_paperIssuer) Issr   "+
        "        ,DECODE(di.t_paperIssuerCode,NULL,'________',CHR(1),'________',di.t_paperIssuerCode) IssCode   "+
        "  FROM dparty_dbt dp,dpersnidc_dbt di,dpersn_dbt dpp,dpaprkind_dbt dpk                 "+
        "  WHERE dp.t_partyid = " + dep.CodClient +
        "        AND di.t_personid(\+) =  dp.t_partyid                                          "+
        "        AND di.t_ismain(\+) = 'X'                                                      "+
        "        AND dpp.t_personid(\+) = dp.t_partyid                                          "+
        "        AND dpk.t_paperkind(\+) = di.t_paperkind                                       ";

 ПаспортныеДанныеВид = "_____________________";
 ПаспортныеДанныеНомер = "__________________";
 ПаспортныеДанныеКем = "________________________________________";
 rsm1 = RsdRecordSet( SQL );
 if ( rsm1.MoveNext )
   ПаспортныеДанныеВид   = rsm1.value("pKind");
   ПаспортныеДанныеНомер = rsm1.value("pSer") + " " + rsm1.value("pNum");
   ПаспортныеДанныеКем   = rsm1.value("Issr") + " " + rsm1.value("IssDate");
   ПаспортныеДанныеКодПодр = rsm1.value("IssCode");
   ИНН_Клиента           = rsm1.value("Inn");
 end;

 // Телефон_филиала = branch.Phone;

 i=00; filled(i)=True; data(i)= "    ";
 i=01; filled(i)=True; data(i)= "    ";
 i=02; filled(i)=True; data(i)= "    ";
 i=03; filled(i)=True; data(i)= "    ";
 i=04; filled(i)=True; data(i)= trim(Место_рождения);
 i=05; filled(i)=True; data(i)= trim(Дом_тел);
 i=06; filled(i)=True; data(i)= trim(Раб_тел);
 i=07; filled(i)=True; data(i)= "    ";
 i=08; filled(i)=True; data(i)= "    ";
 i=09; filled(i)=True; data(i)= "    ";
 i=10; filled(i)=True; data(i)= Номер_счета;
 i=11; filled(i)=True; data(i)= Сегодняшняя_дата;
 // i=12; filled(i)=True; data(i)= ФИО_вкладчика;
 // i=13; filled(i)=True; data(i)= Представитель_Банка;
 i=14; filled(i)=True; data(i)= moneyByDigits(dep.IsCur,Сумма_вклада,dep.Code_Currency);
 i=15; filled(i)=True; data(i)= moneyByWords(dep.IsCur,Сумма_вклада,dep.Code_Currency);
 i=16; filled(i)=True; data(i)= Имя_валюты_прописью;
 i=17; filled(i)=True; data(i)= Имя_валюты_краткое;
 i=18; filled(i)=True; data(i)= String(Срок_вклада_месяцы);
 i=19; filled(i)=True; data(i)= byWords(Срок_вклада_месяцы);
 i=20; filled(i)=True; data(i)= String(Money(Годовые_проценты));
 i=21; filled(i)=True; data(i)= percentsByWords(Годовые_проценты);
 i=22; filled(i)=True; data(i)= String(Срок_перечисления_дни);
 i=23; filled(i)=True; data(i)= byWords(Срок_перечисления_дни);
 i=24; filled(i)=True; data(i)= String(Срок_возврата_вклада_дни);
 i=25; filled(i)=True; data(i)= byWords(Срок_возврата_вклада_дни);
 // i=26; filled(i)=True; data(i)= Паспортные_данные_вкладчика;
 // i=27; filled(i)=True; data(i)= Адрес_проживания_вкладчика;
 // i=28; filled(i)=True; data(i)= Адрес_прописки_вкладчика;
 i=29; filled(i)=True; if(Вклад_наличными)
                         data(i) = "наличными деньгами";
                       else
                         data(i) = "безналичным  путем";
                       end;
 i=30; filled(i)=True; data(i)= Срок_окончания_договора;
 i=31; filled(i)=True; data(i)= Срок_вклада_словами;
 i=32; filled(i)=True; data(i)= Срок_вклада_годы_месяцы_дни;
 // i=33; filled(i)=True; data(i)= Дата_рождения_вкладчика;
 // i=34; filled(i)=True; data(i)= Номер_филиала;
 i=35; filled(i)=True; data(i)= Дата_окончания_срока;
 i=36; filled(i)=True; data(i)= Процентная_ставка_осн;
 i=37; filled(i)=True; data(i)= Вид_процентной_ставки_осн;
 i=38; filled(i)=True; data(i)= Процентная_ставка_альт;
 i=39; filled(i)=True; data(i)= Вид_процентной_ставки_альт;
 i=40; filled(i)=True; data(i)= Процентная_ставка_овер;
 i=41; filled(i)=True; data(i)= Вид_процентной_ставки_овер;
 i=42; filled(i)=True; data(i)= Процентная_ставка_доп;
 i=43; filled(i)=True; data(i)= Вид_процентной_ставки_доп;
 i=44; filled(i)=True; data(i)= Срок_вклада_годы_месяцы_дни;
 // i=45; filled(i)=True; data(i)= Адрес_филиала;
 // i=46; filled(i)=True; data(i)= Продолжение_адреса_филиала;
 i=47; filled(i)=True; data(i)= String(Дата_доп_соглашения:m);
 i=48; filled(i)=True; data(i)= String((Дата_доп_соглашения+1):m);
 i=49; filled(i)=True; data(i)= "    ";
 // i=50; filled(i)=True; data(i)= Город;
 // i=51; filled(i)=True; data(i)= Наименование_Банка;
 // i=52; filled(i)=True; data(i)= Наименование_Банка_с_запятой;
 // i=53; filled(i)=True; data(i)= Наименован_Банка;
 i=54; filled(i)=True; data(i)= "    ";
 i=55; filled(i)=True; data(i)= Дата_возврата_вклада;
 i=56; filled(i)=True; data(i)= "    ";
 i=57; filled(i)=True; data(i)= "    ";
 i=58; filled(i)=True; data(i)= "    ";
 i=59; filled(i)=True; data(i)= "    ";
 i=60; filled(i)=True; data(i)= Данные_вносителя_0;
 i=61; filled(i)=True; data(i)= Данные_вносителя_1;
 i=62; filled(i)=True; data(i)= Данные_вносителя_2;
 i=63; filled(i)=True; data(i)= Данные_вносителя_3;
 i=64; filled(i)=True; data(i)= Данные_вносителя_4;
 // i=65; filled(i)=True; data(i)= Адрес_филиала_кор;
 // i=66; filled(i)=True; data(i)= Продолжение_адреса_филиала_кор;
 i=67; filled(i)=True; data(i)= Телефон_филиала;
 // i=68; filled(i)=True; data(i)= БИК_банка;
 // i=69; filled(i)=True; data(i)= Корр_счет_банка;
 // i=70; filled(i)=True; data(i)= ИНН_банка;
 i=71; filled(i)=True; data(i)= Счет_в_долларах_США;
 i=72; filled(i)=True; data(i)= Счет_в_рублях;
 i=73; filled(i)=True; data(i)= Номер_Договора;
 i=74; filled(i)=True; data(i)= Валюта_Конверсионного;
 i=75; filled(i)=True; data(i)= "    ";
 i=76; filled(i)=True; data(i)= "    ";
 // i=77; filled(i)=True; data(i)= Номер_пенсионн_удостоверения;
 // i=78; filled(i)=True; data(i)= Дата_пенсионн_удостоверения;
 i=79; filled(i)=True; data(i)= Лимит_на_допвзнос;
 i=80; filled(i)=True; data(i)= Минимальный_остаток;
 i=81; filled(i)=True; data(i)= Вид_вклада_при_переоформлении;
 i=82; filled(i)=True; data(i)= Номер_счета_при_переоформлении;
 i=83; filled(i)=True; data(i)= Дата_открытия_при_переоформлен;
 i=84; filled(i)=True; data(i)= Дата_переоформления;
 i=85; filled(i)=True; data(i)= Серия_ГЖС;
 i=86; filled(i)=True; data(i)= Номер_ГЖС;
 i=87; filled(i)=True; data(i)= Сумма_ГЖС_строкой;
 i=88; filled(i)=True; data(i)= Сумма_ГЖС_цифрами;
 i=89; filled(i)=True; data(i)= Номер_договора;
 i=90; filled(i)=True; data(i)= moneyByWords(dep.isCur,Сумма_вклада,dep.Code_Currency);
 i=91; filled(i)=True; data(i)= FindCountry( ClientList.curRec.rec.NrCountry);
 i=92;filled(i)=True; data(i)= Вид_вклада_16_02_2006;
 i=93;filled(i)=True; data(i)= Номер_счета_до_16_02_2006;
 i=94;filled(i)=True; data(i)= Дата_ГЖС;
 i=95;filled(i)=True; data(i)= Кто_выдал_свидетельство;
 i=96;filled(i)=True; data(i)= Номер_договора_МО;
 i=97;filled(i)=True; data(i)= Наименование_МО;
 i=98;filled(i)=True; data(i)= "";
 i=99;filled(i)=True; data(i)= "";
 i=100;filled(i)=True; data(i)= "";
 i=101; filled(i)=True; data(i)= StrSubst(Номер_счета,".","");
 i=102; filled(i)=True; data(i)= dep.Limit_date;
 i=103; filled(i)=True; data(i)= String(dep.Start_DateDep:m);
 i=104; filled(i)=True; data(i)= ИНН_Клиента;
 i=105; filled(i)=True; data(i)= ПаспортныеДанныеВид;
 i=106; filled(i)=True; data(i)= ПаспортныеДанныеНомер;
 i=107; filled(i)=True; data(i)= ПаспортныеДанныеКем;
 i=108; filled(i)=True; data(i)= ПаспортныеДанныеКодПодр;
 i=109; filled(i)=True; data(i)= ВносительФИО;
 i=110; filled(i)=True; data(i)= ВносительАдрес1;
 i=111; filled(i)=True; data(i)= ВносительАдрес2;
 i=112; filled(i)=True; data(i)= ВносительИНН;
 i=113; filled(i)=True; data(i)= ВносительГражданство;
 i=114; filled(i)=True; data(i)= ВносительДокВид;
 i=115; filled(i)=True; data(i)= ВносительДокНомер;
 i=116; filled(i)=True; data(i)= ВносительДокКем;
 i=117; filled(i)=True; data(i)= ВносительДокПодр;
 i=118; filled(i)=True; data(i)= ВносительДатаРожд;
 i=119; filled(i)=True; data(i)= ВносительМестоРожд;
 i=120; filled(i)=True; data(i)= ВносительТел;
 i=121; filled(i)=True; data(i)= ВносительФакс;
 i=122; filled(i)=True; data(i)= StrSubst(Номер_счета_при_переоформлении,".","");
 i=123; filled(i)=True; data(i)= StrSubst(Номер_счета_до_16_02_2006,".","");
 i=124; filled(i)=True; data(i)= GetAddFilelds(Cln.rec.CodClient, 115);

 getCommonItems (data, filled, cln);

 return True;

END;
/**********************************************************************/
MACRO checkBlank(firstBlankLine,lastBlankLine,blank,blankName)

 var
    currentLine = 0,
    startOfBlankFounded = False,
    endOfBlankFounded   = False,
    tmp;

 firstBlankLine = currentLine;
 lastBlankLine  = currentLine;
 if(NOT open(blank,blankName)) return False; end;
 while(
          (next(blank))
      AND NOT ((startOfBlankFounded) AND (endOfBlankFounded))
      )
   currentLine = currentLine + 1;
   tmp = blank.str;
   if(   (NOT (startOfBlankFounded))
     AND (StrLen(tmp) >= StrLen(START_OF_BLANK_MARKER))
     AND (Index(StrUpr(tmp),START_OF_BLANK_MARKER)!=0)
     )
     startOfBlankFounded = True;
     firstBlankLine = currentLine + 1; SetParm(0,firstBlankLine);
   end;
   if(   (NOT (endOfBlankFounded))
     AND (StrLen(tmp) >= StrLen(END_OF_BLANK_MARKER))
     AND (Index(StrUpr(tmp),END_OF_BLANK_MARKER)!=0)
     )
     endOfBlankFounded = True;
     lastBlankLine = currentLine - 1; SetParm(1,lastBlankLine);
   end;
 end;

 Rewind(blank);
 return True;

END;
/**********************************************************************/
MACRO replaceSubstring(source,old,new);

 var
    result,
    sourceLenth = StrLen(source),
    oldStart    = Index(source,old);

 if(oldStart==0) result = source;
 else            result = SubStr(source,1,oldStart-1) + new +
                            SubStr(source,oldStart+StrLen(old));
 end;
 return result;

END;
/**********************************************************************/
MACRO overlapeSubstring(source,position,new);

 var
    result,
    tail,
    head        = SubStr(source,1,position-1),
    newLenth    = StrLen(new),
    sourceLenth = StrLen(source);

 if((position + newLenth) > sourceLenth)
   tail ="";
 else
   tail = SubStr(source,position+newLenth,sourceLenth-(position+newLenth)+1);
 end;
 return head + new + tail;

END;
/**********************************************************************/
MACRO getInserterData(code,data,filled)

 if(code == 99)
   return " ";
 end;
 if(    (code < MAX_INSERTERS_TYPES)
    AND (filled(code))
   )
   return data(code);
 end;
 return "??";

END;
/**********************************************************************/
MACRO isDecimalDigit(field)

 if(Index(decimalSet,field)!=0) return True;
 else                           return False;
 end;

END;
/**********************************************************************/
MACRO processInsertersBlock(leftBound,rightBound,
                              line,leftPosition,rightPosition,
                                data,filled)

 var
    blockLenth = rightPosition - leftPosition + 1,
    inserterCode,
    position = leftPosition+1,
    tmp           = "";

 while(position < rightPosition)
    if(    (isDecimalDigit(SubStr(line,position,1)))
       AND (isDecimalDigit(SubStr(line,position+1,1)))
       AND (isDecimalDigit(SubStr(line,position+2,1)))
      )
      inserterCode = Int(SubStr(line,position,3));
      if(inserterCode == 2)
        leftBound  = position - 1; SetParm(0,leftBound);
      end;
      if(inserterCode == 3)
        rightBound = position + 2; SetParm(1,rightBound);
      end;
      if(inserterCode == 99)
        tmp = tmp + pc_rates_line;
      end;
      tmp = tmp + getInserterData(inserterCode,data,filled);
      position = position + 3;
    elif(  (isDecimalDigit(SubStr(line,position,1)))
       AND (isDecimalDigit(SubStr(line,position+1,1)))
      )
      inserterCode = Int(SubStr(line,position,3));
      if(inserterCode == 2)
        leftBound  = position - 1; SetParm(0,leftBound);
      end;
      if(inserterCode == 3)
        rightBound = position + 2; SetParm(1,rightBound);
      end;
      if(inserterCode == 99)
        tmp = tmp + pc_rates_line;
      end;
      tmp = tmp + getInserterData(inserterCode,data,filled);
      position = position + 2;
    else
      tmp = tmp + SubStr(line,position,1);
      position = position + 1;
    end;
 end;
 if(StrLen(tmp) < blockLenth)
   tmp = tmp + MkStr("_",blockLenth - StrLen(tmp));
 end;
 line = overlapeSubstring(line,leftPosition,tmp);
 return line;

END;
/**********************************************************************/
MACRO processLineOfBlank(leftBound,rightBound,
                          data,filled,
                           overlappedString,line);

 var
    inserterDetected = False,
    lineSize,
    mostLeftPosition,
    leftPosition,
    rightPosition,
    tmp,
    result;

 if(StrLen(overlappedString(1)) != 0)
   StrSplit(overlappedString(1),overlappedString,250,
              rightBound-leftBound+1,2);
   line=overlapeSubstring(line,leftBound,overlappedString(0));
 end;

 lineSize      = StrLen(line);
 leftPosition  = Index(line,"<");
 rightPosition = Index(line,">");
 mostLeftPosition = leftPosition;
 tmp = line;
 while(   (leftPosition  !=0)
      AND (rightPosition !=0)
      AND (leftPosition+2  < rightPosition)
      AND (StrLen(tmp)<250)
      )
      inserterDetected = True;
      tmp = processInsertersBlock(leftBound,rightBound,
                                     tmp,leftPosition,rightPosition,
                                      data,filled);
      SetParm(0,leftBound); SetParm(1,rightBound);
      leftPosition  = Index(tmp,"<");
      rightPosition = Index(tmp,">");
 end;
 if(inserterDetected)
   if(StrLen(tmp) > rightBound)
     StrSplit(tmp,overlappedString,250,rightBound,2);
     tmp = overlappedString(0);
   end;
   result = tmp;
 else
   result = line;
 end;
 return result;

END;
/**********************************************************************/
MACRO fillInBlank(data,filled,firstBlankLine,endBlankLine,blank);

 var
    leftBound   = 1,
    rightBound  =70,
    tmp,
    currentLine = 0;
 array
    overlappedString; asize(overlappedString,2);
    overlappedString(0)=""; overlappedString(1)="";

 while( next(blank))
    currentLine = currentLine + 1;
    if(   (currentLine >= firstBlankLine)
      AND (currentLine <= endBlankLine)
      )
      tmp=processLineOfBlank(leftBound,rightBound,
                              data,filled,
                              overlappedString,blank.str);
      println(tmp);
    end;
 end;
 Rewind(blank);

END;

/**********************************************************************/
MACRO WordDeal( blank, blankName, dep, doc, cln, payer, CloseDoc : bool )

 //var TxtDir = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", TRUE );
 var FNdt = TxtDir + "03." + String( {CNum} );
 var tagFile;
 var realFileName = "";

 var count, insertedItemsFounded;

 var i = 0, nLenIndex = 0, sIndex = "", sNameMark = "";

 array
    filled; asize( filled, MAX_INSERTERS_TYPES );
 array
    data;   asize( data,   MAX_INSERTERS_TYPES );

 count = 0;
 while ( count < MAX_INSERTERS_TYPES )
   data( count )   = "";
   filled( count ) = FALSE;
   count = count + 1;
 end;

 getCommonItems (data, filled, cln);
 insertedItemsFounded = getRequestedItems( data, filled, dep, doc, cln, payer );

 if ( insertedItemsFounded )

   printLn( blankName );  // Путь к шаблону договора.
   println( "RT_ACC" );   // Имя выходного файла формата MS-Word.

   // Заполнение списка маркеров.
   i = 0;
   while ( i < MAX_INSERTERS_TYPES )
     if ( filled( i ) )       // Значение маркера установлено.
       sIndex = String( i );
       nLenIndex = StrLen( sIndex );
       sNameMark = "~M_" + SubStr( "00", 1, 2 - nLenIndex ) + sIndex;
       printLn( sNameMark );  // Маркер.
       printLn( data( i ) );  // Значение маркера.
     end;
     i = i + 1;
   end;

   tagFile = SetOutPut( FNdt, FALSE);

   DLWREPS_PrintReportFromTagFile( tagFile, @realFileName, CloseDoc );

 end;
 return realFileName;
END;

/**********************************************************************/
MACRO SCWordDeal ( blank, blankName, CardProduct )

 //var TxtDir = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", TRUE );
 var FNdt = TxtDir + "03." + String( {CNum} );
 var tagFile;

 var
     Номер_договора              = "??????",
     Дата_открытия_договора      = "??????",
     Платёжная_система_карты     = "??????";

 var clnt = ALG_COMDEPCLNT; 
 var query = "SELECT scps.T_PAYSYSNAME FROM dsccard_dbt scc, dscpaysys_dbt scps WHERE scc.T_CONTRACTID = "+string(ALG_CARDCONTRACT.ID)+" AND scc.T_FNCASH = "+string(ALG_CARDCONTRACT.branch)+" AND scps.T_PAYSYSID = scc.T_PAYSYSID";
 var rs = RsdRecordSet(query);

 if (rs.MoveNext)
     Платёжная_система_карты = rs.value("T_PAYSYSNAME");
 end;

 Rt_contract.ID = ALG_CARDCONTRACT.ID;
 Rt_contract.Branch = ALG_CARDCONTRACT.Branch;

 if (getEQ(Rt_contract))
    Номер_договора             = Rt_contract.Number;
    Дата_открытия_договора     = Rt_contract.OpenDate; 
    //clnt.GetRecord(Rt_contract.ClientCode);    
 else
    MsgBox("Не найден контракт");
    return false;
 end;

 var count, insertedItemsFounded;

 var i = 0, nLenIndex = 0, sIndex = "", sNameMark = "";

 array
    filled; asize( filled, MAX_INSERTERS_TYPES );
 array
    data;   asize( data,   MAX_INSERTERS_TYPES );

 count = 0;
 while ( count < MAX_INSERTERS_TYPES )
   data( count )   = "";
   filled( count ) = FALSE;
   count = count + 1;
 end;

 getCommonItems (data, filled, clnt);

 i = 95; filled(i) = TRUE; data(i) = Номер_договора;
 i = 96; filled(i) = TRUE; data(i) = Дата_открытия_договора;
 i = 97; filled(i) = TRUE; data(i) = Платёжная_система_карты;

 printLn( blankName );  // Путь к шаблону договора.
 println( "RT_CARD" );   // Имя выходного файла формата MS-Word.

 // Заполнение списка маркеров.
 i = 0;
 while ( i < MAX_INSERTERS_TYPES )
    if ( filled( i ) )       // Значение маркера установлено.
       sIndex = String( i );
       nLenIndex = StrLen( sIndex );
       sNameMark = "~M_" + SubStr( "00", 1, 2 - nLenIndex ) + sIndex;
       printLn( sNameMark );  // Маркер.
       printLn( data( i ) );  // Значение маркера.
     end;
     i = i + 1;
 end;

 tagFile = SetOutPut( FNdt, FALSE);

 DLWREPS_PrintReportFromTagFile( tagFile );

END;

/**********************************************************************/
MACRO PrintDeal(blank,blankName,dep,doc,cln,payer)

 var
    count,
    firstBlankLine=0,
    endBlankLine=0,
    insertedItemsFounded,
    validBlankFounded;

 array
    filled; asize(filled,MAX_INSERTERS_TYPES);
 array
    data;   asize(data,  MAX_INSERTERS_TYPES);
 array
    currFlagStr;

 currFlagStr(0)=" (рублевый) ";
 currFlagStr(1)=" (валютный) ";

 count = 0;
 while(count < MAX_INSERTERS_TYPES)
   data(count)   = "";
   filled(count) = False;
   count = count +1;
 end;

 validBlankFounded    = checkBlank(firstBlankLine,endBlankLine,
                                      blank,blankName);
 if(NOT validBlankFounded)
   MsgBox("Бланк для договора "+ dep.Type_Account +
     currFlagStr(dep.IsCur) + " не найден ...");
   return;
 end;
 insertedItemsFounded = getRequestedItems(data,filled,dep,doc,cln,payer);

 if(   (insertedItemsFounded)
   AND (validBlankFounded)
   AND (firstBlankLine > 0)
   AND (endBlankLine >= firstBlankLine)
   )
   fillInBlank(data,filled,firstBlankLine,endBlankLine,blank);
 else
   MsgBox("Бланк договора  некорректен...");
 end;
 return;

END;
/**********************************************************************/
MACRO deleteSpaces(stringWithSpaces);

 var
    position,
    tmp1,tmp2,
    result=stringWithSpaces;

 while(Index(result," ") != 0)
    position=Index(result," ");
    if(  ( position ==1 )
      OR ( position == StrLen(result) )
      )
      Trim(result);
    else;
      tmp1 = SubStr(result,1,position-1);
      tmp2 = SubStr(result,position+1);
      result = tmp1 + tmp2;
    end;
 end;
 return result;

END;
/**********************************************************************/
MACRO getAccountExpirationDate(dep)

 var
    result;

 result = String(dep.End_DateDep:m);
 return result;

END;
/**********************************************************************/
MACRO getYearWord(value)

 var
    lastDecimalDigit,
    empty = "",
    word  = " лет";

 if(value==0) return empty; end;
 lastDecimalDigit = value - (value/10*10);
 if(lastDecimalDigit==1)                                word = " год ";  end;
 if( (lastDecimalDigit > 1) AND (lastDecimalDigit < 5)) word = " года "; end;
 return String(value) + word;

END;
/**********************************************************************/
MACRO getMonthWord(value)

 var
    lastDecimalDigit,
    empty = "",
    suffix = "ев";

 if(value==0) return empty; end;
 lastDecimalDigit = value - (value/10*10);
 if(lastDecimalDigit==1)                                suffix = "" ; end;
 if( (lastDecimalDigit > 1) AND (lastDecimalDigit < 5)) suffix = "а"; end;
 return String(value) + " месяц" + suffix;

END;
/**********************************************************************/
MACRO getDayWord(value)

 var
    lastDecimalDigit,
    empty = "",
    word  = " дней";

 if(value==0) return empty; end;
 lastDecimalDigit = value - (value/10*10);
 if(lastDecimalDigit==1)                                word = " день"; end;
 if( (lastDecimalDigit > 1) AND (lastDecimalDigit < 5)) word = " дня";  end;
 return String(value) + word;

END;
/**********************************************************************/
MACRO getYearMonDaysWords(periodInDays)

 var
    years, months, days, r_y, r_m,
    andWord = "",
    result = "";

 if(periodInDays==0) return ""; end;
 years  = periodInDays/360;
 r_y    = periodInDays - years * 360;
 months = r_y/30;
 r_m    = r_y - months * 30;
 days   = r_m - ( r_m / 30 ) * 30;
 if ( ( months != 0 )  AND  ( days != 0 ) )
   andWord = " и ";
 end;
 return getYearWord(years) + getMonthWord(months) + andWord + getDayWord(days);

END;
/**********************************************************************/
MACRO adjustParameters(foundedAccountType,dep,doc)

 const
    Безналичные       = 0,
    Наличные          = 1,

    TERM_DAY          = 1,  /* в днях       */
    TERM_MONTH        = 2,  /* в месяцах    */
    TERM_MON3         = 3,  /* в кварталах  */
    TERM_YEAR         = 4;  /* в годах      */
 var
    days=0,
    months,
    periodKind = dep.KindTerm;

 if(periodKind==TERM_DAY)
   Срок_вклада_словами = String(dep.Term) + "дней";
 end;
 if(periodKind==TERM_MON3)  months = dep.Term *  3; end;
 if(periodKind==TERM_YEAR)  months = dep.Term * 12; end;
 if(periodKind==TERM_MONTH) months = dep.Term;      end;
 if(  (periodKind==TERM_MON3)
   OR (periodKind==TERM_YEAR)
   OR (periodKind==TERM_MONTH)
   )
   Срок_вклада_месяцы  = months;
   Срок_вклада_словами = getMonthWord(dep.Term);
 end;

 if(periodKind==TERM_DAY)   days = dep.Term;       end;
 if(periodKind==TERM_MON3)  days = dep.Term *  90; end;
 if(periodKind==TERM_YEAR)  days = dep.Term * 360; end;
 if(periodKind==TERM_MONTH) days = dep.Term *  30; end;

 Срок_вклада_годы_месяцы_дни = getYearMonDaysWords(days);
 Срок_окончания_договора     = getAccountExpirationDate(dep);

 if(doc.VidDoc == Безналичные)  Вклад_наличными = False; end;
 if(doc.VidDoc == Наличные   )  Вклад_наличными = True;  end;

END;

/**********************************************************************/
/*****   Проверка для выпуска доп.соглашений по "Особым номерным" *****/
/**********************************************************************/
/*
MACRO SpecialNumber( dep, res )
  var ret = res;
  var st;
  ClearRecord( sn );
  sn.Referenc = dep.Referenc;
  sn.TypeOper = OP_GETCON;
  st = getGE( sn );
  while ( st                               AND
          ( sn.Referenc == dep.Referenc )  AND
          ( sn.TypeOper == OP_GETCON    ) )
    if ( sn.TypeComplexOper == OP_REFNUM )  /* Операция переоформления */
      return blankSpecialNumber;
    end;
    st = Next( sn );
  end;
  return ret;
END;
*/

/**********************************************************************/
MACRO existWordBlank( dep )

 var
   delimiterSize = StrLen( delimiter ),
   typeAccount = Trim( dep.Type_Account ),
   isCur = dep.IsCur,
   foundCurrFlag,
   docName = "",
   docFound = FALSE,
   i = 0,
   foundedAccountType,
   delimiterPosition,
   currFlagPosition,
   corDir;

 while( WordBlnk(i) != "END_OF_LIST" )
   foundCurrFlag = 0;
   delimiterPosition = Index( WordBlnk(i), delimiter );
   currFlagPosition = Index( WordBlnk(i), "руб." );
   if ( currFlagPosition == 0 )
     currFlagPosition = Index( WordBlnk(i), "вал." );
     if ( currFlagPosition != 0 )
       foundCurrFlag = 1;
     else
       currFlagPosition = delimiterPosition;
     end;
   end;
   if ( delimiterPosition > 0 )
     foundedAccountType = Trim( SubStr(WordBlnk(i), 1, currFlagPosition-1 ) );
     if ( ( typeAccount == foundedAccountType ) and ( isCur == foundCurrFlag ) )
       docName = Trim( SubStr( WordBlnk(i), delimiterPosition + delimiterSize ) );
       //corDir = DLREPTL_GetDotFileDir( getregval("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEMPLSDIR", false) );
       if ( /*ExistFile(docName)*/  DLREPTL_GetDotFileDir(docName) != "\\")
         docFound = TRUE;
       end;
     end;
   end;
   i = i + 1;
 end;
 return docFound;

END;

/**********************************************************************/
MACRO getWordBlank( dep, doc )

 var
    delimiterSize = StrLen(delimiter),
    typeAccount = Trim(dep.Type_Account),
    isCur=dep.IsCur,
    foundCurrFlag,
    result = "",
    i = 0,
    foundedAccountType,
    delimiterPosition,
    currFlagPosition;

 while( WordBlnk(i) != "END_OF_LIST" )
    foundCurrFlag = 0;
    delimiterPosition=Index(WordBlnk(i),delimiter);
    currFlagPosition=Index(WordBlnk(i),"руб.");
    if(currFlagPosition==0)
      currFlagPosition=Index(WordBlnk(i),"вал.");
      if(currFlagPosition!=0)
        foundCurrFlag=1;
      else
        currFlagPosition=delimiterPosition;
      end;
    end;
    if(delimiterPosition > 0)
      foundedAccountType = Trim(SubStr(WordBlnk(i),1,currFlagPosition-1));
      if((typeAccount==foundedAccountType) and (isCur==foundCurrFlag))
        adjustParameters(foundedAccountType,dep,doc);
        result = Trim(SubStr(WordBlnk(i),delimiterPosition+delimiterSize));
        /* Проверка для выпуска доп.соглашений по "Особым номерным" */
        /* Сделан новый механизм выпуска доп.соглашений через НФО 293.
        if ( ( foundedAccountType == "Особый на 2г" )  OR
             ( foundedAccountType == "Особый 1г_1м" )  OR
             ( foundedAccountType == "Особый на 3м" ) )
          result = SpecialNumber( dep, result );
        end;
        */
        return result;
      end;
    end;
    i = i + 1;
 end;
 return result;

END;

/**********************************************************************/
MACRO getBlank( dep, doc )

 var
    delimiterSize = StrLen(delimiter),
    typeAccount = Trim(dep.Type_Account),
    isCur=dep.IsCur,
    foundCurrFlag,
    result = "",
    i = 0,
    foundedAccountType,
    delimiterPosition,
    path,
    currFlagPosition;

 while( Бланки(i) != "END_OF_LIST" )
    foundCurrFlag = 0;
    delimiterPosition=Index(Бланки(i),delimiter);
    currFlagPosition=Index(Бланки(i),"руб.");
    if(currFlagPosition==0)
      currFlagPosition=Index(Бланки(i),"вал.");
      if(currFlagPosition!=0)
        foundCurrFlag=1;
      else
        currFlagPosition=delimiterPosition;
      end;
    end;
    if(delimiterPosition > 0)
      foundedAccountType = Trim(SubStr(Бланки(i),1,currFlagPosition-1));
      if((typeAccount==foundedAccountType) and (isCur==foundCurrFlag))
        adjustParameters(foundedAccountType,dep,doc);
        result = Trim(SubStr(Бланки(i),delimiterPosition+delimiterSize));
        /* Проверка для выпуска доп.соглашений по "Особым номерным" */
        /*
        if ( ( foundedAccountType == "Особый на 2г" )  OR
             ( foundedAccountType == "Особый 1г_1м" )  OR
             ( foundedAccountType == "Особый на 3м" ) )
          result = SpecialNumber( dep, result );
        end;
        */
        path = DLREPTL_GetDotFileDir(result);
        if(path != "\\")
  	          result = path + result; 
        end;
        return result;
      end;
    end;
    i = i + 1;
 end;
 return result;

END;
/**********************************************************************/
MACRO pr___dda(dep,doc,cln,payer, CloseDoc : bool);

 var   placementOfBlank;
 var tagFile = "";

 file
    blankItself()txt;

 DLREPTLS_FillTemplsPaths(); // Заполнение путей к директориям шаблонов.

 if ( flagAddContract )
   flagWord = FALSE;  // Флаг формата бланка MS-Word.
   placementOfBlank = getBlank( dep, doc );
   PrintDeal( blankItself, placementOfBlank, dep, doc, cln, payer );
 else
   if( PrintToWORD )
      ExecMacroFile( "PR_DDA_W.MAC" );
   else
      if ( existWordBlank( dep ) )
        flagWord = TRUE;  // Флаг формата бланка MS-Word.
        placementOfBlank = getWordBlank( dep, doc );
        tagFile = WordDeal( blankItself, placementOfBlank, dep, doc, cln, payer, CloseDoc );
      else
        flagWord = FALSE;  // Флаг формата бланка MS-Word.
        placementOfBlank = getBlank( dep, doc );
        PrintDeal( blankItself, placementOfBlank, dep, doc, cln, payer );
      end;
   end;
 end;
 return tagFile;
END;

/**********************************************************************/
MACRO sc___dda()

 var   placementOfBlank;
 var
    Номер_договора              = "??????",
    Дата_открытия_договора      = "??????",
    Платёжная_система_карты     = "??????";

 var DocName; // = "..\\Mac\\CARDTEMPL\\",;
 var DocPath;

 file
     blankItself()txt;
 DLREPTLS_FillTemplsPaths(); // Заполнение путей к директориям шаблонов.
 CardProduct.CardProductID = ALG_CARDCONTRACT.CardProductID;
 if (getEQ(CardProduct) AND CardProduct.ContrFormName!="")
     DocName = /*DocName +*/ CardProduct.ContrFormName;
     DocPath = DLREPTL_GetDotFileDir(docName);
     if (/*ExistFile (DocName)*/ DocPath != "\\")
        SCWordDeal( blankItself, DocPath + DocName, CardProduct);
        Exit( 1 );
     else
        MsgBox("Не найден файл шаблона договора");
     end;
 else
     MsgBox("Не задано имя файла с шаблоном договора у вида карточного продукта");
 end;

END;

/********************************************************/
//
//                      EOF
//
/********************************************************/