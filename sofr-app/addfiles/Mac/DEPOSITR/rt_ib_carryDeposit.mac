import rsd, deprintr;
import "rt_ib_xml.mac";



// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
// à®¢®¤ª  ®â«®¦¥­­ëå ¤®ªã¬¥­â®¢
// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
class(cBaseDeposit) 
    cCarryDeposit( inXml, outXml ) 

  var outXML_cur;
  var appKind, appKey;

/* 
    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ˆ‘•„›… „€›…  
    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

«¥¬¥­â á®®¡é¥­¨ï	   ’¨¯		   Š®¬¬¥­â à¨©	                           Šà â­®áâì
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
request			
ÃÄid                       string(32)      ˆ¤¥­â¨ä¨ª â®à § ¯à®á  ¢ á¨áâ¥¬¥  ˆŠ”‹	
ÀÄcarryDeposit_q                 


    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          ’‚…’
    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
«¥¬¥­â á®®¡é¥­¨ï	’¨¯		Š®¬¬¥­â à¨©
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
response			
ÃÄparentId              string(32)      ˆ¤¥­â¨ä¨ª â®à § ¯à®á  ¢ á¨áâ¥¬¥  ˆŠ”‹	
ÃÄid                    string(32)      ˆ¤¥­â¨ä¨ª â®à ®â¢¥â 	
ÀÄcarryDeposit_a
  ÀÄdocument
    ÃÄerrorCode         int             Š®¤ ®è¨¡ª¨
    ÃÄerrorText         string(80)      ’¥ªáâ ®è¨¡ª¨
    ÃÄapplicationKind   int             ˆ¤¥­â¨ä¨ª â®à ¤®ªã¬¥­â  
    ÀÄapplicationKey    string(29)      ˆ¤¥­â¨ä¨ª â®à ¤®ªã¬¥­â 
*/

// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
// à®¢¥áâ¨ ¤®ªã¬¥­â
// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

  // ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ  
  // ”®à¬¨àã¥¬ ¢ëå®¤­®© XML 
  // ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
  private macro createDateTag( stat, errMes )
    var nodeTemp;
    if ( stat == null )
      stat = 0;
    end;
     
    nodeTemp = nodeAnswer.appendChild( outXML_cur.createNode(1, "document", "") ); 
   
    node = nodeTemp.appendChild( outXML_cur.createNode(1, "errorCode", "") ); 
    node.text = stat;

    if ( stat != 0 )
      if ( errMes == null )
        errMes = getErrorString( stat );
      end;

      node = nodeTemp.appendChild( outXML_cur.createNode(1, "errorText", "") ); 
      node.text = errMes;
    end;

    node = nodeTemp.appendChild( outXML_cur.createNode(1, "applicationKind", "") ); 
    node.text = appKind;
                
    node = nodeTemp.appendChild( outXML_cur.createNode(1, "applicationKey", "") ); 
    node.text = appKey;

  end;


/*  private macro createDateTag( ApplicationKind, ApplicationKey, errorCode )

    nodeAnswer = outXML_cur.documentElement.appendChild( outXML_cur.createNode(1, "document", "") );

    node = nodeAnswer.appendChild( outXML_cur.createNode(1, "errorCode", "") ); 
    node.text = errorCode;

    if (errorCode != 0 )
      node = nodeAnswer.appendChild( outXML_cur.createNode(1, "errorText", "") ); 
      node.text = getErrorString(errorCode);
    end;
    node = nodeAnswer.appendChild( outXML_cur.createNode(1, "applicationKind", "") ); 
    node.text = ApplicationKind;
                
    node = nodeAnswer.appendChild( outXML_cur.createNode(1, "applicationKey", "") ); 
    node.text = ApplicationKey;
                                                             
  end; // createDateTag( ApplicationKind, ApplicationKey, errorCode )   */

  // ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ  
  // ‡ ¯ãáâª ¯à®æ¥¤ãàë
  // ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
  macro start( inXml, outXml ) 
    var nodeParentElement;
    var cmd, cmd_raw;
    var rs_psdoc;
//    var stat = 0;
    var errCode  = 0;

    var firstStep = true, isOpenFiles = false;

    outXML_cur = outXml;    
    if(not outXml_cur )
      outXml_cur = CreateXMLObject();
      if(not outXml_cur) return; end;

      nodeParentElement = inXml.documentElement.selectSingleNode( "//" + NameInputTag );
      CreateBeginTag( outXml_cur );
    
      if( nodeParentElement )

        cmd_raw = RsdCommand("begin rsb_struct.readstruct( 'dsbdepdoc_1' ); end;");
        cmd_raw.execute;

        cmd = RsdCommand(
            "select   t_iapplicationkind, t_applicationkey " +
                "from dpsdepdoc_dbt d left outer join drtpaymentprop_dbt p " +
                     "on p.t_docapplicationkey = d.t_applicationkey " +
                   "and p.t_docapplicationkind = d.t_iapplicationkind " +
               "where d.t_flags2 = 64 " +                                        // à¨§­ ª â®£®, çâ® ¤®ªã¬¥­âë ¨§ ˆŠ”‹
                 "and d.t_typeoper <> 51 " +                                     // à®¢¥àï¥¬ ­¥ ®âªàëâ¨¥ «¨ íâ® ­®¢®£® áç¥â .
                 "and not (    (d.t_typeoper = 65 or d.t_typeoper = 80) " +      // âªàëâ¨¥ ­¥ ¯à®¢®¤¨¬, â ª ª ª ®­® â®«ìª® ¯® 
                          "and substr (nvl(p.t_account, chr(0)), 1, 1) = chr (1) " +          // «¨ç­®© ï¢ª¥ ¢ª« ¤ç¨ª 
                         ") " +
            "order by d.t_fncash, d.t_iscur " );
        cmd.execute;

        rs_psdoc = RsdRecordSet( cmd );

        while ( rs_psdoc.moveNext )
          if ( firstStep )
            isOpenFiles = OpenDepFiles;
            firstStep = false;
          end;

          appKind = rs_psdoc.value( "t_iapplicationkind" );
          appKey  = rs_psdoc.value( "t_applicationkey" );

          errCode = CarryPsDoc( rs_psdoc.value( "t_iapplicationkind" ), rs_psdoc.value( "t_applicationkey" ) );

          createDateTag( errCode );

        end; // while ( rs_psdoc.moveNext )

        if ( isOpenFiles ) 
          CloseDepFiles;
        end;

      end; // if( nodeParentElement )

    end;//if(not outXml )

    return outXml_cur;
  end;//start( inXml, outXml ) 


end;



// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
// ‚áâ ¢ª  ®â«®¦¥­­®£® ¤®ªã¬¥­â 
// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
macro carryDeposit( inXml, outXml ) 

  var t = cCarryDeposit;
  outXml = t.start( inXml, outXml );

  SetParm(1, outXml);
end;
