/********************************************************
*  ---------------------                                *
*  R-Style SoftWare Lab.                                *
*  ---------------------                                *
*  RS-Retail                                            *
*  Кассовые операции                                    *
*                                                       *
*  Проверка при проведении приходной операции           *
*  "Перевод из России"                                  *
*                                                       *
*  Лебедев С.В.                                         *
*  18.02.99                                             *
********************************************************/

import inprccmn, cur_rate, chco5000;

  var BoardSum = 200000;
  var Rate1;
  var Rate2;


/*******************************************************************
       Определить курс валюты
*******************************************************************/
macro DefRateCur ( CodCur )

  var RateCur = 0.0;
  private var {curdate};

  if ( GetAllCurrRate( {curdate}, CodCur, RateCur ) )
    ;
  else
    RateCur = 0.0;
  end;

  return RateCur;

end;


/*******************************************************************
         Перевести строку в верхний регистр
*******************************************************************/
macro Upper (InputString)

  var OutputString = "";
  var i            = 1;
  var s;

  while (i <= StrLen(InputString))
    s = SubStr(InputString,i,1);

    if   (s == "а") s = "А";
    elif (s == "б") s = "Б";
    elif (s == "в") s = "В";
    elif (s == "г") s = "Г";
    elif (s == "д") s = "Д";
    elif (s == "е") s = "Е";
    elif (s == "ж") s = "Ж";
    elif (s == "з") s = "З";
    elif (s == "и") s = "И";
    elif (s == "й") s = "Й";
    elif (s == "к") s = "К";
    elif (s == "л") s = "Л";
    elif (s == "м") s = "М";
    elif (s == "н") s = "Н";
    elif (s == "о") s = "О";
    elif (s == "п") s = "П";
    elif (s == "р") s = "Р";
    elif (s == "с") s = "С";
    elif (s == "т") s = "Т";
    elif (s == "у") s = "У";
    elif (s == "ф") s = "Ф";
    elif (s == "х") s = "Х";
    elif (s == "ц") s = "Ц";
    elif (s == "ч") s = "Ч";
    elif (s == "ш") s = "Ш";
    elif (s == "Щ") s = "Щ";
    elif (s == "Э") s = "Э";
    elif (s == "ю") s = "Ю";
    elif (s == "я") s = "Я";
    elif (s == "a") s = "A";
    elif (s == "b") s = "B";
    elif (s == "c") s = "C";
    elif (s == "d") s = "D";
    elif (s == "e") s = "E";
    elif (s == "f") s = "F";
    elif (s == "g") s = "G";
    elif (s == "h") s = "H";
    elif (s == "i") s = "I";
    elif (s == "j") s = "J";
    elif (s == "k") s = "K";
    elif (s == "l") s = "L";
    elif (s == "m") s = "M";
    elif (s == "n") s = "N";
    elif (s == "o") s = "O";
    elif (s == "p") s = "P";
    elif (s == "q") s = "Q";
    elif (s == "r") s = "R";
    elif (s == "s") s = "S";
    elif (s == "t") s = "T";
    elif (s == "u") s = "U";
    elif (s == "v") s = "V";
    elif (s == "w") s = "W";
    elif (s == "x") s = "X";
    elif (s == "y") s = "Y";
    elif (s == "z") s = "Z";
    end;

    OutputString = OutputString + s;
    i = i + 1;
  end;

  return OutputString;

end;


/*******************************************************************
       Определить курс валюты
*******************************************************************/
macro WasPayOneClient

  file pay_doc (pay_doc) Key 1;
  var flag;
  var stat = FALSE;

  pay_doc.IsCur         = OC_PAY_DOC.IsCur;
  pay_doc.FNCash        = OC_PAY_DOC.FNCash;
  pay_doc.GroupOpert    = OC_PAY_DOC.GroupOpert;
  pay_doc.Date_Document = OC_PAY_DOC.Date_Document;
  pay_doc.NumOpert      = OC_PAY_DOC.NumOpert;
  pay_doc.CodCur        = -1;
  flag = GetGE(pay_doc);
  while (flag)
    if ((pay_doc.IsCur         == OC_PAY_DOC.IsCur        ) AND
  (pay_doc.FNCash        == OC_PAY_DOC.FNCash       ) AND
  (pay_doc.GroupOpert    == OC_PAY_DOC.GroupOpert   ) AND
  (pay_doc.Date_Document == OC_PAY_DOC.Date_Document) AND
  (pay_doc.NumOpert      == OC_PAY_DOC.NumOpert     )    )
      if (pay_doc.ApplType == OC_PAY_DOC.ApplType)
  if ((Upper(Trim(pay_doc.ClientLastName  )) == Upper(Trim(OC_PAY_DOC.ClientLastName  ))) AND
      (Upper(Trim(pay_doc.ClientFirstName )) == Upper(Trim(OC_PAY_DOC.ClientFirstName ))) AND
      (Upper(Trim(pay_doc.ClientSecondName)) == Upper(Trim(OC_PAY_DOC.ClientSecondName))) AND
      (Upper(Trim(pay_doc.PassportSer     )) == Upper(Trim(OC_PAY_DOC.PassportSer     ))) AND
      (Upper(Trim(pay_doc.PassportNumb    )) == Upper(Trim(OC_PAY_DOC.PasportNumb     ))) AND
      (pay_doc.PassportDate                  == OC_PAY_DOC.PassportDate                 )    )
    stat = TRUE;
  end;
      end;
      flag = Next(pay_doc);
    else
      flag = FALSE;
    end;
  end;

  return stat;

end;


/*******************************************************************
        Г Л А В Н А Я    П Р О Г Р А М М А
*******************************************************************/

  OC_RESULT = 0;

  /* Проверка на валюту операции --------------------------------------- */
  if (OC_RESULT == 0)
    if (OC_PAY_DOC.CodCur == 0)
      MsgBox("Данная операция выполняется только в валюте");
      OC_RESULT = 1;
    end;
  end;

  /* Проверка на валюту операции и валюту комиссии --------------------- */
  /*
  if (OC_RESULT == 0)
    if (OC_PAY_DOC.CodCur != OC_PAY_DOC.CommCodCur)
      MsgBox("Валюта суммы перевода и суммы комиссии не совпадают");
      OC_RESULT = 1;
    end;
  end;
  */

  /* Проверка на ограничение суммы операции для первого подвида -------- */
  if (OC_RESULT == 0)
    if (OC_PAY_DOC.ApplType == 1)
      /* Определение ограничивающей суммы */
      if (OC_PAY_DOC.CodCur > 1)
  Rate1 = DefRateCur(1);
  Rate2 = DefRateCur(OC_PAY_DOC.CodCur);
  if (Rate1 == 0)
    MsgBox("Не определен курс базовой валюты");
    OC_RESULT = 1;
  end;
  if ((OC_RESULT == 0) AND (Rate2 == 0))
    MsgBox("Не определен курс валюты операции");
    OC_RESULT = 1;
  end;
  if (OC_RESULT == 0)
    BoardSum = Money( BoardSum * Rate1 / Rate2 );
  end;
      end;
      /* Проверка */
      if ((OC_RESULT == 0) AND (OC_PAY_DOC.InSum > BoardSum))
  MsgBox("Сумма операции по подвиду \"На текущие расходы\"|не должна превышать эквивалента 2000.00 USD");
  OC_RESULT = 1;
      end;
    end;
  end;

  /* Проверка на ограничение суммы ------------------------------------- */
  if (OC_RESULT == 0)
   if ( not CheckOverOther5000( OC_PAY_DOC ) )
      MsgBox("Суммы переводов больше 5000 долларов США|Операция невозможна");
      OC_RESULT = 1;
    end;
  end;

  /* Проверка на повторность проведения операции для первого подвида --- */
  if (OC_RESULT == 0)
    if (OC_PAY_DOC.ApplType == 1)
      if ((StrLen(Trim(OC_PAY_DOC.ClientLastName)) > 0) OR
    (StrLen(Trim(OC_PAY_DOC.PasportNumb   )) > 0)   )
  if (WasPayOneClient())
    MsgBox("Данный клиент осуществлял перевод \"На текущие расходы\"|в текущем операционном дне");
    OC_RESULT = 1;
  end;
      end;
    end;
  end;

  /* Дополнительные данные по операции */
  /*if( ( OC_RESULT == 0 ) and ( execMacroFile( "inprcv.mac", "mainFun", true ) != 0 ) )
    OC_RESULT = -1;
  end;*/

end;