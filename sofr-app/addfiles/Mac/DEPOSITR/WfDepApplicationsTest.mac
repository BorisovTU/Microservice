import RslUnit, dep_utils, wf_depositApi;

class (TTest) TWfDepApplicationsTest
  private macro printUiFormInfo
    println("uiSessionId = " + uiFormManager.uiSessionId);
    if (uiFormManager.currentForm == null)
      println("currentForm == null");
    else
      println("currentForm.Id = " + uiFormManager.currentForm.Id);
      var f;
      println("currentForm.Fields:");
      for (f, uiFormManager.currentForm.Fields)  
        println("  " + f.Name + " = " + f.Value); 
      end;
    end;
  end;

  private macro uiFormField(name : String)
    if (uiFormManager.currentForm != null)
      var fields = TParameters;
      fields.setArray(uiFormManager.currentForm.Fields);
      return fields.get(name);
    end; 
  end;

  macro tearDown
    commonDone;
    setFlagCur(0);
  end;

  macro test_clientRoleToDepDocAuthor
    assertTrue(clientRoleToDepDocAuthor("V") == ACCOUNT_OWNER, "Владелец");
    assertTrue(clientRoleToDepDocAuthor("N") == ACCOUNT_HEIR, "Наследник");
  end; 

  macro test_getAccountInfo
    var inParams = TParameters;
    inParams.add("accountId", 10000002);
    var outParams = TParameters(getAccountInfo(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");

/*    inParams = TParameters;
    inParams.add("accountId", -123);
    outParams = TParameters(getAccountInfo(inParams));
    println(outParams);
    assertTrue(outParams.get("КодОшибки") != "0", "Должно плохо кончиться");
*/
  end;

  macro test_commission_paramsForm
    var inParams = TParameters;
    inParams.add("accountId", 10000002);
    inParams.add("amount", $118);
    inParams.add("tariffId", 1);

    var outParams = TParameters(commission_paramsForm_prepare(inParams));
    println(outParams);
    printUiFormInfo;
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
    expect(uiFormField("commAmount"), "20.00", "Сумма платы");
    expect(uiFormField("commVatAmount"), "3.60", "Сумма НДС");
  end;

  macro test_commission_transaction
    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("commAccountId", 10000002);
    inParams.add("commAmount", $1);
    inParams.add("commVatAmount", $0.18);

    var outParams = TParameters(commission_transaction(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
  end;

  macro test_partialConversion_transaction
    const amountToConvert = $0.75;
    const rate = 30.0;

    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("accountId", 10000003);
    inParams.add("amountToConvert", amountToConvert);
    inParams.add("convertedAmount", amountToConvert * rate);
    inParams.add("conversionRate", rate);

    var outParams = TParameters(partialConversion_transaction(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
  end;

  macro test_additionalDeposit_check
    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("accountId", 10000002);
    inParams.add("amount", $12.09);

    var outParams = TParameters(additionalDeposit_check(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
    assertTrue(outParams.get("result"), "Проверка должна пройти");
    expect(outParams.get("errorMessage"), null, "Не должно быть сообщения");
  end;

  macro test_additionalDeposit_transaction
    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("accountId", 10000002);
    inParams.add("amount", $12.09);
    inParams.add("tokenNumber", 75);

    var outParams = TParameters(additionalDeposit_transaction(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
  end;

  macro test_withdraw_check
    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("accountId", 10000002);
    inParams.add("totalAmount", $9.75 * (1.0 + 0.2));

    var outParams = TParameters(withdraw_check(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
    assertTrue(outParams.get("result"), "Проверка должна пройти");
    expect(outParams.get("errorMessage"), null, "Не должно быть сообщения");
  end;

  macro test_withdraw_transaction
    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("accountId", 10000002);
    inParams.add("amount", $9.75);
    inParams.add("tokenNumber", 12);

    var outParams = TParameters(withdraw_transaction(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
  end;

  macro test_internalTransfer_check
    const amount = $9.75;

    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("payerAccountId", 10000002);
    inParams.add("receiverAccountId", 10000001);
    inParams.add("totalDebitAmount", amount * (1.0 + 0.2));
    inParams.add("creditAmount", amount);

    var outParams = TParameters(internalTransfer_check(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
    assertTrue(outParams.get("result"), "Проверка должна пройти");
    expect(outParams.get("errorMessage"), null, "Не должно быть сообщения");
  end;

  macro test_internalTransfer_transaction
    const amount = $9.75;

    var inParams = TParameters;
    inParams.add("clientId", 14);
    inParams.add("clientRole", "V");
    inParams.add("payerAccountId", 10000002);
    inParams.add("receiverAccountId", 10000001);
    inParams.add("amount", amount);

    var outParams = TParameters(internalTransfer_transaction(inParams));
    println(outParams);
    expect(outParams.get("КодОшибки"), "0", "Должно хорошо кончиться");
  end;

  initTTest;
end;

TWfDepApplicationsTest.run;


