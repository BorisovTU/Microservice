/******************************************************************************

  MacroProgram:  NoOpen.mac
  Created:       09/02/2002 9:10
  Author:        RS

  Requested:
  Comments:   `description`
  *****************************************************************************
  History:

  13-02-2004 LAA корректировка макроса для контроля при открытии вкладов с измененными
                 балансовыми символами

  15.06.2004 KIN по ТЗ 358  дописано предупреждение на валютные переводы физ.лиц.
  06.09.2004 KIN по ТЗ 688  дописан запрет на безналичное открытие счетов без явки вкладчиков. 
******************************************************************************/

import deprintr,alg_vars, checkBal;

  file sb_dtyp ("sb_dtyp.dbt");

  ALG_RESULT = OK_RES;
  
  KeyNum(sb_dtyp,2);
  sb_dtyp.FlagCur = ALG_DEPOSITOR.IsCur;
  sb_dtyp.Kind = ALG_DEPOSITOR.Type_Account;

  if (GetEQ(sb_dtyp))
      /*блок контроля над открытием вкладов с измененными балансовыми счетами*/
      if ( /*все рублевые*/
           (sb_dtyp.Kind == "Депоз.Фв 1 м") OR
           (sb_dtyp.Kind == "Депоз.на 1 м") OR
           (sb_dtyp.Kind == "Депоз.Фв 3 м") OR
           (sb_dtyp.Kind == "Депоз.на 3 м") OR
           (sb_dtyp.Kind == "Пенс.депФв3м") OR
           (sb_dtyp.Kind == "Пенс.деп. 3м") OR
           /*все валютные*/
           (sb_dtyp.Kind == "Дол.деп.фв1м") OR
           (sb_dtyp.Kind == "Дол.депоз 1м") OR
           (sb_dtyp.Kind == "ЕВРО-депФв1м") OR
           (sb_dtyp.Kind == "ЕВРО-деп. 1м")
         )
        DateSplit({curdate}, NULL, mon, NULL);
        ALG_RESULT = Check_Bal_Account(SB_DTYP);
        Return ALG_RESULT;
      end;
      
      if   ( 
           ( sb_dtyp.Kind == "Особый номер" )  OR
           ( sb_dtyp.Kind == "Особ.н.1г_1м" )  OR
           ( sb_dtyp.Kind == "Особ.ном.2 г" )  OR
           ( sb_dtyp.Kind == "Особ.ном. 2г" )
           )
           MsgBox("На текущий момент открытие счетов вклада|", sb_dtyp.Name,  " запрещено");
           ALG_RESULT = ERR_RES;
        end;
        // KIN по ТЗ 358
      if (
         (ALG_SBDEPDOC.TypeOper == 65) AND (ALG_SBDEPDOC.TypeComplexOper == 65) AND (ALG_SBDEPDOC.IsCur == 1)
         )
    
         if (StrFor(GetProgramID) != "П")
           MsgBox("Выполнение операции допустимо при наличии разрешения ЦБ, либо по наследству.","|",
                  "Esc - продолжить"); 
         end;
         ALG_RESULT = OK_RES;
      end;
        
//        MsgBox(ALG_SBDEPDOC.Account,"|",ALG_SBDEPDOC.TypeOper,"|",ALG_SBDEPDOC.TypeComplexOper,"|",ALG_SBDEPDOC.ListTransfer);
      
        // KIN по ТЗ 688
      if (
           ( sb_dtyp.Kind != "Особый на 3м" )  AND // KIN исключаем счета с операциями номерных
           ( sb_dtyp.Kind != "Особый 1г_1м" )  AND
           ( sb_dtyp.Kind != "Особый на 2г" )  AND
             ( 
               ( 
                 (ALG_SBDEPDOC.TypeOper == 0) AND 
                 (ALG_SBDEPDOC.TypeComplexOper == 0) AND 
                 (ALG_SBDEPDOC.ListTransfer == 0) 
               ) 
               OR
               ( (StrFor(GetProgramID) == "П") AND
                 (ALG_SBDEPDOC.TypeComplexOper != 81) AND
                 (ALG_SBDEPDOC.TypeComplexOper != 65) AND
                 (ALG_SBDEPDOC.TypeComplexOper != 80) AND
                 ((ALG_SBDEPDOC.TypeOper == 1) OR 
                  (ALG_SBDEPDOC.TypeOper == 51) OR 
                  (ALG_SBDEPDOC.TypeOper == 58))
               )
             )
           )
                MsgBox("Открытие счета запрещено ");
                ALG_RESULT = ERR_RES;
      elif ((ALG_SBDEPDOC.TypeOper == 73) AND (ALG_SBDEPDOC.TypeComplexOper == 73) AND (ALG_SBDEPDOC.ListTransfer != 0))
//        MsgBox("Безналичное открытие счетов запрещено ");
        ALG_RESULT = ERR_RES;
      end;
  else
       MsgBox("Вид Вклада не найден");
  end;

end;