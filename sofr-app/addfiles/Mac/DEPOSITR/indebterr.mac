 /* ¥ç âì ®âç¥â  (prj937) */
import indebt;
private var {curdate};
private file wrk("scsvdwrk.tmp","spcard.def") key 0 write; /* ‘¢®¤­ë¥ ¤®ªã¬¥­âë  ¢â®à¨§ æ¨¨ */

macro ClearFile(F)
  var Stat=true;          
                 
  Rewind(F);
  while(Stat and Next(F))
    Stat=Delete(F);
  end;
  return Stat;
end;       

macro Print_IndebtReport( _Data )
  var cmdstr = "";
  var cmd, rs;
  var numrec = 0, numtabrec = 0;
  var ClientName, CardNumber, IndebtKindName;
  var IndebtKind = 0, TypeAcc = "";
  var AuthUTypeCode, AuthSum;
 
  cmdstr = "SELECT indebt.t_IndebtID as IndebtID, indebt.t_CardRef as CardRef, indebt.t_IndebtKind as IndebtKind, "
           " depos.t_SpecialAccess as SpecialAccess, depos.t_Type_Account as TypeAcc, depos.t_isCur as isCur, "
           " tran.t_AuthTypeCode as AuthTypeCode, tran.t_PSRef as PSRef, tran.t_AuthDate as AuthDate, tran.t_AuthSum as AuthSum, "
           " tran.t_AuthRef as AuthRef, tran.t_AuthCurrCode as AuthCurrCode, curr.t_Short_Name as CurrName, dtyp.t_Name as TypeAccName "
           " FROM ddpindebt_dbt indebt, ddepositr_dbt depos, dsctran_dbt tran, dcurrency_dbt curr, dsb_dtyp_dbt dtyp "
           " WHERE tran.t_FNcash = ? AND tran.t_ErrorFlagSettingDate >= ? AND tran.t_ErrorFlagSettingDate <= ? "
           " AND tran.t_AuthStateCode = 'PAY__' AND tran.t_isErrorAuth <> chr(0) "
           " AND depos.t_Referenc = indebt.t_Reference "
           " AND indebt.t_Branch = tran.t_FNcash "
           " AND indebt.t_AuthRef = tran.t_AuthRef "
           " AND indebt.t_Action <> 11 AND indebt.t_Action <> 2 "
           " AND curr.t_Code_Currency(+) = tran.t_AuthCurrCode "
           " AND dtyp.t_FlagCur(+) = depos.t_isCur "
           " AND dtyp.t_Kind(+) = depos.t_Type_Account "
           " ORDER BY indebt.t_IndebtKind, depos.t_Type_Account, indebt.t_Date";
  cmd = RsdCommand(cmdstr);

  cmd.addParam("Branch", RsdBp_in);
  cmd.addParam("DateFrom", RsdBp_in);
  cmd.addParam("DateTo", RsdBp_in);
  cmd.value("Branch") = _Data.Branch;
  cmd.value("DateFrom") = _Data.DateFrom;
  cmd.value("DateTo") = _Data.DateTo;
  cmd.execute();
  rs = RsdRecordset(cmd);

  while( rs.moveNext() )
    ClientName = "";
    CardNumber = "";

    numrec = numrec + 1;
    if( numrec == 1 )
      _Data.RepNumber = _Data.RepNumber + 1;
      [  
         ‘âàãªâãà­®¥ ¯®¤à §¤¥«¥­¨¥ ‘¡¥à¡ ­ª  ®áá¨¨ < ########## >]( _Data.NameBranch );
      [      < ##########   ######## >]( Date({curdate}), Time() );
      [  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
         (¤ â  ¨ ¢à¥¬ï ä®à¬¨à®¢ ­¨ï ®âç¥â )
       
       
                       ’—…’  ’Œ…… ˜ˆ—‰ ‹€’›  Œ…†„“€„›Œ €Š‚‘ŠˆŒ Š€’€Œ
                                        ‚ …ˆ„ ‘ ##########  ##########]( Date(_Data.DateFrom), Date(_Data.DateTo) );
    end;

    if( IndebtKind != rs.value("IndebtKind") )
      IndebtKind = rs.value("IndebtKind");
      TypeAcc = rs.value("TypeAcc");
      IndebtKindName = GetIndebtName(rs.value("isCur"), IndebtKind, rs.value("TypeAcc"));

      if( numtabrec > 0 )
        [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
      end;
      [ ];
      [ ‚¨¤ ¯« âë §  ®¡á«ã¦¨¢ ­¨¥:       ####################]( IndebtKindName );
      [                          ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
      [ 
       ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       ³   ”ˆ ¤¥à¦ â¥«ï  ³  ®¬¥à ¡ ­ª®¢áª®© ³’¨¯ âà ­§ ªæ¨¨ ³ „ â  âà ­§ ªæ¨¨ ³ ‚ « ³  ®«­ ï áã¬¬    ³
       ³       ª àâë      ³       ª àâë       ³   á ¯« â®©    ³                 ³     ³     ¯« âë       ³
       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
      [ ‚¨¤ ¢ª« ¤ :       ########################################]( rs.value("TypeAccName") );
      [           ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
      numtabrec = 0;

    elif( TypeAcc != rs.value("TypeAcc") )
      TypeAcc = rs.value("TypeAcc");
      [ ‚¨¤ ¢ª« ¤ :       ########################################]( rs.value("TypeAccName") );
      [           ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
    end;

    sccard.FNcash = _Data.Branch;
    sccard.cardRef = rs.value("CardRef");
    if( GetEQ(sccard) )
      CardNumber = sccard.CardNumber;
      ClientName = GetClientName( sccard.CodClient, rs.value("SpecialAccess") )
    end;

    AuthUTypeCode = GetUserCodeName(rs.value("PSRef"), 20, rs.value("AuthTypeCode"));
    AuthSum = rs.value("AuthSum");

    [³##################³###################³###############³   ##########    ³ ### ³#################³](
    ClientName:w,
    CardNumber,
    AuthUTypeCode,
    Date(rs.value("AuthDate")),
    rs.value("CurrName"),
    AuthSum
    );
    numtabrec = numtabrec + 1;

    if( _Data.NeedStructFile )
      ClearRecord(wrk);
      wrk.ID = numrec;
      wrk.Branch = _Data.Branch;
      wrk.ObjectID = rs.value("AuthRef");
      wrk.CardNumber = CardNumber;
      wrk.AuthCode = AuthUTypeCode;
      wrk.CurrencyCode = rs.value("AuthCurrCode");
      wrk.SumDoc = AuthSum;
      insert(wrk);
    end;
  end;

  if( numrec > 0 )
    [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ



    ];
    [®¤¯¨áì: < ###################### >]( GetOperatorName() );
    [        ____________________________________________________
    
    
    ];
  end;

end;


macro IndebtReport( Branch, RepDate, DateFrom, DateTo, NeedStructFile )
  var cmdstr = "";
  var cmd, rs;
  var Data = IndebtReportData(Branch, RepDate, DateFrom, DateTo, NeedStructFile);

  ClearFile(wrk);
  cmdstr = "SELECT t_code, t_name FROM ddp_dep_dbt";
  if( Data.Branch < 0 )
    Data.Branch = getFilialNum();
    cmdstr = cmdstr + " START WITH t_code = ? CONNECT BY PRIOR t_code=t_parentcode AND t_nodetype!=1"
                      " ORDER BY t_parentcode, t_code";
  else
    cmdstr = cmdstr + " WHERE t_code = ?";
  end;

  cmd = RsdCommand(cmdstr);
  cmd.addParam("Code", RsdBp_in);
  cmd.value("Code") = Data.Branch;
  cmd.execute();
  rs = RsdRecordset(cmd);
  /* âç¥â ¤«ï ª ¦¤®£® ¯®¤à §¤¥«¥­¨ï */
  while( rs.moveNext() )
    Data.Branch = rs.value("t_code");
    Data.NameBranch = rs.value("t_name");
    Print_IndebtReport(Data);
  end;

  if( Data.NeedStructFile )
    ExecMacroFile("sb_outcl.mac");
  end;
end;

END;