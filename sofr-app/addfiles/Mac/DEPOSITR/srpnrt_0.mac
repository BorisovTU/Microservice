/*
               **************************
               *  R-Style SoftWare Lab. *
               **************************

    RS-Retail 5.1
    Сбербанк

  Определение процентной ставки по альтернативным условиям
 (при нарушении) для различных видов вкладов
  Общие переменные и функции.

  Ромодин Александр Васильевич & Макашов М.И.
  08.08.2002
*/
var   MacroError = 0;
private const ACCOUTN_HEIR     = 2; /* Наследник - выдачи */
private const ACCOUTN_HEIR_PAY = 7; /* Наследник - выплаты */

private file SRPNRT_0_SBTRAST (sbtrast) key 0;

/**********************************************************/

macro GetFirstWillDate (BegDate,dep,doc)
/*
  Дата первогй выдачи наследства по счету
*/
  var WillDate = BegDate;
  var st;

  SRPNRT_0_SBTRAST.Referenc  = dep.Referenc;
  SRPNRT_0_SBTRAST.VidDoc    = "\x01";
  SRPNRT_0_SBTRAST.CodClient = 0;
  st = GetGE (SRPNRT_0_SBTRAST);
  while (st
   AND   (SRPNRT_0_SBTRAST.Referenc == dep.Referenc)
   AND   ( (SRPNRT_0_SBTRAST.VidDoc == "\x01") OR (SRPNRT_0_SBTRAST.VidDoc == "\x02") ) )
    if ( (SRPNRT_0_SBTRAST.CloseDate != Date(0,0,0))
     AND (SRPNRT_0_SBTRAST.CloseDate < WillDate))
      WillDate = SRPNRT_0_SBTRAST.CloseDate;
    end;
    st = Next (SRPNRT_0_SBTRAST);
  end;    
// Возможно, первая выдача наследства только идет, и записи в sb_trast еще нет
  if ( (WillDate == BegDate)
   AND ((doc.Author == StrFor(ACCOUTN_HEIR    )) 
     OR (doc.Author == StrFor(ACCOUTN_HEIR_PAY))
       ) )
    WillDate = doc.DepDate_Document;
  end;
  return WillDate;
end;
