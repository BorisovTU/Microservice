
/* Загрузка неподвижных/объединенных счетов */

import BankInter, deprintr, OperCode, TrAc_Cmn;

const
  SA_STATIC = "Неподвижный",
  SA_UNITED = "Объединенный";

const
  Binsert = 2;

const
  SB_DEPOSIT = 1;

const
  D_IN            = 1,    /* Приход */
  D_OUT           = 2;    /* Расход */

const
  BS_BRANCH  = 0,  /* Филиал */
  BS_DEP     = 1,  /* Отделение */
  BS_EXCH    = 2,  /* Обменный пункт */
  BS_OPERDEP = 3;  /* Оперчасть */

private var
  {curdate},
  {oper};

var
  OperBrigade = GetOperBrigade,
  Branch = NumFNCash,
  BranchStatus = GetBranchStatus,
  FileExt,
  StaticPos,
  T_StaticPos,
  IsFirstForBranch,
  ASFirstTime,
  CurStaticType,
  ErrFlag = false,
  TrnStat = true;
private var ddep = TRecHandler( "i_dp_dep.rec" );

macro UploadAccount(Acc)

  var
    SK_Dep = KeyNum(Dep, 8),
    SK_DepDoc = KeyNum(DepDoc, 6),
    SK_T_Dep = KeyNum(T_Dep, 8),
    SK_T_DepDoc = KeyNum(T_DepDoc, 2);

  Direction = Upload;
  From(I_Dep)=T_Dep;
  To(I_Dep)=Dep;
  From(I_DepDoc)=T_DepDoc;
  To(I_DepDoc)=DepDoc;
  From(I_DepRest)=T_DepRest;
  To(I_DepRest)=DepRest;
  From(I_TrWill)=T_TrWill;
  To(I_TrWill)=TrWill;
  From(I_DepClient)=T_DepClient;
  To(I_DepClient)=DepClient;
  From(I_AuxInfo)=T_AuxInfo;
  To(I_AuxInfo)=AuxInfo;
  From(I_ConGet)=T_ConGet;
  To(I_ConGet)=ConGet;
  From(I_PcCalc)=T_PcCalc;
  To(I_PcCalc)=PcCalc;
  From(I_PcEstim)=T_PcEstim;
  To(I_PcEstim)=PcEstim;
  From(I_CashLink)=T_CashLink;
  To(I_CashLink)=CashLink;
  From(I_AccReg)=T_AccReg;
  To(I_AccReg)=AccReg;
  From(I_TextInfo)=T_TextInfo;
  To(I_TextInfo)=TextInfo;
  From(I_PcRDate)=T_PcRDate;
  To(I_PcRDate)=PcRDate;
  From(I_DepHistr)=T_DepHistr;
  To(I_DepHistr)=DepHistr;
  From(I_ScAcc)=T_ScAcc;
  To(I_ScAcc)=ScAcc;
  From(I_ScLink)=T_ScLink;
  To(I_ScLink)=ScLink;
  From(I_ScCard)=T_ScCard;
  To(I_ScCard)=ScCard;
  From(I_ScTran)=T_ScTran;
  To(I_ScTran)=ScTran;
  From(I_PcTax)=T_PcTax;
  To(I_PcTax)=PcTax;
  From(I_RetOp)=T_RetOp;
  To(I_RetOp)=RetOp;
  From(I_OpObject)=T_OpObject;
  To(I_OpObject)=OpObject;

  FNCash = ddep.rec.Code;
  Account = Acc;
  ClearRecord(Dep);
  Dep.Referenc=Account;
  if(not GetEQ(Dep))
    TrnStat = CopyDep;
  end;
  KeyNum(Dep, SK_Dep);
  KeyNum(DepDoc, SK_DepDoc);
  KeyNum(T_Dep, SK_T_Dep);
  KeyNum(T_DepDoc, SK_T_DepDoc);
end;

macro AdjustDepRest(Sum)

  ClearRecord(DepRest);
  DepRest.Referenc = Dep.Referenc;
  DepRest.Type_Object = 2001;
  DepRest.Date_Rest = Dep.Open_Date;
  if(not GetEQ(DepRest))
    DepRest.Rest = Sum;
    TrnStat = Insert(DepRest);
  else
    DepRest.Rest = DepRest.Rest + Sum;
    TrnStat = Update(DepRest);
  end;
end;

macro AdjustDepDoc(Sum)

  ClearRecord(DepDoc);
  DepDoc.Referenc = Dep.Referenc;
  DepDoc.Date_Document = Dep.Open_Date;
  DepDoc.NumDayDoc = 1;
  if(GetEQ(DepDoc))
    DepDoc.InSum = DepDoc.InSum + Sum;
    DepDoc.Rest = DepDoc.Rest + Sum;
    TrnStat = Update(DepDoc);
  else
    DepDoc.FNCash = Branch;
    DepDoc.Referenc = Dep.Referenc;
    DepDoc.Oper = {oper};
    DepDoc.Type_Account = Dep.Type_Account;
    DepDoc.Code_Currency = Dep.Code_Currency;
    DepDoc.YesSbook = "X";
    DepDoc.Date_Document = Dep.Open_Date;
    DepDoc.DepDate_Document = Dep.Open_Date;
    DepDoc.InSum = Sum;
    DepDoc.Rest = Sum;
    DepDoc.TypeOper = Зачисление_По_Данным_ПК;
    DepDoc.Brigade = OperBrigade;
    DepDoc.iApplicationKind = SB_DEPOSIT;
    DepDoc.ApplicationKey = FormApplicationKey(SB_DEPOSIT);
    DepDoc.Ground = "Перевод на " + Dep.Type_Account + " " + Dep.PrevAccount;
    TrnStat = Insert(DepDoc);
  end;
end;

macro AdjustDep(Sum)

  Dep.Sum_Rest = Dep.Sum_Rest + Sum;
  TrnStat = Update(Dep);
end;

macro AdjustStatistics(Sum)

  record StatParm("StatParm.rec");

  ClearRecord(StatParm);
  StatParm.Op = Binsert;
  StatParm.KindOp = D_IN;
  StatParm.Sum = Sum;
  if(ASFirstTime or (Dep.Type_Account == SA_STATIC))
    StatParm.OpenFlag = StrFor(1);
    ASFirstTime = false;
  end;
/*
  if(Dep.Type_Account == SA_STATIC)
    StatParm.Type_Account = Dep.PrevAccount;
  else
*/
    StatParm.Type_Account = Dep.Type_Account;
/*
  end;
*/
  StatParm.CodCur = Dep.Code_Currency;
  StatParm.Date = {curdate};
  StatParm.IsCur = Dep.IsCur;
  if (Index(Dep.UserTypeAccount,"Н") > 0)
    StatParm.Branch = NumRealFNCash();
  else
    StatParm.Branch = Dep.FNCash;
  end;
  TrnStat = UpdateDepStats(StatParm);
end;

macro StepByStepCarry(Sum)

  AdjustDep(Sum);                                       /* Счет */
  if(TrnStat and (Dep.Type_Account == SA_UNITED))
    AdjustDepRest(Sum);                                 /* Остаток счета */
  end;
  if(TrnStat and (Dep.Type_Account == SA_UNITED))
    AdjustDepDoc(Sum);
  end;
  if(TrnStat)
    AdjustStatistics(Sum);
  end;
end;

macro FindAccount(Ref)

  var
    Stat,
    SK_Dep = KeyNum(Dep, 8);
  ClearRecord(Dep);
  Dep.Referenc = Ref;
  Stat = GetEQ(Dep);
  KeyNum(Dep, SK_Dep);
  return Stat;
end;

macro T_TreatAccount;

  var
    Pos = GetPos(T_Dep),
    Rest = T_Dep.StaticRest;

  UploadAccount(T_Dep.Referenc);
  if(TrnStat and (CurStaticType == SA_STATIC))
    TrnStat = FindAccount(T_Dep.Referenc);
    if(TrnStat)
      Dep.Open_Close = StrFor(0);
      Dep.Close_Date = Date( 0, 0, 0 );
      TrnStat = Update(Dep);
    end;
  end;
  if(TrnStat)
    GetDirect(Dep, StaticPos);
    StepByStepCarry(Rest);
  end;
  if(TrnStat)
    GetDirect(T_Dep, Pos);
    TrnStat = Delete(T_Dep);
  end;
  if(not TrnStat)
    ErrFlag = true;
    AbortTrn;
  end;
end;

macro TreatAccount;

  var
    DepPos;

  TrnStat = true;
  ProcessTrn(1, "T_TreatAccount",
    From(I_Dep),To(I_Dep),
    From(I_DepDoc),To(I_DepDoc),
    From(I_DepRest),To(I_DepRest),
    From(I_TrWill),To(I_TrWill),
    From(I_DepClient),To(I_DepClient),
    From(I_AuxInfo),To(I_AuxInfo),
    From(I_ConGet),To(I_ConGet),
    From(I_PcCalc),To(I_PcCalc),
    From(I_PcEstim),To(I_PcEstim),
    From(I_CashLink),To(I_CashLink),
    From(I_AccReg),To(I_AccReg),
    From(I_TextInfo),To(I_TextInfo),
    From(I_PcRDate),To(I_PcRDate),
    From(I_DepHistr),To(I_DepHistr),
    From(I_ScAcc),To(I_ScAcc),
    From(I_ScLink),To(I_ScLink),
    From(I_ScCard),To(I_ScCard),
    From(I_ScTran),To(I_ScTran),
    From(I_PcTax),To(I_PcTax), 
    From(I_RetOp),To(I_RetOp), 
    From(I_OpObject),To(I_OpObject));
  return TrnStat;
end;

macro T_TreatStaticAcc

  T_StaticPos = GetPos(T_Dep);
  UploadAccount(T_Dep.Referenc);
  ASFirstTime = true;
  if(TrnStat)
    TrnStat = FindAccount(T_Dep.Referenc);
  end;
  if(TrnStat)
    StaticPos = GetPos(Dep);
    Dep.Sum_Rest = $0;
    TrnStat = Update(Dep);
  end;
  if(not TrnStat)
    ErrFlag = true;
    AbortTrn;
  end;
end;

macro TreatStaticAcc;

  var
    DepPos;

  TrnStat = true;
  ProcessTrn(null, "T_TreatStaticAcc",
    DepClient, T_DepClient,
    From(I_Dep),To(I_Dep),
    From(I_DepDoc),To(I_DepDoc),
    From(I_DepRest),To(I_DepRest),
    From(I_TrWill),To(I_TrWill),
    From(I_DepClient),To(I_DepClient),
    From(I_AuxInfo),To(I_AuxInfo),
    From(I_ConGet),To(I_ConGet),
    From(I_PcCalc),To(I_PcCalc),
    From(I_PcEstim),To(I_PcEstim),
    From(I_CashLink),To(I_CashLink),
    From(I_AccReg),To(I_AccReg),
    From(I_TextInfo),To(I_TextInfo),
    From(I_PcRDate),To(I_PcRDate),
    From(I_DepHistr),To(I_DepHistr),
    From(I_ScAcc),To(I_ScAcc),
    From(I_ScLink),To(I_ScLink),
    From(I_ScCard),To(I_ScCard),
    From(I_ScTran),To(I_ScTran),
    From(I_PcTax),To(I_PcTax), 
    From(I_RetOp),To(I_RetOp), 
    From(I_OpObject),To(I_OpObject));
  return TrnStat;
end;

macro TreatPrimaryAccsForStatic(BranchID, StaticAcc)

  var
    RecFound,
    Pos,
    NextPos,
    SK_Dep = KeyNum(T_Dep, 5),
    IsFirstLn = true,
    Acc,
    Rest,
    StatStr;

  ClearRecord(T_Dep);
  T_Dep.FNCash = BranchID;
  T_Dep.SvodAccount = StaticAcc;
  RecFound = GetGE(T_Dep)
    and (T_Dep.FNCash == BranchID)
    and (T_Dep.SvodAccount == StaticAcc);
  while(RecFound)
    Pos = GetPos(T_Dep);
    if(Next(T_Dep)
      and (T_Dep.FNCash == BranchID)
      and (T_Dep.SvodAccount == StaticAcc))
      NextPos = GetPos(T_Dep);
    else
      NextPos = 0;
    end;
    GetDirect(T_Dep, Pos);
    Acc = T_Dep.Account;
    Rest = T_Dep.Sum_Rest;
    if(IsFirstLn)
      [--------------------------------------------------------------------];
      [:         С ч е т           :      Остаток        :      Статус     ];
      [--------------------------------------------------------------------];
      IsFirstLn = false;
    end;
    TreatAccount;
    if(TrnStat)
      StatStr = "Нормально";
    else
      StatStr = "Ошибка";
    end;
    [ ########################### ##################### ############### ]
    ( Acc_Form(Acc), Rest, StatStr );
    if(NextPos != 0)
      GetDirect(T_Dep, NextPos);
    else
      RecFound = False;
    end;
  end;
  KeyNum(T_Dep, SK_Dep);
end;

macro TreatCurrentStaticAcc

  var
    BranchHead;

  TreatStaticAcc;
  if(TrnStat)
    if(IsFirstForBranch)
      BranchHead = "Филиал № " + ddep.rec.Name;
      PrintLn;
      PrintLn(BranchHead);
      PrintLn(MkStr("-", StrLen(BranchHead)));
      IsFirstForBranch = false;
    end;
    PrintLn;
    PrintLn(Acc_Form(T_Dep.Account), " - ", Acc_Form(T_Dep.PrevAccount));
    PrintLn;
    TreatPrimaryAccsForStatic(T_Dep.FNCash, T_Dep.Account);
    GetDirect(Dep, StaticPos);
    GetDirect(T_Dep, T_StaticPos);
    if(Dep.Sum_Rest == T_Dep.Sum_Rest)
      TrnStat = Delete(T_Dep);
    end;
  end;
end;

macro TreatStaticAccsForBranch(CurrFlag, StaticAccType)

  var
    Pos,
    NextPos,
    RecFound;

  CurStaticType = StaticAccType;
  ClearRecord(T_Dep);
  T_Dep.IsCur = CurrFlag;
  T_Dep.FNCash = ddep.rec.Code;
  T_Dep.Open_Close = StrFor(0);
  T_Dep.Type_Account = StaticAccType;
  RecFound = GetGE(T_Dep)
    and (T_Dep.IsCur == CurrFlag)
    and (T_Dep.FNCash == ddep.rec.Code)
    and (T_Dep.Open_Close == StrFor(0))
    and (T_Dep.Type_Account == StaticAccType);
  while(RecFound)
    Pos = GetPos(T_Dep);
    if(Next(T_Dep)
      and (T_Dep.IsCur == CurrFlag)
      and (T_Dep.FNCash == ddep.rec.Code)
      and (T_Dep.Open_Close == StrFor(0))
      and (T_Dep.Type_Account == StaticAccType))
      NextPos = GetPos(T_Dep);
    else
      NextPos = 0;
    end;
    GetDirect(T_Dep, Pos);
    TreatCurrentStaticAcc;
    if(NextPos != 0)
      GetDirect(T_Dep, NextPos);
    else
      RecFound = False;
    end;
  end;
end;

macro OpenTrFiles(BranchID)

  var
    BIDStr;

  FileExt = ".s00";
  BIDStr = String(BranchID);
  StrSet(FileExt, 5 - StrLen(BIDStr), BIDStr);

  return (Open(T_Dep,TrakDir+"depositr"+FileExt)
    and Open(T_DepDoc,TrakDir+"sbdepdoc"+FileExt)
    and Open(T_DepRest,TrakDir+"sb_drest"+FileExt)
    and Open(T_TrWill,TrakDir+"sbtrast"+FileExt)
    and Open(T_DepClient,TrakDir+"depclnt"+FileExt)
    and Open(T_AuxInfo,TrakDir+"auxinfo"+FileExt)
    and Open(T_ConGet,TrakDir+"sb_congt"+FileExt)
    and Open(T_PcCalc,TrakDir+"pc__calc"+FileExt)
    and Open(T_PcEstim,TrakDir+"pcestim"+FileExt)
    and Open(T_CashLink,TrakDir+"sb_casln"+FileExt)
    and Open(T_AccReg,TrakDir+"accreg"+FileExt)
    and Open(T_TextInfo,TrakDir+"textinfo"+FileExt)
    and Open(T_PcRDate,TrakDir+"pc_rdate"+FileExt)
    and Open(T_DepHistr,TrakDir+"dephistr"+FileExt)
    and Open(T_ScAcc,TrakDir+"scacc"+FileExt)
    and Open(T_ScLink,TrakDir+"sclink"+FileExt)
    and Open(T_ScCard,TrakDir+"sccard"+FileExt)
    and Open(T_ScTran,TrakDir+"sctran"+FileExt)
    and Open(T_PcTax,TrakDir+"pc_tax"+FileExt)
    and Open(T_RetOp,TrakDir+"ret_op"+FileExt)
    and Open(T_OpObject,TrakDir+"opobject"+FileExt));
end;

macro DeleteFiles

  if(Close(T_Dep)
    and Close(T_DepDoc)
    and Close(T_DepRest)
    and Close(T_TrWill)
    and Close(T_DepClient)
    and Close(T_AuxInfo)
    and Close(T_ConGet)
    and Close(T_PcCalc)
    and Close(T_PcEstim)
    and Close(T_CashLink)
    and Close(T_AccReg)
    and Close(T_TextInfo)
    and Close(T_PcRDate)
    and Close(T_DepHistr)
    and Close(T_ScAcc)
    and Close(T_ScLink)
    and Close(T_ScCard)
    and Close(T_ScTran)
    and Close(T_PcTax)
    and Close(T_RetOp)
    and Close(T_OpObject))
    if(not (DelFile(TrakDir+"depositr"+FileExt)
      and DelFile(TrakDir+"sbdepdoc"+FileExt)
      and DelFile(TrakDir+"sb_drest"+FileExt)
      and DelFile(TrakDir+"sbtrast"+FileExt)
      and DelFile(TrakDir+"depclnt"+FileExt)
      and DelFile(TrakDir+"auxinfo"+FileExt)
      and DelFile(TrakDir+"sb_congt"+FileExt)
      and DelFile(TrakDir+"pc__calc"+FileExt)
      and DelFile(TrakDir+"pcestim"+FileExt)
      and DelFile(TrakDir+"sb_casln"+FileExt)
      and DelFile(TrakDir+"accreg"+FileExt)
      and DelFile(TrakDir+"textinfo"+FileExt)
      and DelFile(TrakDir+"pc_rdate"+FileExt)
      and DelFile(TrakDir+"dephistr"+FileExt)
      and DelFile(TrakDir+"scacc"+FileExt)
      and DelFile(TrakDir+"sclink"+FileExt)
      and DelFile(TrakDir+"sccard"+FileExt)
      and DelFile(TrakDir+"sctran"+FileExt)
      and DelFile(TrakDir+"pc_tax"+FileExt)
      and DelFile(TrakDir+"ret_op"+FileExt)
      and DelFile(TrakDir+"opobject"+FileExt)))
      MsgBox("Ошибка при удалении транспортных файлов");
    end;
  end;
end;

macro TreatBranch;

  if(OpenTrFiles(ddep.rec.Code))
    IsFirstForBranch = true;
    TreatStaticAccsForBranch(0, SA_STATIC);
    TreatStaticAccsForBranch(0, SA_UNITED);
    TreatStaticAccsForBranch(1, SA_STATIC);
    TreatStaticAccsForBranch(1, SA_UNITED);
    if(not ErrFlag)
      DeleteFiles;
    else
      MsgBox("Ошибки при загрузке неподвижных/объединенных счетов|для филиала №",
       ddep.rec.Name, " |Повторите процедуру еще раз");
    end;
  end;
end;


/*    		 О С Н О В Н А Я   Ф У Н К Ц И Я              */

  msgbox("На данный момент данная функциональность не поддерживается!");
/*
  var
    RegPath = "RS-RETAIL\\СЕРВИСНЫЕ\\ВКЛАДЫ\\ДОСТУП_ОБЪЕД_НЕПОДВ_СЧЕТ",
    Type = V_INTEGER,
    Value,
    ErrCode;

  if ( BranchStatus != BS_OPERDEP )
    MsgBox( "Эта процедура выполняется в оперчасти" );
    Exit( 1 );
  end; 

  if(GetRegistryValue(RegPath, Type, Value, ErrCode) == V_INTEGER)
    if(Value == 0)
      MsgBox("Запрещен доступ к неподвижным (объединенным) счетам");
      Exit(0);
    end;
  end;
  KeyNum(Dep, 1);
  KeyNum(T_Dep, 1);
  KeyNum(DepDoc, 6);
  KeyNum(T_DepDoc, 6);
  KeyNum(BranchList, 0);
  Rewind(BranchList);
  while(Next(BranchList))
    TreatBranch;
  end;
*/
end;
