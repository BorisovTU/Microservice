Import CommonInter;
/* Отчет о текущем состоянии очередей спулера загрузки данных */

var dpDepList = TdpDepList;
file TrQueue("tr_queue.dbt") key 0;

var
  StopReason,
  NJobs;

macro OutHead

  [ ];
  [#####################################################################################]
  ("Текущее состояние очередей спулера загрузки данных":c);
  [ ];
  [-------------------------------------------------------------------------------------];
  [|   Филиал   | Сессий |             П р и ч и н а   о с т а н о в к и               |];
  [-------------------------------------------------------------------------------------];
end;

macro OutLine

  [ ############ ######## ############################################################# ]
  (
    dpDepList.rec.Name,
    NJobs,
    StopReason:w
  );
end;
  
macro GetQueueInfo

  var
    RecFound;

  NJobs = 0;
  StopReason = "";
  ClearRecord(TrQueue);
  TrQueue.Branch = dpDepList.rec.Code;
  RecFound = GetGE(TrQueue);
  while(RecFound and (TrQueue.Branch == dpDepList.rec.Code))
    if(NJobs == 0)
      StopReason = TrQueue.StopReason;
    end;
    NJobs = NJobs + 1;
    RecFound = Next(TrQueue); 
  end;
end;

macro TreatQueues

  var
    RecFound;

  dpDepList.SetFilter(dpDepList.getFilialID(NumFNCash()));
  while(dpDepList.next())
    GetQueueInfo;
    if(NJobs != 0)
      OutLine;
    end;
  end;
end;

  OutHead;
  TreatQueues;
end;
