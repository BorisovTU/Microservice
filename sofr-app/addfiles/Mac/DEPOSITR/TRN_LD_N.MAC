/***************************************************************************

  RS-Bank ( Сбербанк )
  Обслуживание безналичных платежей
  Макрос загрузки информации о безналичных платежах
  из текстового файла в файлы расшифровок по филиалалам и
  документов вкладчиков по безналичным платежам
  в модуле "Филиал".


  ВНИМАНИЕ !  1. Предполагается, что номера счетов вкладчиков задаются
                 ТОЛЬКО в "новой" 20-ти значной нумерации, введенной
                 по плану счетов с сентября 1998 года.
              2. Настоящий макрос - для ввода КОРОТКИХ (ЧИСЛОВЫХ) номеров
                 счетов вкладчиков по зачислениям.



  1. Структура исходного текстового файла
  ---------------------------------------

  1.0. Каждая запись в исходном файле занимает отдельную строку.
       Начальные пробелы в поле игнорируются, что позволяет струтурировать
       записи в файле либо по филиалам, либо по типам записей, а внутри
       последовательности записей одного типа - струкутрировать по полям.

  1.1. Первой записью текстового файла должна быть запись о платежном
       поручении. Такая запись должна быть одна на файл. Таким образом, в
       одном файле вводятся записи по ОДНОМУ платежному поручению.

  1.2. Затем должны следовать записи сумм по филиалам и по документам
       вкладчиков. Эти записи могут располагаться в произвольной
       последовательности. Главное условие: по каждому филиалу запись
       суммы должна ОБЯЗАТЕЛЬНО предшествовать записям по документам по
       соответствующему филиалу. Кроме того, по каждому филиалу запись
       суммы должна быть ОДНА в исходном файле.

  1.3. Рекомендуемый порядок расположения записей в исходном файле:

       Вариант 1.

       1). Запись по платежному поручению
       2). По каждому филиалу: сначала запись суммы, затем последовательность
           всех записей по документам по этому филиалу

       Вариант 2.

       1). Запись по платежному поручению
       2). Сначала располагается последовательность записей сумм по филиалам
       3). Далее следуют записи по документам, при условии (п.1.2), что по
           каждому филиалу во второй порции записей наличествует запись суммы

  1.4. При загрузке в филиале из записи по платежному поручению берутся
       номер договора, номер поручения, валюта, номер операции и вид
       операции. Сама запись по платежному поручению в филиале не создается.
       В филиале формируются записи по расшифровке ТОЛЬКО по данному филиалу,
       в котором производится загрузка, и - по документам вкладчика этого же
       филиала.


  2. Структура записей исходного файла
  ------------------------------------

  2.0. Поля каждой записи должны следовать СТРОГО в указанном ниже порядке.
       Если какое-то поле опускается (например, поле счета вкладчика), то
       разделитель в конце пустого поля ОБЯЗАТЕЛЬНО должен быть проставлен.


  2.1. Структура записи по платежному поручению следующая:

       ____________________________________________________________
       Номер поля|Тип поля|            Содержание поля
       ____________________________________________________________
            1       Число   Код записи, всегда: 1
            2       Строка  Номер договора, до 25 символов
            3       Число   Номер платежного поручения
            4       Сумма   Заявленная сумма платежного поручения
            5       Число   Код валюты (должен совпадать с указанным в договоре)
            6       Число   Номер операции ( 63 - Списание, 73 - Зачисление )
            7       Число   Вид операции ( 1 - З.плата, 2 - Пенсия,
                                           3 - Выигрыш, 4 - Прочее,
                                           10 - По компенсации )


  2.1. Структура записи суммы по филиалу следующая:

       ____________________________________________________________
       Номер поля|Тип поля|            Содержание поля
       ____________________________________________________________
            1       Число   Код записи, всегда: 2
            2       Число   Номер филиала
            3       Сумма   Сумма по филиалу


  2.2. Структура записи по документу вкладчика следующая:

       ____________________________________________________________
       Номер поля|Тип поля|            Содержание поля
       ____________________________________________________________
            1       Число   Код записи, всегда: 3
            2       Число   Номер филиала
            3       Число   Номер листа
            4       Число   Короткий номер счета вкладчика (может быть пустым)
            5       Строка  Фамилия вкладчика (можно не задавать, если указан
                            Номер счета. Либо Счет, либо Фамилия обязательно
                            должны быть указаны)
            6       Строка  Имя вкладчика (указвается вместе с Фамилией)
            7       Строка  Отчество вкладчика (указвается вместе с Фамилией)
            8       Строка  Сумма документа


  3. Суммы по платежному поручению, по филиалам и по документам вкладчика
     при загрузке сверяются. При равенстве соответствующих сумм ( по
     платежному поручению = сумме Сумм по филиалам, Сумма по филиалу =
     сумме Сумм по документам вкладчика ) проставляется признак Сверки сумм.
     При неравенстве сумм выдаются соответствующие сообщения.


****************************************************************************/

import BankInter, deprintr, "sb_rprt.mac";

var {curdate};
var {oper};

file InputFile() txt 250;        /* Исходный текстовый файл      */
file RepFile()   txt 250 write;  /* Отчет о занесенных записях   */

file Fdtype (sb_dtyp)  key 2;    /* Файл видов вкладов           */
file Fdacnt (depositr) key 0;    /* Файл счетов вкладчиков       */

file Cntr   (trn_cntr) key 0;    /* Файл договоров               */
file PayF   (trn_payf) write;    /* Файл расшифровок по филиалам */
file Docs   (trn_doc ) write;    /* Файл документов по БП        */

/*****************  Константы  *************************/
const Name_rep =    "trn_ld_b.txt";       /* Отчет по занесенным записям */
/*____________142833 - SAN - Removal of the relative paths__________*/
const PatternFile = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", false ) + "\\*.trn";   /* Маска исходного текстового файла   "..\\TXTFILE\\*.trn"*/
const ReportFile = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", false ) + "\\";            // "..\\TXTFILE\\";
/*___________/142833 - 14/07/09_____________________________________*/
const cFNcash  = NumFNcash();             /* Номер филиала */

/******************  Настраиваемые константы  ********************/
/* Вид операции */
const atPension = 2;        /* Пенсия */
/* Виды вклада */
const taWorkPay = "ДО ВОСТРЕБ.";
const taPension = "Пенсионный";

/*************  Глобальные переменные  *****************/
var NameInputFile      = "";    /* Имя Операционного файла          */
var KolStrFile;                 /* Номер строки и количество
                                   строк в Операционном файле       */
var KolStrPayF = 0;             /* Количество введенных расшифровок */
var KolStrDocs = 0;             /* Количество введенных документов  */
var KolStrErr = 0;              /* Количяество ошибок при записи    */
var StrFile            = "";    /* Строка Операционного файла       */
var Sum_Credit = $0;
var Str_Err = "";
var ErrCode, ErrText;

/* Флаг записи по филиалу */
var FlagFilial = FALSE;

/*  Параметры платежного поручения  */
var NumberContract = "";
var Num_PayMessage = "";
var GlobalSumFilial = $0;
var SumDocuments = $0;
var FlagCur = 0;
var GlobalCurrency = 0;
var Ground = "";
var TypeOper = 0;
var ApplType = 0;

/*
  Разделители
  ВНИМАНИЕ! Пробел в качестве разделителя не желателен, но если
  он используется в качестве разделителя, то в основании пробелы
  между словами не ставить
  Впереди каждого поля можно вставлять пробелы для выравнивания
*/
Array Separate;
Separate(0) = "!";
Separate(1) = ":";
Separate(2) = ";";
Separate(3) = ",";
Separate(4) = "|";
const NumberSeparate = ASize(Separate);

/**********************************************************/
macro GetSeparateStr
/*
  Отделяет от StrFile начало строки до первого разделителя
  и смещает начало StrFile на следующий после разделителя символ
*/
  var Str = "";
  var Sym = "";
  var Cont = TRUE;
  var i = 1,
      j = 0,
      k = 1;
  var Len = StrLen(StrFile);
  var SymSpace =TRUE;

  while ((i <= Len) AND Cont)
    Sym = SubStr (StrFile,k,1);
    if (SymSpace AND (Sym == " "))
      StrFile = SubStr (StrFile,2);     /* Чистка от пробелов */
    else
      SymSpace = FALSE;
      j = 0;
      while (j < NumberSeparate)
        if (Sym == Separate(j))
          Cont = FALSE;
        end;
        j = j + 1;
      end;
      k = k + 1;
    end;
    i = i + 1;
  end;
  if (k > 1)
    if (NOT Cont)
      Str = SubStr (StrFile,1,k-2);
    else
      Str = SubStr (StrFile,1,k-1);
    end;
    StrFile = SubStr (StrFile,k);
  end;
  return Str;
end;

/**********************************************************/
macro IsInt (Str)
/*
  Записано ли в строке целое число (без знака)?

  27.01.97
*/
  var stat = TRUE;
  var Len = StrLen(Str);
  var i = 1;
  var Sym;
  var EndSpace = FALSE;

  while ((i <= Len) AND stat)
    Sym = SubStr(Str,i,1);
    if (Sym == " ")
      if (EndSpace)
        stat = FALSE;
      end;
    elif ((Sym < "0") OR (Sym > "9"))
      stat = FALSE;
    else
      EndSpace = TRUE;
    end;
    i = i + 1;
  end;
  return stat;
end;

/**********************************************************/
macro Разделитель_1_1
  var str;
  str = " ---------------------------------------------------------------------------------------------------------------------------------";
  return str;
end;

/************************************************************/
macro Главный_Заголовок_отчета
/*
  Шапка заголовка для всех отчетов
*/
  var str;
  str = " \n" +
  "    Загрузка информации из текстового файла \n" +
  "    в Платежные поручения на перечисления \n" +
  " \n" +
  " Обработан файл: " + NameInputFile + "\n" +
  " Дата обработки: " + String({curdate}) + "\n" +
/*  " Операционист:   " + String({oper}) + "\n" */
  " \n";
  return str;
end;

/**********************************************************/
macro Заголовок_отчета
  var str;
  /* str = Главный_Заголовок_отчета ();
  Insert (RepFile,str); */
  str = Разделитель_1_1();
  Insert (RepFile,str);
  str = "             Действие               |Лист|          Счет           |        Фамилия Имя Отчество       |          Сумма          |\n" +
        "                                    |    |                         |             вкладчика             |                         |";
  Insert (RepFile,str);
  str = Разделитель_1_1();
  Insert (RepFile,str);
end;

/**********************************************************/
macro Запись_в_отчет_расшифровки ( Pref )
  /*
  var str;
  str = "  " + String(Pref:35) +
    String(PayF.NumberContract:25) + " " +
    String(PayF.Num_PayMessage:6)  + " " +
    String(PayF.GlobalSumFilial:a:25);
  Insert (RepFile, str); */

  Insert( RepFile, "    " + Pref + ":" );
  Insert( RepFile, "        Согласно договору " + PayF.NumberContract );
  Insert( RepFile, "  по платежному поручению " + PayF.Num_PayMessage );
  Insert( RepFile, "                 на сумму " + PayF.GlobalSumFilial + "\n\n" );

end;

/**********************************************************/
macro Запись_в_отчет_документа ( Pref )
  var str;
  str = "  " + String(Pref:35) + " " +
    String(Docs.NList:3) + " " +
    String(Acc_Form(Docs.Account):25) + " " +
    String(Docs.Sname+" "+Docs.Nname+" "+Docs.Pname:35)  + " " +
    String(Docs.Sum:a:25);
  Insert (RepFile, str);
end;

/***********************************************************/
macro Конец_отчета
/*
  Вывод итоговых строк в отчет
*/
  /* var i = 0; */
  /* var kol_cur = Asize (Code_Currency); */
  var str;

  str = Разделитель_1_1 ();
  Insert (RepFile, str);
    str = "      Итого:                  " +
     String(Money(Double(Sum_Credit)):a:25);
    Insert (RepFile, str);
  str = " \n" +
  " Общее число обработанных записей: " + String(KolStrFile) + " \n" +
  " \n" +
  " Введено в базу данных " + String(KolStrPayF) + " расшифровок по филиалам \n";
  Insert (RepFile, str);
  str = " Введено в базу данных " + String(KolStrDocs) + " документов \n" +
  " \n";
  Insert (RepFile, str);
  if (KolStrErr > 0)
    str = " Не занесено в базу данных из-за системной ошибки: "+String(KolStrErr);
    Insert (RepFile, str);
  end;
  str = " ";
  Insert (RepFile, str);
end;

/***********************************************************/
macro Есть_Договор( NumberContract )
  var stat = 0;

  Cntr.NumberContract = NumberContract;
  if ( getEQ( Cntr ) )
    FlagCur = Cntr.FlagCur;
    GlobalCurrency = Cntr.Currency_Busines;
    Ground = Cntr.GroundContract;
    TypeOper = Cntr.TypeOper;
    ApplType = Cntr.ApplType;
  else
    Ground = "";
    stat = 1;
  end;

  return stat;
end;

/***********************************************************/
macro Сверка_сумм_филиала ()
  var stat = 0;

  if ( NOT FlagFilial )
    return 0;    /* Записи по филиалу не было */
  else
    Insert (RepFile, "" );
    if ( GlobalSumFilial == SumDocuments )
      PayF.SignCheckFilial = "X";
      if ( Update( PayF ) )
        Запись_в_отчет_расшифровки( "Проставлена сверка сумм" );
      else
        Запись_в_отчет_расшифровки( "Не занесен признак сверки сумм" );
        ErrCode = Status( ErrText );
        Insert (RepFile, "  Ошибка " + String( ErrCode ) +
                         " при изменении записи по филиалу: " + ErrText );
        stat = 3;
      end;
    else
      if ( GlobalSumFilial > SumDocuments )
        Insert( RepFile, "  Заданные суммы " + String( SumDocuments ) +
                         " по документам не составляют суммы филиала " +
                         String( GlobalSumFilial ) );
      else
        Insert( RepFile, "  Заданные суммы " + String( SumDocuments ) +
                         " по документам превышают сумму филиала " +
                         String( GlobalSumFilial ) );
      end;
    end;
  end;

  Insert (RepFile, Разделитель_1_1() );

  return stat;
end;

/***********************************************************/
macro Платежное_поручение ()
  var stat = 0;
  var InputString;  /* Входная строка */
  var Type;         /* Тип записи     */
  var pCntr, pCurrency, pTypeOper, pApplType;

  /* FlagFilial = FALSE; */

  NumberContract = "";
  Num_PayMessage = "";
  GlobalSumFilial = $0;
  SumDocuments = $0;

  /* Номер договора */
  InputString = GetSeparateStr ();
  if ( InputString != "" )
    pCntr = Есть_Договор( InputString );
    NumberContract = InputString;
  else
    Str_Err = Str_Err + "Не задан номер договора для п/п";
    return 1;
  end;

  /* Номер платежного поручения */
  InputString = GetSeparateStr ();
  if ( InputString != "" )
    Num_PayMessage = InputString;
  else
    Str_Err = Str_Err + "Не задан номер п/п для п/п";
    return 2;
  end;

  /* Сумма */
  InputString = GetSeparateStr ();
  if ( ( InputString == "" ) OR NOT IsInt( InputString ) )
    Str_Err = Str_Err + "Не задана сумма для п/п";
    return 2;
  end;

  /* Код валюты */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    pCurrency = Int( InputString );
    if ( pCntr != 0 )
      GlobalCurrency = pCurrency;
      if ( pCurrency == 0 )
        FlagCur = 0;
      else
        FlagCur = 1;
      end;
    end;
    if ( ( pCntr == 0 ) AND ( Cntr.Currency_Busines != pCurrency ) )
      Str_Err = Str_Err + "Код валюты в договоре " +
                String( Cntr.Currency_Busines ) +
                " не совпадает с заданным " + String( pCurrency );
    end;
  else
    Str_Err = Str_Err + "Не задан код валюты";
    return 3;
  end;

  /* Номер операции */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    pTypeOper = Int( InputString );
    if ( ( pCntr == 0 ) AND ( TypeOper != pTypeOper ) )
      Str_Err = Str_Err + "Номер операции из договора " +
                String( TypeOper ) +
                " заменен на " + String( pTypeOper );
    end;
    TypeOper = pTypeOper;
  else
    Str_Err = Str_Err + "Не задан номер операции";
    return 4;
  end;

  /* Вид операции */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    pApplType = Int( InputString );
    if ( ( pCntr == 0 ) AND ( ApplType != pApplType ) )
      Str_Err = Str_Err + "Вид операции из договора " + String( ApplType ) +
                " заменен на " + String( pApplType );
    end;
    ApplType = pApplType;
  else
    Str_Err = Str_Err + "Не задан вид операции";
    return 5;
  end;

  return stat;
end;

/***********************************************************/
macro Расшифровка ()
  var stat = 0;
  var InputString;  /* Входная строка */
  var FNcash = 0;

  /* FlagFilial = FALSE; */

  if ( NumberContract == "" )
    Str_Err = Str_Err + "Попытка задать сумму по филиалу без п/п";
    return 1;
  end;

  /* Номер филиала */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
      FNcash = Int( InputString );
      if ( FNcash == cFNcash )
        if ( FlagFilial )
          Str_Err = Str_Err + "Дублирование записи по филиалу";
          return 2;
        end;
        PayF.FNcash = FNcash;
      else
        /* Str_Err = Str_Err + "Филал " + String( FNcash ) + " задан ошибочно"; */
        Str_Err = "";
        return 0;
      end;
  else
    Str_Err = Str_Err + "Не задан номер филиала для записи по филиалу";
    return 2;
  end;

  /* Сумма */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    PayF.GlobalSumFilial = Money( Double( InputString ) / 100 );
  else
    Str_Err = Str_Err + "Не задана сумма для записи по филиалу";
    return 3;
  end;

  if ( stat == 0 )
    PayF.AutoKey = 0;
    PayF.Num_PayMessage = Num_PayMessage;
    PayF.NumberContract = NumberContract;
    /* PayF.FNcash */
    PayF.FlagCur = FlagCur;
    PayF.NPack = 0;
    PayF.Code_Currency = GlobalCurrency;
    PayF.TypeOper = TypeOper;
    PayF.ApplType = ApplType;
    PayF.DateDocumentFilial = {curdate};
    /* PayF.GlobalSumFilial */
    PayF.GlobalSumFactFilial = $0;
    PayF.SignCheckFilial = StrFor( 0 );
    PayF.DateKvitFilial = Date( 0, 0, 0 );
    PayF.SignKvitFilial = StrFor( 0 );
    PayF.iApplicationKindFi = 0;
    PayF.ApplicationKeyFi = "";
    PayF.NumSession = -1;  /* Введено в филиале ! */
    PayF.Action = 0;
    PayF.Ground = Ground;

    PayF.PaymAppKind = 0;
    PayF.PaymAppKey = "";

    /* Выбор вида вклада */
    if ( ApplType == atPension )
      PayF.Type_Account = taPension;
    else
      PayF.Type_Account = taWorkPay;
    end;

    if ( Insert( PayF ) )
      FlagFilial = TRUE;
      KolStrPayF = KolStrPayF + 1;
      Запись_в_отчет_расшифровки( "Занесена расшифровка" );
      Заголовок_отчета ();
      GlobalSumFilial = PayF.GlobalSumFilial;
      Sum_Credit = Sum_Credit + GlobalSumFilial;

      /* Поиск записи по виду вклада */
      Fdtype.FlagCur = PayF.FlagCur;
      Fdtype.Kind    = PayF.Type_Account;
      if ( NOT getEQ( Fdtype ) )
        println( " Ошибка при чтении вида вкладов < ", PayF.Type_Account, " >" );
        stat = 3;
      end;

    else
      KolStrErr = KolStrErr + 1;
      Запись_в_отчет_расшифровки( "Не занесена расшифровка" );
      ErrCode = Status( ErrText );
      Insert (RepFile, "  Ошибка " + String( ErrCode ) +
                       " при занесении расшифровки: " + ErrText );
      stat = 4;
    end;
  end;

  return stat;
end;

/***********************************************************/
macro Документ ()
  var stat = 0;
  var InputString;  /* Входная строка */
  var FNcash = 0;
  var Number = 0;

  ClearRecord( Docs );

  if ( NumberContract == "" )
    Str_Err = Str_Err + "Попытка задать сумму по документу без п/п";
    return 1;
  end;

  /* Номер филиала */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
      FNcash = Int( InputString );
      if ( FNcash == cFNcash )
        Docs.FNcash = FNcash;
      else
        Str_Err = "";
        return 0;
      end;
  else
    Str_Err = Str_Err + "Не задан номер филиала для записи по документу";
    return 2;
  end;

  if ( NOT FlagFilial )
    Str_Err = Str_Err + "Не найдена запись по филиалу перед записью по документу";
    return 3;
  end;

  /* Номер листа */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    Docs.NList = Int( InputString );
  else
    Str_Err = Str_Err + "Не задан номер листа для записи по документу";
    return 4;
  end;

  Docs.Type_Account = PayF.Type_Account;

  /* Короткий номер счета */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    Number = Int( InputString );
  else
    Number = 0;
  end;

  if ( Number == 0 )
    Str_Err = Str_Err + "Не указан короткий номер счета для записи по документу, проводка запрещена";
    return 5;
  end;


  /* Фамилия */
  Docs.Sname = GetSeparateStr ();

  /* // Chizhova SCR #57445 Запрет на ввод документа без номера счета  
  if ( ( Number == 0 ) AND ( Docs.Sname == "" ) )
    Str_Err = Str_Err + "Не указаны счет и фамилия для записи по документу";
    return 5;
  end;
  */

  /* Имя */
  Docs.Nname = GetSeparateStr ();

  /* Отчество */
  Docs.Pname = GetSeparateStr ();

  /* Сумма */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    Docs.Sum = Money( Double( InputString ) / 100 );
  else
    Str_Err = Str_Err + "Не задана сумма для записи по документу";
    return 6;
  end;

  if ( ( stat == 0 )  and  ( Number != 0 ) )
  /* Поиск заданного счета вкладчика и простановка Referenc */
    Fdacnt.FNCash        = PayF.FNcash;
    Fdacnt.GroupNumb     = Fdtype.NewGroupNumb;
    Fdacnt.Code_Currency = PayF.Code_Currency;
    Fdacnt.Number        = Number;
    if ( getEQ( Fdacnt ) )
    /* Счет найден */
      Docs.Account   = Fdacnt.Account;
      Docs.CodClient = Fdacnt.CodClient;
      Docs.Referenc  = Fdacnt.Referenc;
      Docs.Type_Account = Fdacnt.Type_Account;
    else
    /* Счет не найден */
      Docs.Account   = "";
      Docs.CodClient = 0;
      Docs.Referenc  = "";
    end;
  end;

  if ( stat == 0 )

    Docs.IsCur = FlagCur;
    Docs.FNCash = cFNcash;
    Docs.ListTransfer = PayF.AutoKey;
    /* Docs.Account */
    Docs.Code_Currency = PayF.Code_Currency;
    /* Docs.Type_Account = PayF.Type_Account; */
    /* Docs.CodClient = 0;
    Docs.Sname
    Docs.Nname
    Docs.Pname */
    Docs.Date_Document = {curdate};
    Docs.Oper = {oper};
    Docs.TypeOper = PayF.TypeOper;
    Docs.ApplType = PayF.ApplType;
    /* Docs.Sum */
    Docs.NPack = 0;
    Docs.NDoc = 0;
    /* Docs.NList */
    Docs.iApplicationKind = 0;
    Docs.ApplicationKey = "";
    Docs.Status = StrFor( 0 );
    Docs.Ground = PayF.Ground;
    Docs.NumSession = -1;  /* Введено в филиале ! */
    Docs.Action = 0;
    Docs.SignCheckList = StrFor( 0 );
    Docs.ReasonNoCarry = 0;
    Docs.OldlistTransfer = 0;
    Docs.AutoKey = 0;
    Docs.OldAutoKey = 0;
    Docs.ErrorCode = 0;
    Docs.Fict = StrFor( 0 );

    if ( Insert( Docs ) )
      KolStrDocs = KolStrDocs + 1;
      Запись_в_отчет_документа( "Занесен документ" );
      SumDocuments = SumDocuments + Docs.Sum;
    else
      KolStrErr = KolStrErr + 1;
      Запись_в_отчет_документа( "Не занесен документ" );
      ErrCode = Status( ErrText );
      Insert (RepFile, "  Ошибка " + String( ErrCode ) +
                       " при занесении документа: " + ErrText );
      stat = 3;
    end;
  end;

  return stat;
end;

/***********************************************************/
macro Обработка_записи ()
/*
  Разбирает строку исходного файла
*/
  var stat = 0;
  var InputString;  /* Входная строка */
  var Type;         /* Тип записи     */

  Str_Err = "";

  /* Тип записи */
  InputString = GetSeparateStr ();
  if ( ( InputString != "" ) AND IsInt( InputString ) )
    Type = Int( InputString );
    if ( Type == 1 )
      stat = Платежное_поручение();
    else
      if ( Type == 2 )
        stat = Расшифровка();
      else
        stat = Документ();
      end;
    end;
  else
    Str_Err = Str_Err + "Ошибка в типе записи" + InputString;
    stat = 1;
  end;
  return stat;
end;

/**********************************************************/
macro Обработка_строк_исходного_файла ()
  var stat = 0;

  ReWind (InputFile);
  KolStrFile = 0;
  KolStrPayF = 0;
  KolStrDocs = 0;

  while (Next(InputFile))
    StrFile = InputFile.str;
    KolStrFile = KolStrFile + 1;
    stat = Обработка_записи();
    if  ( ( stat != 0 )  AND  ( Str_Err != "" ) )
      Insert( RepFile, "  Строка " + String( KolStrFile ) + ": " + Str_Err );
      Str_Err = "";
    end;
  end;

  if ( stat == 0 )
    stat = Сверка_сумм_филиала();
  end;

  return stat;
end;

/************************************************************/
macro Обработка_исходного_файла
  var str;
  str = Строка_Начало_Конец_отчета ();
  Insert (RepFile,str);
  /* Заголовок_отчета (); */
  str = Главный_Заголовок_отчета ();
  Insert (RepFile,str);

  Обработка_строк_исходного_файла ();

  Конец_отчета ();
  str = Строка_Начало_Конец_отчета ();
  Insert (RepFile,str);
end;

/************************************************************
                  Головная функция макроса
************************************************************/

  if ( SelectFile( NameInputFile, PatternFile, "Выберите исходный файл" ) )
    if ( Open( InputFile, NameInputFile )   AND
         Open( RepFile, ReportFile + Name_rep ) )
      Обработка_исходного_файла ();
      Close( RepFile );
      Close( InputFile );
      ViewFile( RepFile );
      [ Работа закончена ]
    else
      [ Ошибка при открытии файлов ];
    end;
  else
    [ Отказались от выбора исходного текстового файла ];
  end;

end;
