
/* Сохранение состояния счета */

import deprintr,OperCode, alg_vars, sqlconv;

const PLANPAY_KIND_PLAN = 0;    /* Плановое перечисление */
const PPAY_CLOSE_CLOSE  = "C";  /* Закрыто при закрытии счета */


var
  FNCash=NumFNCash,
  FlagCur=NumFlagCur,
  Direction,
  Account,
  TrnStat;


var 
  Dep,
  DepDoc,
  DepRest,
  TrWill,  
  Plan,    
  AuxInfo, 
  ConGet,  
  PcCalc,
  PcEstim, 
  PcRDate,
  DepStat, 
  dt,      
  PcTax,   
  TxtInf,  

  T_Dep     = TBFile("depositr.dbt", "w", 8, "depositr.sav"),
  T_DepDoc  = TBFile("sbdepdoc.dbt", "w", 6, "sbdepdoc.sav"),
  T_DepRest = TBFile("pc_drest.dbt", "w", 0, "pc_drest.sav"),
  T_TrWill  = TBFile("sbtrast.dbt", "w", 0, "sbtrast.sav"),
  T_Plan    = TBFile("dplanpay.dbt", "w", 0, "dplanpay.sav"),
  T_AuxInfo = TBFile("auxinfo.dbt", "w", 0, "auxinfo.sav"),
  T_ConGet  = TBFile("sb_congt.dbt", "w", 0, "sb_congt.sav"),
  T_PcCalc  = TBFile("pc__calc.dbt", "w", 0, "pc__calc.sav"),
  T_PcEstim = TBFile("pcestim.dbt", "w", 0, "pcestim.sav"),
  T_PcRDate = TBFile("pc_rdate.dbt", "w", 2, "pc_rdate.sav"),
  T_PcTax   = TBFile("pc_tax.dbt", "w", 0, "pc_tax.sav"),
  T_TxtInf  = TBFile("textinfo.dbt", "w", 0, "textinfo.sav");

const
  Unload=0,
  Upload=1;

const
  I_Dep=0,
  I_DepDoc=1,
  I_DepRest=2,
  I_TrWill=3,
  I_AuxInfo=4,
  I_ConGet=5,
  I_PcCalc=6,
  I_PcEstim=7,
  I_PcRDate=8,
  I_Plan=9,
  I_PcTax=10,
  I_TxtInf=11;

const
  SB_DEPOSIT=1,
  D_AUDIT_STORN=14,  /* Сторнирование операции */
  D_INSERT=0;        /* Вставка                */

const 
  RPCB_TAX_SBDEPR_RETAIL = 2;   /* филиал RS-Retail */

const
  A_INSERT = 1,
  A_DELETE = 2;

array
  From,To;


macro OpenSaveFiles;
// Проверка фактического существования таблиц сохранения в базе данных
  T_Dep.Next;
  T_DepDoc.Next;
  T_DepRest.Next;
  T_TrWill.Next;
  T_Plan.Next;
  T_AuxInfo.Next;
  T_ConGet.Next;
  T_PcCalc.Next;
  T_PcEstim.Next;
  T_PcRDate.Next;
  T_PcTax.Next;
  T_TxtInf.Next;
  return True;
OnError (er)
  MsgBox("Ошибка при открытии файлов сохранения");
  Exit;
end;

macro GetLastDocCompOp

  var
    RetVal;

  DepDoc.addFilter("t.t_Referenc = " + string(Dep.rec.Referenc));
  DepDoc.rec.Referenc = Dep.rec.Referenc;
  DepDoc.rec.Date_Document = {curdate};
  DepDoc.rec.NumDayDoc = 32767;
  if(DepDoc.GetLE() and (DepDoc.rec.Referenc == Dep.rec.Referenc))
    RetVal = DepDoc.rec.TypeComplexOper;
  else
    RetVal = -1;
  end;
  DepDoc.dropFilter();
  return RetVal;
end;

macro CleanUpDepDoc;

  var
    Stat=true;

  To(I_DepDoc).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc));
  To(I_DepDoc).clear();
  To(I_DepDoc).rec.Referenc=From(I_Dep).rec.Referenc;
  while(Stat and To(I_DepDoc).GetGE()
    and (To(I_DepDoc).rec.Referenc==From(I_Dep).rec.Referenc))
    Stat=To(I_DepDoc).Delete();
  end;
  To(I_DepDoc).dropFilter();
  return Stat;
end;

macro CopyDepDoc;

  var
    RecFound,
    Stat=true;

  From(I_DepDoc).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc));
  From(I_DepDoc).clear();
  From(I_DepDoc).rec.Referenc=From(I_Dep).rec.Referenc;
  RecFound=From(I_DepDoc).GetGE();
  while(Stat and RecFound and (From(I_DepDoc).rec.Referenc==From(I_Dep).rec.Referenc))
    Copy(To(I_DepDoc),From(I_DepDoc));
    Stat=To(I_DepDoc).Insert();
    if(Stat)
      RecFound=From(I_DepDoc).Next();
    end;
  end;
  From(I_DepDoc).dropFilter();
  return Stat;
end;

macro CleanUpDepRest;

  var
    Stat=true;

  To(I_DepRest).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc));
  To(I_DepRest).clear();
  To(I_DepRest).rec.Referenc=From(I_Dep).rec.Referenc;
  while(Stat and To(I_DepRest).GetGE()
    and (To(I_DepRest).rec.Referenc==From(I_Dep).rec.Referenc))
    Stat=To(I_DepRest).Delete();
  end;
  To(I_DepRest).dropFilter;
  return Stat;
end;

macro CopyDepRest;

  var
    RecFound,
    Stat=true;

  From(I_DepRest).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc));
  From(I_DepRest).clear();
  From(I_DepRest).rec.Referenc=From(I_Dep).rec.Referenc;
  RecFound=From(I_DepRest).GetGE();
  while(Stat and RecFound and (From(I_DepRest).rec.Referenc==From(I_Dep).rec.Referenc))
    Copy(To(I_DepRest),From(I_DepRest));
    Stat=To(I_DepRest).Insert();
    if(Stat)
      RecFound=From(I_DepRest).Next();
    end;
  end;
  From(I_DepRest).dropFilter();
  return Stat;
end;

macro CleanUpTrWill;

  var
    Stat=true;

  To(I_TrWill).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc));
  To(I_TrWill).clear();
  To(I_TrWill).rec.Referenc=From(I_Dep).rec.Referenc;
  while(Stat and To(I_TrWill).GetGE()
    and (To(I_TrWill).rec.Referenc==From(I_Dep).rec.Referenc))
    Stat=To(I_TrWill).Delete();
  end;
  To(I_TrWill).dropFilter();
  return Stat;
end;

macro CopyTrWill;

  var
    RecFound,
    Stat=true;

  From(I_TrWill).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc));
  From(I_TrWill).clear();
  From(I_TrWill).rec.Referenc=From(I_Dep).rec.Referenc;
  RecFound=From(I_TrWill).GetGE();
  while(Stat and RecFound and (From(I_TrWill).rec.Referenc==From(I_Dep).rec.Referenc))
    Copy(To(I_TrWill),From(I_TrWill));
      Stat=To(I_TrWill).Insert();
    if(Stat)
      RecFound=From(I_TrWill).Next();
    end;
  end;
  From(I_TrWill).dropFilter();
  return Stat;
end;

macro CleanUpPlan;

  var
    Stat=true;

  To(I_Plan).addFilter("t.t_IsCur = " + string(From(I_Dep).rec.IsCur) +
		       " and t.t_FNCash = " + string(From(I_Dep).rec.FNCash) + 
		       " and t.t_KindPay = " + string(PLANPAY_KIND_PLAN) + 
		       " and t.t_Open_Close = " + sqlChar(PPAY_CLOSE_CLOSE) +
		       " and t.t_Account = " + GetSQLString(From(I_Dep).rec.Account) );
  To(I_Plan).clear();
  To(I_Plan).rec.IsCur=From(I_Dep).rec.IsCur;
  To(I_Plan).rec.FNCash=From(I_Dep).rec.FNCash;
  To(I_Plan).rec.KindPay=PLANPAY_KIND_PLAN;
  To(I_Plan).rec.Open_Close=PPAY_CLOSE_CLOSE;
  To(I_Plan).rec.Account=From(I_Dep).rec.Account;
  while(Stat and To(I_Plan).GetGE()
    and (To(I_Plan).rec.IsCur==From(I_Dep).IsCur)
    and (To(I_Plan).rec.FNCash==From(I_Dep).FNCash)
    and (To(I_Plan).rec.KindPay==PLANPAY_KIND_PLAN)
    and (To(I_Plan).rec.Open_Close==PPAY_CLOSE_CLOSE)
    and (To(I_Plan).rec.Account==From(I_Dep).Account))
    Stat=To(I_Plan).Delete();
  end;
  To(I_Plan).dropFilter();
  return Stat;
end;

macro CopyPlan;

  var
    RecFound,
    Stat=true;

  From(I_Plan).addFilter("t.t_IsCur = " + string(From(I_Dep).rec.IsCur) +
			 " and t.t_FNCash = " + string(From(I_Dep).rec.FNCash) + 
			 " and t.t_KindPay = " + string(PLANPAY_KIND_PLAN) + 
			 " and t.t_Open_Close = " + sqlChar(PPAY_CLOSE_CLOSE) +
			 " and t.t_Account = " + GetSQLString(From(I_Dep).rec.Account) );
  From(I_Plan).clear();
  From(I_Plan).rec.IsCur=From(I_Dep).rec.IsCur;
  From(I_Plan).rec.FNCash=From(I_Dep).rec.FNCash;
  From(I_Plan).rec.KindPay=PLANPAY_KIND_PLAN;
  From(I_Plan).rec.Open_Close=PPAY_CLOSE_CLOSE;
  From(I_Plan).rec.Account=From(I_Dep).rec.Account;
  RecFound=From(I_Plan).GetGE();
  while(Stat and RecFound and
        (From(I_Plan).rec.IsCur==From(I_Dep).rec.IsCur) and
        (From(I_Plan).rec.FNCash==From(I_Dep).rec.FNCash) and
        (From(I_Plan).rec.KindPay==PLANPAY_KIND_PLAN) and
        (From(I_Plan).rec.Open_Close==PPAY_CLOSE_CLOSE) and
        (From(I_Plan).rec.Account==From(I_Dep).rec.Account))
    Copy(To(I_Plan),From(I_Plan));
      Stat=To(I_Plan).Insert();
    if(Stat)
      RecFound=From(I_Plan).Next();
    end;
  end;
  From(I_Plan).dropFilter();
  return Stat;
end;

macro CleanUpAuxInfo;

  var
    Stat=true;

  To(I_AuxInfo).addFilter("t.t_Reference = " + string(From(I_Dep).rec.Referenc) );
  To(I_AuxInfo).clear();
  To(I_AuxInfo).rec.Reference=From(I_Dep).rec.Referenc;
  while(Stat and To(I_AuxInfo).GetGE()
    and (To(I_AuxInfo).rec.Reference==From(I_Dep).rec.Referenc))
    Stat=To(I_AuxInfo).Delete();
  end;
  To(I_AuxInfo).dropFilter();
  return Stat;
end;

macro CopyAuxInfo;

  var
    RecFound,
    Stat=true;

  From(I_AuxInfo).addFilter("t.t_Reference = " + string(From(I_Dep).rec.Referenc) );
  From(I_AuxInfo).clear();
  From(I_AuxInfo).rec.Reference=From(I_Dep).rec.Referenc;
  RecFound=From(I_AuxInfo).GetGE();
  while(Stat and RecFound
    and (From(I_AuxInfo).rec.Reference==From(I_Dep).rec.Referenc))
    Copy(To(I_AuxInfo),From(I_AuxInfo));
    Stat=To(I_AuxInfo).Insert();
    if(Stat)
      RecFound=From(I_AuxInfo).Next();
    end;
  end;
  From(I_AuxInfo).dropFilter();
  return Stat;
end;

macro CleanUpConGet;

  var
    Stat=true;

  To(I_ConGet).addFilter("t.t_ReferencAcc = " + string(From(I_Dep).rec.Referenc) );
  To(I_ConGet).clear();
  To(I_ConGet).rec.ReferencAcc=From(I_Dep).rec.Referenc;
  while(Stat and To(I_ConGet).GetGE()
    and (To(I_ConGet).rec.ReferencAcc==From(I_Dep).rec.Referenc))
    Stat=To(I_ConGet).Delete();
  end;
  To(I_ConGet).dropFilter();
  return Stat;
end;

macro CopyConGet;

  var
    RecFound,
    Stat=true;

  From(I_ConGet).addFilter("t.t_ReferencAcc = " + string(From(I_Dep).rec.Referenc) );
  From(I_ConGet).clear();
  From(I_ConGet).rec.ReferencAcc=From(I_Dep).rec.Referenc;
  RecFound=From(I_ConGet).GetGE();
  while(Stat and RecFound
    and (From(I_ConGet).rec.ReferencAcc==From(I_Dep).rec.Referenc))
    Copy(To(I_ConGet),From(I_ConGet));
    Stat=To(I_ConGet).Insert();
    if(Stat)
      RecFound=From(I_ConGet).Next();
    end;
  end;
  From(I_ConGet).dropFilter();
  return Stat;
end;

macro CleanUpPcCalc;

  var
    Stat=true;

  To(I_PcCalc).addFilter("t.t_Referenc = " + string(To(I_Dep).rec.Referenc) );
  To(I_PcCalc).clear();
  To(I_PcCalc).rec.Referenc=To(I_Dep).rec.Referenc;
  while(Stat and To(I_PcCalc).GetGE()
    and (To(I_PcCalc).rec.Referenc==To(I_Dep).rec.Referenc))
    Stat=To(I_PcCalc).Delete();
  end;
  To(I_PcCalc).dropFilter();
  return Stat;
end;

macro CopyPcCalc;

  var
    RecFound,
    Stat=true;

  From(I_PcCalc).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc) );
  From(I_PcCalc).clear();
  From(I_PcCalc).rec.Referenc=From(I_Dep).rec.Referenc;
  RecFound=From(I_PcCalc).GetGE();
  while(Stat and RecFound and (From(I_PcCalc).rec.Referenc==From(I_Dep).rec.Referenc))
    Copy(To(I_PcCalc),From(I_PcCalc));
    Stat=To(I_PcCalc).Insert();
    if(Stat)
      RecFound=From(I_PcCalc).Next();
    end;
  end;
  From(I_PcCalc).dropFilter();
  return Stat;
end;

macro CleanUpPcTax

  var
    Stat=true;

  To(I_PcTax).addFilter("t.t_CodeModule = " + string(RPCB_TAX_SBDEPR_RETAIL) +
      " and t.t_ObjectTax = " + GetSQLString(string(To(I_Dep).rec.Referenc)) );
  To(I_PcTax).clear();
  To(I_PcTax).rec.CodeModule=RPCB_TAX_SBDEPR_RETAIL;
  To(I_PcTax).rec.ObjectTax=string(To(I_Dep).rec.Referenc);
  while(Stat and To(I_PcTax).GetGE()
    and (To(I_PcTax).rec.CodeModule==RPCB_TAX_SBDEPR_RETAIL)
    and (To(I_PcTax).rec.ObjectTax==string(To(I_Dep).rec.Referenc)))
    Stat=To(I_PcTax).Delete();
  end;
  To(I_PcTax).dropFilter();
  return Stat;
end;

macro CopyPcTax

  var
    RecFound,
    Stat=true;

  From(I_PcTax).addFilter("t.t_CodeModule = " + string(RPCB_TAX_SBDEPR_RETAIL) +
      " and t.t_ObjectTax = " + GetSQLString(string(From(I_Dep).rec.Referenc)) );
  From(I_PcTax).clear();
  From(I_PcTax).rec.CodeModule=RPCB_TAX_SBDEPR_RETAIL;
  From(I_PcTax).rec.ObjectTax=string(From(I_Dep).rec.Referenc);
  RecFound=From(I_PcTax).GetGE();
  while(Stat and RecFound 
    and (From(I_PcTax).rec.CodeModule==RPCB_TAX_SBDEPR_RETAIL)
    and (From(I_PcTax).rec.ObjectTax==string(From(I_Dep).rec.Referenc)))
    Copy(To(I_PcTax),From(I_PcTax), 1);
    Stat=To(I_PcTax).Insert();
    if(Stat)
      RecFound=From(I_PcTax).Next();
    end;
  end;
  From(I_PcTax).dropFilter();
  return Stat;
end;

macro CleanUpTxtInf

  var
    Stat=true;

  To(I_TxtInf).addFilter("t.t_Reference = " + string(From(I_Dep).rec.Referenc));
  To(I_TxtInf).clear();
  To(I_TxtInf).rec.Reference=string(To(I_Dep).rec.Referenc);
  while(Stat and To(I_TxtInf).GetGE()
    and (To(I_TxtInf).rec.Reference==string(To(I_Dep).rec.Referenc)))
    Stat=To(I_TxtInf).Delete();
  end;
  To(I_TxtInf).dropFilter();
  return Stat;
end;

macro CopyTxtInf

  var
    RecFound,
    Stat=true;

  From(I_TxtInf).addFilter("t.t_Reference = " + string(From(I_Dep).rec.Referenc));
  From(I_TxtInf).clear();
  From(I_TxtInf).rec.Reference=string(From(I_Dep).rec.Referenc);
  RecFound=From(I_TxtInf).GetGE();
  while(Stat and RecFound 
    and (From(I_TxtInf).rec.Reference==string(From(I_Dep).rec.Referenc)))
    Copy(To(I_TxtInf),From(I_TxtInf), 1);
    Stat=To(I_TxtInf).Insert();
    if(Stat)
      RecFound=From(I_TxtInf).Next();
    end;
  end;
  From(I_TxtInf).dropFilter();
  return Stat;
end;

macro CleanUpPcRDate;

  var
    Stat=true;

  To(I_PcRDate).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc) );
  To(I_PcRDate).clear();
  To(I_PcRDate).rec.Referenc=From(I_Dep).rec.Referenc;
  while(Stat and To(I_PcRDate).GetGE()
    and (To(I_PcRDate).rec.Referenc==From(I_Dep).rec.Referenc))
    Stat=To(I_PcRDate).Delete();
  end;
  To(I_PcRDate).dropFilter();
  return Stat;
end;

macro CopyPcRDate;

  var
    RecFound,
    Stat=true;

  From(I_PcRDate).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc) );
  From(I_PcRDate).clear();
  From(I_PcRDate).rec.Referenc=From(I_Dep).rec.Referenc;
  RecFound=From(I_PcRDate).GetGE();
  while(Stat and RecFound and (From(I_PcRDate).rec.Referenc==From(I_Dep).rec.Referenc))
    Copy(To(I_PcRDate),From(I_PcRDate));
    Stat=To(I_PcRDate).Insert();
    if(Stat)
      RecFound=From(I_PcRDate).Next();
    end;
  end;
  From(I_PcRDate).dropFilter();
  return Stat;
end;

macro InsStornRec

  var
    Stat,
    OldKey = DepDoc.KeyNum();
    DepDoc.KeyNum = 6;

  DepDoc.addFilter("t.t_Referenc = " + string(Dep.rec.Referenc) );
  DepDoc.rec.Referenc = Dep.rec.Referenc;
  DepDoc.rec.Date_Document = {curdate};
  DepDoc.rec.NumDayDoc = 32767;
  Stat = (DepDoc.GetLE() and (DepDoc.rec.Referenc == Dep.rec.Referenc));
  if(Stat)
    if(DepDoc.rec.Date_Document == {curdate});
      DepDoc.rec.NumDayDoc = DepDoc.rec.NumDayDoc + 100;
    else
      DepDoc.rec.NumDayDoc = 100;
      DepDoc.rec.Date_Document = {curdate};
    end;
    DepDoc.rec.ArDate = {curdate};
    DepDoc.rec.KindOp = D_AUDIT_STORN;
    DepDoc.rec.Oper = {oper};
    DepDoc.rec.TypeOper = Закрытие_Счета;
    DepDoc.rec.TypeComplexOper = Закрытие_Счета;
    DepDoc.rec.NumSession = 0;
    DepDoc.rec.Action = D_INSERT;
    DepDoc.rec.FlagStorn = 1;
    DepDoc.rec.iApplicationKind = SB_DEPOSIT;
    DepDoc.rec.InSum = DepDoc.rec.OutSum = DepDoc.rec.PercOprSum = $0;
    DepDoc.rec.Rest = GetRestForDate(DepDoc.rec.Referenc, {curdate});
    DepDoc.rec.ApplicationKey = FormApplicationKey(SB_DEPOSIT);
    DepDoc.rec.Ground = "Сторнирование операции закрытия";
/*
    VZ 18.09.98 В результате перенумерации мог сменится № счета.
    Инициализируем его из записи по счету
*/
    DepDoc.rec.Account = Dep.rec.Account;

    Stat = DepDoc.Insert();
    if(Stat)
      DepDoc.rec.NumDayDoc = DepDoc.rec.NumDayDoc + 100;
      DepDoc.rec.KindOp = 0;
      DepDoc.rec.ApplicationKey = FormApplicationKey(SB_DEPOSIT);
      Stat = DepDoc.Insert();
    end;
  end;
  DepDoc.dropFilter();
  DepDoc.KeyNum = OldKey;
  return Stat;
end;


macro CleanUpPcEstim

  var
    Stat=true;

  To(I_PcEstim).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc) );
  To(I_PcEstim).clear();
  To(I_PcEstim).rec.Referenc=From(I_Dep).rec.Referenc;
  while(Stat and To(I_PcEstim).GetGE()
    and (To(I_PcEstim).rec.Referenc==From(I_Dep).rec.Referenc))
    Stat=To(I_PcEstim).Delete();
  end;
  To(I_PcEstim).dropFilter();
  return Stat;
end;

macro CopyPcEstim;

  var
    RecFound,
    Stat=true;

  From(I_PcEstim).addFilter("t.t_Referenc = " + string(From(I_Dep).rec.Referenc) );
  From(I_PcEstim).clear();
  From(I_PcEstim).rec.Referenc=From(I_Dep).rec.Referenc;
  RecFound=From(I_PcEstim).GetGE();
  while(Stat and RecFound and (From(I_PcEstim).rec.Referenc==From(I_Dep).rec.Referenc))
    Copy(To(I_PcEstim),From(I_PcEstim));
    Stat=To(I_PcEstim).Insert();
    if(Stat)
      RecFound=From(I_PcEstim).Next();
    end;
  end;
  From(I_PcEstim).dropFilter();
  return Stat;
end;

macro CopyDep;

  var
    Stat=true;

  From(I_Dep).clear();
  From(I_Dep).rec.Referenc=Account;

  if(From(I_Dep).GetEQ())
    To(I_Dep).clear();
    To(I_Dep).rec.Referenc=From(I_Dep).rec.Referenc;
    if(To(I_Dep).GetEQ())
      Stat=To(I_Dep).Delete();
    end;
    if(Stat)
      Copy(To(I_Dep),From(I_Dep));
      if(Direction==Upload)
      end;
    end;
    if(Stat)
      Stat=CleanUpDepDoc;
      if(Stat)
        Stat=CopyDepDoc;
      end;
    end;
    if(Stat)
      Stat=CleanUpDepRest;
      if(Stat)
        Stat=CopyDepRest;
      end;
    end;
    if(Stat)
      Stat=CleanUpTrWill;
      if(Stat)
        Stat=CopyTrWill;
      end;
    end;
    if(Stat)
      Stat=CleanUpPlan;
      if(Stat)
        Stat=CopyPlan;
      end;
    end;
    if(Stat)
      Stat=CleanUpAuxInfo;
      if(Stat)
        Stat=CopyAuxInfo;
      end;
    end;
    if(Stat)
      Stat=CleanUpConGet;
      if(Stat)
        Stat=CopyConGet;
      end;
    end;
    if(Stat)
      Stat = CleanUpPcCalc;
      if(Stat)
        Stat=CopyPcCalc;
      end;
    end;
    if(Stat)
      Stat = CleanUpPcEstim;
      if(Stat)
        Stat=CopyPcEstim;
      end;
    end;
    if(Stat)
      Stat = CleanUpPcRDate;
      if(Stat)
        Stat=CopyPcRDate;
      end;
    end;
    if(Stat)
      Stat = CleanUpPcTax;
      if(Stat)
        Stat=CopyPcTax;
      end;
    end;
    if(Stat)
      Stat = CleanUpTxtInf;
      if(Stat)
        Stat=CopyTxtInf;
      end;
    end;
    if(Stat)
      Stat=To(I_Dep).Insert();
    end;
    if(Stat and (Direction==Upload))
      Stat=InsStornRec;
    end;
  else
    Stat=false;
  end;
  return Stat;
end;

macro TrnProc;

  TrnStat=false;
  if(CopyDep)
    TrnStat=true;
  else
    AbortTrn;
  end;
end;

macro DoCopyTransaction;

  if (InTransaction() == false)
      LoopInTrn(TRUE);

      return ProcessTrn(null,"TrnProc",
        From(I_Dep),To(I_Dep),
        From(I_DepDoc),To(I_DepDoc),
        From(I_DepRest),To(I_DepRest),
        From(I_TrWill),To(I_TrWill),
        From(I_Plan),To(I_Plan),
        From(I_AuxInfo),To(I_AuxInfo),
        From(I_ConGet),To(I_ConGet),
        From(I_PcCalc),To(I_PcCalc),
        From(I_PcEstim),To(I_PcEstim),
        From(I_PcRDate),To(I_PcRDate),
        From(I_PcTax),To(I_PcTax),
        From(I_TxtInf),To(I_TxtInf));
  else
    TrnStat = CopyDep();
    return TrnStat;
  end;
end;

macro UnloadAcc(Acc,OpenFlag);

  Dep       = TDepFile("depositr.dbt", "r", 8);
  DepDoc    = TDepFile("sbdepdoc.dbt", "r", 6);
  DepRest   = TDepFile("pc_drest.dbt", "r", 0);
  TrWill    = TBFile("sbtrast.dbt", "r",  0);
  Plan      = TBFile("dplanpay.dbt", "r", 0);
  AuxInfo   = TDepFile("auxinfo.dbt", "r", 0);
  ConGet    = TBFile("sb_congt.dbt", "r", 0);
  PcCalc    = TDepFile("pc__calc.dbt", "r", 0);
  PcEstim   = TDepFile("pcestim.dbt", "r", 0);
  PcRDate   = TDepFile("pc_rdate.dbt", "r", 2);
  DepStat   = TBFile("sb_depst.dbt", "r", 0);
  dt        = TBFile("sb_dtyp.dbt", "r", 2);
  PcTax     = TDepFile("pc_tax.dbt", "r", 0);
  TxtInf    = TBFile("textinfo.dbt", "r", 0);

  Direction=Unload;
  From(I_Dep)=Dep;
  To(I_Dep)=T_Dep;
  From(I_DepDoc)=DepDoc;
  To(I_DepDoc)=T_DepDoc;
  From(I_DepRest)=DepRest;
  To(I_DepRest)=T_DepRest;
  From(I_TrWill)=TrWill;
  To(I_TrWill)=T_TrWill;
  From(I_Plan)=Plan;
  To(I_Plan)=T_Plan;
  From(I_AuxInfo)=AuxInfo;
  To(I_AuxInfo)=T_AuxInfo;
  From(I_ConGet)=ConGet;
  To(I_ConGet)=T_ConGet;
  From(I_PcCalc)=PcCalc;
  To(I_PcCalc)=T_PcCalc;
  From(I_PcEstim)=PcEstim;
  To(I_PcEstim)=T_PcEstim;
  From(I_PcRDate)=PcRDate;
  To(I_PcRDate)=T_PcRDate;
  From(I_PcTax)=PcTax;
  To(I_PcTax)=T_PcTax;
  From(I_TxtInf)=TxtInf;
  To(I_TxtInf)=T_TxtInf;

  if(OpenFlag)
    OpenSaveFiles;
  end;

  Account=Acc;
  if(Account!="")
    DoCopyTransaction;
  end;
  return TrnStat;
end;

macro UploadAcc(Acc,OpenFlag);

  Dep       = TDepFile("depositr.dbt", "w", 8);
  DepDoc    = TDepFile("sbdepdoc.dbt", "w", 6);
  DepRest   = TDepFile("pc_drest.dbt", "w", 0);
  TrWill    = TBFile("sbtrast.dbt", "w",  0);
  Plan      = TBFile("dplanpay.dbt", "w", 0);
  AuxInfo   = TDepFile("auxinfo.dbt", "w", 0);
  ConGet    = TBFile("sb_congt.dbt", "w", 0);
  PcCalc    = TDepFile("pc__calc.dbt", "w", 0);
  PcEstim   = TDepFile("pcestim.dbt", "w", 0);
  PcRDate   = TDepFile("pc_rdate.dbt", "w", 2);
  DepStat   = TBFile("sb_depst.dbt", "w", 0);
  dt        = TBFile("sb_dtyp.dbt", "w", 2);
  PcTax     = TDepFile("pc_tax.dbt", "w", 0);
  TxtInf    = TBFile("textinfo.dbt", "w", 0);

  Direction=Upload;
  From(I_Dep)=T_Dep;
  To(I_Dep)=Dep;
  From(I_DepDoc)=T_DepDoc;
  To(I_DepDoc)=DepDoc;
  From(I_DepRest)=T_DepRest;
  To(I_DepRest)=DepRest;
  From(I_TrWill)=T_TrWill;
  To(I_TrWill)=TrWill;
  From(I_Plan)=T_Plan;
  To(I_Plan)=Plan;
  From(I_AuxInfo)=T_AuxInfo;
  To(I_AuxInfo)=AuxInfo;
  From(I_ConGet)=T_ConGet;
  To(I_ConGet)=ConGet;
  From(I_PcCalc)=T_PcCalc;
  To(I_PcCalc)=PcCalc;
  From(I_PcEstim)=T_PcEstim;
  To(I_PcEstim)=PcEstim;
  From(I_PcRDate)=T_PcRDate;
  To(I_PcRDate)=PcRDate;
  From(I_PcTax)=T_PcTax;
  To(I_PcTax)=PcTax;
  From(I_TxtInf)=T_TxtInf;
  To(I_TxtInf)=TxtInf;

  if(OpenFlag)
    OpenSaveFiles;
  end;

  Account=Acc;
  if(Account!="")
    DoCopyTransaction;
  end;
  return TrnStat;
end;

macro UnloadAccount(Acc);

  return UnloadAcc(Acc,True);
end;

macro UploadAccount(Acc);

  return UploadAcc(Acc,True);
end;
