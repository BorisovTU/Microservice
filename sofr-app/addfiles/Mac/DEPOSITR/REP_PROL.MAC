/*

   âç¥â ¯® ¯à®®«­£ æ¨¨ §  ¯¥à¨®¤ ¯® ¢¨¤ ¬ ¢ª« ¤®¢

*/

import deprintr, sqlconv;
import rsd;

var
  Branch = NumFNCash,
  {curdate},
  {oper},
  StartDate = {curdate},
  EndDate   = {curdate},
  atAccount = false;

var
  recDTyp, recAcc, recDoc;

var
  printTitle = TRUE;

var
  dtypSum = $0;

var dtyp = TBfile( "sb_dtyp.dbt",  "r", 3 );
var acc  = TBfile( "depositr.dbt", "r", 1 );
var doc  = TBfile( "sbdepdoc.dbt", "r", 1 );

/* ‡­ ç¥­¨ï ª®¤  à¥¦¨¬  à ¡®âë */
const MODE_NORMAL = 0;       /* ®à¬ «ì­ë© à¥¦¨¬ */
const MODE_EOY = 1;          /* Š®­¥æ ¯¥à¨®¤  */
const MODE_EOY_PRECALC = 2;  /* Š®­¥æ ¯¥à¨®¤  - ¤®ªã¬¥­âë ¯à¥¤¢ à¨â¥«ì­®£® à áç¥â  */
const MODE_GZ = 4;           /* ƒàã¯¯  § ç¨á«¥­¨ï */

private const NULL_DATE = date( 0, 0, 0 );

private var FNCash = NumFNcash();
private var FlagCur = NumFlagCur();

private var CodeCurrency = 0;


private macro findOperName(oper)
  var cmd, rs;
  var oper_name = "";
  cmd = RsdCommand(
        "select substr (t_name, 0, instr (t_name, ' ')) || ' ' || " +
               "substr (t_name, instr (t_name, ' ') + 1, 1) || '. ' || " +
               "substr (substr (t_name, instr (t_name, ' ') + 1), " +
                        "instr (substr (t_name, instr (t_name, ' ') + 1), ' ') + 1, 1) || '.' fio " +
          "from dperson_dbt persn "
         "where t_oper = ? " );
  cmd.addParam("oper", RSDBP_IN, oper);
  cmd.execute;

  rs = RsdRecordSet(cmd);
  if(rs.moveNext)
    oper_name = rs.value("fio");
  end;
  return oper_name;
end;

//-----------------------------------------------------------------------
private macro print_Title(cur_code)
  private var {Name_Bank};

    macro DefNameCurrency (Code)
      file currency (currency);
      var ShortName = String(Code);

      KeyNum(currency,0);
      currency.Code_Currency = Code;
      if (GetEQ(currency))
        ShortName = currency.Short_Name;
      end;
      return ShortName;
    end;

  var sFilial;
  if ( not findDepartment(FNCash, sFilial) )
    sFilial = "???";
  end;

  [#
   ®¤à §¤¥«¥­¨¥ #
   ‚ «îâ  #
                            ‚¥¤®¬®áâì ¯à®«®­£ æ¨¨ ¤®£®¢®à®¢ §  ##########
   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   ³                              ³                              ³   „ â    ³    ‹¨æ¥¢®© áç¥â    ³ ®¢ë© áà®ª³   ¡é¨©   ³    ‹¨æ¥¢®© áç¥â    ³     ‘ã¬¬      ³   áâ â®ª     ³
   ³      ®¬¥à ¤®£®¢®à           ³         ” ¬¨«¨ï ˆ..         ³ ®âªàëâ¨ï ³   ¤® ¯à®«®­£ æ¨¨   ³¯à®«®­£ æ¨¨³ áà®ª ¯®á«¥³ ¯®á«¥ ¯à®«®­£ æ¨¨  ³    ¯à®æ¥â®¢   ³  ¢ª« ¤  ¯®á«¥ ³
   ³                              ³                              ³ ¤®£®¢®à  ³                    ³ (¢ ¤­ïå)  ³¯à®«®­£ æ¨¨³                    ³               ³   ¯à«®­£¢æ¨¨  ³
  ] 
// ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ({Name_Bank},
   sFilial,
   DefNameCurrency(cur_code),
   StartDate:f
  );
end;

private macro separate_up
  [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
end;

private macro separate_cross
  [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
end;

private macro separate_down
  [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
end;

private macro separate_end
  [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
                                                                                        /##############################/
  ]
  (findOperName({oper}));
end;

private macro print_name_account(type_account)
  [³‚ª« ¤  #                                                                                                                                                                  ³]
  (type_account);
end;
//##########
private macro print_report_str(ctr_number, client_name, open_date, account_before, new_term, term_after, account_after, sum_perc, sum_all, date_end)
  [³##############################³##############################³##########³####################³###########³###########³####################³###############³###############³]
  (ctr_number,
   client_name,
   open_date,
   account_before,
   new_term,
   term_after,
   account_after,
   sum_perc:12:2,
   sum_all:12:2
   );
end;

private macro find_rest(referenc)
  var cmd, rs;
  var sum_rest = 0;
  cmd = RsdCommand(
          "select t_rest " +
            "from (select t_rest " +
                    "from dsbdepdoc_dbt d " +
                   "where t_referenc = ? " +
                     "and t_depdate_document = ? " +
                     "and t_typecomplexoper = 82 " +
                     "and t_kindop <> 8 " +
                     "and t_kindop <> 9 " +
                     "and t_kindop <> 14 " +
                     "and t_kindop <> 15 " +
                     "and t_kindop <> 16 " +
                     "and t_action <> 2 " +
                     "and t_typeoper <> 38 " +
                     "and t_typeoper <> 39 " +
                     "and t_mode <> 2 " +
                     "and bitand (t_flags, 131072) = 0 " +
                  "order by t_numdaydoc desc) " +
           "where rownum = 1 ");
  cmd.addParam("referenc", RSDBP_IN, referenc);
  cmd.addParam("date", RSDBP_IN, StartDate);
  cmd.execute;

  rs = RsdRecordSet(cmd);
  if(rs.moveNext)
    sum_rest = rs.value("t_rest");    
  end;
  return sum_rest;
end;

macro Report_RUR_atAccount

  var cmd, rs;
  var cmd_new, rs_new;
  var save_account = "", cur_account;
  var save_code = 0, cur_code;
  var isHeaderPrint = false;
  var changeAccount = false;
  var sum_rest = 0;
  var account_after = "";
  var new_acc = false;
  var isOpen = true;

  var date_open:date, date_prol:date, date_end:date;
  var new_term = 0, term_after = 0;


  cmd = RsdCommand(
        "select depos.t_account, depos.t_open_close, depos.t_type_account, " +
               "depos.t_svodaccount as contractnumber, depdoc.t_iapplicationkind, depdoc.t_applicationkey, " +
               "depdoc.t_insum, depos.t_referenc, depos.t_code_currency, " +
               "depos.t_usealternate,  " +
//               "decode (to_char (ctr.t_opendate, 'dd.mm.yyyy'), '01.01.0001', '00.00.0000', to_char (ctr.t_opendate, 'dd.mm.yyyy')) open_date,  " +
//               "decode (to_char (depos.t_end_datedep, 'dd.mm.yyyy'), '01.01.0001', '00.00.0000', to_char (depos.t_end_datedep, 'dd.mm.yyyy')) end_datedep, " +
//               "decode (to_char (depos.t_prol_datedep, 'dd.mm.yyyy'), '01.01.0001', '00.00.0000', to_char (depos.t_prol_datedep, 'dd.mm.yyyy')) prol_datedep " +
               "ctr.t_opendate  open_date,  " +
               "depos.t_end_datedep  end_datedep, " +
               "depos.t_prol_datedep  prol_datedep, " +
               "replace (case persn.t_name1 when chr (1) then '' else persn.t_name1 end || ' ' || " +
                       "case persn.t_name2 when chr (1) then '' else persn.t_name2 end || ' ' || " +
                       "case persn.t_name3 when chr (1) then '' else persn.t_name3 end, '  ', '¤ ­­ë¥ ­¥ ­ ©¤¥­ë') fio " +
          "from ddepositr_dbt depos, " +
               "dsbdepdoc_dbt depdoc, " +
               "drt_contract_dbt ctr, " +
               "dpersn_dbt persn " +
         "where depos.t_iscur = ? " +
           "and depos.t_fncash = ? " +
           "and depos.t_referenc = depdoc.t_referenc " +
           "and depdoc.t_depdate_document = ? " +
//           "and depdoc.t_typeoper = 72 " +
           "and (depdoc.t_typeoper = 72 " +
             "or  (depdoc.t_typeoper = 35 " +
              "and depos.t_usealternate = 1 " +
              "and not exists " +
                     "(select 1 " +
                        "from dsbdepdoc_dbt " +
                       "where t_referenc = depdoc.t_referenc " +
                         "and t_typeoper = 72))) " +
           "and depdoc.t_typecomplexoper = 82 " +
           "and depdoc.t_kindop <> 8 " +
           "and depdoc.t_kindop <> 9 " +
           "and depdoc.t_kindop <> 14 " +
           "and depdoc.t_kindop <> 15 " +
           "and depdoc.t_kindop <> 16 " +
           "and depdoc.t_action <> 2 " +
           "and depdoc.t_typeoper <> 38 " +
           "and depdoc.t_typeoper <> 39 " +
           "and depdoc.t_mode <> 2 " +
           "and depdoc.t_flagstorn = chr (0) " +
           "and bitand (depdoc.t_flags, 131072) = 0 " +
           "and ctr.t_branch = depos.t_fncash " +
           "and ctr.t_number = depos.t_svodaccount " +
           "and ctr.t_type = 3 " +
           "and depos.t_codclient = persn.t_personid " +
        "order by depos.t_code_currency, depos.t_type_account " );
  cmd.addParam("FlagCur", RSDBP_IN, FlagCur);
  cmd.addParam("FNCash", RSDBP_IN, FNCash);
  cmd.addParam("date", RSDBP_IN, StartDate);
  cmd.NullConversion = true;
  cmd.execute;

  rs = RsdRecordSet(cmd);
  while(rs.moveNext)
    new_acc = false;
    cur_code = rs.value("t_code_currency");
    if(save_code != cur_code)
      if(isHeaderPrint)
        separate_end;
      end;
      isHeaderPrint = false;
      save_code = cur_code;
       
    end;

    if(not isHeaderPrint)
       print_Title(cur_code);
       isHeaderPrint = true; 
    end;

    cur_account = rs.value("t_type_account"); 
    if(save_account != cur_account)
      save_account = cur_account;
      separate_up;
      print_name_account(cur_account);
      changeAccount = true;
    end;

    if(changeAccount)
      separate_down;
      changeAccount = false;
    else
      separate_cross;
    end;

    sum_rest = find_rest(rs.value("t_referenc"));
    account_after = rs.value("t_account");
    date_open = rs.value("open_date");
    date_prol = rs.value("prol_datedep");
    date_end = rs.value("end_datedep");
    if (rs.value("t_open_close") == "X")
      isOpen = false;
    else
      isOpen = true;
    end;

    cmd_new = RsdCommand(
       "select depos.t_account, dep.t_insum, depos.t_end_datedep, depos.t_prol_datedep, dep.t_typeoper, " +
              "dep.t_typecomplexoper " +
         "from dsbdepdoc_dbt dep, ddepositr_dbt depos " +
        "where (dep.t_iapplicationkind, dep.t_applicationkey) in " +
                 "(select casln.t_applicationkind2, casln.t_applicationkey2 " +
                    "from dsb_casln_dbt casln " +
                   "where (casln.t_applicationkind1, casln.t_applicationkey1) in " +
                            "(select c.t_applicationkind1, c.t_applicationkey1 " +
                               "from dsb_casln_dbt c " +
                              "where (c.t_applicationkind2, " +
                                     "c.t_applicationkey2) = (select t_iapplicationkind, t_applicationkey " +
                                                               "from dsbdepdoc_dbt " +
                                                              "where t_referenc = ? " +
                                                                "and t_depdate_document = ? " +
                                                                "and t_typeoper in (65, 80) " +
                                                                "and t_typecomplexoper = 81 " +
                                                                "and t_insum = 0 " +
                                                                "and t_kindop <> 8 " +
                                                                "and t_kindop <> 9 " +
                                                                "and t_kindop <> 14 " +
                                                                "and t_kindop <> 15 " +
                                                                "and t_kindop <> 16 " +
                                                                "and t_action <> 2 " +
                                                                "and t_typeoper <> 38 " +
                                                                "and t_typeoper <> 39 " +
                                                                "and t_mode <> 2 " +
                                                                "and t_flagstorn = chr (0) " +
                                                                "and bitand ( " +
                                                                       "t_flags, 131072) = 0))) " +
          "and dep.t_typeoper in (51, 65, 80) " +
          "and dep.t_typecomplexoper = 81 " +
          "and dep.t_kindop <> 8 " +
          "and dep.t_kindop <> 9 " +
          "and dep.t_kindop <> 14 " +
          "and dep.t_kindop <> 15 " +
          "and dep.t_kindop <> 16 " +
          "and dep.t_action <> 2 " +
          "and dep.t_typeoper <> 38 " +
          "and dep.t_typeoper <> 39 " +
          "and dep.t_mode <> 2 " +
          "and bitand ( " +
                 "dep.t_flags, 131072) = 0 " +
          "and dep.t_flagstorn = chr (0) " +
          "and depos.t_referenc = dep.t_referenc " +
          "and depos.t_referenc <> ? ");
    cmd_new.addParam("referenc", RSDBP_IN, rs.value("t_referenc"));
    cmd_new.addParam("date", RSDBP_IN, StartDate);
    cmd_new.addParam("referenc_", RSDBP_IN, rs.value("t_referenc"));
    cmd_new.NullConversion = true;
    cmd_new.execute;

    rs_new = RsdRecordSet(cmd_new);
    if(rs_new.moveNext)
      account_after = rs_new.value("t_account");
      sum_rest = rs_new.value("t_insum");
      date_end = rs_new.value("t_end_datedep");
      new_acc = true;
    end;

    new_term = date_end - date_prol + 1; //println(date_end , "-", date_prol, "+", 1);
    term_after = date_end - date_open; //println(date_end, "-", date_open);

    if ((date_end == NULL_DATE) 
     or ((rs.value("t_usealternate") != 0) and (not new_acc))
     or (rs_new.value("t_typeoper") == 65)
     or (rs_new.value("t_typeoper") == 80)
       )
      new_term = 0;
      term_after = 0;
    end;


    print_report_str(
      rs.value("contractnumber"), 
      rs.value("fio"), 
      date_open, 
      rs.value("t_account"), 
      new_term,
      term_after,
      account_after, 
      rs.value("t_insum"),
      sum_rest,
      date_end); // sum_all

  end;

  if(isHeaderPrint) 
    separate_end;
  end;


OnError ( e )
  msgbox(e.Message);
end; // Report_RUR_atAccount


//-----------------------------------------------------------------------
macro Title_RUR

  [
           âç¥â ¯® ¯à®«®­£ æ¨¨ §  ¯¥à¨®¤ á ########## ¯® ##########

               +----------------+------------------------------+
               |   ‚¨¤ ¢ª« ¤    |      ‘ã¬¬   ¯à®«®­£ æ¨¨      |
               +----------------+------------------------------+
               |                |                              |
  ] ( StartDate:10, EndDate:10 );

end;

macro Report_RUR

  var Num = 1, Str = "";

  if (atAccount) 
    return Report_RUR_atAccount;
  end;

  /* ‚­¥è­¨© æ¨ª« ¯® ¢¨¤ ¬ ¢ª« ¤®¢ */
  Str = "T_FlagCur = 0 AND T_FormContr >= 20";
  dtyp.addFilter( Str );
  printTitle = TRUE;
  ClearRecord( dtyp );
  dtyp.rec.FlagCur   = 0;
  dtyp.rec.FormContr = 20;  /* „¥¯®§¨âë */
  recDTyp = getGE( dtyp );
  while ( recDTyp  AND
          ( dtyp.rec.FlagCur == 0 )  AND
          ( dtyp.rec.FormContr >= 20 ) )
    /* –¨ª« ¯® áç¥â ¬ ¤ ­­®£® ¢¨¤  ¢ª« ¤®¢ */
    dtypSum = $0;
    Str = "t.T_IsCur = 0" +
          " AND t.T_FNcash = " + String( Branch ) +
          " AND t.T_Open_Close = CHR(0)" +
          " AND t.T_Type_Account = " + GetSQLString( dtyp.rec.Kind );
    acc.addFilter( Str );
    ClearRecord( acc );
    acc.rec.IsCur         = 0;
    acc.rec.FNCash        = Branch;
    acc.rec.Open_Close    = StrFor(0);
    acc.rec.Type_Account  = dtyp.rec.Kind;
    acc.rec.Code_Currency = 0;
    acc.rec.Number        = 0;
    recAcc = getGE( acc );
    while ( recAcc  AND
            ( acc.rec.IsCur        == 0         )  AND
            ( acc.rec.FNCash       == Branch    )  AND
            ( acc.rec.Open_Close   == StrFor(0) )  AND
            ( acc.rec.Type_Account == dtyp.rec.Kind ) )
      Str = "‚¨¤ ¢ª« ¤  \"" + dtyp.rec.Kind + "\"" +
            " áç¥â " + Acc_Form(acc.rec.Account);
      Message( Str );
      /* –¨ª« ¯® ¤®ªã¬¥­â ¬ ¤ ­­®£® áç¥â  */
      Str = "t.T_Referenc = " + String( acc.rec.Referenc ) +
            " AND t.T_TypeOper = 72" +
            " AND t.T_DepDate_Document >= " + sqlDateToStr( StartDate ) +
            " AND t.T_DepDate_Document <= " + sqlDateToStr( EndDate )   +
            " AND t.T_TypeComplexOper = 82" +
            " and t.t_Mode != " + String(MODE_GZ);
      doc.addFilter( Str );
      ClearRecord( doc );
      doc.rec.Referenc         = acc.rec.Referenc;
      doc.rec.TypeOper         = 72;   /* ‡ ç¨á«¥­¨¥ %% */
      doc.rec.DepDate_Document = StartDate;
      recDoc = getGE( doc );
      while ( recDoc  AND
              ( doc.rec.Referenc         == acc.rec.Referenc )  AND
              ( doc.rec.TypeOper         == 72 )            AND
              ( doc.rec.DepDate_Document >= StartDate )     AND
              ( doc.rec.DepDate_Document <= EndDate ) )
        /*
        Str = "  " + String(Num:7) +
              ": ¢¨¤ ¢ª« ¤  \"" + dtyp.rec.Kind + "\"" +
              " áç¥â " + Acc_Form(acc.rec.Account);
        Message( Str );
        Num = Num + 1; */
        if ( doc.rec.TypeComplexOper == 82 )  /* à®«®­£ æ¨ï ¤¥¯®§¨â  */
          if ( printTitle )
            Title_RUR();
            printTitle = FALSE;
          end;
          dtypSum = dtypSum + doc.rec.InSum;
        end;
        recDoc = Next( doc );
      end;
      doc.dropFilter();
      recAcc = Next( acc );
    end;
    acc.dropFilter();
      if ( dtypSum != 0 )
        [            |  ############  |  ##########################  |
                     |                |                              |]
        ( dtyp.rec.Kind:12, dtypSum:26:2 );
      end;
    recDTyp = Next( dtyp );
  end;
  dtyp.dropFilter();

  if ( printTitle )
    println( "\n à®«®­£ æ¨ï ­¨ ¯® ª ª®¬ã ¢¨¤ã ¢ª« ¤  §  ¯¥à¨®¤" );
    println( "            á ", StartDate, " ¯® ", EndDate );
    println( "                 ­¥ ¢ë¯®«­ï« áì" );
  else
    [            +----------------+------------------------------+];
  end;
end; //Report_RUR



macro SetupPeriod
  record Period("REP_PROL") dialog;

  private const ne_atAccount = 0;
  private const ne_startDate = 1;
  private const ne_endDate   = 2; 

  private const K_ESC = 27, K_SPACE = 32, K_ENTER = 13, K_F7 = 321;
  private const SET_CHAR   = "X";
  private const UNSET_CHAR = "";

    private macro checkFields(dlg)
      var result = true;
      if(Period.atAccount == SET_CHAR)
        Period.EndDate = Period.StartDate;

        if(Period.StartDate == NULL_DATE)
          MsgBox("‡ ¤ ©â¥ ª®­ªà¥â­ãî ¤ âã, §  ª®â®àãî ¡ã¤¥â ¢ë¯ãé¥­ ®âç¥â.");
          SetFocus(Period, ne_startDate);
          result = false;
        end;
        DisableFields(Period, ne_endDate);
      else
        EnableFields(Period, ne_endDate);
      end;

      UpdateFields(dlg);
      return result;
    end;

    private macro space(dlg, id)
      if(id == ne_atAccount)
        if(Period.atAccount == SET_CHAR)
           Period.atAccount = UNSET_CHAR;
        else
           Period.atAccount = SET_CHAR;
        end;
      end;
      UpdateFields(dlg);
    end;


    private macro eventHandler(dlg, cmd, id, key)
      var stat = CM_DEFAULT;

      if(cmd == DLG_KEY)

        if(key == K_SPACE)
          space(dlg, id);
          checkFields(dlg);

        elif(key == K_ESC) 
          stat = CM_CANCEL;

        elif(key == K_F7) 
          if(checkFields(dlg))
            stat = CM_SAVE;
          end; 
        elif(key == K_ENTER) 
          if(id == ne_endDate)
            SetFocus(Period, ne_atAccount);
            stat = CM_IGNORE;
          end;
        end; // if(key == K_SPACE)

      elif ( cmd == DLG_REMFOCUS ) // if(cmd == DLG_KEY)
        if((id == ne_startDate) and (key != K_ESC))
          checkFields(dlg);
        end;
      end; //  if(cmd == DLG_KEY)

      return stat;
    end; // eventHandler

//  ç «® ä. SetupPeriod
  Period.atAccount = UNSET_CHAR;
  Period.StartDate = StartDate;
  Period.EndDate   = EndDate;
  if(RunDialog(Period, @eventHandler))
    atAccount = Period.atAccount;
    StartDate = Period.StartDate;
    EndDate   = Period.EndDate;
    if (EndDate == NULL_DATE)
      EndDate = date(31,12,9999);
    end;
    return TRUE;
  else
    return FALSE;
  end;
end; //SetupPeriod


  if ( SetupPeriod )
    Report_RUR();
  else
    Exit( 1 );
  end;

end;


