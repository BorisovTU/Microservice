/*
$Name:             getattach_fmreq.mac
$Module:           RS-Retail
$Description:      Предоставление информации по запросам ФСФМ РФ.
*/

import CommonInter, BankInter, PTInter, CTInter, rsd, oralib, likepy, globals;
import serviceaction;
import FMInter;
import fmreqi_lib;
import ic_comdata;
import getattach_fm_ex;

private file f_fmrequestinfo( fmrequestinfo ) key 0;
private file f_clientparty( party ) key 0;

private file f_pay_doc ( "pay_doc.dbt" ) key 2;
private record pay_np  ( "pay_doc.np" );
private record pay_n40 ( "pay_doc.n40" );

private record fmreqiattach( fmreqiattach );
private record fmrequestinfo( fmrequestinfo );
private record clientparty( party );

private var persn  = TBFile( "persn.dbt", "r" );
private var person = TBFile( "person.dbt", "r", 0 );

private var tcur = TBFile( "currency.dbt", "bank.def", "r", 0 );

private file ExtractXMLFile() txt write;

private var reestrBOO = TBFile ( "reestr_2.dbt", "R", 2, null, "sbbank.def" );

private var ExtractXMLFileName;

private var gSourceDprt = NumFNCash();

private var gBankName = "";
private var gBankBIC = "";

private var gPeriodDateBegin = Date(01,01,1901);
private var gPeriodDateEnd   = Date(31,12,2999);

private var gAccDprt  = -1;
private var gAccOpen  = Date(0,0,0);
private var gAccClose = Date(0,0,0);
private var gAccOpCl  = 0;

private var gStrListDP = "";

private var gClient;
private var gOKATO = -1;

private var gBank;

private var gBankInFlag = FALSE;
private var gBankInOKSM;
private var gBankInIndex;
private var gBankInOkato;
private var gBankInRegion;
private var gBankInPunct;
private var gBankInStreet;
private var gBankInHouse;
private var gBankInCorp;
private var gBankInOf;

private var gBankOutFlag = FALSE;
private var gBankOutOKSM;
private var gBankOutIndex;
private var gBankOutOkato;
private var gBankOutRegion;
private var gBankOutPunct;
private var gBankOutStreet;
private var gBankOutHouse;
private var gBankOutCorp;
private var gBankOutOf;

private var gRecipNameJur = "";
private var gRecipNamePh1 = "";
private var gRecipNamePh2 = "";
private var gRecipNamePh3 = "";
private var gRecipINN = "";
private var gRecipAcc = "";

private var gDateMake = "";
private var gTransState = "";

private var gNumRasp;
private var gDateRasp;
private var gElIdent;
private var gElGround;

private var gCurDate = Date(0,0,0);
private var gExcDate = Date(0,0,0);
private var gExcNumb = 1;

private var gRefUncalimed = -1;

private var gDetalItem;

private record attr( objattr );

private var AbsentFieldValuesArr = TArray;
private var listDP = TArray;
private var listID = TArray;

private const cMsgDate = "Неверно задан период вложения: дата начала больше даты окончания";
private const cMsgClnt = "Субъект не является владельцем вкладного счета";
private const cMsgDprt = "Вкладной счет не принадлежит описанному в параметрах подразделению";
private const cMsgOpen = "Вкладной счет не был открыт в заданном периоде";
private const cMsgNoAC = "Не задан ни счет, ни клиент";

///////////////////////////////////////////////////

private macro _GetBuffers( fmreqiattach )
  var stat = false;

  ClearRecord( f_fmrequestinfo );
  f_fmrequestinfo.ID = fmreqiattach.RequestInfoID; //15;//20;//19;//20;//22;//
  stat = GetEQ( f_fmrequestinfo );
  if ( stat )
    Copy( fmrequestinfo, f_fmrequestinfo );

    ClearRecord( f_clientparty );
    f_clientparty.PartyID = fmrequestinfo.ClientID;
    stat = GetEQ( f_clientparty );
    if ( stat )
      Copy( clientparty, f_clientparty );
    end;
  end;
  return stat;
end;

private macro _AddAbsentFieldValue( Field )
  var idx = AbsentFieldValuesArr.size;
  AbsentFieldValuesArr[idx] = Field;
end;

// Если ИНН == ИНН/КПП, то оставляем только ИНН.
private macro _getINN(INN)
   var ind_slash = Index(INN,"/");
   if ( ind_slash != 0 ) return SubStr(INN, 1, ind_slash-1); end;
   return INN;
end;

private macro _getKPP(INN)
   var ind_slash = Index(INN,"/");
   if ( ind_slash != 0 ) return SubStr(INN, ind_slash+1); end;
   return "";
end;

/////////////////////////////////////////////////
//            Служебная часть.
/////////////////////////////////////////////////

private macro _СлужЧасть_ВерсФорм()
  ExtractXMLFile.str = "<ВерсФорм>1.1</ВерсФорм>";
  insert(ExtractXMLFile);
end;

private macro _СлужЧасть_ВерсПрог()
  ExtractXMLFile.str = "<ВерсПрог>" + "RS-Bank " + _GetDBVersion() + "</ВерсПрог>";
  insert(ExtractXMLFile);
end;

private macro _СлужЧасть_ДатВып()
  ExtractXMLFile.str = "<ДатВып>" + _GetSchemaFormatDate(date) + "</ДатВып>";
  insert(ExtractXMLFile);
end;

private macro _СлужЧасть_ВремВып()
  ExtractXMLFile.str = "<ВремВып>" + _GetSchemaFormatTime(time) + "</ВремВып>";
  insert(ExtractXMLFile);
end;

private macro _СлужЧасть_НачДат()
  ExtractXMLFile.str = "<НачДат>" + _GetSchemaFormatDate(gPeriodDateBegin) + "</НачДат>";
  insert(ExtractXMLFile);
end;

private macro _СлужЧасть_КонечДат()
  ExtractXMLFile.str = "<КонечДат>" + _GetSchemaFormatDate(gPeriodDateEnd) + "</КонечДат>";
  insert(ExtractXMLFile);
end;

/*
private macro _СлужЧасть_НаимКО()
  if(fmrequestinfo.KGRKO_BankShortName == "")
    _AddAbsentFieldValue("Отсутствует наименование кредитной организации");
  else
    ExtractXMLFile.str = "<НаимКО>" + fmrequestinfo.KGRKO_BankShortName + "</НаимКО>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_РегНомКО()
  if(fmrequestinfo.KGRKO_BankNumber == "")
    _AddAbsentFieldValue("Отсутствует номер кредитной организации по КГРКО");
  else
    ExtractXMLFile.str = "<РегНомКО>" + fmrequestinfo.KGRKO_BankNumber + "</РегНомКО>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_НомФл()
  if(string(int(fmrequestinfo.KGRKO_BankDprt)) == "")
    _AddAbsentFieldValue("Отсутствует номер филиала кредитной организации по КГРКО");
  else
    ExtractXMLFile.str = "<НомФл>" + string(int(fmrequestinfo.KGRKO_BankDprt)) + "</НомФл>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_БИККО()
  if(fmrequestinfo.BIC == "")
    _AddAbsentFieldValue("Отсутствует БИК кредитной организации");
  else
    ExtractXMLFile.str = "<БИККО>" + fmrequestinfo.BIC + "</БИККО>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_ТипКлиент()
  if((fmrequestinfo.ClientType < 1) or (3 < fmrequestinfo.ClientType))
    _AddAbsentFieldValue("Не определён тип клиента");
  else
    ExtractXMLFile.str = "<ТипКлиент>" + fmrequestinfo.ClientType + "</ТипКлиент>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_ПризнРез()
  if(fmrequestinfo.ClientNotResident != "X")
    ExtractXMLFile.str = "<ПризнРез>1</ПризнРез>";
  else
    ExtractXMLFile.str = "<ПризнРез>2</ПризнРез>";
  end;
  insert(ExtractXMLFile);
end;
*/

private macro _СлужЧасть_ФИООтвСотрудн_Фам()
  if(fmrequestinfo.ProxyName1 == "")
    _AddAbsentFieldValue("Не указана фамилия уполномоченного лица");
  else
    ExtractXMLFile.str = "<Фам>" + fmrequestinfo.ProxyName1 + "</Фам>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_ФИООтвСотрудн_Имя()
  if(fmrequestinfo.ProxyName2 == "")
    _AddAbsentFieldValue("Не указано имя уполномоченного лица");
  else
    ExtractXMLFile.str = "<Имя>" + fmrequestinfo.ProxyName2 + "</Имя>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_ФИООтвСотрудн_Отч()
  if(fmrequestinfo.ProxyName3 != "")
    ExtractXMLFile.str = "<Отч>" + fmrequestinfo.ProxyName3 + "</Отч>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть_ФИООтвСотрудн()
  ExtractXMLFile.str = "<ФИООтвСотрудн>";
  insert(ExtractXMLFile);

  _СлужЧасть_ФИООтвСотрудн_Фам();
  _СлужЧасть_ФИООтвСотрудн_Имя();
  _СлужЧасть_ФИООтвСотрудн_Отч();

  ExtractXMLFile.str = "</ФИООтвСотрудн>";
  insert(ExtractXMLFile);
end;

private macro _СлужЧасть_ТелОтвСотрудн()
  if(fmrequestinfo.ProxyPhone != "")
    ExtractXMLFile.str = "<ТелОтвСотрудн>" + fmrequestinfo.ProxyPhone + "</ТелОтвСотрудн>";
    insert(ExtractXMLFile);
  end;
end;

private macro _СлужЧасть( fmreqiattach )
  ExtractXMLFile.str = "<СлужЧасть>";
  insert(ExtractXMLFile);

  _СлужЧасть_ВерсФорм();
  _СлужЧасть_ВерсПрог();
  _СлужЧасть_ДатВып();
  _СлужЧасть_ВремВып();

  _СлужЧасть_НачДат();
  _СлужЧасть_КонечДат();

/*
  _СлужЧасть_НаимКО();
  _СлужЧасть_РегНомКО();
  _СлужЧасть_НомФл();
  _СлужЧасть_БИККО();
  _СлужЧасть_ТипКлиент();
  _СлужЧасть_ПризнРез();
*/

  _СлужЧасть_ФИООтвСотрудн();
  _СлужЧасть_ТелОтвСотрудн();

  ExtractXMLFile.str = "</СлужЧасть>";
  insert(ExtractXMLFile);
end;

///////////////////////////////////////////////////////////

private macro _ФИОФЛ_Фам()
  if ( gClient.LastName == "" )
    _AddAbsentFieldValue("Неизвестна фамилия физического лица");
  else
    ExtractXMLFile.str = "<Фам>" + gClient.LastName + "</Фам>";
    insert(ExtractXMLFile);
  end;
end;

private macro _ФИОФЛ_Имя()
  if ( gClient.FirstName == "" )
    _AddAbsentFieldValue("Неизвестно имя физического лица");
  else
    ExtractXMLFile.str = "<Имя>" + gClient.FirstName + "</Имя>";
    insert(ExtractXMLFile);
  end;
end;

private macro _ФИОФЛ_Отч()
  if ( gClient.Patronymic != "" )
    ExtractXMLFile.str = "<Отч>" + gClient.Patronymic + "</Отч>";
    insert(ExtractXMLFile);
  end;
end;

private macro _ФИОФЛ()
  ExtractXMLFile.str = "<ФИОПлательщ>";
  insert(ExtractXMLFile);

  _ФИОФЛ_Фам();
  _ФИОФЛ_Имя();
  _ФИОФЛ_Отч();
  
  ExtractXMLFile.str = "</ФИОПлательщ>";
  insert(ExtractXMLFile);
end;

private macro _ИННФЛ()
  if ( gClient.Code(PTCK_INN) != "" )
    ExtractXMLFile.str = "<ИННПлательщ>" + gClient.Code(PTCK_INN) + "</ИННПлательщ>";
    insert(ExtractXMLFile);
  end;
end;

private macro _CodeOKCM( _Lat )
  var cmd, rs;
  var ret = _Lat;
  cmd = RsdCommand( "select C.T_CODENUM3 as cn from DCOUNTRY_DBT c where C.T_CODELAT3=?" );
  cmd.addParam( "code", RSDBP_IN );
  cmd.value( "code" ) = Trim( _Lat );
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    ret = rs.value( "cn" );
  end;
  return ret;
end;

private macro _АдресОКСМ( _Type )
  ExtractXMLFile.str = "<КодОКСМ>" + _CodeOKCM( gClient.Address(_Type).Country ) + "</КодОКСМ>";
  insert(ExtractXMLFile);
end;

private macro _АдресИндекс( _Type )
  ExtractXMLFile.str = "<Индекс>" + gClient.Address(_Type).PostIndex + "</Индекс>";
  insert(ExtractXMLFile);
end;

private macro _АдресОКАТО( _Type )
  if ( StrLen( gClient.Address(_Type).Okato ) > 1 )
    gOKATO = Int( SubStr( gClient.Address(_Type).Okato, 1, 2 ) );
  else
    gOKATO = -1;
  end;
  ExtractXMLFile.str = "<КодСубъектаПоОКАТО>" + SubStr( gClient.Address(_Type).Okato, 1, 2 ) + "</КодСубъектаПоОКАТО>";
  insert(ExtractXMLFile);
end;

private macro _АдресРегион( _Type )
  if ( ( gOKATO == 40 )  OR  ( gOKATO == 45 ) )
    ExtractXMLFile.str = "<Регион></Регион>";
  else
    ExtractXMLFile.str = "<Регион>" + gClient.Address(_Type).Region + " " + gClient.Address(_Type).CodeRegion + "</Регион>";
  end;
  insert(ExtractXMLFile);
end;

private macro _АдресПункт( _Type )
  var vDist;
  if ( ( StrLen( gClient.Address(_Type).District     ) < 1 )  AND
       ( StrLen( gClient.Address(_Type).CodeDistrict ) < 1 )  AND
       ( StrLen( gClient.Address(_Type).Place        ) < 1 )  AND
       ( StrLen( gClient.Address(_Type).CodePlace    ) < 1 ) )
    vDist = gClient.Address(_Type).Region + " " + 
            gClient.Address(_Type).CodeRegion;
  else
    vDist = gClient.Address(_Type).District     + " " + 
            gClient.Address(_Type).CodeDistrict + " " + 
            gClient.Address(_Type).Place        + " " + 
            gClient.Address(_Type).CodePlace;
  end;
  ExtractXMLFile.str = "<Пункт>" + vDist + "</Пункт>";
  insert(ExtractXMLFile);
end;

private macro _АдресУлица( _Type )
  ExtractXMLFile.str = "<Улица>" + gClient.Address(_Type).Street     + " " + 
                                   gClient.Address(_Type).CodeStreet + "</Улица>";
  insert(ExtractXMLFile);
end;

private macro _АдресДом( _Type )
  ExtractXMLFile.str = "<Дом>" + gClient.Address(_Type).House + "</Дом>";
  insert(ExtractXMLFile);
end;

private macro _АдресКорп( _Type )
  ExtractXMLFile.str = "<Корп>" + gClient.Address(_Type).NumCorps + "</Корп>";
  insert(ExtractXMLFile);
end;

private macro _АдресОф( _Type )
  ExtractXMLFile.str = "<Оф>" + gClient.Address(_Type).Flat + "</Оф>";
  insert(ExtractXMLFile);
end;

private macro _АдресТипФЛ( _Type )
  _АдресОКСМ  ( _Type );
  _АдресИндекс( _Type );
  _АдресОКАТО ( _Type );
  _АдресРегион( _Type );
  _АдресПункт ( _Type );
  _АдресУлица ( _Type );
  _АдресДом   ( _Type );
  _АдресКорп  ( _Type );
  _АдресОф    ( _Type );
end;

private macro _АдресФЛ()
  ExtractXMLFile.str = "<АдрПлательщ>";
  insert(ExtractXMLFile);
  if   ( StrLen( gClient.Address(1).Address ) > 0 )
    _АдресТипФЛ(1);
  elif ( StrLen( gClient.Address(2).Address ) > 0 )
    _АдресТипФЛ(2);
  elif ( StrLen( gClient.Address(3).Address ) > 0 )
    _АдресТипФЛ(3);
  end;
  ExtractXMLFile.str = "</АдрПлательщ>";
  insert(ExtractXMLFile);
end;

private macro _СведФЛ()
  ExtractXMLFile.str = "<СведФЛ>";
  insert(ExtractXMLFile);

  gClient = RsbParty( fmrequestinfo.ClientID );
  // gClient.LegalForm = 2;    // Вид (1-организация, 2-физ.лицо)  

  _ФИОФЛ();
  _ИННФЛ();
  _АдресФЛ();

  ExtractXMLFile.str = "</СведФЛ>";
  insert(ExtractXMLFile);
end;

///////////////////////////////////////////////////////////

private macro _CurrCode( _Curr )
  var cmd, rs;
  var ret = "";
  cmd = RsdCommand( "select C.T_EXTERNALCODE as ext " +
                    "FROM dcurrency_dbt c " +
                    "where C.T_CODE_CURRENCY = ?" );
  cmd.addParam( "code", RSDBP_IN );
  cmd.value( "code" ) = _Curr;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    ret = rs.value( "ext" );
    if ( ret == "810" )
      ret = "643";
    end;
  end;
  return ret;
end;

private macro _SumToRub( _curr, _branch, _date, _sum )
  var retSum = "";
  var rs;
  var dd, mm, yyyy;
  var vRub, vStr;
  if ( ( _curr > 0 )  AND  ( _date != Date(0,0,0) ) )
    DateSplit( _date, dd, mm, yyyy );
    vStr = String( "select RSU_RTLEXCH.ConvertSumToRub( ", _curr, ", ", _branch, ", ",
                   "TO_DATE('",dd:2," ",mm:2," ",yyyy:4,"','DD MM YYYY'), TO_DATE('01 01 0001 00:00:00','DD MM YYYY HH24:MI:SS'), 1, ", _sum, ", 1) from dual" );
    rs = RsdRecordset( vStr );
    if ( rs.moveNext() )
      vRub = Moneyl( rs.value(0) );
      if ( vRub != 0 )
        retSum = String( vRub:0:2 );
      end;
    end;
  end;
  return retSum;
end;

private macro _BankInfo( _Branch, _Curr )
  var vNatCurr;
  gDetalItem = TIncrementDetailsItem;
  if ( _Curr == 0 )
    vNatCurr = TRUE;
  else
    vNatCurr = FALSE;
  end;
  fill_BankInfo( _Branch, vNatCurr, gDetalItem );
end;

private macro _SetPhysFIO( _FIO )
  var sFIO = Trim( _FIO );
  var sFIO1;
  var i1 = Index( sFIO, " " ), i2;
  gRecipNamePh1 = "";
  gRecipNamePh2 = "";
  gRecipNamePh3 = "";
  if ( i1 > 0 )
    gRecipNamePh1 = SubStr( sFIO, 1, i1-1 );
    sFIO1 = SubStr( sFIO, i1+1 );
    i2 = Index( sFIO1, " " );
    if ( i2 > 0 )
      gRecipNamePh2 = SubStr( sFIO1, 1, i2-1 );
      gRecipNamePh3 = SubStr( sFIO1, i2+1 );
    else
      gRecipNamePh2 = sFIO1;
    end;
  else
    gRecipNamePh1 = sFIO;
  end;
end;

private macro _Trans_XML( _Sum, _Grnd, _Type, _Rasp, _Num, _Date, _Curr, _Branch, _BankBIC )
  var vSumRub = _SumToRub( _Curr, _Branch, _Date, _Sum );
  var vBankCode, vBankBic;
  _BankInfo( _Branch, _Curr );
  ExtractXMLFile.str = "<РаспПлательщ>";
  insert(ExtractXMLFile);

  ExtractXMLFile.str = "<ТипОператор>" + String( _Type ) + "</ТипОператор>";
  insert(ExtractXMLFile);
  if ( StrLen( _Rasp ) > 0 )
    ExtractXMLFile.str = "<НаимРасп>" + _Rasp + "</НаимРасп>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( _Num ) > 0 )
    ExtractXMLFile.str = "<НомРасп>" + _Num + "</НомРасп>";
    insert(ExtractXMLFile);
  end;
  if ( _Date != Date(0,0,0) )
    ExtractXMLFile.str = "<ДатРасп>" + _GetSchemaFormatDate( _Date ) + "</ДатРасп>";
    insert(ExtractXMLFile);
  end;
  ExtractXMLFile.str = "<НомОпер></НомОпер>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КодВалют>" + _CurrCode( _Curr ) + "</КодВалют>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<СумПеревод>" + String( _Sum:0:2 ) + "</СумПеревод>";
  insert(ExtractXMLFile);
  if ( StrLen( vSumRub ) > 0 )
    ExtractXMLFile.str = "<СумПереводРуб>" + vSumRub + "</СумПереводРуб>";
    insert(ExtractXMLFile);
  end;
  if ( _Date == Date(0,0,0) )
    vBankCode = "";
  else
    vBankCode = gDetalItem.BankCode;
  end;
  ExtractXMLFile.str = "<БИКБанкПлательщ>" + vBankCode + "</БИКБанкПлательщ>";
  insert(ExtractXMLFile);

  // Адрес приема
  if ( gBankInFlag )
    ExtractXMLFile.str = "<АдрПрием>";
    insert(ExtractXMLFile);

    ExtractXMLFile.str = "<КодОКСМ>"            + gBankInOKSM   + "</КодОКСМ>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Индекс>"             + gBankInIndex  + "</Индекс>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<КодСубъектаПоОКАТО>" + gBankInOkato  + "</КодСубъектаПоОКАТО>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Регион>"             + gBankInRegion + "</Регион>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Пункт>"              + gBankInPunct  + "</Пункт>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Улица>"              + gBankInStreet + "</Улица>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Дом>"                + gBankInHouse  + "</Дом>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Корп>"               + gBankInCorp   + "</Корп>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Оф>"                 + gBankInOf     + "</Оф>";
    insert(ExtractXMLFile);

    ExtractXMLFile.str = "</АдрПрием>";
    insert(ExtractXMLFile);
  end;

  // Адрес выдачи
  if ( gBankOutFlag )
    ExtractXMLFile.str = "<АдрВыдачи>";
    insert(ExtractXMLFile);

    ExtractXMLFile.str = "<КодОКСМ>"            + gBankOutOKSM   + "</КодОКСМ>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Индекс>"             + gBankOutIndex  + "</Индекс>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<КодСубъектаПоОКАТО>" + gBankOutOkato  + "</КодСубъектаПоОКАТО>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Регион>"             + gBankOutRegion + "</Регион>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Пункт>"              + gBankOutPunct  + "</Пункт>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Улица>"              + gBankOutStreet + "</Улица>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Дом>"                + gBankOutHouse  + "</Дом>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Корп>"               + gBankOutCorp   + "</Корп>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<Оф>"                 + gBankOutOf     + "</Оф>";
    insert(ExtractXMLFile);

    ExtractXMLFile.str = "</АдрВыдачи>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( _BankBIC ) > 0 )
    if   ( _BankBIC == "Э" )
      vBankBic = "";
    elif ( _BankBIC == "Ю" )
      vBankBic = gDetalItem.BankCode;
    else
      vBankBic = _BankBIC;
    end;
    ExtractXMLFile.str = "<БИКБанкПолуч>" + vBankBic + "</БИКБанкПолуч>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( gRecipNameJur ) > 0 )
    ExtractXMLFile.str = "<НаимПолучЮЛ>" + gRecipNameJur + "</НаимПолучЮЛ>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( gRecipNamePh1 ) > 0 )
    ExtractXMLFile.str = "<НаимПолучФЛ>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<ФАМ>" + gRecipNamePh1 + "</ФАМ>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<ИМЯ>" + gRecipNamePh2 + "</ИМЯ>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "<ОТЧ>" + gRecipNamePh3 + "</ОТЧ>";
    insert(ExtractXMLFile);
    ExtractXMLFile.str = "</НаимПолучФЛ>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( gRecipINN ) > 0 )
    ExtractXMLFile.str = "<ИННПолуч>" + gRecipINN + "</ИННПолуч>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( gRecipAcc ) > 0 )
    ExtractXMLFile.str = "<СчПолучат>" + gRecipAcc + "</СчПолучат>";
    insert(ExtractXMLFile);
  end;
  ExtractXMLFile.str = "<НазначПлатеж>" + _Grnd + "</НазначПлатеж>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<ДатИсполн>" + gDateMake + "</ДатИсполн>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<СтатусПеревод>" + gTransState + "</СтатусПеревод>";
  insert(ExtractXMLFile);

  ExtractXMLFile.str = "</РаспПлательщ>";
  insert(ExtractXMLFile);
end;

private macro _TransData_Num( _ApplKey )
  var cmd, rs;
  var ret = "";
  cmd = RsdCommand( "select RD.T_DOCUMENTNUMBER as docnum " +
                    "from drtdocument_dbt rd " +
                    "where RD.T_OPAPPLICATIONKEY = ?" );
  cmd.addParam( "key", RSDBP_IN );
  cmd.value( "key" ) = _ApplKey;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    ret = rs.value( "docnum" );
  end;
  return ret;
end;

//----------------------------------------------------------------------------------------

private macro _AddressRecPartyIn( _Party )
  var vAddrType = 1;
  gBankInFlag = TRUE;
  if ( _Party > 0 )
    gBank = RsbParty( _Party );

    if   ( StrLen( gBank.Address(1).Address ) > 0 )
      vAddrType = 1;
    elif ( StrLen( gBank.Address(2).Address ) > 0 )
      vAddrType = 2;
    elif ( StrLen( gBank.Address(3).Address ) > 0 )
      vAddrType = 3;
    end;

    gBankInOKSM   = _CodeOKCM( gBank.Address(vAddrType).Country );
    gBankInIndex  = "";
    gBankInOkato  = "";
    gBankInRegion = "";
    if ( ( StrLen( gBank.Address(vAddrType).District     ) < 1 )  AND
         ( StrLen( gBank.Address(vAddrType).CodeDistrict ) < 1 )  AND
         ( StrLen( gBank.Address(vAddrType).Place        ) < 1 )  AND
         ( StrLen( gBank.Address(vAddrType).CodePlace    ) < 1 ) )
      gBankInPunct = gBank.Address(vAddrType).Region + " " + 
                     gBank.Address(vAddrType).CodeRegion;
    else
      gBankInPunct = gBank.Address(vAddrType).District     + " " + 
                     gBank.Address(vAddrType).CodeDistrict + " " + 
                     gBank.Address(vAddrType).Place        + " " + 
                     gBank.Address(vAddrType).CodePlace;
    end;
    gBankInStreet = "";
    gBankInHouse  = "";
    gBankInCorp   = "";
    gBankInOf     = "";
  else
    gBankInOKSM   = "";
    gBankInIndex  = "";
    gBankInOkato  = "";
    gBankInRegion = "";
    gBankInPunct  = "";
    gBankInStreet = "";
    gBankInHouse  = "";
    gBankInCorp   = "";
    gBankInOf     = "";
  end;
end;

private macro _AddressRecIn( _Branch )
  var ddep =  TRecHandler( "i_dp_dep.rec" );
  var party = TRecHandler( "i_party.rec" );
  if ( findDepartment( _Branch, NULL, ddep, party ) )
    _AddressRecPartyIn( party.rec.partyID );
  else
    gBankInFlag = FALSE;
  end;
end;

private macro _AddressRecContactPunctIn( _Point )
  var cmd, rs;
  var vPunct = "";
  cmd = RsdCommand( "SELECT CIT.T_CITY as city " +
                    "FROM DCNG_CITY_DBT CIT " +
                    "WHERE CIT.T_ID = ( SELECT BAN.T_CITY_ID FROM DCNG_BANKS_DBT BAN WHERE BAN.T_PP_CODE = ?)" );
  cmd.addParam( "code", RSDBP_IN );
  cmd.value( "code" ) = Trim( _Point );
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    vPunct = rs.value( "city" ) + " Г";
  end;
  return vPunct;
end;

private macro _AddressRecContactIn( _Point )
  var cmd, rs;
  cmd = RsdCommand( "SELECT CON1.T_CODENUM3 as n " +
                    "from DCOUNTRY_DBT CON1 " +
                    "where CON1.T_CODELAT2 = ( SELECT CON.T_CODE FROM DCNG_COUNTRY_DBT CON, DCNG_CITY_DBT CIT " +
                    "WHERE CON.T_ID=CIT.T_COUNTRY AND CIT.T_ID = (SELECT BAN.T_CITY_ID FROM DCNG_BANKS_DBT BAN WHERE BAN.T_PP_CODE = ?))" );
  cmd.addParam( "code", RSDBP_IN );
  cmd.value( "code" ) = Trim( _Point );
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    gBankInFlag = TRUE;
    gBankInOKSM   = rs.value( "n" );
    gBankInIndex  = "";
    gBankInOkato  = "";
    gBankInRegion = "";
    gBankInPunct  = _AddressRecContactPunctIn( _Point );
    gBankInStreet = "";
    gBankInHouse  = "";
    gBankInCorp   = "";
    gBankInOf     = "";
  else
    gBankInFlag = FALSE;
  end;
end;

private macro _AddressRecContactIn_CC( _Country, _Place )
  if ( ( StrLen( _Country ) > 1 )  OR  ( StrLen( _Place ) > 1 ) )
    if ( StrLen( _Country ) < 2 )
      _Country = "";
    end;
    if ( StrLen( _Place ) < 2 )
      _Place = "";
    end;
    gBankInFlag = TRUE;
    gBankInOKSM   = _CodeOKCM( _Country );
    gBankInIndex  = "";
    gBankInOkato  = "";
    gBankInRegion = "";
    gBankInPunct  = _Place;
    gBankInStreet = "";
    gBankInHouse  = "";
    gBankInCorp   = "";
    gBankInOf     = "";
  else
    gBankInFlag = FALSE;
  end;
end;

//----------------------------------------------------------------------------------------

private macro _AddressRecPartyOut( _Party )
  var vAddrType = 1;
  gBankOutFlag = TRUE;
  if ( _Party > 0 )
    gBank = RsbParty( _Party );

    if   ( StrLen( gBank.Address(1).Address ) > 0 )
      vAddrType = 1;
    elif ( StrLen( gBank.Address(2).Address ) > 0 )
      vAddrType = 2;
    elif ( StrLen( gBank.Address(3).Address ) > 0 )
      vAddrType = 3;
    end;

    gBankOutOKSM   = _CodeOKCM( gBank.Address(vAddrType).Country );
    gBankOutIndex  = "";
    gBankOutOkato  = "";
    gBankOutRegion = "";
    if ( ( StrLen( gBank.Address(vAddrType).District     ) < 1 )  AND
         ( StrLen( gBank.Address(vAddrType).CodeDistrict ) < 1 )  AND
         ( StrLen( gBank.Address(vAddrType).Place        ) < 1 )  AND
         ( StrLen( gBank.Address(vAddrType).CodePlace    ) < 1 ) )
      gBankOutPunct = gBank.Address(vAddrType).Region + " " + 
                      gBank.Address(vAddrType).CodeRegion;
    else
      gBankOutPunct = gBank.Address(vAddrType).District     + " " + 
                      gBank.Address(vAddrType).CodeDistrict + " " + 
                      gBank.Address(vAddrType).Place        + " " + 
                      gBank.Address(vAddrType).CodePlace;
    end;
    gBankOutStreet = "";
    gBankOutHouse  = "";
    gBankOutCorp   = "";
    gBankOutOf     = "";
  else
    gBankOutOKSM   = "";
    gBankOutIndex  = "";
    gBankOutOkato  = "";
    gBankOutRegion = "";
    gBankOutPunct  = "";
    gBankOutStreet = "";
    gBankOutHouse  = "";
    gBankOutCorp   = "";
    gBankOutOf     = "";
  end;
end;

private macro _AddressRecOut( _Branch )
  var ddep =  TRecHandler( "i_dp_dep.rec" );
  var party = TRecHandler( "i_party.rec" );
  if ( findDepartment( _Branch, NULL, ddep, party ) )
    _AddressRecPartyOut( party.rec.partyID );
  else
    gBankOutFlag = FALSE;
  end;
end;

private macro _AddressRecContactPunctOut( _Point )
  var cmd, rs;
  var vPunct = "";
  cmd = RsdCommand( "SELECT CIT.T_CITY as city " + 
                    "FROM DCNG_CITY_DBT CIT " +
                    "WHERE CIT.T_ID = ( SELECT BAN.T_CITY_ID FROM DCNG_BANKS_DBT BAN WHERE BAN.T_PP_CODE = ?)" );
  cmd.addParam( "code", RSDBP_IN );
  cmd.value( "code" ) = Trim( _Point );
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    vPunct = rs.value( "city" ) + " Г";
  end;
  return vPunct;
end;

private macro _AddressRecContactOut( _Point )
  var cmd, rs;
  cmd = RsdCommand( "SELECT CON1.T_CODENUM3 as n " +
                    "from DCOUNTRY_DBT CON1 " +
                    "where CON1.T_CODELAT2 = ( SELECT CON.T_CODE FROM DCNG_COUNTRY_DBT CON, DCNG_CITY_DBT CIT " +
                    "WHERE CON.T_ID=CIT.T_COUNTRY AND CIT.T_ID = (SELECT BAN.T_CITY_ID FROM DCNG_BANKS_DBT BAN WHERE BAN.T_PP_CODE = ?))" );
  cmd.addParam( "code", RSDBP_IN );
  cmd.value( "code" ) = Trim( _Point );
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    gBankOutFlag = TRUE;
    gBankOutOKSM   = rs.value( "n" );
    gBankOutIndex  = "";
    gBankOutOkato  = "";
    gBankOutRegion = "";
    gBankOutPunct  = _AddressRecContactPunctOut( _Point );
    gBankOutStreet = "";
    gBankOutHouse  = "";
    gBankOutCorp   = "";
    gBankOutOf     = "";
  else
    gBankOutFlag = FALSE;
  end;
end;

private macro _AddressRecContactOut_CC( _Country, _Place )
  if ( ( StrLen( _Country ) > 1 )  OR  ( StrLen( _Place ) > 1 ) )
    if ( StrLen( _Country ) < 2 )
      _Country = "";
    end;
    if ( StrLen( _Place ) < 2 )
      _Place = "";
    end;
    gBankOutFlag = TRUE;
    gBankOutOKSM   = _CodeOKCM( _Country );
    gBankOutIndex  = "";
    gBankOutOkato  = "";
    gBankOutRegion = "";
    gBankOutPunct  = _Place;
    gBankOutStreet = "";
    gBankOutHouse  = "";
    gBankOutCorp   = "";
    gBankOutOf     = "";
  else
    gBankOutFlag = FALSE;
  end;
end;

private macro _AddressRecOut4042( _ApplKind, _ApplKey, _NumOp )
  var cmd, rs;
  var vBankID, vErr;
  var retBankBic = "";
  gRecipNameJur = "";
  gRecipNamePh1 = "";
  gRecipINN = "";
  cmd = RsdCommand( "select RPP.T_BANKCODEKIND as kind, RPP.T_BANKCODE as code, RPP.T_ACCOUNT as acc, RPP.T_NAME as name " +
                    "from drtpaymentprop_dbt rpp " +
                    "where RPP.T_DOCAPPLICATIONKIND = ? AND RPP.T_DOCAPPLICATIONKEY = ?" );
  cmd.addParam( "i", RSDBP_IN );
  cmd.addParam( "e", RSDBP_IN );
  cmd.value( "i" ) = _ApplKind;
  cmd.value( "e" ) = _ApplKey;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    if ( StrLen( String( rs.value( "acc" ) ) ) > 1 )
      gRecipAcc = String( rs.value( "acc" ) );
    else
      gRecipAcc = "";
    end;
    if ( _NumOp == 42 )
      if ( StrLen( gRecipAcc ) > 4 )
        if ( ( SubStr( gRecipAcc, 1, 3 ) != "423" )  AND  ( SubStr( gRecipAcc, 1, 3 ) != "426" )  AND  ( SubStr( gRecipAcc, 1, 5 ) != "40817" )  AND  ( SubStr( gRecipAcc, 1, 5 ) != "40820" ) )
          if ( StrLen( String( rs.value( "name" ) ) ) > 1 )
            gRecipNameJur = String( rs.value( "name" ) );
          end;
        end;
        if ( (  StrLen( gRecipAcc ) < 2 )  OR  ( SubStr( gRecipAcc, 1, 3 ) == "423" )  OR  ( SubStr( gRecipAcc, 1, 3 ) == "426" )  OR  ( SubStr( gRecipAcc, 1, 5 ) == "40817" )  OR  ( SubStr( gRecipAcc, 1, 5 ) == "40820" ) )
          if ( StrLen( String( rs.value( "name" ) ) ) > 1 )
            _SetPhysFIO( String( rs.value( "name" ) ) );
          end;
        end;
      end;
    end;
    if ( Int( rs.value( "kind" ) ) == 3 )
      retBankBic = String( rs.value( "code" ) );
    end;
    vBankID = ПолучитьКодСубъекта( rs.value( "code" ), rs.value( "kind" ), vErr );
    if ( NOT vErr )
      _AddressRecPartyOut( vBankID );
    end;
  end;
  return retBankBic;
end;

//----------------------------------------------------------------------------------------

private macro _makeListDP( _SourceDprt, _ChildDprtInc )
  var dpDepList = TdpDepList;
  var vStr = "(";
  var i = 0;
  listDP.Size() = 0;
  dpDepList.SetFilter( dpDepList.getFilialID( _SourceDprt ) );
  while ( dpDepList.next() )
    if ( dpDepList.rec.Code == _SourceDprt )  // Текущее подразделение всегда включаем в список подразделений для выписки.
      listDP[i] = dpDepList.rec.Code;
      listID[i] = dpDepList.rec.PartyID;
      if ( i > 0 )
        vStr = vStr + ",";
      end;
      vStr = vStr + String( dpDepList.rec.Code );
      i = i + 1;
    else
      if ( _ChildDprtInc )
        listDP[i] = dpDepList.rec.Code;
        listID[i] = dpDepList.rec.PartyID;
        if ( i > 0 )
          vStr = vStr + ",";
        end;
        vStr = vStr + String( dpDepList.rec.Code );
        i = i + 1;
      else
        if ( dpDepList.rec.NodeType != 1 )  // Не филиал
          listDP[i] = dpDepList.rec.Code;
          listID[i] = dpDepList.rec.PartyID;
          if ( i > 0 )
            vStr = vStr + ",";
          end;
          vStr = vStr + String( dpDepList.rec.Code );
          i = i + 1;
        end;
      end;
    end;
  end;
  vStr = vStr + ")";
  gStrListDP = vStr;
end;

//----------------------------------------------------------------------------------------

private macro _TransData1_RecipNamePh( _id )
  var vClient = RsbParty( _id );
  gRecipNamePh1 = gClient.LastName;
  gRecipNamePh2 = gClient.FirstName;
  gRecipNamePh3 = gClient.Patronymic;
end;

private macro _TransData1_INN( _id )
  var vClient = RsbParty( _id );
  gRecipINN = gClient.Code( PTCK_INN );
end;

private macro _TransData1_DateMake( _id )
  var cmd, rs;
  gDateMake = "";
  cmd = RsdCommand( "SELECT RO.T_OPDATE as od " +
                    "FROM DRMTO_op_DBT RO " +
                    "WHERE RO.T_TRANSID = ? " +
                      "AND RO.T_OPNUM = 2" );
  cmd.addParam( "id", RSDBP_IN );
  cmd.value( "id" ) = _id;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    if ( Date( rs.value( "od" ) ) != Date(0,0,0) )
      gDateMake = _GetSchemaFormatDate( Date( rs.value( "od" ) ) );
    end;
  end;
end;

private macro _TransData1_Status( _state, _psid )
  var cmd, rs;
  gTransState = "Не выплачен";
  cmd = RsdCommand( "SELECT RS.T_STATENAME as st " +
                    "FROM DRMTR_state_dbt RS " +
                    "WHERE RS.T_STATECODE = ? " +
                      "AND RS.T_PSID = ?" );
  cmd.addParam( "s", RSDBP_IN );
  cmd.addParam( "p", RSDBP_IN );
  cmd.value( "s" ) = _state;
  cmd.value( "p" ) = _psid;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    if ( (  StrLen( String( rs.value( "st" ) ) ) > 1 )  AND  ( StrLwr( String( rs.value( "st" ) ) ) == "выплачен" ) )
      gTransState = "Выплачен";
    end;
  end;
end;

private macro _TransData1()
  var vSum, vGrnd, vType, vRasp, vNum, vDate, vBranch, vBankBIC;
  var cmd, rs;
  cmd = RsdCommand( "SELECT RMTO.T_SUM as sum, RMTO.T_RECADDINFO as ground, RMTO.T_OURFLAG as our, RMTO.T_TRANSCODE as trans, RMTO.T_SENDDATE as send, RMTO.T_CURCODE as curr, RMTO.T_BRANCH as brnch, " +
                           "RMTO.T_RECNPFLAG as np, RMTO.T_PSID as psid, RMTO.T_SENDPOINTCODE as spnt, RMTO.T_RECEIVEPOINTCODE as rpnt, RMTO.T_RECPROPERTIES as rprop, RMTO.T_RECPARTYID as rpid, " +
                           "RMTO.T_RECNAME1 as f, RMTO.T_RECNAME1 as n, RMTO.T_RECNAME1 as p, RMTO.T_RECACCOUNT as racc, RMTO.T_TRANSID as id, RMTO.T_STATE as st, " +
                           "RMTO.T_RECCOUNTRY as rcntr, RMTO.T_RECPLACE as rplc, RMTO.T_SENDERCOUNTRY as scntr, RMTO.T_SENDERPLACE as splc " +
                    "FROM DRMTO_trans_dbt RMTO " +
                    "WHERE RMTO.T_SENDDATE BETWEEN ? AND ? " +
                      "AND RMTO.T_SENDERPARTYID = ? " +
                      "AND RMTO.T_BRANCH IN " + gStrListDP +
                      "AND RMTO.T_ACTION NOT IN (2, 11) " +
                      "ORDER BY RMTO.T_TRANSID" );

  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );

  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    vSum  = rs.value( "sum" );
    vGrnd = rs.value( "ground" );
    if ( StrLen( vGrnd ) < 2 )
      vGrnd = " ";
    end;
    vBranch = Int( rs.value( "brnch" ) );
    if ( rs.value( "our" ) == 1 )
      vType = 1;
      vRasp = "Заявление на денежный перевод";
      vNum = rs.value( "trans" );
      vDate = Date( rs.value( "send" ) );
      if ( rs.value( "np" ) == 1 )
        gBankInFlag = FALSE;
      else
        _AddressRecIn( vBranch );
      end;
      if ( StrLen( String( rs.value( "rpnt" ) ) ) > 1 )
        _AddressRecContactOut( rs.value( "rpnt" ) );
      else
        _AddressRecContactOut_CC( String( rs.value( "rcntr" ) ), String( rs.value( "rplc" ) ) );
      end;
      vBankBIC = "Э";
      if ( Date( rs.value( "send" ) ) != Date(0,0,0) )
        gDateMake = _GetSchemaFormatDate( Date( rs.value( "send" ) ) );
      else
        gDateMake = "";
      end;
    else
      vType = 2;
      vRasp = "";
      vNum = "";
      vDate = Date(0,0,0);
      if ( StrLen( String( rs.value( "spnt" ) ) ) > 1 )
        _AddressRecContactIn( rs.value( "spnt" ) );
      else
        _AddressRecContactIn_CC( String( rs.value( "scntr" ) ), String( rs.value( "splc" ) ) );
      end;
      _AddressRecOut( vBranch );
      vBankBIC = "Ю";
      _TransData1_DateMake( Int( rs.value( "id" ) ) );
    end;
    gRecipNamePh1 = "";
    if   ( rs.value( "np" ) == 0 )
      if ( StrLen( String( rs.value( "rprop" ) ) ) > 249 )
        gRecipNameJur = SubStr( String( rs.value( "rprop" ) ), 1, 249 );
      else
        if (  StrLen( String( rs.value( "rprop" ) ) ) > 1 )
          gRecipNameJur = String( rs.value( "rprop" ) );
        else
          gRecipNameJur = "";
        end;
      end;
    elif ( rs.value( "np" ) == 1 )
      gRecipNameJur = "";
      if ( Int( rs.value( "rpid" ) ) > 0 )
        _TransData1_RecipNamePh( Int( rs.value( "rpid" ) ) );
      else
        gRecipNamePh1 = String( rs.value( "f" ) );
        gRecipNamePh2 = String( rs.value( "n" ) );
        gRecipNamePh3 = String( rs.value( "p" ) );
      end;
    else
      gRecipNameJur = "";
    end;
    if ( Int( rs.value( "rpid" ) ) > 0 )
      _TransData1_INN( Int( rs.value( "rpid" ) ) );
    else
      gRecipINN = "";
    end;
    if ( StrLen( String( rs.value( "racc" ) ) ) > 1 )
      gRecipAcc = String( rs.value( "racc" ) );
    else
      gRecipAcc = "";
    end;
    _TransData1_Status( rs.value( "st" ), rs.value( "psid" ) );
    _Trans_XML( vSum, vGrnd, vType, vRasp, vNum, vDate, Int( rs.value( "curr" ) ), vBranch, vBankBIC );
  end;
  //return vClient;
end;

//----------------------------------------------------------------------------------------

private macro _TransData2_n40( _ApplKind, _ApplKey )
  ReWind( f_pay_doc );
  ClearRecord( f_pay_doc );
  f_pay_doc.iApplicationKind = _ApplKind;
  f_pay_doc.ApplicationKey   = _ApplKey;
  if ( getEQ( f_pay_doc ) )
    SetRecordAddr( pay_n40, f_pay_doc, 0, 0, TRUE );
    gRecipNamePh1 = pay_n40.FNameRecp;
    gRecipNamePh2 = pay_n40.NameRecp;
    gRecipNamePh3 = pay_n40.SNameRecp;
  end;
end;

private macro _TransData2()
  var vSum, vGrnd, vBranch, vBankBIC;
  var cmd, rs;
  cmd = RsdCommand( "SELECT PD.T_INSUM as sum, PD.T_GROUND as ground, PD.T_IAPPLICATIONKIND as applkind, PD.T_APPLICATIONKEY as applkey, PD.T_DATE_DOCUMENT as docdate, PD.T_CODCUR as curr, PD.T_FNCASH as brnch " +
                    "FROM DPAY_DOC_DBT PD " +
                    "WHERE PD.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                      "AND PD.T_CODCLIENT = ? " +
                      "AND PD.T_FNCASH IN " + gStrListDP +
                      "AND PD.T_ACTION NOT IN (2, 11) " +
                      "AND PD.T_NUMOPERT=40 " +
                      "AND PD.T_GROUPOPERT=11 " +
                      "ORDER BY PD.T_CODCUR, PD.T_DATE_DOCUMENT, PD.T_APPLICATIONKEY" );

  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );

  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    vSum  = rs.value( "sum" );
    vGrnd = rs.value( "ground" );
    if ( StrLen( vGrnd ) < 2 )
      vGrnd = " ";
    end;
    vBranch = Int( rs.value( "brnch" ) );
    _AddressRecIn( vBranch );
    vBankBIC = _AddressRecOut4042( rs.value( "applkind" ), rs.value( "applkey" ), 40 );
    gRecipINN = "";
    if ( Date( rs.value( "docdate" ) ) != Date(0,0,0) )
      gDateMake = _GetSchemaFormatDate( Date( rs.value( "docdate" ) ) );
    else
      gDateMake = "";
    end;
    gTransState = "";
    _TransData2_n40( rs.value( "applkind" ), rs.value( "applkey" ) );
    _Trans_XML( vSum, vGrnd, 1, "Приходный кассовый ордер", _TransData_Num( rs.value( "applkey" ) ), Date( rs.value( "docdate" ) ), Int( rs.value( "curr" ) ), vBranch, vBankBIC );
  end;
  //return vClient;
end;

//----------------------------------------------------------------------------------------

private macro _TransData3()
  var vSum, vGrnd, vBranch, vBankBIC;
  var cmd, rs;
  cmd = RsdCommand( "SELECT PD.T_INSUM as sum, PD.T_GROUND as ground, PD.T_IAPPLICATIONKIND as applkind, PD.T_APPLICATIONKEY as applkey, PD.T_DATE_DOCUMENT as docdate, PD.T_CODCUR as curr, PD.T_FNCASH as brnch " +
                    "FROM DPAY_DOC_DBT PD " +
                    "WHERE PD.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                      "AND PD.T_CODCLIENT = ? " +
                      "AND PD.T_FNCASH IN " + gStrListDP + 
                      "AND PD.T_ACTION NOT IN (2, 11) " +
                      "AND PD.T_NUMOPERT=42 " +
                      "AND PD.T_GROUPOPERT=11 " +
                      "ORDER BY PD.T_CODCUR, PD.T_DATE_DOCUMENT, PD.T_APPLICATIONKEY" );

  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );

  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    vSum  = rs.value( "sum" );
    vGrnd = rs.value( "ground" );
    if ( StrLen( vGrnd ) < 2 )
      vGrnd = " ";
    end;
    vBranch = Int( rs.value( "brnch" ) );
    _AddressRecIn( vBranch );
    vBankBIC = _AddressRecOut4042( rs.value( "applkind" ), rs.value( "applkey" ), 42 );
    gRecipINN = "";
    if ( Date( rs.value( "docdate" ) ) != Date(0,0,0) )
      gDateMake = _GetSchemaFormatDate( Date( rs.value( "docdate" ) ) );
    else
      gDateMake = "";
    end;
    gTransState = "";
    _Trans_XML( vSum, vGrnd, 1, "Приходный кассовый ордер", _TransData_Num( rs.value( "applkey" ) ), Date( rs.value( "docdate" ) ), Int( rs.value( "curr" ) ), vBranch, vBankBIC );
  end;
  //return vClient;
end;

//----------------------------------------------------------------------------------------

private macro _TransData4_PlanPay( _Ref )
  var cmd, rs;
  var ret = FALSE;
  cmd = RsdCommand( "SELECT PP.T_AVIZO_SNAME as f, PP.T_AVIZO_NAME as n, PP.T_AVIZO_PNAME as p, PP.T_ACCOUNT as acc " +
                    "FROM Ddplanpay_DBT PP " +
                    "WHERE PP.T_REF = ? " +
                      "AND PP.T_OPEN_CLOSE = chr(0) " +
                      "AND PP.T_KINDPAY = 1" );
  cmd.addParam( "ref", RSDBP_IN );
  cmd.value( "ref" ) = _Ref;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    ret = TRUE;
    gRecipNamePh1 = String( rs.value( "f" ) );
    gRecipNamePh2 = String( rs.value( "n" ) );
    gRecipNamePh3 = String( rs.value( "p" ) );
    if ( StrLen( String( rs.value( "acc" ) ) ) > 1 )
      gRecipAcc = String( rs.value( "acc" ) );
    else
      gRecipAcc = "";
    end;
  end;
  return ret;
end;

private macro _TransData4_PlanPay_Check( _ApplKind, _ApplKey, _Sum, _Ground, _Curr, _Branch )
  var ref = 0;
  ReWind( f_pay_doc );
  ClearRecord( f_pay_doc );
  f_pay_doc.iApplicationKind = _ApplKind;
  f_pay_doc.ApplicationKey   = _ApplKey;
  if ( getEQ( f_pay_doc ) )
    SetRecordAddr( pay_np, f_pay_doc, 0, 0, TRUE );
    ref = pay_np.RefUncalimed;
    if ( ( ref > 0 )  AND  ( _TransData4_PlanPay( ref ) ) )
      gBankInFlag = FALSE;
      _AddressRecOut( _Branch );
      gRecipNameJur = "";
      gRecipINN = "";
      gDateMake = "";
      gTransState = "Не выплачен";
      _Trans_XML( _Sum, _Ground, 2, "", "", Date(0,0,0), _Curr, _Branch, "Ю" );
    end;
  end;
end;

private macro _TransData4()
  var vGrnd = "";
  var cmd, rs;
  cmd = RsdCommand( "SELECT PD.T_IAPPLICATIONKIND as applkind, PD.T_APPLICATIONKEY as applkey, PD.T_INSUM as sum, PD.T_GROUND as ground, PD.T_CODCUR as curr, PD.T_FNCASH as brnch " +
                    "FROM DPAY_DOC_DBT PD " +  
                    "WHERE PD.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                      "AND PD.T_CODCLIENT = ? " +
                      "AND PD.T_FNCASH IN " + gStrListDP + 
                      "AND PD.T_ACTION NOT IN (2, 11) " +
                      "AND PD.T_NUMOPERT=41 " +
                      "AND PD.T_GROUPOPERT=11 " +
                      "ORDER BY PD.T_CODCUR, PD.T_DATE_DOCUMENT, PD.T_APPLICATIONKEY" );

  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );

  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    vGrnd = rs.value( "ground" );
    if ( StrLen( vGrnd ) < 2 )
      vGrnd = " ";
    end;
    _TransData4_PlanPay_Check( rs.value( "applkind" ), rs.value( "applkey" ), rs.value( "sum" ), vGrnd, Int( rs.value( "curr" ) ), Int( rs.value( "brnch" ) ) );
  end;
  //return vClient;
end;

//----------------------------------------------------------------------------------------

private macro _TransData5_PlanPay_Check41( _ApplKind, _ApplKey )
  var ret = FALSE;
  ReWind( f_pay_doc );
  ClearRecord( f_pay_doc );
  f_pay_doc.iApplicationKind = _ApplKind;
  f_pay_doc.ApplicationKey   = _ApplKey;
  if ( getEQ( f_pay_doc ) )
    SetRecordAddr( pay_np, f_pay_doc, 0, 0, TRUE );
    if ( gRefUncalimed == pay_np.RefUncalimed )
      ret = TRUE;
    end;
  end;
  return ret;
end;

private macro _TransData5_41( _branch, _avizo_date )
  var ret = FALSE;
  var cmd, rs;
  cmd = RsdCommand( "SELECT PD.T_IAPPLICATIONKIND as applkind, PD.T_APPLICATIONKEY as applkey " +
                    "FROM DPAY_DOC_DBT PD " +
                    "WHERE PD.T_FNCASH = ? " +
                          "AND PD.T_CODCLIENT = ? " +
                          "AND PD.T_DATE_DOCUMENT = ? " +
                          "AND PD.T_ACTION NOT IN (2, 11) " +
                          "AND PD.T_NUMOPERT = 41 " +
                          "AND PD.T_GROUPOPERT = 11 " +
                          "ORDER BY PD.T_CODCUR, PD.T_DATE_DOCUMENT, PD.T_APPLICATIONKEY" );
  cmd.addParam( "branch", RSDBP_IN );
  cmd.addParam( "clnt", RSDBP_IN );
  cmd.addParam( "avizo", RSDBP_IN );
  cmd.value( "branch" ) = _branch;
  cmd.value( "Clnt" )   = fmrequestinfo.ClientID;
  cmd.value( "avizo" )  = _avizo_date;
  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( ( NOT ret )  AND  ( rs.moveNext ) )
    ret = _TransData5_PlanPay_Check41( rs.value( "applkind" ), rs.value( "applkey" ) );
  end;
  return ret;
end;

private macro _TransData5_PlanPay()
  var cmd, rs;
  var ret = FALSE;
  cmd = RsdCommand( "SELECT PP.T_FNCASH as branch, PP.T_AVIZO_DATE as avizo_date " +
                    "FROM Ddplanpay_DBT PP " +
                    "WHERE PP.T_REF = ? " +
                      // "AND PP.T_OPEN_CLOSE = chr(0) " +
                      "AND PP.T_KINDPAY = 1" );
  cmd.addParam( "ref", RSDBP_IN );
  cmd.value( "ref" ) = gRefUncalimed;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    ret = _TransData5_41( rs.value( "branch" ), rs.value( "avizo_date" ) );
  end;
  return ret;
end;

private macro _TransData5_PlanPay_Check( _ApplKind, _ApplKey )
  var ret = FALSE;
  ReWind( f_pay_doc );
  ClearRecord( f_pay_doc );
  f_pay_doc.iApplicationKind = _ApplKind;
  f_pay_doc.ApplicationKey   = _ApplKey;
  if ( getEQ( f_pay_doc ) )
    SetRecordAddr( pay_np, f_pay_doc, 0, 0, TRUE );
    gRefUncalimed = pay_np.RefUncalimed;
    if ( ( NOT ret )  AND  ( gRefUncalimed > 0 ) )
      ret = _TransData5_PlanPay();
    end;
  end;
  return ret;
end;

private macro _AddressRecOut01( _ApplKind, _ApplKey )
  var cmd, rs;
  var vBankID, vErr;
  cmd = RsdCommand( "select RPP.T_BANKCODEKIND as kind, RPP.T_BANKCODE as code, RPP.T_ACCOUNT as acc, RPP.T_NAME as name " +
                    "from drtpaymentprop_dbt rpp " +
                    "where RPP.T_DOCAPPLICATIONKIND = ? AND RPP.T_DOCAPPLICATIONKEY = ?" );
  cmd.addParam( "i", RSDBP_IN );
  cmd.addParam( "e", RSDBP_IN );
  cmd.value( "i" ) = _ApplKind;
  cmd.value( "e" ) = _ApplKey;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    if ( StrLen( String( rs.value( "acc" ) ) ) > 1 )
      gRecipAcc = String( rs.value( "acc" ) );
    else
      gRecipAcc = "";
    end;
  end;
end;

private macro _TransData5()
  var vSum, vGrnd = "", vBranch;
  var cmd, rs;
  cmd = RsdCommand( "SELECT PD.T_IAPPLICATIONKIND as applkind, PD.T_APPLICATIONKEY as applkey, PD.T_INSUM as sum, PD.T_GROUND as ground, PD.T_CODCUR as curr, PD.T_FNCASH as brnch, " +
                           "PD.T_CLIENTLASTNAME as f, PD.T_CLIENTFIRSTNAME as n, PD.T_CLIENTSECONDNAME as p, PD.T_DATE_DOCUMENT as docdate " +
                    "FROM DPAY_DOC_DBT PD " +
                    "WHERE PD.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                      "AND PD.T_FNCASH IN " + gStrListDP + 
                      "AND PD.T_ACTION NOT IN (2, 11) " +
                      "AND PD.T_NUMOPERT=1 " +
                      "AND PD.T_GROUPOPERT=41 " +
                      "ORDER BY PD.T_CODCUR, PD.T_DATE_DOCUMENT, PD.T_APPLICATIONKEY" );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;
  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    if ( _TransData5_PlanPay_Check( rs.value( "applkind" ), rs.value( "applkey" ) ) )
      vSum = rs.value( "sum" );
      vGrnd = rs.value( "ground" );
      if ( StrLen( vGrnd ) < 2 )
        vGrnd = " ";
      end;
      vBranch = Int( rs.value( "brnch" ) );
      gBankInFlag = FALSE;
      _AddressRecOut( vBranch );
      gRecipNameJur = "";
      gRecipNamePh1 = String( rs.value( "f" ) );
      gRecipNamePh2 = String( rs.value( "n" ) );
      gRecipNamePh3 = String( rs.value( "p" ) );
      gRecipINN = "";
      gRecipAcc  = "";
      if ( Date( rs.value( "docdate" ) ) != Date(0,0,0) )
        gDateMake = _GetSchemaFormatDate( Date( rs.value( "docdate" ) ) );
      else
        gDateMake = "";
      end;
      gTransState = "Выплачен";
      _AddressRecOut01( rs.value( "applkind" ), rs.value( "applkey" ) );
      _Trans_XML( vSum, vGrnd, 2, "", "", Date(0,0,0), Int( rs.value( "curr" ) ), Int( rs.value( "brnch" ) ), "Ю" );
    end;
  end;
  //return vClient;
end;

//----------------------------------------------------------------------------------------

private macro _ИнфЧастьПереводы()
  ExtractXMLFile.str = "<ИнфЧасть>";
  insert(ExtractXMLFile);

  _СведФЛ();

  _TransData1();
  _TransData2();
  _TransData3();
  _TransData4();
  _TransData5();

  ExtractXMLFile.str = "</ИнфЧасть>";
  insert(ExtractXMLFile);
end;

// =========================================
//       Переводы без открытия счета.
// =========================================
private macro _ПереводНалДенСредств()
  ExtractXMLFile.str = "<ПереводНалДенСредств>";
  insert( ExtractXMLFile );

  _СлужЧасть();

  _ИнфЧастьПереводы();

  ExtractXMLFile.str = "</ПереводНалДенСредств>";
  insert( ExtractXMLFile );
end;

private macro _CreateExtractXMLFile_Trans()
  ExtractXMLFile.str = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>";
  insert( ExtractXMLFile );

  // if ( _GetBuffers( fmreqiattach ) )
    _ПереводНалДенСредств();
  // end;
end;

////////////////////////////////////////////

private macro _Electron_XML( _Sum, _Name, _Curr, _Branch, _Date )
  var vSumRub = _SumToRub( _Curr, _Branch, _Date, _Sum );

  ExtractXMLFile.str = "<РаспПлательщ>";
  insert(ExtractXMLFile);

  ExtractXMLFile.str = "<ТипОператор>1</ТипОператор>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<НаимРасп>" + _Name + "</НаимРасп>";
  insert(ExtractXMLFile);
  if ( StrLen( gNumRasp ) > 0 )
    ExtractXMLFile.str = "<НомРасп>" + gNumRasp + "</НомРасп>";
    insert(ExtractXMLFile);
  end;
  if ( gDateRasp != Date(0,0,0) )
    ExtractXMLFile.str = "<ДатРасп>" + _GetSchemaFormatDate( gDateRasp ) + "</ДатРасп>";
    insert(ExtractXMLFile);
  end;
  ExtractXMLFile.str = "<НомОпер></НомОпер>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КодВалют>" + _CurrCode( _Curr ) + "</КодВалют>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<СумПеревод>" + String( _Sum:0:2 ) + "</СумПеревод>";
  insert(ExtractXMLFile);
  if ( StrLen( vSumRub ) > 0 )
    ExtractXMLFile.str = "<СумПереводРуб>" + vSumRub + "</СумПереводРуб>";
    insert(ExtractXMLFile);
  end;
  ExtractXMLFile.str = "<ИдентЭлПл>" + gElIdent + "</ИдентЭлПл>";
  insert(ExtractXMLFile);
  if ( StrLen( fmrequestinfo.KGRKO_BankShortName ) > 1 )
    ExtractXMLFile.str = "<НаимКОПл>" + fmrequestinfo.KGRKO_BankShortName + "</НаимКОПл>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( fmrequestinfo.KGRKO_BankNumber ) > 1 )
    ExtractXMLFile.str = "<РегНомКОПл>" + fmrequestinfo.KGRKO_BankNumber + "</РегНомКОПл>";
    insert(ExtractXMLFile);
  end;
  if ( StrLen( String( Int( fmrequestinfo.KGRKO_BankDprt ) ) ) > 0 )
    ExtractXMLFile.str = "<НомФлПл>" + String( Int( fmrequestinfo.KGRKO_BankDprt ) ) + "</НомФлПл>";
    insert(ExtractXMLFile);
  end;
  ExtractXMLFile.str = "<ИННПолуч></ИННПолуч>";
  insert(ExtractXMLFile);
  if ( StrLen( String( gElGround ) ) < 2 )
    gElGround = "";
  end;
  ExtractXMLFile.str = "<НазначПлатеж>" + String( gElGround ) + "</НазначПлатеж>";
  insert(ExtractXMLFile);
  if ( gDateRasp != Date(0,0,0) )
    ExtractXMLFile.str = "<ДатаИспРПлат>" + _GetSchemaFormatDate( gDateRasp ) + "</ДатаИспРПлат>";
    insert(ExtractXMLFile);
  end;

  ExtractXMLFile.str = "</РаспПлательщ>";
  insert(ExtractXMLFile);
end;

private macro _El_Tran( _branch, _ref )
  var cmd, rs;
  cmd = RsdCommand( "SELECT CT.T_AUTHCODE as c, CT.T_AUTHDATE as d, CT.T_AUTHNOTES as notes " +
                    "FROM dsctran_dbt ct " +
                    "WHERE CT.T_FNCASH = ? " +
                      "AND CT.T_AUTHREF = ? " );
  cmd.addParam( "brn", RSDBP_IN );
  cmd.addParam( "ref", RSDBP_IN );
  cmd.value( "brn" ) = _branch;
  cmd.value( "ref" ) = _ref;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    if ( StrLen( String( rs.value( "c" ) ) ) > 1 )
      gNumRasp = String( rs.value( "c" ) );
    else
      gNumRasp = "";
    end;
    gDateRasp = Date( rs.value( "d" ) );
    gElGround = String( rs.value( "notes" ) );
  end;
end;

private macro _El_Card( _branch, _ref )
  var cmd, rs;
  cmd = RsdCommand( "select CC.T_CARDNUMBER as num " +
                    "from dsccard_dbt cc " +
                    "where CC.T_FNCASH = ? " +
                    "AND CC.T_CARDREF = ?" );
  cmd.addParam( "brn", RSDBP_IN );
  cmd.addParam( "ref", RSDBP_IN );
  cmd.value( "brn" ) = _branch;
  cmd.value( "ref" ) = _ref;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    gElIdent = String( rs.value( "num" ) );
  end;
end;

private macro _El_Link( _branch, _ref )
  var cmd, rs;

  cmd = RsdCommand( "select CL.T_FNCASH as branch, CL.T_CARDREF as ref " +
                    "from dsclink_dbt cl " +
                    "where CL.T_FNCASH = ? " +
                      "AND CL.T_ACCCARDLINKREF = ?" );
  cmd.addParam( "brn", RSDBP_IN );
  cmd.addParam( "ref", RSDBP_IN );
  cmd.value( "brn" ) = _branch;
  cmd.value( "ref" ) = _ref;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    _El_Card( rs.value( "branch" ), rs.value( "ref" ) );
  end;
end;

private macro _Electron_Pre_XML( _Sum, _Auth, _Date, _Branch, _Curr, _AddRef, _Link, _Ground )
  var vName;
  gDateRasp = Date(0,0,0);
  gElGround = "";
  if ( _Auth == 0 )
    vName = "Списание с карточного счета";
    gDateRasp = _Date;
    gNumRasp = "";
    gElGround = String( _Ground );
  else
    vName = "Транзакция по пластиковой карте";
    _El_Tran( _Branch, _Auth );
  end;

  if ( _AddRef > 0 )
    _El_Card( _Branch, _AddRef );
  else
    _El_Link( _branch, _Link );
  end;

  _Electron_XML( _Sum, vName, _Curr, _Branch, _Date );
end;

private macro _ElectronData1()
  var vSum, vGrnd = "", vBranch;
  var cmd, rs;

  cmd = RsdCommand( "SELECT CRD.T_AUTHREF as ar, CRD.T_OUTSUM as sum, CRD.T_FNCASH as branch, CRD.T_DATE as dt, CRD.T_CURRCODE as curr, CRD.T_ADDCARDREF as aref, CRD.T_ACCCARDLINKREF as linkr, CRD.T_GROUND as grnd " +
                    "FROM dsccrddoc_dbt CRD " +
                    "WHERE CRD.T_OUTSUM > 0 AND " +
                    "CRD.T_NUMOPER<>47 AND " +
                    "CRD.T_ACTION NOT IN (2, 11) AND " +
                    "CRD.T_DATE BETWEEN ? AND ? AND " +
                    "(CRD.T_ACCCARDLINKREF, CRD.T_FNCASH) IN ( SELECT CL.T_ACCCARDLINKREF, CL.T_FNCASH " +
                                                              "FROM dsclink_dbt CL " +
                                                              "WHERE (CL.T_CARDREF, CL.T_FNCASH) IN ( SELECT CR.T_CARDREF, CR.T_FNCASH " +
                                                                "FROM dsccard_dbt cr INNER JOIN drtcardcontract_dbt cntr ON CR.T_CONTRACTID = CNTR.T_ID AND CR.T_FNCASH = CNTR.T_BRANCH " +
                                                                "WHERE CR.T_CODCLIENT = ? AND CR.T_FNCASH IN " + gStrListDP + " AND " +
                                                                                              "( CNTR.T_MAINCARDCNTRID=0 OR ( CNTR.T_MAINCARDCNTRID>0 AND CNTR.T_ADDCARDOWNACC='X' ) ) " +
                                                                                                  "UNION " +
                                                                                                  "SELECT CR.T_CARDREF, CR.T_FNCASH " +
                                                                                                  "FROM dsccard_dbt cr INNER JOIN drtcardcontract_dbt cntr ON CR.T_CONTRACTID = CNTR.T_ID AND CR.T_FNCASH = CNTR.T_BRANCH " +
                                                                                                  "WHERE CR.T_CODCLIENT <> ? AND cntr.T_MAINCARDCNTRID > 0 AND (cntr.T_MAINCARDCNTRID, CNTR.T_BRANCH) in " +
                                                                                                        "( SELECT CNTR.T_ID, CNTR.T_BRANCH " +
                                                                                                           "FROM dsccard_dbt cr INNER JOIN drtcardcontract_dbt cntr ON CR.T_CONTRACTID = CNTR.T_ID AND CR.T_FNCASH = CNTR.T_BRANCH " +
                                                                                                           "WHERE CR.T_CODCLIENT = ? AND CNTR.T_MAINCARDCNTRID=0 AND " +
                                                                                                                                         "CR.T_FNCASH IN " + gStrListDP + ") AND CNTR.T_ADDCARDOWNACC='X' ) ) " +
                    "ORDER BY  CRD.T_FNCASH, CRD.T_ACCCARDLINKREF, CRD.T_DATE, CRD.T_NUMDAYDOC" );

  cmd.addParam( "dBeg1", RSDBP_IN );
  cmd.addParam( "dEnd1", RSDBP_IN );
  cmd.addParam( "clnt1", RSDBP_IN );
  cmd.addParam( "clnt2", RSDBP_IN );
  cmd.addParam( "clnt3", RSDBP_IN );
  cmd.value( "dBeg1" ) = gPeriodDateBegin;
  cmd.value( "dEnd1" ) = gPeriodDateEnd;
  cmd.value( "clnt1" ) = fmrequestinfo.ClientID;
  cmd.value( "clnt2" ) = fmrequestinfo.ClientID;
  cmd.value( "clnt3" ) = fmrequestinfo.ClientID;
  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    _Electron_Pre_XML( rs.value( "sum" ), Int( rs.value( "ar" ) ), Date( rs.value( "dt" ) ), rs.value( "branch" ), Int( rs.value( "curr" ) ), Int( rs.value( "aref" ) ), Int( rs.value( "linkr" ) ), rs.value( "grnd" ) );
  end;
end;

private macro _ElectronSubAcc( _ref, _link, _branch )
  var vSum, vGrnd = "", vBranch;
  var cmd, rs;
  cmd = RsdCommand( "SELECT CRD.T_AUTHREF as ar, CRD.T_OUTSUM as sum, CRD.T_FNCASH as branch, CRD.T_DATE as dt, CRD.T_CURRCODE as curr, CRD.T_ADDCARDREF as aref, CRD.T_ACCCARDLINKREF as linkr, CRD.T_GROUND as grnd " +
                    "FROM dsccrddoc_dbt CRD " +
                    "WHERE CRD.T_OUTSUM>0 AND " +
                    "CRD.T_NUMOPER<>47 AND " +
                    "CRD.T_ACTION NOT IN (2, 11) AND " +
                    "CRD.T_DATE	BETWEEN ? AND ? AND " +
                    "CRD.T_ADDCARDREF = ? AND " +
                    "CRD.T_ACCCARDLINKREF = ? AND " +
                    "CRD.T_FNCASH = ? " +
                    "ORDER BY CRD.T_FNCASH, CRD.T_ACCCARDLINKREF, CRD.T_DATE, CRD.T_NUMDAYDOC" );
  cmd.addParam( "dt1", RSDBP_IN );
  cmd.addParam( "dt2", RSDBP_IN );
  cmd.addParam( "ref", RSDBP_IN );
  cmd.addParam( "lnk", RSDBP_IN );
  cmd.addParam( "brn", RSDBP_IN );
  cmd.value( "dt1" ) = gPeriodDateBegin;
  cmd.value( "dt2" ) = gPeriodDateEnd;
  cmd.value( "ref" ) = _ref;
  cmd.value( "lnk" ) = _link;
  cmd.value( "brn" ) = _branch;
  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    _Electron_Pre_XML( rs.value( "sum" ), Int( rs.value( "ar" ) ), Date( rs.value( "dt" ) ), rs.value( "branch" ), Int( rs.value( "curr" ) ), Int( rs.value( "aref" ) ), Int( rs.value( "linkr" ) ), rs.value( "grnd" ) );
  end;
end;

private macro _ElectronData2()
  var cmd, rs;
  cmd = RsdCommand( "SELECT DISTINCT CR.T_CARDREF CrdRef, CL.T_MAINSUBACCLINKREF as MainLink, CL.T_FNCASH as Branch " +
                    "FROM dsccard_dbt cr " +
                    "INNER JOIN drtcardcontract_dbt cntr " +
                    "ON CR.T_CONTRACTID = CNTR.T_ID AND CR.T_FNCASH = CNTR.T_BRANCH " +
                    "INNER JOIN dsclink_dbt CL " +
                    "ON CR.T_CARDREF = CL.T_CARDREF AND CR.T_FNCASH = CL.T_FNCASH " +
                    "INNER JOIN drt_contract_dbt CNTRMAIN " +
                    "ON CNTRMAIN.T_BRANCH=CNTR.T_BRANCH AND CNTRMAIN.T_ID = CNTR.T_MAINCARDCNTRID " +
                    "WHERE CR.T_CODCLIENT = ? AND " +
                          "CR.T_FNCASH IN " + gStrListDP + " AND " +
                          "CNTR.T_MAINCARDCNTRID>0 AND " +
                          "CNTR.T_ADDCARDOWNACC<>'X' AND " +
                          "CL.T_MAINSUBACCLINKREF > 0 AND " +
                          "CNTRMAIN.T_CLIENTCODE <> ? " +
                    "ORDER BY 1, 2, 3" );
  cmd.addParam( "clnt1", RSDBP_IN );
  cmd.addParam( "clnt2", RSDBP_IN );
  cmd.value( "clnt1" ) = fmrequestinfo.ClientID;
  cmd.value( "clnt2" ) = fmrequestinfo.ClientID;
  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    _ElectronSubAcc( rs.value( "CrdRef" ), rs.value( "MainLink" ), rs.value( "Branch" ) );
  end;
end;

//----------------------------------------------------------------------------------------

private macro _ИнфЧастьЭлДенСредств()
  ExtractXMLFile.str = "<ИнфЧасть>";
  insert(ExtractXMLFile);

  _СведФЛ();
  _ElectronData1();
  _ElectronData2();

  ExtractXMLFile.str = "</ИнфЧасть>";
  insert(ExtractXMLFile);
end;

// ===================================================
//       Переводы электронных денежных средств.
// ===================================================
private macro _ПереводЭлДенСредств()
  ExtractXMLFile.str = "<ПереводЭлДенСредств>";
  insert( ExtractXMLFile );

  _СлужЧасть();
  _ИнфЧастьЭлДенСредств();

  ExtractXMLFile.str = "</ПереводЭлДенСредств>";
  insert( ExtractXMLFile );
end;

private macro _CreateExtractXMLFile_Electr()
  ExtractXMLFile.str = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>";
  insert( ExtractXMLFile );
  // if ( _GetBuffers( fmreqiattach ) )
    _ПереводЭлДенСредств();
  // end;
end;

////////////////////////////////////////////

private macro _BOO_XML( _Struct )

  var vWarrant = "0";

  if ( NOT _Struct )
    return;
  end;

  ExtractXMLFile.str = "<СведОбОпер>";
  insert(ExtractXMLFile);

  ExtractXMLFile.str = "<НомРеестр>" + String( gExcNumb ) + "</НомРеестр>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<НомОпер>" + reestrBOO.rec.Number + "</НомОпер>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<ДатаОпер>" + _GetSchemaFormatDate( reestrBOO.rec.CurDate ) + "</ДатаОпер>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<ВремОпер>" + SubStr( _GetSchemaFormatTime( _Struct._time ), 1, 5 ) + "</ВремОпер>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КодВидОпер>" + reestrBOO.rec.Code113I + "</КодВидОпер>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КодВалПрин>" + _Struct._incomeISO + "</КодВалПрин>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КурсВал>" + _Struct._rate + "</КурсВал>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<СумПрин>" + _Struct._incomeSum + "</СумПрин>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КодВалВыд>" + _Struct._outISO + "</КодВалВыд>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<СумВыд>" + _Struct._outSum + "</СумВыд>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<ПризИспКарта>" + _Struct._isCard + "</ПризИспКарта>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КолЧек>" + _Struct._pdNum + "</КолЧек>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<КодВалЧек>" + _Struct._pdISO + "</КодВалЧек>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<СумЧек>" + _Struct._pdSum + "</СумЧек>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<НомСчет>" + _Struct._account + "</НомСчет>";
  insert(ExtractXMLFile);
  if ( StrLen( _Struct._warrant ) > 0 )
    vWarrant = "1";
  else
    vWarrant = "0";
  end;
  ExtractXMLFile.str = "<ПризОпДовер>" + vWarrant + "</ПризОпДовер>";
  insert(ExtractXMLFile);
  if ( StrLen( _Struct._country ) > 0 )
    ExtractXMLFile.str = "<ГраждФЛ>" + _Struct._country + "</ГраждФЛ>";
  else
    ExtractXMLFile.str = "<ГраждФЛ>" + "000" + "</ГраждФЛ>";
  end;
  insert(ExtractXMLFile);

  ExtractXMLFile.str = "</СведОбОпер>";
  insert(ExtractXMLFile);
end;

private macro _BOO_Reestr( _ApplKind, _ApplKey )
  reestrBOO.clear();
  reestrBOO.rec.APPLICATIONKIND = _ApplKind;
  reestrBOO.rec.APPLICATIONKEY  = _ApplKey;

  if ( reestrBOO.getEQ() )
    if ( gCurDate == Date(0,0,0) )
      gCurDate = reestrBOO.rec.CurDate;
      gExcDate = reestrBOO.rec.Date;
      gExcNumb = 1;
    else
      if ( ( gCurDate == reestrBOO.rec.CurDate )  AND  ( gExcDate != reestrBOO.rec.Date ) )
        gExcNumb = gExcNumb + 1;
        gExcDate = reestrBOO.rec.Date;
      elif ( gCurDate != reestrBOO.rec.CurDate )
        gExcNumb = 1;
        gCurDate = reestrBOO.rec.CurDate;
        gExcDate = reestrBOO.rec.Date;
      end;
    end;
    _BOO_XML( FillDataEx( reestrBOO ) );
  end;
end;

private macro _BOO_Data( _Branch, _PartyID )
  var vDepReg, vDepRegNum, vErr, vInd;
  var cmd, rs;

  if ( ( ValType( _Branch ) != V_INTEGER )  OR  ( ValType( _PartyID ) != V_INTEGER ) )
    return;
  end;

  cmd = RsdCommand( "SELECT R.T_APPLICATIONKEY AS RAppKey, R.T_APPLICATIONKIND AS RAppKind, R.T_CURDATE AS RCurDate, R.T_DATE AS RDate " +
                    "FROM ( SELECT R.T_APPLICATIONKEY, R.T_APPLICATIONKIND, R.T_CURDATE, R.T_DATE " +
                           "FROM drmto_op_dbt OP " +
                           "INNER JOIN DRMTO_trans_dbt RMTO " +
                             "ON RMTO.T_BRANCH=OP.T_BRANCH AND RMTO.T_TRANSID=OP.T_TRANSID INNER JOIN dreestr_2_dbt R " +
                             "ON OP.T_OPAPPLICATIONKEY=R.T_APPLICATIONKEY AND OP.T_OPAPPLICATIONKIND=R.T_APPLICATIONKIND " +
                               "WHERE OP.T_BRANCH = ? AND R.T_CURDATE BETWEEN ? AND ? AND " +
                                     "RMTO.T_SENDERPARTYID = ? AND " +
                                     "RMTO.T_ACTION NOT IN (2, 11) " +
                                 "UNION " +
                                 "SELECT R.T_APPLICATIONKEY, R.T_APPLICATIONKIND, R.T_CURDATE, R.T_DATE " +
                                 "FROM dexoperat_dbt EXOP " +
                                 "INNER JOIN dreestr_2_dbt R " +
                             "ON EXOP.T_APPLICATIONKEY=R.T_APPLICATIONKEY AND " +
                             "EXOP.T_APPLICATIONKIND=R.T_APPLICATIONKIND " +
                               "WHERE EXOP.T_BRANCH = ? AND " +
                             "R.T_CURDATE BETWEEN ? AND ? AND " +
                             "EXOP.T_CLIENTCODE = ? AND " +
                             "EXOP.T_ACTION NOT IN (2, 11) " +
                                 "UNION " +
                                 "SELECT R.T_APPLICATIONKEY, R.T_APPLICATIONKIND, R.T_CURDATE, R.T_DATE " +
                                 "FROM dsbdepdoc_dbt SB " +
                                 "INNER JOIN dreestr_2_dbt R " + 
                             "ON SB.T_APPLICATIONKEY=R.T_APPLICATIONKEY AND " +
                             "SB.T_IAPPLICATIONKIND=R.T_APPLICATIONKIND " +
                                 "WHERE SB.T_FNCASH = ? AND " +
                             "R.T_CURDATE BETWEEN ? AND ? AND " +
                             "SB.T_CODCLIENT = ? AND " +
                             "SB.T_ACTION NOT IN (2, 11) AND " +
                             "SB.T_FLAGSTORN=chr(0) " +
                                 "UNION " +
                                   "SELECT R.T_APPLICATIONKEY, R.T_APPLICATIONKIND, R.T_CURDATE, R.T_DATE " +
                                   "FROM dpay_doc_dbt PD " +
                                   "INNER JOIN dreestr_2_dbt R " +
                                     "ON PD.T_APPLICATIONKEY=R.T_APPLICATIONKEY AND PD.T_IAPPLICATIONKIND=R.T_APPLICATIONKIND " +
                                       "WHERE PD.T_FNCASH = ? AND R.T_CURDATE BETWEEN ? AND ? AND " +
                                             "PD.T_CODCLIENT = ? AND " +
                                             "PD.T_ACTION NOT IN (2, 11) ) R " +
                             "ORDER BY R.T_CURDATE, R.T_DATE " );

  cmd.addParam( "brn1", RSDBP_IN );
  cmd.addParam( "beg1", RSDBP_IN );
  cmd.addParam( "end1", RSDBP_IN );
  cmd.addParam( "cln1", RSDBP_IN );
  cmd.addParam( "brn2", RSDBP_IN );
  cmd.addParam( "beg2", RSDBP_IN );
  cmd.addParam( "end2", RSDBP_IN );
  cmd.addParam( "cln2", RSDBP_IN );
  cmd.addParam( "brn3", RSDBP_IN );
  cmd.addParam( "beg3", RSDBP_IN );
  cmd.addParam( "end3", RSDBP_IN );
  cmd.addParam( "cln3", RSDBP_IN );
  cmd.addParam( "brn4", RSDBP_IN );
  cmd.addParam( "beg4", RSDBP_IN );
  cmd.addParam( "end4", RSDBP_IN );
  cmd.addParam( "cln4", RSDBP_IN );

  cmd.value( "brn1" ) = _Branch;
  cmd.value( "beg1" ) = gPeriodDateBegin;
  cmd.value( "end1" ) = gPeriodDateEnd;
  cmd.value( "cln1" ) = fmrequestinfo.ClientID;
  cmd.value( "brn2" ) = _Branch;
  cmd.value( "beg2" ) = gPeriodDateBegin;
  cmd.value( "end2" ) = gPeriodDateEnd;
  cmd.value( "cln2" ) = fmrequestinfo.ClientID;
  cmd.value( "brn3" ) = _Branch;
  cmd.value( "beg3" ) = gPeriodDateBegin;
  cmd.value( "end3" ) = gPeriodDateEnd;
  cmd.value( "cln3" ) = fmrequestinfo.ClientID;
  cmd.value( "brn4" ) = _Branch;
  cmd.value( "beg4" ) = gPeriodDateBegin;
  cmd.value( "end4" ) = gPeriodDateEnd;
  cmd.value( "cln4" ) = fmrequestinfo.ClientID;

  cmd.execute;
  rs = RsdRecordset( cmd );

  vDepReg = ПолучитьКодСубъекта( _PartyID, PTCK_BANKREGNUM, vErr );
  if ( vErr )
    vDepRegNum = String( _Branch );
  else
    vInd = Index( vDepReg, "/" );
    if ( vInd == 0 )
      vDepRegNum = vDepReg;
    else
      vDepRegNum = SubStr( vDepReg, vInd+1 );
    end;
  end;

  ExtractXMLFile.str = "<СведОФил>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<НомФл>" + vDepRegNum + "</НомФл>";
  insert(ExtractXMLFile);

  gCurDate = Date(0,0,0);
  gExcDate = Date(0,0,0);
  gExcNumb = 1;

  while ( rs.moveNext )
    _BOO_Reestr( rs.value( "RAppKind" ), rs.value( "RAppKey" ) );
  end;

  ExtractXMLFile.str = "</СведОФил>";
  insert(ExtractXMLFile);
end;

private macro _ИнфЧастьВОО()
  var lenLDP = listDP.Size();
  var i = 0;

  ExtractXMLFile.str = "<ИнфЧасть>";
  insert(ExtractXMLFile);

  ExtractXMLFile.str = "<НаимКО>" + fmrequestinfo.KGRKO_BankShortName + "</НаимКО>";
  insert(ExtractXMLFile);
  ExtractXMLFile.str = "<РегНомКО>" + fmrequestinfo.KGRKO_BankNumber + "</РегНомКО>";
  insert(ExtractXMLFile);

  // _СведФЛ();  - сведения о физ.лице в Реестрах не выводятся.

   while ( i < lenLDP )
    _BOO_Data( ListDP[i], ListID[i] );
     i = i + 1;
   end;

  ExtractXMLFile.str = "</ИнфЧасть>";
  insert(ExtractXMLFile);
end;

// ===================================================
//         Реестр валютно-обменных операций.
// ===================================================
private macro _ВыпискаИзРеестраОпер()
  ExtractXMLFile.str = "<ВыпискаИзРеестраОпер>";
  insert( ExtractXMLFile );

  _СлужЧасть();
  _ИнфЧастьВОО();

  ExtractXMLFile.str = "</ВыпискаИзРеестраОпер>";
  insert( ExtractXMLFile );
end;

private macro _CreateExtractXMLFile_Exchange()
  ExtractXMLFile.str = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>";
  insert( ExtractXMLFile );
  // if ( _GetBuffers( fmreqiattach ) )
    _ВыпискаИзРеестраОпер();
  // end;
end;

////////////////////////////////////////////

private macro _GetElemPairArr( regValue )
  var elemPairArr = TArray;
  var strValue = regValue;
  var idxDelim;
  idxDelim = index( strValue, ";" );
  while ( idxDelim > 0 )
    elemPairArr[elemPairArr.size] = substr(strValue, 1, idxDelim - 1);
    strValue = substr( strValue, idxDelim + 1 );
    idxDelim = index( strValue, ";" );
  end;
  return elemPairArr;
end;

private macro _SetElemText( elem, code, delim )
  var strValue = "";
  var ObjCat;
  var Note;
  if ( delim == "#" )
    ObjCat = RsbObjCategories( OBJTYPE_PARTY, UniID(clientparty, OBJTYPE_PARTY) );
    if ( ObjCat.GetFirst(int(code), {curdate}, attr) == 0 )
      strValue = attr.NumInList;
      while ( ObjCat.GetNext(attr) == 0 )
        strValue = strValue + "," + attr.NumInList;
      end;
    end;
  elif ( delim == "$" )
    ObjCat = RsbObjCategories( OBJTYPE_PARTY, UniID(clientparty, OBJTYPE_PARTY) );
    if ( ObjCat.GetFirst(int(code), {curdate}, attr) == 0 )
      strValue = attr.Name;
      while ( ObjCat.GetNext(attr) == 0 )
        strValue = strValue + "," + attr.Name;
      end;
    end;
  elif ( delim == "@" )
    Note = readNoteForObject( OBJTYPE_PARTY, UniID(clientparty, OBJTYPE_PARTY), int(code) );
    if ( Note != null )
      strValue = strValue + Note;
    end;
  end;
  elem.text = strValue;
end;

private macro _SetChildElem( xmlDoc, root, elemTextPair )
  var idxDelim;
  var ElemName;
  var tmpElemTextPair;
  var elem;
  var delim;
  var i = 0;
  while ( i < 4 )
    if ( i == 0 )
      delim = ".";
    elif ( i == 1 )
      delim = "#";
    elif ( i == 2 )
      delim = "$";
    else
      delim = "@";
    end;
    idxDelim = index( elemTextPair, delim );
    if ( idxDelim > 0 )
      ElemName = substr( elemTextPair, 1, idxDelim - 1 );
      if ( ElemName != "" )
        tmpElemTextPair = substr( elemTextPair, idxDelim + 1 );
        elem = root.selectSingleNode( ElemName );
        if ( elem == null )
          elem = xmlDoc.createElement( ElemName );
          root.appendChild( elem );
        end;
        if ( i == 0 )
          _SetChildElem( xmlDoc, elem, tmpElemTextPair );
        else
          _SetElemText( elem, tmpElemTextPair, delim );
        end;
      end;
      return;
    end;
    i = i + 1;
  end;
end;

private macro _SetXmlByElemTextPair( xmlDoc, elemTextPair )
  var root = xmlDoc.documentElement;
  _SetChildElem( xmlDoc, root, elemTextPair );
end;

private macro _AddUserValueByRegistry( xmlDoc )
  var stat : bool;
  var regValue;
  var elemPairArr;
  var i;

  GetRegistryValue( "ФИНМОНИТОРИНГ\\REQINFO_CQ_SUBSTS", V_STRING, regValue, stat );
  
  if ( regValue != "" )
    elemPairArr = _GetElemPairArr( regValue );
    i = 0;
    while ( i < elemPairArr.size )
      _SetXmlByElemTextPair( xmlDoc, elemPairArr[i] );
      i = i + 1;
    end;
  end;
end;

macro moneyTransfersNonAccount( fm_reqiattach, AttachBody:@string, IsInfoAbsent:@bool )

  var xmlDoc;
  var InfoAvailability = 1; // Запрашиваемая информация имеется в полном объёме.
  var AttachFileCreateDate = Date();
  var AttachFileCreateTime = Time();
  var AttachFileName;
  var Comment = "";
  var tostring = "";
  var j = 0;
  var stat = 0;

  setbuff( fmreqiattach, fm_reqiattach );

  IsInfoAbsent = FALSE;

  if ( fmreqiattach.PeriodDateBegin != Date(0,0,0) )
    gPeriodDateBegin = fmreqiattach.PeriodDateBegin;
  end;

  if ( fmreqiattach.PeriodDateEnd != Date(0,0,0) )
    gPeriodDateEnd = fmreqiattach.PeriodDateEnd;
  end;

  if ( gPeriodDateBegin > gPeriodDateEnd )
    MsgBox( cMsgDate );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgDate;
    AttachBody = cMsgDate;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( ( stat == 0 )  AND  ( NOT _GetBuffers( fmreqiattach ) ) )
    stat = 26249;
  end;

  if ( ( stat == 0 )  AND  ( fmrequestinfo.ClientID <= 0 ) )
    MsgBox( cMsgNoAC );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgNoAC;
    AttachBody = cMsgNoAC;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( stat == 0 )
    if ( fmrequestinfo.SourceDprt != 0 )
      gSourceDprt = fmrequestinfo.SourceDprt;
    end;
    _makeListDP( gSourceDprt, fmrequestinfo.ChildDprtInc );

    AttachFileName = FM_GetReqAttachName( fmreqiattach, "xml" );
    
    ExtractXMLFileName = "..\\workfile\\getattach_fmreq_" + _ПолучитьВременноеИмяФайла( fmreqiattach, "xml" );
    
    if ( open ( ExtractXMLFile, ExtractXMLFileName, "utf8" ) )
      _CreateExtractXMLFile_Trans();
      close(ExtractXMLFile);
    else
      stat = 1;
    end;

    if(stat == 0)
      xmlDoc = CreateXMLParser();
      xmlDoc.async = false;
      xmlDoc.load( ExtractXMLFileName );

      _AddUserValueByRegistry( xmlDoc );

      xmlDoc.save( ExtractXMLFileName );
      xmlDoc = null;
    end;
  end;

  if ( stat == 0 )
    j = 0;
    while ( j < AbsentFieldValuesArr.size )
      if ( j == 0 )
        Comment = "╪- з?-Ё? Rвбгвбвўг?в";
        InfoAvailability = 2; // ╪ Їа иЁў ?┐ п Ё-дRа┐ жЁп Ё┐??вбп з бвЁз-R
      end;
      Comment = Comment + "\n" + AbsentFieldValuesArr[j];
      j = j + 1;
    end;

    fmreqiattach.InfoAvailability = InfoAvailability;
    fmreqiattach.AttachFileCreateDate = AttachFileCreateDate;
    fmreqiattach.AttachFileCreateTime = AttachFileCreateTime;
    fmreqiattach.AttachFileName = AttachFileName;
    if ( ( fmreqiattach.AvailComment != "" ) and ( Comment != "" ) )
      fmreqiattach.AvailComment = fmreqiattach.AvailComment + "\n" + Comment;
    end;

    ReadFileToString( ExtractXMLFileName, tostring );
    AttachBody = tostring;
  end;

  return stat;
end;

private macro _findAccClient( _Acc )
  var vClient = -1;
  var cmd, rs;
  if ( StrLen( _Acc ) > 0 )
    cmd = RsdCommand( "select T_CODCLIENT as clnt, T_FNCASH as dprt, T_OPEN_DATE as open, T_CLOSE_DATE as clse, T_OPEN_CLOSE as opcl " +
                        "from ddepositr_dbt " +
                          "where T_ACCOUNT = ?" );
    cmd.addParam( "acc", RSDBP_IN );
    cmd.value( "acc" ) = _Acc;
    cmd.execute;
    rs = RsdRecordset( cmd );
    if ( rs.moveNext )
      vClient   = rs.value( "clnt" );
      gAccDprt  = rs.value( "dprt" );
      gAccOpen  = rs.value( "open" );
      gAccClose = rs.value( "clse" );
      gAccOpCl  = rs.value( "opcl" );
    end;
  end;
  return vClient;
end;

private macro _checkClientAcc( _Client, _Acc )
  var vRet = FALSE;
  if ( _Client == _findAccClient( _Acc ) )
    vRet = TRUE;
  end;
  return vRet;
end;

private macro _checkAccDprt( _Acc, _source )
  var vRet = FALSE;
  var lenLDP = listDP.Size();
  var i = 0;
  if ( StrLen( _Acc ) <= 0 )
    vRet = TRUE;
  else
    if ( gAccDprt == _source )
      vRet = TRUE;
    else
      while ( ( NOT vRet )  AND  ( i < lenLDP ) )
        if ( gAccDprt == ListDP[i] )
          vRet = TRUE;
        end;
        i = i + 1;
      end;
    end;
  end;
  return vRet;
end;

macro electronicFundsTransfers( fm_reqiattach, AttachBody:@string, IsInfoAbsent:@bool )

  var xmlDoc;
  var InfoAvailability = 1; // Запрашиваемая информация имеется в полном объёме.
  var AttachFileCreateDate = Date();
  var AttachFileCreateTime = Time();
  var AttachFileName;
  var Comment = "";
  var tostring = "";
  var j = 0;
  var stat = 0;

  setbuff( fmreqiattach, fm_reqiattach );

  IsInfoAbsent = FALSE;

  if ( fmreqiattach.PeriodDateBegin != Date(0,0,0) )
    gPeriodDateBegin = fmreqiattach.PeriodDateBegin;
  end;

  if ( fmreqiattach.PeriodDateEnd != Date(0,0,0) )
    gPeriodDateEnd = fmreqiattach.PeriodDateEnd;
  end;

  if ( gPeriodDateBegin > gPeriodDateEnd )
    MsgBox( cMsgDate );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgDate;
    AttachBody = cMsgDate;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( ( stat == 0 )  AND ( NOT _GetBuffers( fmreqiattach ) ) )
    stat = 26249;
  end;

  if ( ( stat == 0 )  AND  ( fmrequestinfo.ClientID <= 0 )  AND  ( StrLen( fmreqiattach.Account ) == 0 ) )
    MsgBox( cMsgNoAC );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgNoAC;
    AttachBody = cMsgNoAC;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( stat == 0 )
    if ( fmrequestinfo.SourceDprt != 0 )
      gSourceDprt = fmrequestinfo.SourceDprt;
    end;
    _makeListDP( gSourceDprt, fmrequestinfo.ChildDprtInc );

    AttachFileName = FM_GetReqAttachName( fmreqiattach, "xml" );
    
    ExtractXMLFileName = "..\\workfile\\getattach_fmreq_" + _ПолучитьВременноеИмяФайла( fmreqiattach, "xml" );
    
    if ( open ( ExtractXMLFile, ExtractXMLFileName, "utf8" ) )
      _CreateExtractXMLFile_Electr();
      close(ExtractXMLFile);
    else
      stat = 1;
    end;

    if(stat == 0)
      xmlDoc = CreateXMLParser();
      xmlDoc.async = false;
      xmlDoc.load( ExtractXMLFileName );

      _AddUserValueByRegistry( xmlDoc );

      xmlDoc.save( ExtractXMLFileName );
      xmlDoc = null;
    end;
  end;

  if ( stat == 0 )
    j = 0;
    while ( j < AbsentFieldValuesArr.size )
      if ( j == 0 )
        Comment = "╪- з?-Ё? Rвбгвбвўг?в";
        InfoAvailability = 2; // ╪ Їа иЁў ?┐ п Ё-дRа┐ жЁп Ё┐??вбп з бвЁз-R
      end;
      Comment = Comment + "\n" + AbsentFieldValuesArr[j];
      j = j + 1;
    end;

    fmreqiattach.InfoAvailability = InfoAvailability;
    fmreqiattach.AttachFileCreateDate = AttachFileCreateDate;
    fmreqiattach.AttachFileCreateTime = AttachFileCreateTime;
    fmreqiattach.AttachFileName = AttachFileName;
    if ( ( fmreqiattach.AvailComment != "" ) and ( Comment != "" ) )
      fmreqiattach.AvailComment = fmreqiattach.AvailComment + "\n" + Comment;
    end;

    ReadFileToString( ExtractXMLFileName, tostring );
    AttachBody = tostring;
  end;

  return stat;
end;

macro currencyReestrExtract( fm_reqiattach, AttachBody:@string, IsInfoAbsent:@bool )

  var xmlDoc;
  var InfoAvailability = 1; // Запрашиваемая информация имеется в полном объёме.
  var AttachFileCreateDate = Date();
  var AttachFileCreateTime = Time();
  var AttachFileName;
  var Comment = "";
  var tostring = "";
  var j = 0;
  var stat = 0;

  setbuff( fmreqiattach, fm_reqiattach );

  IsInfoAbsent = FALSE;

  if ( fmreqiattach.PeriodDateBegin != Date(0,0,0) )
    gPeriodDateBegin = fmreqiattach.PeriodDateBegin;
  end;

  if ( fmreqiattach.PeriodDateEnd != Date(0,0,0) )
    gPeriodDateEnd = fmreqiattach.PeriodDateEnd;
  end;

  if ( gPeriodDateBegin > gPeriodDateEnd )
    MsgBox( cMsgDate );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgDate;
    AttachBody = cMsgDate;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( ( stat == 0 )  AND ( NOT _GetBuffers( fmreqiattach ) ) )
    stat = 26249;
  end;

  if ( ( stat == 0 )  AND  ( fmrequestinfo.ClientID <= 0 ) )
    MsgBox( cMsgNoAC );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgNoAC;
    AttachBody = cMsgNoAC;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( stat == 0 )
    if ( fmrequestinfo.SourceDprt != 0 )
      gSourceDprt = fmrequestinfo.SourceDprt;
    end;
    _makeListDP( gSourceDprt, fmrequestinfo.ChildDprtInc );

    AttachFileName = FM_GetReqAttachName( fmreqiattach, "xml" );
    
    ExtractXMLFileName = "..\\workfile\\getattach_fmreq_" + _ПолучитьВременноеИмяФайла( fmreqiattach, "xml" );
    
    if ( open ( ExtractXMLFile, ExtractXMLFileName, "utf8" ) )
      _CreateExtractXMLFile_Exchange();
      close(ExtractXMLFile);
    else
      stat = 1;
    end;

    if(stat == 0)
      xmlDoc = CreateXMLParser();
      xmlDoc.async = false;
      xmlDoc.load( ExtractXMLFileName );

      _AddUserValueByRegistry( xmlDoc );

      xmlDoc.save( ExtractXMLFileName );
      xmlDoc = null;
    end;
  end;

  if ( stat == 0 )
    j = 0;
    while ( j < AbsentFieldValuesArr.size )
      if ( j == 0 )
        Comment = "╪- з?-Ё? Rвбгвбвўг?в";
        InfoAvailability = 2; // ╪ Їа иЁў ?┐ п Ё-дRа┐ жЁп Ё┐??вбп з бвЁз-R
      end;
      Comment = Comment + "\n" + AbsentFieldValuesArr[j];
      j = j + 1;
    end;

    fmreqiattach.InfoAvailability = InfoAvailability;
    fmreqiattach.AttachFileCreateDate = AttachFileCreateDate;
    fmreqiattach.AttachFileCreateTime = AttachFileCreateTime;
    fmreqiattach.AttachFileName = AttachFileName;
    if ( ( fmreqiattach.AvailComment != "" ) and ( Comment != "" ) )
      fmreqiattach.AvailComment = fmreqiattach.AvailComment + "\n" + Comment;
    end;

    ReadFileToString( ExtractXMLFileName, tostring );
    AttachBody = tostring;
  end;

  return stat;
end;

//
//  Показатели НаимПП и ФИОПП.
//
private macro _Attr_Name_FIO( _isWithdraw, _crAcc, _dbAcc, _Name, _payName, _recName )
  var vAcc, vName, vNameFIO, vFlagName = TRUE;
  if ( _isWithdraw )
    vAcc = _dbAcc;
    vName = _recName;
  else
    vAcc = _crAcc;
    vName = _payName;
  end;
  if ( ( SubStr( vAcc, 1, 3 ) == "423" )    OR
       ( SubStr( vAcc, 1, 3 ) == "426" )    OR
       ( SubStr( vAcc, 1, 5 ) == "40817" )  OR
       ( SubStr( vAcc, 1, 5 ) == "40820" ) )
    vFlagName = FALSE;
  end;
  if ( vFlagName )
    if ( StrLen( vName ) > 1 )
      vNameFIO = vName;
    else
      vNameFIO = _Name;
    end;
    ExtractXMLFile.str = "НаимПП:" + vNameFIO;
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ФИОПП:"  + vNameFIO;
    insert( ExtractXMLFile );
  end;
end;

//
//  Реквизиты банка плательщика/получателя денежных средств из DTEMPORARYPARTY_DBT.
//
private macro _BankTempInfo( _BankID )
  var cmd, rs;
  cmd = RsdCommand( "SELECT TP.T_NAME as bName, TP.T_BANKCODE as bCode " +
                    "FROM DTEMPORARYPARTY_DBT TP " +
                    "WHERE TP.T_TEMPPARTYID = ?" );
  cmd.addParam( "id", RSDBP_IN );
  cmd.value( "id" ) = _BankID;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    ExtractXMLFile.str = "НаимБП:" + Trim( String( rs.value( "bName" ) ) );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "БИКБП:" + Trim( String( rs.value( "bCode" ) ) );
    insert( ExtractXMLFile );
  end;
end;

//
//  Реквизиты плательщика/получателя денежных средств из DTEMPORARYPARTY_DBT.
//
private macro _ClientTempInfo( _ClientID, _isWithdraw, _crAcc, _dbAcc, _payName, _recName )
  var cmd, rs;
  cmd = RsdCommand( "SELECT TP.T_NAME as bName, TP.T_INN as bINN, TP.T_KPP as bKPP " +
                    "FROM DTEMPORARYPARTY_DBT TP " +
                    "WHERE TP.T_TEMPPARTYID = ?" );
  cmd.addParam( "id", RSDBP_IN );
  cmd.value( "id" ) = _ClientID;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    _Attr_Name_FIO( _isWithdraw, _crAcc, _dbAcc, Trim( String( rs.value( "bName" ) ) ), _payName, _recName );
    ExtractXMLFile.str = "ИННПП:" + Trim( String( rs.value( "bINN" ) ) );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "КПППП:" + Trim( String( rs.value( "bKPP" ) ) );
    insert( ExtractXMLFile );
  end;
end;

//
//  Реквизиты банка и плательщика/получателя денежных средств.
//
private macro _AccOperPR( _isWithdraw, _payBankTId, _recBankTId, _Branch, _Curr, _payId, _payTId, _recId, _recTId, _crAcc, _dbAcc, _crSum, _dbSum, _Ground, _payName, _recName )
  var vBankID = -1, vBankMethod;
  var vClientID = -1, vClientMethod, vClient, vFullINN, vINN, vKPP;
  var vAcc = "", vDebSum = "0.00", vCredSum = "0.00";

  if ( _isWithdraw )
    vAcc = _crAcc;
    vDebSum = Trim( String( _dbSum:z ) );
    vCredSum = "0.00";
    if ( ( ValType( _recBankTId ) == V_INTEGER )  AND  ( _recBankTId > 0 ) )
      vBankID = _recBankTId;
      vBankMethod = TRUE;
    else
      vBankMethod = FALSE;
    end;
    if ( ( ValType( _recTId ) == V_INTEGER )  AND  ( _recTId > 0 ) )
      vClientID = _recTId;
      vClientMethod = TRUE;
    else
      if ( ( ValType( _recId ) == V_INTEGER )  AND  ( _recId > 0 ) )
        vClientID = _recId;
      end;
      vClientMethod = FALSE;
    end;
  else
    vAcc = _dbAcc;
    vDebSum = "0.00";
    vCredSum = Trim( String( _crSum:z ) );
    if ( ( ValType( _payBankTId ) == V_INTEGER )  AND  ( _payBankTId > 0 ) )
      vBankID = _payBankTId;
      vBankMethod = TRUE;
    else
      vBankMethod = FALSE;
    end;
    if ( ( ValType( _payTId ) == V_INTEGER )  AND  ( _payTId > 0 ) )
      vClientID = _payTId;
      vClientMethod = TRUE;
    else
      if ( ( ValType( _payId ) == V_INTEGER )  AND  ( _payId > 0 ) )
        vClientID = _payId;
      end;
      vClientMethod = FALSE;
    end;
  end;

  if ( vBankMethod )
    _BankTempInfo( vBankID );
  else
    if ( ( ValType( _Branch ) == V_INTEGER )  AND  ( _Branch > 0 )  AND  ( ValType( _Curr ) == V_INTEGER ) )
      _BankInfo( _Branch, _Curr );
      ExtractXMLFile.str = "НаимБП:" + Trim( gDetalItem.BankName );
      insert( ExtractXMLFile );
      ExtractXMLFile.str = "БИКБП:" + Trim( gDetalItem.BankCode );
      insert( ExtractXMLFile );
    else
      ExtractXMLFile.str = "НаимБП:";
      insert( ExtractXMLFile );
      ExtractXMLFile.str = "БИКБП:";
      insert( ExtractXMLFile );
    end;
  end;

  if ( vClientMethod )
    _ClientTempInfo( vClientID, _isWithdraw, _crAcc, _dbAcc, _payName, _recName );
  else
    if ( vClientID > 0 )
      vClient = RsbParty( vClientID );
      _Attr_Name_FIO( _isWithdraw, _crAcc, _dbAcc, Trim( vClient.FullName ), _payName, _recName );
      vFullINN = GetPartyINN( vClientID, 1 );
      SplitFullINN( vFullINN, vINN, vKPP );
      ExtractXMLFile.str = "ИННПП:" + Trim( vINN );
      insert( ExtractXMLFile );
      ExtractXMLFile.str = "КПППП:" + Trim( vKPP );
      insert( ExtractXMLFile );
    else 
      ExtractXMLFile.str = "НаимПП:";
      insert( ExtractXMLFile );
      ExtractXMLFile.str = "ФИОПП:";
      insert( ExtractXMLFile );
      ExtractXMLFile.str = "ИННПП:";
      insert( ExtractXMLFile );
      ExtractXMLFile.str = "КПППП:";
      insert( ExtractXMLFile );
    end;
  end;

  ExtractXMLFile.str = "НомСчПП:" + Trim( vAcc );
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "Дебет:" + vDebSum;
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "Кредит:" + vCredSum;
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "НазнПл:" + Trim( _Ground );
  insert( ExtractXMLFile );

end;

//
//  Блок "Операции по счету".
//
private macro _AccOperationBlock( _isWithdraw, _DateOper, _KindDoc, _NumDoc, _DateDoc, _payBankTId, _recBankTId, _Branch, _CurrCode, _payId, _payTId, _recId, _recTId, 
                                  _crAcc, _dbAcc, _crSum, _dbSum, _Ground, _payName, _recName )

  ExtractXMLFile.str = "ДатаОпер:" + Trim(String(_DateOper:f));
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "ВидДок:" + _KindDoc;
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "НомДок:" + Trim(String(_NumDoc));
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "ДатаДок:" + Trim(String(_DateDoc:f));
  insert( ExtractXMLFile );

  _AccOperPR( _isWithdraw, _payBankTId, _recBankTId, _Branch, _CurrCode, _payId, _payTId, _recId, _recTId, _crAcc, _dbAcc, _crSum, _dbSum, _Ground, _payName, _recName );

  ExtractXMLFile.str = "###";
  insert( ExtractXMLFile );

end;

//
//  Операции по счету.
//
private macro _AccOperations( _ref, _acc, _curr )
  var cmd, rs;
  var isWithdraw;
  var vDate;

  cmd = RsdCommand( "SELECT RT.T_PAYERACCOUNT as payAcc, RT.T_RECEIVERACCOUNT as recAcc, RT.T_DATE as rdDate, RT.T_BRANCH as branch, " +
                           "RT.T_PAYERNAME as payName, RT.T_RECEIVERNAME as recName, " +
                           "RT.T_OPERATIONCIPHER as kindDoc, RT.T_DOCUMENTNUMBER as numDoc, RT.T_VALUEDATE as dateDoc, " +
                           "RT.T_PAYERBANKTEMPPARTYID as payBankTId, " +
                           "RT.T_RECEIVERBANKTEMPPARTYID as recBankTId, " +
                           "RT.T_PAYERPARTYID as payId, RT.T_PAYERTEMPPARTYID as payTId, " +
                           "RT.T_RECEIVERPARTYID as recId, RT.T_RECEIVERTEMPPARTYID as recTId, " +
                           "RT.T_CREDITAMOUNT as crSum, RT.T_DEBITAMOUNT as dbSum, RT.T_GROUND as grnd " +
                    "FROM DRTDOCUMENT_DBT RT " +
                    "WHERE RT.T_OPAPPLICATIONKEY IN " + 
                    "( " +
                      "SELECT SBL.T_APPLICATIONKEY1 " +
                      "FROM DSBDEPDOC_DBT SBD, DSB_CASLN_DBT SBL " +
                      "WHERE SBD.T_APPLICATIONKEY = SBL.T_APPLICATIONKEY2 AND " +
                        "SBL.T_REFVALUE2 = 0 AND " +
                        "SBD.T_REFERENC = ? AND " +
                        "SBD.T_ACTION NOT IN (2, 11) AND " +
                        "SBD.T_KINDOP NOT IN (8, 9, 14, 15, 16) AND " +
                        "SBD.T_TYPEOPER NOT IN (38, 39) AND " +
                        "SBD.T_MODE <> 2 AND " +
                        "BITAND(SBD.T_FLAGS, 131072) = 0 AND " +
                        "SBD.T_FLAGSTORN = CHR(0) AND " +
                        "SBD.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                      "GROUP BY SBL.T_APPLICATIONKEY1 " +
                    ") AND " +
                    "( " +
                      "RT.T_PAYERACCOUNT    = ? OR " +
                      "RT.T_RECEIVERACCOUNT = ? " +
                    ") " +
                    "ORDER BY RT.T_DOCUMENTID" );

  cmd.addParam( "Refr", RSDBP_IN );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );
  cmd.addParam( "Acc1", RSDBP_IN );
  cmd.addParam( "Acc2", RSDBP_IN );

  cmd.value( "Refr" ) = _ref;
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;
  cmd.value( "Acc1" ) = _acc;
  cmd.value( "Acc2" ) = _acc;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    if ( rs.value( "payAcc" ) == _acc )
      isWithdraw = TRUE;
    else
      isWithdraw = FALSE;
    end;
    if ( ( ValType( rs.value( "dateDoc" ) ) == V_DTTM )  OR  ( ValType( rs.value( "dateDoc" ) ) == V_DATE )  OR  ( ValType( rs.value( "dateDoc" ) ) == V_TIME ) )  
      vDate = Date( rs.value( "dateDoc" ) );
    else
      vDate = Date(0,0,0);
    end;
    
    _AccOperationBlock( isWithdraw, Date(rs.value( "rdDate" )), rs.value( "kindDoc" ), rs.value( "numDoc" ), vDate,
                        rs.value( "payBankTId" ), rs.value( "recBankTId" ), rs.value( "branch" ), _curr,
                        rs.value( "payId" ), rs.value( "payTId" ), rs.value( "recId" ), rs.value( "recTId" ),
                        rs.value( "payAcc" ), rs.value( "recAcc" ), rs.value( "crSum" ), rs.value( "dbSum" ), rs.value( "grnd" ), rs.value( "payName" ), rs.value( "recName" ) );
  end;
end;

// ----------------------------------------
//          Цифровой код валюты.
// ----------------------------------------
private macro _Currency_Code( pCurr )
  var rCurr = "643";
  if ( pCurr > 0 )
    tcur.Clear();
    tcur.rec.Code_Currency = pCurr;
    if ( tcur.GetEQ() )
      rCurr = tcur.rec.EXTERNALCODE;
    end;
  end;
  return rCurr;
end;

//
//  Начальный остаток по счету.
//
private macro _AccRestBegin( _ref )
  var cmd, rs;
  var vRest = $0;
  cmd = RsdCommand( "SELECT SB.T_REST as rest, SB.T_INSUM as sin, SB.T_OUTSUM as sout " +
                    "FROM DSBDEPDOC_DBT SB LEFT OUTER JOIN DRTPAYMENTPROP_DBT RTP " +
                      "ON RTP.T_DOCAPPLICATIONKIND = SB.T_IAPPLICATIONKIND AND " +
                         "RTP.T_DOCAPPLICATIONKEY = SB.T_APPLICATIONKEY " +
                    "WHERE SB.T_REFERENC = ? AND " +
                          "SB.T_ACTION NOT IN (2, 11) AND " +
                          "SB.T_KINDOP NOT IN (8, 9, 14, 15, 16) AND " +
                          "SB.T_TYPEOPER NOT IN (38, 39) AND " +
                          "SB.T_MODE <> 2 AND " +
                          "BITAND(SB.T_FLAGS, 131072) = 0 AND " +
                          "SB.T_FLAGSTORN = CHR(0) AND " +
                          "SB.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                    "ORDER BY SB.T_DATE_DOCUMENT, SB.T_NUMDAYDOC" );

  cmd.addParam( "Refr", RSDBP_IN );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );

  cmd.value( "Refr" ) = _ref;
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;

  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    if ( ValType( rs.value( "rest" ) ) == V_NUMERIC )
      vRest = Money( rs.value( "rest" ) ) - Money( rs.value( "sin" ) ) + Money( rs.value( "sout" ) );
    else
      vRest = 0.0;
    end;
  end;
  return vRest;
end;

//
//  Информация по счету.
//
private macro _AccInfo( _ref )
  var cmd, rs;
  var vRestIn = $0;
  cmd = RsdCommand( "SELECT SUM(SB.T_INSUM) as vTurnKt, SUM(SB.T_OUTSUM) as vTurnDt, SB.T_ACCOUNT as accNum, SB.T_CODE_CURRENCY as codCurr " +
                    "FROM DSBDEPDOC_DBT SB " +
                    "WHERE SB.T_REFERENC = ? AND " +
                          "SB.T_ACTION NOT IN (2, 11) AND " +
                          "SB.T_KINDOP NOT IN (8, 9, 14, 15, 16) AND " +
                          "SB.T_TYPEOPER NOT IN (38, 39) AND " +
                          "SB.T_MODE <> 2 AND " +
                          "BITAND(SB.T_FLAGS, 131072) = 0 AND " +
                          "SB.T_FLAGSTORN = CHR(0) AND " +
                          "SB.T_DATE_DOCUMENT BETWEEN ? AND ? " +
                    "GROUP BY SB.T_ACCOUNT, SB.T_CODE_CURRENCY " );

  cmd.addParam( "Refr", RSDBP_IN );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );

  cmd.value( "Refr" ) = _ref;
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )

    vRestIn = _AccRestBegin( _ref );

    ExtractXMLFile.str = "НомСч:" + String(rs.value( "accNum" ));
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ВалСч:" + _Currency_Code( Int(rs.value("codCurr")));
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ДатаНачала:" + Trim(String( gPeriodDateBegin:z ));
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ДатаКонца:" + Trim(String( gPeriodDateEnd:z ));
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ОстатНач:" + String( vRestIn );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "СуммаДеб:" + String( Money(rs.value( "vTurnDt" )) );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "СуммаКред:" + String( Money(rs.value( "vTurnKt" )) );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ОстатКон:" + String( vRestIn - Money(rs.value( "vTurnDt" )) + Money(rs.value( "vTurnKt" )) );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "###";
    insert( ExtractXMLFile );
  end;
end;

//
//  Выбираются заданный счет клиента.
//
private macro _DeposAcc()
  var cmd, rs;
  cmd = RsdCommand( "SELECT t_Referenc as ref, t_CodClient as clnt, t_Account as acc, t_Type_Account as kind, T_CODE_CURRENCY as curr " +
                    "FROM DDEPOSITR_DBT " +
                    "WHERE T_ACCOUNT = ? AND " +
                          "T_CODCLIENT = ? AND " +
                          "T_FNCASH IN " + gStrListDP + " AND " +
                          "( T_CLOSE_DATE = " + sqlDateToStr( Date(0,0,0) ) + " OR " +
                          "T_CLOSE_DATE >= ? ) AND " +
                          "T_OPEN_DATE <= ? " +
                    "ORDER BY T_REFERENC" );

  cmd.addParam( "Accn", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );

  cmd.value( "Accn" ) = fmreqiattach.Account;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;

  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    _AccInfo( Int( rs.value( "ref" ) ) );
    _AccOperations( Int( rs.value( "ref" ) ), String( rs.value( "acc" ) ), Int( rs.value( "curr" ) ) );
  end;
end;

//
//  Выбираются все счета клиента.
//
private macro _DeposAll()
  var cmd, rs;
  cmd = RsdCommand( "SELECT t_Referenc as ref, t_CodClient as clnt, t_Account as acc, t_Type_Account as kind, T_CODE_CURRENCY as curr " +
                    "FROM DDEPOSITR_DBT " +
                    "WHERE T_CODCLIENT = ? AND " +
                          "T_FNCASH IN " + gStrListDP + " AND " +
                          "( T_CLOSE_DATE = " + sqlDateToStr( Date(0,0,0) ) + " OR " +
                          "T_CLOSE_DATE >= ? ) AND " +
                          "T_OPEN_DATE <= ? " +
                    "ORDER BY T_REFERENC" );

  cmd.addParam( "Clnt", RSDBP_IN );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );

  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;

  cmd.execute;
  rs = RsdRecordset( cmd );
  while ( rs.moveNext )
    _AccInfo( Int( rs.value( "ref" ) ) );
    _AccOperations( Int( rs.value( "ref" ) ), String( rs.value( "acc" ) ), Int( rs.value( "curr" ) ) );
  end;
end;

//
//   Атрибуты операциониста, выпускающего выписку.
//
private macro _DeposOper()
  var cmd, rs;
  var vPhone = "", vPost = "", vFamilie = "";
  cmd = RsdCommand( "select o.t_PhoneNumber as phone, o.t_Post as post, p.t_Name1 as fam " +
                    "from dofficer_dbt o, dpersn_dbt p " +
                    "where p.t_PersonID = o.t_PersonID AND " +
                          "o.t_PartyID = ? AND " + 
                          "o.t_PersonID = ( select t_PartyID " +
                                           "from dperson_dbt " +
                                           "where t_Oper = ? )" );

  cmd.addParam( "prt", RSDBP_IN );
  cmd.addParam( "opr", RSDBP_IN );
  cmd.value( "prt" ) = {ourBank};
  cmd.value( "opr" ) = {oper};
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    vPhone   = String( rs.value( "phone" ) );
    vPost    = String( rs.value( "post" ) );
    vFamilie = String( rs.value( "fam" ) );
    ExtractXMLFile.str = "ТелОтпр:"   + vPhone;
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ДолжнОтпр:" + vPost;
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "ФамОтпр:"   + vFamilie;
    insert( ExtractXMLFile );
  end;
end;

//
//   Указатель на банк, в котором работаем.
//
private macro _BankID()
  var cmd, rs;
  var vBankID = -1, vErr = -1;
  cmd = RsdCommand( "select dp.t_PartyID as bankid, bnk.t_name as bankname " +
                    "from ddp_dep_dbt dp, dparty_dbt bnk " +
                    "where dp.t_Code = ? AND " +
                          "bnk.t_PartyID = dp.t_PartyID" );

  cmd.addParam( "dprt", RSDBP_IN );
  cmd.value( "dprt" ) = fmrequestinfo.SourceDprt;
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    vBankID = Int( rs.value( "bankid" ) );
    gBankName = String( rs.value( "bankname" ) );
    gBankBIC = ПолучитьКодСубъекта( vBankID, PTCK_BIC, vErr );
    if ( vErr )
      gBankBIC = "";
    end;
  end;
  return vBankID;
end;

//
//   Должность операциониста, выпускающего выписку.
//
private macro _OperPost()
  var cmd, rs;
  var vPost = "";
  cmd = RsdCommand( "SELECT TP.T_NAME_TYPE as post " +
                    "FROM DTYPEAC_DBT TP, DPERSON_DBT PN " +
                    "WHERE PN.T_OPER = ? AND " +
                          "TP.T_INUMTYPE = 14 AND " +
                          "TP.T_TYPE_ACCOUNT = PN.T_CTYPEPERSON " );

  cmd.addParam( "opr", RSDBP_IN );
  cmd.value( "opr" ) = {oper};
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    vPost = String( rs.value( "post" ) );
  end;
  return vPost;
end;

//
//   Выписка по вкладным счетам.
//
private macro _DeposExtract()

  var vSeq = "-1";
  var vBankID = -1;
  var vFullINN = "";
  var vINN = "";

  // Служебная часть.
  ExtractXMLFile.str = "ИдФайл:<!--~`#1-->";
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "ТипИнф:ОПЕРАЦИИПОСЧ";
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "ВерсПрог:RS-Bank V.6";
  insert( ExtractXMLFile );
  _DeposOper();
  ExtractXMLFile.str = "КолДок:1";
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "ВерсФорм:2.01";
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "###";
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "@@@";  // Конец фрагмента.
  insert( ExtractXMLFile );

  // Заголовок инф.части = Блок "Выписка по операциям на счете (счетах)".
  ExtractXMLFile.str = "ИдДок:" + createGUID();
  insert( ExtractXMLFile );

  var stat = GetSequenceValue( 238, vSeq, {curdate} );

  if ( stat != 0 )
    MsgBox( "Произошла ошибка ", stat, " при получении референса \"Номера выписок для ФМ\"." );
    MemoryError( stat );
    DisplayError();
  end;

  ExtractXMLFile.str = "НомВыпис:" + vSeq;
  insert( ExtractXMLFile );
  vBankID = _BankID();
  if ( vBankID < 0 )
    MsgBox( "Ошибка при определении идентификатора банка в ddp_dep_dbt." );
  else
    vFullINN = GetPartyINN( vBankID, 1 );
    ExtractXMLFile.str = "ИННКО:" + _getINN( vFullINN );
    insert( ExtractXMLFile );
    ExtractXMLFile.str = "КППКО:" + _getKPP( vFullINN );
    insert( ExtractXMLFile );
  end;
  ExtractXMLFile.str = "БИК:" + gBankBIC;
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "НаимКО:" + gBankName;
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "НомФ:0";
  insert( ExtractXMLFile );
  vFullINN = GetPartyINN( fmrequestinfo.ClientID, 1 );
  vINN = _getINN( vFullINN );
  ExtractXMLFile.str = "ИНННП:" + vINN;
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "КППНП:" + _getKPP( vFullINN );
  insert( ExtractXMLFile );
  if ( ( StrLen( vINN ) == 5 )  OR ( StrLen( vINN ) == 10 ) )
    ExtractXMLFile.str = "НаимНП:";
    insert( ExtractXMLFile );
  end;
  if ( StrLen( vINN ) == 12 )
    persn.rec.PersonID = fmrequestinfo.ClientID;
    if ( GetEQ( persn ) )
      ExtractXMLFile.str = "ФИОИП:" + persn.rec.Name1 + "," + persn.rec.Name2 + "," + persn.rec.Name3;
      insert( ExtractXMLFile );
    end;
  end;
  ExtractXMLFile.str = "ДолжнПрБ:" + _OperPost();
  insert( ExtractXMLFile );
  person.rec.Oper = {oper};
  if ( GetEQ( person ) )
    ExtractXMLFile.str = "ФИОПрБ:" + person.rec.Name;
    insert( ExtractXMLFile );
  end;
  ExtractXMLFile.str = "ДатаСправ:" + String( {curdate} );
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "ДатаСооб:" + String( Date() );
  insert( ExtractXMLFile );
  ExtractXMLFile.str = "###";
  insert( ExtractXMLFile );

  // Информационная часть.
  if ( StrLen( fmreqiattach.Account ) > 1 )
    _DeposAcc();
  else
    _DeposAll();
  end;

  ExtractXMLFile.str = "@@@";  // Конец фрагмента.
  insert( ExtractXMLFile );
  // Разделитель: конец файла.
  ExtractXMLFile.str = "===";
  insert( ExtractXMLFile );

end;

//
//  Проверка: субъект является владельцем вкладного счета?
//
private macro _isAccClient()
  var cmd, rs;
  var stat = FALSE;
  cmd = RsdCommand( "SELECT t_Referenc " +
                    "FROM DDEPOSITR_DBT " +
                    "WHERE T_ACCOUNT = ? AND " +
                          "T_CODCLIENT = ?" );

  cmd.addParam( "Accn", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );

  cmd.value( "Accn" ) = fmreqiattach.Account;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;

  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    stat = TRUE;
  end;
  return stat;
end;

//
//  Проверка: вкладной счет был открыт в заданном периоде?
//
private macro _isAccOpen()
  var cmd, rs;
  var stat = FALSE;
  cmd = RsdCommand( "SELECT t_Referenc " +
                    "FROM DDEPOSITR_DBT " +
                    "WHERE T_ACCOUNT = ? AND " +
                          "T_CODCLIENT = ? AND " +
                          "( T_CLOSE_DATE = " + sqlDateToStr( Date(0,0,0) ) + " OR " +
                          "T_CLOSE_DATE >= ? ) AND " +
                          "T_OPEN_DATE <= ? " +
                    "ORDER BY T_REFERENC" );

  cmd.addParam( "Accn", RSDBP_IN );
  cmd.addParam( "Clnt", RSDBP_IN );
  cmd.addParam( "dBeg", RSDBP_IN );
  cmd.addParam( "dEnd", RSDBP_IN );

  cmd.value( "Accn" ) = fmreqiattach.Account;
  cmd.value( "Clnt" ) = fmrequestinfo.ClientID;
  cmd.value( "dBeg" ) = gPeriodDateBegin;
  cmd.value( "dEnd" ) = gPeriodDateEnd;

  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    stat = TRUE;
  end;
  return stat;
end;

//
// Выписка ФСФМ по вкладным счетам.
//
macro AccountOperations( fm_reqiattach, AttachBody:@string, IsInfoAbsent:@bool )

  var xmlDoc;
  var InfoAvailability = 1; // Запрашиваемая информация имеется в полном объёме.
  var AttachFileCreateDate = Date();
  var AttachFileCreateTime = Time();
  var AttachFileName;
  var Comment = "";
  var tostring = "";
  var j = 0;
  var stat = 0;

  setbuff( fmreqiattach, fm_reqiattach );

  IsInfoAbsent = FALSE;

  if ( fmreqiattach.PeriodDateBegin != Date(0,0,0) )
    gPeriodDateBegin = fmreqiattach.PeriodDateBegin;
  end;

  if ( fmreqiattach.PeriodDateEnd != Date(0,0,0) )
    gPeriodDateEnd = fmreqiattach.PeriodDateEnd;
  end;

  if ( gPeriodDateBegin > gPeriodDateEnd )
    MsgBox( cMsgDate );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgDate;
    AttachBody = cMsgDate;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( ( stat == 0 )  AND ( NOT _GetBuffers( fmreqiattach ) ) )
    stat = 26249;
  end;

  if ( ( stat == 0 )  AND  ( fmrequestinfo.ClientID <= 0 ) )
    MsgBox( cMsgNoAC );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgNoAC;
    AttachBody = cMsgNoAC;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( ( stat == 0 )  AND  ( StrLen( fmreqiattach.Account ) > 1 )  AND  ( NOT _isAccClient() ) )
    MsgBox( cMsgClnt );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgClnt;
    AttachBody = cMsgClnt;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( ( stat == 0 )  AND  ( StrLen( fmreqiattach.Account ) > 1 )  AND  ( NOT _isAccOpen() ) )
    MsgBox( cMsgOpen );
    fmreqiattach.InfoAvailability = 0;
    fmreqiattach.AvailComment = cMsgOpen;
    AttachBody = cMsgOpen;
    IsInfoAbsent = TRUE;
    stat = -777;
  end;

  if ( stat == 0 )
    if ( fmrequestinfo.SourceDprt != 0 )
      gSourceDprt = fmrequestinfo.SourceDprt;
    end;
    _makeListDP( gSourceDprt, fmrequestinfo.ChildDprtInc );

    AttachFileName = FM_GetReqAttachName( fmreqiattach, "txt" );
    
    ExtractXMLFileName = "..\\workfile\\getattach_fmreq_" + _ПолучитьВременноеИмяФайла( fmreqiattach, "txt" );

    if ( open ( ExtractXMLFile, ExtractXMLFileName, "rsoem" ) )
      _DeposExtract();
      close(ExtractXMLFile);
    else
      stat = 1;
    end;
  end;

  if ( stat == 0 )
    j = 0;
    while ( j < AbsentFieldValuesArr.size )
      if ( j == 0 )
        Comment = "╪- з?-Ё? Rвбгвбвўг?в";
        InfoAvailability = 2; // ╪ Їа иЁў ?┐ п Ё-дRа┐ жЁп Ё┐??вбп з бвЁз-R
      end;
      Comment = Comment + "\n" + AbsentFieldValuesArr[j];
      j = j + 1;
    end;

    fmreqiattach.InfoAvailability = InfoAvailability;
    fmreqiattach.AttachFileCreateDate = AttachFileCreateDate;
    fmreqiattach.AttachFileCreateTime = AttachFileCreateTime;
    fmreqiattach.AttachFileName = AttachFileName;
    if ( ( fmreqiattach.AvailComment != "" ) and ( Comment != "" ) )
      fmreqiattach.AvailComment = fmreqiattach.AvailComment + "\n" + Comment;
    end;

    ReadFileToString( ExtractXMLFileName, tostring );
    AttachBody = tostring;
  end;

  return stat;
end;

// moneyTransfersNonAccount( "fmrqa", "AttachBody" );
// electronicFundsTransfers( "fmrqa", "AttachBody" );
// currencyReestrExtract( "fmrqa", "AttachBody" );
