import activex, oralib, likepy, globals;
import func_lib;

//Вынесено для дальнейшего удаления файла
private var TermPath = GetCurDir(true) + "\\Import";
private var FileName;

// поиск ЕД БО по номеру и клиенту, чтобы задействовать индекс
private macro FindDlContrByNumber( p_cntr_num)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid dl_id, cntr.t_partyid"+
             " FROM dsfcontr_dbt cntr, "+
             "      ddlcontr_dbt dl "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND cntr.t_number = :p_cntr_num "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_cntr_num", RSDBP_IN, p_cntr_num);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_partyid");
   end;
   
   return res;
end;



private macro SelectAndOpenFile ()
  var FullNameFile, ExtName, DirName;

  /*Выбираем файл для обработки*/
  if(not SelectFile(FullNameFile, "$\\..\\..\\import\\*.xls*", "Выберите файл для загрузки", 0, true))
    MsgBox("Отказ от загрузки");
    return null;
  end;

  //Отделяем путь файла от имени
  splitfile(FullNameFile, FileName, ExtName);
  FileName = FileName + ExtName;
  DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

  TermPath = DirName;

/*  if (not copyfile("$" + DirName + FileName, "$" + TermPath + "\\" + FileName) )
    MsgBox("Ошибка при передаче файла на терминал");
    //msgbox(string("$" + DirName + FileName) +"|"+string(TermPath + "\\" + FileName));
    return null;
  end; */

  BegAction(1, "Обработка файла \\" + TermPath + "\\" + FileName + "\". Ждите...");

  if(not OpenExcelFile(FileName, false, true, TermPath))
    MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
    EndAction(1);
    return null;
  end;

  return ExcelApplication.Sheets(1);
End;

macro LoadFile()
   var sheet;
   var col = 1;
   var row = 2;
   var sql_str, cmd, rs;
   var ContractNumber, EKK, PhoneNumber, partyid, partyid_found;
   var res;
   var stat = false;
   var recid;

   sheet = SelectAndOpenFile();
   if (valtype(sheet) == V_UNDEF) 
     return;
   end;
   

   rslDefCon.beginTrans();
   while (valtype(sheet.cells(row, col).value) != V_UNDEF)
      ContractNumber = sheet.cells(row, 1).value;
      EKK = sheet.cells(row, 2).value;
      PhoneNumber = sheet.cells(row, 6).value;

      if (StrLen(PhoneNumber) > 0)
         stat = true;
      else
         res = "Пустой телефон";
      end;
      
      if (stat)
         partyid = FindDlContrByNumber( ContractNumber );
         if (partyid == -1)
            res = "Договор не найден";
         else
            stat = true;
         end;
      end;
      
      if (stat)
         recid = -1;
         sql_str = " select t_recid from dcontact_dbt where t_partyid = :partyid and t_addresstype in (0,1) and t_contactkind = 1 and t_contacttype = 1 order by 1 desc";
         cmd = RSDCommand(sql_str);
         cmd.AddParam("partyid", RSDBP_IN, partyid);
         rs = RSDRecordSet(cmd);
         if (rs.movenext)
            recid = rs.value("t_recid");
         end;
         cmd.close; rs.close;
         
         if (recid > 0)
            sql_str = "update dcontact_dbt set t_value = :phone where t_recid = :recid";
            cmd = RSDCommand(sql_str);
            cmd.AddParam("phone", RSDBP_IN, PhoneNumber);
            cmd.AddParam("recid", RSDBP_IN, recid);
            cmd.execute;
            cmd.close;
         else
            sql_str = "insert into dcontact_dbt(t_recid, t_partyid, t_addresstype, t_contactkind, t_contacttype, t_provider, t_value, t_note, t_ismain) "+
                      " values (0, :partyid, 1, 1, 1, chr(1), :value, chr(1), 'X')";
            cmd = RSDCommand(sql_str);
            cmd.AddParam("partyid", RSDBP_IN, partyid);
            cmd.AddParam("value", RSDBP_IN, PhoneNumber);
            cmd.execute;
            cmd.close;
         end;
         res = "OK";
      end;
      
      [####################| ########## : #](ContractNumber, partyid, res);

      row = row + 1;
   end;

   rslDefCon.commitTrans();
   ExcelApplication.ActiveWorkbook.Close;

   EndAction(1);

onerror()
   if (valtype(ExcelApplication) != V_UNDEF)
     ExcelApplication.ActiveWorkbook.Close;
   end;
   if ( rslDefCon.isInTrans() )
     rslDefCon.rollbackTrans();
   end;
   EndAction(1);
End;



LoadFile();

