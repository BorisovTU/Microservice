/*
$Name: resrep2.mac
$Module: Касса
$Description: Ф. 25-в
*/

/* закомментировано при удалении таблицы ddesk_rec_dbt по ##197859, 198467 */
/*
import BankInter, deprintr, ChkPrn, Stat_Tot, ResComm, Res2_Out;

macro ReportOnCurVFResource;

  var
    PrevRest=$0, IPrevRest = 0,
    CurRest=$0, ICurRest = 0,
    Deb=$0, IDeb = 0,
    Cred=$0,ICred = 0,  
    OtherDeb=$0, IOtherDeb = 0,
    OtherCred=$0, IOtherCred = 0;

  if ( CashVal.rec.Type == TYPE_RES_NOPAY )
    return;
  end;

  CalcTurns(CashVal.rec.RefValue, Cred, ICred, Deb, IDeb);
  CalcOtherTurns(CashVal.rec.RefValue,OtherCred, IOtherCred, OtherDeb, IOtherDeb);

  CashAcc.addFilter("t.t_Branch = " + string( Branch ) +
		     " and t.t_CashOper = " + Safe + 
		     " and t.t_RefValue = " + string( CashVal.rec.RefValue ) );
  CashAcc.KeyNum = 2;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetLT and
    (CashAcc.rec.Branch==Branch) and
    (CashAcc.rec.RefValue==CashVal.rec.RefValue) and
    (CashAcc.rec.CashOper==Safe))
    IPrevRest=CashAcc.rec.RestCol;
    if ( CashAcc.rec.RestMoney )
      PrevRest = CashAcc.rec.RestMoney;
    else
      PrevRest = Pieces2Money( CashVal.rec.TypeValue, CashVal.rec.CodIntValue, CashVal.rec.Type, CashAcc.rec.RestCol );
    end;
  end;
  CashAcc.dropFilter;

  CashAcc.KeyNum = 1;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    ICurRest=CashAcc.rec.RestCol;
    if ( CashAcc.rec.RestMoney )
      CurRest = CashAcc.rec.RestMoney;
    else
      CurRest = Pieces2Money( CashVal.rec.TypeValue, CashVal.rec.CodIntValue, CashVal.rec.Type, CashAcc.rec.RestCol );
    end;
  end;

  if ( Mode )
    PrevRest = CurRest;
    Deb = Cred = OtherDeb = OtherCred = $0;
    IPrevRest = ICurRest =
    IDeb = ICred = IOtherDeb = IOtherCred = 0;
  end;

  OutVFLine(GetValName,PrevRest,IPrevRest,CurRest,ICurRest,Cred,ICred,OtherCred,IOtherCred,Deb,IDeb,OtherDeb,IOtherDeb);
end;

macro ReportOnVFResources;

  CashVal.rec.FlagIntoBalance = 3;

  CashVal.addFilter("t.t_FlagIntoBalance = 3");
  OutVFHeader;

  if(CashVal.GetGE and ( CashVal.rec.FlagIntoBalance == 3 ) )
    if(CashVal.rec.RefValueReport!=0)
      ReportOnCurVFResource;
    end;
    while(CashVal.Next and ( CashVal.rec.FlagIntoBalance == 3 ) )
      if(CashVal.rec.RefValueReport!=0)
        ReportOnCurVFResource;
      end;
    end;
  end;
  CashVal.dropFilter;

  OutVFTotLine;
end;

macro ReportOnCurCrResource;

  var
    PrevRest=$0,
    CurRest=$0,
    Deb=$0,
    Cred=$0,
    OtherDeb=$0,
    OtherCred=$0;

  Currency.Code_Currency=CashVal.rec.CodIntValue;
  if(not GetEQ(Currency))
    ClearRecord(Currency);
    Currency.Name_Currency="не найдена";
  end;

  CalcOtherTurns(CashVal.rec.RefValue,OtherCred,null,OtherDeb,null);

  CashAcc.addFilter("t.t_Branch = " + string( Branch ) +
		    " and t.t_CashOper = " + Safe + 
		    " and t.t_RefValue = " + string( CashVal.rec.RefValue ) );
  CashAcc.KeyNum = 2;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetLT and
    (CashAcc.rec.Branch==Branch) and
    (CashAcc.rec.RefValue==CashVal.rec.RefValue) and
    (CashAcc.rec.CashOper==Safe))
    PrevRest=CashAcc.rec.RestMoney;
  end;
  CashAcc.dropFilter;

  CashAcc.KeyNum = 1;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    CurRest=CashAcc.rec.RestMoney;
  end;

  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper="Инкассация";
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    Cred=CashAcc.rec.DebMoney;
    Deb=CashAcc.rec.KredMoney;
  end;

  if ( Mode )
    PrevRest = CurRest;
    Deb = Cred = OtherDeb = OtherCred = $0;
  end;

  OutCrLine(PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
end;

macro ReportOnCrResources;

  var
    SK = CashVal.KeyNum;

  CashVal.KeyNum = 3;
  CashVal.rec.Type = 0;
  CashVal.rec.TypeValue=CV_Currency;
  CashVal.rec.CodIntValue=0;
  CashVal.addFilter("t.t_Type = 0" + 
		    " and t.t_TypeValue = " + string(CV_Currency) );
  OutCrHeader;

  if(CashVal.GetGE and (CashVal.rec.Type==0) and (CashVal.rec.TypeValue==CV_Currency))
    if(CashVal.rec.CodIntValue!=0)
      ReportOnCurCrResource;
    end;
    while(CashVal.Next and (CashVal.rec.Type==0) and (CashVal.rec.TypeValue==CV_Currency))
      ReportOnCurCrResource;
    end;
  end;
  CashVal.dropFilter;

  CashVal.KeyNum = SK;

  /*OutCrTotLine;*/
end;

var
  IsFirst;

macro ReportOnCurDepType (FlagRez, TypeReport)

  record TmpStat("sb_depst.dbt");

  DepStat.rec.FNCash  = Branch;
  DepStat.rec.IsCur   = 1;
  DepStat.rec.Kind    = DepType.Kind;
  DepStat.rec.CodCur  = Currency.Code_Currency;
  DepStat.rec.FlagRez = FlagRez;
  DepStat.rec.Date    = {curdate};
  DepStat.rec.Mode    = Mode;
  DepStat.addFilter("t.t_FNCash = " + string(Branch) +
		    " and t.t_IsCur = 1" + 
		    " and t.t_Kind = " + string(DepType.Kind) + 
		    " and t.t_CodCur = " + string(Currency.Code_Currency) +
		    " and t.t_FlagRez = " + string(FlagRez) );

  if(not (DepStat.GetLE
     and (DepStat.rec.FNCash==Branch)
     and (DepStat.rec.IsCur==1)
     and (DepStat.rec.Kind==DepType.Kind)
     and (DepStat.rec.CodCur==Currency.Code_Currency)
     and (DepStat.rec.FlagRez==FlagRez)))
    DepStat.dropFilter;
    return ;
  end;

  if (IsFirst)
    IsFirst=false;
    if (TypeReport == 0)
      OutDepSubHead();
    else
      OutStatHead2();
    end;
  end;

  if( ( DepStat.rec.Date=={curdate} ) and ( DepStat.rec.Mode == Mode ) )
    Copy(TmpStat,DepStat.rec);
    if(DepStat.Prev
      and (DepStat.rec.FNCash==Branch)
      and (DepStat.rec.IsCur==1)
      and (DepStat.rec.Kind==DepType.Kind)
      and (DepStat.rec.CodCur==Currency.Code_Currency)
      and (DepStat.rec.FlagRez==FlagRez)              )
      Copy(PrevStat,DepStat.rec);
      Copy(DepStat.rec,TmpStat);
    else
      ClearRecord(PrevStat);
      Copy(DepStat.rec,TmpStat);
    end;
  else
    Copy(PrevStat,DepStat.rec);
    DepStat.rec.CurOpenAc=0;
    DepStat.rec.CurClosAc=0;
    DepStat.rec.DebSum=0;
    DepStat.rec.KredSum=0;
    DepStat.rec.EstimIn      = 0;
    DepStat.rec.EstimOut     = 0;
    DepStat.rec.EstimOverOut = 0;
  end;

  if (TypeReport == 0)
    OutDepLine();
  else
    OutDepLine2();
  end;
  DepStat.dropFilter;
end;


macro ZeroStatTotals

  TotPrevRestC=$0;
  TotCreditC=$0;
  TotDebetC=$0;
  TotRestC=$0;
  TotPrevAcc=0;
  TotAcc=0;
  TotOpenedAcc=0;
  TotClosedAcc=0;

  TotPrevEstimRest = $0L;
  TotEstimIn       = $0L;
  TotEstinOut      = $0L;
  TotEstimOverOut  = $0L;
  TotEstimRest     = $0L;

  WasPrintEstim = FALSE;

end;

macro ReportOnDepTypesForCurCurrency (ABalAcc)

  var i;
  var stat;
  var flag = FALSE;

  ZeroStatTotals;
  IsFirst=true;
  WasPrintCurr = FALSE;

  i = 0;
  while (i < ASize(ABalAcc))
    /* Сначала идем для резидентов */
    KeyNum(DepType,4);
    DepType.FlagCur = 1;
    DepType.BalAcc  = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur == 1         ) AND
          (DepType.BalAcc  == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(0),0);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    /* Потом идем для нерезидентов */
    KeyNum(DepType,5);
    DepType.FlagCur      = 1;
    DepType.BalAccNotRez = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur      == 1         ) AND
          (DepType.BalAccNotRez == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(1),0);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    i = i + 1;
  end;

  if (IsFirst == false)
    OutStatTotals();
    WasPrintCurr = TRUE;
    flag = TRUE;
  end;
          
  if ( flag )
    PrintLn;
    PrintLn;
    OutBottom;
    PrintLn( StrFor( 12 ) );
  end;

  /* Отчет по наращенным процентам */
  IsFirst = TRUE;
  flag = false;
  i = 0;
  while (i < ASize(ABalAcc))
    BAPrevEstimRest = $0L;
    BAEstimIn       = $0L;
    BAEstinOut      = $0L;
    BAEstimOverOut  = $0L;
    BAEstimRest     = $0L;
    WasPrintBA      = FALSE;

    /* Сначала идем для резидентов */
    KeyNum(DepType,4);
    DepType.FlagCur = 1;
    DepType.BalAcc  = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur == 1         ) AND
          (DepType.BalAcc  == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(0),1);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    /* Потом идем для нерезидентов */
    KeyNum(DepType,5);
    DepType.FlagCur      = 1;
    DepType.BalAccNotRez = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur      == 1         ) AND
          (DepType.BalAccNotRez == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(1),1);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    if (WasPrintBA)
      OutStatTotalBA();
    end;
    i = i + 1;
  end;

  if (IsFirst == false)
    OutStatTotals2();
    flag = TRUE;
  end;

  if (flag)
    PrintLn;
    PrintLn;
    OutBottom;
    PrintLn( StrFor( 12 ) );
  end;

end;

macro ReportOnDepTypes

  var stat;
  var i,j,k;
  var BA_TMP;
  array ABalAcc,BalAcc;

  KeyNum(DepType,4);
  ReWind(DepType);
  DepType.FlagCur = 1;
  DepType.BalAcc  = "";
  stat = GetGE(DepType);
  while (stat)
    if (DepType.FlagCur == 1)
      BalAcc(0) = Trim(DepType.BalAcc);
      BalAcc(1) = Trim(DepType.BalAccNotRez);
      i = 0;
      while (i < ASize(BalAcc))
        if (ASize(ABalAcc) == 0)
          ABalAcc(0) = BalAcc(i);
        else
          j = 0;
          k = -1;
          while (j < ASize(ABalAcc))
            if (BalAcc(i) == ABalAcc(j))
              k = j;
              j = ASize(ABalAcc); /* Чтобы быстрее выйти из цикла */
            end;
            j = j + 1;
          end;
          if (k == -1)
            k = ASize(ABalAcc);
            ABalAcc(k) = BalAcc(i);
          end;
        end;
        i = i + 1;
      end;
      stat = Next(DepType);
    else
      stat = FALSE;
    end;
  end;

  /* Сортируем в порядке возрастания */
  i = 0;
  while (i < ASize(ABalAcc))
    j = i;
    k = i;
    while (j < ASize(ABalAcc))
      if (ABalAcc(k) > ABalAcc(j))
        k = j;
      end;
      j = j + 1;
    end;
    BA_TMP = ABalAcc(i);
    ABalAcc(i) = ABalAcc(k);
    ABalAcc(k) = BA_TMP;
    i = i + 1;
  end;

  OutDepHead;
  Currency.Code_Currency=1;
  stat=GetGE(Currency);
  while(stat);
    ReportOnDepTypesForCurCurrency (ABalAcc);
    stat=Next(Currency);
  end;
end;

macro DateLastQuartal

  var d,m,y;

  DateSplit({curdate},d,m,y);
  if ((m >= 1) AND (m <= 3))
    m == 1;
  elif ((m >= 4) AND (m <= 6))
    m == 4;
  elif ((m >= 7) AND (m <= 9))
    m == 7;
  else
    m = 10;
  end;

  return Date(1,m,y);

end;


macro ReportOnMemTurns

  var MemInOper   = 0;
  var MemInOperPr = 0;
  var stat;

  OutMemHead;

  Currency.Code_Currency = 1;
  stat = GetGE(Currency);
  while(stat)
    getTotalDepStats( {curdate}, Currency.Code_Currency );
    MemInOper = totalStat.MemInOper;
    getTotalDepStats( {curdate} - 1 , Currency.Code_Currency );
    MemInOperPr = totalStat.MemInOper;
    if (MemInOper OR MemInOperPr)
      OutMemSubHead();
    end;
    OutOpMemLine("1. Безналичные зачисления во вклады",
                 MemInOperPr,MemInOper);
    stat = Next(Currency);
  end;

end;


macro ReportOnOps

  var ColOper    = 0;
  var ColOperPr  = 0;
  var ColOper2   = 0;
  var ColOperPr2 = 0;
  var ColOper3   = 0;
  var ColOperPr3 = 0;
  var ColOper6   = 0;
  var ColOperPr6 = 0;
  var stat;
  array AGrOp;
    AGrOp(0) = CO_NalPer;
    AGrOp(1) = CO_Comission;
    AGrOp(2) = CO_Conversion;
    AGrOp(3) = CO_Payed;

  OutOpHead;

  Currency.Code_Currency = 1;
  stat = GetGE(Currency);
  while(stat)
    /* Операция по вкладам */
    ColOper    = 0;
    ColOperPr  = 0;
    ColOper2   = 0;
    ColOperPr2 = 0;
    ColOper3   = 0;
    ColOperPr3 = 0;
    ColOper6   = 0;
    ColOperPr6 = 0;

    getTotalDepStats( {curdate}, Currency.Code_Currency );
    ColOper = totalStat.OpenInOper;
    ColOper2 = totalStat.DopInOper;
    ColOper3 = totalStat.OutOper;
    getTotalDepStats( {curdate} - 1 , Currency.Code_Currency );
    ColOperPr = totalStat.OpenInOper;
    ColOperPr2 = totalStat.DopInOper;
    ColOperPr3 = totalStat.OutOper;

    if (ColOper   OR ColOper2   OR ColOper3   OR ColOper6 OR
        ColOperPr OR ColOperPr2 OR ColOperPr3 OR ColOperPr6  )
      OutOpSubHead();
    end;
    OutOpMemLine("1. Первоначальные взносы по вкладам населения",
      ColOperPr, ColOper);
    OutOpMemLine("2. Дополнительные взносы по вкладам населения",
      ColOperPr2, ColOper2);
    OutOpMemLine("3. Частичные выдачи и закрытие счетов по вкладам населения",
      ColOperPr3, ColOper3);
    OutOpMemLine("6. Операции по приему платежей от организаций и населения",
      ColOperPr6, ColOper6);
    stat = Next(Currency);
  end;

end;

  var
    RegPath = "RS-RETAIL\\ПЕЧАТИ\\ФОРМА_25";

  CheckPrinter( RegPath, StrFor( 0 ) );

  Message (" Создается форма 25-в ...");
  Safe = GetNativeSafe;
  DeskSubj.Branch = Branch;
  DeskSubj.Name = Safe;
  if ( not GetEQ( DeskSubj ) )
    MsgBox( "Не найден субъект кассы: ", Safe );
    Exit( -1 );
  end;
  if ( Index( DeskSubj.Reports, "B" ) != 0 )
    OutTitle;
    ReportOnCrResources;
    PrintLn;
    PrintLn;
    ReportOnVFResources;
    PrintLn;
    PrintLn;
    OutBottom;
    PrintLn;
    PrintLn;
    ReportOnDepTypes;
/*
    ReportOnOps();
    ReportOnMemTurns();
*/
  end;
  ExitMacro;
end;

*/