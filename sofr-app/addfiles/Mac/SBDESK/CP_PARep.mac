/* Š®¬¬ã­ «ì­ë¥ ¯« â¥¦¨ */
/* âç¥â ® ¯« â¥¦ å, ¯à®¢¥¤¥­­ëå ¯® «¨æ¥¢®¬ã áç¥âã */
import CommonInter, Globals, RSD, CB_SQL;

private file cp_account(rtcp_account) key 0;
private file cp_link(rtcp_link) key 0;
private var {curdate};
private var beginPeriod, endPeriod, sum;

macro FindAccount( id )
    cp_account.Id = id;
    return GetEQ(cp_account);
end;

macro FindLink( id )
    cp_link.Id = id;
    return GetEQ(cp_link);
end;

macro GetTypeName( linkId )
    file cp_type(rtcp_type) key 0;
    if( FindLink( linkId ) )
        cp_type.Id = cp_link.TypeId;
        if ( GetEQ(cp_type) )
            return cp_type.Name;
        end;
    end;
    return "";
end;

macro GetRecipientName
    file cp_recipient(rtcp_recipient) key 0;
    cp_recipient.Id = cp_link.RecipientId;
    if ( GetEQ(cp_recipient) )
        return cp_recipient.Name;
    end;
    return "";
end;

macro GetPayerName
    var FIO = cp_account.Name1;
    if ( cp_account.Name2 != "")
        FIO = FIO + " " + cp_account.Name2;
    end;
    if ( cp_account.Name3 != "")
        FIO = FIO + " " + cp_account.Name3;
    end;
    return FIO;
end;

macro GetAccPaymentsSet
    var cmd = RsdCommand( 
        "SELECT doc.*, docCP.T_CPLINKID FROM DPAY_DOC_DBT doc, DPAY_DOC_CP_DBT docCP WHERE" +
        " docCP.T_APPLKIND = doc.T_IAPPLICATIONKIND AND" +
        " docCP.T_APPLKEY = doc.T_APPLICATIONKEY AND" +
        " docCP.T_CPACCOUNTID = :id AND" +
        " doc.T_DATE_DOCUMENT BETWEEN :beginPeriod AND :endPeriod AND " +
        " doc.T_ACTION <> 2 AND doc.T_ACTION <> 11 " +
        " ORDER BY doc.T_DATE_DOCUMENT" );
    cmd.addParam("id", RsdBp_in, cp_account.id);
    cmd.addParam("beginPeriod", RsdBp_in, beginPeriod);
    cmd.addParam("endPeriod", RsdBp_in, endPeriod);
    cmd.execute;
    return RsdRecordset(cmd);
end;

/* ‡ £®«®¢®ª ®âç¥â  ® § £àã§ª¥ */
macro BeginReport
[
                    ¯« â  ¯« â¥¦¥© ¯® «¨æ¥¢®¬ã áç¥âã #

    « â¥«ìé¨ª  #############################################################################
    ®«ãç â¥«ì  #############################################################################
    §  ¯¥à¨®¤  á  ########## ¯® ##########
ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿
³   „ â    ³              ‚¨¤ ãá«ã£¨                ³      „®¯. ¯ à ¬¥âà     ³ ‡­ ç¥­¨¥ ¯ à ¬¥âà   ³ ¯« ç¥­®  ³
³  ®¯« âë  ³                                        ³                        ³                     ³           ³] (
    cp_account.Account,
    GetPayerName,
    GetRecipientName,
    beginPeriod,
    endPeriod );
end;

/* ‡ ¯¨áì § £àã¦ ¥¬ëå ¤ ­­ëå ¢ ®âç¥â */
macro WriteReport
    var attrs, attrCode, attrValue, stat, flagFirstAttr;
    var rs = GetAccPaymentsSet;

    while( rs.moveNext )
        sum = sum + SQL_ConvTypeSum(rs.value("T_INSUM"));

        attrs = TBPAttrValues( _€’ˆ“’›, rs.value("T_IAPPLICATIONKIND"), rs.value("T_APPLICATIONKEY") );
        stat = attrs.Read;
        if( stat == 0 )
            stat = attrs.MoveFirst;
        end;

        while( stat == 0 )
            attrs.Get( attrCode, attrValue );
            if( strlen( attrValue ) == 0 )
                stat = attrs.MoveNext;
            else
                break;
            end;
        end;
        
        if( stat != 0 )
            attrCode = "";
            attrValue = "";
        end;

[ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´
 ³##########³########################################³########################³#####################³###########³] (
        Date(rs.value("T_DATE_DOCUMENT")),
        GetTypeName(rs.value("T_CPLINKID")),
        attrCode,
        attrValue,
        SQL_ConvTypeSum(rs.value("T_INSUM")):r );
        
        while( stat == 0 )
            stat = attrs.MoveNext;
            if( stat == 0 )
                attrs.Get( attrCode, attrValue );
                if( strlen( attrValue ) != 0 )
                
[³          ³                                        ³########################³#####################³           ³] (
                    attrCode,
                    attrValue );
                end;
            end;
        end;
        
    end;
end;

/* ®¤¢ « ®âç¥â  ® § £àã§ª¥ */
macro EndReport
[ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´
³ ˆ’ƒ                                                                                            ³###########³
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÙ
] ( sum:r );
end;

macro PRINTREPORT( accountId )
    var day, mon, year;
    endPeriod = {curdate};
    DateSplit(endPeriod,day,mon,year);
    beginPeriod = Date(1,1,year);
    sum = $0;

    if ( FindAccount( accountId ) )
        if ( FindLink( cp_account.LinkId ) )
            BeginReport;
            WriteReport;
            EndReport;
        end;
    end;
end;

END;
