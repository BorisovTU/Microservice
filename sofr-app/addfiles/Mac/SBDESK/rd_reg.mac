
/* Реестр */

import deprintr, DeskInter, RD_Comm;

file BagList( "bag.dbt" ) key 0;

var Str_form;

macro GetSum( Sum )

  var
    Stat = true,
    RecFound;
  var ScaleRate = 1;
  var _rateCB = 0.0;

  Sum = 0;
  ClearRecord( BagList );
  BagList.Branch = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )  
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    Stat = FindCashValue( Bag.ValueRef );
    if ( Stat )
      if ( CashValue.TypeValue == TYPERES_CURRENCY )
         if ( Stat )
           Stat = FindCurr( CashValue.CodIntValue );
         end;
         if ( Stat )
           stat = GetAllCurrRate( {curdate}, CashValue.CodIntValue, _rateCB );
         end;
         if ( Stat )
           Sum = Sum + SumConv( BagList.RealSum, _rateCB, 1 );
         end;
      else
        if ( BagList.RealSum )
          Sum = Sum + BagList.RealSum;    
        else
          Sum = Sum + Money( BagList.RealItems );     
        end;
      end;
    end;
    RecFound = Next( BagList );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при расчете суммы" );
    Exit( -1 );
  end;
  SetParm( 0, Sum );  
end;

macro PrintRegistry

  var 
    Sum;

  GetSum( Sum );

  [                                                                                      ];
  [                								#########]
  ( Str_form);
  [                                                                                      ];
  [                                         Реестр                                       ];
  [                  на корреспонденцию, направленную через инкассаторов                 ];
  [          в Отдел кассовых операций Операционного управления Сбербанка России         ];
  [                                                                                      ];
  [            Отправитель:  Отдел по работе с ценностями и наличными деньгами           ];
  [ #####################################################################################]
  ( {Name_Bank} );
  [ #####################################################################################]
  ( {Post_Addr} );
  [                                                                                      ];
  [ ##########################################                                           ]
  ( Bag.Date:m );
  [                                                                                      ];
  [                                                                                      ];
  [--------------------------------------------------------------------------------------];
  [|                    Заполняет отправитель                          | Заполняет |    |];
  [|								       | приемщик  |    |];
  [--------------------------------------------------------------------------------------];
  [| № |№№ |     КУДА     |     КОМУ     | №№ |ВЕС|  Оценочная  стои-  |ВЕС| Сумма | №№ |];
  [|п/п|су-|  (пункт на-  |  (подробное  |плом|   |   мость в рублях   |   |сборов |при-|];
  [|   |мок|  значения,   | наименование |бира|   |(цифрами и прописью)|   |       |ем- |];
  [|   |   |  р-н, обл.)  |   адресата)  |    |   |                    |   |руб|коп|ные |];
  [--------------------------------------------------------------------------------------];
  [  #  ### ############## ##############          ####################                  ]
  (   
    1,
    Bag.Number,
    "Москва, ул.Вавилова 19":w,
    "Отдел кассовых операций Операционного управления Сбербанка России":w,
    ( Sum + " (" + RubToStr( Sum ) + ")" ):w
  );
  [--------------------------------------------------------------------------------------];
  [ Всего:                                         ####################                  ]
  ( Sum );
  [--------------------------------------------------------------------------------------];
  [ # ] ( Sum:m ); 
  [                                                                                      ];
  [                                                                                      ];
  [ Начальник ОРЦНД ____________________________________________                         ];                                     
  [                                                                                      ];
  [ Ст.Контролер-кассир ________________________________________                         ];                                     
  [                                                                                      ];
  [ Указанные опломбированные сумки в количестве 1 ( одной )                             ];
  [                                                ( количество прописью )               ];
  [                                                                                      ];
  [ штук на общую оценочную стоимость  ######################                            ]
  ( Sum:l );
  [                                    ################################################# ] 
  ( ( "( " + RubToStr( Sum ) + " )" ):w );
  [                                    ( прописью )                                      ];
  [                                                                                      ];
  [ и первый экземпляр реестра к ним приняты в исправной упаковке от начальника ОРЦНД    ];
  [ ( контролера )                                                                       ];
  [ _________________________________________________________________________________    ];
  [ ( ФИО )                                                                              ];
  [                                                                                      ];
  [           Сдали:                                                                     ];
 if(Str_form=="ф.N 219-b")
    [                                                                                      ];
    [           Начальник ОКО __________________                                           ];
    [                                                                                      ]; 
    [           Инспектор ______________________                                           ];
    [                                                                                      ]; 
    [                                                                                      ]; 
    [           Приняли:                                                                   ];
    [                                                                                      ]; 
    [           Инкассаторы ____________________                                           ];                                                    
 else
    [                                                                                      ];
    [           Инкассаторы __________________                                             ];
    [                                                                                      ]; 
    [                                                                                      ]; 
    [           Приняли:                                                                   ];
    [                                                                                      ]; 
    [           Зав. кладовой __________________                                           ];
    [                                                                                      ]; 
    [           Операционный работник ______________________                               ];
    [                                                                                      ]; 
 end;
end;

  if ( GetTrue( false, "Печатать реестр ?" ) )
    Str_form="ф.N 219";
    PrintRegistry;
    PrintLn( StrFor( 12 ) );
    Str_form="ф.N 219-a";
    PrintRegistry;
    PrintLn( StrFor( 12 ) );
    Str_form="ф.N 219-b";
    PrintRegistry;
  end;    
end;