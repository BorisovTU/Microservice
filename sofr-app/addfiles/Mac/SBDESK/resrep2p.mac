/* Ф. 25-в */

import ResCommP, SqlConv;

const
  ShowNullLines=false;  /* Показывать ли строки, где все нули */

var
  TotPrevRest=$0,
  TotCredit=$0,
  TotDebet=$0,
  TotOtherCred=$0,
  TotOtherDeb=$0,
  TotRest=$0,
  TotPrevRestR=$0,
  TotCreditR=$0,
  TotDebetR=$0,
  TotOtherCredR=$0,
  TotOtherDebR=$0,
  TotRestR=$0,
  TotPrevRestF=$0,
  TotCreditF=$0,
  TotDebetF=$0,
  TotOtherCredF=$0,
  TotOtherDebF=$0,
  TotRestF=$0,
  TotPrevRestC=$0,
  TotPrevRestCR=$0,
  TotPrevRestCRN=$0,
  TotCreditC=$0,
  TotCreditCR=$0,
  TotDebetC=$0,
  TotDebetCR=$0,
  TotRestC=$0,
  TotRestCR=$0,
  TotPrevAcc=0,
  TotAcc=0,
  TotOpenedAcc=0,
  TotClosedAcc=0;

array NameValArr;

macro OutTitle;

  [
   Место для штампа учреждения                                                                                  Форма № 25-в

                                                          Приложение к операционному дневнику № ####
                                                                          за ###########

   #
  ]
  (GetDiaryNo,String({curdate}),DeskSubj.Desc);
end;

macro OutVFHeader;

  [                                                  Раздел II. "Ценные бланки" ];
  [ ];
  [+----------------------------------------+------------+-----------+------------+------------+------------+------------------------------+
   |                                        |  Остаток   |           | Израсходов.| Выслано в  |  Остаток   |       №№ ценных бланков      |
   |          Наименование бланка           | к  началу  | Поступило |  по опера- | учреждения |  к концу   |         ( с № по № )         |
   |                                        |    дня     |           |    циям    | Сбербанка  |    дня     |                              |
   +----------------------------------------+------------+-----------+------------+------------+------------+------------------------------+];
end;

macro OutVFNameValTail

  var
   RangeStr = "",
   NameValStr = "",
   RecFound,
   i=1;

  while((RecFound = (Next(RegNumList)
    and (RegNumList.Branch == CashAcc.rec.Branch)
    and (RegNumList.CashOper == CashAcc.rec.CashOper)
    and (RegNumList.SubAccount == CashAcc.rec.SubAccount)
    and (RegNumList.Date == CashAcc.rec.Date)
    and (RegNumList.ValueRef == CashAcc.rec.RefValue)))
    or (i < asize(NameValArr)))
    if(i < asize(NameValArr))
      NameValStr = NameValArr(i);
    end;
    if(RecFound)
      RangeStr = MakeRangeStr;
    end;

    [| ###################################### |            |           |            |            |            | ############################ |]
    (
      NameValStr,
      RangeStr
    );
    i=i+1;
  end;
end;

macro OutVFLine(NameVal,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);

  var
    RangeStr = "";

  StrSplit(NameVal,NameValArr,38);

  if((not ShowNullLines) and (PrevRest==$0) and (Cred==$0) and (OtherCred==$0)
     and (Deb==$0) and (OtherDeb==$0) and (CurRest==$0))
    return;
  end;

  ClearRecord(RegNumList);
  RegNumList.Branch = CashAcc.rec.Branch;
  RegNumList.CashOper = CashAcc.rec.CashOper;
  RegNumList.SubAccount = CashAcc.rec.SubAccount;
  RegNumList.ValueRef = CashAcc.rec.RefValue;
  RegNumList.Date = CashAcc.rec.Date;
  if(GetGE(RegNumList)
    and (RegNumList.Branch == CashAcc.rec.Branch)
    and (RegNumList.CashOper == CashAcc.rec.CashOper)
    and (RegNumList.SubAccount == CashAcc.rec.SubAccount)
    and (RegNumList.Date == CashAcc.rec.Date)
    and (RegNumList.ValueRef == CashAcc.rec.RefValue))
    RangeStr = MakeRangeStr;
  end;

  [| ###################################### | ########## | ######### | ########## | ########## | ########## | ############################ |]
  (NameValArr(0),PrevRest:z,Cred+OtherCred:z,OtherDeb:z,Deb:z,CurRest:z,RangeStr);
  OutVFNameValTail;
  TotPrevRestF=TotPrevRestF+PrevRest;
  TotCreditF=TotCreditF+Cred;
  TotDebetF=TotDebetF+Deb;
  TotOtherCredF=TotOtherCredF+OtherCred;
  TotOtherDebF=TotOtherDebF+OtherDeb;
  TotRestF=TotRestF+CurRest;
  if ( CashVal.rec.UnitMeas == RESMESUNIT_MONEY )
    if ( FindNativeCurr )
      [|   - в рублях по курсу ЦБ               | ########## | ######### | ########## | ########## | ########## |                              |]
      (
        ConvertSum( PrevRest ):z,
        ConvertSum( Cred+OtherCred ):z,
        ConvertSum( OtherDeb ):z,
        ConvertSum( Deb ):z,
        ConvertSum( CurRest ):z
      );
    end;
  end;
end;

macro OutVFTotLine;

  [+----------------------------------------+------------+-----------+------------+------------+------------+------------------------------+];
  [| И т о г о                              | ########## | ######### | ########## | ########## | ########## |                              |]
  (TotPrevRestF,TotCreditF+TotOtherCredF,TotOtherDebF,TotDebetF,TotRestF);
end;

macro ReportOnCurVFResource;

  var
    PrevRest=$0,
    CurRest=$0,
    Deb=$0,
    Cred=$0,
    OtherDeb=$0,
    OtherCred=$0;

  if ( not IsShown )
    return;
  end;

  CalcTurns(CashVal.rec.RefValue, Cred, Deb, OtherCred, OtherDeb);
  /*CalcOtherTurns(CashVal.rec.RefValue,OtherCred,OtherDeb);*/

  if ( IsKept )
    CashAcc.KeyNum = 2;
    CashAcc.rec.Branch=Branch;
    CashAcc.rec.CashOper=Safe;
    CashAcc.rec.SubAccount="";
    CashAcc.rec.RefValue=CashVal.rec.RefValue;
    CashAcc.rec.Date={curdate};
    CashAcc.addFilter("t.t_Branch = " + string( Branch ) +
   		      " and t.t_CashOper = " + GetSQLString( Safe ) + 
   		      " and t.t_SubAccount = " + GetSQLString( "" ) + 
  		      " and t.t_RefValue = " + string( CashVal.rec.RefValue ) );
    if(CashAcc.GetLT and
      (CashAcc.rec.Branch==Branch) and
      (CashAcc.rec.RefValue==CashVal.rec.RefValue) and
      (CashAcc.rec.CashOper==Safe) and
      (CashAcc.rec.SubAccount==""))
      if(CashVal.rec.UnitMeas==RESMESUNIT_POINT)
        PrevRest=Money(CashAcc.rec.RestCol);
      else
        PrevRest=CashAcc.rec.RestMoney;
      end;
    end;
    CashAcc.dropFilter;
  
    CashAcc.KeyNum = 1;
    CashAcc.rec.Branch=Branch;
    CashAcc.rec.CashOper=Safe;
    CashAcc.rec.SubAccount="";
    CashAcc.rec.RefValue=CashVal.rec.RefValue;
    CashAcc.rec.Date={curdate};
    if(CashAcc.GetEQ)
      if(CashVal.rec.UnitMeas==RESMESUNIT_POINT)
        CurRest=Money(CashAcc.rec.RestCol);
        if ( {DeskOpen} )
          PrevRest = PrevRest + Money( ( CashAcc.rec.EKredCol - CashAcc.rec.EDebCol ) ); 
        end;
      else
        CurRest=CashAcc.rec.RestMoney;
        if ( {DeskOpen} )
          PrevRest = PrevRest + CashAcc.rec.EKredMoney - CashAcc.rec.EDebMoney; 
        end;
      end;
    end;
  else
    PrevRest = $0;
  end; 

  OutVFLine(CashVal.rec.NameValue,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
/*  if(OperBrigade != 0)
    WriteNBData(0,PrevRest,CurRest,Cred,0,Deb,0);
    WriteNBData(OperBrigade,0,0,0,OtherCred,0,OtherDeb);
  else
    WriteNBData(0,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
  end;   */
end;

macro ReportOnVFResources;

  CashVal.rec.FlagIntoBalance = 3;

  OutVFHeader;

//  CashVal.addFilter("t.t_FlagIntoBalance = 3");
  if(CashVal.GetGE and ( CashVal.rec.FlagIntoBalance == 3 ) )
    if(CashVal.rec.RefValueReport>=1)
      ReportOnCurVFResource;
    end;
    while(CashVal.Next)
      if(CashVal.rec.RefValueReport>=1)
        ReportOnCurVFResource;
      end;
    end;
  end;
//  CashVal.dropFilter;

  OutVFTotLine;
end;

macro OutCrHeader;

  [                                                          Раздел I. "Иностранная валюта" ];
  [ ];
  [+--------+-------------------------+----------------------------------------------------+---------------------------------+---------------------------------+--------------------------------+
   |        |                         |                Остаток на начало дня               |              Приход             |              Расход             |      Остаток на конец дня      |
   |  Код   |                         |-----------------+----------------------------------|-----------------+---------------|-----------------+---------------|----------------+---------------|
   |        |   Наименование валюты   |                 |            в рублях              |                 |               |                 |               |                |               |
   | валюты |                         |    в валюте     |-----------------+----------------|     в валюте    |    в рублях   |     в валюте    |    в рублях   |    в валюте    |    в рублях   |
   |        |                         |                 |  за пред. день  | с уч.изм.курса |                 |               |                 |               |                |               |
   +--------+-------------------------+-----------------+-----------------+----------------+-----------------+---------------+-----------------+---------------+----------------+---------------+];
end;

macro OutCrNameValTail

  var i=1;

  while(i<asize(NameValArr))
  [|        | ####################### |                 |                 |                |                 |               |                 |               |                |               |]
    (NameValArr(i));
    i=i+1;
  end;
end;


macro OutCrLine(PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);

  var
    PrevRestRN=0,
    PrevRestR=0,
    Credit=Cred+OtherCred,
    CreditR,
    Debet=Deb+OtherDeb,
    DebetR,                       
    CurRestR, 
    CBRate,
    PrevCBRate;

  if((not ShowNullLines) and (PrevRest==0) and (Credit==0) and (Debet==0) 
    and (CurRest==0))
    return;
  end;

  CBRate = GetCBRate( {curdate} );
  PrevCBRate = GetCBRate( {curdate} - 1 );

  CreditR=Money(Credit*CBRate);
  DebetR=Money(Debet*CBRate);
  CurRestR=Money(CurRest*CBRate);

  PrevRestRN=Money(PrevRest*CBRate);
  PrevRestR=Money(PrevRest*PrevCBRate);

  StrSplit(Currency.Name_Currency,NameValArr,23);

  [| ###### | ####################### | ############### | ############### | ############## | ############### | ############# | ############### | ############# | ############## | ############# |]
  (
    Currency.ExternalCode,
    NameValArr(0),
    PrevRest:z,
    PrevRestR:z,
    PrevRestRN:z,
    Credit:z,
    CreditR:z,
    Debet:z,
    DebetR:z,
    CurRest:z,
    CurRestR:z
  );
  OutCrNameValTail;
  TotPrevRestC=TotPrevRestC+PrevRest;
  TotPrevRestCR=TotPrevRestCR+PrevRestR;
  TotPrevRestCRN=TotPrevRestCRN+PrevRestRN;
  TotCreditC=TotCreditC+Credit;
  TotCreditCR=TotCreditCR+CreditR;
  TotDebetC=TotDebetC+Debet;
  TotDebetCR=TotDebetCR+DebetR;
  TotRestC=TotRestC+CurRest;
  TotRestCR=TotRestCR+CurRestR;
end;

macro OutCrTotLine;

  [+-------+-------------------------+-----------------------+-----------------------+-----------------------+-----------------------+----------------------+-----------------------+];
  [|       | И т о г о :             | ##################### | ##################### | ##################### | ##################### | #################### | ##################### |]
  (
    TotPrevRestC,
    TotPrevRestCR,
    TotPrevRestCRN,
    TotCreditC,
    TotCreditCR,
    TotDebetC,
    TotDebetCR,
    TotRestC,
    TotRestCR
  );
end;

macro ReportOnCurCrResource;

  var
    PrevRest=$0,
    CurRest=$0,
    Deb=$0,
    Cred=$0,
    OtherDeb=$0,
    OtherCred=$0;

  Currency.Code_Currency=CashVal.rec.CodIntValue;
  if(not GetEQ(Currency))
    ClearRecord(Currency);
    Currency.Name_Currency="не найдена";
  end;

  CashAcc.KeyNum = 2;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.SubAccount="";
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  CashAcc.addFilter("t.t_Branch = " + string( Branch ) +
		    " and t.t_CashOper = " + GetSQLString( Safe ) + 
		    " and t.t_SubAccount = " + GetSQLString( "" ) +
		    " and t.t_RefValue = " + string( CashVal.rec.RefValue ) );
  if(CashAcc.GetLT and
    (CashAcc.rec.Branch==Branch) and
    (CashAcc.rec.RefValue==CashVal.rec.RefValue) and
    (CashAcc.rec.CashOper==Safe) and
    (CashAcc.rec.SubAccount==""))
    PrevRest=CashAcc.rec.RestMoney;
  end;
  CashAcc.dropFilter;

  CashAcc.KeyNum = 1;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.SubAccount="";
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    CurRest=CashAcc.rec.RestMoney;
    if ( {DeskOpen} )
      PrevRest = PrevRest + CashAcc.rec.EKredMoney - CashAcc.rec.EDebMoney; 
    end;
  end;

  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.SubAccount="";
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    if ( {DeskOpen} )
      Cred=CashAcc.rec.KredMoney;
      Deb=CashAcc.rec.DebMoney;
    else
      Cred=CashAcc.rec.EKredMoney;
      Deb=CashAcc.rec.EDebMoney;
    end;
  end;
  OutCrLine(PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
/*  if(OperBrigade != 0)
    WriteNBData(0,PrevRest,CurRest,Cred,0,Deb,0);
    WriteNBData(OperBrigade,0,0,0,OtherCred,0,OtherDeb);
  else
    WriteNBData(0,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
  end;   */
end;

macro ReportOnCrResources;

  var
    PrevKey = CashVal.KeyNum;
    CashVal.KeyNum = 1;

  CashVal.rec.TypeValue=CV_Currency;
  CashVal.rec.CodIntValue=0;
//  CashVal.addFilter("(t.t_TypeValue = " + string(CV_Currency) +
//		    " or t.t_TypeValue = " + string(CV_PayDoc) + ")" );
  OutCrHeader;

  if(CashVal.GetGE and ((CashVal.rec.TypeValue==CV_Currency) or (CashVal.rec.TypeValue==CV_PayDoc)))
    if(CashVal.rec.CodIntValue!=0)
      ReportOnCurCrResource;
    end;
    while(CashVal.Next and ((CashVal.rec.TypeValue==CV_Currency) or (CashVal.rec.TypeValue==CV_PayDoc)))
      if(CashVal.rec.CodIntValue!=0)
        ReportOnCurCrResource;
      end;  
    end;
  end;
//  CashVal.dropFilter;
  CashVal.KeyNum = PrevKey;

  /*OutCrTotLine;*/
end;

macro OutCIHeader;

  [                                                                Учет ценностей ];
  [ ];
  [+--------------+-------------------------+--------------+------------------------------+-----------------------------+---------------+
   |              |                         |              |       П  Р  И  Х  О  Д       |       Р  А  С  Х  О  Д      |               |
   |      №       |                         |  Остаток к   |------------------------------|-----------------------------|   Остаток к   |
   |              |   Наименование счета    |              |   Получено    |    Прочий    |   Выслано    |    Прочий    |               |
   |    счета     |                         | началу  дня  |  от филиалов  |    приход    | учреждениям  |    расход    |   концу дня   |
   |              |                         |              | своего района |              |  Сбербанка   |              |               |
   +--------------+-------------------------+--------------+---------------+--------------+--------------+--------------+---------------+];
end;

macro OutCINameValTail

  var i=1;

  while(i<asize(NameValArr))
    [|              | ####################### |              |               |              |              |              |               |]
    (NameValArr(i));
    i=i+1;
  end;
end;

macro OutCILine(NameVal,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);

  var
    TmpPrevRest,
    TmpCurRest,
    TmpCred,
    TmpOtherCred,
    TmpDeb,
    TmpOtherDeb;

  StrSplit(NameVal,NameValArr,23);

  if((not ShowNullLines) and (PrevRest==$0) and (Cred==$0) and (OtherCred==$0)
     and (Deb==$0) and (OtherDeb==$0) and (CurRest==$0))
    return;
  end;

  [|              | ####################### | ############ | ############# | ############ | ############ | ############ | ############# |]
  (NameValArr(0),PrevRest:z,Cred:z,OtherCred:z,Deb:z,OtherDeb:z,CurRest:z);
  OutCINameValTail;
  TotPrevRest=TotPrevRest+PrevRest;
  TotCredit=TotCredit+Cred;
  TotDebet=TotDebet+Deb;
  TotOtherCred=TotOtherCred+OtherCred;
  TotOtherDeb=TotOtherDeb+OtherDeb;
  TotRest=TotRest+CurRest;
  
  FindNativeCurr;
  TmpPrevRest = ConvertSum( PrevRest );
  TmpCurRest = ConvertSum( CurRest );
  TmpDeb = ConvertSum( Deb );
  TmpOtherDeb = ConvertSum( OtherDeb );
  TmpCred = ConvertSum( Cred );
  TmpOtherCred = ConvertSum( OtherCred );
  [|              | - в рублях по курсу ЦБ  | ############ | ############# | ############ | ############ | ############ | ############# |]
  (TmpPrevRest:z,TmpCred:z,TmpOtherCred:z,TmpDeb:z,TmpOtherDeb:z,TmpCurRest:z);
  TotPrevRestR=TotPrevRestR+TmpPrevRest;
  TotCreditR=TotCreditR+TmpCred;
  TotDebetR=TotDebetR+TmpDeb;
  TotOtherCredR=TotOtherCredR+TmpOtherCred;
  TotOtherDebR=TotOtherDebR+TmpOtherDeb;
  TotRestR=TotRestR+TmpCurRest;
end;

macro OutCITotLine;
  [+--------------+-------------------------+--------------+---------------+--------------+--------------+--------------+---------------+];
  [| И т о г о :                            |##############|###############|##############|##############|##############|###############|]
  (TotPrevRest,TotCredit,TotOtherCred,TotDebet,TotOtherDeb,TotRest);
  [|   - в рублях по курсу ЦБ               |##############|###############|##############|##############|##############|###############|]
  (TotPrevRestR,TotCreditR,TotOtherCredR,TotDebetR,TotOtherDebR,TotRestR);
end;

macro ReportOnCurCIResource;

  var
    PrevRest=0,
    CurRest=0,
    Deb=0,
    Cred=0,
    OtherDeb=0,
    OtherCred=0;

  CalcTurns(CashVal.rec.RefValue,Cred,Deb,OtherCred,OtherDeb);
  /*CalcOtherTurns(CashVal.rec.RefValue,OtherCred,OtherDeb);*/

  CashAcc.KeyNum = 2;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.SubAccount="";
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  CashAcc.addFilter("t.t_Branch = " + string( Branch ) +
		     " and t.t_CashOper = " + GetSQLString( Safe ) + 
		     " and t.t_SubAccount = " + GetSQLString( "" ) +
		     " and t.t_RefValue = " + string( CashVal.rec.RefValue ) );
  if(CashAcc.GetLT and
    (CashAcc.rec.Branch==Branch) and
    (CashAcc.rec.RefValue==CashVal.rec.RefValue) and
    (CashAcc.rec.CashOper==Safe) and
    (CashAcc.rec.SubAccount==""))
    if(CashVal.rec.UnitMeas==RESMESUNIT_POINT)
      PrevRest=Money(CashAcc.rec.RestCol);
    else
      PrevRest=CashAcc.rec.RestMoney;
    end;
  end;
  CashAcc.dropFilter;

  CashAcc.KeyNum = 1;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.SubAccount="";
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    if(CashVal.rec.UnitMeas==RESMESUNIT_POINT)
      CurRest=Money(CashAcc.rec.RestCol);
      if ( {DeskOpen} )
        PrevRest = PrevRest + Money( ( CashAcc.rec.EKredCol - CashAcc.rec.EDebCol ) ); 
      end;
    else
      CurRest=CashAcc.rec.RestMoney;
      if ( {DeskOpen} )
        PrevRest = PrevRest + CashAcc.rec.EKredMoney - CashAcc.rec.EDebMoney; 
      end;
    end;
  end;
  OutCILine(CashVal.rec.NameValue,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
end;

macro ReportOnCIResources;

  var stat;

  TotPrevRest  = $0.0L;
  TotCredit    = $0.0L;
  TotDebet     = $0.0L;
  TotOtherCred = $0.0L;
  TotOtherDeb  = $0.0L;
  TotRest      = $0.0L;
  TotPrevRestR  = $0.0L;
  TotCreditR    = $0.0L;
  TotDebetR     = $0.0L;
  TotOtherCredR = $0.0L;
  TotOtherDebR  = $0.0L;
  TotRestR      = $0.0L;

  OutCIHeader;

  CashVal.rec.FlagIntoBalance = Chapter;
//  CashVal.addFilter("t.t_FlagIntoBalance = " + string( Chapter ) );
  stat = CashVal.GetGE;
  while (stat and (CashVal.rec.FlagIntoBalance == Chapter) )
    if ( /*( (CashVal.rec.TypeValue      >=  CV_ValForm) or ( CashVal.rec.Type > 0 ) ) AND */
        (CashVal.rec.RefValueReport != 0          ) AND
        (CashVal.rec.TypeValue != CV_MinCI + CI_COIN) )
      ReportOnCurCIResource();
    end;
    stat = CashVal.Next;
  end;
//  CashVal.dropFilter;

  OutCITotLine;
end;

macro OutDepHead

  PrintLn("                         Раздел III. Справка об оборотах и остатках по счетам в инвалюте ");
  PrintLn;
end;

macro OutDepSubHead

  PrintLn(Currency.Name_Currency);
  PrintLn;
  [+--------------+-------------------------------+-----------------------------+-----------------------------+------------------------------+------------------------------+
   |      №       |                               |    Остаток к началу дня     |           Приход            |            Расход            |     Остаток к концу дня      |
   |    счета     |      Наименование счета       |------+----------------------|------+----------------------|------+-----------------------|------+-----------------------|
   |              |                               |счета |        сумма         |счета |        сумма         |счета |         сумма         |счета |         сумма         |
   +--------------+-------------------------------+------+----------------------+------+----------------------+------+-----------------------+------+-----------------------+];
end;

macro OutStatTotals

  [+--------------+-------------------------------+------+----------------------+------+----------------------+------+-----------------------+------+-----------------------+];
  [| И т о г о:                                   | #### | #################### | #### | #################### | #### | ##################### | #### | ##################### |]
  (
    TotPrevAcc,
    TotPrevRestC,
    TotOpenedAcc,
    TotCreditC,
    TotClosedAcc,
    TotDebetC,
    TotAcc,
    TotRestC
  );
end;

macro OutDepLine

  if((not ShowNullLines)
     and (PrevStat.ColOpenedAcc==0)
     and (PrevStat.Rest==0)
     and (DepStat.rec.ColAccounts==PrevStat.ColAccounts)
     and (DepStat.rec.KredSum==0)
     and (DepStat.rec.ColClosedAcc==PrevStat.ColClosedAcc)
     and (DepStat.rec.DebSum==0)
     and (DepStat.rec.ColOpenedAcc==0)
     and (DepStat.rec.Rest==0))
    return;
  end;

  [| ############ | ############################# | #### | #################### | #### | #################### | #### | ##################### | #### | ##################### |]
  (
    DepType.BalAcc,
    DepType.Name,
    PrevStat.ColOpenedAcc:z,
    PrevStat.Rest:z,
    DepStat.rec.CurOpenAc:z,
    DepStat.rec.KredSum:z,
    DepStat.rec.CurClosAc:z,
    DepStat.rec.DebSum:z,
    DepStat.rec.ColOpenedAcc:z,
    DepStat.rec.Rest:z
  );
  TotPrevAcc = TotPrevAcc + PrevStat.ColOpenedAcc;
  TotOpenedAcc = TotOpenedAcc + DepStat.rec.CurOpenAc;
  TotClosedAcc = TotClosedAcc + DepStat.rec.CurClosAc;
  TotAcc = TotAcc + DepStat.rec.ColOpenedAcc;
  TotPrevRestC = TotPrevRestC + PrevStat.Rest;
  TotCreditC = TotCreditC + DepStat.rec.KredSum;
  TotDebetC = TotDebetC + DepStat.rec.DebSum;
  TotRestC = TotRestC + DepStat.rec.Rest;
end;

var
  IsFirst;

macro ReportOnCurDepType

  record TmpStat("sb_depst.dbt");

  DepStat.rec.FNCash=Branch;
  DepStat.rec.IsCur=1;
  DepStat.rec.Kind=DepType.Kind;
  DepStat.rec.CodCur=Currency.Code_Currency;
  DepStat.rec.Date={curdate};
  DepStat.addFilter("t.t_FNCash = " + string(Branch) +
		    " and t.t_IsCur = 1" + 
		    " and t.t_Kind = " + string(DepType.Kind) + 
		    " and t.t_CodCur = " + string(Currency.Code_Currency) );

  if(not (DepStat.GetLE
     and (DepStat.rec.FNCash==Branch)
     and (DepStat.rec.IsCur==1)
     and (DepStat.rec.Kind==DepType.Kind)
     and (DepStat.rec.CodCur==Currency.Code_Currency)))
    DepStat.dropFilter;
    return ;
  end;
  DepStat.dropFilter;

  if(IsFirst)
    IsFirst=false;
    OutDepSubHead;
  end;

  if(DepStat.rec.Date=={curdate})
    Copy(TmpStat,DepStat.rec);
    if(DepStat.Prev
      and (DepStat.rec.FNCash==Branch)
      and (DepStat.rec.IsCur==1)
      and (DepStat.rec.Kind==DepType.Kind)
      and (DepStat.rec.CodCur==Currency.Code_Currency))
      Copy(PrevStat,DepStat.rec);
      Copy(DepStat.rec,TmpStat);
    else
      ClearRecord(PrevStat);
      Copy(DepStat.rec,TmpStat);
    end;
  else
    Copy(PrevStat,DepStat.rec);
    DepStat.rec.CurOpenAc=0;
    DepStat.rec.CurClosAc=0;
    DepStat.rec.DebSum=0;
    DepStat.rec.KredSum=0;
  end;
  OutDepLine;
end;

macro ZeroStatTotals

  TotPrevRestC=$0;
  TotCreditC=$0;
  TotDebetC=$0;
  TotRestC=$0;
  TotPrevAcc=0;
  TotAcc=0;
  TotOpenedAcc=0;
  TotClosedAcc=0;
end;

macro ReportOnDepTypesForCurCurrency

  var
    RecFound;

  ZeroStatTotals;
  IsFirst=true;
  ClearRecord(DepType);
  DepType.FlagCur=1;
  RecFound=GetGE(DepType);
  while(RecFound and (DepType.FlagCur==1))
    if(DepType.Kind!="Служебный")
      ReportOnCurDepType;
    end;
    RecFound=Next(DepType);
  end;
  if(not IsFirst)
    OutStatTotals;
  end;
end;

macro ReportOnDepTypes

  var
    RecFound;

  OutDepHead;
  Currency.Code_Currency=1;
  RecFound=GetGE(Currency);
  while(RecFound);
    ReportOnDepTypesForCurCurrency;
    PrintLn;
    RecFound=Next(Currency);
  end;
end;

macro OutBottom
  [







   -------------------------------------------------------------------------------------------------------------------------------------------------
   Ст.контролер (контролер) _________________________________________________ Кассир _______________________________________________________________

   Отчет проверил "___" ________________ ______ г.                            Бухгалтер ____________________________________________________________];
end;

  var
    RegPath = "RS-RETAIL\\ПЕЧАТИ\\ФОРМА_25";

  CheckPrinter( RegPath, StrFor( 0 ) );

macro TreatCurrentSafe

  if ( Index( DeskSubj.Reports, "B" ) == 0 )
    return;
  end;

  TotPrevRestF=$0;
  TotCreditF=$0;
  TotDebetF=$0;
  TotOtherCredF=$0;
  TotOtherDebF=$0;
  TotRestF=$0;
  TotPrevRestC=$0;
  TotPrevRestCR=$0;
  TotPrevRestCRN=$0;
  TotCreditC=$0;
  TotCreditCR=$0;
  TotDebetC=$0;
  TotDebetCR=$0;
  TotRestC=$0;
  TotRestCR=$0;
  TotPrevAcc=0;
  TotAcc=0;
  TotOpenedAcc=0;
  TotClosedAcc=0;
  /*Safe = GetNativeSafe;*/
  OutTitle;
  ReportOnCrResources;
  PrintLn;
  PrintLn;
  ReportOnVFResources;
  PrintLn;
  PrintLn;
  Chapter = 2;
  ReportOnCIResources;
  PrintLn;
  PrintLn;
  OutBottom;
  PrintLn( StrFor( 12 ) );
end;

  var
    RecFound;

  if ( {EDeskOpen} )
    OperBrigade = B_EDESK;
  elif ( {DeskOpen} ) 
    OperBrigade = B_RDESK;
  end;

  if ( {RprtDSubj} == "" )
    KeyNum( DeskSubj, 1 );
    ClearRecord( DeskSubj );
    DeskSubj.Branch = Branch;
    DeskSubj.Type = DST_PANTRY;
    RecFound = GetGE( DeskSubj );
    while ( RecFound
      and ( DeskSubj.Branch == Branch )
      and ( DeskSubj.Type == DST_PANTRY ) )
      Safe = DeskSubj.Name;
      TreatCurrentSafe;
      RecFound = Next( DeskSubj );
    end;
    KeyNum( DeskSubj, 0 );
    DeskSubj.Branch = Branch;
    DeskSubj.Name = RDesk;
    if ( GetEQ( DeskSubj ) )
      Safe = DeskSubj.Name;
      TreatCurrentSafe;
    end;
  else
    DeskSubj.Branch = Branch;
    DeskSubj.Name = {RprtDSubj};
    if ( GetEQ( DeskSubj ) )
      Safe = DeskSubj.Name;
      TreatCurrentSafe;
    end;
  end;
  ExitMacro;
end;
