
/* Препроводительная ведомость ф. 132 */

import deprintr, DeskInter, RD_Comm;

file BagList( "bag.dbt" ) key 0;

var
  RcvName,
  DebetAcc,
  CreditAcc;

array
  SumStrArr;

macro CopyName( CopyNo )

  if ( CopyNo == 1 )
    return "Препроводительная ведомость";
  elif ( CopyNo == 2 )
    return "Накладная";
  elif ( CopyNo == 3 )
    return "Копия препроводительной ведомости";
  end;
end;

macro RcvBankName

  if ( Bag.ClientType == CL_BANK )
    return RcvName;
  else
    return "";
  end;
end;

macro GetSum( Sum )

  var
    Stat = true,
    RecFound;
  var ScaleRate = 1;
  var _rateCB = 0.0;

  Sum = 0;
  ClearRecord( BagList );
  BagList.Branch  = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )  
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    Stat = FindCashValue( BagList.ValueRef );
    if ( Stat )
      Stat = FindCurr( CashValue.CodIntValue );
    end;
    if ( Stat )
      stat = GetAllCurrRate( {curdate}, CashValue.CodIntValue, _rateCB );
    end;
    if ( stat )
      Sum = Sum + SumConv( BagList.RealSum, _rateCB, 1 );
    end;
    RecFound = Next( BagList );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при расчете суммы в рублях" );
    Exit( -1 );
  end;
  SetParm( 0, Sum );  
end;

macro SplitSum( Sum )

  var
    i;

  StrSplit( String( Sum:m ), SumStrArr, 31 );
  
  i = ASize( SumStrArr );
  while ( i < 3 )
    SumStrArr( i ) = "";
    i = i + 1;
  end;
end;

macro PrintSplitting

  var
    Total = 0,
    RSum,
    Stat = true,
    RecFound;
  var ScaleRate = 1;
  var _rateCB = 0.0;

  [                        Опись сдаваемой иностранной валюты                       ];
  [---------------------------------------------------------------------------------];
  [| Наименование |Код|    Сумма по   |     Сумма в     | Наимен. |Сумма по|Сумма в|];
  [|    валюты    |вал|    номиналу   |     рублях      |плат.док.|номиналу|рублях |];
  [---------------------------------------------------------------------------------];

  ClearRecord( BagList );
  BagList.Branch = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )  
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    Stat = FindCashValue( BagList.ValueRef );
    if ( Stat )
      Stat = FindCurr( CashValue.CodIntValue );
    end;
    if ( stat )
      stat = GetAllCurrRate( {curdate}, CashValue.CodIntValue, _rateCB );
    end;
    if ( Stat )
      RSum = Money( _rateCB * BagList.RealSum );
      [ ############## ### ############### ################# ]
      (
        Curr.Name_Currency:w,
        Curr.ExternalCode,
        BagList.RealSum,
        RSum
      );  
      Total = Total + RSum;    
    end;
    RecFound = Next( BagList );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при печати описи" );
    Exit( -1 );
  end;
  [---------------------------------------------------------------------------------];
  [                     Итого рублей:  ################# ]
  ( Total );
  [                     ################################################## ]
  ( Total:m );
end;

macro PrintCopy( CopyNo )

  var
    Sum;

  GetSum( Sum );

  SplitSum( Sum );
  [ # экз.                                                   ---------------------- ]              
  ( CopyNo ); 
  [                                                          |                    | ];
  [     ###############################################      ---------------------- ]
  ( CopyName( CopyNo ) );
  [     к сумке с денежной выручкой № ########                                      ]
  ( Bag.Number );
  [                     ###############################                             ]
  ( {curdate}:m:r );
  [ От ( кого )                                ДЕБЕТ                  СУММА         ];
  [ ################################ ---------------------------------------------- ]
  ( {Name_Bank} );                
  [                                  | ##################### |                    | ]
  ( Acc_Form(DebetAcc) );
  [ Получатель                       ------------------------| ################## | ]
  ( Sum:a );
  [ ################################           КРЕДИТ        |                    | ]
  ( RcvName );
  [                    Наличными     ------------------------|                    | ];
  [ Для зачисл. на сч.               | ##################### |                    | ]
  ( Acc_Form(CreditAcc) );
  [ Банк получателя                  |-----------------------|                    | ];            
  [ ################################ |                       |                    | ]
  ( RcvBankName );
  [ Сумма прописью руб.              | Чеками со счетов      |        Общая       | ];
  [ ################################ | по перечню            |--------------------- ]
  ( SumStrArr( 0 ) );
  [ ################################ | на обороте            |    Показ. касспл.    ]
  ( SumStrArr( 1 ) );                 
  [ ################################ |                       |   сумма         код  ]
  ( SumStrArr( 2 ) );                 
  [ ---------------------------------------------------------|--------------------- ];
  if ( CopyNo != 3 )
    [ Руководитель предпр. (организации)         Кассир        |________________|___| ];
    [ Указ. сумма принята полностью            Кассовый        |________________|___| ];
    [                                          работник        |________________|___| ];
    [   А К Т ########################        Контролер        |________________|___| ]
    ( Bag.Date:m );                            
    [ При вскрытии сумки и пересчете вложений оказалось:                              ];
    [ наличными руб. ______________  Платежными док-тами  руб. __________             ];
    [ нед./изл. руб. ______________  в ин. валюте                                     ];
    [ неплатеж. руб. ______________                                                   ];
    [ и сомнит.                                                                       ];
    [                                                                                 ];
    [ Кассовый работник      Контролирующий работник      Представитель клиента       ];
  else
    [ Руководитель предпр. (организации)         Кассир        |________________|___| ];
    [ ---------------------------------------------------------|________________|___| ];
    [                                                          |________________|___| ];
    [          Р А С П И С К А                                 |________________|___| ];
    [                                                                                 ]; 
    [ Опломбированную сумку № ##### без пересчета вложенных в нее                     ]
    ( Bag.Number );
    [ валютных ценностей принял инкассатор                                            ];
    [ Инкассатор _____________________________________________                        ];
    [                      ( подпись разборчивая )                                    ];
    [                                                                                 ];
    [                                             Печать подразделения инкассации     ];
    [ #########################################                                       ]
    ( Bag.Date:m );                 
  end;

  [ ];
  [ ];
  if ( CopyNo != 3 )
    PrintSplitting;
  end;
  PrintLn( StrFor( 12 ) );
end;        
  
  if ( ( Bag.Operation == CASHOP_PANT_RCRD ) and ( Bag.RouteID != 0 ) )
    CheckPersonType( PT_OPER );
  end;

  GetClientInfo( Bag.ClientType, Bag.ClientID, RcvName );
  GetAccounts( DebetAcc, CreditAcc );
  if ( GetTrue( false, "Печатать ф.132 ?" ) )
    PrintCopy( 1 );
    PrintCopy( 2 );
    PrintCopy( 3 );
  end;    
end;