
/* Препроводительная ведомость ф. 0402006 */

import deprintr, DeskInter, RD_Comm;

file Calc( "rd_calc.dbt" ) key 2;

var
  CalcFound = false,
  RcvName,
  DebetAcc,
  CreditAcc;

array
  SumStrArr;

const
  CS_NONE = 0,
  CS_STARTED = 1,
  CS_FINISHED = 2,
  CS_ACCEPTED = 3,
  CS_REJECTED = 4;

macro OverShort;

  if ( Bag.Overplus )
    return "Избыток";
  else
    return "Недостача";
  end;
end;

macro CopyName( CopyNo )

  if ( CopyNo == 1 )
    return "Препроводительная ведомость";
  elif ( CopyNo == 2 )
    return "Накладная";
  elif ( CopyNo == 3 )
    return "Копия препроводительной ведомости";
  end;
end;

macro RcvBankName

  if ( Bag.ClientType == CL_BANK )
    return RcvName;
  else
    return "";
  end;
end;

macro FindAcceptedCalc

  Calc.BagAppKind = Bag.ApplicationKind;    
  Calc.BagAppKey = Bag.ApplicationKey;    
  Calc.State = CS_ACCEPTED;
  return GetEQ( Calc );
end;

macro SplitSum

  var
    i;

  StrSplit( String( Bag.RealSum:m ), SumStrArr, 31 );
  
  i = ASize( SumStrArr );
  while ( i < 3 )
    SumStrArr( i ) = "";
    i = i + 1;
  end;
end;

macro PrintSplitting

  file BagSplit( "bagsplit.dbt" ) key 0;
  file CalcResult( "rd_calcr.dbt" ) key 1;

  var
    PrevPar = 0,
    CurSum,
    RecFound;

  [ Купюрная опись сдаваемых денег           |    Перечень представленных чеков     ];
  [ -----------------------------------------|--------------------------------------];
  [ | Купюры или |        |                  | №№ чеков | №№ счетов |       |Отмет.|];
  [ | достоинст- | Кол-во |      Сумма       | и серии  | и наимен. | Сумма |о деф.|];
  [ | во         |        |                  |          | чекодат.  |       |чеках |];
  [ -----------------------------------------|--------------------------------------];


  if ( CalcFound )
    ClearRecord( CalcResult );
    CalcResult.CalcID = Calc.ID;
    RecFound = GetGE( CalcFound );
    while ( RecFound and ( CalcResult.CalcID == Calc.ID ) )
      if ( PrevPar == CalcResult.Par )
        CurSum = CurSum + CalcResult.GoodSum;
      else
        if ( PrevPar != 0 )
          [  ####### руб. ######## ################## ]
          (
            CalcResult.Par,
            CalcResult.GoodNumItems,
            CalcResult.GoodSum
          ); 
        end;   
        CurSum = 0;
        PrevPar = CalcResult.Par; 
      end;
    end; 
  else
    ClearRecord( BagSplit );
    BagSplit.Branch = Bag.Branch;    
    BagSplit.Date = Bag.Date;
    BagSplit.ClientType = Bag.ClientType;
    BagSplit.ClientID = Bag.ClientID;
    BagSplit.Number = Bag.Number;
    BagSplit.ValueRef = Bag.ValueRef;
    RecFound = GetGE( BagSplit );
    while ( RecFound
      and ( BagSplit.Branch == Bag.Branch )    
      and ( BagSplit.Date == Bag.Date )
      and ( BagSplit.ClientType == Bag.ClientType )
      and ( BagSplit.ClientID == Bag.ClientID )
      and ( BagSplit.Number == Bag.Number )
      and ( BagSplit.ValueRef == Bag.ValueRef ) )
      [  ####### руб. ######## ################## ]
      (
        MoneyL( BagSplit.Character ),
        BagSplit.Amount,
        Money( BagSplit.Character * BagSplit.Amount )
      ); 
      RecFound = Next( BagSplit ); 
    end;
  end;

  [ --------------------------------------------------------------------------------];
  [                 Итого: ################## ]
  ( Bag.RealSum ); 
end;

macro PrintCopy( CopyNo )

  SplitSum;
  [ # экз.                                                   ---------------------- ]              
  ( CopyNo ); 
  [                                                          |       0402006      | ];
  [     ###############################################      ---------------------- ]
  ( CopyName( CopyNo ) );
  [     к сумке с денежной выручкой № ########                                      ]
  ( Bag.Number );
  [                     ###############################                             ]
  ( {curdate}:m:r );
  [ От ( кого )                                                                     ];
  [ ################################           #####                  #####         ]
  ( {Name_Bank}:w, "ДЕБЕТ", "СУММА" );                
  [                                  ---------------------------------------------- ];
  [                                  | ##################### |                    | ]
  ( Acc_Form(DebetAcc) );
  [ Получатель                       ------------------------| ################## | ]
  ( Bag.RealSum:a );
  [ ################################           ######        |                    | ]
  ( RcvName:w, "КРЕДИТ" );
  [                    Наличными     ------------------------|                    | ];
  [ Для зачисл. на сч.               | ##################### |                    | ]
  ( Acc_Form(CreditAcc) );
  [ Банк получателя                  |-----------------------|                    | ];            
  [ ################################ |                       |                    | ]
  ( RcvBankName:w );
  [ Сумма прописью руб.              | Чеками со счетов      |        Общая       | ];
  [ ################################ | по перечню            |--------------------- ]
  ( SumStrArr( 0 ) );
  [ ################################ | на обороте            |    Показ. касспл.    ]
  ( SumStrArr( 1 ) );                 
  [ ################################ |                       |   сумма         код  ]
  ( SumStrArr( 2 ) );                 
  [ ---------------------------------------------------------|--------------------- ];
  [ Руководитель предпр. (организации)         Кассир        |________________|___| ];
  [ Указ. сумма принята полностью              Кассир        |________________|___| ];
  [                                                          |________________|___| ];
  [   А К Т ########################        Контролер        |________________|___| ]
  ( Bag.Date:m );
  [ При вскрытии сумки и пересчете вложений оказалось:       |Вид оп.|____________| ];
  [ наличными руб. ______________  чеками   руб. ___________ |Назн.пл|____________| ];
  [ нед./изл. руб. ______________  нед./изл руб. ___________ |№ гр.б.|            | ];
  [ неплатеж. руб. ______________  дефектн. руб. ___________ ---------------------- ];
  [ и фальш.                                                   Подписи банка:       ];
  [                                                            Кассир               ];
  [ Кассир      Контролер      Представитель клиента           Контролер            ];

  [ ];
  [ ];
  PrintSplitting;
  PrintLn( StrFor( 12 ) );
end;        
  
  if ( ( Bag.Operation == CASHOP_PANT_RCRD ) and ( Bag.RouteID != 0 ) )
    CheckPersonType( PT_OPER );
  end;

  GetClientInfo( Bag.ClientType, Bag.ClientID, RcvName );
  GetAccounts( DebetAcc, CreditAcc );

  if ( ( ( Bag.Operation == CASHOP_PANT_RCRD ) or ( Bag.Operation == CASHOP_PANT_ECRD ) ) and FindAcceptedCalc )
    CalcFound = true;
  elif ( not SplitCurrBag( Bag ) )
    Exit( -1 );
  end;

  PrintCopy( 1 );
  PrintCopy( 2 );
  PrintCopy( 3 );
end;