/*
     R-Style Software Lab.

     RS-Retail 2.01.

     Справка об остатках
     в операционной кассе вне кассового узла (ОКВКУ)
     на конец операционного дня

*/

 import DeprIntr;
 import rsd;

 var ddep = TRecHandler( "i_dp_dep.rec" );
 var party = TRecHandler( "i_party.rec" );
 file svod     ( desk_rec ) key 0;     /* Сводные кассовые документы */
 file group    ( rtgroup )  key 2;
 file value    ( sb_casvl ) key 0;     /* Справочник видов ресурсов кассы */
 file acc      ( sb_casac ) key 0;     /* Файл счетов кассы */
 file curr     ( currency ) key 0;     /* Fail valyut */

 /* Коды кассовых операций */
 const CASHOP_ADVANCE       =  4;  /* Аванс           */
 const CASHOP_REMOVE_SAFE_1 = 12;  /* Принято по акту */

 /* Типы ресурсов кассы */
 const ttAble = 0;  /* Платежеспособный */

 /* Коды типов ценности */
 const tvCurr = 1;  /* Валюты */
 const tvPD   = 4;  /* Платежные документы */

 /* Коды видов кассовых ресурсов */
 const cvRUB = 0;  /* Рубли */

 const FNCash = NumFNCash();  /* Номер филиала */
 const OperBrigade = GetOperBrigade();  /* Номер бригады */

 private var {curdate};

 var ErrCode, ErrText;

 var ret = TRUE;

 var Safe;
 private var {Name_Bank};
 private var {Post_Addr};
 var NameBranch = "";
 var AddrBranch = "";

 /* Переменные для рублей */
 var RUBnn   = 0;
 var RUBname = "";
 var RUBsum  = $0;

 var cmd, rs;
 var wasPrintTitle, wasPrintTitleRUR, wasPrintTitleCur;

macro CurrencySumToStr( Sum, InternalCode )

  curr.Code_Currency = InternalCode;

  if( GetEQ( curr ) )
    return CurToStrAlt( Sum, null, null, Int( curr.ExternalCode ) );
  else
    return "Валюта не найдена";
  end;
end;


/***********************************************************
   Процедура определения сейфа бригады
***********************************************************/
macro GetNativeSafe

  if( GetProgramID != CodeFor( "Л" ) )       /* не Кладовая отделения */
    group.Branch = FNCash;
    group.Date = {curdate};
    group.ID = OperBrigade;
    if(GetEQ(group))
      return group.SafeID;
    else
      MsgBox( "Не найден сейф бригады № ", OperBrigade );
      Exit;
    end;
  else
    return "Кладовая";
  end;
end;

/***********************************************************
   Находим ФИО зав. кладовой
 ***********************************************************/
macro Get_OperName
  file pers  ( person, "sbbank.def" );
  file grmem ( groupmem, "sbbank.def" );
  var OperZavDesk = 0, Name = " ", IOtmp;
  var RecFound;

  ClearRecord( grmem );
  grmem.Branch = FNCash;
  grmem.Date   = {curdate};
  grmem.Group  = OperBrigade;
  RecFound = GetGE( grmem );

  while ( ( grmem.Branch == FNCash )
      and ( grmem.Date   == {curdate} )
      and ( grmem.Group  == OperBrigade )
      and RecFound )
    ClearRecord( pers );
    pers.Oper = grmem.Oper;
    if ( GetEq ( pers ) )
      if ( pers.cTypeInDesk == "З" )
        OperZavDesk = pers.Oper;
      end;
    end;
    RecFound = Next( grmem );
  end;

  ClearRecord( pers );
  pers.Oper = OperZavDesk;
  if ( GetEq( pers ) )
    Name = pers.Name;
    Name = SubStr( pers.Name, 1, Index(pers.Name, " ") - 1 );
    IOtmp= Trim( Substr( pers.Name, Index(pers.Name, " ") ) );
    Name = Name + " " + strupr( Substr(IOtmp, 1, 1)) + ".";
    IOtmp = Trim( Substr( IOtmp, Index(IOtmp," ") ) );
    Name = Name + strupr( Substr( IOtmp, 1, 1 ) ) + "."; 
  end;

  return Name;
end;


/***********************************************************
   Процедура поиска ресурса кассы
***********************************************************/
macro FindCashValue( ref )
 var stat;
 value.RefValue = ref;
 stat = GetEQ( value );
 if ( NOT stat )
   println( "Не найден ресурс кассы с RefValue = ", ref );
   ErrCode = Status( ErrText );
   println( ErrCode, ": ", ErrText );
 end;
 return stat;
end;


macro printTitleRUR
  wasPrintTitleRUR = true;
  [+--------------------------------+----------------------+--------------------------------+
   |          Наличные рубли        |     Сумма цифрами    |         Сумма прописью         |
   +--------------------------------+----------------------+--------------------------------+];
end;


macro printTitleCurrency
  wasPrintTitleCur = true;
  [+--------------------------------+----------------------+--------------------------------+
   |  Наличная иностранная валюта   |     Сумма цифрами    |         Сумма прописью         |
   +--------------------------------+----------------------+--------------------------------+];
end;

macro printDataString( name, valuemoney, codintvalue )
  [| ############################## | #################### | ############################## |]
  ( name:w, valuemoney:20:2, CurrencySumToStr(valuemoney, codintvalue):w );

end;

macro printFooter
  [+--------------------------------+----------------------+--------------------------------+];
end;

/***********************************************************
   Основная процедура
***********************************************************/

 /* Получение имени и адреса филиала */
 if ( findDepartment(FNCash, null, ddep, party) )
   NameBranch = ddep.rec.Name;
   AddrBranch = party.rec.address;
 end;

 [
   #
   Адрес #
   Операционная касса вне кассового узла                 Регистрационный номер   #
                   


                                      СПРАВКА ОБ ОСТАТКАХ
             НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТЫ, ПЛАТЕЖНЫХ ДОКУМЕНТОВ В ИНОСТРАННОЙ ВАЛЮТЕ
                    И НАЛИЧНЫХ РУБЛЕЙ В ОПЕРАЦИОННОЙ КАССЕ ВНЕ КАССОВОГО УЗЛА
                                   НА КОНЕЦ ОПЕРАЦИОННОГО ДНЯ

                                       #

 ]( {Name_Bank}, {Post_Addr}, NameBranch:c, String({curdate}:m) );

 /* Часть 1. Отчет по ававнсу */

 wasPrintTitle = false;
 wasPrintTitleRUR = false;
 wasPrintTitleCur = false;

 cmd = RsdCommand(
      "select casdc.t_valuemoney, casvl.t_namevalue, casvl.t_codintvalue, casdc.t_refvalue " +
        "from (select t_refvalue, sum (t_valuemoney) t_valuemoney " +
                "from dsb_casdc_dbt " +
               "where t_branch = ? " +
                 "and t_cashdatedoc = ? " +
                 "and t_brigade = ? " +
                 "and t_numoper = ? " +
              "group by t_refvalue) casdc, dsb_casvl_dbt casvl " +
       "where casdc.t_refvalue = casvl.t_refvalue " +
         "and casvl.t_typevalue = ? " +
      "order by casvl.t_codintvalue ");
 cmd.addParam("FNCash", RSDBP_IN, FNCash);
 cmd.addParam("curdate", RSDBP_IN, {curdate});
 cmd.addParam("OperBrigade", RSDBP_IN, OperBrigade);
 cmd.addParam("numoper", RSDBP_IN, CASHOP_ADVANCE);
 cmd.addParam("typevalue", RSDBP_IN, tvCurr);
 cmd.execute;

 rs = RsdRecordSet( cmd );

 while ( rs.moveNext)
   if ( not wasPrintTitle )
     wasPrintTitle = true;
     [                                      ПОЛУЧЕН АВАНС:
                                            --------------                                       ];
   end;
   if ( rs.value("t_codintvalue") == cvRUB )
     if ( not wasPrintTitleRUR )
       printTitleRUR;
     end;
   else
     if ( not wasPrintTitleCur )
       if ( wasPrintTitleRUR )
         printFooter;
       end;
       printTitleCurrency;
     end;
   end;
   printDataString( rs.value("t_namevalue"), rs.value("t_valuemoney"), rs.value("t_codintvalue"));
 end;
 if ( wasPrintTitleRUR or wasPrintTitleCur )
   printFooter;
 end;

 /*
 ReWind( svod );
 ClearRecord( svod );
 svod.IsCur  = 0;
 svod.Branch = FNCash;
 svod.Date   = {curdate};
 if ( GetGE( svod )              AND
      ( svod.IsCur  == 0 )       AND
      ( svod.Branch == FNCash )  AND
      ( svod.Date   == {curdate} ) )
   [                                      ПОЛУЧЕН АВАНС:
                                          --------------
     +--------------------------------+----------------------+--------------------------------+
     |  Наличная иностранная валюта   |     Сумма цифрами    |         Сумма прописью         |
     +--------------------------------+----------------------+--------------------------------+];
   RUBnn   = 0;
   RUBname = "";
   RUBsum  = $0;
   ret = TRUE;
   while ( ret                        AND
           ( svod.IsCur  == 0 )       AND
           ( svod.Branch == FNCash )  AND
           ( svod.Date   == {curdate} ) )
     if ( ( svod.Brigade == OperBrigade )  AND
          ( svod.Operation == CASHOP_ADVANCE ) )
       if ( FindCashValue( svod.ValueRef )  AND
            ( value.Type      == ttAble )   AND
            ( value.TypeValue == tvCurr ) )
         if ( value.CodIntValue == cvRUB )
           /* Рубли */
           RUBnn   = 1;
           RUBname = value.NameValue;
           RUBsum  = svod.Sum;
         else
           /* Валюта */
           [ | ############################## | #################### | ############################## |]
           ( value.NameValue:w, svod.Sum:20:2, CurrencySumToStr(svod.Sum, value.CodIntValue):w );
         end;
       end;
     end;
     ret = Next( svod );
   end;
   if ( RUBnn != 0 )  /* Есть запись по рублям */
     [ +--------------------------------+----------------------+--------------------------------+
       +--------------------------------+----------------------+--------------------------------+
       |          Наличные рубли        |     Сумма цифрами    |         Сумма прописью         |
       +--------------------------------+----------------------+--------------------------------+];
       [ | ############################## | #################### | ############################## |]
       ( RUBname:w, RUBsum:20:2, String(RUBsum:m):w );
     [ +--------------------------------+----------------------+--------------------------------+];
   end;
 end;
 */

 /* Часть 2. Принято по акту от другого кассира */
 /*          Валюты                             */
 wasPrintTitle = false;
 wasPrintTitleRUR = false;
 wasPrintTitleCur = false;

 cmd.value("numoper") = CASHOP_REMOVE_SAFE_1;
 cmd.execute;

 rs = RsdRecordSet( cmd );

 while ( rs.moveNext)
   if ( not wasPrintTitle )
     wasPrintTitle = true;
     [
                                ПРИНЯТО ПО АКТУ ОТ ДРУГОГО КАССИРА:
                                -----------------------------------                               ];
   end;
   if ( rs.value("t_codintvalue") == cvRUB )
     if ( not wasPrintTitleRUR )
       printTitleRUR;
     end;
   else
     if ( not wasPrintTitleCur )
       if ( wasPrintTitleRUR )
         printFooter;
       end;
       printTitleCurrency;
     end;
   end;
   printDataString( rs.value("t_namevalue"), rs.value("t_valuemoney"), rs.value("t_codintvalue"));
 end;
 if ( wasPrintTitleRUR or wasPrintTitleCur )
   printFooter;
 end;


 /*
 ReWind( svod );
 ClearRecord( svod );
 svod.IsCur  = 0;
 svod.Branch = FNCash;
 svod.Date   = {curdate};
 if ( GetGE( svod )              AND
      ( svod.IsCur  == 0 )       AND
      ( svod.Branch == FNCash )  AND
      ( svod.Date   == {curdate} ) )
   [
                                ПРИНЯТО ПО АКТУ ОТ ДРУГОГО КАССИРА:
                                -----------------------------------
     +--------------------------------+----------------------+--------------------------------+
     |  Наличная иностранная валюта   |     Сумма цифрами    |         Сумма прописью         |
     +--------------------------------+----------------------+--------------------------------+];
   RUBnn   = 0;
   RUBname = "";
   RUBsum  = $0;
   ret = TRUE;
   while ( ret                        AND
           ( svod.IsCur  == 0 )       AND
           ( svod.Branch == FNCash )  AND
           ( svod.Date   == {curdate} ) )
     if ( ( svod.Brigade == OperBrigade )  AND
          ( svod.Operation == CASHOP_REMOVE_SAFE_1 ) )
       if ( FindCashValue( svod.ValueRef )  AND
            ( value.Type      == ttAble )   AND
            ( value.TypeValue == tvCurr ) )
         if ( value.CodIntValue == cvRUB )
           /* Рубли */
           RUBnn   = 1;
           RUBname = value.NameValue;
           RUBsum  = svod.Sum;
         else
           /* Валюта */
           [ | ############################## | #################### | ############################## |]
           ( value.NameValue:w, svod.Sum:20:2, CurrencySumToStr(svod.Sum, value.CodIntValue):w );
         end;
       end;
     end;
     ret = Next( svod );
   end;
   [ +--------------------------------+----------------------+--------------------------------+];
 end;
 */

 /* Часть 3. Принято по акту от другого кассира */
 /*          Платежные документы                */
 cmd.value("typevalue") = tvPD;

 wasPrintTitleRUR = false;
 cmd.execute;

 rs = RsdRecordSet( cmd );

 while ( rs.moveNext)
   if ( not wasPrintTitle )
     wasPrintTitle = true;
     [
                                  ПРИНЯТО ПО АКТУ ОТ ДРУГОГО КАССИРА:
                                  -----------------------------------
      +--------------------------------+----------------------+--------------------------------+];
   end;

   if ( not wasPrintTitleRUR )
     wasPrintTitleRUR = true;
     [+-----+--------------------------+----------------------+--------------------------------+
      | Код | Наименован.оплаченных ПД |     Сумма цифрами    |         Сумма прописью         |
      +-----+--------------------------+----------------------+--------------------------------+];
   end;
   [| ### | ######################## | #################### | ############################## |]
   ( rs.value("t_refvalue"):3, rs.value("t_namevalue"):w, rs.value("t_valuemoney"):20:2, String(rs.value("t_valuemoney"):m):w );
 end;
 if ( wasPrintTitleRUR )
  [+-----+--------------------------+----------------------+--------------------------------+];
 end;

/*
 ReWind( svod );
 ClearRecord( svod );
 svod.IsCur  = 0;
 svod.Branch = FNCash;
 svod.Date   = {curdate};
 if ( GetGE( svod )              AND
      ( svod.IsCur  == 0 )       AND
      ( svod.Branch == FNCash )  AND
      ( svod.Date   == {curdate} ) )
   [ +-----+--------------------------+----------------------+--------------------------------+
     | Код | Наименован.оплаченных ПД |     Сумма цифрами    |         Сумма прописью         |
     +-----+--------------------------+----------------------+--------------------------------+];
   ret = TRUE;
   while ( ret                        AND
           ( svod.IsCur  == 0 )       AND
           ( svod.Branch == FNCash )  AND
           ( svod.Date   == {curdate} ) )
     if ( ( svod.Brigade == OperBrigade )  AND
          ( svod.Operation == CASHOP_REMOVE_SAFE_1 ) )
       if ( FindCashValue( svod.ValueRef )  AND
            ( value.Type      == ttAble )   AND
            ( value.TypeValue == tvPD ) )
         [| ### | ######################## | #################### | ############################## |]
         ( svod.ValueRef:3, value.NameValue:w, svod.Sum:20:2, String(svod.Sum:m):w );
       end;
     end;
     ret = Next( svod );
   end;
   [ +-----+--------------------------+----------------------+--------------------------------+];
 end;
 */

 // напечатается во второй части
 /* Часть 4. Принято по акту от другого кассира */
 /*          Рубли                              */
 /* 
 if ( RUBnn != 0 )  /* Есть запись по рублям */
   [ +--------------------------------+----------------------+--------------------------------+
     |          Наличные рубли        |     Сумма цифрами    |         Сумма прописью         |
     +--------------------------------+----------------------+--------------------------------+];
   [ | ############################## | #################### | ############################## |]
       ( RUBname:w, RUBsum:20:2, String(RUBsum:m):w );
   [ +--------------------------------+----------------------+--------------------------------+];
 end;
 */

 /* Часть 5. Остатки на конец операционного дня */
 /*          Валюты                             */
 Safe = GetNativeSafe();

 ReWind( acc );
 ClearRecord( acc );
 acc.Branch   = FNCash;
 acc.Date     = {curdate};
 acc.CashOper = Safe;
 acc.SubAccount = "";
 if ( GetGE( acc )                   AND
      ( acc.Branch   == FNCash )     AND
      ( acc.Date     == {curdate} )  AND
      ( acc.CashOper == Safe )       AND
      ( acc.SubAccount == "" ) )
   [
                                ОСТАТКИ НА КОНЕЦ ОПЕРАЦИОННОГО ДНЯ:
                                -----------------------------------
     +--------------------------------+----------------------+--------------------------------+
     |  Наличная иностранная валюта   |     Сумма цифрами    |         Сумма прописью         |
     +--------------------------------+----------------------+--------------------------------+];
   RUBnn   = 0;
   RUBname = "";
   RUBsum  = $0;
   ret = TRUE;
   while ( ret                            AND
           ( acc.Branch   == FNCash )     AND
           ( acc.Date     == {curdate} )  AND
           ( acc.CashOper == Safe )       AND
           ( acc.SubAccount == "" ) )
     if ( FindCashValue( acc.RefValue )  AND
          ( value.Type      == ttAble )   AND
          ( value.TypeValue == tvCurr ) )
       if ( value.CodIntValue == cvRUB )
         /* Рубли */
         RUBnn   = 1;
         RUBname = value.NameValue;
         RUBsum  = acc.RestMoney;
       else
         /* Валюта */
         [ | ############################## | #################### | ############################## |]
       ( value.NameValue:w, acc.RestMoney:20:2, CurrencySumToStr(acc.RestMoney, value.CodIntValue):w );
       end;
     end;
     ret = Next( acc );
   end;
   [ +--------------------------------+----------------------+--------------------------------+];
 end;

 /* Часть 6. Остатки на конец операционного дня */
 /*          Платежные документы                */
 ReWind( acc );
 ClearRecord( acc );
 acc.Branch   = FNCash;
 acc.Date     = {curdate};
 acc.CashOper = Safe;
 acc.SubAccount = "";
 if ( GetGE( acc )                   AND
      ( acc.Branch   == FNCash )     AND
      ( acc.Date     == {curdate} )  AND
      ( acc.CashOper == Safe )       AND
      ( acc.SubAccount == "" ) )
   [ +-----+--------------------------+----------------------+--------------------------------+
     | Код | Наименован.оплаченных ПД |     Сумма цифрами    |         Сумма прописью         |
     +-----+--------------------------+----------------------+--------------------------------+];
   ret = TRUE;
   while ( ret                            AND
           ( acc.Branch   == FNCash )     AND
           ( acc.Date     == {curdate} )  AND
           ( acc.CashOper == Safe )       AND
           ( acc.SubAccount == "" ) )
     if ( FindCashValue( acc.RefValue )  AND
          ( value.Type      == ttAble )   AND
          ( value.TypeValue == tvPD ) )
       [ | ### | ######################## | #################### | ############################## |]
       ( acc.RefValue:3, value.NameValue:w, acc.RestMoney:20:2, String(acc.RestMoney:m):w );
     end;
     ret = Next( acc );
   end;
   [ +-----+--------------------------+----------------------+--------------------------------+];
 end;

 /* Часть 7. Остатки на конец операционного дня */
 /*          Рубли                              */
 if ( RUBnn != 0 )  /* Есть запись по рублям */
   [ +--------------------------------+----------------------+--------------------------------+
     |          Наличные рубли        |     Сумма цифрами    |         Сумма прописью         |
     +--------------------------------+----------------------+--------------------------------+];
   [ | ############################## | #################### | ############################## |]
       ( RUBname:w, RUBsum:20:2, String(RUBsum:m):w );
   [ +--------------------------------+----------------------+--------------------------------+];
 end;

 [
   Кассир:

   _________________________________               ______________________#___________________
             (подпись)                                       (фамилия, имя, отчество)
 ]( Get_OperName:c );

end;
