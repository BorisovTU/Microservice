/*
$Name: rescomm.mac
$Module: Касса
$Description: Общее для ф. 25-а/в 
*/

import BankInter, deprintr, Pcs2Mon, CVSettng, ChkPrn, ChkBoss;

file Alg    ("namealg.dbt","bank.def")  key 0;
/*file CashVal("sb_casvl.dbt") key 5;*/
/*file CashAcc("sb_casac.dbt") key 1;*/
/*file DepStat("sb_depst.dbt") key 0;*/
/*file OthStat("sb_othst.dbt") key 2;*/
record PrevStat("sb_depst.dbt");
record PrevOthStat("sb_othst.dbt");
record TotOthStat("sb_othst.dbt");
record TotOthPrevStat("sb_othst.dbt");
var CashVal = TBFile("sb_casvl.dbt","w",5);
var CashAcc = TBFile("sb_casac.dbt","w",1);
var DepStat = TBFile("sb_depst.dbt","w",0);
var OthStat = TBFile("sb_othst.dbt","w",2);
file CashDoc("sb_casdc.dbt") key 0;
var DepType = TBFile( "sb_dtyp.dbt", "r", 2 );
file PayKind("pay_kind") key 0;
file OGSZIss("ogsz_iss.dbt") key 0;
file CIMisc("ci_misc.dbt") key 0;
file Cert("cert.dbt") key 0;
file PayRecip("rtcp_recipient.dbt") key 0;
file NBData("nb_data.dbt") key 0 write;
file CIAcc("ci_acnt.dbt") key 0;
file RegNumList("reg_num.dbt") key 0;
file CICode("ci_code.dbt") key 1;
file DeskSubj ("desksubj.dbt") key 0;
var Currency = TBFile("currency.dbt", "r", 0 );

var tBalAcc, tBalAccNR;


const
  ShowNullLines=false;  /* Показывать ли строки, где все нули */

/* Сводные счета */

const
  CommPayAcc  = "321",   /* Коммунальные платежи */
  CashOperAcc = "16",    /* Текущие счета учреждений и организаций */
  CapIssueAcc = "218";   /* Ценные бумаги */

const
  CV_Currency = 1,
  CV_ValForm = 2,
  CV_MinCI = 500;

const
  SB_COMPAY    = 20,   /* Коммунальные платежи */
  SB_CASHOPERT = 200,  /* документ для сервисно-кассовых операций */
  SB_CAPISSUE  = 300;  /* Ценные бумаги                           */

const
  CO_CommPay     =  1, /* Коммунальные платежи */
  CO_NalPer      = 11, /* Наличный перевод     */
  CO_Comission   = 21, /* Комиссия             */
  CO_Conversion  = 31, /* Конверсия            */
  CO_Payed       = 41; /* Выплата              */

const
  CI_OGSZ=1,
  CI_LOTTERY=2,
  CI_CERT=3,
  CI_COIN=4,
  CI_INGOT=5,
  CI_MISC=10;

const
  AS_OPEN = 0,
  AS_CLOSED = 1;

const
  FLAGDEBCRED_IN   = 1,  /* Кредит */
  FLAGDEBCRED_OUT  = 2;  /* Дебет */

const
  RESMESUNIT_POINT = 1,  /* Поштучно   */
  RESMESUNIT_MONEY = 2;  /* Стоимость  */

const
  TYPEDOC_CARRYOFF = 1,  /* Отложен (не подтвержден) */
  TYPEDOC_CARRYON  = 2;  /* Проведен (подтвержден) */

const
  CASHOP_REINFORCE = 1,  /* Подкрепление кассира */
  CASHOP_RETURN    = 2,  /* Возврат средств в кладовую */
  CASHOP_COLLECT   = 3,  /* Инкассация */
  CASHOP_ADVANCE   = 4,  /* Аванс */
  CASHOP_DEBIT     = 5,  /* Расход */
  CASHOP_CREDIT    = 6,  /* Приход */
  CASHOP_REMOVE    = 7,  /* Внутреннее подкрепление (Расход) */
  CASHOP_REMOVE_1  = 8,  /* Внутреннее подкрепление (Приход) */
  CASHOP_CHVALUE   = 9,  /* Перевод на другой ресурс той же группы (Расход) */
  CASHOP_CHVALUE_1 = 10, /* Перевод на другой ресурс той же группы (Приход) */
  CASHOP_REMOVE_SAFE   = 11,  /* Внутреннее подкрепление сейфа (Расход) */
  CASHOP_REMOVE_SAFE_1 = 12,  /* Внутреннее подкрепление сейфа (Приход) */
  CASHOP_DEBET_SAFE = 13,  /* Расход из сейфа */
  CASHOP_CREDIT_SAFE = 14, /* Приход в сейф */
  CASHOP_REVAL_POS = 18, /* Переоценка (+) */
  CASHOP_REVAL_NEG = 19, /* Переоценка (-) */
  CASHOP_PANT_RI   = 20, /* Подкрепление филиала */
  CASHOP_PANT_RET  = 21, /* Возврат из филиала */
  CASHOP_PANT_RIO  = 22, /* Подкрепление оперчасти */
  CASHOP_PANT_RETO = 23, /* Возврат из оперчасти */
  CASHOP_PANT_COL  = 24, /* Инкассация */
  CASHOP_PANT_ADV  = 25, /* Аванс */
  CASHOP_PANT_RDEB = 30, /* Расход по кассе пересчета */
  CASHOP_PANT_RCRD = 31, /* Приход по кассе пересчета */
  CASHOP_PANT_RDRT = 32; /* Сдача ресурса в кладовую из Кассы пересчета */

const
  TYPERES_MINCAPISSUE = 500; /* Минимально возможный код ЦБ */

const
  ALG_CASH_VAL_TYPE = 811;    /* Типы ресурсов кассы в namealg.dbt */

const
  TYPE_RES_NOPAY   = 1;

const
  VALFORM_27 = 6;

var
  {DeskOpen} = true,
  {EDeskOpen} = false,
  {RprtDSubj}, 
  {curdate},
  IsCur,
  Safe,
  OperBrigade = GetOperBrigade,
  Branch=NumFNCash,
  Mode = GetCurrentMode,
  Chapter,
  Chapter1IsEmpty,
  SmthPrinted,
  SmthPrinted_Accum,
  MetalSubheadPrinted;

var
  TotPrevRest=$0,
  TotCredit=$0,
  TotDebet=$0,
  TotOtherCred=$0,
  TotOtherDeb=$0,
  TotRest=$0,
  TotPrevRestC=$0,
  TotPrevRestCR=$0,
  TotPrevRestCRN=$0,
  TotCreditC=$0,
  TotCreditCR=$0,
  TotDebetC=$0,
  TotDebetCR=$0,
  TotRestC=$0,
  TotRestCR=$0,
  TotPrevRestA=$0,
  TotCreditA=$0,
  TotDebetA=$0,
  TotOtherCredA=$0,
  TotOtherDebA=$0,
  TotRestA=$0,
  TotPrevRestPurposeP=$0,
  TotCredPurposeP=$0,
  TotDebPurposeP=$0,
  TotOtherCredPurposeP=$0,
  TotOtherDebPurposeP=$0,
  TotCurRestPurposeP=$0,
  TotPrevRestPurpose=$0,
  TotCredPurpose=$0,
  TotDebPurpose=$0,
  TotOtherCredPurpose=$0,
  TotOtherDebPurpose=$0,
  TotCurRestPurpose=$0,
  TotPrevRestF=$0,
  TotCreditF=$0,
  TotDebetF=$0,
  TotOtherCredF=$0,
  TotOtherDebF=$0,
  TotRestF=$0,
  TotPrevAcc=0,
  TotAcc=0,
  TotOpenedAcc=0,
  TotClosedAcc=0,
  BATotPrevAcc=0,
  BATotPrevRest=0,
  BATotOpenedAcc=0,
  BATotCredit=0,
  BATotClosedAcc=0,
  BATotDebet=0,
  BATotAcc=0,
  BATotRest=0,
  TotPrevNOps=0,
  TotNOps=0;

var 
  TotPrevEstimRest = $0L,
  TotEstimIn       = $0L,
  TotEstinOut      = $0L,
  TotEstimOverOut  = $0L,
  TotEstimRest     = $0L,
  BAPrevEstimRest  = $0L,
  BAEstimIn        = $0L,
  BAEstinOut       = $0L,
  BAEstimOverOut   = $0L,
  BAEstimRest      = $0L;

var WasPrintBA    = FALSE;
var WasPrintEstim = FALSE;
var WasPrintCurr  = FALSE;
var NumBA = "";

array NameValArr;

macro IsKept

  record tmpCashVal( "sb_casvl.dbt" );
  copy( tmpCashVal, CashVal.rec );

  if ( not FindCVSettings( tmpCashVal ) )
    return true;
  end;
  return CVSettings.KeepRests != StrFor( 0 );
end;

macro IsShown

  record tmpCashVal( "sb_casvl.dbt" );
  copy( tmpCashVal, CashVal.rec );

  if ( not FindCVSettings( tmpCashVal ) )
    return true;
  end;
  return CVSettings.Form24 != StrFor( 0 );
end;

/**************************************************************************/
/*  Получить название типа ресурса кассы                                  */
macro GetCashTypeName(Type)

  Alg.iTypeAlg = ALG_CASH_VAL_TYPE;
  Alg.iNumberAlg = Type;
  if(GetEQ(Alg))
    return Alg.szNameAlg;
  else
    return String(Type);
  end;
end;

/**************************************************************************/
/*  Получить название ресурса кассы                                       */
macro GetValName
  var str = CashVal.rec.NameValue;
  if ( CashVal.rec.Type != 0 )
    str = str + " (" + GetCashTypeName(CashVal.rec.Type) + ")";
  end;
  return str;
end;

macro FindCIMisc( Type, IssueID )

  CIMisc.Type = Type;
  CIMisc.IssueID = IssueID;
  return GetEQ( CIMisc );
end;

macro IsDebetCredit
  return FLAGDEBCRED_IN;
end;

macro IsQuarterStart(curdate, prevdate)

  var curmon, prevmon;

  DateSplit(curdate,  null, curmon);
  DateSplit(prevdate, null, prevmon);
  if( (prevmon < curmon) and
          ( (prevmon == 3) or (prevmon == 6)
           or (prevmon == 9) or (prevmon == 12) )  )
    return true;
  end;

  return false;
end;

macro GetNativeSafe

  file Group("rtgroup.dbt") key 2;

  Group.Branch = Branch;
  Group.Date = {curdate};
  Group.ID = OperBrigade;
  if(GetEQ(Group))
    return Group.SafeID;
  else
    MsgBox("Не найден сейф бригады № ", OperBrigade);
    Exit;
  end;
end;

//Получить ID сейфа текущей смены,
//если текущий пользователь ревизор или управляющий то ему предлагается выбрать смену
macro SelectSafe
	var Safe;

	if (IsBoss() OR IsManager() )
  		Safe = SelectBrigadeForBranch(Branch, {curdate}, OperBrigade);
		if(not Safe)
		    Exit;
		end;
	else
		Safe = GetNativeSafe;
	end;

	return Safe;
end;

macro GetDiaryNo();

  file DepParm  ("depparm.dbt")  key 0;

  DepParm.FNCash = Branch;
  DepParm.FlagCur = 0;
  if ( not ( GetGE( DepParm )
    and ( DepParm.FNCash == Branch )
    and ( DepParm.FlagCur == 0 ) ) )
    MsgBox("Ошибка чтения параметров филиала");
    return 0;
  else
    return DepParm.NumOperDy;
  end;
end;

macro FindCICode( AutoKey )

  var
    OldKey = KeyNum( CICode, 0 ),
    Stat;

  CICode.AutoKey = AutoKey;
  Stat = GetEQ( CICode );
  KeyNum( CICode, OldKey );
  return Stat;
end;

macro WriteNBData(Brigade, PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb)

  var
    Stat=true;

  NBData.FNCash=Branch;
  NBData.IsCur=CashVal.rec.RefValueReport;
  NBData.Date={curdate};
  NBData.TypeValue=CashVal.rec.TypeValue;
  NBData.CodIntValue=CashVal.rec.CodIntValue;
  NBData.Brigade=Brigade;
  if(GetEQ(NBData))
    Stat=Delete(NBData);
  end;
  if(Stat and ((PrevRest!=0) or (CurRest!=0) or (Cred!=0) or (OtherCred!=0) or
    (Deb!=0) or (OtherDeb!=0)))
    NBData.RefValue=CashVal.rec.RefValue;
    NBData.Brigade=Brigade;
    NBData.KredCol=Money(OtherCred);
    NBData.DebCol=Money(OtherDeb);
    NBData.IncasCol=Money(Deb);
    NBData.AdvCol=Money(Cred);
    NBData.CurRest=Money(CurRest);
    NBData.PrevRest=Money(PrevRest);
    Insert(NBData);
  end;
end;

macro CalcTurns(RefValue, Credit, ICredit, Debet, IDebet)
  var
    IsCur = 0,
    RecFound,
    Cred = $0, ICred = 0,
    Deb = $0, IDeb = 0;
  SetParm(1, Cred);
  SetParm(2, ICred);
  SetParm(3, Deb);
  SetParm(4, IDeb);
end;

macro CalcOtherTurns(RefValue,OtherCred,IOtherCred,OtherDeb,IOtherDeb)
  var
    IsCur = 0,
    RecFound,
    Cred = $0, ICred = 0,
    Deb = $0, IDeb = 0;
  SetParm(1, Cred);
  SetParm(2, ICred);
  SetParm(3, Deb);
  SetParm(4, IDeb);
end;

macro IntTo07Str( n )

  var
    s = String( n );

  while ( StrLen( s ) < 7 )
    s = "0" + s;
  end;
  return s;
end;

macro ToStr( n )

  if ( ( CashVal.rec.TypeValue == CV_ValForm ) and ( CashVal.rec.CodIntValue == VALFORM_27 ) )
    return IntTo07Str( n );
  else
    return String( n );
  end;
end;

macro MakeRangeStr

  var
    Delim;

  if(RegNumList.Series != "")
    Delim = "-";
  else
    Delim = "";
  end;
/*
  return String(RegNumList.Series + Delim + ToStr( RegNumList.Min ):13:r ) + " .. " +
    String(RegNumList.Series + Delim + ToStr( RegNumList.Max ):13:l);
*/
  return String(RegNumToStr(RegNumList.Series,RegNumList.Min) + " .. " + 
		RegNumToStr(RegNumList.Series,RegNumList.Max));
end;

macro M2Int( m )

  return Int( Double( m ) );
end;

macro ForEachCurr( Proc )

  Currency.Rewind;
  Currency.AddFilter( "t_CrDifrRate <> chr( 0 )" );
  while ( Currency.Next )
    if ( Currency.Rec.CrDifrRate ) /* валюта используется */
      if ( Currency.rec.Code_Currency )
        IsCur = 1;
      end;
      ExecMacro( Proc );
      IsCur = 0;
    end;
  end;
  Currency.DropFilter;
end;

macro GetBranchName

  var
    RetVal;

  if(not findDepartment(Branch, RetVal))
    RetVal=String(Branch);
  end;
  return RetVal;
end;

