/* Справка о сумме принятых денег */
import DeprIntr, RD_Comm, RSD;

file BagList( "bag.dbt" ) key 2;

const
  BST_SENT     = 9,
  BST_RETURNED = 10;

//const
//  TP_OPER = "О";

var
  {RprtDSubj},
  N = 0,
  TotNBags = 0,
  TotTotSum = $0;
const 
   TYPEDOC_CARRYON = 2,
   CASHOP_CREDIT = 6,
   CASHOP_DEBIT  = 5,
   SB_RSBANK = 9000;
private var Branch = NumFNcash();
macro OutHead

  [ # ]( {Name_Bank} );
  [ ];
  [                                                СПРАВКА                                           ];
  [                          О СУММЕ ПРИНЯТЫХ ДЕНЕГ И КОЛИЧЕСТВЕ ПОСТУПИВШИХ                         ];
  [                                      В КАССУ ДЕНЕЖНЫХ ДОКУМЕНТОВ                                 ];
  [ ################################################################################################ ]
  ( ( "За " + String( {curdate}:m ) ):c );
  [ ];
  [--------------------------------------------------------------------------------------------------];
  [ №   | Фамилии операционных             |Кол-во   | Сумма прихода   | Подписи операционных        ];
  [ п/п | работников                       |приходных|                 | работников                  ];
  [     |                                  |док-тов, |                 |                             ];
  [     |                                  |поступив.|                 |                             ];
  [     |                                  |в кассу  |                 |                             ];                      
  [--------------------------------------------------------------------------------------------------];
end;

macro OutLine( NBags, TotSum );

  N = N + 1;
  [##### ################################## ######### #################                              ]
  (
    N,
    Person.Name,
    NBags,
    Cur2Rub( TotSum )
  );                      
end;

macro OutTotals

  var
    Maj, Min;
  
  [--------------------------------------------------------------------------------------------------];
  [      Всего:                             ######### #################                              ]
  (
    TotNBags,
    Cur2Rub( TotTotSum )
  );
  [ ];
  if ( Curr.Code_Currency == 0 )
    PrintLn( "Всего за день, руб.: ", RubToStr( TotTotSum ) );
  else
    RubToStr( TotTotSum, Maj, Min );
    PrintLn( "Всего за день, ", Curr.Short_Name, ": ", Maj, " ", Min  );
    PrintLn( "Всего за день, руб.: ", RubToStr( Cur2Rub( TotTotSum ) ) );
  end;
end;

macro OutFooter

 [ ];
 [ Кассовый работник:                                ____________________ ];
 [                                                        (подпись)       ];
 [ ];
 [ Заведующий кассой:                                ____________________ ];
 [                                                        (подпись)       ];
 Print( StrFor( 12 ) );
end;

macro CountBagsForOper( NBags, TotSum )

  var
    RecFound,
    dt,
    cmd_1, cmd_2,
    rs_1, rs_2,	 
    BrigadeID = GetOperBrigade;

  NBags = 0;
  TotSum = $0;

if ( StrFor(GetProgramID) == "Л" )
  ClearRecord( BagList );
  BagList.Branch = Branch;  
  BagList.Date = {curdate};
  BagList.State = BST_RETURNED;
  RecFound = GetGE( BagList );
  while ( RecFound
    and ( BagList.Branch == Branch )  
    and ( BagList.Date == {curdate} )
    and ( BagList.State == BST_RETURNED ) )
     if (  ( BagList.Safe == {RprtDSubj} )
       and ( BagList.ValueRef == CashValue.RefValue ) 
       and ( BagList.Oper == Person.Oper ) 
       and ( BagList.Operation != CASHOP_PANT_RDEB ) )
       NBags = NBags + 1;
       if ( BagList.RealSum )
         TotSum = TotSum + BagList.RealSum;
       else
         TotSum = TotSum + Money( BagList.RealItems );
       end;
     end;
     RecFound = Next( BagList );
  end; 
else 
  cmd_1 = RsdCommand(" select count(*) from DSB_CASDC_DBT, dsb_casln_dbt, dret_op_dbt "
                     " where (DSB_CASDC_DBT.T_CASHDATEDOC = ? ) AND (DSB_CASDC_DBT.T_BRANCH = ?) AND "
                     " (DSB_CASDC_DBT.T_TYPEDOC = ?) AND (DSB_CASDC_DBT.T_REFVALUE = ?) AND "
                     " (DSB_CASDC_DBT.T_BRIGADE = ?) AND (DSB_CASDC_DBT.T_NUMOPER = ?) and  "
                     " (dsb_casdc_dbt.T_APPLICATIONKIND = dsb_casln_dbt.T_APPLICATIONKIND2) and "
                     " (dsb_casln_dbt.T_APPLICATIONKIND1 = dret_op_dbt.T_APPLICATIONKIND) and "
                     " (dret_op_dbt.T_OPER = ?)  and  (dsb_casdc_dbt.T_APPLICATIONKEY = dsb_casln_dbt.T_APPLICATIONKEY2)"
                     " and (dsb_casln_dbt.T_APPLICATIONKEY1 = dret_op_dbt.T_APPLICATIONKEY) "
                     " and (dsb_casdc_dbt.T_REFVALUE = dsb_casln_dbt.T_REFVALUE2) and "
                     " dsb_casdc_dbt.T_APPLICATIONKIND = ? "  );
  cmd_1.addParam("DSB_CASDC_DBT.T_CASHDATEDOC", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_CASHDATEDOC") =  {curdate};
  cmd_1.addParam("DSB_CASDC_DBT.T_BRANCH", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_BRANCH")=NumFNCash;
  cmd_1.addParam("DSB_CASDC_DBT.T_TYPEDOC", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_TYPEDOC") = TYPEDOC_CARRYON;
  cmd_1.addParam("DSB_CASDC_DBT.T_REFVALUE", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_REFVALUE") = CashValue.RefValue;
  cmd_1.addParam("DSB_CASDC_DBT.T_BRIGADE", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_BRIGADE") = BrigadeID;
  cmd_1.addParam("DSB_CASDC_DBT.T_NUMOPER", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_NUMOPER") = CASHOP_CREDIT;
  cmd_1.addParam("dret_op_dbt.T_OPER", RsdBp_in); 
  cmd_1.value("dret_op_dbt.T_OPER") = Person.oper;
  cmd_1.addParam("dsb_casdc_dbt.T_APPLICATIONKIND",RsdBp_in);
  cmd_1.value("dsb_casdc_dbt.T_APPLICATIONKIND") = SB_RSBANK;
 cmd_1.execute;

  cmd_2 = RsdCommand(" select sum(T_VALUEMONEY) from DSB_CASDC_DBT, dsb_casln_dbt, dret_op_dbt where "
                     " (DSB_CASDC_DBT.T_CASHDATEDOC = ? ) AND (DSB_CASDC_DBT.T_BRANCH = ?) AND "
                     " (DSB_CASDC_DBT.T_TYPEDOC = ?) AND (DSB_CASDC_DBT.T_REFVALUE = ?) AND "
                     " (DSB_CASDC_DBT.T_BRIGADE = ?) AND (DSB_CASDC_DBT.T_NUMOPER = ?) and  "
                     " (dsb_casdc_dbt.T_APPLICATIONKIND = dsb_casln_dbt.T_APPLICATIONKIND2) and "
                     " (dsb_casln_dbt.T_APPLICATIONKIND1 = dret_op_dbt.T_APPLICATIONKIND) and "
                     " (dret_op_dbt.T_OPER = ?)  and  (dsb_casdc_dbt.T_APPLICATIONKEY = dsb_casln_dbt.T_APPLICATIONKEY2)"
                     " and (dsb_casln_dbt.T_APPLICATIONKEY1 = dret_op_dbt.T_APPLICATIONKEY) and "
                     " (dsb_casdc_dbt.T_REFVALUE = dsb_casln_dbt.T_REFVALUE2) and" 
                     " dsb_casdc_dbt.T_APPLICATIONKIND = ? "  );

  cmd_2.addParam("DSB_CASDC_DBT.T_CASHDATEDOC", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_CASHDATEDOC") =  {curdate};
  cmd_2.addParam("DSB_CASDC_DBT.T_BRANCH", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_BRANCH")=NumFNCash;
  cmd_2.addParam("DSB_CASDC_DBT.T_TYPEDOC", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_TYPEDOC") = TYPEDOC_CARRYON;
  cmd_2.addParam("DSB_CASDC_DBT.T_REFVALUE", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_REFVALUE") = CashValue.RefValue;
  cmd_2.addParam("DSB_CASDC_DBT.T_BRIGADE", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_BRIGADE") = BrigadeID;
  cmd_2.addParam("DSB_CASDC_DBT.T_NUMOPER", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_NUMOPER") = CASHOP_CREDIT;
  cmd_2.addParam("dret_op_dbt.T_OPER", RsdBp_in); 
  cmd_2.value("dret_op_dbt.T_OPER") = Person.oper;
  cmd_2.addParam("dsb_casdc_dbt.T_APPLICATIONKIND",RsdBp_in);
  cmd_2.value("dsb_casdc_dbt.T_APPLICATIONKIND") = SB_RSBANK;

 cmd_2.execute;

  rs_1 = RsdRecordset(cmd_1); 
  rs_1.moveNext();
  rs_2 = RsdRecordset(cmd_2);
  rs_2.moveNext();
                                 	

  NBags = Int(rs_1.value(0));
  if ( rs_2.value(0) != null )
    TotSum = Money(rs_2.value(0));
  else 
    TotSum = 0;
  end;
end;

  SetParm( 0, NBags );
  SetParm( 1, TotSum );
end;

macro TreatOper

  var
    NBags,
    TotSum;

  CountBagsForOper( NBags, TotSum );
  if ( TotSum != $0 )
    OutLine( NBags, TotSum );
    TotNBags = TotNBags + NBags;
    TotTotSum = TotTotSum + TotSum;
  end;
end;

macro Report( IsCur )

  var
    CurrCode = 0;

  if ( IsCur )
    if ( not SelectCurrency( CurrCode ) )
      Exit( 1 );
    end;
  end;

  if ( not FindCurr( CurrCode ) )
    MsgBox( "Не найдена валюта с кодом ", CurrCode );
    Exit( 1 );
  end;

  if ( not FindCashValForTypeCode( 0, TYPERES_CURRENCY, CurrCode ) )
    MsgBox( "Не найден ресурс Кассы для валюты '" + Curr.Name_Currency + "'" );
    Exit( 1 );
  end;

  GetCBRate;

  OutHead;

  Rewind( Person );
  while ( Next( Person ) )
    TreatOper;
  end;

  OutTotals;
  OutFooter;
end;
