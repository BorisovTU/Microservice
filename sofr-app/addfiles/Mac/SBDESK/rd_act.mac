
/* Акт на излишки и недостачу */

import deprintr, DeskInter, RD_Comm;

file BagList( "bag.dbt" ) key 0;

var
  PayerName,
  Number,
  Overplus = $0,
  Shortage = $0,
  Bad = $0,
  Dubious = $0;

macro AddSum( Total, Partial )

  var
    Stat = true;
  var ScaleRate = 1;
  var _rateCB = 0.0;

  if ( ( CashValue.TypeValue == TYPERES_CURRENCY ) and ( CashValue.CodIntValue != 0 ) )
    Stat = FindCurr( CashValue.CodIntValue );
    if ( Stat )
      stat = GetAllCurrRate( {curdate}, CashValue.CodIntValue, _rateCB );
    end;
    if ( Stat )
      Total = Total + SumConv( Partial, _rateCB, 1 );
    end;
  else
    if ( CashValue.UnitMeas != RESMESUNIT_POINT )
      Total = Total + Partial;    
    else
      Total = Total + Money( Partial );     
    end;
  end;
  if ( not Stat )
    MsgBox( "Не найдена валюта. Код " + CashValue.CodIntValue );
    Exit( - 1 );
  end;
  SetParm( 0, Total );
end;

macro AddSums

  if ( BagList.Overplus )
    AddSum( Overplus, BagList.Overplus );
  else
    AddSum( Overplus, Money( BagList.OverplusItems ) );
  end;
  if ( BagList.Shortage )
    AddSum( Shortage, BagList.Shortage );
  else
    AddSum( Shortage, Money( BagList.ShortageItems ) );
  end;
  if ( BagList.Bad )
    AddSum( Bad, BagList.Bad );
  else
    AddSum( Bad, Money( BagList.BadItems ) );
  end;
  if ( BagList.Dubious )
    AddSum( Dubious, BagList.Dubious );
  else
    AddSum( Dubious, Money( BagList.DubiousItems ) );
  end;
end;

macro GetSums

  var
    Stat = true,
    RecFound;

  ClearRecord( BagList );
  BagList.Branch = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )  
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    Stat = FindCashValue( BagList.ValueRef );
    if ( Stat )
      AddSums;
    end;
    RecFound = Next( BagList );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при расчете суммы" );
    Exit( -1 );
  end;
end;

macro PrintSumLine( SumDesc, Sum )

  if ( Sum == $0 )
    return;
  end;

  [ в пачке                                    целой                              ];
  [ -------  за № _____________________ с  -------------  упаковкой               ];
  [  мешке                                   нарушенной                           ];
  [                                                                               ];   
  [                       целой              пломбой №                            ];  
  [ ############## с ----------------      -----------------------------          ]   
  ( SumDesc );                                                                        
  [                     нарушенной           упаковкой №                          ];  
  [                                                                               ];  
  [        целыми                                                                 ];  
  [ с ----------------- бандеролями ##############                                ]   
  ( SumDesc );                                                                        
  [      нарушенными                                                              ];  
  [                                                         банкнот(а) №№         ];           
  [ _____________________________________________________ ----------------------  ];  
  [         ( количество цифрами и прописью )               монеты(а)             ];  
  [                                                                               ];  
  [ достоинством __________________________________ на сумму руб. ##############  ]   
  ( Sum:l );                                                                          
  [ ############################################################################# ]   
  ( "( " +  String( Sum:m ) + " )" );                                                                          
  [                                                                               ];  
  [           пачка в количестве .... корешков, из которых в .... корешке         ];  
  [ Указанная ------------------------------------------------------------ был(а) ];  
  [                           монета из мешка, в котором                          ];  
  [                                                                               ];  
  [                                банкнот(а)                                     ];  
  [ обнаружен(а) ############### --------------, пересчитана полностью            ]   
  ( SumDesc );                                                                        
  [                                монеты(а)                                      ];  
  [                                                                               ];  
  [ ######## ###################################################### ############# ]  
  ( "кассиром", Bag.OperName:w, "в присутствии" );
  [                                                                               ];
  [ ____________________________________________________________________ при этом ];  
  [              ( должность, фамилия, имя, отчество )                            ];    
  [                                                                               ];  
  [                      банкнот(а)                                               ];  
  [ ################### ------------ в сумме руб. #############################   ]   
  ( SumDesc, Sum:l );                                                                 
  [                      монет(а)                                                 ];  
  [                                                                               ];  
  [ ########################################################## подтвердился(лась) ]   
  ( "( " + String( Sum:m ) + " )" );                                                                          
  [                                                                               ];  
end;

macro PrintSums

  PrintSumLine( "излишек", Overplus );
  PrintSumLine( "недостача", Shortage );
  PrintSumLine( "неплатежная", Bad );
  PrintSumLine( "сомнительная", Dubious );
end;

macro PrintAct

  [                                                                               ];
  [                                                               --------------- ];
  [                                                               |   0482145   | ];
  [                                                               --------------- ];
  [                                                                               ];
  [                                   А К Т                                       ];
  [                                                                               ];
  [ ##################################                          № ##############  ]
  ( Bag.Date:m, Number:l );
  [                                                                               ];
  [       об излишках, недостачах                     банкнот(ах) в пачках        ];
  [       -------------------------                   --------------------        ];
  [       неплатежных, сомнительных                   монеты(ах) в мешках         ];
  [                                                                               ];
  [ в упаковке ################################################################## ]   
  ( PayerName );
  [                                                                               ];
  [ Настоящий акт составлен ##################################################### ]
  ( {Name_Bank} );
  [                                                                               ];
  [ в ################### в том, что сего числа при вскрытии и пересчета в кассе, ]
  ( GetCity );
  [                                                                               ];
  [ в предкладовой, в помещении для пересчета денег клиентом,                     ];
  [                                                                               ];
  [ банкнот  кассовым работником                                                  ];
  [ ############################ ################################################ ]
  ( "-------  ------------------- ", Bag.OperName:w );
  [ монет         клиентом                                                        ];
  [                                                                               ];
  [ в присутствии _______________________________________________________________ ];
  [               ( фамилия, имя, отчество кассового работника учреждения банка ) ];
  [                                                                               ];
  [ был(а,и) обнаружен(а,и)                                                       ];    
  [                                                                               ];
  PrintSums;
  [                                                                               ];
  [                                                                               ];
  [ Подписи лиц, производивших пересчет    ______________________________________ ];
  [                                               ( расшифровка подписей )        ];
  [                                                                               ];
  [ Подписи лиц, присутствовавших          ______________________________________ ];
  [ при пересчете                                 ( расшифровка подписей )        ];
  [                                                                               ];
  [                                                                               ];
  [                                                                               ];
  [     К акту прилагаются:                                                       ];       
  [        - верхняя и нижняя накладки от пачки;                                  ];
  [        - бандероли от всех корешков ( полной величины );                      ];
  [        - обвязка с пломбой ( полиэтиленовый рукав с оттисками клише ) и       ];                         
  [          и ярлык от мешка с монетами, где был(а) обнаружен(а)                 ];
  [                                                                               ];
  [       излишек, недостача                          банкнот(а)                  ];
  [       -------------------------                 -------------                 ];
  [       неплатежная, сомнительная                   монеты(а)                   ];
  [                                                                               ];
end;

  if ( Bag.RouteID != 0 )
    CheckPersonType( PT_OPER );
  end;

  GetClientInfo( Bag.ClientType, Bag.ClientID, PayerName );
  GetSums;

  if ( ( Overplus == $0 )
    and ( Shortage == $0 )
    and ( Bad == $0 )
    and ( Dubious == $0 ) )
    Exit( 1 );
  end;

  if ( GetTrue( false, "Печатать акт на излишки/недостачу ?" ) )
    GetInt( Number, "Введите номер акта" );
    if ( ValType( Number ) != V_INTEGER )
      Exit( -1 );
    end;
    PrintAct;
  end;
end;
