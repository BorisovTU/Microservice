
/* Реестр ценностей, направляемых через инкассаторов*/

import deprintr, DeskInter, RD_Comm, Ingot, DocBunch;

file BagList( "bag.dbt" ) key 0;

const CI_INGOT = 5;

var Str_form;

macro FindBagDoc
    
  BagDoc.BagAppKind = BagList.ApplicationKind;
  BagDoc.BagAppKey  = BagList.ApplicationKey;
  BagDoc.State      = BagList.State;
  return GetEQ( BagDoc );
end; 

macro GetIngotsCost

  var
    Found,
    Bunch,
    IngDoc;

  if ( FindBagDoc )    
    Bunch = TDocBunch( BagDoc.ApplicationKind, BagDoc.ApplicationKey );
    Found = Bunch.FirstDoc;
    while ( Found ) 
      if ( Bunch.DocValueRef == BagList.ValueRef )
        IngDoc = TIngotCashDoc( Bunch.DocAppKind, Bunch.DocAppKey, BagList.ValueRef );  
        return IngDoc.GetRubValue( BagList.Date );      
      end;
      Found = Bunch.NextDoc;
    end;
  end;       
  return $0;
end;

macro GetSum( Sum )

  var
    Stat = true,
    RecFound;
  var ScaleRate = 1;
  var _rateCB = 0.0;

  Sum = 0;
  ClearRecord( BagList );
  BagList.Branch = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    FindCashValue( BagList.ValueRef );
    if ( CashValue.TypeValue == TYPERES_MINCAPISSUE + CI_INGOT )
      Sum = Sum + GetIngotsCost;
    elif ( CashValue.TypeValue == TYPERES_CURRENCY )
       if ( Stat )
         Stat = FindCurr( CashValue.CodIntValue );
       end;
       if ( Stat )
         stat = GetAllCurrRate( {curdate}, CashValue.CodIntValue, _rateCB );
       end;
       if ( Stat )
         Sum = Sum + SumConv( BagList.RealSum, _rateCB, 1 );
       end;
    else
      if ( BagList.RealSum )
        Sum = Sum + BagList.RealSum;    
      else
        Sum = Sum + Money( BagList.RealItems );     
      end;
    end;
    RecFound = Next( BagList );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при расчете суммы" );
    Exit( -1 );
  end;
  SetParm( 0, Sum );  
end;

macro PrintRegistry

  var 
    Sum;

  GetSum( Sum );

  [                                                                              ];
  [                                                                              ];
  [                                   Реестр                                     ];
  [                 ценностей, направляемых через инкассаторов                   ];      
  [                                                                              ];
  [            Отправитель:#                                                     ]
  ( {Name_Bank} );                                                             
  [                        ------------------------------------------------------];
  [                               (наименование учереждения банка)               ];
  [                                                                              ];
  [                                             #################################]
  ( Bag.Date:m:r );
  [                                                                              ];
  [                                                                              ];
  [------------------------------------------------------------------------------];
  [|                    Заполняет отправитель                    | Заполняет    |];
  [|							         | приемщик     |];
  [------------------------------------------------------------------------------];
  [| № |№№ |     КУДА     |     КОМУ     |   №№    |  Оценочная  | Сумма |   №№ |];
  [|п/п|су-|  (пункт на-  |  (подробное  |  плом-  |  стоимость в| сборов| прием|];
  [|   |мок|  значения,   | наименование |  биров  |    рублях   |       |  ные |];
  [|   |   |    район,    |   адресата)  |(печатей)| (цифрами и  |       |      |];
  [|   |   |   область)   |              |         |  прописью   |       |      |];
  [------------------------------------------------------------------------------];
  [|   |   |              |              |         |             |руб|коп|      |];
  [------------------------------------------------------------------------------];
  [  #  ### ############## ##############           #############                ]
  (   
    1,
    Bag.Number,
    "Москва, ул.Вавилова 19":w,
    "Отдел кассовых операций Операционного управления Сбербанка России":w,
    ( Sum + " (" + RubToStr( Sum ) + ")" ):w
  );
  [------------------------------------------------------------------------------];
  [|Всего:                                   ####################|   |   |      |]
  ( Sum );
  [------------------------------------------------------------------------------];
/*  [----------------------------------------------------------------------------];
  [ # ] ( Sum:m ); */
  [                                                                              ];
  [                                                                              ];
  [ Руководитель           ____________________________________________          ];                                     
  [                                                                              ];
  [ Главный бухгалтер      ____________________________________________          ];                                     
  [                                                                              ];
  [ Начальник ОКО(Заведующий кассой) __________________________________          ];                                     
  [                                                                              ];
  [ Специалист по драгметаллам       __________________________________          ];                                     
  [                                                                              ];
 if(Str_form!=3)                                                                 
  [                                                                              ];
  [ Указанные места груза в количестве  1 (одной)                                ];
  [                                  ( количество прописью )                     ];
  [                                                                              ];
  [ #################################  ######################    ####            ]
  ( "штук на общую оценочную стоимость", ( RubToStr( Sum ) ):w, "Руб." );                                                     
/*  [                                    --------------------------                        ];*/
  [                                       ( сумма прописью )                     ];
  [ и первый экземпляр реестра к ним приняты в исправной упаковке от             ];
  [ инкассаторов_________________________________________________________________];
  [                                                                              ];
  [ _____________________________________________________________________________];
  [                                                                              ];
  [                                                                              ];
  [ Сдали:                                                                       ];
  [ Инкассаторы                                 ________________________(Ф.И.О.) ];
  [                                                                              ];
  [                                             ________________________(Ф.И.О.) ];
  [                                                                              ];
  [                                             ________________________(Ф.И.О.) ];
  [                                                                              ];
  [                                                                              ];
  [ Приняли:                                                                     ];
  [ Руководитель                                ________________________(Ф.И.О.) ];
  [                                                                              ];
  [ Главный бухгалтер                           ________________________(Ф.И.О.) ];
  [                                                                              ];
  [ Начальник ОКО (Зав.Кассой)                  ________________________(Ф.И.О.) ];
  [                                                                              ];
  [ Специалист по драгметаллам                  ________________________(Ф.И.О.) ];
 else
  [                                                                              ];
  [ Указанные места груза в количестве  1 (одной)                                ];
  [                                  ( количество прописью )                     ];
  [                                                                              ];
  [ #################################  ######################    ####            ]
  ( "штук на общую оценочную стоимость", ( RubToStr( Sum ) ):w, "Руб." );                                                     
/*  [                                    --------------------------                ];*/
  [                                       (сумма прописью)                       ];
  [ в исправной упаковке и первый и второй экземпляры реестра к ним приняты от   ];
  [                                                                              ];
  [ начальника ОКО (Заведующий кассой)__________________________________________ ];
  [                                     (фамилия, инициалы)                      ];
  [                                                                              ];
  [ Сдали:                                                                       ];
  [ Руководитель                                ________________________(Ф.И.О.) ];
  [                                                                              ];
  [ Главный бухгалтер                           ________________________(Ф.И.О.) ];
  [                                                                              ];
  [ Начальник ОКО (Зав.Кассой)                  ________________________(Ф.И.О.) ];
  [                                                                              ];
  [ Специалист по драгметаллам                  ________________________(Ф.И.О.) ];
  [                                                                              ];
  [                                                                              ];
  [ Приняли:                                                                     ];
  [ Инкассаторы                                 ________________________(Ф.И.О.) ];
  [                                                                              ];
  [                                             ________________________(Ф.И.О.) ];
  [                                                                              ];
  [                                             ________________________(Ф.И.О.) ];
 end;
end;

  if ( GetTrue( false, "Печатать реестр ?" ) )
    Str_form=1;
    PrintRegistry;
    PrintLn( StrFor( 12 ) );
    Str_form=2;
    PrintRegistry;
    PrintLn( StrFor( 12 ) );
    Str_form=3;
    PrintRegistry;
  end;    
end;