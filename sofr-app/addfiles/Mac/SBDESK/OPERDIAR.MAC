/* „­¥¢­¨ª ®¯¥à æ¨© ª áá¨à  */

import deprintr;

file CashDoc     ( "sb_casdc.dbt"            ) key 0;
file DeskSubj    ( "desksubj.dbt"            ) key 0;
file GroupMember ( "groupmem.dbt"            ) key 0;
file Person      ( "person.dbt",  "bank.def" ) key 0;
file NameAlg     ( "namealg.dbt", "bank.def" ) key 0;

const
  CD_Uncarried = 1,
  CD_Carried = 2;

const
  OC_Debet="1",
  OC_Credit="2";

const
  TA_CashOps = 803,
  TA_Applications = 805;

var
  Branch = NumFNCash,
  OperBrigade = GetOperBrigade,
  {curdate},
  {oper};

macro GetOperAccess(OperNo)
                      
  Person.Oper=OperNo;
  if(not GetEQ(Person))
    MsgBox("®«ì§®¢ â¥«ì ", OperNo, " ­¥ ­ ©¤¥­");
    Exit;
  else
    return Person.cTypeInDesk;
  end;
end;

macro GetAppName(AppKind);

  NameAlg.iTypeAlg=TA_Applications;
  NameAlg.iNumberAlg=AppKind;
  if(not GetEQ(NameAlg))
    return "";
  else
    return NameAlg.szNameAlg;
  end;
end;

macro GetOpName(OpNum);

  NameAlg.iTypeAlg=TA_CashOps;
  NameAlg.iNumberAlg=OpNum;
  if(not GetEQ(NameAlg))
    return "";
  else
    return NameAlg.szNameAlg;
  end;
end;

macro OutTitle(CashOper);

  [
                                „­¥¢­¨ª ®¯¥à æ¨© ª áá¨à  ####
                                        §  ##########
  ]
  (CashOper,String({curdate}));
end;

macro OutCarriedDocsSubTitle;

  PrintLn;
  PrintLn("  à®¢¥¤¥­­ë¥ ¤®ªã¬¥­âë");
  PrintLn;
end;

macro OutUncarriedDocsSubTitle;

  PrintLn;
  PrintLn("  â«®¦¥­­ë¥ ¤®ªã¬¥­âë");
  PrintLn;
end;

macro OutHeader;

  [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   ³                         ³                            ³                  „ ¥ ­ ì £ ¨                   ³   – ¥ ­ ­ ® á â ¨   ³
   ³    à ¨ « ® ¦ ¥ ­ ¨ ¥   ³       ¯ ¥ à   æ ¨ ï       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´
   ³                         ³                            ³       à ¨ å ® ¤       ³         á å ® ¤      ³  à¨å®¤  ³   áå®¤  ³
   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄ´];
end;

macro OutLine;

  var
    MoneyDebet="",
    MoneyCredit="",
    ValDebet="",
    ValCredit="";

  if(CashDoc.FlagDebCredOper==OC_Debet)
    if(CashDoc.ValueMoney>$0.00)
      MoneyDebet=String(CashDoc.ValueMoney);
    elif(CashDoc.ValueCol)
      ValDebet=String(CashDoc.ValueCol);
    end;
  else
    if(CashDoc.ValueMoney>$0.00)
      MoneyCredit=String(CashDoc.ValueMoney);
    elif(CashDoc.ValueCol)
      ValCredit=String(CashDoc.ValueCol);
    end;
  end;

  [³ ####################### ³ ########################## ³ ###################### ³ ##################### ³ ######## ³ ######## ³]
  (GetAppName(CashDoc.ApplicationKind),GetOpName(CashDoc.NumOper),
    MoneyDebet:r,MoneyCredit:r,ValDebet:r,ValCredit:r);
end;

macro OutBottomLine;

  [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÙ];
end;

macro OutCarriedDocs(Subj);

  CashDoc.Branch=Branch;
  CashDoc.CashDateDoc={curdate};
  CashDoc.TypeDoc=CD_Carried;
  CashDoc.CashOper=Subj;
  CashDoc.RefValue=0;

  OutCarriedDocsSubTitle;
  OutHeader;

  if(GetGE(CashDoc) and
    (CashDoc.Branch==Branch) and
    (CashDoc.CashDateDoc=={curdate}) and
    (CashDoc.TypeDoc==CD_Carried) and
    (cashDoc.CashOper==Subj))
    OutLine;
    while(Next(CashDoc) and
      (CashDoc.Branch==Branch) and
      (CashDoc.CashDateDoc=={curdate}) and
      (CashDoc.TypeDoc==CD_Carried) and
      (cashDoc.CashOper==Subj))
      OutLine;
    end;
  end;

  OutBottomLine;
end;

macro OutUncarriedDocs(Subj);

  CashDoc.Branch=Branch;
  CashDoc.CashDateDoc={curdate};
  CashDoc.TypeDoc=CD_Uncarried;
  CashDoc.CashOper=Subj;
  CashDoc.RefValue=0;

  OutUncarriedDocsSubTitle;
  OutHeader;

  if(GetGE(CashDoc) and
    (CashDoc.Branch==Branch) and
    (CashDoc.CashDateDoc=={curdate}) and
    (CashDoc.TypeDoc==CD_Uncarried) and
    (cashDoc.CashOper==Subj))
    OutLine;
    while(Next(CashDoc) and
      (CashDoc.Branch==Branch) and
      (CashDoc.CashDateDoc=={curdate}) and
      (CashDoc.TypeDoc==CD_Uncarried) and
      (cashDoc.CashOper==Subj))
      OutLine;
    end;
  end;

  OutBottomLine;
end;

macro GetWorkDeskName( OperID, BrigadeID )

  var
    OperStr = String( OperID ),
    BrigadeStr = String( BrigadeID );

  return MkStr( "0", 4 - StrLen( OperStr ) ) + OperStr + "/" +  
    MkStr( "0", 2 - StrLen( BrigadeStr ) ) +BrigadeStr;
end;

macro ReportForOper(CashOper);

  var
    WDName = GetWorkDeskName( CashOper, OperBrigade );

  OutTitle(CashOper);
  OutCarriedDocs(WDName);
  OutUncarriedDocs(WDName);
end;

macro ReportForAllOpers;

  var
    RecFound;

  ClearRecord(GroupMember);
  GroupMember.Branch = Branch;
  GroupMember.Date = {curdate}; 
  GroupMember.Group = OperBrigade;
  RecFound = GetGE(GroupMember);
  while(RecFound
    and (GroupMember.Branch == Branch)
    and (GroupMember.Date == {curdate})
    and (GroupMember.Group == OperBrigade))
    ReportForOper(GroupMember.Oper);
    RecFound = Next(GroupMember);
  end;
end;

var
  OperAccess = GetOperAccess({oper});

  if((OperAccess=="€") or (OperAccess=="‡") or (OperAccess=="‹"))
    ReportForAllOpers;
  else
    ReportForOper({oper});
  end;
end;


