/*
  $Name:         CPMakeIdGis.mac
  $Module:       Коммунальные платежи
  $Description:  Автоматическая генерация идентификаторв физического лица
*/

//import CPVars;

record COMPAY_DOC( pay_doc );
record COMPAY_EXTDOC( pay_doc_cp );

macro MakeIDGis()
 var arr = Tarray();
 var i = 0;
 var size = 30;
 while( i < size )
     arr(i) = -1;
     i = i + 1;
 end;
 // коды документов по ГИС
 arr(0)  = "01";
 arr(1)  = "04";
 arr(4)  = "02";
 arr(2)  = "05";
 arr(14) = "06";
 arr(9)  = "07";
 arr(11) = "08";
 arr(5)  = "09";
 arr(20) = "10";
 arr(13) = "11";
 arr(23) = "12";
 arr(7)  = "13";
 arr(15) = "03";


 var strID:string  = ""  ;
 var str1_2:string = "00";                                                 // строки по разрядам (1 и 2)
 if((COMPAY_DOC.PersIdType >=0) AND (COMPAY_DOC.PersIdType < size))
     var tempstr = arr(COMPAY_DOC.PersIdType);
     if( tempstr!= -1)
         str1_2  = arr(COMPAY_DOC.PersIdType);
     end;
 end;  

 var tmpPassportSer = Trim( COMPAY_DOC.PASSPORTSER );
 var passportSer = "";
 var str = "";
 var code = 0;
 var numSymb = 0;
 while ( numSymb < StrLen( tmpPassportSer ) )
   str = StrUpr( SubStr( tmpPassportSer, numSymb + 1, 1 ) );
   code = CodeFor(str);
   if ( ((code < 65) OR (code > 90)) AND ((code < 128) OR (code > 159)) AND (StrIsNumber(str) == false) )
	 ;
   else
		passportSer = passportSer + str;
   end;
   numSymb = numSymb + 1;
 end;

 var tmpPassportNum = Trim( COMPAY_DOC.PASSPORTNUMB );
 var passportNum = "";
 numSymb = 0;
 while ( numSymb < StrLen( tmpPassportNum ) )
   str = StrUpr( SubStr( tmpPassportNum, numSymb + 1, 1 ) );
   code = CodeFor(str);
   if ( ((code < 65) OR (code > 90)) AND ((code < 128) OR (code > 159)) AND (StrIsNumber(str) == false) )
     ;
   else
		passportNum = passportNum + str;
   end;
   numSymb = numSymb + 1;
 end;
 
 var str3_22:string = passportSer + passportNum;
 if(StrLen(str3_22) < 20)
    str3_22 = MkStr("0", 20 - StrLen(str3_22)) + str3_22; 
 end;
 private var payerIdPart23_25: string="643";
 if ((COMPAY_DOC.FLAGREZ == "X") or (COMPAY_DOC.CLIENTCOUNTRY == ""))
    payerIdPart23_25="999";
 end;
 COMPAY_EXTDOC.personId = str1_2 + str3_22 + payerIdPart23_25;
end;