/* Ф. 25-в */

import BankInter, deprintr, ChkPrn, Stat_Tot, ResComm, Res2_Out;

macro ReportOnCurVFResource;

  var
    PrevRest=$0, IPrevRest = 0,
    CurRest=$0, ICurRest = 0,
    Deb=$0, IDeb = 0,
    Cred=$0,ICred = 0,  
    OtherDeb=$0, IOtherDeb = 0,
    OtherCred=$0, IOtherCred = 0;

  if ( CashVal.Type == TYPE_RES_NOPAY )
    return;
  end;

  CalcTurns(CashVal.RefValue, Cred, ICred, Deb, IDeb);
  CalcOtherTurns(CashVal.RefValue,OtherCred, IOtherCred, OtherDeb, IOtherDeb);

  KeyNum(CashAcc,2);
  CashAcc.Branch=Branch;
  CashAcc.CashOper=Safe;
  CashAcc.RefValue=CashVal.RefValue;
  CashAcc.Date={curdate};
  if(GetLT(CashAcc) and
    (CashAcc.Branch==Branch) and
    (CashAcc.RefValue==CashVal.RefValue) and
    (CashAcc.CashOper==Safe))
    IPrevRest=CashAcc.RestCol;
    PrevRest=CashAcc.RestMoney;
  end;

  KeyNum(CashAcc,1);
  CashAcc.Branch=Branch;
  CashAcc.CashOper=Safe;
  CashAcc.RefValue=CashVal.RefValue;
  CashAcc.Date={curdate};
  if(GetEQ(CashAcc))
    ICurRest=CashAcc.RestCol;
    CurRest=CashAcc.RestMoney;
  end;

  if ( Mode )
    PrevRest = CurRest;
    Deb = Cred = OtherDeb = OtherCred = $0;
    IPrevRest = ICurRest =
    IDeb = ICred = IOtherDeb = IOtherCred = 0;
  end;

  OutVFLine(GetValName,PrevRest,IPrevRest,CurRest,ICurRest,Cred,ICred,OtherCred,IOtherCred,Deb,IDeb,OtherDeb,IOtherDeb);
/*  if(OperBrigade != 0)
    WriteNBData(0,PrevRest,CurRest,Cred,0,Deb,0);
    WriteNBData(OperBrigade,0,0,0,OtherCred,0,OtherDeb);
  else
    WriteNBData(0,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
  end; */
end;

macro ReportOnVFResources;

  CashVal.FlagIntoBalance = 3;
  CashVal.BalAccount      = "";

  OutVFHeader;

  if(GetGE(CashVal) and ( CashVal.FlagIntoBalance == 3 ) )
    if(CashVal.RefValueReport!=0)
      ReportOnCurVFResource;
    end;
    while(Next(CashVal) and ( CashVal.FlagIntoBalance == 3 ) )
      if(CashVal.RefValueReport!=0)
        ReportOnCurVFResource;
      end;
    end;
  end;

  OutVFTotLine;
end;

macro ReportOnCurCrResource;

  var
    PrevRest=$0,
    CurRest=$0,
    Deb=$0,
    Cred=$0,
    OtherDeb=$0,
    OtherCred=$0;

  Currency.Code_Currency=CashVal.CodIntValue;
  if(not GetEQ(Currency))
    ClearRecord(Currency);
    Currency.Name_Currency="не найдена";
  end;

  CalcOtherTurns(CashVal.RefValue,OtherCred,OtherDeb);

  KeyNum(CashAcc,2);
  CashAcc.Branch=Branch;
  CashAcc.CashOper=Safe;
  CashAcc.RefValue=CashVal.RefValue;
  CashAcc.Date={curdate};
  if(GetLT(CashAcc) and
    (CashAcc.Branch==Branch) and
    (CashAcc.RefValue==CashVal.RefValue) and
    (CashAcc.CashOper==Safe))
    PrevRest=CashAcc.RestMoney;
  end;

  KeyNum(CashAcc,1);
  CashAcc.Branch=Branch;
  CashAcc.CashOper=Safe;
  CashAcc.RefValue=CashVal.RefValue;
  CashAcc.Date={curdate};
  if(GetEQ(CashAcc))
    CurRest=CashAcc.RestMoney;
  end;

  CashAcc.Branch=Branch;
  CashAcc.CashOper="Инкассация";
  CashAcc.RefValue=CashVal.RefValue;
  CashAcc.Date={curdate};
  if(GetEQ(CashAcc))
    Cred=CashAcc.DebMoney;
    Deb=CashAcc.KredMoney;
  end;

  if ( Mode )
    PrevRest = CurRest;
    Deb = Cred = OtherDeb = OtherCred = $0;
  end;

  OutCrLine(PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
/*  if(OperBrigade != 0)
    WriteNBData(0,PrevRest,CurRest,Cred,0,Deb,0);
    WriteNBData(OperBrigade,0,0,0,OtherCred,0,OtherDeb);
  else
    WriteNBData(0,PrevRest,CurRest,Cred,OtherCred,Deb,OtherDeb);
  end;   */
end;

macro ReportOnCrResources;

  CashVal.TypeValue=CV_Currency;
  CashVal.CodIntValue=0;

  OutCrHeader;

  if(GetGE(CashVal) and (CashVal.TypeValue==CV_Currency))
    if(CashVal.CodIntValue!=0)
      ReportOnCurCrResource;
    end;
    while(Next(CashVal) and (CashVal.TypeValue==CV_Currency))
      ReportOnCurCrResource;
    end;
  end;

  /*OutCrTotLine;*/
end;

var
  IsFirst;

macro ReportOnCurDepType (FlagRez, TypeReport)

  record TmpStat("sb_depst.dbt");

  DepStat.FNCash  = Branch;
  DepStat.IsCur   = 1;
  DepStat.Kind    = DepType.Kind;
  DepStat.CodCur  = Currency.Code_Currency;
  DepStat.FlagRez = FlagRez;
  DepStat.Date    = {curdate};
  DepStat.Mode    = Mode;

  if(not (GetLE(DepStat)
    and (DepStat.FNCash==Branch)
    and (DepStat.IsCur==1)
    and (DepStat.Kind==DepType.Kind)
    and (DepStat.CodCur==Currency.Code_Currency)
    and (DepStat.FlagRez==FlagRez)))
    return ;
  end;

  if (IsFirst)
    IsFirst=false;
    if (TypeReport == 0)
      OutDepSubHead();
    else
      OutStatHead2();
    end;
  end;

  if( ( DepStat.Date=={curdate} ) and ( DepStat.Mode == Mode ) )
    Copy(TmpStat,DepStat);
    if(Prev(DepStat)
      and (DepStat.FNCash==Branch)
      and (DepStat.IsCur==1)
      and (DepStat.Kind==DepType.Kind)
      and (DepStat.CodCur==Currency.Code_Currency)
      and (DepStat.FlagRez==FlagRez)              )
      Copy(PrevStat,DepStat);
      Copy(DepStat,TmpStat);
    else
      ClearRecord(PrevStat);
      Copy(DepStat,TmpStat);
    end;
  else
    Copy(PrevStat,DepStat);
    DepStat.CurOpenAc=0;
    DepStat.CurClosAc=0;
    DepStat.DebSum=0;
    DepStat.KredSum=0;
    DepStat.EstimIn      = 0;
    DepStat.EstimOut     = 0;
    DepStat.EstimOverOut = 0;
  end;

  if (TypeReport == 0)
    OutDepLine();
  else
    OutDepLine2();
  end;

end;


macro ZeroStatTotals

  TotPrevRestC=$0;
  TotCreditC=$0;
  TotDebetC=$0;
  TotRestC=$0;
  TotPrevAcc=0;
  TotAcc=0;
  TotOpenedAcc=0;
  TotClosedAcc=0;

  TotPrevEstimRest = $0L;
  TotEstimIn       = $0L;
  TotEstinOut      = $0L;
  TotEstimOverOut  = $0L;
  TotEstimRest     = $0L;

  WasPrintEstim = FALSE;

end;

macro ReportOnDepTypesForCurCurrency (ABalAcc)

  var i;
  var stat;
  var flag = FALSE;

  ZeroStatTotals;
  IsFirst=true;
  WasPrintCurr = FALSE;

  i = 0;
  while (i < ASize(ABalAcc))
    /* Сначала идем для резидентов */
    KeyNum(DepType,4);
    DepType.FlagCur = 1;
    DepType.BalAcc  = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur == 1         ) AND
          (DepType.BalAcc  == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(0),0);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    /* Потом идем для нерезидентов */
    KeyNum(DepType,5);
    DepType.FlagCur      = 1;
    DepType.BalAccNotRez = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur      == 1         ) AND
          (DepType.BalAccNotRez == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(1),0);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    i = i + 1;
  end;

  if (IsFirst == false)
    OutStatTotals();
    WasPrintCurr = TRUE;
    flag = TRUE;
  end;

  /* Отчет по наращенным процентам */
  IsFirst = TRUE;
  i = 0;
  while (i < ASize(ABalAcc))
    BAPrevEstimRest = $0L;
    BAEstimIn       = $0L;
    BAEstinOut      = $0L;
    BAEstimOverOut  = $0L;
    BAEstimRest     = $0L;
    WasPrintBA      = FALSE;

    /* Сначала идем для резидентов */
    KeyNum(DepType,4);
    DepType.FlagCur = 1;
    DepType.BalAcc  = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur == 1         ) AND
          (DepType.BalAcc  == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(0),1);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    /* Потом идем для нерезидентов */
    KeyNum(DepType,5);
    DepType.FlagCur      = 1;
    DepType.BalAccNotRez = ABalAcc(i);
    stat = GetGE(DepType);
    while (stat)
      if ((DepType.FlagCur      == 1         ) AND
          (DepType.BalAccNotRez == ABalAcc(i))    )
        if (DepType.Kind != "Служебный")
          ReportOnCurDepType(StrFor(1),1);
        end;
        stat = Next(DepType);
      else
        stat = FALSE;
      end;
    end;
    if (WasPrintBA)
      OutStatTotalBA();
    end;
    i = i + 1;
  end;

  if (IsFirst == false)
    OutStatTotals2();
    flag = TRUE;
  end;

  if (flag)
    PrintLn();
  end;

end;

macro ReportOnDepTypes

  var stat;
  var i,j,k;
  var BA_TMP;
  array ABalAcc,BalAcc;

  KeyNum(DepType,4);
  ReWind(DepType);
  DepType.FlagCur = 1;
  DepType.BalAcc  = "";
  stat = GetGE(DepType);
  while (stat)
    if (DepType.FlagCur == 1)
      BalAcc(0) = Trim(DepType.BalAcc);
      BalAcc(1) = Trim(DepType.BalAccNotRez);
      i = 0;
      while (i < ASize(BalAcc))
        if (ASize(ABalAcc) == 0)
          ABalAcc(0) = BalAcc(i);
        else
          j = 0;
          k = -1;
          while (j < ASize(ABalAcc))
            if (BalAcc(i) == ABalAcc(j))
              k = j;
              j = ASize(ABalAcc); /* Чтобы быстрее выйти из цикла */
            end;
            j = j + 1;
          end;
          if (k == -1)
            k = ASize(ABalAcc);
            ABalAcc(k) = BalAcc(i);
          end;
        end;
        i = i + 1;
      end;
      stat = Next(DepType);
    else
      stat = FALSE;
    end;
  end;

  /* Сортируем в порядке возрастания */
  i = 0;
  while (i < ASize(ABalAcc))
    j = i;
    k = i;
    while (j < ASize(ABalAcc))
      if (ABalAcc(k) > ABalAcc(j))
        k = j;
      end;
      j = j + 1;
    end;
    BA_TMP = ABalAcc(i);
    ABalAcc(i) = ABalAcc(k);
    ABalAcc(k) = BA_TMP;
    i = i + 1;
  end;

  OutDepHead;
  Currency.Code_Currency=1;
  stat=GetGE(Currency);
  while(stat);
    ReportOnDepTypesForCurCurrency (ABalAcc);
    stat=Next(Currency);
  end;
end;

macro DateLastQuartal

  var d,m,y;

  DateSplit({curdate},d,m,y);
  if ((m >= 1) AND (m <= 3))
    m == 1;
  elif ((m >= 4) AND (m <= 6))
    m == 4;
  elif ((m >= 7) AND (m <= 9))
    m == 7;
  else
    m = 10;
  end;

  return Date(1,m,y);

end;


macro ReportOnMemTurns

  var MemInOper   = 0;
  var MemInOperPr = 0;
  var stat;

  OutMemHead;

  Currency.Code_Currency = 1;
  stat = GetGE(Currency);
  while(stat)
    getTotalDepStats( {curdate}, Currency.Code_Currency );
    MemInOper = totalStat.MemInOper;
    getTotalDepStats( {curdate} - 1 , Currency.Code_Currency );
    MemInOperPr = totalStat.MemInOper;
    if (MemInOper OR MemInOperPr)
      OutMemSubHead();
    end;
    OutOpMemLine("1. Безналичные зачисления во вклады",
                 MemInOperPr,MemInOper);
    stat = Next(Currency);
  end;

end;


macro ReportOnOps

  var ColOper    = 0;
  var ColOperPr  = 0;
  var ColOper2   = 0;
  var ColOperPr2 = 0;
  var ColOper3   = 0;
  var ColOperPr3 = 0;
  var ColOper6   = 0;
  var ColOperPr6 = 0;
  var stat;
  array AGrOp;
    AGrOp(0) = CO_NalPer;
    AGrOp(1) = CO_Comission;
    AGrOp(2) = CO_Conversion;
    AGrOp(3) = CO_Payed;

  OutOpHead;

  Currency.Code_Currency = 1;
  stat = GetGE(Currency);
  while(stat)
    /* Операция по вкладам */
    ColOper    = 0;
    ColOperPr  = 0;
    ColOper2   = 0;
    ColOperPr2 = 0;
    ColOper3   = 0;
    ColOperPr3 = 0;
    ColOper6   = 0;
    ColOperPr6 = 0;

    getTotalDepStats( {curdate}, Currency.Code_Currency );
    ColOper = totalStat.OpenInOper;
    ColOper2 = totalStat.DopInOper;
    ColOper3 = totalStat.OutOper;
    getTotalDepStats( {curdate} - 1 , Currency.Code_Currency );
    ColOperPr = totalStat.OpenInOper;
    ColOperPr2 = totalStat.DopInOper;
    ColOperPr3 = totalStat.OutOper;

    if (ColOper   OR ColOper2   OR ColOper3   OR ColOper6 OR
        ColOperPr OR ColOperPr2 OR ColOperPr3 OR ColOperPr6  )
      OutOpSubHead();
    end;
    OutOpMemLine("1. Первоначальные взносы по вкладам населения",
      ColOperPr, ColOper);
    OutOpMemLine("2. Дополнительные взносы по вкладам населения",
      ColOperPr2, ColOper2);
    OutOpMemLine("3. Частичные выдачи и закрытие счетов по вкладам населения",
      ColOperPr3, ColOper3);
    OutOpMemLine("6. Операции по приему платежей от организаций и населения",
      ColOperPr6, ColOper6);
    stat = Next(Currency);
  end;

end;

  var
    RegPath = "RS-RETAIL\\ПЕЧАТИ\\ФОРМА_25";

  CheckPrinter( RegPath, StrFor( 0 ) );

  Message (" Создается форма 25-в ...");
  Safe = GetNativeSafe;
  DeskSubj.Branch = Branch;
  DeskSubj.Name = Safe;
  if ( not GetEQ( DeskSubj ) )
    MsgBox( "Не найден субъект кассы: ", Safe );
    Exit( -1 );
  end;
  if ( Index( DeskSubj.Reports, "B" ) != 0 )
    OutTitle;
    ReportOnCrResources;
    PrintLn;
    PrintLn;
    ReportOnVFResources;
    PrintLn;
    PrintLn;
    ReportOnDepTypes;
/*
    ReportOnOps();
    ReportOnMemTurns();
*/
    OutBottom;
  end;
end;

