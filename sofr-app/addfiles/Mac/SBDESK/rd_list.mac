
/* Письмо-опись */

import deprintr, DeskInter, RD_Comm;

file BagList( "bag.dbt" ) key 0;

var
  Number,
  Plombir,
  CtragName;


macro PrintList

  var
    RecFound,
    Stat = true,
    SumStr1, SumStr2,
    PayerName, RcvName;

  if ( Bag.Operation == CASHOP_PANT_RDEB )
    PayerName = {Name_Bank};
    RcvName = CtragName;
  else  
    RcvName = {Name_Bank};
    PayerName = CtragName;
  end;

  [								      Ф.N 218];
  [                           ПИСЬМО-ОПИСЬ № #####                           ]
  ( Number );
  [                                                                          ];
  [     к инкассаторской сумке № ##### с валютными и другими ценностями      ]
  ( Bag.Number );
  [ ######################################################################## ]
  ( Bag.Date:m:c );
  [                                                                          ];
  [ ######################################################################## ]
  ( PayerName );
  [ #########################################################################]
  ( {Post_Addr} );
  [                                                                          ];
  [ В ###################################################################### ]
  ( RcvName );
  [                                                                          ];
  [ Направляем через старшего бригады инкассаторов г-на ____________________ ];
  [                                                                          ];
  [ Получение и зачисление на соответсвующие счета баланса просим подтвер-   ];
  [ дить                                                                     ];
  [                                                                          ];
  [--------------------------------------------------------------------------];
  [| Наименование |Код|            Сумма по номиналу             |    №№    |];
  [|    валюты    |вал|                                          | пломбиров|];
  [--------------------------------------------------------------------------];

  ClearRecord( BagList );
  BagList.Branch = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )  
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    Stat = FindCashValue( BagList.ValueRef );
    if ( Stat 
      and ( BagList.Operation == Bag.Operation )
      and ( BagList.SubOp == Bag.SubOp ) )
      if ( CashValue.TypeValue == TYPERES_CURRENCY )
        Stat = FindCurr( CashValue.CodIntValue );
      end;
      if ( Stat )
        [ ############## ###                     ######################  ######### ]
        (
          Curr.Short_Name:c,
          Curr.ExternalCode,
          BagList.RealSum,
	  Plombir
        );  
      end; 
    end;
    RecFound = Next( BagList );
  end;

  [--------------------------------------------------------------------------];

  ClearRecord( BagList );
  BagList.Branch = Bag.Branch;  
  BagList.Date = Bag.Date;
  BagList.ClientType = Bag.ClientType;
  BagList.ClientID = Bag.ClientID;
  BagList.Operation = Bag.Operation;
  BagList.Number = Bag.Number;
  RecFound = GetGE( BagList );
  while ( RecFound and Stat
    and ( BagList.Branch == Bag.Branch )  
    and ( BagList.Date == Bag.Date )
    and ( BagList.ClientType == Bag.ClientType )
    and ( BagList.ClientID == Bag.ClientID )
    and ( BagList.Operation == Bag.Operation )
    and ( BagList.Number == Bag.Number ) )
    Stat = FindCashValue( BagList.ValueRef );
    Stat = FindCashValue( BagList.ValueRef );
    if ( Stat 
      and ( BagList.Operation == Bag.Operation )
      and ( BagList.SubOp == Bag.SubOp ) )
      Stat = FindCurr( CashValue.CodIntValue );
      if ( Stat )
        RubToStr( BagList.RealSum, SumStr1, SumStr2 );
        [ ############## ### ##################################################### ]
        (
          BagList.RealSum,
          Curr.Short_Name:c,
          "(" + SumStr1 + " " + SumStr2 + ")"
        );  
      end;
    end;
    RecFound = Next( BagList );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при печати описи" );
    Exit( -1 );
  end;

  [--------------------------------------------------------------------------];
  [                        ( сумма цифрами и прописью )                      ];
  [                                                                          ];
  [ ____________________         ____________       ________________________ ];
  [ ( должность )                ( подпись )        ( Ф.И.О. )               ];
  [                                                                          ];
  [ ____________________         ____________       ________________________ ];
  [ ( должность )                ( подпись )        ( Ф.И.О. )               ];
end;

  if ( not FindCashValue( Bag.ValueRef ) )
    MsgBox( "Не найдена ценность" );
    Exit( -1 );
  end;

  /*if ( CashValue.TypeValue != TYPERES_CURRENCY )
    Exit( 1 );
  end;*/

  GetClientInfo( Bag.ClientType, Bag.ClientID, CtragName );
  if ( GetTrue( false, "Печатать письмо-опись ?" ) )
    GetInt( Number, "Введите номер письма-описи" );
    GetInt( Plombir, "Введите номер пломбира" );
    if (( ValType( Number ) == V_INTEGER ) and ( ValType( Plombir ) == V_INTEGER ))
      PrintList;
      PrintLn( StrFor( 12 ) );
      PrintList;
    end;
  end;    
end;
