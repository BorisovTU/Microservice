/*
$Name:             f211_class.mac
$Module:           RS-Retail
$Description:      Книга учета драгоценных металлов
*/

import rsd, DeprIntr,ingot,revalue,TDate;
import Xbt;


file DeskSubj( "desksubj.dbt" ) key 1;
file CashVal( "sb_casvl.dbt" ) key 1;
file CashDoc( "sb_casdc.dbt" ) key 0;
file CashAcc( "sb_casac.dbt" ) key 0;
file CiMisc( "ci_misc.dbt") key 0;
file CiCode( "ci_code.dbt") key 0;

file Tmp( "booktmp.tmp" ) key 0 write;

const
  CII_INGOT       = 5,                  /* Кладовая отделения */
  DST_PANTRY	  = 5,
  DST_DRAGMET     = 505;		/* Драгмет */

private const
  PrintRevalue = false,   /* Печать курсовой разницы. По запросу 62929 печать не нужна*/  
  FlagLaserPrint = FALSE, // FALSE - отключить
  PrintTotal     = false; // Печать итогов


var
  Branch = NumFNCash, 
  {curdate},
  Ostatok=$0,
  NeedPrint=false,
  MetallName = "";

class TDragMetExecutor

/***************************************************************/
private macro GetBranchName

  var ddep = TRecHandler( "i_dp_dep.rec" );
  var party = TRecHandler( "i_party.rec" );

  if ( findDepartment(Branch, null, ddep, party) )
    return party.rec.Name + "  " + ddep.rec.Name;
  end;

  return "";
end;
/*************************************************/
private macro GetStrForSignt()
  var str = "";
  
  if( GetBankStandart() == 0 )
    str = "(наименование, № филиала Сбербанка России/№ ВСП)";
  else
    str = "(Наименование кредитной организации)";
  end;

  return str;
end;
/*************************************************/
private macro PrintSeparator()
  [+----------+------------+---------+------------------+-----------------+];
end;

private macro PrintLine(Name,Account,KolDeb,MassLigDeb,MassPureDeb,KolKred,MassLigKred,MassPureKred,KolOstatok,MassLigOstatok,MassPureOstatok,SummOstatok)

  [|##########|############|#########|##################|#################|]
  (Name:w,
   Acc_Form(Account):w,
/*
   KolDeb:z,
   MassLigDeb:0:1:z,
   MassPureDeb:0:1:z,
   KolKred:z,
   MassLigKred:0:1:z,
   MassPureKred:0:1:z,
*/
   KolOstatok:z,
   MassLigOstatok:0:1:z,
   MassPureOstatok:0:1:z
/*
   SummOstatok:z
*/
);
  PrintSeparator();

end;
/*************************************************/

private macro PrintHead
  var dateStr = TDateStorage;

  if( FlagLaserPrint )
    println ("E&l1O(3R(s0p16.00h16)");
  end;
  [ ];
  [ ##########################################################             ]
  ( GetBranchName:w );                                                                                                        
  [ ------------------------------------------------	           ф.№211  ];
  [ ################################################		           ]
  ( GetStrForSignt():c );
  [ ];
  [ ];
  [               КНИГА УЧЕТА ДРАГОЦЕННЫХ МЕТАЛЛОВ В ХРАНИЛИЩЕ             ];
  [ ];
  [                                                        Месяц__#_______ ]
  ( dateStr.getNameMonthForNum(null,true) );
  [+----------+------------+----------------------------------------------+];
  [|          |            |                   Остаток                    |];
  [|          |            |               на #                           |]( dateStr.getDateInCurStr("\"dd\" month yyyy г.", {curdate} + 1) );
  [|   Вид    |   № счета  |                                              |];      
  [| металла  |            |                                              |];
  [|          |            +---------+------------------+-----------------+];
  [|          |            | Кол-во  | Масса в лигатуре | Масса в чистоте |];
  [|          |            | слитков |      грамм       |      грамм      |];
  [|          |            |  (шт.)  |                  |                 |];
  PrintSeparator();
end;
/************************************************************/
private macro PrintEndDoc
  [ ];
  [ Заведующий кассой            _______________     ______________________ ];
  [  			  		                    (Ф.И.О.)        ];
  [ ];
  [ Руководитель филиала банка   _______________     ______________________ ];
  [  				  	 	            (Ф.И.О.)        ];
  [ ];
  [ С данными бухгалтерского учета сверено:				    ];
  [ ];
  [ Главный бухгалтер		 _______________     ______________________ ];
  [  					                    (Ф.И.О.)        ];
  [ ];
  PrintLn( StrFor( 12 ) );
end;
/*******************************************************/

private macro PrintTmpFile(RevalueDebet,RevalueKredit)
  var 
  recfound=false,
  standart = false,
  strAccount = "",
  SumCurrentS = 0,
  PrevRest = 0,
  KolDeb=0,
  MassLigDeb=0,
  MassPureDeb=0,
  KolKred=0,
  MassLigKred=0,
  MassPureKred=0,
  KolOstatok=0,
  MassLigOstatok=0,
  MassPureOstatok=0,
  SummOstatok=$0,

  MetallPrevRest = 0,
  MetallKolDeb=0,
  MetallMassLigDeb=0,
  MetallMassPureDeb=0,
  MetallKolKred=0,
  MetallMassLigKred=0,
  MetallMassPureKred=0,
  MetallKolOstatok=0,
  MetallMassLigOstatok=0,
  MetallMassPureOstatok=0,
  MetallSummOstatok=$0,

  TotalKolDeb=0,
  TotalMassLigDeb=0,
  TotalMassPureDeb=0,
  TotalKolKred=0,
  TotalMassLigKred=0,
  TotalMassPureKred=0,
  TotalKolOstatok=0,
  TotalMassLigOstatok=0,
  TotalMassPureOstatok=0,
  TotalSummOstatok=$0,

  standartFound = false,
  merFound = false;

  KeyNum(Tmp,1);
  rewind(Tmp);
  recfound = next(Tmp);
  if(recfound)
    MetallName = Tmp.MetallName;
  end;

  while(recfound)

    merFound = false;
    Tmp.MetallName = MetallName;
    Tmp.Weight = 0;
    recfound = GetGE(Tmp);
    while(recfound
	  and (Tmp.MetallName == MetallName)
	  and (Tmp.Weight <= 10000000) )

      merFound = true;
      if( Tmp.MetallName != "Золото" )
        Tmp.MassHimPureDeb = 0;
        Tmp.MassHimPureKred = 0;
        Tmp.MassHimPureOstatok = 0;
      end;

      KolDeb=KolDeb+Tmp.KolDeb;
      MassLigDeb=MassLigDeb+Tmp.MassLigDeb;
      MassPureDeb=MassPureDeb+Tmp.MassHimPureDeb;
      KolKred=KolKred+Tmp.KolKred;
      MassLigKred=MassLigKred+Tmp.MassLigKred;
      MassPureKred=MassPureKred+Tmp.MassHimPureKred;
      KolOstatok=KolOstatok+Tmp.KolOstatok;
      MassLigOstatok=MassLigOstatok+Tmp.MassLigOstatok;
      MassPureOstatok=MassPureOstatok+Tmp.MassHimPureOstatok;
      SummOstatok=SummOstatok+Tmp.SumOstatok;

      TotalKolDeb = TotalKolDeb+Tmp.KolDeb;
      TotalMassLigDeb = TotalMassLigDeb+Tmp.MassLigDeb;
      TotalMassPureDeb = TotalMassPureDeb+Tmp.MassHimPureDeb;
      TotalKolKred = TotalKolKred+Tmp.KolKred;
      TotalMassLigKred = TotalMassLigKred+Tmp.MassLigKred;
      TotalMassPureKred = TotalMassPureKred+Tmp.MassHimPureKred;
      TotalKolOstatok = TotalKolOstatok+Tmp.KolOstatok;
      TotalMassLigOstatok = TotalMassLigOstatok+Tmp.MassLigOstatok;
      TotalMassPureOstatok = TotalMassPureOstatok+Tmp.MassHimPureOstatok;
      TotalSummOstatok = TotalSummOstatok+Tmp.SumOstatok;

      if( index( Tmp.Name, "|" ) < strlen( Tmp.Name ) )
        strAccount = SubStr( Tmp.Name, Index( Tmp.Name, "|") + 1, strlen( Tmp.Name ) - index( Tmp.Name, "|" ) );
      end;

      recfound = next(Tmp);
    end;
/*
    if( merFound )
      PrintLine(MetallName+": мерные слитки","",KolDeb,MassLigDeb,MassPureDeb,KolKred,MassLigKred,MassPureKred,KolOstatok,MassLigOstatok,MassPureOstatok,SummOstatok);
    end;
*/
    MetallKolDeb= MetallKolDeb + KolDeb;
    MetallMassLigDeb= MetallMassLigDeb + MassLigDeb;
    MetallMassPureDeb= MetallMassPureDeb + MassPureDeb;
    MetallKolKred=MetallKolKred + KolKred;
    MetallMassLigKred=MetallMassLigKred + MassLigKred;
    MetallMassPureKred= MetallMassPureKred + MassPureKred;
    MetallKolOstatok= MetallKolOstatok + KolOstatok;
    MetallMassLigOstatok=MetallMassLigOstatok + MassLigOstatok;
    MetallMassPureOstatok=MetallMassPureOstatok + MassPureOstatok;
    MetallSummOstatok=MetallSummOstatok + SummOstatok;

    KolDeb = 0;
    MassLigDeb = 0;
    MassPureDeb = 0;
    KolKred = 0;
    MassLigKred = 0;
    MassPureKred = 0;
    KolOstatok = 0;
    MassLigOstatok = 0;
    MassPureOstatok = 0;
    SummOstatok = 0;


    Tmp.MetallName = MetallName;
    Tmp.Weight = 10000000;
    recfound = GetGT(Tmp);
    standartFound = false;
    while(recfound
	  and (Tmp.MetallName == MetallName)
	  and (Tmp.Weight > 10000000) )

      if( Tmp.MetallName != "Золото" )
        Tmp.MassHimPureDeb = 0;
        Tmp.MassHimPureKred = 0;
        Tmp.MassHimPureOstatok = 0;
      end;

      standartFound = true;
      KolDeb=KolDeb+Tmp.KolDeb;
      MassLigDeb=MassLigDeb+Tmp.MassLigDeb;
      MassPureDeb=MassPureDeb+Tmp.MassHimPureDeb;
      KolKred=KolKred+Tmp.KolKred;
      MassLigKred=MassLigKred+Tmp.MassLigKred;
      MassPureKred=MassPureKred+Tmp.MassHimPureKred;
      KolOstatok=KolOstatok+Tmp.KolOstatok;
      MassLigOstatok=MassLigOstatok+Tmp.MassLigOstatok;
      MassPureOstatok=MassPureOstatok+Tmp.MassHimPureOstatok;
      SummOstatok=SummOstatok+Tmp.SumOstatok;

      TotalKolDeb = TotalKolDeb+Tmp.KolDeb;
      TotalMassLigDeb = TotalMassLigDeb+Tmp.MassLigDeb;
      TotalMassPureDeb = TotalMassPureDeb+Tmp.MassHimPureDeb;
      TotalKolKred = TotalKolKred+Tmp.KolKred;
      TotalMassLigKred = TotalMassLigKred+Tmp.MassLigKred;
      TotalMassPureKred = TotalMassPureKred+Tmp.MassHimPureKred;
      TotalKolOstatok = TotalKolOstatok+Tmp.KolOstatok;
      TotalMassLigOstatok = TotalMassLigOstatok+Tmp.MassLigOstatok;
      TotalMassPureOstatok = TotalMassPureOstatok+Tmp.MassHimPureOstatok;
      TotalSummOstatok = TotalSummOstatok+Tmp.SumOstatok;

      if( index( Tmp.Name, "|" ) < strlen( Tmp.Name ) )
        strAccount = SubStr( Tmp.Name, Index( Tmp.Name, "|") + 1, strlen( Tmp.Name ) - index( Tmp.Name, "|" ) );
      end;

      recfound = next(Tmp);
    end;
/*
    if( standartFound )
      PrintLine(MetallName+": Стандартные слитки","",KolDeb,MassLigDeb,MassPureDeb,KolKred,MassLigKred,MassPureKred,KolOstatok,MassLigOstatok,MassPureOstatok,SummOstatok);
    end;
*/
    MetallKolDeb= MetallKolDeb + KolDeb;
    MetallMassLigDeb= MetallMassLigDeb + MassLigDeb;
    MetallMassPureDeb= MetallMassPureDeb + MassPureDeb;
    MetallKolKred=MetallKolKred + KolKred;
    MetallMassLigKred=MetallMassLigKred + MassLigKred;
    MetallMassPureKred= MetallMassPureKred + MassPureKred;
    MetallKolOstatok= MetallKolOstatok + KolOstatok;
    MetallMassLigOstatok=MetallMassLigOstatok + MassLigOstatok;
    MetallMassPureOstatok=MetallMassPureOstatok + MassPureOstatok;
    MetallSummOstatok=MetallSummOstatok + SummOstatok;

    KolDeb = 0;
    MassLigDeb = 0;
    MassPureDeb = 0;
    KolKred = 0;
    MassLigKred = 0;
    MassPureKred = 0;
    KolOstatok = 0;
    MassLigOstatok = 0;
    MassPureOstatok = 0;
    SummOstatok = 0;

    if( (standartFound) or (merFound) )
      PrintLine(MetallName/*+": Итого"*/,strAccount,MetallKolDeb,MetallMassLigDeb,MetallMassPureDeb,MetallKolKred,MetallMassLigKred,MetallMassPureKred,MetallKolOstatok,MetallMassLigOstatok,MetallMassPureOstatok,MetallSummOstatok);
    end;

    MetallKolDeb=0;
    MetallMassLigDeb=0;
    MetallMassPureDeb=0;
    MetallKolKred=0;
    MetallMassLigKred=0;
    MetallMassPureKred=0;
    MetallKolOstatok=0;
    MetallMassLigOstatok=0;
    MetallMassPureOstatok=0;
    MetallSummOstatok=$0;
    strAccount = "";

    MetallName = Tmp.MetallName;
  end;

  if( PrintRevalue and ((RevalueDebet != 0) or (RevalueKredit !=0 )))
    PrintSeparator();
    [|Курсовая  |    |             |             |#############|    |             |             |#############|       |             |             |             |]
    (RevalueDebet:z,
     RevalueKredit:z);
    [|разница   |    |             |             |             |    |             |             |             |       |             |             |             |];

  end;

/* SCR 63708 - необходимо было убрать*/
/* SCR 70786 - необходимо сделать настройку */
  if( PrintTotal )
    PrintLine("Итого:","",TotalKolDeb,TotalMassLigDeb,TotalMassPureDeb,TotalKolKred,TotalMassLigKred,TotalMassPureKred,TotalKolOstatok,TotalMassLigOstatok,TotalMassPureOstatok,TotalSummOstatok);
  end;


end;  

/*********************************************************/    
private macro ClearTmpFile
   var cmd;
   cmd = RsdCommand( NULL, string("truncate table dbooktmp_tmp") );
   cmd.execute();
end;
/************************************************************/
private macro GetFirstDeskSubj
  
  DeskSubj.Branch = Branch;
  DeskSubj.Type = DST_PANTRY;
  DeskSubj.Name = "";
  if ( not GetGE( DeskSubj ) )
    MsgBox( "Не найден субъект Кассы: Хранилище" );
    Exit( 1 ); 
  end;
  return true;
end;
/********************************************************/
private macro FindCashVal( Ref )

  KeyNum( CashVal, 0 );
  CashVal.RefValue = Ref;
  return GetEQ( CashVal );
end;
/**********************************************************/
private macro FillTmpFile

  var IngotDoc,IngotAcc,NeedInsert=false,Name,MetallName,Ingo,Mass,
	Docfound=false,dat1,dat2,NeedUpdate=false,stat,TmpDebMass=0,TmpKredMass=0;
  IngotAcc = TIngotCashAcc( CashAcc.RefValue, CashAcc.CashOper );

  FindCashVal(CashAcc.RefValue);
  CiMisc.Type=CII_INGOT;
  CiMisc.IssueID=CashVal.CodIntValue;
  stat = getEQ(CiMisc);
  Tmp.Weight = CiMisc.Weight;
  CiCode.AutoKey=CiMisc.MaterialRef;
  stat = getEQ(CiCode);
  Tmp.MetallName=CiCode.String;
  CiCode.AutoKey=CiMisc.HallmarkRef;
  stat = getEQ(CiCode);
  Tmp.Name=CashVal.NameValue;
  if( getEQ(Tmp) )
    NeedUpdate = true;
  else
    Name=Tmp.Name;
    MetallName=Tmp.MetallName;
    Mass = Tmp.Weight;
    ClearRecord(Tmp);
    Tmp.Name=Name;
    Tmp.MetallName=MetallName;
    Tmp.Weight = Mass;
    NeedInsert = true;
  end;

  KeyNum(CashDoc,5);
  CashDoc.Branch=Branch;
  CashDoc.CashDateDoc={curdate};
  CashDoc.TypeDoc=2;
  CashDoc.CashPatern=CashAcc.CashOper;
  CashDoc.SubAccountPatern=CashAcc.SubAccount;
  CashDoc.RefValue=CashAcc.RefValue;
  CashDoc.FlagDebCredOper=0;
  Docfound=getGE(CashDoc);

  while((Docfound)
	and(CashDoc.RefValue==CashAcc.RefValue)
        and(CashDoc.CashPatern==CashAcc.CashOper)
        and(CashVal.TypeValue==DST_DRAGMET)
        and(CashDoc.TypeDoc==2)
        and(CashDoc.CashDateDoc=={curdate}))
    IngotDoc = TIngotCashDoc( CashDoc.ApplicationKind, CashDoc.ApplicationKey, CashDoc.RefValue );
    if(CashDoc.FlagDebCredOper==2)
      Tmp.KolDeb=Tmp.KolDeb+CashDoc.ValueCol;
      Tmp.SumDeb=Tmp.SumDeb+IngotDoc.GetRubValue( {curdate} );
      Tmp.MassLigDeb=Tmp.MassLigDeb+IngotDoc.GetTotalWeight;
      Tmp.MassHimPureDeb=Tmp.MassHimPureDeb+IngotDoc.GetTotalPureWeight;
    else
      Tmp.KolKred=Tmp.KolKred+CashDoc.ValueCol;
      Tmp.SumKred=Tmp.SumKred+IngotDoc.GetRubValue( {curdate} );
      Tmp.MassLigKred=Tmp.MassLigKred+IngotDoc.GetTotalWeight;
      Tmp.MassHimPureKred=Tmp.MassHimPureKred+IngotDoc.GetTotalPureWeight;
    end;
    Docfound=next(CashDoc);
  end;

  Tmp.SumOstatok=IngotAcc.GetRubValue( {curdate} );
  Tmp.KolOstatok=CashAcc.RestCol;
  Tmp.MassLigOstatok=IngotAcc.GetTotalWeight;
  Tmp.MassHimPureOstatok=IngotAcc.GetTotalPureWeight;

  if(NeedInsert)
    if(not Insert(Tmp))
      MsgBox("Не могу вставить строку во временный файл");
    end;
  else
    if(NeedUpdate)
      update(Tmp);
    end;
  end;

end;

private macro MainProcess
var 
  RecFound,DeskFound=true,Accfound=true,IngotAcc;
  KeyNum(CashAcc,0);
  if(GetFirstDeskSubj)
    while((DeskFound)and(DeskSubj.Type==DST_PANTRY))
      CashAcc.Branch=Branch;
      CashAcc.Date={curdate};
      CashAcc.CashOper=DeskSubj.Name;
      CashAcc.SubAccount="";
      CashAcc.RefValue=0;
      Accfound=getGE(CashAcc);	
      while(( Accfound )
           and (CashAcc.CashOper==DeskSubj.Name) 
           and (CashAcc.Date=={curdate}) )
        FindCashVal( CashAcc.RefValue );
        if(CashVal.TypeValue==DST_DRAGMET)
          FillTmpFile;
        end;
        Accfound=next(CashAcc) ;
      end;    
      DeskFound = next(DeskSubj);
    end;
  end;
end;

private macro GetRevalue(Debet,Kredit)
var 
  DeskFound=true,Accfound=true,Sum;
  KeyNum(CashAcc,0);
  if(GetFirstDeskSubj)
    while((DeskFound)and(DeskSubj.Type==DST_PANTRY))
      CashAcc.Branch=Branch;
      CashAcc.Date={curdate};
      CashAcc.CashOper=DeskSubj.Name;
      CashAcc.SubAccount="";
      CashAcc.RefValue=0;
      Accfound=getGE(CashAcc);	
      while(( Accfound )
           and (CashAcc.CashOper==DeskSubj.Name) 
           and (CashAcc.Date=={curdate}) )
        FindCashVal( CashAcc.RefValue );
        if(CashVal.TypeValue==DST_DRAGMET)
          Sum = GetRevalueSum( CashVal.RefValue, {curdate}, DeskSubj.Name );
	  if(Sum > 0)
	    Debet = Debet + Sum;
	  else
	    Kredit = Kredit + abs(Sum);
	  end;
        end;
        Accfound=next(CashAcc) ;
      end;    
      DeskFound = next(DeskSubj);
    end;
  end;
  SetParm(0,Debet);
  SetParm(1,Kredit);
end;

private macro Calc_Ostatok
var 
  RecFound,DeskFound=true,Accfound=true,IngotAcc;

  KeyNum(CashAcc,2);
  if(GetFirstDeskSubj)
    while((DeskFound)and(DeskSubj.Type==DST_PANTRY))
      CiMisc.Type=CII_INGOT;
      CiMisc.IssueID=1;
      RecFound=getEQ(CiMisc);
      while((RecFound)and(CiMisc.Type==CII_INGOT))
        KeyNum(CashVal,1);
        CashVal.TypeValue=DST_DRAGMET;
        CashVal.CodIntValue=CiMisc.IssueID;
        CashVal.Type=0;
        getEQ(CashVal);
        ClearRecord(CashAcc);
        CashAcc.Branch=Branch;
   	CashAcc.CashOper=DeskSubj.Name;
        CashAcc.SubAccount="";
     	CashAcc.RefValue=CashVal.RefValue;
     	CashAcc.Date={curdate}-1;
    	Accfound=getLE(CashAcc);
        if((Accfound)
      	     and(CashAcc.RefValue==CashVal.RefValue)
      	     and(CashAcc.CashOper==DeskSubj.Name)
	     and(CashAcc.SubAccount=="")
	     and(CashAcc.Branch == Branch) )
          IngotAcc = TIngotCashAcc( CashAcc.RefValue, CashAcc.CashOper, CashAcc.Date );
          Ostatok=Ostatok+IngotAcc.GetRubValue(CashAcc.Date);
        end;
        RecFound=next(CiMisc);
      end;
      DeskFound = next(DeskSubj);
    end;
  end;
end;

private macro Print_Book(Debet,Kredit)

  rewind( Tmp );
  if( next( Tmp ) )
    PrintHead;
    PrintTmpFile(Debet,Kredit);
    PrintEndDoc;
  end;

end;

/*************************** Запуск отчета *********************************/
macro RunReport()
  var dat1,dat2,CiFound,Deb = Money(0), Kred = Money(0),Pereocen = false;


/* SCR #62929 Calc_Ostatok; */
  ClearTmpFile;
  MainProcess;

  CiMisc.Type=CII_INGOT;
  CiFound=getGE(CiMisc);
  while((CiFound)and(CiMisc.Type==CII_INGOT)and(not Pereocen))
    dat1=ing_getRubRate(CiMisc.IssueID,{curdate});
    dat2=ing_getRubRate(CiMisc.IssueID,{curdate}-1);
    if(dat1!=dat2)
      Pereocen=true;
    end;
    CiFound=next(CiMisc);
  end;

  if(Pereocen)
    GetRevalue(Deb,Kred);
  end;
  Print_Book(Deb,Kred);

OnError(obj)
  if( isXbt(obj) )
    ShowXbt( obj );
  else
    msgbox( obj.message );
  end;
end;

end;
