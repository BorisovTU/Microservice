
/* Перенос остатков из кассы пересчета в хранилище */

import DeprIntr, DeskInter;

file CashVal("sb_casvl.dbt") key 0;
file CashAcc("sb_casac.dbt") key 0;
file Bag("bag.dbt") key 1;
file CashLink("sb_casln.dbt");
record CashParm("CashParm.dbt");                                   

const
  RESMESUNIT_POINT = 1,  /* Поштучно   */
  RESMESUNIT_MONEY = 2,  /* Стоимость  */

  TYPEDOC_CARRYOFF = 1,  /* Отложен (не подтвержден) */
  TYPEDOC_CARRYON  = 2,  /* Проведен (подтвержден) */

  CASHOP_REINFORCE = 1,  /* Подкрепление кассира */
  CASHOP_RETURN    = 2,  /* Возврат средств в кладовую */
  CASHOP_COLLECT   = 3,  /* Инкассация */
  CASHOP_ADVANCE   = 4,  /* Аванс */
  CASHOP_DEBIT     = 5,  /* Расход */
  CASHOP_CREDIT    = 6,  /* Приход */
  CASHOP_REMOVE    = 7,  /* Внутреннее подкрепление (Расход) */
  CASHOP_REMOVE_1  = 8,  /* Внутреннее подкрепление (Приход) */
  CASHOP_CHVALUE   = 9,  /* Перевод на другой ресурс той же группы (Расход) */
  CASHOP_CHVALUE_1 = 10, /* Перевод на другой ресурс той же группы (Приход) */
  CASHOP_REMOVE_SAFE   = 11,  /* Внутреннее подкрепление сейфа (Расход) */
  CASHOP_REMOVE_SAFE_1 = 12,  /* Внутреннее подкрепление сейфа (Приход) */
  CASHOP_PANT_RI   = 20, /* Подкрепление филиала */
  CASHOP_PANT_RET  = 21, /* Возврат из филиала */
  CASHOP_PANT_RIO  = 22, /* Подкрепление оперчасти */
  CASHOP_PANT_RETO = 23, /* Возврат из оперчасти */
  CASHOP_PANT_COL  = 24, /* Инкассация */
  CASHOP_PANT_ADV  = 25, /* Аванс */
  CASHOP_PANT_RDEB = 30, /* Расход по кассе пересчета */
  CASHOP_PANT_RCRD = 31, /* Приход по кассе пересчета */
  CASHOP_PANT_RDRT = 32, /* Сдача ресурса в кладовую из Кассы пересчета */

  SB_INCASH        = 100,
  SB_RDESK         = 180,

  RDESK            = "К. пересчета",
  INCASS           = "Инкассация",

  BST_NONE         = 0, 
  BST_EDESK        = 1,
  BST_NOT_CHKD     = 2,
  BST_CHECKED      = 3,
  BST_CARRIED      = 4,
  BST_RETURNED     = 5;

var
  Branch = NumFNCash,
  {curdate};

macro FindCashVal(RefValue);

  CashVal.RefValue = RefValue;
  return GetEQ(CashVal);
end;

macro FindBag;

end;

macro CarryOneDoc

  var
    Stat;
  
  CashParm.CashPatern = Bag.Safe;
  if(CashVal.UnitMeas == RESMESUNIT_MONEY)
    CashParm.ValueMoney = CashDoc.ValueMoney;
    CashParm.ValueCol = 0;
  else
    CashParm.ValueMoney = 0;
    CashParm.ValueCol = CashDoc.ValueCol;
  end;
  CashParm.ApplicationKey = FormApplicationKey( CashParm.ApplicationKind );
  CashParm.Series = Bunch.Series;
  CashParm.MinRegistrNumber = Bunch.Min;
  CashParm.MaxRegistrNumber = Bunch.Max;
    Stat = InitCashDoc(CashParm);
    InterDesk_EndDocBunch;
  end;
  return Stat; 
end;

macro CloneDocs

  var
    Stat = true,
    RecFound;

  ClearRecord( CashDoc );
  CashDoc.Branch = Branch;  
  CashDoc.CashDateDoc = CashAcc.Date;  
  CashDoc.TypeDoc = TYPEDOC_CARRYON;
  CashDoc.CashPatern = RDESK;
  CashDoc.RefValue = CashAcc.RefValue;
  RecFound = GetGE( CashDoc );
  while ( RecFound and Stat
    and ( CashDoc.Branch == Branch )
    and ( CashDoc.CashDateDoc == CashAcc.Date ) 
    and ( CashDoc.TypeDoc == TYPEDOC_CARRYON )
    and ( CashDoc.CashPatern == RDESK )
    and ( CashDoc.RefValue == CashAcc.RefValue ) )
    Stat = CloneOneDoc;
    RecFound = Next( CashDoc );
  end;
  if ( not Stat )
    MsgBox( "Ошибка при переносе остатков" );
  end;
  return Stat;
end;

macro MoveAccRests		
  
  var 
    Stat = true; 	  

  if(FindCashVal(CashAcc.RefValue))
    CashParm.TypeValue = CashVal.TypeValue;
    CashParm.CodIntValue = CashVal.CodIntValue;
    Stat = CloneDocs;
  else
    MsgBox("Ресурс кассы не найден, код:|", CashAcc.RefValue);
    Stat = false;
  end;
  return Stat;
end;

macro RDeskReturn

  var
    Stat = true,
    RecFound;

  ClearRecord(CashParm);
  CashParm.CashDateDoc = {curdate};
  CashParm.ApplicationKind = SB_INCASH;
  CashParm.CashOper = RDESK;
  CashParm.NumOper = CASHOP_PANT_RDRT;

  ClearRecord(CashAcc);
  CashAcc.Branch=Branch;
  CashAcc.Date = {curdate};
  CashAcc.CashOper = RDESK;
  RecFound = GetGE(CashAcc);
  while(RecFound and Stat 
    and (CashAcc.Branch==Branch)
    and (CashAcc.Date == {curdate})
    and (CashAcc.CashOper == RDESK))
    if((CashAcc.RestMoney != 0) or (CashAcc.RestCol != 0))
      Stat = MoveAccRests;
    end;
    RecFound = Next(CashAcc);
  end;
  return Stat;
end;

    
    

    


  