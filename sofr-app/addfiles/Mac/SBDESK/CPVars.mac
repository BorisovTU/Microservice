/* äÆ¨¨„≠†´Ï≠Î• Ø´†‚•¶® */
import CommonInter, Globals, RSD, CB_SQL;

const SB_COMPAY = 20;

record COMPAY_RECIPIENT( rtcp_recipient );
record COMPAY_TYPE( rtcp_type );
record COMPAY_LINK( rtcp_link );
record COMPAY_DOC( pay_doc );
record COMPAY_EXTDOC( pay_doc_cp );
record COMPAY_RECIPIENTPROP( rtpaymentprop );

macro GetTmpAttrValuesString( applKind, applKey )
    var str = "", attrCode, attrValue, stat;
    var attrs = TBPAttrValues( Åè_ÄíêàÅìíõ_GTT, applKind, applKey );

    stat = attrs.MoveFirst;
    while( stat == 0 )
        attrs.Get( attrCode, attrValue );
        if( strlen( attrValue ) != 0 )
            if( strlen( str ) != 0 )
                str = str + ",";
            end;
            str = str + attrCode + "=" + attrValue;
        end;
        stat = attrs.MoveNext;
    end;

    return str;
end;

macro GetAttrValuesString( applKind, applKey )
    var str = "", attrCode, attrValue, stat;
    var attrs = TBPAttrValues( Åè_ÄíêàÅìíõ, applKind, applKey );

    if( attrs.Read == 0 )
        stat = attrs.MoveFirst;
        while( stat == 0 )
            attrs.Get( attrCode, attrValue );
            if( strlen( attrValue ) != 0 )
                if( strlen( str ) != 0 )
                    str = str + ",";
                end;
                str = str + attrCode + "=" + attrValue;
            end;
            stat = attrs.MoveNext;
        end;
    end;

    return str;
end;

macro GetPaymentsSet( recipientId: integer )
    var cmd, cmdText =
        "SELECT doc.*, docCP.T_CPACCOUNT as T_CPACCOUNT, cptype.T_NAME as T_TYPENAME" + 
        " FROM DPAY_DOC_DBT doc, DPAY_DOC_CP_DBT docCP, DRTCP_LINK_DBT cplink, DRTCP_TYPE_DBT cptype WHERE" +
        " docCP.T_APPLKIND = doc.T_IAPPLICATIONKIND AND" +
        " docCP.T_APPLKEY = doc.T_APPLICATIONKEY AND" +
        " cptype.T_ID = cplink.T_TYPEID AND" +
        " cplink.T_ID = docCP.T_CPLINKID AND" +
        " doc.T_ACTION <> 2 AND doc.T_ACTION <> 11 AND" +
        " cplink.T_RECIPIENTID = :id";
        
    if ( (COMPAY_BEGINDATE != Date(0,0,0)) or (COMPAY_ENDDATE != Date(0,0,0)) )
        if ( COMPAY_BEGINDATE == COMPAY_ENDDATE )
            cmdText = cmdText + " AND doc.T_DATE_DOCUMENT = :endDate";
        else
            if ( COMPAY_BEGINDATE == Date(0,0,0) )
                cmdText = cmdText + " AND doc.T_DATE_DOCUMENT <= :endDate";
            else
                if ( COMPAY_ENDDATE == Date(0,0,0) )
                    cmdText = cmdText + " AND doc.T_DATE_DOCUMENT >= :beginDate";
                else
                    cmdText = cmdText + " AND doc.T_DATE_DOCUMENT BETWEEN :beginDate AND :endDate ";
                end;
            end;
        end;
    end;
        
    cmdText = cmdText + " ORDER BY doc.T_DATE_DOCUMENT";
    cmd = RsdCommand( cmdText );    
    cmd.addParam("id", RsdBp_in, recipientId);

    if ( (COMPAY_BEGINDATE != Date(0,0,0)) or (COMPAY_ENDDATE != Date(0,0,0)) )
        if ( (COMPAY_BEGINDATE == Date(0,0,0)) or (COMPAY_BEGINDATE == COMPAY_ENDDATE) )
            cmd.addParam("endDate", RsdBp_in, COMPAY_ENDDATE);
        else 
            if ( COMPAY_ENDDATE == Date(0,0,0) )
                cmd.addParam("beginDate", RsdBp_in, COMPAY_BEGINDATE);
            else
                cmd.addParam("beginDate", RsdBp_in, COMPAY_BEGINDATE);
                cmd.addParam("endDate", RsdBp_in, COMPAY_ENDDATE);
            end;
        end;
    end;

    cmd.execute;
    return RsdRecordset(cmd);
end;

END;