
/* Справка о сумме принятых денег */

import DeprIntr, RD_Comm, RSD;

file BagList( "bag.dbt" ) key 2;

const
  BST_SENT     = 9,
  BST_RETURNED = 10;

//const
//  TP_OPER = "О";

var
  {RprtDSubj},
  ReceivedSum = $0,
  TotNBags = 0,
  TotTotSum = $0;
const 
   TYPEDOC_CARRYON = 2,
   CASHOP_CREDIT = 6,
   CASHOP_DEBIT  = 5,
   SB_RSBANK = 9000;

private var Branch = NumFNcash();

macro OutReceivedSum

  var
    Maj, Min,
    ReceivedSumR = Cur2Rub( ReceivedSum );

  if ( Curr.Code_Currency == 0 )
    PrintLn( "Получено под отчет, руб.: ", ReceivedSum, " (", RubToStr( ReceivedSum ), ")" );
  else
    RubToStr( ReceivedSum, Maj, Min );
    PrintLn( "Получено под отчет, ", ReceivedSum, " (", Curr.Short_Name, ": ", Maj, " ", Min, ")"  );
    PrintLn( "Получено под отчет, руб.: ", ReceivedSumR, " (", RubToStr( ReceivedSumR ), ")" );
  end;
end;

macro OutHead

  [ # ]( {Name_Bank} );
  [ ];
  [                                             СПРАВКА                                        ];
  [                     О СУММЕ ВЫДАННЫХ ДЕНЕГ И ПОЛУЧЕННОЙ СУММЕ ПОД ОТЧЕТ                    ];
  [ ########################################################################################## ]
  ( ( "За " + String( {curdate}:m ) ):c );
  [ ];
  OutReceivedSum;
  [ ];
  [--------------------------------------------------------------------------------------------];
  [ Фамилии операционных             |Кол-во   | Сумма прихода   | Подписи операционных        ];
  [ работников                       |приходных|                 | работников                  ];
  [                                  |док-тов, |                 |                             ];
  [                                  |поступив.|                 |                             ];
  [                                  |в кассу  |                 |                             ];                      
  [--------------------------------------------------------------------------------------------];
end;

macro OutLine( NBags, TotSum );

  [################################## ######### #################                              ]
  (
    Person.Name,
    NBags,
    Cur2Rub( TotSum )
  );                      
end;

macro OutTotals

  var
    Maj, Min, 
    Rest = ReceivedSum - TotTotSum,
    RestR = Cur2Rub( Rest );

  if ( Rest < 0 )
    MsgBox( "Сумма, выданная под отчет, меньше израсходованной" );
    Exit( 1 );
  end;
  
  [--------------------------------------------------------------------------------------------];
  [Всего:                             ######### #################                              ]
  (
    TotNBags,
    Cur2Rub( TotTotSum )
  );
  [ ];
  if ( Curr.Code_Currency == 0 )
    PrintLn( "Остаток денег на конец дня, руб.: ", Rest, " (", RubToStr( Rest ), ")" );
  else
    RubToStr( Rest, Maj, Min );
    PrintLn( "Остаток денег на конец дня, ", Rest, " (", Curr.Short_Name, ": ", Maj, " ", Min, ")"  );
    PrintLn( "Остаток денег на конец дня, руб.: ", RestR, " (",  RubToStr( RestR ), ")" );
  end;
end;

macro OutFooter

 [ ];
 [ Кассовый работник:                                ____________________ ];
 [                                                        (подпись)       ];
 [ ];
 [ Заведующий кассой:                                ____________________ ];
 [                                                        (подпись)       ];
 Print( StrFor( 12 ) );
end;

macro CountBagsForOper( NBags, TotSum )

  var
    RecFound,
    dt,
    cmd_1, cmd_2,
    rs_1, rs_2,	 
    BrigadeID = GetOperBrigade;

  NBags = 0;
  TotSum = $0;

if ( StrFor(GetProgramID) == "Л" )

  ClearRecord( BagList );
  BagList.Branch = Branch;  
  BagList.Date = {curdate};
  BagList.State = BST_SENT;
  RecFound = GetGE( BagList );
  while ( RecFound
    and ( BagList.Branch == Branch )   
    and ( BagList.Date == {curdate} ) 
    and ( BagList.State == BST_SENT ) )
     if (  ( BagList.Safe == {RprtDSubj} )
       and ( BagList.ValueRef == CashValue.RefValue ) 
       and ( BagList.Oper == Person.Oper ) 
       and ( BagList.Operation == CASHOP_PANT_RDEB ) )
       NBags = NBags + 1;
       if ( BagList.RealSum )
         TotSum = TotSum + BagList.RealSum;
       else
         TotSum = TotSum + Money( BagList.RealItems );
       end;
     end;
     RecFound = Next( BagList );
  end;
else 
  cmd_1 = RsdCommand(" select count(*) from DSB_CASDC_DBT, dsb_casln_dbt, dret_op_dbt "
                     " where (DSB_CASDC_DBT.T_CASHDATEDOC = ? ) AND (DSB_CASDC_DBT.T_BRANCH = ?) AND "
                     " (DSB_CASDC_DBT.T_TYPEDOC = ?) AND (DSB_CASDC_DBT.T_REFVALUE = ?) AND "
                     " (DSB_CASDC_DBT.T_BRIGADE = ?) AND (DSB_CASDC_DBT.T_NUMOPER = ?) and  "
                     " (dsb_casdc_dbt.T_APPLICATIONKIND = dsb_casln_dbt.T_APPLICATIONKIND2) and "
                     " (dsb_casln_dbt.T_APPLICATIONKIND1 = dret_op_dbt.T_APPLICATIONKIND) and "
                     " (dret_op_dbt.T_OPER = ?)  and  (dsb_casdc_dbt.T_APPLICATIONKEY = dsb_casln_dbt.T_APPLICATIONKEY2)"
                     " and (dsb_casln_dbt.T_APPLICATIONKEY1 = dret_op_dbt.T_APPLICATIONKEY) "
                     " and (dsb_casdc_dbt.T_REFVALUE = dsb_casln_dbt.T_REFVALUE2) and" 
                     " dsb_casdc_dbt.T_APPLICATIONKIND = ? "  );

  cmd_1.addParam("DSB_CASDC_DBT.T_CASHDATEDOC", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_CASHDATEDOC") =  {curdate};
  cmd_1.addParam("DSB_CASDC_DBT.T_BRANCH", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_BRANCH")=NumFNCash;
  cmd_1.addParam("DSB_CASDC_DBT.T_TYPEDOC", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_TYPEDOC") = TYPEDOC_CARRYON;
  cmd_1.addParam("DSB_CASDC_DBT.T_REFVALUE", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_REFVALUE") = CashValue.RefValue;
  cmd_1.addParam("DSB_CASDC_DBT.T_BRIGADE", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_BRIGADE") = BrigadeID;
  cmd_1.addParam("DSB_CASDC_DBT.T_NUMOPER", RsdBp_in);
  cmd_1.value("DSB_CASDC_DBT.T_NUMOPER") = CASHOP_CREDIT;
  cmd_1.addParam("dret_op_dbt.T_OPER", RsdBp_in); 
  cmd_1.value("dret_op_dbt.T_OPER") = Person.oper;
  cmd_1.addParam("dsb_casdc_dbt.T_APPLICATIONKIND", RsdBp_in); 
  cmd_1.value("dsb_casdc_dbt.T_APPLICATIONKIND") = SB_RSBANK;

 cmd_1.execute;

  cmd_2 = RsdCommand(" select sum(T_VALUEMONEY) from DSB_CASDC_DBT, dsb_casln_dbt, dret_op_dbt where "
                     " (DSB_CASDC_DBT.T_CASHDATEDOC = ? ) AND (DSB_CASDC_DBT.T_BRANCH = ?) AND "
                     " (DSB_CASDC_DBT.T_TYPEDOC = ?) AND (DSB_CASDC_DBT.T_REFVALUE = ?) AND "
                     " (DSB_CASDC_DBT.T_BRIGADE = ?) AND (DSB_CASDC_DBT.T_NUMOPER = ?) and  "
                     " (dsb_casdc_dbt.T_APPLICATIONKIND = dsb_casln_dbt.T_APPLICATIONKIND2) and "
                     " (dsb_casln_dbt.T_APPLICATIONKIND1 = dret_op_dbt.T_APPLICATIONKIND) and "
                     " (dret_op_dbt.T_OPER = ?)  and  (dsb_casdc_dbt.T_APPLICATIONKEY = dsb_casln_dbt.T_APPLICATIONKEY2)"
                     " and (dsb_casln_dbt.T_APPLICATIONKEY1 = dret_op_dbt.T_APPLICATIONKEY) and "
                     " (dsb_casdc_dbt.T_REFVALUE = dsb_casln_dbt.T_REFVALUE2) and"
                     " dsb_casdc_dbt.T_APPLICATIONKIND = ? "  );

  cmd_2.addParam("DSB_CASDC_DBT.T_CASHDATEDOC", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_CASHDATEDOC") =  {curdate};
  cmd_2.addParam("DSB_CASDC_DBT.T_BRANCH", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_BRANCH")=NumFNCash;
  cmd_2.addParam("DSB_CASDC_DBT.T_TYPEDOC", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_TYPEDOC") = TYPEDOC_CARRYON;
  cmd_2.addParam("DSB_CASDC_DBT.T_REFVALUE", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_REFVALUE") = CashValue.RefValue;
  cmd_2.addParam("DSB_CASDC_DBT.T_BRIGADE", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_BRIGADE") = BrigadeID;
  cmd_2.addParam("DSB_CASDC_DBT.T_NUMOPER", RsdBp_in);
  cmd_2.value("DSB_CASDC_DBT.T_NUMOPER") = CASHOP_CREDIT;
  cmd_2.addParam("dret_op_dbt.T_OPER", RsdBp_in); 
  cmd_2.value("dret_op_dbt.T_OPER") = Person.oper;
  cmd_2.addParam("dsb_casdc_dbt.T_APPLICATIONKIND", RsdBp_in); 
  cmd_2.value("dsb_casdc_dbt.T_APPLICATIONKIND") = SB_RSBANK;

 cmd_2.execute;

  rs_1 = RsdRecordset(cmd_1); 
  rs_1.moveNext();
  rs_2 = RsdRecordset(cmd_2);
  rs_2.moveNext();
                                 	

  NBags = Int(rs_1.value(0));
  if ( rs_2.value(0) != null )
    TotSum = Money(rs_2.value(0));
  else 
    TotSum = 0;
  end;
end;

  SetParm( 0, NBags );
  SetParm( 1, TotSum );
end;

macro TreatOper

  var
    NBags,
    TotSum;

  CountBagsForOper( NBags, TotSum );
  if ( TotSum != $0 )
    OutLine( NBags, TotSum );
    TotNBags = TotNBags + NBags;
    TotTotSum = TotTotSum + TotSum;
  end;
end;

macro Report( IsCur )

  var
    Prompt,
    CurrCode = 0;

  if ( IsCur )
    if ( not SelectCurrency( CurrCode ) )
      Exit( 1 );
    end;
  end;

  if ( not FindCurr( CurrCode ) )
    MsgBox( "Не найдена валюта с кодом ", CurrCode );
    Exit( 1 );
  end;

  if ( not FindCashValForTypeCode( 0, TYPERES_CURRENCY, CurrCode ) )
    MsgBox( "Не найден ресурс Кассы для валюты '" + Curr.Name_Currency + "'" );
    Exit( 1 );
  end;

  GetCBRate;

  if ( IsCur )
    Prompt = "Введите сумму в валюте '" + Curr.Name_Currency + "', выданную под отчет";
  else
    Prompt = "Введите сумму, выданную под отчет";
  end;
  GetMoney( ReceivedSum, Prompt );

  OutHead;

  Rewind( Person );
  while ( Next( Person ) )
    TreatOper;
  end;

  OutTotals;
  OutFooter;
end;
