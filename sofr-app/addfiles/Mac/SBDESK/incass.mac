/* Дневник по инкассации */

import deprintr;

file Alg    ("namealg.dbt","bank.def")  key 0;
file CashDoc("sb_casdc.dbt") key 0;
file CashVal("sb_casvl.dbt") key 0;

const
  CD_Uncarried = 1,
  CD_Carried = 2;

const
  OC_Credit = "1",
  OC_Debet = "2";

const
  ALG_CASH_VAL_TYPE = 811;    /* Типы ресурсов кассы в namealg.dbt */

var
  Branch = NumFNCash,
  {curdate},
  StartDate={curdate},
  EndDate={curdate};

/* Получить название типа ресурса кассы */
macro GetCashTypeName(Type)

  Alg.iTypeAlg = ALG_CASH_VAL_TYPE;
  Alg.iNumberAlg = Type;
  if(GetEQ(Alg))
    return Alg.szNameAlg;
  else
    return String(Type);
  end;
end;  

macro GetValName(RefValue)
  var str;
  CashVal.RefValue=RefValue;
  if(not GetEQ(CashVal))
    return "???";
  else
    str = CashVal.NameValue;
    if ( CashVal.Type != 0 )
      str = str + " (" + GetCashTypeName(CashVal.Type) + ")";
    end;
    return str;
  end;
end;

macro OutTitle;

  [
                              Книга подкреплений и сдач денег,
                                 ценностей и ценных бланков
  ];
  if(StartDate==EndDate)
    PrintLn("                                     за ",String(StartDate));
  else
    PrintLn("                         за период с ",String(StartDate),
      " по ",String(EndDate));
  end;
end;

macro OutCarriedDocsSubTitle;

  PrintLn;
  PrintLn("  Подтвержденные документы");
  PrintLn;
end;

macro OutUncarriedDocsSubTitle;

  PrintLn;
  PrintLn("  Неподтвержденные документы");
  PrintLn;
end;

macro OutHeader;
  [┌────────────┬───────────┬──────────────────────────────────────────────────────────────────────────────────────────┬───────────┬───────────────────┬───────────────────┐
   │            │           │                                                                                          │           │Подписи работников │                   │
   │            │   Номер   │                                                                                          │   Номер   │кладовой отделения │Подписи работников │
   │            │ отделения │                                                                                          │  филиала  │Сбербанка, удосто- │кладовой отделения │
   │ Ч и с л о, │ Сбербанка,│    В ы с л а н о   д е н е г ,   ц е н н о с т е й    и   ц е н н ы х   б л а н к о в    │ Сбербанка,│ веряющие правиль- │Сбербанка, удосто- │
   │            │  которое  │                                                                                          │  в адрес  │ность сделанных за-│веряющие получение │
   │            │  высылает │                                                                                          │  которого │ писей об отсылке  │ценностей,скреплен-│
   │ м е с я ц, │  деньги,  │                                                                                          │  произво- │ ценностей, скреп- │    ные печатью    │
   │            │  ценности │                                                                                          │   дится   │  ленные печатью   │                   │
   │            │  и ценные ├─────────────────────────────────────────────────────────────────┬────────────────────────┤  высылка  ├─────────┬─────────┼─────────┬─────────┤
   │   г о д    │  бланки   │                                                                 │                        │           │ст.контр.│зав.кла- │ст.контр.│зав.кла- │
   │            │           │                                                                 │                        │           │(контр.) │довой,   │(контр.) │довой,   │
   │            │           │                      Н а и м е н о в а н и е                    │       С у м м а        │           │кладовой │ст.кассир│кладовой │ст.кассир│
   │            │           │                                                                 │                        │           │         │(кассир) │         │(кассир) │
   │            │           │                                                                 │                        │           │         │кладовой │         │кладовой │
   ├────────────┼───────────┼─────────────────────────────────────────────────────────────────┼────────────────────────┼───────────┼─────────┼─────────┼─────────┼─────────┤];
end;

macro OutLine;

  var
    Sum;

  if(CashDoc.ValueMoney>$0.00)
    Sum=CashDoc.ValueMoney;
  else
    Sum=CashDoc.ValueCol;
  end;
  [│ ########## │           │ ############################################################### │ ###################### │           │         │         │         │         │]
  (CashDoc.CashDateDoc,GetValName(CashDoc.RefValue),Sum);
end;

macro OutBottomLine;

  [└────────────┴───────────┴─────────────────────────────────────────────────────────────────┴────────────────────────┴───────────┴─────────┴─────────┴─────────┴─────────┘];
end;

macro OutCarriedDocs;
                          
  ClearRecord( CashDoc );
  CashDoc.Branch=Branch;
  CashDoc.CashDateDoc=StartDate;
  CashDoc.TypeDoc=CD_Carried;
  CashDoc.CashOper="Инкассация";

  OutCarriedDocsSubTitle;
  OutHeader;

  if(GetGE(CashDoc))
    if((CashDoc.Branch==Branch) and
      (CashDoc.CashDateDoc<=EndDate) and
      (CashDoc.TypeDoc==CD_Carried) and
      (CashDoc.CashOper=="Инкассация") and
      (CashDoc.FlagDebCredOper==OC_Debet))
      OutLine;
    end;
    while(Next(CashDoc))
      if((CashDoc.Branch==Branch) and
        (CashDoc.CashDateDoc<=EndDate) and
        (CashDoc.TypeDoc==CD_Carried) and
        (CashDoc.CashOper=="Инкассация") and
        (CashDoc.FlagDebCredOper==OC_Debet))
        OutLine;
      end;
    end;
  end;

  OutBottomLine;
end;

macro OutUncarriedDocs;

  ClearRecord( CashDoc );
  CashDoc.Branch=Branch;
  CashDoc.CashDateDoc=StartDate;
  CashDoc.TypeDoc=CD_Uncarried;
  CashDoc.CashOper="Инкассация";

  OutUncarriedDocsSubTitle;
  OutHeader;

  if(GetGE(CashDoc))
    if((CashDoc.Branch==Branch) and
      (CashDoc.CashDateDoc<=EndDate) and
      (CashDoc.TypeDoc==CD_Uncarried) and
      (CashDoc.FlagDebCredOper==OC_Debet) and
      (CashDoc.CashOper=="Инкассация") and
      (CashDoc.FlagDebCredOper==OC_Debet))
      OutLine;
    end;
    while(Next(CashDoc))
      if((CashDoc.Branch==Branch) and
        (CashDoc.CashDateDoc<=EndDate) and
        (CashDoc.TypeDoc==CD_Uncarried) and
        (CashDoc.FlagDebCredOper==OC_Debet) and
        (CashDoc.CashOper=="Инкассация") and
        (CashDoc.FlagDebCredOper==OC_Debet))
        OutLine;
      end;
    end;
  end;

  OutBottomLine;
end;

macro SetupPeriod;

  record
    Period(Incass)dialog;

  Period.StartDate=StartDate;
  Period.EndDate=EndDate;
  RunDialog(Period);
  StartDate=Period.StartDate;
  EndDate=Period.EndDate;
end;

  SetupPeriod;
  OutTitle;
  OutCarriedDocs;
  OutUncarriedDocs;
end;

