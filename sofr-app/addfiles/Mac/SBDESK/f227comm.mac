/*
file DBcAcc( "dbc_acc.dbt" ) key 0;
file DBcDoc( "dbc_doc.dbt" ) key 2;
file SbCasac( "sb_casac.dbt" ) key 0;
*/
import sqlconv, TDate, CommonInter;

var
  CalcTurnsProc;

private const
  ShowNullLines=false,  /* Показывать ли строки, где все нули */
  NeedPrintOutCoinMetTotLine = false, /* Печатать ли итоговую строку по металлу */
  FlagLaserPrint = FALSE; // FALSE - отключить

private const
  CK_NEW          = 0, 
  CK_OLD          = 1;

var
  PrintHeadIfNeed=-1,
  MetallName,
  PrevDate,
  IsExistRest = true,

  MetalTotPrevRest  = 0,
  MetalTotCredit    = 0,
  MetalTotDebet     = 0,
  MetalTotRest      = 0,
  MetalTotPrevRestA  = $0.0L,
  MetalTotCreditA    = $0.0L,
  MetalTotDebetA     = $0.0L,
  MetalTotRestA      = $0.0L,

  PrintTotMet = 0;

private var
  TotPrevRest=0,
  TotCredit=0,
  TotDebet=0,
  TotRest=0,
  TotPrevRestA=$0,
  TotCreditA=$0,
  TotDebetA=$0,
  TotRestA=$0, 

  MetTotPrevRest=0,
  MetTotCredit=0,
  MetTotDebet=0,
  MetTotRest=0,
  MetTotPrevRestA=$0,
  MetTotCreditA=$0,
  MetTotDebetA=$0,
  MetTotRestA=$0;

/*************************************************/
private macro GetStrForSignt()
  var str = "";
  
  if( GetBankStandart() == 0 )
    str = "(наименование, № филиала Сбербанка России/№ ВСП)";
  else
    str = "(Наименование кредитной организации)";
  end;

  return str;
end;
/*************************************************/

private macro PrintSeparator()
  [+------------------------------+-----------+--------+-------+---------+----------------+]; 
end;

private macro GetBranchName()
  var ddep = TRecHandler( "i_dp_dep.rec" );
  var party = TRecHandler( "i_party.rec" );

  if ( findDepartment(NumFNCash, null, ddep, party) )
    return party.rec.Name + "  " + ddep.rec.Name;
  else
    return "<не найден>";
  end;
end;

private macro OutCoinHeader;

  var dateStr = TDateStorage;

  if( FlagLaserPrint )
    println ("E&l1O(3R(s0p16.00h16)");
  end;
  [ ];
  [ ############################################################################### 	   ]
  ( GetBranchName );                                                                       
  [ ------------------------------------------------				    ф.№227 ];
  [ ################################################					   ]
  ( GetStrForSignt():c );
  [ ];
  [ ];
  [                            		   К Н И Г А                                       ];
  [ учета монет Банка России из драгоценных металлов, находящихся в обращении, в хранилище ];
  [ ];
  [ ];
  [                                                        		    Месяц__#_______]
  ( dateStr.getNameMonthForNum(null,true) );
  [+------------------------------+-----------+--------+-------+--------------------------+];
  [|           Краткое            |  Качество |        |       |          Остаток на      |];
  [|         наименование         |  чеканки, | Металл |Номинал|       #                  |]( dateStr.getDateInCurStr("\"dd\" month yyyy г.", {curdate} + 1) );
  [|           монеты             |           |        |       |                          |];
  [|                              |   проба   |        | руб.  +---------+----------------+];
  [|                              |           |        |       | Кол-во, |      Сумма,    |];
  [|                              |           |        |       |   шт.   |       руб.     |];
  PrintSeparator();                                                         
  [|             1                |     2     |   3    |    4  |    5    |         6      |];
end;

private macro OutCoinTail

  [ ];
  [ Заведующий кассой 			        _______________     ______________________ ];
  [  			  		        		           (Ф.И.О.)        ];
  [ ];
  [ Руководитель филиала банка			_______________     ______________________ ];
  [  				 					   (Ф.И.О.)        ];
  [ ];
  [ С данными бухгалтерского учета сверено:				   		   ];
  [ ];
  [ Главный бухгалтер		 		_______________     ______________________ ];
  [  					        		           (Ф.И.О.)        ];
  [ ];
  PrintLn( StrFor( 12 ) );
end;

private macro CreateStr( HallMarkRef )
  var retval = string(HallMarkRef);
  while( (strlen(retval) > 0) and (substr(retval, strlen(retval), 1) == "0" ) )
    retval = substr(retval,1,strlen(retval)-1);
  end;
  if( substr(retval,strlen(retval),1) == "." )
    retval = substr(retval,1,strlen(retval)-1);
  end;
  return retval;
end;

private macro OutCoinLine(NameVal,PrevRest,CurRest,Cred,Deb);
  var Name;

  if((not ShowNullLines) and (PrevRest==$0) and (Cred==$0)
     and (Deb==$0) and (CurRest==$0))
    return;
  end;

  if(PrintHeadIfNeed==-1)
    OutCoinHeader;
    PrintHeadIfNeed=PrintHeadIfNeed+1;
  end;
  PrintHeadIfNeed=PrintHeadIfNeed+1;

  GetPos( CICode );
  FindCICode(CiMisc.MaterialRef);
  Name=CICode.String;
  FindCICode( CIMisc.HallmarkRef );
  PrintSeparator();
  [|##############################|###########|########|#######|#########|################|]
  (
    (NameVal/* + ", " +
    String( CIMisc.IssueYear ) */):w,
    (CIMisc.Quality + ", " + CreateStr(CICode.Double)):w,
    Name:w,
    String(CIMisc.Par),
/*
    Int( Double(PrevRest) ):z:w,
    Money(PrevRest * CIMisc.Par ):z:w,
    Int( Double(Cred)):z:w,
    Money(Cred * CIMisc.Par ):z:w,
    Int( Double(Deb)):z:w,
    Money(Deb * CIMisc.Par ):z:w,
*/
    Int( Double(CurRest)):z,
    Money( CurRest * CIMisc.Par ):z:w
  );
  TotPrevRest=Int(Double(TotPrevRest))+Int(Double(PrevRest));
  TotPrevRestA=TotPrevRestA+Money(PrevRest * CIMisc.Par);
  TotCredit=Int(Double(TotCredit))+Int(Double(Cred));
  TotCreditA=TotCreditA+Money(Cred * CIMisc.Par);
  TotDebet=Int(Double(TotDebet))+Int(Double(Deb));
  TotDebetA=TotDebetA+Money(Deb * CIMisc.Par);
  TotRest=Int(Double(TotRest))+Int(Double(CurRest));
  TotRestA=TotRestA+Money(CurRest * CIMisc.Par);

  MetalTotPrevRest=MetalTotPrevRest+Int(Double(PrevRest));
  MetalTotPrevRestA=MetalTotPrevRestA+Money(PrevRest * CIMisc.Par);
  MetalTotCredit=MetalTotCredit+Int(Double(Cred));
  MetalTotCreditA=MetalTotCreditA+Money(Cred * CIMisc.Par);
  MetalTotDebet=MetalTotDebet+Int(Double(Deb));
  MetalTotDebetA=MetalTotDebetA+Money(Deb * CIMisc.Par);
  MetalTotRest=MetalTotRest+Int(Double(CurRest));
  MetalTotRestA=MetalTotRestA+Money(CurRest * CIMisc.Par);
  PrintTotMet = 1;

  GetDirect( CICode );
end;

private macro OutCoinTotLine
  PrintSeparator();
  [| И т о г о :                                               |#########|################|]
  (
/*
    TotPrevRest:z,
    TotPrevRestA:z,
    TotCredit:z,
    TotCreditA:z,
    TotDebet:z,
    TotDebetA:z,
*/
    TotRest:z,
    TotRestA
  );
  PrintSeparator();
  PrintHeadIfNeed=0;
end;

private macro TotalLineOnMetall
  PrintSeparator();
  [| И т о г о по металлу #####################################|#########|################|]
  (
    MetallName,
/*
    MetalTotPrevRest:z,
    MetalTotPrevRestA:z,
    MetalTotCredit:z,
    MetalTotCreditA:z,
    MetalTotDebet:z,
    MetalTotDebetA:z,
*/
    MetalTotRest:z,
    MetalTotRestA
  );
  MetalTotPrevRest  = 0;
  MetalTotCredit    = 0;
  MetalTotDebet     = 0;
  MetalTotRest      = 0;
  MetalTotPrevRestA  = $0.0L;
  MetalTotCreditA    = $0.0L;
  MetalTotDebetA     = $0.0L;
  MetalTotRestA      = $0.0L;
  PrintTotMet = 0;
end;

private macro ReportOnCurCoin

  var
    RecFound,
    PrevRest=0,
    CurRest=0,
    Deb=0,
    Cred=0,
    OtherDeb=0,
    OtherCred=0;

  /* В ведомости следует считать монеты поштучно! */

/*
  ExecMacro( CalcTurnsProc,CashVal.rec.RefValue,Cred,Deb,OtherCred,OtherDeb );

  CashAcc.KeyNum = 2;
  CashAcc.addFilter( "t.t_Branch = " + String( Branch ) +
                      " and t.t_CashOper = " + GetSQLString( Safe ) +
                      " and t.t_RefValue = " + String( CashVal.rec.RefValue )  );
  CashAcc.Clear;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetLT and
    (CashAcc.rec.Branch==Branch) and
    (CashAcc.rec.RefValue==CashVal.rec.RefValue) and
    (CashAcc.rec.CashOper==Safe))
    PrevRest=Money(CashAcc.rec.RestCol);
  end;
  CashAcc.dropFilter;
*/

  CashAcc.KeyNum = 0;
  CashAcc.Clear;
  CashAcc.rec.Branch=Branch;
  CashAcc.rec.CashOper=Safe;
  CashAcc.rec.RefValue=CashVal.rec.RefValue;
  CashAcc.rec.Date={curdate};
  if(CashAcc.GetEQ)
    CurRest=Money(CashAcc.rec.RestCol);
//    if ( {DeskOpen} )
//      PrevRest = PrevRest + Money( ( CashAcc.rec.EKredCol - CashAcc.rec.EDebCol ) ); 
//    end;
  end;

  OutCoinLine(CashVal.rec.NameValue,PrevRest,CurRest,Cred + OtherCred,Deb + OtherDeb);
end;


private macro ReportOnCoinResourcesForMetal;

  var stat;
                       
  MetTotPrevRest=$0;
  MetTotCredit=$0;
  MetTotDebet=$0;
  MetTotRest=$0;
  MetTotPrevRestA=$0;
  MetTotCreditA=$0;
  MetTotDebetA=$0;
  MetTotRestA=$0;

  
  CashVal.rec.FlagIntoBalance = 1;
  stat = CashVal.GetGE;
  while (stat and ( CashVal.rec.FlagIntoBalance == 1 ) )
    if ((CashVal.rec.RefValueReport != 1          ) AND
        (CashVal.rec.TypeValue == CV_MinCI + CI_COIN) )
      FindCIMisc( CI_COIN, CashVal.rec.CodIntValue );
      if ( ( CIMisc.KindOfCoin == CK_NEW ) 
        and ( CIMisc.MaterialRef == CICode.AutoKey ) )
        ReportOnCurCoin();
      end;
    end;
    stat = CashVal.Next;
  end;
  
end;

private macro ReportOnCoinResources;

  var
    RecFound;

  TotPrevRest  = $0.0L;
  TotCredit    = $0.0L;
  TotDebet     = $0.0L;
  TotRest      = $0.0L;
  TotPrevRestA  = $0.0L;
  TotCreditA    = $0.0L;
  TotDebetA     = $0.0L;
  TotRestA      = $0.0L;

  ClearRecord( CICode );
  CICode.UpLink = 0;
  CICode.Group = 2; /* CRE_MATERIAL */
  RecFound = GetGE( CICode );
  while ( RecFound
    and ( CICode.UpLink == 0 ) 
    and ( CICode.Group == 2 ) ) /* CRE_MATERIAL */
    MetallName = CICode.String;
    ReportOnCoinResourcesForMetal;
    if(PrintTotMet and NeedPrintOutCoinMetTotLine)
      TotalLineOnMetall;
    end;
    RecFound = Next( CICode );
  end;
  if(PrintHeadIfNeed>0) 
/* SCR 63709
    OutCoinTotLine;
*/
    PrintSeparator();
    OutCoinTail;
  end;
end;

macro TreatCurrentSafe

  TotPrevRest=$0;
  TotCredit=$0;
  TotDebet=$0;
  TotRest=$0;
  TotPrevRestA=$0;
  TotCreditA=$0;
  TotDebetA=$0;
  TotRestA=$0;

/*  if ( Index( DeskSubj.Reports, "М" ) != 0 )*/
    ReportOnCoinResources;
/*  end;*/
end;
