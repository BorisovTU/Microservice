/*
Обновление наименований счетов 47423*, открытх по КУ №5087 "+РасчетыКомисс1"
Обновяться только счета 47423*, запись о которых имеется в таблице счетов, открытых по категориям учете dmcaccdoc_dbt
На тестовой схеме
*/

import DealsInter, "cb_sql.mac", "sfcommon.mac", "dlquery.mac";
import "padej.mac";

Private macro IIF(condition, value_true, value_false)
    If(condition)
       return value_true;
    else
       return value_false;
    end;
end;


  var sqlQuery = RSDCommand(
"      SELECT DISTINCT(ACC.T_ACCOUNTID)AS T_ACCOUNTID,acc.T_ACCOUNT, "+
"        ACC.T_NAMEACCOUNT, MC.T_CATNUM,pt.t_legalform, pt.t_name, "+
"        PT.T_SHORTNAME, sf1.T_NUMBER number_DBO, sf1.T_DATEBEGIN datebegin_DBO,  "+
"        (CASE WHEN sf2.t_servkind = 1 THEN "+
"               (CASE WHEN sf2.t_servkindsub = 9 THEN'внебиржевом рынке' "+
"                     ELSE 'биржевом рынке' END) "+
"           WHEN sf2.t_servkind = 15 THEN "+
"               'срочном рынке' END)  kind_sf "+
"      FROM daccount_dbt acc,dmcaccdoc_dbt mc, dparty_dbt pt, "+
"       dsfcontr_dbt   sf1, dsfcontr_dbt   sf2 "+
"      WHERE     MC.T_CHAPTER IN (1) "+
"       AND MC.T_CATNUM IN (5087) "+
"       AND mc.t_account = ACC.T_ACCOUNT "+
"       AND MC.T_OWNER = PT.T_PARTYID "+
//"       and PT.T_PARTYID = 128293   "+       //для проверки
"       AND sf1.T_ID = (SELECT T_ID FROM dsfcontr_dbt WHERE t_id = "+
"                       (SELECT t_sfcontrid FROM ddlcontr_dbt WHERE t_dlcontrid = "+
"                         (SELECT t_dlcontrid FROM ddlcontrmp_dbt WHERE t_sfcontrid = mc.T_CLIENTCONTRID))) "+
"       AND mc.T_CLIENTCONTRID = sf2.T_ID");

  sqlQuery.execute();

  var sqlData = TRsbDataSet(sqlQuery);
  var new_nameaccount ="";
  var count = 0;

while (sqlData.movenext)
  new_nameaccount = "Требования к "+ IIF (sqlData.t_legalform == 2, падеж (sqlData.t_name, 3), sqlData.T_SHORTNAME) +" по уплате комиссий по дог. № " +sqlData.NUMBER_DBO + " от " + date(sqlData.datebegin_DBO) +" по операциям на " + sqlData.kind_sf;
        
  var cmd = RsdCommand( "UPDATE daccount_dbt SET T_NAMEACCOUNT = ? WHERE T_ACCOUNTID = ? AND T_ACCOUNT = ?" );
  cmd.addParam("", RsdBp_In, new_nameaccount);
  cmd.addParam("", RsdBp_In, sqlData.T_ACCOUNTID);
  cmd.addParam("", RsdBp_In, sqlData.T_ACCOUNT);
  cmd.execute();

  new_nameaccount = "";
  count = count + 1;
 end;                           

  return msgbox ("Обновлены наименования "+ count +" счетов");

end;