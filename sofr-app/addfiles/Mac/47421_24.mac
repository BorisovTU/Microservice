IMPORT "or_rep_h.mac", dv_fun, "dv_categ.mac", "dl_car.mac", "dv_car.mac";

private var Rep, Repp;
private var delim = GetLocaleInfo(0, LOCALE_SDECIMAL, false);

/* Первый вызов макроса для вывода заголовка и задания начальных настроек */
macro f(s,string)
  return strsubst(strsubst(s,".",delim),",",delim);
end;

MACRO First_Call()

  var StrHeader:string =
                                                                                                                              
"┌────────────────────────┬────────────────────────┬────────────────────┬──────────────────────┬──────────────────────┐\n"+
"│                        │                        │                    │                      │                      │\n"+
"├────────────────────────┼────────────────────────┼────────────────────┼──────────────────────┼──────────────────────┤";

  /* Создадим объект класса CMakeReport */
  Rep = CMakeReport(StrHeader);

END; /* First_Call */


/* Циклический вызов макроса, для формирования таблицы с данными */
MACRO PrintLine_Alg(a1, a2, a3, a4, a5, a6)

  Rep.AddPrintCell(a1);
  Rep.AddPrintCell(a2);
  Rep.AddPrintCell(a3);
  Rep.AddPrintCell(a4);
  Rep.AddPrintCell(a5);
  Rep.AddPrintCell(a6);
  Rep.AddStr();

END;


/* Последний вызов макроса для печати и визуализации отчета */
MACRO Last_Call()
  
  /* Печатаем, только если есть хоть одна запись */
  if(Rep.IsDataExist())
     Rep.PrintRep();
     /* Печатаем отчет в Excel */
     Rep.PrintWinRep(1, "Sheet"); 
     /* Делаем окно с Excel активным */
     Rep.ShowWinRep();   
  end;
  
END;

var Query, Query1, Query2, Sql, Sql1, Sql2, Dt, Dt1, Dt2;
var AccPlus = TRecHandler("account");
var AccMinus = TRecHandler("account");
var Счетдеб = TRecHandler("account");
var СчетКред = TRecHandler("account");
var FD, PayDate = {Curdate};
var id_operation = 0;
var NRec = 0;
var curContrid = 0, curCCY = 0;
var restAccPlus = 0, restAccMinus = 0, restAccPlus_cur = 0, restAccMinus_cur = 0, restAccPlus_ = 0, restAccMinus_ = 0;

if (not GetDate(PayDate, "Введите дату отчета"))
    PayDate = {Curdate};
end;

First_Call();

Query1 = " SELECT DEAL.t_id, "+
         "                   DEAL.t_contractor, "+
         "                   DEAL.t_state, "+
         "                   DEAL.t_kind, "+
         "                   DEAL.t_dockind, fin.T_CCY, oper.t_id_operation "+
         "              FROM DDVNDEAL_DBT deal, ddvnfi_dbt fi, DFININSTR_DBT fin, DOPROPER_DBT oper  "+
         "             WHERE     DEAL.t_dockind = 4813 "+
         "                   AND DEAL.t_date <= ? "+
         "                   AND DEAL.t_client = -1 "+
         "                   AND deal.t_kind IN (12730, 22730, 12735) "+ 
         "                   AND fi.T_DEALID = deal.T_ID  "+
         "                   AND DEAL.T_PERIODCLS > 0"
         "                   AND fi.T_EXECDATE = ? "+
         "                   AND fin.t_fiid = fi.t_fiid  "+
         "                   AND LTRIM (OPER.t_documentid, '0') = deal.T_ID "+
         "                   AND OPER.T_KIND_OPERATION = deal.t_kind "+
         "  order by DEAL.t_contractor, T_CCY ";

Sql1 = DL_RSdCommand();
Sql1.addParam(PayDate);
Sql1.addParam(PayDate);

NRec = Sql1.GetCount(Query1);
Dt1 = Sql1.execute(Query1);
var Progress = TProgressBar;
Progress.Init(NRec, "Печать отчета", "Печать отчета");
var i = 0;

while (Dt1.movenext())
       Query = " SELECT "+
               "    NVL(SUM ( "+
               "          CASE "+
               "             WHEN SUBSTR (acctrn.T_ACCOUNT_PAYER, 1, 5) IN ('47421') "+
               "             THEN "+
               "                acctrn.T_SUM_NATCUR "+
               "             WHEN SUBSTR (acctrn.T_ACCOUNT_RECEIVER, 1, 5) IN ('47421') "+
               "             THEN "+
               "                acctrn.T_SUM_NATCUR * -1 "+
               "             ELSE "+
               "                0 "+
               "          END), 0) "+
               "          AS t_Rest47421, "+
               "       NVL(SUM ( "+
               "          CASE "+
               "             WHEN SUBSTR (acctrn.T_ACCOUNT_PAYER, 1, 5) IN ('47424') "+
               "             THEN "+
               "                acctrn.T_SUM_NATCUR "+
               "             WHEN SUBSTR (acctrn.T_ACCOUNT_RECEIVER, 1, 5) IN ('47424') "+
               "             THEN "+
               "                acctrn.T_SUM_NATCUR * -1 "+
               "             ELSE "+
               "                0 "+
               "          END),0) "+
               "          AS t_Rest47424"+
               "  FROM doprdocs_dbt docs, "+
               "       dacctrn_dbt acctrn "+
               " WHERE docs.T_ID_OPERATION = ? "+
               "       AND (SUBSTR (acctrn.T_ACCOUNT_PAYER, 1, 5) IN ('47421', '47424') "+
               "            OR SUBSTR (acctrn.T_ACCOUNT_RECEIVER, 1, 5) IN ('47421', '47424')) "+
               "       AND (    docs.t_DocKind = 1 "+
               "            AND docs.t_AccTrnID = acctrn.t_AccTrnID "+
               "            AND acctrn.t_State = 1)  "+
               "      and exists (select 1 from doprstep_dbt step where step.t_id_operation =  docs.T_ID_OPERATION and step.t_symbol = 'б' and step.t_isexecute = 'X' and step.T_DOCKIND = 4813) ";/*PNV только сделки которые уже поставлены на баланс*/
             
  Sql = DL_RSdCommand();
  Sql.addParam(Dt1.id_operation);
  Dt = Sql.execute(Query);

  while (Dt.movenext())
         FD = DVFirstDocFXDeal(DL_DVFXDEAL, int(Dt1.ID));
         ClearRecord(AccPlus);
         ClearRecord(AccMinus);
         ClearRecord(СчетКред);
         ClearRecord(СчетДеб);

        if( not FD.IsExistAccount("+Переоц.,поставка0", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, MC_PAIRACCMODE_MANUAL, PayDate, NATCUR) )
            return 1;
        end;
        if( not FD.IsExistAccount("-Переоц.,поставка0", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, MC_PAIRACCMODE_MANUAL, PayDate, NATCUR) )
            return 1;
        end;

        if ((curContrid != Dt1.contractor) or (Dt1.CCY != curCCY))
            if (curContrid != 0)
               PrintLine_Alg("Окончательный остаток", "", "", "",  (restAccMinus_cur + restAccPlus_cur) - (restAccPlus - restAccMinus), "");
            end;
            restAccPlus  = 0;
            restAccMinus  = 0;
            restAccPlus_cur  = ABS(GetRestAccountTRH(AccPlus, PayDate));
            restAccMinus_cur  = ABS(GetRestAccountTRH(AccMinus, PayDate));
            PrintLine_Alg("Базовая валюта", Dt1.CCY, "", "",  "", "");
            PrintLine_Alg("Исходный остаток", AccPlus.rec.account, restAccPlus_cur, AccMinus.rec.account,  restAccMinus_cur, "");
        end;
        if ( ((ABS(Dt.Rest47421)!= 0) or (ABS(Dt.Rest47424) != 0 )) and ((ABS(Dt.Rest47421) - ABS(Dt.Rest47424)) != 0))
               PrintLine_Alg("Расхождение!!!!!", FD.DealCode():c, "Сумма расхождения =", ABS(Dt.Rest47421) - ABS(Dt.Rest47424),  "", "");
               Query2 = " SELECT acctrn.* "+
                          "  FROM doprdocs_dbt docs, "+
                          "       dacctrn_dbt acctrn "+
                          " WHERE docs.T_ID_OPERATION = ?  "+
                          "       AND (SUBSTR (acctrn.T_ACCOUNT_PAYER, 1, 5) IN ('47421', '47424') "+
                          "            OR SUBSTR (acctrn.T_ACCOUNT_RECEIVER, 1, 5) IN ('47421', '47424')) "+
                          "       AND (    docs.t_DocKind = 1 "+
                          "            AND docs.t_AccTrnID = acctrn.t_AccTrnID "+
                          "            AND acctrn.t_State = 1) ";
             
               Sql2 = DL_RSdCommand();
               Sql2.addParam(Dt1.T_ID_OPERATION);
               Dt2 = Sql2.execute(Query2); 
               while (Dt2.movenext())
                     PrintLine_Alg(FD.DealCode():c, Date(Dt2.DATE_CARRY), Dt2.ACCOUNT_PAYER,  Dt2.ACCOUNT_RECEIVER, Dt2.t_sum_Natcur, "");
                end; 
        else
           restAccPlus = restAccPlus + ABS(Dt.Rest47421);
           restAccMinus = restAccMinus + ABS(Dt.Rest47424);        
        end;
        curContrid = Dt1.contractor;
        curCCY = Dt1.CCY;  
        i = i + 1;
        Progress.Use();
  end;
end;
PrintLine_Alg("Окончательный остаток", "", "",  "", (restAccMinus_cur + restAccPlus_cur) - (restAccPlus - restAccMinus), "");
Progress.Remove;
Last_Call();
