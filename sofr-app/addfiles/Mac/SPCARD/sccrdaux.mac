/****************************************************************

Вспомогательные карточные функции

****************************************************************/

//import DeprIntr, alg_vars;
import rsd;

//----------------------------------------------------------------------------------------------

/* ссылка на карту с собственным субсчетом */
macro FindSubAccCardRef (referenc)

  var stat;
  var ref = 0;
   var cmd = RsdCommand(string( " select Card.t_CardRef as crdRef FROM DSCCARD_DBT card , DSCACC_DBT acc, DSCLINK_DBT lnk ",
                         " WHERE acc.T_REFERENC = lnk.T_CARDACCREF ",
                         " AND card.T_CARDREF = lnk.T_CARDREF ",
                         " AND acc.T_CARDACCSTATECODE = 'OK___' ",
                         " and lnk.T_ACCCARDLINKOPENCLOSE = chr(0) ",
                         " and lnk.T_CARDACCREF = ", referenc,
                         " and lnk.T_MAINSUBACCLINKREF = 0 ") );
   

   var ds = RsdRecordset( cmd );
   cmd.execute;
   ds.MoveNext();

   ref = ds.value( "crdRef" );

   return ref;
end;
//----------------------------------------------------------------------------------------------

/* количество субсчетов у СКС */
macro SubAccountsCount (referenc)

  var stat;
  var count = 0;

  var cmd = RsdCommand( string(" select count(*) as Cnt from dscacc_dbt acc, dsclink_dbt lnk ",
                         " where lnk.T_CARDACCREF = acc.T_REFERENC ",
                         " and acc.T_CARDACCSTATECODE = 'OK___' ",
                         " and lnk.T_ACCCARDLINKOPENCLOSE = chr(0) ",
                         " and lnk.T_CARDACCREF = ", referenc,
                         " and lnk.T_MAINSUBACCLINKREF = 0 ") );
   

   var ds = RsdRecordset( cmd );
   cmd.execute;
   ds.MoveNext();

   count = ds.value( "Cnt" );

   return count;
end;

//----------------------------------------------------------------------------------------------
