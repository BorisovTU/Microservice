/**************************************************************************\
*  ---------------------                                                   *
*  R-Style Software Lab.                                                   *
*  ---------------------                                                   *
*  RS-Retail                                                               *
*                                                                          *
*  Пластиковые карточки                                                    *
*                                                                          *
*  Действия при сохранении информации по карточке и вызове из панели для   *
*  Платежной системы Сбербанка                                             *
*                                                                          *
*  Лебедев С.В.                                                            *
*  28.12.98                                                                *
\**************************************************************************/

import deprintr,"sc_error.mac";

record ALG_RET_OP( ret_op );

/*  используются после сохранения  */
record acardold  (scCard      ,"spcard.def" );     /* Карточка - старая строка (до сохранения)          */
file   acardnew  ("scCard.dbt","spcard.def" );     /* Карточка - новая строка (запись после сохранения) */


/*  используются до сохранения  */
record cardnew  (scCard      ,"spcard.def" );       /* Карточка - новая строка         */
record carddop  ("scCard.sb" ,"sc_user.def");       /* Карточка - дополнительная часть */
file   cardold  ("scCard.dbt","spcard.def" );       /* Карточка - старая строка        */
record carddopo ("scCard.sb", "sc_user.def");       /* Карточка - старая строка        */
file   card5    ("scCard.dbt","spcard.def" ) key 5; /* Карточка - для выбора           */
file   sc_acc   (scAcc       ,"spcard.def" );       /* Карточная часть счета           */
file   sc_pos   (scPos       ,"spcard.def" );       /* Платежные системы               */
record sbpos    ("scPos.sb"  ,"sc_user.def");       /* Дополнительная информация по ПС */
file   codif    (scCodif     ,"spcard.def" );       /* Кодификатор                     */
file   depositr (depositr                  );       /* Счета вкладчиков                */
file   currency (currency                  );       /* Справочник валют                */
file   person   (person      ,"bank.def"   );       /* Справочник операционистов       */
file   codes    (                          ) dbf;   /* Кодификатор UNICARD             */

var sc_to_pc = TBFile( "sc_to_pc.dbt", "w", 0, null, "sc_user.def" ); /* Неотправленные данные в ПЦ */

var depclnt = TClientList;

const SBCode = "01";        /* Код платежной системы для Сбербанка */

file cz() txt 300 write;    /* ID файла копии заявления                     */
file zc() txt 300 write;    /* ID файла установления контрольной информации */
file cs() txt 300 write;    /* ID файла установления нового состояния       */
file zp() txt 300;          /* ID файла заявки на изменение личных данных   */

var FileCZ  = "Zayavl.";    /* Имя файла копии заявления                     */
var FileZC  = "ContInf.";   /* Имя файла установления контрольной информации */
var FileCS  = "CardStat.";  /* Имя файла установления нового состояния       */
var FileZP  = "ApplPers.";  /* Имя файла установления личных данных          */
var FileANB = "ApplNoBl.";  /* Имя файла заявления на разблокировку          */

var CodesFromFile  = FALSE; /* TRUE - брать коды UNICARD из codes.dbf          */
var AllErrMessages = FALSE; /* TRUE - при выходе из панели сообщать все ошибки */

var OperForPc = "";         /* Операция, о которой нужно сообщить в ПЦ */
var FormForPc = "";

var {curdate};              /* Дата опердня */
var {oper};                 /* Операционист */
var FNCash = NumFNCash();   /* Филиал       */

/* Панель для заявки на выпуск карточки */
record InputPanel ("SB_ZAYAV","sc_user.lbr") dialog;
const ne_CountCard  = 0,
      ne_WhyChange  = 1,
      ne_UnPay      = 2,
      ne_OtherCards = 3,
      ne_DateZ      = 4,
      ne_DateSecur  = 5,
      ne_DateOPERU  = 6;
  InputPanel.CountCard  = "первичная";
  InputPanel.WhyChange  = "------";
  InputPanel.UnPay      = "НЕ имею";
  InputPanel.OtherCards = "НЕ имею";
  InputPanel.DateZ      = {curdate};
  InputPanel.DateSecur  = {curdate};
  InputPanel.DateOPERU  = {curdate};

/* Панель для изменения контрольной информации по карточке */
record InputPanelBlock ("SB_APNBL","sc_user.lbr") dialog;
const ne_Reason   = 0,
      ne_Add_Info = 1;
  InputPanelBlock.Reason  = "";
  InputPanelBlock.AddInfo = "";

/* Панель для дополнительной информации по карточке */
record InputPanelDopCard  ("SB_CARD1","sc_user.lbr") dialog;
record InputPanelDopCardS ("SB_CARD1","sc_user.lbr") dialog;
const ne_CodeClass     =  0,
      ne_CodeClassName =  1,
      ne_ManWom        =  2,
      ne_ManWomName    =  3,
      ne_Marriage      =  4,
      ne_MarriageName  =  5,
      ne_Private       =  6,
      ne_PrivateName   =  7,
      ne_PostCode      =  8,
      ne_PostCodeName  =  9,
      ne_CodeWork      = 10,
      ne_CodeWorkName  = 11,
      ne_Nation        = 12,
      ne_NationName    = 13,
      ne_TitulClnt     = 14,
      ne_TitulEmboss   = 15,
      ne_AgendaDate    = 16,
      ne_TypeAccount   = 17,
      ne_TypeAccName   = 18;

/* Панель для дополнительной информации по карточке (адрес) */
record InputPanelDopCardAdr  ("SB_CARD2","sc_user.lbr") dialog;
record InputPanelDopCardAdrS ("SB_CARD2","sc_user.lbr") dialog;
const ne_PrimaryAddr =  0,
      ne_TypeAddr1   =  1,
      ne_Index1      =  2,
      ne_Addr1S1     =  3,
      ne_Addr1S2     =  4,
      ne_Addr1S3     =  5,
      ne_TypeAddr2   =  6,
      ne_Index2      =  7,
      ne_Addr2S1     =  8,
      ne_Addr2S2     =  9,
      ne_Addr2S3     = 10,
      ne_TypeAddr3   = 11,
      ne_Index3      = 12,
      ne_Addr3S1     = 13,
      ne_Addr3S2     = 14,
      ne_Addr3S3     = 15,
      ne_HomePhone   = 16,
      ne_WorkPhone   = 17;

var TAddr1 = ""; /* Тип адреса 1 - подкачиваемое поле */
var TAddr2 = ""; /* Тип адреса 2 - подкачиваемое поле */
var TAddr3 = ""; /* Тип адреса 3 - подкачиваемое поле */

/* Панель для дополнительной информации по карточке (паспорт) */
record InputPanelDopCardPass  ("SB_CARD3","sc_user.lbr") dialog;
record InputPanelDopCardPassS ("SB_CARD3","sc_user.lbr") dialog;
const ne_TypePass     = 0,
      ne_TypePassName = 1,
      ne_OfKindPas    = 2,
      ne_RomLettSer   = 3,
      ne_RusLettSer   = 4,
      ne_NumPass      = 5,
      ne_IPassSer     = 6,
      ne_IPassNo      = 7;

/* Панель для дополнительной информации по карточке (работа) */
record InputPanelDopCardWork  ("SB_CARD4","sc_user.lbr") dialog;
record InputPanelDopCardWorkS ("SB_CARD4","sc_user.lbr") dialog;
const ne_NameCompany   = 0,
      ne_PostCompany   = 1,
      ne_DepartCompany = 2,
      ne_NumbInCompany = 3;

/* Панель для дополнительной информации по карточке (другие карточки) */
record InputPanelDopCardCard  ("SB_CARD5","sc_user.lbr") dialog;
record InputPanelDopCardCardS ("SB_CARD5","sc_user.lbr") dialog;
const ne_NumberCard1 = 0,
      ne_NumberCard2 = 1,
      ne_NumberCard3 = 2,
      ne_NumberCard4 = 3;

/* Массивы для дополнительной информации по карточке */
array ATypeAddr,    ANameAddr;     /* Виды адресов          */
array ATypeClass,   ANameClass;    /* Классы клиентов       */
array ATypeManWom,  ANameManWom;   /* Пол клиента           */
array ATypeMarriage,ANameMarriage; /* Семейное положение    */
array ATypePrivate, ANamePrivate;  /* Частная собственность */
array ATypeMail,    ANameMail;     /* Почтовая доставка     */
array ATypeWork,    ANameWork;     /* Занятость             */
array ATypeNation,  ANameNation;   /* Национальность        */
array ATypeAppl,    ANameAppl;     /* Тип заявления         */


/**************************************************************************\
|                  Поиск записи карточки до ее изменения                   |
\**************************************************************************/
macro FindCardBeforeChange

  KeyNum(cardold,0);
  cardold.FNCash  = FNCash;
  cardold.cardRef = cardnew.cardRef;

  return GetEQ(cardold);

end;
/**************************************************************************\
|                Поиск записи карточки после ее изменения                  |
\**************************************************************************/
macro FindCardAfterChange

  KeyNum(acardnew,0);
  acardnew.FNCash  = FNCash;
  acardnew.cardRef = acardold.cardRef;

  return GetEQ(acardnew);

end;


/**************************************************************************\
|                        Поиск клиента по его коду                         |
\**************************************************************************/
macro FindClient ( CodClient )

  return depclnt.GetRecord( CodClient, SC_ERROR_PTADDR_LEGAL );

end;


/**************************************************************************\
|                            Поиск операциониста                           |
\**************************************************************************/
macro FindOper

  KeyNum( person, 0 );
  person.Oper = {oper};

  return GetEQ( person );

end;


/**************************************************************************\
|                               Поиск валюты                               |
\**************************************************************************/
macro FindCurr (Code)

  KeyNum(currency,0);
  currency.Code_Currency = Code;

  return GetEQ(currency);

end;


/**************************************************************************\
|                       Поиск записи в кодификаторе                        |
\**************************************************************************/
macro FindCodif (CodType, CodCode)

  var stat;

  KeyNum(codif,1);
  codif.codType = CodType;
  codif.codCode = CodCode;
  codif.psRef   = 0;
  stat = GetEQ(codif);
  if (NOT stat)
    codif.codType = CodType;
    codif.codCode = CodCode;
    codif.psRef   = sc_pos.psRef;
    stat = GetEQ(codif);
  end;

  return stat;

end;


/**************************************************************************\
|           Сравнение состояния с Кодификатором с учетом аналога           |
\**************************************************************************/
macro StateCompare
(
 ObjectState,  /* Состояние объекта                     */
 CompareState, /* Состояние для сравнения               */
 codType,      /* Тип кода - карточка (6), счет (2) ... */
 psRef         /* Референс ПС                           */
)

  var stat = FALSE;

  /* Сначала ищем запись с референсом ПС - 0 */
  KeyNum(codif,1);
  codif.codType = codType;
  codif.codCode = ObjectState;
  codif.psRef   = 0;
  if (GetEQ(codif))
    if ((CompareState == codif.codCode       ) OR
        (CompareState == codif.SimilarCodCode)   )
      stat = TRUE;
    end;
  end;
  /* Потом ищем запись с референсом ПС - psRef, если ObjectState не прошел */
  /* успешной проверки                                                     */
  if (NOT stat)
    KeyNum(codif,1);
    codif.codType = codType;
    codif.codCode = ObjectState;
    codif.psRef   = psRef;
    if (GetEQ(codif))
      if ((CompareState == codif.codCode       ) OR
          (CompareState == codif.SimilarCodCode)   )
        stat = TRUE;
      end;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                          Поиск счета по карточке                         |
\**************************************************************************/
macro FindAcc

  file sc_link (scLink,"spcard.def");
  var  stat;

  KeyNum(sc_link,5);
  sc_link.FNCash  = FNCash;
  sc_link.cardRef = cardnew.cardRef;
  sc_link.mainAcc = "X";
  stat = GetEQ(sc_link);
  if (NOT stat)
    sc_link.FNCash  = FNCash;
    sc_link.cardRef = cardnew.cardRef;
    sc_link.mainAcc = "";
    stat = GetEQ(sc_link);
  end;

  if (stat)
    KeyNum(sc_acc,0);
    sc_acc.Referenc = sc_link.cardAccRef;
    stat = GetEQ(sc_acc);
  end;

  return stat;

end;


/**************************************************************************\
|                          Поиск счета вкладчика                           |
\**************************************************************************/
macro FindDepos (Referenc)

  KeyNum(depositr,8);
  depositr.Referenc = Referenc;

  return GetEQ(depositr);

end;


/**************************************************************************\
|                   Проверка изменений клиентских полей                    |
\**************************************************************************/
macro WasChangedClientFields

  var wasChange = false;

  if ( ( ALG_VARPARTSIZE       == GetRecordSize( carddop ) - GetRecordSize( cardnew ) ) and
       ( GetVarSize( cardold ) == GetRecordSize( carddop ) - GetRecordSize( cardnew ) )    )

    SetRecordAddr( carddopo, cardold, 0, 0, true );

    if ( ( carddop.NumberPrimaryAddr != carddopo.NumberPrimaryAddr ) or
         ( carddop.TypeAddr1         != carddopo.TypeAddr1         ) or
         ( carddop.IndexAddr1        != carddopo.IndexAddr1        ) or
         ( carddop.Addr1S1           != carddopo.Addr1S1           ) or
         ( carddop.Addr1S2           != carddopo.Addr1S2           ) or
         ( carddop.Addr1S3           != carddopo.Addr1S3           ) or
         ( carddop.Addr1S4           != carddopo.Addr1S4           ) or
         ( carddop.TypeAddr2         != carddopo.TypeAddr2         ) or
         ( carddop.IndexAddr2        != carddopo.IndexAddr2        ) or
         ( carddop.Addr2S1           != carddopo.Addr2S1           ) or
         ( carddop.Addr2S2           != carddopo.Addr2S2           ) or
         ( carddop.Addr2S3           != carddopo.Addr2S3           ) or
         ( carddop.Addr2S4           != carddopo.Addr2S4           ) or
         ( carddop.TypeAddr3         != carddopo.TypeAddr3         ) or
         ( carddop.IndexAddr3        != carddopo.IndexAddr3        ) or
         ( carddop.Addr3S1           != carddopo.Addr3S1           ) or
         ( carddop.Addr3S2           != carddopo.Addr3S2           ) or
         ( carddop.Addr3S3           != carddopo.Addr3S3           ) or
         ( carddop.CodeClassClient   != carddopo.CodeClassClient   )   )
      OperForPc = "CL";
      wasChange = true;
    elif ( ( carddop.clientPassword    != carddopo.clientPassword ) or
           ( carddop.TypePass          != carddopo.TypePass       ) or
           ( carddop.OfKindPass        != carddopo.OfKindPass     ) or
           ( carddop.RomLettSer        != carddopo.RomLettSer     ) or
           ( carddop.RusLettSer        != carddopo.RusLettSer     ) or
           ( carddop.NumPass           != carddopo.NumPass        ) or
           ( carddop.IPassSer          != carddopo.IPassSer       ) or
           ( carddop.IPassNo           != carddopo.IPassNo        ) or
           ( carddop.WorkPhone         != carddopo.WorkPhone      ) or
           ( carddop.HomePhone         != carddopo.HomePhone      ) or
           ( carddop.ManWom            != carddopo.ManWom         ) or
           ( carddop.Proprietor        != carddopo.Proprietor     ) or
           ( carddop.PostCode          != carddopo.PostCode       ) or
           ( carddop.Marriage          != carddopo.Marriage       ) or
           ( carddop.CodeWork          != carddopo.CodeWork       ) or
           ( carddop.Nation            != carddopo.Nation         ) or
           ( carddop.TitulClnt         != carddopo.TitulClnt      ) or
           ( carddop.NameCompany       != carddopo.NameCompany    ) or
           ( carddop.PostCompany       != carddopo.PostCompany    ) or
           ( carddop.DepartCompany     != carddopo.DepartCompany  ) or
           ( carddop.NumbInCompany     != carddopo.NumbInCompany  )   )
      OperForPc = "CS";
      wasChange = true;
    end;

  end;

  return wasChange;

end;


/**************************************************************************\
|             Проверка заполненности обязательных полей для ПЦ             |
\**************************************************************************/
const PANEL_MAIN    = 0;
const PANEL_MAINADD = 1;
const PANEL_ADDPASS = 2;
const PANEL_ADDADR  = 3;
const PANEL_ADDWORK = 4;

macro CheckFillNecessaryFields (KindPanel, FlagNew)

  var WasMessage = FALSE;
  var str_tmp;
  var d,m;

  /* Должен быть задан тип счета */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.TypeAccount;
    else
      str_tmp = InputPanelDopCard.TypeAccount;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задан код типа заявления (тип счета)");
        WasMessage = TRUE;
      end;
    end;
  end;
  
  /* Должен быть задан паспорт */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD) OR (KindPanel == PANEL_ADDPASS)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.TypePass;
    else
      str_tmp = InputPanelDopCardPass.TypePass;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задан тип паспорта");
        WasMessage = TRUE;
      end;
    end;
  end;

  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD) OR (KindPanel == PANEL_ADDPASS)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.NumPass;
    else
      str_tmp = InputPanelDopCardPass.NumPass;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задан номер паспорта");
        WasMessage = TRUE;
      end;
    end;
  end;
  
  /* Должен быть задан титул обращения */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.TitulClnt;
    else
      str_tmp = InputPanelDopCard.TitulClnt;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задан титул обращения");
        WasMessage = TRUE;
      end;
    end;
  end;
  
  /* Должен быть задан титул эмбосирования */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.TitulEmboss;
    else
      str_tmp = InputPanelDopCard.TitulEmboss;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задан титул к эмбосированию");
        WasMessage = TRUE;
      end;
    end;
  end;

  /* Должен быть задан пол клиента */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.ManWom;
    else
      str_tmp = InputPanelDopCard.ManWom;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задан пол клиента");
        WasMessage = TRUE;
      end;
    end;
  end;

  /* Должна быть задана должность */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD) OR (KindPanel == PANEL_ADDWORK)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.PostCompany;
    else
      str_tmp = InputPanelDopCardWork.PostCompany;
    end;
        
    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задана должность клиента");
        WasMessage = TRUE;
      end;
    end;
  end;

  /* Должен быть задан адрес */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD) OR (KindPanel == PANEL_ADDADR)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.Addr1S1 + carddop.Addr1S2 + carddop.Addr1S3 + carddop.Addr1S4 +
                carddop.Addr2S1 + carddop.Addr2S2 + carddop.Addr2S3 + carddop.Addr2S4 +
                carddop.Addr3S1 + carddop.Addr3S2 + carddop.Addr3S3;
    else
      str_tmp = InputPanelDopCardAdr.Addr1S1 + InputPanelDopCardAdr.Addr1S2 +
                                               InputPanelDopCardAdr.Addr1S3 +
                InputPanelDopCardAdr.Addr2S1 + InputPanelDopCardAdr.Addr2S2 +
                                               InputPanelDopCardAdr.Addr2S3 +
                InputPanelDopCardAdr.Addr3S1 + InputPanelDopCardAdr.Addr3S2 +
                                               InputPanelDopCardAdr.Addr3S3;
    end;

    if (StrLen(Trim(str_tmp)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Должен быть задан хоть один адрес");
        WasMessage = TRUE;
      end;
    end;
  end;

  /* Должен быть задан индекс */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD) OR (KindPanel == PANEL_ADDADR)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      if (((StrLen(Trim(carddop.Addr1S1 +
                        carddop.Addr1S2 +
                        carddop.Addr1S3 +
                        carddop.Addr1S4   ) ) != 0) AND
           (StrLen(Trim(carddop.IndexAddr1) ) == 0)     ) OR
          ((StrLen(Trim(carddop.Addr2S1 +
                        carddop.Addr2S2 +
                        carddop.Addr2S3 +
                        carddop.Addr2S4   ) ) != 0) AND
           (StrLen(Trim(carddop.IndexAddr2) ) == 0)     ) OR
          ((StrLen(Trim(carddop.Addr3S1 +
                        carddop.Addr3S2 +
                        carddop.Addr3S3   ) ) != 0) AND
           (StrLen(Trim(carddop.IndexAddr3) ) == 0)     )   )
        if (AllErrMessages OR (NOT WasMessage))
          MsgBox("При заданном адресе не задан индекс");
          WasMessage = TRUE;
        end;
      end;
    else
      if (((StrLen(Trim(InputPanelDopCardAdr.Addr1S1 +
                        InputPanelDopCardAdr.Addr1S2 +
                        InputPanelDopCardAdr.Addr1S3   ) ) != 0) AND
           (StrLen(Trim(InputPanelDopCardAdr.Index1    ) ) == 0)     ) OR
          ((StrLen(Trim(InputPanelDopCardAdr.Addr2S1 +
                        InputPanelDopCardAdr.Addr2S2 +
                        InputPanelDopCardAdr.Addr2S3   ) ) != 0) AND
           (StrLen(Trim(InputPanelDopCardAdr.Index2    ) ) == 0)     ) OR
          ((StrLen(Trim(InputPanelDopCardAdr.Addr3S1 +
                        InputPanelDopCardAdr.Addr3S2 +
                        InputPanelDopCardAdr.Addr3S3   ) ) != 0) AND
           (StrLen(Trim(InputPanelDopCardAdr.Index3    ) ) == 0)     )   )
        if (AllErrMessages OR (NOT WasMessage))
          MsgBox("При заданном адресе не задан индекс");
          WasMessage = TRUE;
        end;
      end;
    end;
  end;
  
  /* Должен быть задан тип адреса */
  if (((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD) OR (KindPanel == PANEL_ADDADR)) AND (NOT FlagNew))
    if (KindPanel == PANEL_MAIN)
      if (((StrLen(Trim(carddop.IndexAddr1 +
                        carddop.Addr1S1    +
                        carddop.Addr1S2    +
                        carddop.Addr1S3    +
                        carddop.Addr1S4      ) ) != 0) AND
           (StrLen(Trim(carddop.TypeAddr1    ) ) == 0)     ) OR
          ((StrLen(Trim(carddop.IndexAddr2 +
                        carddop.Addr2S1    +
                        carddop.Addr2S2    +
                        carddop.Addr2S3    +
                        carddop.Addr2S4      ) ) != 0) AND
           (StrLen(Trim(carddop.TypeAddr2    ) ) == 0)     ) OR
          ((StrLen(Trim(carddop.IndexAddr3 +
                        carddop.Addr3S1    +
                        carddop.Addr3S2    +
                        carddop.Addr3S3      ) ) != 0) AND
           (StrLen(Trim(carddop.TypeAddr3    ) ) == 0)     )   )
        if (AllErrMessages OR (NOT WasMessage))
          MsgBox("При заданном адресе или индексе не задан тип адреса");
          WasMessage = TRUE;
        end;
      end;
    else
      if (((StrLen(Trim(InputPanelDopCardAdr.Index1  +
                        InputPanelDopCardAdr.Addr1S1 +
                        InputPanelDopCardAdr.Addr1S2 +
                        InputPanelDopCardAdr.Addr1S3  ) ) != 0) AND
           (StrLen(Trim(InputPanelDopCardAdr.TypeAddr1) ) == 0)     ) OR
          ((StrLen(Trim(InputPanelDopCardAdr.Index2  +
                        InputPanelDopCardAdr.Addr2S1 +
                        InputPanelDopCardAdr.Addr2S2 +
                        InputPanelDopCardAdr.Addr2S3  ) ) != 0) AND
           (StrLen(Trim(InputPanelDopCardAdr.TypeAddr2) ) == 0)     ) OR
          ((StrLen(Trim(InputPanelDopCardAdr.Index3  +
                        InputPanelDopCardAdr.Addr3S1 +
                        InputPanelDopCardAdr.Addr3S2 +
                        InputPanelDopCardAdr.Addr3S3  ) ) != 0) AND
           (StrLen(Trim(InputPanelDopCardAdr.TypeAddr3) ) == 0)     )   )
        if (AllErrMessages OR (NOT WasMessage))
          MsgBox("При заданном адресе или индексе не задан тип адреса");
          WasMessage = TRUE;
        end;
      end;
    end;
  end;

  /* Должно быть задано эмбосированное имя */
  if ((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD))
    if ((StrLen(Trim(carddop.embossingName1)) == 0) OR (StrLen(Trim(carddop.embossingName2)) == 0))
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задано эмбосирование");
        WasMessage = TRUE;
      end;
    end;
  end;

  /* Длина эмбосирования */
  if ((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD))
    if (KindPanel == PANEL_MAIN)
      str_tmp = carddop.TitulEmboss;
    else
      str_tmp = InputPanelDopCard.TitulEmboss;
    end;

    if ((StrLen(Trim(carddop.embossingName1)) + 
         StrLen(Trim(carddop.embossingName2)) +
         StrLen(Trim(str_tmp               )) + 3) > 19)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Длина эмбосирования превышает допустимое значение (19)");
        WasMessage = TRUE;
      end;
    end;
  end;
  
  /* Должна быть задана контрольная информация */
  if ((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD))
    if (StrLen(Trim(carddop.clientPassword)) == 0)
      if (AllErrMessages OR (NOT WasMessage))
        MsgBox("Не задана контрольная информация клиента");
        WasMessage = TRUE;
      end;
    end;
  end;

  if ((KindPanel == PANEL_MAIN) OR (KindPanel == PANEL_MAINADD))
    if (FindClient(carddop.CodClient))
      /* Должна быть задана фамилия клиента */
      if ( StrLen( Trim( depclnt.CurRec.rec.Name1 ) ) == 0 )
        if ( AllErrMessages or ( not WasMessage ) )
          MsgBox("Не задана фамилия клиента");
          WasMessage = TRUE;
        end;
      end;
  
      /* Должно быть задано имя клиента */
      if ( StrLen( Trim( depclnt.CurRec.rec.Name2 ) ) == 0 )
        if ( AllErrMessages or ( not WasMessage ) )
          MsgBox("Не задано имя клиента");
          WasMessage = TRUE;
        end;
      end;
  
      /* Должна быть задана дата рождения */
      DateSplit( depclnt.CurRec.rec.Born, d, m, NULL );
      if ( ( d == 0 ) or ( m == 0 ) )
        if ( AllErrMessages or ( not WasMessage ) )
          MsgBox("Не задана дата рождения клиента");
          WasMessage = TRUE;
        end;
      end;
    end;
  end;
  
end;


/**************************************************************************\
|                      Является ли карточка основной                       |
\**************************************************************************/
macro IsMainCard

  file sc_link  (scLink,"spcard.def");
  file sc_link2 (scLink,"spcard.def");
  var stat;
  var stat2;
  var Counter = 0;
  var IsMain  = FALSE;

  KeyNum(sc_link,2);
  sc_link.FNCash     = FNCash;
  sc_link.cardRef    = cardnew.cardRef;
  sc_link.cardAccRef = "";
  stat = GetGE(sc_link);
  while (stat)
    if ((sc_link.FNCash  == FNCash         ) AND
        (sc_link.cardRef == cardnew.cardRef)    )
      if (sc_link.MainCard)
        IsMain = TRUE;
        stat = FALSE; /* Чтоб быстрей выйти из цикла while ... */
      else
        Counter = 0;
        KeyNum(sc_link2,3);
        sc_link2.cardAccRef = sc_link.cardAccRef;
        stat2 = GetGE(sc_link2);
        while (stat2)
          if (sc_link2.cardAccRef == sc_link.cardAccRef)
            Counter = Counter + 1;
            stat2 = Next(sc_link2);
          else
            stat2 = FALSE;
          end;
        end;
        if (Counter == 1)
          IsMain = TRUE;
          stat = FALSE; /* Чтоб быстрей выйти из цикла while ... */
        end;
      end;
      if (stat)
        stat = Next(sc_link);
      end;
    else
      stat = FALSE;
    end;
  end;

  return IsMain;

end;


/**************************************************************************\
|                          Открытие выходного файла                        |
\**************************************************************************/
macro Open_OutputFile (NumFile)

  var stat = TRUE;
  var PathName;
  var Len;
  var day;
  var y;

  KeyNum(sc_pos,1);
  sc_pos.psCode = SBCode;
  stat = GetEQ(sc_pos);
  if (stat)
    SetRecordAddr(sbpos,sc_pos,0,0,FALSE);
    /* Каталог для выходного файла */
    PathName = sc_pos.scOutputFile;
    Len = StrLen(PathName);
    if (Len > 0)
      if (SubStr(PathName,Len,1) != "\\")
        PathName = PathName + "\\";
      end;
    end;
    /* Расширение для выходного файла */
    DateSplit({curdate},null,null,y);
    day = Trim(String({curdate} - Date(1,1,y) + 1));
    Len = StrLen(day);
    while (Len < 3)
      day = "0" + day;
      Len = Len + 1;
    end;
    /* Имя файла */
    if (NumFile == 1)
      Len = StrLen(FileCZ);
    elif (NumFile == 2)
      Len = StrLen(FileZC);
    else
      Len = StrLen(FileCS);
    end;
    if (Len > 0)
      if (NumFile == 1)
        if (SubStr(FileCZ,Len,1) != ".")
          FileCZ = FileCZ + ".";
        end;
      end;
      if (NumFile == 2)
        if (SubStr(FileZC,Len,1) != ".")
          FileZC = FileZC + ".";
        end;
      end;
      if (NumFile == 3)
        if (SubStr(FileCS,Len,1) != ".")
          FileCS = FileCS + ".";
        end;
      end;
      if (NumFile == 4)
        if (SubStr(FileZP,Len,1) != ".")
          FileZP = FileZP + ".";
        end;
      end;
      if (NumFile == 5)
        if (SubStr(FileANB,Len,1) != ".")
          FileANB = FileANB + ".";
        end;
      end;
      if (NumFile == 1)
        FileCZ = PathName + FileCZ + day;
      end;
      if (NumFile == 2)
        FileZC = PathName + FileZC + day;
      end;
      if (NumFile == 3)
        FileCS = PathName + FileCS + day;
      end;
      if (NumFile == 4)
        FileZP = PathName + FileZP + day;
      end;
      if (NumFile == 5)
        FileANB = PathName + FileANB + day;
      end;
    else
      stat = FALSE;
      MsgBox("Не сформировано имя файла");
    end;
    if (stat)
      if (NumFile == 1)
        stat = Open(cz,FileCZ);
      end;
      if (NumFile == 2)
        stat = Open(zc,FileZC);
      end;
      if (NumFile == 3)
        stat = Open(cs,FileCS);
      end;
    end;
  else
    MsgBox("Не найден процессинговый центр с кодом " + SBCode);
  end;

  return stat;

end;


/**************************************************************************\
|          Послать в ПЦ информацию о первой выдаче карточки                |
\**************************************************************************/
macro WriteNotSendToPc

  if ( OperForPc == "CS" )
    sc_to_pc.Clear;
    sc_to_pc.rec.Branch     = FNCash;
    sc_to_pc.rec.FormatFile = FormForPc;
    sc_to_pc.rec.CodeOper   = "CL"; /* Так как покрывает CS и CL */
    sc_to_pc.rec.RecRef     = cardnew.cardRef;
    if ( sc_to_pc.GetEQ )
      sc_to_pc.rec.MailRef = 0;
      if ( not sc_to_pc.Update )
        AbortTrn( );
      end;
      return;
    end;
  end;

  if ( OperForPc == "CL" )
    sc_to_pc.Clear;
    sc_to_pc.rec.Branch     = FNCash;
    sc_to_pc.rec.FormatFile = FormForPc;
    sc_to_pc.rec.CodeOper   = "CS";
    sc_to_pc.rec.RecRef     = cardnew.cardRef;
    if ( sc_to_pc.GetEQ )
      if ( not sc_to_pc.Delete ) /* Позже вставим передачу всей информации */
        AbortTrn( );
      end;
    end;
  end;

  sc_to_pc.Clear;
  sc_to_pc.rec.Branch     = FNCash;
  sc_to_pc.rec.FormatFile = FormForPc;
  sc_to_pc.rec.CodeOper   = OperForPc;
  sc_to_pc.rec.RecRef     = cardnew.cardRef;
  if ( sc_to_pc.GetEQ )
    sc_to_pc.rec.MailRef = 0;
    if ( not sc_to_pc.Update )
      AbortTrn( );
    end;
    return;
  end;

  sc_to_pc.Clear;
  sc_to_pc.rec.Branch     = FNCash;
  sc_to_pc.rec.FormatFile = FormForPc;
  sc_to_pc.rec.RecRef     = cardnew.cardRef;
  sc_to_pc.rec.CodeOper   = OperForPc;
  sc_to_pc.rec.MailRef    = 0;
  if ( not sc_to_pc.Insert )
    AbortTrn( );
  end;

end;


/**************************************************************************\
|                      Обработчик для панели заявки                        |
\**************************************************************************/
macro WorkDialog (IP, cmd, id, key)

  var stat = CM_DEFAULT;
  var i;

  if (cmd == DLG_KEY)
    /* ENTER ---------------------------------------------------------- */
    if (key == 13)
      if (id == ne_DateOPERU)
        SetFocus(IP,ne_CountCard);
        stat = CM_IGNORE;
      end;
    /* ESC - Выход с запросом ----------------------------------------- */
    elif (key == 27)
      stat = CM_CANCEL;
    /* F7 - Выпустить ------------------------------------------------- */
    elif (key == 321)
      stat = CM_SAVE;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                Заявление на получение банковской карточки                |
\**************************************************************************/
macro CopZayav

  var str;
  var Account   = "";
  var AccountI  = "";
  var AccountA  = "";
  var ShCur     = "";
  var ShCurI    = "";
  var IndexHome = "";
  var AddrHome  = "";
  var IndexWork = "";
  var AddrWork  = "";


  if (Open_OutputFile(1))
    if (FindOper())
      InputPanel.FIOOper = person.Name;
    end;
    if (NOT RunDialog(InputPanel,"WorkDialog"))
      MsgBox("Отказались от выпуска заявки");
    else
      if (FindAcc())
        if (FindDepos(sc_acc.Referenc))
          Account  = depositr.Account;
          if (FindCurr(depositr.Code_Currency))
            ShCur = currency.Short_Name;
          end;
        end;
        if (sc_acc.Referenc_Add != 0)
          if (FindDepos(sc_acc.Referenc_Add))
            AccountA = depositr.Account;
          end;
        end;
        if (sc_acc.Referenc_Insur != 0)
          if (FindDepos(sc_acc.Referenc_Insur))
            AccountI = depositr.Account;
            if (FindCurr(depositr.Code_Currency))
              ShCurI = currency.Short_Name;
            end;
          end;
        end;
      end;
      if (carddop.TypeAddr1 == "H")
        IndexHome = carddop.IndexAddr1;
        AddrHome  = Trim(carddop.Addr1S1 + " " + carddop.Addr1S2 + " " + carddop.Addr1S3 + " " + carddop.Addr1S4);
      elif (carddop.TypeAddr1 == "B")
        IndexWork = carddop.IndexAddr1;
        AddrWork  = Trim(carddop.Addr1S1 + " " + carddop.Addr1S2 + " " + carddop.Addr1S3 + " " + carddop.Addr1S4);
      end;
      if (carddop.TypeAddr2 == "H")
        IndexHome = carddop.IndexAddr2;
        AddrHome  = Trim(carddop.Addr2S1 + " " + carddop.Addr2S2 + " " + carddop.Addr2S3 + " " + carddop.Addr2S4);
      elif (carddop.TypeAddr2 == "B")
        IndexWork = carddop.IndexAddr2;
        AddrWork  = Trim(carddop.Addr2S1 + " " + carddop.Addr2S2 + " " + carddop.Addr2S3 + " " + carddop.Addr2S4);
      end;
      if (carddop.TypeAddr3 == "H")
        IndexHome = carddop.IndexAddr3;
        AddrHome  = Trim(carddop.Addr3S1 + " " + carddop.Addr3S2 + " " + carddop.Addr3S3 + " " + carddop.Addr3S4);
      elif (carddop.TypeAddr3 == "B")
        IndexWork = carddop.IndexAddr3;
        AddrWork  = Trim(carddop.Addr3S1 + " " + carddop.Addr3S2 + " " + carddop.Addr3S3 + " " + carddop.Addr3S4);
      end;

      str = "  Код территориального банка: " + Trim(sbpos.SenderCode) +
            "   Код учреждения Сбербанка: " + Trim(sbpos.DepartmentCode);
      Insert(cz,str);
      str = "  Наименование учреждения Сбербанка: " + Trim(sbpos.Department);
      Insert(cz,str);
      str = "  Карточный счет N: " + Account;
      Insert(cz,str);
      str = "  Страховой депозит N: " + AccountI;
      Insert(cz,str);
      str = "  Номер выдаваемой карточки:     ------";
      Insert(cz,str);
      str = "  Срок действия до (месяц, год): ------";
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  ────────────────────────────────────────────────────────────────";
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  ЗАЯВЛЕНИЕ НА ПОЛУЧЕНИЕ БАНКОВСКОЙ КАРТОЧКИ VISA СБЕРБАНКА РОССИИ";
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  Я,  Фамилия: ";
      if ( FindClient( cardnew.CodClient ) )
        str = str + depclnt.CurRec.rec.Name1;
      end;
      Insert(cz,str);
      str = "      Имя: ";
      if ( FindClient( cardnew.CodClient ) )
        str = str + depclnt.CurRec.rec.Name2;
      end;
      Insert(cz,str);
      str = "      Отчество: ";
      if ( FindClient( cardnew.CodClient ) )
        str = str + depclnt.CurRec.rec.Name3;
      end;
      Insert(cz,str);
      str = "  Прошу выдать мне банковскую карточку ";
      if (FindCodif(7,cardnew.cardTypeCode))
        str = str + codif.codName;
      else
        str = str + cardnew.cardTypeCode;
      end;
      str = str + " Сбербанка России";
      Insert(cz,str);
      str = "  рег. No организации: " + sbpos.RegNumber;
      Insert(cz,str);
      str = "  Выдача карточки: " + InputPanel.CountCard;
      Insert(cz,str);
      str = "  Причина замены карточки: " + InputPanel.WhyChange;
      Insert(cz,str);
      str = "  О себе сообщаю следующие данные:";
      Insert(cz,str);
      str = "  Дата рождения: ";
      if ( FindClient( cardnew.CodClient ) )
        str = str + String( depclnt.CurRec.rec.Born:f );
      end;
      Insert(cz,str);
      str = "  Прописан по адресу: ";
      Insert(cz,str);
      str = "  Индекс: " + IndexHome;
      Insert(cz,str);
      str = "  Адрес: " + AddrHome;
      Insert(cz,str);
      str = "  Телефон дом.: " + Trim(carddop.HomePhone);
      Insert(cz,str);
      str = "  Общегражданский паспорт: ";
      Insert(cz,str);
      str = "  Серия: ";
      if (StrLen(carddop.RomLettSer) > 0)
        str = str + carddop.RomLettSer;
      end;
      if (StrLen(carddop.RusLettSer) > 0)
        if (StrLen(carddop.RomLettSer) > 0)
          str = str + "-";
        end;
        str = str + carddop.RusLettSer;
      end;
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str +  "        Номер: ";
      if (StrLen(carddop.NumPass) > 0)
        str = str + carddop.NumPass;
      end;
      Insert(cz,str);
      str = "  Когда: ";
      while (StrLen(str) < 19)
        str = str + " ";
      end;
      str = str +  "    кем: ";
      Insert(cz,str);
      str = "  Заграничный паспорт: ";
      Insert(cz,str);
      str = "  Серия: " + Trim(carddop.IPassSer);
      while (StrLen(str) < 15)
        str = str + " ";
      end;
      str = str +  "        Номер: " + Trim(carddop.IPassNo);
      Insert(cz,str);
      str = "  Когда: ";
      while (StrLen(str) < 19)
        str = str + " ";
      end;
      str = str + "    кем: ";
      Insert(cz,str);
      str = "  Место работы: " + carddop.NameCompany;
      Insert(cz,str);
      str = "  Должность: " + carddop.PostCompany;
      Insert(cz,str);
      str = "  Рабочий адрес: ";
      Insert(cz,str);
      str = "  Индекс: " + IndexWork;
      Insert(cz,str);
      str = "  Адрес: " + AddrWork;
      Insert(cz,str);
      str = "  Телефон: " + Trim(carddop.WorkPhone);
      Insert(cz,str);
      str = "  Имя и фамилия латинскими буквами: " + Trim(cardnew.embossingName1) + " " + Trim(cardnew.embossingName2);
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  Невыплаченные кредиты в других учреждениях Сбербанка: " + InputPanel.UnPay;
      Insert(cz,str);
      str = "  Международные карточки в других учреждениях СБ РФ: " + InputPanel.OtherCards;
      Insert(cz,str);
      str = "  При недостатке средств на счете карточки";
      Insert(cz,str);
      str = "  прошу перечислять со счета N: " + AccountA;
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  Я предупрежден, что неверные сведения в настоящем заявлении могут служить";
      Insert(cz,str);
      str = "  основанием для отказа в выдаче карточки";
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  Дата заполнения: " + String(InputPanel.DateZ);
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  Заявление принял контролер: " + InputPanel.FIOOper;
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  ────────────────────────────────────────────────────────────────";
      Insert(cz,str);
      str = "  Согласовано: " + Trim(sbpos.SecurityDept1);
      Insert(cz,str);
      str = "               " + Trim(sbpos.SecurityDept2);
      Insert(cz,str);
      str = "               " + Trim(sbpos.SecurityOfficer) + " ________________ " + Trim(sbpos.SecurityPerson);
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "                                             Дата: " + String(InputPanel.DateSecur);
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "  Разрешаю: " + Trim(sbpos.OperChief) + " ____________________ " + Trim(sbpos.OperChiefPerson);
      Insert(cz,str);
      str = " ";
      Insert(cz,str);
      str = "                                             Дата: " + String(InputPanel.DateOPERU);
      Insert(cz,str);
      Close(cz);
      ViewFile(cz);
    end;
  end;

end;


/**************************************************************************\
|              Заявление на изменение контрольной информации               |
\**************************************************************************/
macro ZayavContr

  var str;

  if (Open_OutputFile(2))
    str = " ";
    Insert(zc,str);
    str = " В "+ Trim(sbpos.Department);
    Insert(zc,str);
    str = " От ___________________________________________";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = "     Прошу изменить контрольную информацию.";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " Ф.И.О. держателя карты: ";
    if (FindClient(cardnew.CodClient))
      str = str + Trim( depclnt.CurRec.rec.Name1 ) + " " + Trim( depclnt.CurRec.rec.Name2 ) + " " + Trim( depclnt.CurRec.rec.Name3 );
      str = str + "\n ";
      if ( depclnt.CurRec.rec.PaperKind == 0)
        str = str + "Паспорт: ";
      elif ( depclnt.CurRec.rec.PaperKind == 1)
        str = str + "Удостоверение личности: ";
      elif ( depclnt.CurRec.rec.PaperKind == 2)
        str = str + "Военный билет: ";
      elif ( depclnt.CurRec.rec.PaperKind == 3)
        str = str + "Паспорт моряка: ";
      elif ( depclnt.CurRec.rec.PaperKind == 4)
        str = str + "Свидетельство о рождении: ";
      end;
      str = str + "\n " + depclnt.CurRec.rec.PaperSeries + " " + depclnt.CurRec.rec.PaperNumber;
    end;
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " Новая контрольная информация: ";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " " + cardnew.clientPassword;
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " Заявитель: ";
    if (FindClient(cardnew.CodClient))
      str = str + Trim(depclnt.CurRec.rec.Name1) + " " + Trim( depclnt.CurRec.rec.Name2 ) + " " + Trim( depclnt.CurRec.rec.Name3 );
    end;
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " Дата: " + String({curdate});
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " ______________Для отметок банка______________";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " Заявление принял(а): _______________ ";
    if (FindOper())
      str = str + Trim(person.Name) + " ";
    end;
    str = str + String({curdate});
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    str = " ";
    Insert(zc,str);
    Close(zc);
    ViewFile(ZC);
  end;

end;


/**************************************************************************\
|               Заявка на внесение изменений в личные данные               |
\**************************************************************************/
macro ZayavPerson

  var fio = "";

  if (FindClient(cardnew.CodClient))
    fio = Trim( depclnt.CurRec.rec.Name1 ) + " " + Trim( depclnt.CurRec.rec.Name2 ) + " " + Trim( depclnt.CurRec.rec.Name3 );
    if (Open_OutputFile(4))
      SetOutput(FileZP);
      [ ];
      SetColumn(1);
      [ Наименование учреждения Сбербанка:];
      SetColumn(2);
      [ ####################################](sbpos.Department:w);
      FlushColumn();
      [ ];
      SetColumn(1);
      [ Код учреждения Сбербанка         :];
      SetColumn(2);
      [ ####################################](sbpos.DepartmentCode:w);
      FlushColumn();
      [ ];
      [ ];
      [ Прошу внести изменения в личные данные держателя пластиковой];
      [ карточки N: ###################](cardnew.cardNumber);
      fio = "Ф.И.О.: " + fio;
      [ #](fio);
      [ ];
      [ Старые данные:];
      [ ];
      [ ];
      [ ];
      [ ];
      [ Новые данные:];
      [ ];
      [ ];
      [ ];
      [ ];
      [ Руководитель учреждения: ____________________ ########################](sbpos.OperChiefPerson);
      [ ];
      [ Дата: ##########]({curdate});
      SetOutput(NULL,TRUE);
      open(zp,FileZP);
      ViewFile(zp);
    end;
  else
    MsgBox(" Не найден держатель карточки в справочнике клиентов ");
  end;

end;


/**************************************************************************\
|                   Обработчик для панели разблокировки                    |
\**************************************************************************/
macro WorkDialogBlock (IP, cmd, id, key)

  var stat = CM_DEFAULT;
  var i;

  if (cmd == DLG_KEY)
    /* ENTER ---------------------------------------------------------- */
    if (key == 13)
      if (id == ne_Add_Info)
        SetFocus(IP,ne_Reason);
        stat = CM_IGNORE;
      end;
    /* ESC - Выход с запросом ----------------------------------------- */
    elif (key == 27)
      stat = CM_CANCEL;
    /* F7 - Выпустить ------------------------------------------------- */
    elif (key == 321)
      stat = CM_SAVE;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                    Заявление о разблокировке карточки                    |
\**************************************************************************/
macro ApplNoBlock

  var TypeCard = "Основная";
  var fio      = "";

  if ( FindClient( cardnew.CodClient ) )
    fio = depclnt.CurRec.rec.Name1 + " " + depclnt.CurRec.rec.Name2 + " " + depclnt.CurRec.rec.Name3;
  end;
  if (Open_OutputFile(5))
    SetOutput(FileANB);
    if (NOT RunDialog(InputPanelBlock,"WorkDialogBlock"))
      MsgBox(" Отказались от выпуска заявки ");
    else
      if (NOT IsMainCard())
        TypeCard = "Дополнительная";
      end;
      [ ];
      [ В #](sbpos.Department);
      [ От ___________________________________];
      [ ];
      [ N карты ###################](cardnew.cardNumber);
      [ Карта выпущена на имя #](fio);
      [ ];
      [ ];
      [      ЗАЯВЛЕНИЕ О РАЗБЛОКИРОВКЕ КАРТЫ];
      [ ];
      [ Прошу разблокировать указанную выше карту Сбербанка России в связи с тем, что];
      [ #](InputPanelBlock.Reason:w:70);
      [ ];
      [ ];
      [ Дополнительно сообщаю следующие сведения:];
      [ Тип карты: ###########################](TypeCard);
      if (FindCodif(7,cardnew.cardTypeCode))
        [ #](codif.codName);
      else
        [ ];
      end;
      [ ];
      [ Место выдачи карты: #](sbpos.Department);
      [ Срок действия карты: ##########](cardnew.cardMaturityDate);
      [ Дополнительная информация:];
      [ #](InputPanelBlock.AddInfo:w:70);
      [ ];
      [ ];
      [ Подпись _____________________________ Дата ##########]({curdate});
      SetOutput(NULL,TRUE);
      Open(zp,FileANB);
      ViewFile(zp);
    end;
    SetOutput(NULL,TRUE);
  end;

end;


/**************************************************************************\
|                Заявление на изменение состояния карточки                 |
\**************************************************************************/
macro AfterChangeState

  var str;

  if (Open_OutputFile(3))
    str = "         Операция изменения состояния карточки";
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = "   Изменено состояние карточки N: " + acardnew.cardNumber;
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = "   Владелец карточки: ";
    if (FindClient(acardnew.CodClient))
      str = str + Trim( depclnt.CurRec.rec.Name1 ) + " " + Trim( depclnt.CurRec.rec.Name2 ) + " " + Trim( depclnt.CurRec.rec.Name3 );
    end;
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = "   Старое состояние: ";
    if (FindCodif(6,acardold.cardStateCode))
      str = str + codif.codUserCode + " - " + codif.codName;
    else
      str = str + acardold.cardStateCode;
    end;
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = "   Новое состояние:  ";
    if (FindCodif(6,acardnew.cardStateCode))
      str = str + codif.codUserCode + " - " + codif.codName;
    else
      str = str + acardnew.cardStateCode;
    end;
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = "   Дата: " + String({curdate});
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = " ";
    Insert(cs,str);
    str = "       Операционист: ";
    if (FindOper())
      str = str + person.Name;
    end;
    Insert(cs,str);
    Close(cs);
    ViewFile(cs);
  end;

end;


/**************************************************************************\
|                        Были ли изменения в полях                         |
\**************************************************************************/
macro WasChangedField

  var stat = FALSE;

  if ((InputPanelDopCardS.CodeClassClient   != InputPanelDopCard.CodeClassClient  ) OR
      (InputPanelDopCardS.ManWom            != InputPanelDopCard.ManWom           ) OR
      (InputPanelDopCardS.Marriage          != InputPanelDopCard.Marriage         ) OR
      (InputPanelDopCardS.Proprietor        != InputPanelDopCard.Proprietor       ) OR
      (InputPanelDopCardS.PostCode          != InputPanelDopCard.PostCode         ) OR
      (InputPanelDopCardS.CodeWork          != InputPanelDopCard.CodeWork         ) OR
      (InputPanelDopCardS.Nation            != InputPanelDopCard.Nation           ) OR
      (InputPanelDopCardS.TitulClnt         != InputPanelDopCard.TitulClnt        ) OR
      (InputPanelDopCardS.TitulEmboss       != InputPanelDopCard.TitulEmboss      ) OR
      (InputPanelDopCardS.AgendaDate        != InputPanelDopCard.AgendaDate       ) OR
      (InputPanelDopCardS.TypeAccount       != InputPanelDopCard.TypeAccount      ) OR
      (InputPanelDopCardAdr.PrimaryAddr     != InputPanelDopCardAdr.PrimaryAddr   ) OR
      (carddop.TypeAddr1                    != TAddr1                             ) OR
      (InputPanelDopCardAdrS.Index1         != InputPanelDopCardAdr.Index1        ) OR
      (InputPanelDopCardAdrS.Addr1S1        != InputPanelDopCardAdr.Addr1S1       ) OR
      (InputPanelDopCardAdrS.Addr1S2        != InputPanelDopCardAdr.Addr1S2       ) OR
      (InputPanelDopCardAdrS.Addr1S3        != InputPanelDopCardAdr.Addr1S3       ) OR
      (carddop.TypeAddr2                    != TAddr2                             ) OR
      (InputPanelDopCardAdrS.Index2         != InputPanelDopCardAdr.Index2        ) OR
      (InputPanelDopCardAdrS.Addr2S1        != InputPanelDopCardAdr.Addr2S1       ) OR
      (InputPanelDopCardAdrS.Addr2S2        != InputPanelDopCardAdr.Addr2S2       ) OR
      (InputPanelDopCardAdrS.Addr2S3        != InputPanelDopCardAdr.Addr2S3       ) OR
      (carddop.TypeAddr3                    != TAddr3                             ) OR
      (InputPanelDopCardAdrS.Index3         != InputPanelDopCardAdr.Index3        ) OR
      (InputPanelDopCardAdrS.Addr3S1        != InputPanelDopCardAdr.Addr3S1       ) OR
      (InputPanelDopCardAdrS.Addr3S2        != InputPanelDopCardAdr.Addr3S2       ) OR
      (InputPanelDopCardAdrS.Addr3S3        != InputPanelDopCardAdr.Addr3S3       ) OR
      (InputPanelDopCardAdrS.HomePhone      != InputPanelDopCardAdr.HomePhone     ) OR
      (InputPanelDopCardAdrS.WorkPhone      != InputPanelDopCardAdr.WorkPhone     ) OR
      (InputPanelDopCardPassS.TypePass      != InputPanelDopCardPass.TypePass     ) OR
      (InputPanelDopCardPassS.OfKindPas     != InputPanelDopCardPass.OfKindPas    ) OR
      (InputPanelDopCardPassS.RomLettSer    != InputPanelDopCardPass.RomLettSer   ) OR
      (InputPanelDopCardPassS.RusLettSer    != InputPanelDopCardPass.RusLettSer   ) OR
      (InputPanelDopCardPassS.NumPass       != InputPanelDopCardPass.NumPass      ) OR
      (InputPanelDopCardPassS.IPassSer      != InputPanelDopCardPass.IPassSer     ) OR
      (InputPanelDopCardPassS.IPassNo       != InputPanelDopCardPass.IPassNo      ) OR
      (InputPanelDopCardWorkS.NameCompany   != InputPanelDopCardWork.NameCompany  ) OR
      (InputPanelDopCardWorkS.PostCompany   != InputPanelDopCardWork.PostCompany  ) OR
      (InputPanelDopCardWorkS.DepartCompany != InputPanelDopCardWork.DepartCompany) OR
      (InputPanelDopCardWorkS.NumbInCompany != InputPanelDopCardWork.NumbInCompany) OR
      (InputPanelDopCardCardS.NumberCard1   != InputPanelDopCardCard.NumberCard1  ) OR
      (InputPanelDopCardCardS.NumberCard2   != InputPanelDopCardCard.NumberCard2  ) OR
      (InputPanelDopCardCardS.NumberCard3   != InputPanelDopCardCard.NumberCard3  ) OR
      (InputPanelDopCardCardS.NumberCard4   != InputPanelDopCardCard.NumberCard4  )   )
    stat = TRUE;
  end;

  return stat;

end;


/**************************************************************************\
|                       Обработка поля тип паспорта                        |
\**************************************************************************/
macro WorkWithTypePass (IsWorkKey)

  if (IsWorkKey)
    if (InputPanelDopCardPass.TypePass == "N")
      InputPanelDopCardPass.TypePass = "Y";
    else
      InputPanelDopCardPass.TypePass = "N";
    end;
  end;

  if (InputPanelDopCardPass.TypePass == "Y")
    InputPanelDopCardPass.TypePassName = "Российский паспорт";
  elif (InputPanelDopCardPass.TypePass == "N")
    InputPanelDopCardPass.TypePassName = "Иной документ";
  else
    InputPanelDopCardPass.TypePassName = "";
  end;

end;


/**************************************************************************\
|                           Обработка типа адреса                          |
\**************************************************************************/
macro WorkWithTypeAddr (IsWorkKey, NumField)

  array AMenu;
  var i = 0;
  var x = 25;
  var y = 1;

  if ((NumField >= 1) AND (NumField <= 3))
    if (IsWorkKey)
      i = 0;
      while (i < ASize(ATypeAddr))
        AMenu(i) = " " + ATypeAddr(i) + "  " + ANameAddr(i) + " ";
        i = i + 1;
      end;
      if (NumField == 1)
        y = 7;
      elif (NumField == 2)
        y = 12;
      elif (NumField == 3)
        y = 17;
      end;
      i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Типы адресов",x,y);
      if (i >= 0)
        if (NumField == 1)
          TAddr1 = ATypeAddr(i);
        elif (NumField == 2)
          TAddr2 = ATypeAddr(i);
        elif (NumField == 3)
          TAddr3 = ATypeAddr(i);
        end;
      end;
    end;

    if (NumField == 1)
      InputPanelDopCardAdr.TypeAddr1 = "";
    elif (NumField == 2)
      InputPanelDopCardAdr.TypeAddr2 = "";
    elif (NumField == 3)
      InputPanelDopCardAdr.TypeAddr3 = "";
    end;
    i = 0;
    while (i < ASize(ATypeAddr))
      if (NumField == 1)
        if (TAddr1 == ATypeAddr(i))
          InputPanelDopCardAdr.TypeAddr1 = ANameAddr(i);
        end;
      elif (NumField == 2)
        if (TAddr2 == ATypeAddr(i))
          InputPanelDopCardAdr.TypeAddr2 = ANameAddr(i);
        end;
      elif (NumField == 3)
        if (TAddr3 == ATypeAddr(i))
          InputPanelDopCardAdr.TypeAddr3 = ANameAddr(i);
        end;
      end;
      i = i + 1;
    end;

  end;

end;


/**************************************************************************\
|                         Обработка класса клиента                         |
\**************************************************************************/
macro WorkWithClass (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeClass))
      AMenu(i) = " " + String(ATypeClass(i):2) + "  " + ANameClass(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Выберите класс клиента");
    if (i >= 0)
      InputPanelDopCard.CodeClassClient = ATypeClass(i);
    end;
  end;

  InputPanelDopCard.NameClassClient = "";
  i = 0;
  while (i < ASize(ATypeClass))
    if (InputPanelDopCard.CodeClassClient == ATypeClass(i))
      InputPanelDopCard.NameClassClient = ANameClass(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                        Обработка поля пол клиента                        |
\**************************************************************************/
macro WorkWithManWom (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeManWom))
      AMenu(i) = " " + ATypeManWom(i) + "  " + ANameManWom(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Пол");
    if (i >= 0)
      InputPanelDopCard.ManWom = ATypeManWom(i);
    end;
  end;

  InputPanelDopCard.ManWomName = "";
  i = 0;
  while (i < ASize(ATypeManWom))
    if (InputPanelDopCard.ManWom == ATypeManWom(i))
      InputPanelDopCard.ManWomName = ANameManWom(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                    Обработка поля семейное положение                     |
\**************************************************************************/
macro WorkWithMarriage (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeMarriage))
      AMenu(i) = " " + ATypeMarriage(i) + "  " + ANameMarriage(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Семейное положение");
    if (i >= 0)
      InputPanelDopCard.Marriage = ATypeMarriage(i);
    end;
  end;

  InputPanelDopCard.MarriageName = "";
  i = 0;
  while (i < ASize(ATypeMarriage))
    if (InputPanelDopCard.Marriage == ATypeMarriage(i))
      InputPanelDopCard.MarriageName = ANameMarriage(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                   Обработка поля наличия недвижимости                    |
\**************************************************************************/
macro WorkWithPrivate (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypePrivate))
      AMenu(i) = " " + ATypePrivate(i) + "  " + ANamePrivate(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Наличие недвижимости");
    if (i >= 0)
      InputPanelDopCard.Proprietor = ATypePrivate(i);
    end;
  end;

  InputPanelDopCard.PrivateName = "";
  i = 0;
  while (i < ASize(ATypePrivate))
    if (InputPanelDopCard.Proprietor == ATypePrivate(i))
      InputPanelDopCard.PrivateName = ANamePrivate(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                     Обработка поля почтовой доставки                     |
\**************************************************************************/
macro WorkWithPostCode (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeMail))
      AMenu(i) = " " + ATypeMail(i) + "  " + ANameMail(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Выберите код почтового отделения");
    if (i >= 0)
      InputPanelDopCard.PostCode = ATypeMail(i);
    end;
  end;

  InputPanelDopCard.PostCodeName = "";
  i = 0;
  while (i < ASize(ATypeMail))
    if (InputPanelDopCard.PostCode == ATypeMail(i))
      InputPanelDopCard.PostCodeName = ANameMail(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                      Обработка поля кода занятости                       |
\**************************************************************************/
macro WorkWithCodeWork (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeWork))
      AMenu(i) = " " + ATypeWork(i) + "  " + ANameWork(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Коды занятости");
    if (i >= 0)
      InputPanelDopCard.CodeWork = ATypeWork(i);
    end;
  end;

  InputPanelDopCard.CodeWorkName = "";
  i = 0;
  while (i < ASize(ATypeWork))
    if (InputPanelDopCard.CodeWork == ATypeWork(i))
      InputPanelDopCard.CodeWorkName = ANameWork(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                       Обработка поля национальности                      |
\**************************************************************************/
macro WorkWithNation (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeNation))
      AMenu(i) = " " + ATypeNation(i) + "  " + ANameNation(i) + "   ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Национальность");
    if (i >= 0)
      InputPanelDopCard.Nation = ATypeNation(i);
    end;
  end;

  InputPanelDopCard.NationName = "";
  i = 0;
  while (i < ASize(ATypeNation))
    if (InputPanelDopCard.Nation == ATypeNation(i))
      InputPanelDopCard.NationName = ANameNation(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                      Обработка поля титул обращения                      |
\**************************************************************************/
macro WorkWithTitul

  array AMenu;
  var i = 0;

  AMenu(0) = " ГОСПОДИН    ";
  AMenu(1) = " ГОСПОЖА     ";

  i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Титул",37,15);
  if (i >= 0)
    InputPanelDopCard.TitulClnt = Trim(AMenu(i));
  end;

end;


/**************************************************************************\
|                  Обработка поля титул к эмбоссированию                   |
\**************************************************************************/
macro WorkWithTitulEmbos

  array AMenu;
  var i = 0;

  AMenu(0) = " MR      ";
  AMenu(1) = " MRS     ";

  i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Титул",37,16);
  if (i >= 0)
    InputPanelDopCard.TitulEmboss = Trim(AMenu(i));
  end;

end;


/**************************************************************************\
|                      Обработка поля типа заявления                       |
\**************************************************************************/
macro WorkWithTypeAccount (IsWorkKey)

  array AMenu;
  var i = 0;

  if (IsWorkKey)
    i = 0;
    while (i < ASize(ATypeAppl))
      AMenu(i) = " " + SubStr(ATypeAppl(i) + " ",1,2) + "  " + ANameAppl(i) + " ";
      i = i + 1;
    end;
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Выберите тип заявления");
    if (i >= 0)
      InputPanelDopCard.TypeAccount = ATypeAppl(i);
    end;
  end;

  InputPanelDopCard.TypeAccountName = "";
  i = 0;
  while (i < ASize(ATypeAppl))
    if (InputPanelDopCard.TypeAccount == ATypeAppl(i))
      InputPanelDopCard.TypeAccountName = ANameAppl(i);
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                          Выбор карточки клиента                          |
\**************************************************************************/
macro WorkWithCardClient (NumberField)

  var stat;
  var i = 0;
  array ACards;
  array AMenu;

  card5.CodClient  = carddop.CodClient;
  card5.psRef      = carddop.psRef;
  card5.cardNumber = "";

  stat = GetGE(card5);
  while (stat)
    if ((card5.CodClient == carddop.CodClient) AND
        (card5.psRef     == carddop.psRef    )    )
      if ((card5.cardNumber == carddop.cardNumber               ) OR
          (card5.cardNumber == InputPanelDopCardCard.NumberCard1) OR
          (card5.cardNumber == InputPanelDopCardCard.NumberCard2) OR
          (card5.cardNumber == InputPanelDopCardCard.NumberCard3) OR
          (card5.cardNumber == InputPanelDopCardCard.NumberCard4)   )
        ;
      else
        if ((StateCompare(card5.cardStateCode,"OK___",6,card5.psRef)) OR
            (StateCompare(card5.cardStateCode,"NA___",6,card5.psRef)) OR
            (StateCompare(card5.cardStateCode,"TCL__",6,card5.psRef))   )
          i = ASize(ACards);
          AMenu(i) = " " + card5.cardNumber + " ";
          ACards(i) = card5.cardNumber;
        end;
      end;
      stat = Next(card5);
    else
      stat = FALSE;
    end;
  end;

  if (ASize(AMenu) > 0)
    i = Menu(AMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Карточки клиента");
    if (i >= 0)
      if   (NumberField == ne_NumberCard1) 
        InputPanelDopCardCard.NumberCard1 = ACards(i);
      elif (NumberField == ne_NumberCard2)  
        InputPanelDopCardCard.NumberCard2 = ACards(i);
      elif (NumberField == ne_NumberCard3) 
        InputPanelDopCardCard.NumberCard3 = ACards(i);
      elif (NumberField == ne_NumberCard4)
        InputPanelDopCardCard.NumberCard4 = ACards(i);
      end;
    end;
  end;
      
end;


/**************************************************************************\
|     Обработчик для панели по дополнительным полям (другие карточки)      |
\**************************************************************************/
macro WorkDialogDopCardCard (IP, cmd, id, key)

  var stat = CM_DEFAULT;
  var i;

  /* ================================================================== */
  if (cmd == DLG_KEY)
    /* ENTER -------------------------------------------------------- */
    if (key == 13)
      if (id == ne_NumberCard4)
        SetFocus(IP,ne_NumberCard1);
        stat = CM_IGNORE;
      end;
    /* F3 ----------------------------------------------------------- */
    elif (key == 317)
      if ((id == ne_NumberCard1) OR (id == ne_NumberCard2) OR 
          (id == ne_NumberCard3) OR (id == ne_NumberCard4)   )
        WorkWithCardClient(id);
      end; 
    /* ESC - Выход -------------------------------------------------- */
    elif (key == 27)
      stat = CM_SAVE;
    /* F9 - Сохранить ----------------------------------------------- */
    elif (key == 323)
      stat = CM_SAVE;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|          Обработчик для панели по дополнительным полям (работа)          |
\**************************************************************************/
macro WorkDialogDopCardWork (IP, cmd, id, key)

  var stat = CM_DEFAULT;
  var i;

  /* ================================================================== */
  if (cmd == DLG_KEY)
    /* ENTER -------------------------------------------------------- */
    if (key == 13)
      if (id == ne_NumbInCompany)
        SetFocus(IP,ne_NameCompany);
        stat = CM_IGNORE;
      end;
    /* ESC - Выход -------------------------------------------------- */
    elif (key == 27)
      stat = CM_SAVE;
    /* F9 - Сохранить ----------------------------------------------- */
    elif (key == 323)
      stat = CM_SAVE;
    end;
  /* ================================================================== */
  elif (cmd == DLG_SAVE)
    CheckFillNecessaryFields(PANEL_ADDWORK,FALSE);
  end;

  return stat;

end;


/**************************************************************************\
|          Копирование паспортных данных из справочника клиентов           |
\**************************************************************************/
macro CopyClientPassportInfo

  var i;

  if ( ( StrLen( Trim( depclnt.CurRec.rec.PaperNumber ) ) > 0 ) or
       ( StrLen( Trim( depclnt.CurRec.rec.PaperSeries ) ) > 0 )   )
    // -------------------------------------------------------------------
    if ( Index( Trim( depclnt.CurRec.rec.PaperSeries ), "-" ) > 0 )
      i = Index( Trim( depclnt.CurRec.rec.PaperSeries ), "-" );
      InputPanelDopCardPass.RomLettSer = SubStr( Trim( depclnt.CurRec.rec.PaperSeries ), 1, i - 1 );
      InputPanelDopCardPass.RusLettSer = SubStr( Trim( depclnt.CurRec.rec.PaperSeries ), i + 1 );
    // -------------------------------------------------------------------
    elif ( Index( Trim( depclnt.CurRec.rec.PaperSeries ), " " ) > 0 )
      i = Index( Trim( depclnt.CurRec.rec.PaperSeries ), " " );
      InputPanelDopCardPass.RomLettSer = SubStr( Trim( depclnt.CurRec.rec.PaperSeries ), 1, i - 1 );
      InputPanelDopCardPass.RusLettSer = SubStr( Trim( depclnt.CurRec.rec.PaperSeries ), i + 1 );
    // -------------------------------------------------------------------
    else
      InputPanelDopCardPass.RomLettSer = Trim( depclnt.CurRec.rec.PaperSeries );
      InputPanelDopCardPass.RusLettSer = "";
    end;

    InputPanelDopCardPass.NumPass = Trim( depclnt.CurRec.rec.PaperNumber );

    if ( ( depclnt.CurRec.rec.PaperKind == 1 ) or  // Удостоверение офицера
         ( depclnt.CurRec.rec.PaperKind == 7 )   ) // Паспорт СССР
      InputPanelDopCardPass.TypePass = "Y";
    else
      InputPanelDopCardPass.TypePass = "N";
    end;
  end;

end;


/**************************************************************************\
|         Обработчик для панели по дополнительным полям (паспорт)          |
\**************************************************************************/
macro WorkDialogDopCardPass (IP, cmd, id, key)

  var stat = CM_DEFAULT;

  /* ================================================================== */
  if (cmd == DLG_KEY)
    /* ENTER -------------------------------------------------------- */
    if (key == 13)
      if (id == ne_IPassNo)
        SetFocus(IP,ne_TypePass);
        stat = CM_IGNORE;
      end;
    /* SPACE -------------------------------------------------------- */
    elif (key == 32)
      if (id == ne_TypePass)
        WorkWithTypePass(TRUE);
        UpdateFields(IP);
      elif (id == ne_OfKindPas)
        if (InputPanelDopCardPass.OfKindPas == "")
          InputPanelDopCardPass.OfKindPas = "*";
        else
          InputPanelDopCardPass.OfKindPas = "";
        end;
      end;
    /* F5 ----------------------------------------------------------- */
    elif (key == 319)
      if (cardnew.CodClient > 0)
        if (FindClient(cardnew.CodClient))
          CopyClientPassportInfo( );
          UpdateFields( IP );
        end;
      end;
    /* ESC - Выход -------------------------------------------------- */
    elif (key == 27)
      stat = CM_SAVE;
    /* F9 - Сохранить ----------------------------------------------- */
    elif (key == 323)
      stat = CM_SAVE;
    end;
  /* ================================================================== */
  elif (cmd == DLG_SAVE)
    CheckFillNecessaryFields( PANEL_ADDPASS, false );
  end;

  return stat;

end;


/**************************************************************************\
|            Копирование адреса клиента из справочника клиентов            |
\**************************************************************************/

macro MakeAdressWhenCopy (AdrType,Index_Clnt,ad1,ad2,ad3,HomePhone,WorkPhone)
//
// Вспомогательный макрос формирования полей по типу адреса
//
  var bIsAdr = true;
  var Addr_Clnt;

  ad1        = "";
  ad2        = "";
  ad3        = "";
  Index_Clnt = "";

  depclnt.MayMakeNewTypeAdress = false;
  depclnt.AdressType = AdrType;

  if (depclnt.AdressType == AdrType)
    Addr_Clnt = depclnt.CurRec.rec.Address;
//  Индекс
    if (StrLen(depclnt.CurRec.rec.PostIndex ) > 0 )
      Index_Clnt = depclnt.CurRec.rec.PostIndex;
      if (Index(Addr_Clnt,Index_Clnt) == 1)
        Addr_Clnt = SubStr(Addr_Clnt,StrLen(Index_Clnt) + 1);
        if (StrLen(Addr_Clnt) > 0)
          if (SubStr(Addr_Clnt,1,1) == ",")
            Addr_Clnt = SubStr(Addr_Clnt,2);
          end;
        end;
        Addr_Clnt = Trim(Addr_Clnt);
      end;
    end;
//  Адрес
    if (StrLen(Trim(Addr_Clnt)) > 0)
      ad1 = Trim(Addr_Clnt);
      if (StrLen(Trim(Addr_Clnt)) > 31)
        ad2 = SubStr(Trim(Addr_Clnt),31);
      end;
      if (StrLen(Trim(Addr_Clnt)) > 61)
        ad3 = SubStr(Trim(Addr_Clnt),61);
      end;
    end;
//  Домашний телефон
    if (HomePhone == "")
      HomePhone = depclnt.CurRec.rec.PhoneNumber;
    end;
//  Рабочий телефон
    if (WorkPhone == "")
      WorkPhone = depclnt.CurRec.rec.PhoneNumber2;
    end;
  else
    bIsAdr = false;
    Index_Clnt = "";
    ad1        = "";
    ad2        = "";
    ad3        = ""; 
  end;
  setparm (1,Index_Clnt);
  setparm (2,ad1);
  setparm (3,ad2);
  setparm (4,ad3);
  setparm (5,HomePhone);
  setparm (6,WorkPhone);
  return bIsAdr;
end;
// *********************************************************

macro CopyClientAddressInfo

  var badr1,badr2,badr3;
// Юридический адрес
  badr1 = MakeAdressWhenCopy (SC_ERROR_PTADDR_LEGAL,
                                  InputPanelDopCardAdr.Index1,
                                  InputPanelDopCardAdr.Addr1S1,
                                  InputPanelDopCardAdr.Addr1S2,
                                  InputPanelDopCardAdr.Addr1S3,
                                  InputPanelDopCardAdr.HomePhone,
                                  InputPanelDopCardAdr.WorkPhone );
// Фактический адрес            
  badr2 = MakeAdressWhenCopy (SC_ERROR_PTADDR_REAL,
                                  InputPanelDopCardAdr.Index2,
                                  InputPanelDopCardAdr.Addr2S1,
                                  InputPanelDopCardAdr.Addr2S2,
                                  InputPanelDopCardAdr.Addr2S3,
                                  InputPanelDopCardAdr.HomePhone,
                                  InputPanelDopCardAdr.WorkPhone );
// Почтовый адрес
  badr3 = MakeAdressWhenCopy (SC_ERROR_PTADDR_POST,
                                  InputPanelDopCardAdr.Index3,
                                  InputPanelDopCardAdr.Addr3S1,
                                  InputPanelDopCardAdr.Addr3S2,
                                  InputPanelDopCardAdr.Addr3S3,
                                  InputPanelDopCardAdr.HomePhone,
                                  InputPanelDopCardAdr.WorkPhone );
// Типы адресов
  if (badr1)
    TAddr1 = ATypeAddr(1);
    InputPanelDopCardAdr.TypeAddr1 = ANameAddr(1);
  end;
  if (badr2)
    TAddr2 = ATypeAddr(1);
    InputPanelDopCardAdr.TypeAddr2 = ANameAddr(1);
  end;
  if (badr3)
    TAddr3 = ATypeAddr(2);
    InputPanelDopCardAdr.TypeAddr3 = ANameAddr(2);
  end;
end;


/**************************************************************************\
|          Обработчик для панели по дополнительным полям (адрес)           |
\**************************************************************************/
macro WorkDialogDopCardAdr (IP, cmd, id, key)

  var stat = CM_DEFAULT;

  /* ================================================================= */
  if (cmd == DLG_KEY)
    /* ENTER --------------------------------------------------------  */
    if (key == 13)
      if (id == ne_WorkPhone)
        SetFocus(IP,ne_PrimaryAddr);
        stat = CM_IGNORE;
      end;
    /* ESC - Выход --------------------------------------------------- */
    elif (key == 27)
      stat = CM_SAVE;
    /* F3 ------------------------------------------------------------ */
    elif (key == 317)
      if (id == ne_TypeAddr1)
        WorkWithTypeAddr(TRUE,1);
      elif (id == ne_TypeAddr2)
        WorkWithTypeAddr(TRUE,2);
      elif (id == ne_TypeAddr3)
        WorkWithTypeAddr(TRUE,3);
      end;
      UpdateFields(IP);
    /* F5 ------------------------------------------------------------ */
    elif (key == 319)
      if (cardnew.CodClient > 0)
        if ( FindClient( cardnew.CodClient ) )
          CopyClientAddressInfo( );
          UpdateFields( IP );
        end;
      end;
    /* F9 - Сохранить ------------------------------------------------ */
    elif (key == 323)
      stat = CM_SAVE;
    end;
  /* ================================================================== */
  elif (cmd == DLG_SAVE)
    CheckFillNecessaryFields(PANEL_ADDADR,FALSE);
  end;

  return stat;

end;


/**************************************************************************\
|              Обработчик для панели по дополнительным полям               |
\**************************************************************************/
macro WorkDialogDopCard (IP, cmd, id, key)

  var stat = CM_DEFAULT;

  /* ================================================================== */
  if (cmd == DLG_KEY)
    /* ENTER -------------------------------------------------------- */
    if (key == 13)
      if (id == ne_TypeAccount)
        SetFocus(IP,ne_CodeClass);
        stat = CM_IGNORE;
      end;
    /* ESC - Выход с запросом --------------------------------------- */
    elif (key == 27)
      if (WasChangedField())
        if (GetTrue(TRUE,"Данные были изменены. Сохранить?"))
          stat = CM_SAVE;
        else
          stat = CM_CANCEL;
        end;
      else
        stat = CM_CANCEL;
      end;
    /* F3 ----------------------------------------------------------- */
    elif (key == 317)
      if (id == ne_CodeClass)
        WorkWithClass(TRUE);
      elif (id == ne_ManWom)
        WorkWithManWom(TRUE);
      elif (id == ne_Marriage)
        WorkWithMarriage(TRUE);
      elif (id == ne_Private)
        WorkWithPrivate(TRUE);
      elif (id == ne_PostCode)
        WorkWithPostCode(TRUE);
      elif (id == ne_CodeWork)
        WorkWithCodeWork(TRUE);
      elif (id == ne_Nation)
        WorkWithNation(TRUE);
      elif (id == ne_TitulClnt)
        WorkWithTitul();
      elif (id == ne_TitulEmboss)
        WorkWithTitulEmbos();
      elif (id == ne_TypeAccount)
        WorkWithTypeAccount(TRUE);
      end;
      UpdateFields(IP);
    /* F5 - Паспорт ------------------------------------------------- */
    elif (key == 319)
      RunDialog(InputPanelDopCardPass,"WorkDialogDopCardPass");
    /* F6 - Адреса -------------------------------------------------- */
    elif (key == 320)
      RunDialog(InputPanelDopCardAdr,"WorkDialogDopCardAdr");
    /* F7 - Работа -------------------------------------------------- */
    elif (key == 321)
      RunDialog(InputPanelDopCardWork,"WorkDialogDopCardWork");
    /* ^F7 - Другие карточки ---------------------------------------- */
    elif (key == 356)
      RunDialog(InputPanelDopCardCard,"WorkDialogDopCardCard");
    /* F9 - Сохранить ----------------------------------------------- */
    elif (key == 323)
      stat = CM_SAVE;
    end;
  /* ================================================================== */
  elif (cmd == DLG_REMFOCUS)
    if (id == ne_Nation)
      WorkWithNation(FALSE);
      UpdateFields(IP);
    end;
  /* ================================================================== */
  elif (cmd == DLG_SAVE)

    CheckFillNecessaryFields(PANEL_MAINADD,FALSE);

    carddop.CodeClassClient   = InputPanelDopCard.CodeClassClient;
    carddop.ManWom            = InputPanelDopCard.ManWom;
    carddop.Marriage          = InputPanelDopCard.Marriage;
    carddop.Proprietor        = InputPanelDopCard.Proprietor;
    carddop.PostCode          = InputPanelDopCard.PostCode;
    carddop.CodeWork          = InputPanelDopCard.CodeWork;
    carddop.Nation            = InputPanelDopCard.Nation;
    carddop.TitulClnt         = InputPanelDopCard.TitulClnt;
    carddop.TitulEmboss       = InputPanelDopCard.TitulEmboss;
    carddop.AgendaDate        = InputPanelDopCard.AgendaDate;
    carddop.TypeAccount       = InputPanelDopCard.TypeAccount;
    carddop.NumberPrimaryAddr = InputPanelDopCardAdr.PrimaryAddr;
    carddop.TypeAddr1         = TAddr1;
    carddop.IndexAddr1        = InputPanelDopCardAdr.Index1;
    carddop.Addr1S1           = InputPanelDopCardAdr.Addr1S1;
    carddop.Addr1S2           = InputPanelDopCardAdr.Addr1S2;
    carddop.Addr1S3           = InputPanelDopCardAdr.Addr1S3;
    carddop.TypeAddr2         = TAddr2;
    carddop.IndexAddr2        = InputPanelDopCardAdr.Index2;
    carddop.Addr2S1           = InputPanelDopCardAdr.Addr2S1;
    carddop.Addr2S2           = InputPanelDopCardAdr.Addr2S2;
    carddop.Addr2S3           = InputPanelDopCardAdr.Addr2S3;
    carddop.TypeAddr3         = TAddr3;
    carddop.IndexAddr3        = InputPanelDopCardAdr.Index3;
    carddop.Addr3S1           = InputPanelDopCardAdr.Addr3S1;
    carddop.Addr3S2           = InputPanelDopCardAdr.Addr3S2;
    carddop.Addr3S3           = InputPanelDopCardAdr.Addr3S3;
    carddop.HomePhone         = InputPanelDopCardAdr.HomePhone;
    carddop.WorkPhone         = InputPanelDopCardAdr.WorkPhone;
    carddop.TypePass          = InputPanelDopCardPass.TypePass;
    carddop.OfKindPass        = InputPanelDopCardPass.OfKindPas;
    carddop.RomLettSer        = InputPanelDopCardPass.RomLettSer;
    carddop.RusLettSer        = InputPanelDopCardPass.RusLettSer;
    carddop.NumPass           = InputPanelDopCardPass.NumPass;
    carddop.IPassSer          = InputPanelDopCardPass.IPassSer;
    carddop.IPassNo           = InputPanelDopCardPass.IPassNo;
    carddop.NameCompany       = InputPanelDopCardWork.NameCompany;
    carddop.PostCompany       = InputPanelDopCardWork.PostCompany;
    carddop.DepartCompany     = InputPanelDopCardWork.DepartCompany;
    carddop.NumbInCompany     = InputPanelDopCardWork.NumbInCompany;
    carddop.NumberCard1       = InputPanelDopCardCard.NumberCard1;
    carddop.NumberCard2       = InputPanelDopCardCard.NumberCard2;
    carddop.NumberCard3       = InputPanelDopCardCard.NumberCard3;
    carddop.NumberCard4       = InputPanelDopCardCard.NumberCard4;
  end;

  return stat;

end;


/**************************************************************************\
|                Чтение информации из кодификатора UNICARD                 |
\**************************************************************************/
macro ReadListInfoForPanelDopInfo

  var stat = TRUE;
  var NameFile;
  var i;

  if (CodesFromFile)
    NameFile = ""; //GetIniString("DATABASEDIR");
    if (StrLen(NameFile) > 0)
      if (SubStr(NameFile,StrLen(NameFile),1) != "\\")
        NameFile = NameFile + "\\";
      end;
    end;
    NameFile = NameFile + "codes.dbf";
    stat = Open(codes,NameFile);
    if (stat)
      while (Next(codes))
        /* Тип адреса ------------------------------------------------- */
        if   (StrUpr(Trim(codes.GROUP)) == "ADML")
          i = ASize(ATypeAddr);
          ATypeAddr(i) = Trim(codes.COD); 
          ANameAddr(i) = Trim(codes.VALCOD);
        /* Класс клиента ---------------------------------------------- */
        elif (StrUpr(Trim(codes.GROUP)) == "CCLSS")
          i = ASize(ATypeClass);
          ATypeClass(i) = Int(Trim(codes.COD)); 
          ANameClass(i) = Trim(codes.VALCOD);
        /* Пол клиента ------------------------------------------------ */
        elif (StrUpr(Trim(codes.GROUP)) == "GEND")
          i = ASize(ATypeManWom);
          ATypeManWom(i) = Trim(codes.COD); 
          ANameManWom(i) = Trim(codes.VALCOD);
        /* Семейное положение ----------------------------------------- */
        elif (StrUpr(Trim(codes.GROUP)) == "MRTL")
          i = ASize(ATypeMarriage);
          ATypeMarriage(i) = Trim(codes.COD); 
          ANameMarriage(i) = Trim(codes.VALCOD);
        /* Частная собственность -------------------------------------- */
        elif (StrUpr(Trim(codes.GROUP)) == "OWNHM")
          i = ASize(ATypePrivate);
          ATypePrivate(i) = Trim(codes.COD); 
          ANamePrivate(i) = Trim(codes.VALCOD);
        /* Почтовая доставка ------------------------------------------ */
        elif (StrUpr(Trim(codes.GROUP)) == "MAIL")
          i = ASize(ATypeMail);
          ATypeMail(i) = Trim(codes.COD); 
          ANameMail(i) = Trim(codes.VALCOD);
        /* Занятость -------------------------------------------------- */
        elif (StrUpr(Trim(codes.GROUP)) == "OCCAT")
          i = ASize(ATypeWork);
          ATypeWork(i) = Trim(codes.COD); 
          ANameWork(i) = Trim(codes.VALCOD);
        /* Национальность --------------------------------------------- */
        elif (StrUpr(Trim(codes.GROUP)) == "RACE")
          i = ASize(ATypeNation);
          ATypeNation(i) = Trim(codes.COD); 
          ANameNation(i) = Trim(codes.VALCOD);
        /* Тип заявления ---------------------------------------------- */
        elif (StrUpr(Trim(codes.GROUP)) == "APPLN")
          i = ASize(ATypeAppl);
          ATypeAppl(i) = Trim(codes.COD); 
          ANameAppl(i) = Trim(codes.VALCOD);
        end;
      end;
      Close(codes);
    else
      MsgBox("Ошибка при открытии кодификатора UNICARD|" + NameFile);
    end;
  else
    /* Тип адреса ----------------------------------------------------- */
    ATypeAddr(0) = "B"; ANameAddr(0) = "Бизнес-адрес";
    ATypeAddr(1) = "H"; ANameAddr(1) = "Домашний адрес";
    ATypeAddr(2) = "P"; ANameAddr(2) = "Только почтовый адрес";
    /* Класс клиента -------------------------------------------------- */
    ATypeClass( 0) = 10; ANameClass( 0) = "VIP";
    ATypeClass( 1) = 13; ANameClass( 1) = "CIP (важные люди в коммерции)";
    ATypeClass( 2) = 16; ANameClass( 2) = "SIP (руководители организаций)";
    ATypeClass( 3) = 19; ANameClass( 3) = "Председатель/Член совета директоров";
    ATypeClass( 4) = 20; ANameClass( 4) = "Персонал - главный управляющий";
    ATypeClass( 5) = 21; ANameClass( 5) = "Бывший директор/главный управляющий";
    ATypeClass( 6) = 22; ANameClass( 6) = "Персонал - директор";
    ATypeClass( 7) = 23; ANameClass( 7) = "Персонал - старший менеджер";
    ATypeClass( 8) = 24; ANameClass( 8) = "Персонал - менеджер";
    ATypeClass( 9) = 25; ANameClass( 9) = "Персонал - руководитель среднего звена";
    ATypeClass(10) = 28; ANameClass(10) = "Персонал - прочие служащие";
    ATypeClass(11) = 29; ANameClass(11) = "Персонал - вышедшие на пенсию";
    ATypeClass(12) = 40; ANameClass(12) = "Руководитель коммерческого счета";
    ATypeClass(13) = 50; ANameClass(13) = "Остановить письма кредитного контроля";
    ATypeClass(14) = 60; ANameClass(14) = "Обычный клиент";
    /* Пол клиента ---------------------------------------------------- */
    ATypeManWom(0) = "F"; ANameManWom(0) = "Женский";
    ATypeManWom(1) = "M"; ANameManWom(1) = "Мужской";
    ATypeManWom(2) = "U"; ANameManWom(2) = "Неизвестен";
    /* Семейное положение --------------------------------------------- */
    ATypeMarriage(0) = "D"; ANameMarriage(0) = "Разведен/Разведена";
    ATypeMarriage(1) = "M"; ANameMarriage(1) = "Женат/Замужем";
    ATypeMarriage(2) = "P"; ANameMarriage(2) = "Разделены";
    ATypeMarriage(3) = "S"; ANameMarriage(3) = "Одинокий/Одинока";
    ATypeMarriage(4) = "W"; ANameMarriage(4) = "Вдова/Вдовец";
    /* Частная собственность ------------------------------------------ */
    ATypePrivate(0) = "E"; ANamePrivate(0) = "Проживает по адресу найма";
    ATypePrivate(1) = "M"; ANamePrivate(1) = "Заложен";
    ATypePrivate(2) = "O"; ANamePrivate(2) = "Владелец дома";
    ATypePrivate(3) = "P"; ANamePrivate(3) = "Живет с родителями";
    ATypePrivate(4) = "R"; ANamePrivate(4) = "Арендатор. Адрес проживания";
    /* Почтовая доставка ---------------------------------------------- */
    ATypeMail(0) = "I"; ANameMail(0) = "Не высылать литературу по страховке";
    ATypeMail(1) = "M"; ANameMail(1) = "Не высылать литературу по Торговым Учреждениям";
    ATypeMail(2) = "X"; ANameMail(2) = "Ничего не высылать";
    /* Занятость ------------------------------------------------------ */
    ATypeWork( 0) = "01"; ANameWork( 0) = "Правительство";
    ATypeWork( 1) = "02"; ANameWork( 1) = "Служащий на жаловании";
    ATypeWork( 2) = "03"; ANameWork( 2) = "Экспантриант";
    ATypeWork( 3) = "04"; ANameWork( 3) = "Единоличный владелец";
    ATypeWork( 4) = "05"; ANameWork( 4) = "Партнерство";
    ATypeWork( 5) = "06"; ANameWork( 5) = "Бизнес";
    ATypeWork( 6) = "07"; ANameWork( 6) = "Студент";
    ATypeWork( 7) = "08"; ANameWork( 7) = "Пенсионер";
    ATypeWork( 8) = "09"; ANameWork( 8) = "Домохозяйка";
    ATypeWork( 9) = "10"; ANameWork( 9) = "Прочие";
    ATypeWork(10) = "99"; ANameWork(10) = "Прочие";
    /* Национальность ------------------------------------------------- */
    ATypeNation(0) = "01"; ANameNation(0) = "Русский";
    ATypeNation(1) = "02"; ANameNation(1) = "Украинец";
    ATypeNation(2) = "03"; ANameNation(2) = "Белорус";
    ATypeNation(3) = "04"; ANameNation(3) = "Казах";
    ATypeNation(4) = "63"; ANameNation(4) = "Татарин";
    ATypeNation(5) = "65"; ANameNation(5) = "Карел";
    ATypeNation(6) = "66"; ANameNation(6) = "Немец";
    ATypeNation(7) = "89"; ANameNation(7) = "Экспатриант";
    ATypeNation(8) = "99"; ANameNation(8) = "Прочее";
    /* Тип заявления -------------------------------------------------- */
    ATypeAppl( 0) = "A";  ANameAppl( 0) = "Дополнительная карточка";
    ATypeAppl( 1) = "B";  ANameAppl( 1) = "Индивидуальная карточка Business";
    ATypeAppl( 2) = "BA"; ANameAppl( 2) = "Бизнес-счет с дополнительной карточкой";
    ATypeAppl( 3) = "G";  ANameAppl( 3) = "Счет-гарантия";
    ATypeAppl( 4) = "GA"; ANameAppl( 4) = "Счет-гарантия с дополнительной карточкой";
    ATypeAppl( 5) = "I";  ANameAppl( 5) = "Карточка индивидуального счета";
    ATypeAppl( 6) = "IA"; ANameAppl( 6) = "Индивидуальный счет с дополнительной карточкой";
    ATypeAppl( 7) = "IS"; ANameAppl( 7) = "Дополнительная карточка с отдельной выпиской";
    ATypeAppl( 8) = "J";  ANameAppl( 8) = "Карточка совместного счета";
    ATypeAppl( 9) = "K";  ANameAppl( 9) = "Замена карточки, выпущенной через Кардцентр";
    ATypeAppl(10) = "L";  ANameAppl(10) = "Льготная карточка";
    ATypeAppl(11) = "LA"; ANameAppl(11) = "Льготная карточка с дополнительной";
    ATypeAppl(12) = "M";  ANameAppl(12) = "Молодежная карточка";
    ATypeAppl(13) = "P";  ANameAppl(13) = "Представительская карточка";
    ATypeAppl(14) = "PA"; ANameAppl(14) = "Представительская карточка с дополнительной";
    ATypeAppl(15) = "R";  ANameAppl(15) = "Привилегированная карточка";
    ATypeAppl(16) = "RA"; ANameAppl(16) = "Привилегированная карточка с дополнительной";
    ATypeAppl(17) = "Z";  ANameAppl(17) = "Зарплатная карточка";
    ATypeAppl(18) = "ZA"; ANameAppl(18) = "Зарплатная карточка с дополнительной";
  end;

  return stat;

end;


/**************************************************************************\
|                  Дополнительная информация по карточке                   |
\**************************************************************************/
macro PanelDopInfo

  var stat = TRUE;

  /* Чтение информации из кодификатора UNICARD */
  if (stat)
    stat = ReadListInfoForPanelDopInfo();
  end;

  /* Длина переменной части */
  if (stat)
    ALG_VARPARTSIZE = GetRecordSize(carddop) - GetRecordSize(cardnew);
  end;

  /* Инициализация полей панели */
  if (stat)
    InputPanelDopCard.CodeClassClient   = carddop.CodeClassClient;
    InputPanelDopCard.ManWom            = carddop.ManWom;
    InputPanelDopCard.Marriage          = carddop.Marriage;
    InputPanelDopCard.Proprietor        = carddop.Proprietor;
    InputPanelDopCard.PostCode          = carddop.PostCode;
    InputPanelDopCard.CodeWork          = carddop.CodeWork;
    InputPanelDopCard.Nation            = carddop.Nation;
    InputPanelDopCard.TitulClnt         = carddop.TitulClnt;
    InputPanelDopCard.TitulEmboss       = carddop.TitulEmboss;
    InputPanelDopCard.AgendaDate        = carddop.AgendaDate;
    InputPanelDopCard.TypeAccount       = carddop.TypeAccount;
    InputPanelDopCardAdr.PrimaryAddr    = carddop.NumberPrimaryAddr;
    TAddr1                              = carddop.TypeAddr1;
    InputPanelDopCardAdr.Index1         = carddop.IndexAddr1;
    InputPanelDopCardAdr.Addr1S1        = carddop.Addr1S1;
    InputPanelDopCardAdr.Addr1S2        = carddop.Addr1S2;
    InputPanelDopCardAdr.Addr1S3        = carddop.Addr1S3;
    TAddr2                              = carddop.TypeAddr2;
    InputPanelDopCardAdr.Index2         = carddop.IndexAddr2;
    InputPanelDopCardAdr.Addr2S1        = carddop.Addr2S1;
    InputPanelDopCardAdr.Addr2S2        = carddop.Addr2S2;
    InputPanelDopCardAdr.Addr2S3        = carddop.Addr2S3;
    TAddr3                              = carddop.TypeAddr3;
    InputPanelDopCardAdr.Index3         = carddop.IndexAddr3;
    InputPanelDopCardAdr.Addr3S1        = carddop.Addr3S1;
    InputPanelDopCardAdr.Addr3S2        = carddop.Addr3S2;
    InputPanelDopCardAdr.Addr3S3        = carddop.Addr3S3;
    InputPanelDopCardAdr.HomePhone      = carddop.HomePhone;
    InputPanelDopCardAdr.WorkPhone      = carddop.WorkPhone;
    InputPanelDopCardPass.TypePass      = carddop.TypePass;
    InputPanelDopCardPass.OfKindPas     = carddop.OfKindPass;
    InputPanelDopCardPass.RomLettSer    = carddop.RomLettSer;
    InputPanelDopCardPass.RusLettSer    = carddop.RusLettSer;
    InputPanelDopCardPass.NumPass       = carddop.NumPass;
    InputPanelDopCardPass.IPassSer      = carddop.IPassSer;
    InputPanelDopCardPass.IPassNo       = carddop.IPassNo;
    InputPanelDopCardWork.NameCompany   = carddop.NameCompany;
    InputPanelDopCardWork.PostCompany   = carddop.PostCompany;
    InputPanelDopCardWork.DepartCompany = carddop.DepartCompany;
    InputPanelDopCardWork.NumbInCompany = carddop.NumbInCompany;
    InputPanelDopCardCard.NumberCard1   = carddop.NumberCard1;
    InputPanelDopCardCard.NumberCard2   = carddop.NumberCard2;
    InputPanelDopCardCard.NumberCard3   = carddop.NumberCard3;
    InputPanelDopCardCard.NumberCard4   = carddop.NumberCard4;
  end;

  /* Инициализация подкачиваемых полей */
  if (stat)
    WorkWithTypePass   (FALSE);
    WorkWithTypeAddr   (FALSE,1);
    WorkWithTypeAddr   (FALSE,2);
    WorkWithTypeAddr   (FALSE,3);
    WorkWithClass      (FALSE);
    WorkWithManWom     (FALSE);
    WorkWithMarriage   (FALSE);
    WorkWithPrivate    (FALSE);
    WorkWithPostCode   (FALSE);
    WorkWithCodeWork   (FALSE);
    WorkWithNation     (FALSE);
    WorkWithTypeAccount(FALSE);
  end;

  /* Сохранение подкачиваемых полей */
  if (stat)
    Copy(InputPanelDopCardS,    InputPanelDopCard    );
    Copy(InputPanelDopCardAdrS, InputPanelDopCardAdr );
    Copy(InputPanelDopCardPassS,InputPanelDopCardPass);
    Copy(InputPanelDopCardWorkS,InputPanelDopCardWork);
    Copy(InputPanelDopCardCardS,InputPanelDopCardCard);
  end;

  /* Запустить панель */
  if (stat)
    RunDialog(InputPanelDopCard,"WorkDialogDopCard");
  end;

end;


/**************************************************************************\
|                      Действия при вызове из панели                       |
\**************************************************************************/
macro Panel

  var i;
  array ArrayMenu;
    ArrayMenu(0) = " Дополнительная информация по карточке ";
    ArrayMenu(1) = " Копия заявления на получение карточки ";
    ArrayMenu(2) = " Заявка на установление контрольной информации ";
    ArrayMenu(3) = " Заявка на внесение изменения в личные данные ";
    ArrayMenu(4) = " Заявление о разблокировке карты ";

  i = Menu(ArrayMenu,NULL,"Выберите действие");

  if   (i == 0)
    PanelDopInfo();
  elif (i == 1)
    CopZayav();
  elif (i == 2)
    ZayavContr();
  elif (i == 3)
    ZayavPerson();
  elif (i == 4)
    ApplNoBlock();
  end;

end;


/**************************************************************************\
|       Инициализация полей для новой карточки из держателя карточки       |
\**************************************************************************/
macro InitDopCardFields

  var endSecName;
  
  carddop.AgendaDate = carddop.cardOpenDate;
    
  if ( FindClient( carddop.CodClient ) )

    // Копирование адреса
    ClearRecord( InputPanelDopCardAdr );
    CopyClientAddressInfo( );
    carddop.IndexAddr1  = InputPanelDopCardAdr.Index1;
    carddop.Addr1S1     = InputPanelDopCardAdr.Addr1S1;
    carddop.Addr1S2     = InputPanelDopCardAdr.Addr1S2;
    carddop.Addr1S3     = InputPanelDopCardAdr.Addr1S3;
    carddop.IndexAddr2  = InputPanelDopCardAdr.Index2;
    carddop.Addr2S1     = InputPanelDopCardAdr.Addr2S1;
    carddop.Addr2S2     = InputPanelDopCardAdr.Addr2S2;
    carddop.Addr2S3     = InputPanelDopCardAdr.Addr2S3;
    carddop.IndexAddr3  = InputPanelDopCardAdr.Index3;
    carddop.Addr3S1     = InputPanelDopCardAdr.Addr3S1;
    carddop.Addr3S2     = InputPanelDopCardAdr.Addr3S2;
    carddop.Addr3S3     = InputPanelDopCardAdr.Addr3S3;

    // Копирование паспортных данных
    ClearRecord( InputPanelDopCardPass );
    CopyClientPassportInfo( );

    carddop.RomLettSer = InputPanelDopCardPass.RomLettSer;
    carddop.RusLettSer = InputPanelDopCardPass.RusLettSer;
    carddop.NumPass    = InputPanelDopCardPass.NumPass;
    carddop.TypePass   = InputPanelDopCardPass.TypePass;

    // Инициализация полей связанных с полом
    if ( StrLen( depclnt.CurRec.rec.Name3 ) > 2 )
      endSecName = SubStr( depclnt.CurRec.rec.Name3, StrLen( depclnt.CurRec.rec.Name3 ) - 1, 2 );
      if ( StrUpr( endSecName ) == "ИЧ" )
        carddop.ManWom      = "M";
        carddop.TitulClnt   = "ГОСПОДИН";
        carddop.TitulEmboss = "MR";
      elif ( StrUpr( endSecName ) == "НА" )
        carddop.ManWom      = "F";
        carddop.TitulClnt   = "ГОСПОЖА";
        carddop.TitulEmboss = "MRS";
      end;
    end;

    // Категория занятости
    if ( depclnt.CurRec.rec.Kategor == StrFor( 3 ) ) // Пенсионер
      carddop.CodeWork = "08";
    elif ( depclnt.CurRec.rec.Kategor == StrFor( 5 ) ) // Домохозяйка
      carddop.CodeWork = "09";
    end;

  end;

end;


/**************************************************************************\
|                     П О С Л Е   С О Х Р А Н Е Н И Я                      |
\**************************************************************************/
macro AfterSave
(
 rec,     /* Карточка           */
 operate, /* Операция           */
 soperate /* Уточнение операции */
)
  var stat = 0;
  
 /* Устанавливаем старое значение записи до ее сохранения */
  setbuff(acardold,rec);

  /* Действия после сохранения карточки */
  if (operate == SCPSMAC_AFTERSAVE)   
   /* Находим новое значение записи после ее сохранения*/
    stat = FindCardAfterChange();
    if (stat)
      if (acardnew.cardStateCode != acardold.cardStateCode)
      /* Заявление на изменение статуса карточки */
        AfterChangeState();
      end;
    end;         

  end;
  
  return stat;
end;         
/**************************************************************************\
|                    Г Л А В Н А Я   П Р О Г Р А М М А                     |
\**************************************************************************/
macro Card
(
 rec,     /* Карточка           */
 operate, /* Операция           */
 soperate /* Уточнение операции */
)              

  var stat = 0;

  setbuff(cardnew,rec);
  setbuff(carddop,rec); /* Структура переменной части */

  /* Действия при сохранении существующей карточки */
  if ((operate == SCPSMAC_SAVE) AND (soperate == 0))
    if (StateCompare(cardnew.cardStateCode,"OFF__",6,cardnew.psRef))
      CheckFillNecessaryFields(PANEL_MAIN,FALSE);
    end;
    if (FindCardBeforeChange())
      /* Заявление на изменение контрольной информации */
      if (cardnew.clientPassword != cardold.clientPassword)
        ZayavContr();
      end;
      /* Заявление на разблокировку карточки */
      if ((NOT StateCompare(cardnew.cardStateCode,"NA___",6,cardnew.psRef)) AND
          (    StateCompare(cardold.cardStateCode,"NA___",6,cardold.psRef))    )
        ApplNoBlock();
      end;
      /* Выдача первой карточки */
      if (( StateCompare(cardnew.cardStateCode,"OK___",6,cardnew.psRef)    ) AND
          ((StateCompare(cardold.cardStateCode,"OFFPC",6,cardold.psRef)) OR 
           (StateCompare(cardold.cardStateCode,"REC__",6,cardold.psRef))   )    )
        FormForPc = "";
        OperForPc = "UB";
        if ( not ProcessTrn( NULL, "WriteNotSendToPc" ) )
          MsgBox("Ошибка при сохранении записи в файле неотправленных сообщений в ПЦ");
          stat = 1664;
        end;
      end;
      /* Досрочный перевыпуск карточки */
      if ((StateCompare(cardold.cardStateCode,"OK___",6,cardnew.psRef)) AND
          (SubStr(cardnew.cardStateCode,1,3) == "OVR"                 )    )
        FormForPc = "";
        OperForPc = "OV";
        if ( not ProcessTrn( NULL, "WriteNotSendToPc" ) )
          MsgBox("Ошибка при сохранении записи в файле неотправленных сообщений в ПЦ");
          stat = 1664;
        end;
      end;
      /* Блокирование карты */
      if ((StateCompare(cardold.cardStateCode,"OK___",6,cardnew.psRef)) AND
          (SubStr(cardnew.cardStateCode,1,3) == "BLK"                 )    )
        FormForPc = "";
        OperForPc = "BL";
        if ( not ProcessTrn( NULL, "WriteNotSendToPc" ) )
          MsgBox("Ошибка при сохранении записи в файле неотправленных сообщений в ПЦ");
          stat = 1664;
        end;
      end;
      /* Разблокирование карты */
      if ((StateCompare(cardnew.cardStateCode,"OK___",6,cardnew.psRef)) AND
          (StateCompare(cardold.cardStateCode,"NA___",6,cardold.psRef))    )
        FormForPc = "";
        OperForPc = "UB";
        if ( not ProcessTrn( NULL, "WriteNotSendToPc" ) )
          MsgBox("Ошибка при сохранении записи в файле неотправленных сообщений в ПЦ");
          stat = 1664;
        end;
      end;
      /* Изменение информации по клиенту */
      if ((StateCompare(cardnew.cardStateCode,"OFF__",6,cardnew.psRef)) OR
          (StateCompare(cardnew.cardStateCode,"CLS__",6,cardnew.psRef))   )
        ;
      else
        if ( WasChangedClientFields( ) )
          FormForPc = "CL";
          // OperForPc определяется в  WasChangedClientFields
          if ( not ProcessTrn( NULL, "WriteNotSendToPc" ) )
            MsgBox( "Ошибка при сохранении записи в файле неотправленных сообщений в ПЦ" );
            stat = 1664;
          end;
        end;
      end;
    end;
  /* Действия при сохранении новой карточки */
  elif ( ( operate == SCPSMAC_SAVE ) and ( soperate == 1 ) )
    InitDopCardFields( );

    MsgBox( "Не забудьте задать дополнительную информацию по карточке" );
    CheckFillNecessaryFields( PANEL_MAIN, true );
  /* Действия при вызове из панели */
  elif (operate == SCPSMAC_PANEL)
    Panel( );
  end;

  return stat;

end;
