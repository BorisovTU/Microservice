/**************************************************************************\
*  ---------------                                                         *
*  R-Style Softlab                                                         *
*  ---------------                                                         *
*  RS-Retail                                                               *
*                                                                          *
*  Пластиковые карточки                                                    *
*                                                                          *
*  Формирование формы 250                                                  *
*                                                                          *
*  Лебедев С.В.                                                            *
*  20.03.2002                                                              *
*                                                                          *
*  НАСТРОЙКА. ОПИСАНИЕ ПРОГРАММЫ                                           *
*                                                                          *
*  Данная программа формирует 1 (по физическим лицам) и 3 часть формы 250  *
*  1 часть                                                                 *
*  Идет цикл по карточкам, которые действовали в течении квартала и идет   *
*  подсчет их количества. Для каждой карточки идет просмотр транзакций за  *
*  квартал и по всем дебетовым транзакциям идет подсчет сумм таблиц на     *
*  основе сумм транзакций из файла транзакций (комиссии не учитываются).   *
*  Суммы разбиваются по колонкам по типам транзакций в соответствии с      *
*  массивами ACashRF, ACashAbrode, AServiceRF, AServiceAbrode - которые    *
*  настраиваются пользователями в соответствии с их справочником типов     *
*  транзакций (сейчас данные массивы настроены для дистрибутива)           *
*  3 часть                                                                 *
*  Вначале идет цикл по карточкам и транзакциям аналогично части 1. В      *
*  соответствии с массивами ACashRF, ACashAbrode, AServiceRF,              *
*  AServiceAbrode идет разбиение сумм транзакций на торгово-сервисную сеть *
*  (AServiceRF и AServiceAbrode) и выдачу наличных (ACashRF и ACashAbrode).*
*  Потом внутри каждой группы идет подразбиение сумм на полученыых в       *
*  банкоматах и с использованием терминальных устройств - соответственно   *
*  массивы ATerminal и ABankomat. Так заполняется 1 часть 3 раздела. 2 и 3 *
*  часть заполняется на основе эквайринговых проводок - идет цикл по       *
*  эквайринговым проводкам за квартал и для них определяется только сумма  *
*  выдачи наличных в ПВН и банкоматах в валюте РФ и иностранной валюте.    *
*  В дистрибутивных настройках пока не разделяется в каком банке выпущена  *
*  обслуживаемая карточка - в российском или иностранном - поэтому все     *
*  эквайринговые операции попадают в раздел "с использованием карт,        *
*  эмитированных резидентами" - для разбиения надо доработать макрофункцию *
*  IsForeignBank - которое в зависимости может от типа транзакции или еще  *
*  от какого-то значения будует помещать эквайринговую операцию в нужный   *
*  раздел отчета                                                           *
\**************************************************************************/

import DeprIntr,cur_rate,sqlconv;

file scCodif  (scCodif,"spcard.def") key 3;
file scCard   (scCard, "spcard.def") key 0;
file person   (person, "bank.def"  ) key 0;
/*
file scLink   (scLink, "spcard.def") key 2;
file scTran   (scTran, "spcard.def") key 3;
file scAcqu   (scAcqu, "spcard.def") key 5;
file depositr (depositr            ) key 8;
file pay_doc  (pay_doc             ) key 2;
*/
var  scLink   = TBFile( "scLink.dbt", "r", 2, "scLink.dbt", "spcard.def");
var  scTran   = TBFile( "scTran.dbt", "r", 3, "scTran.dbt", "spcard.def");
var  scAcqu   = TBFile( "scAcqu.dbt", "r", 5, "scAcqu.dbt", "spcard.def");
var  depositr = TBFile( "depositr.dbt", "r", 8);
var  pay_doc  = TBFile( "pay_doc.dbt", "r", 2);

/* Настраиваемые массивы */
array ACashRF,ACashAbrode,AServiceRF,AServiceAbrode,ATerminal,ABankomat;
/* Наличные РФ               Наличные зарубежом   */
  /* Базовое значение */
  ACashRF( 0) = "PRC__";
  /* Платежная система Сбербанка */
  ACashRF( 1) = "2000_";     ACashAbrode(0) = "2200_";
  ACashRF( 2) = "2001_";     ACashAbrode(1) = "2210_";
  ACashRF( 3) = "2010_";
  ACashRF( 4) = "2011_";
  ACashRF( 5) = "2020_";
  ACashRF( 6) = "2021_";
  ACashRF( 7) = "2100_";
  ACashRF( 8) = "2110_";
  /* Платежная система СТБ */
  ACashRF( 9) = "04___";
  ACashRF(10) = "61___";
  /* Платежная система Мультикарта */
  ACashRF(11) = "MULTI";
  /* Платежная система МББ */
  ACashRF(12) = "07___";
  /* Платежная система АСМ-Р */
  ACashRF(13) = "ACASH";
  ACashRF(14) = "CASH_";

/* Товары/Услуги РФ          Товары/Услуги зарубежом */
  /* Платежная система Сбербанка */
  AServiceRF(0) = "1000_";  AServiceAbrode(0) = "1200_";
  AServiceRF(1) = "1010_";  AServiceAbrode(1) = "1210_";
  AServiceRF(2) = "1100_";
  AServiceRF(3) = "1110_";
  /* Платежная система СТБ */
  AServiceRF(4) = "25___";
  /* Платежная система Мультикарта */
  /* Платежная система МББ */
  AServiceRF(5) = "05___";
  /* Платежная система АСМ-Р */
  AServiceRF(6) = "ASHOP";
  AServiceRF(7) = "SHOP_";

/* Терминал                     Банкомат */
  /* Базовое значение */
                                ABankomat(0) = "PRC__";
  /* Платежная система Сбербанка */
   ATerminal( 0) = "1000_";     ABankomat(1) = "2010_";
   ATerminal( 1) = "1010_";     ABankomat(2) = "2011_";
   ATerminal( 2) = "1100_";     ABankomat(3) = "2110_";
   ATerminal( 3) = "1110_";     ABankomat(4) = "2110_";
   ATerminal( 4) = "1200_";     ABankomat(5) = "2210_";
   ATerminal( 5) = "1210_";
   ATerminal( 6) = "2000_";
   ATerminal( 7) = "2001_";
   ATerminal( 8) = "2020_";
   ATerminal( 9) = "2021_";
   ATerminal(10) = "2100_";
   ATerminal(11) = "2200_";
  /* Платежная система СТБ */
   ATerminal(12) = "25___";     ABankomat(6) = "04___";
   ATerminal(13) = "61___";
  /* Платежная система Мультикарта */
  /* Платежная система МББ */
   ATerminal(14) = "05___";
  /* Платежная система АСМ-Р */
   ATerminal(15) = "ASHOP";
   ATerminal(16) = "SHOP_";

const TYPE_UNDEF          = 0;
/*****************************/
const TYPE_CASH_RF        = 1;
const TYPE_CASH_ABRODE    = 2;
const TYPE_SERVICE_RF     = 3;
const TYPE_SERVICE_ABRODE = 4;
/*****************************/
const TYPE_TERMINAL       = 1;
const TYPE_BANKOMAT       = 2;

/* Панель и поля панели для выпуска отчета */
record FORM250 ("FORM250") dialog;
/* Номер полей диалога */
const ne_NameBranch = 0,
      ne_Quartal    = 1,
      ne_Year       = 2;

var Branch = NumFNCash();
var {curdate};
var BegDate;
var EndDate;

private var {MFO_Bank};
private var {Name_Bank};
private var {Post_Addr};
private var {oper};
  
array ABranches,ACardTypes,APos;
/* Массивы для формирования раздела 1 */
array AClients,ACards,ADebits;
array ACountsNatRF,ASumNatRF,ACountsCurRF,ASumCurRF,ACountsCurAbr,ASumCurAbr;
array ACountsNatRFServ,ASumNatRFServ,ACountsCurRFServ,ASumCurRFServ,ACountsCurAbrServ,ASumCurAbrServ;
/* Массивы для формирования раздела 3 */
array ACountServ,ASummaServ,ACountServET,ASummaServET;
array ACountPVNB,ASummaPVNB,ACountPVNBB,ASummaPVNBB,ACountPVNBET,ASummaPVNBET;
array ACountPVNBCur,ASummaPVNBCur,ACountPVNBBCur,ASummaPVNBBCur,ACountPVNBETCur,ASummaPVNBETCur;
array ACountPVNBRes,ASummaPVNBRes;
array ACountPVNBCurRes,ASummaPVNBCurRes;
array ACountPVNBNRes,ASummaPVNBNRes;
array ACountPVNBCurNRes,ASummaPVNBCurNRes;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintHead

  var NameBank    = "";
  var AddressBank = "";
  var ddep = TRecHandler( "i_dp_dep.rec" );
  var party = TRecHandler( "i_party.rec" );

  NameBank = {Name_Bank};

  if (findDepartment(Branch, null, ddep, party))
    NameBank = Trim(NameBank + " " + ddep.rec.Name);
    if (ddep.rec.NodeType == I_DEPARTMENT_TYPE_FILIAL)
      AddressBank = {Post_Addr};
    else
      AddressBank = party.rec.address;
    end;
  end;

  [ ];
  [                                                      Банковская отчетность];
  [                               Код формы документа по ОКУД 0409250];
  [                               --------------------------------------------];
  [                               |   Код    |   Код кредитной организации   |];
  [                               |территории---------------------------------];
  [                               | по ОКАТО |  по  |регистрацион- |   БИК   |];
  [                               |          | ОКПО |ный номер     |         |];
  [                               --------------------------------------------];
  [                               |          |      |              |#        |]({MFO_Bank});
  [                               --------------------------------------------];
  [ ];
  [ ];
  [                           СВЕДЕНИЯ];
  [        О ДЕЯТЕЛЬНОСТИ КРЕДИТНЫХ ОРГАНИЗАЦИЙ (ФИЛИАЛОВ)];
  [         В ЧАСТИ РАСЧЕТОВ С ИСПОЛЬЗОВАНИЕМ БАНКОВСКИХ];
  [                        И ПЛАТЕЖНЫХ КАРТ];
  [ ];
  [   по состоянию на "__" __________ ____ г.];
  [   Наименование кредитной организации (филиала)  #](NameBank);
  [ ];
  [   Почтовый адрес  #](AddressBank);
  [ ];
  [ ];
  [                                                        Форма N 250];
  [                                                        Квартальная];
  [ ];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefNumElemForCard

  var i        = 0;
  var ret_elem = -1;

  while (i < ASize(ACardTypes))
    if ((ACardTypes(i) == scCard.cardTypeCode) AND (APos(i) == scCard.psRef))
      ret_elem = i;
      i = ASize(ACardTypes);
    end;
    i = i + 1;
  end;

  if (ret_elem == -1)
    ret_elem = ASize(ACardTypes);
    ACardTypes       (ret_elem) = scCard.cardTypeCode;
    APos             (ret_elem) = scCard.psRef;
    /* Для раздела 1 */
    AClients         (ret_elem) = 0;
    ACards           (ret_elem) = 0;
    ADebits          (ret_elem) = $0L;
    ACountsNatRF     (ret_elem) = 0;  ASumNatRF        (ret_elem) = $0L;
    ACountsCurRF     (ret_elem) = 0;  ASumCurRF        (ret_elem) = $0L;
    ACountsCurAbr    (ret_elem) = 0;  ASumCurAbr       (ret_elem) = $0L;
    ACountsNatRFServ (ret_elem) = 0;  ASumNatRFServ    (ret_elem) = $0L;
    ACountsCurRFServ (ret_elem) = 0;  ASumCurRFServ    (ret_elem) = $0L;
    ACountsCurAbrServ(ret_elem) = 0;  ASumCurAbrServ   (ret_elem) = $0L;
    /* Для раздела 3 */
    ACountServ       (ret_elem) = 0;  ASummaServ       (ret_elem) = $0L;
    ACountServET     (ret_elem) = 0;  ASummaServET     (ret_elem) = $0L;
    ACountPVNB       (ret_elem) = 0;  ASummaPVNB       (ret_elem) = $0L;
    ACountPVNBB      (ret_elem) = 0;  ASummaPVNBB      (ret_elem) = $0L;
    ACountPVNBET     (ret_elem) = 0;  ASummaPVNBET     (ret_elem) = $0L;
    ACountPVNBCur    (ret_elem) = 0;  ASummaPVNBCur    (ret_elem) = $0L;
    ACountPVNBBCur   (ret_elem) = 0;  ASummaPVNBBCur   (ret_elem) = $0L;
    ACountPVNBETCur  (ret_elem) = 0;  ASummaPVNBETCur  (ret_elem) = $0L;
    ACountPVNBRes    (ret_elem) = 0;  ASummaPVNBRes    (ret_elem) = $0L;
    ACountPVNBCurRes (ret_elem) = 0;  ASummaPVNBCurRes (ret_elem) = $0L;
    ACountPVNBNRes   (ret_elem) = 0;  ASummaPVNBNRes   (ret_elem) = $0L;
    ACountPVNBCurNRes(ret_elem) = 0;  ASummaPVNBCurNRes(ret_elem) = $0L;
  end;

  return ret_elem;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro TransformSum (summa_op, cod_cur, date_op, time_op)

  var summa_out = summa_op;
  var rate      = 1;

  if (date_op == Date(0,0,0))
    date_op = {curdate};
  end;

  if (cod_cur >= 0)
    ClearRecord(RtlCurr);
    RtlCurr.Code_Currency = cod_cur;
    rate = GetCurrRate(date_op, time_op);
    summa_out = summa_op * rate;
  end;

  summa_out = Money(summa_out / 1000);
  
  return summa_out;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefTypeTransaction (type_transaction)

  var ret_type = TYPE_UNDEF;
  var i        = 0;

  while (i < ASize(ACashRF))
    if (type_transaction == ACashRF(i))
      ret_type = TYPE_CASH_RF;
      i = ASize(ACashRF);
    end;
    i = i + 1;
  end;

  if (ret_type == TYPE_UNDEF)
    i = 0;
    while (i < ASize(ACashAbrode))
      if (type_transaction == ACashAbrode(i))
        ret_type = TYPE_CASH_ABRODE;
        i = ASize(ACashAbrode);
      end;
      i = i + 1;
    end;
  end;

  if (ret_type == TYPE_UNDEF)
    i = 0;
    while (i < ASize(AServiceRF))
      if (type_transaction == AServiceRF(i))
        ret_type = TYPE_SERVICE_RF;
        i = ASize(AServiceRF);
      end;
      i = i + 1;
    end;
  end;
  
  if (ret_type == TYPE_UNDEF)
    i = 0;
    while (i < ASize(AServiceAbrode))
      if (type_transaction == AServiceAbrode(i))
        ret_type = TYPE_SERVICE_ABRODE;
        i = ASize(AServiceAbrode);
      end;
      i = i + 1;
    end;
  end;

  return ret_type;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefTypeTransaction2 (type_transaction)

  var ret_type = TYPE_UNDEF;
  var i        = 0;

  while (i < ASize(ATerminal))
    if (type_transaction == ATerminal(i))
      ret_type = TYPE_TERMINAL;
      i = ASize(ATerminal);
    end;
    i = i + 1;
  end;

  if (ret_type == TYPE_UNDEF)
    i = 0;
    while (i < ASize(ABankomat))
      if (type_transaction == ABankomat(i))
        ret_type = TYPE_BANKOMAT;
        i = ASize(ABankomat);
      end;
      i = i + 1;
    end;
  end;

  return ret_type;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefParametersForPart1

  var stat;
  var stat_link;
  var stat_tran;
  var counter = 0;
  var i       = 0;
  var summa   = $0L;
  var cod_cur = 0;
  var type    = TYPE_UNDEF;
  var num_elem;

  while (i < ASize(ABranches))
    /* Цикл по карточкам */
    ClearRecord(scCard);
    scCard.FNCash  = ABranches(i);
    scCard.cardRef = 0;
    stat = GetGE(scCard);
    while (stat)
      if (scCard.FNCash == ABranches(i))
        if (((scCard.cardCloseDate == Date(0,0,0)) OR
             (scCard.cardCloseDate >= BegDate    )   ) AND
            ( scCard.cardOpenDate  <= EndDate        )    )
          counter = counter + 1;
          Message(" Форма 250. Раздел 1. Обрабатывается карточка " + counter + " ...");
          /* Цикл по связям */
          num_elem = DefNumElemForCard();
          AClients(num_elem) = AClients(num_elem) + 1;
          ACards  (num_elem) = ACards  (num_elem) + 1;
          scLink.Clear();
          scLink.rec.FNCash     = scCard.FNCash;
          scLink.rec.cardRef    = scCard.cardRef;
          scLink.rec.cardAccRef = 0;
	  scLink.addFilter("t.t_FNCash = " + string(scCard.FNCash) +
			   " and t.t_cardRef = " + string(scCard.cardRef) );
          stat_link = scLink.GetGE();
          while (stat_link)
            if ((scLink.rec.FNCash  == scCard.FNCash ) AND
                (scLink.rec.cardRef == scCard.cardRef)    )
              /* Цикл по транзакциям */
              scTran.Clear();
              scTran.rec.FNCash         = scLink.rec.FNCash;
              scTran.rec.accCardLinkRef = scLink.rec.accCardLinkRef;
              scTran.rec.authDate       = BegDate;
              scTran.rec.authTime       = Time(0,0,0);
	      scTran.addFilter("t.t_FNCash = " + string(scLink.rec.FNCash) +
			       " and t.t_accCardLinkRef = " + string(scLink.rec.accCardLinkRef) +
			       " and t.t_authDate <= " + sqlDateToStr(EndDate) );
              stat_tran = scTran.GetGE();
              while (stat_tran)
                if ((scTran.rec.FNCash         == scLink.rec.FNCash        ) AND
                    (scTran.rec.accCardLinkRef == scLink.rec.accCardLinkRef) AND
                    (scTran.rec.authDate       <= EndDate              )    )
                  /* Взведение данных по таблице */
                  if (scTran.rec.authKindOp == 2)
                    depositr.rec.Referenc = scLink.rec.cardAccRef;
                    if (depositr.GetEQ())
                      cod_cur = depositr.rec.Code_Currency;
                    else
                      cod_cur = 0;
                    end;
                    summa = TransformSum(scTran.rec.authSum,cod_cur,scTran.rec.authDate,scTran.rec.authTime);
                    type  = DefTypeTransaction(scTran.rec.authTypeCode);
                    /* --------------------- */
                    if (type == TYPE_CASH_RF)
                      if (cod_cur == 0)
                        ACountsNatRF(num_elem) = ACountsNatRF(num_elem) + 1;
                        ASumNatRF   (num_elem) = ASumNatRF   (num_elem) + summa;
                      else
                        ACountsCurRF(num_elem) = ACountsCurRF(num_elem) + 1;
                        ASumCurRF   (num_elem) = ASumCurRF   (num_elem) + summa;
                      end;
                      ADebits(num_elem) = ADebits(num_elem) + summa;
                    /* --------------------- */
                    elif (type == TYPE_CASH_ABRODE)
                      ACountsCurAbr(num_elem) = ACountsCurAbr(num_elem) + 1;
                      ASumCurAbr   (num_elem) = ASumCurAbr   (num_elem) + summa;
                      ADebits(num_elem) = ADebits(num_elem) + summa;
                    /* --------------------- */
                    elif (type == TYPE_SERVICE_RF)
                      if (cod_cur == 0)
                        ACountsNatRFServ(num_elem) = ACountsNatRFServ(num_elem) + 1;
                        ASumNatRFServ   (num_elem) = ASumNatRFServ   (num_elem) + summa;
                      else
                        ACountsCurRFServ(num_elem) = ACountsCurRFServ(num_elem) + 1;
                        ASumCurRFServ   (num_elem) = ASumCurRFServ   (num_elem) + summa;
                      end;
                      ADebits(num_elem) = ADebits(num_elem) + summa;
                    /* --------------------- */
                    elif (type == TYPE_SERVICE_ABRODE)
                      ACountsCurAbrServ(num_elem) = ACountsCurAbrServ(num_elem) + 1;
                      ASumCurAbrServ   (num_elem) = ASumCurAbrServ   (num_elem) + summa;
                      ADebits(num_elem) = ADebits(num_elem) + summa;
                    end;
                  end;
                  stat_tran = scTran.Next();
                else
                  stat_tran = FALSE;
                end;
              end;
	      scTran.dropFilter();
              stat_link = scLink.Next();
            else
              stat_link = FALSE;
            end;
          end;
	  scLink.dropFilter();
        end;
        stat = Next(scCard);
      else
        stat = FALSE;
      end;
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintPart1

  array ANameCard;

  var i                 = 0;
  var NameCard;
  var counter           = 0;
  var SClients          = 0;
  var SCards            = 0;
  var SDebits           = $0L;
  var SCountsNatRF      = 0;
  var SSumNatRF         = $0L;
  var SCountsCurRF      = 0;
  var SSumCurRF         = $0L;
  var SCountsCurAbr     = 0;
  var SSumCurAbr        = $0L;
  var SCountsNatRFServ  = 0;
  var SSumNatRFServ     = $0L;
  var SCountsCurRFServ  = 0;
  var SSumCurRFServ     = $0L;
  var SCountsCurAbrServ = 0;
  var SSumCurAbrServ    = $0L;

  Message(" Форма 250. Раздел 1 ...");

  DefParametersForPart1();

  [ ];
  [        Раздел 1. СВЕДЕНИЯ О СДЕЛКАХ, СОВЕРШЕННЫХ];
  [        С ИСПОЛЬЗОВАНИЕМ КАРТ, ЭМИТИРОВАННЫХ ДЛЯ КЛИЕНТОВ];
  [                КРЕДИТНОЙ ОРГАНИЗАЦИИ (ФИЛИАЛА)];
  [ ];
  [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  [ | N |     В разрезе     |Коли- |Коли-  |  Общая сумма   |          Получение наличных денег          |       Оплата товаров (работ, услуг)        |];
  [ |п/п|      систем       |чество|чество |  сделок при    |                                            |                                            |];
  [ |   |     расчетов      |клиен-|карт в | осуществлении  |                                            |                                            |];
  [ |   |                   |тов,  |исполь-|   расчетов,    -------------------------------------------------------------------------------------------];
  [ |   |                   |ед.   |зова-  |   тыс. руб.    |        в Российской         |  за рубежом  |        в Российской         |      за      |];
  [ |   |                   |      |нии,   |                |          Федерации          |              |          Федерации          |   рубежом    |];
  [ |   |                   |      |шт.    ------------------------------------------------              -------------------------------              |];
  [ |   |                   |      |       |в       |за счет|   в валюте   |      в       |              |   в валюте   |      в       |              |];
  [ |   |                   |      |       |пре-    |предо- |      РФ      |   инвалюте   |              |      РФ      |   инвалюте   |              |];
  [ |   |                   |      |       |делах   |став-  -------------------------------------------------------------------------------------------];
  [ |   |                   |      |       |наличия |ленного|коли-|сум-    |коли-|сум-    |коли-|сум-    |коли-|сум-    |коли-|сум-    |коли-|сум-    |];
  [ |   |                   |      |       |средств |держа- |чест-|ма      |чест |ма      |чест-|ма      |чест-|ма      |чест-|ма      |чест-|ма      |];
  [ |   |                   |      |       |на сче- |телям  |во   |сде-    |во   |сде-    |во   |сде-    |во   |сде-    |во   |сде-    |во   |сде-    |];
  [ |   |                   |      |       |тах     |карт   |сде- |лок,    |сде- |лок,    |сде- |лок,    |сде- |лок,    |сде- |лок,    |сде- |лок,    |];
  [ |   |                   |      |       |держа-  |кредита|лок, |тыс.    |лок, |тыс.    |лок, |тыс.    |лок, |тыс.    |лок, |тыс.    |лок, |тыс.    |];
  [ |   |                   |      |       |телей   |       |шт.  |руб.    |шт.  |руб.    |шт.  |руб.    |шт.  |руб.    |шт.  |руб.    |шт.  |руб.    |];
  [ |   |                   |      |       |карт    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
  [ |   |                   |      |       |или     |       |     |        |     |        |     |        |     |        |     |        |     |        |];
  [ |   |                   |      |       |сумм    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
  [ |   |                   |      |       |"оверд- |       |     |        |     |        |     |        |     |        |     |        |     |        |];
  [ |   |                   |      |       |рафта"  |       |     |        |     |        |     |        |     |        |     |        |     |        |];
  [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  [ | 1 |         2         |  3   |   4   |   5    |   6   |  7  |    8   |  9  |   10   | 11  |   12   | 13  |   14   |  15 |   16   |  17 |   18   |];
  [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  [ |                                              I. Физические лица                                                                                 |];
  [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  while (i < ASize(ACardTypes))
    if ((AClients(i) > 0) OR
        (ACards  (i) > 0)   )
      counter  = counter + 1;
      SClients          = SClients          + AClients         (i);
      SCards            = SCards            + ACards           (i);
      SDebits           = SDebits           + ADebits          (i);
      SCountsNatRF      = SCountsNatRF      + ACountsNatRF     (i);
      SSumNatRF         = SSumNatRF         + ASumNatRF        (i);
      SCountsCurRF      = SCountsCurRF      + ACountsCurRF     (i);
      SSumCurRF         = SSumCurRF         + ASumCurRF        (i);
      SCountsCurAbr     = SCountsCurAbr     + ACountsCurAbr    (i);
      SSumCurAbr        = SSumCurAbr        + ASumCurAbr       (i);
      SCountsNatRFServ  = SCountsNatRFServ  + ACountsNatRFServ (i);
      SSumNatRFServ     = SSumNatRFServ     + ASumNatRFServ    (i);
      SCountsCurRFServ  = SCountsCurRFServ  + ACountsCurRFServ (i);
      SSumCurRFServ     = SSumCurRFServ     + ASumCurRFServ    (i);
      SCountsCurAbrServ = SCountsCurAbrServ + ACountsCurAbrServ(i);
      SSumCurAbrServ    = SSumCurAbrServ    + ASumCurAbrServ   (i);

      KeyNum(scCodif,1);
      scCodif.codType = 7;
      scCodif.codCode = ACardTypes(i);
      scCodif.psRef   = APos(i);
      if (GetEQ(scCodif))
        NameCard     = scCodif.codUserCode;
        StrSplit(scCodif.codName,ANameCard,19,19,2);
      else
        NameCard     = ACardTypes(i);
        ANameCard(0) = "";
        ANameCard(1) = "";
      end;                                                            
      [ | # |Всего по #         |##### | ##### |########|       |#####|########|#####|########|#####|########|#####|########|#####|########|#####|########|](String(counter),NameCard,AClients(i),ACards(i),ADebits(i):8:2,ACountsNatRF(i),ASumNatRF(i):8:2,ACountsCurRF(i),ASumCurRF(i):8:2,ACountsCurAbr(i),ASumCurAbr(i):8:2,ACountsNatRFServ(i),ASumNatRFServ(i):8:2,ACountsCurRFServ(i),ASumCurRFServ(i):8:2,ACountsCurAbrServ(i),ASumCurAbrServ(i):8:2);
      [ |   |#                  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |](ANameCard(0));
      [ |   |#                  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |](ANameCard(1));
      [ |   |      из них:      |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |- расчетные карты: |##### | ##### |########|   х   |#####|########|#####|########|#####|########|#####|########|#####|########|#####|########|](AClients(i),ACards(i),ADebits(i):8:2,ACountsNatRF(i),ASumNatRF(i):8:2,ACountsCurRF(i),ASumCurRF(i):8:2,ACountsCurAbr(i),ASumCurAbr(i):8:2,ACountsNatRFServ(i),ASumNatRFServ(i):8:2,ACountsCurRFServ(i),ASumCurRFServ(i):8:2,ACountsCurAbrServ(i),ASumCurAbrServ(i):8:2);
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |      из них:      |      |       |        |   х   |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    предавторизо-  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    ванные карты   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |- кредитные карты  |      |       |   х    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |      из них:      |      |       |   х    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    предавторизо-  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    ванные карты   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
    end;
    i = i + 1;
  end;
  if (counter > 0)
      [ |   |Итого по физическим|##### | ##### |########|       |#####|########|#####|########|#####|########|#####|########|#####|########|#####|########|](SClients,SCards,SDebits:8:2,SCountsNatRF,SSumNatRF:8:2,SCountsCurRF,SSumCurRF:8:2,SCountsCurAbr,SSumCurAbr:8:2,SCountsNatRFServ,SSumNatRFServ:8:2,SCountsCurRFServ,SSumCurRFServ:8:2,SCountsCurAbrServ,SSumCurAbrServ:8:2);
      [ |   |лицам:             |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  else
      [ | 1 |Всего по           |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |                   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |                   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |      из них:      |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |- расчетные карты: |      |       |        |   х   |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |      из них:      |      |       |        |   х   |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    предавторизо-  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    ванные карты   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |- кредитные карты  |      |       |   х    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |      из них:      |      |       |   х    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    предавторизо-  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    ванные карты   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |Итого по физическим|      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |лицам:             |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  end;
      [ |                                             II. Юридические лица                                                                                |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ | 1 |Всего по           |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |                   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |                   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |      из них:      |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |- расчетные корпо- |      |       |        |   х   |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |ративные карты:    |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |      из них:      |      |       |        |   х   |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    предавторизо-  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    ванные карты   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |- кредитные корпо- |      |       |   х    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |ративные карты:    |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |      из них:      |      |       |   х    |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    предавторизо-  |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |    ванные карты   |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
      [ |   |Итого по юридичес- |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |   |ким лицам:         |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  if (counter > 0)
      [ |    Итого по кредитной |##### | ##### |########|       |#####|########|#####|########|#####|########|#####|########|#####|########|#####|########|](SClients,SCards,SDebits:8:2,SCountsNatRF,SSumNatRF:8:2,SCountsCurRF,SSumCurRF:8:2,SCountsCurAbr,SSumCurAbr:8:2,SCountsNatRFServ,SSumNatRFServ:8:2,SCountsCurRFServ,SSumCurRFServ:8:2,SCountsCurAbrServ,SSumCurAbrServ:8:2);
      [ |    организации        |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |    (филиалу)          |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  else
      [ |    Итого по кредитной |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |    организации        |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ |    (филиалу)          |      |       |        |       |     |        |     |        |     |        |     |        |     |        |     |        |];
      [ ---------------------------------------------------------------------------------------------------------------------------------------------------];
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintPart2

  Message(" Форма 250. Раздел 2 ...");

  [ ];
  [        Раздел 2. СВЕДЕНИЯ ОБ ИНФРАСТРУКТУРЕ КРЕДИТНОЙ];
  [        ОРГАНИЗАЦИИ (ФИЛИАЛА), ПРЕДНАЗНАЧЕННОЙ ДЛЯ ВЫДАЧИ];
  [        НАЛИЧНЫХ ДЕНЕЖНЫХ СРЕДСТВ И ОСУЩЕСТВЛЕНИЯ РАСЧЕТОВ];
  [                С ИСПОЛЬЗОВАНИЕМ ПЛАТЕЖНЫХ, В ТОМ ЧИСЛЕ];
  [                        БАНКОВСКИХ, КАРТ];
  [ ];
  [ ----------------------------------------------------------------------------------------];
  [ |N |Наимено-|       Для выдачи наличных денег       |Для совершения сделок в торгово - |];
  [ |п/|вание и |                                       |           сервисной сети         |];
  [ |п |код сис-----------------------------------------------------------------------------];
  [ |  |темы    |общее | из них |количе-|количе-|количе-|общее    | из них |количе-|количе-|];
  [ |  |расчетов|коли- ----------ство   |ство   |ство   |количес- ----------ство   |ство   |];
  [ |  |        |чество|оборудо-|элект- |банко- |имприн-|тво тор- |оборудо-|элект- |имприн-|];
  [ |  |        |ПВН   |ванных  |ронных |матов  |теров  |гово -   |ванных  |ронных |теров  |];
  [ |  |        |      |электро-|терми- |       |       |сервисных|электро-|терми- |       |];
  [ |  |        |      |нными   |налов  |       |       |точек    |нными   |налов  |       |];
  [ |  |        |      |термина-|       |       |       |         |термина-|       |       |];
  [ |  |        |      |лами    |       |       |       |         |лами    |       |       |];
  [ ----------------------------------------------------------------------------------------];
  [ |1 |   2    |   3  |   4    |   5   |   6   |   7   |    8    |    9   |   10  |   11  |];
  [ ----------------------------------------------------------------------------------------];
  [ |1 |        |      |        |       |       |       |         |        |       |       |];
  [ ----------------------------------------------------------------------------------------];
  [ |2 |        |      |        |       |       |       |         |        |       |       |];
  [ ----------------------------------------------------------------------------------------];
  [ |3 |        |      |        |       |       |       |         |        |       |       |];
  [ ----------------------------------------------------------------------------------------];
  [ |                     Итого по кредитной организации (филиалу)                         |];
  [ ----------------------------------------------------------------------------------------];
  [ |х |        |      |        |       |       |       |         |        |       |       |];
  [ ----------------------------------------------------------------------------------------];
  
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro IsForeignBank

  return FALSE;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefParametersForPart3

  var stat;
  var stat_link;
  var stat_tran;
  var counter = 0;
  var i       = 0;
  var j       = 0;
  var summa   = $0L;
  var cod_cur = 0;
  var type    = TYPE_UNDEF;
  var type2   = TYPE_UNDEF;
  var num_elem;
  var tm;

  while (i < ASize(ABranches))
    /* Цикл по карточкам */
    ClearRecord(scCard);
    scCard.FNCash  = ABranches(i);
    scCard.cardRef = 0;
    stat = GetGE(scCard);
    while (stat)
      if (scCard.FNCash == ABranches(i))
        if (((scCard.cardCloseDate == Date(0,0,0)) OR
             (scCard.cardCloseDate >= BegDate    )   ) AND
            ( scCard.cardOpenDate  <= EndDate        )    )
          counter = counter + 1;
          Message(" Форма 250. Раздел 3. Обрабатывается карточка " + counter + " ...");
          /* Цикл по связям */
          num_elem = DefNumElemForCard();
          scLink.Clear();
          scLink.rec.FNCash     = scCard.FNCash;
          scLink.rec.cardRef    = scCard.cardRef;
          scLink.rec.cardAccRef = 0;
          stat_link = scLink.GetGE();
          while (stat_link)
            if ((scLink.rec.FNCash  == scCard.FNCash ) AND
                (scLink.rec.cardRef == scCard.cardRef)    )
              /* Цикл по транзакциям */
              scTran.Clear();
              scTran.rec.FNCash         = scLink.rec.FNCash;
              scTran.rec.accCardLinkRef = scLink.rec.accCardLinkRef;
              scTran.rec.authDate       = BegDate;
              scTran.rec.authTime       = Time(0,0,0);
              stat_tran = scTran.GetGE();
              while (stat_tran)
                if ((scTran.rec.FNCash         == scLink.rec.FNCash        ) AND
                    (scTran.rec.accCardLinkRef == scLink.rec.accCardLinkRef) AND
                    (scTran.rec.authDate       <= EndDate              )    )
                  /* Взведение данных по таблице */
                  if (scTran.rec.authKindOp == 2)
                    depositr.rec.Referenc = scLink.rec.cardAccRef;
                    if (depositr.GetEQ())
                      cod_cur = depositr.rec.Code_Currency;
                    else
                      cod_cur = 0;
                    end;
                    summa = TransformSum(scTran.rec.authSum,cod_cur,scTran.rec.authDate,scTran.rec.authTime);
                    type  = DefTypeTransaction(scTran.rec.authTypeCode);
                    /* --------------------- */
                    if ((type == TYPE_SERVICE_RF    ) OR
                        (type == TYPE_SERVICE_ABRODE)   )
                      ACountServ(num_elem) = ACountServ(num_elem) + 1;
                      ASummaServ(num_elem) = ASummaServ(num_elem) + summa;
                      type2 = DefTypeTransaction2(scTran.rec.authTypeCode);
                      if (type2 == TYPE_TERMINAL)
                        ACountServET(num_elem) = ACountServET(num_elem) + 1;
                        ASummaServET(num_elem) = ASummaServET(num_elem) + summa;
                      end;
                    /* --------------------- */
                    elif ((type == TYPE_CASH_RF    ) OR 
                          (type == TYPE_CASH_ABRODE)   )
                      if (cod_cur == 0)
                        ACountPVNB(num_elem)   = ACountPVNB(num_elem) + 1;
                        ASummaPVNB(num_elem)   = ASummaPVNB(num_elem) + summa;
                        type2 = DefTypeTransaction2(scTran.rec.authTypeCode);
                        if (type2 == TYPE_TERMINAL)
                          ACountPVNBET(num_elem) = ACountPVNBET(num_elem) + 1;
                          ASummaPVNBET(num_elem) = ASummaPVNBET(num_elem) + summa;
                        elif (type2 == TYPE_BANKOMAT)
                          ACountPVNBB(num_elem)  = ACountPVNBB(num_elem) + 1;
                          ASummaPVNBB(num_elem)  = ASummaPVNBB(num_elem) + summa;
                        end;
                      else
                        ACountPVNBCur(num_elem) = ACountPVNBCur(num_elem) + 1;
                        ASummaPVNBCur(num_elem) = ASummaPVNBCur(num_elem) + summa;
                        type2 = DefTypeTransaction2(scTran.rec.authTypeCode);
                        if (type2 == TYPE_TERMINAL)
                          ACountPVNBETCur(num_elem) = ACountPVNBETCur(num_elem) + 1;
                          ASummaPVNBETCur(num_elem) = ASummaPVNBETCur(num_elem) + summa;
                        elif (type2 == TYPE_BANKOMAT)
                          ACountPVNBBCur(num_elem)  = ACountPVNBBCur(num_elem) + 1;
                          ASummaPVNBBCur(num_elem)  = ASummaPVNBBCur(num_elem) + summa;
                        end;
                      end;
                    end;
                  end;
                  stat_tran = scTran.Next();
                else
                  stat_tran = FALSE;
                end;
              end;
              stat_link = scLink.Next();
            else
              stat_link = FALSE;
            end;
          end;
        end;
        stat = Next(scCard);
      else
        stat = FALSE;
      end;
    end;
    i = i + 1;
  end;

  /* Цикл по эквайринговым операциям */
  i = 0;
  Message(" Форма 250. Раздел 3. Обрабатываются эквайринговые операции ...");
  while (i < ASize(ABranches))
    j = 0;
    while (j <= 1)
      scAcqu.Clear();
      scAcqu.rec.FlagCur = j;
      scAcqu.rec.FNCash  = ABranches(i);
      scAcqu.rec.acqDate = BegDate;
      scAcqu.rec.acqTime = Time(0,0,0);
      stat = scAcqu.GetGE();
      while (stat)
        if ((scAcqu.rec.FlagCur == j           ) OR
            (scAcqu.rec.FNCash  == ABranches(i)) OR
            (scAcqu.rec.acqDate <= EndDate     )   )
          ClearRecord(scCard);
          scCard.cardTypeCode = scAcqu.rec.cardTypeCode;
          scCard.psRef        = scAcqu.rec.psRef;
          num_elem = DefNumElemForCard();
          pay_doc.Clear();
          pay_doc.rec.iApplicationKind = scAcqu.rec.PayDocApplKind;
          pay_doc.rec.ApplicationKey   = scAcqu.rec.PayDocApplKey;
          if (pay_doc.GetEQ())
            if ( ( pay_doc.rec.Action < 2 ) and ( ( pay_doc.rec.IsSuspended == "" ) or ( pay_doc.rec.IsSuspended == "X" ) ) )
              if( pay_doc.rec.ApplicationKey != "" )
                tm = Time( int( substr( pay_doc.rec.ApplicationKey, 11, 2 ) ),
                           int( substr( pay_doc.rec.ApplicationKey, 13, 2 ) ),
                           int( substr( pay_doc.rec.ApplicationKey, 15, 2 ) ) );
              else
                tm = null;
              end;
              summa = TransformSum(pay_doc.rec.InSum,pay_doc.rec.CodCur,pay_doc.rec.Date_Document, tm);
              if (IsForeignBank())
                if (pay_doc.rec.CodCur == 0)
                  ACountPVNBNRes(num_elem) = ACountPVNBNRes(num_elem) + 1;
                  ASummaPVNBNRes(num_elem) = ASummaPVNBNRes(num_elem) + summa;
                else
                  ACountPVNBCurNRes(num_elem) = ACountPVNBCurNRes(num_elem) + 1;
                  ASummaPVNBCurNRes(num_elem) = ASummaPVNBCurNRes(num_elem) + summa;
                end;
              else
                if (pay_doc.rec.CodCur == 0)
                  ACountPVNBRes(num_elem) = ACountPVNBRes(num_elem) + 1;
                  ASummaPVNBRes(num_elem) = ASummaPVNBRes(num_elem) + summa;
                else
                  ACountPVNBCurRes(num_elem) = ACountPVNBCurRes(num_elem) + 1;
                  ASummaPVNBCurRes(num_elem) = ASummaPVNBCurRes(num_elem) + summa;
                end;
              end;
            end;
          end;
          stat = scAcqu.Next();
        else
          stat = FALSE;
        end;
      end;
      j = j + 1;
    end;
    i = i + 1;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintPart3

  array ANameCard;

  var i               = 0;
  var NameCard;
  var counter         = 0;
  var Scounter        = 0;
  var SCountServ      = 0;
  var SSummaServ      = $0L;
  var SCountServET    = 0;
  var SSummaServET    = $0L;
  var SCountPVNB      = 0;
  var SSummaPVNB      = $0L;
  var SCountPVNBB     = 0;
  var SSummaPVNBB     = $0L;
  var SCountPVNBET    = 0;
  var SSummaPVNBET    = $0L;
  var SCountPVNBCur   = 0;
  var SSummaPVNBCur   = $0L;
  var SCountPVNBBCur  = 0;
  var SSummaPVNBBCur  = $0L;
  var SCountPVNBETCur = 0;
  var SSummaPVNBETCur = $0L;
   
  Message(" Форма 250. Раздел 3 ...");

  DefParametersForPart3();

  [ ];
  [        Раздел 3. СВЕДЕНИЯ О СДЕЛКАХ, СОВЕРШЕННЫХ];
  [        В ТОРГОВО - СЕРВИСНОЙ СЕТИ, И ОПЕРАЦИЯХ ПО ВЫДАЧЕ];
  [        НАЛИЧНЫХ ДЕНЕЖНЫХ СРЕДСТВ С ИСПОЛЬЗОВАНИЕМ ПЛАТЕЖНЫХ,];
  [                В ТОМ ЧИСЛЕ БАНКОВСКИХ, КАРТ];
  [ ];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  [ |N |Наименова-  |                            Количество и сумма сделок, совершенных с использованием карт                               |];
  [ |п/|ние и код   -------------------------------------------------------------------------------------------------------------------------];
  [ |п |системы     |    в торгово - сервисной    |                             при выдаче наличных денег                                   |];
  [ |  |расчетов    |            сети             |                                                                                         |];
  [ |  |            -------------------------------------------------------------------------------------------------------------------------];
  [ |  |            |   по всем    |   из них     |        в валюте Российской Федерации       |           в иностранной валюте             |];
  [ |  |            |   торгово -  ----------------                                            |                                            |];
  [ |  |            |  сервисным   |оборудо-      |                                            |                                            |];
  [ |  |            |    точкам    |ванных        |                                            |                                            |];
  [ |  |            |              |электронными  |                                            |                                            |];
  [ |  |            |              |терминалами   |                                            |                                            |];
  [ |  |            -------------------------------------------------------------------------------------------------------------------------];
  [ |  |            |коли- |сумма  |коли- |сумма  |   в ПВН и    |           из них            |    в ПВН и   |           из них            |];
  [ |  |            |чество|сде-   |чество|сде-   |  банкоматах  |                             |  банкоматах  |                             |];
  [ |  |            |сде-  |лок,   |сде-  |лок,   -------------------------------------------------------------------------------------------];
  [ |  |            |лок,  |тыс.   |лок,  |тыс.   |коли- |сумма  | в банкоматах |с исполь-     |коли- |сумма  | в банкоматах |с исполь-     |];
  [ |  |            |шт.   |руб.   |шт.   |руб.   |чество|сде-   |              |зованием      |чество|сде-   |              |зованием      |];
  [ |  |            |      |       |      |       |сде-  |лок,   |              |электронных   |сде-  |лок,   |              |электронных   |];
  [ |  |            |      |       |      |       |лок,  |тыс.   |              |терминалов    |лок,  |тыс.   |              |терминалов    |];
  [ |  |            |      |       |      |       |шт.   |руб.   -------------------------------шт.   |руб.   -------------------------------];
  [ |  |            |      |       |      |       |      |       |коли- |сумма  |коли- |сумма  |      |       |коли- |сумма  |коли- |сумма  |];
  [ |  |            |      |       |      |       |      |       |чество|сде-   |чество|сде-   |      |       |чество|сде-   |чество|сде-   |];
  [ |  |            |      |       |      |       |      |       |сде-  |лок,   |сде-  |лок,   |      |       |сде-  |лок,   |сде-  |лок,   |];
  [ |  |            |      |       |      |       |      |       |лок,  |тыс.   |лок,  |тыс.   |      |       |лок,  |тыс.   |лок,  |тыс.   |];
  [ |  |            |      |       |      |       |      |       |шт.   |руб.   |шт.   |руб.   |      |       |шт.   |руб.   |шт.   |руб.   |];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  [ | 1|      2     |   3  |   4   |  5   |   6   |  7   |   8   |  9   |  10   |  11  |  12   |  13  |  14   |  15  |   16  |  17  |  18   |];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  [ |                         I. С использованием карт, эмитированных данной кредитной организацией (филиалом)                              |];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  while (i < ASize(ACardTypes))
    if ((ACountServ(i) > 0) OR (ACountPVNB(i) > 0) OR (ACountPVNBCur(i) > 0))
      counter  = counter  + 1;
      Scounter = Scounter + 1;

      SCountServ      = SCountServ      + ACountServ(i);
      SSummaServ      = SSummaServ      + ASummaServ(i);
      SCountServET    = SCountServET    + ACountServET(i);
      SSummaServET    = SSummaServET    + ASummaServET(i);
      SCountPVNB      = SCountPVNB      + ACountPVNB(i);
      SSummaPVNB      = SSummaPVNB      + ASummaPVNB(i);
      SCountPVNBB     = SCountPVNBB     + ACountPVNBB(i);
      SSummaPVNBB     = SSummaPVNBB     + ASummaPVNBB(i);
      SCountPVNBET    = SCountPVNBET    + ACountPVNBET(i);
      SSummaPVNBET    = SSummaPVNBET    + ASummaPVNBET(i);
      SCountPVNBCur   = SCountPVNBCur   + ACountPVNBCur(i);
      SSummaPVNBCur   = SSummaPVNBCur   + ASummaPVNBCur(i);
      SCountPVNBBCur  = SCountPVNBBCur  + ACountPVNBBCur(i);
      SSummaPVNBBCur  = SSummaPVNBBCur  + ASummaPVNBBCur(i);
      SCountPVNBETCur = SCountPVNBETCur + ACountPVNBETCur(i);
      SSummaPVNBETCur = SSummaPVNBETCur + ASummaPVNBETCur(i);
     
      KeyNum(scCodif,1);
      scCodif.codType = 7;
      scCodif.codCode = ACardTypes(i);
      scCodif.psRef   = APos(i);
      if (GetEQ(scCodif))
        NameCard     = scCodif.codUserCode;
        StrSplit(scCodif.codName,ANameCard,12,12,2);
      else
        NameCard     = ACardTypes(i);
        ANameCard(0) = "";
        ANameCard(1) = "";
      end;                                                            

      [ |##|#           |##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|](counter,ANameCard(0),ACountServ(i),ASummaServ(i):7:2,ACountServET(i),ASummaServET(i):7:2,ACountPVNB(i),ASummaPVNB(i):7:2,ACountPVNBB(i),ASummaPVNBB(i):7:2,ACountPVNBET(i),ASummaPVNBET(i):7:2,ACountPVNBCur(i),ASummaPVNBCur(i):7:2,ACountPVNBBCur(i),ASummaPVNBBCur(i):7:2,ACountPVNBETCur(i),ASummaPVNBETCur(i):7:2);
      if (ANameCard(1) != "")
        [ |  |#           |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |](ANameCard(1));
      end;
      [ -----------------------------------------------------------------------------------------------------------------------------------------];
    end;
    i = i + 1;
  end;
  if (counter > 0)
    ;
  else
    [ | 1|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
    [ | 2|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
    [ | 3|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
  end;
  [ |                                     II. С использованием карт других эмитентов - резидентов                                           |];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  i = 0;
  counter = 0;
  while (i < ASize(ACardTypes))
    if ((ACountPVNBRes(i) > 0) OR (ACountPVNBCurRes(i) > 0))
      counter  = counter  + 1;
      Scounter = Scounter + 1;

      SCountPVNB    = SCountPVNB    + ACountPVNBRes(i);
      SSummaPVNB    = SSummaPVNB    + ASummaPVNBRes(i);
      SCountPVNBCur = SCountPVNBCur + ACountPVNBCurRes(i);
      SSummaPVNBCur = SSummaPVNBCur + ASummaPVNBCurRes(i);

      KeyNum(scCodif,1);
      scCodif.codType = 7;
      scCodif.codCode = ACardTypes(i);
      scCodif.psRef   = APos(i);
      if (GetEQ(scCodif))
        NameCard     = scCodif.codUserCode;
        StrSplit(scCodif.codName,ANameCard,12,12,2);
      else
        NameCard     = ACardTypes(i);
        ANameCard(0) = "";
        ANameCard(1) = "";
      end;                                                            

      [ |##|#           |      |       |      |       |##### |#######|      |       |      |       |##### |#######|      |       |      |       |](counter,ANameCard(0),ACountPVNBRes(i),ASummaPVNBRes(i):7:2,ACountPVNBCurRes(i),ASummaPVNBCurRes(i):7:2);
      if (ANameCard(1) != "")
        [ |  |#           |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |](ANameCard(1));
      end;
      [ -----------------------------------------------------------------------------------------------------------------------------------------];
    end;
    i = i + 1;
  end;
  if (counter > 0)
    ;
  else
    [ | 1|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
    [ | 2|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
    [ | 3|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
  end;
  [ |                                    III. С использованием карт, эмитированных нерезидентами                                            |];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  i = 0;
  counter = 0;
  while (i < ASize(ACardTypes))
    if ((ACountPVNBNRes(i) > 0) OR (ACountPVNBCurNRes(i) > 0))
      counter  = counter  + 1;
      Scounter = Scounter + 1;

      SCountPVNB    = SCountPVNB    + ACountPVNBNRes(i);
      SSummaPVNB    = SSummaPVNB    + ASummaPVNBNRes(i);
      SCountPVNBCur = SCountPVNBCur + ACountPVNBCurNRes(i);
      SSummaPVNBCur = SSummaPVNBCur + ASummaPVNBCurNRes(i);

      KeyNum(scCodif,1);
      scCodif.codType = 7;
      scCodif.codCode = ACardTypes(i);
      scCodif.psRef   = APos(i);
      if (GetEQ(scCodif))
        NameCard     = scCodif.codUserCode;
        StrSplit(scCodif.codName,ANameCard,12,12,2);
      else
        NameCard     = ACardTypes(i);
        ANameCard(0) = "";
        ANameCard(1) = "";
      end;                                                            

      [ |##|#           |      |       |      |       |##### |#######|      |       |      |       |##### |#######|      |       |      |       |](counter,ANameCard(0),ACountPVNBNRes(i),ASummaPVNBNRes(i):7:2,ACountPVNBCurNRes(i),ASummaPVNBCurNRes(i):7:2);
      if (ANameCard(1) != "")
        [ |  |#           |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |](ANameCard(1));
      end;
      [ -----------------------------------------------------------------------------------------------------------------------------------------];
    end;
    i = i + 1;
  end;
  if (counter > 0)
    ;
  else
    [ | 1|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
    [ | 2|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
    [ | 3|            |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
  end;
  [ |                                            Итого по кредитной организации (филиалу)                                                   |];
  [ -----------------------------------------------------------------------------------------------------------------------------------------];
  if (Scounter > 0)
    [ |х |     х      |##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|##### |#######|](SCountServ,SSummaServ:7:2,SCountServET,SSummaServET:7:2,SCountPVNB,SSummaPVNB:7:2,SCountPVNBB,SSummaPVNBB:7:2,SCountPVNBET,SSummaPVNBET:7:2,SCountPVNBCur,SSummaPVNBCur:7:2,SCountPVNBBCur,SSummaPVNBBCur:7:2,SCountPVNBETCur,SSummaPVNBETCur:7:2);
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
  else
    [ |х |     х      |      |       |      |       |      |       |      |       |      |       |      |       |      |       |      |       |];
    [ -----------------------------------------------------------------------------------------------------------------------------------------];
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintPart4

  Message(" Форма 250. Раздел 4 ...");

  [ ];
  [        Раздел 4. СВЕДЕНИЯ ОБ ИСПОЛЬЗОВАНИИ СЕТЕЙ,];
  [              ПРИНАДЛЕЖАЩИХ ДРУГИМ ЮРИДИЧЕСКИМ ЛИЦАМ];
  [ ];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | N |                              Наименование юридического лица, управляющего сетью                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ |                                   I. Для выдачи наличных денежных средств                                    |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | 1 |                                                                                                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | 2 |                                                                                                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | 3 |                                                                                                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ |                            II. Для совершения сделок в торгово - сервисной сети                              |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | 1 |                                                                                                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | 2 |                                                                                                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
  [ | 3 |                                                                                                          |];
  [ ----------------------------------------------------------------------------------------------------------------];
      
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintBottom

  var NamePerson = "";

  ClearRecord(person);
  person.Oper = {oper};
  if (GetEQ(person))
    NamePerson = person.Name;
  end;

  [ ];
  [ Руководитель                                          (Ф.И.О.)];
  [ ];
  [ Исполнитель  #                                        (Ф.И.О.)](NamePerson);
  [ ];
  [ Телефон:];
  [ ];
  [ "__" _________ ____ г.];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ListBranch

  array ABranch;
  array ANumber;

  var stat;
  var i = 0;
  var name;

  var dpDepList = TdpDepList;
  var filialID = dpDepList.getFilialID(NumFNCash());
  dpDepList.SetFilter(filialID);
  while (dpDepList.next())
    i = ASize(ABranch);
    ANumber(i) = dpDepList.rec.Code;
    ABranch(i) = " " + dpDepList.rec.Name + "            ";
  end;

  if (ASize(ABranch))
    i = Menu(ABranch,NULL,"Подразделения");
    if (i >= 0)
      Branch = ANumber(i);
      FORM250.NameBranch = Trim(ABranch(i));
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ListQuartal

  array ANumber;

  var i = 0;

  while (i < 4)
   ANumber(i) = " " + String(i + 1) + " квартал  ";
   i = i + 1;
  end;

  if (ASize(ANumber))
    i = Menu(ANumber,NULL,"Кварталы",40,13);
    if (i >= 0)
      FORM250.Quartal = i + 1;;
    end;
  end;


end;


/**************************************************************************\
|               Обработка нажатия клавишей в панели диалога                |
\**************************************************************************/
macro WorkDialogFORM250 (IP, cmd, id, codekey)

  var stat = CM_DEFAULT;

  if (cmd == DLG_KEY)
    if (codekey == 13)
      if (id == ne_Year)
        SetFocus(IP,ne_NameBranch);
        stat = CM_IGNORE;
      end;
    elif (codekey == 27)
      stat = CM_CANCEL;
    elif (codekey == 317)
      if (id == ne_NameBranch)
        ListBranch();
      elif (id == ne_Quartal)
        ListQuartal();
      end;
    elif (codekey == 321)
      stat = CM_SAVE;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InputReportData

  var stat;
  var d,m,y;
  var DateReport = {curdate};

  if (DateReport == Date(0,0,0))
    DateReport = Date();
  end;

  DateSplit(DateReport,d,m,y);
  if ((m >= 1) AND (m <= 3))
    FORM250.Quartal = 4;
    FORM250.Year    = y - 1;
  elif ((m >= 4) AND (m <= 6))
    FORM250.Quartal = 1;
    FORM250.Year    = y;
  elif ((m >= 7) AND (m <= 9))
    FORM250.Quartal = 2;
    FORM250.Year    = y;
  else
    FORM250.Quartal = 3;
    FORM250.Year    = y;
  end;

  if (not findDepartment(Branch, FORM250.NameBranch))
    FORM250.NameBranch = String(Branch);
  end;

  stat = RunDialog(FORM250,"WorkDialogFORM250");

  if (stat)
    if (FORM250.Quartal == 1)
      BegDate = Date( 1, 1,FORM250.Year);
      EndDate = Date(31, 3,FORM250.Year);
    elif (FORM250.Quartal == 2)
      BegDate = Date( 1, 4,FORM250.Year);
      EndDate = Date(30, 6,FORM250.Year);
    elif (FORM250.Quartal == 3)
      BegDate = Date( 1, 7,FORM250.Year);
      EndDate = Date(30, 9,FORM250.Year);
    else
      BegDate = Date( 1,10,FORM250.Year);
      EndDate = Date(31,12,FORM250.Year);
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefCardTypes

  var i;
  var stat;

  ClearRecord(scCodif);
  scCodif.codType     = 7;
  scCodif.psRef       = 0;
  scCodif.codUserCode = "";

  stat = GetGE(scCodif);
  while (stat)
    if (scCodif.codType == 7)
      i = ASize(ACardTypes);
      ACardTypes       (i) = scCodif.codCode;
      APos             (i) = scCodif.psRef;
      /* Для раздела 1 */
      AClients         (i) = 0;
      ACards           (i) = 0;
      ADebits          (i) = $0L;
      ACountsNatRF     (i) = 0;  ASumNatRF        (i) = $0L;
      ACountsCurRF     (i) = 0;  ASumCurRF        (i) = $0L;
      ACountsCurAbr    (i) = 0;  ASumCurAbr       (i) = $0L;
      ACountsNatRFServ (i) = 0;  ASumNatRFServ    (i) = $0L;
      ACountsCurRFServ (i) = 0;  ASumCurRFServ    (i) = $0L;
      ACountsCurAbrServ(i) = 0;  ASumCurAbrServ   (i) = $0L;
      /* Для раздела 3 */
      ACountServ       (i) = 0;  ASummaServ       (i) = $0L;
      ACountServET     (i) = 0;  ASummaServET     (i) = $0L;
      ACountPVNB       (i) = 0;  ASummaPVNB       (i) = $0L;
      ACountPVNBB      (i) = 0;  ASummaPVNBB      (i) = $0L;
      ACountPVNBET     (i) = 0;  ASummaPVNBET     (i) = $0L;
      ACountPVNBCur    (i) = 0;  ASummaPVNBCur    (i) = $0L;
      ACountPVNBBCur   (i) = 0;  ASummaPVNBBCur   (i) = $0L;
      ACountPVNBETCur  (i) = 0;  ASummaPVNBETCur  (i) = $0L;
      ACountPVNBRes    (i) = 0;  ASummaPVNBRes    (i) = $0L;
      ACountPVNBCurRes (i) = 0;  ASummaPVNBCurRes (i) = $0L;
      ACountPVNBNRes   (i) = 0;  ASummaPVNBNRes   (i) = $0L;
      ACountPVNBCurNRes(i) = 0;  ASummaPVNBCurNRes(i) = $0L;
      stat = Next(scCodif);
    else
      stat = FALSE;
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefBranches

  var i;
  var stat;
  var ddep = TRecHandler( "i_dp_dep.rec" );
  var dpDepList = TdpDepList;
  var filialID;
  
  if (findDepartment(Branch, null, ddep))
    if (ddep.rec.NodeType == I_DEPARTMENT_TYPE_FILIAL)
      filialID = dpDepList.getFilialID(Branch);
      dpDepList.SetFilter(filialID);
      while (dpDepList.next())
        i = ASize(ABranches);
        ABranches(i) = dpDepList.rec.Code;
      end;
    else
      ABranches(0) = Branch;
    end;
  else
    ABranches(0) = Branch;
  end;
      
end;


/**************************************************************************\
|                    Г Л А В Н А Я   П Р О Г Р А М М А                     |
\**************************************************************************/

  if (InputReportData())
    DefCardTypes();
    DefBranches();
    PrintHead();
    PrintPart1();
    PrintPart2();
    PrintPart3();
    PrintPart4();
    PrintBottom();
  else
    Exit(1);
  end;

end;
