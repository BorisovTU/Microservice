/**************************************************************************\
*  ---------------                                                         *
*  R-Style Softlab                                                         *
*  ---------------                                                         *
*  RS-Retail                                                               *
*  Эмитент                                                                 *
*                                                                          *
*  Система автоматического обмена информацией между Эмитентом и            *
*  Процессинговым центром СберБанка в формате UniCard                      *
*                                                                          *
*  Формирование выходного файла по                                         *
*    - клиентам                                                            *
*    - открываемым счетам и картам                                         *
*    - блокированным и перевыпускаемым картам                              *
*    - приходам/расходам по карточным счетам                               *
*                                                                          *
*  Лебедев С.В.                                                            *
*  26.02.1999                                                              *
\**************************************************************************/

import spCardInter, "sb_comm.mac", "sb_err.mac", sqlconv, rsd, "cb_sql.mac";

private var {curdate}, {oper};
/*-------------------- Файлы для работы программы ------------------*/
file sc_codif ( scCodif, "spcard.def" );                              /* Кодификатор           */
file curr     ( currency );                                           /* Справочник валют      */
file dr       ( depositr );                                           /* Счета вкладчиков      */
file sbdepdoc ( sbdepdoc );
file FSCAcqu  ( scAcqu );
file FSCCard  ( sccard );
var scCard    = TBFile( "scCard.dbt",   "w", 0, NULL, "spcard.def" ); /* Пластиковые карточки  */
var scAcc     = TBFile( "scAcc.dbt",    "r", 0, NULL, "spcard.def" ); /* Карточные счета       */
var scLink    = TBFile( "scLink.dbt",   "w", 0, NULL, "spcard.def" ); /* Связи Карточка - Счет */
var scAcqu    = TBFile( "scAcqu.dbt",   "w", 0, NULL, "spcard.def" ); /* Транзакции эквайринга */
var scMail    = TBFile( "scMail.dbt",   "w", 0, NULL, "spcard.def" ); /* Сеансы связи          */
var scMailIt  = TBFile( "scMailIt.dbt", "w", 0, NULL, "spcard.def" ); /* Расшифровки сеансов   */
var sc_to_pc  = TBFile( "sc_to_pc.dbt", "w", 0, NULL, "sc_user.def"); /* Неотправленные в ПЦ   */
var pay_doc   = TBFile( "pay_doc.dbt",  "r", 2 );                     /* Расходные операции    */
var sb_casln  = TBFile( "sb_casln.dbt", "r", 0 );                     /* Связка документов     */
var sbdepdoc5 = TRecHandler( "sbdepdoc.5" );
var pay_docnp = TRecHandler( "pay_doc.np" );
var sbCard    = TRecHandler( "scCard.sb", "sc_user.def" );

var depclnt = TClientList;                                            /* Справочник вкладчиков */
                                                                      
var rsSC;                                                             /* Recordset по sc_to_pc.dbt */
var rsLM;                                                             /* Recordset по sclimit.dbt  */
var SQLStr, RsdSetAcc, RsdSetDepDoc, RsdSet, RsdSetCard, RsdSetLink, RsdSetAcqu;

file OutFile  ()                       txt 300 write; /* Выходной файл для ПЦ  */
file TMPFile1 ()                       txt 300 write; /* Временный файл для ПЦ */
file TMPFile2 ()                       txt 300 write; /* Временный файл для ПЦ */
file TMPFile3 ()                       txt 300 write; /* Временный файл для ПЦ */
file TMPFile4 ()                       txt 300 write; /* Временный файл для ПЦ */
file TMPFile5 ()                       txt 300 write; /* Временный файл для ПЦ */
file TMPFile6 ()                       txt 300 write; /* Временный файл для ПЦ */
file TMPFileR1()                       txt 300;       /* Временный файл для ПЦ */
file TMPFileR2()                       txt 300;       /* Временный файл для ПЦ */
file TMPFileR3()                       txt 300;       /* Временный файл для ПЦ */
file TMPFileR4()                       txt 300;       /* Временный файл для ПЦ */
file TMPFileR5()                       txt 300;       /* Временный файл для ПЦ */
file TMPFileR6()                       txt 300;       /* Временный файл для ПЦ */

/*----------------- Константы для работы программы -----------------*/
const Merger = TRUE;  /*LAA флаг для разделения объединения выходного файла
               TRUE  - объединение информации производится
               FALSE -  объединение информации не происходит. Выходят два файла*/

const Delim  = "\x09"; /* Разделитель между полями     */
const OutLen = 256;    /* Длина строки выходного файла */

const D_AR            = 8;   /* Проводка в архиве                 */
const D_ARC           = 9;   /* Корректировка в архиве            */
const D_AUDIT_STORN   = 14;  /* Сторнирование операции            */
const D_AUDIT_DELETE  = 15;  /* Удаление операции                 */
const D_AUDIT_CORRECT = 16;  /* Корректировка операции            */
const D_DELETE        = 2;   /* Удаленная запись                  */
const AK_DEPSC        = 110; /* Оплата транзакции                 */
const TypeItForLink   = 1;   /* Расшифровка сеанса для заказа     */
const TypeItForCard   = 2;   /* Расшифровка сеанса для блокировки */
const TypeItForTran   = 3;   /* Расшифровка сеанса для транзакций */
const TypeItForAcqu   = 4;   /* Расшифровка сеанса для эквайринга */
const TypeItForLimit  = 5;   /* Расшифровка сеанса для лимитов    */

/*---------------- Переменные для работы программы -----------------*/
var OutFileName      = "";            /* Имя выходного файла               */
var OutShortFileName = "";            /* Имя выходного файла без пути      */
var MaskTMP          = "";            /* Имя временного файла              */
var MailRef          = 0;             /* Референс текущего сеанса связи    */
var GlobalError      = FALSE;         /* Ошибка при записи в выходной файл */
var BegDate          = {curdate} - 7; /* Начальная дата для операций       */
var EndDate          = {curdate};     /* Конечная дата для операций        */
var NumPPTran        = 0;             /* Номер по порядку транзакции       */
var NumPPAcqu        = 0;             /* Номер по порядку эквайера         */
var NumPPCardNew     = 0;             /* Номер по порядку для клиента      */
var NumPPCardBlockOv = 0;             /* Номер по порядку для карточек     */
var NumPPLimit       = 0;             /* Номер по порядку для лимитов      */
var CountAPPLN       = 0;             /* Количество записей типа APPLN     */
var CountCUSTR       = 0;             /* Количество записей типа CUSTR     */
var CountCARD        = 0;             /* Количество записей типа CARD      */
var SummaMoneyUSD    = $0.0L;         /* Сумма транзакций в долларах       */
var SummaMoneyRUB    = $0.0L;         /* Сумма транзакций в рублях         */
var SummaAcquUSD     = $0.0L;         /* Сумма эквайринга в долларах       */
var SummaAcquRUB     = $0.0L;         /* Сумма эквайринга в рублях         */
var DayNumFile       = 0;             /* Номер файла за день               */
var BranchCode; /* Номер ВСП */
private var NameBranch;
private array BranchOut;  /* Список подразделений, из которых была произведена выгрузка */
private array BranchMailRef;  /* Список референсов текущего сеанса связи */

var NumDayInYear;

/* Значения кода режима работы */
private const MODE_NORMAL = 0;      /* Нормальный режим                                    */
private const MODE_EOY = 1;         /* Конец периода                                       */
private const MODE_EOY_PRECALC = 2; /* Предварительный расчет завершения отчетного периода */
private const MODE_GZ = 4;          /* Группа зачисления                                   */


/**************************************************************************\
|             Приведение значений к формату в выходных файлах              |
\**************************************************************************/
/*======================================================================*/
macro NumToUN (InNum, Len)

  var OutString = "";
  var NumStr;

  NumStr = String(Abs(Int(InNum)));
  if (StrLen(NumStr) > Len)
    OutString = MkStr("0",Len);
  else
    OutString = NumStr;
    while (StrLen(OutString) < Len)
      OutString = "0" + OutString;
    end;
  end;

  return OutString;

end;

/*======================================================================*/
macro BDToAN

  var OutDate = "";
  var Month   = "";
  var d,m,y;

  DateSplit( depclnt.CurRec.rec.Born, d, m, y );

  if   (m ==  1)
    Month = "JAN";
  elif (m ==  2)
    Month = "FEB";
  elif (m ==  3)
    Month = "MAR";
  elif (m ==  4)
    Month = "APR";
  elif (m ==  5)
    Month = "MAY";
  elif (m ==  6)
    Month = "JUN";
  elif (m ==  7)
    Month = "JUL";
  elif (m ==  8)
    Month = "AUG";
  elif (m ==  9)
    Month = "SEP";
  elif (m == 10)
    Month = "OCT";
  elif (m == 11)
    Month = "NOV";
  elif (m == 12)
    Month = "DEC";
  else
    Month = "???";
  end;

  if (y <= 1999)
    y = y - 1900;
  else
    y = y - 2000;
  end;

  OutDate = NumToUN(d,2) + Month + NumToUN(y,2);

  return OutDate;

end;

/*======================================================================*/
macro DateToUN (InDate)

  var OutDate = "";
  var d,m,y;

  DateSplit(InDate,d,m,y);
  OutDate = NumToUN(y,4) + NumToUN(m,2) + NumToUN(d,2);

  return OutDate;

end;

/*======================================================================*/
macro StrToAN (InStr, Len)

  var OutString = "";

  if (StrLen(InStr) > Len)
    OutString = MkStr("_",Len);
  else
    OutString = InStr;
    while (StrLen(OutString) < Len)
      OutString = OutString + " ";
    end;
  end;

  return OutString;

end;

/*======================================================================*/
macro NumToSD (InNum, Len);

  var OutString = "";
  var NumStr;
  var InNumI;

  InNumI = Abs(Int(DoubleL(InNum)));
  NumStr = String(InNumI);
  if (StrLen(NumStr) > Len - 1)
    OutString = "+" + MkStr("0",Len - 1);
  else
    if (InNum >= 0)
      OutString = "+";
    else
      OutString = "-";
    end;
    OutString = OutString + NumToUN(InNumI,Len - 1);
  end;

  return OutString;

end;

/*======================================================================*/
macro NumToSN (InNum, Len);

  var OutString = "";
  var NumStr;
  var InNumI;
      
  InNumI = Abs(Int(InNum));
  NumStr = String(InNumI);
  if (StrLen(NumStr) > Len - 1)
    OutString = "+" + MkStr("0",Len - 1);
  else
    if (InNum >= 0)
      OutString = "+";
    else
      OutString = "-";
    end;
    OutString = OutString + NumToUN(InNumI,Len - 1);
  end;

  return OutString;

end;


/**************************************************************************\
|                   Является ли документ закрытием счета                   |
\**************************************************************************/
macro IsOperCloseAcc

  var stat = false;
   
  if ( ( sbdepdoc.TypeComplexOper == 10 ) and
       ( sbdepdoc.TypeOper        ==  4 )    )
    stat = true;
  elif ( ( (   sbdepdoc.TypeComplexOper == 81       ) or
           (   sbdepdoc.TypeComplexOper == 96       )   ) and
         ( (   sbdepdoc.TypeOper        == 63       ) or
           (   sbdepdoc.TypeOper        == 64       ) or
           ( ( sbdepdoc.TypeOper        == 65 ) and 
             ( sbdepdoc.ApplType        != 11 )     ) or
           (   sbdepdoc.TypeOper        == 66       ) or
           (   sbdepdoc.TypeOper        == 67       ) or
           (   sbdepdoc.TypeOper        == 80       )   )    )
    stat = true;
  end;
     
  return stat;

end;


/**************************************************************************\
|                   Является ли операция закрытием счета                   |
\**************************************************************************/
macro IsComplexOperCloseAcc

  var stat = false;
   
  if ( ( sbdepdoc.TypeComplexOper == 10 ) or
       ( sbdepdoc.TypeComplexOper == 81 ) or
       ( sbdepdoc.TypeComplexOper == 96 )   )
    stat = true;
  end;
     
  return stat;

end;


/**************************************************************************\
|             Запись заголовка в отчет о заказанных карточках              |
\**************************************************************************/
macro HeadCardNewForReport (flag_change_client)

  [ ];
  if (flag_change_client)
    [   Изменение информации по клиенту];
  else
    [   Заказ карточек];
  end;
  [ ];
  [ ┌───────────────────┬─────┬────────────────────┬──────────────────────────┐];
  if (flag_change_client)
    [ │  Номер карточки   │ Тип │ Держатель карточки │       Номер счета        │];
  else
    [ │   Номер заказа    │ Тип │ Держатель карточки │       Номер счета        │];
  end;
  [ ├───────────────────┼─────┼────────────────────┼──────────────────────────┤];

end;


/**************************************************************************\
|             Запись хвостовика в отчет о заказанных карточках             |
\**************************************************************************/
macro BottomCardNewForReport

  [ └───────────────────┴─────┴────────────────────┴──────────────────────────┘];
  [ ];

end;


/**************************************************************************\
|             Запись информации в отчет о заказанных карточках             |
\**************************************************************************/
macro WriteCardNewToReport (ErrorCode, AErrCodes)

  var FIOHolder = "";
  var i         = 0;

  FIOHolder = Trim( depclnt.CurRec.rec.Name1 );
  if ( StrLen( Trim( depclnt.CurRec.rec.Name2 ) ) > 0 )
    FIOHolder = FIOHolder + " " + SubStr( Trim( depclnt.CurRec.rec.Name2), 1, 1 ) + ".";
    if ( StrLen( Trim( depclnt.CurRec.rec.Name3 ) ) > 0 )
      FIOHolder = FIOHolder + SubStr( Trim( depclnt.CurRec.rec.Name3), 1, 1 ) + ".";
    end;
  end;

  [ │#                  │#####│####################│###################### ###│]
  ( FSCCard.cardNumber, sc_codif.codUserCode, FIOHolder, dr.Account, curr.Short_Name );

  if (ASize(AErrCodes) > 0)
    while (i < ASize(AErrCodes))
      [ │#########################################################################│]
      (NameError(AErrCodes(i),""):w);
      i = i + 1;
    end;
  elif (ErrorCode != NOERROR)
    [ │#########################################################################│]
    (NameError(ErrorCode,""):w);
  end;

end;


/**************************************************************************\
|             Запись заголовка в отчет о заказанных карточках              |
\**************************************************************************/
macro HeadCardBlockOvForReport

  [ ];
  [   Блокировка, разблокировка и перевыпуск карточек];
  [ ];
  [ ┌───────────────────┬─────┬────────────────────┬──────────────────────────┐];
  [ │  Номер карточки   │ Тип │ Держатель карточки │    Описание операции     │];
  [ ├───────────────────┼─────┼────────────────────┼──────────────────────────┤];

end;


/**************************************************************************\
|             Запись хвостовика в отчет о заказанных карточках             |
\**************************************************************************/
macro BottomCardBlockOvForReport

  [ └───────────────────┴─────┴────────────────────┴──────────────────────────┘];
  [ ];

end;


/**************************************************************************\
|              Запись информации в отчет о блокировке карточек             |
\**************************************************************************/
macro WriteBlockOvCardToReport (ErrorCode, AErrCodes)

  var CardNumber = "";
  var FIOHolder  = "";
  var NameOper   = "";
  var i          = 0;

  if ( ErrorCode == NOERROR )
    CardNumber = FSCCard.cardNumber;
    FIOHolder = Trim( depclnt.CurRec.rec.Name1 );
    if ( StrLen( Trim( depclnt.CurRec.rec.Name2 ) ) > 0 )
      FIOHolder = FIOHolder + " " + SubStr( Trim( depclnt.CurRec.rec.Name2 ), 1, 1 ) + ".";
      if ( StrLen( Trim( depclnt.CurRec.rec.Name3 ) ) > 0 )
        FIOHolder = FIOHolder + SubStr( Trim( depclnt.CurRec.rec.Name3 ), 1, 1 ) + ".";
      end;
    end;  
  end;

  if   ( sc_to_pc.rec.CodeOper == "UB" )
    NameOper = "Разблокировка";
  elif ( sc_to_pc.rec.CodeOper == "BL" )
    NameOper = "Блокировка";
  elif ( sc_to_pc.rec.CodeOper == "OV" )
    NameOper = "Перевыпуск";
  end;

  [ │#                  │#####│####################│##########################│]
  (CardNumber,sc_codif.codUserCode,FIOHolder,NameOper:w);

  if (ASize(AErrCodes) > 0)
    while (i < ASize(AErrCodes))
      [ │#########################################################################│]
      (NameError(AErrCodes(i),""):w);
      i = i + 1;
    end;
  elif (ErrorCode != NOERROR)
    [ │#########################################################################│]
    (NameError(ErrorCode,""):w);
  end;

end;

/**************************************************************************\
|             Запись заголовка в отчет о лимитах                           |
\**************************************************************************/
macro HeadLimitForReport

  [ ];
  [   Установка, изменение и удаление лимитов операций по карточкам];
  [ ];
  [ ┌───────────────────┬─────┬────────────────────┬──────────────────────────┐];
  [ │  Номер карточки   │ Тип │ Держатель карточки │    Состояние карточки    │];
  [ ├───────────────────┼─────┼────────────────────┼──────────────────────────┤];

end;


/**************************************************************************\
|             Запись информации в отчет о лимитах                          |
\**************************************************************************/
macro WriteLimitToReport

  var FIOHolder  = "";
  var CardNumber = "";
  var CardState  = "";
  var CardType   = "";

  var cmdCard, rsCard;
  var cmdCod,  rsCod;
  var cmdClnt, rsClnt;

  cmdCard = RsdCommand( "select t_cardnumber, t_codclient, t_cardstatecode, t_cardtypecode, t_psref " +
                        "from dsccard_dbt " +
                        "where t_cardref = " + String( rsSC.value("t_recref") ) + 
                        "  and t_fncash  = " + String( rsSC.value("t_branch") ) );

  cmdCard.execute;

  rsCard = RsdRecordset( cmdCard );



  if ( rsCard.MoveNext )

    /* Ищем тип карточки  */

    cmdCod = RsdCommand( "select t_codusercode from dsccodif_dbt " +
                         "where t_codtype = " + String( LogSC_CardT ) + 
                         "  and t_psref   = " + String( rsCard.value("t_psref") ) +
                         "  and t_codcode = '" + String( rsCard.value("t_cardtypecode") ) + "'" );
    cmdCod.execute;

    rsCod = RsdRecordset( cmdCod );
                          
    if ( rsCod.MoveNext )
      CardType = rsCod.value("t_codusercode");
    else
      cmdCod = RsdCommand( "select t_codusercode from dsccodif_dbt " +
                           "where t_codtype = " + String( LogSC_CardT ) + 
                           "  and t_psref   = 0" +
                           "  and t_codcode = '" + String( rsCard.value("t_cardtypecode") ) + "'" );
      cmdCod.execute;

      rsCod = RsdRecordset( cmdCod );

      if ( rsCod.MoveNext )
        CardType = rsCod.value("t_codusercode");
      end;
    end;

    /* Ищем состояние карточки  */

    cmdCod = RsdCommand( "select t_codname from dsccodif_dbt " +
                         "where t_codtype = " + String( LogSC_CardS ) + 
                         "  and t_psref   = " + String( rsCard.value("t_psref") ) +
                         "  and t_codcode = '" + String( rsCard.value("t_cardstatecode") ) + "'" );
    cmdCod.execute;

    rsCod = RsdRecordset( cmdCod );
                          
    if ( rsCod.MoveNext )
      CardType = rsCod.value("t_codname");
    else
      cmdCod = RsdCommand( "select t_codname from dsccodif_dbt " +
                           "where t_codtype = " + String( LogSC_CardS ) + 
                           "  and t_psref   = 0" +
                           "  and t_codcode = '" + String( rsCard.value("t_cardstatecode") ) + "'" );
      cmdCod.execute;

      rsCod = RsdRecordset( cmdCod );

      if ( rsCod.MoveNext )
        CardState = rsCod.value("t_codname");
      end;

      /* Ищем ФИО клиента  */

      cmdClnt = RsdCommand( "select t_name1, t_name2, t_name3 from dpersn_dbt " +
                           "where t_personid = " + String( rsCard.value("t_codclient") ) );
      cmdClnt.execute;

      rsClnt = RsdRecordset( cmdClnt );
                            
      if ( rsClnt.MoveNext )
        FIOHolder = rsClnt.value("t_name1") + " " 
                  + SubStr( rsClnt.value("t_name2"), 1, 1 ) + "." 
                  + SubStr( rsClnt.value("t_name3"), 1, 1 )  + ".";
      end;

    end;
    


    [ │###################│#####│####################│##########################│]
    ( rsCard.value("t_cardnumber"), CardType, FIOHolder, CardState );
 
  else
    [ │ Ошибка при чтении файла sccard.dbt                                      │]
   
  end;

end;


/**************************************************************************\
|             Запись хвостовика в отчет о лимитах                          |
\**************************************************************************/
macro BottomLimitForReport

  [ └───────────────────┴─────┴────────────────────┴──────────────────────────┘];
  [ ];

end;


/**************************************************************************\
|            Запись заголовка в отчет по финансовым транзакциям            |
\**************************************************************************/
macro HeadDocForReport

  [ ];
  [   Финансовые транзакции по карточкам];
  [ ];
  [ ┌──────────────────────────┬────────────────────┬───────────────────┬─────┬──────────────┬──────────┐];
  [ │       Номер счета        │   Владелец счета   │  Номер карточки   │ Тип │Сумма операции│   Дата   │];
  [ ├──────────────────────────┼────────────────────┼───────────────────┼─────┼──────────────┼──────────┤];

end;


/**************************************************************************\
|           Запись хвостовика в отчет по финансовым транзакциям            |
\**************************************************************************/
macro BottomDocForReport

  [ └──────────────────────────┴────────────────────┴───────────────────┴─────┴──────────────┴──────────┘];
  [ ];

end;


/**************************************************************************\
|           Запись информации в отчет по финансовым транзакциям            |
\**************************************************************************/
macro WriteDocToReport

  var FIOAcc   = "";
  var StornSym = "";
  var tran_sum = $0L;

  FIOAcc = Trim( depclnt.CurRec.rec.Name1 );
  if ( StrLen( Trim( depclnt.CurRec.rec.Name2 ) ) > 0 )
    FIOAcc = FIOAcc + " " + SubStr( Trim( depclnt.CurRec.rec.Name2), 1, 1 ) + ".";
    if ( StrLen( Trim( depclnt.CurRec.rec.Name3 ) ) > 0 )
      FIOAcc = FIOAcc + SubStr( Trim( depclnt.CurRec.rec.Name3), 1, 1 ) + ".";
    end;
  end;

  if ( IsOperCloseAcc( ) ) /* Закрытие счета */
    tran_sum = -sbdepdoc.OutSum;
    if ( sbdepdoc.FlagStorn and ( tran_sum != 0 ) )
      tran_sum = -tran_sum;
    end;
  elif ( sbdepdoc.TypeOper == 92 ) /* Списание для погашения овердрафта */
    sbdepdoc5.SetRecordAddr( sbdepdoc, 0, 0, true );
    tran_sum = -sbdepdoc5.rec.Percent1 - sbdepdoc5.rec.Percent2;
  else /* Приходные операции */
    tran_sum = sbdepdoc.InSum;
    if ( sbdepdoc.FlagStorn and ( tran_sum != 0 ) )
      tran_sum = -tran_sum;
    end;
  end;

  if ( sbdepdoc.FlagStorn )
    StornSym = "С";
  end;

  [ │###################### ###│####################│#                  │#####│# ############│##########│]
  ( dr.Account, curr.Short_Name, FIOAcc, FSCCard.cardNumber,
    sc_codif.codUserCode, StornSym, tran_sum:12:2:a,
    sbdepdoc.Date_Document:f );

end;


/**************************************************************************\
|            Запись заголовка в отчет по транзакциям эквайринга            |
\**************************************************************************/
macro HeadTranAcquForReport

  [ ];
  [   Транзакции эквайринга (выдача наличных) по карточкам];
  [ ];
  [ ┌─────────────────┬───────────────────┬─────┬────────────────┬──────────┐];
  [ │ Код авторизации │ Номер карточки    │ Тип │ Сумма операции │   Дата   │];
  [ ├─────────────────┼───────────────────┼─────┼────────────────┼──────────┤];

end;


/**************************************************************************\
|           Запись хвостовика в отчет по транзакциям эквайринга            |
\**************************************************************************/
macro BottomTranAcquForReport

  [ └─────────────────┴───────────────────┴─────┴────────────────┴──────────┘];
  [ ];

end;


/**************************************************************************\
|            Запись информации в отчет о транзакции эквайринга             |
\**************************************************************************/
macro WriteAcquToReport (ErrorCode, AErrCodes)

  var CurName = "";
  var i       = 0;

  if (ErrorCode == NOERROR)
    CurName = curr.Short_Name;
  end;

  [ │#################│###################│#####│############ ###│##########│]
  ( FSCAcqu.authCode, FSCAcqu.cardNumber, sc_codif.codUserCode, ( pay_doc.rec.InSum + pay_docnp.rec.CommSum ):12:2:a, CurName, pay_doc.rec.Date_Document );

  if (ASize(AErrCodes) > 0)
    while (i < ASize(AErrCodes))
      [ │#######################################################################│]
      (NameError(AErrCodes(i),""):w);
      i = i + 1;
    end;
  elif (ErrorCode != NOERROR)
    [ │#######################################################################│]
    (NameError(ErrorCode,""):w);
  end;

end;


/**************************************************************************\
|              Запись информации в расшифровки сеансов связей              |
\**************************************************************************/
macro WriteToMailIt ( TypeIt )

  var ItemRef = scDefReferMailIt( );

  if ( ItemRef < 1 )
    GlobalError = true;
  else
    scMailIt.Clear;
    scMailIt.rec.mailItemRef = ItemRef;
    scMailIt.rec.mailRef     = MailRef;
    scMailIt.rec.FNCash      = BranchCode;

    if ( TypeIt == TypeItForLink )
      scMailIt.rec.SessItemType      = LogSC_Link;
      scMailIt.rec.mailRefFile       = scLink.rec.accCardLinkRef;
      scMailIt.rec.mailIdentificator = "CARD" + String( NumPPCardNew );
    elif ( TypeIt == TypeItForCard )
      scMailIt.rec.SessItemType      = LogSC_Card;
      scMailIt.rec.mailRefFile       = FSCCard.cardRef;
      scMailIt.rec.mailIdentificator = "BLOV" + String( NumPPCardBlockOv );
    elif ( TypeIt == TypeItForTran )
      scMailIt.rec.SessItemType      = LogSC_depdoc;
      scMailIt.rec.mailRefFile       = sbdepdoc.iApplicationKind;
      scMailIt.rec.mailRefFile2      = sbdepdoc.ApplicationKey;
      scMailIt.rec.mailIdentificator = "TRAN" + String( NumPPTran );
    elif ( TypeIt == TypeItForAcqu )
      scMailIt.rec.SessItemType      = LogSC_Acqu;
      scMailIt.rec.mailRefFile       = FSCAcqu.PayDocApplKind;
      scMailIt.rec.mailRefFile2      = FSCAcqu.PayDocApplKey;
      scMailIt.rec.mailIdentificator = "ACQU" + String( NumPPAcqu );
    elif ( TypeIt == TypeItForLimit )
      scMailIt.rec.SessItemType      = LogSC_Limit;
      scMailIt.rec.mailRefFile       = rsLM.value( "t_limitid" );
      scMailIt.rec.mailIdentificator = "LMNT" + String( NumPPLimit );
    end;

    if ( not scMailIt.Insert )
      GlobalError = true;
    end;
  end;

end;


/**************************************************************************\
|           Запись заголовка по заказу карточек в выходной файл            |
\**************************************************************************/
macro WriteHeadForCard

  var str  = "";
  var stat = TRUE;

  str = Delim + "AAHDR00"             + Delim; /* Код транзакции               */
  str = str   + CodeTB                + Delim; /* Номер территориального банка */
  str = str   + DateToUN({curdate})   + Delim; /* Дата подготовки файла        */
  str = str   + NumToUN(DayNumFile,3) + Delim; /* Номер файла за день          */
  str = str   + NumToUN(100,       3) + Delim; /* Номер реализации             */
  str = str   + StrToAN(TypeOutF,  4) + Delim; /* Признак тестового файла      */
  str = str   + StrToAN("I",       1) + Delim; /* Код доставки                 */
  str = str   + StrToAN("PARTIAL", 7);         /* Код обновления               */

  while (StrLen(str) < OutLen)
    str = str + " ";
  end;

  if (NOT Insert(OutFile,str))
    GlobalError = TRUE;
  end;

end;


/**************************************************************************\
|           Запись хвостовика по заказу карточек в выходной файл           |
\**************************************************************************/
macro WriteBotForCard

  var str  = "";
  var stat = TRUE;

  str = Delim + "ZZTLR00"              + Delim; /* Код транзакции                    */
  str = str   + CodeTB                 + Delim; /* Номер территориального банка      */
  str = str   + DateToUN({curdate})    + Delim; /* Дата подготовки файла             */
  str = str   + NumToUN(DayNumFile, 3) + Delim; /* Номер файла за день               */
  str = str   + NumToUN(0,          9) + Delim; /* Количество блоков транзакций      */
  str = str   + NumToUN(0,         12) + Delim; /* Количество строк транзакций       */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций ACCT  */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций ADDR  */
  str = str   + NumToUN(CountAPPLN, 9) + Delim; /* Количество строк транзакций APPLN */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций AUTH  */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций BUSNS */
  str = str   + NumToUN(CountCARD,  9) + Delim; /* Количество строк транзакций CARD  */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций CLOCD */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций CODES */
  str = str   + NumToUN(CountCUSTR, 9) + Delim; /* Количество строк транзакций CUSTR */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций LINX  */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций MISC  */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций SCODE */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций STMT  */
  str = str   + NumToUN(0,          9) + Delim; /* Количество строк транзакций TRAN  */
  str = str   + NumToUN(0,          9);         /* Количество строк транзакций USERS */

  while (StrLen(str) < OutLen)
    str = str + " ";
  end;

  if (NOT Insert(OutFile,str))
    GlobalError = TRUE;
  end;

end;


/**************************************************************************\
|             Запись заголовка по транзакциям в выходной файл              |
\**************************************************************************/
macro WriteHeadForTran

  var str  = "";
  var stat = TRUE;

  str = Delim + "CSHDR00"                 + Delim; /* Код транзакции                 */
  str = str   + DateToUN({curdate})       + Delim; /* Дата подготовки файла          */
  str = str   + NumToUN(DayNumFile,    6) + Delim; /* Номер файла за день            */
  str = str   + NumToUN(0,             6) + Delim; /* Резерв                         */
  str = str   + NumToUN(NumPPTran,    16) + Delim; /* Количество записей             */
  str = str   + NumToSD(SummaMoneyUSD,13) + Delim; /* Сводная сумма транзакций в USD */
  str = str   + StrToAN("",            1) + Delim; /* Резерв                         */
  str = str   + NumToSD(SummaMoneyRUB,13) + Delim; /* Сводная сумма транзакций в RUR */
  str = str   + StrToAN("",            7) + Delim; /* Резерв                         */
  str = str   + NumToUN(0,             6) + Delim; /* Резерв                         */
  str = str   + CodeTB                    + Delim; /* Номер территориального банка   */
  str = str   + NumToUN(0,            14) + Delim; /* Резерв                         */

  while (StrLen(str) < OutLen)
    str = str + " ";
  end;

  if (NOT Insert(OutFile,str))
    GlobalError = TRUE;
  end;

end;


/**************************************************************************\
|        Запись заголовка по транзакциям эквайринга в выходной файл        |
\**************************************************************************/
macro WriteHeadForAcqu

  var str  = "";
  var stat = TRUE;

  str = Delim + "CSHDR00"                 + Delim; /* Код транзакции                 */
  str = str   + DateToUN({curdate})       + Delim; /* Дата подготовки файла          */
  str = str   + NumToUN(DayNumFile,    3) + Delim; /* Номер файла за день            */
  str = str   + NumToUN(0,             6) + Delim; /* Резерв                         */
  str = str   + NumToUN(NumPPAcqu,    16) + Delim; /* Количество записей             */
  str = str   + NumToSD(SummaAcquUSD, 13) + Delim; /* Сводная сумма транзакций в USD */
  str = str   + StrToAN("",            1) + Delim; /* Резерв                         */
  str = str   + NumToSD(SummaAcquRUB, 13) + Delim; /* Сводная сумма транзакций в RUR */
  str = str   + StrToAN("",            7) + Delim; /* Резерв                         */
  str = str   + NumToUN(0,             6) + Delim; /* Резерв                         */
  str = str   + CodeTB                    + Delim; /* Номер территориального банка   */
  str = str   + NumToUN(0,            14) + Delim; /* Резерв                         */

  while (StrLen(str) < OutLen)
    str = str + " ";
  end;

  if (NOT Insert(OutFile,str))
    GlobalError = TRUE;
  end;

end;


/**************************************************************************\
|             Запись хвостовика по транзакциям в выходной файл             |
\**************************************************************************/
macro WriteBotForTran

  var str  = "";
  var stat = TRUE;

  str = Delim + "ZZSUM00"              + Delim; /* Код транзакции               */
  str = str   + CodeTB                 + Delim; /* Номер территориального банка */
  str = str   + DateToUN({curdate})    + Delim; /* Дата подготовки файла        */
  str = str   + NumToUN(DayNumFile, 3) + Delim; /* Номер файла за день          */
  str = str   + NumToUN(0,         11);         /* Контрольная сумма файла      */

  while (StrLen(str) < OutLen)
    str = str + " ";
  end;

  if (NOT Insert(OutFile,str))
    GlobalError = TRUE;
  end;

end;


/**************************************************************************\
|                       Формирование номера паспорта                       |
\**************************************************************************/
macro MakeNumPass

  var str = "";

  if ( StrLen( Trim( sbCard.rec.OfKindPass ) ) > 0 )
    str = "* ";
  end;
  if ( StrLen( Trim( sbCard.rec.RomLettSer ) ) > 0 )
    str = str + Trim( sbCard.rec.RomLettSer ) + " ";
  end;
  if ( StrLen( Trim( sbCard.rec.RusLettSer ) ) > 0 )
    str = str + Trim( sbCard.rec.RusLettSer ) + " ";
  end;
  if ( StrLen( Trim( sbCard.rec.NumPass ) ) > 0 )
    str = str + Trim( sbCard.rec.NumPass );
  end;

  return str;

end;


/**************************************************************************\
|                    Формирование номера загранпаспорта                    |
\**************************************************************************/
macro MakeNumPassI

  var str = "";

  if ( StrLen( Trim( sbCard.rec.IPassSer ) ) > 0 )
    str = str + Trim( sbCard.rec.IPassSer ) + " ";
  end;
  if ( StrLen( Trim( sbCard.rec.IPassNo ) ) > 0 )
    str = str + Trim( sbCard.rec.IPassNo );
  end;

  return str;

end;


/**************************************************************************\
|                        Определение типа карточки                         |
\**************************************************************************/
macro DefCardType

  var CardType = 0;

  if   ( Index( FSCCard.cardTypeCode,"CM_" ) )
    CardType = 7;
  elif ( Index( FSCCard.cardTypeCode,"CMZ" ) )
    CardType = 7;
  elif   ( Index( FSCCard.cardTypeCode,"CMPS" ) )
    CardType = 9;
  elif ( Index( FSCCard.cardTypeCode, "MCM" ) )
    CardType = 4;
  elif ( Index( FSCCard.cardTypeCode, "MCG" ) )
    CardType = 6;
  elif ( Index( FSCCard.cardTypeCode, "MCB" ) )
    CardType = 5;
  elif ( Index( FSCCard.cardTypeCode, "VC" ) )
    CardType = 1;
  elif ( Index( FSCCard.cardTypeCode, "VG" ) )
    CardType = 3;
  elif ( Index( FSCCard.cardTypeCode, "VB" ) )
    CardType = 2;
  elif ( Index( FSCCard.cardTypeCode, "VE" ) )
    CardType = 8;
  end;

  return CardType;

end;


/**************************************************************************\
|                         Формирование ФИО клиента                         |
\**************************************************************************/
macro FormFIOClnt

  var OutString = Trim( depclnt.CurRec.rec.Name1 ) + " ";

  if ( Trim( depclnt.CurRec.rec.Name2 ) != "")
    OutString = OutString + SubStr( Trim( depclnt.CurRec.rec.Name2), 1, 1 ) + ".";
  end;

  if ( Trim( depclnt.CurRec.rec.Name3 ) != "")
    OutString = OutString + SubStr( Trim( depclnt.CurRec.rec.Name3 ), 1, 1 ) + ".";
  end;

  OutString = Trim( OutString );

  return OutString;

end;


/**************************************************************************\
|                       Формирование кода заявления                        |
\**************************************************************************/
macro FormCodeZayavl

  var OutString = "ПРОСТОЙ";

  if ( Trim( sbCard.rec.TypeAccount == "M" ) )
    OutString = "ЛЬГОТНЫЙ";
  end;

  return OutString;

end;


/**************************************************************************\
|                        Формирование номера счета                         |
\**************************************************************************/
macro FormNAcc

  var OutString = Trim(dr.Account);

  if (StrLen(OutString) > 20)
    OutString = SubStr(OutString,1,20) + "/" + SubStr(OutString,21);
  end;

  return OutString;

end;


/**************************************************************************\
|                   Запись информации в клиентские поля                    |
\**************************************************************************/
macro WriteInfoForClientAndCard ( flag_change_client )

  var str       = "";
  var stat      = true;
  var Num       = 0;
  var Num2      = 0;
  var Embos     = "";
  var Limit     = 0;
  var onlyCustr = false;

  if ( flag_change_client )
    if ( sc_to_pc.rec.CodeOper == "CS" )
      onlyCustr = true;
    end;
  end;

  if ( (dr.Limit > 0 ) and ( Index( dr.UserTypeAccount, "О" ) > 0 ) )
    Limit = Int( DoubleL( dr.Limit ) );
  end;

  NumPPCardNew = NumPPCardNew + 1;

  /* Формирование строки CUSTR00 ====================================== */
  if ( stat )
    str = Delim + "CUSTR00";                                           /* Код транзакции                  */
    str = str   + NumToUN( {oper}, 6 );                                /* Номер ответственного лица       */
    str = str   + CodeO + CodeF;                                       /* Номер отделения + номер филиала */
    str = str   + NumToUN( 0, 5 );                                     /* Дата порождения транзакции      */
    str = str   + NumToUN( 0, 6 )                             + Delim; /* Время порождения транзакции     */
    if ( flag_change_client )
      str = str + StrToAN( "C", 1 )                           + Delim; /* Действие ответственного лица    */
    else
      str = str + StrToAN( "A", 1 )                           + Delim; /* Действие ответственного лица    */
    end;
    str = str   + CodeTB                                      + Delim; /* Номер территориального банка    */
    str = str   + StrToAN( Trim( sbCard.rec.TypePass ), 1 )   + Delim; /* Признак наличия паспорта        */
    str = str   + StrToAN( MakeNumPass( ), 19 )               + Delim; /* Номер паспорта                  */
    str = str   + StrToAN( MakeNumPassI( ), 12 )              + Delim; /* Номер загранпаспорта            */
    str = str   + StrToAN( "", 2 )                            + Delim; /* Код класса клиента              */
    if ( ( Limit > 0 ) and ( dr.Code_Currency == 1 ) )
      str = str + NumToSN( Limit, 9 )                         + Delim; /* Лимит остатка в долларах        */
    else
      str = str + "-00000001"                                 + Delim;
    end;
    if ( (Limit > 0 ) and ( dr.Code_Currency == 0 ) )
      str = str + NumToSN( Limit, 9 )                         + Delim; /* Лимит остатка в долларах        */
    else
      str = str + "-00000001"                                 + Delim;
    end;
    str = str   + StrToAN( "", 1 )                            + Delim; /* Тип клиента                     */
    str = str   + BDToAN( )                                   + Delim; /* Дата рождения клиента           */
    str = str   + NumToUN( 0, 2 )                             + Delim; /* Количество иждивенцев           */
    str = str   + StrToAN( Trim( sbCard.rec.ManWom ), 1 )     + Delim; /* Пол                             */
    str = str   + StrToAN( Trim( sbCard.rec.Proprietor ), 1 ) + Delim; /* Код наличия недвижимости        */
    str = str   + StrToAN( sbCard.rec.HomePhone, 12 )         + Delim; /* Номер домашнего телефона        */
    str = str   + StrToAN( sbCard.rec.WorkPhone, 12 )         + Delim; /* Номер рабочего телефона         */
    str = str   + StrToAN( "", 6 )                            + Delim; /* Добавочный номер телефона       */
    str = str   + NumToUN( 0, 9 )                             + Delim; /* Ежегодный годовой доход         */
    str = str   + StrToAN( "", 1 )                            + Delim; /* Источник дохода                 */
    str = str   + StrToAN( Trim( sbCard.rec.PostCode ), 2 )   + Delim; /* Почтовый код                    */
    str = str   + StrToAN( Trim( sbCard.rec.Marriage ), 1 )   + Delim; /* Семейное положение              */
    str = str   + NumToUN( 0, 7 )                             + Delim; /* Лимит                           */
    str = str   + StrToAN( FormFIOClnt( ), 30 )               + Delim; /* ФИО клиента                     */
    str = str   + StrToAN( "", 20 )                           + Delim; /* Ключ ФИО клиента                */
    str = str   + StrToAN( Trim( sbCard.rec.CodeWork ), 2 )   + Delim; /* Код категории занятости         */
    str = str   + StrToAN( "", 5 )                            + Delim; /* Код занятости                   */
    str = str   + StrToAN( Trim( sbCard.rec.Nation ), 2 )     + Delim; /* Код национальности              */
    str = str   + NumToUN( 0, 2 )                             + Delim; /* Непрерывный стаж                */
    str = str   + NumToUN( 0, 2 );                                     /* Общий стаж                      */
    stat = Insert( TMPFile1, str );
    if ( stat )
      CountCUSTR = CountCUSTR + 1;
    end;
  end;
  /* Формирование строки CUSTR01 ====================================== */
  if ( stat )
    str = Delim + "CUSTR01"                                       + Delim; /* Код транзакции                        */
    str = str   + StrToAN( Trim( sbCard.rec.TitulClnt ), 20 )     + Delim; /* Титул                                 */
    str = str   + StrToAN( SubStr( Trim( FSCCard.clientPassword ), 1, 30 ), 30 ) + Delim; /* Контрольная информация                */
    str = str   + StrToAN( Trim( sbCard.rec.NameCompany ), 30 )   + Delim; /* Название работы клиента               */
    str = str   + StrToAN( "", 20 )                               + Delim; /* Должность клиента                     */
    str = str   + StrToAN( Trim( sbCard.rec.DepartCompany ), 20 ) + Delim; /* Отдел компании, где работает клиент   */
    str = str   + StrToAN( Trim( sbCard.rec.NumbInCompany ), 6 )  + Delim; /* Номер клиента в компании              */
    str = str   + NumToUN( 0, 8)                                  + Delim; /* Филиал, где было принято заявление (1)*/
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Юлианская дата заявления              */
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Номер заявления в сквозной нумерации  */
    str = str   + NumToUN( 0, 8)                                  + Delim; /* Филиал, где было принято заявление (2)*/
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Юлианская дата заявления              */
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Номер заявления в сквозной нумерации  */
    str = str   + NumToUN( 0, 8)                                  + Delim; /* Филиал, где было принято заявление (3)*/
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Юлианская дата заявления              */
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Номер заявления в сквозной нумерации  */
    str = str   + NumToUN( 0, 8)                                  + Delim; /* Филиал, где было принято заявление (4)*/
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Юлианская дата заявления              */
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Номер заявления в сквозной нумерации  */
    str = str   + NumToUN( 0, 4)                                  + Delim; /* Номер профессии                       */
    str = str   + NumToUN( 0, 6);                                          /* Резерв                                */
    stat = Insert( TMPFile1, str );
    if ( stat )
      CountCUSTR = CountCUSTR + 1;
    end;
  end;
  /* Формирование строки CUSTR02 ====================================== */
  if ( stat )
    str = Delim + "CUSTR02"                                                       + Delim;  /* Код транзакции */
    str = str   + StrToAN( SubStr( Trim( depclnt.CurRec.rec.Name1 ), 1, 20), 20 ) + Delim;  /* Имя            */
    str = str   + StrToAN( SubStr( Trim( depclnt.CurRec.rec.Name2 ), 1, 15), 15 ) + Delim;  /* Отчество       */
    str = str   + StrToAN( SubStr( Trim( depclnt.CurRec.rec.Name3 ), 1, 20), 20 );          /* Фамилия        */
    stat = Insert( TMPFile1, str );
    if ( stat )
      CountCUSTR = CountCUSTR + 1;
    end;
  end;
  /* Формирование строки APPLN00 ====================================== */
  if ( stat and ( not onlyCustr ) )
    str = Delim + "APPLN00";                                        /* Код транзакции                  */
    str = str   + NumToUN({oper},                       6);         /* Номер ответственного лица       */
    str = str   + CodeO + CodeF;                                    /* Номер отделения + номер филиала */
    str = str   + NumToUN(0,                            5);         /* Дата порождения транзакции      */
    str = str   + NumToUN(0,                            6) + Delim; /* Время порождения транзакции     */
    str = str   + StrToAN("A",                          1) + Delim; /* Действие ответственного лица    */
    str = str   + CodeTB                                   + Delim; /* Номер территориального банка    */
    Num = 0;
    if ( sbCard.rec.AgendaDate != Date( 0, 0, 0 ) )
      Num = sbCard.rec.AgendaDate - Date( 1, 1, 1957 );
    end;
    str = str   + NumToUN(Num,                          5) + Delim; /* Дата заполнения заявления       */
    Num = 0;
    if ( sbCard.rec.AgendaDate != Date( 0, 0, 0 ) )
      DateSplit( sbCard.rec.AgendaDate, null, null, Num2 );
      Num = sbCard.rec.AgendaDate - Date( 1, 1, Num2 ) + 1;
    end;
    str = str   + NumToUN(Num,                          4) + Delim; /* Дата заполнения заявления       */
    str = str   + NumToUN(0,                            4) + Delim; /* Сквозной номер заявления        */
    str = str   + StrToAN(Trim(sbCard.rec.TypeAccount), 2) + Delim; /* Тип счета                       */
    str = str   + NumToUN(DefCardType(),                2) + Delim; /* Тип карточного продукта         */
    str = str   + NumToUN(Int(Trim(curr.ExternalCode)), 3) + Delim; /* Валюта                          */
    str = str   + NumToUN(0,                            7) + Delim; /* Номер счета                     */
    str = str   + StrToAN("",                          30) + Delim; /* Имя счета                       */
    str = str   + StrToAN("",                          30) + Delim; /* Имя счета                       */
    str = str   + StrToAN(FormCodeZayavl(),            10) + Delim; /* Код источника заявления         */
    str = str   + CodeO + CodeF                            + Delim; /* Номер отделения + номер филиала */
    str = str   + NumToUN(0,                            4) + Delim; /* Бизнес номер                    */
    str = str   + StrToAN("",                          17) + Delim; /* Адрес терминала обмена          */
    str = str   + "+00000000"                              + Delim; /* Лимит кредита или остаток       */
    str = str   + StrToAN(MakeNumPass(),               19) + Delim; /* Номер паспорта заявителя        */
    str = str   + StrToAN("",                          19) + Delim; /* Номер паспорта дополн.заявителя */
    str = str   + NumToUN(0,                            1) + Delim; /* Флаг редактирования             */
    str = str   + NumToUN(sbCard.rec.NumberPrimaryAddr, 1) + Delim; /* Номер адреса для печати выписки */
    str = str   + NumToUN(0,                            5) + Delim; /* Дата запроса                    */
    str = str   + NumToUN(0,                            7) + Delim; /* MP запрос лимита                */
    str = str   + NumToUN(0,                            7);         /* MP лимит                        */
    stat = Insert(TMPFile2,str);
    if (stat)
      CountAPPLN = CountAPPLN + 1;
    end;
  end;
  /* Формирование строки APPLN01 ====================================== */
  if ( stat and ( not onlyCustr ) )
    str = Delim + "APPLN01"                           + Delim; /* Код транзакции              */
    str = str   + StrToAN("A",                     1) + Delim; /* Код разрешения              */
    str = str   + NumToUN(10,                      2) + Delim; /* Причина разрешения          */
    str = str   + StrToAN("N",                     1) + Delim; /* Индикатор отклонения        */
    str = str   + NumToUN(0,                       5) + Delim; /* Дата разрешения             */
    str = str   + NumToUN({oper},                  6) + Delim; /* Номер ответственного лица   */
    str = str   + NumToUN(sbCard.rec.CodeClassClient, 2) + Delim; /* Код класса                  */
    str = str   + "+00000000"                         + Delim; /* Лимит кредита или остаток   */
    Embos = Trim(FSCCard.embossingName1) + "/" + Trim(FSCCard.embossingName2) + "/" + Trim(sbCard.rec.TitulEmboss);
    Num   = StrLen(Trim(FSCCard.embossingName1));
    Num2  = StrLen(Trim(FSCCard.embossingName1) + "/" + Trim(FSCCard.embossingName2));
    str = str   + StrToAN(Embos,                  26) + Delim; /* Эмбоссирование 1            */
    str = str   + NumToUN(Num,                     2) + Delim; /* Знакоместо разделителя 1    */
    str = str   + NumToUN(Num2,                    2) + Delim; /* Знакоместо разделителя 2    */
    str = str   + StrToAN("Y",                     1) + Delim; /* Эмбоссированный индикатор   */
    /*LAA  пробел вместо нуля */
    str = str   + StrToAN(" ",                     1) + Delim; /* Плата курьеру               */
    /*LAA  вместо четырех пусто "COLL"*/
    str = str   + StrToAN("COLL",                  4) + Delim; /* Способ доставки карты       */
    str = str   + CodeO + CodeF                       + Delim; /* Место отправки карты        */
    str = str   + NumToUN(0,                       3) + Delim; /* Номер конца карты           */
    Num = 0;
    if (FSCCard.cardMaturityDate != Date(0,0,0))
      DateSplit( FSCCard.cardMaturityDate, null, Num, Num2 );
      if (Num2 <= 1999)
        Num2 = Num2 - 1900;
      else
        Num2 = Num2 - 2000;
      end;
      Num = Num2 * 100 + Num;
    end;
    str = str   + NumToUN(Num,                     4) + Delim; /* Окончание действия карты    */
    str = str   + StrToAN("",                     12) + Delim; /* Специнструкции карты        */
    str = str   + StrToAN("",                      1) + Delim; /* Тип карты                   */
    str = str   + StrToAN("",                     26) + Delim; /* Эмбоссирование 2            */
    str = str   + NumToUN(0,                       2) + Delim; /* Знакоместо разделителя 1    */
    str = str   + NumToUN(0,                       2) + Delim; /* Знакоместо разделителя 2    */
    str = str   + StrToAN("Y",                     1) + Delim; /* Эмбоссированный индикатор   */
    str = str   + NumToUN(0,                       1) + Delim; /* Плата курьеру               */
    str = str   + StrToAN("COUR",                  4) + Delim; /* Способ доставки карты       */
    str = str   + CodeO + CodeF                       + Delim; /* Место отправки карты        */
    str = str   + NumToUN(0,                       3) + Delim; /* Номер конца карты           */
    str = str   + NumToUN(0,                       4) + Delim; /* Окончание действия карты    */
    str = str   + StrToAN("",                     12) + Delim; /* Специнструкции карты        */
    str = str   + StrToAN("0",                     1) + Delim; /* Тип карты                   */
    str = str   + NumToUN(0,                       5) + Delim; /* День ввода                  */
    str = str   + NumToUN(0,                       6) + Delim; /* Время ввода                 */
    str = str   + NumToUN(0,                       6) + Delim; /* Сотрудник, заведший запись  */
    str = str   + StrToAN("",                     17) + Delim; /* Адрес терминала ввода       */
    /*LAA  код страхования ДОЛЖЕН быть равен ПРОБЕЛ (DOS-ANSII==32) */
    str = str   + StrToAN(" ",                     2) + Delim; /* Код страхования             */
    /*LAA  Код процентов   ДОЛЖЕН быть равен 01 */
    str = str   + NumToUN(01,                      2) + Delim; /* Код процентов               */
    str = str   + StrToAN("",                      1) + Delim; /* Код управления              */
    str = str   + StrToAN("",                      1) + Delim; /* Код погашения               */
    str = str   + "+00000000"                         + Delim; /* Счет погашения              */
    str = str   + NumToUN(0,                       2) + Delim; /* Проценты погашения          */
    str = str   + StrToAN("N",                     1);         /* Индикатор срочности платежа */
    stat = Insert(TMPFile2,str);
    if (stat)
      CountAPPLN = CountAPPLN + 1;
    end;
  end;
  /* Формирование строки APPLN02 ====================================== */
  if ( stat and ( not onlyCustr ) )
    str = Delim + "APPLN02"                             + Delim; /* Код транзакции             */
    str = str   + StrToAN(FormNAcc(),               25) + 
                  StrToAN("C",                       1) + Delim; /* Номер банковского счета 1  */
    str = str   + StrToAN("",                       25) +
                  StrToAN("",                        1) + Delim; /* Номер банковского счета 2  */
    str = str   + StrToAN("",                       25) +
                  StrToAN("",                        1) + Delim; /* Номер банковского счета 3  */
    str = str   + StrToAN("",                       25) +
                  StrToAN("",                        1) + Delim; /* Номер банковского счета 4  */
    str = str   + StrToAN(Trim(sbCard.rec.NumberCard1),19) + Delim; /* Номер имеющейся карточки   */
    if (Trim(sbCard.rec.NumberCard1) == "")
      str = str + StrToAN("",                        1) + Delim; /* Код имеющейся карточки     */
    else
      str = str + StrToAN("C",                       1) + Delim;
    end;
    str = str   + StrToAN(Trim(sbCard.rec.NumberCard2),19) + Delim; /* Номер имеющейся карточки   */
    if (Trim(sbCard.rec.NumberCard2) == "")
      str = str + StrToAN("",                        1) + Delim; /* Код имеющейся карточки     */
    else
      str = str + StrToAN("C",                       1) + Delim;
    end;
    str = str   + StrToAN(Trim(sbCard.rec.NumberCard3),19) + Delim; /* Номер имеющейся карточки   */
    if (Trim(sbCard.rec.NumberCard3) == "")
      str = str + StrToAN("",                        1) + Delim; /* Код имеющейся карточки     */
    else
      str = str + StrToAN("C",                       1) + Delim;
    end;
    str = str   + StrToAN(Trim(sbCard.rec.NumberCard4),19) + Delim; /* Номер имеющейся карточки   */
    if (Trim(sbCard.rec.NumberCard4) == "")
      str = str + StrToAN("",                        1) + Delim; /* Код имеющейся карточки     */
    else
      str = str + StrToAN("C",                       1) + Delim;
    end;
    str = str   + StrToAN("",                        1);         /* Код типа гарантии          */
    str = str   + StrToAN("",                       25);         /* Банковский счет поручителя */
    str = str   + StrToAN("",                       19);         /* Номер карточки поручителя  */
    str = str   + NumToUN(0,                         5);         /* Срок действия карточки     */
    stat = Insert( TMPFile2, str );
    if ( stat )
      CountAPPLN = CountAPPLN + 1;
    end;
  end;
  /* Формирование строки APPLN03 ====================================== */
  if ( stat and ( not onlyCustr ) )
    str = Delim + "APPLN03"                         + Delim; /* Код транзакции      */
    str = str   + StrToAN(sbCard.rec.TypeAddr1,  1) + Delim; /* Код типа адреса     */
    str = str   + StrToAN(sbCard.rec.IndexAddr1,30) + Delim; /* Почтовый индекс     */
    str = str   + StrToAN(sbCard.rec.Addr1S1,   30) + Delim; /* Адрес               */
    str = str   + StrToAN(sbCard.rec.Addr1S2,   30) + Delim; /* Адрес (продолжение) */
    str = str   + StrToAN(sbCard.rec.Addr1S3,   30) + Delim; /* Адрес (продолжение) */
    str = str   + StrToAN(" ",                  30) + Delim; /* Адрес (продолжение) */
    str = str   + NumToUN(sbCard.rec.IndexAddr1, 6) + Delim; /* Почтовый индекс     */
    str = str   + StrToAN(" ",                   2) + Delim; /* Код штата           */
    str = str   + StrToAN(sbCard.rec.WorkPhone, 12) + Delim; /* Рабочий телефон     */
    str = str   + StrToAN(" ",                   6) + Delim; /* Добавочный номер    */
    str = str   + StrToAN(sbCard.rec.HomePhone, 12);         /* Домашний телефон    */
    stat = Insert( TMPFile2, str );
    if ( stat )
      CountAPPLN = CountAPPLN + 1;
    end;
  end;
  /* Формирование строки APPLN04 ====================================== */
  if ( stat and ( not onlyCustr ) )
    str = Delim + "APPLN04"                         + Delim; /* Код транзакции           */
    str = str   + StrToAN(sbCard.rec.TypeAddr2,  1) + Delim; /* Код типа адреса          */
    str = str   + StrToAN(sbCard.rec.IndexAddr2,30) + Delim; /* Почтовый индекс          */
    str = str   + StrToAN(sbCard.rec.Addr2S1,   30) + Delim; /* Адрес                    */
    str = str   + StrToAN(sbCard.rec.Addr2S2,   30) + Delim; /* Адрес (продолжение)      */
    str = str   + StrToAN(sbCard.rec.Addr2S3,   30) + Delim; /* Адрес (продолжение)      */
    str = str   + StrToAN(" ",                  30) + Delim; /* Адрес (продолжение)      */
    str = str   + NumToUN(sbCard.rec.IndexAddr2, 6) + Delim; /* Почтовый индекс          */
    str = str   + StrToAN(" ",                   2) + Delim; /* Код штата                */
    str = str   + NumToUN(0,                     1) + Delim; /* Имеющийся пользователь 1 */
    str = str   + NumToUN(0,                     1) + Delim; /* Имеющийся пользователь 2 */
    str = str   + StrToAN(" ",                   1) + Delim; /* Согласование файла       */
    str = str   + StrToAN(" ",                   4) + Delim; /* Кредитный отдел          */
    str = str   + StrToAN(" ",                  30) + Delim; /* Доверенное лицо          */
    str = str   + StrToAN(" ",                  19);         /* Номер паспорта           */
    stat = Insert( TMPFile2, str );
    if ( stat )
      CountAPPLN = CountAPPLN + 1;
    end;
  end;
  /* Формирование строки APPLN05 ====================================== */
  if ( stat and ( not onlyCustr ) )
    str = Delim + "APPLN05"                            + Delim; /* Код транзакции      */
    str = str   + StrToAN( sbCard.rec.TypeAddr3,   1 ) + Delim; /* Код типа адреса     */
    str = str   + StrToAN( sbCard.rec.IndexAddr3, 30 ) + Delim; /* Почтовый индекс     */
    str = str   + StrToAN( sbCard.rec.Addr3S1,    30 ) + Delim; /* Адрес               */
    str = str   + StrToAN( sbCard.rec.Addr3S2,    30 ) + Delim; /* Адрес (продолжение) */
    str = str   + StrToAN( sbCard.rec.Addr3S3,    30 ) + Delim; /* Адрес (продолжение) */
    str = str   + StrToAN( " ",                   30 ) + Delim; /* Адрес (продолжение) */
    str = str   + NumToUN( sbCard.rec.IndexAddr3,  6 ) + Delim; /* Почтовый индекс     */
    str = str   + StrToAN( " ",                    2 ) + Delim; /* Код штата           */
    str = str   + NumToUN( 0,                     12 );         /* Номер микрофильма   */
    str = str   + StrToAN( " ",                    1 );         /* Резерв              */
    stat = Insert( TMPFile2, str );
    if ( stat )
      CountAPPLN = CountAPPLN + 1;
    end;
  end;

  if ( not stat )
    GlobalError = true;
  else
    WriteToMailIt( TypeItForLink );
  end;

end;


/**************************************************************************\
|            Запись информации в поля по блокировке/перевыпуску            |
\**************************************************************************/
macro WriteInfoForBlockOvCard

  var stat       = TRUE;
  var str        = "";
  var CardNumber = Trim( FSCCard.cardNumber );
  var LenNumber  = StrLen(CardNumber);
  var OverBlockCode;
  var Embos;
  var mm,yy;
  var Num;

  /* Определение срока действия карты */
  DateSplit( FSCCard.cardMaturityDate, null, mm, yy );
  mm = String( mm );
  yy = String( yy );
  while (StrLen( mm ) < 2)
    mm = "0" + mm;
  end;
  if (StrLen( yy ) > 2)
    yy = SubStr( yy, StrLen( yy ) - 1 );
  end;
  while ( StrLen( yy ) < 2 )
    yy = "0" + yy;
  end;

  /* Определение кода перевыпуска */
  OverBlockCode = " ";
  if ( sc_to_pc.rec.CodeOper != "UB" )
    OverBlockCode = SubStr( FSCCard.cardStateCode, 4, 1 );
  end;

  /* Эмбоссирование */
  Embos = "";
  if ((OverBlockCode == "E") OR (OverBlockCode == "M"))
    Embos = Trim(FSCCard.embossingName1) + "/" + Trim(FSCCard.embossingName2) + "/" + Trim( sbCard.rec.TitulEmboss );
  end;

  /* Относительная дата операции */
  Num = {curdate} - Date(1,1,1957);

  NumPPCardBlockOv = NumPPCardBlockOv + 1;

  if (stat)
    str = Delim + "CARD 00";                                    /* Код транзакции                  */
    str = str   + NumToUN({oper},                   6);         /* Номер ответственного лица       */
    str = str   + CodeO + CodeF;                                /* Номер отделения + номер филиала */
    str = str   + NumToUN(0,                        5);         /* Дата порождения транзакции      */
    str = str   + NumToUN(0,                        6) + Delim; /* Время порождения транзакции     */
    str = str   + "C"                                  + Delim; /* Действие с картой               */
    str = str   + "BCNCL"                              + Delim; /* Признак действия с картой       */
    str = str   + StrToAN(CardNumber,              19) + Delim; /* Номер карты                     */
    str = str   + CodeTB                               + Delim; /* Номер территориального банка    */
    str = str   + NumToUN(DefCardType(),            2) + Delim; /* Тип карточного продукта         */
    str = str   + SubStr(CardNumber,LenNumber -  9, 7) + Delim; /* Код                             */
    str = str   + SubStr(CardNumber,LenNumber -  2, 1) + Delim; /* 3-я цифра с конца номера карты  */
    str = str   + SubStr(CardNumber,LenNumber -  1, 1) + Delim; /* 2-я цифра с конца номера карты  */
    str = str   + SubStr(CardNumber,LenNumber,      1) + Delim; /* Последняя цифра номера карты    */
    str = str   + NumToUN(0,                        4) + Delim; /* Значимая дата                   */
    str = str   + yy + mm                              + Delim; /* Срок окончания действия карты   */
    str = str   + OverBlockCode                        + Delim; /* Код перевыпуска                 */
    str = str   + NumToUN(Num,                      5) + Delim; /* Дата операции                   */
    str = str   + NumToUN(0,                        6) + Delim; /* Время операции                  */
    str = str   + NumToUN(FSCCard.cardStatusOper,6) + Delim; /* Номер ответственного лица       */
    str = str   + CodeO + CodeF                        + Delim; /* Номер отделения + номер филиала */
    str = str   + StrToAN(Embos,                   26) + Delim; /* Эмбоссирование                  */
    str = str   + "COLL"                               + Delim; /* Метод перевыпуска               */
    str = str   + NumToUN(0,                        1) + Delim; /* Символ платы за курьера         */
    str = str   + NumToUN(0,                        1) + Delim; /* Символ платы за замену карточки */
    str = str   + StrToAN("",                       1) + Delim; /* Основание выпуска               */
    str = str   + StrToAN("",                      24) + Delim; /* Резерв                          */
    str = str   + StrToAN("",                       1) + Delim; /* Индикатор эмбоссирования        */
    str = str   + StrToAN("",                       2) + Delim; /* Код оплаты                      */
    str = str   + StrToAN("",                      18) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        5) + Delim; /* Дата утери карточки             */
    str = str   + NumToUN(0,                        4) + Delim; /* Время утери карточки            */
    str = str   + StrToAN("",                       2) + Delim; /* Признак времени утери карточки  */
    str = str   + StrToAN("",                       3) + Delim; /* Тип сообщения об утере карточки */
    str = str   + StrToAN("",                      12) + Delim; /* Пояснение для отказа            */
    str = str   + NumToUN(0,                        5) + Delim; /* Дата перевыпуска карточки       */
    str = str   + StrToAN("",                       9);         /* Резерв                          */
    stat = Insert(TMPFile3,str);
    if (stat)
      CountCARD = CountCARD + 1;
    end;
  end;

  if ( stat and ( sc_to_pc.rec.CodeOper == "OV" ) )
    str = Delim + "CARD 00";                                    /* Код транзакции                  */
    str = str   + NumToUN({oper},                   6);         /* Номер ответственного лица       */
    str = str   + CodeO + CodeF;                                /* Номер отделения + номер филиала */
    str = str   + NumToUN(0,                        5);         /* Дата порождения транзакции      */
    str = str   + NumToUN(0,                        6) + Delim; /* Время порождения транзакции     */
    str = str   + "C"                                  + Delim; /* Действие с картой               */
    str = str   + "CDREP"                              + Delim; /* Признак действия с картой       */
    str = str   + StrToAN(CardNumber,              19) + Delim; /* Номер карты                     */
    str = str   + CodeTB                               + Delim; /* Номер территориального банка    */
    str = str   + NumToUN(DefCardType(),            2) + Delim; /* Тип карточного продукта         */
    str = str   + SubStr(CardNumber,LenNumber -  9, 7) + Delim; /* Код                             */
    str = str   + SubStr(CardNumber,LenNumber -  2, 1) + Delim; /* 3-я цифра с конца номера карты  */
    str = str   + SubStr(CardNumber,LenNumber -  1, 1) + Delim; /* 2-я цифра с конца номера карты  */
    str = str   + SubStr(CardNumber,LenNumber,      1) + Delim; /* Последняя цифра номера карты    */
    str = str   + NumToUN(0,                        4) + Delim; /* Значимая дата                   */
    str = str   + yy + mm                              + Delim; /* Срок окончания действия карты   */
    str = str   + OverBlockCode                        + Delim; /* Код перевыпуска                 */
    str = str   + NumToUN(Num,                      5) + Delim; /* Дата операции                   */
    str = str   + NumToUN(0,                        6) + Delim; /* Время операции                  */
    str = str   + NumToUN(FSCCard.cardStatusOper,6) + Delim; /* Номер ответственного лица       */
    str = str   + CodeO + CodeF                        + Delim; /* Номер отделения + номер филиала */
    str = str   + StrToAN(Embos,                   26) + Delim; /* Эмбоссирование                  */
    str = str   + "COLL"                               + Delim; /* Метод перевыпуска               */
    str = str   + NumToUN(0,                        1) + Delim; /* Символ платы за курьера         */
    str = str   + NumToUN(0,                        1) + Delim; /* Символ платы за замену карточки */
    str = str   + StrToAN("",                       1) + Delim; /* Основание выпуска               */
    str = str   + StrToAN("",                      24) + Delim; /* Резерв                          */
    str = str   + StrToAN("",                       1) + Delim; /* Индикатор эмбоссирования        */
    str = str   + StrToAN("",                       2) + Delim; /* Код оплаты                      */
    str = str   + StrToAN("",                      18) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        5) + Delim; /* Дата утери карточки             */
    str = str   + NumToUN(0,                        4) + Delim; /* Время утери карточки            */
    str = str   + StrToAN("",                       2) + Delim; /* Признак времени утери карточки  */
    str = str   + StrToAN("",                       3) + Delim; /* Тип сообщения об утере карточки */
    str = str   + StrToAN("",                      12) + Delim; /* Пояснение для отказа            */
    str = str   + NumToUN(0,                        5) + Delim; /* Дата перевыпуска карточки       */
    str = str   + StrToAN("",                       9);         /* Резерв                          */
    stat = Insert( TMPFile3, str );
    if ( stat )
      CountCARD = CountCARD + 1;
    end;
  end;

  if (NOT stat)
    GlobalError = TRUE;
  else
    WriteToMailIt(TypeItForCard);
  end;

end;

/**************************************************************************\
|               Запись информации в поля по лимитам операций               |
\**************************************************************************/
macro WriteInfoForLimit
  var stat         = TRUE;
  var str          = "";
  var Num          = 0;
  var CardNumber   = "";
  var LimitedTrade = 0;  /* Лимит на покупку */
  var LimitedCash  = 0;  /* Лимит на выдачу наличных */
  var LimitedTotal = 0;  /* Общий расходный лимит */

  /* Ищем номер карточки */
  var cmd, rs;

  cmd = RsdCommand( "select t_cardnumber from dsccard_dbt " + 
                    "where t_cardref = " + String( rsSC.value("t_recref") ) + 
                    " and  t_fncash  = " + String( rsSC.value("t_branch") ) );      
  cmd.execute;
  rs = RsdRecordset( cmd );
  if ( rs.moveNext )
    CardNumber = rs.value(0);
  else
    stat = FALSE;
    GlobalError = TRUE;
  end;

  /* Ищем значения лимитов */
  if ( (rsLM.value("t_level") == CLL_Card) and (rsLM.value("t_type") == CLT_Sum) and (rsLM.value("t_period") == ADSP_MON) )
    if ( rsLM.value("t_operkind") == CLOK_Buy )
      LimitedTrade = rsLM.value("t_limitvalue");
    elif ( rsLM.value("t_operkind") == CLOK_Cash )
      LimitedCash = rsLM.value("t_limitvalue");        
    elif ( rsLM.value("t_operkind") == CLOK_TotalSum )
      LimitedTotal = rsLM.value("t_limitvalue");        
    end;
  end;

  NumPPLimit = NumPPLimit + 1;

  if (stat)
    str = Delim + "CDLMT00";                                    /* Код лимита                      */
    str = str   + NumToUN({oper},                   6);         /* Номер ответственного лица       */
    str = str   + CodeO + CodeF;                                /* Номер отделения + номер филиала */

    Num = 0;
    Num = Date() - Date( 1, 1, 1957 );
    str = str   + NumToUN(Num,                      5);         /* Дата внесения изменения         */
    str = str   + NumToUN(0,                        6) + Delim; /* Время внесения изменения        */
    str = str   + "C"                                  + Delim; /* Действие с картой               */
    str = str   + CodeTB                               + Delim; /* Номер территориального банка    */
    str = str   + "C"                                  + Delim; /* Действие с картой               */
    str = str   + StrToAN(CardNumber,              19) + Delim; /* Номер карты                     */
    str = str   + "C "                                 + Delim; /* Действие с картой               */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        2) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        2) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(LimitedTrade,             8) + Delim; /* Лимит покупки                   */
    str = str   + NumToUN(0,                        2) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(LimitedCash,              8) + Delim; /* Лимит выдачи наличных           */
    str = str   + NumToUN(0,                        2) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(LimitedTotal,             8) + Delim; /* Общий расходный лимит           */
    str = str   + NumToUN(0,                        4) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        4) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        8) + Delim; /* Резерв                          */
    str = str   + NumToUN(0,                        4) + Delim; /* Резерв                          */
    str = str   + StrToAN("00000000",              39) + Delim; /* Резерв                          */
    stat = Insert( TMPFile6, str );
  end;

  if (NOT stat)
    GlobalError = TRUE;
  else
    WriteToMailIt(TypeItForLimit);
  end;

end;


/**************************************************************************\
|               Запись информации в поля по приходу/расходу                |
\**************************************************************************/
macro WriteInfoForAccountInOut

  var stat      = TRUE;
  var str       = "";
  var num_opert = 0;
  var tran_ind  = 0;
  var tran_sum  = $0L;
    
  if ( IsOperCloseAcc( ) ) /* Закрытие счета */
    tran_sum = -sbdepdoc.OutSum;
    if ( sbdepdoc.FlagStorn and ( tran_sum != 0 ) )
      tran_sum = -tran_sum;
    end;
    num_opert = 8035;
  elif ( sbdepdoc.TypeOper == 92 ) /* Списание для погашения овердрафта */
    sbdepdoc5.SetRecordAddr( sbdepdoc, 0, 0, true );
    tran_sum = -sbdepdoc5.rec.Percent1 - sbdepdoc5.rec.Percent2;
    num_opert = 5110;
  else /* Приходные операции */
    tran_sum = sbdepdoc.InSum;
    if ( sbdepdoc.FlagStorn and ( tran_sum != 0 ) )
      tran_sum = -tran_sum;
    end;
    num_opert = 7000;
  end;

  if ( sbdepdoc.FlagStorn )
    tran_ind = 1;
  end;
      
  /* Подсчет итоговых значений */
  NumPPTran = NumPPTran + 1;
  if   (Trim(curr.ExternalCode) == "810")
    SummaMoneyRUB = SummaMoneyRUB + tran_sum;
  elif (Trim(curr.ExternalCode) == "840")
    SummaMoneyUSD = SummaMoneyUSD + tran_sum;
  end;

  if (stat)
    str = Delim + "CSHTX00"                               + Delim; /* Код транзакции    */
    str = str   + DateToUN( sbdepdoc.Date_Document )  + Delim; /* Дата обработки    */
    str = str   + NumToUN( NumPPTran, 6 )                 + Delim; /* Номер записи      */
    str = str   + NumToUN( num_opert, 4 )                 + Delim; /* Код транзакции    */
    str = str   + NumToUN( 0, 1 )                         + Delim; /* Резерв            */
    str = str   + NumToUN( tran_ind, 1 )                  + Delim; /* Индикатор         */
    str = str   + StrToAN( FSCCard.cardNumber, 19 )    + Delim; /* Номер карты       */
    str = str   + NumToSD(tran_sum,13)                    + Delim; /* Сумма транзакции  */
    str = str   + StrToAN(" ",1)                          + Delim; /* Резерв            */
    str = str   + NumToUN(Int(Trim(curr.ExternalCode)),3) + Delim; /* Валюта транзакции */
    str = str   + NumToUN(0,6)                            + Delim; /* Номер чека        */
    str = str   + DateToUN( sbdepdoc.Date_Document )  + Delim; /* Дата перевода     */
    str = str   + DateToUN({curdate})                     + Delim; /* Дата обработки    */
    str = str   + StrToAN("0",6)                          + Delim; /* Код авторизации   */
    str = str   + CodeTB                                  + Delim; /* Код Тербанка      */
    str = str   + CodeO + CodeF                           + Delim; /* Отделение/филиал  */
    str = str   + NumToUN( sbdepdoc.Oper, 6 )         + Delim; /* Номер сотрудника  */
    str = str   + StrToAN(" ",17)                         + Delim; /* Адрес терминала   */
    str = str   + NumToUN(0,6)                            + Delim; /* Время транзакции  */
    str = str   + NumToUN(1,1)                            + Delim; /* Тип терминала     */
    str = str   + NumToUN(0,12)                           + Delim; /* MP Amount         */
    str = str   + NumToUN(0,91);                                   /* Резерв            */
    stat = Insert(TMPFile4,str);
  end;

  if (NOT stat)
    GlobalError = TRUE;
  else
    WriteToMailIt(TypeItForTran);
  end;

end;


/**************************************************************************\
|            Запись информации в поля по транзакциям эквайринга            |
\**************************************************************************/
macro WriteInfoForAcqu

  var stat      = TRUE;
  var str       = "";
  var SummaPay  = pay_doc.rec.InSum + pay_docnp.rec.CommSum;
  var Indicator = 0;

  if ( FSCAcqu.FlagStorn )
    Indicator = 1;
  end;

  /* Подсчет итоговых значений */
  NumPPAcqu = NumPPAcqu + 1;
  if   (Trim(curr.ExternalCode) == "810")
    SummaAcquRUB = SummaAcquRUB + SummaPay;
  elif (Trim(curr.ExternalCode) == "840")
    SummaAcquUSD = SummaAcquUSD + SummaPay;
  end;

  if (stat)
    str = Delim + "CSHTX00"                               + Delim; /* Код транзакции    */
    str = str   + DateToUN(pay_doc.rec.Date_Document)     + Delim; /* Дата обработки    */
    str = str   + NumToUN(NumPPAcqu,6)                    + Delim; /* Номер записи      */
    str = str   + NumToUN(2000,4)                         + Delim; /* Код транзакции    */
    str = str   + NumToUN(0,1)                            + Delim; /* Резерв            */
    str = str   + NumToUN(Indicator,1)                    + Delim; /* Индикатор         */
    str = str   + StrToAN( FSCAcqu.cardNumber, 19 )    + Delim; /* Номер карты       */
    str = str   + NumToSD(SummaPay,13)                    + Delim; /* Сумма транзакции  */
    str = str   + StrToAN(" ",1)                          + Delim; /* Резерв            */
    str = str   + NumToUN(Int(Trim(curr.ExternalCode)),3) + Delim; /* Валюта транзакции */
    str = str   + NumToUN(0,6)                            + Delim; /* Номер чека        */
    str = str   + NumToUN(0,8)                            + Delim; /* Дата перевода     */
    str = str   + DateToUN({curdate})                     + Delim; /* Дата обработки    */
    str = str   + StrToAN( FSCAcqu.authCode, 6 )       + Delim; /* Код авторизации   */
    str = str   + CodeTB                                  + Delim; /* Код Тербанка      */
    str = str   + CodeO + CodeF                           + Delim; /* Отделение/филиал  */
    str = str   + NumToUN(0,6)                            + Delim; /* Номер сотрудника  */
    str = str   + StrToAN(" ",17)                         + Delim; /* Адрес терминала   */
    str = str   + NumToUN(0,6)                            + Delim; /* Время транзакции  */
    str = str   + NumToUN(0,1)                            + Delim; /* Тип терминала     */
    str = str   + NumToUN(0,12)                           + Delim; /* MP Amount         */
    stat = Insert(TMPFile5,str);
  end;

  if (NOT stat)
    GlobalError = TRUE;
  else
    WriteToMailIt(TypeItForAcqu);
  end;

end;


/**************************************************************************\
|         Установка на записи по счету и связи для заказа карточки         |
\**************************************************************************/
macro SetAccountAndLinkForCard (flag_change_client)

  var ErrCode = NOERROR;
  var stat;
  var flag;

  /* Поиск карточки - при изменении информации по клиенту */
  if ( ( ErrCode == NOERROR ) and flag_change_client )
    SQLStr = "select * from dsccard_dbt " +
             " where t_FNCash = " + sc_to_pc.rec.Branch +
             "   and t_cardRef = " + sc_to_pc.rec.RecRef;
    RsdSetCard = NULL;
    RsdSetCard = RsdRecordset( SQLStr );
    if ( RsdSetCard.moveNext )
      CopyRSetToFBuff(FSCCard, RsdSetCard);
    else
      ErrCode = "50"; /* Карточка в базе данных не найдена */
    end;
  end;

  /* Определим размер переменной части карточки */
  if ( ErrCode == NOERROR )
    SQLStr = "select 1 from dsccard_dbt" +
             " where dbms_lob.getlength(t_fmtblobdata_xxxx) > 0" +
             "   and t_FNCash = " + BranchCode +
             "   and t_cardRef = " + FSCCard.cardRef;
    RsdSet = NULL;
    RsdSet = RsdRecordset( SQLStr );
    if ( RsdSet.moveNext )
      sbCard.SetRecordAddr( FSCCard, 0, 0, true );
    else
      ErrCode = "61"; /* У карточки отсутствует необходимая переменная часть */
    end;
  end;

  /* Поиск связи Карточка - Счет для карточки */
  /* Сначала пытаемся найти связь по главному счету, потом по первому открытому */
  if (ErrCode == NOERROR)
    scLink.KeyNum = 5;
    scLink.rec.FNCash  = BranchCode;
    scLink.rec.cardRef = FSCCard.cardRef;    
    scLink.rec.mainAcc = "X";
    stat = scLink.GetEQ;
    if ( stat )
      if ( scLink.rec.accCardLinkOpenClose != "" )
        stat = false;
      end;
    end;
    if ( not stat )
      SQLStr = "select * from dSCLink_dbt " +
               " where t_FNCash = " + BranchCode +
               "   and t_cardRef = " + FSCCard.cardRef +
               "   and t_accCardLinkOpenClose = chr(0)";
      RsdSetLink = NULL;
      RsdSetLink = RsdRecordset( SQLStr );
      stat = RsdSetLink.moveNext;
    end;
    if ( NOT stat )
      ErrCode = "60"; /* У карточки отсутствуют открытые связи со счетами */
    end;
  end;

  /* Поиск счета */
  ClearRecord( dr );
  if ( ErrCode == NOERROR )
    KeyNum( dr, 8 );
    dr.Referenc = RsdSetLink.Value("t_cardAccRef");
    stat = GetEQ( dr );
    if ( not stat )
      ErrCode = "51"; /* Счет в базе данных не найден */
    end;
  end;

  /* Поиск валюты */
  ClearRecord(curr);
  if (ErrCode == NOERROR)
    KeyNum(curr,0);
    curr.Code_Currency = dr.Code_Currency;
    stat = GetEQ(curr);
    if (NOT stat)
      ErrCode = "55"; /* Валюта в справочнике валют не найдена */
    end;
  end;

  /* Поиск клиента - держателя карточки */
  depclnt.CurRec.Clear( );
  if ( ErrCode == NOERROR )
    stat = depclnt.GetRecord( FSCCard.CodClient );
    if ( not stat )
      depclnt.CurRec.Clear( );
      ErrCode = "54"; /* Клиент в базе данных не найден */
    end;
  end;

  /* Найдем тип карточки */
  ClearRecord( sc_codif );
  if ( ErrCode == NOERROR )
    KeyNum( sc_codif, 1 );
    sc_codif.codType = LogSC_CardT;
    sc_codif.codCode = FSCCard.cardTypeCode;
    sc_codif.psRef   = 0;
    if ( not GetEQ( sc_codif ) )
      sc_codif.codType = LogSC_CardT;
      sc_codif.codCode = FSCCard.cardTypeCode;
      sc_codif.psRef   = FSCCard.psRef;
      if ( not GetEQ( sc_codif ) )
        ClearRecord( sc_codif );
      end;
    end;
  end;

  return ErrCode;

end;


/**************************************************************************\
|        Проверка заполнения необходимых полей для заказа карточки         |
\**************************************************************************/
macro CheckFillNecessaryFields (AErrCodes)

  var ErrCode = NOERROR;
  var strtmp;
  var i;
  var d;
  var m;

  /* Должна быть задана фамилия клиента */
  if ( StrLen( Trim( depclnt.CurRec.rec.Name1 ) ) == 0 )
    if ( ErrCode == NOERROR )
      ErrCode = "71";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "71";
  end;

  /* Должно быть задано имя клиента */
  if ( StrLen( Trim( depclnt.CurRec.rec.Name2 ) ) == 0 )
    if ( ErrCode == NOERROR )
      ErrCode = "70";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "70";
  end;

  /* Должен быть задан тип продукта */
  if (DefCardType() == 0)
    if (ErrCode == NOERROR)
      ErrCode = "103";
    end;
    AErrCodes(ASize(AErrCodes)) = "103";
  end;

  /* Должен быть задан тип счета */
  if ( StrLen( Trim( sbCard.rec.TypeAccount ) ) == 0 )
    if ( ErrCode == NOERROR )
      ErrCode = "76";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "76";
  end;
  
  /* Должен быт задан код источника */
  if (StrLen(Trim(FormCodeZayavl())) == 0)
    if (ErrCode == NOERROR)
      ErrCode = "106";
    end;
    AErrCodes(ASize(AErrCodes)) = "106";
  end;

  /* Должен быть задан код валюты */
  if (StrLen(Trim(curr.ExternalCode)) == 0)
    if (ErrCode == NOERROR)
      ErrCode = "104";
    end;
    AErrCodes(ASize(AErrCodes)) = "104";
  end;

  /* Должно быть задано эмбосированное имя */
  if ((StrLen(Trim(FSCCard.embossingName1)) == 0) OR (StrLen(Trim(FSCCard.embossingName2)) == 0))
    if (ErrCode == NOERROR)
      ErrCode = "77";
    end;
    AErrCodes(ASize(AErrCodes)) = "77";
  end;
  
  /* Должен быть задан банковский счет */
  if (StrLen(Trim(FormNAcc())) == 0)
    if (ErrCode == NOERROR)
      ErrCode = "105";
    end;
    AErrCodes(ASize(AErrCodes)) = "105";
  end;

  /* Должен быть задан паспорт */
  if ( StrLen( Trim( sbCard.rec.TypePass ) ) == 0 )
    if (ErrCode == NOERROR)
      ErrCode = "74"; /* Не задан тип паспорта */
    end;
    AErrCodes( ASize( AErrCodes ) ) = "74";
  end;

  if ( StrLen( Trim( sbCard.rec.NumPass ) ) == 0 )
    if (ErrCode == NOERROR)
      ErrCode = "75"; /* Не задан номер паспорта */
    end;
    AErrCodes(ASize(AErrCodes)) = "75";
  end;
  
  /* Должен быть задан титул обращения */
  if ( StrLen( Trim( sbCard.rec.TitulClnt ) ) == 0 )
    if ( ErrCode == NOERROR )
      ErrCode = "72";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "72";
  end;
  
  /* Должен быть задан титул эмбосирования */
  if ( StrLen( Trim( sbCard.rec.TitulEmboss ) ) == 0 )
    if ( ErrCode == NOERROR )
      ErrCode = "107";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "107";
  end;

  /* Должен быть задан пол клиента */
  if ( StrLen( Trim( sbCard.rec.ManWom ) ) == 0 )
    if (ErrCode == NOERROR)
      ErrCode = "101";
    end;
    AErrCodes(ASize(AErrCodes)) = "101";
  end;
  
  /* Должна быть задана дата рождения */
  DateSplit( depclnt.CurRec.rec.Born, d, m, NULL );
  if ( ( d == 0 ) or ( m == 0 ) )
    if ( ErrCode == NOERROR )
      ErrCode = "78";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "78";
  end;

  /* Должна быть задана контрольная информация */
  if ( StrLen( Trim( FSCCard.clientPassword ) ) == 0 )
    if ( ErrCode == NOERROR )
      ErrCode = "73";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "73";
  end;

  /* Должна быть задана должность */
  if ( StrLen( Trim( sbCard.rec.PostCompany ) ) == 0 )
    if (ErrCode == NOERROR)
      ErrCode = "102";
    end;
    AErrCodes(ASize(AErrCodes)) = "102";
    /* sbCard.rec.PostCompany = "КЛИЕНТ"; - можно будет инициализировать по умолчанию */
  end;

  /* Должен быть задан адрес */
  if (StrLen(Trim(sbCard.rec.Addr1S1) +
             Trim(sbCard.rec.Addr1S2) +
             Trim(sbCard.rec.Addr1S3) +
             Trim(sbCard.rec.Addr1S4) +
             Trim(sbCard.rec.Addr2S1) +
             Trim(sbCard.rec.Addr2S2) +
             Trim(sbCard.rec.Addr2S3) +
             Trim(sbCard.rec.Addr2S4) +
             Trim(sbCard.rec.Addr3S1) +
             Trim(sbCard.rec.Addr3S2) +
             Trim(sbCard.rec.Addr3S3)  ) == 0)
    if (ErrCode == NOERROR)
      ErrCode = "108";
    end;
    AErrCodes(ASize(AErrCodes)) = "108";
  end;

  /* Должен быть задан индекс */
  if (((StrLen(Trim(sbCard.rec.Addr1S1   ) +
               Trim(sbCard.rec.Addr1S2   ) +
               Trim(sbCard.rec.Addr1S3   ) +
               Trim(sbCard.rec.Addr1S4   )  ) != 0) AND
       (StrLen(Trim(sbCard.rec.IndexAddr1)  ) == 0)     ) OR
      ((StrLen(Trim(sbCard.rec.Addr2S1   ) +
               Trim(sbCard.rec.Addr2S2   ) +
               Trim(sbCard.rec.Addr2S3   ) +
               Trim(sbCard.rec.Addr2S4   )  ) != 0) AND
       (StrLen(Trim(sbCard.rec.IndexAddr2)  ) == 0)     ) OR
      ((StrLen(Trim(sbCard.rec.Addr3S1   ) +
               Trim(sbCard.rec.Addr3S2   ) +
               Trim(sbCard.rec.Addr3S3   )  ) != 0) AND
       (StrLen(Trim(sbCard.rec.IndexAddr3)  ) == 0)     )   )
    if (ErrCode == NOERROR)
      ErrCode = "109";
    end;
    AErrCodes(ASize(AErrCodes)) = "109";
  end;
  
  /* Должен быть задан тип адреса */
  if (((StrLen(Trim(sbCard.rec.IndexAddr1) +
               Trim(sbCard.rec.Addr1S1   ) +
               Trim(sbCard.rec.Addr1S2   ) +
               Trim(sbCard.rec.Addr1S3   ) +
               Trim(sbCard.rec.Addr1S4   )  ) != 0) AND
       (StrLen(Trim(sbCard.rec.TypeAddr1 )  ) == 0)     ) OR
      ((StrLen(Trim(sbCard.rec.IndexAddr2) +
               Trim(sbCard.rec.Addr2S1   ) +
               Trim(sbCard.rec.Addr2S2   ) +
               Trim(sbCard.rec.Addr2S3   ) +
               Trim(sbCard.rec.Addr2S4   )  ) != 0) AND
       (StrLen(Trim(sbCard.rec.TypeAddr2 )  ) == 0)     ) OR
      ((StrLen(Trim(sbCard.rec.IndexAddr3) +
               Trim(sbCard.rec.Addr3S1   ) +
               Trim(sbCard.rec.Addr3S2   ) +
               Trim(sbCard.rec.Addr3S3   )  ) != 0) AND
       (StrLen(Trim(sbCard.rec.TypeAddr3 )  ) == 0)     )   )
    if (ErrCode == NOERROR)
      ErrCode = "110";
    end;
    AErrCodes(ASize(AErrCodes)) = "110";
  end;

  /* Длина эмбосирования */
  if ( Index( FSCCard.cardTypeCode, "VE" ) > 0 )
    /* LAA увеличина длина эмбоссирования  */
    if ( ( StrLen( Trim( FSCCard.embossingName1 ) ) + 
           StrLen( Trim( FSCCard.embossingName2 ) ) +
           StrLen( Trim( sbCard.rec.TitulEmboss    ) ) + 3 ) > 22 )
      if ( ErrCode == NOERROR )
        ErrCode = "111";
      end;
      AErrCodes( ASize( AErrCodes ) ) = "111";
    end;
  else
    if ( ( StrLen( Trim( FSCCard.embossingName1 ) ) + 
           StrLen( Trim( FSCCard.embossingName2 ) ) +
           StrLen( Trim( sbCard.rec.TitulEmboss    ) ) + 3 ) > 25 )
      if ( ErrCode == NOERROR )
        ErrCode = "111";
      end;
      AErrCodes( ASize( AErrCodes ) ) = "111";
    end;
  end;
    
  /* Код почтового отделения */
  if ( ErrCode == NOERROR )
    if ( StrLen( Trim( sbCard.rec.PostCode ) ) == 0 )
      sbCard.rec.PostCode = "X"; /* По умолчанию - Ничего не высылать */
    end;
  end;

  /* Номер адреса для выписок */
  if (ErrCode == NOERROR)
    if ((sbCard.rec.NumberPrimaryAddr < 1) OR (sbCard.rec.NumberPrimaryAddr > 3))
      sbCard.rec.NumberPrimaryAddr = 1;
    end;
  end;

  /* Код класса */
  /*
  if (ErrCode == NOERROR)
    if (sbCard.rec.CodeClassClient == 0)
      sbCard.rec.CodeClassClient = 60;
    end;
  end;
  */

  return ErrCode;

end;


/**************************************************************************\
|    Установка на записи по карточке и клиенту для блокировки карточки     |
\**************************************************************************/
macro SetCardAndClientForBlockOv

  var ErrCode = NOERROR;
  var stat;

  /* Поиск карточки */
  if ( ErrCode == NOERROR )
    SQLStr = "select * from dsccard_dbt " +
             " where t_FNCash = " + sc_to_pc.rec.Branch +
             "   and t_cardRef = " + sc_to_pc.rec.RecRef;
    RsdSetCard = NULL;
    RsdSetCard = RsdRecordset( SQLStr );
    if ( RsdSetCard.moveNext )
      CopyRSetToFBuff(FSCCard, RsdSetCard);
      SQLStr = "select 1 from dsccard_dbt" +
               " where dbms_lob.getlength(t_fmtblobdata_xxxx) > 0" +
               "   and t_FNCash = " + BranchCode +
               "   and t_cardRef = " + FSCCard.cardRef;
      RsdSet = NULL;
      RsdSet = RsdRecordset( SQLStr );
      if ( RsdSet.moveNext )
        sbCard.SetRecordAddr( FSCCard, 0, 0, true );
      else
        ErrCode = "61"; /* У карточки отсутствует необходимая переменная часть */
      end;
    else
      ErrCode = "50"; /* Карточка в базе данных не найдена */
    end;
  end;

  /* Поиск клиента - держателя карточки */
  if ( ErrCode == NOERROR )
    stat = depclnt.GetRecord( FSCCard.CodClient );
    if ( not stat )
      ErrCode = "54"; /* Клиент в базе данных не найден */
    end;
  end;

  /* Поиск типа карточки */
  if ( ErrCode == NOERROR )
    KeyNum( sc_codif, 1 );
    sc_codif.codType = LogSC_CardT;
    sc_codif.codCode = FSCCard.cardTypeCode;
    sc_codif.psRef   = 0;
    if ( not GetEQ( sc_codif ) )
      sc_codif.codType = LogSC_CardT;
      sc_codif.codCode = FSCCard.cardTypeCode;
      sc_codif.psRef   = FSCCard.psRef;
      if ( not GetEQ( sc_codif ) )
        ClearRecord( sc_codif );
      end;
    end;
  else
    ClearRecord( sc_codif );
  end;

  return ErrCode;

end;


/**************************************************************************\
|      Проверка заполнения необходимых полей для блокировки карточки       |
\**************************************************************************/
macro CheckFillNecessaryFieldsForBlockOv (AErrCodes)

  var ErrCode = NOERROR;

  /* У карточки неверен формат номера */
  if ( StrLen( Trim( FSCCard.cardNumber ) ) < 10 )
    if ( ErrCode == NOERROR )
      ErrCode = "65";
    end;
    AErrCodes( ASize( AErrCodes ) ) = "65";
  end;

  return ErrCode;

end;


/**************************************************************************\
|                 Была ли запись успешно обработана ранее                  |
\**************************************************************************/
macro WasSuccessSentBefore ( AppKind, AppKey )

  var stat = false;
  var Ref1 = AppKind;
  var Ref2 = AppKey;

  if ( (Ref1 != 0 ) or ( Ref2 != "" ) )
    var cmd = RsdCommand(
        "SELECT 1 "+
        "FROM dscMail_dbt "+
        "WHERE t_ApplKind = ? "+
        "  AND t_ApplKey = ? ");
    cmd.addParam("ApplKind", RSDBP_IN, AppKind);
    cmd.addParam("ApplKey", RSDBP_IN, AppKey);
    cmd.execute();

    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    if (rs.moveNext())
      return true;
    end;
    
  
    SQLStr = "select * from dscMailIt_dbt " +
             " where t_FNCash = " + BranchCode +
             "   and t_SessItemType = " + LogSC_depdoc+
             "   and t_mailRefFile = " + Ref1+
             "   and t_mailRefFile2 = " + Ref2;
    RsdSet = NULL;
    RsdSet = RsdRecordset( SQLStr );
    while ( (RsdSet.moveNext) and (not stat) )
      scMail.KeyNum = 0;
      scMail.rec.FNCash  = FNCash;
      scMail.rec.mailRef = RsdSet.Value("t_mailRef");
      if ( scMail.GetEQ )
        if ( scMail.rec.EndSession == "X" )
          stat = true;
        end;
      end;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|   Установка на записи счета, клиента и карточки для операции по счету    |
\**************************************************************************/
macro SetAccountAndCardForDoc

  var stat = TRUE;
  var flag;
  var NeedContinue;

  /* Найдем счет вкладчика */
  if (stat)
    KeyNum(dr,8);
    dr.Referenc = RsdSetAcc.Value("t_Referenc");
    stat = GetEQ( dr );
  end;

  /* Найдем валюту счета */
  if ( stat )
    KeyNum( curr, 0 );
    curr.Code_Currency = dr.Code_Currency;
    stat = GetEQ( curr );
  end;

  /* Найдем владельца счета */
  if (stat)
    if ( depclnt.GetRecord( dr.CodClient ) )
      ;
    else
      depclnt.CurRec.Clear( );
    end;
  end;

  /* Найдем связь с карточкой и карточку */
  if ( stat )
    NeedContinue = true;
    scLink.KeyNum = 6;
    scLink.rec.cardAccRef = RsdSetAcc.Value("t_Referenc");
    scLink.rec.mainCard   = "X";
    if ( scLink.GetEQ )
      if ( ( scLink.rec.accCardLinkOpenClose == "" ) or IsComplexOperCloseAcc( ) )
        SQLStr = "select * from dScCard_dbt" + 
                 " where t_FNCash = " + BranchCode +
                 "   and t_cardRef = " + scLink.rec.cardRef;
        RsdSetCard = NULL;
        RsdSetCard = RsdRecordset(SQLStr);
        if ( RsdSetCard.moveNext )
          CopyRSetToFBuff(FSCCard, RsdSetCard);
          if ( StateCompare( FSCCard.cardStateCode, VCardState_OFF,   LogSC_CardS, psRef ) or
               StateCompare( FSCCard.cardStateCode, VCardState_OFFPC, LogSC_CardS, psRef )   )
            ;
          else
            NeedContinue = false;
          end;
        end;
      end;
    end;
    if ( NeedContinue )
      SQLStr = "select * from dScLink_dbt" + 
               " where t_FNCash = " + BranchCode +
               "   and t_cardAccRef = " + RsdSetAcc.Value("t_Referenc");
      RsdSet = NULL;
      RsdSet = RsdRecordset(SQLStr);
      while ( (RsdSet.moveNext) and (NeedContinue) )
        if ( ( RsdSet.Value("t_accCardLinkOpenClose") == "" ) or IsComplexOperCloseAcc( ) )
          SQLStr = "select * from dScCard_dbt" + 
                   " where t_FNCash = " + BranchCode +
                   "   and t_cardRef = " + RsdSet.Value("t_cardRef");
          RsdSetCard = NULL;
          RsdSetCard = RsdRecordset(SQLStr);
          if ( RsdSetCard.moveNext )
            CopyRSetToFBuff(FSCCard, RsdSetCard);
            if ( StateCompare( FSCCard.cardStateCode, VCardState_OFF,   LogSC_CardS, psRef ) or
                 StateCompare( FSCCard.cardStateCode, VCardState_OFFPC, LogSC_CardS, psRef )   )
              ;
            else
              NeedContinue = false;
            end;
          end;
        end;
      end;

    end;
    if ( NeedContinue )
      stat = false;
    end;
  end;

  /* Найдем тип карточки */
  if (stat)
    KeyNum(sc_codif,1);
    sc_codif.codType = LogSC_CardT;
    sc_codif.codCode = FSCCard.cardTypeCode;
    sc_codif.psRef   = 0;
    if (NOT GetEQ(sc_codif))
      sc_codif.codType = LogSC_CardT;
      sc_codif.codCode = FSCCard.cardTypeCode;
      sc_codif.psRef   = FSCCard.psRef;
      if (NOT GetEQ(sc_codif))
        ClearRecord(sc_codif);
      end;
    end;
  else
    ClearRecord(sc_codif);
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro NeedSendCurrentDepDoc

  var mainKind = 0;
  var mainKey  = "";
  var stat     = true;

  /* Отсечем архивную проводку */
  if ( stat )
    if ( ( sbdepdoc.KindOp == D_AR           ) or
         ( sbdepdoc.KindOp == D_ARC          ) or
         ( sbdepdoc.KindOp == D_AUDIT_STORN  ) or
         ( sbdepdoc.KindOp == D_AUDIT_DELETE ) or
         ( sbdepdoc.KindOp == D_AUDIT_CORRECT) or
         ( sbdepdoc.Action == D_DELETE       )   )
      stat = false;
    end;
  end;

  /* Непроведенный документ */
  if ( ( sbdepdoc.IsSuspended != "" ) and ( sbdepdoc.IsSuspended != "X" ) )
    stat = false;
  end;

  /* Предварительный расчет завершения отчетного периода */
  if ( stat )
    if ( sbdepdoc.Mode == MODE_EOY_PRECALC )
      stat = false;
    end;
  end;

  /* Отсечем неподтвержденный документ */
  if ( stat )
    if ( sbdepdoc.NotConfirm != "" )
      stat = false;
    end;
  end;

  /* Отсечем проводку из Процессингового центра без возврата информации */
  if ( stat )
    if ( sbdepdoc.iApplicationKind == AK_DEPSC )
      stat = false;
    end;
  end;

  /* Берем только приходные операции и закрытие счета */
  if ( stat )
    if ( IsOperCloseAcc( ) )
      ;
    elif ( sbdepdoc.TypeOper == 92 )
      sbdepdoc5.SetRecordAddr( sbdepdoc, 0, 0, true );
      if ( ( sbdepdoc5.rec.Percent1 == 0 ) and ( sbdepdoc5.rec.Percent2 == 0 ) )
        stat = false;
      end;
    elif ( sbdepdoc.TypeOper == 93 )
      stat = false;
    elif ( ( sbdepdoc.TypeOper == 38 ) or ( sbdepdoc.TypeOper == 39 ) )
      stat = false;
    elif ( sbdepdoc.InSum != 0 )
      ;
    else
      stat = false;
    end;
  end;

  /* Была ли данная запись успешно обработана ранее */
  if ( stat )
    if ( WasSuccessSentBefore( sbdepdoc.iApplicationKind, sbdepdoc.ApplicationKey ) )
      stat = false;
    end;
  end;

  /* Сторнирующий документ передаем если был передан сторнируемый документ */
  if ( stat )
    if ( sbdepdoc.FlagStorn )

      stat = false;

      sb_casln.KeyNum = 1;
      sb_casln.Clear;
      sb_casln.rec.ApplicationKind2 = sbdepdoc.iApplicationKind;
      sb_casln.rec.ApplicationKey2  = sbdepdoc.ApplicationKey;
      sb_casln.addFilter( "t.t_ApplicationKind2 = " + string( sbdepdoc.iApplicationKind ) + " and " +
                          "t.t_ApplicationKey2 = " + GetSQLString( sbdepdoc.ApplicationKey )         );
      if ( sb_casln.GetGE )
        if ( ( sb_casln.rec.ApplicationKind2 == sbdepdoc.iApplicationKind ) and
             ( sb_casln.rec.ApplicationKey2  == sbdepdoc.ApplicationKey   )    )
          mainKind = sb_casln.rec.ApplicationKind1;
          mainKey  = sb_casln.rec.ApplicationKey1;
        end;
      end;
      sb_casln.dropFilter;

      if ( ( mainKind != 0 ) and ( mainKey != "" ) )
        SQLStr = "select * from dsb_casln_dbt " +
                 " where t_ApplicationKind1 = " + mainKind + 
                 "   and t_ApplicationKey1 = '" + mainKey + "'";
        RsdSet = NULL;
        RsdSet = RsdRecordset( SQLStr );
        while ( (RsdSet.moveNext) and (not stat) )
          if ( ( RsdSet.Value("t_RefValue2") == 0 ) and ( RsdSet.Value("t_ApplicationKind2") == 1 ) )
            if ( WasSuccessSentBefore( RsdSet.Value("t_ApplicationKind2"), RsdSet.Value("t_ApplicationKey2") ) )
              stat = true; /* Документ из сторнированной связки учавствовал */
            end;           /* в сеансе связи */
          end;
        end;
        sb_casln.dropFilter;
      end;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                       История по операциям по счету                      |
\**************************************************************************/
macro HistoryDepDocForAccount

  SQLStr = "select * from dSbdepdoc_dbt"+
           " where t_Referenc = " + RsdSetAcc.Value("t_Referenc") +
           " and t_Date_Document between " + sqlDateToStr(BegDate) + " and " + sqlDateToStr(EndDate);
  RsdSetDepDoc = NULL;
  RsdSetDepDoc = RsdRecordset( SQLStr );

  while ( RsdSetDepDoc.MoveNext )
    CopyRSetToFBuff(sbdepdoc, RsdSetDepDoc);
    if ( NeedSendCurrentDepDoc( ) )
      if ( SetAccountAndCardForDoc( ) )
        WriteInfoForAccountInOut( );
        WriteDocToReport( );
      end;
    end;
  end;

end;


/**************************************************************************\
|     Установка на записи по прочей расходной операции для эквайринга      |
\**************************************************************************/
macro SetPayDocAndOtherForAcqu

  var ErrCode = NOERROR;
  var stat;
  var flag;

  /* Поиск документа по прочей расходной операции */
  if ( ErrCode == NOERROR )
    pay_doc.Clear;
    pay_doc.rec.iApplicationKind = FSCAcqu.PayDocApplKind;
    pay_doc.rec.ApplicationKey   = FSCAcqu.PayDocApplKey;
    stat = pay_doc.GetEQ;
    if ( not stat )
      ErrCode = "80"; /* Не найден документ по расходной операции */
      pay_docnp.Clear;
    else
      pay_docnp.SetRecordAddr( pay_doc, 0, 0, true );
    end;
  end;

  /* Поиск валюты */
  if ( ErrCode == NOERROR )
    KeyNum( curr, 0 );
    curr.Code_Currency = pay_doc.rec.CodCur;
    stat = GetEQ( curr );
    if ( not stat )
      ErrCode = "55"; /* Валюта в справочнике валют не найдена */
    end;
  end;

  /* Найдем тип карточки */
  if ( ErrCode == NOERROR )
    KeyNum( sc_codif, 1 );
    sc_codif.codType = LogSC_CardT;
    sc_codif.codCode = FSCAcqu.cardTypeCode;
    sc_codif.psRef   = 0;
    if ( not GetEQ( sc_codif ) )
      sc_codif.codType = LogSC_CardT;
      sc_codif.codCode = FSCAcqu.cardTypeCode;
      sc_codif.psRef   = psRef;
      if ( not GetEQ( sc_codif ) )
        ClearRecord( sc_codif );
      end;
    end;
  else
    ClearRecord( sc_codif );
  end;

  return ErrCode;

end;


/**************************************************************************\
|     Проверка заполнения необходимых полей для транзакций эквайринга      |
\**************************************************************************/
macro CheckFillNecessaryFieldsForAcqu (AErrCodes)

  var ErrCode = NOERROR;

  /* Должен быть задан номер карточки */
  if (StrLen(Trim(FSCAcqu.cardNumber)) == 0)
    if (ErrCode == NOERROR)
      ErrCode = "81"; /* Номер карточки не задан */
    end;
    AErrCodes(ASize(AErrCodes)) = "81";
  end;

  /* Должен быть задан код авторизации */
  if (StrLen(Trim(FSCAcqu.authCode)) == 0)
    if (ErrCode == NOERROR)
      ErrCode = "82";
    end;
    AErrCodes(ASize(AErrCodes)) = "82";
  end;

  return ErrCode;

end;


/**************************************************************************\
| Запись информации во временные файлы о клиентах, карточках и транзакциях |
\**************************************************************************/
macro WriteToTempClientsAndCardsAndTran

  var   stat;
  var   RecCounter = 0;
  var   ErrCode;
  array AErrCodes;

  [];
  [];
  [ Подразделение: #] (NameBranch);
  [];
  /* Формирование заявки на изготовление новой карточки =============== */
  HeadCardNewForReport( false );
  SQLStr = "select * from dsccard_dbt " +
           " where t_FNCash = " + BranchCode +
           "   and t_cardStateCode = '" + VCardState_OFF + "'";
  RsdSetCard = NULL;
  RsdSetCard = RsdRecordset( SQLStr );
  if (RsdSetCard != NULL)
    while( RsdSetCard.moveNext )
      RecCounter = RecCounter + 1;
      Message(" Заказ карточек. Обрабатывается ",RecCounter:4," карточка ...");
      CopyRSetToFBuff(FSCCard, RsdSetCard);
      ASize( AErrCodes, 0 );
      ErrCode = SetAccountAndLinkForCard( false );
      if ( ErrCode == NOERROR )
        ErrCode = CheckFillNecessaryFields( AErrCodes );
      end;
      if ( ErrCode == NOERROR )
        WriteInfoForClientAndCard( false );
      end;
      WriteCardNewToReport( ErrCode, AErrCodes );
    end;
  end;
  BottomCardNewForReport( );

  /* Формирование информации о измененной информации по клиенту ======= */
  HeadCardNewForReport( true );
  RecCounter = 0;
  sc_to_pc.KeyNum = 0;
  sc_to_pc.rec.Branch     = BranchCode;
  sc_to_pc.rec.FormatFile = "CL";
  sc_to_pc.rec.CodeOper   = "";
  sc_to_pc.rec.RecRef     = 0;
  sc_to_pc.addFilter( "t.t_Branch = " + string( BranchCode ) + " and " +
                      "t.t_FormatFile = " + GetSQLString( "CL" )        );
  stat = sc_to_pc.GetGE;
  while ( stat )
    if ( ( sc_to_pc.rec.Branch     == BranchCode ) and
         ( sc_to_pc.rec.FormatFile == "CL"   )    )
      if (sc_to_pc.rec.MailRef == 0)
        RecCounter = RecCounter + 1;
        Message(" Изменение информации по клиенту. Обрабатывается ",RecCounter:4," карточка ...");
        ASize(AErrCodes,0);
        ErrCode = SetAccountAndLinkForCard(TRUE);
        if (ErrCode == NOERROR)
          ErrCode = CheckFillNecessaryFields(AErrCodes);
        end;
        if ( ErrCode == NOERROR )
          if ( ( StateCompare( FSCCard.cardStateCode, "OFF__", LogSC_CardS, FSCCard.psRef ) ) or
               ( StateCompare( FSCCard.cardStateCode, "CLS__", LogSC_CardS, FSCCard.psRef ) )   )
            sc_to_pc.rec.MailRef = -1;
            sc_to_pc.Update;
          else
            WriteInfoForClientAndCard( true );
          end;
        end;
        if ( sc_to_pc.rec.MailRef != -1 )
          sc_to_pc.rec.MailRef = MailRef;
          if ( not sc_to_pc.Update )
            GlobalError = true;
          end;
          WriteCardNewToReport( ErrCode, AErrCodes );
        end;
      end;
      stat = sc_to_pc.Next;
    else
      stat = false;
    end;
  end;
  sc_to_pc.dropFilter;
  BottomCardNewForReport( );

  /* Формирование информации о блокировке и перевыпуске =============== */
  HeadCardBlockOvForReport( );
  RecCounter = 0;
  sc_to_pc.KeyNum = 0;
  sc_to_pc.rec.Branch     = BranchCode;
  sc_to_pc.rec.FormatFile = "";
  sc_to_pc.rec.CodeOper   = "";
  sc_to_pc.rec.RecRef     = 0;
  sc_to_pc.addFilter( "t.t_Branch = " + string( BranchCode ) + " and " +
                      "t.t_FormatFile = " + GetSQLString( "" )          );
  stat = sc_to_pc.GetGE;
  while ( stat )
    if ( ( sc_to_pc.rec.Branch     == BranchCode ) and
         ( sc_to_pc.rec.FormatFile == ""     )    )
      if ( sc_to_pc.rec.MailRef == 0 )
        RecCounter = RecCounter + 1;
        Message(" Блокировка/перевыпуск карточек. Обрабатывается ",RecCounter:4," карточка ...");
        ASize( AErrCodes, 0 );
        ErrCode = SetCardAndClientForBlockOv( );
        if ( ErrCode == NOERROR )
          ErrCode = CheckFillNecessaryFieldsForBlockOv( AErrCodes );
        end;
        if (ErrCode == NOERROR)
          if   ( ( sc_to_pc.rec.CodeOper == "UB" ) and ( not StateCompare( FSCCard.cardStateCode, "OK___", LogSC_CardS, FSCCard.psRef ) ) )
            sc_to_pc.rec.MailRef = -1;
            sc_to_pc.Update;
          elif ( ( sc_to_pc.rec.CodeOper == "BL" ) and ( SubStr( FSCCard.cardStateCode, 1, 3 ) != "BLK" ) )
            sc_to_pc.rec.MailRef = -1;
            sc_to_pc.Update;
          elif ( ( sc_to_pc.rec.CodeOper == "OV" ) and ( SubStr( FSCCard.cardStateCode, 1, 3 ) != "OVR" ) )
            sc_to_pc.rec.MailRef = -1;
            sc_to_pc.Update;
          else
            WriteInfoForBlockOvCard( );
          end;
        end;
        if ( sc_to_pc.rec.MailRef != -1 )
          sc_to_pc.rec.MailRef = MailRef;
          if ( not sc_to_pc.Update )
            GlobalError = true;
          end;
          WriteBlockOvCardToReport( ErrCode, AErrCodes );
        end;
      end;
      stat = sc_to_pc.Next;
    else
      stat = false;
    end;
  end;
  sc_to_pc.dropFilter;
  BottomCardBlockOvForReport( );

  /* Формирование информации о лимитах операций ======================= */
  HeadLimitForReport();
  RecCounter = 0;  

  var cmd;
  var printed;

  cmd = RsdCommand( "select t_branch, t_recref from dsc_to_pc_dbt " +
                    "where t_branch = " + String( FNcash )  + " and t_formatfile = ' ' " + 
                    "and t_codeoper = 'LM' and t_mailref = 0" );
  cmd.execute;
  rsSC = RsdRecordset( cmd );

  while ( rsSC.moveNext )
    RecCounter = RecCounter + 1;
    Message(" Установление лимитов операций по карте. Обрабатывается ", RecCounter:4, " карта...");

    cmd = RsdCommand( "select t_level, t_type, t_period, t_operkind, t_limitvalue, t_limitid " + 
                      "from dsclimit_dbt lm, dscLmType_dbt lt where exists " + 
                      "(select 'x' from dsccard_dbt " + 
                      "where t_fncash = " + String( rsSC.value("t_branch") ) + 
                      " and t_cardref = " + String( rsSC.value("t_recref") ) + 
                      " and t_cardstatecode not in ('OFF__','OFFPC','CLS__'))" + 
                      " and lm.t_fncash =  " + String( rsSC.value("t_branch") ) + 
                      " and lm.t_cardref = " + String( rsSC.value("t_recref") ) + 
                      " and lm.t_action <> 2 and lt.t_LimitTypeID = lm.t_LimitTypeID" );
    cmd.execute;
    rsLM = RsdRecordset( cmd );


    printed = false;

    while ( rsLM.moveNext )
      if ( printed != true )
         WriteLimitToReport();
         printed = true;
      end;
      WriteInfoForLimit();
    end;

    cmd = RsdCommand( "update dsc_to_pc_dbt set t_mailref = " + String( Mailref ) +
                      " where t_branch = " + String( rsSC.value("t_branch") ) +
                      " and t_formatfile = ' '" +
                      " and t_recref = " + String( rsSC.value("t_recref") ) +
                      " and t_codeoper = 'LM'" );
    cmd.execute;
  end; 

  BottomLimitForReport();      

  /* Формирование проводок по карточным счетам ======================== */
  HeadDocForReport( );
  RecCounter = 0;
  SQLStr = "select * from dScAcc_dbt where t_FNCash = " + BranchCode +
           " order by t_FlagCur ASC";
  RsdSetAcc = NULL;
  RsdSetAcc = RsdRecordset( SQLStr );

  if (RsdSetAcc != NULL)
    while ( RsdSetAcc.MoveNext )
        RecCounter = RecCounter + 1;
        Message(" Операции по карточкам. Обрабатывается ",RecCounter:4," счет ...");
        HistoryDepDocForAccount( );
    end;
  end;
  BottomDocForReport( );

  /* Формирование проводок эквайера по карточкам ====================== */
  HeadTranAcquForReport( );
  RecCounter = 0;
  SQLStr = "select * from dscAcqu_dbt" +
           " where t_FNCash = " + BranchCode +
           "   and t_acqDate = " + sqlDateToStr({curdate}) +
           " order by t_FlagCur ASC";
  RsdSetAcqu = NULL;
  RsdSetAcqu = RsdRecordset( SQLStr );
  if (RsdSetAcqu != NULL)
    while ( RsdSetAcqu.MoveNext )
      if ( ( RsdSetAcqu.Value("t_psRef") == psRef ) and
           ( StateCompare( RsdSetAcqu.Value("t_acqStateCode"), VAcquState_INI, LogSC_AcquS, psRef ) )   )
        RecCounter = RecCounter + 1;
        Message(" Транзакции эквайринга. Обрабатывается ",RecCounter:4," операция ...");
        CopyRSetToFBuff(FSCAcqu, RsdSetAcqu);
        ASize( AErrCodes, 0 );
        ErrCode = SetPayDocAndOtherForAcqu( );
        if ( ErrCode == NOERROR )
          ErrCode = CheckFillNecessaryFieldsForAcqu( AErrCodes );
        end;
        if ( ErrCode == NOERROR )
          WriteInfoForAcqu( );
        end;
        WriteAcquToReport( ErrCode, AErrCodes );
      end;
    end;
  end;
  BottomTranAcquForReport( );

end;


/**************************************************************************\
|  Запись информации в выходной файл о клиентах, карточках и транзакциях   |
\**************************************************************************/
macro WriteToOutClientsAndCardsAndTran

  /* Слияние информации из временных файлов в выходной =================== */
  if ( not GlobalError )
    /* Перечитаем временные файлы на чтение */
    Close( TMPFile1 );
    Close( TMPFile2 );
    Close( TMPFile3 );
    Close( TMPFile4 );
    Close( TMPFile5 );
    Close( TMPFile6 );
    if ( not Open( TMPFileR1, MaskTMP + "TM1" ) )
      GlobalError = true;
    end;
    if ( not Open( TMPFileR2, MaskTMP + "TM2" ) )
      GlobalError = true;
    end;
    if ( not Open( TMPFileR3, MaskTMP + "TM3" ) )
      GlobalError = true;
    end;
    if ( not Open( TMPFileR4, MaskTMP + "TM4" ) )
      GlobalError = true;
    end;
    if ( not Open( TMPFileR5, MaskTMP + "TM5" ) )
      GlobalError = true;
    end;
    if ( not Open( TMPFileR6, MaskTMP + "TM6" ) )
      GlobalError = true;
    end;
    /* Слияние информации */
    if ( not GlobalError )
      /* Слияние информации о клиентах и заказе, блокировке и перевыпуске карточек */
      if ( NumPPCardNew or NumPPCardBlockOv or NumPPLimit )
        WriteHeadForCard( );
        while ( Next( TMPFileR1 ) )
          if ( StrLen( TMPFileR1.str ) )
            TMPFileR1.str = StrUpr( TMPFileR1.str );
            while ( StrLen( TMPFileR1.str ) < OutLen )
              TMPFileR1.str = TMPFileR1.str + " ";
            end;
            if ( not Insert( OutFile, TMPFileR1.str ) )
              GlobalError = true;
            end;
          end;
        end;
        while ( Next( TMPFileR2 ) )
          if (StrLen(TMPFileR2.str))
            TMPFileR2.str = StrUpr(TMPFileR2.str);
            while (StrLen(TMPFileR2.str) < OutLen)
              TMPFileR2.str = TMPFileR2.str + " ";
            end;
            if (NOT Insert(OutFile,TMPFileR2.str))
              GlobalError = TRUE;
            end;
          end;
        end;
        while ( Next( TMPFileR3 ) )
          if ( StrLen( TMPFileR3.str ) )
            TMPFileR3.str = StrUpr( TMPFileR3.str );
            while ( StrLen( TMPFileR3.str ) < OutLen )
              TMPFileR3.str = TMPFileR3.str + " ";
            end;
            if ( not Insert( OutFile, TMPFileR3.str ) )
              GlobalError = true;
            end;
          end;
        end;
        while ( Next( TMPFileR6 ) )
          if ( StrLen( TMPFileR6.str ) )
            TMPFileR6.str = StrUpr( TMPFileR6.str );
            while ( StrLen( TMPFileR6.str ) < OutLen )
              TMPFileR6.str = TMPFileR6.str + " ";
            end;
            if ( not Insert( OutFile,TMPFileR6.str ) )
              GlobalError = true;
            end;
          end;
        end;
        WriteBotForCard( );
      end;
      /* Слияние информации по транзакциям эмитента и эквайера */
      if ( NumPPTran or NumPPAcqu )
        if ( NumPPTran )
          WriteHeadForTran( );
          while ( Next( TMPFileR4 ) )
            if ( StrLen( TMPFileR4.str ) )
              TMPFileR4.str = StrUpr( TMPFileR4.str );
              while ( StrLen( TMPFileR4.str ) < OutLen )
                TMPFileR4.str = TMPFileR4.str + " ";
              end;
              if ( not Insert( OutFile,TMPFileR4.str ) )
                GlobalError = true;
              end;
            end;
          end;
        end;
        if ( NumPPAcqu )
          WriteHeadForAcqu( );
          while ( Next( TMPFileR5 ) )
            if ( StrLen( TMPFileR5.str ) )
              TMPFileR5.str = StrUpr( TMPFileR5.str );
              while ( StrLen( TMPFileR5.str ) < OutLen )
                TMPFileR5.str = TMPFileR5.str + " ";
              end;
              if ( not Insert( OutFile, TMPFileR5.str ) )
                GlobalError = true;
              end;
            end;
          end;
        end;
        WriteBotForTran( );
      end;
      /* Удаление временных файлов */
      Close( TMPFileR1 );
      Close( TMPFileR2 );
      Close( TMPFileR3 );
      Close( TMPFileR4 );
      Close( TMPFileR5 );
      Close( TMPFileR6 );
      DelFile( MaskTMP + "TM1" );
      DelFile( MaskTMP + "TM2" );
      DelFile( MaskTMP + "TM3" );
      DelFile( MaskTMP + "TM4" );
      DelFile( MaskTMP + "TM5" );
      DelFile( MaskTMP + "TM6" );
    end;
  end;

end;


/**************************************************************************\
|        Транзакция по записи информации об окончании сеанса связи         |
\**************************************************************************/
macro Write_X_To_Mail

  var stat;
  var i = 0;

 while (i < ASize(BranchOut))
  BranchCode = BranchOut(i);
  MailRef = BranchMailRef(i);

  scMail.KeyNum = 0;
  scMail.rec.FNCash  = BranchCode;
  scMail.rec.mailRef = MailRef;
  stat = scMail.GetEQ;
  if ( stat )
    scMail.rec.EndSession    = "X";
    scMail.rec.mailStateCode = VMailState_OK;
    stat = scMail.Update;
  end;

  if ( not stat )
    GlobalError = true;
    AbortTrn( );
  end;

  /* Поставим у карточек, связей и операций по эквайрингу соответствующие признаки */
  scMailIt.KeyNum = 1;
  scMailIt.rec.FNCash  = BranchCode;
  scMailIt.rec.mailRef = MailRef;
  stat = scMailIt.GetEQ;
  while ( stat )
    if ( ( scMailIt.rec.FNCash  == BranchCode  ) and
         ( scMailIt.rec.mailRef == MailRef )    )
      /* -------------------------------------------------------- */
      if ( scMailIt.rec.SessItemType == LogSC_Link )
        scLink.KeyNum = 0;
        scLink.rec.FNCash         = scMailIt.rec.FNCash;
        scLink.rec.accCardLinkRef = scMailIt.rec.mailRefFile;
        if ( scLink.GetEQ )
          scLink.rec.accCardLinkState = VLinkState_OK;
          if ( not scLink.Update )
            GlobalError = true;
            AbortTrn( );
          else
            scCard.KeyNum = 0;
            scCard.rec.FNCash  = scLink.rec.FNCash;
            scCard.rec.cardRef = scLink.rec.cardRef;
            if ( scCard.GetEQ )
              scCard.rec.cardStateCode = VCardState_OFFPC;
              if ( not scCard.Update )
                GlobalError = true;
                AbortTrn( );
              end;
            end;
          end;
        end;
      /* -------------------------------------------------------- */
      elif ( scMailIt.rec.SessItemType == LogSC_Acqu )
        scAcqu.KeyNum = 6;
        scAcqu.rec.PayDocApplKind = scMailIt.rec.mailRefFile;
        scAcqu.rec.PayDocApplKey  = scMailIt.rec.mailRefFile2;
        if ( scAcqu.GetEQ )
          scAcqu.rec.acqStateCode = VAcquState_INIPC;
          if ( not scAcqu.Update )
            GlobalError = true;
            AbortTrn( );
          end;
        end;
      end;
      stat = scMailIt.Next;
    else
      stat = false;
    end;
  end;

  sc_to_pc.KeyNum = 0;
  sc_to_pc.rec.Branch     = BranchCode;
  sc_to_pc.rec.FormatFile = "";
  sc_to_pc.rec.CodeOper   = 0;
  sc_to_pc.rec.RecRef     = 0;
  sc_to_pc.addFilter( "t.t_Branch = " + string( BranchCode ) );
  stat = sc_to_pc.GetGE;
  while ( stat )
    if ( sc_to_pc.rec.Branch == BranchCode )
      if ( ( sc_to_pc.rec.MailRef == -1 ) or ( sc_to_pc.rec.MailRef == MailRef ) )
        if ( not sc_to_pc.Delete )
          GlobalError = true;
          AbortTrn( );
        end;
      end;
      stat = sc_to_pc.Next;
    else
      stat = false;
    end;
  end;
  sc_to_pc.dropFilter;

  i = i + 1;
 end;

end;


/**************************************************************************\
|                  Запись информации в файл сеансов связи                  |
\**************************************************************************/
macro Write_To_Mail

  var stat          = TRUE;
  var Err;
  var NumberSession;
  var CounterForDay = 0;
  var StrNumberSession;
  var TodayDate     = {curdate};
  var year,month,day;
  var YYYY,MM,DD;

  /* Определение значения поля mailCode - код сеанса связи */
  DateSplit(TodayDate,day,month,year);
  YYYY = Trim(String(year));
  while (StrLen(YYYY) < 4)
    YYYY = "0" + YYYY;
  end;
  MM = Trim(String(month));
  while (StrLen(MM) < 2)
    MM = "0" + MM;
  end;
  DD = Trim(String(day));
  while (StrLen(DD) < 2)
    DD = "0" + DD;
  end;

  scMail.KeyNum = 1;
  scMail.rec.FNCash   = BranchCode;
  scMail.rec.psRef    = psRef;
  scMail.rec.mailDate = TodayDate;
  scMail.rec.mailTime = Time( 23, 59, 59 );
  scMail.addFilter( "t.t_FNCash = " + string( BranchCode ) + " and " +
                    "t.t_psRef = " + string( psRef ) + " and " +
                    "t.t_mailDate = " + sqlDateToStr( TodayDate ) );
  stat = scMail.GetLE;
  if ( stat )
    if ( ( scMail.rec.FNCash   == BranchCode    ) and
         ( scMail.rec.psRef    == psRef     ) and
         ( scMail.rec.mailDate == TodayDate )    )
      if ( StrLen( scMail.rec.mailCode ) > 10 )
        NumberSession = Int( Trim( SubStr( scMail.rec.mailCode, 11 ) ) ) + 1;
      else
        NumberSession = 1;
      end;
    else
      NumberSession = 1;
    end;
  else
    NumberSession = 1;
  end;
  scMail.dropFilter;

  scMail.ReWind;
  scMail.rec.FNCash   = BranchCode;
  scMail.rec.psRef    = psRef;
  scMail.rec.mailDate = TodayDate;
  scMail.rec.mailTime = Time( 0, 0, 0 );
  scMail.addFilter( "t.t_FNCash = " + string( BranchCode ) + " and " +
                    "t.t_psRef = " + string( psRef ) + " and " +
                    "t.t_mailDate = " + sqlDateToStr( TodayDate ) );
  stat = scMail.GetGE;
  while ( stat )
    if ( ( scMail.rec.FNCash   == BranchCode    ) and
         ( scMail.rec.psRef    == psRef     ) and
         ( scMail.rec.mailDate == TodayDate )    )
      CounterForDay = CounterForDay + 1;
      stat = scMail.Next;
    else
      stat = false;
    end;
  end;
  scMail.dropFilter;

  if ( NumberSession <= CounterForDay )
    NumberSession == CounterForDay + 1;
  end;
  StrNumberSession = Trim( String( NumberSession ) );
  while ( StrLen( StrNumberSession ) < 5 )
    StrNumberSession = "0" + StrNumberSession;
  end;
  scMail.Clear;
  scMail.rec.mailCode = "SB" + YYYY + MM + DD + StrNumberSession;
  /* Взведение оставшихся полей */
  scMail.rec.FNCash        = BranchCode;
  scMail.rec.psRef         = psRef;
  scMail.rec.oper          = {oper};
  scMail.rec.mailStateCode = VMailState_Error;
  scMail.rec.mailTypeCode  = VMailType_OUT;
  scMail.rec.mailDate      = TodayDate;
  scMail.rec.mailTime      = Time( );
  scMail.rec.mailFile      = OutShortFileName;
  scMail.rec.mailNotes     = "Формирование выходного файла";
  /* Вставка записи в файл сеансов связи */
  MailRef = scDefReferMail( );
  if ( MailRef > 0 )
    scMail.rec.mailRef = MailRef;
    stat = scMail.Insert;
    if ( not stat )
      Err = "30";
      [ #]( NameError( Err, "scMail.dbt" ) );
    end;
  else
    stat = false;
    Err  = "40";
    [ #]( NameError( Err, "scMail.dbt" ) );
  end;

  return stat;

end;


/**************************************************************************\
|               Запись сеанса связи и определение имени файла              |
\**************************************************************************/
macro DefOutFileNameAndOpen

  var stat       = TRUE;
  var flag;
  var NumFileInDay;
  var CurYear;
  var MaxNumFile = 0;
  var NumFile;
  var ErrCode    = NOERROR;

  /* Определим номер текущего дня в году */
  DateSplit({curdate},NULL,NULL,CurYear);
  NumDayInYear = Trim(String({curdate} - Date(1,1,CurYear) + 1));
  while (StrLen(NumDayInYear) < 3)
    NumDayInYear = "0" + NumDayInYear;
  end;
  /* Определим порядковый номер файла за текущую дату */
  if (FilePrefix != "")
    OutShortFileName = FilePrefix;
  else
    OutShortFileName = CodeTB;
  end;
  while (StrLen(OutShortFileName) < 3)
    OutShortFileName = OutShortFileName + "_";
  end;
  /*LAA  Меняем название выходного файла на формат КККК - код - название филиала
                                                   ДДД  - день в году
                                                   Х    - как константа */
  OutShortFileName = CodeBranch + NumDayInYear + "X.";
  scMail.KeyNum = 5;
  scMail.rec.FNCash   = FNCash;
  scMail.rec.mailDate = {curdate};
  scMail.rec.mailTime = Time( 0, 0, 0 );
  scMail.addFilter( "t.t_FNCash = " + string( FNCash ) + " and " +
                    "t.t_mailDate = " + sqlDateToStr( {curdate} ) );
  flag = scMail.GetGE;
  while ( flag )
    if ( ( scMail.rec.FNCash   == FNCash    ) and
         ( scMail.rec.mailDate == {curdate} )    )
      if ( ( scMail.rec.EndSession == "X"                        ) and
           ( Index( scMail.rec.mailFile, OutShortFileName ) >  0 )    )
        NumFile = Int( Trim( SubStr( scMail.rec.mailFile, Index( scMail.rec.mailFile, "." ) + 1 ) ) );
        if ( NumFile > MaxNumFile )
          MaxNumFile = NumFile;
        end;
      end;
      flag = scMail.Next;
    else
      flag = false;
    end;
  end;
  scMail.dropFilter;

  DayNumFile   = MaxNumFile + 1;
  NumFileInDay = String( DayNumFile );
  while ( StrLen( NumFileInDay ) < 3 )
    NumFileInDay = "0" + NumFileInDay;
  end;

  MaskTMP          = OutputPath       + OutShortFileName;
  OutShortFileName = OutShortFileName + NumFileInDay;
  OutFileName      = OutputPath       + OutShortFileName;

  if ( ErrCode == NOERROR )
    if ( not Open( OutFile, OutFileName ) )
      ErrCode = "01";
    end;
  end;
  /* Открытие временного файла для записи информации о клиентах */
  if ( ErrCode == NOERROR )
    if ( not Open( TMPFile1, MaskTMP + "TM1" ) )
      ErrCode = "01";
    end;
  end;
  /* Открытие временного файла для записи информации о новых карточках и счетах */
  if ( ErrCode == NOERROR )
    if ( not Open( TMPFile2, MaskTMP + "TM2" ) )
      ErrCode = "01";
    end;
  end;
  /* Открытие временного файла для записи информации о блокировке/перевыпуске карточек */
  if ( ErrCode == NOERROR )
    if ( not Open( TMPFile3, MaskTMP + "TM3" ) )
      ErrCode = "01";
    end;
  end;
  /* Открытие временного файла для записи информации о приходе/расходе */
  if ( ErrCode == NOERROR )
    if ( not Open( TMPFile4, MaskTMP + "TM4" ) )
      ErrCode = "01";
    end;
  end;
  /* Открытие временного файла для записи информации о транзакциях эквайринга */
  if ( ErrCode == NOERROR )
    if ( not Open( TMPFile5, MaskTMP + "TM5" ) )
      ErrCode = "01";
    end;
  end;

  /* Открытие временного файла для записи информации о лимитах */
  if ( ErrCode == NOERROR )
    if ( not Open( TMPFile6, MaskTMP + "TM6" ) )
      ErrCode = "01";
    end;
  end;



  if ( ErrCode != NOERROR )
    stat = false;
    [ #]( NameError( ErrCode, "" ) );
  end;

  return stat;

end;


/**************************************************************************\
|                        Резюме по работе программы                        |
\**************************************************************************/
macro WriteSummary

  var str;

  if (GlobalError)
    [ При записи информации в выходной файла возникла ошибка];
    [ Выходной файл посылать в Процессинговый центр нельзя];
  else
    if ((NumPPCardNew == 0) AND (NumPPCardBlockOv == 0) AND (NumPPTran == 0) 
        AND (NumPPAcqu == 0) AND (NumPPLimit == 0))
      [ В выходной файл не попало ни одной записи];
      [ В Процессинговый центр посылать нечего];
    else
      [ Сеанс связи по передаче информации в Процессинговый центр завершен успешно];
      [ Сформированный файл подлежит передаче в Процессинговый центр];
      [ Имя файла #](OutFileName);
    end;
  end;

end;


/**************************************************************************\
|     Удаление из файла неотправленных по успешнопроведенным операциям     |
\**************************************************************************/
macro DeleteEndToPC

  var stat;

  Message(" Чистка файла неотпраленных в ПЦ ...");

  sc_to_pc.KeyNum = 3;
  sc_to_pc.rec.Branch  = BranchCode;
  sc_to_pc.rec.MailRef = 1;
  sc_to_pc.addFilter( "t.t_Branch = " + string( BranchCode ) );
  stat = sc_to_pc.GetGE;
  while ( stat )
    if ( sc_to_pc.rec.Branch == BranchCode )
      scMail.KeyNum = 0;
      scMail.rec.FNCash  = BranchCode;
      scMail.rec.mailRef = sc_to_pc.rec.MailRef;
      if ( scMail.GetEQ )
        if ( scMail.rec.EndSession == "X" )
          stat = sc_to_pc.Delete;
        else
          sc_to_pc.rec.MailRef = 0;
          stat = sc_to_pc.Update;
        end;
      else
        sc_to_pc.rec.MailRef = 0;
        stat = sc_to_pc.Update;
      end;
      if ( stat )
        sc_to_pc.rec.Branch  = BranchCode;
        sc_to_pc.rec.MailRef = 1;
        stat = sc_to_pc.GetGE;
      end;
    else
      stat = false;
    end;
  end;
  sc_to_pc.dropFilter;

end;


private macro IsGZ
  var ddep = TRecHandler( "i_dp_dep.rec" );

  if (GetCurrentMode() == MODE_GZ)
    if (findDepartment(NumFNCash(), null, ddep))
      if (ddep.rec.NodeType == I_DEPARTMENT_TYPE_FILIAL)
        return true;
      else
        [ ];
        [ #]("Выгрузка производится в подразделении со статусом \"Филиал\"!");
        exit(1);
      end;
    end;
  end;
  return false;
end;

/**************************************************************************\
|                    Г Л А В Н А Я    П Р О Г Р А М М А                    |
\**************************************************************************/

  var stat;
  var str;
  /*LAA Введена переменная для образования имени текстового 
        УНИКАЛЬНОГО имени отчета.*/
  var NameTXTFile  = "";/*LAA  для выходного потока в текстовике*/
  private var all_branches;
  private var dpDepList;
  private var work = true;
  private var lastNumPPCardNew, lastNumPPCardBlockOv, lastNumPPTran, lastNumPPAcqu,
    lastNumPPLimit;

  /* Найдем платежную систему */
  stat = FindPos();
  if (NOT stat)
    [ ];
    str = "Процессинговый центр с кодом " + PosCode + " не найден";
    [ #](str);
  end;
  /* Определим имя выходного файла и откроем его */
  if (stat)
    stat = DefOutFileNameAndOpen( );
  end;
  /*LAA Определяем имя выходного текстового файла*/
  if (stat)
    nameTxtFile = OutputPath + NumDayInYear + "_" + SubStr( OutFileName,( StrLen( OutFileName ) - 2 ), 3 ) + "X.txt";
    stat = SetOutput( nameTxtFile, FALSE );
  end;

  all_branches = IsGZ();
  if (all_branches)
    dpDepList = TdpDepList;
    dpDepList.SetFilter(dpDepList.getFilialID(FNCash));
    work = dpDepList.next();
    BranchCode = dpDepList.rec.Code;
  else
    BranchCode = FNCash;
  end;

  while (work and ( not GlobalError ))
    lastNumPPCardNew = NumPPCardNew;
    lastNumPPCardBlockOv = NumPPCardBlockOv;
    lastNumPPTran = NumPPTran;
    lastNumPPAcqu = NumPPAcqu;
    lastNumPPLimit = NumPPLimit;
    
    SetFNCash(BranchCode);
    /* Определение кода банка */
    NameBranch = DefCodeBank(BranchCode);
    /* Чистка файла неотпраленных в ПЦ */
    DeleteEndToPC();
    /* Запись сеанса связи по формированию выходного файла */
    if (stat)
      stat = Write_To_Mail();
    end;
    /* Запись информации во временный файл о заказанных карточках и клиентах */
    if (stat)
      WriteToTempClientsAndCardsAndTran();
    end;
    /* Поставить у сеанса связи признака его окончания */
    if (stat)
      if ( ( not GlobalError ) 
       and ( (lastNumPPCardNew != NumPPCardNew) 
          or (lastNumPPCardBlockOv != NumPPCardBlockOv) 
          or (lastNumPPTran != NumPPTran)    
          or (lastNumPPAcqu != NumPPAcqu) 
          or (lastNumPPLimit != NumPPLimit) ) )
        BranchOut(ASize(BranchOut)) = BranchCode;
        BranchMailRef(ASize(BranchMailRef)) = MailRef;
      end;
    end;

    if (all_branches)
      work = dpDepList.next();
      BranchCode = dpDepList.rec.Code;
    else
      work = false;
    end;
  end;
  // Запись информации в выходной файл о клиентах, карточках и транзакциях
  if (stat)
    WriteToOutClientsAndCardsAndTran();
  end;
  /* Поставить у сеанса связи признак его окончания */
  if ((not GlobalError) and (ASize(BranchOut) > 0))
    if ( not ProcessTrn( null, "Write_X_To_Mail" ) )
      GlobalError = true;
    end;
  end;
  SetFNCash(FNCash);
  
  /* Резюме по работе программы */
  if ( stat )
    WriteSummary( );
  end;
  /* LAA разделение выходного файла */
  if ( stat )
    if ( Merger == false )
      stat = ExecMacroFile( "sb_out_c.mac", "CutFiles", OutFileName );
    end;
  end;

end;
