/*********************************************************************
*  ---------------------                                             *
*  R-Style Software Lab.                                             *
*  ---------------------                                             *
*  RS-Retail                                                         *
*                                                                    *
*  Пластиковые карточки                                              *
*                                                                    *
*  Действия при закрытии Связи Карточка-Счет Платежной системы       *
*  STB-Card                                                          *
*                                                                    *
*  Лебедев С.В.                                                      *
*  17.12.99                                                          *
*********************************************************************/

import "sc_error.mac","stb_com.mac";

record SC_LINK (scLink,"spcard.def"); /* Связь - Глобальная строка */


/*********************************************************************
             Запись необходимых изменений в sc_to_pc.dbt
*********************************************************************/
macro WriteToStbMail

  var stat = НЕТ_ОШИБКИ;

  if (FindStbMail("AC",SC_LINK.accCardLinkRef,Oper_CloseLink))
    stb_mail.MailRef = 0;
    if (NOT Update(stb_mail))
      stat = ЕСТЬ_ОШИБКА;
    end;
  else
    stb_mail.Branch     = Branch;
    stb_mail.FormatFile = "AC";
    stb_mail.RecRef     = SC_LINK.accCardLinkRef;
    stb_mail.CodeOper   = Oper_CloseLink;
    stb_mail.MailRef    = 0;
    if (NOT Insert(stb_mail))
      stat = ЕСТЬ_ОШИБКА;
    end;
  end;

  return stat;

end;


/*********************************************************************
       	          Г Л А В Н А Я   П Р О Г Р А М М А
*********************************************************************/

  ALG_STAT = НЕТ_ОШИБКИ;

  if ((ALG_WHATDO == SCPSMAC_OPCL) AND (ALG_SECONDDO == 2))
    ALG_STAT = WriteToStbMail();
  end;

end;
