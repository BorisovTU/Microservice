/*********************************************************************
*  ---------------------                                             *
*  R-Style Software Lab.                                             *
*  ---------------------                                             *
*  RS-Retail                                                         *
*                                                                    *
*  Пластиковые карточки                                              *
*                                                                    *
*  Действия при сохранении Карточного счета Платежной системы        *
*  STB-Card                                                          *
*                                                                    *
*  Лебедев С.В.                                                      *
*  17.12.99                                                          *
*********************************************************************/

import "sc_error.mac","stb_com.mac";

file   scAcc  (scAcc,"spcard.def"); /* Файл Карточные счета     */
record SC_ACC (scAcc,"spcard.def"); /* Счет - Глобальная строка */


/*********************************************************************
             Запись необходимых изменений в sc_to_pc.dbt
*********************************************************************/
macro WriteAccToStbMail

  var stat = НЕТ_ОШИБКИ;
  var flag = TRUE;

  /* Состояние счета поменялось с блокированный на другое */
  if ((NOT StateCompare(SC_ACC.cardAccStateCode,VAccState_NA,LogSC_AccS,STB_psRef)) AND
      (    StateCompare(scAcc.cardAccStateCode, VAccState_NA,LogSC_AccS,STB_psRef))    )
    if (FindStbMail("AB",SC_ACC.Referenc,Oper_StateAcc))
      stb_mail.MailRef = 0;
      flag = Update(stb_mail);
    else
      stb_mail.Branch     = Branch;
      stb_mail.FormatFile = "AB";
      stb_mail.RecRef     = SC_ACC.Referenc;
      stb_mail.CodeOper   = Oper_StateAcc;
      stb_mail.MailRef    = 0;
      flag = Insert(stb_mail);
    end;
  end;

  /* Состояние счета поменялось на блокированный с другого */
  if ((    StateCompare(SC_ACC.cardAccStateCode,VAccState_NA,LogSC_AccS,STB_psRef)) AND
      (NOT StateCompare(scAcc.cardAccStateCode, VAccState_NA,LogSC_AccS,STB_psRef))    )
    if (FindStbMail("AB",SC_ACC.Referenc,Oper_StateAcc))
      stb_mail.MailRef = 0;
      flag = Update(stb_mail);
    else
      stb_mail.Branch     = Branch;
      stb_mail.FormatFile = "AB";
      stb_mail.RecRef     = SC_ACC.Referenc;
      stb_mail.CodeOper   = Oper_StateAcc;
      stb_mail.MailRef    = 0;
      flag = Insert(stb_mail);
    end;
  end;

  if (NOT flag)
    stat = ЕСТЬ_ОШИБКА;
  end;

  return stat;

end;


/*********************************************************************
       Поиск счета в базе счетов и вызов записи в sc_to_pc.dbt
*********************************************************************/
macro WriteToStbMail

  var stat = НЕТ_ОШИБКИ;

  KeyNum(scAcc,0);
  scAcc.Referenc = SC_ACC.Referenc;
  if (GetEQ(scAcc))
    stat = WriteAccToStbMail();
  else
    stat = ЕСТЬ_ОШИБКА;
  end;

  return stat;

end;


/*********************************************************************
       	          Г Л А В Н А Я   П Р О Г Р А М М А
*********************************************************************/

  ALG_STAT   = НЕТ_ОШИБКИ;
  ALG_VARPARTSIZE = 0;

  if ((ALG_WHATDO == SCPSMAC_SAVE) AND (ALG_SECONDDO == 0))
    if (Find_psCode())
      ALG_STAT = WriteToStbMail();
    else
      ALG_STAT = ЕСТЬ_ОШИБКА;
    end;
  end;

end;
