/****************************************************************
*  ---------------------                                        *
*  R-Style SoftWare Lab.                                        *
*  ---------------------                                        *
*  RS-Retail                                                    *
*  Эмитент                                                      *
*                                                               *
*  Выпуск Отчета по "Журналу корректировок" за текущий день     *
*                                                               *
*  Лебедев С.В.                                                 *
*  04.09.97                                                     *
****************************************************************/
import deprintr;

file sc_log   ("sc_log.dbt", "spcard.def"); /* Журнала корректировок */
file sc_pos   ("scPos.dbt" , "spcard.def"); /* Платежные системы     */
file name_alg ("namealg.dbt","bank.def"  ); /* Названия алгоритмов   */

var {curdate};                             /* Текущая дата          */
var FNcash = NumFNCash();                  /* Номер филиала         */
var FlagBegin;


/**********************************************************************
**********************************************************************/
macro DateRep (InputDate)

  var d ,m ,y ;
  var ds,ms,ys;
  var OutDate = "";

  DateSplit(InputDate,d,m,y);
  ds = String(d);
  ms = String(m);
  ys = String(y);
  while (StrLen(ds) < 2)
    ds = "0" + ds;
  end;
  while (StrLen(ms) < 2)
    ms = "0" + ms;
  end;
  while (StrLen(ys) < 4)
    ys = "0" + ys;
  end;

  OutDate = ds + "." + ms + "." + ys;

  return OutDate;

end;


/**********************************************************************
**********************************************************************/
macro DefDepos (Referenc)

  file depos (depositr) key 8;
  var  Account = Referenc;

  depos.Referenc = Referenc;
  if (GetEQ(depos))
    Account = depos.Account;
  end;

  if (Account == "")
    Account = "Нет";
  end;

  return Account;

end;


/**********************************************************************
**********************************************************************/
macro DefCard (CardRef)

  file card (scCard,"spcard.def") key 0;
  var  CardNumber = "";

  card.FNCash  = FNcash;
  card.cardRef = CardRef;
  if (GetEQ(card))
    CardNumber = card.cardNumber;
  end;

  return CardNumber;

end;


/**********************************************************************
**********************************************************************/
macro DefCode (psRef, codType, codCode)

  file codif (scCodif,"spcard.def") key 1;
  var  Code = codCode;

  codif.codType = codType;
  codif.codCode = codCode;
  codif.psRef   = 0;
  if (GetEQ(codif))
    Code = Trim(codif.codUserCode) + " (" + Trim(codif.codName) + ")";
  else
    codif.codType = codType;
    codif.codCode = codCode;
    codif.psRef   = psRef;
    if (GetEQ(codif))
      Code = Trim(codif.codUserCode) + " (" + Trim(codif.codName) + ")";
    end;
  end;

  return Code;

end;


/**********************************************************************
**********************************************************************/
macro WriteLine (Num)

  var str;

  if (Num == 2)
    str = "===========================================================================";
  else
    str = "---------------------------------------------------------------------------";
  end;

  return str;

end;


/**********************************************************************
**********************************************************************/
macro WriteRepLine (NameField, OldField, NewField)

  if (FlagBegin == FALSE)
    [ #](WriteLine(1));
    FlagBegin = TRUE;
  end;

  [ | ######################| #######################| #######################|]
  (NameField,OldField,NewField);

end;


/*********************************************************************
             Печать заголовка журнала в выходной файл
*********************************************************************/
macro HeadReport (DateDoc)

  var dep_name;

  [          Журнал корректировок данных модуля Эмитент за ##########](DateDoc);
  if (findDepartment(FNcash, dep_name))
    [                           по филиалу #](dep_name);
  end;
  [ ];

  [ #](WriteLine(2));
  [ |     Название поля     |    Старое значение     |     Новое значение     |];
  [ #](WriteLine(2));

end;


/*********************************************************************
       Определение названия файла по его номеру из namealg.dbt
*********************************************************************/
macro DefNameFromAlg (Type, Num);

  var str = "";

  KeyNum(name_alg,0);
  ReWind(name_alg);
  name_alg.iTypeAlg   = Type;
  name_alg.iNumberAlg = Num;
  if (GetEQ(name_alg))
    str = name_alg.szNameAlg;
  end;

  return str;

end;


/*********************************************************************
        Запись информации об изменении по карточному счету
*********************************************************************/
macro LogForCardAcc

  record acc_new(scAcc,"spcard.def");
  record acc_old(scAcc,"spcard.def");
  var    fname   = "";
  var    fold    = "";
  var    fnew    = "";
  var    Account = "";

  if   (sc_log.NumOperation == 2)
    ClearRecord(acc_old);
    SetRecordAddr(acc_new,sc_log,0,0,FALSE);
    fold = "";
    Account = acc_new.Referenc;
  elif (sc_log.NumOperation == 3)
    SetRecordAddr(acc_old,sc_log,0,0,FALSE);
    SetRecordAddr(acc_new,sc_log,0,2048,FALSE);
    Account = acc_new.Referenc;
  elif (sc_log.NumOperation == 4)
    SetRecordAddr(acc_old,sc_log,0,0,FALSE);
    ClearRecord(acc_new);
    fnew = "";
    Account = acc_old.Referenc;
  end;

  /* Выведим номер счета */
  Account = DefDepos(Account);
  [ | Номер счета #                                                           |]
  (Account);

  /* Операционист ------------------------------------------ */
  if ((acc_old.oper        != acc_new.oper) OR
      (sc_log.NumOperation == 2           ) OR
      (sc_log.NumOperation == 4           )   )
    fname = DefNameFromAlg(87,1);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(acc_new.oper));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(acc_new.oper));
      fold = Trim(String(acc_old.oper));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(acc_old.oper));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Состояние счета --------------------------------------- */
  if ((acc_old.cardAccStateCode != acc_new.cardAccStateCode) OR
      (sc_log.NumOperation      == 2                       ) OR
      (sc_log.NumOperation      == 4                       )   )
    fname = DefNameFromAlg(87,2);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(DefCode(acc_new.psRef,2,acc_new.cardAccStateCode));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(DefCode(acc_new.psRef,2,acc_new.cardAccStateCode));
      fold = Trim(DefCode(acc_old.psRef,2,acc_old.cardAccStateCode));
    elif (sc_log.NumOperation == 4)
      fold = Trim(DefCode(acc_old.psRef,2,acc_old.cardAccStateCode));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Блокированная сумма ----------------------------------- */
  if ((acc_old.BlockSum    != acc_new.BlockSum) OR
      (sc_log.NumOperation == 2               ) OR
      (sc_log.NumOperation == 4               )   )
    fname = DefNameFromAlg(87,3);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(acc_new.BlockSum:20:2:a));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(acc_new.BlockSum:20:2:a));
      fold = Trim(String(acc_old.BlockSum:20:2:a));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(acc_old.BlockSum:20:2:a));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Страховой депозит ------------------------------------- */
  if ((acc_old.Referenc_Insur != acc_new.Referenc_Insur) OR
      (sc_log.NumOperation    == 2                     ) OR
      (sc_log.NumOperation    == 4                     )   )
    fname = DefNameFromAlg(87,4);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(DefDepos(acc_new.Referenc_Insur));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(DefDepos(acc_new.Referenc_Insur));
      fold = Trim(DefDepos(acc_old.Referenc_Insur));
    elif (sc_log.NumOperation == 4)
      fold = Trim(DefDepos(acc_old.Referenc_Insur));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Счет пополнения --------------------------------------- */
  if ((acc_old.Referenc_Add != acc_new.Referenc_Add) OR
      (sc_log.NumOperation  == 2                   ) OR
      (sc_log.NumOperation  == 4                   )   )
    fname = DefNameFromAlg(87,5);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(DefDepos(acc_new.Referenc_Add));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(DefDepos(acc_new.Referenc_Add));
      fold = Trim(DefDepos(acc_old.Referenc_Add));
    elif (sc_log.NumOperation == 4)
      fold = Trim(DefDepos(acc_old.Referenc_Add));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Неснижаемый остаток ----------------------------------- */
  if ((acc_old.cardAccRestMin != acc_new.cardAccRestMin) OR
      (sc_log.NumOperation     == 2                    ) OR
      (sc_log.NumOperation     == 4                    )   )
    fname = DefNameFromAlg(87,6);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(acc_new.cardAccRestMin:20:2:a));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(acc_new.cardAccRestMin:20:2:a));
      fold = Trim(String(acc_old.cardAccRestMin:20:2:a));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(acc_old.cardAccRestMin:20:2:a));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Гарантированный остаток ------------------------------- */
  if ((acc_old.cardAccRestGuarantee != acc_new.cardAccRestGuarantee) OR
      (sc_log.NumOperation          == 2                           ) OR
      (sc_log.NumOperation          == 4                           )   )
    fname = DefNameFromAlg(87,7);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(acc_new.cardAccRestGuarantee:20:2:a));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(acc_new.cardAccRestGuarantee:20:2:a));
      fold = Trim(String(acc_old.cardAccRestGuarantee:20:2:a));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(acc_old.cardAccRestGuarantee:20:2:a));
    end;
    WriteRepLine(fname,fold,fnew);
  end;

end;


/*********************************************************************
             Запись информации об изменении по карточке
*********************************************************************/
macro LogForCard

  record card_new(scCard,"spcard.def");
  record card_old(scCard,"spcard.def");
  var    fname      = "";
  var    fold       = "";
  var    fnew       = "";
  var    CardNumber = "";

  if   (sc_log.NumOperation == 2)
    ClearRecord(card_old);
    SetRecordAddr(card_new,sc_log,0,0,FALSE);
    fold = "";
    CardNumber = card_new.CardNumber;
  elif (sc_log.NumOperation == 3)
    SetRecordAddr(card_old,sc_log,0,0,FALSE);
    SetRecordAddr(card_new,sc_log,0,2048,FALSE);
    CardNumber = card_new.CardNumber;
  elif (sc_log.NumOperation == 4)
    SetRecordAddr(card_old,sc_log,0,0,FALSE);
    ClearRecord(card_new);
    fnew = "";
    CardNumber = card_old.CardNumber;
  end;

  /* Выведим номер карточки */
  [ | Номер карточки #                                                        |]
  (CardNumber);

  /* Номер карточки ---------------------------------------- */
  if ((card_old.cardNumber != card_new.cardNumber) OR
      (sc_log.NumOperation == 2                  ) OR
      (sc_log.NumOperation == 4                  )   )
    fname = DefNameFromAlg(89,1);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(card_new.cardNumber));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(card_new.cardNumber));
      fold = Trim(String(card_old.cardNumber));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(card_old.cardNumber));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Состояние карточки ------------------------------------ */
  if ((card_old.cardStateCode != card_new.cardStateCode) OR
      (sc_log.NumOperation    == 2                     ) OR
      (sc_log.NumOperation    == 4                     )   )
    fname = DefNameFromAlg(89,3);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(DefCode(card_new.psRef,6,card_new.cardStateCode));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(DefCode(card_new.psRef,6,card_new.cardStateCode));
      fold = Trim(DefCode(card_old.psRef,6,card_old.cardStateCode));
    elif (sc_log.NumOperation == 4)
      fold = Trim(DefCode(card_old.psRef,6,card_old.cardStateCode));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Операционист ------------------------------------------ */
  if ((card_old.oper        != card_new.oper) OR
      (sc_log.NumOperation  == 2            ) OR
      (sc_log.NumOperation  == 4            )   )
    fname = DefNameFromAlg(89,4);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(card_new.oper));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(card_new.oper));
      fold = Trim(String(card_old.oper));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(card_old.oper));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Эмбоссирование 1 -------------------------------------- */
  if ((card_old.embossingName1 != card_new.embossingName1) OR
      (sc_log.NumOperation     == 2                      ) OR
      (sc_log.NumOperation     == 4                      )   )
    fname = DefNameFromAlg(89,5);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(card_new.embossingName1);
    elif (sc_log.NumOperation == 3)
      fnew = Trim(card_new.embossingName1);
      fold = Trim(card_old.embossingName1);
    elif (sc_log.NumOperation == 4)
      fold = Trim(card_old.embossingName1);
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Эмбоссирование 2 -------------------------------------- */
  if ((card_old.embossingName2 != card_new.embossingName2) OR
      (sc_log.NumOperation     == 2                      ) OR
      (sc_log.NumOperation     == 4                      )   )
    fname = DefNameFromAlg(89,6);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(card_new.embossingName2);
    elif (sc_log.NumOperation == 3)
      fnew = Trim(card_new.embossingName2);
      fold = Trim(card_old.embossingName2);
    elif (sc_log.NumOperation == 4)
      fold = Trim(card_old.embossingName2);
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Можно перевыпускать ----------------------------------- */
  if ((card_old.cardMayOverIssuer != card_new.cardMayOverIssuer) OR
      (sc_log.NumOperation        == 2                         ) OR
      (sc_log.NumOperation        == 4                         )   )
    fname = DefNameFromAlg(89,7);
    if   (sc_log.NumOperation == 2)
      fnew = card_new.cardMayOverIssuer;
    elif (sc_log.NumOperation == 3)
      fnew = card_new.cardMayOverIssuer;
      fold = card_old.cardMayOverIssuer;
    elif (sc_log.NumOperation == 4)
      fold = card_old.cardMayOverIssuer;
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Дата Эмбоссирования карты ----------------------------- */
  if ((card_old.cardEmbossingDate != card_new.cardEmbossingDate) OR
      (sc_log.NumOperation        == 2                         ) OR
      (sc_log.NumOperation        == 4                         )   )
    fname = DefNameFromAlg(89,8);
    if   (sc_log.NumOperation == 2)
      fnew = DateRep(card_new.cardEmbossingDate);
    elif (sc_log.NumOperation == 3)
      fnew = DateRep(card_new.cardEmbossingDate);
      fold = DateRep(card_old.cardEmbossingDate);
    elif (sc_log.NumOperation == 4)
      fold = DateRep(card_old.cardEmbossingDate);
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Срок действия карты ----------------------------------- */
  if ((card_old.cardMaturityDate != card_new.cardMaturityDate) OR
      (sc_log.NumOperation        == 2                       ) OR
      (sc_log.NumOperation        == 4                       )   )
    fname = DefNameFromAlg(89,9);
    if   (sc_log.NumOperation == 2)
      fnew = DateRep(card_new.cardMaturityDate);
    elif (sc_log.NumOperation == 3)
      fnew = DateRep(card_new.cardMaturityDate);
      fold = DateRep(card_old.cardMaturityDate);
    elif (sc_log.NumOperation == 4)
      fold = DateRep(card_old.cardMaturityDate);
    end;
    WriteRepLine(fname,fold,fnew);
  end;

end;


/*********************************************************************
              Запись информации об изменении по связи
*********************************************************************/
macro LogForLink

  record link_new(scLink,"spcard.def");
  record link_old(scLink,"spcard.def");
  var    fname      = "";
  var    fold       = "";
  var    fnew       = "";
  var    Account    = "";
  var    CardNumber = "";
  var    CardRef    = 0;

  if   (sc_log.NumOperation == 2)
    ClearRecord(link_old);
    SetRecordAddr(link_new,sc_log,0,0,FALSE);
    fold = "";
    Account = link_new.cardAccRef;
    CardRef = link_new.cardRef;
  elif (sc_log.NumOperation == 3)
    SetRecordAddr(link_old,sc_log,0,0,FALSE);
    SetRecordAddr(link_new,sc_log,0,2048,FALSE);
    Account = link_new.cardAccRef;
    CardRef = link_new.cardRef;
  elif (sc_log.NumOperation == 4)
    SetRecordAddr(link_old,sc_log,0,0,FALSE);
    ClearRecord(link_new);
    fnew = "";
    Account = link_old.cardAccRef;
    CardRef = link_old.cardRef;
  end;

  Account = DefDepos(Account);
  CardNumber = DefCard(CardRef);
  [ | Номер карточки ###################   Номер счета ###################### |]
  (CardNumber,Account);

  /* Состояние связи --------------------------------------- */
  if ((link_old.accCardLinkState != link_new.accCardLinkState) OR
      (sc_log.NumOperation    == 2                           ) OR
      (sc_log.NumOperation    == 4                           )   )
    fname = DefNameFromAlg(90,1);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(DefCode(link_new.psRef,9,link_new.accCardLinkState));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(DefCode(link_new.psRef,9,link_new.accCardLinkState));
      fold = Trim(DefCode(link_old.psRef,9,link_old.accCardLinkState));
    elif (sc_log.NumOperation == 4)
      fold = Trim(DefCode(link_old.psRef,9,link_old.accCardLinkState));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Операционист ------------------------------------------ */
  if ((link_old.oper        != link_new.oper) OR
      (sc_log.NumOperation  == 2            ) OR
      (sc_log.NumOperation  == 4            )   )
    fname = DefNameFromAlg(90,2);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(String(link_new.oper));
    elif (sc_log.NumOperation == 3)
      fnew = Trim(String(link_new.oper));
      fold = Trim(String(link_old.oper));
    elif (sc_log.NumOperation == 4)
      fold = Trim(String(link_old.oper));
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Главная карточка -------------------------------------- */
  if ((link_old.MainCard    != link_new.MainCard) OR
      (sc_log.NumOperation  == 2                ) OR
      (sc_log.NumOperation  == 4                )   )
    fname = DefNameFromAlg(90,3);
    if   (sc_log.NumOperation == 2)
      fnew = link_new.MainCard;
    elif (sc_log.NumOperation == 3)
      fnew = link_new.MainCard;
      fold = link_old.MainCard;
    elif (sc_log.NumOperation == 4)
      fold = link_old.MainCard;
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Главный счет ------------------------------------------ */
  if ((link_old.MainAcc    != link_new.MainAcc) OR
      (sc_log.NumOperation == 2               ) OR
      (sc_log.NumOperation == 4               )   )
    fname = DefNameFromAlg(90,4);
    if   (sc_log.NumOperation == 2)
      fnew = link_new.MainAcc;
    elif (sc_log.NumOperation == 3)
      fnew = link_new.MainAcc;
      fold = link_old.MainAcc;
    elif (sc_log.NumOperation == 4)
      fold = link_old.MainAcc;
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Дата закрытия ----------------------------------------- */
  if ((link_old.accCardLinkCloseDate != link_new.accCardLinkCloseDate) OR
      (sc_log.NumOperation           == 2                            ) OR
      (sc_log.NumOperation           == 4                            )   )
    fname = DefNameFromAlg(90,5);
    if   (sc_log.NumOperation == 2)
      fnew = DateRep(link_new.accCardLinkCloseDate);
    elif (sc_log.NumOperation == 3)
      fnew = DateRep(link_new.accCardLinkCloseDate);
      fold = DateRep(link_old.accCardLinkCloseDate);
    elif (sc_log.NumOperation == 4)
      fold = DateRep(link_old.accCardLinkCloseDate);
    end;
    WriteRepLine(fname,fold,fnew);
  end;

end;


/*********************************************************************
           Запись информации об изменении по кодификатору
*********************************************************************/
macro LogForCodif

  record cod_new(scCodif,"spcard.def");
  record cod_old(scCodif,"spcard.def");
  var    fname = "";
  var    fold  = "";
  var    fnew  = "";

  if   (sc_log.NumOperation == 2)
    ClearRecord(cod_old);
    SetRecordAddr(cod_new,sc_log,0,0,FALSE);
    fold = "";
  elif (sc_log.NumOperation == 3)
    SetRecordAddr(cod_old,sc_log,0,0,FALSE);
    SetRecordAddr(cod_new,sc_log,0,2048,FALSE);
  elif (sc_log.NumOperation == 4)
    SetRecordAddr(cod_old,sc_log,0,0,FALSE);
    ClearRecord(cod_new);
    fnew = "";
  end;

  /* Пользовательский код ---------------------------------- */
  if ((cod_old.codUserCode != cod_new.codUserCode) OR
      (sc_log.NumOperation == 2                  ) OR
      (sc_log.NumOperation == 4                  )   )
    fname = DefNameFromAlg(93,1);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(cod_new.codUserCode);
    elif (sc_log.NumOperation == 3)
      fnew = Trim(cod_new.codUserCode);
      fold = Trim(cod_old.codUserCode);
    elif (sc_log.NumOperation == 4)
      fold = Trim(cod_old.codUserCode);
    end;
    WriteRepLine(fname,fold,fnew);
  end;
  /* Название ---------------------------------------------- */
  if ((cod_old.codName     != cod_new.codName) OR
      (sc_log.NumOperation == 2              ) OR
      (sc_log.NumOperation == 4              )   )
    fname = DefNameFromAlg(93,1);
    if   (sc_log.NumOperation == 2)
      fnew = Trim(cod_new.codName);
    elif (sc_log.NumOperation == 3)
      fnew = Trim(cod_new.codName);
      fold = Trim(cod_old.codName);
    elif (sc_log.NumOperation == 4)
      fold = Trim(cod_old.codName);
    end;
    WriteRepLine(fname,fold,fnew);
  end;

end;


/*********************************************************************
         Запись в выходной файл информации о корректировке
*********************************************************************/
macro WriteToZhurnal

  var   FileNameChange = DefNameFromAlg(85,sc_log.NumFile);
  var   NameOperation  = "";
  const HeadOper       = "Опер.:";
  const HeadTime       = "Время:";

  FlagBegin = FALSE;

  if (sc_log.NumOperation == 2)
    NameOperation = "(Вставка)";
  end;
  if (sc_log.NumOperation == 3)
    NameOperation = "(Корректировка)";
  end;
  if (sc_log.NumOperation == 4)
    NameOperation = "(Удаление)";
  end;

  [ | ##########################################  #      ####  #      ########|]
  ((FileNameChange + " " + NameOperation):w,HeadOper,sc_log.oper:4,HeadTime,sc_log.TimeRec);

  if   (sc_log.NumFile ==  1) /* Карточный счет             */
    LogForCardAcc();
  elif (sc_log.NumFile ==  5) /* Карточка                   */
    LogForCard();
  elif (sc_log.NumFile ==  8) /* Связь Карточка - Счет      */
    LogForLink();
  elif (sc_log.NumFile == 11) /* Платежные системы          */
    ;
  elif (sc_log.NumFile == 17) /* Макросы ПС                 */
    ;
  elif (sc_log.NumFile == 18) /* Транзакции                 */
    ;
  elif (sc_log.NumFile == 23) /* Кодификатор                */
    LogForCodif();
  elif (sc_log.NumFile == 30) /* Сеансы связей              */
    ;
  elif (sc_log.NumFile == 31) /* Расшифровки сеансов связей */
    ;
  end;

  [ #](WriteLine(2));

end;


/*********************************************************************
             Цикл по записям журнала за текущую дату
*********************************************************************/
macro WorkWithZhurn (DateDoc)

  var stat;
  var NumRec = 0;

  KeyNum(sc_log,1);
  ReWind(sc_log);
  sc_log.FNCash      = FNcash;
  sc_log.DateOperDay = DateDoc;
  sc_log.TimeRec     = Time(0,0,0);
  stat = GetGE(sc_log);
  while (stat)
    if ((sc_log.FNCash      == FNcash ) AND
        (sc_log.DateOperDay == DateDoc)    )
      if (sc_log.NumFile < 100)
        NumRec = NumRec + 1;
        Message(" Отчет по Журналу корректировок. Обрабатывается ",NumRec:4," запись ...");
        WriteToZhurnal();
      end;
      stat = Next(sc_log);
    else
      stat = FALSE;
    end;
  end;

end;


/*********************************************************************
                   Г О Л О В Н О Й   М А К Р О С
*********************************************************************/

  var DateDoc;

  DateDoc = {curdate};

  [ ];

  HeadReport(DateDoc);
  WorkWithZhurn(DateDoc);

end;
