/*
$Name:              psRollback.mac
$Module:            Пластиковые карты
$Description:       Откат операции в ПЦ
*/

import psCommon;


private class (PsOnlineStep) RollbackStep
  
  //--------------------------------------------------------------------------
  private macro callPsMacro()
    var macName = getMacroName();
    if (not macName)
      DoError("Не найден макрос для Online взаимодействия с ПЦ");
    end;
    
    CheckError(ExecMacroFile(macName, "Transmit", Params));
  end;

  //--------------------------------------------------------------------------
  macro execute()
    if (not isOnline())
      return OK_RES;
    end;

    var scMail = findOpMail(Params.OpAppKind, Params.OpAppKey);
    if (scMail == null)
      return OK_RES;
    end;
    var stat = 0;
    if (scMail.rec.mailStateCode == "ISFIN")
      message("Выполняется откат операции в ПЦ...");

      Params.flagStorn = true;
      var scMailt = findOpMailt(scMail);
      if(scMailt)
          Params.RRN       = scMailt.rec.RRN;
      end;
      callPsMacro();
      stat = psCheckError();
      if( stat == OK_RES)
          deleteMail(Params.OpAppKind, Params.OpAppKey);
      end;
    end;

    message(" ");
    return stat;

  OnError(err)
    ShowError(err);
    return ERR_RES;
  end;

  //--------------------------------------------------------------------------
  InitPsOnlineStep();
  
end;


//--------------------------------------------------------------------------
private var step = RollbackStep;
ALG_RESULT = step.execute();


