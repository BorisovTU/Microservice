/**************************************************************************\
*  ---------------------                                                   *
*  R-Style Software Lab.                                                   *
*  ---------------------                                                   *
*  RS-Retail                                                               *
*                                                                          *
*  Пластиковые карточки                                                    *
*                                                                          *
*  Работа с ридером магнитных карточек                                     *
*                                                                          *
*  Лебедев С.В.                                                            *
*  11.09.97                                                                *
\**************************************************************************/

var PINCode    = "";   /* Глобальная переменная (PIN Code)                */
var CardNumber = "";   /* Глобальная переменная (Номер карточки)          */
var MaturDay   = 0;    /* Глобальная переменная (День действия карточки)  */
var MaturMonth = 0;    /* Глобальная переменная (Месяц действия карточки) */
var MaturYear  = 0;    /* Глобальная переменная (Год действия карточки)   */

file WorkFile () txt;


/**************************************************************************\
|                          Чтение номера карточки                          |
\**************************************************************************/
macro ReadCardNumber (FileNameData)

  var MatDate;
  var TmpDate;
  var i;

  /* DrawMsgWindow("Чтение карточки с ридера"); */
  Run("reader.exe","2 " + FileNameData,null,null);
  /* CloseMsgWindow(); */

  if (Open(WorkFile,FileNameData))
    if (Next(WorkFile))
      CardNumber = WorkFile.str;
      if (Next(WorkFile))
	MatDate = WorkFile.str;
	i = Index(MatDate,".");
        if (i > 0)
	  MaturMonth = Int(Trim(SubStr(MatDate,1,i-1)));
	  MaturYear  = Int(Trim(SubStr(MatDate,i+1)));
	  if (MaturMonth = 12)
            TmpDate = Date(1,1,MaturYear + 1);
          else
            TmpDate = Date(1,MaturMonth + 1,MaturYear);
          end;
          TmpDate = TmpDate - 1;
          DateSplit(TmpDate,MaturDay,NULL,NULL);
        end;
      end;
      Close(WorkFile);
    else
      CardNumber = "";
    end;
  else
    CardNumber = "";
  end;

  Run("reader.exe","3 SPACE",NULL,NULL);

end;


/**************************************************************************\
|                    Г Л А В Н А Я    П Р О Г Р А М М А                    |
\**************************************************************************/
macro WorkWithReader (WhatDo, OutName)

  if (WhatDo == "2")
    ReadCardNumber(OutName);
  end;

end;
