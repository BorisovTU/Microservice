/*
$Name:             ic_spcard.mac
$Module:           è´†·‚®™Æ¢Î• ™†‡‚ÆÁ™®
$Description:      ë•‡¢®·Î Ø´†·‚®™Æ¢ÎÂ ™†‡‚ÆÁ•™ §´Ô ¢≠•Ë≠®Â ·®·‚•¨
*/
import ic_comdata, spCardInter;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ClientCardList ( ClientID : integer, Type : string, Activity : string )

  var retVal = TArray;
  var sql = "select crd.t_fncash branch, " +
                   "dp.t_name branchName, " +
                   "crd.t_cardref cardRef, " +
                   "crd.t_cardnumber cardNumber, " +
                   "ps.t_paysyscode paySysCode, " +
                   "codif.t_codname cardTypeName, " +
                   "decode( lnk.t_maincard, chr( 0 ), 'X', chr( 0 ) ) isSup, " +
                   "decode( crd.t_cardopenclose, chr( 0 ), chr( 0 ), 'X' ) isClose, " +
                   "crd.t_cardopendate cardOpenDate, " +
                   "crd.t_cardrecdate cardRecDate, " +
                   "crd.t_cardmaturitydate cardMaturityDate, " +
                   "crd.t_cardclosedate cardCloseDate, " +
                   "dep.t_account as Account " +
            "from dsccard_dbt crd, " +
                 "ddp_dep_dbt dp, " +
                 "dsccodif_dbt codif, " +
                 "dsclink_dbt lnk, " +
                 "ddepositr_dbt dep, " +
                 "dscpaysys_dbt ps " +
            "where crd.t_codclient = ? and " +
                  "dp.t_code = crd.t_fncash and " +
                  "codif.t_codcode = crd.t_cardtypecode and " +
                  "codif.t_codtype = 7 and " +
                  "lnk.t_fncash = crd.t_fncash and " +
                  "lnk.t_cardref = crd.t_cardref and " +
                  "lnk.t_cardaccref = dep.t_referenc and " +
                  "ps.t_paysysid = crd.t_paysysid";

  if ( ValType( Type ) == V_UNDEF )
    ;
  elif ( ValType( Type ) == V_STRING )
    if ( Type == "" )
     ;
    elif ( Type == "G" )
      sql = sql + " and decode( lnk.t_maincard, chr( 0 ), 'X', chr( 0 ) ) = chr( 0 )";
    elif ( Type == "D" )
      sql = sql + " and decode( lnk.t_maincard, chr( 0 ), 'X', chr( 0 ) ) <> chr( 0 )";
    else
      RunError( ErrMessage( 16502 ), 16502 );
    end;
  else
    RunError( ErrMessage( 16502 ), 16502 );
  end;

  if ( ValType( Activity ) == V_UNDEF )
    ;
  elif ( ValType( Activity ) == V_STRING )
    if ( Activity == "" )
     ;
    elif ( Activity == "A" )
      sql = sql + " and decode( crd.t_cardopenclose, chr( 0 ), chr( 0 ), 'X' ) = chr( 0 )";
    elif ( Activity == "C" )
      sql = sql + " and decode( crd.t_cardopenclose, chr( 0 ), chr( 0 ), 'X' ) <> chr( 0 )";
    else
      RunError( ErrMessage( 16503 ), 16503 );
    end;
  else
    RunError( ErrMessage( 16503 ), 16503 );
  end;

  var cmd = RsdCommand( sql );

  cmd.addParam( "p_ClientID", RsdBp_In, ClientID );

  cmd.nullConversion = true;
  cmd.execute;

  var rs = RsdRecordset( cmd );

  while ( rs.moveNext )
    var item = TClientCardItem;

    item.Branch = convertNullInt( rs.value( "branch" ) );
    item.BranchName = convertNullStr( rs.value( "branchName" ) );
    item.CardID = convertNullInt( rs.value( "cardRef" ) );
    item.CardNumber = convertNullStr( rs.value( "cardNumber" ) );
    item.Person = "";
    item.PSCode = convertNullStr( rs.value( "paySysCode" ) );
    item.TypeName = convertNullStr( rs.value( "cardTypeName" ) );
    item.isSupplement = convertNullStr( rs.value( "isSup" ) );
    item.isClosed = convertNullStr( rs.value( "isClose" ) );
    item.OpenDate = convertNullDate( rs.value( "cardOpenDate" ) );
    item.IssueDate = convertNullDate( rs.value( "cardRecDate" ) );
    item.EndDate = convertNullDate( rs.value( "cardMaturityDate" ) );
    item.CloseDate = convertNullDate( rs.value( "cardCloseDate" ) );
    item.Account = convertNullStr( rs.value( "Account" ) );

    retVal[retVal.size] = item;
  end;

  return retVal;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CardLimits ( Branch : integer, CardID : integer, CardNumber : string, RegDate : date )

  var retVal = TArray;
  var searchById = false;
  var searchByNumber = false;
  var branchForLim = 0;
  var cardIdForLim = 0;
  var cardCounter = 0;

  if ( ( ValType( Branch ) == V_INTEGER ) and ( ValType( CardID ) == V_INTEGER ) )
    if ( CardID > 0 )
      searchById = true;
    end;
  end;

  if ( not searchById )
    if ( ValType( CardNumber ) == V_STRING )
      if ( CardNumber != "" )
        searchByNumber = true;
      end;
    end;
  end;

  if ( searchById or searchByNumber )
   ;
  else
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  if ( ValType( RegDate ) == V_UNDEF )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var sql = "select crd.t_fncash branch, " +
                   "crd.t_cardref cardRef " +
            "from dsccard_dbt crd";

  if ( searchById )
    sql = sql + " where crd.t_fncash = ? and crd.t_cardref = ?";
  else
    sql = sql + " where crd.t_cardnumber = ?";
  end;

  var cmd = RsdCommand( sql );

  if ( searchById )
    cmd.addParam( "p_Branch", RsdBp_In, Branch );
    cmd.addParam( "p_CardRef", RsdBp_In, CardID );
  else
    cmd.addParam( "p_CardNumber", RsdBp_In, CardNumber );
  end;

  cmd.nullConversion = true;
  cmd.execute;

  var rs = RsdRecordset( cmd );

  while ( rs.moveNext )
    cardCounter = cardCounter + 1;
    if ( cardCounter > 1 )
      break;
    end;

    branchForLim = convertNullInt( rs.value( "branch" ) );
    cardIdForLim = convertNullInt( rs.value( "cardRef" ) );
  end;

  if ( cardCounter == 0 )
    if ( searchById )
      RunError( ErrMessage( 16505 ), 16505 );
    else
      RunError( ErrMessage( 16506 ), 16506 );
    end;
  elif ( cardCounter == 1 )
    ;
  else
    RunError( ErrMessage( 16508 ), 16508 );
  end;

  sql = "select nalvl.t_sznamealg nameLevel, " +
               "natyp.t_sznamealg nameType, " +
               "nakind.t_sznamealg nameKind, " +
               "naperiod.t_sznamealg namePeriod, " +
               "lim.t_begindate beginDate, " +
               "lim.t_enddate endDate, " +
               "lim.t_limitvalue limitValue " +
        "from dsclimit_dbt lim, " +
             "dsclmtype_dbt typ, " +
             "dnamealg_dbt nalvl, " +
             "dnamealg_dbt natyp, " +
             "dnamealg_dbt nakind, " +
             "dnamealg_dbt naperiod " +
        "where typ.t_limittypeid = lim.t_limittypeid and " +
              "nalvl.t_itypealg(+) = 861 and " +
              "natyp.t_itypealg(+) = 862 and " +
              "naperiod.t_itypealg(+) = 863 and " +
              "nakind.t_itypealg(+) = 864 and " +
              "nalvl.t_inumberalg(+) = typ.t_level and " +
              "natyp.t_inumberalg(+) = typ.t_type and " +
              "nakind.t_inumberalg(+) = typ.t_operkind and " +
              "naperiod.t_inumberalg(+) = typ.t_period and " +
              "naperiod.t_inumberalg(+) = typ.t_period and " +
              "lim.t_fncash = ? and " +
              "lim.t_cardref = ?";

  if ( RegDate != Date( 0, 0, 0 ) )
    sql = sql + " and ? between lim.t_begindate and decode( lim.t_enddate, to_date( '01.01.0001', 'DD.MM.YYYY' ), to_date( '31.12.2199', 'DD.MM.YYYY' ), lim.t_enddate )";
  end;

  cmd = RsdCommand( sql );

  cmd.addParam( "p_Branch", RsdBp_In, branchForLim );
  cmd.addParam( "p_CardRef", RsdBp_In, cardIdForLim );

  if ( RegDate != Date( 0, 0, 0 ) )
    cmd.addParam( "p_RegDate", RsdBp_In, RegDate );
  end;

  cmd.nullConversion = true;
  cmd.execute;

  rs = RsdRecordset( cmd );

  while ( rs.moveNext )
    var item = TCardLimitsItem;

    item.Level = convertNullStr( rs.value( "nameLevel" ) );
    item.LimitType = convertNullStr( rs.value( "nameType" ) );
    item.OperKind = convertNullStr( rs.value( "nameKind" ) );
    item.Period = convertNullStr( rs.value( "namePeriod" ) );
    item.BeginDate = convertNullDate( rs.value( "beginDate" ) );
    item.EndDate = convertNullDate( rs.value( "endDate" ) );
    item.LimitValue = convertNullInt( rs.value( "limitValue" ) );

    retVal[retVal.size] = item;
  end;

  return retVal;
end;

/**************************************************************************\
|                         àçîéêåÄñàü èé äÄêíÄå                             |
\**************************************************************************/
macro CardInfo ( ExternalData )

  var retVal = TArray;
  var i;
  var j;

  i = 1;
  while ( i <= StrLen( ExternalData.InfoType ) )
    if ( SubStr( ExternalData.InfoType, i, 1 ) == "F" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "I" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "S" )
      ;
    elif ( SubStr( ExternalData.InfoType, i, 1 ) == "C" )
      ;
    else
      RunError( ErrMessage( 16509 ), 16509 );
    end;
    i = i + 1;
  end;


  var num = ExternalData.Cards.size;
  for ( j, 0, num-1 )
    if ( (ValType(ExternalData.Cards[j].ID) != V_STRING) or (ValType(ExternalData.Cards[j].ObjectType) != V_INTEGER) or (ValType(ExternalData.Cards[j].IDType) != V_INTEGER) )
      RunError( ErrMessage( 16504 ), 16504 );
    end;
    if ( (ExternalData.Cards[j].ID == "") )
      RunError( ErrMessage( 16520 ), 16520 );
    end;
    if ( (ExternalData.Cards[j].IDType == 2) and ((ValType(ExternalData.Cards[j].Branch) != V_STRING) or (ExternalData.Cards[j].Branch == "")) )
      RunError( ErrMessage( 16520 ), 16520 );
    end;
    if ((ExternalData.Cards[j].ObjectType != 554) and (ExternalData.Cards[j].ObjectType != 552))
      RunError( ErrMessage( 16520 ), 16520 );
    end;

    if ( ((ValType(ExternalData.InfoType) != V_STRING) or (ExternalData.InfoType == "")) )
      RunError( ErrMessage( 16504 ), 16504 );
    end;

    var searchById = false;
    var searchByNumber = false;
    if (ExternalData.Cards[j].IDType == 1)
      searchById = true;
    elif (ExternalData.Cards[j].IDType == 2)
      searchByNumber = true;
    else
      RunError( ErrMessage( 16531 ), 16531 );
    end;

    var sql, cmd;
    if ( ExternalData.Cards[j].ObjectType == 554 )
      sql = "select crd.* " +
                      "from dsccard_dbt crd";
      if ( searchById )
        sql = sql + " where crd.t_fncash = ? and crd.t_cardref = ?";
      else
        sql = sql + " where crd.t_cardnumber = ? and crd.t_fncash = (select t_code from ddp_dep_dbt where t_name = ?)";
      end;
      cmd = RsdCommand( sql );
      if ( searchById )
        var ExtBranch = int(SubStr(ExternalData.Cards[j].ID, 1, StrBrk(ExternalData.Cards[j].ID,"/")));
        var ExtCardRef = int(SubStr(ExternalData.Cards[j].ID, StrBrk(ExternalData.Cards[j].ID,"/") + 1));
        cmd.addParam( "p_Branch", RsdBp_In, ExtBranch );
        cmd.addParam( "p_CardRef", RsdBp_In, ExtCardRef );
      else
        cmd.addParam( "p_CardNumber", RsdBp_In,  ExternalData.Cards[j].ID );
        cmd.addParam( "p_Branch", RsdBp_In, ExternalData.Cards[j].Branch );
      end;
    elif ( ExternalData.Cards[j].ObjectType == 552 )
      sql = "select crd.* " +
              "from dsccard_dbt crd, drt_contract_dbt con " +
              "where CRD.T_CURRENTCNTRCARD = 'X' AND CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH ";
      if ( searchById )
        sql = sql + " and CON.T_BRANCH = ? and CON.T_ID = ? ";
      else
        sql = sql + " and CON.T_NUMBER = ? and CON.T_BRANCH = (select t_code from ddp_dep_dbt where t_name = ?) ";
      end;
      cmd = RsdCommand( sql );
      if ( searchById )
        var ConBranch = int(SubStr(ExternalData.Cards[j].ID, 1, StrBrk(ExternalData.Cards[j].ID,"/")));
        var ConCardID = int(SubStr(ExternalData.Cards[j].ID, StrBrk(ExternalData.Cards[j].ID,"/") + 1));
        cmd.addParam( "p_Branch", RsdBp_In, ConBranch );
        cmd.addParam( "p_ConCardID", RsdBp_In, ConCardID );
      else
        cmd.addParam( "p_ConCardNumber", RsdBp_In,  ExternalData.Cards[j].ID );
        cmd.addParam( "p_Branch", RsdBp_In, ExternalData.Cards[j].Branch );
      end;
    end;

    cmd.nullConversion = true;
    cmd.execute;

    var rs_Card = RsdRecordset( cmd );
    if ( not rs_Card.moveNext() )
      /*if ( searchById )
        RunError( ErrMessage( 16505 ), 16505 );
      else
        RunError( ErrMessage( 16506 ), 16506 );
      end;*/
      continue;
    end;

    var CardResult = TCIRes;
    var linkRef = 0;
     sql = "select dp.t_name branchName, " +
                 "ps.t_paysyscode psCode, " +
                 "ps.t_paysysname psName, " +
                 "codiftype.t_codname typeName, " +
                 "rctr.t_number contractNumber, " +
                 "decode( crd.t_cardopenclose, chr( 0 ), chr( 0 ), 'X' ) isClose, " +
                 "decode( lnk.t_maincard, chr( 0 ), 'X', chr( 0 ) ) isSup, " +
                 "crd.t_cardnumber cardNumber, " +
                 "contr.t_maincardcntrid mainCntrId, " +
                 "crd.t_prevcardref prevCardRef, " +
                 "crd.t_cardmayoverissuer canReIssue, " +
                 "crd.t_cardopendate openDate, " +
                 "crd.t_cardrecdate issueDate, " +
                 "crd.t_cardmaturitydate endDate, " +
                 "crd.t_cardclosedate closeDate, " +
                 "codifstate.t_codUserCode stateCode, " +
                 "codifstate.t_codname stateName, " +
                 "dep.t_account account, " +
                 "case lnk.t_MainSubAccLinkRef when 0 then lnk.t_acccardlinkref else lnk.t_MainSubAccLinkRef end linkRef, " +
                 "crd.t_codclient codClient, " +
                 "prs.t_name nameCardHolder, " +
                 "Decode(prod.t_fundsource,1,1,2,2,3,2,4,3) FundSource " +
          "from dsccard_dbt crd, " +
               "ddp_dep_dbt dp, " +
               "dsccodif_dbt codiftype, " +
               "dsccodif_dbt codifstate, " +
               "dsclink_dbt lnk, " +
               "ddepositr_dbt dep, " +
               "dscpaysys_dbt ps, " +
               "dparty_dbt prs, " +
               "drtcardcontract_dbt contr, " +
               "drt_contract_dbt rctr, " +
               "dcardproduct_dbt prod " +
          "where dp.t_code = crd.t_fncash and " +
                "codiftype.t_codcode = crd.t_cardtypecode and " +
                "codiftype.t_codtype = 7 and " +
                "codifstate.t_codcode = crd.t_cardstatecode and " +
                "codifstate.t_codtype = 6 and " +
                "lnk.t_fncash = crd.t_fncash and " +
                "lnk.t_cardref = crd.t_cardref and " +
                "lnk.t_cardaccref = dep.t_referenc and " +
                "ps.t_paysysid = crd.t_paysysid and " +
                "prs.t_partyid = crd.t_codclient and " +
                "crd.t_contractid = contr.t_id and " +
                "crd.t_fncash = contr.t_branch and " +
                "rctr.t_branch = contr.t_branch and " +
                "rctr.t_id = contr.t_id and " +
                "prod.t_cardproductid = contr.t_cardproductid and " +
                "crd.t_fncash = ? and " +
                "crd.t_cardref = ?";

      var fndCommCard = RsdCommand( sql );

      fndCommCard.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndCommCard.addParam( "p_CardRef", RsdBp_In, rs_Card.value("T_CARDREF") );

      fndCommCard.nullConversion = true;
      fndCommCard.execute;


      var rs_ComCard = RsdRecordset( fndCommCard );
      rs_ComCard.moveNext();
      linkRef = Int(convertNullInt(rs_ComCard.value("linkRef")));  // linkRef ÔËıÓ‰ËÚ Í‡Í double...

    if ( ( StrBrk ( ExternalData.InfoType, "F" ) > 0 ) or ( StrBrk ( ExternalData.InfoType, "I" ) > 0 ) )
      CardResult.CardData.CardNumber = rs_Card.value("T_CARDNUMBER");
      CardResult.CardData.Branch = rs_Card.value("T_FNCASH");

      CardResult.CardData.BranchName = convertNullStr( rs_ComCard.value( "branchName" ) );
      CardResult.CardData.PSCode = convertNullStr( rs_ComCard.value( "psCode" ) );
      CardResult.CardData.PSName = convertNullStr( rs_ComCard.value( "psName" ) );

      if ( convertNullInt(rs_ComCard.value( "FundSource" )) == 1 )
        CardResult.CardData.SourceType = "D";
      elif ( convertNullInt(rs_ComCard.value( "FundSource" )) == 2 )
        CardResult.CardData.SourceType = "O";
      elif ( convertNullInt(rs_ComCard.value( "FundSource" )) == 3 )
        CardResult.CardData.SourceType = "C";
      end;

      CardResult.CardData.TypeName = convertNullStr( rs_ComCard.value( "typeName" ) );
      CardResult.CardData.isSupplement = convertNullStr( rs_ComCard.value( "isSup" ) );
      CardResult.CardData.StateCode = convertNullStr( rs_ComCard.value( "stateCode" ) );
      CardResult.CardData.StateName = convertNullStr( rs_ComCard.value( "stateName" ) );
      CardResult.CardData.isClosed = convertNullStr( rs_ComCard.value( "isClose" ) );
      CardResult.CardData.OpenDate = convertNullDate( rs_ComCard.value( "openDate" ) );
      CardResult.CardData.IssueDate = convertNullDate( rs_ComCard.value( "issueDate" ) );
      CardResult.CardData.EndDate = convertNullDate( rs_ComCard.value( "endDate" ) );
      CardResult.CardData.CloseDate = convertNullDate( rs_ComCard.value( "closeDate" ) );
      if ( convertNullInt( rs_ComCard.value( "prevCardRef" ) ) != 0 )
        var fndPrevCard = rsdcommand( "select crd.* from dsccard_dbt crd where crd.t_fncash = ? and crd.t_cardref = ?");
        fndPrevCard.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
        fndPrevCard.addParam( "p_CardNumber", RsdBp_In, convertNullInt( rs_ComCard.value( "prevCardRef" ) ) );
        var rs_fndPrevCard = RsdRecordset(fndPrevCard);
        if (rs_fndPrevCard.moveNext())
          CardResult.CardData.PrevCard.ID = string( rs_fndPrevCard.value("T_FNCASH") ) + "/" + string( rs_fndPrevCard.value("T_CARDREF") );
          CardResult.CardData.PrevCard.Number = rs_fndPrevCard.value("T_CARDNUMBER");
          CardResult.CardData.PrevCard.Branch = convertNullStr( rs_ComCard.value( "branchName" ) );
          CardResult.CardData.PrevCard.OpenDate = rs_fndPrevCard.value("T_CARDOPENDATE");
        end;
      end;
      CardResult.CardData.CanReIssue = convertNullStr( rs_ComCard.value( "canReIssue" ) );

      var fndLim = rsdcommand("select * from dsclimit_dbt where T_CARDREF = ? and T_FNCASH = ?");
      fndLim.addParam( "p_CardRef", RsdBp_In, rs_Card.value("T_CARDREF") );
      fndLim.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndLim.nullConversion = true;
      fndLim.execute();
      var rs_fndLim = Rsdrecordset(fndLim);
      if ( rs_fndLim.moveNext() )
        CardResult.CardData.IsLimited = true;
      else
        CardResult.CardData.IsLimited = false;
      end;

      var fndCardCon = rsdcommand ("select * from drt_contract_dbt where T_NUMBER = ? and T_BRANCH = ?");
      fndCardCon.addParam( "p_Num", RsdBp_In,  convertNullStr( rs_ComCard.value( "contractNumber" ) ) );
      fndCardCon.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndCardCon.nullConversion = true;
      fndCardCon.execute();
      var rs_fndCardCon = rsdrecordset(fndCardCon);
      if ( rs_fndCardCon.moveNext() )
        CardResult.CardData.Contract.ID = string (rs_fndCardCon.value("T_BRANCH")) + "/" + string  (rs_fndCardCon.value("T_ID"));
        CardResult.CardData.Contract.Number = rs_fndCardCon.value("T_NUMBER");
        CardResult.CardData.Contract.OpenDate = rs_fndCardCon.value("T_OPENDATE");
      end;

      var fndcardAcc = rsdcommand("select * from ddepositr_dbt where T_ACCOUNT = ? and T_FNCASH = ?");
      fndcardAcc.addParam( "p_Num", RsdBp_In,  convertNullStr( rs_ComCard.value( "account" ) ) );
      fndcardAcc.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndcardAcc.nullConversion = true;
      fndcardAcc.execute();
      var rs_fndcardAcc = RsdRecordset(fndcardAcc);
      if ( rs_fndcardAcc.moveNext() )
        CardResult.CardData.Account.ID = rs_fndcardAcc.value("T_REFERENC");
        CardResult.CardData.Account.Number = rs_fndcardAcc.value("T_ACCOUNT");
        var fndCardCur = FindCurrency(FINDCURBYCODE_CUR, rs_fndcardAcc.value("T_CODE_CURRENCY"));
        CardResult.CardData.Currency = RetKernelNatISO(fndCardCur.value("T_EXTERNALCODE"));
        CardResult.CardData.Account.Currency = RetKernelNatISO(fndCardCur.value("T_EXTERNALCODE"));
        CardResult.CardData.Account.OpenDate = rs_fndcardAcc.value("T_OPEN_DATE");
      end;

      if ( convertNullInt( rs_ComCard.value( "mainCntrId" ) ) > 0 )
        sql = "select crd.t_cardNumber mainCardNumber, " +
                   "crd.t_cardref cardRef, " +
                   "crd.t_fncash fncash, " +
                   "crd.t_cardopendate openDate, " +
                   "crd.t_codclient codClient, " +
                   "prs.t_name nameMainCardHolder, " +
                   "dep.t_name BranchName, " +
                   "cardcon.t_deprcntrid depconid, " +
                   "cur.t_externalcode externalcode " +
            "from dsccard_dbt crd, " +
                 "dparty_dbt prs, " +
                 "ddp_dep_dbt dep, " +
                 "drtcardcontract_dbt cardcon, " +
                 "drt_contract_dbt con, " +
                 "ddepositr_dbt depos, " +
                 "dcurrency_dbt cur " +
            "where crd.t_fncash = ? and " +
                  "crd.t_contractid = ? and " +
                  "crd.t_currentcntrcard = 'X' and " +
                  "prs.t_partyid = crd.t_codclient and " +
                  "dep.t_code = crd.t_fncash and " +
                  "cardcon.t_branch = crd.t_fncash and " +
                  "cardcon.t_id = crd.t_contractid and " +
                  "con.t_id = cardcon.t_deprcntrid and " +
                  "con.t_branch = crd.t_fncash and " +
                  "depos.t_SvodAccount = con.t_number and " +
                  "con.t_branch = depos.t_fncash and " +
                  "cur.t_code_currency = depos.t_code_currency ";

        var fndMainCard = RsdCommand( sql );

        fndMainCard.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
        fndMainCard.addParam( "p_ContractId", RsdBp_In, convertNullInt( rs_ComCard.value( "mainCntrId" ) ) );

        fndMainCard.nullConversion = true;
        fndMainCard.execute();

        var rs_fndMainCard = RsdRecordset( fndMainCard );

        if ( rs_fndMainCard.moveNext() )
          CardResult.CardData.MainCard.ID =  string(convertNullInt(rs_fndMainCard.value("fncash"))) + "/" + convertNullStr(rs_fndMainCard.value("cardRef"));
          CardResult.CardData.MainCard.Number = convertNullStr(rs_fndMainCard.value("mainCardNumber"));
          CardResult.CardData.MainCard.Currency = RetKernelNatISO(convertNullStr(rs_fndMainCard.value("externalcode")));
          CardResult.CardData.MainCard.Branch = convertNullStr(rs_fndMainCard.value("BranchName"));
          CardResult.CardData.MainCard.OpenDate = convertNullDate(rs_fndMainCard.value("openDate"));
          if ( ( StrBrk ( ExternalData.InfoType, "F" ) > 0 ) or ( StrBrk ( ExternalData.InfoType, "C" ) > 0 ) )
            CardResult.CardData.MainCard.PersonID = convertNullInt(rs_fndMainCard.value("codClient"));
            CardResult.CardData.MainCard.Person = convertNullStr(rs_fndMainCard.value("nameMainCardHolder"));
          end;
        end;
      end;
    end;

    if ( ( StrBrk ( ExternalData.InfoType, "F" ) > 0 ) or ( StrBrk ( ExternalData.InfoType, "S" ) > 0 ) )

      if ( linkRef > 0 )
        sql = 
              "select * from ( "
              "select doc.t_rest rest, cur.t_externalcode " +
              "from dsccrddoc_dbt doc, dcurrency_dbt cur " +
              "where doc.t_fncash = ? and " +
                    "doc.t_acccardlinkref = ? and " +
                    "doc.t_action != 2 and " +
                    "cur.t_code_currency = doc.t_currcode " +
              "order by doc.t_date desc, doc.t_numdaydoc desc"
              ") "
              "where rownum = 1 ";

        var fndRest = RsdCommand( sql );

        fndRest.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
        fndRest.addParam( "p_LinkRef", RsdBp_In,  linkRef );

        fndRest.nullConversion = true;
        fndRest.execute();
        var rs_fndResst = RsdRecordset( fndRest );
        if ( rs_fndResst.moveNext )
          CardResult.FinInfo.Rest.Sum = convertNullInt( rs_fndResst.value( "rest" ) );
          CardResult.FinInfo.Rest.Currency = RetKernelNatISO(convertNullStr( rs_fndResst.value("t_externalcode") ));
        else
          CardResult.FinInfo.Rest.Sum = $0;
        end;
      end;

      sql = "select * from drtcardcontract_dbt where T_BRANCH = ? and T_ID = ?";
      var fndCredconId = rsdcommand(sql);
      fndCredconId.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndCredconId.addParam( "p_ContractId", RsdBp_In, convertNullInt( rs_Card.value( "T_CONTRACTID" ) ));
      fndCredconId.nullConversion = true;
      fndCredconId.execute();
      var rs_fndCredconId = Rsdrecordset(fndCredconId);
      if ( rs_fndCredconId.moveNext() )
        CardResult.FinInfo.CreditContractID = convertNullInt( rs_fndCredconId.value( "T_CREDITCNTRID" ));
      else
        CardResult.FinInfo.CreditContractID = 0;
      end;

      sql = "SELECT DECODE (TYPELIM.T_LEVEL,  1, 'A',  2, 'C') ObjType, " +
         "DECODE (TYPELIM.T_TYPE,  2, 'O',  1, 'S') TYPE, "
         "DECODE (TYPELIM.T_OPERKIND,  3, 'A',  2, 'C',  1, 'T') OperType, "
         "DECODE (TYPELIM.T_PERIOD,  1, 2,  2, 4,  3, 3,  4, 1) PeriodType, " +
         "LIM.T_BEGINDATE beginDate, " +
         "LIM.T_ENDDATE endDate, " +
         "LIM.T_LIMITVALUE summa, " +
         "cur.t_externalcode externalcode " +
         "FROM dsccard_dbt crd, " +
         "drtcardcontract_dbt cardcon, " +
         "drt_contract_dbt con, " +
         "ddepositr_dbt depos, " +
         "dcurrency_dbt cur, " +
         "dsclimit_dbt lim, " +
         "dsclmtype_dbt typelim " +
         " WHERE     LIM.t_begindate >= ? " +
         "AND LIM.T_ENDDATE = TO_DATE ('01.01.0001', 'dd.mm.yyyy') " +
         "AND LIM.T_ACTION <> 2 " +
         "AND TYPELIM.T_LIMITTYPEID = LIM.T_LIMITTYPEID " +
         "AND lim.T_FNCASH = CRD.T_FNCASH " +
         "AND lim.T_CARDREF = CRD.T_CARDREF " +
         "AND cardcon.t_branch = crd.t_fncash " +
         "AND cardcon.t_id = crd.t_contractid " +
         "AND con.t_id = cardcon.t_deprcntrid " +
         "AND con.t_branch = crd.t_fncash " +
         "AND depos.t_SvodAccount = con.t_number " +
         "AND con.t_branch = depos.t_fncash " +
         "AND cur.t_code_currency = depos.t_code_currency " +
         "AND CRD.T_FNCASH = ? " +
         "AND CRD.T_CARDREF = ? " +
         "UNION ALL " +
         "SELECT DECODE (TYPELIM.T_LEVEL,  1, 'A',  2, 'C') ObjType, " +
         "DECODE (TYPELIM.T_TYPE,  2, 'O',  1, 'S') TYPE, " +
         "DECODE (TYPELIM.T_OPERKIND,  3, 'A',  2, 'C',  1, 'T') OperType, " +
         "DECODE (TYPELIM.T_PERIOD,  1, 2,  2, 4,  3, 3,  4, 1) PeriodType, " +
         "LIM.T_BEGINDATE beginDate, " +
         "LIM.T_ENDDATE endDate, " +
         "LIM.T_LIMITVALUE summa, " +
         "cur.t_externalcode externalcode " +
         "FROM dsccard_dbt crd, " +
         "drtcardcontract_dbt cardcon, " +
         "drt_contract_dbt con, " +
         "ddepositr_dbt depos, " +
         "dcurrency_dbt cur, " +
         "dsclimit_dbt lim, " +
         "dsclmtype_dbt typelim " +
         "WHERE     LIM.t_begindate >= ? " +
         "AND LIM.T_ENDDATE >= ? " +
         "AND LIM.T_ACTION <> 2 " +
         "AND TYPELIM.T_LIMITTYPEID = LIM.T_LIMITTYPEID " +
         "AND lim.T_FNCASH = CRD.T_FNCASH " +
         "AND lim.T_CARDREF = CRD.T_CARDREF " +
         "AND cardcon.t_branch = crd.t_fncash " +
         "AND cardcon.t_id = crd.t_contractid " +
         "AND con.t_id = cardcon.t_deprcntrid " +
         "AND con.t_branch = crd.t_fncash " +
         "AND depos.t_SvodAccount = con.t_number " +
         "AND con.t_branch = depos.t_fncash " +
         "AND cur.t_code_currency = depos.t_code_currency " +
         "AND CRD.T_FNCASH = ? " +
         "AND CRD.T_CARDREF = ?";

      var fndLimit = RsdCommand(sql);
      fndLimit.addParam( "p_curdate", RsdBp_In, {curdate} );
      fndLimit.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndLimit.addParam( "p_ContractId", RsdBp_In, convertNullInt( rs_Card.value( "T_CARDREF" ) ));
      fndLimit.addParam( "p_begndate", RsdBp_In, {curdate} );
      fndLimit.addParam( "p_enddate", RsdBp_In, {curdate} );
      fndLimit.addParam( "p_Branch1", RsdBp_In, rs_Card.value("T_FNCASH") );
      fndLimit.addParam( "p_ContractId1", RsdBp_In, convertNullInt( rs_Card.value( "T_CARDREF" ) ));
      fndLimit.nullConversion = true;
      fndLimit.execute();
      var rs_fndLimit = RsdRecordSet(fndLimit);
      while ( rs_fndLimit.moveNext() )
        var Limit = TLimitData;
        Limit.Object = convertNullStr( rs_fndLimit.value("ObjType") );
        Limit.Type = convertNullStr( rs_fndLimit.value("TYPE") );
        Limit.OperType = convertNullStr( rs_fndLimit.value("OperType") );
        Limit.PeriodType = convertNullInt( rs_fndLimit.value("PeriodType") );
        Limit.BeginDate = convertNullDate( rs_fndLimit.value("beginDate") );
        Limit.EndDate = convertNullDate( rs_fndLimit.value("endDate") );
        if ( Limit.Type == "S" )
          Limit.Sum.Sum = rs_fndLimit.value("summa");
          Limit.Sum.Currency = RetKernelNatISO(convertNullStr( rs_fndLimit.value("externalcode") ));
        elif ( Limit.Type == "O" )
          Limit.Quantity = rs_fndLimit.value("summa");
        end;

        CardResult.FinInfo.Limits[CardResult.FinInfo.Limits.size] = Limit;
      end;
    end;
    
      if ( ( StrBrk ( ExternalData.InfoType, "F" ) > 0 ) or ( StrBrk ( ExternalData.InfoType, "C" ) > 0 ) )
        sql = "SELECT PRS.T_NAME ClientName, " +
             "PRS.T_PARTYID CodClient, " +
             "decode (CRD.T_EMBOSSINGNAME1, chr(1), '', CRD.T_EMBOSSINGNAME1 ) Emb1, " +
             "decode (CRD.T_EMBOSSINGNAME2, chr(1), '', CRD.T_EMBOSSINGNAME2 ) Emb2 " +
             "FROM dparty_dbt prs, dsccard_dbt crd " +
             "WHERE     PRS.T_PARTYID = CRD.T_CODCLIENT " +
             "AND CRD.T_FNCASH = ? " +
             "AND CRD.T_CARDREF = ?";
        var findPerson = rsdCommand(sql);
        findPerson.addParam( "p_Branch", RsdBp_In, rs_Card.value("T_FNCASH") );
        findPerson.addParam( "p_ContractId", RsdBp_In, convertNullInt( rs_Card.value( "T_CARDREF" ) ));
        findPerson.nullConversion = true;
        findPerson.execute();
        var rs_findPerson = RsdRecordset(findPerson);
        if ( rs_findPerson.moveNext() )
          CardResult.PersonInfo.PersonID = convertNullInt( rs_findPerson.value("CodClient") );
          CardResult.PersonInfo.Person = convertNullStr( rs_findPerson.value("ClientName") );
          if ( (convertNullStr( rs_findPerson.value("Emb1") ) != "") and (convertNullStr( rs_findPerson.value("Emb2") ) != "") )
            CardResult.PersonInfo.EmbossingText = convertNullStr( rs_findPerson.value("Emb1") ) + "/" + convertNullStr( rs_findPerson.value("Emb2") );
          elif( convertNullStr( rs_findPerson.value("Emb1") ) != "" )
            CardResult.PersonInfo.EmbossingText = convertNullStr( rs_findPerson.value("Emb1") );
          elif( convertNullStr( rs_findPerson.value("Emb2") ) != "" )
            CardResult.PersonInfo.EmbossingText = convertNullStr( rs_findPerson.value("Emb2") );
          end;
        end;

      end;
      
    CardResult.CardID = string( convertNullInt( rs_Card.value( "T_FNCASH" ) ) ) + "/" + convertNullStr( rs_Card.value( "T_CARDREF" ) );
    retVal[retVal.size] = CardResult;
  end;

  return retVal;
end;

/**************************************************************************\
|                   ÑéèéãçàíÖãúçõÖ äÄêíõ ä éëçéÇçéâ                        |
\**************************************************************************/
macro SuppCardList ( ExternalData )

  var retVal = TArray;

  if ( (ValType(ExternalData.Card.ID) != V_STRING) or (ValType(ExternalData.Card.ObjectType) != V_INTEGER) or (ValType(ExternalData.Card.IDType) != V_INTEGER) )
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  if ( (ExternalData.Card.ID == "") )
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ( (ExternalData.Card.IDType == 2) and ((ValType(ExternalData.Card.Branch) != V_STRING) or (ExternalData.Card.Branch == "")) )
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ((ExternalData.Card.ObjectType != 554) and (ExternalData.Card.ObjectType != 552))
    RunError( ErrMessage( 16520 ), 16520 );
  end;

  if (ValType(ExternalData.Filter) == V_UNDEF)
    ExternalData.Filter = "";
  end;
  var i;
  i = 1;
  while ( i <= StrLen( ExternalData.Filter ) )
    if ( SubStr( ExternalData.Filter, i, 1 ) == "A" )
      ;
    elif ( SubStr( ExternalData.Filter, i, 1 ) == "C" )
      ;
    elif ( SubStr( ExternalData.Filter, i, 1 ) == "" )
      ;
    else
      RunError( ErrMessage( 16509 ), 16509 );
    end;
    i = i + 1;
  end;

  var searchById = false;
  var searchByNumber = false;
  if (ExternalData.Card.IDType == 1)
    searchById = true;
  elif (ExternalData.Card.IDType == 2)
    searchByNumber = true;
  else
    RunError( ErrMessage( 16531 ), 16531 );
  end;

  var sql;
  var MainCard;
  if (ExternalData.Card.ObjectType == 554)
    sql = "select crd.* " +
                    "from dsccard_dbt crd";
    if ( searchById )
      sql = sql + " where crd.t_fncash = ? and crd.t_cardref = ?";
    else
      sql = sql + " where crd.t_cardnumber = ? and crd.t_fncash = (select t_code from ddp_dep_dbt where t_name = ?)";
    end;
    MainCard = RsdCommand( sql );
    if ( searchById )
      var ExtBranch = int(SubStr(ExternalData.Card.ID, 1, StrBrk(ExternalData.Card.ID,"/")));
      var ExtCardRef = int(SubStr(ExternalData.Card.ID, StrBrk(ExternalData.Card.ID,"/") + 1));
      MainCard.addParam( "p_Branch", RsdBp_In, ExtBranch );
      MainCard.addParam( "p_CardRef", RsdBp_In, ExtCardRef );
    else
      MainCard.addParam( "p_CardNumber", RsdBp_In,  ExternalData.Card.ID );
      MainCard.addParam( "p_Branch", RsdBp_In, ExternalData.Card.Branch );
    end;
  elif (ExternalData.Card.ObjectType == 552)
    sql = "select crd.* " +
            "from dsccard_dbt crd, drt_contract_dbt con " +
            "where CRD.T_CURRENTCNTRCARD = 'X' AND CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH ";
    if ( searchById )
      sql = sql + " and CON.T_BRANCH = ? and CON.T_ID = ? ";
    else
      sql = sql + " and CON.T_NUMBER = ? and CON.T_BRANCH = (select t_code from ddp_dep_dbt where t_name = ?) ";
    end;
    MainCard = RsdCommand( sql );
    if ( searchById )
      var ConBranch = int(SubStr(ExternalData.Card.ID, 1, StrBrk(ExternalData.Card.ID,"/")));
      var ConCardID = int(SubStr(ExternalData.Card.ID, StrBrk(ExternalData.Card.ID,"/") + 1));
      MainCard.addParam( "p_Branch", RsdBp_In, ConBranch );
      MainCard.addParam( "p_ConCardID", RsdBp_In, ConCardID );
    else
      MainCard.addParam( "p_ConCardNumber", RsdBp_In,  ExternalData.Card.ID );
      MainCard.addParam( "p_Branch", RsdBp_In, ExternalData.Card.Branch );
    end;
  end;

  MainCard.nullConversion = true;
  MainCard.execute;

  var rs_MainCard = RsdRecordset( MainCard );
  if ( not rs_MainCard.moveNext() )
    if ( searchById )
      RunError( ErrMessage( 16505 ), 16505 );
    else
      RunError( ErrMessage( 16506 ), 16506 );
    end;
  else
    if ( rs_MainCard.moveNext )
      RunError( ErrMessage( 16508 ), 16508 );
    end;
  end;

  sql = "select * " +
        "from drtcardcontract_dbt cntr " +
        "where cntr.t_branch = ? and " +
              "cntr.t_id = ?";

  var IsNotMain = RsdCommand( sql );

  IsNotMain.addParam( "p_Branch", RsdBp_In, convertNullInt(rs_MainCard.value("T_FNCASH")) );
  IsNotMain.addParam( "p_CntrId", RsdBp_In, convertNullInt(rs_MainCard.value("T_CONTRACTID")) );
  IsNotMain.nullConversion = true;
  IsNotMain.execute;

  var rs_IsNotMain = RsdRecordset( IsNotMain );
  if ( rs_IsNotMain.moveNext )
    if ( convertNullInt( rs_IsNotMain.value( "T_MAINCARDCNTRID" ) ) > 0 )
      RunError( ErrMessage( 16507 ), 16507 );
    end;
  end;

  sql = "select crd.t_fncash branch, " +
               "dp.t_name branchName, " +
               "crd.t_cardref cardRef, " +
               "crd.t_cardnumber cardNumber, " +
               "cur.t_externalcode currency," +
               "prs.t_name nameCardHolder, " +
               "ps.t_paysyscode paySysCode, " +
               "codif.t_codname cardTypeName, " +
               "codifstate.t_codUserCode cardStateCode, " +
               "decode( crd.t_cardopenclose, CHR (1), 'X', '') isClose, " +
               "crd.t_cardopendate cardOpenDate, " +
               "crd.t_cardrecdate cardRecDate, " +
               "crd.t_cardmaturitydate cardMaturityDate, " +
               "crd.t_cardclosedate cardCloseDate, " +
               "dep.t_account Account, " +
               "dep.t_referenc Referenc, " +
               "prs.t_partyid PersonId " +
        "from dsccard_dbt crd, " +
             "ddp_dep_dbt dp, " +
             "dsccodif_dbt codif, " +
             "dsccodif_dbt codifstate, " +
             "dsclink_dbt lnk, " +
             "ddepositr_dbt dep, " +
             "dscpaysys_dbt ps, " +
             "dparty_dbt prs, " +
             "drtcardcontract_dbt contr, " +
             "dcurrency_dbt cur " +
        "where dp.t_code = crd.t_fncash and " +
              "codif.t_codcode = crd.t_cardtypecode and " +
              "codif.t_codtype = 7 and " +
              "codifstate.t_codcode = crd.t_cardstatecode and " +
              "codifstate.t_codtype = 6 and " +
              "lnk.t_fncash = crd.t_fncash and " +
              "lnk.t_cardref = crd.t_cardref and " +
              "lnk.t_cardaccref = dep.t_referenc and " +
              "ps.t_paysysid = crd.t_paysysid and " +
              "prs.t_partyid = crd.t_codclient and " +
              "contr.t_branch = ? and " +
              "contr.t_maincardcntrid = ? and " +
              "crd.t_contractid = contr.t_id and " +
              "crd.t_fncash = contr.t_branch and " +
              "cur.t_code_currency = dep.t_code_currency";


  if ( ExternalData.Filter == "" )
   ;
  elif ( ExternalData.Filter == "A" )
    sql = sql + " and decode( crd.t_cardopenclose, CHR (1), 'X', chr(0)) = chr( 0 )";
  elif ( ExternalData.Filter == "C" )
    sql = sql + " and decode( crd.t_cardopenclose, CHR (1), 'X', chr(0)) <> chr( 0 )";
  else
    RunError( ErrMessage( 16503 ), 16503 );
  end;

  var AddCard = RsdCommand( sql );

  AddCard.addParam( "p_Branch", RsdBp_In,  convertNullInt(rs_MainCard.value("T_FNCASH")) );
  AddCard.addParam( "p_ContractID", RsdBp_In,  convertNullInt(rs_MainCard.value("T_CONTRACTID")) );

  AddCard.nullConversion = true;
  AddCard.execute;

  var rs_AddCard = RsdRecordset( AddCard );

  while ( rs_AddCard.moveNext )
    var ResCard = TSCLRes;

    ResCard.Branch = convertNullInt( rs_AddCard.value( "branch" ) );
    ResCard.BranchName = convertNullStr( rs_AddCard.value( "branchName" ) );
    ResCard.CardID = string( convertNullInt( rs_AddCard.value( "branch" ) ) ) + "/" + convertNullStr( rs_AddCard.value( "cardRef" ) );
    ResCard.CardNumber = convertNullStr( rs_AddCard.value( "cardNumber" ) );
    ResCard.Currency = RetKernelNatISO(convertNullStr( rs_AddCard.value( "currency" ) ));
    ResCard.Account = convertNullStr( rs_AddCard.value( "Account" ) );
    ResCard.AccountID = convertNullStr( rs_AddCard.value( "Referenc" ) );
    ResCard.PersonID = convertNullInt( rs_AddCard.value( "PersonId" ) );
    ResCard.PersonName = convertNullStr( rs_AddCard.value( "nameCardHolder" ) );
    ResCard.PSCode = convertNullStr( rs_AddCard.value( "paySysCode" ) );
    ResCard.TypeName = convertNullStr( rs_AddCard.value( "cardTypeName" ) );
    ResCard.StateCode = convertNullStr( rs_AddCard.value( "cardStateCode" ) );
    if ( convertNullStr( rs_AddCard.value( "isClose" ) ) == ""  )
      ResCard.IsClosed = false;
    else
      ResCard.IsClosed = true;
    end;
    ResCard.OpenDate = convertNullDate(  rs_AddCard.value( "cardOpenDate" ) );
    ResCard.IssueDate = convertNullDate( rs_AddCard.value( "cardRecDate" ) );
    ResCard.EndDate = convertNullDate( rs_AddCard.value( "cardMaturityDate" ) );
    ResCard.CloseDate = convertNullDate( rs_AddCard.value( "cardCloseDate" ) );

    retVal[retVal.size] = ResCard;
  end;

  return retVal;
end;

/**************************************************************************\
|               êÖäÇàáàíõ ÇçÖòçÖÉé èãÄíÖÜÄ(çÄ äÄêíì)                       |
\**************************************************************************/
macro CardIncData ( ExternalData )

  var retVal : TIncrementDetailsItem;
  var item = TIncrementDetailsItem;
  var isClosed = "";
  var sql;

  if ( (ValType(ExternalData.ID) != V_STRING) or (ValType(ExternalData.ObjectType) != V_INTEGER) or (ValType(ExternalData.IDType) != V_INTEGER) )
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  if ( (ExternalData.ID == "") )
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ( (ExternalData.IDType == 2) and ((ValType(ExternalData.Branch) != V_STRING) or (ExternalData.Branch == "")) )
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ((ExternalData.ObjectType != 554) and (ExternalData.ObjectType != 552))
    RunError( ErrMessage( 16520 ), 16520 );
  end;

  var searchById = false;
  var searchByNumber = false;
  if (ExternalData.IDType == 1)
    searchById = true;
  elif (ExternalData.IDType == 2)
    searchByNumber = true;
  else
    RunError( ErrMessage( 16531 ), 16531 );
  end;

  if ( searchById or searchByNumber )
   ;
  else
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var Card, rs_Card;
  if (ExternalData.ObjectType == 554)
    sql = "select crd.t_fncash branch, " +
                   "crd.t_cardref cardRef, " +
                   "crd.t_cardnumber cardNumber, " +
                   "decode( crd.t_cardopenclose, CHR (1), 'X', chr(0)) isClose " +
            "from dsccard_dbt crd";

    if ( searchById )
      sql = sql + " where crd.t_fncash = ? and crd.t_cardref = ?";
    else
      sql = sql + " where crd.t_cardnumber = ? and crd.t_fncash = (select t_code from ddp_dep_dbt where t_name = ?)";
    end;
    Card = RsdCommand( sql );
    if ( searchById )
      var ExtBranch = int(SubStr(ExternalData.ID, 1, StrBrk(ExternalData.ID,"/")));
      var ExtCardRef = int(SubStr(ExternalData.ID, StrBrk(ExternalData.ID,"/") + 1));
      Card.addParam( "p_Branch", RsdBp_In, ExtBranch );
      Card.addParam( "p_CardRef", RsdBp_In, ExtCardRef );
    else
      Card.addParam( "p_CardNumber", RsdBp_In,  ExternalData.ID );
      Card.addParam( "p_Branch", RsdBp_In, ExternalData.Branch );
    end;

    Card.nullConversion = true;
    Card.execute;
  end;
  if (ExternalData.ObjectType == 552)
    sql = "select crd.t_fncash branch, " +
                   "crd.t_cardref cardRef, " +
                   "crd.t_cardnumber cardNumber, " +
                   "decode( crd.t_cardopenclose, CHR (1), 'X', chr(0)) isClose " +
            "from dsccard_dbt crd, drt_contract_dbt con " +
            "where CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH AND CRD.T_CURRENTCNTRCARD = 'X' ";
    if ( searchById )
      sql = sql + " and CON.T_BRANCH = ? and CON.T_ID = ? and decode( crd.t_cardopenclose, CHR (1), 'X', chr(0)) = chr( 0 )";
    else
      sql = sql + " and CON.T_NUMBER = ? and CON.T_BRANCH = (select t_code from ddp_dep_dbt where t_name = ?) and decode( crd.t_cardopenclose, CHR (1), 'X', chr(0)) = chr( 0 ) ";
    end;
    Card = RsdCommand( sql );
    if ( searchById )
      var ConBranch = int(SubStr(ExternalData.ID, 1, StrBrk(ExternalData.ID,"/")));
      var ConCardID = int(SubStr(ExternalData.ID, StrBrk(ExternalData.ID,"/") + 1));
      Card.addParam( "p_Branch", RsdBp_In, ConBranch );
      Card.addParam( "p_ConCardID", RsdBp_In, ConCardID );
    else
      Card.addParam( "p_ConCardNumber", RsdBp_In,  ExternalData.ID );
      Card.addParam( "p_Branch", RsdBp_In, ExternalData.Branch );
    end;
    Card.nullConversion = true;
    Card.execute;
  end;

  rs_Card = RsdRecordset( Card );

  if ( not rs_Card.moveNext )
    if ( searchById )
      RunError( ErrMessage( 16505 ), 16505 );
    else
      RunError( ErrMessage( 16506 ), 16506 );
    end;
  else
    if ( rs_Card.moveNext )
      RunError( ErrMessage( 16508 ), 16508 );
    end;
  end;

  isClosed = convertNullStr( rs_Card.value( "isClose" ) );
  if ( isClosed == "X" )
    RunError( ErrMessage( 16510 ), 16510 );
  end;

  sql = "select dep.t_account depAccount, dep.t_code_currency, " +
               "prs.t_name nameCardHolder " +
        "from dsccard_dbt crd, " +
             "dsclink_dbt lnk, " +
             "ddepositr_dbt dep, " +
             "dparty_dbt prs " +
        "where lnk.t_fncash = crd.t_fncash and " +
              "lnk.t_cardref = crd.t_cardref and " +
              "lnk.t_cardaccref = dep.t_referenc and " +
              "lnk.t_acccardlinkopenclose = chr( 0 ) and " +
              "prs.t_partyid = crd.t_codclient and " +
              "crd.t_fncash = ? and " +
              "crd.t_cardref = ?";

  var CardAcc = RsdCommand( sql );

  CardAcc.addParam( "p_Branch", RsdBp_In, convertNullInt( rs_Card.value( "branch" ) ) );
  CardAcc.addParam( "p_CardRef", RsdBp_In, convertNullInt( rs_Card.value( "cardRef" ) ) );

  CardAcc.nullConversion = true;
  CardAcc.execute;

  var rs_CardAcc = RsdRecordset( CardAcc );

  if ( rs_CardAcc.moveNext )
    item.Account = convertNullStr( rs_CardAcc.value( "depAccount" ) );
    item.PersonName = convertNullStr( rs_CardAcc.value( "nameCardHolder" ) );
  else
    item.Account = "";
    item.PersonName = "";
  end;

  item.Ground = "èÆØÆ´≠•≠®• ™†‡‚Î #" + convertNullStr( rs_Card.value( "cardNumber" ) );

  /*var ourBank_BIC = Trim( getRegNumOurBank( I_PTCK_BIC ) );
  var ourBank_Name = "";
  var ourBank_CorrAcc = "";
  var ourBank_INN = "";
  var ourBank_KPP = "";
  var ourBankID = "";*/

  //iFindBank( 3 /*CODEKIND_BIC*/, ourBank_BIC, ourBank_Name, ourBank_CorrAcc, ourBank_INN, ourBank_KPP, ourBankID );


  /*item.BankID = ourBankID;
  item.BankCodeKind = 3;
  item.BankCode = ourBank_BIC;
  item.BankName = ourBank_Name;
  item.CorAccount = ourBank_CorrAcc;*/

  var isNationalCur;
  if (rs_CardAcc.value("T_CODE_CURRENCY") == 0)
    isNationalCur = true;
  else
    isNationalCur = false;
  end;
  fillBankInfo(rs_Card.value( "branch" ), isNationalCur, item);


  var codeDistrict = "";
  var district = "";

  sql = "select adr.t_codedistrict codeDistrict, " +
               "adr.t_district district " +
        "from dadress_dbt adr " +
        "where adr.t_partyid = ? and " +
              "adr.t_type = 1";

  var Distr = RsdCommand( sql );

  Distr.addParam( "p_PartyId", RsdBp_In, item.BankID );

  Distr.nullConversion = true;
  Distr.execute;

  var rs_Distr = RsdRecordset( Distr );

  if ( rs_Distr.moveNext )
    codeDistrict = convertNullStr( rs_Distr.value( "codeDistrict" ) );
    district = convertNullStr( rs_Distr.value( "district" ) );

    if ( codeDistrict != "" )
      item.BankName = item.BankName + "; " + codeDistrict;

      if ( district != "" )
        item.BankName = item.BankName + ". " + district;
      end;
    end;
  end;

  retVal = item;

  return retVal;
end;

/********************************************************************************\
|         èÖêÖÇéÑ ë äÄêíõ çÄ íÖäìôàâ ëóÖí äãàÖçíÄ (Ç éÑçéâ ÇÄãûíÖ)               |
\********************************************************************************/
macro ITransCA ( ExternalData )
  record r_sbdepdoc ("sbdepdoc.1");
  record r_operprm ("oper_prm.1");
  //record pmnt_prop("rtpaymentprop.dbt");
  var DestAccount, SourceAccount;

  checkRealSum(ExternalData.OperData.Sum.Sum);
  if ( (ValType(ExternalData.OperData.Client) != V_INTEGER) or (ExternalData.OperData.Client < 0) )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ValType(ExternalData.OperData.ExternalPayCode) != V_STRING) or (ExternalData.OperData.ExternalPayCode == "") )
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = true;
  var fndstat = findReissueAccount ( SourceAccount, ExternalData.OperData.Source, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16552; // ≠•™Æ‡‡•™‚≠Æ ß†ØÆ´≠•≠Î Ø†‡†¨•‚‡Î ®·‚ÆÁ≠®™†
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  if ( (ValType(ExternalData.OperData.Sum.Currency) == V_STRING) and (ExternalData.OperData.Sum.Currency != "") )
    checkCurrency( ExternalData.OperData.Sum.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16555 );
  end;
  ß†§†§®¨_Ø†‡†¨•‚‡Î_°†≠™† (SourceAccount);
  var findCurr = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  findParam.Currency = Int(findCurr.value("T_EXTERNALCODE"));
  findParam.IsFindMCD = true;
  findParam.FindOKCard = true;
  findParam.FindWithFncash = false;
  fndstat = findReissueAccount ( DestAccount, ExternalData.OperData.Destination, findParam );
  if (fndstat)
    if (fndstat == 16504)
      fndstat = 16553; // ≠•™Æ‡‡•™‚≠Æ ß†ØÆ´≠•≠Î Ø†‡†¨•‚‡Î ØÆ´„Á†‚•´Ô
    end;
    RunError( ErrMessage( fndstat ), fndstat );
  end;
  /*if ( DestAccount.value("T_CODE_CURRENCY") != SourceAccount.value("T_CODE_CURRENCY") )
    RunError( ErrMessage( 16528 ), 16528 );
  end;*/
  if ( (ValType(ExternalData.OperData.Sum.Currency) == V_STRING) and (ExternalData.OperData.Sum.Currency != "") )
    checkCurrency( ExternalData.OperData.Sum.Currency, DestAccount.value("T_CODE_CURRENCY"), 16557 );
  end;

  if ( (ValType(ExternalData.OperData.ComissionOut.Currency) == V_STRING) and (ExternalData.OperData.ComissionOut.Currency != "") )
    checkCurrency( ExternalData.OperData.ComissionOut.Currency, SourceAccount.value("T_CODE_CURRENCY"), 16558 );
  end;
  if ( (ValType(ExternalData.OperData.ComissionIn.Currency) == V_STRING) and (ExternalData.OperData.ComissionIn.Currency != "") )
    checkCurrency( ExternalData.OperData.ComissionIn.Currency, DestAccount.value("T_CODE_CURRENCY"), 16559 );
  end;

  var OpData : Operation;
  OpData.ExternalSystem = ExternalData.OperData.ExternalSystem;
  OpData.ExternalPayCode = ExternalData.OperData.ExternalPayCode;
  OpData.ComissionType = ExternalData.OperData.ComissionType;
  OpData.ComissionIn.Sum = ExternalData.OperData.ComissionIn.Sum;
  OpData.ComissionIn.Currency = RetRetailNatISO(ExternalData.OperData.ComissionIn.Currency);
  OpData.OperSubType = ExternalData.OperData.OperSubType;
  OpData.Account = DestAccount.value("T_REFERENC");

  á†ØÆ´≠•≠®•_ÉÄï( OpData );

  r_sbdepdoc.Referenc = DestAccount.value("T_REFERENC");
  r_sbdepdoc.NumDayDoc = 0;
  r_sbdepdoc.IsCur = DestAccount.value("T_ISCUR");
  r_sbdepdoc.FNCash = DestAccount.value("T_FNCASH");
  r_sbdepdoc.RealFNCash = NumRealFNCash();
  if (ExternalData.OperData.Client > 0)
    r_sbdepdoc.CodClient = ExternalData.OperData.Client;
  else
    r_sbdepdoc.CodClient = SourceAccount.value("T_CODCLIENT");
  end;
  r_sbdepdoc.Account = DestAccount.value("T_ACCOUNT");
  r_sbdepdoc.Code_Currency = DestAccount.value("T_CODE_CURRENCY");
  if ( (ValType(ExternalData.OperData.DateDocument) != V_DATE) or (ExternalData.OperData.DateDocument == Date(0,0,0)) )
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = {curdate};
  else
    r_sbdepdoc.Date_Document = {curdate};
    r_sbdepdoc.DepDate_Document = ExternalData.OperData.DateDocument;
  end;
  r_sbdepdoc.TypeOper = 71;
  if ( (ValType(ExternalData.OperData.OperSubType) != V_INTEGER) or (ExternalData.OperData.OperSubType < 0) )
      r_sbdepdoc.ApplType = 50;
  else
    r_sbdepdoc.ApplType = ExternalData.OperData.OperSubType;
  end;


  r_sbdepdoc.TypeComplexOper = 71;
  r_sbdepdoc.IsControl = StrFor(1);
  r_sbdepdoc.Author = StrFor(0);
  r_sbdepdoc.YesSbook = "X";
  r_sbdepdoc.Oper = {oper};
  r_sbdepdoc.VIDDOC = 0;
  r_sbdepdoc.KINDOP = 5;
  r_sbdepdoc.OBJECTPERC = 2001;
  if ( (ValType(ExternalData.OperData.Ground) == V_STRING) and (ExternalData.OperData.Ground != "") )
    r_sbdepdoc.Ground = ExternalData.OperData.Ground;
  else
    r_sbdepdoc.Ground = "è•‡•Á®·´•≠®• ·‡•§·‚¢ · ™†‡‚Î " + getCardNumberByAccRef(SourceAccount.value("T_REFERENC")) + ".";
    if ((ValType(ExternalData.AuthCode) == V_STRING) and (ExternalData.AuthCode != ""))
      r_sbdepdoc.Ground = r_sbdepdoc.Ground + " äÆ§ †¢‚Æ‡®ß†Ê®® " + ExternalData.AuthCode;
    end;
  end;
  r_sbdepdoc.InSum = ExternalData.OperData.Sum.Sum;
  r_sbdepdoc.iApplicationKind = 1;
  r_sbdepdoc.ApplicationKey = FormApplicationKey(1);

  r_operprm.Account = DestAccount.value("T_ACCOUNT");
  r_operprm.Type_Account = DestAccount.value("T_TYPE_ACCOUNT");
  r_operprm.Code_Currency = DestAccount.value("T_CODE_CURRENCY");
  r_operprm.Type_Oper = 71;
  r_operprm.Show_Panel = 0;
  r_operprm.UseMaxDate = 1;
  r_operprm.NoPrint = 1;
  r_operprm.TypeComplexOper = 71;

  /*var BankName, CorAccount, Bank_INN, Bank_KPP, BankID;
  iFindBank( PTCK_BIC, Trim( getRegNumOurBank( PTCK_BIC ) ), BankName, CorAccount, Bank_INN, Bank_KPP, BankID );
  var findBankAcc = rsdcommand("select * from dsb_acdep_dbt where T_ISCUR = :iscur and T_FNCASH = :branch and "
                               " T_CODCUR = :codcur and T_CONTMODE = 0 and T_SPECVARIABLE = :specval");
  findBankAcc.AddParam("iscur", RSDBP_IN, SourceAccount.value("T_ISCUR"));
  findBankAcc.AddParam("branch", RSDBP_IN, DestAccount.value("T_FNCASH"));
  findBankAcc.AddParam("codcur", RSDBP_IN, SourceAccount.value("T_CODE_CURRENCY"));
  findBankAcc.AddParam("specval", RSDBP_IN, V_ACCSPECNAME);
  findBankAcc.nullConversion = true;
  findBankAcc.execute();
  var rs_findBankAcc = RsdRecordset(findBankAcc);
  if ( not rs_findBankAcc.moveNext() )
    pmnt_prop.account = "";
  else
    pmnt_prop.account = rs_findBankAcc.value("t_account");
  end;

  pmnt_prop.bankcodekind = 3;
  pmnt_prop.BankCode = Trim( getRegNumOurBank( PTCK_BIC ) );
  pmnt_prop.BankName = BankName;
  pmnt_prop.PartyID = {OurBank};
  pmnt_prop.Branch = DestAccount.value("T_FNCASH");
  pmnt_prop.account_currcode = DestAccount.value("T_CODE_CURRENCY");
  if (ValType(ExternalData.AuthCode) != V_STRING)
    pmnt_prop.Ground = "è•‡•¢Æ§ · ™†‡‚Î ≠† ·Á•‚. äÆ§ †¢‚Æ‡®ß†Ê®®: 0";
  else
    pmnt_prop.Ground = "è•‡•¢Æ§ · ™†‡‚Î ≠† ·Á•‚. äÆ§ †¢‚Æ‡®ß†Ê®®: " + ExternalData.AuthCode;
  end;*/

  OpenDepFiles;
  var oldBatchMode = setbatchmode(true);
  AddStackGuard();
  var oldFnCash = NumFNcash();
  setFnCash(DestAccount.value("T_FNCASH"));
  var stat = ÇÎØÆ´≠•≠®•_éØ•‡†Ê®®(r_operprm, r_sbdepdoc/*, pmnt_prop*/);
  setFnCash(oldFnCash);
  setbatchmode(oldBatchMode);
  var errstackmes: string = "";
  var errstackerr: integer = GetErrorMessage(errstackmes);
  RemoveStackGuard();
  if (stat > 0)
    if ( errstackmes != "" )
      errstackmes = SubStr( (ErrMessage( stat ) + "|" + StrSubst (errstackmes , ErrMessage( stat ), "")), 1 , 241 );
      RunError( errstackmes , stat );
    else
    RunError( ErrMessage( stat ), stat );
  end;
  end;

  OpData.ComissionIn.Sum = RetrieveValue("Operation:ë„¨¨†@äÆ¨®··®Ô");
  OpData.ComissionIn.Currency = RetrieveValue("Operation:Ç†´Ó‚†@äÆ¨®··®Ô");
  OpData.OperSubType = RetrieveValue("Operation:Ç®§ëØ®·†≠®Ô@äÆ¨®··®Ô");
  OpData.Account = RetrieveValue("Operation:ëÁ•‚@äÆ¨®··®Ô");

  InterDesk_EndDocBunch();

  var retVal : TOperationResult ;
  retVal.OperationID = r_operprm.ApplicationKey;
  retVal.OperDate = r_operprm.Date_Document;
  var rs_Cur = FindCurrency(FINDCURBYCODE_CUR, SourceAccount.value("T_CODE_CURRENCY"));
  retVal.SumOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.SumIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionIn.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.ComissionOut.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));

  retVal.ComissionIn.Sum =  OpData.ComissionIn.Sum;
  retVal.SumIn.Sum = ExternalData.OperData.Sum.Sum - retVal.ComissionIn.Sum;
  retVal.SumOut.Sum = ExternalData.OperData.Sum.Sum;
  retVal.ComissionOut.Sum = $0L;

  retVal.Rate.Kind = 1;
  retVal.Rate.BaseSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.BaseSum.Sum = $1;
  retVal.Rate.WorkSum.Currency = RetKernelNatISO(rs_Cur.value("T_EXTERNALCODE"));
  retVal.Rate.WorkSum.Sum = $1;

  var findDocID = rsdcommand("select * from drtdocument_dbt where T_OPAPPLICATIONKEY = :appkey and T_OPAPPLICATIONKIND = :appkind");
  findDocID.AddParam("appkey", RSDBP_IN, r_operprm.ApplicationKey);
  findDocID.AddParam("appkind", RSDBP_IN, r_operprm.ApplicationKind);
  findDocID.nullConversion = true;
  findDocID.execute();
  var rs_findDocID = RsdRecordset(findDocID);
  while ( rs_findDocID.moveNext() )
    retVal.DocumentIDs[retVal.DocumentIDs.size] = rs_findDocID.value("T_DOCUMENTID");
  end;

  return retVal;
end;

/**************************************************************************\
|                            ÇõèàëäÄ èé äÄêíÖ                              |
\**************************************************************************/
macro CardOperDetail ( ExternalData )
  var Account;
  var CardDetail = TCODRes;
  var NumQuantity = 0;
  var MainCardRef = 0, findMainCard, rs_findMainCard;
  if ( (ValType(ExternalData.Card.ID) != V_STRING) or (ValType(ExternalData.Card.ObjectType) != V_INTEGER) or (ValType(ExternalData.Card.IDType) != V_INTEGER) )
    RunError( ErrMessage( 16504 ), 16504 );
  end;
  if ( (ExternalData.Card.ID == "") )
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ( (ExternalData.Card.IDType == 2) and ((ValType(ExternalData.Card.Branch) != V_STRING) or (ExternalData.Card.Branch == "")) )
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ((ExternalData.Card.ObjectType != 554) and (ExternalData.Card.ObjectType != 552))
    RunError( ErrMessage( 16520 ), 16520 );
  end;
  if ( ValType(ExternalData.TypeInfo) != V_INTEGER )
    RunError( ErrMessage( 16504 ), 16504 );
  elif ( (ExternalData.TypeInfo < 0) or (ExternalData.TypeInfo > 1) )
    RunError( ErrMessage( 16509 ), 16509 );
  end;

  var searchById = false;
  var searchByNumber = false;
  if (ExternalData.Card.IDType == 1)
    searchById = true;
  elif (ExternalData.Card.IDType == 2)
    searchByNumber = true;
  else
    RunError( ErrMessage( 16531 ), 16531 );
  end;

  if ( searchById or searchByNumber )
   ;
  else
    RunError( ErrMessage( 16504 ), 16504 );
  end;

  var sql = "", Card, rs_Card;
  if (ExternalData.Card.ObjectType == 554)
    sql = "select crd.t_fncash branch, " +
                   "crd.t_cardref cardRef, " +
                   "crd.t_cardnumber cardNumber, " +
                   "crd.t_contractid conId " +
            "from dsccard_dbt crd";

    if ( searchById )
      sql = sql + " where crd.t_fncash = ? and crd.t_cardref = ?";
    else
      sql = sql + " where crd.t_cardnumber = ? and crd.t_fncash = (select t_code from ddp_dep_dbt where t_name = ?)";
    end;
    Card = RsdCommand( sql );
    if ( searchById )
      var ExtBranch = int(SubStr(ExternalData.Card.ID, 1, StrBrk(ExternalData.Card.ID,"/")));
      var ExtCardRef = int(SubStr(ExternalData.Card.ID, StrBrk(ExternalData.Card.ID,"/") + 1));
      Card.addParam( "p_Branch", RsdBp_In, ExtBranch );
      Card.addParam( "p_CardRef", RsdBp_In, ExtCardRef );
    else
      Card.addParam( "p_CardNumber", RsdBp_In,  ExternalData.Card.ID );
      Card.addParam( "p_Branch", RsdBp_In, ExternalData.Card.Branch );
    end;

    Card.nullConversion = true;
    Card.execute;
  end;
  if (ExternalData.Card.ObjectType == 552)
    sql = "select crd.t_fncash branch, " +
                   "crd.t_cardref cardRef, " +
                   "crd.t_cardnumber cardNumber, " +
                   "crd.t_contractid conId " +
            "from dsccard_dbt crd, drt_contract_dbt con " +
            "where CRD.T_CURRENTCNTRCARD = 'X' AND CRD.T_CONTRACTID = CON.T_ID AND CRD.T_FNCASH = CON.T_BRANCH ";
    if ( searchById )
      sql = sql + " and CON.T_BRANCH = ? and CON.T_ID = ? ";
    else
      sql = sql + " and CON.T_NUMBER = ? and CON.T_BRANCH = (select t_code from ddp_dep_dbt where t_name = ?) ";
    end;
    Card = RsdCommand( sql );
    if ( searchById )
      var ConBranch = int(SubStr(ExternalData.Card.ID, 1, StrBrk(ExternalData.Card.ID,"/")));
      var ConCardID = int(SubStr(ExternalData.Card.ID, StrBrk(ExternalData.Card.ID,"/") + 1));
      Card.addParam( "p_Branch", RsdBp_In, ConBranch );
      Card.addParam( "p_ConCardID", RsdBp_In, ConCardID );
    else
      Card.addParam( "p_ConCardNumber", RsdBp_In,  ExternalData.Card.ID );
      Card.addParam( "p_Branch", RsdBp_In, ExternalData.Card.Branch );
    end;
    Card.nullConversion = true;
    Card.execute;
  end;

  rs_Card = RsdRecordset( Card );

  if ( not rs_Card.moveNext )
    if ( searchById )
      RunError( ErrMessage( 16505 ), 16505 );
    else
      RunError( ErrMessage( 16506 ), 16506 );
    end;
  else
    if ( rs_Card.moveNext )
      RunError( ErrMessage( 16508 ), 16508 );
    end;
  end;

  sql = "SELECT CNTR.T_MAINCARDCNTRID MAINCARDCNTRID, DECODE (CNTR.T_ADDCARDOWNACC, CHR (0), '', 'X') isSubAcc " +
        " FROM drtcardcontract_dbt cntr " +
        "WHERE CNTR.T_BRANCH = ? AND CNTR.T_ID = ?";

  var IsNotMain = RsdCommand( sql );

  IsNotMain.addParam( "p_Branch", RsdBp_In, convertNullInt(rs_Card.value("branch")) );
  IsNotMain.addParam( "p_CntrId", RsdBp_In, convertNullInt(rs_Card.value("conId")) );
  IsNotMain.nullConversion = true;
  IsNotMain.execute;
  var rs_IsNotMain = RsdRecordset( IsNotMain );

  sql = " SELECT CL.T_APPLICATIONKEY1 OpAppKey, " +
        " CL.T_APPLICATIONKIND1 OpAppKind, " +
        " DOC.T_REFERENC Referenc, " +
        " DOC.T_TYPE_ACCOUNT Kind, " +
        " DOC.T_ISCUR isCur, " +
        " crddoc.T_DATE OperDate, " +
        " crddoc.T_NUMDAYDOC numDoc, " +
        " DOC.T_INSUM CreditSum, " +
        " DOC.T_OUTSUM DebitSum, " +
        " DOC.T_REST RestSum, " +
        " DOC.T_GROUND Ground, " +
        " DOC.T_TYPEOPER TypeOper, " +
        " DOC.T_APPLTYPE OperSubType, " +
        " DOC.T_IAPPLICATIONKIND appkind, " +
        " DOC.T_APPLICATIONKEY appkey, " +
        " CRDDOC.T_ADDCARDREF addcardref, " +
        " CRDDOC.T_AUTHREF authref, " +
        " CRDDOC.T_INSUM  sCreditSum, " +
        " CRDDOC.T_OUTSUM sDebitSum, " +
        " CRDDOC.T_REST    subrest  " +
        " FROM dsccrddoc_dbt crddoc, dsbdepdoc_dbt doc, dsb_casln_dbt cl, dsclink_dbt sclink " +
        " WHERE     DOC.T_APPLICATIONKEY = CRDDOC.T_DEPDOCAPPKEY " +
        " AND DOC.T_IAPPLICATIONKIND = CRDDOC.T_DEPDOCAPPKIND " +
        " AND CL.T_APPLICATIONKIND2 = DOC.T_IAPPLICATIONKIND " +
        " AND CL.T_APPLICATIONKEY2 = DOC.T_APPLICATIONKEY " +
        " AND CL.T_REFVALUE2 = 0 " +
        " AND CRDDOC.T_ACCCARDLINKREF = SCLINK.T_ACCCARDLINKREF " +
        " AND CRDDOC.T_FNCASH = SCLINK.T_FNCASH " +
        " AND CRDDOC.T_DATE BETWEEN ? AND ? " +
        " AND SCLINK.T_ACCCARDLINKOPENCLOSE = CHR(0) " +
        " AND SCLINK.T_FNCASH = ? ";
  
  if ( rs_IsNotMain.moveNext )
    if ( convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) == 0 )
        if   ((ValType(ExternalData.ShowAuxCard) == V_BOOL) and (ExternalData.ShowAuxCard == false))

        sql = sql + " AND SCLINK.T_CARDREF = ? ";

        elif ((ValType(ExternalData.ShowAuxCard) != V_BOOL) or (ExternalData.ShowAuxCard == true))

        sql = sql + " AND SCLINK.T_CARDREF = ? " +
                    " UNION ALL " +
                    " SELECT CL.T_APPLICATIONKEY1 OpAppKey, " +
                    " CL.T_APPLICATIONKIND1 OpAppKind, " +
                    " DOC.T_REFERENC Referenc, " +
                    " DOC.T_TYPE_ACCOUNT Kind, " +
                    " DOC.T_ISCUR isCur, " +
                    " crddoc.T_DATE OperDate, " +
                    " crddoc.T_NUMDAYDOC numDoc, " +
                    " DOC.T_INSUM CreditSum, " +
                    " DOC.T_OUTSUM DebitSum, " +
                    " DOC.T_REST RestSum, " +
                    " DOC.T_GROUND Ground, " +
                    " DOC.T_TYPEOPER TypeOper, " +
                    " DOC.T_APPLTYPE OperSubType, " +
                    " DOC.T_IAPPLICATIONKIND appkind, " +
                    " DOC.T_APPLICATIONKEY appkey, " +
                    " CRDDOC.T_ADDCARDREF addcardref, " +
                    " CRDDOC.T_AUTHREF authref, " +
                    " CRDDOC.T_INSUM  sCreditSum, " +
                    " CRDDOC.T_OUTSUM sDebitSum, " +

                    " CRDDOC.T_REST    subrest  " +
                    " FROM dsccrddoc_dbt crddoc, dsbdepdoc_dbt doc, dsb_casln_dbt cl, dsclink_dbt sclink, drtcardcontract_dbt cntr, dsccard_dbt crd " +
                    " WHERE DOC.T_APPLICATIONKEY = CRDDOC.T_DEPDOCAPPKEY " +
                    " AND DOC.T_IAPPLICATIONKIND = CRDDOC.T_DEPDOCAPPKIND " +
                    " AND CL.T_APPLICATIONKIND2 = DOC.T_IAPPLICATIONKIND " +
                    " AND CL.T_APPLICATIONKEY2 = DOC.T_APPLICATIONKEY " +
                    " AND CL.T_REFVALUE2 = 0 " +
                    " AND CRDDOC.T_ACCCARDLINKREF = SCLINK.T_ACCCARDLINKREF " +
                    " AND CRDDOC.T_FNCASH = SCLINK.T_FNCASH " +
                    " AND CNTR.T_ADDCARDOWNACC = 'X' " +
                    " AND CRD.T_FNCASH = CNTR.T_BRANCH " +
                    " AND CRD.T_CONTRACTID = CNTR.T_ID " +
                    " AND CRD.T_CURRENTCNTRCARD = 'X' " +
                    " AND SCLINK.T_CARDREF = CRD.T_CARDREF " +
                    " AND SCLINK.T_FNCASH = CNTR.T_BRANCH " +
                    " AND SCLINK.T_ACCCARDLINKOPENCLOSE = CHR(0) " +
                    " AND CRDDOC.T_DATE BETWEEN ? AND ? " +
                    " AND CNTR.T_MAINCARDCNTRID = ? " +
                    " AND CNTR.T_BRANCH = ? ";
      end;
    elif ( convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) > 0 )
      if ( convertNullStr( rs_IsNotMain.value( "isSubAcc" ) ) == "X" )
        sql = sql + " AND SCLINK.T_CARDREF = ? ";
      else
        sql = sql + " AND SCLINK.T_CARDREF = ? AND CRDDOC.T_ADDCARDREF = ? ";
      end;
    end;
  end;

  sql = sql + " ORDER BY 3,6,7,17 "; //DOC.T_REFERENC,CRDDOC.T_DATE,crddoc.T_NUMDAYDOC,CRDDOC.T_AUTHREF

  if ( convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) > 0 )
    findMainCard = rsdcommand("select * from dsccard_dbt crd where crd.t_fncash = ? and crd.T_CONTRACTID = ? ");
    findMainCard.addParam( "fncash", RsdBp_In, convertNullInt(rs_Card.value("branch")));
    findMainCard.addParam( "contractId", RsdBp_In, convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) );
    findMainCard.nullConversion = true;
    findMainCard.execute;
    rs_findMainCard = RsdRecordset( findMainCard );
    if (rs_findMainCard.MoveNext)
      MainCardRef = convertNullInt( rs_findMainCard.value( "T_CARDREF" ) );
    else
      MainCardRef = 0;
    end;
  else
    MainCardRef = convertNullInt(rs_Card.value("cardRef"));
  end;
  var stat;
  var findParam : FindObjParm;
  findParam.Currency = null;
  findParam.IsFindMCD = false;
  findParam.FindOKCard = false;
  findParam.FindWithFncash = true;
  if ( convertNullStr( rs_IsNotMain.value( "isSubAcc" ) ) == "X" )
    stat = findOpenAccount ( Account, ExternalData.Card, findParam );
    if ( (stat>0) and (stat != 16512) and (stat != 16505) and (stat != 16529) )
      RunError( ErrMessage( stat ), stat );
    end;
  else
    var MainCard = TObjectID;
    MainCard.ObjectType = 554;
    MainCard.IDType = 1;
    MainCard.ID = string ( convertNullInt(rs_Card.value("branch")) ) + "/" + string ( MainCardRef );
    stat = findOpenAccount ( Account, MainCard, findParam );
    if ( (stat>0) and (stat != 16512) and (stat != 16505) and (stat != 16529) )
      RunError( ErrMessage( stat ), stat );
    end;
  end;

  
  var isQuantity = true, Quantity = 0;
  if ( (ValType(ExternalData.Quantity) != V_INTEGER) or (ExternalData.Quantity <= 0) )
    isQuantity = false;
  else
    Quantity = ExternalData.Quantity;
  end;

  var StartDate,EndDate;
  if ( ValType(ExternalData.EndDate) != V_DATE )
    if ( (convertNullDate(Account.value("T_CLOSE_DATE")) != Date(0,0,0)) )
      EndDate = min ({curdate},convertNullDate(Account.value("T_CLOSE_DATE")));
    else
      EndDate = {curdate};
    end
  else
    EndDate = ExternalData.EndDate;
  end;
  if ( ValType(ExternalData.BeginDate) != V_DATE ) 
    StartDate = max(convertNullDate(Account.value("T_OPEN_DATE")), DateAfterWorkMonths( EndDate, -1 ));
  else
    StartDate = ExternalData.BeginDate;
  end;
  
  
  CardDetail.BeginDate = StartDate;
  CardDetail.EndDate = EndDate;
  var CardAccCur = FindCurrency(FINDCURBYCODE_CUR, convertNullInt(Account.value("T_CODE_CURRENCY")));
  CardDetail.Currency = RetKernelNatISO(convertNullStr( CardAccCur.value("T_EXTERNALCODE") ));

  var sclinkCmd = RsdCommand(
      "select case t_MainSubAccLinkRef when 0 then t_acccardlinkref else t_MainSubAccLinkRef end linkRef "
      "from dsclink_dbt "
      "where T_FNCASH = ? "
      "  and T_CARDREF = ? "
      "  and T_ACCCARDLINKOPENCLOSE = chr(0) "
  );
  sclinkCmd.addParam("fncash", RsdBp_In, convertNullInt(rs_Card.value("branch")));
  sclinkCmd.addParam("CARDREF", RsdBp_In, convertNullInt(rs_Card.value("cardRef")));
  sclinkCmd.nullConversion = true;
  sclinkCmd.execute();
  var rs_sclink = RsdRecordset(sclinkCmd);
  if (rs_sclink.MoveNext())
    CardDetail.RestOut = GetCardSubAccRest (convertNullInt( rs_Card.value( "branch" ) ), rs_sclink.value("linkRef"), EndDate);
  end;

  var sqllastOpDate = "SELECT * FROM dsbdepdoc_dbt doc WHERE DOC.T_DATE_DOCUMENT < ? AND DOC.T_REFERENC = ? ORDER BY DOC.T_DATE_DOCUMENT DESC";
  var lastOpDate = rsdcommand(sqllastOpDate);
  lastOpDate.addParam( "beginDate", RsdBp_In, StartDate);
  lastOpDate.addParam( "Referenc", RsdBp_In, convertNullInt( Account.value( "T_REFERENC" ) ) );
  lastOpDate.nullConversion = true;
  lastOpDate.execute;
  var rs_lastOpDate = RsdRecordset(lastOpDate);
  if (rs_lastOpDate.moveNext)
    CardDetail.LastOperDate = convertNullDate(rs_lastOpDate.value("T_DATE_DOCUMENT"));
    CardDetail.RestIn = GetCardSubAccRest (convertNullInt( rs_Card.value( "branch" ) ), convertNullInt( rs_Card.value( "cardRef" ) ), convertNullDate(rs_lastOpDate.value("T_DATE_DOCUMENT")) );
  else
    CardDetail.LastOperDate = Date(0,0,0);
    CardDetail.RestIn = $0;
  end;

  var Detail = rsdcommand (sql);
  Detail.addParam( "beginDate", RsdBp_In, StartDate);
  Detail.addParam( "endDate", RsdBp_In, EndDate);
  Detail.addParam( "p_Branch", RsdBp_In, convertNullInt( rs_Card.value( "branch" ) ) );
  if ( convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) == 0 )
    if ( (ValType(ExternalData.ShowAuxCard) == V_BOOL) and (ExternalData.ShowAuxCard == false) )
      Detail.addParam( "cardLinkRef", RsdBp_In, convertNullInt( rs_Card.value( "cardRef" ) ) ) ;
    elif ( (ValType(ExternalData.ShowAuxCard) != V_BOOL) or (ExternalData.ShowAuxCard == true) )
      Detail.addParam( "cardLinkRef", RsdBp_In, convertNullInt( rs_Card.value( "cardRef" ) ) ) ;
      Detail.addParam( "beginDate1", RsdBp_In, StartDate);
      Detail.addParam( "endDate1", RsdBp_In, EndDate);
      Detail.addParam( "MainCardId", RsdBp_In, convertNullInt( rs_Card.value( "conId" ) ) ) ;
      Detail.addParam( "p_Branch1", RsdBp_In, convertNullInt( rs_Card.value( "branch" ) ) );
    end;  
  elif ( convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) > 0 )
    if ( convertNullStr( rs_IsNotMain.value( "isSubAcc" ) ) == "X" )
      Detail.addParam( "cardLinkRef", RsdBp_In, convertNullInt( rs_Card.value( "cardRef" ) ) ) ;
    else
      Detail.addParam( "cardLinkRef", RsdBp_In, MainCardRef ) ;
      Detail.addParam( "cardRef", RsdBp_In, convertNullInt( rs_Card.value( "cardRef" ) ) );
    end;
  end;
  Detail.nullConversion = true;
  Detail.execute;
  var rs_Detail  = RsdRecordSet(Detail, null, RSDVAL_STATIC);
  while ( (rs_Detail.moveNext) and 
     ( ( (isQuantity) and ( (NumQuantity < Quantity) or ( (CardDetail.Operations.size >= 1) and 
            ( CardDetail.Operations[CardDetail.Operations.size-1].OperDate == convertNullDate(rs_Detail.value("OperDate")) ) ) ) ) or 
            ( not isQuantity ) ) )
    var Operations = TCardOperationData;
    Operations.OperDate = convertNullDate(rs_Detail.value("OperDate"));
    Operations.NDoc = convertNullInt(rs_Detail.value("numDoc"));
    Operations.RestIn = rs_Detail.value("subrest") - rs_Detail.value("CreditSum") + rs_Detail.value("DebitSum");
    
    if (rs_Detail.value("CreditSum") < rs_Detail.value("DebitSum"))
      Operations.TypeOper = "-";
    elif (rs_Detail.value("CreditSum") > rs_Detail.value("DebitSum"))
      Operations.TypeOper = "+";
    else
      Operations.TypeOper = "";
    end;
    
    Operations.Sum = abs(rs_Detail.value("CreditSum") - rs_Detail.value("DebitSum"));
    Operations.RestOut = rs_Detail.value("subrest");
    Operations.OperationID = convertNullStr(rs_Detail.value("OpAppKey"));
    Operations.Ground = convertNullStr(rs_Detail.value("Ground"));
    
    if ( ExternalData.TypeInfo == 1 )
      var expendParam = " SELECT OP.T_CZNAMEALG OperName, OP.T_NUMOPERT NumOper " + 
                        " FROM dsb_typop_dbt op, dsbdepdoc_dbt doc " +
                        " WHERE OP.T_KIND = DOC.T_TYPE_ACCOUNT AND OP.T_NUMOPERT = DOC.T_TYPEOPER AND OP.T_ISCUR = DOC.T_ISCUR " +
                        " AND DOC.T_APPLICATIONKEY = ? AND DOC.T_IAPPLICATIONKIND = ? ";
      var findexpendParam = rsdcommand(expendParam);
      findexpendParam.AddParam("appKey", RSDBP_IN, convertNullStr(rs_Detail.value("AppKey")));
      findexpendParam.AddParam("appKind", RSDBP_IN, convertNullInt(rs_Detail.value("AppKind")));
      findexpendParam.nullConversion = true;
      findexpendParam.execute;
      var rs_findexpendParam = RsdRecordset(findexpendParam);
      if ( rs_findexpendParam.moveNext )
        Operations.OperName = convertNullStr(rs_findexpendParam.value("OperName"));
        Operations.OperType = convertNullInt(rs_findexpendParam.value("NumOper"));
      else
        Operations.OperName = "";
        Operations.OperType = 0;
      end;

      expendParam = " SELECT SUBOP.T_NAME SubopName, SUBOP.T_TYPE SubopNum " + 
                        " FROM dsuboper_dbt subop, dsbdepdoc_dbt doc " +
                        " WHERE SUBOP.T_KIND = DOC.T_TYPE_ACCOUNT AND SUBOP.T_OPERTYPE = DOC.T_TYPEOPER " +
                        " AND SUBOP.T_ISCUR = DOC.T_ISCUR AND SUBOP.T_TYPE = DOC.T_APPLTYPE " +
                        " AND DOC.T_APPLICATIONKEY = ? AND DOC.T_IAPPLICATIONKIND = ? ";
      findexpendParam = rsdcommand(expendParam);
      findexpendParam.AddParam("appKey", RSDBP_IN, convertNullStr(rs_Detail.value("AppKey")));
      findexpendParam.AddParam("appKind", RSDBP_IN, convertNullInt(rs_Detail.value("AppKind")));
      findexpendParam.nullConversion = true;
      findexpendParam.execute;
      rs_findexpendParam = RsdRecordset(findexpendParam);
      if ( rs_findexpendParam.moveNext )
        Operations.OperSubName = convertNullStr(rs_findexpendParam.value("SubopName"));
        Operations.OperSubType = convertNullInt(rs_findexpendParam.value("SubopNum"));
      else
        Operations.OperSubName = "";
        Operations.OperSubType = 0;
      end;

    end;
    if ( (ValType(ExternalData.ShowAuxCard) != V_BOOL) or (ExternalData.ShowAuxCard == true ) )
      if ( convertNullInt(rs_Detail.value("addcardref")) > 0 )
        expendParam = " SELECT CARD.T_CARDNUMBER CardNum FROM dsccard_dbt card WHERE CARD.T_FNCASH = ? AND CARD.T_CARDREF = ? ";
        findexpendParam = rsdcommand(expendParam);
        findexpendParam.AddParam( "branch", RSDBP_IN, convertNullInt( rs_Card.value( "branch" ) ) );
        findexpendParam.AddParam("cardRef", RSDBP_IN, convertNullInt(rs_Detail.value("addcardref")) );
        findexpendParam.nullConversion = true;
        findexpendParam.execute;
        rs_findexpendParam = RsdRecordset(findexpendParam);
        if ( rs_findexpendParam.moveNext )
          Operations.Number = convertNullStr(rs_findexpendParam.value("CardNum"));
        else
          Operations.Number = "";
        end;
      else
        Operations.Number = convertNullStr(rs_Card.value("cardNumber"));
      end;
    else
      if ( convertNullInt( rs_IsNotMain.value( "MAINCARDCNTRID" ) ) == 0 )
        Operations.Number = convertNullStr(rs_Card.value("cardNumber"));
      end;
    end;
    NumQuantity = NumQuantity + 1;
    CardDetail.Operations[CardDetail.Operations.size] = Operations;
  end;
  return CardDetail;
end; 

