import "sp_car.mac", "scservop.mac";

var FIIDDebet, FIIDCredit, Sum, FiRoleCred, FiRoleDeb, Ground, CatDeb, CatCred, DebAccNumber = "", CredAccNumber = "", FD,
    Group, Bpp = false, GroupBank;
var debug = false; //true;

Import cb_sql;

  var AccBirgRub = TRecHandler("account");
  var AccBirgUSD = TRecHandler("account");
  var AccBirgEUR = TRecHandler("account");
  var AccBirg = TRecHandler("account");


Private Macro  GetBirgAccount(currency) 
var sql, cmd, Birgacc = "";
  var AccBuf = TRecHandler("account");
  AccBuf.Clear();

sql = "select * from dmcaccdoc_DBT where t_catnum = 214 and t_iscommon = 'X' and t_currency = " + currency + "  and t_marketplaceofficeid = 2";
cmd = TrsbDataSet(sql);
If(cmd.movenext())
   Birgacc = cmd.t_account;
else

end;
GetAccount( 1, currency, Birgacc, AccBuf, false );
return AccBuf;

End;
var ExcelApp;

//ExcelApp = ActiveX("Excel.Application", null, true);

var startAX = CreateObject("rsax", "TRsAxServer", "FmAxServer", isStandalone());
ExcelApp = startAX.CreateComObject("Excel.Application");
//var file_name ="d:\\RSHB_SOFR_TEST\\IMPORT\\Проводки_13_02_2020.xls";
//var file_name ="d:\\RSHB_SOFR_TEST\\IMPORT\\Книга1.xlsx";
var file_name ="C:\\SOFR\\IMPORT\\Книга1.xlsx";  
var ExcelDoc = ExcelApp.Workbooks.Open(file_name);
    ExcelDoc.Sheets(1).Activate();
var ActiveSheet = ExcelApp.ActiveSheet;
var row_cnt = ActiveSheet.UsedRange.Rows.Count;
var ind = 1;

Var Amount = 0, Portf = 0, Summa = $0, StrCatDeb = "", StrCatCred = "", DocNum = "", tr;
const bonusdate = date(31,12,2019);
const convdate = date(31,12,2019);


AccBirgRub = GetBirgAccount(0);
AccBirgUSD = GetBirgAccount(7);
AccBirgEUR = GetBirgAccount(8);


while ( ind <= row_cnt )
            StrCatDeb = "";
            StrCatCred = "";
            CatCred= "";
            CatDeb= "";
	    If(valtype(ActiveSheet.Cells(ind, 1).Value) == v_undef)
	       ind = ind + 1;
               continue;
	    end;

	    If(ActiveSheet.Cells(ind, 2).Value == "Д-т")
	       ind = ind + 1;
               continue;
	    end;

            DocNum = string(int(ActiveSheet.Cells(ind, 1).Value)); 

             Summa = money(ActiveSheet.Cells(ind, 4).Value);

	     CatDeb = string(ActiveSheet.Cells(ind, 2).Value);
	     CatCred = string(ActiveSheet.Cells(ind, 3).Value);
             Sum = abs(Summa);
             Ground = string(ActiveSheet.Cells(ind, 5).Value);


                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                 tr.Chapter         = 1;
                 tr.Date_Carry      = {Curdate};
                 tr.Numb_Document   = string(DocNum);
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = " 1";
                 tr.Ground          = Ground;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = 0;
                 tr.FIIDReceiver    = 0;
                 tr.AccountPayer    = CatDeb;
                 tr.AccountReceiver = CatCred;
                 tr.SumPayer      = ABS(Sum);
                 tr.SumReceiver   = ABS(Sum); 

                 tr.Userfield2    = "1";
   
                 if( not tr.Carry() )
                     return Msgbox("Ошибка при выполнении проводки");
                 end;
                 println(CatDeb, "|", CatCred, "|", Sum); 


                ind = ind + 1;

end;