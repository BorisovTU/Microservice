/*
  $Name:             pmpartatReport.mac
  $Module:           €Œ ¯®§¨æ¨®­¥à 
  $Description:      âç¥â ¯à®æ¥¤ãàë ç áâ¨ç­®£® ¨á¯®«­¥­¨ï ¯« â¥¦ 
*/

import oralib, likepy, MesInter, OprInter, PTInter, PaymInter;

RECORD oprstep_rec( oprstep );

private macro PrintSuccessfulRecords( rs:RsdRecordset )

  var isNext = rs and rs.MoveNext();
  
  if( isNext )
  [ 
     ‘ä®à¬¨à®¢ ­ë ¯« â¥¦¨:
      ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³  ID  ³  ID  ³         ‚¨¤ ¤®ªã¬¥­â        ³     ®¬¥à     ³         ‘ã¬¬       ³         ‘â âãá       ³
      ³§ ¯¨á¨³ ¯« â.³                             ³               ³                    ³                      ³
      ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ];
  
  while( isNext )
    [   ³######³######³#############################³###############³####################³######################³]
    (
      rs.value("okID"),
      rs.value("pID"),
      rs.value("pDocKInd"),
      rs.value("pNumber") : r,
      money(rs.value("pAmount")),
      rs.value("State") : w
    );
    
    isNext = rs and rs.MoveNext();
      
    if( isNext )
      [   ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
    end;
    
    end;
    
    [   ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];  
  end;

end;

private macro PrintUnsuccessfulRecords( rs:RsdRecordset )
  
  var isNext = rs and rs.MoveNext();
  
  if( isNext )
  [ 
     ‡ ¯¨á¨, ®¡à ¡®â ­­ë¥ á ®è¨¡ª ¬¨:    
      ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³  ID  ³                                        è¨¡ª                                                   ³
      ³      ³                                                                                                ³
      ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ];
  
  while( isNext )
    [   ³######³################################################################################################³]
    (
      rs.value("okID"),
      rs.value("Description") : w
    );
    
    isNext = rs and rs.MoveNext();
      
    if( isNext )
      [   ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
    end;
    
    end;
    
    [   ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];  
  end;

end;

macro PrintOnePaymentReport( paymentID : integer )
  
  var payment = RsbPayment( paymentID );
 
  if( payment )
    [--¡à ¡®â ­ ¯« â¥¦----------------------------------------------------------------------------------------------------------------------------------------------
       ID: ################
       ®¬¥à: ################
       „ â : ################
       ‘ã¬¬ : ################
       ¥®¯« ç¥­­ë© ®áâ â®ª: ###################]
    (
      payment.paymentID : l,
      payment.Number : l,
      payment.Date : l,
      payment.BaseAmount : l,
      payment.FutureBaseAmount : l
    );

    var query =     
              "  SELECT pmpartat.t_ID              \"okID\", " +
              "         pmpartat.t_CreatePaymentID \"pID\", " +
              "         NVL(oprkdoc.t_Name, 0)     \"pDocKInd\", " +
              "         NVL(createdPmRmProp.t_Number, CHR(1)) \"pNumber\", " +
              "         NVL(createdPmPaym.t_Amount, 0) \"pAmount\", " +
              "         NVL(pmstatus.t_Name, CHR(1)) \"State\" , " +
              "         pmpartat.t_Description     \"Description\" " +
              "    FROM dpmpartat_dbt pmpartat " +
              "         LEFT OUTER JOIN doprkdoc_dbt oprkdoc " +
              "            ON oprkdoc.t_DocKind = pmpartat.t_DocKind " +
              "         LEFT OUTER JOIN dpmpaym_dbt createdPmPaym " +
              "            ON createdPmPaym.t_PaymentID = pmpartat.t_CreatePaymentID " +
              "         LEFT OUTER JOIN dpmrmprop_dbt createdPmRmProp " +
              "            ON createdPmRmProp.t_PaymentID = pmpartat.t_CreatePaymentID " +
              "         LEFT OUTER JOIN dpmstatus_dbt pmstatus " +
              "            ON     pmstatus.t_PaymStatus = createdPmPaym.t_PaymStatus " +
              "               AND pmstatus.t_Type = 0 "
              "   WHERE pmpartat.t_ID IN ( SELECT * FROM TABLE (WLD_EXPREP.GetPmPartat ()) ) " +
              "     AND pmpartat.t_PaymentID = :PaymentID " +
              "     AND pmpartat.t_State = :State ";
      
    var rs:RsdRecordset = execSQLselect(query, makeArray(
                                                          SQLParam("PaymentID", paymentID),
                                                          SQLParam("State", WLD_STATUS_PMPARTAT_CREATED )
                                                          ));  
    PrintSuccessfulRecords( rs );  

    rs = execSQLselect(query, makeArray(
                                          SQLParam("PaymentID", paymentID),
                                          SQLParam("State", WLD_STATUS_PMPARTAT_ERROR )
                                        ));

    PrintUnsuccessfulRecords( rs );
  end;    
end;

macro ¥ç âì_âç¥â‘ª ­¨à®¢ ­¨ï( ‚ë§®¢, rec_step, ‘â âãá, ‘®®¡é¥­¨¥ )
  
  file oproper    ( oproper  );
  var PaymentId:integer = 0;
  setbuff( oprstep_rec, rec_step );
  oproper.ID_Operation = oprstep_rec.ID_Operation;
  
  if( GetEQ(oproper) )
    PaymentId = int(oproper.DocumentId);
  end;
  
  if( ‚ë§®¢ == 0 )

    PrintOnePaymentReport( PaymentId );

    if(‘®®¡é¥­¨¥ != "")
      println( "" );
      println( "   " + ‘®®¡é¥­¨¥ );
      println( "" );
    end;
  end;
END;
