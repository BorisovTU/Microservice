import PaymInter, InsCarryDoc, rmtools;

RECORD Corschem( corschem );
RECORD ppd( pmprop );
RECORD ppk( pmprop );
RECORD prm( pmrmprop );

macro ExecuteStep( doc, first, KindDoc )

  record payment( pmpaym ) ;

  SetBuff( payment, first );

  // В RsbPayment можно менять только ReplicationSession и ReplicationBO, иначе будет конфликт 70!
  var paymentobj:RsbPayment = RsbPayment( payment.PaymentID );

  if( paymentobj.ToBackOffice )
    paymentobj.ReplicationSession = 0;
    paymentobj.ReplicationBO = paymentobj.ToBackOffice;
  end;

  if( (payment.ToBackOffice == "В") AND (NOT IsNeedInAccounting( payment.PayFIID, payment.ToBackOffice )) )
      
    if( payment.PaymStatus != PM_FINISHED )
      MsgBox( "Обработка платежа в RS-Retail еще не завершена" );
      return 1;
    else
      if( not InsertPaymentPropStat( payment.PaymentID, PM_PROP_CLOSED ) )
        msgbox("Ошибка при завершении платежа");
        return 1;
      end;
    end;

  end;

  return 0;

end;