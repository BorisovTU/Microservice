/* ---------------------------------------------------------------------------
  RS-Bank 5.10                                         R-Style Software Lab

  File Name   : r200_100.mac
  Created     : 02.03.04
  Programmer  : BARS
  Description : Завершение входящего
----------------------------------------------------------------------------*/
import InsCarryDoc, BankInter, OprInter, PaymInter, "rmtools.mac", PTInter, RMInter, WldInter, CTInter, "cbsttls.mac", oralib, likepy;

RECORD Corschem( corschem );

var PaymentObj:RsbPayment;

macro IsExistsChieldDocuments(PaymentID)
   var rs:object;
   var select:string;
   var params:TArray;
   select = "select 1 from doproper_dbt opr, doprdocs_dbt docs where To_Number(opr.t_DocumentID)=:PaymentID"+  
                                 " and opr.T_DOCKIND=320 and docs.T_ID_OPERATION=opr.T_ID_OPERATION and docs.T_DOCKIND in (1,2,7)";
   params = makeArray( SQLParam("PaymentID", PaymentID));
   rs = execSQLselect( select, params, FALSE );
   if ( rs.moveNext() )
      return true;
   end;

   select = "select 1 from dpmlink_dbt link where link.t_InitialPayment=:PaymentID"+
                             " and link.t_linkKind In(:PMLINK_KIND_RETREDIR,:PMLINK_KIND_CLOSACC)";
   params = makeArray(  SQLParam("PaymentID", PaymentID),
                        SQLParam("PMLINK_KIND_RETREDIR", PMLINK_KIND_RETREDIR),
                        SQLParam("PMLINK_KIND_CLOSACC", PMLINK_KIND_CLOSACC)
                        );

   rs = execSQLselect( select, params, FALSE );

   if ( rs.moveNext() )
      return true;
   end;

   return false;
end;

const ПутьСчетаКорреспонденцииСКартотеками = "МЕЖБАНКОВСКИЕ РАСЧЕТЫ\\ПЕРЕМЕННЫЕ\\CARDFILEACCOUNT";

/**********************************/
/* Выполнение шага                */
/**********************************/
macro ExecuteStep( doc, first, KindDoc )
  var FlagTrans = 0, DKFlag = "", stat:integer = 0, Cancel = KVIT_NORMAL;
  var НомерСчетаКорреспонденцииСКартотеками, err;
  var paymtr:RsbPaymTransaction = PaymentObj.MakeTransaction();

  if ( PaymentObj.IsCredit() )
     DKFlag = FL_KREDIT;
  else 
     DKFlag = FL_DEBET;
  end;

  FlagTrans = PaymentObj.IsTransit();

  Cancel = KVIT_NORMAL;

  if ( Cancel == KVIT_NORMAL )
     if ( not CarryPlanDocuments(PaymentObj.PaymentID) )
        MsgBox("Ошибка при помещении планируемой проводки в проведенные");
        return 1;
     end;
  else
     if ( PaymentObj.ToBackOffice=="" )        
/*        if ( GetOprStatus(OPR_PAYM_DO)==OPR_PM_ST_LORO_CARD )
           GetRegistryValue( ПутьСчетаКорреспонденцииСКартотеками, V_STRING, НомерСчетаКорреспонденцииСКартотеками, err );
           if( err != 0 )
             MsgBox( "Не определен номер счета корреспонденции с картотеками в настройках банка" );
             return 1;
           end;

           /* Формируем проводку по внебалансу */
           paymtr.Chapter = 3 ;
           paymtr.FIIDPayer = PaymentObj.ReceiverFIID ;
           paymtr.Sum = PaymentObj.ReceiverAmount ;
           paymtr.ResultCarry = 1 ;

           paymtr.Kind_Oper  = " 1" ;
           paymtr.Shifr_Oper = "09" ;

           /* Реальные счета и коды банков */
           if( FlagTrans == 1 )
             if( DKFlag == FL_KREDIT )
               paymtr.AccountPayer      = НомерСчетаКорреспонденцииСКартотеками;
               paymtr.AccountReceiver   = GetCorAcc( PaymentObj.ReceiverFIID, Corschem.Number, CORS_ACC_CARDFILELORO ) ;
             else
               paymtr.AccountPayer      = GetCorAcc( PaymentObj.ReceiverFIID, Corschem.Number, CORS_ACC_CARDFILELORO ) ;
               paymtr.AccountReceiver   = НомерСчетаКорреспонденцииСКартотеками;
             end ;
           else
             if( DKFlag == FL_KREDIT )
               paymtr.AccountPayer        = НомерСчетаКорреспонденцииСКартотеками;
               paymtr.AccountReceiver     = GetCorAcc( PaymentObj.ReceiverFIID, Corschem.Number, CORS_ACC_CARDFILELORO ) ;
             else
               paymtr.AccountPayer        = GetCorAcc( PaymentObj.ReceiverFIID, Corschem.Number, CORS_ACC_CARDFILELORO ) ;
               paymtr.AccountReceiver     = НомерСчетаКорреспонденцииСКартотеками;
             end ;
           end ;

           paymtr.Date_Carry = {curdate};
           paymtr.Department = PaymentObj.Department ;
           
           paymtr.Ground = substr( "Квитовка входящего платежа отказом/"+PaymentObj.Ground, 1, 210 ) ;
           paymtr.Numb_Document = PaymentObj.Number ;
                        
           if( not paymtr.Carry() )
             MsgBox("Ошибка при актуализации платежа");
             return 1;
           end;
        end;*/
        /* Удаляем балансовые проводки */
        if ( not OprDeleteDocumentsPaymObject(PaymentObj.PaymentID, 1) )
           msgbox("Ошибка при удалении балансовых проводок");
           return 1;
        end;
     else
        if ( PaymentObj.PaymStatus==PM_KVITPROCESSING )
           msgbox("Платеж обрабатывается в бэкофисе");
           return 1;
        else
           /* Удаляем проводки */
           if ( not OprDeleteDocumentsPaymObject(PaymentObj.PaymentID) )
              msgbox("Ошибка при удалении проводок");
              return 1;
           end;
        end;
     end; 
     if ( УстановитьСтатусыПлатежа(OPR_PAYM_STATE, OPR_PM_ST_REJECT) )
        MsgBox("Возникла ошибка при смене статусов операции платежа");
        return 1;
     end;
  end;  

  return 0;
end;
