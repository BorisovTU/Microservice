//-----------------------------------------------------------------------------
// Блок      : 29032 - "Перенаправление невыясненного"
// Шаг       : 153   - "Выбор корреспондента"
// Назначение: Макрос шага
// Описание  : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, InsCarryDoc, "rmconst.mac", "cbsttls.mac";

var PaymentObj:RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
macro ExecuteStep( doc, first, KindDoc )

  RECORD dp_dep( dp_dep );      

  if( PaymentObj.ToBackOffice)
     MsgBox("Выбор корреспондента может быть осуществлен только для платежей, у которых не задан бэк-офис");
     return 1;
  end;

   if( not ListDepartment( dp_dep ) )
     MsgBox("Пользователь прервал выполнение операции");
     return 1;
  end;

  if( PaymentObj.IsCredit() )
    if( dp_dep.PartyID == PaymentObj.PayerBankID )
      MsgBox("Невозможно перенаправить платеж отправителю");
      return 1;
    end;
  else
    if( dp_dep.PartyID == PaymentObj.ReceiverBankID )
      MsgBox("Невозможно перенаправить платеж отправителю");
      return 1;
    end;
  end;

  PaymentObj.EndDepartment = dp_dep.Code;
  return 0;
end;