/*
  $Name:             pmpartat.mac
  $Module:           АРМ позиционера
  $Description:      Макрос скроллинга реквизитов платежей для частичного исполнения 
*/

import oralib, likepy, MesInter, OprInter, PTInter;

RECORD r_pmpartat("pmpartat.dbt");

macro Новый_Документ( )
  
  r_pmpartat.DocKind = PS_PAYORDER;
  r_pmpartat.ReceiverBankcodeKind = PTCK_BIC;
  r_pmpartat.State = WLD_STATUS_PMPARTAT_FILLED;
  
  
  var ground = "";

  var query = 
              " SELECT PMRMPROP.T_NUMBER, " +
              "        PMRMPROP.T_SHIFROPER, " +
              "        PMRMPROP.T_RECEIVERINN, " +
              "        PMRMPROP.T_RECEIVERNAME, " +
              "        PMRMPROP.T_DATE, "
              "        PMRMPROP.T_RECEIVERBANKNAME " +              
              "   FROM DPMRMPROP_DBT PMRMPROP " +
              "  WHERE PMRMPROP.T_PAYMENTID = :PAYMENTID ";

  var rs = execSQLselect( query, makeArray(SQLParam("PAYMENTID", r_pmpartat.PaymentID)), false );

  if( rs and rs.MoveNext())
    r_pmpartat.Number = rs.value(0);  
    r_pmpartat.ShifrOper = rs.value(1);
    r_pmpartat.ReceiverINN = rs.value(2);
    r_pmpartat.ReceiverName = rs.value(3);
    r_pmpartat.ReceiverBankName = rs.value(5);    
    
    ground  = ground + "Зачисление выплаты из бюджетных средств по платежу N " + rs.value(0) + " от " + date(rs.value(4));
  end;
  
  query = 
          " SELECT OBJCODE.T_CODE, DP_DEP.T_PARTYID " +
          "   FROM DPMPAYM_DBT PMPAYM " +
          "        INNER JOIN DDP_DEP_DBT DP_DEP " +
          "           ON DP_DEP.T_CODE = PMPAYM.T_ENDDEPARTMENT " +
          "        INNER JOIN DOBJCODE_DBT OBJCODE " +
          "           ON OBJCODE.T_OBJECTID = DP_DEP.T_PARTYID " +
          "  WHERE     OBJCODE.T_CODEKIND = :CODEkIND " +
          "        AND OBJCODE.T_STATE = 0 " +
          "        AND OBJCODE.T_OBJECTTYPE = :OBJECTTYPE " +
          "        AND PMPAYM.T_PAYMENTID = :PAYMENTID ";
          
  rs = execSQLselect( query, makeArray(SQLParam("CODEKIND", r_pmpartat.ReceiverBankcodeKind),
                                       SQLParam("OBJECTTYPE", 3),
                                       SQLParam("PAYMENTID", r_pmpartat.PaymentID)), false );

  if( rs and rs.MoveNext())
    r_pmpartat.ReceiverBankCode = rs.value(0);
    r_pmpartat.ReceiverBankID = rs.value(1);
  end;
  
  query = 
          " SELECT CASE " +
          "    WHEN PMPAYM.T_RECEIVERCODEKIND <> 0 THEN PMPAYM.T_RECEIVERCODEKIND " +
          "      ELSE 1 " +
          "    END, " +
          " PMPAYM.T_RECEIVERCODE, "
          " PMPAYM.T_BASEAMOUNT, "
          " PMPAYM.T_RECEIVER " +
          "  FROM DPMPAYM_DBT PMPAYM " +
          " WHERE T_PAYMENTID = :PAYMENTID ";
          
  rs = execSQLselect( query, makeArray(SQLParam("PAYMENTID", r_pmpartat.PaymentID)), false );

  if( rs and rs.MoveNext())
    r_pmpartat.ReceiverCodeKind = rs.value(0);
    r_pmpartat.ReceiverCode = rs.value(1);
    r_pmpartat.ReceiverID = rs.value(3);
    
    ground = ground + " на сумму " + rs.value(2) + " с учетом требований части 5 статьи 30.5 Федерального закона N 161-ФЗ";
    
    r_pmpartat.Ground = ground;
  end;
          
  return 0;
end;

macro Функция_Пользователя(Режим)
  
  return 0;
end;

