//-----------------------------------------------------------------------------
// Блок      : 29027 - "Картотека ЛОРО"
// Шаг       : 135   - "Средств достаточно?"
// Назначение: Макрос шага
// Описание  : Макрос шага
//-----------------------------------------------------------------------------
import BankInter, OprInter, CurrInter, WldInter, "rmtools.mac", "cbsttls.mac", pm_common;

RECORD Corschem( corschem );
var PaymentObj:RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
macro ExecuteCaseStep( Kind_Operation, Number_Step, first, KindDoc )

  var AccLORO  :string  = PaymentObj.FuturePayerAccount;
  var ChaptLORO:integer = 1;
  var SkipArest;

  //if( PaymentObj.Priority > 5 )
  //  return string( НомерШагаСписаниеСВнебаланса );
  //end;
  RECORD oprstep("oprstep");
  StepInfoEx(Number_Step, oprstep);
  
  if(CheckDateStartOpr(oprstep.ID_Operation))
    return 1;
  end;

  // Установить дату начала операции равной дате операционного дня пользователя
  SetOprDate(29000000, {curdate});
  PaymentObj.ValueDate = PM_GetOperDay_Balance(PaymentObj.Department);

  if( GetOprStatus(OPR_PAYM_PERMISSION) == OPR_PAYM_ST_PERMISSION_YES )
    SkipArest = true;
  else
    SkipArest = false;
  end;

  if( PaymentObj.CheckRest(AccLORO, ChaptLORO, Corschem.FIID, PaymentObj.FuturePayerAmount, {curdate},
                           false, false, false, false, SkipArest) 
    )
    msgbox("Недостаточно средств на счете ЛОРО");
    return 1;
  elif( UnpaidDocIsExist(PaymentObj.FuturePayerAccount, PaymentObj.Priority, false) ) 
    msgbox("В картотеке ЛОРО есть платежи с более высоким приоритетом");
    return 1;
  end;

  return string( НомерШагаСписаниеСВнебаланса );
end;
