/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : u_rmrepos.mac
  Rewrite     : 02.06.2010
  Description : âç¥â ® ¬ áá®¢®¬ ¯¥à¥¯®§¨æ¨®­¨à®¢ ­¨¨ ¯« â¥¦¥©
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import rsd, globals, PaymInter, likepy;

// ¯®«ãç¨âì §­ ç¥­¨¥ ¨§ à¥§ã«ìâ â  § ¯à®á  
private macro getValue( rs : RsdRecordset, fld : string, nullValue : variant ) : variant

  var val = rs.value(fld);
  
  if( val == nullVal )

    if( nullValue != null ) val = nullValue;
    else                    val = "";
    end;

  end;
  
  return val;

end;


private macro PrintRecord( Number, ValueDate, BankCode, Account, Message)                                                                
[  ³#######³##########³###############³####################³#####################################³](Number:w, ValueDate, BankCode:w:c, Account:w, Message:w);
end;

macro PM_ShowMassRepositionLog()
    
[                                                                             
    ¥§ã«ìâ âë ¬ áá®¢®© ®¡à ¡®âª¨ ¨áå®¤ïé¨å ¯« â¥¦¥©                             
                                                                                 
   ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   ³ ®¬¥à ³  „ â     ³             Š®­âà £¥­â             ³                                     ³
   ³       ³          ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´         ¥§ã«ìâ â ®¡à ¡®âª¨         ³
   ³       ³          ³      Š®¤      ³       ‘ç¥â         ³                                     ³
   ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];

  var rs : RsdRecordset;
  var numAll = 0, numError = 0;

  rs = RsdRecordset( "select rm.t_Number, pm.t_ValueDate, prop.t_BankCode, decode(prop.t_DebetCredit, 0, pm.t_PayerAccount, pm.t_ReceiverAccount) as t_Account, substr(msg.t_Msg, 2) as t_Msg, t_IsError "
                       "from( select t_PaymentID, max(decode(t_ErrorStatus, 0, chr(0), chr(88))) as t_IsError, max(sys_connect_by_path (decode (t_ErrorStatus, 0, '', to_char(t_ErrorStatus)||' ')||t_Message, '\n' )) t_Msg "
                               "from (select t_PaymentID, t_ErrorStatus, t_Message, row_number() over (partition by t_PaymentID order by t_ID_Step, t_LogID) t_RowNumInGroup "
                                      "from dpmoprlog_tmp "
                                    ") "
                             "start with t_RowNumInGroup = 1 "
                             "connect by prior t_RowNumInGroup = t_RowNumInGroup - 1 "
                                    "and prior t_PaymentID = t_PaymentID "
                               "group by t_PaymentID "
                               "order by t_PaymentID ) msg, dpmpaym_dbt pm, dpmrmprop_dbt rm, dpmprop_dbt prop "
                       "where msg.t_PaymentID = pm.t_PaymentID "
                         "and rm.t_PaymentID = pm.t_PaymentID "
                         "and prop.t_PaymentID = pm.t_PaymentID "
                         "and prop.t_IsSender = chr(0) ");

  while( rs.moveNext() )
    
    numAll = numAll + 1;

    if(getValue(rs, "t_IsError"))
      numError = numError + 1
    end;

    PrintRecord(getValue(rs, "t_Number"), date(rs.value("t_ValueDate")), getValue(rs, "t_BankCode"), getValue(rs, "t_Account"), getValue(rs, "t_Msg"));

  end;

[  ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

   ˆâ®£®:
   - ®¡à ¡®â ­®   #######################
   - ãá¯¥è­®      #######################
   - á ®è¨¡ª®©    #######################

](numAll:l, (numAll - numError):l, numError:l);

end;

