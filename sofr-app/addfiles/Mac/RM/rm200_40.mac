/* ---------------------------------------------------------------------------
  RS-Bank 5.10                                         R-Style Software Lab

  File Name   : rm200_40.mac
  Created     : 05.05.00
  Programmer  : AAV
  Description : Предварительные проводки по корсчету ответного
----------------------------------------------------------------------------*/
import InsCarryDoc, PaymInter, PTInter, OprInter, BankInter, RMInter, WldInter,
       "rmtools.mac", "pmincom.mac", "cbctuncs.mac", "cbsttls.mac";

RECORD Corschem( corschem );

var PaymentObj:RsbPayment;

private macro ret_EmptySymbol( InSymbol )

  var ret_value = true;
  var i         = 1;

  InSymbol = Trim( InSymbol );

  while ( i <= StrLen( InSymbol ) )
    if ( SubStr( InSymbol, i, 1 ) != "0" )
      ret_value = false;
      i = StrLen( InSymbol );
    end;
    i = i + 1;
  end;

  return ret_value;

end;


/*здесь транзитных не будет*/
macro ExecuteStep( doc, first, KindDoc, ID_Operation )
  var DKFlag = "", FlagTrans = 0, stat, ForceMove = 0;
  var SumPaym = $0, SumDoc = $0, PaySumPaym = $0, PaySumDoc = $0;  
  var accUncs, AccountCarry;
  var aSymb = TArray;
  var num_el_symb = 0;
  var paymtr:RsbPaymTransaction;

  RECORD sleeve( pmsleeve );
  RECORD wlconf( wlconf );
  RECORD firstBuf( pmpaym );

  SetBuff( firstBuf, first );  

  if ( PaymentObj.IsCredit() )
     DKFlag = FL_KREDIT;
  else
     DKFlag = FL_DEBET;
  end;

  FlagTrans = PaymentObj.IsTransit();
  if( FlagTrans ) /* флаг уже заполнен - это транзитный документ */
      msgbox("Транзитный документ не может быть зачислен");
      return 1;
  end;

  if ( not CheckPaymentObj(PaymentObj) )
     return 1;
  end;

  if ( DKFlag == FL_KREDIT )
    if ( (PaymentObj.InTransferDate>{curdate}) and (Corschem.IsKvitInPaym=="X") )
       accUncs = InPaymentAccUnclosed(PaymentObj);
       AccountCarry=accUncs.FindAndOpenAccount();  
    else
       AccountCarry=PaymentObj.FutureReceiverAccount;
    end;
  end;

  ClearRecord( sleeve );
     /* Берем всю зарезервированную сумму */
     ПолучитьРасходыРеспондента(PaymentObj.PaymentID, sleeve, {OurBank});

  /*                     Для начала разберемся с комиссиями                */
  if ( ExecuteSingCommissionObj( ID_Operation, firstBuf, KindDoc, PaymentObj,
                          OUR, BEN,
                          PaySumPaym, PaySumDoc, SumPaym, SumDoc, NULL, NULL, sleeve.Amount, sleeve.FIID) )
     msgbox("Ошибка при начислении комиссий");
     return 1;
  end;  

  /* Заполняем поля документа */
  if( IsNeedInAccounting( PaymentObj.ReceiverFIID, PaymentObj.ToBackOffice ) )
    paymtr = PaymentObj.MakeTransaction();
    paymtr.Chapter       = 1;
    paymtr.FIIDPayer     = PaymentObj.ReceiverFIID;
    paymtr.Sum           = PaySumDoc;
    paymtr.ResultCarry  = AVIZOCARRY;
    paymtr.Date_Carry    = PaymentObj.ValueDate;
    paymtr.Department    = PaymentObj.Department;
    paymtr.Kind_Oper     = " 1";
    paymtr.Shifr_Oper    = "09";
    paymtr.Number_Pack   = PaymentObj.NumberPack;
  
    /* Реальные счета и коды банков */
    if( FlagTrans == 1 )
      if( DKFlag == FL_KREDIT )
        paymtr.AccountPayer        = PaymentObj.FuturePayerAccount;        
        paymtr.AccountReceiver     = AccountCarry;
      else        
        paymtr.AccountPayer        = AccountCarry;
        paymtr.AccountReceiver     = PaymentObj.FutureReceiverAccount;
      end;
    else
      if( DKFlag == FL_KREDIT )
        paymtr.AccountPayer        = PaymentObj.FuturePayerAccount;
        paymtr.AccountReceiver     = AccountCarry;
      else
        paymtr.AccountPayer        = AccountCarry;
        paymtr.AccountReceiver     = PaymentObj.FutureReceiverAccount;
      end;
    end;
  
  
    paymtr.Ground        = PaymentObj.Ground;
    paymtr.Numb_Document = PaymentObj.Number;

    paymtr.AddCashSymbol(PaymentObj.SymbNotBalDebet, paymtr.Sum, CASHSYMB_TYPE_NOTB);

    if( not paymtr.Carry() )
      MsgBox("Ошибка при актуализации платежа");
      return 1;
    end;
  
  end;

  if ( not CarryPlanDocuments(PaymentObj.PaymentID) )
     MsgBox("Ошибка при помещении планируемой проводки в проведенные");
    return 1;
  end;

   ClearRecord( wlconf );
    FillConfirmationParamObj(PaymentObj, wlconf);
    if(CreateConfFlagForCorschem(wlconf))
    if( CreateConfirmation(wlconf) == FALSE )
      msgbox("Ошибка при создании подтверждения по проводке");
      return 1;
    end;
    end;
/*  if(УстановитьСтатусыПлатежа(OPR_PAYM_DO, OPR_PM_ST_COMPLET ))
      msgbox("Ошибка при установке статуса платежа");
      return 1;
  end;*/
  if((PaymentObj.ToBackOffice == "") and (GetOprStatus(OPR_PAYM_IN_KVIT) == OPR_PM_ST_KVIT)/*здесь надо проверить сквитованность платежа*/)
     /* Закрываем платеж */
     PaymentObj.PaymStatus = PM_FINISHED;
     PaymentObj.PropStatus = PM_PROP_CLOSED;
     return УстановитьСтатусыПлатежа(OPR_PAYM_STATE, OPR_PM_ST_CLOSE );
  end;
  return 0;
end;

