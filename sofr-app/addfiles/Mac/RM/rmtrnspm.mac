/* ---------------------------------------------------------------------------
  RS-Bank 6.0                                         R-Style Software Lab

  Имя файла   : rmtrnspm.mac
  Создан      : 22.10.07
  Описание    : Макрос скролинга созданных по исполнению платежей
----------------------------------------------------------------------------*/
import PaymInter, globals, PTInter, OprInter, CTInter, FIInter, WldInter, pm_opr, "rmtplstr.mac";

record Curpmpaym   ( pmpaym   );
record Curpmdebet  ( pmprop   );
record Curpmcredit ( pmprop   );
record Curpmrmprop ( pmrmprop );
record Curpmakkr   ( pmakkr   );
record CurPmco     ( pmco     );
record CurPmkz     ( pmkz     );
record CurCurTr    ( pmcurtr  );

record Oldpmpaym   ( pmpaym   );
record Oldpmdebet  ( pmprop   );
record Oldpmcredit ( pmprop   );
record Oldpmrmprop ( pmrmprop );
record Oldpmakkr   ( pmakkr   );
record OldPmco     ( pmco     );
record OldPmkz     ( pmkz     );
record OldCurTr    ( pmcurtr  );

/* Установка подсказки для скролингов из макроса */
/*  PM_ALLBYPROC_SCR  = 34, // все созданные по исполнению
    PM_REJBYPROC_SCR  = 35, // отвергнутые по исполнению
    PM_CTRLBYPROC_SCR = 36, // для контроля по исполнению*/
private const Hint_AllPaym:string = "/*+FIRST_ROWS LEADING(pmprop pmpaym t pmrmprop prop2 oproper) INDEX(pmprop dpmprop_dbt_idx1) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(t dpmlink_dbt_idx3) USE_NL(pmprop pmpaym t pmrmprop prop2 oproper)*/";
private const Hint_StatusPaym:string = "/*+FIRST_ROWS LEADING(oprcurst oproper pmpaym pmprop prop2 pmrmprop) INDEX(oprcurst doprcurst_dbt_idx1) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(t dpmlink_dbt_idx3) INDEX(pmprop dpmprop_dbt_idx0) USE_NL(oprcurst oproper pmpaym pmprop prop2 pmrmprop)*/";
private const Hint_StepPaym:string = "/*+FIRST_ROWS LEADING(oprstep oproper pmpaym pmprop prop2 pmrmprop) INDEX(oprstep doprstep_dbt_idx10) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(t dpmlink_dbt_idx3) INDEX(pmprop dpmprop_dbt_idx0) USE_NL(oprstep oproper pmpaym pmprop prop2 pmrmprop)*/";
MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string
  // Пример формируемой подсказки
  //    "/*+FIRST_ROWS LEADING(t)*/"
  if( ScrolStates == 34 )
    return Hint_AllPaym;
  elif( ScrolStates == 35 )
    return Hint_StatusPaym;
  elif( ScrolStates == 36 )
    return Hint_StepPaym;
  end;
  return DefaultHint;
END;


macro Новый_Документ( )
  return 0;
end;



macro Проверить_Документ( Режим )
  var stat = 0;
  var Status:integer = -1;  
  PM_GetOprStatus( Curpmpaym.DocKind, Curpmpaym.PaymentID, OPR_PAYM_STATE, @Status );

  if( Режим == 3 )  /* РЕДАКТИРОВАНИЕ ДОКУМЕНТА */
    /*При редактировании производим проверку важности внесенных изменений */
    /* Константы важности внесенных изменений:           */
    /* CHANG_NOTIMPORTANT   - изменения неважные (сохранение без отката операции)*/
    /* CHANG_IMPORTANT      - изменения важны (сохранение изменений возможно только при откате) */
    /* CHANG_NOTKEEP        - не сохранять изменения */
    /* Если возвращаемое значение  > 0, то это оно интерпретируется как номер поля с ошибочным параметром*/
    /* Если возвращаемое значение  = 0, то cчитается, что проверка прошла успешно
       и сохранение изменений можно производить без отката операции      */
    if( Status == OPR_PM_ST_OPEN )
      stat = CHANG_IMPORTANT;
    elif( (Status == OPR_PM_ST_REJECT) or (Status == OPR_PM_ST_DEFER))
      stat = CHANG_NOTIMPORTANT;
    else
      stat = CHANG_NOTKEEP;
    end;
  elif( Режим == 2 ) /* Ввод ответного платежа  */

  end;
  return stat;
end;

