import PaymInter, rmtools, lnpaym, OprInter;

RECORD Corschem( corschem );
RECORD ppd( pmprop );
RECORD ppk( pmprop );
RECORD prm( pmrmprop );

MACRO ExecuteCaseStep( Kind_Operation, Number_Step, first, KindDoc )
  record payment( pmpaym ) ;

  SetBuff( payment, first );

  // В RsbPayment можно менять только ReplicationSession и ReplicationBO, иначе будет конфликт 70!
  var paymentobj:RsbPayment = RsbPayment( payment.PaymentID );

  if( (payment.ToBackOffice == "В") AND (NOT IsNeedInAccounting( payment.PayFIID, payment.ToBackOffice )) )
    return "110";
  else
    return "";
  end;

END;

MACRO CheckStepAction( mes, primdoc, DocKind, ID_Operation )

  RECORD payment( pmpaym ) ;
  SetBuff( payment, primdoc );
  var paymentobj:RsbPayment = RsbPayment( payment.PaymentID );

  if( mes == OP_BACKOUT_STEP )

    if( ( paymentobj.ToBackOffice == "В" ) AND
        ( index( Get_SYMB_BACK_NOT_ACCOUNTING(), "В" ) ) AND
        ( paymentobj.PaymStatus != PM_KVITWAIT ) )
      msgbox("Невозможно откатить шаг операции,|т.к. платеж обрабатывается в ПС " + LnFindType( paymentobj.ToBackOffice ) );
      return 1;
    end;

  end;

  return 0;
END;
