//-----------------------------------------------------------------------------
// Блок     : 29050 - "Ожидание перепозиционирования"
// Шаг      : 10    - "Ожидание перепозиционирования"
// Описание : Макрос шага
//-----------------------------------------------------------------------------

import InsCarryDoc, PaymInter, PTInter, OprInter, BankInter, "rmtools.mac", "cbsttls.mac", "pmcarfun.mac"
;

var PaymentObj:RsbPayment;

private macro IsUnfinAcc( FIID, Account ):bool
  var select = " select 1 " +
                 " from dmcaccdoc_dbt doc, dmccateg_dbt cat " +
                " where doc.t_Chapter = 1 " +
                  " and doc.t_Currency = :FIID " +
                  " and doc.t_Account = :Account " +
                  " and doc.t_CatID  = cat.t_ID " +
                  " and cat.t_Number = 103 ";

  var params = makeArray( SQLParam( "FIID", FIID ), 
                          SQLParam( "Account", Account ) );
  var rs = execSQLselect( select, params, TRUE );
  
  if( rs and rs.moveNext() )
    return true;
  else
    return false;
  end;
end;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
macro ExecuteStep( doc, first )
  var rs:RsdRecordset;  
  record Corschem(corschem);

  if( НайтиКорсхему(PaymentObj.OutCorschem, PaymentObj.OutCorschemFIID, Corschem))
    MsgBox("Не найдена исходящая корсхема");
    return 1;
  end;
 
  if(ПолучитьВсеПроводки(PaymentObj.PaymentID,@rs, 1/*CHAPT1*/) and rs.moveLast())
    /* Если в последней проводке счет кредита (дебета для дебетового платежа) равен корсчету из исходящей корсхемы платежа 
       или является счетом СНР (имеет связь с категорией учета СНР)*/
    if( ( (PaymentObj.DbFlag == UNSET_CHAR) and ( (rs.value("t_ReceiverAccount") == Corschem.Account) or 
                                                  ( IsUnfinAcc( rs.value("t_ReceiverFIID"),rs.value("t_ReceiverAccount") ) ) )
        ) OR
        ( (PaymentObj.DbFlag == SET_CHAR)   and ( (rs.value("t_PayerAccount")    == Corschem.Account) or 
                                                  ( IsUnfinAcc( rs.value("t_PayerFIID"),rs.value("t_PayerAccount") ) ) ) 
        )
      )
      if(УстановитьСтатусыПлатежа( OPR_PAYM_DO, OPR_PM_ST_DISCHARGE))
        MsgBox( "Возникла ошибка при смене статусов операции платежа" );
        return 1;
      end;
    else
      PaymentObj.ValueDate = ValueDateForRmPosition(PaymentObj, Corschem);
      SetOprDate(29000000, PaymentObj.ValueDate);
      if(УстановитьСтатусыПлатежа( OPR_PAYM_DO, OPR_PM_ST_ENTER))
        MsgBox( "Возникла ошибка при смене статусов операции платежа" );
        return 1;
      end;
    end;
  end;
   return 0;
end;

