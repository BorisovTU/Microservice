/*
  $Name:         rmunkno.mac
  $Module:       Арм позиционера
  $Description:  Отчет: "Оборот по счету невыясненных сумм"
*/ 

/*                                                */
/*       Обороты по счету невыясненных сумм       */
/*                                                */
/* Файл: rmunkno.mac                              */
/*                                                */
import BankInter, PaymInter, PTInter, CurrInter, "rmunktl.mac" ;

/********************** переменные *************************/
var СчетК, СчетД,
    FIID,
    ОборотКредита,
    ОборотДебета,
    ОборотКредитаЗаДень,
    ОборотДебетаЗаДень,
    Остаток,
    Операционист,
    ДПД, ПРЗ, ВидСчета,
    НачалоОтчета = {curdate},
    КонецОтчета  = {curdate},
    ДатаОтчета ;


/*************** Печать заголовка по счету *****************/
macro ЗаголовокПоСчету( DKflag )
  var Name, Счет ;

  if( DKflag == FL_KREDIT )
    Name = "КРЕДИТОВЫЙ" ;
    Счет = СчетК ;
  else
    Name = "ДЕБЕТОВЫЙ" ;
    Счет = СчетД ;
  end ;

[
---------------------------------------------------------------------------------------------------------------
 #
 БИК #
 ##########, ########

 ########## ОБОРОТ ПО СЧЕТУ НЕВЫЯСНЕННЫХ ПЛАТЕЖЕЙ]
({Name_Bank}:l, {MFO_Bank}:l, Date(), Time(), Name ) ;

  if(НачалоОтчета == КонецОтчета)

[                  за #                                            ДПД #]
(ДатаОтчета:m, ДПД:m) ;
  else

[     за период с #                   по #                         ДПД #]
(НачалоОтчета:m, КонецОтчета:m, ДПД:m) ;
  end ;

  if ( FIID == 0 )

[
  СЧЕТ #########################//###//#########       ОТВ. ИСП. #####

  ВХОДЯЩИЙ ОСТАТОК  #     #######################

-------------------------------------------------------------------------------------------------------------------------------------------
|      Номер     | Шифр |БИК банка |    Счет отправителя/    |     Счет получателя     |ПР|         ДЕБЕТ         |        КРЕДИТ         |
|   документа    | опер.|  корр.   |       плательщика       |                         |  |                       |                       |
|----------------|------|----------|-------------------------|-------------------------|--|-----------------------|-----------------------|]
(Счет, ПРЗ, ВидСчета, Операционист, АП(Остаток):l, abs(Остаток):0:2) ;

  else

[
  СЧЕТ #########################//###//#########       ОТВ. ИСП. #####

  ВХОДЯЩИЙ ОСТАТОК  #     #######################

+----------------+----------+-------------------------+-------------------------+--+-----------------------+-----------------------+
|      Номер     |Код банка |    Счет отправителя/    |     Счет получателя     |ПР|         ДЕБЕТ         |        КРЕДИТ         |
|   документа    |  корр.   |       плательщика       |                         |  |                       |                       |
|----------------|----------|-------------------------|-------------------------|--|-----------------------|-----------------------|]
(Счет, ПРЗ, ВидСчета, Операционист, АП(Остаток):l, abs(Остаток):0:2) ;

  end;
end ;

/****************** Печать итогов по счету *****************/
macro ИтогиПоСчету()
if ( FIID == 0 )
[|-----------------------------------------------------------------------------------------|-----------------------|-----------------------|
|ИТОГО ОБОРОТЫ                                                                            |#######################|#######################|
-------------------------------------------------------------------------------------------------------------------------------------------

  ИСХОДЯЩИЙ ОСТАТОК #     #######################
](ОборотДебета:0:2, ОборотКредита:0:2, АП(Остаток):l, abs(Остаток):0:2) ;
else
[|----------------------------------------------------------------------------------|-----------------------|-----------------------|
|ИТОГО ОБОРОТЫ                                                                     |#######################|#######################|
------------------------------------------------------------------------------------------------------------------------------------

  ИСХОДЯЩИЙ ОСТАТОК #     #######################
](ОборотДебета:0:2, ОборотКредита:0:2, АП(Остаток):l, abs(Остаток):0:2) ;
end;

end;

/****************** Печать итогов за день ******************/
macro ИтогиЗаДень()
if ( FIID == 0 )
[|-----------------------------------------------------------------------------------------|-----------------------|-----------------------|
|ИТОГО за #                                                                               |#######################|#######################|
|-----------------------------------------------------------------------------------------|-----------------------|-----------------------|
](ДатаОтчета:m, ОборотДебетаЗаДень:0:2, ОборотКредитаЗаДень:0:2) ;
else
[|----------------------------------------------------------------------------------|-----------------------|-----------------------|
|ИТОГО за #                                                                        |#######################|#######################|
|----------------------------------------------------------------------------------|-----------------------|-----------------------|
](ДатаОтчета:m, ОборотДебетаЗаДень:0:2, ОборотКредитаЗаДень:0:2) ;
end

end ;

/************* Печать документа по дебету счета ************/
macro ПечатьДокументаДебета()

  ОборотДебета       = ОборотДебета + rminprop.Sum;
  ОборотДебетаЗаДень = ОборотДебетаЗаДень + rminprop.Sum;

if ( pm.PayFIID == 0 )
[|################|######|##########|                         |#########################|##|#######################|                       |
]( rmaket.Number, rmaket.ShifrOper, ppk.BankCode, pm.ReceiverAccount, "", rminprop.Sum:0:2);
else
[|################|##########|                         |#########################|##|#######################|                       |
]( rmaket.Number, ppk.BankCode, pm.ReceiverAccount, "", rminprop.Sum:0:2);
end;

end;

/************ Печать документа по кредиту счета ************/
macro ПечатьДокументаКредита()

  ОборотКредита       = ОборотКредита + rminprop.Sum;
  ОборотКредитаЗаДень = ОборотКредитаЗаДень + rminprop.Sum;

if ( pm.PayFIID == 0 )
[|################|######|##########|#########################|                         |##|                       |#######################|
]( rmaket.Number, rmaket.ShifrOper, ppd.BankCode, pm.PayerAccount, "", rminprop.Sum:0:2 ) ;
else
[|################|##########|#########################|                         |##|                       |#######################|
]( rmaket.Number, ppd.BankCode, pm.PayerAccount, "", rminprop.Sum:0:2 ) ;
end;

end ;

/********** Перебор документов дебета за один день *********/
macro ДокументыДебета()
  var result = TRUE, stat, Год, Месяц, День ;
/*
  /* Заполняем ключ поиска */
  fd.Closed   = "" ;
  fd.Account  = СчетД;
  datesplit( ДатаОтчета, День, Месяц, Год ) ;
  fd.Sort     = Заменить_пробелы_нулями( string( Год:4, Месяц:2, День:2 ) ) ;

  stat = GetGE( fd ) ;
  while( stat )
    if(    ( fd.Closed != "" )
        OR ( fd.Account != СчетД )
        OR ( fd.PlaceDate > ДатаОтчета )
      )
      if(     ( fd.Closed == "" )                 /* Если выходим из-за даты */
          AND ( fd.Account != СчетД )
          AND ( fd.PlaceDate > ДатаОтчета )
        )
        if( fd.PlaceDate > КонецОтчета )
          return ;
        else
          ДатаОтчета = fd.PlaceDate - 1 ;
          return ;
        end ;
      end ;

      stat = FALSE ; /* Кончились подходящие записи */
    else
      if( Фильтр_ДокНев( FL_DEBET ) )
        ПечатьДокументаДебета() ;
      end ;
      stat = Next( fd ) ;
    end ;
  end ;*/
end ;

/********* Перебор документов кредита за один день *********/
macro ДокументыКредита()
  var result = TRUE, stat, Год, Месяц, День ;
/*
  /* Заполняем ключ поиска */
  fd.Closed   = "" ;
  fd.Account  = СчетК ;
  datesplit( ДатаОтчета, День, Месяц, Год ) ;
  fd.Sort     = Заменить_пробелы_нулями( string( Год:4, Месяц:2, День:2 ) ) ;

  stat = GetGE( fd ) ;
  while( stat )
    if(    ( fd.Closed != "" )
        OR ( fd.Account != СчетК )
        OR ( fd.PlaceDate > ДатаОтчета )
      )
      if(     ( fd.Closed == "" )                 /* Если выходим из-за даты */
          AND ( fd.Account != СчетК )
          AND ( fd.PlaceDate > ДатаОтчета )
        )
        if( fd.PlaceDate > КонецОтчета )
          return ;
        else
          ДатаОтчета = fd.PlaceDate - 1 ;
          return ;
        end ;
      end ;

      stat = FALSE ; /* Кончились подходящие записи */
    else
      if( Фильтр_ДокНев( FL_KREDIT ) )
        ПечатьДокументаКредита() ;
      end ;
      stat = Next( fd ) ;
    end ;
  end ;
  */
end ;

/************* Печать документов за один день **************/
macro ДокументыЗаДату( DKflag )
  if( DKflag == FL_DEBET )
    ДокументыДебета() ;
  else
    ДокументыКредита() ;
  end ;
end ;

/***************** Выписка по одному счету ****************/
macro ВыпискаПоСчету( DKflag )
  var Счет ;

  ОборотКредита = $0 ;
  ОборотДебета  = $0 ;

  if( DKflag == FL_DEBET )
    Счет = СчетД ;
  else
    Счет = СчетК ;
  end ;

  ДатаОтчета = НачалоОтчета ;
  /* входящий остаток есть исходящий остаток за предыдущую дату */
  if(FIID == 0)
     Остаток = RestA( Счет, НачалоОтчета - 1) ;
  else
     Остаток = RestAC( Счет, FIID, НачалоОтчета - 1 ) ;
  end;

  ЗаголовокПоСчету( DKflag ) ;
  while( ДатаОтчета <= КонецОтчета )

    ОборотДебетаЗаДень  = $0 ;
    ОборотКредитаЗаДень = $0 ;

    ДокументыЗаДату( DKflag ) ;

    if( ( НачалоОтчета != КонецОтчета ) and
        ( ( ОборотДебетаЗаДень != $0 ) or ( ОборотКредитаЗаДень != $0 ) ) )
      ИтогиЗаДень() ;
      end ;
    ДатаОтчета = ДатаОтчета + 1 ;
    end ;

  /* исходящий остаток за дату отчета */
  if(FIID == 0)
     Остаток = RestA( Счет, КонецОтчета) ;
  else
     Остаток = RestAC( Счет, FIID, КонецОтчета ) ;
  end;
  ИтогиПоСчету() ;
end ;

/************************************************************/
macro ОбработатьСчет( DKflag )
  var Счет ;
  ac.Chapter = 1 ;

  if( DKflag == FL_DEBET )
    Счет = СчетД ;
  else
    Счет = СчетК ;
  end ;

  ac.Account = Счет ;
  ac.Code_Currency = FIID;

  if( not GetEQ( ac ) )
    MsgBox("Указанный счет не найден") ;
    return ;
  end ;
  if( IsAccessToAc( ac.Account, ac.Code_Currency, {oper}, ac.Chapter ) )
    MsgBox("Нет права доступа к счету") ;
    return ;
  end ;

  ДПД          = ac.Final_Date ;
  Операционист = ac.Oper ;
  ПРЗ          = "" ;
  if(ac.Kind_Account == "А")
    ВидСчета = "АКТИВНЫЙ" ;
    elif(ac.Kind_Account == "П")
    ВидСчета = "ПАССИВНЫЙ" ;
    elif(ac.Kind_Account == "АП")
    ВидСчета = "АКТ-ПАСС" ;
    else
    ВидСчета = "" ;
    end ;
  ВыпискаПоСчету( DKflag ) ;
end ;

/************************************************************/
macro ОтчетОборот( Cur, date1, date2)
  НачалоОтчета  = date1 ;
  КонецОтчета   = date2 ;
  FIID          = Cur ;
  СчетК         = Unkn_GetAccountPassive( {OperDprt}, FIID);
  СчетД         = Unkn_GetAccountActive( {OperDprt}, FIID);

  if(НачалоОтчета > КонецОтчета)
    КонецОтчета = НачалоОтчета ;
  end ;

  ОбработатьСчет( FL_DEBET ) ;

  ОбработатьСчет( FL_KREDIT ) ;
end ;
