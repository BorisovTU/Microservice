/*
$Name:           rmoutpm.mac
$Module:         МБР
$Description:    Проверки начального платежа, функция пользователя
*/


import PaymInter, globals, PTInter, OprInter, CTInter, FIInter, "pmbuff.mac", "rmtools.mac", "multypm.mac", "rmtplstr.mac";
import "cb_FillFactura.mac";
import "pmchangeprop.mac";


private macro ПроверитьИдентичностьСводногоПлатежа() : integer
  if( not ( ПроверкаИдентичности(r_pmpaym,   r_pmpaym_old, "PayType"  ) and
            ПроверкаИдентичности(r_debet,  r_debet_old ) and
            ПроверкаИдентичности(r_credit, r_credit_old) and
            ПроверкаИдентичности(r_pmrmprop, r_pmrmprop_old, 
                                 "PayerINN", "PayerName", "ReceiverINN", "ReceiverName",
                                 "Ground", "TaxAuthorState", "BTTTICode", "OKATOCode",
                                 "TaxPmGround", "TaxPmPeriod", "TaxPmNumber",
                                 "TaxPmDate", "TaxPmType"
                                ) and
            ПроверкаИдентичности(r_pmakkr,   r_pmakkr_old  ) and
            ПроверкаИдентичности(r_pmcurtr,  r_pmcurtr_old ) and
            ПроверкаИдентичности(r_pmkz,     r_pmkz_old    ) ) 
    )
    msgbox("В сводном платеже разрешено изменять только реквизиты плательщика и получателя, назначение платежа и налоговые реквизиты");
    return CHANG_NOTKEEP;
  end;

  return 0;
end;

macro Проверить_Документ( Режим )

  if (Режим == 3) /* Редактирование документа */
    if( (r_pmpaym.DocKind == DLDOC_MULTYPM) and (r_pmpaym.PaymStatus <= PM_IS_SENDING) )
      return ПроверитьИдентичностьСводногоПлатежа();
    else // пока что запрещено редактировать все, кроме сводных
      return CHANG_NOTKEEP;
    end;
  elif (Режим == 4) /* Откат операции */
    return 0;
  elif (Режим == 5) /* Инициализация операции */
    return 0;
  end;

  return 0;
end;

/*
 return 0;        // никаких действий после работы макросы не делать
 return UPDTREC   // обновить в скролле текущюю запись
 return UPDTPAGE  // обновить страницу скроллла         
*/
macro Функция_Пользователя(Режим)
  if (Режим == UFN_PANEL_INPUT)
    // функция вызвана из панели ввода объекта
  end;
  if (Режим == UFN_PANEL_EDIT)
    // функция вызвана из панели корректировки объекта  
  end;
  if (Режим == UFN_SCROL)
    // функция вызвана из панели скроллинга, единичный вызов (read-only)  
  end;

  return 0;
end;

/* Хинты */

// а) списки по шагу
private const Hint_ByStep:string = "/*+FIRST_ROWS LEADING(oprstep oproper t pmpaym pmrmprop prop2) INDEX(oprstep doprstep_dbt_idx10) INDEX(t dpmprop_dbt_idx0) INDEX(pmpaym dpmpaym_dbt_idx0) USE_NL(oprstep oproper t pmpaym pmrmprop prop2)*/";
// б) списки по статусу свойств
private const Hint_ByPropStatus:string = "/*+FIRST_ROWS LEADING(t pmpaym pmrmprop prop2 oproper oprstep) INDEX(t dpmprop_dbt_idx4) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(oprstep doprstep_dbt_idx0) USE_NL(t pmpaym pmrmprop prop2 oproper oprstep)*/";
// в) списки по статусу свойств, где документов слишком много, и необходима фильтрация по дате
// в1) Если фильтрация по дате значения
private const Hint_ByValueDate:string = "/*+FIRST_ROWS LEADING(pmpaym t pmrmprop prop2 oproper oprstep) INDEX(pmpaym dpmpaym_dbt_idx11) INDEX(t dpmprop_dbt_idx0) USE_NL(pmpaym t pmrmprop prop2 oproper oprstep)*/";
// в2) Если фильтрация по ДПП
private const Hint_ByTransferDate:string = "/*+FIRST_ROWS LEADING(t pmpaym pmrmprop prop2 oproper oprstep) INDEX(t dpmprop_dbt_idx1) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(oprstep doprstep_dbt_idx0) USE_NL(t pmpaym pmrmprop prop2 oproper oprstep)*/";
// в3) Если фильтрация по дате закрытия
private const Hint_ByCloseDate:string = "/*+FIRST_ROWS LEADING(pmpaym t pmrmprop prop2 oproper oprstep) INDEX(pmpaym dpmpaym_dbt_idx15) INDEX(t dpmprop_dbt_idx0) USE_NL(pmpaym t pmrmprop prop2 oproper oprstep)*/";
// г) списки по статусу платежа
private const Hint_ByPaymStatus:string = "/*+FIRST_ROWS LEADING(pmpaym t pmrmprop prop2 oproper oprstep) INDEX(pmpaym dpmpaym_dbt_idx16) INDEX(t dpmprop_dbt_idx0) USE_NL(pmpaym t pmrmprop prop2 oproper oprstep)*/";

MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string

  /* Возможные значения ScrolStates:
  PM_OUTALL_SCR         = 0,  // Список всех начальных платежей
  PM_READY_TO_DISCH_SCR = 1,  // Готовые к отправке 
  PM_DISCHARGED_SCR     = 2,  // Выгруженные из АРМ
  PM_UPLOADED_SCR       = 3,  // Все отправленные корреспонденту
  PM_DEFECTED_SCR       = 4,  // Отбракованные адресатом
  PM_OUT_UNKVIT_SCR     = 5,  // несквитованные платежи
  PM_OUT_CARDFILE_SCR   = 6,  // Документы на картотеках к корсчетам
  PM_UNFINISHED_SCR     = 7,  // Помещенные в незавершенные
  PM_RETFROMFRONT_SCR   = 8,   // Список возвращенных из фронт-офиса платежей
  PM_OUT_REJECTED_WORK_SCR  = 9,  // список обрабатываемых отвергнутых платежей
  PM_OUT_REJECTED_SCR       = 10, // список отвергнутых платежей
  PM_FINISHED_SCR           = 11, // Платежи с завершенной обработкой (закрытые)
  PM_PLANED_SCR             = 12, // Список планируемых платежей 
  PM_FOR_POSITIONING_SCR    = 13, // Для позиционирования   

  */

  if( ( ScrolStates ==  2 ) or   /* Выгруженные в фронт-офис   */
      ( ScrolStates ==  3 ) or   /* Все отправленные           */
      ( ScrolStates ==  4 ) or   /* Отбракованные адресатом    */
      ( ScrolStates ==  6 ) or   /* На картотеках к корсчетам  */
      ( ScrolStates ==  9 ) or   /* Обработка отвергнутых      */
      ( ScrolStates == 10 ) or   /* Отвергнутые                */
      ( ScrolStates == 12 ) )    /* Планируемые                */
    
    return Hint_ByPropStatus;
  
  elif ( ScrolStates == 7 )      /* Помещенные в незавершенные */
  
    return Hint_ByPaymStatus;
  
  elif ( ( ScrolStates == 1 ) or /* Готовые к выгрузке  */
         ( ScrolStates == 5 ) or /* Несквитованные */
         ( ScrolStates == 8 ) or /* Список возвращенных из фронт-офиса платежей */
         ( ScrolStates == 13) )  /* Для позиционирования */
    
    return Hint_ByStep;
  
  elif( ( ScrolStates == 11 ) or /* Закрытые */
        ( ScrolStates ==  0 ) )  /* Все */

    var dtflt:PMScrolDateFltr = PMScrolDateFltr();

    if( dtflt.IsSet( DTFL_TRANSFERDATE ) )
      return Hint_ByTransferDate;
    elif( dtflt.IsSet( DTFL_VALUEDATE ) )
      return Hint_ByValueDate;
    elif( dtflt.IsSet( DTFL_CLOSEDATE ) )
      return Hint_ByCloseDate;
    else
      return Hint_ByPropStatus;
    end;

  end; 
  return DefaultHint;

END;


macro  ЗапроситьРеквизиты()
  return ChoicePaymentPropertiesFromScrol();
end;

macro  УстановитьРеквизиты( PaymentID )
  return ChangePaymentPropertiesFromScrol( PaymentID );
end;
