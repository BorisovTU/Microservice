 /*
 $Name: rm200_35.mac
 $Module: АРМ позиционера
 $Description: Макрос шага "Контроль отредактированного платежа" блока "Ручная обработка"
 */

//-----------------------------------------------------------------------------
// Блок      : 29029 - "Ручная обработка"
// Шаг       : 35    - "Контроль отредактированного платежа"
// Назначение: Макрос шага
// Описание  : Макрос шага
//-----------------------------------------------------------------------------
import WldInter, "cbsttls.mac", pm_tools, "pm_common.mac", pm_setst, pmsummo;

var PaymentObj:RsbPayment;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
macro ExecuteStep( Kind_Operation, first, KindDoc, ID_Operation, ID_Step )

  var err      :integer = 0;
  var Direct   :integer = GetOprStatus( OPR_PAYM_DIRECT );
  var Account  :string;
  var FIID     :integer;
  var Chapter  :integer = 1;
  var note_text:string = "";
  var err_text :string = "";
  var err_str  :string = "";
  var stat     :integer = 0;

  var CABS_Segment:integer;

  if(Bnk_GetRegistryValue("АРМ ПОЗИЦИОНЕРА\\ОТВЕТНЫЙ\\STOPCONTROLEDITEDSAMEPERSN", V_BOOL, false))
    if( not КонтрольПлатежа( PaymentObj, ID_Operation, ID_Step ) )
      MsgBox("Пользователь " + {Oper} + " не может контролировать платеж");
      return 1;
    end;
  end;


  if( not IsSummaryPayment( PaymentObj ) )

    // Определить, какой счет надо проверять
    if( ( Direct == OPR_PM_ST_DIR_IN ) or ( Direct == OPR_PM_ST_DIR_TRANZIT ) ) // Входящий или транзитный
      Account = PaymentObj.FutureReceiverAccount;
      FIID    = PaymentObj.FutureReceiverFIID;
      err_text = "Счет получателя ";
      err_str  = " получателя";
    else
      if( PaymentObj.DbFlag )
        Account  = PaymentObj.FuturePayerAccount;
        FIID     = PaymentObj.FuturePayerFIID;
        err_text = "Счет плательщика ";
        err_str  = " плательщика";
      else
        Account = PaymentObj.FutureReceiverAccount;
        FIID    = PaymentObj.FutureReceiverFIID;
        err_text = "Счет получателя ";
        err_str  = " получателя";
      end;
    end;

    // Проверить счет
    if( СчетСуществуетИОткрыт( FIID, Account, Chapter ) )

      // Если счет является счетом МФР
      if( PM_AccountIsMFR( Account, Chapter, FIID, false, err ) )
        note_text = err_text + "не может быть счетом МФР";
        msgbox( note_text );
        if( PaymentObj.Notes.AddNote( PM_NOTEKIND_DENIALGROUND, note_text ) != 0 )
          msgbox( "Ошибка при вставке примечания платежа" );
          return 1;
        end;
        return 0;
      end;
    else
      note_text = "Нельзя работать с закрытым счетом" + err_str;
      if( PaymentObj.Notes.AddNote( PM_NOTEKIND_DENIALGROUND, note_text ) != 0 )
        msgbox( "Ошибка при вставке примечания платежа" );
        return 1;
      end;
      return 0;
    end;

  end;

  if( ( Direct == OPR_PM_ST_DIR_IN ) or ( Direct == OPR_PM_ST_DIR_TRANZIT ) ) // Входящий или транзитный
    if( УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_CONTROL ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return 1;
    end;
  else

    if(  not IsSummaryPayment( PaymentObj ) )
      // Проверим счет на наличие признака "К"
      if( PM_CheckAccount_Type( Account, Chapter, FIID, "К" ) )
        note_text = err_text + "не может быть корреспондентским счетом";
        msgbox( note_text );
        if( PaymentObj.Notes.AddNote( PM_NOTEKIND_DENIALGROUND, note_text ) != 0 )
          msgbox( "Ошибка при вставке примечания платежа" );
          return 1;
        end;
        return 0;
      end;
    end;

    if( PaymentObj.StartDepartment == PaymentObj.EndDepartment )
      CABS_Segment = OPR_PM_ST_MFR_YES;
    else
      CABS_Segment = OPR_PM_ST_MFR_NO;
    end;
    if( PaymentObj.DocKind != PS_INRQ )
      if( УстановитьСтатусыПлатежа( OPR_PAYM_DO, OPR_PM_ST_ENTER, OPR_PAYM_CABS, CABS_Segment ) )
        msgbox("Ошибка при установке сегментов статуса экземпляра операции");
        return 1;
      end;
    end;
  end; 

  // Если все нормально - то снять признак необходимости ручной обработки
  if( УстановитьСтатусыПлатежа( OPR_PAYM_MANUAL, OPR_PAYM_ST_MANUAL_NOTNEED ) )
    msgbox("Ошибка при установке сегментов статуса экземпляра операции");
    return 1;
  end;

  // Очистить примечание
  if( PaymentObj.Notes.AddNote( PM_NOTEKIND_DENIALGROUND, note_text ) != 0 )
    msgbox( "Ошибка при вставке примечания платежа" );
    return 1;
  end;

  // Установить ToBackOffice
  return 0;
end;
