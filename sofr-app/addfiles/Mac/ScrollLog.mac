/*BPV просмотр лога миграции*/
import RSD;

const K_ENTER   = 13;
const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;


PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

var shift = 0, kind = 0, logid = -1;

macro Scroll
   var cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";

   macro EvProc2(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if ((cmd == DLG_KEY)and(key == K_ENTER))
        if (rs.RecCount > 0)
          return CM_SELECT;
        end;
     end;
     return CM_DEFAULT;
  end;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null;
//msgbox(key);
     if ((cmd == DLG_KEY)and(key == K_ENTER))
       /* if (rs.RecCount > 0)
          return CM_SELECT;
        end;*/
      elif ((cmd == DLG_KEY)and(key == K_F3))
         GetInt(shift,"Сдвиг логайд");
         cond = "";
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == K_F8))
         if (kind == 3) kind = -1; else kind = kind + 1; end;
         if (kind == -1) cond = ""; 
         else  cond = " and t_kind = " + kind; 
         end;
         if (logid > -1) cond = cond + " and t_kind = " + kind; end;
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == K_F9))
         cond = "";
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == 18))
         cond = "";
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == K_F2))
            var retval, cmd2 = " select to_char(t_logid) t_logid,t_objecttype from ( select t_logid, t_objecttype from user_cnvhlplogex where t_logid is not null group by t_logid,t_objecttype order by t_logid desc) ";
            cmd2 = RSDCommand(cmd2);
            var rs2 = RSDRecordset(cmd2 , null, RSDVAL_STATIC );

            if (RunScroll (rs2,2,null,"","EvProc2"))
               logid = rs2.value(0);
               shift = 0;
               cond = " and t_logid = " + logid;
            else
                cond = "";
            end;
         need = true;
         return 2;

      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   

   AddCol (col1, 0, "T_KIND",        "Вид",    3,  0,0);
   AddCol (col1, 1, "T_LINE",        "Строка",    5,  0,0);
   AddCol (col1, 2, "T_CONTEXT",     "Текст",    40, 0);
   AddCol (col1, 3, "T_OBJECTTYPE",  "Объект", 10, 1);
   AddCol (col1, 4, "T_EXTID",       "Внеш ID",        15, true,0);
   AddCol (col1, 5, "T_MISSID",      "Пропущенный ID",        15, true,0);
   AddCol (col1, 6, "T_MISSOBJTYPE", "Тип объекта пропущенного ID",        10, true);
   AddCol (col1, 7, "T_LOGID",       "LOGID",        5,  true,0);

   while (need)
      need = false;
      cmd1 = " select decode(t_kind,0, 'Ok',1,'Err',2,'Warn',3,'Skip') t_kind, to_char(t_line) t_line, t_context, to_char(t_objecttype) t_objecttype, "
              " to_char(t_extid) t_extid, to_char(t_missid) t_missid, t_missidobjtype, to_char(t_logid) t_logid  from user_cnvhlplogex where  ";

             if ( cond )
                cmd1 =  cmd1 + " 1 = 1 " + cond;
              else
                cmd1 =  cmd1 + " t_logid = (select max(t_logid)-"+shift+" from user_cnvhlplogex) ";
              end;
              cmd1 =  cmd1 + " order by t_logid desc";
      cmd1 = RSDCommand(cmd1);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );


      if (RunScroll (rs1,8, col1, "test" ,"EvProc","Лог миграции","F2 - выбрать logid  F3 - установить сдвиг logid ("+shift+")   F8 - сменить kind", true, 1, 1))
       //   return rs1;
      end;
   end;

return null;

end;

Scroll;
exit(1);