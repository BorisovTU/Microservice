/*******************************************************************************
 DESCRIPTION  :   Отчет "Расшифровка долговых ценных бумаг"
 PROGRAMMED BY:   Шайков В.Е.
 CREATION DATE:    **.**.****
*******************************************************************************/
IMPORT FIInter, "spCache.mac", "brokcheck_form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac","ws_txreportform.mac";
//import "sccomiss.mac", "spRepFun.mac"

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   brokcheck_Form;
PRIVATE VAR   brokcheck_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб
record RateRec(ratedef);

PRIVATE VAR ReportHeader = " \n"; 
                                                                                                                                                                                                                                                                                                                             
PRIVATE VAR TableHeader = " \n"; 

                                                                                                                                   
PRIVATE CLASS (DL_CReportTemplate) SP_brokcheck_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  PRIVATE VAR v_account = "";
  var RS;
  VAR Begin_RepDate, End_RepDate;
  var m_BegDate, m_EndDate;

  PRIVATE VAR v_BuyCost, v_BuyNKD, v_BuyTotalCost, v_SaleCost, v_SaleNKD, v_SaleTotalCost, v_ComS, v_ComB, v_FinRez;
  PRIVATE VAR v_s_BuyCost, v_s_BuyNKD, v_s_BuyTotalCost, v_s_SaleCost, v_s_SaleNKD, v_s_SaleTotalCost, v_s_ComS, v_s_ComB, v_s_FinRez;
  VAR PrevFI, PrevS;
  VAR ProgressValue = CTxProgressValue();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
/* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9)

     this.PrintTableLine( 

          /*1 */     "Date_period",           P1, null,        /*Период за который указываются данные в строке*/
          /*2 */     "Account",               P2, null,        /*Номер счета*/
          /*3 */     "FiCode",                P3, null,        /*Код валюты*/
          /*4 */     "Rest_In",               P4, null,        /*Остаток входящий*/
          /*5 */     "Rest_In_Rub",           P5, null,        /*Остаток входящий в рублях*/
          /*6 */     "DT",                    P6, null,        /*Оборот ДТ*/
          /*7 */     "KT",                    P7, null,        /*Оборот КТ*/
          /*8 */     "Rest_Out",              P8, null,        /*Остаток исходящий*/
          /*9 */     "Rest_Out_Rub",          P9, null         /*Остаток исходящий в рублях*/
       );      

  END;




  PRIVATE MACRO BeginReport()

    VAR AvrKindShowValue = "";

    this.SetActiveSheet( "Лист1" );
    m_BegDate   = brokcheck_Form.GetFieldValue( PNFLD_brokcheck_BEGINDATE );
    m_EndDate   = brokcheck_Form.GetFieldValue( PNFLD_brokcheck_ENDDATE );
	
    this.PrintFormatString( ReportHeader, "H0_1", m_BegDate,  
	                                  "H0_2", m_EndDate );
 


    this.RegisterTable( "MainTable", "",
          /*1 */     "Date_period",           /*Период за который указываются данные в строке*/
          /*2 */     "Account",               /*Номер счета*/
          /*3 */     "FiCode",                /*Код валюты*/
          /*4 */     "Rest_In",               /*Остаток входящий*/
          /*5 */     "Rest_In_Rub",           /*Остаток входящий в рублях*/
          /*6 */     "DT",                    /*Оборот ДТ*/
          /*7 */     "KT",                    /*Оборот КТ*/
          /*8 */     "Rest_Out",              /*Остаток исходящий*/
          /*9 */     "Rest_Out_Rub"          /*Остаток исходящий в рублях*/
       );      

  END;

  MACRO ПечататьПромежуточныеИтоги() END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     ПечататьПромежуточныеИтоги();
  END;      
  
  PRIVATE MACRO ConvertSum(Sum, Currency, Commdate)
     var RetVal;
     if(Currency != NATCUR)
	SmartConvertSumDbl(RetVal, Sum, Commdate, Currency, NATCUR, false);
	return RetVal;
     else
        return Sum;
     end;
  END;
  
  PRIVATE MACRO Get_Rests(account, fiid, start_date, end_date, chapter)
    var Rests = TArray;
    var query, Data, sql;	
    sql = "SELECT ";
    if (fiid == 0)
       sql = sql + "Rsb_Account.Resta('" + account + "', " + GetSQLDate(start_date - 1) + ", " + chapter + ", " + fiid + ") as rest_in, ";                                       //account, start_date-1,  chapter, fiid
       sql = sql + "Rsb_Account.Debeta('" + account + "', " + chapter + ", " + GetSQLDate(start_date) + ", " + GetSQLDate(end_date) + ", " + fiid + ") as DT, ";                 //account, chapter, start_date, end_date, fiid
       sql = sql + "Rsb_Account.Kredita('" + account + "', " + chapter + ", " + GetSQLDate(start_date) + ", " + GetSQLDate(end_date) + ", " + fiid + ") as KT, ";                //account, chapter, start_date, end_date, fiid
       sql = sql + "Rsb_Account.Resta('" + account + "', " + GetSQLDate(end_date) + ", " + chapter + ", " + fiid + ") as rest_out ";                                             //account, end_date, chapter, fiid
    else
       sql = sql + "Rsb_Account.Restac('" + account + "', " + fiid + ", " + GetSQLDate(start_date - 1) + ", " + chapter + ", " + fiid + ") as rest_in, ";                        //account, fiid счета, start_date-1, chapter, fiid остатка       
       sql = sql + "Rsb_Account.Debetac('" + account + "', " + chapter + ", " + fiid + ", " + GetSQLDate(start_date) + ", " + GetSQLDate(end_date) + ", " + fiid + ") as DT, ";  //account, chapter, fiid счета, start_date, end_date, fiid суммы
       sql = sql + "Rsb_Account.Kreditac('" + account + "', " + chapter + ", " + fiid + ", " + GetSQLDate(start_date) + ", " + GetSQLDate(end_date) + ", " + fiid + ") as KT, "; //account, chapter, fiid счета, start_date, end_date, fiid суммы
       sql = sql + "Rsb_Account.Restac('" + account + "', " + fiid + ", " + GetSQLDate(end_date) + ", " + chapter + ", " + fiid + ") as rest_out ";                              //account, end_date, chapter, fiid
    end;
    sql = sql + "FROM dual";
    query = DL_RSDCommand(sql);
    Data = query.execute(); 
    if (Data.MoveNext)
      Rests[0] = data.rest_in;
      if (fiid == 0)
         Rests[1] = data.rest_in;
      else
         Rests[1] = ConvertSum(data.rest_in, fiid, start_date - 1) ;
      end;
      Rests[2] = data.DT;
      Rests[3] = data.KT;
      Rests[4] = data.rest_out;
      if (fiid == 0)
         Rests[5] = data.rest_out;
      else
         Rests[5] = ConvertSum(data.rest_out, fiid, end_date);
      end;
    end;

    return Rests;
  END;

  PRIVATE MACRO Get_FIIDCode(fiid)
    if (fiid == 0)
       return "810";
    elif (fiid == 7)
       return "840";
    elif (fiid == 8)
       return "978";
    elif (fiid == 19)
       return "756";
    elif(fiid == 20)
       return "826";
    else
       return "-1";
    end;
  END;

  PRIVATE MACRO Last_Day(date)
     var sql, data;
     sql = DL_RSDCommand("select last_day(?) as last_day from dual");
     sql.AddParam(date);
     data = sql.Execute();
     if (data.Movenext())
       return data.last_day;
     end;
     return -1;
  END;
             
  PRIVATE MACRO Create()

     VAR dl_leg      = TRecHandler( "dl_leg.dbt" );

     var  /*1 */     Date_period:string,
          /*2 */     Account = "",
          /*3 */     FiCode = "",
          /*4 */     Rest_In:money = $0,
          /*5 */     Rest_in_rub:money = $0,
          /*6 */     DT:money = $0,
          /*7 */     KT:money = $0,
          /*8 */     Rest_Out:money = $0,
          /*9 */     Rest_Ount_Rub:money = $0;
	 
     VAR DataQuery;
     VAR RetVal;
     VAR Rests = TArray;   
     var start_date:date, end_date:date;
       
     brokcheck_Form.GetFieldValue( PNFLD_brokcheck_BEGINDATE, @Begin_RepDate );
     brokcheck_Form.GetFieldValue( PNFLD_brokcheck_ENDDATE, @End_RepDate );

     DataQuery = "select distinct acc.t_account,                                                                                                                                " +
                 "t_code_currency as acc_fiid,                                                                                                                                  " +
                 "acc.t_chapter                                                                                                                                                 " +
                 "from daccount_dbt acc, dmcaccdoc_dbt doc, dsfcontr_dbt contr, dparty_dbt party where 1=1                                                                      " +
                 "and PARTY.T_PARTYID = contr.t_partyid                                                                                                                         " +
                 "and contr.t_id = doc.t_clientcontrid                                                                                                                          " +
                 "and doc.t_account = acc.t_account                                                                                                                             " +  
                 "and party.t_legalform = 2                                                                                                                                     " +  //физические лица
                 "and party.t_notresident <> 'X'                                                                                                                                " +  //резиденты
                 "and contr.t_servkind = 1                                                                                                                                      " +  //договора фондового рынка
                 "and contr.t_servkindsub = 8                                                                                                                                   " +
                 "and acc.t_balance = 30601                                                                                                                                     " ;   //счета 30601*                 
     
     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;
     
     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Идет расчет данных\"" , HTML_StSheetName);
     end;

     RS = TRsbDataSet( DataQuery );
     while( RS.MoveNext() )
        start_date = Begin_RepDate;
        end_date = Last_Day(start_date + 80);
        while (end_date <= End_RepDate)
          Rests = Get_Rests(rs.Account, rs.acc_fiid, start_date, end_date, rs.chapter);
          m_IsDataExist = true;              
          PrintLine( 
          /*1 */     Date_period = start_date + " - " + end_date,
          /*2 */     Account = rs.account,
          /*3 */     FiCode = Get_FIIDCode(rs.acc_fiid),
          /*4 */     Rest_In = round(Rests[0], 2),
          /*5 */     Rest_in_rub =round(Rests[1], 2),
          /*6 */     DT = round(Rests[2], 2),
          /*7 */     KT = round(Rests[3], 2),
          /*8 */     Rest_Out = round(Rests[4], 2),
          /*9 */     Rest_Ount_Rub = round(Rests[5], 2)
          );
          start_date = end_date + 1;
          end_date = Last_Day(start_date + 80);
        end;
        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;
     ProgressIndicator.Stop();

  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  brokcheck_Form = DL_brokcheck_Panel();

  stat = brokcheck_Form.Run();

  if( stat )
      brokcheck_Report = SP_brokcheck_Report( null, "Report_brokcheck.xlsx", null, IsWebService, ReportHashCode );
      brokcheck_Report.Run();

      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

  return FullReportFileNames;
END;
