import rsd, "or_rep_h.mac";

PRIVATE var mode;

IF(NOT GetInt(mode, "ÇÎ°•‡®‚• ‡•¶®¨ ‡†°Æ‚Î: \n"
                    " 0 - í•·‚Æ¢Î© ‡•¶®¨. àß¨•≠•≠®Ô ≠• ¢≠Æ·Ô‚·Ô ¢ ÅÑ                                                     \n"
                    " 1 - ê•¶®¨ · ‰®™·†Ê®•© Ø‡® Æ‚·„‚·‚¢®® ÆË®°Æ™                                                        \n"
                    " 2 - ê•¶®¨ · ‰®™·†Ê®•© „·Ø•Ë≠ÎÂ ®ß¨•≠•≠®©. Ç·• ß†Ø®·®, ØÆØ†§†ÓÈ®• ØÆ§ „·´Æ¢®• Æ‚°Æ‡†, °„§„‚ „§†´•≠Î.\n" 
                    "     é°≠Æ¢´•≠≠Î• °•ß ÆË®°Æ™ ß†Ø®·® °„§„‚ ¢·‚†¢´•≠Î ¢ ÅÑ. á†Ø®·® · ÆË®°™†¨® ‚‡•°„•‚·Ô ¢¢•·‚® ¢‡„Á≠„Ó \n"
                    " 3 - é‚™†‚ ß†‰®™·®‡Æ¢†≠≠ÎÂ ®ß¨•≠•≠®©                                                                "))
  exit(1);
END;

IF (mode == 0)
  println("!!!í•·‚Æ¢Î© ‡•¶®¨!!!");
ELIF (mode == 1)
  println("!!!ê•¶®¨ · ‰®™·†Ê®•© Ø‡® Æ‚·„‚·‚¢®® ÆË®°Æ™!!!");
ELIF (mode == 2)
  println("!!!ê•¶®¨ · ‰®™·†Ê®•© „·Ø•Ë≠ÎÂ ®ß¨•≠•≠®©!!!");
ELIF (mode == 3)
  println("!!!é‚™†‚ ®ß¨•≠•≠®©!!!");
ELSE
  println("ç•¢•‡≠Æ• ß≠†Á•≠®• Ø†‡†¨•‚‡† \"mode\"");
  return;
END;

PRIVATE VAR BulkInsertExceptionsLogging = "WHEN dml_errors THEN "
                                        + "  :errCount := SQL%BULK_EXCEPTIONS.COUNT; "
                                        + "  :tran_id := dbms_transaction.local_transaction_id; "
                                        + "  FOR i IN 1..SQL%BULK_EXCEPTIONS.COUNT "
                                        + "  LOOP "
                                        + "    bad_stmt_no := SQL%BULK_EXCEPTIONS(i).ERROR_INDEX; "
                                        + "    err_rec := objatcor_ins(bad_stmt_no); "
                                        + "    BEGIN "
                                        + "      pt_code := ''; "
                                        + "      SELECT t_code INTO pt_code "
                                        + "        FROM dobjcode_dbt "
                                        + "       WHERE t_ObjectType = 3 AND t_CodeKind = 1 AND t_ObjectId = err_rec.t_Object AND ROWNUM = 1; "
                                        + "    END; "
                                        + "    BEGIN "
                                        + "      attr_name := ''; "
                                        + "      SELECT t_name INTO attr_name "
                                        + "        FROM dobjattr_dbt "
                                        + "       WHERE t_ObjectType = 3 AND t_GroupId = err_rec.T_GROUPID AND t_attrid = err_rec.T_ATTRID; "
                                        + "    END; "
                                        + "    error_message := 'éË®°™† Ø‡® ¢·‚†¢™• ß≠†Á•≠®Ô \"' || attr_name || '\" ™†‚•£Æ‡®® ¸'|| err_rec.t_GroupId || ' §´Ô ·„°Í•™‚† \"' || pt_code || '\" ≠† §†‚„ ' || TO_CHAR( err_rec.T_VALIDFROMDATE, 'dd.mm.yyyy') || CHR(10) "
                                        + "                     || 'Ç·‚†¢´Ô•¨†Ô ß†Ø®·Ï: (T_OBJECTTYPE, T_GROUPID, T_ATTRID, T_OBJECT, T_GENERAL, T_VALIDFROMDATE, T_OPER, T_VALIDTODATE, T_SYSDATE, T_SYSTIME, T_ISAUTO, T_ID ):'|| CHR(10) "
                                        + "                     || '                    ('|| err_rec.T_OBJECTTYPE ||', ' "
                                        + "                                               || err_rec.T_GROUPID ||', ' "
                                        + "                                               || err_rec.T_ATTRID ||', ' "
                                        + "                                               || '''' || err_rec.T_OBJECT ||''', ' "
                                        + "                                               || CASE err_rec.T_GENERAL WHEN 'X'THEN '''X''' ELSE 'CHR(0)' END ||', ' "
                                        + "                                               || '''' || err_rec.T_VALIDFROMDATE ||''', ' "
                                        + "                                               || err_rec.T_OPER ||', ' "
                                        + "                                               || '''' || err_rec.T_VALIDTODATE ||''', ' "
                                        + "                                               || '''' || err_rec.T_SYSDATE ||''', ' "
                                        + "                                               || '''' || err_rec.T_SYSTIME ||''', ' "
                                        + "                                               || CASE err_rec.T_ISAUTO WHEN 'X'THEN '''X''' ELSE 'CHR(0)' END ||', ' "
                                        + "                                               || err_rec.T_ID || ')' || CHR(10) "
                                        + "                     || SQLERRM(-(SQL%BULK_EXCEPTIONS(i).ERROR_CODE)); "
                                        + "    IT_LOG.Log(error_message, IT_LOG.C_MSG_TYPE__ERROR); "
                                        + "  END LOOP; ";

PRIVATE VAR query = " DECLARE "
                  + "   TYPE objatcor_t IS TABLE OF dobjatcor_dbt%ROWTYPE; "
                  + "     objatcor_ins   objatcor_t; "
                  + "     objatcor_old   objatcor_t; "
                  + "     error_message  itt_log.msg%TYPE; "
                  + "     bad_stmt_no    PLS_INTEGER; "
                  + "     dml_errors     EXCEPTION; "
                  + "     err_rec        dobjatcor_dbt%ROWTYPE;"
                  + "     pt_code        dobjcode_dbt.t_Code%TYPE; "
                  + "     attr_name      dobjattr_dbt.t_Name%Type; "
                  + "     PRAGMA EXCEPTION_INIT(dml_errors, -24381); "
                  + "   BEGIN "
                  + "     SELECT at1.t_ObjectType, "
                  + "            at1.t_GroupId, "
                  + "            at1.t_AttrId, "
                  + "            at1.t_Object, "
                  + "            at1.t_General, "
                  + "            at1.t_ValidFromDate, "
                  + "            at1.t_Oper, "
                  + "            CASE "
                  + "               WHEN at1.t_isLast = 1 "
                  + "               THEN "
                  + "                  NVL ( "
                  + "                     (SELECT MIN (at2.t_ValidFromDate) - 1 "
                  + "                        FROM dobjatcor_dbt at2 "
                  + "                       WHERE     at1.t_isLast = 1 "
                  + "                             AND at2.t_ObjectType = 3 "
                  + "                             AND at2.t_Object = at1.t_Object "
                  + "                             AND at2.t_GroupId = at1.t_GroupId "
                  + "                             AND at2.t_ValidFromDate > TO_DATE ('01.09.2022', 'DD.MM.YYYY')), "
                  + "                     TO_DATE ('31.12.9999', 'DD.MM.YYYY')) "
                  + "               ELSE "
                  + "                  at1.t_ValidToDate "
                  + "            END, "
                  + "            at1.t_SysDate, "
                  + "            at1.t_SysTime, "
                  + "            at1.t_IsAuto, "
                  + "            at1.t_Id "
                  + "       BULK COLLECT INTO objatcor_ins "
                  + "       FROM (SELECT t_ObjectType, "
                  + "                    CASE t_GroupId "
                  + "                       WHEN 205 THEN 201 "
                  + "                       WHEN 204 THEN 202 "
                  + "                       WHEN 210 THEN 204 "
                  + "                       WHEN 202 THEN 205 "
                  + "                       WHEN 209 THEN 206 "
                  + "                       WHEN 201 THEN 207 "
                  + "                       WHEN 211 THEN 208 "
                  + "                       WHEN 208 THEN 209 "
                  + "                       WHEN 207 THEN 210 "
                  + "                       WHEN 206 THEN 211 "
                  + "                    END "
                  + "                      t_GroupId, "
                  + "                    t_AttrId, "
                  + "                    t_Object, "
                  + "                    t_General, "
                  + "                    t_ValidFromDate, "
                  + "                    t_Oper, "
                  + "                    t_ValidToDate, "
                  + "                    t_SysDate, "
                  + "                    t_SysTime, "
                  + "                    t_IsAuto, "
                  + "                    t_Id, "
                  + "                    CASE "
                  + "                       WHEN t_ValidToDate = MAX (t_ValidToDate) OVER (PARTITION BY t_ObjectType, t_GroupId, t_Object) THEN 1 "
                  + "                       ELSE 0 "
                  + "                    END "
                  + "                       t_isLast "
                  + "               FROM dobjatcor_dbt "
                  + "              WHERE     t_ObjectType = 3 "
                  + "                    AND t_GroupId IN (205,204,210,202,209,201,211,208,207,206) "
                  + "                    AND t_ValidFromDate <= TO_DATE ('01.09.2022', 'DD.MM.YYYY')) at1; "
                  + "     :recCount := objatcor_ins.Count(); "
                  + "     IF objatcor_ins.Count() > 0 THEN "
                  + "       FORALL i IN objatcor_ins.FIRST .. objatcor_ins.LAST "
                  + "       DELETE FROM dobjatcor_dbt "
                  + "        WHERE t_Id = objatcor_ins(i).t_Id "
                  + "       RETURNING t_ObjectType,t_GroupId, t_AttrId, t_Object, t_General, t_ValidFromDate, t_Oper, t_ValidToDate, t_SysDate, t_SysTime, t_IsAuto, t_Id "
                  + "       BULK COLLECT INTO objatcor_old; ";

PRIVATE VAR bck_ins = "     FORALL i IN objatcor_old.FIRST .. objatcor_old.LAST "
                    + "     INSERT INTO upd_dobjatcor_dbt "
                    + "          VALUES objatcor_old(i); ";

PRIVATE VAR query_end = "   FORALL i IN objatcor_ins.FIRST .. objatcor_ins.LAST "
                      + "   SAVE EXCEPTIONS "
                      + "   INSERT INTO dobjatcor_dbt "
                      + "        VALUES objatcor_ins(i); "
                      + " END IF; "
                      + " EXCEPTION "
                      + BulkInsertExceptionsLogging
                      + " END; ";

PRIVATE VAR BackupQuery = " DECLARE "
                        + "   TYPE upd_objatcor_t IS TABLE OF upd_dobjatcor_dbt%ROWTYPE; "
                        + "   objatcor_ins    upd_objatcor_t; "
                        + "   error_message   itt_log.msg%TYPE; "
                        + "   bad_stmt_no     PLS_INTEGER; "
                        + "   dml_errors      EXCEPTION; "
                        + "   err_rec         dobjatcor_dbt%ROWTYPE;"
                        + "   pt_code         dobjcode_dbt.t_Code%TYPE; "
                        + "   attr_name       dobjattr_dbt.t_Name%Type; "
                        + "   PRAGMA EXCEPTION_INIT (dml_errors, -24381); "
                        + " BEGIN "
                        + "   SELECT * "
                        + "     BULK COLLECT INTO objatcor_ins "
                        + "     FROM upd_dobjatcor_dbt; "
                        + "   IF objatcor_ins.COUNT () > 0 "
                        + "   THEN "
                        + "      FORALL i IN objatcor_ins.FIRST .. objatcor_ins.LAST "
                        + "         DELETE FROM dobjatcor_dbt "
                        + "               WHERE t_Id = objatcor_ins (i).t_Id; "
                        + "      FORALL i IN objatcor_ins.FIRST .. objatcor_ins.LAST SAVE EXCEPTIONS "
                        + "         INSERT INTO dobjatcor_dbt "
                        + "              VALUES objatcor_ins (i); "
                        + "   END IF; "
                        + " EXCEPTION "
                        + BulkInsertExceptionsLogging
                        + " END; ";


PRIVATE VAR ErrMsgTableHead = "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"
                              "≥ ¸ ÆË®°™® ≥ í•™·‚ ÆË®°™®                                                                                                                                                 ≥\n"
                              "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

RslDefCon.BeginTrans();

PRIVATE VAR recCount, errCount, tran_id, Rep, i = 1;
PRIVATE VAR cmd, rs;

IF(mode == 3)
  cmd = RSDCommand("select 1 FROM upd_dobjatcor_dbt");
  rs = RSDRecordSet(cmd);
  IF(rs.MoveNext())
    cmd = RSDCommand(BackupQuery);
    cmd.AddParam("errCount", RSDBP_OUT, V_INTEGER);
    cmd.AddParam("tran_id", RSDBP_OUT, V_STRING, 33);
    cmd.Execute();

    errCount = cmd.Value("errCount");
    tran_id = cmd.Value("tran_id");
  ELSE
    println("ç•‚ §†≠≠ÎÂ §´Ô Æ‚™†‚†");
    errCount = 0;
  END;
ELSE
  IF((mode == 1) OR (mode == 2))
    cmd = RSDCommand("select 1 FROM upd_dobjatcor_dbt");
    rs = RSDRecordSet(cmd);
    IF(NOT rs.MoveNext())
      query = query + bck_ins;
    END;
  END;
  query = query + query_end;
  cmd = RSDCommand(query);
  cmd.AddParam("recCount", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("errCount", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("tran_id", RSDBP_OUT, V_STRING, 33);
  cmd.Execute();

  recCount = cmd.Value("recCount");
  errCount = cmd.Value("errCount");
  tran_id = cmd.Value("tran_id");

  println("é°‡†°Æ‚†≠Æ ß†Ø®·•©: " + recCount);
  println("éË®°Æ™: " + errCount);
END;

IF(errCount > 0)
  Rep = CMakeReport( ErrMsgTableHead );

  cmd = RSDCommand("SELECT msg FROM itt_log WHERE tran_id = ?");
  cmd.AddParam("", RSDBP_IN, tran_id);
  rs = RSDRecordSet(cmd);

  WHILE(rs.MoveNext())
    Rep.AddPrintCell(i);
    Rep.AddPrintCell(rs.Value("msg"));
    Rep.AddStr();
    i = i + 1;
  END;

  Rep.PrintRep();
END;

IF(mode == 0)
  RslDefCon.RollbackTrans();
ELIF(mode == 1)
  IF(errCount > 0)
    println("é‚™†‚ ®ß¨•≠•≠®©");
    RslDefCon.RollbackTrans();
  ELSE
    RslDefCon.CommitTrans();
  END;
ELIF(mode == 2)
  RslDefCon.CommitTrans();
ELIF(mode == 3)
  IF(errCount > 0)
    println("ç• „§†´Æ·Ï Æ‚™†‚®‚Ï ®ß¨•≠•≠®Ô");
    RslDefCon.RollbackTrans();
  ELSE
    println("é‚™†‚ ¢ÎØÆ´≠•≠");
    cmd = RSDCommand("TRUNCATE TABLE upd_dobjatcor_dbt");
    cmd.Execute();
    RslDefCon.CommitTrans();
  END;
END;

OnError(err)
  println(err.Message);
  print("åÆ§„´Ï: "+err.Module);
  println(" ë‚‡Æ™†: "+err.line);
  IF(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  END;

