/*
$Name:               mtreverserecip.mac
$Module:             Срочные переводы
$Description:        Базовые процедуры проведения операции возврата срочного перевода
*/
import MTOperat;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtOperation ) TMtOpReverseRecipient( p_opNum, p_subOpNum, p_psId, p_transCode )

  private var opNum = p_opNum;
  private var subOpNum = p_subOpNum;
  private var psId = p_psId;
  private var transCode = p_transCode;

  private var vReferenc = 0;
  private var vAccount = "";
  private var vTypeAccount = "";
  private var vNeedCloseAccount = 0;

  if ( opNum == 0 )
    opNum = MTSUBOP_reverse_recip;
    subOpNum = 0;
  end;

  // =====================================================================
  macro startInit( )

    startInit( );

    opHistory.rec.opNum = opNum;
    opHistory.rec.subOpNum = subOpNum;
    opHistory.rec.isSentToCC = 0; // Информация подлежит передаче в КЦ

    return true;
  end;
   
  // =====================================================================
  macro finalInit( )

    opHistory.rec.stateBefore = transfer.rec.state;

    transfer.rec.state = "TO_BE_RETD"; // К возврату
    transfer.rec.action = D_UPDATE;

    opHistory.rec.stateAfter = transfer.rec.state;

    return true;
  end;

  // =====================================================================
  macro check( )

    var cmd;
    var rs;
    var stat = true;

    // Найдем перевод --------------------------------------------------
    cmd = RsdCommand( "select rmto_trans.t_branch as branch, " +
                             "rmto_trans.t_transId as transId " +
                      "from drmto_trans_dbt rmto_trans " +
                      "where rmto_trans.t_branch = :branch and " +
                            "rmto_trans.t_psId = :psId and " +
                            "rmto_trans.t_transCode = :transCode " +
                            "order by rmto_trans.t_sendDate desc" );

    rs = RsdRecordset( cmd );

    cmd.addParam( "branch", RSDBP_IN, NumFNcash( ) );
    cmd.addParam( "psId", RSDBP_IN, psId );
    cmd.addParam( "transCode", RSDBP_IN, transCode );

    cmd.execute( );

    if ( rs.moveNext( ) )
      stat = transfer.load( rs.value( "branch" ),  rs.value( "transId" ) );
      if ( not stat )
        PushErrorMessage( "Ошибка при загрузке срочного перевода с уникальным идентификатором " + String( rs.value( "transId" ) ) );
      end;
    else
      PushErrorMessage( "Не найден перевод c идентификатором \"" + transCode + "\"" );
    end;

    // Проверка признака "нашего" банка --------------------------------
    if ( stat )
      if ( transfer.rec.ourFlag != 0 )
        stat = false;
        PushErrorMessage( "Операция для перевода c идентификатором \"" + transfer.rec.transCode + "\" невозможна: перевод должен быть принят в не \"нашем\" банке" );
      end;
    end;

    // Проверим состояние операции -------------------------------------
    if ( stat )

      cmd = RsdCommand( "select * from drmtr_state_dbt rmtr_state " +
                        "where rmtr_state.t_psId = :psId and " +
                              "rmtr_state.t_stateCode = :stateCode and " +
                              "( rmtr_state.t_stateCode = 'ONSET_____' or " +
                                "rmtr_state.t_equivalentCode = 'ONSET_____' )" );

      rs = RsdRecordset( cmd );

      cmd.addParam( "psId", RSDBP_IN, transfer.rec.psId );
      cmd.addParam( "stateCode", RSDBP_IN, transfer.rec.state );

      cmd.execute( );

      if ( rs.moveNext( ) )
        ;
      else
        stat = false;
        PushErrorMessage( "Операция для перевода c идентификатором \"" + transfer.rec.transCode + "\" невозможна: перевод должен быть в состоянии \"К выплате\"" );
      end;
    end;

    return stat;
  end;

  // =====================================================================
  macro createDocuments( )

    var depositr = Tbfile( "depositr.dbt", "r", 8 );
    var doc;
    var stat = true;

    vReferenc = transfer.rec.accRef;
    vAccount = "";
    vTypeAccount = "";
    vNeedCloseAccount = 0;

    if ( system.rec.closeAccFlag != "" )
      vNeedCloseAccount = 1;
    end;

    if ( vReferenc != 0 )
      depositr.KeyNum = 8;
      depositr.Clear;
      depositr.rec.Referenc = vReferenc;

      stat = depositr.GetEQ( );

      if ( stat )
        vAccount = depositr.rec.Account;
        vTypeAccount = depositr.rec.Type_Account;
      else
        PushErrorMessage( "Счет вкладчика с референсом " + String( vReferenc ) + " не найден" );
      end;
    else
      stat = false;
      PushErrorMessage( "У перевода c идентификатором \"" + transfer.rec.transCode + "\" нет ссылки на счет вкладчика" );
    end;

    // Списание суммы перевода со служебного счета ---------------------
    if ( stat )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 1 );
      else
        doc = newDepDoc( 2 );
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_GET;
      doc.rec.InSum = 0;
      doc.rec.OutSum = transfer.rec.sum;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Списание при аннулировании срочного перевода";

      initClientInfoInDepDoc( doc, false );

      stat = docList.insert( doc );

      if ( not stat )
        PushErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Закрытие служебного счета ---------------------------------------
    if ( stat and ( vNeedCloseAccount == 1 ) )
      transfer.rec.accRef = 0;

      ; // Производится в транзакции функцией Выполнение_Операции( ... )
    end;

    return true;
  end;

  // =====================================================================
  macro postCarryTrnProc( ) : bool

    record operParm ( "oper_prm.1" );
    record depDoc ( sbdepdoc );

    var stat = true;

    if ( stat and ( vNeedCloseAccount == 1 ) )

      ClearRecord( operParm );
      ClearRecord( depDoc );

      operParm.Account = vAccount;
      operParm.Type_Account = vTypeAccount;
      operParm.Code_Currency = transfer.rec.curCode;
      operParm.Type_Oper = 63;
      operParm.Show_Panel = 0;
      operParm.UseMaxDate = 1;
      operParm.NoPrint = 1;
      operParm.TypeComplexOper = 81;

      depDoc.Referenc = vReferenc;
      if ( transfer.rec.curCode == 0 )
        depDoc.IsCur = 0;
      else
        depDoc.IsCur = 1;
      end;
      depDoc.FNCash = NumFNcash( );
      depDoc.RealFNCash = NumFNcash( );
      depDoc.Account = vAccount;
      depDoc.Oper = {oper};
      depDoc.Type_Account = vTypeAccount;
      depDoc.Code_Currency = transfer.rec.curCode;
      depDoc.CodClient = transfer.rec.recPartyID;
      depDoc.FlagRezid = StrFor( transfer.rec.recNotResident );
      depDoc.YesSbook = "X";
      depDoc.Date_Document = {curdate};
      depDoc.DepDate_Document = {curdate};
      depDoc.TypeOper = 63;
      depDoc.TypeComplexOper = 81;
      depDoc.IsControl = StrFor( 1 );
      SetBitFlag( depDoc.Flags2, 7, 1 ); // BIT_FLAG2_MONTRANS
      depDoc.Ground = "Закрытие служебного счета после выдачи перевода";

      if ( Выполнение_Операции( operParm, depDoc ) != 0 )
        stat = false;
      end;
    end;

    return stat;
  end;

  // =====================================================================
  macro runPanel( )

    setFlagOperationPanel( false );

    return true;
  end;

  // =====================================================================
  macro errorMessage( )
    ;
  end;

  // =====================================================================
  InitTMtOperation( p_psId );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro createInstance ( opNum, subOpNum, psId )

  var opReverseRecipient = TMtOpReverseRecipient( opNum, subOpNum, psId, "" ); 

  return opReverseRecipient;
end;
