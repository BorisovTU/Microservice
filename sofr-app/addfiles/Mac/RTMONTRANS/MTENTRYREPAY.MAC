import MTOperat;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtOperation ) TMtOpEntryRepay( p_opNum, p_subOpNum, p_psId, p_transCode )

  private var opNum = p_opNum;
  private var subOpNum = p_subOpNum;
  private var psId = p_psId;
  private var transCode = p_transCode;

  if ( opNum == 0 )
    opNum = MTOP_entry;
    subOpNum = MTSUBOP_entry_repay;
  end;

  // =====================================================================
  macro startInit( )

    startInit( );

    opHistory.rec.opNum = opNum;
    opHistory.rec.subOpNum = subOpNum;
    opHistory.rec.isSentToCC = 1; // В КЦ передавать не надо

    return true;
  end;

  // =====================================================================
  macro finalInit( )

    opHistory.rec.stateBefore = transfer.rec.state;

    transfer.rec.state = "TO_BE_RETD";
    transfer.rec.action = D_UPDATE;

    opHistory.rec.stateAfter = transfer.rec.state;

    return true;
  end;

  // =====================================================================
  macro check( )

    var cmd;
    var rs;
    var stat = false;

    // Найдем перевод --------------------------------------------------
    cmd = RsdCommand( "select rmto_trans.t_branch as branch, " +
                             "rmto_trans.t_transId as transId " +
                      "from drmto_trans_dbt rmto_trans " +
                      "where rmto_trans.t_branch = :branch and " +
                            "rmto_trans.t_psId = :psId and " +
                            "rmto_trans.t_transCode = :transCode " +
                            "order by rmto_trans.t_sendDate desc" );

    rs = RsdRecordset( cmd );

    cmd.addParam( "branch", RSDBP_IN, NumFNcash( ) );
    cmd.addParam( "psId", RSDBP_IN, psId );
    cmd.addParam( "transCode", RSDBP_IN, transCode );

    cmd.execute( );

    if ( rs.moveNext( ) )
      stat = transfer.load( rs.value( "branch" ),  rs.value( "transId" ) );
      if ( not stat )
        PushErrorMessage( "Ошибка при загрузке срочного перевода с уникальным идентификатором " + String( rs.value( "transId" ) ) );
      end;
    else
      PushErrorMessage( "Не найден перевод c идентификатором \"" + transCode + "\"" );
    end;

    return stat;
  end;

  // =====================================================================
  macro createDocuments( )

    var depositr = Tbfile( "depositr.dbt", "r", 4 );
    var doc;
    var stat = true;
    var cmd, rs;

    var vReferenc = 0;
    var vAccount = "";
    var vTypeAccount = "";
    var vNeedOpenAccount = 0;
    var vNeedCloseAccount = 0;
    var clientForDepAcc = defCodeServiceClient( true );

    if ( clientForDepAcc == 0 )
      clientForDepAcc = transfer.rec.senderPartyID;
    end;

    // Определим вид вклада и прочие параметры -------------------------
    vTypeAccount = determineTypeAccount( false, transfer.rec.curCode );

    if ( system.rec.closeAccFlag == "" )
      cmd = RSDCommand( "select depositr.t_Account as Account, depositr.t_Referenc as Referenc "
                        "from ddepositr_dbt depositr "
                        "where depositr.t_CodClient = ? and "
                              "depositr.t_FNCash = ? and "
                              "depositr.t_Open_Close = chr( 0 ) and "
                              "depositr.t_Type_Account = ? and "
                              "depositr.t_Code_Currency = ? and "
                              "depositr.t_Action != 2 "
                        "order by depositr.t_CodClient" );
                                  
      cmd.addParam( "CodClient", RSDBP_IN, clientForDepAcc );
      cmd.addParam( "FNCash", RSDBP_IN, transfer.rec.branch );
      cmd.addParam( "Type_Account", RSDBP_IN, vTypeAccount );
      cmd.addParam( "Code_Currency", RSDBP_IN, transfer.rec.curCode );

      rs = RsdRecordSet( cmd );

      cmd.Execute( );

      if ( rs.moveNext )
        vAccount = rs.value( "Account" );
        vReferenc = rs.value( "Referenc" );
      else
        vAccount = "";
      end;
    end;

    if ( system.rec.closeAccFlag != "" )
      vNeedOpenAccount = 1;
      vNeedCloseAccount = 1;
    else
      vNeedCloseAccount = 0;

      if ( vAccount != "" )
        vNeedOpenAccount = 0;
      else
        vNeedOpenAccount = 1;
      end;
    end;

    // Если нужно открыть вкладной счет, откроем его -------------------
    if ( vNeedOpenAccount == 1 )
      depositr.Clear;
      depositr.rec.Type_Account  = vTypeAccount;
      depositr.rec.Code_Currency = transfer.rec.curCode;
      depositr.rec.CodClient     = clientForDepAcc;
      depositr.rec.Open_Date     = transfer.rec.sendDate;
      if ( depositr.rec.Open_Date == Date( 0, 0, 0 ) )
        depositr.rec.Open_Date = {curdate};
      end;

      if ( НовыйСчетБезДокументов( depositr, 1 ) != 0 )
        stat = false;
        PushErrorMessage( "Ошибка при создании нового счета вкладчика \"" + vTypeAccount + "\"" );
      else
        vReferenc = depositr.rec.Referenc;
        vAccount = depositr.rec.Account;
      end;
    end;

    if ( stat )
      transfer.rec.accRef = vReferenc;
    end;

    // Списание суммы перевода со служебного счета ---------------------
    if ( stat )
      if ( vNeedOpenAccount == 1 )
        if ( transfer.rec.curCode == 0 )
          doc = newDepDoc( 1 );
        else
          doc = newDepDoc( 2 );
        end;
      else
        if ( transfer.rec.curCode == 0 )
          doc = newDepDoc( 3 );
        else
          doc = newDepDoc( 4 );
        end;
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_PUT;
      doc.rec.InSum = transfer.rec.sum;
      doc.rec.OutSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Поступление для возврата срочного перевода";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        PushErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Возврат комиссии из КЦ ------------------------------------------
    if ( stat and ( transfer.rec.returnCS_CC > transfer.rec.returnCS_Client ) and ( transfer.rec.returnCS_CC > 0 ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 5 );
      else
        doc = newDepDoc( 6 );
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_PUT;
      doc.rec.InSum = transfer.rec.returnCS_CC;
      doc.rec.OutSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Возврат комиссии из КЦ";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        PushErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Комиссия НБ -----------------------------------------------------
    if ( stat and ( transfer.rec.returnCS_CC > transfer.rec.returnCS_Client ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 7 );
      else
        doc = newDepDoc( 8 );
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_GET;
      doc.rec.InSum = 0;
      doc.rec.OutSum = transfer.rec.returnCS_CC - transfer.rec.returnCS_Client;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Комиссия НБ";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        PushErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Возврат комиссии отправителю ------------------------------------
    if ( stat and ( transfer.rec.returnCS_CC < transfer.rec.returnCS_Client ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 9 );
      else
        doc = newDepDoc( 10 );
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_PUT;
      doc.rec.InSum = transfer.rec.returnCS_Client - transfer.rec.returnCS_CC;
      doc.rec.OutSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Возврат комиссии отправителю";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        PushErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Возврат комиссии из КЦ ------------------------------------------
    if ( stat and ( transfer.rec.returnCS_CC <= transfer.rec.returnCS_Client ) and ( transfer.rec.returnCS_CC > 0 ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 5 );
      else
        doc = newDepDoc( 6 );
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_PUT;
      doc.rec.InSum = transfer.rec.returnCS_CC;
      doc.rec.OutSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Возврат комиссии из КЦ";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        PushErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    return stat;
  end;
 
  // =====================================================================
  macro runPanel( )

    setFlagOperationPanel( false );

    return true;
  end;

  // =====================================================================
  macro errorMessage( )
    ;
  end;

  // =====================================================================
  InitTMtOperation( p_psId );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro createInstance ( opNum, subOpNum, psId )

  var opEntryRepay = TMtOpEntryRepay( opNum, subOpNum, psId, "" ); 

  return opEntryRepay;
end;
