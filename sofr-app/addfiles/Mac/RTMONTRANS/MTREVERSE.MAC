import MTOperat;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtOperation ) TMtOpReverse( p_opNum, p_subOpNum, p_psId )

  private var opNum = p_opNum;
  private var subOpNum = p_subOpNum;
  private var psId = p_psId;

  private var flagSentToCC = false;
  private var prevFieldValue;

  if ( opNum == 0 )
    opNum = MTOP_reverse;
    subOpNum = 0;
  end;

  // =====================================================================
  macro calcCommission( )

    return true;
  end;

  // =====================================================================
  macro enterWindowEventHandler( ev )

    var curPanel = operPanel.currentTab;
    var control = curPanel.getControl( "recBankCorrAccount" );

    if ( control != null )
      control.editable = false;
      control.focusable = false;

      curPanel.redraw( );
    end;

    control = curPanel.getControl( "recBankCode" );

    if ( control != null )
      control.editable = false;
      control.focusable = false;

      curPanel.redraw( );
    end;

    return true;
  end;

  // =====================================================================
  macro setFocusEventHandler( ev )

    var curControl = operPanel.getForm( MT_OPER_PANEL ).focusedControl;
    var curControlName = null;

    if ( curControl != null )
      curControlName = curControl.name;
    end;

    if ( StrUpr( curControlName ) == "ISRETURNCOMISS" )
      prevFieldValue = transfer.rec.isReturnComiss;
    end;

    return true;
  end;

  // =====================================================================
  macro postEventHandler( ev )

    var keyCode = ev.keyCode;
    var curPanel = operPanel.currentTab;
    var curControl = curPanel.focusedControl;
    var curControlName = null;

    if ( curControl != null )
      curControlName = curControl.name;
    else
      return true;
    end;

    if ( StrUpr( curControlName ) == "ISRETURNCOMISS" )
      if ( prevFieldValue != transfer.rec.isReturnComiss )
        if ( CodeFor( transfer.rec.isReturnComiss ) == 0 )
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).editable = false;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).focusable = false;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).editable = false;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).focusable = false;

          transfer.rec.returnCS_CC = 0;
          transfer.rec.returnCS_Client = 0;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).value = $0L;
        else
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).editable = true;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).focusable = true;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).editable = true;
          operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).focusable = true;
        end;

        operPanel.getForm( MT_OPER_PANEL ).redraw( );
      end;
    end;

    return true;
  end;

  // =====================================================================
  macro addUserKeyHandler

    var i;

    if ( operPanel.numForms > MT_OPER_PANEL )
      for ( i, 0, operPanel.getForm( MT_OPER_PANEL ).numControls - 1 )

        if ( operPanel.getForm( MT_OPER_PANEL ).getControl( i ).editable )
          operPanel.getForm( MT_OPER_PANEL ).getControl( i ).editable = false;
        end;
        operPanel.getForm( MT_OPER_PANEL ).getControl( i ).focusable = false;
      end;

      operPanel.getForm( MT_OPER_PANEL ).getControl( "isReturnComiss" ).focusable = true;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sum" ).focusable = true;

      if ( CodeFor( transfer.rec.isReturnComiss ) != 0 )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).editable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).focusable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).editable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).focusable = true;
      end;
    end;

    if ( operPanel.numForms > MT_PAYER_PANEL )
      for ( i, 0, operPanel.getForm( MT_PAYER_PANEL ).numControls - 1 )

        if ( operPanel.getForm( MT_PAYER_PANEL ).getControl( i ).editable )
          operPanel.getForm( MT_PAYER_PANEL ).getControl( i ).editable = false;
        end;
        operPanel.getForm( MT_PAYER_PANEL ).getControl( i ).focusable = false;
      end;

      operPanel.getForm( MT_PAYER_PANEL ).getControl( "name1" ).focusable = true; 
    end;

    if ( operPanel.numForms > MT_RECEIVER_PANEL )
      for ( i, 0, operPanel.getForm( MT_RECEIVER_PANEL ).numControls - 1 )

        if ( operPanel.getForm( MT_RECEIVER_PANEL ).getControl( i ).editable )
          operPanel.getForm( MT_RECEIVER_PANEL ).getControl( i ).editable = false;
        end;
        operPanel.getForm( MT_RECEIVER_PANEL ).getControl( i ).focusable = false;
      end;

      operPanel.getForm( MT_RECEIVER_PANEL ).getControl( "name1" ).focusable = true; 
    end;

    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.addEventHandler( RSB_EV_ENTER_WINDOW, r2m( this, "enterWindowEventHandler" ) );
      operPanel.getForm( MT_OPER_PANEL ).addEventHandler( RSB_EV_SET_FOCUS, r2m( this, "setFocusEventHandler" ) );
      operPanel.addEventHandler( RSB_EV_KEY_PRESSED, r2m( this, "postEventHandler" ) );
    end;
  end;

  // =====================================================================
  macro startInit( )

    var cmd;
    var rs;
    var stat = true;
    var rate, buyRate, sellRate;
    var rate2, buyRate2, sellRate2;

    startInit( );

    opHistory.rec.opNum = opNum;
    opHistory.rec.subOpNum = subOpNum;

    stat = transfer.select( NumFNcash( ), system.rec.psId );

    if ( stat )
      cmd = RsdCommand( "select * from drmto_op_dbt rmto_op " +
                        "where rmto_op.t_branch = :branch and " +
                              "rmto_op.t_transId = :transId and " +
                              "rmto_op.t_isSentToCC > 0 and " +
                              "rmto_op.t_action not in ( :action1, :action2 )" );

      rs = RsdRecordset( cmd );

      cmd.addParam( "branch", RSDBP_IN, transfer.rec.branch );
      cmd.addParam( "transId", RSDBP_IN, transfer.rec.transId );
      cmd.addParam( "action1", RSDBP_IN, D_DELETE );
      cmd.addParam( "action2", RSDBP_IN, D_STORN );

      cmd.execute( );

      if ( rs.moveNext( ) )
        flagSentToCC = true;
      end;
    end;

    if ( flagSentToCC )
      opHistory.rec.isSentToCC = 0; // Информация подлежит передаче в КЦ
    else
      opHistory.rec.isSentToCC = 1; // Информация не передается в КЦ
    end;

    // Рассчитаем суммы плат по умолчанию
    if ( stat )
      transfer.rec.returnCS_curCode = transfer.rec.curCode;
      transfer.rec.isReturnComiss = 1;

      if ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommis, rate, buyRate, sellRate ) )
        if ( rate == 0 )
          rate = buyRate = sellRate = 1.0;
        end;
      else
        rate = buyRate = sellRate = 1.0;
      end;

      if ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.returnCS_curCode, rate2, buyRate2, sellRate2 ) )
        if ( rate2 == 0 )
          rate2 = buyRate2 = sellRate2 = 1.0;
        end;
      else
        rate2 = buyRate2 = sellRate2 = 1.0;
      end;

      transfer.rec.returnCS_Client = Floor( MoneyL( ( transfer.rec.sumCommisOur + transfer.rec.sumCommisCC ) * rate / rate2 ) );

      transfer.rec.returnCS_CC = Floor( MoneyL( transfer.rec.sumCommisCC * rate / rate2 ) );

      if ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommisAdd, rate, buyRate, sellRate ) )
        if ( rate == 0 )
          rate = buyRate = sellRate = 1.0;
        end;
      else
        rate = buyRate = sellRate = 1.0;
      end;

      transfer.rec.returnCS_Client = transfer.rec.returnCS_Client + Floor( MoneyL( ( transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis ) * rate / rate2 ) );

      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).value = transfer.rec.returnCS_Client - transfer.rec.returnCS_CC;

      if ( operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).value < 0 )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).value = 0;
      end;
    end;

    if ( stat )
      addUserKeyHandler( );
    end;

    return stat;
  end;

  // =====================================================================
  macro finalInit( )

    opHistory.rec.stateBefore = transfer.rec.state;

    /*
    if ( flagSentToCC )
      transfer.rec.state = "REQ_RETURN"; // Отправитель пожелал аннулировать свой перевод, но КЦ еще не подтвердил возможность аннулирования
    else
      transfer.rec.state = "TO_BE_RETD"; // Перевод подлежит возврату отправителю
    end;
    */
    transfer.rec.state = "TO_BE_RETD"; // Перевод подлежит возврату отправителю

    transfer.rec.action = D_UPDATE;

    opHistory.rec.stateAfter = transfer.rec.state;

    return true;
  end;

  // =====================================================================
  macro check( )

    var cmd;
    var rs;
    var stat = true;

    // Проверим состояние операции -------------------------------------
    if ( stat )
      cmd = RsdCommand( "select * from drmtr_state_dbt rmtr_state " +
                        "where rmtr_state.t_psId = :psId and " +
                              "rmtr_state.t_stateCode = :stateCode and " +
                              "( rmtr_state.t_stateCode = 'ONSET_____' or " +
                                "rmtr_state.t_equivalentCode = 'ONSET_____' or " +
                                "rmtr_state.t_stateCode = 'RECEIVED__' or " +
                                "rmtr_state.t_equivalentCode = 'RECEIVED__' )" );

      rs = RsdRecordset( cmd );

      cmd.addParam( "psId", RSDBP_IN, transfer.rec.psId );
      cmd.addParam( "stateCode", RSDBP_IN, transfer.rec.state );

      cmd.execute( );

      if ( rs.moveNext( ) )
        ;
      else
        stat = false;

        cmd = RsdCommand( "select * from drmto_op_dbt rmto_op " +
                          "where rmto_op.t_branch = :branch and " +
                                "rmto_op.t_transId = :transId and " +
                                "rmto_op.t_opNum in ( :opNum1, :opNum2 ) and " +
                                "rmto_op.t_isSentToCC > 0 and " +
                                "rmto_op.t_action not in ( :action1, :action2 )" );

        rs = RsdRecordset( cmd );

        cmd.addParam( "branch", RSDBP_IN, transfer.rec.branch );
        cmd.addParam( "transId", RSDBP_IN, transfer.rec.transId );
        cmd.addParam( "opNum1", RSDBP_IN, MTOP_send );
        cmd.addParam( "opNum2", RSDBP_IN, MTOP_send_dep );
        cmd.addParam( "action1", RSDBP_IN, D_DELETE );
        cmd.addParam( "action2", RSDBP_IN, D_STORN );

        cmd.execute( );

        if ( rs.moveNext( ) )
          stat = true;
        else
          PushErrorMessage( "Перевод должен быть в состоянии \"К выплате\", \"Принят\" или отправлен в КЦ" );
        end;
      end;
    end; 

    // Проверка признака "нашего" банка --------------------------------
    if ( stat )
      if ( transfer.rec.ourFlag == 0 )
        stat = false;
        PushErrorMessage( "Перевод должен быть принят в \"нашем\" банке" );
      end;
    end;

    // Проверка в КЦ, что данный перевод не был ранее выплачен ---------
    if ( stat )
      stat = isTransferPaidOut( );

      if ( not stat )
        stat = true;
      else
        stat = false;
        PushErrorMessage( "По данным Клирингового центра перевод уже был выплачен" );
      end;
    end;

    // Подтверждение операции вторым лицом -----------------------------
    if ( stat )
      stat = CritWaitAcceptEx( 0, "Прошу разрешить аннулирование срочного перевода" );
    end;

    return stat;
  end;

  // =====================================================================
  macro createDocuments( )

    return true;
  end;

  // =====================================================================
  InitTMtOperation( p_psId, NULL, NULL, NULL, NULL, 2, true );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro createInstance ( opNum, subOpNum, psId )

  var opReverse = TMtOpReverse( opNum, subOpNum, psId ); 

  return opReverse;
end;
