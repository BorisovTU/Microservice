import mtcommission, mtcntng_webserv, RSD, RsbDataSet;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TReqCommission
  class ( TRequestAttributesBase ) A
    var TO_BANK_CODE : string;
    var TRANSACTION_AMOUNT : money;
    var TRANSACTION_CUR : string;
    var ENTER_AMOUNT : money;
    var ENTER_CUR : string;
    var RET_COURSE : money;
    var USER_ID : integer;
    var LANG : string = "RU";

    InitTRequestAttributesBase( "TMoneyOrderObject", "CalcFee" ); 
  end;

  var attr = A;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TRespCommission
  class ( TResponseAttributesBase ) A
    var TRANSACTION_AMOUNT : money;
    var TRANSACTION_FEE : money;
    var RSB_FEE : money;
    var ENTER_CUR : string;
    var ENTER_FEE : money; 
    var RET_FEE : money;
    var RATE : double;
  end;

  var attr = A;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtCommissionCalculator ) TMtCngCommissionCalculator ( _system : RslTMtSystem, _transfer : TMtTransfer, _opDate, _isPayout )

  var ErrorMessage : STRING = "";

  // Вызов конструктора базового класса
  InitTMtCommissionCalculator( _system, _transfer, _opDate, _isPayout );

  // =====================================================================
  private macro defCurrCodeForAttr( currCode )

    var currency = Tbfile( "currency.dbt", "r", 0 );

    currency.Clear( );
    currency.KeyNum = 0;

    currency.rec.Code_Currency = currCode;

    if ( currency.GetEQ( ) )
      return StrUpr( currency.rec.Short_Name );
    else
      return "";
    end;
  end;

  // =====================================================================
  macro loadTariff : bool

    return true;
  end;

  // =====================================================================
  macro calcNotificationCommission : bool

    return true;
  end;

  // =====================================================================
  macro calcDeliveryCommission : bool

    return true;
  end;

  // =====================================================================
  macro calcInformationCommission : bool

    return true;
  end;

  // =====================================================================
  macro calcCommission : bool

    var stat = true;
    var req = TReqCommission;
    var resp = TRespCommission;
    var currCodeForAttr = defCurrCodeForAttr( transfer.rec.curCode );

    if ( Trim( transfer.rec.receivePointCode ) == "" ) // Еще не выбрали точку
      return true;
    end;

    if ( currCodeForAttr == "" )
      ErrorMessage = "Не найдена валюта перевода в справочнике валют";

      stat = false;
      return stat;
    end;

    req.attr.USER_ID = transfer.rec.senderPartyId;
    req.attr.TRANSACTION_AMOUNT = transfer.rec.sum;
    req.attr.TRANSACTION_CUR = currCodeForAttr;
    req.attr.ENTER_CUR = currCodeForAttr;
    req.attr.ENTER_AMOUNT = transfer.rec.sum;
    req.attr.TO_BANK_CODE = Trim( transfer.rec.receivePointCode );
    req.attr.RET_COURSE = 0;

    if ( CNG_Request( req, resp, false ) == 0 )
      if ( resp.attr.RE == 0 )
        transfer.rec.sumCommisAll = resp.attr.TRANSACTION_FEE;
        transfer.rec.sumCommisOur = resp.attr.TRANSACTION_FEE - resp.attr.RSB_FEE;
        transfer.rec.sumCommisCC = resp.attr.RSB_FEE;
        if ( transfer.rec.sumCommisOur < $0L )
          transfer.rec.sumCommisOur = $0L;
        end;

        stat = true;
      else
        ErrorMessage = resp.attr.ERR_TEXT;
        stat = false;
      end;
    else
      ErrorMessage = "Ошибка при расчете комиссии";

      stat = false;
    end;

    if (not stat)
      ShowError();
    end;
    
    return stat;

    OnError( er )
      ErrorMessage = er.Message;
      ShowError(er.Message);
      return false;
  end;

end;
