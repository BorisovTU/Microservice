import DeprIntr, globals, MonTransInter, rsd, sqlconv;

private var transferReport = getCurrentTransfer( );

private var rmtr_ps = Tbfile( "rmtr_ps.dbt", "r", 0 );
private var currency = Tbfile( "currency.dbt", "r", 0 );

private var senderName = "";
private var senderPaper = "";
private var senderAddress = "";
private var transCode = "";
private var nameCurr = "";
private var recName = "";
private var recBankName = "";


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefShName( currCode )

  currency.Clear( );
  currency.KeyNum = 0;

  currency.rec.Code_Currency = currCode;

  if ( currency.GetEQ( ) )
    return currency.rec.Short_Name;
  else
    return "";
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefRecBankName( )

  var recPointCode = Int( Trim( transferReport.rec.receivePointCode ) );
  var country = "";
  var place = "";
  var cmd;
  var rs;

  recBankName = Trim( transferReport.rec.recBankName );

  if ( ( recBankName == "" ) and ( recPointCode > 0 ) )
    cmd = RsdCommand( "select party.t_name as name " +
                      "from dparty_dbt party " +
                      "where party.t_partyid = :partyid" );

    rs = RsdRecordset( cmd );

    cmd.addParam( "partyid", RSDBP_IN, recPointCode );

    cmd.execute( );

    if ( rs.moveNext( ) )
      recBankName = rslString( rs.value( "name" ) );
    end;
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro fillOutField ( inField )

  var outField = "";
  var i = 1;

  while ( i <= StrLen( inField ) )

    if ( SubStr( inField, i, 1 ) == " " )
      outField = outField + "_";
    else
      outField = outField + SubStr( inField, i, 1 );
    end;

    i = i + 1;
  end;

  if ( outField == "" )
    outField = "_";
  end;

  return outField;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/

  if ( ValType( transferReport ) == V_GENOBJ )

    // Определим платежную систему
    rmtr_ps.Clear( );
    rmtr_ps.KeyNum = 0;
    rmtr_ps.rec.psId = transferReport.rec.psId;

    if ( not rmtr_ps.GetEQ( ) )
      rmtr_ps.Clear( );
    end;
    rmtr_ps.rec.psName = fillOutField( rmtr_ps.rec.psName );

    // Определим имя отправителя
    if ( transferReport.rec.senderName1 != "" )
      senderName = Trim( transferReport.rec.senderName1 );
      if ( transferReport.rec.senderName2 != "" )
        senderName = senderName + "_" + Trim( transferReport.rec.senderName2 );
        if ( transferReport.rec.senderName3 != "" )
          senderName = senderName + "_" + Trim( transferReport.rec.senderName3 );
        end;
      end;
    end;
    senderName = fillOutField( senderName );

    // Определим номер документа отправителя
    if ( transferReport.rec.senderPaperNumber != "" )
      senderPaper = Trim( GetNameOfPAPRKIND( transferReport.rec.senderPaperKind ) );

      if ( transferReport.rec.senderPaperSeries != "" )
        senderPaper = senderPaper + " " + Trim( transferReport.rec.senderPaperSeries );
      end;

      senderPaper = senderPaper + " № " + Trim( transferReport.rec.senderPaperNumber );

      if ( transferReport.rec.senderPaperIssuer != "" )
        senderPaper = senderPaper + ", выдан " + Trim( transferReport.rec.senderPaperIssuer );
      end;

      if ( transferReport.rec.senderPaperIssuedDate != Date( 0, 0, 0 ) )
        senderPaper = senderPaper + ", " + String( transferReport.rec.senderPaperIssuedDate:f );
      end;
    end;
    senderPaper = fillOutField( senderPaper );

    // Определим адрес отправителя
    senderAddress = fillOutField( Trim( transferReport.rec.senderAdress ) );

    // Определим номер перевода
    transCode = fillOutField( Trim( transferReport.rec.transCode ) );

    // Определим название валюты
    nameCurr = DefShName( transferReport.rec.curCode );
    nameCurr = fillOutField( Trim( nameCurr ) );

    // Определим имя получателя
    if ( transferReport.rec.recName1 != "" )
      recName = Trim( transferReport.rec.recName1 );
      if ( transferReport.rec.recName2 != "" )
        recName = recName + "_" + Trim( transferReport.rec.recName2 );
        if ( transferReport.rec.recName3 != "" )
          recName = recName + "_" + Trim( transferReport.rec.recName3 );
        end;
      end;
    end;
    recName = fillOutField( recName );

    // Определим банк получателя
    DefRecBankName( );
    recBankName = fillOutField( Trim( recBankName ) );

    [Платежная система _#_________________________________________
                         (название платежной системы)


                                    ЗАЯВЛЕНИЕ НА АННУЛИРОВАНИЕ ДЕНЕЖНОГО ПЕРЕВОДА

     Я, _#__________________________________________________________________________________________________________________
                                            (Фамилия, Имя, Отчество Отправителя)
     _#_____________________________________________________________________________________________________________________
                                   (документ, удостоверяющий личность (серия, номер, кем и когда выдан)
     _#_____________________________________________________________________________________________________________________
                                                (адрес отправителя)
     отправил денежный перевод со следующими реквизитами:
     	Номер перевода _#_______________________________________________
     	Дата отправления перевода _#____________________________________
     	Сумма и валюта перевода _#_____________________________ _#______
     	Ф.И.О. Получателя _#____________________________________________
     	Банк Получателя _#______________________________________________
     Прошу аннулировать денежный перевод и вернуть денежные средства

     _#_________________________                                    ________________________________________________________
              (дата)                                                             (подпись Отправителя)


     ОТМЕТКИ БАНКА
     +-----------------------------------------------------------+-----------------------------------------------------------+
     |             Заявление принято и проверено                 |     Подтверждение об аннулировании денежного перевода     |
     |                                                           |     получено "_______" ______________________ 200___ г.   |
     |                                                           |                                                           |
     |                                                           |     Номер перевода _____________________________          |
     |                                                           |                                                           |
     |                                                           |                                                           |
     |  _______________________________________________________  |  _______________________________________________________  |
     |         (печать, подпись сотрудника Банка)                |              (печать, подпись сотрудника Банка)           |
     +-----------------------------------------------------------+-----------------------------------------------------------+]
     ( rmtr_ps.rec.psName, 
       senderName, senderPaper, senderAddress, 
       transCode, String( transferReport.rec.sendDate:f ), 
       String( transferReport.rec.sum:0:2:a ), nameCurr, 
       recName, recBankName,
       String( {curdate}:f ) );

  end;

end;
