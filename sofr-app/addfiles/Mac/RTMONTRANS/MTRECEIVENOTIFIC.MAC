import MTOperat;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtOperation ) TMtOpProcessReceiveNotification( p_opNum, p_subOpNum, p_psId, p_transCode, p_newState )

  private var opNum = p_opNum;
  private var subOpNum = p_subOpNum;
  private var psId = p_psId;
  private var transCode = p_transCode;

  if ( opNum == 0 )
    opNum = MTOP_process_receive_notification;
    subOpNum = 0;
  end;

  // =====================================================================
  macro startInit( )

    startInit( );

    opHistory.rec.opNum = opNum;
    opHistory.rec.subOpNum = subOpNum;
    opHistory.rec.isSentToCC = 1; // В КЦ передавать не надо

    return true;
  end;

  // =====================================================================
  macro finalInit( )

    opHistory.rec.stateBefore = transfer.rec.state;

    transfer.rec.state = "ONSET_____"; // ????? "TO_BE_RETD" В зависимости от того, что пришло в сеансе связи из КЦ
    transfer.rec.action = D_UPDATE;

    opHistory.rec.stateAfter = transfer.rec.state;

    return true;
  end;

  // =====================================================================
  macro check( )

    var cmd;
    var rs;
    var stat = false;

    // Найдем перевод --------------------------------------------------
    cmd = RsdCommand( "select rmto_trans.t_branch as branch, " +
                             "rmto_trans.t_transId as transId " +
                      "from drmto_trans_dbt rmto_trans " +
                      "where rmto_trans.t_branch = :branch and " +
                            "rmto_trans.t_psId = :psId and " +
                            "rmto_trans.t_transCode = :transCode " +
                            "order by rmto_trans.t_sendDate desc" );

    rs = RsdRecordset( cmd );

    cmd.addParam( "branch", RSDBP_IN, NumFNcash( ) );
    cmd.addParam( "psId", RSDBP_IN, psId );
    cmd.addParam( "transCode", RSDBP_IN, transCode );

    cmd.execute( );

    if ( rs.moveNext( ) )
      stat = transfer.load( rs.value( "branch" ),  rs.value( "transId" ) );
      if ( not stat )
        PushErrorMessage( "Ошибка при загрузке срочного перевода с уникальным идентификатором " + String( rs.value( "transId" ) ) );
      end;
    else
      PushErrorMessage( "Не найден перевод c идентификатором \"" + transCode + "\"" );
    end;

    // Проверка признака "нашего" банка --------------------------------
    if ( stat )
      if ( transfer.rec.ourFlag == 0 )
        stat = false;
        PushErrorMessage( "Операция для перевода c идентификатором \"" + transfer.rec.transCode + "\" невозможна: перевод должен быть принят в \"нашем\" банке" );
      end;
    end;

    // Проверим состояние операции -------------------------------------
    if ( stat )

      cmd = RsdCommand( "select * from drmtr_state_dbt rmtr_state " +
                        "where rmtr_state.t_psId = :psId and " +
                              "rmtr_state.t_stateCode = :stateCode and " +
                              "( rmtr_state.t_stateCode = 'RECEIVED__' or " +
                                "rmtr_state.t_equivalentCode = 'RECEIVED__' )" );

      rs = RsdRecordset( cmd );

      cmd.addParam( "psId", RSDBP_IN, transfer.rec.psId );
      cmd.addParam( "stateCode", RSDBP_IN, transfer.rec.state );

      cmd.execute( );

      if ( rs.moveNext( ) )
        ;
      else
        stat = false;
        PushErrorMessage( "Операция для перевода c идентификатором \"" + transfer.rec.transCode + "\" невозможна: перевод должен быть в состоянии \"Принят\"" );
      end;
    end;

    return stat;
  end;

  // =====================================================================
  macro runPanel( )

    setFlagOperationPanel( false );

    return true;
  end;

  // =====================================================================
  macro errorMessage( )
    ;
  end;

  // =====================================================================
  InitTMtOperation( p_psId );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro createInstance ( opNum, subOpNum, psId )

  var opProcessReceiveNotification = TMtOpProcessReceiveNotification( opNum, subOpNum, psId, "" ); 

  return opProcessReceiveNotification;
end;
