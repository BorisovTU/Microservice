import Globals, ContactNGReport;

// Report mode flag
private const useTemplate = false;

/******************************************************************************
 *                           Finished report classes                          *
 ******************************************************************************/
private class (TxtContactNGReport) TxtContactNGRecievingReport(transferRec)
  InitTxtContactNGReport(transferRec);

  private macro notResident(client)
    if(not (client.IsResident()))
      return "X";
    end;
    return "";
  end;
    
  macro show()
    var dd, mm, yyyy;
    DateSplit( transferRec_.sendDate, dd, mm, yyyy );
    
    [Платежная система _Contact_NG_________________________________________
                         (название платежной системы)
  
  
  
                                          ЗАЯВЛЕНИЕ НА ДЕНЕЖНЫЙ ПЕРЕВОД № _#________________
  
     Дата перевода  "_##__"________##_________________ #______г.
  
     Отправитель _#________________________________________________________________________________________________________
                                            (Фамилия, Имя, Отчество Отправителя)
     Документ _#___________________________________________________________________________________________________________
                                   (документ, удостоверяющий личность (серия, номер, кем и когда выдан)
     Гражданство _#_____________________________
     Нерезидент __#___
     Адрес, номер телефона _#______________________________________________________________________________________________
     Поручает осуществить перевод в размере _#______________________ _#______
                                                 (сумма цифрами)      (валюта)
     _#____________________________________________________________________________________________________________________
       (сумма прописью)                                                                                                  
     На _#_____________________________________________________________________________ Телефон Банка: _#__________________
              (наименование Банка Получателя, город, страна)
     Кому выплатить:
     _#_____________________________________________________________________________________________________ 
                     (Фамилия, Имя, Отчество Получателя)
     _#________________________________________________________________________________________________, _#________________
          (документ, удостоверяющий личность Получателя (серия, номер, кем и когда выдан)                       (телефон)
     Сумма включая комиссию:
     +--------------+-----------------------------------+--------+--------------------------------------------------------+
     |              |                                   | Валюта |                    Сумма прописью                      |
     +--------------+-----------------------------------+--------+--------------------------------------------------------+
     | Сумма        |  #                                |  #     |                                                        |
     | Комиссия     |  #                                |  #     |                                                        |
     | Общая сумма  |  #                                |        | #######################################################|
     +--------------+-----------------------------------+--------+--------------------------------------------------------+
     С условиями перевода денег согласен. Это частный перевод и он не служит покрытию торговой деятельности, капитальных 
     вложений или иным подобным действиям.
     Комиссия взимается в соответствии с действующими в настоящий момент тарифами.
  
     ___________________________________________                       ____________________________________________________
         (печать, подпись операциониста)                                          (подпись Отправителя)                    
  
     ПАМЯТКА
     1. Информация, которую Вам необходимо самостоятельно сообщить получателю
     +--------------------------------------------------------------------------------------------------------------------+
     | Перевод № _#_________________ на сумму _#______________ _#______ от "_##_"_____##_____________ #_____г.           |
     | Отправитель: _#________________________________________________________________________________________________    |
     |                        (Фамилия, Имя, Отчество Отправителя)                                                        |
     | Получатель: __#________________________________________________________________________________________________    |
     |                        (Фамилия, Имя, Отчество Получателя)                                                         |
     | Банк Получателя: _#____________________________________________________________________________________________    |
     |                   (наименование Банка Получателя, город, страна)                                                   |
     +--------------------------------------------------------------------------------------------------------------------+
     2. Банк Получателя не несет ответственности за отказ в выплате Перевода при несоответствии сведений о Получателе, 
        указанных Отправителем, документам, предъявленным Получателем.
     3. Сумма уплаченной комиссии возврату не подлежит.
     4. Невостребованная Получателем сумма денежного перевода подлежит возврату в Банк Отправителя по истечении 
        30 (тридцати) календарных дней с даты приема Заявления на денежный перевод.]
    ( transferRec_.transCode,
      dd:o, mm:o, yyyy,
      format(concat(concat(sender_.LastName(), sender_.FirstName(), " "), sender_.SecondName(), " ")),
      format(sender_.paper()), sender_.citizenship(), format(notResident(sender_)), concat(format(sender_.address()), format(sender_.phone())),
      string(transferRec_.sum:0:2:a:l), sumCurrency(), sumInWords(transferRec_.sum),
      concat(concat(format(reciever_.point().name()), format(reciever_.point().city())), format(reciever_.point().country())),
      format(reciever_.point().phone()),
      format(concat(concat(reciever_.lastName(), reciever_.FirstName(), " "), reciever_.SecondName(), " ")),
      format(reciever_.paper()), reciever_.phone(),
      string(transferRec_.sum:20:2:a), sumCurrency(), 
      string(transferRec_.sumCommisAll:20:2:a), sumCurrency(),
      string((transferRec_.sum+transferRec_.sumCommisAll):20:2:a), sumInWords(transferRec_.sum+transferRec_.sumCommisAll),
      transferRec_.transCode, 
      string(transferRec_.sum:0:2:a:l), sumCurrency(),
      dd:o, mm:o, yyyy,
      format(concat(concat(sender_.LastName(), sender_.FirstName(), " "), sender_.SecondName(), " ")),
      format(concat(concat(reciever_.lastName(), reciever_.FirstName(), " "), reciever_.SecondName(), " ")),
      concat(concat(format(reciever_.point().name()), format(reciever_.point().city())), format(reciever_.point().country())));

      [#](TxtExtraInfo(transferRec_.branch, transferRec_.transCode).toString());
  end;
end;

private class (TemplateContactNGReport) TemplateContactNGRecievingReport(transferRec)
  InitTemplateContactNGReport(transferRec);

  private macro ground()
    var cmd = RsdCommand("select t_ground as ground "
                         " from drmto_op_dbt rmto_op " 
                         " where rmto_op.t_branch = " + transferRec_.branch +
                         "  and rmto_op.t_transid = " + transferRec_.transId + 
                         "  and rmto_op.t_opnum in ( 1, 6 ) "
                         "  and rmto_op.t_action = 0 ");
    var recSet = RsdRecordSet( cmd );
    if (recSet.MoveNext())
      return trim(recSet.Value("ground"));
    end;
    return "";
  end;
  
  macro show()
    factory_.registerForm("Contact_NG", "Contact_NG_receiving.dot", "Contact_NG_recieving.doc",
                          "transCode", "sendDate",
                          "senderName1", "senderName2", "senderName3", "senderBorn",
                          "senderPaper", "senderAdress", "senderPhoneNumber", "senderPointName",
                          "sum", "curCode", "sumProp",
                          "recName1", "recName2", "recName3",
			  "recPointName", "recPointAddress",
			  "Ground", "recAddInfo",
                          "senderName1", "senderName2", "senderName3",
			  "senderBankName", "senderBankAdress",
			  "sumCommis", "curCommisCode", "curCommis",
			  "Ground",
                          "transCode", "sendDate",
			  "sum", "curCode", "CurName",
                          "recName1", "recName2", "recName3", "recPointName", "recPointAdress",
			  "recAddInfo");
 
    factory_.addDoc("Contact_NG",
                     transferRec_.transCode, string(transferRec_.sendDate),
                     sender_.lastName(), sender_.FirstName(), sender_.SecondName(), string(sender_.birthDay()),
		     sender_.paper(), sender_.address(), sender_.phone(), sender_.point().name(),
                     string(transferRec_.sum:0:2), sumCurrency(), sumInWords(),
                     reciever_.LastName(), reciever_.FirstName(), reciever_.SecondName(),
		     reciever_.point().name(), reciever_.point().address(),
                     ground(), recAddInfo(),
                     sender_.LastName(), sender_.FirstName(), sender_.SecondName(),
		     sender_.point().name(), sender_.point().address(),
		     string(transferRec_.sumCommisAll:0:2), sumCurrency(), TCurrency(transferRec_.curCode).fullName(),
		     ground(),
		     transferRec_.transCode, string(transferRec_.sendDate),
		     string(transferRec_.sum:0:2), sumCurrency(), TCurrency(transferRec_.curCode).fullName(),
		     reciever_.lastName(), reciever_.firstName(), reciever_.secondName(),
		     reciever_.point().name(), reciever_.point().address(),
                     recAddInfo());
    show();
  end;
end;
		    

/**************************************************************************/

private macro main()
  var transfer = getCurrentTransfer();
  if (ValType(transfer) != V_GENOBJ ) return ; end;
  
  var report = null;
  if(useTemplate) report = TemplateContactNGRecievingReport();
  else            report = TxtContactNGRecievingReport();
  end;
  
  report.setTransfer(transfer.rec);
  report.show();
end;

main();

