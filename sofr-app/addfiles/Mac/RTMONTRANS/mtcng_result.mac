import DeprIntr;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro GetFieldNameForResultReport ( bankCode, fieldName )

  var cmd;
  var rs;
  var fieldCaption = "";
  
  cmd = RsdCommand( "select cng_attrlist.t_field_caption as field_caption "
                    "from dcng_attrlist_tmp cng_attrlist join dcng_attr_grps_tmp cng_attr_grps on ( cng_attrlist.t_grp_num = cng_attr_grps.t_groupnum ) "
                    "where cng_attrlist.t_field_name = :field_name "
                      "and cng_attr_grps.t_subj_type = 3 "
                      "and cng_attr_grps.t_subj_code = ( select cng_banks.t_id "
                                                        "from dcng_banks_tmp cng_banks "
                                                        "where cng_banks.t_pp_code = :pp_code )" );

  rs = RsdRecordSet( cmd );

  cmd.addParam( "field_name", RSDBP_IN, fieldName );
  cmd.addParam( "pp_code", RSDBP_IN, bankCode );

  cmd.execute( );
  
  if ( rs.moveNext( ) )
    fieldCaption = rs.value( "field_caption" );
  end;

  if ( fieldCaption == "" )
    cmd = RsdCommand( "select cng_attrlist.t_field_caption as field_caption "
                      "from dcng_attrlist_dbt cng_attrlist join dcng_attr_grps_dbt cng_attr_grps on ( cng_attrlist.t_grp_num = cng_attr_grps.t_groupnum ) "
                      "where cng_attrlist.t_field_name = :field_name "
                        "and cng_attr_grps.t_subj_type = 3 "
                        "and cng_attr_grps.t_subj_code = ( select cng_banks.t_id "
                                                          "from dcng_banks_dbt cng_banks "
                                                          "where cng_banks.t_pp_code = :pp_code )" );

    rs = RsdRecordSet( cmd );

    cmd.addParam( "field_name", RSDBP_IN, fieldName );
    cmd.addParam( "pp_code", RSDBP_IN, bankCode );

    cmd.execute( );
    
    if ( rs.moveNext( ) )
      fieldCaption = rs.value( "field_caption" );
    end;
  end;

  if ( fieldCaption == "" )
    fieldCaption = fieldName;
  end;

  return fieldCaption;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro getCurrencyNameForResultReport( currCode )

  var cmd;
  var rs;

  cmd = RsdCommand( "select t_short_name as short_name " 
                    "from dcurrency_dbt "
                    "where t_code_currency = :currCode" );

  cmd.addParam( "currCode", RSDBP_IN, currCode );

  rs = RsdRecordSet( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    return rs.value( "short_name" );
  else
    return "";
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro getPaperNameForResultReport( paperKind )

  var cmd;
  var rs;

  cmd = RsdCommand( "select t_name as nameKind "
                    "from dpaprkind_dbt "
                    "where t_paperkind = :paperKind" );

  cmd.addParam( "paperKind", RSDBP_IN, paperKind );

  rs = RsdRecordSet( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    return rs.value( "nameKind" );
  else
    return "";
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro getPaperForResultReport( sr, num )

  return Trim( sr + " " + num );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro getDataFromTransferFieldForResultReport ( transfer, nameField )

  return GenGetProp( transfer.rec, nameField );

  OnError( er )
    return null;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintResult( transfer, panel, fieldsToPrint );

  var k = 0;
  var fieldName;
  var fieldValue;
  var fieldAttr;

  [ - #---------------------------------------- #------------------- #----------]
  ( GetRetailVersion( ), date( ):f, time( ):f );
  [ ];
  [                           Реквизиты перевода/платежа];
  [ ];
  [ ----------------------------------------------------------------------------];
  [ |Идентификатор платежа            |########################################|]
  ( transfer.rec.transCode:w );
  [ ----------------------------------------------------------------------------];

  if ( ValType( fieldsToPrint ) != V_UNDEF )

    while ( k < fieldsToPrint.Size )

      if ( StrUpr( fieldsToPrint[k] ) == "TRNREFERENCE" )
        k = k + 1;
        continue; // Данное поле напечатали самым первым, повторно печатать не надо
      end;

      fieldName = GetFieldNameForResultReport( transfer.rec.receivePointCode, fieldsToPrint[k] );
      fieldValue = "";

      // ---------------------------------------------------------------
      if ( StrUpr( fieldsToPrint[k] ) == "TRNCURRENCY" )
        fieldValue = getCurrencyNameForResultReport( transfer.rec.curCode );
      // ---------------------------------------------------------------
      elif ( StrUpr( fieldsToPrint[k] ) == "TRNFEESCLIENTCURR" )
        fieldValue = getCurrencyNameForResultReport( transfer.rec.curCodeCommis );
      // ---------------------------------------------------------------
      elif ( StrUpr( fieldsToPrint[k] ) == "SIDTYPE" )
        fieldValue = getPaperNameForResultReport( transfer.rec.senderPaperKind );
      // ---------------------------------------------------------------
      elif ( StrUpr( fieldsToPrint[k] ) == "BIDTYPE" )
        fieldValue = getPaperNameForResultReport( transfer.rec.recPaperKind );
      // ---------------------------------------------------------------
      elif ( StrUpr( fieldsToPrint[k] ) == "SIDNUMBER" )
        fieldValue = getPaperForResultReport( transfer.rec.senderPaperSeries, transfer.rec.senderPaperNumber );
      // ---------------------------------------------------------------
      elif ( StrUpr( fieldsToPrint[k] ) == "BIDNUMBER" )
        fieldValue = getPaperForResultReport( transfer.rec.recPaperSeries, transfer.rec.recPaperNumber );
      // ---------------------------------------------------------------
      else
        if ( ValType( panel ) != V_UNDEF )
          fieldAttr = panel.GetFieldByPSysIdent( fieldsToPrint[k] )[0];

          if ( ValType( fieldAttr ) != V_UNDEF )

            fieldValue = getDataFromTransferFieldForResultReport( transfer, fieldAttr.IdFieldTS );

            if ( ValType( fieldValue ) == V_UNDEF )
              fieldValue = "";
            elif ( ( ValType( fieldValue ) == V_MONEY ) or ( ValType( fieldValue ) == V_MONEYL ) )
              fieldValue = String( fieldValue:0:2:a );
            elif ( ( ValType( fieldValue ) == V_DATE ) or ( ValType( fieldValue ) == V_TIME ) )
              fieldValue = String( fieldValue:f );
            else
              fieldValue = String( fieldValue );
            end;
          end;
        else
          if ( StrUpr( fieldsToPrint[k] ) == "SNAME" )
            fieldValue = transfer.rec.senderName1;
          elif ( StrUpr( fieldsToPrint[k] ) == "SLASTNAME" )
            fieldValue = transfer.rec.senderName2;
          elif ( StrUpr( fieldsToPrint[k] ) == "SSURNAME" )
            fieldValue = transfer.rec.senderName3;
          elif ( StrUpr( fieldsToPrint[k] ) == "SPHONE" )
            fieldValue = transfer.rec.senderPhoneNumber;
          elif ( StrUpr( fieldsToPrint[k] ) == "BNAME" )
            fieldValue = transfer.rec.recName1;
          elif ( StrUpr( fieldsToPrint[k] ) == "BLASTNAME" )
            fieldValue = transfer.rec.recName2;
          elif ( StrUpr( fieldsToPrint[k] ) == "BSURNAME" )
            fieldValue = transfer.rec.recName3;
          elif ( StrUpr( fieldsToPrint[k] ) == "BPHONE" )
            fieldValue = transfer.rec.recPhoneNumber;
          elif ( StrUpr( fieldsToPrint[k] ) == "TRNDATE" )
            fieldValue = String( transfer.rec.sendDate:f );
          elif ( StrUpr( fieldsToPrint[k] ) == "TRNAMOUNT" )
            fieldValue = String( transfer.rec.sum:0:2:a );
          elif ( StrUpr( fieldsToPrint[k] ) == "TRNSENDPOINT" )
            fieldValue = transfer.rec.sendPointCode;
          elif ( StrUpr( fieldsToPrint[k] ) == "TRNPICKUPPOINT" )
            fieldValue = transfer.rec.receivePointCode;
          elif ( StrUpr( fieldsToPrint[k] ) == "TRNADDITIONALINFO" )
            fieldValue = transfer.rec.recAddInfo;
          elif ( StrUpr( fieldsToPrint[k] ) == "TACCOUNTNUMBER" )
            fieldValue = transfer.rec.recAccount;
          elif ( StrUpr( fieldsToPrint[k] ) == "TRNFEESCLIENT" )
            fieldValue = String( transfer.rec.sumCommisAll:0:2:a );
          end;
        end;
      end;

      [ |#################################|########################################|]
      ( fieldName:w, fieldValue:w );
      [ ----------------------------------------------------------------------------];
      
      k = k + 1;
    end;
  end;

  return true;
end;
