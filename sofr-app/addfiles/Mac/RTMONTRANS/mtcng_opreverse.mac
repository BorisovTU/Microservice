import mtreverse, mtcntng_webserv, mtcng_service, mtcng_view;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TReqForCancel

  class ( TRequestAttributesBase ) A
    var DOC_ID : integer;
    var USER_ID : integer;
    var LANG : string = "RU";

    InitTRequestAttributesBase( "TMoneyOrderObject", "ReqForCancel" ); 
  end;

  var attr = A;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class TRespForCancel

  class ( TResponseAttributesBase ) A
    var STATE : integer;
  end;

  var attr = A;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtOpReverse ) TMtCngReverseOpAssign( p_opNum, p_subOpNum, p_psId )

  // =====================================================================
  macro Configure( )

    var i;
    var j;
    var stat = true;

    // Закрытие всех полей от редактирования
    for ( i, 0, operPanel.numForms - 1 )

      for ( j, 0, operPanel.getForm( i ).numControls - 1 )
        if ( operPanel.getForm( i ).getControl( j ).editable )
          operPanel.getForm( i ).getControl( j ).editable = false;
        end;
        operPanel.getForm( i ).getControl( j ).focusable = false;
      end;
    end;

    // Дополнительные действия для основной панели
    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sum" ).focusable = true;

      operPanel.getForm( MT_OPER_PANEL ).getControl( "insideTheCountry" ).enabled = false;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "recNPflag" ).enabled = false;
    end;

    // Дополнительные действия для панели плательщика
    if ( operPanel.numForms > MT_PAYER_PANEL )
      operPanel.getForm( MT_PAYER_PANEL ).getControl( "name1" ).focusable = true;
    end;

    // Дополнительные действия для панели получателя
    if ( operPanel.numForms > MT_RECEIVER_PANEL )
      operPanel.getForm( MT_RECEIVER_PANEL ).getControl( "name1" ).focusable = true;
    end;

    // Дополнительные действия для дополнительной панели
    if ( operPanel.numForms > MT_AUX_PANEL )
      if ( operPanel.getForm( MT_AUX_PANEL ).numControls > 0 )
        operPanel.getForm( MT_AUX_PANEL ).getControl( 0 ).focusable = true;
      end;
    end;
 
    return stat;
  end;

  // =====================================================================
  macro addUserKeyHandler

    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.addEventHandler( RSB_EV_ENTER_WINDOW, r2m( this, "enterWindowEventHandler" ) );
    end;
  end;

  // =====================================================================
  macro SelectPayment( )

    var stat = true;
    var cmd;
    var rs;
    var id = 0;
    var numPay = "";

    if ( stat )
      id = SelectOutgoingPayment( numPay );

      if ( ( id == 0 ) or ( numPay == "" ) )
        stat = false;
      end;
    end;

    if ( stat )
      cmd = RsdCommand( "select rmto_trans.t_branch as branch, " +
                               "rmto_trans.t_transId as transId " +
                        "from drmto_trans_dbt rmto_trans " +
                        "where rmto_trans.t_branch = :branch and " +
                              "rmto_trans.t_psId = :psId and " +
                              "rmto_trans.t_transCode = :transCode " +
                              "order by rmto_trans.t_sendDate desc" );

      rs = RsdRecordset( cmd );

      cmd.addParam( "branch", RSDBP_IN, NumFNcash( ) );
      cmd.addParam( "psId", RSDBP_IN, system.rec.psId );
      cmd.addParam( "transCode", RSDBP_IN, numPay );

      cmd.execute( );

      if ( rs.moveNext( ) )
        stat = transfer.load( rs.value( "branch" ), rs.value( "transId" ) );
        if ( not stat )
          PushErrorMessage( "Ошибка при загрузке срочного перевода с уникальным идентификатором " + String( rs.value( "transId" ) ) );
          stat = false;
        end;
      else
        PushErrorMessage( "Не найден перевод c идентификатором \"" + numPay + "\"" );
        stat = false;
      end;
    end;

    if ( stat )
      stat = GetPaymentData( id, transfer, NULL, NULL, NULL, true );
    end;

    return stat;
  end;
 
  // =====================================================================
  macro createPanel( )

    ;
  end;

  // =====================================================================
  macro startInit( )

    var stat = true;

    ResetErrorMessage( );

    if ( stat )
      if ( checkPing( true ) != 0 )
        stat = false;
      end;
    end;

    if ( stat )
      opHistory.rec.branch = NumFNcash( );
      opHistory.rec.opDate = {curdate};
      opHistory.rec.oper = {oper};
      opHistory.rec.action = 0;
      opHistory.rec.opApplicationKind = SB_MONEY_TRANSFER;
      opHistory.rec.opApplicationKey = FormApplicationKey( SB_MONEY_TRANSFER );
      opHistory.rec.opNum = opNum;
      opHistory.rec.subOpNum = subOpNum;
      opHistory.rec.isSentToCC = 1; // В КЦ передавать не надо

      transfer.rec.branch = NumFNcash( );
      transfer.rec.psId = system.rec.psId;
    end;
  
    // Ввод идентификатора платежа
    if ( stat )
      stat = SelectPayment( );
    end;

    if ( stat )
      panel = TMtCngOperPanel( this );
      panel.Configure( );

      Configure( );
    end;

    if ( stat )
      addUserKeyHandler( );
    end;

    return stat;
  end;

  // =====================================================================
  macro finalInit( )

    var req = TReqForCancel;
    var resp = TRespForCancel;
    var retCode = 0;
    var cycle = true;
    var stat = true;

    if ( stat )
      req.attr.USER_ID = transfer.rec.senderPartyID;
      req.attr.DOC_ID = transfer.rec.psTransID;

      while ( cycle )
        cycle = false;

        retCode = CNG_Request( req, resp );

        if ( retCode == 0 )
          retCode = resp.attr.RE;
        end;

        if ( ( retCode == 100 ) or ( retCode == 105 ) )
          if ( GetTrue( true, "Не удалось получить информацию из КЦ. Повторить попытку ?" ) )
            cycle = true;
          else
            stat = false;
          end;
        elif ( retCode != 0 )
          if ( ( ValType( resp.attr.ERR_TEXT ) == V_STRING ) and ( resp.attr.ERR_TEXT != "" ) )
            MsgBox( MT_PS_MESSAGE_PREFIX + resp.attr.ERR_TEXT );
          else
            MsgBox( "Ошибка при запросе в КЦ об аннулировании перевода" );
          end;
          stat = false;
        end;
      end;
    end;

    if ( stat )
      opHistory.rec.stateBefore = transfer.rec.state;

      transfer.rec.state = "TO_BE_RETD";

      transfer.rec.action = D_UPDATE;

      opHistory.rec.stateAfter = transfer.rec.state;
    end;

    return stat;
  end;

  // =====================================================================
  macro check( )

    var cmd;
    var rs;
    var stat = true;

    // Проверим состояние операции -------------------------------------
    if ( stat )
      cmd = RsdCommand( "select * from drmtr_state_dbt rmtr_state " +
                        "where rmtr_state.t_psId = :psId and " +
                              "rmtr_state.t_stateCode = :stateCode and " +
                              "( rmtr_state.t_stateCode = 'ONSET_____' or " +
                                "rmtr_state.t_equivalentCode = 'ONSET_____' )" );

      rs = RsdRecordset( cmd );

      cmd.addParam( "psId", RSDBP_IN, transfer.rec.psId );
      cmd.addParam( "stateCode", RSDBP_IN, transfer.rec.state );

      cmd.execute( );

      if ( rs.moveNext( ) )
        ;
      else
        stat = false;

        cmd = RsdCommand( "select * from drmto_op_dbt rmto_op " +
                          "where rmto_op.t_branch = :branch and " +
                                "rmto_op.t_transId = :transId and " +
                                "rmto_op.t_opNum in ( :opNum1, :opNum2 ) and " +
                                "rmto_op.t_isSentToCC > 0 and " +
                                "rmto_op.t_action not in ( :action1, :action2 )" );

        rs = RsdRecordset( cmd );

        cmd.addParam( "branch", RSDBP_IN, transfer.rec.branch );
        cmd.addParam( "transId", RSDBP_IN, transfer.rec.transId );
        cmd.addParam( "opNum1", RSDBP_IN, MTOP_send );
        cmd.addParam( "opNum2", RSDBP_IN, MTOP_send_dep );
        cmd.addParam( "action1", RSDBP_IN, D_DELETE );
        cmd.addParam( "action2", RSDBP_IN, D_STORN );

        cmd.execute( );

        if ( rs.moveNext( ) )
          stat = true;
        else
          PushErrorMessage( "Перевод должен быть в состоянии \"К выплате\" или отправлен в КЦ" );
        end;
      end;
    end; 

    // Проверка признака "нашего" банка --------------------------------
    if ( stat )
      if ( transfer.rec.ourFlag == 0 )
        stat = false;
        PushErrorMessage( "Перевод должен быть принят в \"нашем\" банке" );
      end;
    end;

    // Проверка в КЦ, что данный перевод не был ранее выплачен ---------
    if ( stat )
      stat = isTransferPaidOut( );

      if ( not stat )
        stat = true;
      else
        stat = false;
        PushErrorMessage( "По данным Клирингового центра перевод уже был выплачен" );
      end;
    end;

    // Подтверждение операции вторым лицом -----------------------------
    if ( stat )
      stat = CritWaitAcceptEx( 0, "Прошу разрешить аннулирование срочного перевода" );
    end;

    return stat;
  end;

  // =====================================================================
  macro calcCommission( )

    return true;
  end;
  
  // =====================================================================
  macro createDocuments( )

    return true;
  end;

  // =====================================================================
  InitTMtOpReverse( p_opNum, p_subOpNum, p_psId );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro createInstance ( opNum, subOpNum, psId )

  var opModify = TMtCngReverseOpAssign( opNum, subOpNum, psId ); 

  return opModify;
end;
