import DeprIntr, MonTransInter, BankInter, globals, rsd, rcw, sqlconv, mtcntng_webserv, mtcng_service;

private var rmto_trans = Tbfile( "rmto_trans.dbt", "w", 0 );
private var rmto_op = Tbfile( "rmto_op.dbt", "w", 0 );
private var rmtr_ps = Tbfile( "rmtr_ps.dbt", "r", 0 );

private var {BatchMode};


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro GetNamePS( psId )

  rmtr_ps.KeyNum = 0;
  rmtr_ps.Clear;
  rmtr_ps.rec.psId = psId;

  if ( rmtr_ps.GetEQ )
    return rmtr_ps.rec.psName;
  else
    return "";
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro getStatusCode( statusCode )

  var req = TReqGetState;
  var resp = TRespGetState;
  var retCode = 0;
  var stat = false;

  statusCode = 0;

  req.attr.USER_ID = rmto_trans.rec.recPartyID;
  req.attr.DOC_ID = rmto_trans.rec.psTransID;

  retCode = CNG_Request( req, resp );

  if ( retCode == 0 )
    retCode = resp.attr.RE;
  end;

  if ( retCode == 0 )
    statusCode = resp.attr.STATE;
    stat = true;
  end;

  SetParm( 0, statusCode );

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro isNeedChangeStatus( prevStatus, newStatus )

  var needChange = false;
  var cmd;
  var rs;

  if ( prevStatus != newStatus )
    cmd = RsdCommand( "select rmtr_state.t_equivalentcode as equivalentCode " +
                      "from drmtr_state_dbt rmtr_state "+
                      "where rmtr_state.t_psid = :psid and " +
                            "rmtr_state.t_statecode = :statecode" );

    cmd.addParam( "psid", RSDBP_IN, rmto_trans.rec.psId );
    cmd.addParam( "statecode", RSDBP_IN, prevStatus );

    rs = RsdRecordset( cmd );

    cmd.execute( );

    if ( rs.moveNext( ) )
      if ( rs.value( "equivalentCode" ) != newStatus )
        needChange = true;
      end;
    else
      needChange = true;
    end;
  end;

  return needChange;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro formCommandForSelect ( forCount, psId, minSendDate, maxSendDate, actual, sendCC, sender, receiver )  

  var cmd = RsdCommand( "" );
  var rs;
  var cmdText = "";
  var branch = NumFNCash( );

  if ( forCount )
    cmdText = "select count( * )";
  else
    cmdText = "select rmto_trans.t_branch as branch, rmto_trans.t_transid as transid";
  end;

  cmdText = cmdText + " from drmto_trans_dbt rmto_trans " + 
                       "where rmto_trans.t_branch = :branch";
  cmd.addParam( "branch", RSDBP_IN, branch );

  if ( psId > 0 )
    cmdText = cmdText + " and rmto_trans.t_psId = ?";
    cmd.addParam( "", RSDBP_IN, psId );
  end;

  if ( ( minSendDate != Date( 0, 0, 0 ) ) and ( minSendDate == maxSendDate ) )
    cmdText = cmdText + " and rmto_trans.t_sendDate = ?";
    cmd.addParam( "", RSDBP_IN, minSendDate );
  elif ( ( minSendDate != Date( 0, 0, 0 ) ) and ( maxSendDate != Date( 0, 0, 0 ) ) )
    cmdText = cmdText + " and ( rmto_trans.t_sendDate between ? and ? )";
    cmd.addParam( "", RSDBP_IN, minSendDate );
    cmd.addParam( "", RSDBP_IN, maxSendDate );
  elif ( minSendDate != Date( 0, 0, 0 ) )
    cmdText = cmdText + " and rmto_trans.t_sendDate >= ?";
    cmd.addParam( "", RSDBP_IN, minSendDate );
  elif ( maxSendDate != date( 0, 0, 0 ) )
    cmdText = cmdText + " and rmto_trans.t_sendDate <= ?";
    cmd.addParam( "", RSDBP_IN, maxSendDate );
  end;

  if ( ValType( actual ) == V_INTEGER )
    if ( actual == 1 )
      cmdText = cmdText + " and ( rmto_trans.t_state = ? or " +
                                 "rmto_trans.t_state = ? or " +
                                 "rmto_trans.t_state = ? or " +
                                 "rmto_trans.t_state = ? or " +
                                 "exists( select 1 from drmtr_state_dbt rmtr_state " +
                                         "where rmtr_state.t_psId = rmto_trans.t_psId and " +
                                               "rmtr_state.t_stateCode = rmto_trans.t_state and " +
                                               "rmtr_state.t_equivalentCode in ( ?, ?, ?, ? ) ) )";
                                                
      cmd.addParam( "", RSDBP_IN, "RECEIVED__" );
      cmd.addParam( "", RSDBP_IN, "ONSET_____" );
      cmd.addParam( "", RSDBP_IN, "REQ_RETURN" );
      cmd.addParam( "", RSDBP_IN, "TO_BE_RETD" );
      cmd.addParam( "", RSDBP_IN, "RECEIVED__" );
      cmd.addParam( "", RSDBP_IN, "ONSET_____" );
      cmd.addParam( "", RSDBP_IN, "REQ_RETURN" );
      cmd.addParam( "", RSDBP_IN, "TO_BE_RETD" );
    elif ( actual == 2 )
      cmdText = cmdText + " and ( rmto_trans.t_state = ? or " +
                                 "rmto_trans.t_state = ? or " +
                                 "rmto_trans.t_state = ? or " +
                                 "rmto_trans.t_state = ? or " +
                                 "exists( select 1 from drmtr_state_dbt rmtr_state " +
                                         "where rmtr_state.t_psId = rmto_trans.t_psId and " +
                                               "rmtr_state.t_stateCode = rmto_trans.t_state and " +
                                               "rmtr_state.t_equivalentCode in ( ?, ?, ?, ? ) ) )";
                                                
      cmd.addParam( "", RSDBP_IN, "FINISHED__" );
      cmd.addParam( "", RSDBP_IN, "RETURNED__" );
      cmd.addParam( "", RSDBP_IN, "ISSUED____" );
      cmd.addParam( "", RSDBP_IN, "ABORTED___" );
      cmd.addParam( "", RSDBP_IN, "FINISHED__" );
      cmd.addParam( "", RSDBP_IN, "RETURNED__" );
      cmd.addParam( "", RSDBP_IN, "ISSUED____" );
      cmd.addParam( "", RSDBP_IN, "ABORTED___" );
    end;
  elif ( ValType( actual ) == V_STRING )
    if ( actual != "" )
      cmdText = cmdText + " and ( rmto_trans.t_state = ? or " + 
                                 "exists( select 1 from drmtr_state_dbt rmtr_state " + 
                                         "where rmtr_state.t_psId = rmto_trans.t_psId and " + 
                                               "rmtr_state.t_stateCode = rmto_trans.t_state and " + 
                                               "rmtr_state.t_equivalentCode = ? ) )";
      cmd.addParam( "", RSDBP_IN, actual );
      cmd.addParam( "", RSDBP_IN, actual );
    end;
  end;

  if ( sendCC > 0 )
    cmdText = cmdText + " and exists( select 1 from drmto_op_dbt rmto_op where " +
                                     "rmto_op.t_branch = rmto_trans.t_branch and " +
                                     "rmto_op.t_transId = rmto_trans.t_transId and ";

    if ( sendCC == 1 )
      cmdText = cmdText + "rmto_op.t_issenttocc >= 1";
    else
      cmdText = cmdText + "rmto_op.t_issenttocc < 1";
    end;

    cmdText = cmdText + " and rmto_op.t_action != 2 and rmto_op.t_action != 11 )";
  end;

  if ( sender != "" )
    cmdText = cmdText + " and trim( upper( rmto_trans.t_senderName1 || ' ' || rmto_trans.t_senderName2 || ' ' || rmto_trans.t_senderName3 ) ) = trim( upper( ? ) )";
    cmd.addParam( "", RSDBP_IN, sender );
  end;

  if ( receiver != "" )
    cmdText = cmdText + " and trim( upper( rmto_trans.t_recName1 || ' ' || rmto_trans.t_recName2 || ' ' || rmto_trans.t_recName3 ) ) = trim( upper( ? ) )";
    cmd.addParam( "", RSDBP_IN, receiver );
  end;

  cmdText = cmdText + " and rmto_trans.t_ourflag > 0";

  cmdText = cmdText + " and ( rmto_trans.t_state = ? or " +
                             "rmto_trans.t_state = ? or " +
                             "rmto_trans.t_state = ? or " +
                             "rmto_trans.t_state = ? or " +
                             "exists( select 1 from drmtr_state_dbt rmtr_state " +
                                     "where rmtr_state.t_psId = rmto_trans.t_psId and " +
                                           "rmtr_state.t_stateCode = rmto_trans.t_state and " +
                                           "rmtr_state.t_equivalentCode in ( ?, ?, ?, ? ) ) )";
                                              
  cmd.addParam( "", RSDBP_IN, "RECEIVED__" );
  cmd.addParam( "", RSDBP_IN, "ONSET_____" );
  cmd.addParam( "", RSDBP_IN, "REQ_RETURN" );
  cmd.addParam( "", RSDBP_IN, "TO_BE_RETD" );
  cmd.addParam( "", RSDBP_IN, "RECEIVED__" );
  cmd.addParam( "", RSDBP_IN, "ONSET_____" );
  cmd.addParam( "", RSDBP_IN, "REQ_RETURN" );
  cmd.addParam( "", RSDBP_IN, "TO_BE_RETD" );

  cmdText = cmdText + " and rmto_trans.t_action != 2 and rmto_trans.t_action != 11";

  cmd.CmdText = cmdText;

  rs = RsdRecordset( cmd );

  cmd.execute( );

  return rs;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro IsActual ( )
  var actual = false;
  var cmd, rs;

  if ( ( rmto_trans.rec.state == "RECEIVED__" ) or
       ( rmto_trans.rec.state == "ONSET_____" ) or
       ( rmto_trans.rec.state == "REQ_RETURN" ) or
       ( rmto_trans.rec.state == "TO_BE_RETD" )   )
    actual = true;
  else
    cmd = RsdCommand( "select 1 from drmtr_state_dbt rmtr_state " +
                      "where rmtr_state.t_psId = ? and " +
                            "rmtr_state.t_stateCode = ? and " +
                            "rmtr_state.t_equivalentCode in ( ?, ?, ?, ? )" );

    cmd.addParam( "", RSDBP_IN, rmto_trans.rec.psId );
    cmd.addParam( "", RSDBP_IN, rmto_trans.rec.state );
    cmd.addParam( "", RSDBP_IN, "RECEIVED__" );
    cmd.addParam( "", RSDBP_IN, "ONSET_____" );
    cmd.addParam( "", RSDBP_IN, "REQ_RETURN" );
    cmd.addParam( "", RSDBP_IN, "TO_BE_RETD" );

    cmd.execute;

    rs = RsdRecordset( cmd );

    if ( rs.moveNext( ) )
      actual = true;
    end;
  end;

  return actual;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro SingleSync ( NeedFullUpdate, branch, transId )

  var transferTemplate = TMtTransfer( );
  var sateBefore = "";
  var statusCode = 0;
  var needUpdate = false;
  var errCode = 0;

  rmto_trans.Clear;
  rmto_trans.KeyNum = 0;
  rmto_trans.rec.branch = branch;
  rmto_trans.rec.transId = transId;

  if ( rmto_trans.GetEQ )
    sateBefore = rmto_trans.rec.state;
  else
    errCode = -1;
  end;

  if ( NeedFullUpdate and ( errCode == 0 ) )
    if ( ( rmto_trans.rec.psTransID > 0 ) and ( rmto_trans.rec.ourFlag > 0 ) and IsActual( ) )
      ;
    else
      errCode = -6;
    end;
  end;

  if ( errCode == 0 )
    if ( rmto_trans.rec.psId != 3 )
      errCode = -4;
    elif ( rmto_trans.rec.psTransID <= 0 )
      errCode = -5;
    end;
  end;

  if ( errCode == 0 )
    if ( NeedFullUpdate )
      if ( GetPaymentData( rmto_trans.rec.psTransID, transferTemplate, null, true, statusCode ) )
        if ( ( transferTemplate.rec.recName1 != "" ) and ( StrUpr( rmto_trans.rec.recName1 ) != StrUpr( transferTemplate.rec.recName1 ) ) )
          rmto_trans.rec.recName1 = transferTemplate.rec.recName1;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recName2 != "" ) and ( StrUpr( rmto_trans.rec.recName2 ) != StrUpr( transferTemplate.rec.recName2 ) ) ) 
          rmto_trans.rec.recName2 = transferTemplate.rec.recName2;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recName3 != "" ) and ( StrUpr( rmto_trans.rec.recName3 ) != StrUpr( transferTemplate.rec.recName3 ) ) )
          rmto_trans.rec.recName3 = transferTemplate.rec.recName3;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recBorn != Date( 0, 0, 0 ) ) and ( rmto_trans.rec.recBorn != transferTemplate.rec.recBorn ) )
          rmto_trans.rec.recBorn = transferTemplate.rec.recBorn;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recCountry != "" ) and ( StrUpr( rmto_trans.rec.recCountry ) != StrUpr( transferTemplate.rec.recCountry ) ) )
          rmto_trans.rec.recCountry = transferTemplate.rec.recCountry;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recCountryCode != "" ) and ( StrUpr( rmto_trans.rec.recCountryCode ) != StrUpr( transferTemplate.rec.recCountryCode ) ) )
          rmto_trans.rec.recCountryCode = transferTemplate.rec.recCountryCode;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recCitizenship != "" ) and ( StrUpr( rmto_trans.rec.recCitizenship ) != StrUpr( transferTemplate.rec.recCitizenship ) ) )
          rmto_trans.rec.recCitizenship = transferTemplate.rec.recCitizenship;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recAdress != "" ) and ( StrUpr( rmto_trans.rec.recAdress ) != StrUpr( transferTemplate.rec.recAdress ) ) )
          rmto_trans.rec.recAdress = transferTemplate.rec.recAdress;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recPostIndex != "" ) and ( StrUpr( rmto_trans.rec.recPostIndex ) != StrUpr( transferTemplate.rec.recPostIndex ) ) )
          rmto_trans.rec.recPostIndex = transferTemplate.rec.recPostIndex;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recRegion != "" ) and ( StrUpr( rmto_trans.rec.recRegion ) != StrUpr( transferTemplate.rec.recRegion ) ) )
          rmto_trans.rec.recRegion = transferTemplate.rec.recRegion;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recPlace != "" ) and ( StrUpr( rmto_trans.rec.recPlace ) != StrUpr( transferTemplate.rec.recPlace ) ) )
          rmto_trans.rec.recPlace = transferTemplate.rec.recPlace;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recPlaceName != "" ) and ( StrUpr( rmto_trans.rec.recPlaceName ) != StrUpr( transferTemplate.rec.recPlaceName ) ) )
          rmto_trans.rec.recPlaceName = transferTemplate.rec.recPlaceName;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recPhoneNumber != "" ) and ( StrUpr( rmto_trans.rec.recPhoneNumber ) != StrUpr( transferTemplate.rec.recPhoneNumber ) ) )
          rmto_trans.rec.recPhoneNumber = transferTemplate.rec.recPhoneNumber;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recPhoneNumber != "" ) and ( StrUpr( rmto_trans.rec.recPhoneNumber ) != StrUpr( transferTemplate.rec.recPhoneNumber ) ) )
          rmto_trans.rec.recPhoneNumber = transferTemplate.rec.recPhoneNumber;
          needUpdate = true;
        end;

        if ( ( transferTemplate.rec.recNotResident != 0 ) and ( rmto_trans.rec.recNotResident != transferTemplate.rec.recNotResident ) )
          rmto_trans.rec.recNotResident = transferTemplate.rec.recNotResident;
          needUpdate = true;
        end;

        if ( transferTemplate.rec.recPaperNumber != "" )
          if ( rmto_trans.rec.recPaperKind != transferTemplate.rec.recPaperKind )
            rmto_trans.rec.recPaperKind = transferTemplate.rec.recPaperKind;
            needUpdate = true;
          end;

          if ( rmto_trans.rec.recPaperIssuedDate != transferTemplate.rec.recPaperIssuedDate )
            rmto_trans.rec.recPaperIssuedDate = transferTemplate.rec.recPaperIssuedDate;
            needUpdate = true;
          end;

          if ( StrUpr( rmto_trans.rec.recPaperSeries ) != StrUpr( transferTemplate.rec.recPaperSeries ) )
            rmto_trans.rec.recPaperSeries = transferTemplate.rec.recPaperSeries;
            needUpdate = true;
          end;

          if ( StrUpr( rmto_trans.rec.recPaperNumber ) != StrUpr( transferTemplate.rec.recPaperNumber ) )
            rmto_trans.rec.recPaperNumber = transferTemplate.rec.recPaperNumber;
            needUpdate = true;
          end;

          if ( StrUpr( rmto_trans.rec.recPaperIssuer ) != StrUpr( transferTemplate.rec.recPaperIssuer ) )
            rmto_trans.rec.recPaperIssuer = transferTemplate.rec.recPaperIssuer;
            needUpdate = true;
          end;

          if ( StrUpr( rmto_trans.rec.recPaperIssuerCode ) != StrUpr( transferTemplate.rec.recPaperIssuerCode ) )
            rmto_trans.rec.recPaperIssuerCode = transferTemplate.rec.recPaperIssuerCode;
            needUpdate = true;
          end;
        end;
      else
        errCode = -2;
      end;
    else
      if ( getStatusCode( statusCode ) )
        ;
      else
        errCode = -2;
      end;
    end;
  end;

  if ( errCode == 0 )
    if ( ( statusCode == 0 ) or ( statusCode == 1 ) or ( statusCode == 2 ) or ( statusCode == 3 ) )
      if ( isNeedChangeStatus( sateBefore, "RECEIVED__" ) )
        rmto_trans.rec.state = "RECEIVED__";
      end;
    elif ( ( statusCode == 4 ) or ( statusCode == 5 ) )
      if ( isNeedChangeStatus( sateBefore, "ONSET_____" ) )
        rmto_trans.rec.state = "ONSET_____";
      end;
    elif ( statusCode == 7 )
      if ( isNeedChangeStatus( sateBefore, "REQ_RETURN" ) )
        rmto_trans.rec.state = "REQ_RETURN";
      end;
    elif ( ( statusCode == 8 ) or ( statusCode == 9 ) )
      if ( isNeedChangeStatus( sateBefore, "TO_BE_RETD" ) )
        rmto_trans.rec.state = "TO_BE_RETD";
      end;
    elif ( statusCode == 6 )
      if ( isNeedChangeStatus( sateBefore, "FINISHED__" ) )
        rmto_trans.rec.state = "FINISHED__";
      end;
    elif ( statusCode == 10 )
      if ( isNeedChangeStatus( sateBefore, "RETURNED__" ) )
        rmto_trans.rec.state = "RETURNED__";
      end;
    elif ( statusCode == -1 )
      if ( isNeedChangeStatus( sateBefore, "ABORTED___" ) )
        rmto_trans.rec.state = "ABORTED___";
      end;
    end;
  end;

  if ( errCode == 0 )
    if ( ( sateBefore != rmto_trans.rec.state ) or needUpdate )
      if ( not rmto_trans.Update )
        errCode = -3;
      end;

      if ( errCode == 0 )
        rmto_op.Clear;
        rmto_op.rec.opApplicationKind = 210;
        rmto_op.rec.opApplicationKey = FormApplicationKey( 210 );
        rmto_op.rec.branch = rmto_trans.rec.branch;
        rmto_op.rec.transId = rmto_trans.rec.transId;
        rmto_op.rec.opDate = {curdate};
        rmto_op.rec.opNum = 23;
        rmto_op.rec.subOpNum = 0;
        rmto_op.rec.stateBefore = sateBefore;
        rmto_op.rec.stateAfter = rmto_trans.rec.state;
        rmto_op.rec.isSentToCC = 1;
        rmto_op.rec.oper = {oper};

        if ( not rmto_op.Insert )
          errCode = -3;
        end;
      end;
    end;
  end;

  return errCode;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro Sync ( psId, minSendDate, maxSendDate, actual, sendCC, sender, receiver )

  var cmdCount;
  var rsCount;
  var cmd;
  var rs;
  var branch = NumFNCash( );
  var transId = 0;
  var countAll = 0;
  var countCur = 0;
  var errCode = 0;
  var statusCode = 0;
  var sateBefore = "";
  var nameBranch = "";
  var namePS = "";

  if ( not findDepartment( Branch, nameBranch ) )
    nameBranch = "";
  end;

  if ( psId > 0 )
    namePS = GetNamePS ( psId );
  end;

  [ ];
  [ Подразделение Банка #]( nameBranch );
  [ ];
  if ( psId > 0 )
    [ Платежная система   #]( namePS );
    [ ];
  end;
  [ Дата и время актуализации #]( String( Date( ):f ) + " " + String( Time( ):f ) );
  [ ];
  [              ИЗМЕНЕНИЕ СОСТОЯНИЙ СРОЧНЫХ ПЕРЕВОДОВ/ПЛАТЕЖЕЙ];
  println( " ------------------------------------------------------------------------------" );
  println( " |Номер срочного перевода|Дата перевода| Старое состояние | Текущее состояние |" );
  println( " ------------------------------------------------------------------------------" );

  rsCount = formCommandForSelect( true, psId, minSendDate, maxSendDate, actual, sendCC, sender, receiver );
  rs = formCommandForSelect( false, psId, minSendDate, maxSendDate, actual, sendCC, sender, receiver );

  if ( rsCount.moveNext( ) )
    countAll = Int( rsCount.value( 0 ) );
  end;

  if ( countAll > 0 )
    InitProgress( countAll, null, "Актуализация срочных переводов" );
  end;

  while ( rs.moveNext( ) )

    countCur = countCur + 1;

    if ( countAll > 0 )
      UseProgress( countCur );
    end;

    errCode = 0;
    sateBefore = "";

    branch = rs.value( "branch" );
    transId = rs.value( "transid" );

    rmto_trans.Clear;
    rmto_trans.KeyNum = 0;
    rmto_trans.rec.branch = branch;
    rmto_trans.rec.transId = transId;

    if ( rmto_trans.GetEQ )
      ;
    else
      errCode = -1;
    end;

    if ( errCode == 0 )
      sateBefore = rmto_trans.rec.state;
    end;

    if ( errCode == 0 )
      if ( rmto_trans.rec.psId != 3 )
        errCode = -4;
      elif ( rmto_trans.rec.psTransID <= 0 )
        errCode = -5;
      end;
    end;

    if ( errCode == 0 )
      if ( not getStatusCode( statusCode ) )
        errCode = -2;
      end;
    end;

    if ( errCode == 0 )
      if ( ( statusCode == 0 ) or ( statusCode == 1 ) or ( statusCode == 2 ) or ( statusCode == 3 ) )
        if ( isNeedChangeStatus( sateBefore, "RECEIVED__" ) )
          rmto_trans.rec.state = "RECEIVED__";
        end;
      elif ( ( statusCode == 4 ) or ( statusCode == 5 ) )
        if ( isNeedChangeStatus( sateBefore, "ONSET_____" ) )
          rmto_trans.rec.state = "ONSET_____";
        end;
      elif ( statusCode == 7 )
        if ( isNeedChangeStatus( sateBefore, "REQ_RETURN" ) )
          rmto_trans.rec.state = "REQ_RETURN";
        end;
      elif ( ( statusCode == 8 ) or ( statusCode == 9 ) )
        if ( isNeedChangeStatus( sateBefore, "TO_BE_RETD" ) )
          rmto_trans.rec.state = "TO_BE_RETD";
        end;
      elif ( statusCode == 6 )
        if ( isNeedChangeStatus( sateBefore, "FINISHED__" ) )
          rmto_trans.rec.state = "FINISHED__";
        end;
      elif ( statusCode == 10 )
        if ( isNeedChangeStatus( sateBefore, "RETURNED__" ) )
          rmto_trans.rec.state = "RETURNED__";
        end;
      elif ( statusCode == -1 )
        if ( isNeedChangeStatus( sateBefore, "ABORTED___" ) )
          rmto_trans.rec.state = "ABORTED___";
        end;
      end;

      if ( sateBefore != rmto_trans.rec.state )
        if ( not rmto_trans.Update )
          errCode = -3;
        end;

        if ( errCode == 0 )
          rmto_op.Clear;
          rmto_op.rec.opApplicationKind = 210;
          rmto_op.rec.opApplicationKey = FormApplicationKey( 210 );
          rmto_op.rec.branch = rmto_trans.rec.branch;
          rmto_op.rec.transId = rmto_trans.rec.transId;
          rmto_op.rec.opDate = {curdate};
          rmto_op.rec.opNum = 23;
          rmto_op.rec.subOpNum = 0;
          rmto_op.rec.stateBefore = sateBefore;
          rmto_op.rec.stateAfter = rmto_trans.rec.state;
          rmto_op.rec.isSentToCC = 1;
          rmto_op.rec.oper = {oper};

          if ( not rmto_op.Insert )
            errCode = -3;
          end;
        end;
      end;
    end;

    if ( errCode == 0 )
      if ( sateBefore != rmto_trans.rec.state )
        [ |#######################| ##########  | ################ | ################# |]
        ( rmto_trans.rec.transCode, rmto_trans.rec.sendDate:f, sateBefore, rmto_trans.rec.state );
      end;
    end;

  end;

  if ( countAll > 0 )
    RemProgress( );
  end;

  println( " ------------------------------------------------------------------------------" );

  if ( {BatchMode} )
    Exit( 1 );
  end;

end;
