/*
$Name:               mtassign.mac
$Module:             Срочные переводы
$Description:        Базовые процедуры проведения операции приема срочного перевода
*/
import MTOperat, MTCommission;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
class ( TMtOperation ) TMtOpAssign( p_sendAccRef, p_opNum, p_subOpNum, p_psId, p_initClient )

  // =====================================================================
  private var sendAccRef = p_sendAccRef;
  private var opNum = p_opNum;
  private var subOpNum = p_subOpNum;
  private var initClient = p_initClient;

  private var commCalculator;
  private var prevFieldValue;

  private var vReferenc = 0;
  private var vAccount = "";
  private var vTypeAccount = "";
  private var vNeedCloseAccount = 0;

  private var recvAttr = NULL;

  private var clientForDepAcc = 0;

  private var isBlockFMRoll = 0; // Флаг блокировки выгрузки в ФМ

  private var wasPressEsc = false;
  private var forPayer = false;

  private var transRate_CB = 1.0;
  private var transRate_Buy = 1.0;
  private var transRate_Sell = 1.0;
  private var comissRate_1 = 1.0;
  private var comissRate_4 = 1.0;
  private var addPayRate_1 = 1.0;
  private var addPayRate_4 = 1.0;
  private var saveCurCodeForRate = -1;
  private var savePaymentCurCodeForRate = -1;
  private var saveCurCodeCommisForRate = -1;
  private var saveCurCodeCommisAddForRate = -1;

  private var aSymbols = TArray;

  if ( opNum == 0 )
    if ( p_sendAccRef > 0 )
      opNum = MTOP_send_dep;
    else
      opNum = MTOP_send;
    end;
  end;

  // =====================================================================
  macro initCommCalculator( )

    return TMtCommissionCalculator( system, transfer, opHistory.rec.opDate );
  end;

  // =====================================================================
  macro calcRates( ) : bool

    var rate, buyRate, sellRate;
    var rate2, buyRate2, sellRate2;
    var stat = true;

    // -----------------------------------------------------------------
    if ( transfer.rec.curCode != saveCurCodeForRate ) 

      transRate_CB = 1.0;
      transRate_Buy = 1.0;
      transRate_Sell = 1.0;

      if ( transfer.rec.curCode > 0 )
        stat = GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate, buyRate, sellRate );

        if ( stat )
          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;

          transRate_CB = rate;
          transRate_Buy = buyRate;
          transRate_Sell = sellRate;
        end;
      end;
    end;

    // -----------------------------------------------------------------
    if ( ( transfer.rec.curCodeCommis != saveCurCodeCommisForRate ) or ( transfer.rec.paymentCurCode != savePaymentCurCodeForRate ) )
      comissRate_1 = 1.0;
      comissRate_4 = 1.0;

      rate = buyRate = sellRate = 1.0;
      rate2 = buyRate2 = sellRate2 = 1.0;

      if ( transfer.rec.curCodeCommis > 0 )
        stat = GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommis, rate, buyRate, sellRate );

        if ( stat )
          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;
        else
          rate = buyRate = sellRate = 1.0;
        end;
      end;

      if ( stat and ( transfer.rec.paymentCurCode > 0 ) )
        stat = GetAllCurrRate( opHistory.rec.opDate, transfer.rec.paymentCurCode, rate2, buyRate2, sellRate2 );

        if ( stat )
          if ( rate2 == 0 )
            rate2 = buyRate2 = sellRate2 = 1.0;
          end;
        else
          rate2 = buyRate2 = sellRate2 = 1.0;
        end;
      end;

      if ( stat )
        comissRate_1 = rate / rate2;
        comissRate_4 = rate2;
      end;
    end;

    // -----------------------------------------------------------------
    if ( ( transfer.rec.curCodeCommisAdd != saveCurCodeCommisAddForRate ) or ( transfer.rec.paymentCurCode != savePaymentCurCodeForRate ) )
      addPayRate_1 = 1.0;
      addPayRate_4 = 1.0;

      rate = buyRate = sellRate = 1.0;
      rate2 = buyRate2 = sellRate2 = 1.0;

      if ( transfer.rec.curCodeCommisAdd > 0 )
        stat = GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommisAdd, rate, buyRate, sellRate );

        if ( stat )
          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;
        else
          rate = buyRate = sellRate = 1.0;
        end;
      end;

      if ( stat and ( transfer.rec.paymentCurCode > 0 ) )
        stat = GetAllCurrRate( opHistory.rec.opDate, transfer.rec.paymentCurCode, rate2, buyRate2, sellRate2 );

        if ( stat )
          if ( rate2 == 0 )
            rate2 = buyRate2 = sellRate2 = 1.0;
          end;
        else
          rate2 = buyRate2 = sellRate2 = 1.0;
        end;
      end;

      if ( stat )
        addPayRate_1 = rate / rate2;
        addPayRate_4 = rate2;
      end;
    end;

    saveCurCodeForRate = transfer.rec.curCode;
    savePaymentCurCodeForRate = transfer.rec.paymentCurCode;
    saveCurCodeCommisForRate = transfer.rec.curCodeCommis;
    saveCurCodeCommisAddForRate = transfer.rec.curCodeCommisAdd;

    return stat;
  end;

  // =====================================================================
  macro defCurCodeCommisAdd
    var rmtr_tariff = Tbfile( "rmtr_tariff.dbt", "r", 1 );
    var curCodeCommisAdd = 0;

    rmtr_tariff.Clear( );
    rmtr_tariff.rec.psId = transfer.rec.psId;
    rmtr_tariff.rec.destCode = transfer.rec.destCode;
    rmtr_tariff.rec.curCode = transfer.rec.curCode;

    if ( rmtr_tariff.GetEQ( ) )
      curCodeCommisAdd = rmtr_tariff.rec.curCodeAdd;
    end;

    if ( curCodeCommisAdd < 0 )
      curCodeCommisAdd = 0;
    end;

    return curCodeCommisAdd;
  end;

  // =====================================================================
  macro calcConcernedFields( )

    var sumCommisAll = transfer.rec.sumCommisAll;
    var sumAddService = transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
    var cbRate = 1.0;

    sumCommisAll = transfer.rec.sumCommisOur + transfer.rec.sumCommisCC;
    transfer.rec.sumCommisAll = sumCommisAll;

    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisAll" ).value = sumCommisAll;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumAddService" ).value = sumAddService;

      operPanel.getForm( MT_OPER_PANEL ).redraw( );
    end;

    // Подсчет сумм в панели к выплате
    transfer.rec.transRate_CB = 1.0;
    transfer.rec.transRate_Buy = 1.0;
    transfer.rec.transRate_Sell = 1.0;
    transfer.rec.comissRate_1 = 1.0;
    transfer.rec.comissRate_4 = 1.0;

    if ( operPanel.numForms > MT_TOPAY_PANEL )
      calcRates( );

      transfer.rec.transRate_CB = transRate_CB;
      transfer.rec.transRate_Buy = transRate_Buy;
      transfer.rec.transRate_Sell = transRate_Sell;
      transfer.rec.comissRate_1 = comissRate_1;
      transfer.rec.comissRate_4 = comissRate_4;

      if ( transfer.rec.paymentCurCode == transfer.rec.curCode )
        transfer.rec.transSum1 = transfer.rec.sum;
      else
        transfer.rec.transSum1 = Floor( MoneyL( transfer.rec.sum * transRate_Sell ) )
      end;

      transfer.rec.transSum2 = $0L;

      if ( ( transfer.rec.paymentType == 2 ) and ( transfer.rec.curCodeCommis == 0 ) )
        transfer.rec.comissSum1 = $0L;
      else
        transfer.rec.comissSum1 = Floor( MoneyL( transfer.rec.sumCommisAll * comissRate_1 ) );
      end;

      if ( ( transfer.rec.paymentType == 2 ) and ( transfer.rec.curCodeCommis == 0 ) )
        transfer.rec.comissSum2 = transfer.rec.sumCommisAll;
      else
        transfer.rec.comissSum2 = $0L;
      end;

      if ( ( transfer.rec.paymentType == 2 ) and ( transfer.rec.curCodeCommisAdd == 0 ) )
        transfer.rec.addPaySum1 = $0L;
      else
        transfer.rec.addPaySum1 = Floor( MoneyL( ( transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis ) * addPayRate_1 ) );
      end;

      if ( ( transfer.rec.paymentType == 2 ) and ( transfer.rec.curCodeCommisAdd == 0 ) )
        transfer.rec.addPaySum2 = transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
      else
        transfer.rec.addPaySum2 = $0L;
      end;

      if ( transfer.rec.paymentType == 0 )
        operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TransSum1" ).value +
                                                                              operPanel.getForm( MT_TOPAY_PANEL ).getControl( "ComissSum1" ).value +
                                                                              operPanel.getForm( MT_TOPAY_PANEL ).getControl( "AddPaySum1" ).value;
      end;

      if ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value >= transfer.rec.transSum1 )
        transfer.rec.transSum3 = transfer.rec.transSum1;
      else
        transfer.rec.transSum3 = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value;
      end;

      if ( transfer.rec.paymentCurCode == 0 )
        transfer.rec.transSum4 = transfer.rec.transSum1 - transfer.rec.transSum3;
      else
        transfer.rec.transSum4 = ( transfer.rec.transSum1 - transfer.rec.transSum3 ) * transRate_Sell;
      end;

      if ( ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value - transfer.rec.transSum3 ) >= transfer.rec.comissSum1 )
        transfer.rec.comissSum3 = transfer.rec.comissSum1;
      else
        transfer.rec.comissSum3 = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value - transfer.rec.transSum3;
      end;

      if ( transfer.rec.paymentCurCode == 0 )
        transfer.rec.comissSum4 = transfer.rec.comissSum1 - transfer.rec.comissSum3 + transfer.rec.comissSum2;
      else
        if ( ( transfer.rec.comissSum3 == 0 ) and ( transfer.rec.curCodeCommis == 0 ) )
          transfer.rec.comissSum4 = transfer.rec.sumCommisAll;
        else
          transfer.rec.comissSum4 = ( transfer.rec.comissSum1 - transfer.rec.comissSum3 ) * comissRate_4 + transfer.rec.comissSum2;
        end;
      end;

      if ( ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value - transfer.rec.transSum3 - transfer.rec.comissSum3 ) >= transfer.rec.addPaySum1 )
        transfer.rec.addPaySum3 = transfer.rec.addPaySum1;
      else
        transfer.rec.addPaySum3 = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value - transfer.rec.transSum3 - transfer.rec.comissSum3;
      end;

      if ( transfer.rec.paymentCurCode == 0 )
        transfer.rec.addPaySum4 = transfer.rec.addPaySum1 - transfer.rec.addPaySum3 + transfer.rec.addPaySum2;
      else
        if ( ( transfer.rec.addPaySum3 == 0 ) and ( transfer.rec.curCodeCommisAdd == 0 ) )
          transfer.rec.addPaySum4 = transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
        else
          transfer.rec.addPaySum4 = ( transfer.rec.addPaySum1 - transfer.rec.addPaySum3 ) * addPayRate_4 + transfer.rec.addPaySum2;
        end;
      end;

      operPanel.getForm( MT_TOPAY_PANEL ).getControl( "sumCommisAdd" ).value = transfer.rec.notificationCommis +
                                                                               transfer.rec.deliveryCommis +
                                                                               transfer.rec.informationCommis;
         
      operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum1" ).value = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TransSum1" ).value +
                                                                            operPanel.getForm( MT_TOPAY_PANEL ).getControl( "ComissSum1" ).value +
                                                                            operPanel.getForm( MT_TOPAY_PANEL ).getControl( "AddPaySum1" ).value;

      operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum2" ).value = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TransSum2" ).value +
                                                                            operPanel.getForm( MT_TOPAY_PANEL ).getControl( "ComissSum2" ).value +
                                                                            operPanel.getForm( MT_TOPAY_PANEL ).getControl( "AddPaySum2" ).value;

      operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum4" ).value = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TransSum4" ).value +
                                                                            operPanel.getForm( MT_TOPAY_PANEL ).getControl( "ComissSum4" ).value +
                                                                            operPanel.getForm( MT_TOPAY_PANEL ).getControl( "AddPaySum4" ).value;

      operPanel.getForm( MT_TOPAY_PANEL ).redraw( );
    end;

  end;

  // =====================================================================
  macro calcCommission( )

    if ( ValType( commCalculator ) != V_UNDEF )
      commCalculator.calcCommission( );

      calcConcernedFields( );
    end;

    return true;
  end;

  // =====================================================================
  macro initRecvAttr( )

    if ( ( transfer.rec.recBankName        != "" ) or 
         ( transfer.rec.recBankCode        != "" ) or 
         ( transfer.rec.recBankCorrAccount != "" ) or 
         ( transfer.rec.recBankAccount     != "" )   )
      recvAttr = TRecHandler( "rtpaymentprop.dbt" );

      recvAttr.Clear( );

      recvAttr.rec.BankCodeKind = transfer.rec.recBankCodeKind;
      recvAttr.rec.BankCode = transfer.rec.recBankCode;
      recvAttr.rec.BankName = transfer.rec.recBankName;
      recvAttr.rec.CorrAccount = transfer.rec.recBankCorrAccount;
      recvAttr.rec.Account = transfer.rec.recBankAccount;
      recvAttr.rec.Account_CurrCode = transfer.rec.curCode;
      recvAttr.rec.Branch = transfer.rec.branch;
    end;

  end;

  // =====================================================================
  macro checkTotalSum ( messError )

     var stat = true;

     messError = "";

     if ( ( operPanel.numForms > MT_TOPAY_PANEL ) and ( transfer.rec.paymentCurCode > 0 ) )
       if ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value > operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum1" ).value )
         messError = "Сумма внесения не может превышать " + String( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum1" ).value:0:2:a ) + " " + operPanel.getForm( MT_TOPAY_PANEL ).getControl( "curCodeTotalSum1" ).value;
         stat = false;
       end;
     end;

     SetParm( 1, messError );

    return stat;
  end;

  // =====================================================================
  macro setFocusEventHandler( ev )

    var curControl = operPanel.getForm( MT_OPER_PANEL ).focusedControl;
    var curControlName = null;

    if ( curControl != null )
      curControlName = curControl.name;
    end;

    if ( ( StrUpr( curControlName ) == "SUM"                ) or 
         ( StrUpr( curControlName ) == "SUMCOMMISALL"       ) or 
         ( StrUpr( curControlName ) == "SUMCOMMISOUR"       ) or 
         ( StrUpr( curControlName ) == "SUMCOMMISCC"        ) or 
         ( StrUpr( curControlName ) == "NOTIFICATIONCOMMIS" ) or 
         ( StrUpr( curControlName ) == "DELIVERYCOMMIS"     ) or 
         ( StrUpr( curControlName ) == "INFORMATIONCOMMIS"  ) or 
         ( StrUpr( curControlName ) == "INFORMATIONTEXT"    ) or
         ( StrUpr( curControlName ) == "SUMSHNAME"          ) or 
         ( StrUpr( curControlName ) == "DESTNAME"           )   )
      prevFieldValue = operPanel.getForm( MT_OPER_PANEL ).getControl( curControlName ).value;
    end;

    return true;
  end;

  // =====================================================================
  macro setFocusEventHandlerToPay( ev )

    var curControl = operPanel.getForm( MT_TOPAY_PANEL ).focusedControl;
    var curControlName = null;

    if ( curControl != null )
      curControlName = curControl.name;
    end;

    if ( ( StrUpr( curControlName ) == "SUM"         ) or
         ( StrUpr( curControlName ) == "TOTALSUM3"   ) or
         ( StrUpr( curControlName ) == "PAYMENTTYPE" )   )
      prevFieldValue = operPanel.getForm( MT_TOPAY_PANEL ).getControl( curControlName ).value;
    end;

    return true;
  end;

  // =====================================================================
  macro remFocusEventHandlerToPay( ev )

    var curControl = operPanel.getForm( MT_TOPAY_PANEL ).focusedControl;
    var curControlName = null;
    var messError = "";

    if ( curControl != null )
      curControlName = curControl.name;
    end;

    if ( StrUpr( curControlName ) == "TOTALSUM3" )
      if ( not checkTotalSum( messError ) )
        MsgBox( messError );
      end;
    end;

    return true;
  end;

  // =====================================================================
  macro quitWindowToPay( ev )

    var messError = "";

    if ( not wasPressEsc )
      if ( not checkTotalSum( messError ) )
        MsgBox( messError );
      end;
    end;

    return true;
  end;

  // =====================================================================
  macro controlCheckedEventHandler( ev )

    var curControl = operPanel.getForm( MT_OPER_PANEL ).focusedControl;
    var curControlName = null;

    if ( curControl != null)
      curControlName = curControl.name;
    end;

    if ( curControlName != null )

      if ( StrUpr( curControlName ) == "NOTIFICATIONFLAG" )
        commCalculator.calcNotificationCommission( );
      elif ( StrUpr( curControlName ) == "DELIVERYFLAG" )
        commCalculator.calcDeliveryCommission( );
      elif ( StrUpr( curControlName ) == "INFORMATIONFLAG" )
        commCalculator.calcInformationCommission( );
      end;

      calcConcernedFields( );
    end;

    return true;
  end;

  // =====================================================================
  macro chooseCashSymbol( )
    var i = 0;
    var cmd, rs;
    var docKind = 1;
    var nameSymbol;
    var aMenu = TArray;

    while ( i < aSymbols.size )
      cmd = RSDCommand( "select listsymb.t_Name as Name "
                        "from dlistsymb_dbt listsymb "
                        "where listsymb.t_DocKind = ? and "
                              "listsymb.t_Symb_Cash = ?" );

      cmd.addParam( "DocKind", RSDBP_IN, docKind );
      cmd.addParam( "Symb_Cash", RSDBP_IN, aSymbols[i] );

      rs = RsdRecordSet( cmd );

      cmd.execute( );

      nameSymbol = "";
      if ( rs.moveNext )
        nameSymbol = rs.value( "Name" );

        if ( nameSymbol == StrFor( 1 ) )
          nameSymbol = "";
        end;
      end;

      aMenu[i] = " " + aSymbols[i] + " " + nameSymbol + " ";

      i = i + 1;
    end;

    i = Menu( aMenu, NULL, "Кассовый символ" );

    if ( i >= 0 )
      transfer.rec.cashSIn_Nat = aSymbols[i];
    end;
  end;

  // =====================================================================
  macro operEventHandler( ev )

    var keyCode = ev.keyCode;
    var curPanel = operPanel.currentTab;
    var curControl = curPanel.focusedControl;
    var curControlName = null;
    var vSendAccRef = sendAccRef;

    if ( curControl != null )
      curControlName = curControl.name;
    end;

    if ( keyCode == MTK_F3 )
      if ( ( StrUpr( curControlName ) == "SUMSHNAME" ) and ( vSendAccRef > 0 ) )
        return false;
      end;

      if ( ( StrUpr( curControlName ) == "SENDERACCOUNT" ) and ( ( vSendAccRef > 0 ) or ( opNum == MTOP_send ) ) )
        return false;
      end;

      if ( StrUpr( curControlName ) == "CASHSIN_NAT" )
        if ( aSymbols.size == 1 )
          return false;
        elif ( aSymbols.size > 1 )
          chooseCashSymbol( );
          return false;
        end;
      end;
    end;

    return true;
  end;

  // =====================================================================
  macro operEventHandlerForAll( ev )

    var keyCode = ev.keyCode;

    if ( keyCode == MTK_ESC )
      wasPressEsc = true;
    else
      wasPressEsc = false;
    end;

    return true;
  end;

  // =====================================================================
  macro postEventHandler( ev )

    var keyCode = ev.keyCode;
    var curPanel = operPanel.currentTab;
    var curControl = curPanel.focusedControl;
    var curControlName = null;
    var nominal;

    if ( curControl != null )
      curControlName = curControl.name;
    else
      return true;
    end;

    if ( StrUpr( curControlName ) == "SUM" )
      if ( prevFieldValue != operPanel.getForm( MT_OPER_PANEL ).getControl( "sum" ).value )
        commCalculator.setHandInput( false );
        calcCommission( );
      end;
    elif ( ( StrUpr( curControlName ) == "PAYMENTTYPE" ) or
           ( StrUpr( curControlName ) == "TOTALSUM3"   )   )
      if ( prevFieldValue != operPanel.getForm( MT_TOPAY_PANEL ).getControl( curControlName ).value )
        if ( StrUpr( curControlName ) == "PAYMENTTYPE" )
          operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value = $0L;
        end;

        if ( ( StrUpr( curControlName ) == "TOTALSUM3" ) and ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value > 0 ) )
          nominal = utils.getMinNominal( transfer.rec.paymentCurCode );

          if ( mod( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value, nominal ) != 0 )
            MsgBox( "Ошибка задания вносимой суммы. Сумма должна быть кратна " + String( nominal:0:2:a ) );
          end;
        end;

        calcConcernedFields( );
      end;
    elif ( ( StrUpr( curControlName ) == "SUMCOMMISOUR"       ) or 
           ( StrUpr( curControlName ) == "SUMCOMMISCC"        ) or
           ( StrUpr( curControlName ) == "NOTIFICATIONCOMMIS" ) or 
           ( StrUpr( curControlName ) == "DELIVERYCOMMIS"     ) or 
           ( StrUpr( curControlName ) == "INFORMATIONCOMMIS"  )   ) 
      if ( prevFieldValue != operPanel.getForm( MT_OPER_PANEL ).getControl( curControlName ).value )

        if ( ( StrUpr( curControlName ) == "SUMCOMMISOUR" ) or 
             ( StrUpr( curControlName ) == "SUMCOMMISCC"  )   )
          commCalculator.setHandInput( true );
        end;
        calcConcernedFields( );
      end;
    elif ( StrUpr( curControlName ) == "SUMCOMMISALL" )
      if ( prevFieldValue != operPanel.getForm( MT_OPER_PANEL ).getControl( curControlName ).value )
        commCalculator.setHandInput( true );

        commCalculator.calcCommission( operPanel.getForm( MT_OPER_PANEL ).getControl( curControlName ).value );

        calcConcernedFields( );
      end;
    elif ( StrUpr( curControlName ) == "INFORMATIONTEXT" )
      if ( prevFieldValue != operPanel.getForm( MT_OPER_PANEL ).getControl( curControlName ).value )
        commCalculator.calcInformationCommission( );
        calcConcernedFields( );
      end;
    elif ( StrUpr( curControlName ) == "DESTNAME" )
      if ( ( keyCode == MTK_SPACE ) or ( keyCode == MTK_F3 ) )
        if ( isForeignCounterparty( ) )
          transfer.rec.insideTheCountry = "";
        else
          transfer.rec.insideTheCountry = "X";
        end;

        transfer.rec.curCodeCommisAdd = defCurCodeCommisAdd( );

        commCalculator.setHandInput( false );
        commCalculator.loadTariff( );
        calcCommission( );
      end;
    elif ( StrUpr( curControlName ) == "SUMSHNAME" )
      if ( keyCode == MTK_F3 )
        if ( ( operPanel.numForms > MT_TOPAY_PANEL ) and ( prevFieldValue != operPanel.getForm( MT_OPER_PANEL ).getControl( curControlName ).value ) )
          operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value = $0L;
        end;

        transfer.rec.curCodeCommisAdd = defCurCodeCommisAdd( );

        commCalculator.setHandInput( false );
        commCalculator.loadTariff( );
        calcCommission( );
      end;
    end;

    return true;
  end;

  // =====================================================================
  macro addUserKeyHandler

    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.getForm( MT_OPER_PANEL ).addEventHandler( RSB_EV_SET_FOCUS, r2m( this, "setFocusEventHandler" ) );
      operPanel.getForm( MT_TOPAY_PANEL ).addEventHandler( RSB_EV_SET_FOCUS, r2m( this, "setFocusEventHandlerToPay" ) );
      operPanel.getForm( MT_TOPAY_PANEL ).addEventHandler( RSB_EV_REMOVE_FOCUS, r2m( this, "remFocusEventHandlerToPay" ) );
      operPanel.getForm( MT_TOPAY_PANEL ).addEventHandler( RSB_EV_QUIT_WINDOW, r2m( this, "quitWindowToPay" ) );
      operPanel.getForm( MT_OPER_PANEL ).addEventHandler( RSB_EV_CONTROL_CHECKED, r2m( this, "controlCheckedEventHandler" ) );
      operPanel.getForm( MT_OPER_PANEL ).addEventHandler( RSB_EV_KEY_PRESSED, r2m( this, "operEventHandler" ) );
      operPanel.addEventHandler( RSB_EV_KEY_PRESSED, r2m( this, "postEventHandler" ) );

      var i;

      for ( i, 0, operPanel.numForms - 1 )
        operPanel.getForm( i ).addEventHandler( RSB_EV_KEY_PRESSED, r2m( this, "operEventHandlerForAll" ) );
      end;
    end;
  end;

  // =====================================================================
  macro defCashSymbols( )

    var rmtr_subop = Tbfile( "rmtr_subop.dbt", "r", 0 );
    var i;
    var j;
    var symb = "";
    var symb1 = "";
    var needAddSymbol;

    rmtr_subop.KeyNum = 0;
    rmtr_subop.Clear;
    rmtr_subop.rec.psId = transfer.rec.psId;
    rmtr_subop.rec.numOp = opHistory.rec.opNum;
    rmtr_subop.rec.numSubOp = opHistory.rec.subOpNum;
                     
    if ( rmtr_subop.GetEQ( ) )

      if ( transfer.rec.senderNotResident == 0 )
        transfer.rec.cashSIn_Val = rmtr_subop.rec.cashSCur;
      else
        transfer.rec.cashSIn_Val = rmtr_subop.rec.cashSCNR;
      end;
      if ( ( StrLen( transfer.rec.cashSIn_Val ) > 0 ) and ( StrLen( transfer.rec.cashSIn_Val ) < 3 ) )
        transfer.rec.cashSIn_Val = " " + transfer.rec.cashSIn_Val;
      end;

      if ( StrLen( rmtr_subop.rec.cashSymbol ) > 0 )
        i = 0;
        while ( i < StrLen( rmtr_subop.rec.cashSymbol ) )
          symb1 = SubStr( rmtr_subop.rec.cashSymbol, i + 1, 1 );
          if ( ( symb1 == "," ) or ( symb1 == ";" ) or ( i == StrLen( rmtr_subop.rec.cashSymbol ) - 1 ) )
            if ( ( i == StrLen( rmtr_subop.rec.cashSymbol ) - 1 ) and ( symb1 != "," ) and ( symb1 != ";" ) )
              symb = symb + symb1;
            end;

            if ( StrLen( symb ) < 3 )
              symb = " " + symb;
            end;

            needAddSymbol = true;
            if ( aSymbols.size > 0 )
              j = 0;
              while ( j < aSymbols.size )
                if ( Trim( aSymbols[j] ) == Trim( symb ) )
                  needAddSymbol = false;
                  break;
                end;
                j = j + 1;
              end;
            end;

            if ( needAddSymbol )
              aSymbols[aSymbols.size] = symb;
            end;

            symb = "";
          else
            symb = symb + symb1;
          end;
          i = i + 1;
        end;
      end;
    end;

    if ( aSymbols.size > 0 )
      transfer.rec.cashSIn_Nat = aSymbols[0];
    else
      transfer.rec.cashSIn_Nat = " 13";
    end;
  end;

  // =====================================================================
  macro startInit( )

    var depositr = Tbfile( "depositr.dbt", "r", 4 );
    var rmtr_subop = Tbfile( "rmtr_subop.dbt", "r", 0 );
    record recInitClient( "commclnt.rec" );
    var clientList = TClientList;
    var transCode = "";
    var vSendAccRef = sendAccRef;
    var i;

    ClearRecord( recInitClient );
    if ( ValType( initClient ) != V_UNDEF )
      SetBuff( recInitClient, initClient );
    end;

    MT_PAYER_PANEL    = 2;
    MT_RECEIVER_PANEL = 3;
    MT_AUX_PANEL      = 4;

    startInit( );

    opHistory.rec.stateAfter = "RECEIVED__";
    opHistory.rec.opNum = opNum;
    opHistory.rec.subOpNum = subOpNum;

    transfer.rec.branch = NumFNcash( );
    transfer.rec.psId = system.rec.psId;
    transfer.rec.sendDate = {curdate};
    transfer.rec.ourFlag = 1;
    transfer.rec.state = "RECEIVED__";
    transfer.rec.sendPointCode = String( {OurBank} );
    transfer.rec.action = 0;

    if ( vSendAccRef == 0 )
      if ( recInitClient.CodClient > 0 )
        if ( clientList.GetRecord( recInitClient.CodClient ) )
          transfer.rec.senderPartyID = clientList.CurRec.rec.CodClient;
          transfer.rec.senderName1 = clientList.CurRec.rec.Name1;
          transfer.rec.senderName2 = clientList.CurRec.rec.Name2;
          transfer.rec.senderName3 = clientList.CurRec.rec.Name3;
          transfer.rec.senderBorn = clientList.CurRec.rec.Born;
          transfer.rec.senderCitizenship = clientList.CurRec.rec.NRCountry;
          transfer.rec.senderPaperKind = clientList.CurRec.rec.PaperKind;
          transfer.rec.senderPaperSeries = clientList.CurRec.rec.PaperSeries;
          transfer.rec.senderPaperNumber = clientList.CurRec.rec.PaperNumber;
          transfer.rec.senderPaperIssuedDate = clientList.CurRec.rec.PaperIssuedDate;
          transfer.rec.senderPaperIssuer = clientList.CurRec.rec.PaperIssuer;
          transfer.rec.senderPaperIssuerCode = clientList.CurRec.rec.PaperIssuerCode;
          transfer.rec.senderCountry = clientList.CurRec.rec.Country;
          transfer.rec.senderPostIndex = clientList.CurRec.rec.PostIndex;
          transfer.rec.senderRegion = clientList.CurRec.rec.Region;
          transfer.rec.senderPlace = clientList.CurRec.rec.Place;
          transfer.rec.senderAdress = clientList.CurRec.rec.Address;
          transfer.rec.senderPhoneNumber = clientList.CurRec.rec.PhoneNumber;
          if ( clientList.CurRec.rec.NotResident == StrFor( 0 ) )
            transfer.rec.senderNotResident = 0;
          else
            transfer.rec.senderNotResident = 1;
          end;
        end;
      else
        if ( recInitClient.Name1 != "" )
          transfer.rec.senderName1 = recInitClient.Name1;
          transfer.rec.senderName2 = recInitClient.Name2;
          transfer.rec.senderName3 = recInitClient.Name3;
          transfer.rec.senderBorn = recInitClient.Born;
          transfer.rec.senderBornPlace = recInitClient.BirsPlace;
          transfer.rec.senderAdress = recInitClient.Address;

          if ( recInitClient.PaperNumber != "" )
            transfer.rec.senderPaperKind = recInitClient.PaperKind;
            transfer.rec.senderPaperSeries = recInitClient.PaperSeries;
            transfer.rec.senderPaperNumber = recInitClient.PaperNumber;
            transfer.rec.senderPaperIssuer = recInitClient.PaperIssuer;
            transfer.rec.senderPaperIssuedDate = recInitClient.PaperIssuedDate;
          end;
        end;
      end;
    end;
    
    if ( vSendAccRef > 0 )
      depositr.KeyNum = 8;
      depositr.Clear;
      depositr.rec.Referenc = vSendAccRef;

      transfer.rec.senderDepReferenc = vSendAccRef;

      if ( depositr.GetEQ( ) )
        if ( clientList.GetRecord( depositr.rec.CodClient ) )
          transfer.rec.senderPartyID = clientList.CurRec.rec.CodClient;
          transfer.rec.senderName1 = clientList.CurRec.rec.Name1;
          transfer.rec.senderName2 = clientList.CurRec.rec.Name2;
          transfer.rec.senderName3 = clientList.CurRec.rec.Name3;
          transfer.rec.senderBorn = clientList.CurRec.rec.Born;
          transfer.rec.senderCitizenship = clientList.CurRec.rec.NRCountry;
          transfer.rec.senderPaperKind = clientList.CurRec.rec.PaperKind;
          transfer.rec.senderPaperSeries = clientList.CurRec.rec.PaperSeries;
          transfer.rec.senderPaperNumber = clientList.CurRec.rec.PaperNumber;
          transfer.rec.senderPaperIssuedDate = clientList.CurRec.rec.PaperIssuedDate;
          transfer.rec.senderPaperIssuer = clientList.CurRec.rec.PaperIssuer;
          transfer.rec.senderPaperIssuerCode = clientList.CurRec.rec.PaperIssuerCode;
          transfer.rec.senderCountry = clientList.CurRec.rec.Country;
          transfer.rec.senderPostIndex = clientList.CurRec.rec.PostIndex;
          transfer.rec.senderRegion = clientList.CurRec.rec.Region;
          transfer.rec.senderPlace = clientList.CurRec.rec.Place;
          transfer.rec.senderAdress = clientList.CurRec.rec.Address;
          transfer.rec.senderPhoneNumber = clientList.CurRec.rec.PhoneNumber;
          if ( clientList.CurRec.rec.NotResident == StrFor( 0 ) )
            transfer.rec.senderNotResident = 0;
          else
            transfer.rec.senderNotResident = 1;
          end;

          transfer.rec.curCode = depositr.rec.Code_Currency;
          transfer.rec.curCodeCommis = depositr.rec.Code_Currency;
          transfer.rec.curCodeCommisAdd = depositr.rec.Code_Currency;

          if ( transfer.rec.curCode == 0 )
            transfer.rec.recBankCodeKind = 3;
          else
            transfer.rec.recBankCodeKind = 6;
          end;
        end;
      end;
    else
      if ( NumFlagCur( ) == 0 )
        transfer.rec.recBankCodeKind = 3;
      else
        transfer.rec.curCode = 1;
        transfer.rec.recBankCodeKind = 6;
      end;
    end;

    transfer.rec.curCodeCommis = transfer.rec.curCode;
    transfer.rec.curCodeCommisAdd = defCurCodeCommisAdd( );

    if ( ( opNum == MTOP_send_dep ) or ( vSendAccRef > 0 ) )
      if ( operPanel.numForms > MT_PAYER_PANEL )
        for ( i, 0, operPanel.getForm( MT_PAYER_PANEL ).numControls - 1 )

          if ( operPanel.getForm( MT_PAYER_PANEL ).getControl( i ).editable )
            operPanel.getForm( MT_PAYER_PANEL ).getControl( i ).editable = false;
          end;
          operPanel.getForm( MT_PAYER_PANEL ).getControl( i ).focusable = false;
        end;

        operPanel.getForm( MT_PAYER_PANEL ).getControl( "name1" ).focusable = true;

        operPanel.getForm( MT_PAYER_PANEL ).status = 
          " ~F2~ Ввод  ~F3~ Справочники  ~F5~ Особенности  ~Esc~ Выход";
      end;
      // Дополнительные действия для панели получателя
      if ( operPanel.numForms > MT_RECEIVER_PANEL )
        operPanel.getForm( MT_RECEIVER_PANEL ).getControl( "agent" ).enabled = false;
        operPanel.getForm( MT_RECEIVER_PANEL ).status = 
          " ~F2~ Ввод  ~F3~ Справочники  ~F5~ Особенности  ~Esc~ Выход";
      end;
    end;

    if ( system.rec.refId > 0 )
      GenerateReference( system.rec.refId, transCode );

      transfer.rec.transCode = transCode;
          
      if ( ( transfer.rec.transCode != "" ) and ( operPanel.numForms > MT_OPER_PANEL ) )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "transCode" ).editable = false;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "transCode" ).focusable = false;
      end;
    end;

    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.getForm( MT_OPER_PANEL ).getControl( "senderBankName" ).focusable = false;

      if ( ( opHistory.rec.opNum > 0 ) and ( operPanel.numForms >= MT_OPER_PANEL ) )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "opNum" ).focusable = false;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "opName" ).focusable = false;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "subOpNum" ).focusable = false;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "subOpName" ).focusable = false;
      end;

      if ( ( transfer.rec.psId > 0 ) and ( operPanel.numForms >= MT_OPER_PANEL ) )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "psId" ).focusable = false;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "psName" ).focusable = false;
      end;
    end;

    if ( operPanel.numForms > MT_PAYER_PANEL )
      operPanel.getForm( MT_PAYER_PANEL ).getControl( "ident" ).editable = false;
      operPanel.getForm( MT_PAYER_PANEL ).getControl( "ident" ).focusable = true;
    end;

    if ( operPanel.numForms > MT_RECEIVER_PANEL )
      operPanel.getForm( MT_RECEIVER_PANEL ).getControl( "ident" ).editable = false;
      operPanel.getForm( MT_RECEIVER_PANEL ).getControl( "ident" ).focusable = false;
    end;

    if ( operPanel.numForms > MT_OPER_PANEL )
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisAll" ).editable = false;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisAll" ).focusable = false;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).editable = false;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).focusable = false;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).editable = false;
      operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).focusable = false;

      if ( TypeCalcComm == TYPE_CALC_COMM_EDIT_SUMALL )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisAll" ).editable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisAll" ).focusable = true;
      end;
      if ( ( TypeCalcComm == TYPE_CALC_COMM_EDIT_SUMOUR ) or ( TypeCalcComm == TYPE_CALC_COMM_EDIT_SUMOUR_SUMCC ) )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).editable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisOur" ).focusable = true;
      end;
      if ( ( TypeCalcComm == TYPE_CALC_COMM_EDIT_SUMCC ) or ( TypeCalcComm == TYPE_CALC_COMM_EDIT_SUMOUR_SUMCC ) )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).editable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "sumCommisCC" ).focusable = true;
      end;
    end;

    commCalculator = initCommCalculator( );
    calcCommission( );

    addUserKeyHandler( );

    transfer.rec.senderIdentType = defNumIdentClient( );
    transfer.rec.recIdentType = defNumIdentClient( );

    // Определение кассовых символов по умолчанию и возможных их значений
    defCashSymbols( );

    if ( opHistory.rec.subOpNum > 0 )
      rmtr_subop.KeyNum = 0;
      rmtr_subop.Clear;
      rmtr_subop.rec.psId = system.rec.psId;
      rmtr_subop.rec.numOp = opNum;
      rmtr_subop.rec.numSubOp = opHistory.rec.subOpNum;

      if ( rmtr_subop.GetEQ )
        transfer.rec.ReportType = rmtr_subop.rec.ReportType;
      end;
    end;

    if ( transfer.rec.ReportType == 0 )
      transfer.rec.recNPflag = 1;
    else
      transfer.rec.recNPflag = 0;
    end;

    if ( operPanel.numForms > MT_OPER_PANEL )
      if ( transfer.rec.recNPflag == 0 )
        operPanel.getForm( MT_OPER_PANEL ).getControl( "chargeId" ).editable = true;
        operPanel.getForm( MT_OPER_PANEL ).getControl( "chargeId" ).focusable = true;
      end;
    end;

    return true;
  end;

  // =====================================================================
  macro finalInit( )

    if ( isForeignCounterparty( ) )
      transfer.rec.insideTheCountry = "";
    else
      transfer.rec.insideTheCountry = "X";
    end;

    return true;
  end;

  // =====================================================================
  macro checkLimitSumForTransfer( )

    var rmtr_cur = Tbfile( "rmtr_cur.dbt", "r", 0 );
    var stat = true;

    rmtr_cur.KeyNum = 0;
    rmtr_cur.Clear;
    rmtr_cur.rec.psId = transfer.rec.psId;
    rmtr_cur.rec.curCode = transfer.rec.curCode;

    if ( rmtr_cur.GetEQ( ) )
      if ( ( rmtr_cur.rec.limitSum > 0 ) and ( transfer.rec.sum > rmtr_cur.rec.limitSum ) )
        stat = false;
      end;
    end;  

    return stat;
  end;

  // =====================================================================
  macro check( )

    var clientList = TClientList;
    var rmtr_ps = Tbfile( "rmtr_ps.dbt", "r", 0 );
    var messError = "";
    var controlChargeId = true;
    var regError = 0;
    var stat = true;

    correctIdentType( );

    if ( ( ( opNum == MTOP_send     ) OR       // Прием перевода наличными
           ( opNum == MTOP_send_dep )   ) AND  // Списание срочным переводом
         ( transfer.rec.senderIdentType == MTCLNT_IDENT_STANDART ) AND
         ( transfer.rec.recNPflag != 0 ) AND
         ( defCodeServiceClient( true ) == 0 ) AND
         ( transfer.rec.senderPartyID == 0 ) )

      if ( stat )
        if ( transfer.rec.senderName1 == "" )
          setErrorMessage( "Задайте фамилию отправителя", MT_PAYER_PANEL, npc_name1 );
          stat = false;
        end;
      end;

      if ( stat )
        if ( transfer.rec.senderName2 == "" )
          setErrorMessage( "Задайте имя отправителя", MT_PAYER_PANEL, npc_name2 );
          stat = false;
        end;
      end;
    end;

    if ( stat )
      if ( not checkTotalSum( messError ) )
        setErrorMessage( messError, MT_TOPAY_PANEL, nptp_totalSum3 );
        stat = false;
      end;
    end;

    if ( stat )
      if ( transfer.rec.transCode == "" )
        setErrorMessage( "Задайте номер перевода", MT_OPER_PANEL, npo_psCode );
        stat = false;
      end;
    end;

    if ( stat and ( opNum == MTOP_send_dep ) )
      if ( transfer.rec.senderDepReferenc == 0 )
        setErrorMessage( "Задайте счет вкладчика", MT_OPER_PANEL, npo_senderAccount );
        stat = false;
      end;
    end;

    if ( stat )
      if ( isForeignCounterparty( ) )
        if ( transfer.rec.senderAdress == "" )
          setErrorMessage( "Для трансграничных переводов обязательно заполнение адреса плательщика",
              MT_PAYER_PANEL, npc_address );
          stat = false;
        end;
      end;
    end;

    if ( stat )
      if ( transfer.rec.recNPflag == 0 )
        if ( StrLen( transfer.rec.recAccount ) > 5 )
          if ( SubStr( transfer.rec.recAccount, 1, 5 ) == "40822" )
            if ( GetRegistryValue( "RS-RETAIL\\СЕРВИСНЫЕ\\КОНТРОЛЬ_УИП", V_BOOL, controlChargeId, regError ) == V_BOOL )
              ;
            else
              controlChargeId = true;
            end;

            if ( controlChargeId )
              if ( ( StrLen( transfer.rec.chargeId ) < 25 ) or ( SubStr( transfer.rec.chargeId, 1, 25 ) == "0000000000000000000000000" ) )
                setErrorMessage( "Значение поля УИП указано неверно", MT_OPER_PANEL, npo_chargeId );
                stat = false;
              elif ( CheckKeyChargeId( transfer.rec.recAccount, transfer.rec.chargeId ) == false )
                setErrorMessage( "Значение УИП введено неверно", MT_OPER_PANEL, npo_chargeId );
                stat = false;
              end;
            end;
          end;
        end;
      end;
    end;

    if ( stat )
      stat = checkLimitSumForTransfer( );
      if ( not stat )
        setErrorMessage( "Сумма перевода превышает лимитирующую сумму за один перевод", MT_OPER_PANEL, npo_sum );
      end;
    end;
    
    // Проверка идентификации отправителя
    if ( stat )
      stat = checkSenderIdent( );
    end;

    // Проверка идентификации получателя
    if ( stat )
      stat = checkRecIdent( );
    end;

    // Проверка на банкротство
    if ( stat )
      if ( transfer.rec.senderPartyID > 0 )
        var statBancrupt = 0;
        var clientRole = "V";

        if ( operPanel.getForm( MT_PAYER_PANEL ).getControl( "agent" ).checked )
          clientRole = "D";
        end;

        statBancrupt = CheckOnBancruptStart( transfer.rec.senderPartyID, clientRole, 100 /* ПЕРЕВОДЫ_ПРИЕМ */, {curdate}, resolutionFMByBankrupt );

        if ( statBancrupt == 0 )
          if ( resolutionFMByBankrupt == 0 )
            ; // Банкрот, но операцию проводить можно
          else
            ; // Не банкрот или процедура банкротства завершена
          end;
        elif ( statBancrupt == -9999 )
          if ( not GetTrue( false, getfmsg( 4472 ) ) )
            statBancrupt = CheckOnBancruptEnd( 0, 100 /* ПЕРЕВОДЫ_ПРИЕМ */, resolutionFMByBankrupt );

            if ( statBancrupt > 100 )
              SetErrorMessage( statBancrupt, MT_PAYER_PANEL, npc_partyId );
              stat = false;
            end;
          else
            resolutionFMByBankrupt = 1;
          end;
        elif ( statBancrupt > 100 )
          SetErrorMessage( statBancrupt, MT_PAYER_PANEL, npc_partyId );
          stat = false;
        end;
      else
        resolutionFMByBankrupt = -1;
      end;
    end;

    if ( stat )
      stat = checkLimitSum( );

      if ( not stat )
        setErrorMessage( "Превышено ограничение на перевод денежных средств резидентом (за один день)" );
      end;
    end;

    // Проверка нахождения в стоп-листе плательщика и получателя -------
    if ( stat )
      stat = transfer.checkStopList( );
    end;

    if ( stat )
      stat = check( );
    end;

    return stat;
  end;

  // =====================================================================
  macro isRubleTransferToRussia

    return transfer.rec.curCode == 0;
  end;

  // =====================================================================
  macro createDocuments( )

    var depositr = Tbfile( "depositr.dbt", "r", 4 );
    var depclnt = TClientList;
    var doc;
    var stat = true;
    var statOpenAcc = 0;
    var clientList = TClientList;
    var rate, buyRate, sellRate;
    var rate2, buyRate2, sellRate2;
    var sumForConvert = $0L;
    var cmd, rs;

    var vNeedOpenAccount = 0;

    vReferenc = 0;
    vAccount = "";
    vTypeAccount = "";
    vNeedCloseAccount = 0;

    clientForDepAcc = defCodeServiceClient( true );

    if ( clientForDepAcc == 0 )
      clientForDepAcc = transfer.rec.senderPartyID;
    end;

    if ( transfer.rec.senderIdentType == MTCLNT_IDENT_STANDART )
      isBlockFMRoll = 1;  // Включается флаг блокировки выгрузки в ФМ.
    end;

    // Определим, нужно ли открывать вкладной счет ---------------------
    vTypeAccount = determineTypeAccount( false, transfer.rec.curCode );

    if ( ( system.rec.closeAccFlag == "" ) and ( clientForDepAcc > 0 ) )

      cmd = RSDCommand( "select depositr.t_Account as Account, depositr.t_Referenc as Referenc "
                        "from ddepositr_dbt depositr "
                        "where depositr.t_CodClient = ? and "
                              "depositr.t_FNCash = ? and "
                              "depositr.t_Open_Close = chr( 0 ) and "
                              "depositr.t_Type_Account = ? and "
                              "depositr.t_Code_Currency = ? and "
                              "depositr.t_Action != 2 "
                        "order by depositr.t_CodClient" );
                                  
      cmd.addParam( "CodClient", RSDBP_IN, clientForDepAcc );
      cmd.addParam( "FNCash", RSDBP_IN, transfer.rec.branch );
      cmd.addParam( "Type_Account", RSDBP_IN, vTypeAccount );
      cmd.addParam( "Code_Currency", RSDBP_IN, transfer.rec.curCode );

      rs = RsdRecordSet( cmd );

      cmd.Execute( );

      if ( rs.moveNext )
        vAccount = rs.value( "Account" );
        vReferenc = rs.value( "Referenc" );
      else
        vAccount = "";
      end;
    end;

    if ( system.rec.closeAccFlag != "" )
      vNeedOpenAccount = 1;
      vNeedCloseAccount = 1;
    else
      vNeedCloseAccount = 0;

      if ( vAccount != "" )
        vNeedOpenAccount = 0;
      else
        vNeedOpenAccount = 1;
      end;
    end;
      
    // Надо открыть новый счет, а клиента нет, заведем его -------------
    if ( ( vNeedOpenAccount == 1 ) and ( clientForDepAcc == 0 ) )

      if ( ( transfer.rec.senderName1 != "" ) and ( transfer.rec.senderName2 != "" ) )
        clientForDepAcc = defClientFromClientData( true );
        transfer.rec.senderPartyID = clientForDepAcc;
      end;

      if ( clientForDepAcc == 0 )
        depclnt.CurRec.Clear( );

        depclnt.CurRec.rec.CodClient = 0;

        depclnt.CurRec.rec.Name1 = transfer.rec.senderName1;
        depclnt.CurRec.rec.Name2 = transfer.rec.senderName2;
        depclnt.CurRec.rec.Name3 = transfer.rec.senderName3;

        depclnt.CurRec.rec.Born = transfer.rec.senderBorn;
        depclnt.CurRec.rec.BirsPlace = transfer.rec.senderBornPlace;

        if ( transfer.rec.senderNotResident != 0 )
          depclnt.CurRec.rec.NotResident = "X";
        end;
        depclnt.CurRec.rec.NRCountry = transfer.rec.senderCitizenship;

        if ( ( transfer.rec.senderPaperSeries == "" ) and ( transfer.rec.senderPaperNumber == "" ) )
          depclnt.CurRec.rec.PaperKind = -1;
        else
          depclnt.CurRec.rec.PaperKind       = transfer.rec.senderPaperKind;
          depclnt.CurRec.rec.PaperSeries     = transfer.rec.senderPaperSeries;
          depclnt.CurRec.rec.PaperNumber     = transfer.rec.senderPaperNumber;
          depclnt.CurRec.rec.PaperIssuedDate = transfer.rec.senderPaperIssuedDate;
          depclnt.CurRec.rec.PaperIssuer     = transfer.rec.senderPaperIssuer;
          depclnt.CurRec.rec.PaperIssuerCode = transfer.rec.senderPaperIssuerCode;
          depclnt.CurRec.rec.IsMain          = "X";
        end;
              
        if ( ( transfer.rec.senderCountry == "" ) and ( transfer.rec.senderPostIndex == "" ) and ( transfer.rec.senderAdress == "" ) and ( transfer.rec.senderPhoneNumber == "" ) )
          ;
        else
          depclnt.CurRec.rec.AdressType  = 1;
          depclnt.CurRec.rec.Country     = transfer.rec.senderCountry;
          depclnt.CurRec.rec.PostIndex   = transfer.rec.senderPostIndex;
          depclnt.CurRec.rec.CodeRegion  = transfer.rec.senderRegion;
          depclnt.CurRec.rec.Territory   = "00";
          depclnt.CurRec.rec.Place       = transfer.rec.senderPlace;
          depclnt.CurRec.rec.Address     = transfer.rec.senderAdress;
          depclnt.CurRec.rec.PhoneNumber = transfer.rec.senderPhoneNumber;
          depclnt.CurRec.rec.E_Mail      = transfer.rec.senderEMail;
        end;

        depclnt.CurRec.rec.FNcash = transfer.rec.branch;
          
        depclnt.MayInsert = true;

        stat = depclnt.Insert( );

        if ( stat )
          transfer.rec.senderPartyID = depclnt.CurRec.rec.CodClient;
          clientForDepAcc = transfer.rec.senderPartyID;
        else
          setErrorMessage( "Ошибка при вставке нового клиента" );
        end;
      end;
    end;
    
    // Если нужно открыть вкладной счет, откроем его -------------------
    if ( stat and ( vNeedOpenAccount == 1 ) )
      depositr.Clear;
      depositr.rec.Type_Account  = vTypeAccount;
      depositr.rec.Code_Currency = transfer.rec.curCode;
      depositr.rec.CodClient     = clientForDepAcc;
      depositr.rec.Open_Date     = transfer.rec.sendDate;
      if ( depositr.rec.Open_Date == Date( 0, 0, 0 ) )
        depositr.rec.Open_Date = {curdate};
      end;

      statOpenAcc = НовыйСчетБезДокументов( depositr, 1 );

      if ( statOpenAcc != 0 )
        stat = false;
        if ( statOpenAcc > 100 )
          setErrorMessage( statOpenAcc );
        else
          setErrorMessage( "Ошибка при создании нового счета вкладчика \"" + vTypeAccount + "\"" );
        end;
      else
        vReferenc = depositr.rec.Referenc;
        vAccount = depositr.rec.Account;
      end;
    end;

    initRecvAttr( );

    // Прием срочного перевода -----------------------------------------
    if ( stat )
      if ( ( vNeedOpenAccount == 1 ) or ( ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value > 0 ) and ( transfer.rec.paymentCurCode == transfer.rec.curCode ) ) )
        if ( vNeedOpenAccount == 1 )
          if ( transfer.rec.curCode == 0 )
            doc = newDepDoc( 1 );
          else
            doc = newDepDoc( 2 );
          end;
        else
          if ( transfer.rec.curCode == 0 )
            doc = newDepDoc( 3 );
          else
            doc = newDepDoc( 4 );
          end;
        end;

        doc.rec.Referenc = vReferenc;
        doc.rec.Type_Account = vTypeAccount;
        doc.rec.Account = vAccount;
        if ( transfer.rec.curCode == 0 )
          doc.rec.IsCur = 0;
        else
          doc.rec.IsCur = 1;
        end;
        doc.rec.Code_Currency = transfer.rec.curCode;
        doc.rec.VidDoc = 1; // Налично
        doc.rec.KindOp = D_IN;
        if ( ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value > 0 ) and ( transfer.rec.paymentCurCode == transfer.rec.curCode ) )
          doc.rec.InSum = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value;
        else
          doc.rec.InSum = 0;
        end;
        doc.rec.OutSum = 0;
        doc.rec.Action = D_INSERT;
        doc.rec.Ground = "Прием срочного перевода";

        initClientInfoInDepDoc( doc, true, clientForDepAcc );

        stat = docList.insert( doc );

        if ( not stat )
          setErrorMessage( "Ошибка при попытке вставить документ в список" );
        end;
      end;
    end;

    if ( stat )
      transfer.rec.accRef = vReferenc;
    end;

    // Конверсия -------------------------------------------------------
    if ( stat )
      if ( ( transfer.rec.curCode > 0 ) and ( ( ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value > 0 ) and ( transfer.rec.paymentCurCode == 0 ) ) or ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum4" ).value > 0 ) ) )
        doc = newPayDoc( 5, NULL, "pay_doc.cnv" );

        doc.rec.KonvertSum = transfer.rec.sum;
        if ( transfer.rec.curCodeCommis == transfer.rec.curCode )	
          doc.rec.KonvertSum = doc.rec.KonvertSum + transfer.rec.sumCommisOur + transfer.rec.sumCommisCC;
        else
          if ( ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommis, rate, buyRate, sellRate ) ) and
               ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate2, buyRate2, sellRate2 ) ) )

            if ( rate == 0 )
              rate = buyRate = sellRate = 1.0;
            end;

            if ( rate2 == 0 )
              rate2 = buyRate2 = sellRate2 = 1.0;
            end;

            doc.rec.KonvertSum = doc.rec.KonvertSum + Floor( MoneyL( ( transfer.rec.sumCommisOur + transfer.rec.sumCommisCC ) * ( rate / rate2 ) ) );
          else
            doc.rec.KonvertSum = doc.rec.KonvertSum + transfer.rec.sumCommisOur + transfer.rec.sumCommisCC;
          end;
        end;
        if ( transfer.rec.curCodeCommisAdd == transfer.rec.curCode )	
          doc.rec.KonvertSum = doc.rec.KonvertSum + transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
        else
          if ( ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommisAdd, rate, buyRate, sellRate ) ) and
               ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate2, buyRate2, sellRate2 ) ) )

            if ( rate == 0 )
              rate = buyRate = sellRate = 1.0;
            end;

            if ( rate2 == 0 )
              rate2 = buyRate2 = sellRate2 = 1.0;
            end;

            doc.rec.KonvertSum = doc.rec.KonvertSum + Floor( MoneyL( ( transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis ) * ( rate / rate2 ) ) );
          else
            doc.rec.KonvertSum = doc.rec.KonvertSum + transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
          end;
        end;

        if ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum4" ).value > 0 ) // Частичная оплата в валюте
          doc.rec.InSum = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum4" ).value;
          doc.rec.VydachSum = doc.rec.InSum;

          doc.rec.KonvertSum = doc.rec.KonvertSum - operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value;
        else // Полная оплата в валюте
          doc.rec.InSum = operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value;
          doc.rec.VydachSum = doc.rec.InSum;
        end;

        if ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate, buyRate, sellRate ) )
          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;
        else
          rate = buyRate = sellRate = 1.0;
        end;

        sumForConvert = doc.rec.KonvertSum;

        doc.rec.IsCur = 1;
        doc.rec.CodCur = 0;
        doc.rec.VydachCodCur = doc.rec.CodCur;
        doc.rec.KonvertCodCur = transfer.rec.curCode;
        doc.rec.Rate = sellRate;
        doc.rec.CBRate = rate;
        doc.rec.Ground = "Конверсия";
        doc.rec.Action = D_INSERT;
        doc.rec.VidDoc = StrFor( 0 ); // Наличный
        doc.rec.DebetCredit = DOC_CREDIT; // Приходный документ
        doc.rec.FlagCredit = StrFor( 1 );
        doc.rec.ClntIdentType = transfer.rec.senderIdentType;

        initClientInfoInPayDoc( doc, true );

        stat = docList.insert( doc );

        if ( not stat )
          setErrorMessage( "Ошибка при попытке вставить документ в список" );
        end;
      end;
    end;

    // Зачисление на счет суммы конверсии ------------------------------
    if ( stat and ( sumForConvert > 0 ) )
      doc = newDepDoc( 7 );

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_PUT;
      doc.rec.InSum = sumForConvert;
      doc.rec.OutSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Отправка срочного перевода в клиринговый центр";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc, recvAttr );

      if ( not stat )
        setErrorMessage( "Зачисление на счет суммы конверсии" );
      end;
    end;

    // Списание срочного перевода --------------------------------------
    if ( stat )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 8 );
      else
        doc = newDepDoc( 9 );
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_GET;
      doc.rec.InSum = 0;
      doc.rec.OutSum = transfer.rec.sum;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Отправка срочного перевода в клиринговый центр";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc, recvAttr );

      if ( not stat )
        setErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Взимание платы нашему банку -------------------------------------
    if ( stat and ( transfer.rec.sumCommisOur != 0 ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 10 );
      else
        doc = newDepDoc( 11 );
      end;
      
      if ( transfer.rec.curCodeCommis == transfer.rec.curCode )	
        doc.rec.OutSum = transfer.rec.sumCommisOur;
      else
        if ( ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommis, rate, buyRate, sellRate ) ) and
             ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate2, buyRate2, sellRate2 ) ) )

          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;

          if ( rate2 == 0 )
            rate2 = buyRate2 = sellRate2 = 1.0;
          end;

          doc.rec.OutSum = Floor( MoneyL( transfer.rec.sumCommisOur * ( rate / rate2 ) ) );
        else
          doc.rec.OutSum = transfer.rec.sumCommisOur;
        end;
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_GET;
      doc.rec.InSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Срочный перевод - комиссия \"нашего\" банка";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        setErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Взимание платы в клиринговый центр ------------------------------
    if ( stat and ( transfer.rec.sumCommisCC != 0 ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 12 );
      else
        doc = newDepDoc( 13 );
      end;
      
      if ( transfer.rec.curCodeCommis == transfer.rec.curCode )	
        doc.rec.OutSum = transfer.rec.sumCommisCC;
      else
        if ( ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommis, rate, buyRate, sellRate ) ) and
             ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate2, buyRate2, sellRate2 ) ) )

          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;

          if ( rate2 == 0 )
            rate2 = buyRate2 = sellRate2 = 1.0;
          end;

          doc.rec.OutSum = Floor( MoneyL( transfer.rec.sumCommisCC * ( rate / rate2 ) ) );
        else
          doc.rec.OutSum = transfer.rec.sumCommisCC;
        end;
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_GET;
      doc.rec.InSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Срочный перевод - комиссия в клиринговый центр";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        setErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Взимание платы за дополнительные услуги -------------------------
    if ( stat and ( ( transfer.rec.notificationCommis != 0 ) or ( transfer.rec.deliveryCommis != 0 ) or ( transfer.rec.informationCommis != 0 ) ) )
      if ( transfer.rec.curCode == 0 )
        doc = newDepDoc( 14 );
      else
        doc = newDepDoc( 15 );
      end;
      
      if ( transfer.rec.curCodeCommisAdd == transfer.rec.curCode )	
        doc.rec.OutSum = transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
      else
        if ( ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCodeCommisAdd, rate, buyRate, sellRate ) ) and
             ( GetAllCurrRate( opHistory.rec.opDate, transfer.rec.curCode, rate2, buyRate2, sellRate2 ) ) )

          if ( rate == 0 )
            rate = buyRate = sellRate = 1.0;
          end;

          if ( rate2 == 0 )
            rate2 = buyRate2 = sellRate2 = 1.0;
          end;

          doc.rec.OutSum = Floor( MoneyL( ( transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis ) * ( rate / rate2 ) ) );
        else
          doc.rec.OutSum = transfer.rec.notificationCommis + transfer.rec.deliveryCommis + transfer.rec.informationCommis;
        end;
      end;

      doc.rec.Referenc = vReferenc;
      doc.rec.Type_Account = vTypeAccount;
      doc.rec.Account = vAccount;
      if ( transfer.rec.curCode == 0 )
        doc.rec.IsCur = 0;
      else
        doc.rec.IsCur = 1;
      end;
      doc.rec.Code_Currency = transfer.rec.curCode;
      doc.rec.VidDoc = 0; // Безналично
      doc.rec.KindOp = D_GET;
      doc.rec.InSum = 0;
      doc.rec.Action = D_INSERT;
      doc.rec.Ground = "Срочный перевод - плата за дополнительные услуги";

      initClientInfoInDepDoc( doc, true, clientForDepAcc );

      stat = docList.insert( doc );

      if ( not stat )
        setErrorMessage( "Ошибка при попытке вставить документ в список" );
      end;
    end;

    // Закрытие служебного счета ---------------------------------------
    if ( stat )
      if ( vNeedCloseAccount == 1 )
        ; // Производится в транзакции функцией Выполнение_Операции( ... )
      end;
    end;

    // Сохранение спецпеременной для РДД
    if ( transfer.rec.paymentCurCode > 0 )
      if ( operPanel.numForms > MT_OPER_PANEL )
        if ( operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum1" ).value > operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value )
          StoreValue( "doc:СрПеревод@КонвМелИсходная", operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum1" ).value - operPanel.getForm( MT_TOPAY_PANEL ).getControl( "TotalSum3" ).value );
        end;
      end;
    end;

    return stat;
  end;

  // =====================================================================
  macro postCarryTrnProc( ) : bool

    record operParm ( "oper_prm.1" );
    record depDoc ( sbdepdoc );

    var stat = true;

    if ( stat and ( vNeedCloseAccount == 1 ) )

      ClearRecord( operParm );
      ClearRecord( depDoc );

      operParm.Account = vAccount;
      operParm.Type_Account = vTypeAccount;
      operParm.Code_Currency = transfer.rec.curCode;
      operParm.Type_Oper = 63;
      operParm.Show_Panel = 0;
      operParm.UseMaxDate = 1;
      operParm.NoPrint = 1;
      operParm.TypeComplexOper = 81;

      depDoc.Referenc = vReferenc;
      if ( transfer.rec.curCode == 0 )
        depDoc.IsCur = 0;
      else
        depDoc.IsCur = 1;
      end;
      depDoc.FNCash = NumFNcash( );
      depDoc.RealFNCash = NumFNcash( );
      depDoc.Account = vAccount;
      depDoc.Oper = {oper};
      depDoc.Type_Account = vTypeAccount;
      depDoc.Code_Currency = transfer.rec.curCode;
      depDoc.CodClient = clientForDepAcc;
      depDoc.FlagRezid = StrFor( transfer.rec.senderNotResident );
      depDoc.YesSbook = "X";
      depDoc.Date_Document = {curdate};
      depDoc.DepDate_Document = {curdate};
      depDoc.TypeOper = 63;
      depDoc.TypeComplexOper = 81;
      depDoc.IsControl = StrFor( 1 );
      SetBitFlag( depDoc.Flags2, 7, 1 ); // BIT_FLAG2_MONTRANS
      depDoc.Ground = "Закрытие служебного счета при списании на доходы банка";

      if ( Выполнение_Операции( operParm, depDoc ) != 0 )
        stat = false;
      end;
    end;

    return stat;
  end;

  // =====================================================================
  InitTMtOperation( p_psId, NULL, NULL, NULL, NULL, NULL, NULL, 1 );

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro createInstance ( opNum, subOpNum, psId, sendAccRef, initClient )

  var opAssign = TMtOpAssign( sendAccRef, opNum, subOpNum, psId, initClient ); 

  return opAssign;
end;
