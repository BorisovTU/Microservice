/********************************************************\
  R-Style Softlab
  RS-Retail
  Электронный кассир Pro Cash 6000
  Воронцов Ю.В., IIX.2006

Проверка возможности приема денег при выполнении операции tcd_pc_сrcv.mac

Точка вызова:
Вызывается при создании кассового документа операции "Приход" (CASHOP_CREDIT)
по ресурсу типа "Валюта" (платежеспособная) в функции InitCashDoc

Параметры:
TCD_PARM.aCurrency - валюта документа (определяется стандартным образом по ресурсу кассы),
TCD_PARM.aSum - сумма документа

Алгоритм:
1.        Если валюта - не национальная, завершить макрос без ошибки
2.        Подключиться к ЭК своей смены
3.        Если подключение выполнено
3.1.        Выполнить проверку возможности приема суммы TCD_PARM.aSum  (метод TProCashDevice.checkInputAmount)
\*********************************************************/


Import tcd_pc_def;

//macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money ):integer
macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money , in_adrCashDoc ):integer
  var stat = true;
  
  name_pc_Macro = "tcd_pc_crcv.mac";
  
//  msgbox("tcd_pc_crcv.mac");
  //Получение платёжного документа
  getCashDoc( in_adrCashDoc );
  
  if( in_aSum < 0 ) 
    in_aSum = - in_aSum;
  end;
  
  debugmsg( string(in_aCurrency) );
  //Алгоритм:
  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(in_aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
  end;

  //2.        Подключиться к ЭК своей смены
  if(  procStandConnect(_MODE_SMENA_TCD,in_aTCDRef) == false ) 
  //msgbox("Подключиться не удалось");
  return 7071;//-1; 
  end;
  
  if(_flag_debug_ret == true)
    return 0;
  end;

  //3.        Если подключение выполнено
  //3.1.        Выполнить проверку возможности приема суммы TCD_PARM.aSum  (метод TProCashDevice.checkInputAmount)
  stat = objPCDevice.checkInputAmount(in_aSum) ;  //msgbox("checkInputAmount("+string(in_aSum)+") ="+string(stat));

  if(stat == true)
    return 0;
  else
//    return 7072;//1;
    return 7004;//1;
  end;

end;//mainProCash

//7071; //ККМ выключена или отсутствует - оплату производить нельзя
//7072; //Ошибка при проверке возможности проведения оплаты на ККМ
//7004; //Недостаточное количество ресурса на счёте при проведении операции

/*
  //Алгоритм:
  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(TCD_PARM.aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
  end;

  //2.        Подключиться к ЭК своей смены
  if(  procStandConnect(_MODE_SMENA_TCD) == false ) return -1; end;

  //3.        Если подключение выполнено
  //3.1.        Выполнить проверку возможности приема суммы TCD_PARM.aSum  (метод TProCashDevice.checkInputAmount)
  stat = objPCDevice.checkInputAmount(TCD_PARM.aSum) ;

  if(stat == true)
    return 0;
  else
    return 1;
  end;

*/

/*
Import tcd_pc_def;




macro mainProCash(in_TCDRef:integer, in_Curr:integer, in_Sum:money ):integer

 msgbox
 ( 
   "Run MAcro"+
   "\nTCD_PARM:\n"+
    " TCDRef = "+string(TCD_PARM.aTCDRef) +"  "+
    " Currency = "+string(TCD_PARM.aCurrency) +"  "+
    " Sum = "+string(TCD_PARM.aSum) +"  "
   +
   "\nFUNC-PARAM:\n"+
    "  in_TCDRef=  "+ string(in_TCDRef)+
    "  in_Curr =  "+ string(in_Curr)+
    "  in_Sum =   "+ string(in_Sum)
 );

//  msgbox("\nEnd  Macro");

  return 0;
end;
*/
/* msgbox
 ( 
   "Run MAcro"+
   "\nTCD_PARM:\n"+
    " TCDRef = "+string(TCD_PARM.aTCDRef) +"  "+
    " Currency = "+string(TCD_PARM.aCurrency) +"  "+
    " Sum = "+string(TCD_PARM.aSum) +"  "
 );





return 0;

*/  


