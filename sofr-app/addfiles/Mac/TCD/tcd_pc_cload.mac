 /*************************************************\

  R-Style Softlab
  RS-Retail
  Электронный кассир Pro Cash 6000
  Воронцов Ю.В., IIX.2006

 Проверка возможности подкрепления электронного кассира - tcd_pc_сload.mac

Точка вызова: Вызывается при создании кассового документа операции "Подкрепление кассы" (CASHOP_ADVANCE) 
по ресурсу типа "Валюта" (платежеспособная) в начале функции InitCashDoc при условии, что:
 -  мы находимся не в АРМ "Кладовая банка"
 -  функция вызвана вне транзакции
В случае завершения макроса с ошибкой прервать выполнение функции InitCashDoc. 
Примечание: эта точка общая для нескольких действий, далее будем называть ее "Функция InitCashDoc"

Параметры: 
TCD_PARM.aTCDRef - ID ЭК смены, к которой относится сейф, 
TCD_PARM.aCurrency - валюта документа (определяется стандартным образом по ресурсу кассы), 
TCD_PARM.aSum - сумма документа

Алгоритм:
1.        Если валюта - не национальная, завершить макрос без ошибки
2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
Указание имени объекта третьим параметром функции CreateObject позволит избежать 
его повторного создания при последующих вызовах макросов ЭК. 
Вызвать метод connect, указав адрес из записи tcd_unit.dbt с tcd_unit.Reference == TCD_PARM.aTCDRef

Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к указанному ЭК"

3.        Если подключение выполнено

3.1.        Выполнить проверку возможности приема суммы TCD_PARM. (метод TProCashDevice.checkInputAmount)

\*************************************************/


 Import tcd_pc_def;

 
macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money , in_adrCashDoc ):integer
  var stat = true;

  name_pc_Macro = "tcd_pc_cload.mac";

  //Получение платёжного документа
  getCashDoc( in_adrCashDoc );

  if( in_aSum < 0 ) 
    in_aSum = - in_aSum;
  end;
  
  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(in_aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
  end;
  //2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
  //Указание имени объекта третьим параметром функции CreateObject позволит избежать 
  //его повторного создания при последующих вызовах макросов ЭК. 
  //Вызвать метод connect, указав адрес из записи tcd_unit.dbt с tcd_unit.Reference == TCD_PARM.aTCDRef

  //Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к указанному ЭК"

  if(  procStandConnect(_MODE_SPECIFIED_TCD,in_aTCDRef) == false ) 
  return 7071;//-1; 
  end;
  
  if(_flag_debug_ret == true)
    return 0;
  end;

// 3.        Если подключение выполнено

//3.1.        Выполнить проверку возможности приема суммы TCD_PARM. (метод TProCashDevice.checkInputAmount)

  stat = objPCDevice.checkInputAmount(in_aSum);

  if(stat == true)
    return 0;
  else
    return 7072;//1;
  end;


end;//mainProCash

//7071; //ККМ выключена или отсутствует - оплату производить нельзя
//7072; //Ошибка при проверке возможности проведения оплаты на ККМ
//7004; //Недостаточное количество ресурса на счёте при проведении операции

/*
  var stat;

//1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(TCD_PARM.aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
  end;
//2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
//Указание имени объекта третьим параметром функции CreateObject позволит избежать 
//его повторного создания при последующих вызовах макросов ЭК. 
//Вызвать метод connect, указав адрес из записи tcd_unit.dbt с tcd_unit.Reference == TCD_PARM.aTCDRef

//Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к указанному ЭК"

  if(  procStandConnect(_MODE_SPECIFIED_TCD) == false ) return -1; end;

// 3.        Если подключение выполнено

//3.1.        Выполнить проверку возможности приема суммы TCD_PARM. (метод TProCashDevice.checkInputAmount)

  stat = objPCDevice.checkInputAmount(TCD_PARM.aSum);

  if(stat == true)
    return 0;
  else
    return 1;
  end;

*/

