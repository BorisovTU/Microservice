/**********************************************************\
  R-Style Softlab
  RS-Retail
  Электронный кассир Pro Cash 6000
  Воронцов Ю.В., IIX.2006

Выдача денег при выполнении операции - tcd_pc_pay.mac

Точка вызова: 
Вызывается при подтверждении кассового документа операции "Расход" (CASHOP_DEBET) 
по ресурсу типа "Валюта" (платежеспособная) 
в функции CCdBunTokScrolling::carryAllSuitableDocs непосредственно 
перед вызовом функции CCdBunTokScrolling::carryAllSuitableDocsCore. 
В случае завершения макроса с ошибкой прервать выполнение 
функции CCdBunTokScrolling::carryAllSuitableDocs. 

Примечание: эта точка общая для нескольких действий, 
далее будем называть ее "Функция CCdBunTokScrolling::carryAllSuitableDocs"

Параметры: 
TCD_PARM.aCurrency - валюта подтверждаемых документов, 
TCD_PARM.aSum - сумма всех документов, подтверждаемых в рамках данного 
вызова функции CCdBunTokScrolling::carryAllSuitableDocs

Алгоритм:
1.        Если валюта - не национальная, завершить макрос без ошибки
2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
Указание имени объекта третьим параметром функции CreateObject позволит 
избежать его повторного создания при последующих вызовах макросов ЭК. 

Метод connect не вызывать (будет выполнено подключение к ЭК, подключенному к терминалу пользователя).

Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к своему ЭК"
3.        Если подключение выполнено
3.1.        Выполнить выдачу суммы TCD_PARM.aSum  в режиме обычной выдачи (метод TProCashDevice.outputAmount)
\**********************************************************/


Import tcd_pc_def;

macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money , in_adrCashDoc ):integer
  var stat = true;
  
//  msgbox("tcd_pc_pay.mac");
  name_pc_Macro = "tcd_pc_pay.mac";

  //Получение платёжного документа
  getCashDoc( in_adrCashDoc );
  
  if( in_aSum < 0 ) 
    debugmsg(in_aSum);
    println(in_aSum);
    in_aSum = - in_aSum;
  end;
  
  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(in_aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
  end;
  //2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
  //Указание имени объекта третьим параметром функции CreateObject позволит 
  //избежать его повторного создания при последующих вызовах макросов ЭК. 
  //Метод connect не вызывать (будет выполнено подключение к ЭК, подключенному к терминалу пользователя).
  //Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к своему ЭК"

  if(  procStandConnect( _MODE_LOCAL_TCD,in_aTCDRef ) == false ) 
    return 7071;//-1; 
  end;
 
  //debugmsg(in_aSum);
  //3.        Если подключение выполнено
  //3.1.        Выполнить выдачу суммы TCD_PARM.aSum  в режиме обычной выдачи (метод TProCashDevice.outputAmount)
  stat = objPCDevice.outputAmount(in_aSum);

  debugmsg( ("stat = " + string(stat) ) );
  
  if(stat == true) 
    if( (objPCDevice.getAvailableAmount()) <= 0 )
      setLoadStatusTCD(_LOADSTATUS_UnLoad,in_aTCDRef);
    end; 
    return 0;
  else
    setLoadStatusTCD(_LOADSTATUS_UnloadError,in_aTCDRef);
    return 7004;//1;
  end;

end;//mainProCash  

// 7071; //ККМ выключена или отсутствует - оплату производить нельзя
// 7072; //Ошибка при проверке возможности проведения оплаты на ККМ
// 7004; //Недостаточное количество ресурса на счёте при проведении операции


/*
  var stat;

  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(TCD_PARM.aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
  end;
  //2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
  //Указание имени объекта третьим параметром функции CreateObject позволит 
  //избежать его повторного создания при последующих вызовах макросов ЭК. 
  //Метод connect не вызывать (будет выполнено подключение к ЭК, подключенному к терминалу пользователя).
  //Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к своему ЭК"

  if(  procStandConnect( _MODE_LOCAL_TCD ) == false ) return -1; end;

  //3.        Если подключение выполнено
  //3.1.        Выполнить выдачу суммы TCD_PARM.aSum  в режиме обычной выдачи (метод TProCashDevice.outputAmount)
  stat = objPCDevice.outputAmount(TCD_PARM.aSum);

  if(stat == true) 
     return 0;
  else
     return 1;
  end;
*/
