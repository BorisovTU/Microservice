/***************************************************************/
/*                                                             */
/*      RS-Retail 2.0                                          */
/*                                                             */
/*      ‘¨áâ¥¬  ®¡á«ã¦¨¢ ­¨ï TCD                               */
/*                                                             */
/*      Œ ªà®á ®âç¥â  ¯® ¨­ª áá æ¨ï¬ TCD                       */
/*                                                             */
/***************************************************************/

  Import deprintr, ListCurr;

  file   fLoad ( TCD_Load, "TCD.DEF" ) key 1;
  file   fSlot ( TCD_Slot, "TCD.DEF" ) key 1;
  file   fPers ( TCD_Pers, "TCD.DEF" ) key 1;
  file   fUnit ( TCD_Unit, "TCD.DEF" ) key 0;

  record dlg  ( "REP_PARM", "TCD.LBR" ) dialog;
  record scrI ( Inc_Scrl,   "TCD.LBR" ) dialog;

  const NoRight = "‚ë ­¥ ¬®¦¥â¥|à ¡®â âì á TCD";

  const CurStatus = 9;  /* ‘â âãá § ¯¨á¨ § £àã§ª¨: à®¢¥¤¥­  ¨­ª áá æ¨ï */
  const TimeMin   = Time(  0,  0,  0 );
  const TimeMax   = Time( 23, 59, 59 );

  array SlotNumb, SlotStat, SlotCurr, SlotNmnl;
  array SlotLoad, SlotCsst, SlotUnLd, SlotRjct, SlotPay;
  array sTrnRet;

  /* Œ áá¨¢ë ¨â®£®¢ëå áã¬¬ ¯® ¢ «îâ ¬ */
  array totalISO;
  array totalRSumL, totalRSumP, totalRSumU, totalRSumD;  /* Žâç¥â */
  array totalSumReject;  /* ‚®§¢à â */
  array totalBSumL, totalBSumP, totalBSumU, totalBSumR, totalBSumD;  /*  « ­á */

  var sCassetteID;

  var {oper}, {curdate};

  var Branch = NumFNCash;

  var Casher, Date1, Date2;

  var FirstRec = True;

  var PersonRefIncass =  0;
  var TCDRef          =  0;
  var TCD_ID          = "";
  var LoadRef         =  0;
  var NumCassettes    =  0;
  var LoadRecPos      = -1;

  var sComment;

  var stat = 0;
  var i, j, k, l;
  var ret = TRUE;
  var TrnRet;

  /***********************************************************/
  /*               à®æ¥¤ãàë ä¨«ìâà  áªà®«¨­£                */
  /***********************************************************/
  macro TestRec( ff )
    if ( ( ff.FNCash == Branch )  AND
         ( ff.TCDRef == TCDRef )  AND
         ( ff.Date   >= Date1 )   AND
         ( ff.Date   <= Date2 )   AND
         ( ff.Status == CurStatus ) )
      return True;
    end;
    return False;
  end;

  macro NextIncass( ff )
    if ( FirstRec )
      FirstRec = False;
      ClearRecord( ff );
      ff.FNCash = Branch;
      ff.TCDRef = TCDRef;
      ff.Status = CurStatus;
      ff.Date   = Date1;
      ff.Time   = TimeMin;
      if ( GetGE( ff ) )
        return TestRec( ff );
      end;
    else
      if ( Next( ff ) )
        return TestRec( ff );
      end;
    end;
    return False;
  end;

  macro PrevIncass( ff )
    if ( FirstRec )
      FirstRec = False;
      ClearRecord( ff );
      ff.FNCash = Branch;
      ff.TCDRef = TCDRef;
      ff.Status = CurStatus;
      ff.Date   = Date2;
      ff.Time   = TimeMax;
      if ( GetLE( ff ) )
        return TestRec( ff );
      end;
    else
      if ( Prev( ff ) )
        return TestRec( ff );
      end;
    end;
    return False;
  end;

  macro RewindIncass( ff )
    Rewind( ff );
    FirstRec = True;
  end;

  /********************************************************/
  /*      ®¤áç¥â ¨â®£®¢ëå áã¬¬ ¯® ¢ «îâ ¬ ¤«ï ®âç¥â      */
  /********************************************************/
  macro addTotalReportSum( Curr, Nmnl, Load, Pay, UnLoad )
    var ii = 0, nn = aSize( totalISO ), find = FALSE;

    while ( ii < nn )
      if ( totalISO( ii ) == Curr )
        find = TRUE;  /*  è«¨ ¢ «îâã ¢ ¨â®£®¢®¬ ¬ áá¨¢¥ */
        totalRSumL( ii ) = totalRSumL( ii ) + Load   * Nmnl;
        totalRSumP( ii ) = totalRSumP( ii ) + Pay    * Nmnl;
        totalRSumU( ii ) = totalRSumU( ii ) + UnLoad * Nmnl;
        totalRSumD( ii ) = totalRSumD( ii ) + ( Load - Pay - UnLoad ) * Nmnl;
      end;
      ii = ii + 1;
    end;

    /* Ž¡à §ã¥¬ ­®¢ë© í«¥¬¥­â ¨â®£®¢ëå ¬ áá¨¢®¢ */
    if ( NOT find )
      totalISO ( ii ) = Curr;
      totalRSumL( ii ) = Load   * Nmnl;
      totalRSumP( ii ) = Pay    * Nmnl;
      totalRSumU( ii ) = UnLoad * Nmnl;
      totalRSumD( ii ) = ( Load - Pay - UnLoad ) * Nmnl;
    end;

  end;

  /***********************************************************/
  /*             ®«ãç¥­¨¥ ¨­ä®à¬ æ¨¨ ¯® ª áá¥â ¬            */
  /***********************************************************/
  macro GetCassettes

    ret = TRUE;
    NumCassettes = 0;
    ClearRecord( fSlot );
    fSlot.LoadRef = LoadRef;
    fSlot.SlotNumber = 0;
    if ( GetGE( fSlot )  AND  ( fSlot.LoadRef == LoadRef ) )

      while ( ret  AND  ( fSlot.LoadRef == LoadRef ) )
        SlotNumb(NumCassettes) = fSlot.SlotNumber;
        SlotStat(NumCassettes) = fSlot.SlotStatus;
        SlotCurr(NumCassettes) = fSlot.SlotCurrency;
        SlotNmnl(NumCassettes) = fSlot.SlotNominal;
        SlotLoad(NumCassettes) = fSlot.SlotQuantityLoad;
        SlotPay (NumCassettes) = fSlot.SlotQuantityPay;
        if ( fSlot.SlotNumber != 0 )
          SlotUnLd(NumCassettes) = fSlot.SlotQuantityUnLoad;
          SlotRjct(NumCassettes) = 0;
        else
          SlotUnLd(NumCassettes) = 0;
          SlotRjct(NumCassettes) = fSlot.SlotQuantityUnLoad;
        end;
        SlotCsst(NumCassettes) = fSlot.CassetteID;

        if ( fSlot.SlotNumber != 0 )
          addTotalReportSum( SlotCurr(NumCassettes),
                             SlotNmnl(NumCassettes),
                             SlotLoad(NumCassettes),
                             SlotPay (NumCassettes),
                             SlotUnLd(NumCassettes) );
        end;

        NumCassettes = NumCassettes + 1;
        ret = Next( fSlot );
      end;
    else
      MsgBox( "‡ ¯¨á¨ ¯® ª áá¥â ¬|¤«ï § £àã§ª¨ á Reference = ", LoadRef,
              "|­¥ ­ ©¤¥­ë" );
      return FALSE;
    end;

    return TRUE;

  end;

  /********************************************************/
  /*          ‘ªà®«¨­£ § ¯¨á¥© § £àã§ª¨\¢ë£àã§ª¨          */
  /********************************************************/
  macro LoadScroll

    var Stat = 0;

    ClearRecord( fLoad );
    fLoad.FNCash = Branch;
    fLoad.TCDRef = TCDRef;
    fLoad.Status = CurStatus;
    fLoad.Date   = Date1;
    fLoad.Time   = TimeMin;
    if ( ( NOT GetGE( fLoad ) )  OR  ( NOT TestRec( fLoad ) ) )
      MsgBox( "¥ ­ ©¤¥­ë § ¯¨á¨ ¨­ª áá æ¨¨|¯® ä¨«¨ «ã ", Branch,
              "|¤«ï TCD \"", TCD_ID, "\"" +
              "|®â ¤ âë ", Date1, " ¤® ", Date2 );
      Stat = -1;
    end;

    if ( Stat == 0 )

      ReplaceMacro( "Next",   "NextIncass"   );
      ReplaceMacro( "Prev",   "PrevIncass"   );
      ReplaceMacro( "Rewind", "RewindIncass" );

      SetScroll( fLoad, "Date", "Date", "Time", "Time", "Comment", "Commentary" );

      if ( RunDialog( scrI, "ScrollMes" ) )
        LoadRecPos = GetPos( fLoad );
        Stat = fLoad.Reference;
      else
        Stat = -1;
      end;

      ReplaceMacro( "Next" );
      ReplaceMacro( "Prev" );
      ReplaceMacro( "Rewind" );

    end;

    return Stat;

  end;

  /***********************************************************/
  /*                   Žâç¥â ¯® ¨­ª áá æ¨¨                   */
  /***********************************************************/
  macro calcTotalReject( Curr, Sum )
    var ii = 0, nn = aSize( totalISO );
    while ( ii < nn )
      if ( totalISO( ii ) == Curr )
        totalSumReject( ii ) = totalSumReject( ii ) + Sum;
      end;
      ii = ii + 1;
    end;
  end;

  /********************************************************/
  /*      ®¤áç¥â ¨â®£®¢ëå áã¬¬ ¯® ¢ «îâ ¬ ¤«ï ®âç¥â      */
  /********************************************************/
  macro addTotalBalansSum( Curr, Nmnl, Load, Pay, UnLoad, Rjct )
    var ii = 0, nn = aSize( totalISO );

    while ( ii < nn )
      if ( totalISO( ii ) == Curr )
        totalBSumL( ii ) = totalBSumL( ii ) + Load   * Nmnl;
        totalBSumP( ii ) = totalBSumP( ii ) + Pay    * Nmnl;
        totalBSumU( ii ) = totalBSumU( ii ) + UnLoad * Nmnl;
        totalBSumR( ii ) = totalBSumR( ii ) + Rjct   * Nmnl;
        totalBSumD( ii ) = totalBSumD( ii ) +
                             ( Load - Pay - UnLoad - Rjct ) * Nmnl;
      end;
      ii = ii + 1;
    end;

  end;

  /***********************************************************/
  /*                   Žâç¥â ¯® ¨­ª áá æ¨¨                   */
  /***********************************************************/
  macro CassettesReport

    var cCur = "";
    var iii = 0, nnn = aSize( totalISO ), sCurr;

    /* Žâç¥â ¯® ª áá¥â ¬ ¢ë¤ ç¨ */
    ret = TRUE;
    ClearRecord( fSlot );
    fSlot.LoadRef = LoadRef;
    fSlot.SlotNumber = 0;
    if ( GetGE( fSlot )  AND  ( fSlot.LoadRef == LoadRef ) )
      [
                       Žâç¥â ¯® ¨­ª áá æ¨¨ §  ¤ âã ########## ¢à¥¬ï ######## ª áá¨à ####


        ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
        ³ ‘«®â ³ Š áá¥â   ³ ‚ «îâ  ³ ®¬¨­ « ³ ‡ £àã¦¥­® ³   ‚ë¤ ­®  ³ ‚ë£àã¦¥­® ³    ‘ã¬¬  à §­®áâ¨    ³
        ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
      ( fLoad.Date, fLoad.Time, Casher );

      while ( ret  AND  ( fSlot.LoadRef == LoadRef ) )
        if ( fSlot.SlotNumber != 0 )
        if ( FindCurrency( fSlot.SlotCurrency ) )
          cCur = " " + Curr.Short_Name;
        else
          cCur = "   " + String(fSlot.SlotCurrency);
        end;
        [ ³ #### ³ ######## ³ ###### ³ ####### ³ ######### ³ ######### ³ ######### ³ #################### ³]
        ( fSlot.SlotNumber:4, fSlot.CassetteID:8, cCur:6, fSlot.SlotNominal:7,
          fSlot.SlotQuantityLoad:9, fSlot.SlotQuantityPay:9, fSlot.SlotQuantityUnLoad:9,
          MoneyL( ( fSlot.SlotQuantityLoad - fSlot.SlotQuantityPay - fSlot.SlotQuantityUnLoad ) *
                    fSlot.SlotNominal ):a:20:2 );
        end;
        ret = Next( fSlot );
      end;
      [ ÀÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

      println( "        ˆâ®£® áã¬¬ :" );

      while ( iii < nnn )
        if ( FindCurrency( totalISO( iii ) ) )
          sCurr = Curr.Short_Name;
        else
          sCurr = String( totalISO( iii ) );
        end;
        println( "                      " +
                 String( sCurr:3 ) +
                 "                 " +
                 String( ( totalRSumL( iii ) * 1.0 ):a:10:2 ) +
                 "  " +
                 String( ( totalRSumP( iii ) * 1.0 ):a:10:2 ) +
                 "  " +
                 String( ( totalRSumU( iii ) * 1.0 ):a:10:2 ) +
                 " " +
                 String( ( totalRSumD( iii ) * 1.0 ):a:19:2 ) );
        iii = iii + 1;
      end;

    else
      MsgBox( "‡ ¯¨á¨ ¯® ª áá¥â ¬|¤«ï § £àã§ª¨ á Reference = ", LoadRef,
              "|­¥ ­ ©¤¥­ë" );
      return FALSE;
    end;

    /*  ç «ì­®¥ ®¡­ã«¥­¨¥ áã¬¬ ¯® ª áá¥â¥ ¢®§¢à â  */
    iii = 0;
    while ( iii < nnn )
      totalSumReject( iii ) = 0;
      iii = iii + 1;
    end;

    /* Žâç¥â ¯® ª áá¥â¥ ¢®§¢à â  */
    ret = TRUE;
    ClearRecord( fSlot );
    fSlot.LoadRef = LoadRef;
    fSlot.SlotNumber = 0;
    if ( GetGE( fSlot )  AND  ( fSlot.LoadRef == LoadRef ) )
      [
                   Š áá¥â  ¢®§¢à â  "#####"

        ÚÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
        ³ ‚ «îâ  ³ ®¬¨­ « ³   ­ª­®â  ³ ‘ã¬¬  ¢®§¢à â  ³
        ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
      ( fSlot.CassetteID:5 );
      while ( ret  AND  ( fSlot.LoadRef == LoadRef ) )
        if ( fSlot.SlotNumber == 0 )
          if ( FindCurrency( fSlot.SlotCurrency ) )
            cCur = " " + Curr.Short_Name;
          else
            cCur = "   " + String(fSlot.SlotCurrency);
          end;
          [ ³ ###### ³ ####### ³ ######### ³ ############## ³]
          ( cCur:6, fSlot.SlotNominal:7,
            fSlot.SlotQuantityUnLoad:9,
            MoneyL( fSlot.SlotQuantityUnLoad * fSlot.SlotNominal ):a:14:2 );
          calcTotalReject( fSlot.SlotCurrency,
                           fSlot.SlotQuantityUnLoad * fSlot.SlotNominal );
        end;
        ret = Next( fSlot );
      end;
      [ ÀÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

      println( "  ˆâ®£®:" );
      iii = 0;
      while ( iii < nnn )
        if ( FindCurrency( totalISO( iii ) ) )
          sCurr = Curr.Short_Name;
        else
          sCurr = String( totalISO( iii ) );
        end;
        println( "    " +
                 String( sCurr:3 ) +
                 "                      " +
                 String( ( totalSumReject( iii ) * 1.0 ):a:19:2 ) );
        iii = iii + 1;
      end;

    else
      MsgBox( "‡ ¯¨á¨ ¯® ª áá¥â ¬|¤«ï § £àã§ª¨ á Reference = ", LoadRef,
              "|­¥ ­ ©¤¥­ë" );
      return FALSE;
    end;

    /* ¥à¥­®á ¤ ­­ëå ¯® ª áá¥â¥ ¢®§¢à â  ¢ ª áá¥âë ¢ë¤ ç¨ */
    i = 0;
    while ( i < aSize( SlotNumb ) )
      if ( SlotNumb(i) == 0 )
        j = 0;
        while ( j < aSize( SlotNumb ) )
          if ( ( SlotCurr(i) == SlotCurr(j) )  AND
               ( SlotNmnl(i) == SlotNmnl(j) ) )
            SlotRjct(j) = SlotRjct(i);
          end;
          j = j + 1;
        end;
      end;
      i = i + 1;
    end;

    /*  ç «ì­®¥ ®¡­ã«¥­¨¥ áã¬¬ ¯® ¡ « ­áã */
    iii = 0;
    while ( iii < nnn )
      totalBSumL( iii ) = 0;
      totalBSumP( iii ) = 0;
      totalBSumU( iii ) = 0;
      totalBSumR( iii ) = 0;
      totalBSumD( iii ) = 0;
      iii = iii + 1;
    end;

    [
                                  « ­á ¯® ­®¬¨­ « ¬

      ÚÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³ ‚ «îâ  ³ ®¬¨­ « ³ ‡ £àã¦¥­® ³   ‚ë¤ ­®  ³ ‚ë£àã¦¥­® ³ ‚®§¢à â ³ ‘ã¬¬  à §­®áâ¨       ³
      ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
    i = 1;
    while ( i < aSize( SlotNumb ) )
      if ( SlotNumb(i) != 0 )
        if ( FindCurrency( SlotCurr(i) ) )
          cCur = " " + Curr.Short_Name;
        else
          cCur = "   " + String( SlotCurr(i) );
        end;
        [ ³ ###### ³ ####### ³ ######### ³ ######### ³ ######### ³ ####### ³ #################### ³]
        ( cCur:6, SlotNmnl(i):7,
          SlotLoad(i):9, SlotPay(i):9, SlotUnLd(i):9, SlotRjct(i):7,
          MoneyL( SlotNmnl(i) * ( SlotLoad(i) - SlotPay(i) - SlotUnLd(i) - SlotRjct(i) ) ):a:20:2 );
          addTotalBalansSum( SlotCurr(i),
                             SlotNmnl(i),
                             SlotLoad(i),
                             SlotPay(i),
                             SlotUnLd(i),
                             SlotRjct(i) );
      end;
      i = i + 1;
    end;
    [ ÀÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

    ];

    println( "  ˆâ®£®:" );
    iii = 0;
    while ( iii < nnn )
      if ( FindCurrency( totalISO( iii ) ) )
        sCurr = Curr.Short_Name;
      else
        sCurr = String( totalISO( iii ) );
      end;
      println( "    " +
               String( sCurr:3 ) +
               "                 " +
               String( ( totalBSumL( iii ) * 1.0 ):a:10:2 ) +
               "  " +
               String( ( totalBSumP( iii ) * 1.0 ):a:10:2 ) +
               "  " +
               String( ( totalBSumU( iii ) * 1.0 ):a:10:2 ) +
               String( ( totalBSumR( iii ) * 1.0 ):a:10:2 ) +
               " " +
               String( ( totalBSumD( iii ) * 1.0 ):a:19:2 ) );
      iii = iii + 1;
    end;

    println( "\n" );

    i = 1;
    while ( i < aSize( SlotNumb ) )
      if ( SlotNumb(i) != 0 )
        if ( ( SlotLoad(i) - SlotPay(i) - SlotUnLd(i) - SlotRjct(i) ) != 0 )
          if ( FindCurrency( SlotCurr(i) ) )
            cCur = " " + Curr.Short_Name;
          else
            cCur = "   " + String( SlotCurr(i) );
          end;
          println( "   àãè¥­ ¡ « ­á ç¨á«  ¡ ­ª­®â ¯® ¢ «îâ¥ ", cCur:4,
                   ", ­®¬¨­ «ã ", SlotNmnl(i):5 );
        end;
      end;
      i = i + 1;
    end;

    return TRUE;

  end;


  /********************************************************/
  /***                à®æ¥¤ãà  ¨­ª áá æ¨¨              ***/
  /********************************************************/

  sTrnRet(1) = "¥ ­ ©¤¥­  § ¯¨áì|¯® ª áá¥â¥ ";
  sTrnRet(2) = "¥¢®§¬®¦­® ®¡­®¢¨âì § ¯¨áì|¯® ª áá¥â¥ ";
  sTrnRet(3) = "¥¢®§¬®¦­® ¯à®ç¨â âì § ¯¨á¨ ¯® ª áá¥â¥";
  sTrnRet(4) = "¥¢®§¬®¦­® ®¡­®¢¨âì|§ ¯¨áì § £àã§ª¨/¢ë£àã§ª¨";

  Casher = {oper};
  Date1  = Date();
  Date2  = Date1;

  /* „¨ «®£ ¯®«ãç¥­¨ï ¯ à ¬¥âà®¢ ®âç¥â  */
  dlg.Oper  = Casher;
  dlg.Date1 = Date1;
  dlg.Date2 = Date2;

  if ( RunDialog( dlg ) )
    Casher = dlg.Oper;
    Date1  = dlg.Date1;
    Date2  = dlg.Date2;
  end;

  /* ®¨áª § ¯¨á¨ ¯® ª áá¨àã */
  ClearRecord( fPers );
  fPers.Oper = Casher;
  if ( getEQ( fPers ) )
    PersonRefIncass = fPers.Reference;
  else
    MsgBox( NoRight );
    stat = 1;
  end;

  /* ®¨áª § ¯¨á¨ ¯® TCD */
  if ( stat == 0 )
    ClearRecord( fUnit );
    fUnit.Reference = fPers.TCDRef;
    if ( getEQ( fUnit ) )
      TCDRef = fUnit.Reference;
      TCD_ID = fUnit.ID;
    else
      MsgBox( "‡ ¯¨áì ¯® TCD|­¥ ­ ©¤¥­ " );
      stat = 2;
    end;
  end;

  /* à®¢¥àª  ä¨«¨ «  TCD */
  if ( ( stat == 0 )  AND  ( fUnit.FNCash != Branch ) )
    MsgBox( "”¨«¨ « TCD (# ", fUnit.FNCash,
            ") ­¥ ï¢«ï¥âáï|â¥ªãé¨¬ ä¨«¨ «®¬ (# ", Branch, ")" );
    stat = 3;
  end;

  /* ‘ªà®«¨­£ ä ©«  § £àã§®ª\¢ë£àã§®ª TCD */
  if ( stat == 0 )
    LoadRef = LoadScroll();
    if ( LoadRef > -1 )

      sComment = fLoad.Commentary;

      if ( NOT GetCassettes() )
        stat = 1;
      end;
    else
      stat = -1;
    end;
  end;

  /* Žâç¥â ¯® ¨­ª áá æ¨¨ */
  if ( stat == 0 )
    CassettesReport();
  end;
