//

import BankInter, DeprIntr, DeskInter;
import RCW;

private var agent = CreateObject( "rtbrcash.d32", "TBranchCashAgent", NULL, false );

private var sX = "";

private macro CheckRcvXML( s )
  var n1, n2, c1, v1, v2, t1, t2, r1, r2;
  var vN, vC, vV, vT, vR;
  var chk = TRUE;
  var i = Index( s, "<Cassette>" );

  while ( i > 0 )
    n1 = Index( SubStr( s, i ), "<Number>" );
    n2 = Index( SubStr( s, i ), "</Number>" );

    c1 = Index( SubStr( s, i ), "<Currency>" );

    v1 = Index( SubStr( s, i ), "<Value>" );
    v2 = Index( SubStr( s, i ), "</Value>" );

    t1 = Index( SubStr( s, i ), "<Count>" );
    t2 = Index( SubStr( s, i ), "</Count>" );

    r1 = Index( SubStr( s, i ), "<Remaining>" );
    r2 = Index( SubStr( s, i ), "</Remaining>" );

    vN = Int( SubStr( s, i + n1 + 7, n2 - n1 - 8 ) );
    vC = SubStr( s, i + c1 + 9, 3 );
    vV = Int( SubStr( s, i + v1 + 6, v2 - v1 - 7 ) );
    vT = Int( SubStr( s, i + t1 + 6, t2 - t1 - 7 ) );
    vR = Int( SubStr( s, i + r1 + 10, r2 - r1 - 8 ) );

    if ( ( vT / ( vT + vR ) ) > 4/5 )
      println( "Барабан: номер ", vN, " (валюта: ", vC, ", номинал: ", vV, ") заполнен на 80%!" );
      chk = FALSE;
    end;

    s = SubStr( s, 1, i - 1 ) + "*" + SubStr( s, i + 1 );
    i = Index( s, "<Cassette>" );
  end;
  if ( chk )
    println( "Все барабаны готовы принять сумму (заполнены менее 80%)" );
  end;
end;


/*************************************************************/
//             Проверка возможности принять сумму.
/*************************************************************/
SetOutPut( NULL, TRUE );

println( " " );
println( "  Проверка возможности принять сумму." );
println( " " );
println( " " );

if ( ( agent.login( 1, 1 ) )  AND  ( agent.GetSafeInfo2( 1, sX ) ) )
  CheckRcvXML( sX );
else
  println( "Невозможно получить информацию об устройстве" );
end;
