/******************************************************\
  R-Style Softlab
  RS-Retail
  Электронный кассир Pro Cash 6000
  Воронцов Ю.В., IIX.2006

Прием денег при выполнении операции - tcd_pc_rcv.mac

Точка вызова: 
Вызывается при подтверждении кассового документа операции "Приход" (CASHOP_CREDIT) 
по ресурсу типа "Валюта" (платежеспособная) в функции CCdBunTokScrolling::carryAllSuitableDocs

Параметры: 
TCD_PARM.aTCDRef - ID ЭК, 
TCD_PARM.aCurrency - валюта подтверждаемых документов, 
TCD_PARM.aSum - сумма всех документов, подтверждаемых в рамках данного вызова 
функции CCdBunTokScrolling::carryAllSuitableDocs

Алгоритм:
1.        Если валюта - не национальная, завершить макрос без ошибки
2.        Подключиться к своему ЭК
3.        Если подключение выполнено
3.1.        Выполнить выдачу суммы TCD_PARM.aSum  в обычном режиме (метод TProCashDevice.inputAmount, параметр reinforce = false)
3.2.        Отключиться от ЭК
Обработка ошибок стандартная.
\******************************************************/

Import tcd_pc_def;

//macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money ):integer
macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money , in_adrCashDoc ):integer
  var stat = true;
 
  name_pc_Macro = "tcd_pc_rcv.mac";
  
  //Получение платёжного документа
  getCashDoc( in_adrCashDoc );
  
  if( in_aSum < 0 ) 
    in_aSum = - in_aSum;
  end;

   //1.        Если валюта - не национальная, завершить макрос без ошибки
   if( validateCurCurrency(in_aCurrency) == false )
     //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
     return 0;
   end;
   //2.        Подключиться к своему ЭК
   if( procStandConnect(_MODE_LOCAL_TCD,in_aTCDRef) == false ) 
     return 7071;//-1; 
   end;

   //3.        Если подключение выполнено
   //3.1.        Выполнить выдачу суммы TCD_PARM.aSum  в обычном режиме 
             //(метод TProCashDevice.inputAmount, параметр reinforce = false)
   stat = objPCDevice.inputAmount( in_aSum , false );

   //3.2.        Отключиться от ЭК
   //Обработка ошибок стандартная.

   //резюме
   if(stat == true)
     if( ( objPCDevice.getAvailableAmount() ) >0 )
       setLoadStatusTCD(_LOADSTATUS_IsLoad,in_aTCDRef);
     end;  
     return 0; //выполнено
   else
     setLoadStatusTCD(_LOADSTATUS_LoadError,in_aTCDRef);
     return 7072;//1; //ошибка
//     return 7004;//1; //ошибка
   end;
   
end;//mainProCash

// 7071; //ККМ выключена или отсутствует - оплату производить нельзя
// 7072; //Ошибка при проверке возможности проведения оплаты на ККМ
// 7004; //Недостаточное количество ресурса на счёте при проведении операции


/*
   Import tcd_pc_def;
  
   var stat;

   //1.        Если валюта - не национальная, завершить макрос без ошибки
   if( validateCurCurrency(TCD_PARM.aCurrency) == false )
     //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
     return 0;
   end;
   //2.        Подключиться к своему ЭК
   if( procStandConnect(_MODE_LOCAL_TCD) == false ) return -1; end;

   //3.        Если подключение выполнено
   //3.1.        Выполнить выдачу суммы TCD_PARM.aSum  в обычном режиме 
             //(метод TProCashDevice.inputAmount, параметр reinforce = false)
   stat = objPCDevice.inputAmount( TCD_PARM.aSum , false );

   //3.2.        Отключиться от ЭК
   //Обработка ошибок стандартная.

   //резюме
   if(stat == true)
     return 0; //выполнено
   else
     return 1; //ошибка
   end;

*/	
