/*******************************************************\
  R-Style Softlab
  RS-Retail
  Электронный кассир Pro Cash 6000
  Воронцов Ю.В., IIX.2006

Проверка возможности выдачи денег при выполнении операции - tcd_pc_сpay.mac

Точка вызова: 
Вызывается при создании кассового документа операции "Расход" (CASHOP_DEBIT) 
по ресурсу типа "Валюта" (платежеспособная) в функции InitCashDoc

Параметры: 
TCD_PARM.aCurrency - валюта документа (определяется стандартным образом по ресурсу кассы), 
TCD_PARM.aSum - сумма документа

Алгоритм:
1.        Если валюта - не национальная, завершить макрос без ошибки
2.        Создать именованный RSCOM-объект класса TProCashDevice с именем "ProCash". 
Указание имени объекта третьим параметром функции CreateObject позволит избежать его повторного 
создания при последующих вызовах макросов ЭК. 
Вызвать метод connect, указав адрес из записи tcd_unit.dbt, соотвествующей устройству, 
с которым работает текущая смена пользователей

Примечание. Далее шаг такого вида не расписывается подробно, пишется просто "Подключиться к ЭК своей смены"

3.        Если подключение выполнено
3.1.        Выполнить проверку возможности выдачи суммы TCD_PARM.aSum  (метод TProCashDevice.checkOutputAmount)

Примечание. Такая реализация, конечно же, неправильная - в рамках операции 
может быть порождено несколько кассовых документов на рубли, 
и проверять на возможность выдачи (приема) нужно общую сумму. 
Однако это требует серьезной переработки наших операций. 
Пока клиента устроит описанный вариант, т.к. его интересуют только 
допвзнос и расход по счету без комиссии, 
а эти операции порождают только один кассовый документ на деньги
\*******************************************************/



  Import tcd_pc_def;
  
macro mainProCash(in_aTCDRef:integer, in_aCurrency:integer, in_aSum:money , in_adrCashDoc ):integer
  var stat = true;

//  msgbox("tcd_pc_cpay.mac");
  name_pc_Macro = "tcd_pc_cpay.mac";

  //Получение платёжного документа
  getCashDoc( in_adrCashDoc );
 
  if( in_aSum < 0 ) 
    in_aSum = - in_aSum;
  end;

  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(in_aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
    //return true;
  end;

  //2.        Подключиться к указанному ЭК
  if(  procStandConnect(_MODE_SPECIFIED_TCD,in_aTCDRef) == false ) 
//  if(  procStandConnect(_MODE_LOCAL_TCD,in_aTCDRef) == false ) 
  //msgbox("Подключиться не удалось");
  return 7071;//-1 //ККМ выключена или отсутствует - оплату производить нельзя
  end;
    
  if(_flag_debug_ret == true)
    return 0;
  end;
    
  //3.        Если подключение выполнено
  //3.1.        Выполнить проверку возможности выдачи суммы TCD_PARM. 
  //(метод TProCashDevice.checkOutputAmount)

  stat = objPCDevice.checkOutputAmount(in_aSum);
  //msgbox("checkOutputAmount("+string(in_aSum)+") ="+string(stat));

  if(stat == true)
    return 0;
  else
    return 7004;//1; //Ошибка при проверке возможности проведения оплаты на ККМ
  end;

end;//mainProCash

// 7071; //ККМ выключена или отсутствует - оплату производить нельзя
// 7072; //Ошибка при проверке возможности проведения оплаты на ККМ
// 7004 //Недостаточное количество ресурса на счёте при проведении операции
  
/*  
  var stat;

  //1.        Если валюта - не национальная, завершить макрос без ошибки
  if( validateCurCurrency(TCD_PARM.aCurrency) == false )
    //msgbox("Работа с ЭК осуществляется только с национальной валютой.");
    return 0;
    //return true;
  end;

  //2.        Подключиться к указанному ЭК
  if(  procStandConnect(_MODE_SPECIFIED_TCD) == false ) return -1; end;

  //3.        Если подключение выполнено
  //3.1.        Выполнить проверку возможности выдачи суммы TCD_PARM. 
  //(метод TProCashDevice.checkOutputAmount)

  stat = objPCDevice.checkOutputAmount(TCD_PARM.aSum);

  if(stat == true)
    return 0;
  else
    return 1;
  end;

*/
