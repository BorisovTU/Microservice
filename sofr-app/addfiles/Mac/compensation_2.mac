import DealsInter, CTInter, FIInter, PTInter, 
      globals, cb_sql, oralib, likepy, dldlngfun, lim_utils, dlquery, dlcontrfunc,
      sp_car, "or_rep_h.mac", "cblogger.mac", "nptxstbfun.mac";


PRIVATE CONST SHOW_EXCEL = true; //отображать протокол в Excel, или просто вывести в таблице в текстовом файле

PRIVATE CONST StrHeader =
"┌───────────────┬──────────────┬──────────┬───────────────┬─────────────┬───────────────┬───────────────┬────────────────────────────────┐\n"+
"│  Id клиента   │ Имя клиента  │ Дата НДР │ Ндр PlusG_4800│ Ндр BaseG9  │ Ндр BaseBill  │ Ндр PaidBill  │ Результат по клиенту           │\n"+
"├───────────────┼──────────────┼──────────┼───────────────┼─────────────┼───────────────┼───────────────┼────────────────────────────────┤";


PRIVATE MACRO IsPartyResident(PartyID)
  var party = TBFile("party");
  party.KeyNum = 0;
  party.rec.PartyID = PartyID;
  if (GetEQ(party))
    if (party.rec.NotResident)
      return false;
    else
      return true;
    end;
  end;
END;

private macro GetMainQuery()
  var query =
     " SELECT deff.T_ACCOUNT3060, "
    +"        deff.T_CONTRACTID, "
    +"        deff.T_DATE, "
    +"        deff.T_ERROR, "
    +"        deff.T_ID, "
    +"        deff.T_PAIDCOMP, "
    +"        deff.T_PAIDCOMP_15, "
    +"        deff.T_PARTYID, "
    +"        deff.T_PLUSG_4800, "
    +"        deff.TRN1, "
    +"        deff.TRN2, "
    +"        deff.TRN3, "
    +"        deff.TRN4, "
    +"        pt.t_name, "
    +"        sf.t_number, "
    +"        DLCONT.T_IIS "
    +"   FROM DNPTXDEFFEREDOBJ_DBT deff "
    +"        INNER JOIN dparty_dbt pt "
    +"           ON PT.T_PARTYID = DEFF.T_PARTYID "
    +"        INNER JOIN dsfcontr_dbt sf "
    +"           ON SF.T_ID = DEFF.T_CONTRACTID "
    +"        INNER JOIN DDLCONTR_DBT dlcont "
    +"           ON DLCONT.T_SFCONTRID = sf.t_id "
    +"  WHERE NOT EXISTS "
    +"               (SELECT 1 "
    +"                  FROM DNPTXOBJ_DBT txobj "
    +"                 WHERE     TXOBJ.T_KIND = " + TXOBJ_PAIDBILL
    +"                       AND txobj.T_CLIENT = deff.T_PARTYID "
    +"                       AND txobj.T_SUM = deff.T_PAIDCOMP + deff.T_PAIDCOMP_15 "
    +"                       AND txobj.T_DATE = deff.T_DATE) "
//    +"        AND deff.T_PARTYID = 144977 "
//    +"  ORDER BY T_ID DESC "
//    +"  FETCH NEXT 1 ROWS ONLY " 
    ;
  return query;
end;

private macro InsertTxRec(date,client,direction,level,user,kind,sum,cur,sum0,
                          analitickind1,analitic1,analitickind2,analitic2,analitickind3,analitic3,analitickind4,analitic4,
                          analitickind5,analitic5,analitickind6,analitic6,comment)
  var txRec = TBFile("nptxobj.dbt","W");
  txRec.rec.date = date;
  txRec.rec.client = client;
  txRec.rec.direction = direction;
  txRec.rec.level = level;
  txRec.rec.user = user;
  txRec.rec.kind = kind;
  txRec.rec.sum = sum;
  txRec.rec.cur = cur;
  txRec.rec.sum0 = sum0;
  txRec.rec.analitickind1 = analitickind1;
  txRec.rec.analitic1 = analitic1;
  txRec.rec.analitickind2 = analitickind2;
  txRec.rec.analitic2 = analitic2;
  txRec.rec.analitickind3 = analitickind3;
  txRec.rec.analitic3 = analitic3;
  txRec.rec.analitickind4 = analitickind4;
  txRec.rec.analitic4 = analitic4;
  txRec.rec.analitickind5 = analitickind5;
  txRec.rec.analitic5 = analitic5;
  txRec.rec.analitickind6 = analitickind6;
  txRec.rec.analitic6 = analitic6;
  txRec.rec.comment = comment;
  
  txRec.rec.FROMOUTSYST = UNSET_CHAR;
  txRec.rec.OUTSYSTCODE = "";
  if(level < 8)
    txRec.rec.OUTSYSTCODE = "КОМПЕНС";
  end;
  txRec.rec.OUTOBJID    = "";
  txRec.rec.SOURCEOBJID = 0;
  txRec.rec.TECHNICAL   = UNSET_CHAR;
  txRec.rec.TAXPERIOD   = 0;

  return txRec.Insert();
end;

private macro ExecuteWork()
  private var env = RsdEnvironment( "RDDrvO", "RDDrvO.dll" );
  private var ConString = GetIniString("CONNSTRING", "rsreq.ini");    
  private var newCon = RsdConnection(env, ConString);

  var cmd = RsdCommand(newCon,GetMainQuery());
  var ds = RSDRecordSet(cmd);

  var count = DL_RSDCommand(GetMainQuery()).GetCount();

  InitCBLog(1, "compensation_log");

  var counter = 0;

  var Rep = CMakeReport(StrHeader);

  if (count > 0)
    InitProgress(count, "Реализация компенсаций", "Реализация компенсаций");
    while (ds.MoveNext())
      SetDialogFlag(0);

      var curDate = SQL_ConvTypeDate(ds.value("t_Date"));
      var ErrStr = "OK";
      var errBuf = "";
      var flag = false;
      var stat = 0;

      var docId = 0;

      flag = InsertTxRec( curDate          // Дата НДР
                   ,ds.value("t_PartyId")       // Клиент
                   ,TXOBJ_DIR_IN     // Направление
                   ,TXOBJ_LEVEL5     // Уровень
                   ,""               // Признак "Пользовательский"
                   ,TXOBJ_PLUSG_4800     // Вид НДР
                   ,ds.value("t_PLUSG_4800")    // Сумма дохода/расхода
                   ,NATCUR           // Валюта дохода/расхода
                   ,ds.value("t_PLUSG_4800")    // Сумма дохода/расхода
                   ,0                // Вид аналитики 1
                   ,-1               // Аналитика 1
                   ,0                // Вид аналитики 2
                   ,-1               // Аналитика 2
                   ,0                // Вид аналитики 3
                   ,-1               // Аналитика 3
                   ,0                // Вид аналитики 4
                   ,-1               // Аналитика 4
                   ,0                // Вид аналитики 5
                   ,-1               // Аналитика 5
                   ,0                // Вид аналитики 6
                   ,-1               // Аналитика 6
                   ," "              // Комментарий
                  );

      if (flag)
        flag = InsertTxRec(curDate          // Дата НДР
                 ,ds.value("t_PartyId")       // Клиент
                 ,TXOBJ_DIR_IN     // Направление
                 ,TXOBJ_LEVEL7     // Уровень
                 ,""               // Признак "Пользовательский"
                 ,TXOBJ_BASECOMP   // Вид НДР
                 ,ds.value("t_PLUSG_4800")    // Сумма дохода/расхода
                 ,NATCUR           // Валюта дохода/расхода
                 ,ds.value("t_PLUSG_4800")    // Сумма дохода/расхода
                 ,0                // Вид аналитики 1
                 ,-1               // Аналитика 1
                 ,0                // Вид аналитики 2
                 ,-1               // Аналитика 2
                 ,0                // Вид аналитики 3
                 ,-1               // Аналитика 3
                 ,0                // Вид аналитики 4
                 ,-1               // Аналитика 4
                 ,0                // Вид аналитики 5
                 ,-1               // Аналитика 5
                 ,0                // Вид аналитики 6
                 ,-1               // Аналитика 6
                 ," "              // Комментарий
                );
        
      end;

      if (flag)

        flag = InsertTxRec( curDate          // Дата НДР
                   ,ds.value("t_PartyId")       // Клиент
                   ,TXOBJ_DIR_IN     // Направление
                   ,TXOBJ_LEVEL7     // Уровень
                   ,""               // Признак "Пользовательский"
                   ,TXOBJ_BASEG9     // Вид НДР
                   ,ds.value("t_PLUSG_4800")    // Сумма дохода/расхода
                   ,NATCUR           // Валюта дохода/расхода
                   ,ds.value("t_PLUSG_4800")    // Сумма дохода/расхода
                   ,0                // Вид аналитики 1
                   ,-1               // Аналитика 1
                   ,0                // Вид аналитики 2
                   ,-1               // Аналитика 2
                   ,0                // Вид аналитики 3
                   ,-1               // Аналитика 3
                   ,0                // Вид аналитики 4
                   ,-1               // Аналитика 4
                   ,0                // Вид аналитики 5
                   ,-1               // Аналитика 5
                   ,0                // Вид аналитики 6
                   ,-1               // Аналитика 6
                   ,"Налогооблагаемая база по общей ставке"              // Комментарий
                  );
      end;

      if (flag)
        flag = InsertTxRec(curDate          // Дата НДР
                   ,ds.value("t_PartyId")       // Клиент
                   ,TXOBJ_DIR_OUT    // Направление
                   ,TXOBJ_LEVEL8     // Уровень
                   ,""               // Признак "Пользовательский"
                   ,TXOBJ_PAIDCOMP   // Вид НДР
                   ,ds.value("t_PAIDCOMP") + ds.value("t_PAIDCOMP_15")    // Сумма дохода/расхода
                   ,NATCUR           // Валюта дохода/расхода
                   ,ds.value("t_PAIDCOMP") + ds.value("t_PAIDCOMP_15")    // Сумма дохода/расхода
                   ,0                // Вид аналитики 1
                   ,-1               // Аналитика 1
                   ,0                // Вид аналитики 2
                   ,-1               // Аналитика 2
                   ,0                // Вид аналитики 3
                   ,-1               // Аналитика 3
                   ,0                // Вид аналитики 4
                   ,-1               // Аналитика 4
                   ,0                // Вид аналитики 5
                   ,-1               // Аналитика 5
                   ,0                // Вид аналитики 6
                   ,-1               // Аналитика 6
                   ," "              // Комментарий
                  );
      end;

      if (not flag)
        ErrStr = GetErrMsg();
      end;

      if (flag)

        var TxArr = TArray ();
    
        if(IsPartyResident(ds.value("t_PartyId")))
          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT*100),
                                            ds.value("t_PLUSG_4800"), 
                                            ds.value("t_PAIDCOMP"));


          if (ds.value("t_PAIDCOMP_15") > 0)
            TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                              ds.value("t_PLUSG_4800"), 
                                              ds.value("t_PAIDCOMP_15"));
          end;
        else
          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_NOTRESIDENT*100),
                                            ds.value("t_PLUSG_4800"), 
                                            ds.value("t_PAIDCOMP") + ds.value("t_PAIDCOMP_15"));
        end;
    
        var year;
        DateSplit(curDate, null, null, year);

        docId = int(string(ds.value("t_CONTRACTID"))+string(ds.value("t_ID")));

        stat = STB_ExecuteCreateSTBOnStep(TxArr,
                                          ds.value("t_PLUSG_4800"),
                                          DL_NPTXCRNSET, 
                                          docId, 
                                          ds.value("t_PartyId"), 
                                          curDate, 
                                          ds.value("t_IIS") == SET_CHAR, 
                                          year, 
                                          0, 
                                          0, 
                                          @errBuf,
                                          curDate,
                                          time(12,0,0),
                                          NULL,
                                          NULL,
                                          NULL,
                                          NULL,
                                          NULL,
                                          NULL,
                                          NPTXTOTALBASE_TAXBASEKIND_ONB
                                          );

        if(errBuf)
          ErrStr = errBuf;
        end;

        if (true)
          if(РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ() == true)

            var query =   " select tb.* "
                    + "   from dnptxtotalbase_dbt tb "
                    + "  where tb.t_docId = ? "
                    + "    and tb.t_dockind = " + DL_NPTXCRNSET
                    + "    and tb.t_ConfirmState = " + NPTXTOTALBASE_CONFIRMSTATE_NOTCONFIRMED
                    + "    and not (tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_CANCELED + " and tb.t_StorID = CHR(1)) ";

            cmd = DL_RSDCommand(query);

            cmd.AddParam(docId);

            var DataSet = cmd.Execute();
            if(DataSet.moveNext())
              stat = DL_ResendSTB(DataSet.tbid,@errBuf);
              if(errBuf)
                ErrStr = errBuf;
              else
                ErrStr = "";
                query = 
                  "   SELECT mes.t_message "
                 +"     FROM dnptxtbmes_dbt mes "
                 +"    WHERE mes.t_TBID IN (SELECT tb.t_TBID "
                 +"                           FROM dnptxtotalbase_dbt tb "
                 +"                          WHERE tb.T_TBID = ? OR TB.T_ORIGTBID = ?) "
                 +" GROUP BY mes.t_message, t_Date, t_Time "
                 +" ORDER BY mes.t_Date ASC, mes.t_Time ASC ";
                var cmd2 = DL_RSDCommand(query);
                cmd2.AddParam(DataSet.tbid);
                cmd2.AddParam(DataSet.tbid);
                var DataSet2 = cmd2.Execute();
                while (DataSet2.moveNext())
                  ErrStr = ErrStr + DataSet2.Message + "\n";
                end;
              end;
            end;

          end;
        end;
        
      end;

      Rep.AddPrintCell(ds.value("t_PartyId"));
      Rep.AddPrintCell(ds.value("t_Name"));
      Rep.AddPrintCell(curDate);
      Rep.AddPrintCell(ds.value("t_PLUSG_4800"));
      Rep.AddPrintCell(ds.value("t_PLUSG_4800"));
      Rep.AddPrintCell(ds.value("t_PLUSG_4800"));
      Rep.AddPrintCell((ds.value("t_PAIDCOMP") + ds.value("t_PAIDCOMP_15")));
      Rep.AddPrintCell(ErrStr);
      Rep.AddStr();

      SetDialogFlag(1);

      UseProgress((counter = counter + 1));
    end;
    RemProgress();
  end;

  if(Rep.IsDataExist())
     if (SHOW_EXCEL)
       /* Печатаем отчет в Excel */
       Rep.PrintWinRep(1, "Sheet"); 
       /* Делаем окно с Excel активным */
       Rep.ShowWinRep();   
     else
       Rep.PrintRep();
     end;
  end;

  InitCBLog(0);

OnError(err)
  SetDialogFlag(1);
  MsgBox(GetFullErrorMessage(err));
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;
end;

ExecuteWork();