/*
$Name:        gtImPFIS.mac
$Module:      Шлюз Securities
$Description: Загрузка ММВБ xml-формат файла биржи рынка СПФИ
$Autor:       Речкалов Иван
$Doc:         //RS-Bank_V6/Doc/Analytic_Doc/Main/Securities/Derivatives/Операции_Импорт_итоги торгов СПФИ.doc
*/

import CTInter, Календарь, FIInter, PTInter, PaymInter, DealsInter,
       "gtconst.inc","rgobj.mac","globals.mac", "gtdlfun.mac", "secinter.mac", "gtmktrep.mac", "rgtgtrec.mac", "GTRrate.mac", "DlForms_h.mac","dldlngfun.mac";
import gtdlfun_u;
import dlutils;

       
private const SRC_CODE = "SPFI";
PRIVATE record pp(IMP_SPFI, "rgate.lbr") dialog;
private var SeanceID, RGLog, FlagCtrlBrk:bool = false, MarketReportID = "", IsMarketReportLoad = false, CurImpDate_ = {Curdate};
private const PNFLD_BEGDATE = 0,
              PNFLD_ENDDATE = 1;
private const CtrlBrkErr = 17;              
private macro GetDateStr(date_val)
   var day,month,year;

   DateSplit(date_val,day,month,year);

   return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,4);
end;   
/**************************************************************/
/* настраиваемый пользователем макрос формирования имен файла */
/**************************************************************/
private macro DateToDirName( date_val )
  var day, month, year;
  DateSplit(date_val, day, month, year);

  //получить последние две цифры года
  year = year - ( year / 100 * 100 ) ;

  return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,2);
end;

private macro get_data_file_name( CurImpDate:date, datafilepath:@string, datafilename:@string, datafilepath_orig:@string )
  var ErrStr:string = "";
  var day:integer = 0, month:integer = 0, year:integer = 0;

   var datafilepath_reg = GetRegImportDirU(CurImpDate, @ErrStr) ;
   datafilepath = datafilepath_reg;
   datafilepath = DL_GetFullPath(datafilepath, true);

  DateSplit(CurImpDate, day, month, year);

  var datafilemask = "*_"  + RGDLFUN_LZ(year,4) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(day,2)  + "*.xml";
  var List = TDirList(datafilepath + datafilemask, "f");

  List.Sort(0);
  if( List.Count == 0 )
     datafilepath = "$"+datafilepath;
     List = TDirList(datafilepath + datafilemask, "f");
     List.Sort(0);
  end;

  if( List.Count == 0 )
     datafilepath = PrcPath(datafilepath_reg);
     List = TDirList(datafilepath + datafilemask, "f");
     List.Sort(0);
  end;

  if( List.Count == 0 )
     datafilename = "";
     RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
     return 1;
  else
     datafilename = List.name(0);
     var txtpath = GetAbsoluteTxtPath()+"\\";
     if((txtpath != "") and (txtpath != datafilepath))
        var stat = CopyFile(datafilepath+datafilename, txtpath+datafilename);
        datafilepath_orig = datafilepath;
        datafilepath = txtpath;
     end;

     RGLog.Message("Используется файл " + datafilename);
     return 0;
  end;
end;              
  
  
/*****************************/
/*  вспомогательные макросы  */
/*****************************/  
private macro GetCorrectDate(DateFromFile:string)
   var vDate = date(0,0,0);
   if( (Date(DateFromFile) == null) or (Date(DateFromFile) == "") )
      RGDLFUN_IsCorrectDate(DateFromFile,vDate);
   else
      vDate = Date(DateFromFile);
   end;
   return vDate;
end;  
  
  
/********************************************************************************/
/* Класс для сохранения XML-документа в виде структуры данных                   */
/* Примечание при чтении:                                                       */
/* moexSpfiReport.ЗАГЛАВНЫЕ_ЕСЛИ_НЕ_КОНЕЧНЫЙ_ЭЛЕМЕНТ.прописные_если_конечный    */
/* т.е. имя_экземпляра.XXX(.XXX).xxx                                            */
/* Пример: moexSpfiReport_obj.HEADER.messageID                                  */
/********************************************************************************/  
class moexSpfiReport

  class header_cls
    var messageID:integer;
    var sentBy:string;
    var sendTo:string;
    var clearingDate:date;
    var creationTimestamp:datetime;
  end;
  /*класс информации о всех сделках*/
  class FPML_cls
    /*класс сделки*/
    class trade_cls
      var TradeID :string;         //номер сделки
      /*класс заголовка сделки*/
      class tradeHeader_cls
        /*класс контрагента (участник клиринга или НКЦ)*/
        class partyTradeIdentifier_cls
          var partyReference :string;   
          var accountReference :string; //клиринговый регистр
          var TradeID :integer;         //номер сделки
        end;
        class partyTradeInformation_cls
          /*код контрагента по парному договору*/
          class relatedParty_cls
            var partyReference :string;
            var role :string;
          end;
          class executionDateTime_cls;
            var _date :date;
            var _time :time;
          end;
        
          var PartyReference :string;
          var relatedParty :relatedParty_cls;  //код контрагента по парному договору
          var category :string;               //биржевая/внебиржевая
          var trader :integer;                 //идентификатор пользователя
          var executionDateTime :datetime;     //дата/время регистрации сделки
        end;
        
        var partyTradeIdentifier_ClearingMan:partyTradeIdentifier_cls;//участник клиринга
        var partyTradeIdentifier_ClearingCenter:partyTradeIdentifier_cls;//нац. клиринговый центр
        var partyTradeInformation:partyTradeInformation_cls; //данные сделки
        var tradeDate :date;
        var clearedDate :date;
        
      end;
      /*класс данных для операции ПроцентныйСВОП*/
      class swap_cls;
        class swapStream_cls
          /*класс правила расчета процентных периодов*/
          class calculationPeriodDates_cls
            /*класс дата начала рассчетного периода*/
            class effectiveDate_cls
              class dateAdjustments_cls
                var businessDayConvention :string;
              end;              

              var unadjustedDate :date;
              var dateAdjustments :dateAdjustments_cls;              
              
            end;
            /*Дата окончания расчетного периода*/
            class terminationDate_cls
              class dateAdjustments_cls
                var businessDayConvention :string;
              end;
              var unadjustedDate :date;
              var dateAdjustments:dateAdjustments_cls;
            end;
            /*Правило переноса даты окончания процентного периода. если она приходится на выходной день*/
            class calculationPeriodDatesAdjustments_cls
              class businessCenters_cls
                var businessCenter_first :string;
                var businessCenter_second :string;
              end;
              var businessDayConvention :string;
              var businessCenters :businessCenters_cls;
            end;
            /*Срок процентного периода */
            class calculationPeriodFrequency_cls
              var periodMultiplier :integer;
              var period :string;
              var rollConvention :string;
            end;
            var id :string;//id
            var effectiveDate :effectiveDate_cls;/*Дата начала расчетного периода*/
            var terminationDate :terminationDate_cls;/*Дата окончания расчетного периода*/
            var calculationPeriodDatesAdjustments :calculationPeriodDatesAdjustments_cls;/*Правило переноса даты окончания процентного периода. если она приходится на выходной день*/
            var calculationPeriodFrequency :calculationPeriodFrequency_cls;
          end;
          /*класс правила расчета дат платежей*/
          class paymentDates_cls
            /*Срок периодичности платежей*/
            class paymentFrequency_cls
              var periodMultiplier :integer;
              var period :string;
            end;
            class paymentDaysOffset_cls
              var periodMultiplier :integer;
              var period :string;
              var dayType :string;/*рабочик/календарные дни*/
            end;
            class paymentDatesAdjustments_cls
              class businessCenters_cls
                var businessCenter_first :string;
                var businessCenter_second :string;
              end;
            
              var businessDayConvention :string;
              var businessCenters :businessCenters_cls;
              
            end;
            
            var calculationPeriodDatesReference :string;/*Ссылка на процентные периоды. т.к. платежи привязаны к ним*/
            var paymentFrequency :paymentFrequency_cls;/*Срок периодичности платежей*/
            var payRelativeTo :string; /*Указание на то. что выплаты происходят в конце процентного периода*/
            var paymentDaysOffset :paymentDaysOffset_cls;
            var paymentDatesAdjustments :paymentDatesAdjustments_cls;
          end;

          class resetDates_cls
            class fixingDates_cls
              var periodMultiplier :integer;
              var period :string;
              var businessDayConvention :string;
              var dateRelativeTo :string;
            end;
            class resetFrequency_cls
              var periodMultiplier :integer;
              var period :string;
            end;
            class resetDatesAdjustments_cls
              class businessCenters_cls
                 var businessCenter:string;
              end;
              var businessDayConvention:string;
              var businessCenters:businessCenters_cls;
            end;
            var id:integer;
            var calculationPeriodDatesReference:string;
            var resetRelativeTo:string;
            var fixingDates:fixingDates_cls;
            var resetFrequency:resetFrequency_cls;
            var resetDatesAdjustments:resetDatesAdjustments_cls;
          end;

          /*класс Номинал и ставка*/
          class calculationPeriodAmount_cls
            class calculation_cls
              /*класс номинал*/
              class notionalSchedule_cls
                class notionalStepSchedule_cls
                  var initialValue :double;
                  var currency: string;
                end;
                var notionalStepSchedule :notionalStepSchedule_cls;
              end;
              /*класс фиксированной ставки*/
              class fixedRateSchedule_cls
                var initialValue :double;
              end;

              /*класс плавающей ставки*/
              class floatingRateCalculation_cls
                var floatingRateIndex: string;
              end;

              var notionalSchedule  :notionalSchedule_cls;/*номинал*/
              var fixedRateSchedule :fixedRateSchedule_cls;/*фиксированная ставка*/
              var floatingRateCalculation :floatingRateCalculation_cls;/*плавающая ставка*/
              var dayCountFraction  :integer;/*Конвенция*/
              
            end;
            var calculation :calculation_cls;
            
          end;
          /*класс Денежные потоки*/
          class cashflows_cls
            class principalExchange_cls
              var id :string;
              var adjustedPrincipalExchangeDate :date;
              var principalExchangeAmount :double;
            end;
            class paymentCalculationPeriod_cls
              /*Сроки процентного периода*/
              class calculationPeriod_cls
                class floatingRateDefinition_cls
                  var calculatedRate :double;
                  class rateObservation_cls
                     var adjustedFixingDate:date;
                     var observedRate:double;
                  end;
                  var rateObservation :rateObservation_cls;
                end;
                var adjustedStartDate :date;
                var adjustedEndDate :date;
                var notionalAmount :double;/*Номинал*/
                var floatingRateDefinition :floatingRateDefinition_cls;
                var fixedRate :double;      /*Ставка */
              end;
              /*Сумма будущего платежа*/
              class forecastPaymentAmount_cls
                var currency :string;
                var amount :double;
              end;
              
              var id :string;
              var adjustedPaymentDate :date;/*Дата платежа*/
              var calculationPeriod :calculationPeriod_cls;/*Сроки процентного периода*/
              var forecastPaymentAmount :forecastPaymentAmount_cls;/*Сумма будущего платежа*/
              
            end;
          
            var cashflowsMatchParameters :bool;
            var principalExchange :principalExchange_cls;
            var principalExchanges:TArray = TArray;
            var paymentCalculationPeriod :paymentCalculationPeriod_cls;
            var paymentCalculationPeriods :TArray = TArray;
          end;
          
          var payerPartyReference :string;/*плательщик*/
          var payerAccountReference :string;
          var receiverPartyReference :string;/*получатель*/
          var receiverAccountReference :string;
          
          var calculationPeriodDates :calculationPeriodDates_cls;/*Правило расчета процентных периодов*/
          var paymentDates :paymentDates_cls;/*Правило расчета дат платежей*/
          var resetDates :resetDates_cls;
          var calculationPeriodAmount :calculationPeriodAmount_cls;/*Номинал и ставка*/
          var cashflows :cashflows_cls;
          
        end;
        
        var productType :string; /*тип инструмента*/
        var swapStreams:TArray = TArray;
        var swapStream :swapStream_cls;
        var swapStream_first :swapStream_cls;
        var swapStream_second :swapStream_cls;
        
      end;
      /*класс данных для операции ВнебиржФорвард*/
      class fxSingleLeg_cls
        /*класс Первый платеж*/
        class exchangedCurrency_cls;
          /*класс Сумма/валюта платежа */
          class paymentAmount_cls
            var currency :string;
            var amount :double;
          end;
          /*класс Дата платежа*/
          class paymentDate_cls
            class dateAdjustments_cls
              var businessDayConvention :string;
            end;
            var unadjustedDate :date;
            var dateAdjustments :dateAdjustments_cls;
          end;
          
          var payerPartyReference :string;
          var payerAccountReference :string;
          var receiverPartyReference :string;
          var receiverAccountReference :string;
          var paymentAmount :paymentAmount_cls;
          var paymentDate :paymentDate_cls;
          var paymentType :string;
        end;
        /*класс Описание валютной пары*/
        class exchangeRate_cls
          /*Описание валютной пары*/
          class quotedCurrencyPair_cls
            var currency1 :string;
            var currency2 :string;
            var quoteBasis :string;
          end;
          var quotedCurrencyPair :quotedCurrencyPair_cls;
          var rate :double;
        end;
        class nonDeliverableSettlement_cls
          class fixing_cls
            class quotedCurrencyPair_cls
              var currency1  :string;
              var currency2  :string;
              var quoteBasis :string;
            end;
            class fxSpotRateSource_cls
              class primaryRateSource_cls
                var rateSource :string;
              end;
              var primaryRateSource :primaryRateSource_cls;
            end;
            var quotedCurrencyPair :quotedCurrencyPair_cls;
            var fixingDate :date;
            var fxSpotRateSource :fxSpotRateSource_cls;
          end;
          var settlementCurrency :string;
          var fixing :fixing_cls;
        end;
        var productType :string;
        var exchangedCurrency1 :exchangedCurrency_cls;
        var exchangedCurrency2 :exchangedCurrency_cls;
        var valueDate :date;
        var exchangeRate :exchangeRate_cls;
        var nonDeliverableSettlement :nonDeliverableSettlement_cls;
      end;
      /*класс данных для операции Валютный СВОП*/
      class fxSwap_cls
        /*класс Первая часть*/
        class nearLeg_cls
          /*класс Первый платеж*/
          class exchangedCurrency_cls;
            /*класс Сумма/валюта платежа */
            class paymentAmount_cls
              var currency :string;
              var amount :double;
            end;
            /*класс Дата платежа*/
            class paymentDate_cls
              class dateAdjustments_cls
                var businessDayConvention :string;
              end;
              var unadjustedDate :date;
              var dateAdjustments :dateAdjustments_cls;
            end;
          
            var payerPartyReference :string;
            var payerAccountReference :string;
            var receiverPartyReference :string;
            var receiverAccountReference :string;
            var paymentAmount :paymentAmount_cls;
            var paymentDate :paymentDate_cls;
            var paymentType :string;
          end;
          /*класс Описание валютной пары*/
          class exchangeRate_cls
            /*Описание валютной пары*/
            class quotedCurrencyPair_cls
              var currency1 :string;
              var currency2 :string;
              var quoteBasis :string;
            end;
            var quotedCurrencyPair :quotedCurrencyPair_cls;
            var rate :double;
          end;
          var exchangedCurrency1 :exchangedCurrency_cls;
          var exchangedCurrency2 :exchangedCurrency_cls;
          var valueDate :date;
          var exchangeRate :exchangeRate_cls;
        end;
        /*класс Вторая часть*/
        class farLeg_cls
          /*класс Первый платеж*/
          class exchangedCurrency_cls;
            /*класс Сумма/валюта платежа */
            class paymentAmount_cls
              var currency :string;
              var amount :double;
            end;
            /*класс Дата платежа*/
            class paymentDate_cls
              class dateAdjustments_cls
                var businessDayConvention :string;
              end;
              var unadjustedDate :date;
              var dateAdjustments :dateAdjustments_cls;
            end;
          
            var payerPartyReference :string;
            var payerAccountReference :string;
            var receiverPartyReference :string;
            var receiverAccountReference :string;
            var paymentAmount :paymentAmount_cls;
            var paymentDate :paymentDate_cls;
            var paymentType :string;
          end;
          /*класс Описание валютной пары*/
          class exchangeRate_cls
            /*Описание валютной пары*/
            class quotedCurrencyPair_cls
              var currency1 :string;
              var currency2 :string;
              var quoteBasis :string;
            end;
            var quotedCurrencyPair :quotedCurrencyPair_cls;
            var rate :double;
          end;
          var exchangedCurrency1 :exchangedCurrency_cls;
          var exchangedCurrency2 :exchangedCurrency_cls;
          var valueDate :date;
          var exchangeRate :exchangeRate_cls;
        end;
        class nonDeliverableSettlement_cls
          class fixing_cls
            class quotedCurrencyPair_cls
              var currency1  :string;
              var currency2  :string;
              var quoteBasis :string;
            end;
            class fxSpotRateSource_cls
              class primaryRateSource_cls
                var rateSource :string;
              end;
              var primaryRateSource :primaryRateSource_cls;
            end;
            var quotedCurrencyPair :quotedCurrencyPair_cls;
            var fixingDate :date;
            var fxSpotRateSource :fxSpotRateSource_cls;
          end;
          var settlementCurrency :string;
          var fixing :fixing_cls;
        end;
        var nonDeliverableSettlement :nonDeliverableSettlement_cls;
        var productType :string;
        var nearLeg :nearLeg_cls;
        var farLeg :farLeg_cls;
      end;
      /*класс данных для... ещё чего то*/
      class bulletPayment_cls
        var productType :string;
      end;
      class otherPartyPayment_cls     
        /*Сумма/валюта платежа*/
        class paymentAmount_cls
          var currency :string;
          var amount :double;
        end;
        /*Дата платежа*/
        class paymentDate_cls
          var adjustedDate :date;
        end;
              
        var id :string;
        var payerPartyReference :string;/*плательщик*/
        var payerAccountReference :string;
        var receiverPartyReference :string;/*получатель*/
        var receiverAccountReference :string;
        var paymentAmount :paymentAmount_cls;/*Сумма/валюта платежа*/
        var paymentDate :paymentDate_cls;/*Дата платежа*/
        var paymentType :string;/*Код типа платежа*/
        
      end;
      /*класс Дополнительная информация рынка СПФИ*/
      class moexSpfiExt_cls
        /*класс информация о сделке*/
        class tradeInfo_cls
          var settlementCode :string;/*Расчетный код на котором учитывается сделка/платеж*/
          var csa :string;
        end;
        class npv_cls
          class npvPoint_cls
            /*класс Значение NPV*/
            class npvValue_cls
              var npvCurrency :string;
              var npvAmount :double;
            end;
            /*класс Платежи. зависящие от изменения NPV (вариационная маржа)*/
            class npvPayment_cls
              /*класс Сумма/валюта платежа*/
              class paymentAmount_cls
                var currency :string;
                var amount :double;
              end;
              /*Дата платежа*/
              class paymentDate_cls
                var adjustedDate :date;
              end;
              var id :string;
              var payerPartyReference :string;/*Плательщик*/
              var payerAccountReference :string;
              var receiverPartyReference :string;/*получатель*/
              var receiverAccountReference :string;
              var paymentAmount :paymentAmount_cls;/*Сумма/валюта платежа*/
              var paymentDate: paymentDate_cls;/*Дата платежа*/              
              var paymentType :string;/*Код типа платежа*/
            end;
            var npvDate :date;/*Дата определения NPV*/
            var npvValue :npvValue_cls;/*Значение NPV*/
            var npvPayment :npvPayment_cls;/*Платежи. зависящие от изменения NPV (вариационная маржа)*/
            var npvPayments :TArray = TArray;
            
          end;
          
          /*текущий, для удобства кодонаписания*/
          var npvPoint :npvPoint_cls;
          var npvPoints:TArray = TArray;
        end;
        var tradeInfo :tradeInfo_cls;
        var npv :npv_cls;
      end;
      
      var tradeHeader :tradeHeader_cls;
      var swap :swap_cls;  
      var fxSingleLeg :fxSingleLeg_cls;
      var fxSwap :fxSwap_cls;
      var bulletPayment :bulletPayment_cls;
      var otherPartyPayment :otherPartyPayment_cls;
      var otherPartyPayments:TArray = TArray;
      var moexSpfiExt :moexSpfiExt_cls;

      
    end;
    /*класс Рыночные данные*/
    class market_cls
      
    end;
    class party_cls
      var partyID :string;
      var partyName :string;
    end;
    class account_cls
    end;
    
    /*массив сделок*/
    var trades:TArray = TArray;
    /*одна сделка (для удобства кодонаписания)*/
    var trade:trade_cls;
    var party:party_cls;
    var parties:TArray = TArray;
    
    
    
  end;

  var Header:header_cls;
  var FPML:FPML_cls;
  
end;
              
private macro CheckPanel( Pan ):bool

  if( Pan.beg_date == date(0,0,0) )
     MsgBox("Не задана дата начала периода");
     return false;
  end;

  if( Pan.end_date == date(0,0,0) )
     MsgBox("Не задана дата окончания периода");
     return false;
  end;

  if( Pan.end_date < Pan.beg_date )
     MsgBox("Дата окончания периода не может быть меньше даты начала периода");
     return false;
  end;

  return true;
end;

/************************************************************************/
/* Макрос для переноса данных модели (объекта rsl, повторяющего xml)     */
/* В записи репликации вида:                                            */
/* "Внебиржевая сделка с ПИ" - код 53                                   */
/* "Строка графика платежей процентногоСВОП-а" - код 57                 */
/************************************************************************/  
private macro convertFromModelToReplicationRecords( Mobj:moexSpfiReport)
  
  var obj = Mobj.FPML.trades.createEnum;
  var ErrMes:string = "", NTrades = Mobj.FPML.trades.size;
  var Cound_RG_Total = 0, Cound_RG_Saved = 0, b = 0;
  var Cound_RG_npvPoint_Total = 0 , Cound_RG_npvPoint_Saved = 0;
  var Cound_RG_PM_GR_Total = 0, Cound_RG_PM_GR_Saved = 0;
  var Cound_RG_FIXPM_GR_Total = 0, Cound_RG_FIXPM_GR_Saved = 0;
  var Cound_RG_FairVal_Total = 0, Cound_RG_FairVal_Saved = 0;

  var RG;

  InitProgress(NTrades, "Обработка данных внешнего файла итогов торгов на рынке СПФИ", "Создание ЗР по итогам торгов на рынке СПФИ...");

  while (obj.next)

    var RGDVNDL_KIND = null, RGDVNDL_BUYSELL= null, RGDVNDL_SECTOR= null;
    var RGDVNDL_PAYDATE  = null, RGDVNDL_EXECDATE  = null, RGDVNDL_SUPLDATE  = null;
    var RGDVNDL_PAYDATE_2= null, RGDVNDL_EXECDATE_2= null, RGDVNDL_SUPLDATE_2= null;
    var RGDVNDL_ISIN  = null, RGDVNDL_AMOUNT  = null, RGDVNDL_PRICE  = null, RGDVNDL_COST  = null, RGDVNDL_PRICEFIID  = null, RGDVNDL_TYPEEXEC  = null;
    var RGDVNDL_ISIN_2= null, RGDVNDL_AMOUNT_2= null, RGDVNDL_PRICE_2= null, RGDVNDL_COST_2= null, RGDVNDL_PRICEFIID_2= null;
    var RGDVNDL_SPREAD = 0.0, RGDVNDL_SPREAD_2 = 0.0;
    var RGDVNDL_RATE_DVNFI = null, RGDVNDL_RATE_DVNFI_2 = null;
    var RGDVNDL_FIXRATE_DVNFI = null, RGDVNDL_FIXRATE_DVNFI_2 = null;
    var RGDVNDL_PAYKIND = null, RGDVNDL_EXTCODE = null;
    var RGDVNDL_PERIOD_DVNFI = null, RGDVNDL_PERIODKIND_DVNFI = null, RGDVNDL_PERIOD_DVNFI_2 = null, RGDVNDL_PERIODKIND_DVNFI_2 = null;
    var RGDVNDL_TYPECALC_DVNFI = null, RGDVNDL_TYPECALC_DVNFI_2 = null;
    var RGDVNDL_RATEID_DVNFI = null, RGDVNDL_RATEID_DVNFI_2 = null, RGDVNDL_AMOUNT_COMM = null, RGDVNDL_CLRCOMM = null;
    var RGDVNDL_COMM_DATE = null, RGDVNDL_CLRCOMM_DATE = null;
    var RGDVNDL_BEGINDATE = null;
    var RGDVNDL_SWAPTYPE = null;
    var RGDVNDL_EXTSETTLECODE = null;
    var Об = null, Тр = null;
    var Ба = null, Ка = null;
    var Ба2ч = null, Ка2ч = null;
    var k = 0, p = 0;
    var RelPartyRefCode = "", RelPartyRefName = "";

    if ( obj.item.swap.productType )
      if (( obj.item.swap.productType == "IRS") or (obj.item.swap.productType == "XCCY" ) or (obj.item.swap.productType == "OIS" ))
        RGDVNDL_KIND = ПроцентныйСВОП; /*2720, Процентный СВОП(сделка с ПИ)*/
      else
        b = b + 1;
        UseProgress(b);
        continue;
      end;
    elif ( obj.item.fxSingleLeg.productType )
      if (obj.item.fxSingleLeg.productType == "FWD")
        RGDVNDL_KIND = ВнебиржФорвард;/*Внебиржевой форвард*/ /*2690*/
      else
        b = b + 1;
        UseProgress(b);
        continue;
      end;
    elif ( obj.item.fxSwap.productType )
      if (obj.item.fxSwap.productType == "FXSWAP")
        RGDVNDL_KIND = ВалютныйСВОП;/*Валютный СВОП*/ /*2710*/
      else
        b = b + 1;
        UseProgress(b);
        continue;
      end;
    elif (obj.item.bulletPayment.productType)
      b = b + 1;
      UseProgress(b);
      continue;
    end;

    if( SubStr(obj.item.TradeID, 1, 1) == "t" )
       obj.item.TradeID = SubStr(obj.item.TradeID, 2); 
    end;
    RG = TGTRecord(ВставкаЧерезКеш, 
              SeanceID, 
              NULL,
              RG_DVNDEAL, 
                   String("Внебирж. сделка с ПИ № " + obj.item.TradeID),
              Создать );
              
    if(NOT RG.InitByCode(RG_DVNDEAL, obj.item.TradeID, SRC_CODE) )
       Exit();
    end;

    RGDVNDL_EXTCODE = obj.item.TradeID;
    RGDVNDL_SECTOR = IIF (obj.item.tradeHeader.partyTradeInformation.category == "Exchange", SET_CHAR, UNSET_CHAR);  
    RGDVNDL_EXTSETTLECODE = obj.item.moexSpfiExt.tradeInfo.settlementCode;  
    
    if(RGDVNDL_KIND == ВнебиржФорвард)                                                          

      RGDVNDL_TYPEEXEC = IIF (obj.item.fxSingleleg.nonDeliverableSettlement.settlementCurrency, DVSETTLEMET_CALC,DVSETTLEMET_STATE);

      /*по ТЗ пока неверное определение сторон валют (БА=КА, что неверно и суммы тоже), поэтому пока делаю так*/
      if( obj.item.fxSingleleg.exchangeRate.quotedCurrencyPair.quoteBasis == "Currency1PerCurrency2" )
         Ба = obj.item.fxSingleleg.exchangedCurrency2;
         Ка = obj.item.fxSingleleg.exchangedCurrency1;
      else
         Ба = obj.item.fxSingleleg.exchangedCurrency1;
         Ка = obj.item.fxSingleleg.exchangedCurrency2;
      end;

      if( Ба.payerPartyReference == "NCCB" )
         RGDVNDL_BUYSELL = "B";
      else
         RGDVNDL_BUYSELL = "S";
      end;

      RGDVNDL_ISIN = Ба.paymentAmount.currency; 
      RGDVNDL_ISIN = IIF ( RGDVNDL_ISIN == "RUB", "RUR", RGDVNDL_ISIN);      
      RGDVNDL_AMOUNT = Ба.paymentAmount.amount;      
      RGDVNDL_PRICE = obj.item.fxSingleleg.exchangeRate.rate;
      RGDVNDL_COST  = Ка.paymentAmount.amount;

      RGDVNDL_PRICEFIID = Ка.paymentAmount.currency;
      RGDVNDL_PRICEFIID = IIF ( RGDVNDL_PRICEFIID == "RUB", "RUR", RGDVNDL_PRICEFIID);

      /*даты по ТЗ тоже странно получаются, поэтому делаю пока так*/
      RGDVNDL_PAYDATE = GetCorrectDate(Ка.paymentDate.unadjustedDate);
      RGDVNDL_SUPLDATE = GetCorrectDate(Ба.paymentDate.unadjustedDate);
      RGDVNDL_EXECDATE = GetCorrectDate(obj.item.fxSingleleg.valueDate);

    elif(RGDVNDL_KIND == ПроцентныйСВОП)

      RGDVNDL_TYPEEXEC = IIF (obj.item.swap.productType == "XCCY", DVSETTLEMET_STATE,DVSETTLEMET_CALC);

      if( obj.item.swap.swapStream_first.payerPartyReference != "NCCB" )
         Об = obj.item.swap.swapStream_first;
         Тр = obj.item.swap.swapStream_second;
      else
         Об = obj.item.swap.swapStream_second;
         Тр = obj.item.swap.swapStream_first;
      end;

      RGDVNDL_BUYSELL = IIF(Об.calculationPeriodAmount.calculation.fixedRateSchedule.initialValue != null, "FIX", "FLOAT" );
      RGDVNDL_BUYSELL = RGDVNDL_BUYSELL + "/";
      RGDVNDL_BUYSELL = RGDVNDL_BUYSELL + IIF(Тр.calculationPeriodAmount.calculation.fixedRateSchedule.initialValue != null, "FIX", "FLOAT" ); 

      RGDVNDL_ISIN   = Об.calculationPeriodAmount.calculation.notionalSchedule.notionalStepSchedule.currency; 
      RGDVNDL_ISIN_2 = Тр.calculationPeriodAmount.calculation.notionalSchedule.notionalStepSchedule.currency;
      RGDVNDL_ISIN   = IIF ( RGDVNDL_ISIN   == "RUB", "RUR", RGDVNDL_ISIN  );
      RGDVNDL_ISIN_2 = IIF ( RGDVNDL_ISIN_2 == "RUB", "RUR", RGDVNDL_ISIN_2);

      RGDVNDL_AMOUNT   = Об.calculationPeriodAmount.calculation.notionalSchedule.notionalStepSchedule.initialValue;
      RGDVNDL_AMOUNT_2 = Тр.calculationPeriodAmount.calculation.notionalSchedule.notionalStepSchedule.initialValue;

      RGDVNDL_EXECDATE_2   =  GetCorrectDate(Об.calculationPeriodDates.terminationDate.unadjustedDate);     

      var sw = 0;
      var MaxDate = date(0,0,0);
      while ( sw < obj.item.SWAP.swapStreams.size )
        var swObj = obj.item.SWAP.swapStreams[sw];
        var cf = 0;
        while ( cf < swObj.cashflows.paymentCalculationPeriods.size )
          var pm_obj = swObj.cashflows.paymentCalculationPeriods[cf];
          if(GetCorrectDate(pm_obj.adjustedPaymentDate) > MaxDate)
            MaxDate = GetCorrectDate(pm_obj.adjustedPaymentDate);
          end;
          cf = cf + 1;
        end;
        sw = sw + 1;
      end;

      if(MaxDate != date(0,0,0))
        RGDVNDL_EXECDATE = MaxDate;
      end;

      if( RGDVNDL_BUYSELL == "FIX/FLOAT" )
         RGDVNDL_RATE_DVNFI     = Об.calculationPeriodAmount.calculation.fixedRateSchedule.initialValue*100;
         RGDVNDL_RATEID_DVNFI_2 = Тр.calculationPeriodAmount.calculation.floatingRateCalculation.floatingRateIndex;
         RGDVNDL_FIXRATE_DVNFI_2 = abs(Тр.RESETDATES.FIXINGDATES.periodMultiplier);
      elif( RGDVNDL_BUYSELL == "FIX/FIX" )
         RGDVNDL_RATE_DVNFI     = Об.calculationPeriodAmount.calculation.fixedRateSchedule.initialValue*100;
         RGDVNDL_RATE_DVNFI_2 = Тр.calculationPeriodAmount.calculation.fixedRateSchedule.initialValue*100;
      elif( RGDVNDL_BUYSELL == "FLOAT/FLOAT" )
         RGDVNDL_RATEID_DVNFI = Об.calculationPeriodAmount.calculation.floatingRateCalculation.floatingRateIndex;
         RGDVNDL_FIXRATE_DVNFI = abs(Об.RESETDATES.FIXINGDATES.periodMultiplier);
         RGDVNDL_RATEID_DVNFI_2 = Тр.calculationPeriodAmount.calculation.floatingRateCalculation.floatingRateIndex;
         RGDVNDL_FIXRATE_DVNFI_2 = abs(Тр.RESETDATES.FIXINGDATES.periodMultiplier);
      else
         RGDVNDL_RATE_DVNFI_2 = Тр.calculationPeriodAmount.calculation.fixedRateSchedule.initialValue*100;
         RGDVNDL_RATEID_DVNFI = Об.calculationPeriodAmount.calculation.floatingRateCalculation.floatingRateIndex;
         RGDVNDL_FIXRATE_DVNFI = abs(Об.RESETDATES.FIXINGDATES.periodMultiplier);
      end;
      
      RGDVNDL_BEGINDATE = GetCorrectDate(Об.CALCULATIONPERIODDATES.EFFECTIVEDATE.unadjustedDate);

      RGDVNDL_PERIOD_DVNFI = Об.calculationPeriodDates.calculationPeriodFrequency.periodMultiplier;
      RGDVNDL_PERIODKIND_DVNFI = Об.calculationPeriodDates.calculationPeriodFrequency.period;
      RGDVNDL_TYPECALC_DVNFI = Об.calculationPeriodDates.calculationPeriodDatesAdjustments.businessDayConvention;
      
      RGDVNDL_PERIOD_DVNFI_2 = Тр.calculationPeriodDates.calculationPeriodFrequency.periodMultiplier;
      RGDVNDL_PERIODKIND_DVNFI_2 = Тр.calculationPeriodDates.calculationPeriodFrequency.period;
      RGDVNDL_TYPECALC_DVNFI_2 = Тр.calculationPeriodDates.calculationPeriodDatesAdjustments.businessDayConvention;
      
      if   (obj.item.swap.productType  == "IRS"  )
         RGDVNDL_SWAPTYPE = 1;
      elif (obj.item.swap.productType  == "OIS"  )
         RGDVNDL_SWAPTYPE = 2;
      elif (obj.item.swap.productType  == "XCCY" )
         RGDVNDL_SWAPTYPE = 3;
      end;
    elif(RGDVNDL_KIND == ВалютныйСВОП)
      if( obj.item.fxSwap.nearLeg.exchangeRate.quotedCurrencyPair.quoteBasis == "Currency1PerCurrency2" )
         Ба = obj.item.fxSwap.nearLeg.exchangedCurrency2;
         Ка = obj.item.fxSwap.nearLeg.exchangedCurrency1;
      else
         Ба = obj.item.fxSwap.nearLeg.exchangedCurrency1;
         Ка = obj.item.fxSwap.nearLeg.exchangedCurrency2;
      end;
      if( obj.item.fxSwap.farLeg.exchangeRate.quotedCurrencyPair.quoteBasis == "Currency1PerCurrency2" )
         Ба2ч = obj.item.fxSwap.farLeg.exchangedCurrency2;
         Ка2ч = obj.item.fxSwap.farLeg.exchangedCurrency1;
      else
         Ба2ч = obj.item.fxSwap.farLeg.exchangedCurrency1;
         Ка2ч = obj.item.fxSwap.farLeg.exchangedCurrency2;
      end;
      if( Ба.payerPartyReference == "NCCB" )
         RGDVNDL_BUYSELL = "B/S";
      else
         RGDVNDL_BUYSELL = "S/B";
      end;

      RGDVNDL_TYPEEXEC = IIF (obj.item.fxSwap.nonDeliverableSettlement.settlementCurrency, DVSETTLEMET_CALC,DVSETTLEMET_STATE);

      RGDVNDL_ISIN = Ба.paymentAmount.currency; 
      RGDVNDL_ISIN = IIF ( RGDVNDL_ISIN == "RUB", "RUR", RGDVNDL_ISIN);      

      RGDVNDL_PRICEFIID = Ка.paymentAmount.currency;
      RGDVNDL_PRICEFIID = IIF ( RGDVNDL_PRICEFIID == "RUB", "RUR", RGDVNDL_PRICEFIID);

      RGDVNDL_ISIN_2 = Ба2ч.paymentAmount.currency; 
      RGDVNDL_ISIN_2 = IIF ( RGDVNDL_ISIN_2 == "RUB", "RUR", RGDVNDL_ISIN_2);      

      RGDVNDL_PRICEFIID_2 = Ка2ч.paymentAmount.currency;
      RGDVNDL_PRICEFIID_2 = IIF ( RGDVNDL_PRICEFIID_2 == "RUB", "RUR", RGDVNDL_PRICEFIID_2);

      RGDVNDL_AMOUNT     = Ба.paymentAmount.amount;
      RGDVNDL_SUPLDATE   = GetCorrectDate(Ба.paymentDate.unadjustedDate);
      RGDVNDL_COST       = Ка.paymentAmount.amount;
      RGDVNDL_PAYDATE    = GetCorrectDate(Ка.paymentDate.unadjustedDate);
      RGDVNDL_EXECDATE   = min(RGDVNDL_SUPLDATE,RGDVNDL_PAYDATE);

      RGDVNDL_AMOUNT_2     = Ба2ч.paymentAmount.amount;
      RGDVNDL_SUPLDATE_2   = GetCorrectDate(Ба2ч.paymentDate.unadjustedDate);
      RGDVNDL_COST_2       = Ка2ч.paymentAmount.amount;
      RGDVNDL_PAYDATE_2    = GetCorrectDate(Ка2ч.paymentDate.unadjustedDate);
      RGDVNDL_EXECDATE_2   = min(RGDVNDL_SUPLDATE_2,RGDVNDL_PAYDATE_2);

      RGDVNDL_PRICE = obj.item.fxSwap.nearLeg.exchangeRate.rate;
      RGDVNDL_PRICE_2 = obj.item.fxSwap.farLeg.exchangeRate.rate; 
    end;

    /*комиссии*/
    if( obj.item.otherPartyPayments.size() > 0 )
       while( obj.item.otherPartyPayments.size() > k )
          if( obj.item.otherPartyPayments[k].paymentType == "SCMC1" )
             RGDVNDL_AMOUNT_COMM = obj.item.otherPartyPayments[k].paymentAmount.Amount;
             RGDVNDL_COMM_DATE = obj.item.otherPartyPayments[k].paymentDate.adjustedDate;
          elif( obj.item.otherPartyPayments[k].paymentType == "SCMC2" )
             RGDVNDL_CLRCOMM = obj.item.otherPartyPayments[k].paymentAmount.Amount;
             RGDVNDL_CLRCOMM_DATE = obj.item.otherPartyPayments[k].paymentDate.adjustedDate;
          end;
          k = k + 1;
       end;
    end;

    /*Вид сделки*/          
    RG.SetParmByName( "RGDVNDL_KIND", RGDVNDL_KIND );
    /*направлеие сделки*/    
    RG.SetParmByName( "RGDVNDL_BUYSELL", RGDVNDL_BUYSELL );
    /*Код внешний*/          
    RG.SetParmByName( "RGDVNDL_EXTCODE", RGDVNDL_EXTCODE );
    /*Код внутренний*/
    RG.SetParmByName( "RGDVNDL_CODE",    GetDateStr(GetCorrectDate(obj.item.tradeHeader.tradeDate)) + RGDVNDL_EXTCODE );
    /*Дата регистрации*/
    RG.SetParmByName( "RGDVNDL_DATE",    GetCorrectDate(obj.item.tradeHeader.partyTradeInformation.executionDateTime));
    /*Время регистрации*/
    RG.SetParmByName( "RGDVNDL_TIME",    time(obj.item.tradeHeader.partyTradeInformation.executionDateTime));
    /*Направление сделки*/ /* ALG-номер 7004*/
    RG.SetParmByName( "RGDVNDL_BUYSELL", RGDVNDL_BUYSELL);
    /*Признак "биржевая" (если выставлен - "Биржевая с ЦК", иначе - "Внебиржевая с ЦК")*/
    RG.SetParmByName( "RGDVNDL_SECTOR", RGDVNDL_SECTOR);
    /*Расчетный код*/
    RG.SetParmByName( "RGDVNDL_EXTSETTLECODE", RGDVNDL_EXTSETTLECODE);
    /*Расчетный - 1, Поставочный - 2*/
    RG.SetParmByName( "RGDVNDL_TYPEEXEC", RGDVNDL_TYPEEXEC);
    /*дата исполнения сделки/части*/
    RG.SetParmByName( "RGDVNDL_EXECDATE", RGDVNDL_EXECDATE);
    /*конечный контрагент по сделке*/

    RelPartyRefCode = obj.item.tradeHeader.partyTradeInformation.relatedParty.PartyReference;
    if (RelPartyRefCode != NULL)
      while ( Mobj.FPML.parties.size() > p)
        if (Mobj.FPML.parties[p].partyID == RelPartyRefCode)
   
          RelPartyRefName = Mobj.FPML.parties[p].partyName;
          RG.SetParmByName( "RGDVNDL_RELPARTYREF", RelPartyRefName);
          
          break;
        end;
        p = p + 1;
      end;
    end;
    
    /*блок базовый актив*/
    /*код БА*/
    RG.SetParmByName( "RGDVNDL_ISIN", RGDVNDL_ISIN);
    /*количество БА*/
    RG.SetParmByName( "RGDVNDL_AMOUNT", RGDVNDL_AMOUNT);

    if( RGDVNDL_AMOUNT_COMM != null )
       RG.SetParmByName( "RGDVNDL_AMOUNT_COMM", RGDVNDL_AMOUNT_COMM );
       RG.SetParmByName( "RGDVNDL_COMM_DATE", RGDVNDL_COMM_DATE );
    end;
    if( RGDVNDL_CLRCOMM != null )
       RG.SetParmByName( "RGDVNDL_CLRCOMM", RGDVNDL_CLRCOMM );
       RG.SetParmByName( "RGDVNDL_CLRCOMM_DATE", RGDVNDL_CLRCOMM_DATE );
    end;
    
    if( RGDVNDL_BEGINDATE != null)
       RG.SetParmByName("RGDVNDL_BEGINDATE", RGDVNDL_BEGINDATE);
    end;

    if( RGDVNDL_KIND == ПроцентныйСВОП )
      if( RGDVNDL_SPREAD != null )
         RG.SetParmByName( "RGDVNDL_SPREAD", RGDVNDL_SPREAD );
      end;
      if( RGDVNDL_SPREAD_2 != null )
         RG.SetParmByName( "RGDVNDL_SPREAD_2", RGDVNDL_SPREAD_2 );
      end;
      /*блок контрактив*/      
      /*код контрактива*/
      if ( RGDVNDL_ISIN_2 != null )
        RG.SetParmByName( "RGDVNDL_ISIN_2", RGDVNDL_ISIN_2);
      end;
      /*количество КА*/  
      if ( RGDVNDL_AMOUNT_2 != null )
        RG.SetParmByName( "RGDVNDL_AMOUNT_2", RGDVNDL_AMOUNT_2);
      end;
      /*Сохранение фиксированной ставки, если она задана*/
      /*для каждой ноги отдельно*/
      if (RGDVNDL_RATE_DVNFI != null)
        RG.SetParmByName( "RGDVNDL_RATE_DVNFI", RGDVNDL_RATE_DVNFI );
      end;
      if (RGDVNDL_RATE_DVNFI_2 != null)
        RG.SetParmByName( "RGDVNDL_RATE_DVNFI_2", RGDVNDL_RATE_DVNFI_2 );
      end;

      if (RGDVNDL_RATEID_DVNFI != null)
        RG.SetParmByName( "RGDVNDL_RATEID_DVNFI", RGDVNDL_RATEID_DVNFI );
      end;
      if (RGDVNDL_RATEID_DVNFI_2 != null)
        RG.SetParmByName( "RGDVNDL_RATEID_DVNFI_2", RGDVNDL_RATEID_DVNFI_2 );
      end;

      if (RGDVNDL_PERIOD_DVNFI != null)
        RG.SetParmByName( "RGDVNDL_PERIOD_DVNFI", RGDVNDL_PERIOD_DVNFI );
      end;
      if (RGDVNDL_PERIODKIND_DVNFI != null)
        RG.SetParmByName( "RGDVNDL_PERIODKIND_DVNFI", RGDVNDL_PERIODKIND_DVNFI );
      end;
      if (RGDVNDL_PERIOD_DVNFI_2 != null)
        RG.SetParmByName( "RGDVNDL_PERIOD_DVNFI_2", RGDVNDL_PERIOD_DVNFI_2 );
      end;
      if (RGDVNDL_PERIODKIND_DVNFI_2 != null)
        RG.SetParmByName( "RGDVNDL_PERIODKIND_DVNFI_2", RGDVNDL_PERIODKIND_DVNFI_2 );
      end;
      if (RGDVNDL_TYPECALC_DVNFI != null)
        RG.SetParmByName( "RGDVNDL_TYPECALC_DVNFI", RGDVNDL_TYPECALC_DVNFI );
      end;
      if (RGDVNDL_TYPECALC_DVNFI_2 != null)
        RG.SetParmByName( "RGDVNDL_TYPECALC_DVNFI_2", RGDVNDL_TYPECALC_DVNFI_2 );
      end;
      if (RGDVNDL_FIXRATE_DVNFI != null)
        RG.SetParmByName( "RGDVNDL_FIXRATE_DVNFI", RGDVNDL_FIXRATE_DVNFI );
      end;
      if (RGDVNDL_FIXRATE_DVNFI_2 != null)
        RG.SetParmByName( "RGDVNDL_FIXRATE_DVNFI_2", RGDVNDL_FIXRATE_DVNFI_2 );
      end;
      if (RGDVNDL_SWAPTYPE != null)
        RG.SetParmByName( "RGDVNDL_SWAPTYPE", RGDVNDL_SWAPTYPE );
      end;

      if (RGDVNDL_EXECDATE_2 != null)
        RG.SetParmByName( "RGDVNDL_EXECDATE_2", RGDVNDL_EXECDATE_2 );
      end;
    elif(RGDVNDL_KIND != ВалютныйСВОП)
      /*цена единицы базового актива*/
      if ( RGDVNDL_PRICE != null)
        RG.SetParmByName( "RGDVNDL_PRICE", RGDVNDL_PRICE);
      end;
      /*валюта цены БА*/
      if ( RGDVNDL_PRICEFIID !=NULL )
        RG.SetParmByName( "RGDVNDL_PRICEFIID", RGDVNDL_PRICEFIID);
      end;
      if (RGDVNDL_COST != null)
        RG.SetParmByName( "RGDVNDL_COST", RGDVNDL_COST);
      end;
      /*дата поставки базового актива*/
      if (RGDVNDL_PAYDATE != NULL)
        RG.SetParmByName( "RGDVNDL_PAYDATE", RGDVNDL_PAYDATE);
      end;
      /*дата поставки контр актива*/
      if (RGDVNDL_SUPLDATE != NULL)
        RG.SetParmByName( "RGDVNDL_SUPLDATE", RGDVNDL_SUPLDATE);
      end;
    end;
       
    if( RGDVNDL_KIND == ВалютныйСВОП )
      /*дата исполнения сделки/части*/
      RG.SetParmByName( "RGDVNDL_EXECDATE_2", RGDVNDL_EXECDATE_2);

      if ( RGDVNDL_ISIN != null )
        RG.SetParmByName( "RGDVNDL_ISIN", RGDVNDL_ISIN);
      end;
      if ( RGDVNDL_ISIN_2 != null )
        RG.SetParmByName( "RGDVNDL_ISIN_2", RGDVNDL_ISIN_2);
      end;
      /*валюта цены БА*/
      if ( RGDVNDL_PRICEFIID !=NULL )
        RG.SetParmByName( "RGDVNDL_PRICEFIID", RGDVNDL_PRICEFIID);
      end;
      /*валюта цены БА*/
      if ( RGDVNDL_PRICEFIID !=NULL )
        RG.SetParmByName( "RGDVNDL_PRICEFIID_2", RGDVNDL_PRICEFIID_2);
      end;
      if ( RGDVNDL_COST !=NULL )
        RG.SetParmByName( "RGDVNDL_COST", RGDVNDL_COST);
      end;
      if ( RGDVNDL_SUPLDATE !=NULL )
        RG.SetParmByName( "RGDVNDL_SUPLDATE", RGDVNDL_SUPLDATE);
      end;
      if ( RGDVNDL_PAYDATE !=NULL )
        RG.SetParmByName( "RGDVNDL_PAYDATE", RGDVNDL_PAYDATE);
      end;
      if ( RGDVNDL_AMOUNT_2 !=NULL )
        RG.SetParmByName( "RGDVNDL_AMOUNT_2", RGDVNDL_AMOUNT_2);
      end;
      if ( RGDVNDL_COST_2 !=NULL )
        RG.SetParmByName( "RGDVNDL_COST_2", RGDVNDL_COST_2);
      end;
      if ( RGDVNDL_SUPLDATE_2 !=NULL )
        RG.SetParmByName( "RGDVNDL_SUPLDATE_2", RGDVNDL_SUPLDATE_2);
      end;
      if ( RGDVNDL_PAYDATE_2 !=NULL )
        RG.SetParmByName( "RGDVNDL_PAYDATE_2", RGDVNDL_PAYDATE_2);
      end;
      /*цена единицы базового актива*/
      if ( RGDVNDL_PRICE != null)
        RG.SetParmByName( "RGDVNDL_PRICE", RGDVNDL_PRICE);
      end;
      /*цена единицы базового актива*/
      if ( RGDVNDL_PRICE_2 != null)
        RG.SetParmByName( "RGDVNDL_PRICE_2", RGDVNDL_PRICE_2);
      end;
    end;
    /*сохранение "Внебиржевая сделка с ПИ"*/
    ErrMes = "";
    if (GetCorrectDate(obj.item.tradeHeader.partyTradeInformation.executionDateTime) >= CurImpDate_)
        if( RG.Save() != true )
            if( RG.GetLastError() )
                 ErrMes = RG.GetLastError();
            end;
            RGLog.Message("Ошибка при загрузке сделки \"" + RGDVNDL_EXTCODE + "\"\n" + ErrMes, RG);
        else
            RGLog.Message("Успешно загружена сделка \"" + RGDVNDL_EXTCODE + "\"", RG, SUCCESS);
            Cound_RG_Saved = Cound_RG_Saved + 1;
        end;
        Cound_RG_Total = Cound_RG_Total + 1;
    else
      if (RelPartyRefName != NULL)
         var dealCode = GetDateStr(GetCorrectDate(obj.item.tradeHeader.partyTradeInformation.executionDateTime))+RGDVNDL_EXTCODE, dealID = -1, clientId, dealDate, dealExtCode;
         RG_GetIDForDealcode(dealCode, @dealId, @clientId, @dealDate, @dealExtCode);
         if (dealID > 0)
            if( addNoteForObject( OBJTYPE_OUTOPER_DV,
                           L_Z(dealID, 34 ),
                           14,
                           RelPartyRefName,
                           dealDate ) )
              RGLog.Message("Ошибка при установке примечания \"Сторона парного договора для формы 701\" для сделки " + dealCode);
            end;
         end;
      end;
    end;

    var i ;
    var tmp;
    /*сохранение "Строка графика платежей процентногоСВОП-а"*/
    if( RGDVNDL_KIND == ПроцентныйСВОП )
      i = 0;
      
      var principalExchange :object;
      var isfloatRate :bool;
      while ( i < obj.item.SWAP.swapStreams.size )
          var swapObj = obj.item.SWAP.swapStreams[i];
          var j = 0;
          while ( j < swapObj.cashflows.paymentCalculationPeriods.size )
              var paym_obj = swapObj.cashflows.paymentCalculationPeriods[j];
              isfloatRate = (paym_obj.calculationPeriod.floatingRateDefinition.calculatedRate != null);
              var PaymCode = RGDVNDL_EXTCODE + "_" + paym_obj.id + IIF(isfloatRate, "_" + string(Mobj.header.clearingDate), "");

              if(RG_CheckExistGtObject(RG_PMGR_PRCNTSWAP, GT_SPFI, PaymCode))
                 RGLog.Message( "Строка графика платежа \""+string(paym_obj.id)+"\" по сделке \"" + RGDVNDL_EXTCODE +"\" уже загружена в шлюз\n" );
                 j = j + 1;
                 continue;
              end; 
              var RG_PM_GR = TGTRecord(ВставкаЧерезКеш, 
                                       SeanceID, 
                                       NULL,
                                       RG_PMGR_PRCNTSWAP, 
                                       String("Строка графика платежей процентного свопа № " + RGDVNDL_EXTCODE+" за "+string(paym_obj.adjustedPaymentDate)+IIF(isfloatRate, " по состоянию на "+string(Mobj.header.clearingDate),"")),
                                       Создать );
              if(NOT RG_PM_GR.InitByCode(RG_PMGR_PRCNTSWAP, PaymCode, SRC_CODE) )
                Exit();
              end;

              var RGPMGR_SIDE = IIF(swapObj.PayerPartyReference != "NCCB", "О", "Т");
              RG_PM_GR.SetParmByName("RGPMGR_SIDE", RGPMGR_SIDE);

              RG_PM_GR.SetParmByName("RGPMGR_PRODUCT_TYPE", obj.item.swap.productType);
              /*внешний код сделки*/
              RG_PM_GR.SetParmByName("RGPMGR_EXTCODE_DEAL", RGDVNDL_EXTCODE);

              RG_PM_GR.SetParmByName("RGPMGR_PAYMENTSUM", paym_obj.forecastPaymentAmount.amount);

              /*Дата нач. начисления*/
              RG_PM_GR.SetParmByName("RGPMGR_BEGDATE", paym_obj.calculationPeriod.adjustedStartDate);
              /*Дата окончания начисления*/
              RG_PM_GR.SetParmByName("RGPMGR_ENDDATE", paym_obj.calculationPeriod.adjustedEndDate);
              /*Дата платежа*/              
              RG_PM_GR.SetParmByName("RGPMGR_PAYDATE", paym_obj.adjustedPaymentDate);             
              /*Дата импорта*/              
              RG_PM_GR.SetParmByName("RGPMGR_IMPORTDATE", Mobj.header.clearingDate);               
              
              /*Если задана плавающая ставка*/
              if( paym_obj.calculationPeriod.floatingRateDefinition.calculatedRate != null )                
                RG_PM_GR.SetParmByName("RGPMGR_FLOATRATEVALUE", paym_obj.calculationPeriod.floatingRateDefinition.calculatedRate * 100);
              end;
              if( paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate != null )                     
                 RG_PM_GR.SetParmByName("RGPMGR_FIXDATE", paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate );
              else
                 RG_PM_GR.SetParmByName("RGPMGR_FIXDATE", date(0,0,0) );
              end; 

              /*с заполнением даты переноса RGPMGR_TRANSFERDATE по ТЗ пока непонятно!!!*/
              
              tmp = RG_PM_GR;
              
              ErrMes = "";
              if (paym_obj.adjustedPaymentDate >= CurImpDate_)
                  if( tmp.Save() != true )
                      if(tmp.GetLastError())
                         ErrMes = tmp.GetLastError();
                      end;
                      RGLog.Error("Ошибка при загрузке строки графика платежей "+string(paym_obj.id)+" по сделке \"" + RGDVNDL_EXTCODE + "\"\n" + ErrMes, RG);
                 else
                      RGLog.Message("Успешно загружена строка графика платежей "+string(paym_obj.id)+" по сделке \"" + RGDVNDL_EXTCODE + "\"", tmp, SUCCESS);
                      Cound_RG_PM_GR_Saved = Cound_RG_PM_GR_Saved + 1;
                 end;
                Cound_RG_PM_GR_Total = Cound_RG_PM_GR_Total + 1;
              end;
              //Для платежей с плавающей ставкой создаём операцию фиксинга  
              if( (paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate != null) AND 
                  (paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate <= CurImpDate_) AND
                  (paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate <=  paym_obj.adjustedPaymentDate)  )
                var FixCode = "FIX_" + RGDVNDL_EXTCODE + "_" + paym_obj.id;
                if(RG_CheckExistGtObject(RG_FIXPMGR_PRCNTSWAP, GT_SPFI, FixCode))
                   RGLog.Message( "Операция фиксинга платежа \""+string(paym_obj.id)+"\" уже загружена в шлюз\n" );
                   j = j + 1;
                   continue;
                end;  
                var RG_FIXPM_GR = TGTRecord(ВставкаЧерезКеш, 
                                            SeanceID, 
                                            NULL,
                                            RG_FIXPMGR_PRCNTSWAP, 
                                            String("Операция фиксинга платежей процентного свопа № " + RGDVNDL_EXTCODE+" за "+string(paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate)),
                                            Создать );
                if(NOT RG_FIXPM_GR.InitByCode(RG_FIXPMGR_PRCNTSWAP, FixCode, SRC_CODE) )
                  Exit();
                end;
                /*внешний код сделки*/
                RG_FIXPM_GR.SetParmByName("RGFIXPMGR_EXTCODE_DEAL", RGDVNDL_EXTCODE);
                /*дата операции*/
                RG_FIXPM_GR.SetParmByName("RGFIXPMGR_FIXDATE", paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.adjustedFixingDate );
                /*сторона платежа*/
                RG_FIXPM_GR.SetParmByName("RGFIXPMGR_SIDE", RGPMGR_SIDE);
                /*значение ставки float, %*/
                RG_FIXPM_GR.SetParmByName("RGFIXPMGR_FLOATRATEVALUE", paym_obj.calculationPeriod.floatingRateDefinition.rateObservation.observedRate * 100 );
                /*сумма платежа*/
                RG_FIXPM_GR.SetParmByName("RGFIXPMGR_PAYMENTSUM", paym_obj.forecastPaymentAmount.amount);
                /*валюта платежа*/
                RG_FIXPM_GR.SetParmByName("RGFIXPMGR_PAYMENTCURRENCY", paym_obj.forecastPaymentAmount.currency);            
        
                tmp = RG_FIXPM_GR;
                
                ErrMes = "";
                if( tmp.Save() != true )
                  if(tmp.GetLastError())
                    ErrMes = tmp.GetLastError();
                  end;
                  RGLog.Error("Ошибка при загрузке операции фиксинга платежа "+string(paym_obj.id)+" по сделке \"" + RGDVNDL_EXTCODE + "\"\n" + ErrMes, RG);
                else
                  RGLog.Message("Успешно загружена операция фиксинга платежа "+string(paym_obj.id)+" по сделке \"" + RGDVNDL_EXTCODE + "\"", tmp, SUCCESS);
                  Cound_RG_FIXPM_GR_Saved = Cound_RG_FIXPM_GR_Saved + 1;
                end;
                Cound_RG_FIXPM_GR_Total = Cound_RG_FIXPM_GR_Total + 1;
              end;
              j = j + 1;
          end;      
          
          i = i + 1;
      end;
    end;
    
    /*загрузка ВМ, ДМ, %% на ВМ*/
    if( (RGDVNDL_KIND == ПроцентныйСВОП)  or (RGDVNDL_KIND == ВнебиржФорвард) or (RGDVNDL_KIND == ВалютныйСВОП) )
      i = 0;
      while ( i < obj.item.moexSpfiExt.npv.npvPoints.size )
          var npvPointObj = obj.item.moexSpfiExt.npv.npvPoints[i];
            j = 0;
            while (j < npvPointObj.npvPayments.size)              
              // npvPointObj.npvPayments[j] - это npvPayment     

              var RG_npvPoint = NULL;

              if( (npvPointObj.npvPayments[j].paymentType == "RTN_DM") or (npvPointObj.npvPayments[j].paymentType == "SCFDM") or (npvPointObj.npvPayments[j].paymentType == "SCFVM") or (npvPointObj.npvPayments[j].paymentType == "PRC_NM") )
                 RG_npvPoint = TGTRecord(ВставкаЧерезКеш, 
                            SeanceID, 
                            NULL,
                            RG_KINDOBJ_DVNDEALCALC, 
                            String("Расчеты по ПФИ для внебирж. сделки № " + RGDVNDL_EXTCODE + "_" +npvPointObj.npvPayments[j].paymentType + "_" + string(npvPointObj.npvDate)),
                            Создать );
                 if(NOT RG_npvPoint.InitByCode(RG_KINDOBJ_DVNDEALCALC, RGDVNDL_EXTCODE + "_" + npvPointObj.npvPayments[j].id +"_" +npvPointObj.npvPayments[j].paymentType, SRC_CODE) )
                   Exit();
                 end;
                 
                 if(( npvPointObj.npvPayments[j].paymentType == "SCFDM" ) OR (npvPointObj.npvPayments[j].paymentType == "RTN_DM"))
                    RGDVNDL_PAYKIND = DV_CALCOP_PAYKIND_GUARANT_MARGIN;
                 elif( npvPointObj.npvPayments[j].paymentType == "PRC_NM" )
                    RGDVNDL_PAYKIND = DV_CALCOP_PAYKIND_MARGIN_INTEREST;
                 elif( npvPointObj.npvPayments[j].paymentType == "NDF0" )
                    RGDVNDL_PAYKIND = DV_CALCOP_PAYKIND_EXECUTION;
                 else
                    RGDVNDL_PAYKIND = DV_CALCOP_PAYKIND_MARGIN;
                 end;

                 RG_npvPoint.SetParmByName("RGDVNDL_KIND",    RGDVNDL_KIND);
                 RG_npvPoint.SetParmByName("RGDVNDL_EXTCODE", RGDVNDL_EXTCODE);
                 RG_npvPoint.SetParmByName("RGDVNDL_DATE",    npvPointObj.npvDate);

                 if( npvPointObj.NPVPAYMENTS[j].payerPartyReference == "NCCB" )
                    RG_npvPoint.SetParmByName("RGDVNDL_MARGIN",  npvPointObj.NPVPAYMENTS[j].PAYMENTAMOUNT.amount);
                 else
                    RG_npvPoint.SetParmByName("RGDVNDL_MARGIN",  -npvPointObj.NPVPAYMENTS[j].PAYMENTAMOUNT.amount);
                 end;
                 
                 RG_npvPoint.SetParmByName("RGDVNDL_CURRENCY", npvPointObj.NPVPAYMENTS[j].PAYMENTAMOUNT.currency);

                 RG_npvPoint.SetParmByName("RGDVNDL_PAYKIND", RGDVNDL_PAYKIND);

                 tmp = RG_npvPoint;
                 ErrMes = "";
                 if (npvPointObj.npvDate == CurImpDate_)
                     if( tmp.Save() != true )
                         if(tmp.GetLastError())
                            ErrMes = tmp.GetLastError();
                         end;
                         RGLog.Error("Ошибка при загрузке расчетов вида \""+npvPointObj.npvPayments[j].paymentType+"\" за дату "+string(npvPointObj.npvDate)+" по сделке \"" + RGDVNDL_EXTCODE + "\"\n" + ErrMes, RG);
                     else
                         RGLog.Message("Успешно загружены расчеты вида \""+npvPointObj.npvPayments[j].paymentType+"\" за дату "+string(npvPointObj.npvDate)+" по сделке \"" + RGDVNDL_EXTCODE + "\"", tmp, SUCCESS);
                         Cound_RG_npvPoint_Saved = Cound_RG_npvPoint_Saved + 1;
                     end;
                     Cound_RG_npvPoint_Total = Cound_RG_npvPoint_Total + 1;
                 end;
              end;
              j = j+1;  
            end;
            i = i + 1;
        end;
    end;

    if(RGDVNDL_SECTOR == UNSET_CHAR)
      i = 0;
      while ( i < obj.item.moexSpfiExt.npv.npvPoints.size )
        var npvPointFairValObj = obj.item.moexSpfiExt.npv.npvPoints[i];
        var RG_npvPointFairVal = NULL;
        RG_npvPointFairVal = TGTRecord(ВставкаЧерезКеш, 
                            SeanceID, 
                            NULL,
                            RG_DVFAIRVAL,
                            String("Справедливая стоимость для внебирж. сделки № " + RGDVNDL_EXTCODE + "_" + "_" + string(npvPointFairValObj.npvDate)),
                            Создать );
        if(NOT RG_npvPointFairVal.InitByCode(RG_DVFAIRVAL, RGDVNDL_EXTCODE + "_" + string(npvPointFairValObj.npvDate), SRC_CODE) )
          Exit();
        end;

        RG_npvPointFairVal.SetParmByName("RGDVNDL_KIND",    RGDVNDL_KIND);
        RG_npvPointFairVal.SetParmByName("RGDVNDL_EXTCODE", RGDVNDL_EXTCODE);
        RG_npvPointFairVal.SetParmByName("RGDVNDL_FAIRVAL_DATE", npvPointFairValObj.npvDate);
        RG_npvPointFairVal.SetParmByName("RGDVNDL_FAIRVAL_CURR", npvPointFairValObj.NPVVALUE.npvCurrency);
        RG_npvPointFairVal.SetParmByName("RGDVNDL_FAIRVAL_AMOUNT", npvPointFairValObj.NPVVALUE.npvAmount);

        tmp = RG_npvPointFairVal;
        ErrMes = "";
        if (npvPointFairValObj.npvDate == CurImpDate_)
            if( tmp.Save() != true )
                if(tmp.GetLastError())
                   ErrMes = tmp.GetLastError();
                end;
                RGLog.Message("Ошибка при загрузке справедливой стоимости за дату "+ string(npvPointFairValObj.npvDate)+" по сделке \"" + RGDVNDL_EXTCODE + "\"\n" + ErrMes, RG);
            else
                RGLog.Message("Успешно загружена справедливая стоимость за дату "+string(npvPointFairValObj.npvDate)+" по сделке \"" + RGDVNDL_EXTCODE + "\"", tmp, SUCCESS);
                Cound_RG_FairVal_Saved = Cound_RG_FairVal_Saved + 1;
            end;
        Cound_RG_FairVal_Total = Cound_RG_FairVal_Total + 1;
        end;
        i = i + 1;
      end;
    end;

    if (RGDVNDL_KIND == ВнебиржФорвард)
      var k_ndf = 0;
      if( obj.item.otherPartyPayments.size() > 0 )
        while( obj.item.otherPartyPayments.size() > k_ndf )
            if( obj.item.otherPartyPayments[k_ndf].paymentType == "NDF0" )
              RG_npvPoint = TGTRecord(ВставкаЧерезКеш, 
                            SeanceID, 
                            NULL,
                            RG_KINDOBJ_DVNDEALCALC, 
                            String("Расчеты по ПФИ для внебирж. сделки № " + RGDVNDL_EXTCODE + 
                                   "_" + obj.item.otherPartyPayments[k_ndf].paymentType + 
                                   "_" + string(obj.item.otherPartyPayments[k_ndf].paymentDate.adjustedDate)),
                            Создать );
              if(NOT RG_npvPoint.InitByCode(RG_KINDOBJ_DVNDEALCALC, RGDVNDL_EXTCODE + "_" + obj.item.otherPartyPayments[k_ndf].id +"_" +obj.item.otherPartyPayments[k_ndf].paymentType, SRC_CODE) )
                Exit();
              end;
                 
              RGDVNDL_PAYKIND = DV_CALCOP_PAYKIND_MARGIN;

              RG_npvPoint.SetParmByName("RGDVNDL_KIND",    RGDVNDL_KIND);
              RG_npvPoint.SetParmByName("RGDVNDL_EXTCODE", RGDVNDL_EXTCODE);
              RG_npvPoint.SetParmByName("RGDVNDL_DATE",    obj.item.otherPartyPayments[k_ndf].paymentDate.adjustedDate);

              if( obj.item.otherPartyPayments[k_ndf].payerPartyReference == "NCCB" )
                RG_npvPoint.SetParmByName("RGDVNDL_MARGIN",  obj.item.otherPartyPayments[k_ndf].paymentAmount.amount);
              else
                RG_npvPoint.SetParmByName("RGDVNDL_MARGIN",  -obj.item.otherPartyPayments[k_ndf].paymentAmount.amount);
              end;
                 
              RG_npvPoint.SetParmByName("RGDVNDL_CURRENCY", obj.item.otherPartyPayments[k_ndf].paymentAmount.currency);

              RG_npvPoint.SetParmByName("RGDVNDL_PAYKIND", RGDVNDL_PAYKIND);

              tmp = RG_npvPoint;
              ErrMes = "";
              if (obj.item.otherPartyPayments[k_ndf].paymentDate.adjustedDate == CurImpDate_)
                if( tmp.Save() != true )
                  if(tmp.GetLastError())
                    ErrMes = tmp.GetLastError();
                  end;
                  RGLog.Error("Ошибка при загрузке расчетов вида \""+obj.item.otherPartyPayments[k_ndf].paymentType+
                              "\" за дату "+string(obj.item.otherPartyPayments[k_ndf].paymentDate.adjustedDate)+" по сделке \"" + RGDVNDL_EXTCODE + "\"\n" + ErrMes, RG);
                else
                  RGLog.Message("Успешно загружены расчеты вида \""+obj.item.otherPartyPayments[k_ndf].paymentType+
                                "\" за дату "+string(obj.item.otherPartyPayments[k_ndf].paymentDate.adjustedDate)+" по сделке \"" + RGDVNDL_EXTCODE + "\"", tmp, SUCCESS);
                  Cound_RG_npvPoint_Saved = Cound_RG_npvPoint_Saved + 1;
                end;
                Cound_RG_npvPoint_Total = Cound_RG_npvPoint_Total + 1;
              end;
            end;
            k_ndf = k_ndf + 1;
        end;
      end;
    end;
    
    b = b + 1;
    UseProgress(b);
  end;

  RemProgress(); 

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано сделок - " + string(Cound_RG_Total) + "\nиз них успешно - " + string(Cound_RG_Saved) + "\nошибочно - " + string(Cound_RG_Total - Cound_RG_Saved));
  RGLog.Message("Всего обработано расчетов по сделкам - " + string(Cound_RG_npvPoint_Total) + "\nиз них успешно - " + string(Cound_RG_npvPoint_Saved) + "\nошибочно - " + string(Cound_RG_npvPoint_Total - Cound_RG_npvPoint_Saved));
  RGLog.Message("Всего обработано строк графика платежей по %% свопам - " + string(Cound_RG_PM_GR_Total) + "\nиз них успешно - " + string(Cound_RG_PM_GR_Saved) + "\nошибочно - " + string(Cound_RG_PM_GR_Total - Cound_RG_PM_GR_Saved));
  RGLog.Message("Всего обработано операций фиксинга по %% свопам - " + string(Cound_RG_FIXPM_GR_Total) + "\nиз них успешно - " + string(Cound_RG_FIXPM_GR_Saved) + "\nошибочно - " + string(Cound_RG_FIXPM_GR_Total - Cound_RG_FIXPM_GR_Saved));
  RGLog.Message("Всего обработано справедливой стоимости по сделкам - " + string(Cound_RG_FairVal_Total) + "\nиз них успешно - " + string(Cound_RG_FairVal_Saved) + "\nошибочно - " + string(Cound_RG_FairVal_Total - Cound_RG_FairVal_Saved));

OnError(ErObj)
  RemProgress();
  if( ErObj.Code == CtrlBrkErr )
    FlagCtrlBrk = true;
    AbortTRN;
  else
    /*if(FlagAbortTRN == false)*/
      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
    /*end;*/
  end;
  
end;

private macro import_itog_SPFI_to_gate(datafilename):integer
  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var tmp_Node:object;
  var Main_Node :object, child_of_moexSpfiReport :object, child_fpml :object, FPML_Node :object, TRADE_Node :object;
  var moexSpfiReport_Node :object, HEADER_Node :object;
  var PARTYTRADEIDENTIFIER_Node :object;
  var TRADEHEADER_Node :object;
  var PARTYTRADEINFORMATION_Node :object;
  var RELATEDPARTY_Node :object;
  var SWAP_Node :object;
  var PARTYREFERENCE_Node :object;
  var ACCOUNTREFERENCE_Node :object;
  var SWAPSTREAM_Node :object;
  var CALCULATIONPERIODDATES_Node :object;
  var EFFECTIVEDATE_Node :object;
  var TERMINATIONDATE_Node :object;
  var CALCULATIONPERIODDATESADJUSTMENTS_Node :object;
  var PAYMENTDATES_Node :object;
  var PAYMENTDATESADJUSTMENTS_Node :object;
  var RESETDATES_Node :object;
  var FIXINGDATES_Node :object;
  var CALCULATIONPERIODAMOUNT_Node :object;
  var CALCULATION_Node :object;
  var BUSINESSCENTERS_Node :object;
  var CASHFLOWS_Node :object;
  var PAYMENTCALCULATIONPERIOD_Node :object;
  var CALCULATIONPERIOD_Node :object;
  var FXSINGLELEG_Node :object;
  var EXCHANGEDCURRENCY1_Node :object;
  var EXCHANGEDCURRENCY2_Node :object;
  var EXCHANGERATE_Node :object;
  var NONDELIVERABLESETTLEMENT_Node :object;
  var FIXING_Node :object;
  var PAYMENTDATE_Node :object;
  var BULLETPAYMENT_Node :object;
  var PRINCIPALEXCHANGE_Node :object;
  var MOEXSPFIEXT_Node :object;
  var TRADEINFO_Node :object;
  var NPV_Node :object;
  var NPVPOINT_Node :object;
  var OTHERPARTYPAYMENT_Node :object;
  var NPVPAYMENT_Node :object;
  var FXSWAP_Node :object;
  var NEARLEG_Node :object;
  var FARLEG_Node :object;
  var PARTY_Node :object;
  
  var ProgressIndex:integer;  
  var a,b,c,d,e,f,g,h,i:integer,prefix;
  private var moexSpfiReport_obj = moexSpfiReport(); 
  
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
  end;
  /*заполним массивы данных из файла*/

  
  /*
0. счётчики a..z - индексы текущей дочерней вершины в списке детей в порядке глубины (а - верхний, z- самый нижний)
   общая "маска" и ход парсера (нисходящее заполнение):
1. Пусть есть какой то текущий дочерний элемент   
2. _ИМЯ_НОДЫ = _ИМЯ_РОДИТЕЛЯ НОДЫ.childNodes.item(_индекс_);
3. блок чтения аттрибутов:
   macro ReadTagAttribut(node:object, name:string, DataType:integer, retval)
4. блок чтения значений дочерних элементов (ТОЛЬКО ДЛЯ КОНЕЧНЫХ. ЗАРАНЕЕ ИЗВЕСТНЫ)
   ReadTagChild
5. создание нового индекса    
    _новый_индекс = 0;
6. просмотр всех дочерних элементов    
    while ( _новый_индекс < _ИМЯ_НОДЫ.childNodes.length)
6.1 запоминание, если необходимо, предшествующему вершине комментария    
      if ( ( _ИМЯ_НОДЫ.childNodes.item(_новый_индекс) ) and ( _ИМЯ_НОДЫ.childNodes.item(_новый_индекс).nodeType == COMMENT_NODE ) )
        Предыдущий_комментарий = _новый_индекс.childNodes.item(_новый_индекс).text;
      end;
6.2 проверка tag-а блока на ожидаемый и запуск анализа "вглубь"      
      if ( ( _ИМЯ_НОДЫ.childNodes.item(_новый_индекс) ) and ( _ИМЯ_НОДЫ.childNodes.item(_новый_индекс).nodeType == CHILD_NODE ) )
        if (StrUpr(_ИМЯ_НОДЫ.childNodes.item(_новый_индекс).tagname) == "ОЖИДАЕМЫЙ_БЛОК")
          запуск_того парсера для дочерней вершины
        end;
      end;
  *
  *
  
  */
  
  
/*блок чтения аттрибутов*/
/*блок чтения значений*/          
/*просмотр всех дочерних элементов*/    
/*пустой*/
  
  Main_Node = xml.DocumentElement;
  if ( (Main_Node) and (StrUpr(Main_Node.tagname) == "MOEXSPFIREPORT") )
  
    moexSpfiReport_Node = Main_Node;
    a = 0;
    while (a < moexSpfiReport_Node.childNodes.length )
      if ( (moexSpfiReport_Node.childNodes.item(a)) and (moexSpfiReport_Node.childNodes.item(a).nodeType == CHILD_NODE) )
        if   (StrUpr(moexSpfiReport_Node.childNodes.item(a).tagname) == "HEADER")
          /*<header> */
          HEADER_Node = moexSpfiReport_Node.childNodes.item(a);
          /*блок чтения аттрибутов*/
          /*пустой*/
          /*блок чтения значений*/          
          ReadTagChild(HEADER_Node, "MESSAGEID", V_INTEGER, moexSpfiReport_obj.HEADER.messageID);
          ReadTagChild(HEADER_Node, "SENTBY", V_STRING, moexSpfiReport_obj.HEADER.sentBy);
          ReadTagChild(HEADER_Node, "SENDTO", V_STRING, moexSpfiReport_obj.HEADER.sendTo);
          ReadTagChild(HEADER_Node, "CLEARINGDATE", V_DATE, moexSpfiReport_obj.HEADER.clearingDate);
          ReadTagChild(HEADER_Node, "CREATIONTIMESTAMP", V_DTTM, moexSpfiReport_obj.HEADER.creationTimestamp);          
          /*просмотр всех дочерних элементов*/
          /*пустой*/
          
        elif ((StrUpr(moexSpfiReport_Node.childNodes.item(a).tagname) == "FPML") or (StrUpr(moexSpfiReport_Node.childNodes.item(a).tagname) == "MS:FPML"))
          /*<fpml>*/
          
          FPML_Node = moexSpfiReport_Node.childNodes.item(a);
          InitProgress(FPML_Node.childNodes.length, "Просмотр внешнего файла итогов торгов на рынке СПФИ", "Просмотр итогов...");
          /*блок чтения аттрибутов*/
          /*пустой*/
          /*блок чтения значений*/          
          /*пустой*/
          /*просмотр всех дочерних элементов*/
          b = 0;
          while ( b < FPML_Node.childNodes.length )
            if ( (FPML_Node.childNodes.item(b)) and (FPML_Node.childNodes.item(b).nodeType == CHILD_NODE) )              
              if ((StrUpr(FPML_Node.childNodes.item(b).tagname) == "TRADE") or (StrUpr(FPML_Node.childNodes.item(b).tagname) == "MS:TRADE"))
                  
                /*<trade>*/
                TRADE_Node = FPML_Node.childNodes.item(b);
                /*блок чтения аттрибутов*/
                ReadTagAttribut(TRADE_Node, "ID", V_STRING, moexSpfiReport_obj.FPML.TRADE.TradeID);
                /*блок чтения значений*/          
                /*пустой*/
                /*просмотр всех дочерних элементов*/                
                c = 0;
                while ( c < TRADE_Node.childNodes.length )
                  if ( (TRADE_Node.childNodes.item(c)) and (TRADE_Node.childNodes.item(c).nodeType == CHILD_NODE) )
                    /*блок <tradeHeader>*/   
/*<tradeHeader>*/   if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "TRADEHEADER")
                                         
                      TRADEHEADER_Node = TRADE_Node.childNodes.item(c);
                      /*блок чтения аттрибутов*/
                      /*пустой*/
                      /*блок чтения значений*/                          
                      ReadTagChild(TRADEHEADER_Node, "TRADEDATE",   V_DATE, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.tradeDate);
                      ReadTagChild(TRADEHEADER_Node, "CLEAREDDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.clearedDate);
                      /*просмотр всех дочерних элементов*/                
                      d = 0;
                      /*в блоке <tradeHeader> два одинаковых PARTYTRADEIDENTIFIER. различаем их по предшествующему комментарию*/
                      var Контрагент_участник_клиринга_str = " Контрагент (участник клиринга) ";
                      var Контрагент_НКЦ_str = " Контрагент (НКЦ) ";
                      var Предыдущий_комментарий :string = "";
                      while ( d < TRADEHEADER_Node.childNodes.length )
                        /*блок запоминания комментария*/
                        if ( ( TRADEHEADER_Node.childNodes.item(d) ) and ( TRADEHEADER_Node.childNodes.item(d).nodeType == COMMENT_NODE ) )
                           Предыдущий_комментарий = TRADEHEADER_Node.childNodes.item(d).text;
                        end;
                        
                        if ( ( TRADEHEADER_Node.childNodes.item(d) ) and ( TRADEHEADER_Node.childNodes.item(d).nodeType == CHILD_NODE ) )
                          /*<partyTradeIdentifier>*/
                          if   (StrUpr(TRADEHEADER_Node.childNodes.item(d).tagname) == "PARTYTRADEIDENTIFIER")
                            PARTYTRADEIDENTIFIER_Node = TRADEHEADER_Node.childNodes.item(d);                            
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/          
                            /*if   ( Предыдущий_комментарий == Контрагент_участник_клиринга_str )
                              ReadTagChild(PARTYTRADEIDENTIFIER_Node, "TRADEID", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEIDENTIFIER_CLEARINGMAN.tradeId);
                            elif ( Предыдущий_комментарий == Контрагент_НКЦ_str )
                              ReadTagChild(PARTYTRADEIDENTIFIER_Node, "TRADEID", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEIDENTIFIER_CLEARINGCENTER.tradeId);
                            end;*/
                            /*просмотр всех дочерних элементов*/     
                            e = 0;
                            while ( e < PARTYTRADEIDENTIFIER_Node.childNodes.length )
                              if ( ( PARTYTRADEIDENTIFIER_Node.childNodes.item(e) ) and ( PARTYTRADEIDENTIFIER_Node.childNodes.item(e).nodeType == CHILD_NODE ) )
                                /*<partyReference>*/
                                if   (StrUpr(PARTYTRADEIDENTIFIER_Node.childNodes.item(e).tagname) == "PARTYREFERENCE")                                  
                                  PARTYREFERENCE_Node = PARTYTRADEIDENTIFIER_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  if   ( Предыдущий_комментарий == Контрагент_участник_клиринга_str )
                                    ReadTagAttribut(PARTYREFERENCE_Node, "HREF",   V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEIDENTIFIER_CLEARINGMAN.partyReference);
                                  elif ( Предыдущий_комментарий == Контрагент_НКЦ_str )
                                    ReadTagAttribut(PARTYREFERENCE_Node, "HREF",   V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEIDENTIFIER_CLEARINGCENTER.partyReference);
                                  end;                                  
                                  /*блок чтения значений*/          
                                  /*пустой*/
                                  /*просмотр всех дочерних элементов*/   
                                  /*пустой*/
                                /*<accountReference>*/
                                elif (StrUpr(PARTYTRADEIDENTIFIER_Node.childNodes.item(e).tagname) == "ACCOUNTREFERENCE")
                                  ACCOUNTREFERENCE_Node = PARTYTRADEIDENTIFIER_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  ReadTagAttribut(ACCOUNTREFERENCE_Node, "HREF", V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEIDENTIFIER_CLEARINGMAN.accountReference);
                                  /*блок чтения значений*/          
                                  /*пустой*/
                                  /*просмотр всех дочерних элементов*/   
                                  /*пустой*/
                                end;
                              end;
                              e = e + 1;
                            end;
                          /*блок <partyTradeInformation>*/
                          elif (StrUpr(TRADEHEADER_Node.childNodes.item(d).tagname) == "PARTYTRADEINFORMATION")                           
                            PARTYTRADEINFORMATION_Node = TRADEHEADER_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/          
                            ReadTagChild(PARTYTRADEINFORMATION_Node, "CATEGORY",   V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEINFORMATION.category);
                            ReadTagChild(PARTYTRADEINFORMATION_Node, "TRADER",   V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEINFORMATION.trader);
                            ReadTagChild(PARTYTRADEINFORMATION_Node, "EXECUTIONDATETIME",   V_DTTM, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEINFORMATION.executionDateTime);
                            /*просмотр всех дочерних элементов*/    
                            e = 0;
                            while ( e < PARTYTRADEINFORMATION_Node.childNodes.length )
                              if ( ( PARTYTRADEINFORMATION_Node.childNodes.item(e) ) and ( PARTYTRADEINFORMATION_Node.childNodes.item(e).nodeType == CHILD_NODE ) )
                                if ( StrUpr(PARTYTRADEINFORMATION_Node.childNodes.item(e).tagname) == "PARTYREFERENCE" )
                                  PARTYREFERENCE_Node = PARTYTRADEINFORMATION_Node.childNodes.item(e);
                                  
                                  ReadTagAttribut( PARTYREFERENCE_Node, "HREF", V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEINFORMATION.partyReference );
                                  /*блок чтения значений*/   
                                  /*пустой*/
                                  /*просмотр всех дочерних элементов*/    
                                  /*пустой*/
                                elif ( StrUpr(PARTYTRADEINFORMATION_Node.childNodes.item(e).tagname) == "RELATEDPARTY" )
                                  RELATEDPARTY_Node = PARTYTRADEINFORMATION_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  ReadTagAttributeOfTagChild(RELATEDPARTY_Node, "HREF", "PARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEINFORMATION.RELATEDPARTY.partyReference);
                                  /*пустой*/
                                  /*блок чтения значений*/                                     
                                  ReadTagChild(RELATEDPARTY_Node, "ROLE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.TRADEHEADER.PARTYTRADEINFORMATION.RELATEDPARTY.role);
                                  /*просмотр всех дочерних элементов*/
                                  /*пустой*/
                                end; 
                              end;
                              e = e + 1;
                            end;                                                        
                          end;
                        end;
                        d = d + 1;
                      end;  
                    end;
                    /*блок <SWAP>*/  
/*<SWAP>*/          if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "SWAP")
                      SWAP_Node = TRADE_Node.childNodes.item(c);
                      /*блок чтения аттрибутов*/
                      /*пустой*/
                      /*блок чтения значений*/
                      ReadTagChild(SWAP_Node, "PRODUCTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.productType);
                      
                      /*просмотр всех дочерних элементов*/    
                      d = 0;
                      var leg_swap = 0;//номер ноги свопа
                      while ( d < SWAP_Node.childNodes.length)
                        if ( (SWAP_Node.childNodes.item(d)) and (SWAP_Node.childNodes.item(d).nodeType == CHILD_NODE) )
                          if ( StrUpr(SWAP_Node.childNodes.item(d).tagname) == "SWAPSTREAM")
                            leg_swap = leg_swap + 1;//две ноги свопа
                            SWAPSTREAM_Node = SWAP_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/          
                            /*пустой*/
                            /*просмотр всех дочерних элементов*/    
                            e = 0;
                            while ( e < SWAPSTREAM_Node.childNodes.length)
                              if ( (SWAPSTREAM_Node.childNodes.item(e)) and (SWAPSTREAM_Node.childNodes.item(e).nodeType == CHILD_NODE) )
                                /*<payerPartyReference>*/ /*Плательщик*/
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "PAYERPARTYREFERENCE")
                                  /*блок чтения аттрибутов*/
                                  ReadTagAttribut(SWAPSTREAM_Node.childNodes.item(e), "HREF" , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.payerPartyReference);
                                end;
                                /*<receiverPartyReference>*/ /*Получатель*/
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "RECEIVERPARTYREFERENCE")
                                  ReadTagAttribut(SWAPSTREAM_Node.childNodes.item(e), "HREF" , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.receiverPartyReference);
                                end;
                                /*<receiverAccountReference>*/ 
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "RECEIVERACCOUNTREFERENCE")
                                  ReadTagAttribut(SWAPSTREAM_Node.childNodes.item(e), "HREF" , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.receiverAccountReference);
                                end;
                                /*<calculationPeriodDates>*/ /*Правило расчета процентных периодов */
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "CALCULATIONPERIODDATES")
                                  CALCULATIONPERIODDATES_Node = SWAPSTREAM_Node.childNodes.item(e);                                  
                                  /*блок чтения аттрибутов*/
                                  ReadTagAttribut(CALCULATIONPERIODDATES_Node, "ID" , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.calculationPeriodDates.id);
                                  /*блок чтения значений*/          
                                  /*пустой*/
                                  /*просмотр всех дочерних элементов*/    
                                  f = 0;
                                  while ( f < CALCULATIONPERIODDATES_Node.childNodes.length )
                                    if ( (CALCULATIONPERIODDATES_Node.childNodes.item(f)) and ( CALCULATIONPERIODDATES_Node.childNodes.item(f).nodeType == CHILD_NODE))
                                      /*<effectiveDate>*/
                                      if ( StrUpr(CALCULATIONPERIODDATES_Node.childNodes.item(f).tagname) == "EFFECTIVEDATE") 
                                        EFFECTIVEDATE_Node = CALCULATIONPERIODDATES_Node.childNodes.item(f);
                                        /*блок чтения аттрибутов*/
                                        /*пустой*/
                                        /*блок чтения значений*/
                                        ReadTagChild (EFFECTIVEDATE_Node, "UNADJUSTEDDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.EFFECTIVEDATE.unadjustedDate);
                                        /*просмотр всех дочерних элементов*/    
                                        g = 0;
                                        while ( g < EFFECTIVEDATE_Node.childNodes.length )
                                          if ( (EFFECTIVEDATE_Node.childNodes.item(g)) and (EFFECTIVEDATE_Node.childNodes.item(g).nodeType == CHILD_NODE) )
                                            if (StrUpr( EFFECTIVEDATE_Node.childNodes.item(g).tagname) == "DATEADJUSTMENTS" )
                                              ReadTagChild (EFFECTIVEDATE_Node.childNodes.item(g), "BUSINESSDAYCONVENTION"  , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.EFFECTIVEDATE.DATEADJUSTMENTS.businessDayConvention);
                                            end;
                                          end;
                                          g = g + 1;
                                        end;
                                      end;
                                      /*<terminationDate>*/
                                      if ( StrUpr(CALCULATIONPERIODDATES_Node.childNodes.item(f).tagname) == "TERMINATIONDATE") 
                                        TERMINATIONDATE_Node = CALCULATIONPERIODDATES_Node.childNodes.item(f);
                                        /*блок чтения аттрибутов*/
                                        /*пустой*/
                                        /*блок чтения значений*/  
                                        ReadTagChild (TERMINATIONDATE_Node, "UNADJUSTEDDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.TERMINATIONDATE.unadjustedDate);
                                        /*просмотр всех дочерних элементов*/ 
                                        g = 0;
                                        while ( g < TERMINATIONDATE_Node.childNodes.length )
                                          if ( (TERMINATIONDATE_Node.childNodes.item(g)) and (TERMINATIONDATE_Node.childNodes.item(g).nodeType == CHILD_NODE) )
                                            if (StrUpr( TERMINATIONDATE_Node.childNodes.item(g).tagname) == "DATEADJUSTMENTS" )
                                              ReadTagChild (TERMINATIONDATE_Node.childNodes.item(g), "BUSINESSDAYCONVENTION"  , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.TERMINATIONDATE.DATEADJUSTMENTS.businessDayConvention);
                                            end;
                                          end;
                                          g = g + 1;
                                        end;
                                      end;
                                      /*<calculationPeriodDatesAdjustments>*/
                                      if ( StrUpr(CALCULATIONPERIODDATES_Node.childNodes.item(f).tagname) == "CALCULATIONPERIODDATESADJUSTMENTS") 
                                        CALCULATIONPERIODDATESADJUSTMENTS_Node = CALCULATIONPERIODDATES_Node.childNodes.item(f);
                                        /*блок чтения аттрибутов*/
                                        /*пустой*/
                                        /*блок чтения значений*/  
                                        ReadTagChild (CALCULATIONPERIODDATESADJUSTMENTS_Node, "BUSINESSDAYCONVENTION", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.CALCULATIONPERIODDATESADJUSTMENTS.businessDayConvention);                                                                                 
                                        /*просмотр всех дочерних элементов*/    
                                        g = 0;
                                        while ( g < CALCULATIONPERIODDATESADJUSTMENTS_Node.childNodes.length )
                                          if ( (CALCULATIONPERIODDATESADJUSTMENTS_Node.childNodes.item(g)) and (CALCULATIONPERIODDATESADJUSTMENTS_Node.childNodes.item(g).nodeType == CHILD_NODE ) )
                                            if ( StrUpr(CALCULATIONPERIODDATESADJUSTMENTS_Node.childNodes.item(g).tagname) == "BUSINESSCENTERS") 
                                              BUSINESSCENTERS_Node = CALCULATIONPERIODDATESADJUSTMENTS_Node.childNodes.item(g);
                                              h = 0;
                                              while (h < BUSINESSCENTERS_Node.childNodes.length)
                                                if (h == 0)
                                                  moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.CALCULATIONPERIODDATESADJUSTMENTS.BUSINESSCENTERS.businessCenter_first  = BUSINESSCENTERS_Node.childNodes.item(h).nodeTypedValue;
                                                elif ( h ==1 )
                                                  moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.CALCULATIONPERIODDATESADJUSTMENTS.BUSINESSCENTERS.businessCenter_second = BUSINESSCENTERS_Node.childNodes.item(h).nodeTypedValue;
                                                end;
                                                h = h + 1;
                                              end;
                                            end;
                                          end;
                                          g = g + 1;
                                        end;
                                      end;
                                      /*<calculationPeriodFrequency>*/
                                      if ( StrUpr(CALCULATIONPERIODDATES_Node.childNodes.item(f).tagname) == "CALCULATIONPERIODFREQUENCY") 
                                        tmp_Node = CALCULATIONPERIODDATES_Node.childNodes.item(f);
                                        /*блок чтения аттрибутов*/
                                        /*пустой*/
                                        /*блок чтения значений*/ 
                                        ReadTagChild( tmp_Node, "PERIODMULTIPLIER", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.CALCULATIONPERIODFREQUENCY.periodMultiplier );
                                        ReadTagChild( tmp_Node, "PERIOD", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.CALCULATIONPERIODFREQUENCY.period );
                                        ReadTagChild( tmp_Node, "ROLLCONVENTION", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODDATES.CALCULATIONPERIODFREQUENCY.rollConvention );
                                        
                                        /*просмотр всех дочерних элементов*/   
                                        /*пустой*/
                                      end;
                                    end;
                                    f = f + 1;
                                  end;
                                end;
                                /*<paymentDates>*/ /*Правило расчета дат платежей*/
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "PAYMENTDATES")
                                  PAYMENTDATES_Node = SWAPSTREAM_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  /*пустой*/
                                  /*блок чтения значений*/
                                  /*<payRelativeTo>*/
                                  ReadTagChild(PAYMENTDATES_Node, "PAYRELATIVETO",   V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.payRelativeTo);
                                  /*<calculationPeriodDatesReference>*/
                                  ReadTagAttributeOfTagChild(PAYMENTDATES_Node, "HREF", "CALCULATIONPERIODDATESREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.CALCULATIONPERIODDATESREFERENCE);
                                  /*<paymentFrequency>*/
                                  ReadTagChildOfTagChild(PAYMENTDATES_Node, "PAYMENTFREQUENCY", "PERIODMULTIPLIER", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTFREQUENCY.periodMultiplier);
                                  ReadTagChildOfTagChild(PAYMENTDATES_Node, "PAYMENTFREQUENCY", "PERIOD", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTFREQUENCY.period);
                                  /*<paymentDaysOffset>*/
                                  ReadTagChildOfTagChild(PAYMENTDATES_Node, "PAYMENTDAYSOFFSET", "PERIODMULTIPLIER", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTDAYSOFFSET.periodMultiplier);
                                  ReadTagChildOfTagChild(PAYMENTDATES_Node, "PAYMENTDAYSOFFSET", "PERIOD", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTDAYSOFFSET.period);                                        
                                  ReadTagChildOfTagChild(PAYMENTDATES_Node, "PAYMENTDAYSOFFSET", "DAYTYPE", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTDAYSOFFSET.dayType);
                                  /*просмотр всех дочерних элементов*/    
                                  f = 0;
                                  while ( f < PAYMENTDATES_Node.childNodes.length)
                                    if ( (PAYMENTDATES_Node.childNodes.item(f)) and (PAYMENTDATES_Node.childNodes.item(f).nodeType == CHILD_NODE ) )
                                      /*<paymentDatesAdjustments>*/
                                      if ( StrUpr(PAYMENTDATES_Node.childNodes.item(f).tagname) == "PAYMENTDATESADJUSTMENTS")
                                        PAYMENTDATESADJUSTMENTS_Node = PAYMENTDATES_Node.childNodes.item(f);
                                        /*блок чтения значений*/
                                        ReadTagChild(PAYMENTDATESADJUSTMENTS_Node, "BUSINESSDAYCONVENTION", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTDATESADJUSTMENTS.businessDayConvention);
                                        /*просмотр всех дочерних элементов*/ 
                                        g = 0;
                                        while ( g < PAYMENTDATESADJUSTMENTS_Node.childNodes.length)
                                          if ( (PAYMENTDATESADJUSTMENTS_Node.childNodes.item(g)) and (PAYMENTDATESADJUSTMENTS_Node.childNodes.item(g).nodeType == CHILD_NODE))
                                            /*<businessCenters>*/
                                            if ( StrUpr(PAYMENTDATESADJUSTMENTS_Node.childNodes.item(g).tagname) == "BUSINESSCENTERS" )
                                              BUSINESSCENTERS_Node = PAYMENTDATESADJUSTMENTS_Node.childNodes.item(g);
                                              ReadTagChildEx( BUSINESSCENTERS_Node, "BUSINESSCENTER", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTDATESADJUSTMENTS.businessCenters.businessCenter_first, 0 );
                                              ReadTagChildEx( BUSINESSCENTERS_Node, "BUSINESSCENTER", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.PAYMENTDATES.PAYMENTDATESADJUSTMENTS.businessCenters.businessCenter_second, 1 );
                                            end;
                                          end;
                                          g = g + 1;
                                        end;
                                      end;
                                    end;
                                    f = f + 1;
                                  end;
                                end;
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "RESETDATES")
                                  RESETDATES_Node = SWAPSTREAM_Node.childNodes.item(e);
                                    /*блок чтения аттрибутов*/
                                    ReadTagAttribut(RESETDATES_Node, "ID", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.id);
                                    /*блок чтения значений*/          
                                    ReadTagChild(RESETDATES_Node, "RESETRELATIVETO", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.resetRelativeTo);
                                    /*просмотр всех дочерних элементов*/ 
                                    f = 0;
                                    while (f <  RESETDATES_Node.childNodes.length )
                                      if ( (RESETDATES_Node.childNodes.item(f)) and (RESETDATES_Node.childNodes.item(f).nodeType == CHILD_NODE ))
                                        /*<calculationPeriodDatesReference>*/
                                        if (StrUpr(RESETDATES_Node.childNodes.item(f).tagname) == "CALCULATIONPERIODDATESREFERENCE")
                                          ReadTagAttribut(RESETDATES_Node.childNodes.item(f), "HREF", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.calculationPeriodDatesReference);                                           
                                        end;
                                        /*<fixingDates>*/ /*смещение фиксинга относительно reset date*/
                                        if ( StrUpr(RESETDATES_Node.childNodes.item(f).tagname) == "FIXINGDATES")
                                          FIXINGDATES_Node = RESETDATES_Node.childNodes.item(f);                                          
                                          ReadTagChild( FIXINGDATES_Node, "PERIODMULTIPLIER", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.FIXINGDATES.periodMultiplier );
                                          ReadTagChild( FIXINGDATES_Node, "PERIOD", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.FIXINGDATES.period );
                                          ReadTagChild( FIXINGDATES_Node, "BUSINESSDAYCONVENTION", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.FIXINGDATES.businessDayConvention );
                                          ReadTagAttributeOfTagChild(FIXINGDATES_Node, "DATERELATIVETO", "HREF", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.FIXINGDATES.dateRelativeTo);
                                        end;
                                        /*<resetFrequency>*/ /*Периодичность определения ставки*/
                                        if ( StrUpr(RESETDATES_Node.childNodes.item(f).tagname) == "RESETFREQUENCY")
                                          ReadTagChild( FIXINGDATES_Node, "PERIODMULTIPLIER", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.RESETFREQUENCY.periodMultiplier );
                                          ReadTagChild( FIXINGDATES_Node, "PERIOD", V_INTEGER, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.RESETFREQUENCY.period );
                                        end;
                                        /*<resetDatesAdjustments>*/ /*Правило переноса даты. если она приходится на выходной день*/
                                        if ( StrUpr(RESETDATES_Node.childNodes.item(f).tagname) == "RESETDATESADJUSTMENTS")
                                          tmp_Node = RESETDATES_Node.childNodes.item(f);
                                          ReadTagChild(tmp_Node, "BUSINESSDAYCONVENTION", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.RESETDATESADJUSTMENTS.businessDayConvention);
                                          ReadTagChildOfTagChild(tmp_Node, "BUSINESSCENTERS", "BUSINESSCENTER", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.RESETDATES.RESETDATESADJUSTMENTS.businessCenters.businessCenter);
                                        end;
                                      end;
                                      f = f + 1;
                                    end;
                                end;
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "CALCULATIONPERIODAMOUNT")
                                  CALCULATIONPERIODAMOUNT_Node = SWAPSTREAM_Node.childNodes.item(e);
                                  f = 0;
                                  while ( f < CALCULATIONPERIODAMOUNT_Node.childNodes.length)
                                    if ( (CALCULATIONPERIODAMOUNT_Node.childNodes.item(f)) and (CALCULATIONPERIODAMOUNT_Node.childNodes.item(f).nodeType == CHILD_NODE))
                                      /*<calculation>*/
                                      if ( StrUpr(CALCULATIONPERIODAMOUNT_Node.childNodes.item(f).tagname) == "CALCULATION")
                                       CALCULATION_Node = CALCULATIONPERIODAMOUNT_Node.childNodes.item(f);
                                       /*блок чтения аттрибутов*/
                                       /*пустой*/
                                       /*блок чтения значений*/          
                                       ReadTagChild(CALCULATION_Node, "DAYCOUNTFRACTION" , V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODAMOUNT.CALCULATION.dayCountFraction);
                                       /*просмотр всех дочерних элементов*/
                                       g = 0;
                                       while ( g < CALCULATION_Node.childNodes.length)
                                        if ( (CALCULATION_Node.childNodes.item(g)) and (CALCULATION_Node.childNodes.item(g).nodeType == CHILD_NODE ))
                                          if ( StrUpr(CALCULATION_Node.childNodes.item(g).tagname) == "NOTIONALSCHEDULE")
                                            ReadTagChildOfTagChild ( CALCULATION_Node.childNodes.item(g), "NOTIONALSTEPSCHEDULE", "INITIALVALUE", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODAMOUNT.CALCULATION.NOTIONALSCHEDULE.NOTIONALSTEPSCHEDULE.initialValue );
                                            ReadTagChildOfTagChild ( CALCULATION_Node.childNodes.item(g), "NOTIONALSTEPSCHEDULE", "CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODAMOUNT.CALCULATION.NOTIONALSCHEDULE.NOTIONALSTEPSCHEDULE.currency );
                                          end;
                                          /*<fixedRateSchedule> - фикс ставка*/
                                          if ( StrUpr(CALCULATION_Node.childNodes.item(g).tagname) == "FIXEDRATESCHEDULE")
                                            ReadTagChild ( CALCULATION_Node.childNodes.item(g), "INITIALVALUE", V_DOUBLE,   moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODAMOUNT.CALCULATION.FIXEDRATESCHEDULE.initialValue );
                                          end;

                                          /*<floatingRateCalculation> - плавающая ставка*/
                                          if ( StrUpr(CALCULATION_Node.childNodes.item(g).tagname) == "FLOATINGRATECALCULATION")
                                            ReadTagChild ( CALCULATION_Node.childNodes.item(g), "FLOATINGRATEINDEX", V_STRING,   moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CALCULATIONPERIODAMOUNT.CALCULATION.FLOATINGRATECALCULATION.FLOATINGRATEINDEX );
                                          end;
                                          
                                        end;
                                        g = g + 1;
                                       end;
                                      end;
                                    end;
                                    f = f + 1;
                                  end;
                                end;
                                if ( StrUpr(SWAPSTREAM_Node.childNodes.item(e).tagname) == "CASHFLOWS")
                                  CASHFLOWS_Node = SWAPSTREAM_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/                                 
                                  /*пустой*/
                                  /*блок чтения значений*/        
                                  ReadTagChild ( CASHFLOWS_Node, "CASHFLOWSMATCHPARAMETERS", V_STRING,   moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.cashflowsMatchParameters );
                                  /*просмотр всех дочерних элементов*/
                                  f = 0;
                                  while ( f < CASHFLOWS_Node.childNodes.length )
                                    if ( (CASHFLOWS_Node.childNodes.item(f)) and (CASHFLOWS_Node.childNodes.item(f).nodeType == CHILD_NODE))                                    
                                      if ( StrUpr(CASHFLOWS_Node.childNodes.item(f).tagname) == "PRINCIPALEXCHANGE" )
                                        PRINCIPALEXCHANGE_Node = CASHFLOWS_Node.childNodes.item(f);
                                        moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGE = NULL;
                                        /*блок чтения аттрибутов*/    
                                        ReadTagAttribut(PRINCIPALEXCHANGE_Node, "ID", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGE.id );                                        
                                        /*блок чтения значений*/
                                        ReadTagChild(PRINCIPALEXCHANGE_Node, "ADJUSTEDPRINCIPALEXCHANGEDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGE.adjustedPrincipalExchangeDate);
                                        ReadTagChild(PRINCIPALEXCHANGE_Node, "PRINCIPALEXCHANGEAMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGE.principalExchangeAmount);
                                        /*просмотр всех дочерних элементов*/
                                        /*пусто*/
                                        var tmp :object;
                                        tmp = null;
                                        tmp = moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGE;
                                        moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGES[moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PRINCIPALEXCHANGES.size] = tmp;
                                      end;
                                      if ( StrUpr(CASHFLOWS_Node.childNodes.item(f).tagname) == "PAYMENTCALCULATIONPERIOD" )
                                        moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD = NULL;
                                        
                                        PAYMENTCALCULATIONPERIOD_Node = CASHFLOWS_Node.childNodes.item(f);
                                        ReadTagAttribut( PAYMENTCALCULATIONPERIOD_Node, "ID", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.ID);
                                        ReadTagChild( PAYMENTCALCULATIONPERIOD_Node, "ADJUSTEDPAYMENTDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.adjustedPaymentDate);
                                        g = 0;
                                        while ( g < PAYMENTCALCULATIONPERIOD_Node.childNodes.length)
                                          if ( (PAYMENTCALCULATIONPERIOD_Node.childNodes.item(g)) and (PAYMENTCALCULATIONPERIOD_Node.childNodes.item(g).nodeType == CHILD_NODE ))
                                            if ( StrUpr(PAYMENTCALCULATIONPERIOD_Node.childNodes.item(g).tagname) == "CALCULATIONPERIOD")
                                               CALCULATIONPERIOD_Node = PAYMENTCALCULATIONPERIOD_Node.childNodes.item(g);
                                               ReadTagChild( CALCULATIONPERIOD_Node, "ADJUSTEDSTARTDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.CALCULATIONPERIOD.adjustedStartDate);
                                               ReadTagChild( CALCULATIONPERIOD_Node, "ADJUSTEDENDDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.CALCULATIONPERIOD.adjustedEndDate);
                                               ReadTagChild( CALCULATIONPERIOD_Node, "NOTIONALAMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.CALCULATIONPERIOD.notionalAmount);
                                               ReadTagChildOfTagChild( CALCULATIONPERIOD_Node, "FLOATINGRATEDEFINITION", "CALCULATEDRATE", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.CALCULATIONPERIOD.FLOATINGRATEDEFINITION.calculatedRate);
                                               ReadTagChildOfTagChildOfTagChild( CALCULATIONPERIOD_Node, "FLOATINGRATEDEFINITION", "RATEOBSERVATION", "ADJUSTEDFIXINGDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.CALCULATIONPERIOD.FLOATINGRATEDEFINITION.RATEOBSERVATION.adjustedFixingDate);
                                               ReadTagChildOfTagChildOfTagChild( CALCULATIONPERIOD_Node, "FLOATINGRATEDEFINITION", "RATEOBSERVATION", "OBSERVEDRATE", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.CALCULATIONPERIOD.FLOATINGRATEDEFINITION.RATEOBSERVATION.observedRate);
                                            end;                         
                                          end;
                                          g = g + 1;
                                        end;
                                        ReadTagChildOfTagChild( PAYMENTCALCULATIONPERIOD_Node, "FORECASTPAYMENTAMOUNT", "CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.FORECASTPAYMENTAMOUNT.currency);                                        
                                        ReadTagChildOfTagChild( PAYMENTCALCULATIONPERIOD_Node, "FORECASTPAYMENTAMOUNT", "AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD.FORECASTPAYMENTAMOUNT.amount);                                        
                                        var tmpobj :object;
                                        tmpobj = null;
                                        tmpobj = moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIOD;
                                        moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIODS[moexSpfiReport_obj.FPML.TRADE.SWAP.SWAPSTREAM.CASHFLOWS.PAYMENTCALCULATIONPERIODS.size] = tmpobj;
                                      end;
                                    end;
                                    f = f + 1;
                                  end;
                                end;
                                
                              end;
                               e = e + 1;
                            end; 
                            moexSpfiReport_obj.FPML.TRADE.SWAP.swapStreams.size = 2;
                            if   (leg_swap==1)
                              moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream_first = moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream;
                              moexSpfiReport_obj.FPML.TRADE.SWAP.swapStreams[0] = moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream_first;
                            elif (leg_swap==2)
                              moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream_second = moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream;
                              moexSpfiReport_obj.FPML.TRADE.SWAP.swapStreams[1] = moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream_second;
                            end;
                            moexSpfiReport_obj.FPML.TRADE.SWAP.swapStream = null;
                          end;
                        end;
                        d = d + 1;

                      end;
                      
                    end;
                    /*блок <fxSingleLeg>*/
/*<fxSingleLeg>*/   if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "FXSINGLELEG")
                      FXSINGLELEG_Node = TRADE_Node.childNodes.item(c);
                      /*блок чтения аттрибутов*/
                      /*пустой*/
                      /*блок чтения значений*/
                      ReadTagChild( FXSINGLELEG_Node, "PRODUCTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.productType);
                      
                      ReadTagChild( FXSINGLELEG_Node, "VALUEDATE",   V_DATE, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.valueDate);
                      /*просмотр всех дочерних элементов*/
                      d = 0;
                      while ( d < FXSINGLELEG_Node.childNodes.length)
                        if ( (FXSINGLELEG_Node.childNodes.item(d)) and (FXSINGLELEG_Node.childNodes.item(d).nodeType == CHILD_NODE) )              
                          if (StrUpr(FXSINGLELEG_Node.childNodes.item(d).tagname) == "EXCHANGEDCURRENCY1")
                            EXCHANGEDCURRENCY1_Node = FXSINGLELEG_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.payerPartyReference);
                            ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.receiverPartyReference);
                            ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "RECEIVERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.receiverAccountReference);
                            /*блок чтения значений*/
                            ReadTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.paymentType);
                            ReadTagChildOfTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTAMOUNT","CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.paymentAmount.currency );
                            ReadTagChildOfTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTAMOUNT","AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.paymentAmount.amount );
                            e = 0;
                            while ( e < EXCHANGEDCURRENCY1_Node.childNodes.length)
                              if ( (EXCHANGEDCURRENCY1_Node.childNodes.item(e)) and (EXCHANGEDCURRENCY1_Node.childNodes.item(e).nodeType == CHILD_NODE) )
                                if (StrUpr(EXCHANGEDCURRENCY1_Node.childNodes.item(e).tagname) == "PAYMENTDATE")
                                  PAYMENTDATE_Node = EXCHANGEDCURRENCY1_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  /*блок чтения значений*/
                                  ReadTagChild( PAYMENTDATE_Node, "UNADJUSTEDDATE", V_DATE,  moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency1.paymentDate.unadjustedDate );
                                  ReadTagChildOfTagChild( PAYMENTDATE_Node, "dateAdjustments", "businessDayConvention", V_STRING,  moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.EXCHANGEDCURRENCY1.PAYMENTDATE.DATEADJUSTMENTS.businessDayConvention  );
                                  /*просмотр всех дочерних элементов*/
                                  /*пусто*/
                                end;
                              end;
                              e = e + 1;
                            end;
                          end;
                          if (StrUpr(FXSINGLELEG_Node.childNodes.item(d).tagname) == "EXCHANGEDCURRENCY2")
                            EXCHANGEDCURRENCY2_Node = FXSINGLELEG_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.payerPartyReference);
                            ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "PAYERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.payerAccountReference);
                            ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.receiverPartyReference);
                            /*блок чтения значений*/
                            ReadTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.paymentType);
                            ReadTagChildOfTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTAMOUNT","CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.paymentAmount.currency );
                            ReadTagChildOfTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTAMOUNT","AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.paymentAmount.amount );
                            e = 0;
                            while ( e < EXCHANGEDCURRENCY2_Node.childNodes.length)
                              if ( (EXCHANGEDCURRENCY2_Node.childNodes.item(e)) and (EXCHANGEDCURRENCY2_Node.childNodes.item(e).nodeType == CHILD_NODE) )
                                if (StrUpr(EXCHANGEDCURRENCY2_Node.childNodes.item(e).tagname) == "PAYMENTDATE")
                                  PAYMENTDATE_Node = EXCHANGEDCURRENCY2_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  /*блок чтения значений*/
                                  ReadTagChild( PAYMENTDATE_Node, "UNADJUSTEDDATE", V_DATE,  moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.exchangedCurrency2.paymentDate.unadjustedDate );
                                  ReadTagChildOfTagChild( PAYMENTDATE_Node, "dateAdjustments", "businessDayConvention", V_STRING,  moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.EXCHANGEDCURRENCY2.PAYMENTDATE.DATEADJUSTMENTS.businessDayConvention  );
                                  /*просмотр всех дочерних элементов*/
                                  /*пусто*/
                                end;
                              end;
                              e = e + 1;
                            end;                        
                          end;                                                 
                          /*<exchangeRate>*/
                          if (StrUpr(FXSINGLELEG_Node.childNodes.item(d).tagname) == "EXCHANGERATE")
                            EXCHANGERATE_Node = FXSINGLELEG_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/
                            ReadTagChild(EXCHANGERATE_Node, "RATE", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.EXCHANGERATE.rate);
                            ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "CURRENCY1", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.currency1);
                            ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "CURRENCY2", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.currency2);
                            ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "QUOTEBASIS", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.quoteBasis);
                            /*просмотр всех дочерних элементов*/
                            /*пустой*/
                          end;
                          /*<nonDeliverableSettlement>*/
                          if (StrUpr(FXSINGLELEG_Node.childNodes.item(d).tagname) == "NONDELIVERABLESETTLEMENT")
                            NONDELIVERABLESETTLEMENT_Node = FXSINGLELEG_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/
                            ReadTagChild(NONDELIVERABLESETTLEMENT_Node, "SETTLEMENTCURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.NONDELIVERABLESETTLEMENT.settlementCurrency);
                            /*просмотр всех дочерних элементов*/
                            e = 0;
                            while ( e < NONDELIVERABLESETTLEMENT_Node.childNodes.length )
                              if ( (NONDELIVERABLESETTLEMENT_Node.childNodes.item(e)) and (NONDELIVERABLESETTLEMENT_Node.childNodes.item(e).nodeType == CHILD_NODE) )
                                if (StrUpr(NONDELIVERABLESETTLEMENT_Node.childNodes.item(e).tagname) == "FIXING")
                                  FIXING_Node = NONDELIVERABLESETTLEMENT_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  /*пустой*/
                                  /*блок чтения значений*/
                                  ReadTagChildOfTagChild(FIXING_Node, "QUOTEDCURRENCYPAIR", "CURRENCY1", V_STRING,
                                  moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.NONDELIVERABLESETTLEMENT.FIXING.QUOTEDCURRENCYPAIR.currency1);
                                  ReadTagChildOfTagChild(FIXING_Node, "QUOTEDCURRENCYPAIR", "CURRENCY2", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.NONDELIVERABLESETTLEMENT.FIXING.QUOTEDCURRENCYPAIR.currency2);
                                  ReadTagChildOfTagChild(FIXING_Node, "QUOTEDCURRENCYPAIR", "QUOTEBASIS", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.NONDELIVERABLESETTLEMENT.FIXING.QUOTEDCURRENCYPAIR.quoteBasis);
                                  ReadTagChild(FIXING_Node, "FIXINGDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.NONDELIVERABLESETTLEMENT.FIXING.fixingDate);
                                  ReadTagChildOfTagChildOfTagChild(FIXING_Node, "FXSPOTRATESOURCE", "PRIMARYRATESOURCE", "RATESOURCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSINGLELEG.NONDELIVERABLESETTLEMENT.FIXING.FXSPOTRATESOURCE.PRIMARYRATESOURCE.rateSource);
                                  /*просмотр всех дочерних элементов*/
                                  /*пустой*/
                                end;
                              end;
                              e = e + 1;
                            end;
                          end;
                        end;
                        d = d + 1;
                      end;
                    end;

/*<fxSwap>*/       if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "FXSWAP")
                      FXSWAP_Node = TRADE_Node.childNodes.item(c);
                      /*блок чтения аттрибутов*/
                      /*пустой*/
                      /*блок чтения значений*/
                      ReadTagChild( FXSWAP_Node, "PRODUCTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.productType);                     
                      /*просмотр всех дочерних элементов*/
                      d = 0;
                      while ( d < FXSWAP_Node.childNodes.length)
                        if ( (FXSWAP_Node.childNodes.item(d)) and (FXSWAP_Node.childNodes.item(d).nodeType == CHILD_NODE) )
                          if (StrUpr(FXSWAP_Node.childNodes.item(d).tagname) == "NEARLEG")
                             NEARLEG_Node = FXSWAP_Node.childNodes.item(d);
                             /*блок чтения аттрибутов*/
                             /*пустой*/
                             /*блок чтения значений*/
                             ReadTagChild( NEARLEG_Node, "VALUEDATE",   V_DATE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.valueDate);
                             /*просмотр всех дочерних элементов*/
                             e = 0;
                             while ( e < NEARLEG_Node.childNodes.length)
                               if ( (NEARLEG_Node.childNodes.item(e)) and (NEARLEG_Node.childNodes.item(e).nodeType == CHILD_NODE) )              
                                 if (StrUpr(NEARLEG_Node.childNodes.item(e).tagname) == "EXCHANGEDCURRENCY1")
                                   EXCHANGEDCURRENCY1_Node = NEARLEG_Node.childNodes.item(e);
                                   /*блок чтения аттрибутов*/
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.payerPartyReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.receiverPartyReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "RECEIVERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.receiverAccountReference);
                                   /*блок чтения значений*/
                                   ReadTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.paymentType);
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTAMOUNT","CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.paymentAmount.currency );
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTAMOUNT","AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.paymentAmount.amount );
                                   f = 0;
                                   while ( f < EXCHANGEDCURRENCY1_Node.childNodes.length)
                                     if ( (EXCHANGEDCURRENCY1_Node.childNodes.item(f)) and (EXCHANGEDCURRENCY1_Node.childNodes.item(f).nodeType == CHILD_NODE) )
                                       if (StrUpr(EXCHANGEDCURRENCY1_Node.childNodes.item(f).tagname) == "PAYMENTDATE")
                                         PAYMENTDATE_Node = EXCHANGEDCURRENCY1_Node.childNodes.item(f);
                                         /*блок чтения аттрибутов*/
                                         /*блок чтения значений*/
                                         ReadTagChild( PAYMENTDATE_Node, "UNADJUSTEDDATE", V_DATE,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency1.paymentDate.unadjustedDate );
                                         ReadTagChildOfTagChild( PAYMENTDATE_Node, "dateAdjustments", "businessDayConvention", V_STRING,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.EXCHANGEDCURRENCY1.PAYMENTDATE.DATEADJUSTMENTS.businessDayConvention  );
                                         /*просмотр всех дочерних элементов*/
                                         /*пусто*/
                                       end;
                                     end;                                  
                                     f = f + 1;
                                   end;
                                 end;
   
                                 if (StrUpr(NEARLEG_Node.childNodes.item(e).tagname) == "EXCHANGEDCURRENCY2")
                                   EXCHANGEDCURRENCY2_Node = NEARLEG_Node.childNodes.item(e);
                                   /*блок чтения аттрибутов*/
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.payerPartyReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "PAYERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.payerAccountReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.receiverPartyReference);
                                   /*блок чтения значений*/
                                   ReadTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.paymentType);
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTAMOUNT","CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.paymentAmount.currency );
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTAMOUNT","AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.paymentAmount.amount );
                                   f = 0;
                                   while ( f < EXCHANGEDCURRENCY2_Node.childNodes.length)
                                     if ( (EXCHANGEDCURRENCY2_Node.childNodes.item(f)) and (EXCHANGEDCURRENCY2_Node.childNodes.item(f).nodeType == CHILD_NODE) )
                                       if (StrUpr(EXCHANGEDCURRENCY2_Node.childNodes.item(f).tagname) == "PAYMENTDATE")
                                         PAYMENTDATE_Node = EXCHANGEDCURRENCY2_Node.childNodes.item(f);
                                         /*блок чтения аттрибутов*/
                                         /*блок чтения значений*/
                                         ReadTagChild( PAYMENTDATE_Node, "UNADJUSTEDDATE", V_DATE,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.exchangedCurrency2.paymentDate.unadjustedDate );
                                         ReadTagChildOfTagChild( PAYMENTDATE_Node, "dateAdjustments", "businessDayConvention", V_STRING,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.EXCHANGEDCURRENCY2.PAYMENTDATE.DATEADJUSTMENTS.businessDayConvention  );
                                         /*просмотр всех дочерних элементов*/
                                         /*пусто*/
                                       end;
                                     end;
                                     f = f + 1;
                                   end;                        
                                 end;

                                 /*<exchangeRate>*/
                                 if (StrUpr(NEARLEG_Node.childNodes.item(e).tagname) == "EXCHANGERATE")
                                   EXCHANGERATE_Node = NEARLEG_Node.childNodes.item(e);
                                   /*блок чтения аттрибутов*/
                                   /*пустой*/
                                   /*блок чтения значений*/
                                   ReadTagChild(EXCHANGERATE_Node, "RATE", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.EXCHANGERATE.rate);
                                   ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "CURRENCY1", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.currency1);
                                   ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "CURRENCY2", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.currency2);
                                   ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "QUOTEBASIS", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NEARLEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.quoteBasis);
                                   /*просмотр всех дочерних элементов*/
                                   /*пустой*/
                                 end;
                                                 
                               end;
                               e = e + 1;
                             end;
                          end;
                          if (StrUpr(FXSWAP_Node.childNodes.item(d).tagname) == "FARLEG")
                             FARLEG_Node = FXSWAP_Node.childNodes.item(d);
                             /*блок чтения аттрибутов*/
                             /*пустой*/
                             /*блок чтения значений*/
                             ReadTagChild( FARLEG_Node, "VALUEDATE",   V_DATE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.valueDate);
                             /*просмотр всех дочерних элементов*/
                             e = 0;
                             while ( e < FARLEG_Node.childNodes.length)
                               if ( (FARLEG_Node.childNodes.item(e)) and (FARLEG_Node.childNodes.item(e).nodeType == CHILD_NODE) )              
                                 if (StrUpr(FARLEG_Node.childNodes.item(e).tagname) == "EXCHANGEDCURRENCY1")
                                   EXCHANGEDCURRENCY1_Node = FARLEG_Node.childNodes.item(e);
                                   /*блок чтения аттрибутов*/
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.payerPartyReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.receiverPartyReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY1_Node, "HREF", "RECEIVERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.receiverAccountReference);
                                   /*блок чтения значений*/
                                   ReadTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.paymentType);
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTAMOUNT","CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.paymentAmount.currency );
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY1_Node, "PAYMENTAMOUNT","AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.paymentAmount.amount );
                                   f = 0;
                                   while ( f < EXCHANGEDCURRENCY1_Node.childNodes.length)
                                     if ( (EXCHANGEDCURRENCY1_Node.childNodes.item(f)) and (EXCHANGEDCURRENCY1_Node.childNodes.item(f).nodeType == CHILD_NODE) )
                                       if (StrUpr(EXCHANGEDCURRENCY1_Node.childNodes.item(f).tagname) == "PAYMENTDATE")
                                         PAYMENTDATE_Node = EXCHANGEDCURRENCY1_Node.childNodes.item(f);
                                         /*блок чтения аттрибутов*/
                                         /*блок чтения значений*/
                                         ReadTagChild( PAYMENTDATE_Node, "UNADJUSTEDDATE", V_DATE,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency1.paymentDate.unadjustedDate );
                                         ReadTagChildOfTagChild( PAYMENTDATE_Node, "dateAdjustments", "businessDayConvention", V_STRING,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.EXCHANGEDCURRENCY1.PAYMENTDATE.DATEADJUSTMENTS.businessDayConvention  );
                                         /*просмотр всех дочерних элементов*/
                                         /*пусто*/
                                       end;
                                     end;                                  
                                     f = f + 1;
                                   end;
                                 end;
   
                                 if (StrUpr(FARLEG_Node.childNodes.item(e).tagname) == "EXCHANGEDCURRENCY2")
                                   EXCHANGEDCURRENCY2_Node = FARLEG_Node.childNodes.item(e);
                                   /*блок чтения аттрибутов*/
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.payerPartyReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "PAYERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.payerAccountReference);
                                   ReadTagAttributeOfTagChild( EXCHANGEDCURRENCY2_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.receiverPartyReference);
                                   /*блок чтения значений*/
                                   ReadTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTTYPE",   V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.paymentType);
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTAMOUNT","CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.paymentAmount.currency );
                                   ReadTagChildOfTagChild( EXCHANGEDCURRENCY2_Node, "PAYMENTAMOUNT","AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.paymentAmount.amount );
                                   f = 0;
                                   while ( f < EXCHANGEDCURRENCY2_Node.childNodes.length)
                                     if ( (EXCHANGEDCURRENCY2_Node.childNodes.item(f)) and (EXCHANGEDCURRENCY2_Node.childNodes.item(f).nodeType == CHILD_NODE) )
                                       if (StrUpr(EXCHANGEDCURRENCY2_Node.childNodes.item(f).tagname) == "PAYMENTDATE")
                                         PAYMENTDATE_Node = EXCHANGEDCURRENCY2_Node.childNodes.item(f);
                                         /*блок чтения аттрибутов*/
                                         /*блок чтения значений*/
                                         ReadTagChild( PAYMENTDATE_Node, "UNADJUSTEDDATE", V_DATE,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.exchangedCurrency2.paymentDate.unadjustedDate );
                                         ReadTagChildOfTagChild( PAYMENTDATE_Node, "dateAdjustments", "businessDayConvention", V_STRING,  moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.EXCHANGEDCURRENCY2.PAYMENTDATE.DATEADJUSTMENTS.businessDayConvention  );
                                         /*просмотр всех дочерних элементов*/
                                         /*пусто*/
                                       end;
                                     end;
                                     f = f + 1;
                                   end;                        
                                 end;

                                 /*<exchangeRate>*/
                                 if (StrUpr(FARLEG_Node.childNodes.item(e).tagname) == "EXCHANGERATE")
                                   EXCHANGERATE_Node = FARLEG_Node.childNodes.item(e);
                                   /*блок чтения аттрибутов*/
                                   /*пустой*/
                                   /*блок чтения значений*/
                                   ReadTagChild(EXCHANGERATE_Node, "RATE", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.EXCHANGERATE.rate);
                                   ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "CURRENCY1", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.currency1);
                                   ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "CURRENCY2", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.currency2);
                                   ReadTagChildOfTagChild(EXCHANGERATE_Node, "QUOTEDCURRENCYPAIR", "QUOTEBASIS", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.FARLEG.EXCHANGERATE.QUOTEDCURRENCYPAIR.quoteBasis);
                                   /*просмотр всех дочерних элементов*/
                                   /*пустой*/
                                 end;
                                                 
                               end;
                               e = e + 1;
                             end;
                          end;
                          /*<nonDeliverableSettlement>*/
                          if (StrUpr(FXSWAP_Node.childNodes.item(d).tagname) == "NONDELIVERABLESETTLEMENT")
                            NONDELIVERABLESETTLEMENT_Node = FXSWAP_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/
                            ReadTagChild(NONDELIVERABLESETTLEMENT_Node, "SETTLEMENTCURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NONDELIVERABLESETTLEMENT.settlementCurrency);
                            /*просмотр всех дочерних элементов*/
                            e = 0;
                            while ( e < NONDELIVERABLESETTLEMENT_Node.childNodes.length )
                              if ( (NONDELIVERABLESETTLEMENT_Node.childNodes.item(e)) and (NONDELIVERABLESETTLEMENT_Node.childNodes.item(e).nodeType == CHILD_NODE) )
                                if (StrUpr(NONDELIVERABLESETTLEMENT_Node.childNodes.item(e).tagname) == "FIXING")
                                  FIXING_Node = NONDELIVERABLESETTLEMENT_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  /*пустой*/
                                  /*блок чтения значений*/
                                  ReadTagChildOfTagChild(FIXING_Node, "QUOTEDCURRENCYPAIR", "CURRENCY1", V_STRING,
                                  moexSpfiReport_obj.FPML.TRADE.FXSWAP.NONDELIVERABLESETTLEMENT.FIXING.QUOTEDCURRENCYPAIR.currency1);
                                  ReadTagChildOfTagChild(FIXING_Node, "QUOTEDCURRENCYPAIR", "CURRENCY2", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NONDELIVERABLESETTLEMENT.FIXING.QUOTEDCURRENCYPAIR.currency2);
                                  ReadTagChildOfTagChild(FIXING_Node, "QUOTEDCURRENCYPAIR", "QUOTEBASIS", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NONDELIVERABLESETTLEMENT.FIXING.QUOTEDCURRENCYPAIR.quoteBasis);
                                  ReadTagChild(FIXING_Node, "FIXINGDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NONDELIVERABLESETTLEMENT.FIXING.fixingDate);
                                  ReadTagChildOfTagChildOfTagChild(FIXING_Node, "FXSPOTRATESOURCE", "PRIMARYRATESOURCE", "RATESOURCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.FXSWAP.NONDELIVERABLESETTLEMENT.FIXING.FXSPOTRATESOURCE.PRIMARYRATESOURCE.rateSource);
                                  /*просмотр всех дочерних элементов*/
                                  /*пустой*/
                                end;
                              end;
                              e = e + 1;
                            end;
                          end;
                        end;
                        d = d + 1;
                      end;
                    end;

/*<bulletpayment>*/ if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "BULLETPAYMENT")
                      BULLETPAYMENT_Node = TRADE_Node.childNodes.item(c);
                      ReadTagChild(BULLETPAYMENT_Node, "PRODUCTTYPE", V_STRING, moexSpfiReport_obj.FPML.trade.bulletPayment.productType);
                    end;
                     /*<otherPartyPayment>*/
                    if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "OTHERPARTYPAYMENT")       
                      OTHERPARTYPAYMENT_Node = TRADE_Node.childNodes.item(c); 
                      /*блок чтения аттрибутов*/
                      /*пустой*/
                      /*блок чтения значений*/     
                      ReadTagAttributeOfTagChild(OTHERPARTYPAYMENT_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.payerPartyReference);
                      ReadTagAttributeOfTagChild(OTHERPARTYPAYMENT_Node, "HREF", "PAYERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.payerAccountReference);
                      ReadTagAttributeOfTagChild(OTHERPARTYPAYMENT_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.receiverPartyReference);
                      ReadTagAttributeOfTagChild(OTHERPARTYPAYMENT_Node, "HREF", "RECEIVERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.receiverAccountReference);
                      ReadTagChildOfTagChild(OTHERPARTYPAYMENT_Node, "PAYMENTAMOUNT", "CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.PAYMENTAMOUNT.currency);
                      ReadTagChildOfTagChild(OTHERPARTYPAYMENT_Node, "PAYMENTAMOUNT", "AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.PAYMENTAMOUNT.amount);
                      ReadTagChildOfTagChild(OTHERPARTYPAYMENT_Node, "PAYMENTDATE", "ADJUSTEDDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.PAYMENTDATE.adjustedDate);
                      ReadTagChild(OTHERPARTYPAYMENT_Node, "PAYMENTTYPE", V_STRING, moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT.paymentType);
                      
                      var otherPartyPaymentObj = moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT;
                      moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENT = null;
                      moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENTS[moexSpfiReport_obj.FPML.TRADE.OTHERPARTYPAYMENTS.size] = otherPartyPaymentObj;
                      /*просмотр всех дочерних элементов*/                       
                    end;
/*<moexSpfiExt>*/if ((StrUpr(TRADE_Node.childNodes.item(c).tagname) == "MOEXSPFIEXT") or (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "MS:MOEXSPFIEXT"))
                      MOEXSPFIEXT_Node = TRADE_Node.childNodes.item(c);
                      /*блок чтения аттрибутов*/
                      /*пустой*/
                      /*блок чтения значений*/     
                      /*пустой*/
                      /*просмотр всех дочерних элементов*/ 
                      if (StrUpr(TRADE_Node.childNodes.item(c).tagname) == "MS:MOEXSPFIEXT")
                        prefix = "MS:";
                      else
                        prefix = "";
                      end;

                      d = 0;
                      while ( d < MOEXSPFIEXT_Node.childNodes.length )
                        if ( ( MOEXSPFIEXT_Node.childNodes.item(d) ) and ( MOEXSPFIEXT_Node.childNodes.item(d).nodeType == CHILD_NODE ) )
                          if (StrUpr(MOEXSPFIEXT_Node.childNodes.item(d).tagname) == (prefix + "TRADEINFO"))
                            TRADEINFO_Node = MOEXSPFIEXT_Node.childNodes.item(d);
                            ReadTagChild(TRADEINFO_Node, prefix + "SETTLEMENTCODE" , V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.TRADEINFO.settlementCode);
                            ReadTagChild(TRADEINFO_Node, prefix + "CSA" , V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.TRADEINFO.csa);
                          end;
                          if (StrUpr(MOEXSPFIEXT_Node.childNodes.item(d).tagname) == (prefix + "NPV"))
                            NPV_Node = MOEXSPFIEXT_Node.childNodes.item(d);
                            /*блок чтения аттрибутов*/
                            /*пустой*/
                            /*блок чтения значений*/
                            /*пустой*/
                            /*просмотр всех дочерних элементов*/ 
                            e = 0;
                            while ( e < NPV_Node.childNodes.length )
                              if ( ( NPV_Node.childNodes.item(e) ) and ( NPV_Node.childNodes.item(e).nodeType == CHILD_NODE ) )
                                if (StrUpr(NPV_Node.childNodes.item(e).tagname) == (prefix + "NPVPOINT"))
                                  NPVPOINT_Node = NPV_Node.childNodes.item(e);
                                  /*блок чтения аттрибутов*/
                                  /*пустой*/
                                  /*блок чтения значений*/   
                                  ReadTagChild(NPVPOINT_Node, prefix + "NPVDATE" , V_DATE, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.npvDate);
                                  ReadTagChildOfTagChild(NPVPOINT_Node, prefix + "NPVVALUE" , prefix + "NPVCURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVVALUE.npvCurrency);
                                  ReadTagChildOfTagChild(NPVPOINT_Node, prefix + "NPVVALUE" , prefix + "NPVAMOUNT", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVVALUE.npvAmount);
                                  f = 0;
                                  while ( f < NPVPOINT_Node.childNodes.length)
                                    if ( ( NPVPOINT_Node.childNodes.item(f) ) and ( NPVPOINT_Node.childNodes.item(f).nodeType == CHILD_NODE ) )
                                      if (StrUpr(NPVPOINT_Node.childNodes.item(f).tagname) == "NPVPAYMENT")
                                        NPVPAYMENT_Node = NPVPOINT_Node.childNodes.item(f);
                                        ReadTagAttribut(NPVPAYMENT_Node, "ID", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.id);
                                        ReadTagAttributeOfTagChild(NPVPAYMENT_Node, "HREF", "PAYERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.payerpartyreference);
                                        ReadTagAttributeOfTagChild(NPVPAYMENT_Node, "HREF", "PAYERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.payerAccountReference);
                                        ReadTagAttributeOfTagChild(NPVPAYMENT_Node, "HREF", "RECEIVERPARTYREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.receiverPartyReference);
                                        ReadTagAttributeOfTagChild(NPVPAYMENT_Node, "HREF", "RECEIVERACCOUNTREFERENCE", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.receiverAccountReference);
                                        ReadTagChildOfTagChild(NPVPAYMENT_Node, "PAYMENTAMOUNT", "CURRENCY", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.PAYMENTAMOUNT.currency);
                                        ReadTagChildOfTagChild(NPVPAYMENT_Node, "PAYMENTAMOUNT", "AMOUNT", V_DOUBLE, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.PAYMENTAMOUNT.amount);
                                        ReadTagChildOfTagChild(NPVPAYMENT_Node, "PAYMENTDATE", "ADJUSTEDDATE", V_DATE, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.PAYMENTDATE.adjustedDate);
                                        ReadTagChild(NPVPAYMENT_Node, "PAYMENTTYPE", V_STRING, moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT.paymentType);
                                        
                                        var npvpayment = moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT;
                                        moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENT = NULL;
                                        moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENTS[moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT.NPVPAYMENTS.size] = npvpayment;
                                      end;
                                    end;
                                    f = f + 1;
                                  end;

                                  var npvpoint = moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT;
                                  moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.NPVPOINT  = NULL;
                                  moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.npvpoints[moexSpfiReport_obj.FPML.TRADE.MOEXSPFIEXT.NPV.npvpoints.size] = npvpoint;
                                  /*просмотр всех дочерних элементов*/ 
                                end;
                              end;
                              e = e + 1;
                            end;
                          end;
                        end;
                        d = d + 1;
                      end;
                      
                    end;
                    
                  end;
                  c = c + 1;
                end;
                var trade = moexSpfiReport_obj.FPML.trade;
                moexSpfiReport_obj.FPML.trade = NULL;
                moexSpfiReport_obj.FPML.trades[moexSpfiReport_obj.FPML.trades.size] = trade;///*Copy(*/moexSpfiReport_obj.FPML.trade/*)*/;
                //Copy( moexSpfiReport_obj.FPML.trades[moexSpfiReport_obj.FPML.trades.size], moexSpfiReport_obj.FPML.trade);
              elif (StrUpr(FPML_Node.childNodes.item(b).tagname) == "PARTY")
                PARTY_Node =  FPML_Node.childNodes.item(b);
                /*блок чтения значений*/

                var PartyInf = moexSpfiReport_obj.FPML.PARTY;
                moexSpfiReport_obj.FPML.PARTY = null;

                ReadTagChild(PARTY_Node, "PARTYID", V_STRING, PartyInf.partyID);
                ReadTagChild(PARTY_Node, "PARTYNAME", V_STRING, PartyInf.partyName);

                moexSpfiReport_obj.FPML.PARTIES[moexSpfiReport_obj.FPML.PARTIES.size] = PartyInf;
              end;
            end;
            b = b + 1;
            UseProgress(b);
          end;
        
        
        elif (StrUpr(moexSpfiReport_Node.childNodes.item(a).tagname) == "GUARANTEEFUND")
        elif (StrUpr(moexSpfiReport_Node.childNodes.item(a).tagname) == "INITIALMARGIN")
        elif (StrUpr(moexSpfiReport_Node.childNodes.item(a).tagname) == "RISKPARAMETERS")
        end;
      end;
      
      a = a + 1;
    end;
    RemProgress(); 
  else 
    stat = 1;
  end;
  convertFromModelToReplicationRecords(moexSpfiReport_obj);
  
  return stat;

OnError( RslErrObj )
    RemProgress();
    MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
    RunError;
end;
           
private macro ResultCopyFile( done:bool, data_filepath:string, data_filename:string, CurImpDate:date )
  var data_file_new_path, data_file_new_file;

  if( done )
     data_file_new_path = data_filepath + "Done\\";
  else
     data_file_new_path = data_filepath + "Err\\";
  end;

  MakeDir(data_file_new_path);

  data_file_new_file = data_file_new_path + data_filename;

  if( not CopyFile(data_filepath + data_filename, data_file_new_file) )
     RGLog.Error("Ошибка копирования файла " + data_filename + " в " + data_file_new_file);
  else
     RGLog.Message("Файл " + data_filename + " скопирован в " + data_file_new_file);
  end;
end;
          
private macro RunImportSPFI( Pan )

  var stat:integer = 0;
  var data_filepath_ITOG_SPFI:string = "", data_filename_ITOG_SPFI:string = "", data_filepath_orig_ITOG_SPFI:string = "";
  var RetVal = CM_SAVE;

  if( CheckPanel(Pan) == false )
     RetVal = CM_IGNORE;
  end;

  if( RetVal != CM_IGNORE )
     RGLog = GTDL_Log(SeanceID);
     RGLog.Message("Импорт файлов итогов торгов на рынке СПФИ");

     var CurImpDate:date = Pan.beg_date;
     CurImpDate_ = CurImpDate;

     var ProgressIndex:integer = 0;
     if( GetDialogFlag() )
        InitProgress((Pan.end_date - Pan.beg_date + 1), "Загрузка файлов за период дат", "Просмотр дат...");
     end;
     while( CurImpDate <= Pan.end_date )
        if( get_data_file_name(CurImpDate, @data_filepath_ITOG_SPFI, @data_filename_ITOG_SPFI, @data_filepath_orig_ITOG_SPFI) == 0 )
           if( import_itog_SPFI_to_gate(data_filepath_ITOG_SPFI + data_filename_ITOG_SPFI) == 0 )
              ResultCopyFile(true, data_filepath_orig_ITOG_SPFI, data_filename_ITOG_SPFI, CurImpDate);
           else
              ResultCopyFile(false, data_filepath_orig_ITOG_SPFI, data_filename_ITOG_SPFI, CurImpDate);
           end;
        end;
        CurImpDate_ = CurImpDate = CurImpDate + 1;
        ProgressIndex = ProgressIndex + 1;
        if( GetDialogFlag() )
           UseProgress(ProgressIndex);
        end;
        if( FlagCtrlBrk == true )
           break;
        end;
     end;
     if( GetDialogFlag() )
        RemProgress(); 
     end;

     RGLog.Save();
  end;

  return RetVal;

OnError( RslErrObj )
  if( GetDialogFlag() )
     RemProgress(); 
  end;
end;              
              
private macro RunInitPSFI( Pan )
  Pan.beg_date = {curdate};
  Pan.end_date = {curdate};
end;

private macro ProcessPanel( Pn, Cmd, ID, Key )

  if( Cmd == DLG_INIT )
     RunInitPSFI(Pn);
     UpdateFields(Pn);
  elif( cmd == DLG_KEY )
     if( (key == 317) AND (ID == PNFLD_BEGDATE) ) /* F3 */
        Pn.beg_date = GetDateByCalendar(Pn.beg_date);
        UpdateFields(Pn);
     elif( (key == 317) AND (ID == PNFLD_ENDDATE) ) /* F3 */
        Pn.end_date = GetDateByCalendar(Pn.end_date);
        UpdateFields(Pn);
     elif( Key == 316 )
        return RunImportSPFI(Pn);
     elif( (Key == 13) or (Key == 323) )
        return CM_IGNORE;
     end;
  end;

  return CM_DEFAULT;
end;

macro Receive(_SeanceID:integer, Parm:variant)
   SeanceID = _SeanceID;

   record _party(party);
   var RS;

   if( IsShedulerRunning() )
     /* RunInitMVB4(pp);
      AutoSetParm(pp, Parm);                     // пар-ры из панели источника
      AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
      RunImportMVB4(pp);*/
      RunInitPSFI(pp);
      AutoSetParm(pp, Parm);
      RunImportSPFI(pp);
   else
      var autoproc;
      if((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
        RunInitPSFI(pp);
        AutoSetParm(pp, Parm);
        RunImportSPFI(pp);
      else
        RunDialog(pp, "ProcessPanel");
      end;
      //RunDialog(pp, "ProcessPanel");
   end;

   return 0;
end;