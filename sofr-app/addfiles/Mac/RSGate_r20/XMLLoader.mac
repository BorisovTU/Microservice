/*
$Name:        XMLLoader.mac
$Module:      Шлюз
$Description: Ф-и для загрузки из XML файлов
*/
const INVALID_NODE                = 0;
const CHILD_NODE                  = 1;
const ATTR_NODE                   = 2;
const TEXT_NODE                   = 3;
const CDATA_SECTION_NODE          = 4;
const ENTITY_REFERENCE_NODE       = 5;
const ENTITY_NODE                 = 6;
const PROCESSING_INSTRUCTION_NODE = 7;
const COMMENT_NODE                = 8;
const DOCUMENT_NODE               = 9;
const DOCUMENT_TYPE_NODE          = 10;
const DOCUMENT_FRAGMENT_NODE      = 11;
const NOTATION_NODE               = 12;


/* оставить 2 знака */
private macro MakeMoney( Summa:STRING )
   return Round(money(double(Summa)), 2);
end;

/* в xml файле дата приходит в формате "YYYY-MM-DD"*/
macro XML_ПолучитьДату( str:string ):date

   var YYYY:integer, MM:integer, DD:integer;

   YYYY = int(substr(str, 1, 4));
   MM   = int(substr(str, 6, 2));
   DD   = int(substr(str, 9, 2));

   return date(DD, MM, YYYY);
end;

/* в xml файле V_DTTM приходит в формате "YYYY-MM-DD hh:mm:ss"*/
macro XML_ПолучитьВремяИзDTTM( str:string ):time

   var hh:integer, mm:integer, ss:integer;

   hh = int(substr(str, 12, 2));
   mm = int(substr(str, 15, 2));
   ss = int(substr(str, 18, 2));

   return time(hh, mm, ss);
end;

/* Получить значение атрибута тэга */
macro ReadTagAttribut(node:object, name:string, DataType:integer, retval)

   var ret;
   var i:integer;
   var child:object;
   i=0;
   while( i < node.attributes.length )
     child = node.attributes.item(i);
     if( child and (child.nodeType == ATTR_NODE) )
        if ( StrUpr(child.NodeName) == name )
           if(DataType == V_DATE)
              ret = XML_ПолучитьДату(child.nodeValue);
           elif(DataType == V_INTEGER)
              ret = int(child.nodeValue);
           elif(DataType == V_MONEY)
              ret = MakeMoney(child.nodeValue);
           elif(DataType == V_DOUBLE)
              ret = double(child.nodeValue);
           elif(DataType == V_STRING)
              ret = child.nodeValue;
           elif(DataType == V_TIME)
              ret = time(child.nodeValue);
           end;

           setparm(3, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;
end;

macro ReadTagChild( node:object, name:string, DataType:integer, retval )

   var ret;
   var i:integer;
   var child:object;

   i=0;
   while( i < node.childNodes.length )
     child = node.childNodes.item(i);
     if( child and (child.nodeType == CHILD_NODE) )
        if ( StrUpr(child.NodeName) == name )
           if(DataType == V_DATE)
              ret = XML_ПолучитьДату(child.nodeTypedValue);
           elif(DataType == V_INTEGER)
              ret = int(child.nodeTypedValue);
           elif(DataType == V_MONEY)
              ret = MakeMoney(child.nodeTypedValue);
           elif(DataType == V_DOUBLE)
              ret = double(child.nodeTypedValue);
           elif(DataType == V_STRING)
              ret = child.nodeTypedValue;
           elif(DataType == V_TIME)
              ret = time(child.nodeTypedValue);
           elif(DataType == V_DTTM)
              ret = DtTm(XML_ПолучитьДату(child.nodeTypedValue), XML_ПолучитьВремяИзDTTM(child.nodeTypedValue));
           end;

           setparm(3, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;
end;

/* получить дочерний элемент с заданн*/
macro ReadTagChildEx( node:object, name:string, DataType:integer, retval, number:integer )

   var ret;
   var i:integer;
   var child:object;
   if ( (number==null) or (number == -1) )
    number = 0;
   end;
   var foundedNumber = -1;
   i=0;
   while( i < node.childNodes.length )
     child = node.childNodes.item(i);
     if( child and (child.nodeType == CHILD_NODE) )
        if ( StrUpr(child.NodeName) == name )
           foundedNumber = foundedNumber + 1;
           if (foundedNumber == number)
              if(DataType == V_DATE)
                 ret = XML_ПолучитьДату(child.nodeTypedValue);
              elif(DataType == V_INTEGER)
                 ret = int(child.nodeTypedValue);
              elif(DataType == V_MONEY)
                 ret = MakeMoney(child.nodeTypedValue);
              elif(DataType == V_DOUBLE)
                 ret = double(child.nodeTypedValue);
              elif(DataType == V_STRING)
                 ret = child.nodeTypedValue;
              elif(DataType == V_TIME)
                 ret = time(child.nodeTypedValue);
              elif(DataType == V_DTTM)
                 ret = DtTm(XML_ПолучитьДату(child.nodeTypedValue), XML_ПолучитьВремяИзDTTM(child.nodeTypedValue));
              end;
              
              setparm(3, ret);
              return true;
           end;
        end;
     end;
     i= i + 1;
   end;

   return false;
end;

macro ReadTagAttributeOfTagChild(node:object, nameAttribute:string, nameChild:string, DataType:integer, retval)
   var ret;
   var i:integer;
   var child:object;

   i=0;
   while( i < node.childNodes.length )
     child = node.childNodes.item(i);
     if( child and (child.nodeType == CHILD_NODE) )
        if ( StrUpr(child.NodeName) == nameChild )
        
           ReadTagAttribut(child, nameAttribute, DataType, ret);        
           setparm(4, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;

end;

macro ReadTagAttributeOfTagChildOfTagChild(node:object, nameAttribute:string, nameChild1:string, nameChild2:string, DataType:integer, retval)
   var ret;
   var i:integer;
   var child:object;

   i=0;
   while( i < node.childNodes.length )
     child = node.childNodes.item(i);
     if( child and (child.nodeType == CHILD_NODE) )
        if ( StrUpr(child.NodeName) == nameChild1 )
        
           ReadTagAttributeOfTagChild(child, nameAttribute, nameChild2:string, DataType, ret);        
           setparm(5, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;

end;

macro ReadTagChildOfTagChild (node:object, name1:string, name2:string, DataType:integer, retval)
   var ret;
   var i:integer;
   var child:object;

   i=0;
   while( i < node.childNodes.length )
     child = node.childNodes.item(i);
     if( child and (child.nodeType == CHILD_NODE) )
        if ( StrUpr(child.NodeName) == name1 )        
           ReadTagChild(child, name2, DataType, ret);        
           setparm(4, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;

end;

macro ReadTagChildOfTagChildOfTagChild (node:object, name1:string, name2:string, name3:string, DataType:integer, retval)
   var ret;
   var i:integer;
   var child:object;

   i=0;
   while( i < node.childNodes.length )
     child = node.childNodes.item(i);
     if( child and (child.nodeType == CHILD_NODE) )
        if ( StrUpr(child.NodeName) == name1 )        
           ReadTagChildOfTagChild(child, name2, name3, DataType, ret);        
           setparm(5, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;

end;