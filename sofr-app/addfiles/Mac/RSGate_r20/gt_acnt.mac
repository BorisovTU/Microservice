/************************************************************************/
/*         Автоматизированная банковская система RS-Bank v5.хх          */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Модуль           : Шлюз                                             */
/*                                                                      */
/*  Имя файла        : mvo_acnt.mac                                     */
/*                                                                      */
/*  Описание         : Репликация лицевых счетов            */
/*                                                                      */
/*  Программист      : Сулимов Д.В.                                     */
/*                                                                      */
/*  Создан           : 08.10.1998                                       */
/*                                                                      */
/************************************************************************/
import Globals, "gt_func.mac";

record AcntGKBO  ( account, "bank.def" );
record AcntBlncGKBO  ( accblnc, "bank.def" );

private var objAcntMVODB;
private var objObAcntMVODB;

private var AcntMVODB;
private var AcntBlncMVODB;
private var obAcntMVODB;
private var obAcntBlncMVODB;


macro CarryAccount

   var stat;
   var AccTableNamePtr;
   var AccBlncTableNamePtr;
   var ObjPtr;

   if( AcntGKBO.Chapter == 1 ) ObjPtr = objAcntMVODB;
   else                        ObjPtr = objObAcntMVODB;
   end;

   stat = mvodbCarryCheck(ObjPtr.carry(AcntGKBO.Chapter, InfObject.ActionID, @MVODB_ObjectCode),@ErrorMessage);

   if(stat != 0)
      stat = Error_InCarry;

      if( AcntGKBO.Chapter == 1 )
         ErrorMessage = string( " Счет ", AcntMVODB.Account," - ",  ErrorMessage );
      else
         ErrorMessage = string( " Счет ", obAcntMVODB.Account," - ",  ErrorMessage );
      end;

      ReplicatorMsgBox(ErrorMessage);
   end;

   return stat;
end;

MACRO GetPartyID(PartyID)
  return PartyID;
END;

PRIVATE MACRO GetAccLimit(Account, FIID, Chapter, limitdate )
   var Limit = $0;
   var cmd : RsdCommand;
   var rs; 
   var SqlStr = "SELECT t_Limit                                  " +
                "FROM dacclimit_dbt                              " +
                "WHERE t_Account       = ?                       " +
                "  AND t_Code_Currency = ?                       " +
                "  AND t_Chapter       = ?                       " +
                "  AND t_LimitDate = (SELECT max(t_LimitDate)    " +
                "                     FROM dacclimit_dbt         " +
                "                     WHERE t_Account       = ?  " +
                "                       AND t_Code_Currency = ?  " +
                "                       AND t_Chapter       = ?  " +
                "                       AND t_LimitDate    <= ?) " ;

    cmd = RsdCommand( SqlStr );

    cmd.addParam( "", RSDBP_IN, Account );               /* Номер счета   */
    cmd.addParam( "", RSDBP_IN, FIID    );               /* Валюта счета  */
    cmd.addParam( "", RSDBP_IN, Chapter );               /* Глава счета   */

    cmd.addParam( "", RSDBP_IN, Account );               /* Номер счета   */
    cmd.addParam( "", RSDBP_IN, FIID    );               /* Валюта счета  */
    cmd.addParam( "", RSDBP_IN, Chapter );               /* Глава счета   */
    cmd.addParam( "", RSDBP_IN, limitdate );         

    rs = RsdRecordset(cmd);
    if( rs.moveNext() ) 
      Limit = rs.value(0);
    end;

    return Limit;
END;

macro CopyAcntGKBO_to_AcntMVODB( balance )

  var stat = 0;

  AcntBlncMVODB   = mvodbXCheck(objAcntMVODB.CreateBlnc(AcntMVODB.Code_Currency),"TRecHandler");

  obAcntBlncMVODB = mvodbXCheck(objObAcntMVODB.CreateBlnc(obAcntMVODB.Code_Currency),"TRecHandler");

  if( balance == 1 )

    ClearRecord( AcntMVODB );
    ClearRecord( AcntBlncMVODB );

    stat = ConvertCurrCode( AcntMVODB.Code_Currency, AcntGKBO.Code_Currency );
    if( stat ) stat = Error_NoCurrency; return stat; end;

    stat = ConvertContrCode( AcntMVODB.Client, GetPartyID(AcntGKBO.Client) );
    if( stat ) stat = Error_NoContragent; return stat; end;

    AcntMVODB.Open_Close   = AcntGKBO.Open_Close;
    AcntMVODB.Account      = AcntGKBO.Account;
    AcntMVODB.Oper      = AcntGKBO.Oper;
    AcntMVODB.Balance      = AcntGKBO.Balance;
    AcntMVODB.Index2    = AcntGKBO.Index2;
    AcntMVODB.Index3    = AcntGKBO.Index3;
    AcntMVODB.Kind_Account = AcntGKBO.Kind_Account;
    AcntMVODB.Type_Account = AcntGKBO.Type_Account;
    AcntMVODB.EType_Account   = AcntGKBO.EType_Account;
    AcntMVODB.UserTypeAccount = AcntGKBO.UserTypeAccount;
//    AcntMVODB.Connect_Account = AcntGKBO.Connect_Account;
    AcntMVODB.Symbol    = AcntGKBO.Symbol;
    AcntMVODB.Limit     = GetAccLimit(AcntGKBO.Account, AcntGKBO.Code_Currency, AcntGKBO.Chapter, date(31,12,9999));
    AcntMVODB.Open_Date    = AcntGKBO.Open_Date;
    AcntMVODB.Close_Date   = AcntGKBO.Close_Date;
    AcntMVODB.NameAccount  = AcntGKBO.NameAccount;
    AcntMVODB.Change_Date  = AcntGKBO.Change_Date;
    AcntMVODB.Change_DatePrev = AcntGKBO.Change_DatePrev;
    AcntMVODB.PairAccount  = AcntGKBO.PairAccount;
    AcntMVODB.UserField1   = AcntGKBO.UserField1;
    AcntMVODB.UserField2   = AcntGKBO.UserField2;
    AcntMVODB.UserField3   = AcntGKBO.UserField3;
    AcntMVODB.UserField4   = AcntGKBO.UserField4;
    AcntMVODB.OperationDate   = AcntGKBO.OperationDate;
    AcntMVODB.DaysToEnd    = AcntGKBO.DaysToEnd;
    AcntMVODB.Department   = AcntGKBO.Department;
    AcntMVODB.ORScheme     = AcntGKBO.ORScheme;

    if (AcntMVODB.Kind_Account == "0")
        AcntMVODB.Kind_Account = "-";
    end;

    ReplCopy(@AcntBlncMVODB, AcntBlncGKBO);
  else

    ClearRecord( obAcntMVODB );
    ClearRecord( obAcntBlncMVODB );

    stat = ConvertCurrCode( obAcntMVODB.Code_Currency, AcntGKBO.Code_Currency );
    if( stat ) stat = Error_NoCurrency; return stat; end;

    stat = ConvertContrCode( obAcntMVODB.Client, GetPartyID(AcntGKBO.Client) );
    if( stat ) stat = Error_NoContragent; return stat; end;

    obAcntMVODB.Open_Close    = AcntGKBO.Open_Close;
    obAcntMVODB.Account    = AcntGKBO.Account;
    obAcntMVODB.Oper    = AcntGKBO.Oper;
    obAcntMVODB.Balance    = AcntGKBO.Balance;
    obAcntMVODB.Kind_Account  = AcntGKBO.Kind_Account;
    obAcntMVODB.Type_Account  = AcntGKBO.Type_Account;
    obAcntMVODB.UserTypeAccount  = AcntGKBO.UserTypeAccount;
//    obAcntMVODB.Connect_Account  = AcntGKBO.Connect_Account;
    obAcntMVODB.Symbol     = AcntGKBO.Symbol;
    obAcntMVODB.Limit      = GetAccLimit(AcntGKBO.Account, AcntGKBO.Code_Currency, AcntGKBO.Chapter, date(31,12,9999));
    obAcntMVODB.Open_Date  = AcntGKBO.Open_Date;
    obAcntMVODB.Close_Date = AcntGKBO.Close_Date;
    obAcntMVODB.NameAccount   = AcntGKBO.NameAccount;
    obAcntMVODB.Change_Date   = AcntGKBO.Change_Date;
    obAcntMVODB.Change_DatePrev  = AcntGKBO.Change_DatePrev;
    obAcntMVODB.PairAccount   = AcntGKBO.PairAccount;
    obAcntMVODB.UserField1 = AcntGKBO.UserField1;
    obAcntMVODB.UserField2 = AcntGKBO.UserField2;
    obAcntMVODB.UserField3 = AcntGKBO.UserField3;
    obAcntMVODB.UserField4 = AcntGKBO.UserField4;
    obAcntMVODB.OperationDate = AcntGKBO.OperationDate;
    obAcntMVODB.DaysToEnd  = AcntGKBO.DaysToEnd;
    obAcntMVODB.Department = AcntGKBO.Department;
    obAcntMVODB.Chapter    = AcntGKBO.Chapter;

    ReplCopy(@obAcntBlncMVODB, AcntBlncGKBO);

  end;

  return stat;

end;


macro GetAccountGKBO()

 var НомерСчета;
 var acntPtr = 0, accblncPtr = 0;
 var stat = 0;

 codeObject.rec.ObjectID      = InfObject.ObjectID;
 codeObject.rec.ApplicationID = GKBO;
 codeObject.rec.ObjectKind    = Object.ObjectKind;

 if (GetEQ(codeObject))

    stat = FindAcntInGKBO( codeObject.rec.ObjectCode, accblncPtr, acntPtr );

    if( stat )

      НомерСчета = SubStr( codeObject.rec.ObjectCode, 10 );
/*      ReplicatorMsgBox(string( "Счет ", НомерСчета," в базе ГКБО не найден"));
*/
      ErrorMessage = string( "Счет ", НомерСчета," в базе ГКБО не найден");
      ReplicatorMsgBox(ErrorMessage);

      codeObject.dropFilter();

      return Error_NoCarry;

    else

      setbuff( AcntGKBO, acntPtr );

      if( accblncPtr )
        setbuff( AcntBlncGKBO, accblncPtr );
      else
        ClearRecord( AcntBlncGKBO );
      end;

    end;

 else

   ReplicatorMsgBox(string( "Нет записи о коде объекта в системе-источнике"));
   codeObject.dropFilter();
   return Error_NoObjectCode;

 end;

 codeObject.dropFilter();
 return 0;

end;

macro PrepareExportAccounts(IsMCAAccount)
  var stat = 0;
  if (InfObject.ActionID == ACT_DELETE)
     ErrorMessage = "Логическая ошибка: данный объект удалять нельзя.";
     return 1;
  end;

  if(IsMCAAccount)
    objAcntMVODB    = mvodbXCheck(IMVODBRepl.CreateAccountMCA(false, @AcntMVODB),"IMVODBAccountMCA");
  else
    objAcntMVODB    = mvodbXCheck(IMVODBRepl.CreateAccount(false, @AcntMVODB),"IMVODBAccount");
  end;

  AcntMVODB       = AcntMVODB.rec;

  if(IsMCAAccount)
    objObAcntMVODB  = mvodbXCheck(IMVODBRepl.CreateAccountMCA(true,  @obAcntMVODB),"IMVODBAccountMCA");
  else
    objObAcntMVODB  = mvodbXCheck(IMVODBRepl.CreateAccount(true,  @obAcntMVODB),"IMVODBAccount");
  end;

  obAcntMVODB     = obAcntMVODB.rec;

  stat = GetAccountGKBO();

  if( stat == 0 )

   stat = CopyAcntGKBO_to_AcntMVODB( AcntGKBO.Chapter );

  end;

  return stat;

end;
