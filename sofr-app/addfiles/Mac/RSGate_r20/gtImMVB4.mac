/*
$Name:        gtImMVB4.mac
$Module:      Шлюз Securities
$Description: Загрузка ММВБ xml-формат файла биржи
*/

import gtImMVB_DL, "secinter.mac", "gtmktrep.mac", "rgtgtrec.mac", "GTRrate.mac", "DlForms_h.mac","dldlngfun.mac";
/*ak*/
import gtdlfun_u;
/*~ak*/

/*настраиваемые пользователем константы*/
/* используется для задания вида курса, если он не задан во входном файле с котировками */
PRIVATE CONST RATE_KIND_MARKET     = 1;  /*курс вида "Рыночная цена"         */        
PRIVATE CONST RATE_KIND_MIN        = 2;  /*курс вида "Минимальная цена"      */
PRIVATE CONST RATE_KIND_MAX        = 3;  /*курс вида "Максимальная цена"     */
PRIVATE CONST RATE_KIND_WA         = 4;  /*курс вида "Средневзвешенная цена" */
PRIVATE CONST RATE_KIND_NKD1SEC    = 15; /*курс вида "НКД на одну бумагу"    */
PRIVATE CONST RATE_KIND_VOLUME     = 17; /*курс вида "Объём торгов"          */
PRIVATE CONST RATE_KIND_MARKET_TAX = 21; /*курс вида "Рыночная цена для НДФЛ"*/

PRIVATE CONST SET_CHAR   = "X";
PRIVATE CONST UNSET_CHAR = "";

PRIVATE CONST ОСНОВНАЯ_002 = 0;
PRIVATE CONST ОСНОВНАЯ_003 = 1;
PRIVATE CONST ВЕЧЕРНЯЯ     = 2;

PRIVATE VAR NumImportDeals = 0, NumImportDealsTotal = 0,
            NumImportDealsCliring = 0, NumImportDealsTotalCliring = 0,
            CodeRate = "", RateKind_ = "", NumImportRates = 0, NumImportRatesTotal = 0,
            RECORDID_Deals = 0, RECORDID_Deals_Cliring = 0, RECORDID_Deals_DV = 0, RECORDID_MarketReport;

PRIVATE record pp(IMP_PRM3, "rgate.lbr") dialog;

private macro ЧислоСтрокой( _var, _point:integer )
   return ExecExp("String(_var:0" + ":" + string(_point) + ")");
end;

PRIVATE CONST PNFLD_IMPDATE         = 0,
              PNFLD_MARKET          = 1,
              PNFLD_RATES           = 2,
              PNFLD_COMP            = 3,
              PNFLD_PAYM            = 4,
              PNFLD_INCREPO         = 5,
              PNFLD_DIVIDREPO       = 6, 
              PNFLD_REQUEST         = 7, 
              PNFLD_SECUR           = 8, 
              PNFLD_CLEARING        = 9, 
              PNFLD_CLEARING_CLIENT = 10,
              PNFLD_SEC_BO          = 11,
              PNFLD_SEC_SEB         = 12,
              PNFLD_SEC_DU          = 13,
              PNFLD_MAR_SCHEME_DU   = 14,
              PNFLD_NETTOITOG       = 15,
              PNFLD_MONEYMOTION     = 16,
              PNFLD_KSUWRT          = 17;

private class DataMoneyMotion(_StatementAcc, _EntryCodeType, _EntryNumber, _EntryCorAcc, _EntryPurposePayment, _EntryDebit, _EntryCredit,
                                  _EntryDate, _EntryPayAcc, _EntryRecAcc, _ExtSettleCodeID, _OtherKlirAcc, _CurrencyId, _ClientCode)
        var StatementAcc:string                             =   _StatementAcc,
        EntryCodeType:integer                               =   _EntryCodeType,
        EntryNumber:string                                  =   _EntryNumber,
        EntryCorAcc:string                                  =   _EntryCorAcc,
        EntryPurposePayment:string                          =   _EntryPurposePayment,
        EntryDebit:money                                    =   _EntryDebit,
        EntryCredit:money                                   =   _EntryCredit,
        EntryDate:date                                      =   _EntryDate,
        EntryPayAcc:string                                  =   _EntryPayAcc,
        EntryRecAcc:string                                  =   _EntryRecAcc,
        ExtSettleCodeID:string                              =   _ExtSettleCodeID,
        OtherKlirAcc:string                                 =   _OtherKlirAcc,
        CurrencyId:string                                   =   _CurrencyId,
        ClientCode:string                                   =   _ClientCode;

    macro Init()
        OtherKlirAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = EntryRecAcc = CurrencyId = ClientCode = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;

    macro InitRecords()
        StatementAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = ClientCode = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;
END;

private class DataRates()
  var TradeDate   :date,
      BoardType   :string,
      SecurityId  :string,
      SecurityType:string,
      Decimals    :integer,
      Volume      :integer,
      CurrencyId  :string,
      FaceUnit    :string,
      Low         :double,
      High        :double,
      WAPrice     :double,
      AccInt      :double,
      MarketPrice :double,
      BoardID     :string,
      MarketPrice3:double,
      MP3ValTrd   :double,
      PriceType   :string,
      FaceValue   :double;

  macro Init()
     MarketPrice = WAPrice      = AccInt     = High      = Low     = MarketPrice3 = MP3ValTrd = FaceValue = 0.0;
     SecurityId  = SecurityType = CurrencyId = FaceUnit = BoardType = BoardID = PriceType    = "";
     Decimals    = Volume       = 0;
     TradeDate   = date(0,0,0);
  end;

  macro InitRecords()
     MarketPrice = WAPrice      = AccInt     = High      = Low = MarketPrice3 = MP3ValTrd = FaceValue = 0.0;
     SecurityId  = SecurityType = CurrencyId = FaceUnit = PriceType = "";
     Decimals    = Volume       = 0;
  end;

end;

private class DataReq()
  var BuySell   :string,
      EntryTime :time,
      AmendTime :time,
      Status    :string,
      BrokerRef :string,
      ClientCode:string,
      OrderNo   :string,
      TradeDate :date,
      TradeSessionDate:date,
      RepoRate  :double,
      RecNo     :integer,
      SecurityId:string,
      Quantity  :money,
      Price     :double,
      PriceType :string,
      CurrencyId:string,
      TrdAccId  :string,
      RepoValue :money,
      IsTrust   :bool,
      IsSEB     :bool,
      OrdTypeCode:string,
      SessionNo :integer,
      FileSessionNo:integer,
      IsUnderWr :bool;

  macro Init()
      BuySell   = Status    = BrokerRef = OrderNo = SecurityId = ClientCode = PriceType = CurrencyId = TrdAccId = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = SessionNo = FileSessionNo = 0;
      RepoRate  = Price = 0.0;
      TradeDate = TradeSessionDate = date(0,0,0);
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = IsUnderWr = false;
  end;

  macro InitRecords()
      BuySell   = Status    = BrokerRef = OrderNo = SecurityId = ClientCode = PriceType = CurrencyId = TrdAccId = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = SessionNo = FileSessionNo = 0;
      RepoRate  = Price = 0.0;
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = IsUnderWr = false;
  end;

end;

private class DataComp()
  var ReportDate:date,
      RepoTradeNo:string,
      SettleDate:date,
      Direction:string,
      Value:money,
      Quantity:integer,
      ClientDetails:string,
      RecNo:integer;

  macro Init()
      RepoTradeNo = Direction = ClientDetails = "";
      Quantity = RecNo = 0;
      Value = $0.0;
      ReportDate = SettleDate = date(0,0,0);
  end;

  macro InitRecords()
      RepoTradeNo = Direction = ClientDetails = "";
      Quantity = RecNo = 0;
      Value = $0.0;
      SettleDate = date(0,0,0);
  end;

end;

private class DataPaym()
  var ReportDate:date,
      RepoTradeNo:string,
      RepoValueDate:date,
      PrincipalValue:money,
      CouponValue:money,
      ClientDetails:string,
      RecNo:integer,
      PaymentValue:money;

  macro Init()
      RepoTradeNo = ClientDetails = "";
      RecNo = 0;
      CouponValue = PrincipalValue = PaymentValue = $0.0;
      ReportDate = RepoValueDate = date(0,0,0);
  end;

  macro InitRecords()
      RepoTradeNo = ClientDetails = "";
      RecNo = 0;
      CouponValue = PrincipalValue = PaymentValue = $0.0;
      RepoValueDate = date(0,0,0);
  end;

end;

private class DataNettoItog()
  var DocNo:string,
      ReportDate:date,
      ExtCode:string,
      PosType:string,
      Currency:string,
      Debit:money, 
      Credit:money,
      NettoSum:money,
      LiabType:string;

  macro Init()
     DocNo = ExtCode = PosType = Currency = LiabType = "";
     ReportDate = date(0,0,0);
     Debit = Credit = NettoSum = $0.0;
  end;

  macro InitRecords()
     LiabType = "";
     Debit = Credit = NettoSum = $0.0;
  end;
end;

private class DataRepo(TradeNo_:string, Amount_:money, SettleDate_:date, AccInt2_:money, Price2_:double, Value_:money)
  var TradeNo:string  = TradeNo_,
      Amount2:money    = Amount_,
      SettleDate:date = SettleDate_,
      AccInt2:money   = AccInt2_,
      Price2:double   = Price2_,
      Value2_:money   = Value_;
end;

private class CPFirmData(TradeNo_:string, BuySell_:string, CPFirmID_:string)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      CPFirmId:string = CPFirmID_;
end;

private class CommData(TradeNo_:string, BuySell_:string, ClrComm_:money)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      ClrComm:money   = ClrComm_;
end;

private class SettleCodeData(TradeNo_:string, RepoPart_:string, SettleCode_:string)
  var TradeNo:string    = TradeNo_,
      RepoPart:string   = RepoPart_,
      SettleCode:string = SettleCode_;
end;

private class DataRepo_1(TradeNo_:string)
  var TradeNo:string  = TradeNo_;
end;

private class KsuData(SecurityId_:string)
  var SecurityId:string = SecurityId_;
end;

private class DataTrdAccId(TradeNo_:string, BuySell_:string, TrdAccId_:string)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      TrdAccId:string = TrdAccId_;
end;

private class DataExtSettlCodeEqm(TradeNo_:string, BuySell_:string, ExtSettlCodeEqm_:string)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      ExtSettlCodeEqm:string = ExtSettlCodeEqm_;
end;

private class DataKSU()
  var DocNo:string,
      ReportDate:date,
      OperationTime:time,
      ISIN:string,
      Debit:money,
      Credit:money,
      BankAccID:string,
      TrdAccID:string,
      SecurityId:string;

  macro Init()
     DocNo = ISIN = SecurityId = BankAccID = TrdAccID = "";
     ReportDate = date(0,0,0);
     OperationTime = time(0,0,0);
     Debit = Credit = $0.0;
  end;

  macro InitRecords()
     DocNo = "";
     OperationTime = time(0,0,0);
     Debit = Credit = $0.0;
  end;
end;

private class DataDividends()
  var DealType:integer,
      ReportDate:date,   
      TradeNO:string,        
      Ext_SettleCode:string, 
      ISIN:string,           
      Quantity:double,        
      Price:double,          
      D1:money,              
      D2:money,              
      Tax:money,            
      Sum:money,
      CurrencyId:string,
      RecordDate:date;             

  macro Init()
      DealType = 0;
      Ext_SettleCode = ISIN = CurrencyId = "";
      Tax = D1 = D2 = Sum = $0.0;
      Price = Quantity = 0.0;
      ReportDate = RecordDate = date(0, 0, 0);
  end;
END;

private class Data_file(data_filepath_:string, data_filename_:string, SessionNo_:integer, stat_:integer)
  var data_filepath:string  = data_filepath_,
      data_filename:string  = data_filename_,
      SessionNo:integer = SessionNo_,
      stat:integer = stat_;
end;

private var Rates = DataRates();
private var Req   = DataReq();
private var Comp  = DataComp();
private var Paym  = DataPaym();
private var MoneyMotion = DataMoneyMotion();
private var NettoItog   = DataNettoItog();
private var KSUWRT   = DataKSU();
private var Dividends = DataDividends();

private macro FileDate(date_val)
   var day, month, year;
   DateSplit(date_val,day,month,year);

   year = year - 1900;

   if( year >= 100 )
      year = year - 100;
   end;

   return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,2);
end;

/* настраиваемый пользователем макрос формирования
   имен файла котировок и сделок с госбумагами с ММВБ */
private macro get_data_file_name( folder:string, pfx:string, datafilepath:@string, datafilename:@string, comment_from_:string, SessionNo:integer, NoSayError:bool )
   var ErrStr = "", v_NoSayError = RG_IIF(NoSayError!=null,NoSayError,false);

/*ak
   datafilepath = GetRegImportDir("MICEX",@ErrStr);

   if( (ErrStr != "") or (ErrStr == null) )
      RGLog.Message( ErrStr );
      return 1;
   end;

   datafilepath = datafilepath + folder + "\\";*/
   datafilepath = GetRegImportDirU(imp_date, @ErrStr);
/*~ak*/

   var datafilemask = "???????_" + pfx;

   if( SessionNo != NULL )
      datafilemask = datafilemask + "_00" + String(SessionNo) + "_";
   elif( pfx == "SEM21" )
      datafilemask = datafilemask + "_00T_";
   else
      datafilemask = datafilemask + "_???_";
   end;

   datafilemask = datafilemask + FileDate(imp_date) + "_?????????" + ".xml";

   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      datafilename = "";
      if( v_NoSayError == false )
         if( (SessionNo != NULL) and (SessionNo == 2) )
            /*просто предупреждение (наличие, например, в утренней сессии необязательно)*/
            RGLog.Message( comment_from + "Не найден файл вечерней сессии по маске " + datafilepath + datafilemask);
         else
      RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
         end;
      else
         datafilename = datafilemask;
      end;
      if((pfx == "EQM13") OR ( pfx == "CCX99") )
        return List;
      end;
      return 1;
   elif( (pfx == "EQM13") OR ( pfx == "CCX99") )
      return List;
   else
        datafilename = List.name(0);
        if( v_NoSayError == false )
               RGLog.Message(comment_from + "Используется файл " + datafilename);
       end;
      return 0;
   end;

end;
/*KEA IS*/
private macro get_data_file_nameEQM6_002( folder:string, pfx:string, datafilepath:@string, datafilename:@string, comment_from_:string )
   var ErrStr = "";
   datafilepath = GetRegImportDirU(imp_date, @ErrStr);
/*~ak*/

   var datafilemask = "???????_" + pfx + "_002_" + FileDate(imp_date) + "_?????????" + ".xml";
   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      datafilename = "";
      RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      return 1;
   else
      return 0;
   end;

end;
 /*End KEA*/

/*ak*/
private macro get_data_file_name_list( folder:string, pfx:string, datafilepath:@string, datafilename:@tarray, comment_from_:string )
   var ErrStr = "";

   datafilepath = GetRegImportDirU(imp_date, @ErrStr);

   var datafilemask = "???????_" + pfx + "_???_" + FileDate(imp_date) + "_?????????" + ".xml";
   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      return 1;
   else
      var ilist = 0;
      while(ilist < List.Count)
        datafilename[datafilename.size] = List.name(ilist);
        ilist = ilist + 1;
      end;
      return 0;
   end;

end;
/*~ak*/

private macro PutMarketReport()
   if( (Deals.DOC_NO == "") OR (WriteMarketReport( SeanceID, NULL, SOURCE_CODE, @MarketReportID, @ErrMes, null, Deals.DOC_NO, imp_date, MMVB_Code ) == false) )
      AbortTrn;
   end; 
end;

private macro PutMoneyMotion()
   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   var ObjName = "", EntryNumber = "";

   if( MoneyMotion.EntryCodeType == 9999 )
      ObjName = String("Т/О по передаче дохода по РЕПО №" + MoneyMotion.EntryNumber + " на " + string(MoneyMotion.EntryDate));
      EntryNumber = MoneyMotion.EntryNumber + "_" + string(MoneyMotion.EntryDate);
   else
      ObjName = String("Движение денежных средств №" + MoneyMotion.EntryNumber);
      EntryNumber = MoneyMotion.EntryNumber;
   end;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_MONEYMOTION, 
                   ObjName,
                   Создать );

   if(NOT RG.InitByCode(RG_MONEYMOTION, EntryNumber, SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("CODETYPE", MoneyMotion.EntryCodeType);
   RG.SetParmByName("DEBIT", MoneyMotion.EntryDebit);
   RG.SetParmByName("CREDIT", MoneyMotion.EntryCredit);
   RG.SetParmByName("DATE", MoneyMotion.EntryDate);
   //RG.SetParmByName("EXTCODEID", MoneyMotion.ExtSettleCodeID); //Параметр EXTCODEID не используется при дальнейшей обработке
   RG.SetParmByName("EXT_SETTLECODE", MoneyMotion.ExtSettleCodeID);

   if( MoneyMotion.EntryCodeType == 9999 )
      RG.SetParmByName("NUMBER", MoneyMotion.EntryNumber);
      RG.SetParmByName("CURRENCYID", MoneyMotion.CurrencyID);
      RG.SetParmByName("CLIENTCODE", MoneyMotion.ClientCode);
   else
   RG.SetParmByName("ACCOUNT", MoneyMotion.StatementAcc);
   RG.SetParmByName("COR_ACC", MoneyMotion.EntryCorAcc);
   RG.SetParmByName("PAY_ACC", MoneyMotion.EntryPayAcc);
   RG.SetParmByName("REC_ACC", MoneyMotion.EntryRecAcc);
   RG.SetParmByName("PURPOSE_PAYMENT", MoneyMotion.EntryPurposePayment);
   RG.SetParmByName("OTHERKLIRACC", MoneyMotion.OtherKlirAcc);
   end;

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;

end;

private macro PutDividends()
   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_DIVIDENDS, 
                   RG_IIF(Dividends.DealType==ПолучДивидендовРЕПО,"Получение дивидендов по РЕПО №","") + Dividends.TradeNO,
                   Создать );

   if(NOT RG.InitByCode(RG_DIVIDENDS, Dividends.TradeNO, SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("DEALTYPE", Dividends.DealType);
   RG.SetParmByName("TRADENO", Dividends.TradeNO);
   RG.SetParmByName("REPORTDATE", Dividends.REPORTDate);
   RG.SetParmByName("EXT_SETTLECODE", Dividends.EXT_SETTLECODE);
   RG.SetParmByName("ISIN", Dividends.ISIN);
   RG.SetParmByName("QUANTITY", Dividends.QUANTITY);
   RG.SetParmByName("PRICE", Dividends.Price);
   RG.SetParmByName("D1", Dividends.D1);
   RG.SetParmByName("D2", Dividends.D2);
   RG.SetParmByName("TAX", Dividends.TAX);
   RG.SetParmByName("SUM", Dividends.SUM);
   RG.SetParmByName("CURRENCYID", Dividends.CurrencyId);
   RG.SetParmByName("RECORDDATE", Dividends.RecordDate);

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;

end;

// сделка подходит?
private macro IsFitDeal(IsTrust, IsSEB)
   if( (pp.deals_bo == SET_CHAR) and (not IsTrust) and (not IsSEB))
      return true;
   elif( (pp.deals_du == SET_CHAR) and IsTrust )
      return true;
   elif( (pp.deals_seb == SET_CHAR) and IsSEB )
      return true;
   end;
   return false;
end;

/* заполнение и сохранение внебиржевой сделки ПИ*/
private macro PutDVnDealInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   var ClientCode:string = "";
   var ClientID = 0, ClientContrID = 0;
   var ErrStr = "";
   var CPFirmId = -1, CurrencyId = -1, UINNumber = GetUINNumber();

   if(Deals.ClientCode != "")
      ClientCode = Deals.ClientCode;
   else
      GetClientCode(Deals.BrokerRef, @ClientCode);
   end;

   if( ClientCode != "" )
      if( GetRealID(RG_PARTY, ClientCode, PTCK_MICEX, @ClientID, @ErrStr, true, PTSK_DV, Deals.TradeDate, @ClientContrID, MarketID) != 0 )
         ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n"+ErrMes;
         Exit();
      end;
   end;

   RG.InitB(SeanceID,
            NULL,
            RG_DVNDEAL,/*Внебиржевая сделка с ПИ*/
            String("Внебирж. сделка с ПИ № " + UINNumber),
            Создать,
            NULL,
            NULL,
            ClientID
           );

   if( GetRealID(RG_PARTY, MICEX_CODE, Код_на_ММВБ_Субъект, @CPFirmId, @ErrMes) != 0 )
      ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n"+ErrMes;
      Exit();
   end;

   if( GetRealID(RG_CURRENCY, Deals.CurrencyId, Код_на_ММВБ_ФинИн, @CurrencyId, @ErrMes) != 0 )
      ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n"+ErrMes;
      Exit();
   end;

   /*Расчёт дней до даты исполнения*/
   var RGDVNDL_DAYBEFOREEXECUTE:Integer = 0;
   var calcDate:date = RG_GetDateAfterWorkDay(Deals.SettleDate,0,CurrencyId,CPFirmId);
   
   if( calcDate != Deals.SettleDate  )
     //Если день расчётов не рабочий, берём ближайший рабочий
     //И считаем сколько рабочих дней получилось от заключения сделки до планового исполнения
     RGDVNDL_DAYBEFOREEXECUTE = DL_GetNumWorkDaysForPeriod( Deals.TradeDate, calcDate, -1, CurrencyId, CPFirmId );     
   end;
                                                                                    
   if(NOT RG.InitByCode(RG_DVNDEAL, UINNumber, SOURCE_CODE) )
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Deals.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDVNDL_KIND",      ПокупкаПродажаT3);
   RG.SetParmByName("RGDVNDL_CODE",      Deals.RecNo);
   RG.SetParmByName("RGDVNDL_EXTCODE",   UINNumber);/*внешний код также как у сделок БОЦБ (чтобы клиринг, если потребуется, нашел сделку по внешнему коду)*/
   RG.SetParmByName("RGDVNDL_DATE",      Deals.TradeDate);
   RG.SetParmByName("RGDVNDL_TIME",      Deals.TradeTime);
   RG.SetParmByName("RGDVNDL_EXECDATE",  Deals.SettleDate);
   RG.SetParmByName("RGDVNDL_ISIN",      Deals.SecurityId);
   RG.SetParmByName("RGDVNDL_BUYSELL",   Deals.BuySell);
   RG.SetParmByName("RGDVNDL_AMOUNT",    Deals.Quantity);
   RG.SetParmByName("RGDVNDL_PRICE",     Deals.Price);
   RG.SetParmByName("RGDVNDL_COST",      Deals.Amount);
   RG.SetParmByName("RGDVNDL_PRICEFIID", Deals.CurrencyId);/*ВЦ,ВР*/
   RG.SetParmByName("RGDVNDL_POINT",     Deals.Decimals);
   RG.SetParmByName("RGDVNDL_NKD",       Deals.AccInt);
   RG.SetParmByName("RGDVNDL_PRICETYPE", Deals.PriceType);
   RG.SetParmByName("RGDVNDL_VALUE",     Deals.Value_);
   RG.SetParmByName("RGDVNDL_AMOUNT_COMM", Deals.ExhComm);

   if (RGDVNDL_DAYBEFOREEXECUTE > 0)
     RGLog.Message("Дата "+ Deals.SettleDate +", указанная в файле выгрузки, попадает на выходной день. Расчетная дата - " + calcDate );
     RG.SetParmByName("RGDVNDL_DAYBEFOREEXECUTE", RGDVNDL_DAYBEFOREEXECUTE);
   end;
  
   RG.SetParmByName("RGDVNDL_CLIENT", ClientCode );

   if(Deals.BrokerRef != "")
      RG.SetParmByName("RGDVNDL_BROKERREF", Deals.BrokerRef);
   end;

   RG.Save();
   SetErrAfterLoad();

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" +
                      "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError() );
      end;
   end;
end;

PRIVATE MACRO IsOutExchangeREPO():BOOL
  return ((Deals.BoardId == "RPNG") AND (Deals.InfType == 2));
END;

PRIVATE MACRO IsDealData():BOOL
  if( FileImport == FileSEM03 )
     return true;
  end;

  if( IsOutExchangeREPO() )
     return true;
  end;

  return false;
END;

PRIVATE MACRO IsDVnDealData():BOOL
  return ((FileImport == FileSEM03) and (ЗагружатьСделкувБОПИ(Deals.TradeType, Deals.TradeDate, Deals.SettleDate, @ErrMes)==true));
END;

PRIVATE MACRO IsCliringData():BOOL

  if( FileImport != FileEQM06 )
     return false;
  end;

  if(    ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи

      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 

      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО  
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 
    )
     return true;
  end;

  return false;
END;

private macro WriteDealData()
   VAR NoError = true;
   ErrMes = "";
   WarnMes = "";

   if( IsDealData() )
      if( NumImportDeals == 0 ) /*на первой сделке вставляем документ-основание*/
         if(ProcessTrn(0, "PutMarketReport"))
         else
            RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep );
         end;
         ErrMes = "";
      end;

      NumImportDeals = NumImportDeals + 1;
      Deals.IsCliring = false;

      if (ProcessTrn(0, IIF(IsDVnDealData(),"PutDVnDealInfo","PutDealInfo")) )
      else
         NoError = false;
         RG.UnInit();
      end;

      if( ErrMes != "" )
         RGLog.Error(ErrMes);
      end;

      if( WarnMes != "" )
         RGLog.Message(WarnMes);
      end;

      ErrMes = "";
      WarnMes = "";
   end;

   /* !!! В EQM06 одна запись может попаcть сразу в оба условия IsDealData и IsCliringData*/
   if( IsCliringData() )
      NumImportDealsCliring = NumImportDealsCliring + 1;
      Deals.IsCliring = true;
      if (ProcessTrn(0, "PutDealInfo") )
         Deals.IsCliring = false;
      else
         Deals.IsCliring = false;
         NoError = false;
         RG.UnInit();
      end;

      if( ErrMes != "" )
         RGLog.Error(ErrMes);
      end;

      if( WarnMes != "" )
         RGLog.Message(WarnMes);
      end;

      ErrMes = "";
      WarnMes = "";
   end;

   return NoError;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

/* обработка параметров котировки */
MACRO PutRateInfo()

   var strObject = "", MMVB_NumSection, SecType, CurRate;

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   if(Rates.TradeDate != date(0,0,0))
      strObject = String("Котировка финансового инструмента " + Rates.SecurityId + " на ") + string(Rates.TradeDate);
   else          
      strObject = String("Котировка финансового инструмента " + Rates.SecurityId + " на ") + string(imp_date);
   end;

   RG = TGTRecord(ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_RATE,
                  strObject,
                  Создать );

   if(NOT RG.InitByCode( RG_RATE, CodeRate, SOURCE_CODE ))
      AbortTRN;
   end;

   RG.SetParmByName( "RGFIRT_BOARDTYPE", Rates.BoardType);

   RG.SetParmByName( "RGFIRT_BOARDID", Rates.BoardID );

   RG.SetParmByName( "RGFIRT_ISIN_ISO", Rates.SecurityId );

   RG.SetParmByName( "RGFIRT_FOR_CB", SET_CHAR);

   RG.SetParmByName( "RGFIRT_RATEKIND", RateKind_ );

   if( ((RateKind_ == RATE_KIND_MARKET) or (RateKind_ == RATE_KIND_MARKET_TAX)) and (Rates.FaceUnit != "RUR") and (Rates.FaceUnit != "RUB") )
      SecType = StrUpr(Rates.SecurityType);
      if( SecType == "ОБ" )
         CurRate = Rates.FaceUnit;
      elif( (SecType == "АО") or (SecType == "АП") or (SecType == "ИП") or (SecType == "ИФ") or (SecType == "ДР") )
         CurRate = "RUR";
      else
         CurRate = Rates.CurrencyId;
      end;
   else
      CurRate = Rates.CurrencyId;
   end;
   RG.SetParmByName( "RGFIRT_CURR_RATE", CurRate);

   RG.SetParmByName( "RGFIRT_TCC_FLAG", -1);

   RG.SetParmByName( "RGFIRT_RATE_ISREALID", UNSET_CHAR);

   RG.SetParmByName( "RGFIRT_FINCODEKIND", Код_на_ММВБ_ФинИн);

   /* Признак: цена задана в процентах от номинала */
   if( (StrUpr(Rates.PriceType) == "PERC") and (RateKind_ != RATE_KIND_NKD1SEC) )
      RG.SetParmByName("RGFIRT_ISRELATIVE", SET_CHAR);
   else
      RG.SetParmByName("RGFIRT_ISRELATIVE", UNSET_CHAR);
   end;

   if( RateKind_ == RATE_KIND_MARKET ) /*вид котировки - рыночная цена, значит устанавливаем признак основного курса*/
      RG.SetParmByName( "RGFIRT_ISDOMINANT", "X");
   else
      RG.SetParmByName( "RGFIRT_ISDOMINANT", "");
   end;   
   RG.SetParmByName( "RGFIRT_ISINVERSE", UNSET_CHAR);
   RG.SetParmByName( "RGFIRT_SCALE", 1);

   if(Rates.TradeDate != date(0,0,0))
      imp_date = Rates.TradeDate;
   end;

   RG.SetParmByName( "RGFIRT_SINCEDATE", imp_date);

   if(RateKind_   == RATE_KIND_MARKET)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MarketPrice, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_MIN)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.Low, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_MAX)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.High, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_WA)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.WAPrice, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_NKD1SEC)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.AccInt, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_VOLUME)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.Volume, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_MARKET_TAX)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MarketPrice3, Rates.Decimals));
   end;

   if( RateKind_ == RATE_KIND_MARKET_TAX)
      RG.SetParmByName( "RGFIRT_MPVALTRD", Rates.MP3ValTrd);
   end;

   RG.SetParmByName( "RGFIRT_PARTYCODEKIND", Код_на_ММВБ_Субъект);

   RG.SetParmByName( "RGFIRT_MARKETPLACE", string(MMVB_Code));

   /*Сектор биржи*/
   if( MMVB_Code == MICEX_CODE_FB )
      MMVB_NumSection = СекторФонд;
   elif( MMVB_Code == MICEX_CODE )
      MMVB_NumSection = СекторГосЦБ;
   else
      MMVB_NumSection = 0;
   end;
   RG.SetParmByName( "RGFIRT_MARKETOFFICE", MMVB_NumSection);

   /*точность*/
   RG.SetParmByName("RGFIRT_POINT", Rates.Decimals);

   RG.SetParmByName( "RGFIRT_FACEVALUE", Rates.FaceValue);

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
END;

/* настраиваемый пользователем макрос формирования кода котировки ц/б в шлюзе*/
PRIVATE MACRO get_rate_cb_code( RateKind, RateMarketPlace )
   if(Rates.TradeDate != date(0,0,0))
      return string(Rates.SecurityId) + "_" + string(RateKind) + "_" + string(Rates.TradeDate) + "_" + string(RateMarketPlace) + "_" + string(Rates.BoardID);
   else
      return string(Rates.SecurityId) + "_" + string(RateKind) + "_" + string(imp_date) + "_" + string(RateMarketPlace) + "_" + string(Rates.BoardID);
   end;
END;

private macro WriteRateData(RateKind)

   ErrMes = "";
   NumImportRates = NumImportRates + 1;

   CodeRate = get_rate_cb_code( RateKind, string(MMVB_Code));
   RateKind_ = RateKind;

   if(ProcessTrn(0, "PutRateInfo") )
      NumImportRatesTotal = NumImportRatesTotal + 1;
      RGLog.Message( "Успешно загружена котировка \"" + CodeRate + "\"\n" + ErrMes, RG, SUCCESS );
      return true;
   else
      RGLog.Error( "Ошибка при загрузке котировки \"" + CodeRate + "\"\n" + ErrMes, RG  );
      return false;
   end;
   ErrMes = "";

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

private macro ДнейВГоду( YYYY:INTEGER ):INTEGER
   return DATE( 31,12,YYYY )-DATE( 1,1,YYYY )+1;
end;

private macro НайтиДанныеПо2Части(DataRepoArray:TArray, TradeNo1:string, SettleDate:date, Amount:money, RepoRate:@double,
                                  AccInt2:@money, Amount2:@money, Value2_:@money, Price2:@double)
   var i:integer = 0, N:double = 1.0;
   var YYYY_beg, YYYY_end, YYYY_cur;
   RepoRate = 0.0; AccInt2 = $0.0; Amount2 = $0.0; Value2_ = $0.0; Price2 = 0.0;
   while(i < DataRepoArray.size)
      if(DataRepoArray[i].TradeNo == TradeNo1)
         AccInt2 = DataRepoArray[i].AccInt2;
         Amount2 = DataRepoArray[i].Amount2;
         Value2_ = DataRepoArray[i].Value2_;
         Price2  = DataRepoArray[i].Price2;
         if(SettleDate != DataRepoArray[i].SettleDate)
            datesplit( SettleDate, NULL, NULL, YYYY_beg );
            datesplit( DataRepoArray[i].SettleDate, NULL, NULL, YYYY_end );
            if(YYYY_beg == YYYY_end)
               N = double(DataRepoArray[i].SettleDate - SettleDate) / double(ДнейВГоду(YYYY_beg));
            else
               YYYY_cur = YYYY_beg + 1;
               N = double(DATE(1,1,YYYY_cur) - SettleDate) / double(ДнейВГоду(YYYY_beg));
               while(YYYY_cur < YYYY_end)
                  N = N + 1;
                  YYYY_cur = YYYY_cur + 1;
               end;
               N = N + double(DataRepoArray[i].SettleDate - DATE(1,1,YYYY_cur)) / double(ДнейВГоду(YYYY_end));
            end;
         end;
         if((Amount * N) != 0.0)
            RepoRate = round(((DataRepoArray[i].Amount2 - Amount) / (Amount * N)) * 100, 4);
         end;
         break;
      end;
      i = i + 1;
   end;
end;

/*заполняем нулевые параметры AccInt2:@money, Amount2:@money, Value2_:@money, Price2 данными из файла клиринга*/
private macro ДозаполнитьРЕПО2ч(DataRepoArray:TArray, TradeNo1:string,
                                AccInt2:@money, Amount2:@money, Value2_:@money, Price2:@double)
   var i:integer = 0;

   while(i < DataRepoArray.size)

      if(DataRepoArray[i].TradeNo == TradeNo1)

         if( AccInt2 == $0.0 )
            AccInt2 = DataRepoArray[i].AccInt2;
         end;

         if( Amount2 == $0.0 )
            Amount2 = DataRepoArray[i].Amount2;
         end;

         if( Value2_ == $0.0 )
            Value2_ = DataRepoArray[i].Value2_;
         end;

         if( Price2 == 0.0 )
            Price2  = DataRepoArray[i].Price2;
         end;

         break;

      end;

      i = i + 1;

   end;

end;

private macro СкорректироватьТоргСчет(DataTrdAccIdArray:TArray, TradeNo:string, BuySell:string, TrdAccId:@string)
   var i:integer = 0;
   while(i < DataTrdAccIdArray.size)
      if( (DataTrdAccIdArray[i].TradeNo == TradeNo) and (DataTrdAccIdArray[i].BuySell == BuySell) )
         if( TrdAccId != DataTrdAccIdArray[i].TrdAccId )
            TrdAccId = DataTrdAccIdArray[i].TrdAccId;
         end;
         break;
      end;
      i = i + 1;
   end;
end;

/*
private macro ЗаполнитьДругойКлирСчет(DataOtherSchema:TArray, EntryDebit:money, EntryCredit:money, EXTSettleCodeID:integer, EntryDate:date, EntryCodeType:integer, EntryPurposePayment:string, OtherAccount:@string)
    var i:integer = 0;

    while(i < DataOtherSchema.Size)
        if( ( (DataOtherSchema[i].EntryDebit == EntryDebit) OR (DataOtherSchema[i].EntryCredit ==  EntryCredit) ) and (DataOtherSchema[i].ExtSettleCodeID == EXTSettleCodeID) and (DataOtherSchema[i].EntryDate == EntryDate) and (DataOtherSchema[i].EntryCodeType == EntryCodeType) and (DataOtherSchema[i].EntryPurposePayment == EntryPurposePayment))
            OtherAccount = DataOtherSchema[i].StatementAcc;
            break;
        end;
        i = i + 1;
    end;
end;
*/

private macro ЗаполнитьДругойКлирСчет(DataOtherSchema:TArray, EntryCredit:money, EXTSettleCodeID:integer, EntryDate:date, EntryCodeType:integer, EntryPurposePayment:string, OtherAccount:@string)
    var i:integer = 0;

    while(i < DataOtherSchema.Size)
        if((DataOtherSchema[i].EntryDebit == EntryCredit) /*and (DataOtherSchema[i].ExtSettleCodeID == EXTSettleCodeID)*/ and (DataOtherSchema[i].EntryDate == EntryDate) and (DataOtherSchema[i].EntryCodeType == EntryCodeType) and 
           (substr(DataOtherSchema[i].EntryPurposePayment,1,strlen(DataOtherSchema[i].EntryPurposePayment)-1) == substr(EntryPurposePayment,1,strlen(EntryPurposePayment)-1)))
            OtherAccount = DataOtherSchema[i].StatementAcc;
            break;
        end;
        i = i + 1;
    end;
end;


private macro ЗаполнитьКонтрагентаДляРПС(DataContrSEM03Array:TArray, TradeNo:string, BuySell:string, CPFirmId:@string)
   var i:integer = 0;

   while(i < DataContrSEM03Array.size)
      if( (DataContrSEM03Array[i].TradeNo == TradeNo) and (DataContrSEM03Array[i].BuySell == BuySell) )
         CPFirmId = DataContrSEM03Array[i].CPFirmId;
         break;
      end;
      i = i + 1;
   end;
end;

private macro ЗагрузитьКомиссииПо1ч(DataCommArray:TArray, TradeNo:string, BuySell:string, CLRCOMM:@money)
   var i:integer = 0;

   while(i < DataCommArray.size)
      if( (DataCommArray[i].TradeNo == TradeNo) and (DataCommArray[i].BuySell == BuySell) )
         CLRCOMM = DataCommArray[i].CLRCOMM;
         break;
      end;
      i = i + 1;
   end;
end;

private macro ЗагрузитьРасчетныйКодИзЕКМ(DataExtSettlCodeEqmArray:TArray, TradeNo:string, BuySell:string, ExtSettlCodeEqm:@string)
   var i:integer = 0;

   while(i < DataExtSettlCodeEqmArray.size)
      If(valtype(DataExtSettlCodeEqmArray[i]) != V_undef)
      if( (DataExtSettlCodeEqmArray[i].TradeNo == TradeNo) and (DataExtSettlCodeEqmArray[i].BuySell == BuySell) )
         ExtSettlCodeEqm = DataExtSettlCodeEqmArray[i].ExtSettlCodeEqm;
         break;
      end;
      end;
      i = i + 1;
   end;
end;


private macro НевнутридневноеРЕПО(DataRepoArray:TArray, TradeNo1:string)
   var i:integer = 0, ret = true;
   while(i < DataRepoArray.size)
      if(DataRepoArray[i].TradeNo == TradeNo1)
         ret = false;
         break;
      end;
      i = i + 1;
   end;
   return ret;
end;

/*Поле BrokerRef - заполняется трейдером. Как правило: <код клиента>/<номер поручения>*/
PRIVATE MACRO GetClientCode_Req(BrokerRef:string):STRING
  var ClientCode = "", ClientCodeEndPos = 0;

  ClientCode = BrokerRef;
  if( ClientCode != "" )
     ClientCodeEndPos = Index( ClientCode, "/" );
     if( ClientCodeEndPos != 0 ) 
        ClientCode = SubStr( ClientCode, 1, ClientCodeEndPos-1 );
     else
        ClientCode = "";
     end; 
  end;
  return ClientCode;
END;

private macro ЗагрузитьКодРасчетов2ч(DataSettleCode2Array:TArray, TradeNo:string, SettleCode2:@string)
   var i:integer = 0;

   while(i < DataSettleCode2Array.size)
      if( (DataSettleCode2Array[i].TradeNo == TradeNo) and (DataSettleCode2Array[i].RepoPart == 2) )
         SettleCode2 = DataSettleCode2Array[i].SettleCode;
         break;
      end;
      i = i + 1;
   end;
end;

private macro ЗаполнитьКсуДляРЕПО(DataKsuSEM03Array:TArray, SecurityId:string, SecurityType:@string)
   var i:integer = 0;

   while(i < DataKsuSEM03Array.size)
      if( DataKsuSEM03Array[i].SecurityId == SecurityId )
         SecurityType = "ксу";
         break;
      end;
      i = i + 1;
   end;
end;

/* получение данных о заявке */
PRIVATE MACRO PutRequestInfo()
   VAR ClientID = 0, ClientContrID = 0;
   VAR ErrStr = "";
   var UnderWr:bool = false, UnderWr_Pokupka:bool = false;

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   if(Req.ClientCode != "")
      if(GetRealID(RG_PARTY, Req.ClientCode, PTCK_MICEX, @ClientID, @ErrStr, true, PTSK_STOCKDL, Req.TradeDate, @ClientContrID, MarketID) != 0)
         ErrMes = "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\n" + ErrStr;
         RG = NULL;
         Exit();
      end;
   end;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_REQUEST, 
                   String("Заявка на сделку №" + Req.OrderNo),
                   Создать,
                   NULL,
                   NULL,
                   ClientID );

   if(NOT RG.InitByCode(RG_REQUEST, Req.OrderNo + "_" + string(Req.FileSessionNo), SOURCE_CODE) )
      Exit();
   end;

   if( strlen(trim(string(Req.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLRQ_KIND",       350/*DOCKIND_REQ_CLIENT_DEAL*/);
   RG.SetParmByName("RGDLRQ_CODE",       Req.OrderNo);
   RG.SetParmByName("RGDLRQ_CODETS",     Req.OrderNo);
   RG.SetParmByName("RGDLRQ_DATE",       Req.TradeDate);
   if((Req.TradeSessionDate != date(0,0,0)) and (Req.TradeSessionDate != Req.TradeDate))
      RG.SetParmByName("RGDLRQ_SESSIONDATE", Req.TradeSessionDate);         
   end;
   RG.SetParmByName("RGDLRQ_TIME",       Req.EntryTime);
   RG.SetParmByName("RGDLRQ_PARTY",      MMVB_Code);
   RG.SetParmByName("RGDLRQ_BUYSALE",    Req.BuySell);
   RG.SetParmByName("RGDLRQ_FIID",       Req.SecurityId); 
   RG.SetParmByName("RGDLRQ_AMOUNT",     Req.Quantity);
   RG.SetParmByName("RGDLRQ_PRICE",      Req.Price);
   RG.SetParmByName("RGDLRQ_REPORATE",   Req.RepoRate);
   RG.SetParmByName("RGDLRQ_STATUS",     Req.Status);
   RG.SetParmByName("RGDLRQ_PRICETYPE",  Req.PriceType);
   RG.SetParmByName("RGDLRQ_CURRENCYID", Req.CurrencyId);
   RG.SetParmByName("RGDLRQ_PRICEFIID",  Req.CurrencyId); // валюта цены = валюте расчетов
   RG.SetParmByName("RGDLRQ_ORDTYPECODE",Req.OrdTypeCode);
   RG.SetParmByName("RGDLRQ_GRNDNUM",    ""+Req.SessionNo+Req.RecNo);

   var ClientCode:string = "";
   ClientCode = GetClientCode_Req(Req.BrokerRef);
   if( ClientCode == "" )
      ClientCode = Req.ClientCode;
   end;
   RG.SetParmByName("RGDLRQ_CLIENT", ClientCode);

   // Golovkin кот трейдера
   var TraderCode:string = "";
   TraderCode = GetRefNote(Req.BrokerRef);
   if(TraderCode == "spec")
      TraderCode = "";
   end;
   RG.SetParmByName("RGDLRQ_TRADERCODE", TraderCode);

   if( Req.BrokerRef != "" )
      RG.SetParmByName("RGDLRQ_BROKERREF", Req.BrokerRef);
   end;

   RG.SetParmByName("RGDLRQ_TRDACCID",   Req.TrdAccID);

   //Проверим субдоговор клиента на принадлежность к услугам агента (андеррайтингу) 
   GetIdUnderWrDO(ClientContrID, @UnderWr, @UnderWr_Pokupka);
   Req.IsUnderWr = (UnderWr or UnderWr_Pokupka); 
   if(Req.IsUnderWr)
      RG.SetParmByName("RGDLRQ_UNDERWR", SET_CHAR);
   end;

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

PRIVATE MACRO import_request_to_gate_SEM02(datafilename:STRING,filename_SEM02:STRING,filename_session_number:INTEGER):INTEGER

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem02:object, child_Firm:object,
       child_Board:object, child_Activationdate:object, child_Session:object;
   var DOC_REQUISITES = false, SEM02 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0, n=0;
   var stat:integer = 0;
   var NumImportReq:integer = 0, NumImportReqTotal:integer = 0;

   private macro IdentIsSEB()
      if( (Req.RepoValue == $0.0)
      AND (not Req.IsTrust)
      AND ((Req.BuySell == "B") OR (Req.BuySell == "S"))
      AND (Req.ClientCode == "")
      AND (GetClientCode_Req(Req.BrokerRef) == "") )
         if( PrevISIN != Req.SecurityId )
            ClearRecord(issues);
            ClearRecord(fin);
            RG_GetAvoirByISIN(Req.SecurityId,Код_на_ММВБ_ФинИн,issues,fin);
            PrevISIN = Req.SecurityId;
         end;
         if( fin.Issuer == {OurBank} )
            Req.IsSEB = true;
         end;
      end;
   end;

   private macro RunImp()
      ErrMes = "";

      NumImportReq = NumImportReq + 1;

      if(ProcessTrn( 0, "PutRequestInfo"))
         NumImportReqTotal = NumImportReqTotal + 1;
         RGLog.Message( "Заявка с кодом \"" + Req.OrderNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
      else
         RGLog.Error( "Ошибка при загрузке заявки с кодом \"" + Req.OrderNo + "\"\n" + ErrMes, RG );
         return 1;
      end;
      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   Req.Init();

   NumImportReq = 0;
   NumImportReqTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры заявок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM02")
            if(SEM02)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM02 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM02 = true;
            Req.TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Req.TradeDate) == false)
               /* если не нашли дату предоставления информации */
            end;

            Req.TradeSessionDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADESESSIONDATE", V_DATE, Req.TradeSessionDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            n = 0;
            while (n < child_MicexDoc.childNodes.length)
               child_Sem02 = child_MicexDoc.childNodes.item(n);
               if(child_Sem02 and (child_Sem02.nodeType==CHILD_NODE))
                  if (child_Sem02.tagname == "SESSION")
                     FIRM = false;

                     var SessionNo = -1;
                     ReadTagAttribut(child_Sem02, "SESSIONNO", V_INTEGER, SessionNo);

                     j = 0;
                     while(j<child_Sem02.childNodes.length) /* бегаем по SESSION */
                        child_Session = child_Sem02.childNodes.item(j);
                        if(child_Session and (child_Session.nodeType==CHILD_NODE))

                           if(child_Session.tagname == "FIRM")
                              if(FIRM)
                                 RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM02\SESSION\FIRM должен присутствовать в единственном экземпляре"));
                                return false;
                              end;
                              FIRM = true;
                              k=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Session.childNodes.length, "Загрузка внешнего файла заявок", "Просмотр режимов торгов...");
                              end;
                              while(k<child_Session.childNodes.length) /* бегаем по FIRM */
                                 child_Firm = child_Session.childNodes.item(k);
                                 if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                          
                                    if(child_Firm.tagname == "BOARD")
                                       l=0;
                                       while(l<child_Firm.childNodes.length) /* бегаем по BOARD */
                                          child_Board = child_Firm.childNodes.item(l);
                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                          
                                             if(child_Board.tagname == "ACTIVATIONDATE")
                                                m=0;
                                                if(GetDialogFlag())
                                                   InitProgress(child_Board.childNodes.length, "Загрузка внешнего файла заявок", "Просмотр записей заявок...");
                                                end;
                                                while(m<child_Board.childNodes.length) /* бегаем по ACTIVATIONDATE */
                                                   child_Activationdate = child_Board.childNodes.item(m);
                                                   if(child_Activationdate and (child_Activationdate.nodeType==CHILD_NODE))
                          
                                                      if(child_Activationdate.tagname == "RECORDS")
                                                         Req.InitRecords();
                          
                                                         ReadTagAttribut(child_Activationdate, "STATUS", V_STRING, Req.Status);
                          
                                                         Req.SessionNo = SessionNo;
                                                         Req.FileSessionNo = filename_session_number;
                                                         ReadTagAttribut(child_Activationdate, "BUYSELL",    V_STRING,  Req.BuySell);
                                                         ReadTagAttribut(child_Activationdate, "ENTRYTIME",  V_TIME,    Req.EntryTime);
//                                                         ReadTagAttribut(child_Activationdate, "TRADETIME",  V_TIME,    Req.TradeTime);
                                                         ReadTagAttribut(child_Activationdate, "AMENDTIME",  V_TIME,    Req.AmendTime);
                                                         ReadTagAttribut(child_Activationdate, "BROKERREF",  V_STRING,  Req.BrokerRef);
                                                         ReadTagAttribut(child_Activationdate, "ORDERNO",    V_STRING,  Req.OrderNo);
                                                         ReadTagAttribut(child_Activationdate, "REPORATE",   V_DOUBLE,  Req.RepoRate);
                                                         ReadTagAttribut(child_Activationdate, "RECNO",      V_INTEGER, Req.RecNo);
                                                         ReadTagAttribut(child_Activationdate, "SECURITYID", V_STRING,  Req.SecurityId);
                                                         ReadTagAttribut(child_Activationdate, "QUANTITY",   V_MONEY,   Req.Quantity);
                                                         ReadTagAttribut(child_Activationdate, "PRICE",      V_DOUBLE,  Req.Price);
                                                         ReadTagAttribut(child_Activationdate, "CLIENTCODE", V_STRING,  Req.ClientCode);
                                                         ReadTagAttribut(child_Activationdate, "PRICETYPE",  V_STRING,  Req.PriceType);
                                                         ReadTagAttribut(child_Activationdate, "CURRENCYID", V_STRING,  Req.CurrencyId);
                                                         ReadTagAttribut(child_Activationdate, "TRDACCID",   V_STRING,  Req.TrdAccId);
                                                         ReadTagAttribut(child_Activationdate, "REPOVALUE",  V_MONEY,   Req.RepoValue);
                                                         ReadTagAttribut(child_Activationdate, "ORDTYPECODE",  V_STRING,  Req.OrdTypeCode);

                                                         /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                         if(SubStr(Req.TrdAccId,1,1) == "D")
                                                            Req.IsTrust = true;
                                                         end;
                                                         IdentIsSEB();
                          
                                                         if( IsFitDeal(Req.IsTrust, Req.IsSeb) and (Index(GetRefNote(Req.BrokerRef), "mc") == 0) ) //biq-9103 поручения Margin Call не загружаем
                                                            if( RunImp() )
                                                               stat = 1;
                                                            end;
                                                         end;
                                                      end;
                          
                                                   end;
                                                   m = m + 1;
                                                   if(GetDialogFlag())
                                                      UseProgress(m);
                                                   end;
                                                   if( FlagCtrlBrk == true )
                                                      break;
                                                   end;
                                                end;
                                                if(GetDialogFlag())
                                                   RemProgress(); 
                                                end;
                                             end;
                          
                                          end;
                                          l = l + 1;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                    end;
                          
                                 end;
                                 k = k + 1;
                                 if(GetDialogFlag())
                                    UseProgress(k);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress(); 
                              end;
                           end;

                        end;
                        j = j + 1;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                  end;
               end;

               n = n + 1;
               if (FlagCtrlBrk == true)
                  break;
               end;
            end;
         end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано заявок из "+string(filename_SEM02)+" - " + string(NumImportReq) + "\nиз них успешно - " + string(NumImportReqTotal) + "\nошибочно - " + string(NumImportReq - NumImportReqTotal));

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro import_rates_to_gate_from_SEM21( datafilename )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem21:object, child_SessionNo:object, child_Board:object;
   var DOC_REQUISITES = false, SEM21 = false, SessionNo:integer = -1;
   var i=0, j=0, k=0, s=0;
   var stat:integer = 0;

   private macro RunImp(RateKind)
      /* сохранение информации о курсе в промежуточном файле */
      if(WriteRateData(RateKind) != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   Rates.Init();

   NumImportRates = 0;
   NumImportRatesTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры котировок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM21")
            if(SEM21)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM21 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM21 = true;
            Rates.TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Rates.TradeDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM21 */
               child_Sem21 = child_MicexDoc.childNodes.item(j);
               if(child_Sem21 and (child_Sem21.nodeType==CHILD_NODE))
                  if(child_Sem21.tagname == "SESSION")
                     SessionNo = -1;
                     ReadTagAttribut(child_Sem21, "SESSIONNO", V_INTEGER, SessionNo);
                     if ((0 <= SessionNo) and (SessionNo <= 3))
                        s=0;
                        if(GetDialogFlag())
                           InitProgress(child_Sem21.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр режимов торгов...");
                        end;
                        while(s<child_Sem21.childNodes.length) /* бегаем по SESSION */
                           child_SessionNo = child_Sem21.childNodes.item(s);
                           if(child_SessionNo and (child_SessionNo.nodeType==CHILD_NODE))
                              if(child_SessionNo.tagname == "BOARD")
                      Rates.BoardID = "";
                                  if(ReadTagAttribut(child_SessionNo, "BOARDID", V_STRING, Rates.BoardID) == false)
                         /* если не нашли идентификатор режима торгов */
                      end;
                      Rates.BoardType = "";
                                  if(ReadTagAttribut(child_SessionNo, "BOARDTYPE", V_STRING, Rates.BoardType) == false)
                         /* если не нашли режим торгов */
                      end;
                      if((Rates.BoardType == "MAIN"/*если основной режим торгов*/)
                      or (/*(эмитент ц/б == {OurBank}) and*/ ((Rates.BoardID == "PSAU") or (Rates.BoardID == "PSBB") or (Rates.BoardID == "AUBB") or (Rates.BoardID == "AUCT")))) 
                          k=0;
                          if(GetDialogFlag())
                                         InitProgress(child_SessionNo.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр записей котировок...");
                          end;
                                      while(k<child_SessionNo.childNodes.length) /* бегаем по BOARD */
                                         child_Board = child_SessionNo.childNodes.item(k);
                             if(child_Board and (child_Board.nodeType==CHILD_NODE))

                                 if(child_Board.tagname == "RECORDS")
                                     Rates.InitRecords();
                                     if(ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Rates.SecurityId) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "SECURITYTYPE", V_STRING, Rates.SecurityType) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "DECIMALS", V_INTEGER, Rates.Decimals) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "VOLUME", V_INTEGER, Rates.Volume) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "CURRENCYID", V_STRING, Rates.CurrencyId) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "FACEUNIT", V_STRING, Rates.FaceUnit) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "LOW", V_DOUBLE, Rates.Low) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "HIGH", V_DOUBLE, Rates.High) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "WAPRICE", V_DOUBLE, Rates.WAPrice) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "ACCINT", V_DOUBLE, Rates.AccInt) == false)
                                        /* если не нашли  */
                                     end;
                                     /*MarketPrice3 загружаем и в курс <Рыночная цена для НДФЛ> и в курс <Рыночная цена>*/
                                     if(ReadTagAttribut(child_Board, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice3) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "MP3VALTRD", V_DOUBLE, Rates.MP3ValTrd) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "PRICETYPE", V_STRING, Rates.PriceType) == false)
                                        /* если не нашли тип цены */
                                     end;
                                     if(ReadTagAttribut(child_Board, "FACEVALUE", V_DOUBLE, Rates.FaceValue) == false)
                                        /* если не нашли  */
                                     end;
                                     if(RunImp(RATE_KIND_MARKET))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_MIN))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_MAX))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_WA))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_NKD1SEC))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_VOLUME))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_MARKET_TAX))
                                        stat = 1;
                                     end;
                                 end;
                             end;
                             k = k + 1;
                             if(GetDialogFlag())
                                UseProgress(k);
                             end;
                             if( FlagCtrlBrk == true )
                                break;
                             end;
                          end;
                          if(GetDialogFlag())
                             RemProgress(); 
                          end;
                      end;
                  end;
               end;
                           s = s + 1;
               if(GetDialogFlag())
                              UseProgress(s);
               end;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
            if(GetDialogFlag())
               RemProgress(); 
            end;
         end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано котировок - " + string(NumImportRates) + "\nиз них успешно - " + string(NumImportRatesTotal) + "\nошибочно - " + string(NumImportRates - NumImportRatesTotal));

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/*ДЛя заключенных сделок РПС контрагента по сделке берем из файла исполненных сделок
  сделку ищем по параметрам TradeNo, BuySell*/
private macro GetContrFromEQM06(DataContrSEM03Array:@TArray, datafilename_EQM06:string)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "";
   var PartyCode = "";
   var stat:integer = 0;
   var v=0, h=0, y=0;

   if(GetDialogFlag())
      InitProgress(-1, "Поиск контрагента по сделке РПС в файле исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "SETTLE")
                              y=0;
                              while(y<child_Firm.childNodes.length) /* бегаем по SETTLE */
                                 child_Settle = child_Firm.childNodes.item(y);
                                 if(child_Settle and (child_Settle.nodeType==CHILD_NODE))
                                    if(child_Settle.tagname == "CURRENCY")
                              l=0;
                                       while(l<child_Settle.childNodes.length) /* бегаем по CURRENCY */
                                          child_Currency = child_Settle.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       q=0;
                                       while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                          child_InfType = child_Currency.childNodes.item(q);
                                          if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                             if(child_InfType.tagname == "CLEARINGTYPE")
                                                w=0;
                                                while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                   child_ClearingType = child_InfType.childNodes.item(w);
                                                   if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                      if(child_ClearingType.tagname == "SESSION")
                                                         e=0;
                                                         while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                            child_Session = child_ClearingType.childNodes.item(e);
                                                            if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                               if(child_Session.tagname == "SETTLEDATE")
                                                                  t=0;
                                                                  while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                     child_Settledate = child_Session.childNodes.item(t);
                                                                     if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                        if(child_Settledate.tagname == "INSTRTRADE")
                                                                           h=0;
                                                                           while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                              child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                              if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                 if(child_InstrTrade.tagname == "BOARD")
                                                                                    m=0;
                                                                                    while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                       child_Board = child_InstrTrade.childNodes.item(m);
                                                                                       if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                          if(child_Board.tagname == "SECURITY")
                                                                                             s=0;
                                                                                             while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                child_Security = child_Board.childNodes.item(s);
                                                                                                if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                   if(child_Security.tagname == "RECORDS")
                                                                                                      TradeNo = "";
                                                                                                      if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                      end;
                                                                        
                                                                                                      BuySell = "";
                                                                                                      if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                                                      end;
                                                                        
                                                                                                      v = 0;
                                                                                                      while( v < DataContrSEM03Array.size )
                                                                                                         if( (TradeNo == DataContrSEM03Array[v].TradeNo) AND (BuySell == DataContrSEM03Array[v].BuySell)  )
                                                                                                            PartyCode = "";
                                                                                                            if(ReadTagAttribut(child_Security, "CPFIRMID", V_STRING, PartyCode) == false)
                                                                                                                /* если не нашли идентификатор фирмы партнера */
                                                                                                            end;
                                                                        
                                                                                                            if( (PartyCode != null) and (PartyCode != "") )
                                                                                                               DataContrSEM03Array[v].CPFIRMID = PartyCode;
                                                                                                            end;
                                                                                                         end;
                                                                                                         v = v + 1;
                                                                                                      end;
                                                                        
                                                                                                   end;
                                                                                                end;
                                                                                                s = s + 1;
                                                                                             end;
                                                                                          end;
                                                                                       end;
                                                                                       m = m + 1;
                                                                                    end;
                                                                                 end;
                                                                              end;
                                                                              h = h + 1;
                                                                           end;
                                                                        end;
                                                                     end;
                                                                     t = t + 1;
                                                                  end;
                                                               end;
                                                            end;
                                                            e = e + 1;
                                                         end;
                                                      end;
                                                   end;
                                                   w = w + 1;
                                                end;
                                             end;
                                          end;
                                          q = q + 1;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                                 y = y + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/*здесь собираем комиссии и информацию по торговым счетам по сделкам (1 частям) и заодно
  суммовые параметры по секции InfType == (3, 6) по 2 частям РЕПО*/
private macro GetCommFromEQM06(DataCommArray:@TArray, DataRepoArray:@TArray, DataTrdAccIdArray:@TArray, DataExtSettlCodeEqmArray:@TArray, datafilename_EQM06:string)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0, y=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "", TrdAccId:string = "";
   var stat:integer = 0;
   var RepoPart:integer = 0;
   var ClrComm = $0.0;
   var ExtSettlcodeeqm = "";

   var Amount:money = $0.0, AccInt2:money = $0.0, Price2:double = $0.0, Value_:money = $0.0;

   if(GetDialogFlag())
      InitProgress(-1, "Сбор данных по комиссиям из файла исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "SETTLE")
                              y=0;
      	                    ExtSettlcodeeqm = child_Firm.attributes.item(y).nodevalue;
                              while(y<child_Firm.childNodes.length) /* бегаем по SETTLE */
                                 child_Settle = child_Firm.childNodes.item(y);
                                 if(child_Settle and (child_Settle.nodeType==CHILD_NODE))
                                    if(child_Settle.tagname == "CURRENCY")
                                       l=0;
                                       while(l<child_Settle.childNodes.length) /* бегаем по CURRENCY */
                                          child_Currency = child_Settle.childNodes.item(l);
                                          if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                             if(child_Currency.tagname == "INFTYPE")
                                                InfType = 0;
                                                if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                                end;
                                                if( (InfType == 2) OR (InfType == 3) OR (InfType == 6) )
                                                   q=0;
                                                   while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                                      child_InfType = child_Currency.childNodes.item(q);
                                                      if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                         if(child_InfType.tagname == "CLEARINGTYPE")
                                                            w=0;
                                                            while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                               child_ClearingType = child_InfType.childNodes.item(w);
                                                               if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                                  if(child_ClearingType.tagname == "SESSION")
                                                                     e=0;
                                                                     while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                                        child_Session = child_ClearingType.childNodes.item(e);
                                                                        if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                           if(child_Session.tagname == "SETTLEDATE")
                                                                              t=0;
                                                                              while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                                 child_Settledate = child_Session.childNodes.item(t);
                                                                                 if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                                    if(child_Settledate.tagname == "INSTRTRADE")
                                                                                       h=0;
                                                                                       while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                          child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                          if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                             if(child_InstrTrade.tagname == "BOARD")
                                                                                                m=0;
                                                                                                while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                                   child_Board = child_InstrTrade.childNodes.item(m);
                                                                                                   if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                                      if(child_Board.tagname == "SECURITY")
                                                                                                         s=0;
                                                                                                         while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                            child_Security = child_Board.childNodes.item(s);
                                                                                                            if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                               if(child_Security.tagname == "RECORDS")
                                                                                                                  RepoPart = 0;
                                                                                                                  if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                                  end;
                                                                                                                        
                                                                                                                  if(ReadTagAttribut(child_Security, "CLRCOMM", V_MONEY, ClrComm) == false)
                                                                                                                  end;
                                                                                           
                                                                                                                  if( (RepoPart == 0) OR (RepoPart == 1) )
                                                                                                                     TradeNo = "";
                                                                                                                     if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                                     end;
                                                                                                                     BuySell = "";
                                                                                                                     if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                                                                     end;
                                                                                                                     TrdAccId = "";
                                                                                                                     if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                                                                     end;
                                                                                                                     if( (TradeNo != "") AND (BuySell != "") )
                                                                                                                        if( TrdAccId != "" )
                                                                                                                           DataTrdAccIdArray[DataTrdAccIdArray.size] = DataTrdAccId(TradeNo,BuySell,TrdAccId);
                                                                                                                        end;
                                                                                                                        if( ClrComm > $0.0 )
                                                                                                                           DataCommArray[DataCommArray.size] = CommData(TradeNo,BuySell,ClrComm);
                                                                                                                        end;
                                                                                                                        if( ExtSettlcodeeqm != "" )
                                                                                                                           DataExtSettlcodeeqmArray[DataExtSettlcodeeqmArray.size] = DataExtSettlcodeeqm(TradeNo,BuySell,ExtSettlcodeeqm);
                                                                                                                        end;
                                                                                                                     end;
                                                                                                                  end;
                                                                                                                  /*суммовые параметры по секции InfType == (3, 6) по 2 частям РЕПО
                                                                                                                    эти суммы вместо незаполненных по 2 части пойдут в ЗР по сделке*/
                                                                                                                  if( (RepoPart == 2) and ((InfType == 3) or (InfType == 6)) )
                                                                                                                     TradeNo = "";
                                                                                                                     if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                                     end;
                                                                                                                     Amount = $0.0;
                                                                                                                     if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Amount) == false)
                                                                                                                     end;
                                                                                                                     AccInt2 = $0.0;
                                                                                                                     if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, AccInt2) == false)
                                                                                                                     end;
                                                                                                                     Price2 = 0.0;
                                                                                                                     if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Price2) == false)
                                                                                                                     end;
                                                                                                                     Value_ = $0.0;
                                                                                                                     if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Value_) == false)
                                                                                                                     end;
                                                                                                                     /* вытащили все данные */
                                                                                                                     DataRepoArray[DataRepoArray.size] = DataRepo(TradeNo, Amount, Date(0,0,0), AccInt2, Price2, Value_);
                                                                                                                  end;
                                                                                                               end;
                                                                                                            end;
                                                                                                            s = s + 1;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   m = m + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          h = h + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 t = t + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        e = e + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               w = w + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      q = q + 1;
                                                   end;
                                                end;
                                             end;
                                          end;
                                          l = l + 1;
                                       end;
                                    end;
                                 end;
                                 y = y + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetInfoFromCCX99(DataArray:@TArray, datafilename_CCX99)
    var xml:object = ActiveX( "MSXML.DOMDocument" );
    var node:object, child_MicexDoc:object, child_CCX99:object, child_ExtSettleCode:object, child_Statement:object, child_Entry:object;
    var i = 0, j = 0, k = 0, l = 0;
    var stat = 0;
    var DOC_REQUISITES = false, CCX99 = false;
    var ID = 0, Debit = 0, Credit = 0, EntryDate = date(0, 0, 0), CodeType = 0, Account = "", PurposePayment = "";
/*ak*/
    var Pay_Acc = "", Rec_Acc = "", Number = "", Cor_Acc = "", res = true;
/*~ak*/

    var ExtSettleCodeID = "", ExtBuff = TRecHandler( "dl_extsettlecode.dbt" ); // Golovkin 24.04.20 ID : 509063 
    if(GetDialogFlag())
        InitProgress(-1, "Поиск движений денежных средств для перевода с другого клирингового счета", "Просмотр данных...");
    end;

    if(not xml.load(datafilename_CCX99))
        RGLog.Error( "Неверный формат файла импорта|"+ datafilename_CCX99+ "|Невозможно загрузить xml-документ" );
        return false;
    end;

    node = xml.DocumentElement;
    i = 0;
    while(i < node.ChildNodes.Length)
        child_MicexDoc = node.childNodes.item(i);
        if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
                RGLog.Error(string(datafilename_CCX99, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
                return false;
            end;
            DOC_REQUISITES = true;
        end;

        if(child_MicexDoc.tagname == "CCX99")
            if(CCX99)
                RGLog.Error(string(datafilename_CCX99, ": Блок MICEX_DOC\CCX99 должен присутствовать в единственном экземпляре"));
                return false;
            end;
            CCX99 = true;

            j = 0;
            while(j < child_MicexDoc.ChildNodes.Length)
                child_ExtSettleCode = child_MicexDoc.ChildNodes.item(j);
                if(child_ExtSettleCode.tagname == "EXTSETTLECODE")
                    ID = 0;
                    if(ReadTagAttribut(child_ExtSettleCode, "ID", V_INTEGER, ID) == false)
                    end;

                    if(ReadTagAttribut(child_ExtSettleCode, "ID", V_STRING, ExtSettleCodeID) == false)
                    end;

                    ExtBuff.clear();
                    if( FindDL_EXTSETTLECODEbyCode( ExtSettleCodeID, ExtBuff ) != 0 ) // Golovkin
                    end;

                    /*ak - Код должен быть либо нашим (01356 и 13385)
                           либо клиентским (06263,10120,10121,10122,10123,10124,10125,10126,11140,11139)*/
                    if((valtype(ID) == V_INTEGER) and ((ID ==  1356) or
                                                       (ID == 13385) or
                                                       (ID ==  6263) or
                                                       (ID == 10120) or
                                                       (ID == 10121) or
                                                       (ID == 10122) or
                                                       (ID == 10123) or
                                                       (ID == 10124) or
                                                       (ID == 10125) or
                                                       (ID == 10126) or
                                                       (ID == 11140) or
                                                       (ID == 485) or /*PNV*/
                                                       (ID == 17958) or /*CHVA 508883*/
                                                       (ID == 11139) or
                                                       (ExtBuff.rec.MarketKind == DV_MARKETKIND_STOCK) // Golovkin 24.04.2020 ID : 509063
                                                       ))

                      k = 0;
                      while(k < child_ExtSettleCode.childNodes.Length)
                          child_Statement = child_ExtSettleCode.childNodes.item(k);
                          if(child_Statement.tagname == "STATEMENT")
                              Account = "";
                              if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, Account) == false)
                              end;

                              l = 0;
                              while(l < child_Statement.childNodes.Length)
                                  child_Entry = child_Statement.childNodes.item(l);
                                  CodeType = 0;
                                  Debit = $0.0;
                                  Credit = $0.0;
                                  EntryDate = date(0, 0, 0);
                                  PurposePayment = "";
                                  /*ak*/
                                  Pay_Acc = "";
                                  Rec_Acc = "";
                                  Credit = $0.0;
                                  Number = "";
                                  Cor_Acc = "";
                                  /*~ak*/
                                  if(child_Entry.tagname == "ENTRY")
                                      if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, CodeType) == false)
                                      end;
                                      /*20 и задан DEBIT*/
                                      if((valtype(CodeType) == V_INTEGER) and (CodeType == 20))

                                        if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, Debit) == false)
                                        end;

                                        if((valtype(Debit) == V_MONEY) and (Debit > 0))

                                          if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, Credit) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, Pay_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, Rec_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, Number) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "DATE", V_DATE, EntryDate) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, PurposePayment) == false)
                                          end;

                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, 		/*_StatementAcc*/ 
                                                                                      CodeType, 	/*_EntryCodeType*/
                                                                                      Number, 		/*_EntryNumber*/
                                                                                      Cor_Acc, 		/*_EntryCorAcc*/
                                                                                      PurposePayment, 	/*_EntryPurposePayment*/
                                                                                      Debit, 		/*_EntryDebit*/
                                                                                      Credit, 		/*_EntryCredit*/
                                                                                      EntryDate, 	/*_EntryDate*/
                                                                                      Pay_Acc, 		/*_EntryPayAcc*/
                                                                                      Rec_Acc, 		/*_EntryRecAcc*/
                                                                                      ID); 		/*_ExtSettleCodeID*/

                                        end;

                                      end;
                                      /*~ak*/

                                      /*ak - Все не так
                                      if((Debit > 0) and ((CodeType == 20) or (CodeType == 813)))
                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, Debit, $0.0, EntryDate, "", "", ID);
                                      elif((Credit > 0) AND (CodeType == 813))
                                        DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, $0.0, Credit, EntryDate, "", "", ID);
                                      end;~ak*/
                                  end;

                                  l = l + 1;
                              end;
                          end;

                          k = k + 1;
                      end;
                    end;
                end;

                j = j + 1;
            end;
        end;

        i = i + 1;
    end;

    if(GetDialogFlag())
        RemProgress();
    end;

    /*ak*/
     return res;
    /*~ak*/

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
end;

/*Для сделок РПС контрагента по сделке берем из файла исполненных сделок,
  сделку ищем по параметрам TradeNo, BuySell, но если в EQM06 контрагент не указан, то пытаемся найти в SEM03*/
private macro GetInfoFromSEM03( DataContrSEM03Array:@TArray, DataKsuSEM03Array:@TArray, OnlyN:bool, filename_session_number:integer)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem03:object, child_Session : object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, SEM03 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var data_filepath_SEM03:string = "", data_filename_SEM03:string = "", datafilename_SEM03:string = "";
   var TrdAccId:string = "", IsTrust = false, TradeNo:string = "", BuySell:string = "", TradeType:string = "", CPFirmId:string = "", SecurityType:string = "", SecurityId:string = "";
   var SettleDate = date(0,0,0), TradeDate = date(0,0,0);
   var OnlyN_ = false, RepoValue = $0.0;
   var IsSEB = false, ClientCode = "", BrokerRef = "";

   private macro IdentIsSEB()
      if( (RepoValue == $0.0)
      AND (not IsTrust)
      AND ((BuySell == "B") OR (BuySell == "S"))
      AND (ClientCode == "")
      AND (GetClientCode_Req(BrokerRef) == "") )
         if( PrevISIN != SecurityId )
            ClearRecord(issues);
            ClearRecord(fin);
            RG_GetAvoirByISIN(SecurityId,Код_на_ММВБ_ФинИн,issues,fin);
            PrevISIN = SecurityId;
         end;
         if( fin.Issuer == {OurBank} )
            IsSEB = true;
         end;
      end;
   end;

   if( OnlyN != NULL )
      OnlyN_ = OnlyN;
   end;

   if(MMVB_Code == MICEX_CODE_FB)
      stat = get_data_file_name("DEALX", "SEM03", @data_filepath_SEM03, @data_filename_SEM03, "Импорт контрагентов по сделкам РПС и импорт КСУ для РЕПО из SEM03: ", filename_session_number);
   end;

   if(stat)
      return;
   end;

   datafilename_SEM03 = data_filepath_SEM03 + data_filename_SEM03;

   if(GetDialogFlag())
      InitProgress(-1, "Поиск сделок РПС в файле заключенных сделок с заданным значением контрагента", "Просмотр данных...");
   end;
   
   /* откроем файл импорта */
   if( not xml.load(datafilename_SEM03) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_SEM03, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM03")
            if(SEM03)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM03 = true;
            TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, TradeDate) == false)
               /* если не нашли дату торгов */
            end;
            if( TradeDate == date(0,0,0) )
               TradeDate = imp_date;
            end;

            var a = 0;
            while (a < child_MicexDoc.childNodes.length)
               child_Sem03 = child_MicexDoc.childNodes.item(j);
               if(child_Sem03 and (child_Sem03.nodeType==CHILD_NODE))
                  if (child_Sem03.tagname == "SESSION")
                     FIRM = false;

                     var SessionNo = -1;
                     ReadTagAttribut(child_Sem03, "SESSIONNO", V_INTEGER, SessionNo);
                     
                     if (   (filename_session_number == 1) and ((SessionNo == 0) or (SessionNo == 1))
                         or (filename_session_number == 2) and ( SessionNo == 2                     ))
                        j=0;
                        while(j<child_Sem03.childNodes.length) /* бегаем по SESSION */
                           child_Session = child_Sem03.childNodes.item(j);
                           if(child_Session and (child_Session.nodeType==CHILD_NODE))

                              if(child_Session.tagname == "FIRM")
                     if(FIRM)
                                    RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03\SESSION\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                                 while(k<child_Session.childNodes.length) /* бегаем по FIRM */
                                    child_Firm = child_Session.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "BOARD")
                                       m=0;
                                       while(m<child_Currency.childNodes.length) /* бегаем по BOARD */
                                          child_Board = child_Currency.childNodes.item(m);
                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                             if(child_Board.tagname == "SETTLEDATE")
                                                SettleDate = date(0,0,0);
                                                if(ReadTagAttribut(child_Board, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                    /* если не нашли фактическую дату расчётов */
                                                end;
                                                n=0;
                                                while(n<child_Board.childNodes.length) /* бегаем по SETTLEDATE */
                                                   child_Settledate = child_Board.childNodes.item(n);
                                                   if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                      if(child_Settledate.tagname == "SECURITY")
                                                         SecurityId = "";
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYID", V_STRING, SecurityId) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         SecurityType = "";
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYTYPE", V_STRING, SecurityType) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         if( (DataKsuSEM03Array != null) and ( ЭтоКСУ(SecurityType) ) )
                                                            DataKsuSEM03Array[DataKsuSEM03Array.size] = KsuData(SecurityId);
                                                         end;
                                                         s=0;
                                                         while(s<child_Settledate.childNodes.length) /* бегаем по SECURITY */
                                                            child_Security = child_Settledate.childNodes.item(s);
                                                            if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                                               if(child_Security.tagname == "TRDACC")
                                                                  TrdAccId = "";
                                                                  if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                      /* если не нашли торгово-клиринговый счет, с указанием которого заключена данная сделка */
                                                                  end;
                                                                  /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                  if(SubStr(TrdAccId,1,1) == "D")
                                                                     IsTrust = true;
                                                                  else
                                                                     IsTrust = false;
                                                                  end;
                                                                  IsSEB = false;
                                                                  r=0;
                                                                  while(r<child_Security.childNodes.length) /* бегаем по TRDACC */
                                                                     child_Trdacc = child_Security.childNodes.item(r);
                                                                     if(child_Trdacc and (child_Trdacc.nodeType==CHILD_NODE))

                                                                        if(child_Trdacc.tagname == "RECORDS")
                                                                           TradeNo = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADENO", V_STRING, TradeNo) == false)
                                                                               /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           BuySell = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "BUYSELL", V_STRING, BuySell) == false)
                                                                               /* если не нашли направленность заявки */
                                                                           end;
                                                                           TradeType = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADETYPE", V_STRING, TradeType) == false)
                                                                               /* если не нашли тип сделки */
                                                                           end;
                                                                           CPFirmId = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "CPFIRMID", V_STRING, CPFirmId) == false)
                                                                               /* если не нашли идентификатор фирмы партнера */
                                                                           end;

                                                                           if(ReadTagAttribut(child_Trdacc, "REPOVALUE", V_MONEY, RepoValue) == false)
                                                                               /* если не нашли сумму РЕПО */
                                                                           end;
                                                                           ClientCode = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "CLIENTCODE", V_STRING, ClientCode) == false)
                                                                               /* если не нашли краткий код клиента */
                                                                           end;
                                                                           BrokerRef = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "BROKERREF", V_STRING, BrokerRef) == false)
                                                                               /* если не нашли примечание */
                                                                           end;

                                                                           IdentIsSEB();

                                                                           if( IsFitDeal(IsTrust, IsSEB) AND
                                                                               ( ((OnlyN_ == true) and (TradeType == "N")) or (OnlyN_ == false) )
                                                                             )
                                                                              if( CPFirmId == "" )
                                                                                 /*для СделкаToday (не срочных и не РЕПО) в качестве контрагента ставим субъекта с принадлежностью 'Центральный контрагент'*/
                                                                                 if( ( RepoValue == $0.0 ) AND 
                                                                                     (SettleDate == TradeDate) AND (TradeDate >= date(1,11,2011))
                                                                                   )
                                                                                    RG_GetCentralContrForMarket( true ,@CPFirmId);
                                                                                 end;
                                                                              end;
                                                                              DataContrSEM03Array[DataContrSEM03Array.size] = CPFirmData(TradeNo, BuySell, CPFirmId);
                                                                           end;

                                                                         end;
                                                                     end;
                                                                     r = r + 1;
                                                                  end;
                                                               end;
                                                            end;
                                                            s = s + 1;
                                                         end;
                                                      end;

                                                   end;
                                                   n = n + 1;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                       end;
                                    end;
                             
                                 end;
                                 l = l + 1;
                              end;
                           end;

                        end;
                        k = k + 1;
                     end;
                  end;

               end;
               j = j + 1;
            end;
         end;
                  end;
               end;
               a = a + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetSettleCode2FromEQM06(DataSettleCode2Array:@TArray, SessionNo:integer)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0, y=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "";
   var stat:integer = 0;
   var RepoPart:integer = 0;
   var SettleCode2 = "";

   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "", datafilename_EQM06:string = "";

   if(MMVB_Code == MICEX_CODE_FB)
      stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, "Импорт кода по второй части из EQM06: ", SessionNo);
   end;

   if(stat)
      return;
   end;

   datafilename_EQM06 = data_filepath_EQM06 + data_filename_EQM06;
 
   if(GetDialogFlag())
      InitProgress(-1, "Сбор данных по комиссиям из файла исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "SETTLE")
                              y=0;
                              while(y<child_Firm.childNodes.length) /* бегаем по SETTLE */
                                 child_Settle = child_Firm.childNodes.item(y);
                                 if(child_Settle and (child_Settle.nodeType==CHILD_NODE))
                                    if(child_Settle.tagname == "CURRENCY")
                              l=0;
                                       while(l<child_Settle.childNodes.length) /* бегаем по CURRENCY */
                                          child_Currency = child_Settle.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( (InfType == 2) OR (InfType == 3) OR (InfType == 6) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                               
                                                                                                         if( RepoPart == 2 )
                                                                                                            TradeNo = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                            end;
                                                                                                            BuySell = "";
                                                                                                            if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                                                            end;
                                                                                                            SettleCode2 = "";
                                                                                                            if(ReadTagAttribut(child_Security, "SETTLECODE", V_STRING, SettleCode2) == false)
                                                                                                            /* если не нашли код расчётов по сделке */
                                                                                                            end;
                                                                                                            if( TradeNo != "" )
                                                                                                               DataSettleCode2Array[DataSettleCode2Array.size] = SettleCodeData(TradeNo,RepoPart,SettleCode2);
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                                 y = y + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetRecsAfterLoad_SEM03()
   var NumImportDealsTotal_DV = 0;

   RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT,"Документ-подтверждение \"Отчет биржи\" успешно загружен\n",null,true,null,@RECORDID_MarketReport);
   RGLog.GetAndAddReceiveLoadRecs(RG_SECURDEAL,"Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotal, @RECORDID_Deals);
   RGLog.GetAndAddReceiveLoadRecs(RG_DVNDEAL,"Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotal_DV, @RECORDID_Deals_DV);

   NumImportDealsTotal = NumImportDealsTotal + NumImportDealsTotal_DV;
end;

private macro GetRecsAfterLoad_EQM06()
   RGLog.GetAndAddReceiveLoadRecs(27,"Клиринг. Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotalCliring, @RECORDID_Deals_Cliring);
end;

private macro import_deals_to_gate_from_SEM03( datafilename_SEM03, filename_SEM03:string, data_file_EQM06_arr:TArray, filename_session_number:integer )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem03:object, child_SessionNo : object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, SEM03 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var PartyCode:string = "", TrdAccId:string = "";
   var DataCommArray = TArray(); DataCommArray.size = 0;
   var DataContrSEM03Array = TArray(); DataContrSEM03Array.size = 0;
   var DataSettleCode2Array = TArray(); DataSettleCode2Array.size = 0;
   var DataRepoArray = TArray(); DataRepoArray.size = 0;
   var DataTrdAccIdArray = TArray(); DataTrdAccIdArray.size = 0; 
   var DataExtSettlCodeEqmArray = TArray(); DataExtSettlCodeEqmArray.size = 0; 

   var v=0;

   FileImport = FileSEM03;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   /*соберем сделки РПС из файла SEM03*/
   GetInfoFromSEM03(@DataContrSEM03Array, null, false, filename_session_number);

   if( data_file_EQM06_arr.size > 0 )
      i = 0;
/*USR
 UPD 76 В пользовательский версии отсутсвует данный фрогмент 
      if( (data_file_EQM06_arr[ОСНОВНАЯ_003].stat == 1) and (data_file_EQM06_arr[ОСНОВНАЯ_002].stat == 1) )
         RGLog.Error( "Не найден файл основной сессии по маске "
                      + data_file_EQM06_arr[ОСНОВНАЯ_003].data_filepath + data_file_EQM06_arr[ОСНОВНАЯ_003].data_filename + " или "
                      + data_file_EQM06_arr[ОСНОВНАЯ_002].data_filepath + data_file_EQM06_arr[ОСНОВНАЯ_002].data_filename
                      +" для загрузки контрагентов, комиссий, информации по торговым счетам и суммовым параметрам РЕПО"
                    );
      end;
USR*/
      while( i < data_file_EQM06_arr.size )
         if(data_file_EQM06_arr[i].stat == 0)
            /*проверка на случай, если положат и 002 и 003 (а вдруг(!), в этом случае грузим только 003)*/
            if( (i == ОСНОВНАЯ_002) and (data_file_EQM06_arr[ОСНОВНАЯ_003].stat == 0) and (data_file_EQM06_arr[ОСНОВНАЯ_002].stat == 0) )
               i = i + 1;
               continue;
            end;
            RGLog.Message("Загрузка контрагентов, комиссий, информации по торговым счетам и суммовым параметрам РЕПО из EQM06.|Используется файл "
                          + data_file_EQM06_arr[i].data_filename);
   /*для сделок РПС контрагента возьмем из EQM06 (только если в EQM06 контрагент заполнен)*/
            GetContrFromEQM06(@DataContrSEM03Array,data_file_EQM06_arr[i].data_filepath + data_file_EQM06_arr[i].data_filename);
   /*собираем комиссии и информацию по торговым счетам по сделкам (1 частям) и заодно суммовые параметры по секции InfType == (3, 6) по 2 частям РЕПО*/
            GetCommFromEQM06(@DataCommArray, @DataRepoArray, @DataTrdAccIdArray, @DataExtSettlCodeEqmArray, data_file_EQM06_arr[i].data_filepath + data_file_EQM06_arr[i].data_filename);
         end;
         i = i + 1;
      end;
      if( (filename_session_number == 2) and (data_file_EQM06_arr[ВЕЧЕРНЯЯ].stat == 1) )
         RGLog.Error( "Не найден файл вечерней сессии по маске "
                      + data_file_EQM06_arr[ВЕЧЕРНЯЯ].data_filepath + data_file_EQM06_arr[ВЕЧЕРНЯЯ].data_filename
                      +" для загрузки контрагентов, комиссий, информации по торговым счетам и суммовым параметрам РЕПО"
                    );
      end;
   end;

   /*получить код по 2 ч для определения даты исполнения 2 ч*/
   //GetSettleCode2FromEQM06(@DataSettleCode2Array);

   /* откроем файл импорта */
   if( not xml.load(datafilename_SEM03) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_SEM03, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
            Deals.DOC_NO = "";
            if(ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, Deals.DOC_NO) == false)
               /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
            end;
         end;

         if(child_MicexDoc.tagname == "SEM03")
            if(SEM03)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM03 = true;
            Deals.TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Deals.TradeDate) == false)
               /* если не нашли дату торгов */
            end;
            Deals.TradeSessionDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADESESSIONDATE", V_DATE, Deals.TradeSessionDate) == false)
               /* если не нашли дату торгов */
            end;

            var a = 0;
            while (a < child_MicexDoc.childNodes.length)
               child_Sem03 = child_MicexDoc.childNodes.item(j);
               if(child_Sem03 and (child_Sem03.nodeType==CHILD_NODE))
                  if (child_Sem03.tagname == "SESSION")
                     FIRM = false;

                     var SessionNo = -1;
                     ReadTagAttribut(child_Sem03, "SESSIONNO", V_INTEGER, SessionNo);

                     if (   (filename_session_number == 1) and ((SessionNo == 0) or (SessionNo == 1))
                         or (filename_session_number == 2) and ( SessionNo == 2                     ))
                        j=0;
                        while(j<child_Sem03.childNodes.length) /* бегаем по SESSION */
                           child_SessionNo = child_Sem03.childNodes.item(j);
                           if(child_SessionNo and (child_SessionNo.nodeType==CHILD_NODE))

                              if(child_SessionNo.tagname == "FIRM")
                     if(FIRM)
                                    RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03\SESSION\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     if(GetDialogFlag())
                                    InitProgress(child_SessionNo.childNodes.length, "Загрузка внешнего файла сделок", "Просмотр сделок по валютам расчёта...");
                     end;
                                 while(k<child_SessionNo.childNodes.length) /* бегаем по FIRM */
                                    child_Firm = child_SessionNo.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              Deals.CurrencyId = "";
                              if(ReadTagAttribut(child_Firm, "CURRENCYID", V_STRING, Deals.CurrencyId) == false)
                                  /* если не нашли идентификатор валюты расчётов */
                              end;
                              l=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Firm.childNodes.length, "Загрузка внешнего файла сделок", "Просмотр сделок по режимам торгов...");
                              end;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))

                                    if(child_Currency.tagname == "BOARD")
                                       Deals.BoardId = "";
                                       Deals.BoardType = "";
                                       if(ReadTagAttribut(child_Currency, "BOARDID", V_STRING, Deals.BoardId) == false)
                                       end;
                                       if(ReadTagAttribut(child_Currency, "BOARDNAME", V_STRING, Deals.BoardType) == false)
                                       end;
                                       m=0;
                                       while(m<child_Currency.childNodes.length) /* бегаем по BOARD */
                                          child_Board = child_Currency.childNodes.item(m);
                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))

                                             if(child_Board.tagname == "SETTLEDATE")
                                                Deals.SettleDate = date(0,0,0);
                                                if(ReadTagAttribut(child_Board, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                                    /* если не нашли фактическую дату расчётов */
                                                end;
                                                n=0;
                                                while(n<child_Board.childNodes.length) /* бегаем по SETTLEDATE */
                                                   child_Settledate = child_Board.childNodes.item(n);
                                                   if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))

                                                      if(child_Settledate.tagname == "SECURITY")
                                                         Deals.SecurityId = ""; Deals.FaceValue = 0.0;
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYID", V_STRING, Deals.SecurityId) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYTYPE", V_STRING, Deals.SecurityType) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         if(ReadTagAttribut(child_Settledate, "FACEVALUE", V_DOUBLE, Deals.FaceValue) == false)
                                                             /* если не нашли номинальную стоимость одной ценной бумаги, в валюте инструмента */
                                                         end;
                                                         if(ReadTagAttribut(child_Settledate, "PRICETYPE", V_STRING, Deals.PriceType) == false)
                                                             /* если не нашли тип цены */
                                                         end;
                                                         s=0;
                                                         while(s<child_Settledate.childNodes.length) /* бегаем по SECURITY */
                                                            child_Security = child_Settledate.childNodes.item(s);
                                                            if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                                               if(child_Security.tagname == "TRDACC")
                                                                  TrdAccId = "";
                                                                  if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                      /* если не нашли торгово-клиринговый счет, с указанием которого заключена данная сделка */
                                                                  end;
                                                                   
                                                                  /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                  if(SubStr(TrdAccId,1,1) == "D")
                                                                     Deals.IsTrust = true;
                                                                  else
                                                                     Deals.IsTrust = false;
                                                                  end;
                                                                  r=0;
                                                                  if(GetDialogFlag())
                                                                     InitProgress(child_Security.childNodes.length, "Загрузка внешнего файла сделок", "Загрузка сделок...");
                                                                  end;
                                                                  while(r<child_Security.childNodes.length) /* бегаем по TRDACC */
                                                                     child_Trdacc = child_Security.childNodes.item(r);
                                                                     if(child_Trdacc and (child_Trdacc.nodeType==CHILD_NODE))

                                                                        if(child_Trdacc.tagname == "RECORDS")
                                                                           Deals.InitRecords();

                                                                           Deals.TrdAccId = TrdAccId;/*ниже корректируем*/

                                                                           if(ReadTagAttribut(child_Trdacc, "RECNO", V_STRING, Deals.RecNo) == false)
                                                                               /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                                               /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADETIME", V_TIME, Deals.TradeTime) == false)
                                                                               /* если не нашли время регистрации сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "BUYSELL", V_STRING, Deals.BuySell) == false)
                                                                               /* если не нашли направленность заявки */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "SETTLECODE", V_STRING, Deals.SettleCode) == false)
                                                                               /* если не нашли код расчётов по сделке */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "DECIMALS", V_INTEGER, Deals.Decimals) == false)
                                                                               /* если не нашли число значимых знаков после запятой */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "PRICE", V_DOUBLE, Deals.Price) == false)
                                                                               /* если не нашли цену за одну ценную бумагу */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "QUANTITY", V_MONEY, Deals.Quantity) == false)
                                                                               /* если не нашли количество ценных бумаг */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "VALUE", V_MONEY, Deals.Value_) == false)
                                                                               /* если не нашли объём сделки, в валюте расчётов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "AMOUNT", V_MONEY, Deals.Amount) == false)
                                                                               /* если не нашли сумму сделки, в валюте расчётов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                               /* если не нашли объём комиссии по заключенной сделке за торги */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "ORDERNO", V_STRING, Deals.OrderNo) == false)
                                                                               /* если не нашли номер заявки */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "ACCINT", V_MONEY, Deals.AccInt) == false)
                                                                               /* если не нашли накопленный купонный доход */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "CPFIRMID", V_STRING, Deals.CPFirmId) == false)
                                                                               /* если не нашли участника торгов - контрагента */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "REPOVALUE", V_MONEY, Deals.RepoValue) == false)
                                                                               /* если не нашли сумму РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "REPOPERIOD", V_INTEGER, Deals.RepoPeriod) == false)
                                                                               /* если не нашли срок РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "REPORATE", V_DOUBLE, Deals.RepoRate) == false)
                                                                               /* если не нашли ставку РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADETYPE", V_STRING, Deals.TradeType) == false)
                                                                               /* если не нашли тип сделки */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "PRICE2", V_DOUBLE, Deals.Price2) == false)
                                                                               /* если не нашли цену выкупа второй части РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "ACCINT2", V_MONEY, Deals.AccInt2) == false)
                                                                               /* если не нашли накопленный купонный доход на дату исполнения второй части сделки РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "CLIENTCODE", V_STRING, Deals.ClientCode) == false)
                                                                               /* если не нашли краткий код клиента */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "MATCHREF", V_STRING, Deals.MatchRef) == false)
                                                                               /* если не нашли поле "Ссылка" (заполняется при вводе заявки) */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "BROKERREF", V_STRING, Deals.BrokerRef) == false)
                                                                               /* если не нашли примечание */
                                                                           end;

                                                                           /* вытащили все данные по сделке, теперь обработаем и вставим */
                                                                           SetPartPrmDeal();

                                                                           if( IsFitDeal(Deals.IsTrust, Deals.IsSEB) )
                                                                              /*сделка РПС ? контрагента берем из EQM06, если в EQM06 он задан*/
                                                                              if( Deals.TradeType == "N" )
                                                                                 v = 0;
                                                                                 while( v < DataContrSEM03Array.size )
                                                                                    if( (Deals.TradeNo == DataContrSEM03Array[v].TradeNo) AND (Deals.BuySell == DataContrSEM03Array[v].BuySell) )
                                                                                       Deals.CPFirmId = DataContrSEM03Array[v].CPFirmId;
                                                                                    end;
                                                                                    v = v + 1;
                                                                                 end;
                                                                              end;

                                                                              if( not IsDVnDealData() )/*если сделка грузится в ПИ, то комиссии и 2 ч. не нужны (пока)*/
                                                                                 ЗагрузитьКомиссииПо1ч(DataCommArray, Deals.TradeNo, Deals.BuySell, @Deals.CLRCOMM);
                                                                                 ЗагрузитьРасчетныйКодИзЕКМ(DataExtSettlCodeEqmArray, Deals.TradeNo, Deals.BuySell, @Deals.ExtSettlCodeEqm);
                                                                                 
                                                                                 //ЗагрузитьКодРасчетов2ч(DataSettleCode2Array, Deals.TradeNo, @Deals.SettleCode2);
                                                                                 
                                                                                 /*заполнить недостающие(нулевые) параметры по 2 ч РЕПО из файла клиринга секции inftype = (3, 6)*/
                                                                                 ДозаполнитьРЕПО2ч(DataRepoArray, Deals.TradeNo,
                                                                                                   @Deals.AccInt2, @Deals.Amount2, @Deals.Value2_, @Deals.Price2);

                                                                                 СкорректироватьТоргСчет(DataTrdAccIdArray, Deals.TradeNo, Deals.BuySell, @Deals.TrdAccId);
                                                                              end;
                                                                              if(RunImp())
                                                                                 stat = 1;
                                                                              end;
                                                                           end;

                                                                         end;
                                                                     end;
                                                                     r = r + 1;
                                                                     if(GetDialogFlag())
                                                                        UseProgress(r);
                                                                     end;
                                                                     if( FlagCtrlBrk == true )
                                                                        break;
                                                                     end;
                                                                  end;
                                                                  if(GetDialogFlag())
                                                                     RemProgress(); 
                                                                  end;
                                                               end;
                                                            end;
                                                            s = s + 1;
                                                            if( FlagCtrlBrk == true )
                                                               break;
                                                            end;
                                                         end;
                                                      end;

                                                   end;
                                                   n = n + 1;
                                                   if( FlagCtrlBrk == true )
                                                      break;
                                                   end;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                    end;
                             
                                 end;
                                 l = l + 1;
                                 if(GetDialogFlag())
                                    UseProgress(l);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress(); 
                              end;
                           end;

                        end;
                        k = k + 1;
                        if(GetDialogFlag())
                           UseProgress(k);
                        end;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                     if(GetDialogFlag())
                        RemProgress(); 
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;
                  end;
                  a = a + 1;
                  if (FlagCtrlBrk == true)
                     break;
                  end;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   if( not FlagCtrlBrk )
      RG.Transfer();
      SetErrAfterLoad(true);
   end;

   /*загрузить в лог инфу о загруженных ЗР*/
   GetRecsAfterLoad_SEM03();

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано сделок из " + string(filename_SEM03) + " - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro import_deals_to_gate_from_CCX99( datafilename_CCX99 )
   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Requisites:object, child_CCX99:object,
       child_ExtSettleCode:object, child_Statement:object, child_Entry:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, CCX99 = false, EXTSETTLECODE = false, STATEMENT = false, ENTRY = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var DataOtherKlirArray = TArray(); DataOtherKlirArray.Size = 0;
   var ExtBuff = TRecHandler( "dl_extsettlecode.dbt" ); // Golovkin 24.04.2020 ID : 509063 Для проверки расчетного кода

   const AccountCode = "01054";

   FileImport = FileCCX99;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
       VAR NoError = true;
       ErrMes = "";
       WarnMes = "";
       if(ProcessTrn(0, "PutMoneyMotion"))
          RGLog.Message( "Движение денежных средств с номером \"" + MoneyMotion.EntryNumber + "\" уcпешно загружено в шлюз" + ErrMes, RG, SUCCESS );
       else
          RGLog.Error( "Ошибка при вставке движения денежных средств\n" + ErrMes, RGMkRep );
          return 1;
       end;
       return 0;

    OnError(ErObj)

       RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
 
       if(ErObj.Code == CtrlBrkErr)
          FlagCtrlBrk = true;
       else
          RemProgress();
          RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
       end;
       return ErObj.Code;
   end;

   //Собираем движения денежных средств для сравнения с CODETYPE = 20 и CODETYPE = 813
   /*ak - Завершаем обработку при ошибке, явпо передаем файл*/
   if(not GetInfoFromCCX99(@DataOtherKlirArray, datafilename_CCX99))
     return false;
   end;
   /*~ak*/

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   /*ak - Все необходимые данные у нас в массиве DataOtherKlirArray, второй раз обход файла делать не будем

   var iarr = 0;
   var res = true;
   while(iarr < DataOtherKlirArray.size)
     MoneyMotion = DataOtherKlirArray[iarr];
     if(RunImp() > 0)
       if(res)
         res = false;
       end;
     end;
     iarr = iarr + 1;
     if(FlagCtrlBrk == true)
        break;
     end;
   end;
   return res;
   ~ak*/

   if( not xml.load(datafilename_CCX99) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_CCX99, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length )
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))
         if(child_MicexDoc.tagname == "CCX99")
            j = 0;
            while(j < child_MicexDoc.childNodes.Length)
               child_ExtSettleCode = child_MicexDoc.childNodes(j);
               if(ReadTagAttribut(child_ExtSettleCode, "ID", V_STRING, MoneyMotion.ExtSettleCodeID) == false)
                  /* если не нашли расчетный код */
               end;
               ExtBuff.clear();
               if( FindDL_EXTSETTLECODEbyCode( MoneyMotion.ExtSettleCodeID, ExtBuff ) != 0 ) // Golovkin
               end;  

               /*ak - Код должен быть либо нашим (01356 и 13385)
                      либо клиентским (06263,10120,10121,10122,10123,10124,10125,10126,11140,11139)*/
               if((valtype(MoneyMotion.ExtSettleCodeID) == V_STRING) and 
                         ((MoneyMotion.ExtSettleCodeID == "01356") or
                          (MoneyMotion.ExtSettleCodeID == "13385") or
                          (MoneyMotion.ExtSettleCodeID == "06263") or
                          (MoneyMotion.ExtSettleCodeID == "10120") or
                          (MoneyMotion.ExtSettleCodeID == "10121") or
                          (MoneyMotion.ExtSettleCodeID == "10122") or
                          (MoneyMotion.ExtSettleCodeID == "10123") or
                          (MoneyMotion.ExtSettleCodeID == "10124") or
                          (MoneyMotion.ExtSettleCodeID == "10125") or
                          (MoneyMotion.ExtSettleCodeID == "10126") or
                          (MoneyMotion.ExtSettleCodeID == "11140") or
                          (MoneyMotion.ExtSettleCodeID == "17958") or /*CHVA 508883*/
                          (MoneyMotion.ExtSettleCodeID == "11139") or
                          (ExtBuff.rec.MarketKind == DV_MARKETKIND_STOCK) // Golovkin 24.04.2020 ID : 509063 Пока делаю безопасную проверку на наличие кода в справочнике. Т.е. либо прописанные в макросе, либо код в справочнике с признаком фондового рынка
                          ))
               /*~ak*/

                  if(GetDialogFlag())
                     InitProgress(child_ExtSettleCode.childNodes.length, "Загрузка внешнего файла движений денежных средств", "Просмотр блока данных о движении ДС в разрезе расчетного кода...");
                  end;
                  k = 0;
                  while(k < child_ExtSettleCode.childNodes.Length)
                     child_Statement = child_ExtSettleCode.childNodes(k);
                     MoneyMotion.StatementAcc = "";
                     if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, MoneyMotion.StatementAcc) == false)
                        /* если не нашли номер счета */
                     end;
                     if(GetDialogFlag() and (child_Statement.childNodes.length > 0))
                        InitProgress(child_Statement.childNodes.length, "Загрузка внешнего файла движений денежных средств", "Просмотр данных по счету...");
                     end;
                     /*ak
                     if(MoneyMotion.ExtSettleCodeID == AccountCode)
                     ~ak*/
                        l = 0;
                        while(l < child_Statement.childNodes.Length)
                           child_Entry = child_Statement.childNodes(l);
                           MoneyMotion.Init();
                           if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, MoneyMotion.EntryCodeType) == false)
                              /* если не нашли код типа операции */
                           end;

                           /*ak - Тип кода должен быть 916, 918 или 20*/
                           if((valtype(MoneyMotion.EntryCodeType) == V_INTEGER) and ((MoneyMotion.EntryCodeType == 916) or (MoneyMotion.EntryCodeType == 918) or (MoneyMotion.EntryCodeType == 812) or (MoneyMotion.EntryCodeType == 20)))
                           /*~ak*/

                              /*ak - Для 916 балансовый PAY_ACC должен быть 30411, 
                                     а для 918 REC_ACC 30411*/

                              if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, MoneyMotion.EntryPayAcc) == false)
                                 /* если не нашли счет плательщика */
                              end;
                              if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, MoneyMotion.EntryRecAcc) == false)
                                 /* если не нашли счет получателя */
                              end;
                              if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, MoneyMotion.EntryCredit) == false)
                                 /* если не нашли кредит */
                              end;

                              /*ak*/
                              if(((MoneyMotion.EntryCodeType == 916) and (valtype(MoneyMotion.EntryPayAcc) == V_STRING) and (substr(MoneyMotion.EntryPayAcc,1,5) == "30411")) or
                                 (((MoneyMotion.EntryCodeType == 918) or (MoneyMotion.EntryCodeType == 812)) and (valtype(MoneyMotion.EntryRecAcc) == V_STRING) and (substr(MoneyMotion.EntryRecAcc,1,5) == "30411")) or
                                 ((MoneyMotion.EntryCodeType ==  20) and (valtype(MoneyMotion.EntryCredit) == V_MONEY) and (MoneyMotion.EntryCredit > 0)))
                              /*~ak*/

                                 if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, MoneyMotion.EntryNumber) == false)
                                    /* если не нашли номер документа */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "COR_ACC", V_STRING, MoneyMotion.EntryCorAcc) == false)
                                    /* если не нашли номер корреспондирующего счета */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, MoneyMotion.EntryPurposePayment) == false)
                                    /* если не нашли комментарии */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, MoneyMotion.EntryDebit) == false)
                                    /* если не нашли дебет */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "DATE", V_DATE, MoneyMotion.EntryDate) == false)
                                    /* если не нашли дату операции */
                                 end;
                                 if(MoneyMotion.EntryCodeType == 20)
                                     ЗаполнитьДругойКлирСчет(DataOtherKlirArray, MoneyMotion.EntryCredit, MoneyMotion.EXTSettleCodeID, MoneyMotion.EntryDate, MoneyMotion.EntryCodeType, MoneyMotion.EntryPurposePayment, @MoneyMotion.OtherKlirAcc);
                                 end;
                
                                 if(RunImp())
                                     stat = 1;
                                 end;

                              end;
                           end;
                           
                           l = l + 1;
                           if(GetDialogFlag())
                              UseProgress(l);
                           end;
                           if( FlagCtrlBrk == true )
                              break;
                           end;
                        end;
//                    end;
                     if(GetDialogFlag() and (child_Statement.childNodes.length > 0))
                        RemProgress(); 
                     end;
                     k = k + 1;
                     if(GetDialogFlag())
                        UseProgress(k);
                     end;
                     if( FlagCtrlBrk == true )
                        break;
                     end;
                  end;
                  if(GetDialogFlag())
                     RemProgress(); 
                  end;
               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         break;
      end;
   end;
END;

// b. запись по исполненной 2 части - с (InfType = 1 или InfType = 2) и RepoPart = 2
// исполенние 2 ч НЕ в день заключения - внутридневное РЕПО (в файле есть обе части)
// исполенние 2 ч в день заключения - внутридневное РЕПО (в файле есть обе части)
// исполнение 2 ч НЕвнутридневного РЕПО (в файле только 2 ч)
private macro СобратьДанныеПо2ЧастиРепо( datafilename_EQM06, DataRepoArray:@TArray )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0, y=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, SettleDate:date = date(0,0,0), BoardId:string = "", ClientCode:string = "",
       RepoPart:integer = 0, TrdAccId:string = "", IsTrust:bool = false, TradeNo:string = "",
       Amount:money = $0.0, AccInt2:money = $0.0, Price2:double = $0.0, Value_:money = $0.0;
   var stat:integer = 0;

   if( GetDialogFlag() )
      InitProgress(-1, "Обработка 2 частей сделок РЕПО", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "SETTLE")
                              y=0;
                              while(y<child_Firm.childNodes.length) /* бегаем по SETTLE */
                                 child_Settle = child_Firm.childNodes.item(y);
                                 if(child_Settle and (child_Settle.nodeType==CHILD_NODE))
                                    if(child_Settle.tagname == "CURRENCY")
                              l=0;
                                       while(l<child_Settle.childNodes.length) /* бегаем по CURRENCY */
                                          child_Currency = child_Settle.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( (InfType == 1) OR (InfType == 2) OR (InfType == 3) OR (InfType == 6) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     SettleDate = date(0,0,0);
                                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                                     end;
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       BoardId = "";
                                                                                       if(ReadTagAttribut(child_InstrTrade, "BOARDID", V_STRING, BoardId) == false)
                                                                                       end;
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                         if(RepoPart == 2)
                                                                                                            TrdAccId = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                                                            end;
                                                                                                            /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                                                            if(SubStr(TrdAccId,1,1) == "D")
                                                                                                               IsTrust = true;
                                                                                                            else
                                                                                                               IsTrust = false;
                                                                                                            end;
                                                                                                            if( ( (pp.deals_bo == SET_CHAR) AND ( IsTrust == false) ) OR
                                                                                                                ( (pp.deals_du == SET_CHAR) AND ( IsTrust == true) )
                                                                                                              )
                                                                                                               ClientCode = "";
                                                                                                               if(ReadTagAttribut(child_Security, "CLIENTCODE", V_STRING, ClientCode) == false)
                                                                                                               end;
                                                                                                               
                                                                                                               TradeNo = "";
                                                                                                               if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                               end;
                                                                                                               Amount = $0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Amount) == false)
                                                                                                               end;
                                                                                                               AccInt2 = $0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, AccInt2) == false)
                                                                                                               end;
                                                                                                               Price2 = 0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Price2) == false)
                                                                                                               end;
                                                                                                               Value_ = $0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Value_) == false)
                                                                                                               end;
                                                                                                               /* вытащили все данные */
                                                                                                               DataRepoArray[DataRepoArray.size] = DataRepo(TradeNo, Amount, SettleDate, AccInt2, Price2, Value_);
                                                                                                            
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                                 y = y + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

// запись по исполненным 1ч РЕПО (с inftype=1 и repopart=1) для определения пналичия пары (inftype=1 и repopart=2):
// в случае исполнения внутридневного РЕПО в файле будет запись (inftype=1 и repopart=2) 
// в случае невнутридневного - пары не будет
private macro СобратьДанныеПо1ЧастиРепо(datafilename_EQM06, DataRepoArray:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0, y=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, SettleDate:date = date(0,0,0), BoardId:string = "", ClientCode:string = "",
       RepoPart:integer = 0, TrdAccId:string = "", IsTrust:bool = false, TradeNo:string = "";
   var stat:integer = 0;

   if(GetDialogFlag())
      InitProgress(-1, "Обработка 1 частей сделок РЕПО", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "SETTLE")
                              y=0;
                              while(y<child_Firm.childNodes.length) /* бегаем по SETTLE */
                                 child_Settle = child_Firm.childNodes.item(y);
                                 if(child_Settle and (child_Settle.nodeType==CHILD_NODE))
                                    if(child_Settle.tagname == "CURRENCY")
                              l=0;
                                       while(l<child_Settle.childNodes.length) /* бегаем по CURRENCY */
                                          child_Currency = child_Settle.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( InfType == 1 )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     SettleDate = date(0,0,0);
                                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                                     end;
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       BoardId = "";
                                                                                       if(ReadTagAttribut(child_InstrTrade, "BOARDID", V_STRING, BoardId) == false)
                                                                                       end;
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                         if(RepoPart == 1)
                                                                                                            TrdAccId = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                                                            end;
                                                                                                            /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                                                            if(SubStr(TrdAccId,1,1) == "D")
                                                                                                               IsTrust = true;
                                                                                                            else
                                                                                                               IsTrust = false;
                                                                                                            end;
                                                                                                            if( ( (pp.deals_bo == SET_CHAR) AND ( IsTrust == false) ) OR
                                                                                                                ( (pp.deals_du == SET_CHAR) AND ( IsTrust == true) )
                                                                                                              )
                                                                                                               ClientCode = "";
                                                                                                               if(ReadTagAttribut(child_Security, "CLIENTCODE", V_STRING, ClientCode) == false)
                                                                                                               end;
                                                                                                               
                                                                                                               TradeNo = "";
                                                                                                               if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                               end;
                                                                                                               DataRepoArray[DataRepoArray.size] = DataRepo_1(TradeNo);
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                                 y = y + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;


// a. запись по исполненной 1 части - с InfType = 2 и RepoPart = 1,
// в день исполнения 2 части сделки в ФИС приходит 1 запись с информацией об этой сделке - с InfType = 1 и RepoPart = 2 
private macro import_deals_to_gate_from_EQM06( datafilename_EQM06, filename_EQM06:string )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0, y=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var stat:integer = 0;
   var DataRepoArray = TArray(); DataRepoArray.size = 0;
   var DataContrSEM03Array = TArray(); DataContrSEM03Array.size = 0;
   var DataRepoArray_1 = TArray(); DataRepoArray_1.size = 0;
   var DataKsuSEM03Array = TArray(); DataKsuSEM03Array.size = 0;
   var IsRun = true;

   FileImport = FileEQM06;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   NumImportDealsCliring = 0;
   NumImportDealsTotalCliring = 0;

   СобратьДанныеПо2ЧастиРепо(datafilename_EQM06, @DataRepoArray);

   СобратьДанныеПо1ЧастиРепо(datafilename_EQM06, @DataRepoArray_1);

   /*соберем сделки РПС из файла SEM03 
     на тот случай, если в файле EQM06 для сделок РПС не указан контрагент, а в SEM03 указан - контрагента тогда берем из SEM03
     + соберем КСУ для РЕПО с КСУ (для опеределения, что данная сделка клиринга есть сделка с КСУ),
     обязательно соберем данные из файла первой сесии SEM03, а из файла второй сессии только если сессия файла клиринга дополнительная или вечерняя
   */
   GetInfoFromSEM03(@DataContrSEM03Array, @DataKsuSEM03Array, true, 1);
   GetInfoFromSEM03(@DataContrSEM03Array, @DataKsuSEM03Array, true, 2);

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
            Deals.DOC_NO = "";
            if(ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, Deals.DOC_NO) == false)
               /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
            end;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     if(GetDialogFlag())
                        InitProgress(child_Eqm06.childNodes.length, "Загрузка сделок из EQM06", "Просмотр сделок по валютам расчёта...");
                     end;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "SETTLE")
                              Deals.ExtSettleCode = "";
                              if( ReadTagAttribut(child_Firm, "EXTSETTLECODE", V_STRING, Deals.ExtSettleCode) == false )
                                 /* если не нашли расчетный код участника клиринга */
                              end;
                              y=0;
                              while(y<child_Firm.childNodes.length) /* бегаем по SETTLE */
                                 child_Settle = child_Firm.childNodes.item(y);
                                 if(child_Settle and (child_Settle.nodeType==CHILD_NODE))
                                    if(child_Settle.tagname == "CURRENCY")
                              Deals.CurrencyId = "";
                                       if(ReadTagAttribut(child_Settle, "CURRENCYID", V_STRING, Deals.CurrencyId) == false)
                                  /* если не нашли идентификатор валюты расчётов */
                              end;
                              l=0;
                                       while(l<child_Settle.childNodes.length) /* бегаем по CURRENCY */
                                          child_Currency = child_Settle.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       Deals.InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, Deals.InfType) == false)
                                       end;
                                       if( (Deals.InfType == 1) or (Deals.InfType == 2) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            Deals.Session = -1;
                                                            if(ReadTagAttribut(child_ClearingType, "SESSION", V_INTEGER, Deals.Session) == false)
                                                                /* если не нашли клиринговую сессию */
                                                            end;
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     Deals.SettleDate = date(0,0,0);
                                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                                                         /* если не нашли фактическую дату расчётов */
                                                                     end;
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       Deals.BoardId = "";
                                                                                       if(ReadTagAttribut(child_InstrTrade, "BOARDID", V_STRING, Deals.BoardId) == false)
                                                                                       end;
                                                                                          m=0;
                                                                                          while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                             child_Board = child_InstrTrade.childNodes.item(m);
                                                                                             if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                                if(child_Board.tagname == "SECURITY")
                                                                                                   Deals.SecurityId = "";
                                                                                                   if(ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Deals.SecurityId) == false)
                                                                                                       /* если не нашли идентификатор финансового инструмента */
                                                                                                   end;
                                                                                                   if(ReadTagAttribut(child_Board, "PRICETYPE", V_STRING, Deals.PriceType) == false)
                                                                                                       /* если не нашли тип цены */
                                                                                                   end;
                                                                                                   ЗаполнитьКсуДляРЕПО(DataKsuSEM03Array, Deals.SecurityId, @Deals.SecurityType);
                                                                                                   s=0;
                                                                                                   if(GetDialogFlag())
                                                                                                      InitProgress(child_Board.childNodes.length, "Загрузка сделок из EQM06", "Загрузка сделок...");
                                                                                                   end;
                                                                                                   while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                      child_Security = child_Board.childNodes.item(s);
                                                                                                      if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                         if(child_Security.tagname == "RECORDS")
                                                                                                            Deals.InitRecords();
                                                                                                            if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, Deals.RepoPart) == false)
                                                                                                                Deals.RepoPart = 0;
                                                                                                                /* если не нашли часть репо */
                                                                                                            end;
                                                                                   
                                                                                                            if(    ( (Deals.InfType == 1) AND (Deals.RepoPart == 1) )
                                                                                                                OR ( (Deals.InfType == 2) AND ((Deals.RepoPart == 1) or (Deals.RepoPart == 2)) )
                                                                                                                OR ( (Deals.InfType == 1) AND (Deals.RepoPart == 2) )
                                                                                                                OR ( Deals.RepoPart == 0 )
                                                                                                              ) 
                                                                                                               Deals.TrdAccId = "";
                                                                                                               if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, Deals.TrdAccId) == false)
                                                                                                                   /* если не нашли торговый счет, в счет которого заключена данная сделка */
                                                                                                               end;

                                                                                                               /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                                                               if(SubStr(Deals.TrdAccId,1,1) == "D")
                                                                                                                  Deals.IsTrust = true;
                                                                                                               else
                                                                                                                  Deals.IsTrust = false;
                                                                                                               end;
                                                                                                               if(ReadTagAttribut(child_Security, "CLIENTCODE", V_STRING, Deals.ClientCode) == false)
                                                                                                                   /* если не нашли краткий код клиента */
                                                                                                               end;

                                                                                                               if(ReadTagAttribut(child_Security, "BROKERREF", V_STRING, Deals.BrokerRef) == false)
                                                                                                                   /* если не нашли краткий код клиента */
                                                                                                               end;

                                                                                                               if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, Deals.BuySell) == false)
                                                                                                                   /* если не нашли направленность заявки */
                                                                                                               end;

                                                                                                               Deals.IsCliring = true;

                                                                                                               SetPartPrmDeal();

                                                                                                               if( IsFitDeal(Deals.IsTrust, Deals.IsSEB) )
                                                                                                                  Deals.TradeDate = date(0,0,0);
                                                                                                                  if(ReadTagAttribut(child_Security, "TRADEDATE", V_DATE, Deals.TradeDate) == false)
                                                                                                                     /* если не нашли дату торгов */
                                                                                                                  end;

                                                                                                                  if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                                                                                      /* если не нашли номер сделки в торговой системе */
                                                                                                                  end;

                                                                                                                  if(ReadTagAttribut(child_Security, "SETTLECODE", V_STRING, Deals.SettleCode) == false)
                                                                                                                      /* если не нашли код расчётов по сделке */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "DECIMALS", V_INTEGER, Deals.Decimals) == false)
                                                                                                                      /* если не нашли число значимых знаков после запятой */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Deals.Price) == false)
                                                                                                                      /* если не нашли цену за одну ценную бумагу */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "QUANTITY", V_MONEY, Deals.Quantity) == false)
                                                                                                                      /* если не нашли объём сделки, в ценных бумагах */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Deals.Value_) == false)
                                                                                                                      /* если не нашли объём сделки, в валюте расчётов */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Deals.Amount) == false)
                                                                                                                      /* если не нашли сумму сделки, в валюте расчётов */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                                                                      /* если не нашли объём комиссии по заключенной сделке за торги */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, Deals.AccInt) == false)
                                                                                                                      /* если не нашли накопленный купонный доход */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "CPFIRMID", V_STRING, Deals.CPFirmId) == false)
                                                                                                                      /* если не нашли идентификатор фирмы партнера */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "REPOPERIOD", V_INTEGER, Deals.RepoPeriod) == false)
                                                                                                                      /* если не нашли срок РЕПО */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "REPORTTIME", V_TIME, Deals.TradeTime) == false)
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "SETTLETIME", V_TIME, Deals.SettleTime) == false)
                                                                                                                  end;
                                                                                                                  if( Deals.RepoPart == 1 )
                                                                                                                     НайтиДанныеПо2Части(DataRepoArray, Deals.TradeNo, Deals.SettleDate, Deals.Amount, @Deals.RepoRate,
                                                                                                                                         @Deals.AccInt2, @Deals.Amount2, @Deals.Value2_, @Deals.Price2);
                                                                                   
                                                                                                                     /*проверяем, что это внебиржевые сделки*/
                                                                                                                     if( IsOutExchangeREPO() )
                                                                                                                        /*для внебиржевых сделок РЕПО все комиссии загружаем в ЗР по сделке*/
                                                                                                                        if(ReadTagAttribut(child_Security, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                                                                        end;
                                                                                                                        if(ReadTagAttribut(child_Security, "CLRCOMM", V_MONEY, Deals.ClrComm) == false)
                                                                                                                        end;
                                                                                                                     end;
                                                                                   
                                                                                                                  end;
                                                                                   
                                                                                                                  IsRun = true;
                                                                                                                  if( (Deals.InfType == 1) AND (Deals.RepoPart == 2) AND 
                                                                                                                      (not НевнутридневноеРЕПО(DataRepoArray_1, Deals.TradeNo)) 
                                                                                                                    )
                                                                                                                     IsRun = false;
                                                                                                                  end;
                                                                                   
                                                                                                                  if( IsRun )
                                                                                                                     if( Deals.CPFirmId == "" )
                                                                                                                        ЗаполнитьКонтрагентаДляРПС(DataContrSEM03Array, Deals.TradeNo, Deals.BuySell, @Deals.CPFirmId);
                                                                                                                     end;
                                                                                                                     /* вытащили все данные по сделке, теперь обработаем и вставим */
                                                                                                                     if(RunImp())
                                                                                                                        stat = 1;
                                                                                                                     end;
                                                                                                                  end;
                                                                                                               end;
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                      s = s + 1;
                                                                                                      if(GetDialogFlag())
                                                                                                         UseProgress(s);
                                                                                                      end;
                                                                                                      if( FlagCtrlBrk == true )
                                                                                                         break;
                                                                                                      end;
                                                                                                   end;
                                                                                                   if(GetDialogFlag())
                                                                                                      RemProgress(); 
                                                                                                   end;
                                                                                                end;
                                                                                             end;
                                                                                             m = m + 1;
                                                                                             if( FlagCtrlBrk == true )
                                                                                                break;
                                                                                             end;
                                                                                          end;
                                                                                       end;
                                                                                    end;
                                                                                    h = h + 1;
                                                                                    if( FlagCtrlBrk == true )
                                                                                       break;
                                                                                    end;
                                                                                 end;
                                                                             end;
                                                                        end;
                                                                        t = t + 1;
                                                                        if( FlagCtrlBrk == true )
                                                                           break;
                                                                        end;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                               if( FlagCtrlBrk == true )
                                                                  break;
                                                               end;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                      if( FlagCtrlBrk == true )
                                                         break;
                                                      end;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                             if( FlagCtrlBrk == true )
                                                break;
                                             end;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                           end;
                        end;
                                 y = y + 1;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                           end;
                        end;
                        k = k + 1;
                        if(GetDialogFlag())
                           UseProgress(k);
                        end;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                     if(GetDialogFlag())
                        RemProgress(); 
                     end;
                  end;
               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   if( not FlagCtrlBrk )
      RG.Transfer();
      SetErrAfterLoad(true);
   end;

   /*загрузить в лог инфу о загруженных ЗР*/
   GetRecsAfterLoad_EQM06();

   /* сообщаем о результатах загрузки */
   RGLog.Message( "Загрузка "+string(filename_EQM06)+":"+
                  "\nВсего сделок, прошедших клиринг - " + string(NumImportDealsCliring) + 
                  "\n из них успешно - " + string(NumImportDealsTotalCliring) + 
                  "\n ошибочно - " + string(NumImportDealsCliring - NumImportDealsTotalCliring)
                );

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

PRIVATE MACRO PutCompInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_COMP,
                   String("Компенсационный взнос по сделке №" + Comp.RepoTradeNo),
                   Создать );

   if( NOT RG.InitByCode(RG_REQUEST, Comp.RepoTradeNo + "_" + string(Comp.SettleDate) + "_" + string(Comp.RecNo), SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("RGDLCOMP_REPORTDATE",    Comp.ReportDate);
   RG.SetParmByName("RGDLCOMP_REPOTRADENO",   Comp.RepoTradeNo);
   RG.SetParmByName("RGDLCOMP_DIRECTION",     Comp.Direction);
   RG.SetParmByName("RGDLCOMP_CLIENTDETAILS", Comp.ClientDetails);
   RG.SetParmByName("RGDLCOMP_QUANTITY",      Comp.Quantity);
   RG.SetParmByName("RGDLCOMP_VALUE",         Comp.Value);
   RG.SetParmByName("RGDLCOMP_SETTLEDATE",    Comp.SettleDate);

   if( RG.Save() != true )
      if( RG.GetLastError() )
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
END;
              
PRIVATE MACRO import_comp_to_gate_from( datafilename:STRING ):INTEGER

   var xml:object = ActiveX("MSXML.DOMDocument");
   var node:object, child_MicexDoc:object, child_Sem25:object, child_Firm:object, child_Currency:object, child_Security:object;
   var DOC_REQUISITES = false, SEM25 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0;
   var stat:integer = 0;
   var NumImportComp:integer = 0, NumImportCompTotal:integer = 0;

   private macro RunImp()
      ErrMes = "";

      NumImportComp = NumImportComp + 1;

      if(ProcessTrn( 0, "PutCompInfo"))
         NumImportCompTotal = NumImportCompTotal + 1;
         RGLog.Message( "Компенсационный взнос для сделки \"" + Comp.RepoTradeNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
      else
         RGLog.Error( "Ошибка при загрузке компенсационного взноса для сделки \"" + Comp.RepoTradeNo + "\"\n" + ErrMes, RG );
         return 1;
      end;
      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   Comp.Init();

   NumImportComp = 0;
   NumImportCompTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры заявок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM25")
            if(SEM25)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM25 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM25 = true;
            Comp.ReportDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Comp.ReportDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM25 */
               child_Sem25 = child_MicexDoc.childNodes.item(j);
               if(child_Sem25 and (child_Sem25.nodeType==CHILD_NODE))

                  if(child_Sem25.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM25\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Sem25.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem25.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Firm.childNodes.length, "Загрузка внешнего файла компенсационных взносов", "Просмотр блоков данных по ценной бумаге...");
                              end;

                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))

                                    if(child_Currency.tagname == "SECURITY")
                                       m=0;
                                       if(GetDialogFlag())
                                          InitProgress(child_Currency.childNodes.length, "Загрузка внешнего файла компенсационных взносов", "Просмотр записей...");
                                       end;
                                       while(m<child_Currency.childNodes.length) /* бегаем по SECURITY */
                                          child_Security = child_Currency.childNodes.item(m);
                                          if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                             if(child_Security.tagname == "RECORDS")
                                                Comp.InitRecords();

                                                ReadTagAttribut(child_Security, "REPOTRADENO",   V_STRING,  Comp.RepoTradeNo);
                                                ReadTagAttribut(child_Security, "DIRECTION",     V_STRING,  Comp.Direction);
                                                ReadTagAttribut(child_Security, "CLIENTDETAILS", V_STRING,  Comp.ClientDetails);
                                                ReadTagAttribut(child_Security, "QUANTITY",      V_INTEGER, Comp.Quantity);
                                                ReadTagAttribut(child_Security, "VALUE",         V_MONEY,   Comp.Value);
                                                ReadTagAttribut(child_Security, "SETTLEDATE",    V_DATE,    Comp.SettleDate);
                                                ReadTagAttribut(child_Security, "RECNO",         V_INTEGER, Comp.RecNo);

                                                if( RunImp() )
                                                   stat = 1;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if(GetDialogFlag())
                                             UseProgress(m);
                                          end;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                       if(GetDialogFlag())
                                          RemProgress(); 
                                       end;
                                    end;

                                 end;
                                 l = l + 1;
                                 if(GetDialogFlag())
                                    UseProgress(l);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress();
                              end;
                           end;

                        end;
                        k = k + 1;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано компенсационных взносов - " + string(NumImportComp) + "\nиз них успешно - " + string(NumImportCompTotal) + "\nошибочно - " + string(NumImportComp - NumImportCompTotal));

   return stat;

OnError( RslErrObj )
   RemProgress(); RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

PRIVATE MACRO PutPaymInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_PAYM,
                   String("Выплата по сделке №" + Paym.RepoTradeNo),
                   Создать );

   if( NOT RG.InitByCode(RG_REQUEST, Paym.RepoTradeNo + "_" + string(Paym.RepoValueDate) + "_" + string(Paym.RecNo), SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("RGDLPAYM_REPORTDATE",     Paym.ReportDate);
   RG.SetParmByName("RGDLPAYM_REPOTRADENO",    Paym.RepoTradeNo);
   RG.SetParmByName("RGDLPAYM_REPOVALUEDATE",  Paym.RepoValueDate);
   RG.SetParmByName("RGDLPAYM_PRINCIPALVALUE", Paym.PrincipalValue);
   RG.SetParmByName("RGDLPAYM_COUPONVALUE",    Paym.CouponValue);
   RG.SetParmByName("RGDLPAYM_CLIENTDETAILS",  Paym.ClientDetails);
   RG.SetParmByName("RGDLPAYM_PAYMENTVALUE",   Paym.PaymentValue);

   if( RG.Save() != true )
      if( RG.GetLastError() )
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
END;
              
PRIVATE MACRO import_paym_to_gate_from( datafilename:STRING ):INTEGER

   var xml:object = ActiveX("MSXML.DOMDocument");
   var node:object, child_MicexDoc:object, child_Sem26:object, child_Firm:object, child_Currency:object, child_Security:object;
   var DOC_REQUISITES = false, SEM26 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0;
   var stat:integer = 0;
   var NumImportPaym:integer = 0, NumImportPaymTotal:integer = 0;

   private macro RunImp()
      ErrMes = "";

      NumImportPaym = NumImportPaym + 1;

      if(ProcessTrn( 0, "PutPaymInfo"))
         NumImportPaymTotal = NumImportPaymTotal + 1;
         RGLog.Message( "Выплата по сделке \"" + Paym.RepoTradeNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
      else
         RGLog.Error( "Ошибка при загрузке выплаты по сделке \"" + Paym.RepoTradeNo + "\"\n" + ErrMes, RG );
         return 1;
      end;
      return 0;

   OnError(ErObj)

      RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
      end;
      return ErObj.Code;
   end;

   Paym.Init();

   NumImportPaym = 0;
   NumImportPaymTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры заявок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM26")
            if(SEM26)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM26 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM26 = true;
            Paym.ReportDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Paym.ReportDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM26 */
               child_Sem26 = child_MicexDoc.childNodes.item(j);
               if(child_Sem26 and (child_Sem26.nodeType==CHILD_NODE))

                  if(child_Sem26.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM26\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Sem26.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem26.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Firm.childNodes.length, "Загрузка внешнего файла выплат", "Просмотр блоков данных по ценной бумаге...");
                              end;

                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))

                                    if(child_Currency.tagname == "SECURITY")
                                       m=0;
                                       if(GetDialogFlag())
                                          InitProgress(child_Currency.childNodes.length, "Загрузка внешнего файла выплат", "Просмотр записей...");
                                       end;
                                       while(m<child_Currency.childNodes.length) /* бегаем по SECURITY */
                                          child_Security = child_Currency.childNodes.item(m);
                                          if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                             if(child_Security.tagname == "RECORDS")
                                                Paym.InitRecords();

                                                ReadTagAttribut(child_Security, "REPOTRADENO",    V_STRING,  Paym.RepoTradeNo);
                                                ReadTagAttribut(child_Security, "REPOVALUEDATE",  V_DATE,    Paym.RepoValueDate);
                                                ReadTagAttribut(child_Security, "PRINCIPALVALUE", V_MONEY,   Paym.PrincipalValue);
                                                ReadTagAttribut(child_Security, "COUPONVALUE",    V_MONEY,   Paym.CouponValue);
                                                ReadTagAttribut(child_Security, "CLIENTDETAILS",  V_STRING,  Paym.ClientDetails);
                                                ReadTagAttribut(child_Security, "RECNO",          V_INTEGER, Paym.RecNo);
                                                ReadTagAttribut(child_Security, "PAYMENTVALUE",   V_MONEY,   Paym.PaymentValue);
                                                

                                                if( RunImp() )
                                                   stat = 1;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if(GetDialogFlag())
                                             UseProgress(m);
                                          end;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                       if(GetDialogFlag())
                                          RemProgress(); 
                                       end;
                                    end;

                                 end;
                                 l = l + 1;
                                 if(GetDialogFlag())
                                    UseProgress(l);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress();
                              end;
                           end;

                        end;
                        k = k + 1;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано выплат - " + string(NumImportPaym) + "\nиз них успешно - " + string(NumImportPaymTotal) + "\nошибочно - " + string(NumImportPaym - NumImportPaymTotal));

   return stat;

OnError( RslErrObj )
   RemProgress(); RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

PRIVATE MACRO PutNettoInfo()

  var FlagAbortTRN = false;

  macro Exit()
     FlagAbortTRN = true;
     AbortTRN;
  end;

  RG = TGTRecord( ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_DLITOGCLVR,
                  "Нетто-требование/нетто-обязательство " + NettoItog.LiabType + " на " + NettoItog.Currency + " c расчетным кодом " + NettoItog.ExtCode + " на " + string(NettoItog.ReportDate) + " из документа " + NettoItog.DocNo,
                  Создать );

  if( not RG.InitByCode(RG_DLITOGCLVR, "EQM13" + "_" + NettoItog.DocNo + "_" + NettoItog.ExtCode + "_" + NettoItog.Currency + "_" + NettoItog.LiabType + "_" + string(NettoItog.ReportDate), SOURCE_CODE) )
     AbortTRN;
  end;

  RG.SetParmByName("RGDLICVR_TYPE",     "EQM13");
  RG.SetParmByName("RGDLICVR_DATE",     NettoItog.ReportDate);
  RG.SetParmByName("RGDLICVR_EXTCODE",  NettoItog.ExtCode);
  RG.SetParmByName("RGDLICVR_CURRENCY", NettoItog.Currency);
  RG.SetParmByName("RGDLICVR_NETTOSUM", NettoItog.NettoSum); 
  RG.SetParmByName("RGDLICVR_LIABTYPE", NettoItog.LiabType);  

  if( RG.Save() != true )
     if( RG.GetLastError() )
        ErrMes = ErrMes + "\n" + RG.GetLastError();
     end;
     Exit();
  end;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     AbortTRN;
  else
     if( FlagAbortTRN == false )
        RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError(), RG);
     end;
  end;
END;

PRIVATE MACRO import_netto_to_gate_from_EQM13(datafilename:STRING):INTEGER

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportNetto:integer = 0, NumImportNettoTotal:integer = 0;
  var node:object, child_MicexDoc:object, child_EQM13:object, child_FIRM:object, child_SETTLE:object, child_POSTYPES:object, child_GROUP:object, child_CURRENCY:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, l:integer = 0, m:integer = 0, n:integer = 0, p:integer = 0;

  private macro RunImp()
      ErrMes = "";
      var CodeNettoItog = "EQM13" + "_" + NettoItog.DocNo + "_" + NettoItog.ExtCode + "_" + NettoItog.Currency + "_" + NettoItog.LiabType + "_" + string(NettoItog.ReportDate);      

      NumImportNetto = NumImportNetto + 1;

     if( ProcessTrn(0, "PutNettoInfo") )
        NumImportNettoTotal = NumImportNettoTotal + 1;
        RGLog.Message("Успешно загружены итоговые нетто-требования и нетто-обязательства \"" + CodeNettoItog + "\"\n" + ErrMes, RG, SUCCESS);
     else
        RGLog.Error("Ошибка при загрузке итоговых нетто-требований и нетто-обязательств \"" + CodeNettoItog + "\"\n" + ErrMes, RG);
        return 1;
     end;
      return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  NettoItog.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;

  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "DOC_REQUISITES" )
           NettoItog.DocNo = "";
           if( ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, NettoItog.DocNo) == false )
              /* если не нашли уникальный учетный номер документа в системе электронного документооборота */
           end;
        end;
        if( StrUpr(child_MicexDoc.tagname) == "EQM13" )
           NettoItog.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, NettoItog.ReportDate) == false )
              /* если не нашли дату формирования отчета */
           end;
           j = 0;
           while( j < child_MicexDoc.childNodes.length ) /* бегаем по EQM13 */
              child_EQM13 = child_MicexDoc.childNodes.item(j);
              if( child_EQM13 and (child_EQM13.nodeType == CHILD_NODE) )
                 if( StrUpr(child_EQM13.tagname) == "FIRM" )
                    k = 0;
                    while( k < child_EQM13.childNodes.length ) /* бегаем по FIRM */
                       child_FIRM = child_EQM13.childNodes.item(k);
                       if( child_FIRM and (child_FIRM.nodeType == CHILD_NODE) )
                          if( StrUpr(child_FIRM.tagname) == "SETTLE" )
                             NettoItog.ExtCode = "";
                             if( ReadTagAttribut(child_FIRM, "EXTSETTLECODE", V_STRING, NettoItog.ExtCode) == false )
                                /* если не нашли расчетный код участника клиринга */
                             end;
                             l = 0;
                             while( l < child_FIRM.childNodes.length ) /* бегаем по SETTLE */
                                child_SETTLE = child_FIRM.childNodes.item(l);
                                if( child_SETTLE and (child_SETTLE.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_SETTLE.tagname) == "POSTYPES" )
                                      NettoItog.PosType = "";
                                      if( ReadTagAttribut(child_SETTLE, "POSTYPE", V_STRING, NettoItog.PosType) == false )
                                         /* если не нашли тип информации: по денежной позиции или по депозитарному разделу */
                                      end;
                                      if( NettoItog.PosType == "C" ) // Из отчета загружаются данные узлов <PosTypes>, в которых значение параметра PosType равно "C"
                                         m = 0;
                                         while( m < child_SETTLE.childNodes.length ) /* бегаем по POSTYPES */
                                            child_POSTYPES = child_SETTLE.childNodes.item(m);
                                            if( child_POSTYPES and (child_POSTYPES.nodeType == CHILD_NODE) )
                                               if( StrUpr(child_POSTYPES.tagname) == "GROUP" )
                                                  if(GetDialogFlag())
                                                     InitProgress(child_POSTYPES.childNodes.length, "Загрузка внешнего файла итогов по ФИ", "Просмотр записей...");
                                                  end;
                                                  n = 0;
                                                  while( n < child_POSTYPES.childNodes.length ) /* бегаем по GROUP */
                                                     child_GROUP = child_POSTYPES.childNodes.item(n);
                                                     if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                                                        if( StrUpr(child_GROUP.tagname) == "CURRENCY" )
                                                           NettoItog.Currency = "";
                                                           if( ReadTagAttribut(child_GROUP, "CURRENCYID", V_STRING, NettoItog.Currency) == false )
                                                              /* если не нашли идентификатор валюты / драгоценного металла */
                                                           end;
                                                           p = 0;
                                                           while( p < child_GROUP.childNodes.length ) /* бегаем по CURRENCY */
                                                              child_CURRENCY = child_GROUP.childNodes.item(p);
                                                              if( child_CURRENCY and (child_CURRENCY.nodeType == CHILD_NODE) )
                                                                 if( StrUpr(child_CURRENCY.tagname) == "RECORDS" )
                                                                    NettoItog.InitRecords();
                                                                    if( ReadTagAttribut(child_CURRENCY, "DATATYPE", V_STRING, NettoItog.LiabType) == false )
                                                                       /* если не нашли тип обязательства */
                                                                    end;
                                                                    if(SubStr(NettoItog.LiabType, 1, 5) != "DEPO_") // Загрузка данных по депозитным операциям фондового рынка не выполняется, т.к. операции данного типа в системе не поддерживаются 
                                                                       if( ReadTagAttribut(child_CURRENCY, "DEBIT", V_STRING, NettoItog.Debit) == false )
                                                                          /* если не нашли нетто-обязательство */
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "CREDIT", V_STRING, NettoItog.Credit) == false )
                                                                          /* если не нашли нетто-требование */
                                                                       end;
                                                                       NettoItog.NettoSum = NettoItog.Credit - NettoItog.Debit;
                                                        
                                                                       if( RunImp() )
                                                                          stat = 1;
                                                                       end;
                                                                    end;
                                                                 end;
                                                              end;
                                                              p = p + 1;
                                                           end;
                                                        end;
                                                     end;
                                                     n = n + 1;
                                                     if( GetDialogFlag() )
                                                        UseProgress(n);
                                                     end;
                                                     if( FlagCtrlBrk == true )
                                                        break;
                                                     end;
                                                  end;
                                                  if( GetDialogFlag() )
                                                     RemProgress(); 
                                                  end;
                                               end;
                                            end;
                                            m = m + 1;
                                         end;
                                      end;
                                   end;
                                end;
                                l = l + 1;
                             end;
                          end;
                       end;
                       k = k + 1;
                    end;
                 end;
              end;
              j = j + 1;
           end;
        end;
     end;
     i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано итогов по ФИ - " + string(NumImportNetto) + "\nиз них успешно - " + string(NumImportNettoTotal) + "\nошибочно - " + string(NumImportNetto - NumImportNettoTotal));

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
END;

PRIVATE MACRO PutKSUWRTInfo()

  var FlagAbortTRN = false;

  macro Exit()
     FlagAbortTRN = true;
     AbortTRN;
  end;

  RG = TGTRecord( ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_DLKSUWRT,
                  "Выдача/погашение КСУ № " + KSUWRT.DocNo + " на " + string(KSUWRT.ReportDate),
                  Создать );

  if( not RG.InitByCode(RG_DLKSUWRT, KSUWRT.DocNo + "_" + string(KSUWRT.ReportDate), SOURCE_CODE) )
     AbortTRN;
  end;

  if( KSUWRT.Credit != 0 )
     RG.SetParmByName("RGDLWRT_DEALTYPE",ЗачислениеЦБ);
     RG.SetParmByName("RGDLWRT_AMOUNT",    abs(KSUWRT.Credit)); 
  elif( KSUWRT.Debit != 0 )
     RG.SetParmByName("RGDLWRT_DEALTYPE",СписаниеЦБ);
     RG.SetParmByName("RGDLWRT_AMOUNT",    abs(KSUWRT.Debit)); 
  end;

  RG.SetParmByName("RGDLWRT_DEALCODETS", KSUWRT.DocNo);
  RG.SetParmByName("RGDLWRT_DEALDATE",   KSUWRT.ReportDate);
  RG.SetParmByName("RGDLWRT_DEALTIME",   KSUWRT.OperationTime);
  RG.SetParmByName("RGDLWRT_ISIN",       KSUWRT.ISIN);
  RG.SetParmByName("RGDLWRT_SECURITYID", KSUWRT.SecurityId);
  RG.SetParmByName("RGDLWRT_BANKACCID",  KSUWRT.BankAccID);
  RG.SetParmByName("RGDLWRT_TRDACCID",   KSUWRT.TrdAccID);
  RG.SetParmByName("RGDLWRT_MARKET",     MMVB_Code);

  if( RG.Save() != true )
     if( RG.GetLastError() )
        ErrMes = ErrMes + "\n" + RG.GetLastError();
     end;
     Exit();
  end;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     AbortTRN;
  else
     if( FlagAbortTRN == false )
        RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError(), RG);
     end;
  end;
END;

PRIVATE MACRO import_ksu_to_gate_from_EQM99(datafilename:STRING):INTEGER

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportKSU:integer = 0, NumImportKSUTotal:integer = 0;
  var node:object, child_MicexDoc:object, child_EQM99:object, child_FIRM:object, child_BANKACC:object, child_POSTYPES:object, child_GROUP:object, child_RECORDS:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, l:integer = 0, m:integer = 0, n:integer = 0, p:integer = 0;
  var PosType = "", OperationCode = "";

  private macro RunImp()
      ErrMes = "";

      NumImportKSU = NumImportKSU + 1;

     if( ProcessTrn(0, "PutKSUWRTInfo") )
        NumImportKSUTotal = NumImportKSUTotal + 1;
        RGLog.Message("Успешно загружены данные о выдаче/погашении КСУ с кодом \"" + KSUWRT.DocNo + "\"\n" + ErrMes, RG, SUCCESS);
     else
        RGLog.Error("Ошибка при загрузке данных о выдаче/погашении КСУ с кодом \"" + KSUWRT.DocNo + "\"\n" + ErrMes, RG);
        return 1;
     end;
      return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  KSUWRT.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;
  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "EQM99" )
           KSUWRT.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, KSUWRT.ReportDate) == false )
              /* если не нашли дату формирования отчета */
           end;
           j = 0;
           while( j < child_MicexDoc.childNodes.length ) /* бегаем по EQM99 */
              child_EQM99 = child_MicexDoc.childNodes.item(j);
              if( child_EQM99 and (child_EQM99.nodeType == CHILD_NODE) )
                 if( StrUpr(child_EQM99.tagname) == "FIRM" )
                    k = 0;
                    while( k < child_EQM99.childNodes.length ) /* бегаем по FIRM */
                       child_FIRM = child_EQM99.childNodes.item(k);
                       if( child_FIRM and (child_FIRM.nodeType == CHILD_NODE) )
                          if( StrUpr(child_FIRM.tagname) == "BANKACC" )
                             KSUWRT.BankAccID = "";
                             if( ReadTagAttribut(child_FIRM, "BANKACCID", V_STRING, KSUWRT.BankAccID) == false )
                                /* если не нашли расчетный код участника клиринга */
                             end;
                             l = 0;
                             while( l < child_FIRM.childNodes.length ) /* бегаем по BANKACC */
                                child_BANKACC = child_FIRM.childNodes.item(l);
                                if( child_BANKACC and (child_BANKACC.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_BANKACC.tagname) == "POSTYPES" )
                                      PosType = "";
                                      if( ReadTagAttribut(child_BANKACC, "POSTYPE", V_STRING, PosType) == false )
                                         /* если не нашли тип информации: по денежной позиции или по депозитарному разделу */
                                      end;
                                      if( PosType == "S" ) // Из отчета загружаются данные узлов <PosTypes>, в которых значение параметра PosType равно "S"
                                         m = 0;
                                         while( m < child_BANKACC.childNodes.length ) /* бегаем по POSTYPES */
                                            child_POSTYPES = child_BANKACC.childNodes.item(m);
                                            if( child_POSTYPES and (child_POSTYPES.nodeType == CHILD_NODE) )
                                               if( StrUpr(child_POSTYPES.tagname) == "GROUP" )
                                                  KSUWRT.TrdAccId = "";
                                                  if( ReadTagAttribut(child_POSTYPES, "TRDACCID", V_STRING, KSUWRT.TrdAccId) == false )
                                                     /* если не нашли Код Торгово-клирингового счета */
                                                  end;
                                                  if(GetDialogFlag())
                                                     InitProgress(child_POSTYPES.childNodes.length, "Загрузка внешнего файла данных о выдаче/погашении КСУ", "Просмотр записей...");
                                                  end;
                                                  n = 0;
                                                  while( n < child_POSTYPES.childNodes.length )
                                                     child_GROUP = child_POSTYPES.childNodes.item(n);
                                                     if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                                                        if( StrUpr(child_GROUP.tagname) == "RECORDS" )
                                                           KSUWRT.ISIN = "";
                                                           if( ReadTagAttribut(child_GROUP, "ISIN", V_STRING, KSUWRT.ISIN) == false )
                                                           end;
                                                           KSUWRT.SecurityId = "";
                                                           if( ReadTagAttribut(child_GROUP, "SECURITYID", V_STRING, KSUWRT.SecurityId) == false )
                                                           end;
                                                           p = 0;
                                                           while( p < child_GROUP.childNodes.length )
                                                              child_RECORDS = child_GROUP.childNodes.item(p);
                                                              if( child_RECORDS and (child_RECORDS.nodeType == CHILD_NODE) )
                                                                 if( StrUpr(child_RECORDS.tagname) == "ENTRY" )

                                                                    KSUWRT.InitRecords();

                                                                    OperationCode = "";
                                                                    if( ReadTagAttribut(child_RECORDS, "OPERATIONCODE", V_STRING, OperationCode) == false )
                                                                    end;
                                                                    if( ReadTagAttribut(child_RECORDS, "DOCNO", V_STRING, KSUWRT.DocNo) == false )
                                                                    end;

                                                                    if( ((OperationCode == "22") or (OperationCode == "23")) and (KSUWRT.DocNo != "") )

                                                                       ReadTagAttribut(child_RECORDS, "OPERATIONTIME", V_TIME, KSUWRT.OperationTime);
                                                                       ReadTagAttribut(child_RECORDS, "DEBIT", V_MONEY, KSUWRT.Debit);
                                                                       ReadTagAttribut(child_RECORDS, "CREDIT", V_MONEY, KSUWRT.Credit);
                                                                       
                                                                       if( RunImp() )
                                                                          stat = 1;
                                                                       end;

                                                                    end;
                                                             
                                                                 end;
                                                              end;
                                                              p = p + 1;
                                                           end;
                                                        end;
                                                     end;
                                                     n = n + 1;
                                                     if( GetDialogFlag() )
                                                        UseProgress(n);
                                                     end;
                                                     if( FlagCtrlBrk == true )
                                                        break;
                                                     end;
                                                  end;
                                                  if( GetDialogFlag() )
                                                     RemProgress(); 
                                                  end;
                                               end;
                                            end;
                                            m = m + 1;
                                         end;
                                      end;
                                   end;
                                end;
                                l = l + 1;
                             end;
                          end;
                       end;
                       k = k + 1;
                    end;
                 end;
              end;
              j = j + 1;
           end;
        end;
     end;
     i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано данных о выдаче/погашении КСУ - " + string(NumImportKSU) + "\nиз них успешно - " + string(NumImportKSUTotal) + "\nошибочно - " + string(NumImportKSU - NumImportKSUTotal));

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
END;

PRIVATE MACRO import_incREPO_to_gate_from_EQM98(datafilename:STRING):INTEGER

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportIncREPO:integer = 0, NumImportIncREPOTotal:integer = 0;
  var node:object, child_MicexDoc:object, child_EQM98:object, child_FIRM:object, child_BANKACC:object, child_POSTYPES:object, child_GROUP:object, child_CURRENCY:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, l:integer = 0, m:integer = 0, n:integer = 0, p:integer = 0;
  var PosType = "", Type = "", DebitCredit = "", EntryDate = date(0,0,0);
  var NumImportDvdREPO:integer = 0, NumImportDvdREPOTotal:integer = 0;
  var ExtSettleCodeID = "", CurrencyId = "";

  private macro RunImpMoneyMotion()
      ErrMes = "";

      NumImportIncREPO = NumImportIncREPO + 1;

     if( ProcessTrn(0, "PutMoneyMotion") )
        NumImportIncREPOTotal = NumImportIncREPOTotal + 1;
        RGLog.Message("Успешно загружены Т/О по передаче дохода по РЕПО с кодом \"" + MoneyMotion.EntryNumber + "\"\n" + ErrMes, RG, SUCCESS);
     else
        RGLog.Error("Ошибка при загрузке Т/О по передаче дохода по РЕПО с кодом \"" + MoneyMotion.EntryNumber + "\"\n" + ErrMes, RG);
        return 1;
     end;
      return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  private macro RunImpDividends()
     ErrMes = "";

     NumImportDvdREPO = NumImportDvdREPO + 1;

     if( ProcessTrn(0, "PutDividends") )
        NumImportDvdREPOTotal = NumImportDvdREPOTotal + 1;
        RGLog.Message("Успешно загружены данные по получению дивидендов по РЕПО с кодом \"" + Dividends.TRADENO + "\"\n" + ErrMes, RG, SUCCESS);
     else
        RGLog.Error("Ошибка при загрузке данных по получению дивидендов по РЕПО с кодом \"" + Dividends.TRADENO + "\"\n" + ErrMes, RG);
        return 1;
     end;
     return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  MoneyMotion.Init();
  Dividends.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;
  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "EQM98" )
           EntryDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, EntryDate) == false )
              /* если не нашли дату формирования отчета */
           end;
           j = 0;
           while( j < child_MicexDoc.childNodes.length ) /* бегаем по EQM98 */
              child_EQM98 = child_MicexDoc.childNodes.item(j);
              if( child_EQM98 and (child_EQM98.nodeType == CHILD_NODE) )
                 if( StrUpr(child_EQM98.tagname) == "FIRM" )
                    k = 0;
                    while( k < child_EQM98.childNodes.length ) /* бегаем по FIRM */
                       child_FIRM = child_EQM98.childNodes.item(k);
                       if( child_FIRM and (child_FIRM.nodeType == CHILD_NODE) )
                          if( StrUpr(child_FIRM.tagname) == "BANKACC" )
                             ExtSettleCodeID = "";
                             if( ReadTagAttribut(child_FIRM, "BANKACCID", V_STRING, ExtSettleCodeID) == false )
                                /* если не нашли расчетный код участника клиринга */
                             end;
                             l = 0;
                             while( l < child_FIRM.childNodes.length ) /* бегаем по BANKACC */
                                child_BANKACC = child_FIRM.childNodes.item(l);
                                if( child_BANKACC and (child_BANKACC.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_BANKACC.tagname) == "POSTYPES" )
                                      PosType = "";
                                      if( ReadTagAttribut(child_BANKACC, "POSTYPE", V_STRING, PosType) == false )
                                      end;
                                      if( PosType == "C" )
                                         m = 0;
                                         while( m < child_BANKACC.childNodes.length ) /* бегаем по POSTYPES */
                                            child_POSTYPES = child_BANKACC.childNodes.item(m);
                                            if( child_POSTYPES and (child_POSTYPES.nodeType == CHILD_NODE) )
                                               if( StrUpr(child_POSTYPES.tagname) == "GROUP" )
                                                  if(GetDialogFlag())
                                                     InitProgress(child_POSTYPES.childNodes.length, "Загрузка внешнего файла данных Т/О по передаче дохода по РЕПО", "Просмотр записей...");
                                                  end;
                                                  n = 0;
                                                  while( n < child_POSTYPES.childNodes.length )
                                                     child_GROUP = child_POSTYPES.childNodes.item(n);
                                                     if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                                                        if( StrUpr(child_GROUP.tagname) == "CURRENCY" )
                                                           CurrencyId = "";
                                                           if( ReadTagAttribut(child_GROUP, "CURRENCYID", V_STRING, CurrencyId) == false )
                                                           end;
                                                           p = 0;
                                                           while( p < child_GROUP.childNodes.length )
                                                              child_CURRENCY = child_GROUP.childNodes.item(p);
                                                              if( child_CURRENCY and (child_CURRENCY.nodeType == CHILD_NODE) )
                                                                 if( StrUpr(child_CURRENCY.tagname) == "RECORDS" )
                                                                    Type = "";
                                                                    if( ReadTagAttribut(child_CURRENCY, "TYPE", V_STRING, Type) == false )
                                                                    end;
                                                                    DebitCredit = "";
                                                                    if( ReadTagAttribut(child_CURRENCY, "DEBITCREDIT", V_STRING, DebitCredit) == false )
                                                                    end;
                                                                    if( (pp.IncREPO == SET_CHAR) and (StrUpr(Type) == "COUPON_PAYMENT") )
                                                                       MoneyMotion.ExtSettleCodeID = ExtSettleCodeID;
                                                                       MoneyMotion.CurrencyId = CurrencyId;
                                                                       MoneyMotion.InitRecords();
                                                                       MoneyMotion.EntryCodeType = 9999;/*спецномер для переводов вида <Возврат дохода контрагенту по сделке обратного РЕПО> и <Получение дохода от контрагента по сделке прямого РЕПО>*/
                                                                       MoneyMotion.EntryDate = EntryDate;
                                                                       if( ReadTagAttribut(child_CURRENCY, "TRADENO", V_STRING, MoneyMotion.EntryNumber) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "CLIENTCODE", V_STRING, MoneyMotion.ClientCode) == false )
                                                                       end;
                                                                       if( DebitCredit == "D" )
                                                                          if( ReadTagAttribut(child_CURRENCY, "SUM", V_MONEY, MoneyMotion.EntryDebit) == false )
                                                                          end;
                                                                       else
                                                                          if( ReadTagAttribut(child_CURRENCY, "SUM", V_MONEY, MoneyMotion.EntryCredit) == false )
                                                                          end;
                                                                       end;
                                                                       if( RunImpMoneyMotion() )
                                                                          stat = 1;
                                                                       end;
                                                                    end;
                                                                    if( (pp.DividREPO == SET_CHAR) and (StrUpr(Type) == "DIVIDEND_PAYMENT") and (DebitCredit == "C") )
                                                                       Dividends.Init();
                                                                       Dividends.CurrencyId = CurrencyId;
                                                                       Dividends.Ext_SettleCode = ExtSettleCodeID;
                                                                       Dividends.ReportDate = EntryDate;
                                                                       Dividends.DealType = ПолучДивидендовРЕПО;

                                                                       if( ReadTagAttribut(child_CURRENCY, "TRADENO", V_STRING, Dividends.TRADENO) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "SUM", V_MONEY, Dividends.Sum) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "ISIN", V_STRING, Dividends.ISIN) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "QUANTITY", V_MONEY, Dividends.Quantity) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "PRICE", V_DOUBLE, Dividends.Price) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "D1", V_MONEY, Dividends.D1) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "D2", V_MONEY, Dividends.D2) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "TAX", V_MONEY, Dividends.Tax) == false )
                                                                       end;
                                                                       if( ReadTagAttribut(child_CURRENCY, "RECORDDATE", V_DATE, Dividends.RecordDate) == false )
                                                                       end;

                                                                       if( RunImpDividends() )
                                                                          stat = 1;
                                                                       end;
                                                                    end;
                                                                 end;
                                                              end;
                                                              p = p + 1;
                                                           end;
                                                        end;
                                                     end;
                                                     n = n + 1;
                                                     if( GetDialogFlag() )
                                                        UseProgress(n);
                                                     end;
                                                     if( FlagCtrlBrk == true )
                                                        break;
                                                     end;
                                                  end;
                                                  if( GetDialogFlag() )
                                                     RemProgress(); 
                                                  end;
                                               end;
                                            end;
                                            m = m + 1;
                                         end;
                                      end;
                                   end;
                                end;
                                l = l + 1;
                             end;
                          end;
                       end;
                       k = k + 1;
                    end;
                 end;
              end;
              j = j + 1;
           end;
        end;
     end;
     i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  if(pp.IncREPO == SET_CHAR)
  RGLog.Message("Всего обработано Т/О по передаче дохода по РЕПО - " + string(NumImportIncREPO) + "\nиз них успешно - " + string(NumImportIncREPOTotal) + "\nошибочно - " + string(NumImportIncREPO - NumImportIncREPOTotal));
  end;
  if(pp.DividREPO == SET_CHAR)
     RGLog.Message("Всего обработано данных по получению дивидендов по РЕПО - " + string(NumImportDvdREPO) + "\nиз них успешно - " + string(NumImportDvdREPOTotal) + "\nошибочно - " + string(NumImportDvdREPO - NumImportDvdREPOTotal));
  end;

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
END;

private macro ResultCopyFile(done:bool, data_filepath:string, data_filename:string)
/*ak - ничего никуда не переностим*/
   return;
/*~ak*/

   var data_file_new_path, data_file_new_file;

   if(done)
      data_file_new_path = data_filepath + "Done\\";
   else
      data_file_new_path = data_filepath + "Err\\";
   end;

   MakeDir(data_file_new_path);
   data_file_new_path = data_file_new_path + string(FileDate(imp_date)) + "\\";
   MakeDir(data_file_new_path);

   data_file_new_file = data_file_new_path + data_filename;

   if(not CopyFile(data_filepath + data_filename, data_file_new_file ) )
      RGLog.Error("Ошибка копирования файла " + data_filename + " в " + data_file_new_file);
   else
      RGLog.Message("Файл " + data_filename + " скопирован в " + data_file_new_file);
      RemoveFile(data_filepath + data_filename);
   end;

end;

private macro RunImportMVB4( Pan )
   var stat:integer, data_file_SEM03_arr = TArray(), data_file_EQM06_arr = TArray(), data_file_EQM13_list = NULL, data_file_CCX99_list = NULL, i = 0;
   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "";
   var data_filepath_EQM6C:string = "", data_filename_EQM6C:string = "";
   var data_filepath_SEM02:string = "", data_filename_SEM02:string = "";
   var data_filepath_SEM03:string = "", data_filename_SEM03:string = "";
   var data_filepath_SET21:string = "", data_filename_SET21:string = "";
   var data_filepath_SET25:string = "", data_filename_SET25:string = "";
   var data_filepath_SET26:string = "", data_filename_SET26:string = "";
   var data_filepath_CCX99:string = "", data_filename_CCX99:string = "";
   var data_filepath_EQM13:string = "", data_filename_EQM13:string = "";
   var data_filepath_EQM99:string = "", data_filename_EQM99:string = "";
   var data_filepath_EQM98:string = "", data_filename_EQM98:string = "";
   var RetVal = CM_SAVE;
   var SEM02_FilenameSessionNumber = 1;
   var SEM03_FilenameSessionNumber = 1;

   data_file_SEM03_arr.size = 0;
   data_file_EQM06_arr.size = 0;

   if( CheckPanel(Pan, @MMVB_Code, @MarketScheme_BO, @MarketScheme_DU, true, @MarketID) == false )
      RetVal = CM_IGNORE;
   end;

   if( RetVal != CM_IGNORE )
      RGLog = GTDL_Log(SeanceID);
      imp_date = Pan.imp_date;

      if( Pan.comp == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА КОМПЕНСАЦИОННЫХ ВЗНОСОВ В РЕПО");
         stat = 1;
         if( MMVB_Code == MICEX_CODE_FB )
            stat = get_data_file_name("KVREPO", "SEM25", @data_filepath_SET25, @data_filename_SET25);
         end;

         if( stat == 0 )
            if( import_comp_to_gate_from(data_filepath_SET25 + data_filename_SET25) == 0 )
               ResultCopyFile(true, data_filepath_SET25, data_filename_SET25)
            else
               ResultCopyFile(false, data_filepath_SET25, data_filename_SET25)
            end;
         end;

      end;

      if( Pan.paym == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА ВЫПЛАТ В РЕПО");
         stat = 1;
         if( MMVB_Code == MICEX_CODE_FB )
            stat = get_data_file_name("HPREPO", "SEM26", @data_filepath_SET26, @data_filename_SET26);
         end;

         if( stat == 0 )
            if( import_paym_to_gate_from(data_filepath_SET26 + data_filename_SET26) == 0 )
               ResultCopyFile(true, data_filepath_SET26, data_filename_SET26)
            else
               ResultCopyFile(false, data_filepath_SET26, data_filename_SET26)
            end;
         end;

      end;

      if( Pan.rates == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА КОТИРОВОК");
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("QUOTESX", "SEM21", @data_filepath_SET21, @data_filename_SET21);
         end;
         if(stat == 0)
            if(import_rates_to_gate_from_SEM21( data_filepath_SET21 + data_filename_SET21 ) == 0)
               ResultCopyFile(true, data_filepath_SET21, data_filename_SET21);
            else
               ResultCopyFile(false, data_filepath_SET21, data_filename_SET21);
            end;
         end;
      end;

      if( Pan.request == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА ЗАЯВОК НА СДЕЛКИ");
         if( not DL_ИспользPaymentsПриИмпорте(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            stat = 1;
            //загружаем файлы первой(основной + доп. утренней) сессии и файлы второй(дополнительной) сессии
            SEM02_FilenameSessionNumber = 1;
            while (SEM02_FilenameSessionNumber <= 2)
               if(MMVB_Code == MICEX_CODE_FB)
                  stat = get_data_file_name("ORDERSX", "SEM02", @data_filepath_SEM02, @data_filename_SEM02, null, SEM02_FilenameSessionNumber);
               end;
   
               if(stat == 0)
                  if(import_request_to_gate_SEM02( data_filepath_SEM02 + data_filename_SEM02, data_filename_SEM02, SEM02_FilenameSessionNumber) == 0)
                     ResultCopyFile(true, data_filepath_SEM02, data_filename_SEM02)
                  else
                     ResultCopyFile(false, data_filepath_SEM02, data_filename_SEM02)
                  end;
               end;
   
               SEM02_FilenameSessionNumber = SEM02_FilenameSessionNumber + 1;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ ЗАЯВОК НА СДЕЛКИ НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      /*предварительно находим, какие файлы клиринга есть в каталоге*/
      if( ((Pan.deals == SET_CHAR) OR (Pan.deals_clearing == SET_CHAR)) and (MMVB_Code == MICEX_CODE_FB) )
         stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, null, 2, true);
         data_file_EQM06_arr[data_file_EQM06_arr.size] = Data_file(data_filepath_EQM06, data_filename_EQM06, 2, stat);
         stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, null, 3, true);
         data_file_EQM06_arr[data_file_EQM06_arr.size] = Data_file(data_filepath_EQM06, data_filename_EQM06, 3, stat);
         stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, null, 4, true);
         data_file_EQM06_arr[data_file_EQM06_arr.size] = Data_file(data_filepath_EQM06, data_filename_EQM06, 4, stat);
      end;

      if( Pan.deals == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ SEM03");
         if( not DL_ИспользPaymentsПриИмпорте(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            stat = 1;
            RECORDID_Deals = 0;
            RECORDID_Deals_DV = 0;
            RECORDID_MarketReport = 0;
   
            SEM03_FilenameSessionNumber = 1;
            while (SEM03_FilenameSessionNumber <= 2)
               if(MMVB_Code == MICEX_CODE_FB)
                  stat = get_data_file_name("DEALX", "SEM03", @data_filepath_SEM03, @data_filename_SEM03, null, SEM03_FilenameSessionNumber);
               end;
      
               if(stat == 0)
                  stat = import_deals_to_gate_from_SEM03( data_filepath_SEM03 + data_filename_SEM03, data_filename_SEM03, data_file_EQM06_arr, SEM03_FilenameSessionNumber);
                  if(Pan.deals_clearing != SET_CHAR)
                     if( stat == 0 )
                        ResultCopyFile(true, data_filepath_SEM03, data_filename_SEM03);
                     else
                        ResultCopyFile(false, data_filepath_SEM03, data_filename_SEM03);
                     end;
                  else//сохраним, чтобы ниже закрыть
                     data_file_SEM03_arr[data_file_SEM03_arr.size] = Data_file(data_filepath_SEM03, data_filename_SEM03, NULL, stat);
                  end;
               end;
      
               SEM03_FilenameSessionNumber = SEM03_FilenameSessionNumber + 1;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ СДЕЛОК ИЗ SEM03 НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if( Pan.deals_clearing == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ EQM06");
         if( not DL_ИспользPaymentsПриИмпорте(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            stat = 0;
            RECORDID_Deals_Cliring = 0;
            if( data_file_EQM06_arr.size > 0 )
               if( (data_file_EQM06_arr[ОСНОВНАЯ_003].stat == 1) and (data_file_EQM06_arr[ОСНОВНАЯ_002].stat == 1) )
                  RGLog.Error( "Не найден файл данных основной сессии по маске: "
                               + data_file_EQM06_arr[ОСНОВНАЯ_003].data_filepath + data_file_EQM06_arr[ОСНОВНАЯ_003].data_filename + " или "
                               + data_file_EQM06_arr[ОСНОВНАЯ_002].data_filepath + data_file_EQM06_arr[ОСНОВНАЯ_002].data_filename
                             );
                  stat = 1;
               end;
               i = 0;
               if(stat == 0)
                  while( i < data_file_EQM06_arr.size )
                     if(data_file_EQM06_arr[i].stat == 0)
                        /*проверка на случай, если положат и 002 и 003 (в этом случае грузим только 003)*/
                        if( (i == ОСНОВНАЯ_002) and (data_file_EQM06_arr[ОСНОВНАЯ_003].stat == 0) and (data_file_EQM06_arr[ОСНОВНАЯ_002].stat == 0) )
                           i = i + 1;
                           continue;
                        end;
                        RGLog.Message("Используется файл " + data_file_EQM06_arr[i].data_filename);
                        if(import_deals_to_gate_from_EQM06( data_file_EQM06_arr[i].data_filepath + data_file_EQM06_arr[i].data_filename, data_file_EQM06_arr[i].data_filename) == 0)
                           ResultCopyFile(true, data_file_EQM06_arr[i].data_filepath, data_file_EQM06_arr[i].data_filename);
                        else
                           ResultCopyFile(false, data_file_EQM06_arr[i].data_filepath, data_file_EQM06_arr[i].data_filename);
                        end;
                     end;
                     i = i + 1;
                  end;
               end;
               if( data_file_EQM06_arr[ВЕЧЕРНЯЯ].stat == 1 )
                  /*просто предупреждение (наличие, например, в утренней сессии необязательно)*/
                  RGLog.Message( "Не найден файл вечерней сессии по маске:"
                                 + data_file_EQM06_arr[ВЕЧЕРНЯЯ].data_filepath + data_file_EQM06_arr[ВЕЧЕРНЯЯ].data_filename
                               );
               end;
            end;
            if(Pan.deals == SET_CHAR)
               if( data_file_SEM03_arr.size > 0 )
                  i = 0;
                  while( i < data_file_SEM03_arr.size )
                     if( data_file_SEM03_arr[i].stat == 0 )
                        ResultCopyFile(true, data_file_SEM03_arr[i].data_filepath, data_file_SEM03_arr[i].data_filename);
                     else
                        ResultCopyFile(false, data_file_SEM03_arr[i].data_filepath, data_file_SEM03_arr[i].data_filename);
                     end;
                     i = i + 1;
                  end;
               end;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ СДЕЛОК ИЗ EQM06 НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if(Pan.MoneyMotion == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ДВИЖЕНИЯ ДЕНЕЖНЫХ СРЕДСТВ");
         if(not DL_ИспользPaymentsПриИмпортеВалютногоРынка(@ErrMes))
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            stat = 1;      
            if(MMVB_Code == MICEX_CODE_FB)
               data_file_CCX99_list = get_data_file_name("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_CCX99);
               stat = 0;  
            end;
        
            if((stat == 0) AND (data_file_CCX99_list != NULL))
               i = 0;
               while(i < data_file_CCX99_list.Count)
                 RGLog.Message("Используется файл " + data_file_CCX99_list.name(i));
                 if(import_deals_to_gate_from_CCX99(data_filepath_CCX99 + data_file_CCX99_list.name(i)))
                     ResultCopyFile(true, data_filepath_CCX99, data_file_CCX99_list.name(i));
                 else
                     ResultCopyFile(false, data_filepath_CCX99, data_file_CCX99_list.name(i));
                 end;
                 i = i + 1;
               end;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ ДВИЖЕНИЙ ДЕНЕЖНЫХ СРЕДСТВ НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ_ВР, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if(Pan.NettoItog == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ИТОГОВЫХ НЕТТО-ТРЕБОВАНИЙ И НЕТТО-ОБЯЗАТЕЛЬСТВ");
         if( not DL_ИспользPaymentsПриИмпортеММВБЧасть2(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            stat = 1;
            if(MMVB_Code == MICEX_CODE_FB)
               data_file_EQM13_list = get_data_file_name("CLEARX_NET", "EQM13", @data_filepath_EQM13, @data_filename_EQM13); 
               stat = 0;  
            end;
            if( (stat == 0) and (data_file_EQM13_list != NULL) )
               i = 0;
               while( i < data_file_EQM13_list.Count )
                  RGLog.Message("Используется файл " + data_file_EQM13_list.name(i));
                  if(import_netto_to_gate_from_EQM13(data_filepath_EQM13 + data_file_EQM13_list.name(i)) == 0)
                     ResultCopyFile(true, data_filepath_EQM13, data_file_EQM13_list.name(i));
                  else
                     ResultCopyFile(false, data_filepath_EQM13, data_file_EQM13_list.name(i));
                  end;
                  i = i + 1;
               end;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ ИТОГОВЫХ НЕТТО-ТРЕБОВАНИЙ И НЕТТО-ОБЯЗАТЕЛЬСТВ НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if(Pan.KSUWRT == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ДАННЫХ О ВЫДАЧЕ/ПОГАШЕНИИ КСУ ИЗ EQM99");
         if( not DL_ИспользPaymentsПриИмпортеММВБЧасть2(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            stat = 1; 
            if(MMVB_Code == MICEX_CODE_FB)
               stat = get_data_file_name("COLLATERAL", "EQM99", @data_filepath_EQM99, @data_filename_EQM99);   
            end;

            if(stat == 0)
               if(import_ksu_to_gate_from_EQM99(data_filepath_EQM99 + data_filename_EQM99) == 0)
                  ResultCopyFile(true, data_filepath_EQM99, data_filename_EQM99);
               else
                  ResultCopyFile(false, data_filepath_EQM99, data_filename_EQM99);
               end;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ ДАННЫХ О ВЫДАЧЕ/ПОГАШЕНИИ КСУ НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ_ВР, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if((Pan.IncREPO == SET_CHAR) or (Pan.DividREPO == SET_CHAR))
//GAA:адаптация hf14 (76)         SessionNo = 2;       //SVE 514208 10.08.2020 файла EQM98 может не быть в ежедневном пакете биржевых файлов и он не обязателен, поэтому выводим только предупреждение при его отсутствии
         if((Pan.IncREPO == SET_CHAR) and (Pan.DividREPO == SET_CHAR))
            RGLog.Message("ЗАГРУЗКА Т/О ПО ПЕРЕДАЧЕ ДОХОДА И ДАННЫХ О ПОЛУЧЕНИИ ДИВИДЕНДОВ ПО РЕПО ИЗ EQM98");
         elif( Pan.IncREPO == SET_CHAR )
            RGLog.Message("ЗАГРУЗКА Т/О ПО ПЕРЕДАЧЕ ДОХОДА ПО РЕПО ИЗ EQM98");
         else
            RGLog.Message("ЗАГРУЗКА ДАННЫХ О ПОЛУЧЕНИИ ДИВИДЕНДОВ ПО РЕПО ИЗ EQM98");
         end;
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("PRNCPL_PAYM", "EQM98", @data_filepath_EQM98, @data_filename_EQM98, null, 2/*GAA:адаптация hf14 (76), old: SessionNo*/);   
         end;

         if(stat == 0)
            if(import_incREPO_to_gate_from_EQM98(data_filepath_EQM98 + data_filename_EQM98) == 0)
                ResultCopyFile(true, data_filepath_EQM98, data_filename_EQM98);
            else
                ResultCopyFile(false, data_filepath_EQM98, data_filename_EQM98);
            end;
         end;
      end;

      RGLog.Save();
   end;

   return RetVal;
end;

private macro RunInitMVB4(Pan)
   Pan.imp_date              = {curdate};
   Pan.Market                = MMVB_Code = MICEX_CODE_FB;
   Pan.rates                 = UNSET_CHAR;
   Pan.comp                  = UNSET_CHAR;
   Pan.paym                  = UNSET_CHAR;
   Pan.IncREPO               = UNSET_CHAR;
   Pan.DividREPO             = UNSET_CHAR;
   Pan.request               = UNSET_CHAR;
   Pan.deals                 = SET_CHAR;
   Pan.deals_clearing        = SET_CHAR;
   Pan.deals_clearing_client = UNSET_CHAR;
   Pan.deals_bo              = SET_CHAR;
   Pan.deals_seb             = SET_CHAR;
   Pan.deals_du              = UNSET_CHAR;
   Pan.MarketSchemeDU        = "";
   Pan.NettoItog             = UNSET_CHAR;
   Pan.MoneyMotion           = SET_CHAR;
   Pan.KSUWRT                = UNSET_CHAR;
   DisableFields( Pan, PNFLD_CLEARING_CLIENT );
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)
   var Party, DlMarket;

   if (Cmd == DLG_INIT)
        RunInitMVB4(Pn);
        PumpMarketScheme(@Pn, true);
        UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_MARKET) ) /* F3 */
      Party = TRecHandler("party.dbt");
      if( ListPT( Party, MMVB_CodeKind, Pn.Market, PTLIST_MARKETPLASE, PTCK_CONTR) == true )
         MMVB_Code = Pn.Market;
         PumpMarketScheme(@Pn, true);
         UpdateFields(Pn);
      end;

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
      Pn.imp_date = GetDateByCalendar( Pn.imp_date );
      UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) and (ID == PNFLD_MAR_SCHEME_DU) ) /* F3 */
      if(ID == PNFLD_MAR_SCHEME_DU)
         ListMarketScheme(@Pn, true);
      end;

   elif( (Cmd == DLG_KEY) and (Key == 32) ) /* Пробел */
      if ((ID == PNFLD_RATES)
      or  (ID == PNFLD_COMP)
      or  (ID == PNFLD_PAYM)
      or  (ID == PNFLD_INCREPO)
      or  (ID == PNFLD_DIVIDREPO)
      or  (ID == PNFLD_REQUEST)
      or  (ID == PNFLD_SECUR)
      or  (ID == PNFLD_CLEARING)
      or  (ID == PNFLD_CLEARING_CLIENT)
      or  (ID == PNFLD_SEC_BO)
      or  (ID == PNFLD_SEC_SEB)
      or  (ID == PNFLD_SEC_DU)
      or  (ID == PNFLD_NETTOITOG)
      or  (ID == PNFLD_MONEYMOTION)
      or  (ID == PNFLD_KSUWRT))
         Pn(ID) = IIF(Pn(ID) == SET_CHAR, UNSET_CHAR, SET_CHAR);
         end;

      if ((Pn(PNFLD_REQUEST) == UNSET_CHAR) and (Pn(PNFLD_SECUR) == UNSET_CHAR)
      and (Pn(PNFLD_CLEARING) == UNSET_CHAR) and (Pn(PNFLD_CLEARING_CLIENT) == UNSET_CHAR))
            Pn(PNFLD_SEC_BO)  = UNSET_CHAR;
            Pn(PNFLD_SEC_SEB) = UNSET_CHAR;
            Pn(PNFLD_SEC_DU)  = UNSET_CHAR;
            DisableFields( Pn, PNFLD_SEC_BO );
            DisableFields( Pn, PNFLD_SEC_SEB );
            DisableFields( Pn, PNFLD_SEC_DU );     
         else
               EnableFields( Pn, PNFLD_SEC_BO );
               EnableFields( Pn, PNFLD_SEC_SEB );
               EnableFields( Pn, PNFLD_SEC_DU );
            end;

         if( Pn(PNFLD_SEC_DU) == SET_CHAR )
            EnableFields( Pn, PNFLD_MAR_SCHEME_DU );
         else
         DisableFields(Pn, PNFLD_MAR_SCHEME_DU);
      end;

      UpdateFields(Pn);

   elif ( (Cmd == DLG_KEY) and (Key == 316) )
      return RunImportMVB4(Pn);

   elif( (Cmd == DLG_KEY) and ( (Key == 13) or (Key == 323) ) )
      return CM_IGNORE;

   end;

   return CM_DEFAULT;
end;

macro Process(SeanceID, Parms)
end;

macro Receive(_SeanceID:integer, Parm:variant)
   SeanceID = _SeanceID;
   SOURCE_CODE = "SRC-12";

   record _party(party);
   var RS;

   if( IsShedulerRunning() )
      RunInitMVB4(pp);
      AutoSetParm(pp, Parm);                     // пар-ры из панели источника
      AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
      RunImportMVB4(pp);
   else
/*ak*/
     var autoproc;
     if((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
       RunInitMVB4(pp);
       AutoSetParm(pp, Parm);
       RunImportMVB4(pp);
     else
/*~ak*/
       RunDialog(pp, "ProcessPanel");
/*ak*/
     end;
/*~ak*/
   end;

   return 0;
end;

macro Deliver (SeanceID, Parm)
end;