/*
$Name:        gtImVR.mac
$Module:      Шлюз Securities
$Description: ММВБ_Валютный рынок, xml-формат
*/

import gtdlfun_u; 
import gtImMVB_VR;

private const PNFLD_BEGDATE = 0,
              PNFLD_ENDDATE = 1,
              PNFLD_OWN_DEALS = 2,
              PNFLD_CLIENT_DEALS = 3,
              PNFLD_CCX17 = 4,
              PNFLD_CUX22 = 5,
              PNFLD_CUX23 = 6;

private record pp(IMP_VR, "rgateu.lbr") dialog;

private var Panel;

private macro IsOperBO(oper)
   var sql = 
   "SELECT 1 " +
   "  FROM dacsoprole_dbt t, DACSROLETREE_DBT tt " +
   " WHERE T.T_ROLEID = TT.T_ROLEID " +
   "       AND TT.T_NAME IN " +
   "              ('[13] Специалист БУ БО', " +
   "               '[14] Специалист БО') " +
   "       AND t.t_oper = " + oper ;
   var Dt = TRsbDataSet(sql);
   if (Dt.movenext())
      return true;
   else
      return false;
   end;
end;

private macro IsAdmin(oper)
   var sql = 
   "SELECT 1 " +
   "  FROM dacsoprole_dbt t, DACSROLETREE_DBT tt " +
   " WHERE T.T_ROLEID = TT.T_ROLEID " +
   "       AND TT.T_NAME IN " +
   "              ('Администратор') " +
   "       AND t.t_oper = " + oper ;
   var Dt = TRsbDataSet(sql);
   if (Dt.movenext())
      return true;
   else
      return false;
   end;
end;


private macro isRunFromMenu
   var run_as = GetGlobalParameter("PROCESS_RUN_WHO", true);
   if ((run_as == null) or (run_as == nullval))
      return false;
   end;
   if (run_as == "FROM_MENU")
      return true;
   end;
   return false;
end;

private class ReqRec()
  var ReportDate:date,
      CurrencyId:string,
      CoCurrencyId:string,
      SecShortName:string,
      TradeGroup:string,
      OrderNo:string,
      EntryTime:time,
      BuySell:string,
      OrderType:string,
      Quantity:double,
      Decimals:integer,
      Price:double,
      Stat:string,
      ClientCode:string;

  macro Init()
     ReportDate = date(0,0,0);
     CurrencyId = CoCurrencyId = SecShortName = "";
     TradeGroup = "";
     Decimals = 4;
  end;

  macro InitRecords()
     OrderNo = BuySell = OrderType = Stat = ClientCode = "";
     EntryTime = time(0,0,0);
     Quantity = Price = 0.0;
     Decimals = 4;
  end;

  macro GetCopy( Request:ReqRec )
     ReportDate   = Request.ReportDate;       
     CurrencyId   = Request.CurrencyId;       
     CoCurrencyId = Request.CoCurrencyId;         
     SecShortName = Request.SecShortName;         
     TradeGroup   = Request.TradeGroup;       
     OrderNo      = Request.OrderNo;     
     EntryTime    = Request.EntryTime;    
     BuySell      = Request.BuySell;  
     OrderType    = Request.OrderType;     
     Quantity     = Request.Quantity;     
     Decimals     = Request.Decimals;     
     Price        = Request.Price; 
     Stat         = Request.Stat; 
     ClientCode   = Request.ClientCode;
  end;
end;

/*
private class ItogRec()
  var TradeNo:string,
      Kind:integer,
      Margin:money,
      ReportDate:date;

  macro Init()
     TradeNo = "";
     Margin = $0.0;
     ReportDate = date(0,0,0);
     Kind = 0;
  end;

  macro InitRecords()
     TradeNo = "";
     Margin = $0.0;
     Kind = 0;
  end;
end;

private var VRItogRec = ItogRec();
*/

private var RequestGl;
private var DeleteDealG1;

private macro FileDate( date_val, delim )
  var day, month, year;
  DateSplit(date_val, day, month, year);

  year = year - 1900;
  if( year >= 100 )
     year = year - 100;
  end;

  return RGDLFUN_LZ(day,2) + delim + RGDLFUN_LZ(month,2) + delim + RGDLFUN_LZ(year,2);
end;

/* настраиваемый пользователем макрос формирования имен файла */
private macro get_data_file_name( pfx:string, CurImpDate:date, datafilepath:@string, datafilemask:@string )
  var ErrStr:string = "";
  datafilemask = "???????_" + pfx + "_???_" + FileDate(CurImpDate, "") + "*.xml";// + "_?????????.xml";
//  datafilepath = GetRegImportDir("VRMICEX", @ErrStr);
// teg 21.01.19 пока читаем реестр так
  var RegDir;
  if (Panel(PNFLD_CLIENT_DEALS) == SET_CHAR)  
    datafilepath = GetRegImportDirU(CurImpDate, @ErrStr);/*bpv*/
  else
  RegDir = "РСХБ\\ДИРЕКТОРИИ\\VRMICEX";
  GetRegistryValue(RegDir, V_STRING, datafilepath, @ErrStr);
  end;  
//TEG стандартная функцуия возвращает 0 его тоже надо исключать из обработки
  if( ((ErrStr != "") and (ErrStr != "0")) or (ErrStr == null) )
     RGLog.Message( ErrStr );
     return NULL;
  end;

  if (Panel(PNFLD_CLIENT_DEALS) == SET_CHAR)  
    datafilepath = datafilepath + "\\";  /*bpv*/
  else
  datafilepath = datafilepath + "\\"+ FileDate(CurImpDate, ".") + "\\"; 
  end;

  var List = TDirList(datafilepath + datafilemask, "f");

  List.Sort(0);

  return List;
end;

PRIVATE MACRO PutRequestInfo()

   VAR FlagAbortTRN = false;
   VAR ClientID = 0;
   VAR ErrStr = "";

   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;
   var Direction = 0;

   if(RequestGl.ClientCode != "")
      if( GetRealID(RG_PARTY, RequestGl.ClientCode, PTCK_MICEX, @ClientID, @ErrStr, true, PTSK_CM, RequestGl.ReportDate) != 0 )
         ErrMes = ErrMes + "Ошибка при загрузке заявки с кодом \"" + RequestGl.OrderNo + "\"\n" + ErrStr;
         RG = NULL;
         Exit();
      end;
  end;

   RG = TGTRecord( ВставкаЧерезКеш, RGLog.SeanceID, NULL, RG_DVREQ, 
                   String("Заявка на сделку №" + RequestGl.OrderNo),
                   Создать, NULL, NULL, ClientID );

   if(NOT RG.InitByCode(RG_DVREQ, CodeRQ, SOURCE_CODE) )
      Exit();
   end;

   if( strlen(trim(string(RequestGl.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке заявки № \"" + RequestGl.OrderNo + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDVRQ_CODETS",       RequestGl.OrderNo);
   RG.SetParmByName("RGDVRQ_DATE",         RequestGl.ReportDate);
   RG.SetParmByName("RGDVRQ_TIME",         RequestGl.EntryTime);
   RG.SetParmByName("RGDVRQ_CLIENT",       RequestGl.ClientCode);
   RG.SetParmByName("RGDVRQ_FI_CODE",      RequestGl.CurrencyId);
   RG.SetParmByName("RGDVRQ_STATUS",       RequestGl.Stat);
   RG.SetParmByName("RGDVRQ_OPERKIND",     -1);
   RG.SetParmByName("RGDVRQ_VOL",          RequestGl.Quantity);
   RG.SetParmByName("RGDVRQ_PRICE",        RequestGl.Price);
   RG.SetParmByName("RGDVRQ_ORDTYPECODE",  RequestGl.OrderType);
   RG.SetParmByName("RGDVRQ_SECSHORTNAME", RequestGl.SecShortName);
   RG.SetParmByName("RGDVRQ_FI_CODE_2",    RequestGl.CoCurrencyId);
   RG.SetParmByName("RGDVRQ_TRADEGROUP",   RequestGl.TradeGroup);
  
   if (RequestGl.TradeGroup == "T")
      Direction = IIF(RequestGl.BuySell == "B", DL_REQ_DIRECTION_B, DL_REQ_DIRECTION_S);  
   elif(RequestGl.TradeGroup == "S")
      Direction = IIF(RequestGl.BuySell == "B", DL_REQ_DIRECTION_BS, DL_REQ_DIRECTION_SB);
   end;
   RG.SetParmByName("RGDVRQ_DIRECTION",  Direction); 


   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;
/*
macro PutItogInfo()

  var FlagAbortTRN = false;

  macro Exit()
     FlagAbortTRN = true;
     AbortTRN;
  end;

  RG = TGTRecord( ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_KINDOBJ_DVNDEALCALC,
                  "Расчеты по ПФИ для внебирж. сделки № " + string(VRItogRec.TradeNo) + " на " + string(VRItogRec.ReportDate),
                  Создать );

  if( not RG.InitByCode(RG_KINDOBJ_DVNDEALCALC, CodeDeal, SOURCE_CODE) )
     AbortTRN;
  end;

  RG.SetParmByName("RGDVNDL_KIND",    VRItogRec.Kind);
  RG.SetParmByName("RGDVNDL_EXTCODE", VRItogRec.TradeNo);
  RG.SetParmByName("RGDVNDL_DATE",    VRItogRec.ReportDate);
  RG.SetParmByName("RGDVNDL_MARGIN",  VRItogRec.Margin);

  if( RG.Save() != true )
     if( RG.GetLastError() )
        ErrMes = ErrMes + "\n" + RG.GetLastError();
     end;
     Exit();
  end;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     AbortTRN;
  else
     if( FlagAbortTRN == false )
        RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError(), RG);
     end;
  end;
end;
*/

private macro get_req_code()
  return string(RequestGl.OrderNo) + "_VR_" + string(RequestGl.ReportDate);
end;

private macro WriteRequestData( NumImportRQ:@integer, NumImportRQTotal:@integer ):bool
  var RetVal:bool = true;

  ErrMes = "";
  CodeRQ = get_req_code();

  NumImportRQ = NumImportRQ + 1;

  if( ProcessTrn(0, "PutRequestInfo") )
     NumImportRQTotal = NumImportRQTotal + 1;
     RGLog.Message("Успешно загружена заявка \"" + CodeRQ + "\"\n" + ErrMes, RG, SUCCESS);
     RetVal = true;
  else
     RGLog.Error("Ошибка при загрузке заявки \"" + CodeRQ + "\"\n" + ErrMes, RG);
     RetVal = false;
  end;

  ErrMes = "";

  return RetVal;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     return true;
  end;
end;

/*private macro WriteItogData( NumImportVR:@integer, NumImportVRTotal:@integer ):bool
  var RetVal:bool = true;

  ErrMes = "";
  CodeDeal = string(VRItogRec.TradeNo) + "_" + string(VRItogRec.ReportDate) + "_" + "i";

  NumImportVR = NumImportVR + 1;

  if( ProcessTrn(0, "PutItogInfo") )
     NumImportVRTotal = NumImportVRTotal + 1;
     RGLog.Message("Успешно загружены итоги по сделке \"" + CodeDeal + "\"\n" + ErrMes, RG, SUCCESS);
     RetVal = true;
  else
     RGLog.Error("Ошибка при загрузке итогов по сделке \"" + CodeDeal + "\"\n" + ErrMes, RG);
     RetVal = false;
  end;

  ErrMes = "";

  return RetVal;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     return true;
  end;
end;
*/

private macro get_time_from_cux23(datafilename):time
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var node:object, child_MicexDoc:object;
  var i:integer = 0;
  var DocTime:time = Time(00, 00, 00);

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
  end;

  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "DOC_REQUISITES" )
           ReadTagAttribut(child_MicexDoc, "DOC_TIME", V_TIME, DocTime);
        end;
     end;
     i = i + 1;
  end;

  return DocTime;
end;

private macro import_cux23_to_gate(datafilename, Pan):integer

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportVR:integer = 0, NumImportVRTotal:integer = 0, NumImportRq:integer = 0, NumImportRqTotal:integer = 0;
  var VRArray = TArray();
  var node:object, child_MicexDoc:object, child_CUX23:object, child_CLEARPART:object, child_SETTLE:object, child_TRADEACC:object, child_SESSION:object, child_CURRPAIR:object, child_SECURITY:object, child_SETTLEDATE:object, child_GROUP:object, child_MAINSEC:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, m:integer = 0, t:integer = 0, n:integer = 0, l:integer = 0, r:integer = 0, p:integer = 0, q:integer = 0, y:integer = 0;
  var Deal = DealRec(), VRExchDeal:VRDealRec, NumWorkDays = 0, Request = ReqRec();
  var ReqExtSettleCode:string = "";
  var TagString = "";

  FileImport = FileCUX23;

  private macro RunImp( VRDeal:VRDealRec )
     VRDealGl = VRDeal;

     if( WriteDealData(@NumImportVR, @NumImportVRTotal) != true )
        return 1;
     end;

     return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  private macro RunImpRq(Request:ReqRec)
     RequestGl = Request;

     if( WriteRequestData(@NumImportRq, @NumImportRqTotal) != true )
        return 1;
     end;

     return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  private macro VRAddRecord()
     var find:bool = false;
     var s = 0;
     while( s < VRArray.size ) 
        if( (VRArray[s].leg12.RepoTradeNo == Deal.RepoTradeNo) and (VRArray[s].leg12.OrderNo == Deal.OrderNo) )
           VRArray[s].leg21.GetCopy(Deal);
           find = true;
           break;
        end;
        s = s + 1;
     end;

     if( not find )
        VRArray[VRArray.size] = VRDealRec();
        VRArray[VRArray.size-1].leg12.GetCopy(Deal);
     end;
  end;

  VRArray.Size = 0;
  Deal.Init();
  Request.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
  end;

  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "DOC_REQUISITES" )
           Deal.DocNo = "";
           if( ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, Deal.DocNo) == false )
              /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
           end;
        end;
        if( StrUpr(child_MicexDoc.tagname) == "CUX23" )
           TagString = "CUX23";
           Deal.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Deal.ReportDate) == false )
              /* если не нашли дату торгов */
           end;
           k = 0;
           while( k < child_MicexDoc.childNodes.length ) /* бегаем по CUX23 */
              child_CUX23 = child_MicexDoc.childNodes.item(k);
              if( child_CUX23 and (child_CUX23.nodeType == CHILD_NODE) )
                 if( StrUpr(child_CUX23.tagname) == "CLEARPART" )
                    q = 0;
                    while( q < child_CUX23.childNodes.length ) /* бегаем по CLEARPART */
                       child_CLEARPART = child_CUX23.childNodes.item(q);
                       if( child_CLEARPART and (child_CLEARPART.nodeType == CHILD_NODE) )
                          if( StrUpr(child_CLEARPART.tagname) == "SETTLE" )
                             Deal.ExtSettleCode = "";                                  
                             if( ReadTagAttribut(child_CLEARPART, "EXTSETTLECODE", V_STRING, Deal.ExtSettleCode) == false )
                                /* если не нашли расчетный код ExtSettleCode */
                             end;
                             if( CheckExtSettleCode(Deal.ExtSettleCode, Pan, TagString) )
                             j = 0;
                             while( j < child_CLEARPART.childNodes.length ) /* бегаем по SETTLE */
                                child_SETTLE = child_CLEARPART.childNodes.item(j);
                                if( child_SETTLE and (child_SETTLE.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_SETTLE.tagname) == "TRADEACC" )
                                      y = 0;
                                      while( y < child_SETTLE.childNodes.length ) /* бегаем по TRADEACC */
                                         child_TRADEACC = child_SETTLE.childNodes.item(y);
                                         if( child_TRADEACC and (child_TRADEACC.nodeType == CHILD_NODE) )
                                            if( StrUpr(child_TRADEACC.tagname) == "SESSION" )
                                               m = 0;
                                               while( m < child_TRADEACC.childNodes.length ) /* бегаем по SESSION */
                                                  child_SESSION = child_TRADEACC.childNodes.item(m);
                                                  if( child_SESSION and (child_SESSION.nodeType == CHILD_NODE) )
                                                     if( StrUpr(child_SESSION.tagname) == "CURRPAIR" )
                                                        Deal.CurrencyId = "";
                                                        if( ReadTagAttribut(child_SESSION, "CURRENCYID", V_STRING, Deal.CurrencyId) == false )
                                                           /* если не нашли идентификатор валюты лота */
                                                        end;
                                                        Deal.CoCurrencyId = "";
                                                        if( ReadTagAttribut(child_SESSION, "COCURRENCYID", V_STRING, Deal.CoCurrencyId) == false )
                                                           /* если не нашли идентификатор сопряженной валюты */
                                                        end;
                                                        t = 0;
                                                        while( t < child_SESSION.childNodes.length ) /* бегаем по CURRPAIR */
                                                           child_CURRPAIR = child_SESSION.childNodes.item(t);
                                                           if( child_CURRPAIR and (child_CURRPAIR.nodeType == CHILD_NODE) )
                                                              if( StrUpr(child_CURRPAIR.tagname) == "SECURITY" )
                                                                 Deal.SecShortName = "";
                                                                 if( ReadTagAttribut(child_CURRPAIR, "SECSHORTNAME", V_STRING, Deal.SecShortName) == false )
                                                                   /* если не нашли краткое наименование инструмента */
                                                                 end;
                                                                 Deal.FaceValue = 0.0;
                                                                 if( ReadTagAttribut(child_CURRPAIR, "FACEVALUE", V_DOUBLE, Deal.FaceValue) == false )
                                                                   /* если не нашли номинал */
                                                                 end;
                                                                 n = 0;
                                                                 while( n < child_CURRPAIR.childNodes.length ) /* бегаем по SECURITY */
                                                                    child_SECURITY = child_CURRPAIR.childNodes.item(n);
                                                                    if( child_SECURITY and (child_SECURITY.nodeType == CHILD_NODE) )
                                                                       if( StrUpr(child_SECURITY.tagname) == "SETTLEDATE" )
                                                                          Deal.SettleDate = date(0,0,0);
                                                                          if( ReadTagAttribut(child_SECURITY, "SETTLEDATE", V_DATE, Deal.SettleDate) == false )
                                                                             /* если не нашли дату исполнения */
                                                                          end;
                                                                          l = 0;
                                                                          while( l < child_SECURITY.childNodes.length ) /* бегаем по SETTLEDATE */
                                                                             child_SETTLEDATE = child_SECURITY.childNodes.item(l);
                                                                             if( child_SETTLEDATE and (child_SETTLEDATE.nodeType == CHILD_NODE) )
                                                                                if( StrUpr(child_SETTLEDATE.tagname) == "GROUP" )
                                                                                   var TradeGroup:string = "";
                                                                                   if( ReadTagAttribut(child_SETTLEDATE, "TRADEGROUP", V_STRING, TradeGroup) == false )
                                                                                      /* если не нашли вид сделки */
                                                                                   end;
                                                                                   if( (TradeGroup == "S") OR (TradeGroup == "T") )/*загружаем сделки СВОП и сделки <Покупка фьючерсов>/<Продажа фьючерсов>*/
                                                                                      r = 0;
                                                                                      while( r < child_SETTLEDATE.childNodes.length ) /* бегаем по GROUP */
                                                                                         child_GROUP = child_SETTLEDATE.childNodes.item(r);
                                                                                         if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                                                                                            if( StrUpr(child_GROUP.tagname) == "MAINSEC" )
                                                                                                  Deal.MainSecShortName = "";
                                                                                                  if( ReadTagAttribut(child_GROUP, "MAINSECSHORTNAME", V_STRING, Deal.MainSecShortName) == false )
                                                                                                      /* если не нашли наименование инструмента титульной сделки своп */
                                                                                                  end;
                                                                                               p = 0;
                                                                                               if( GetDialogFlag() )
                                                                                                  InitProgress(child_GROUP.childNodes.length, "Просмотр внешнего файла заключенных сделок", "Просмотр заключенных сделок...");
                                                                                               end;
                                                                                               while( p < child_GROUP.childNodes.length ) /* бегаем по MAINSEC */
                                                                                                  child_MAINSEC = child_GROUP.childNodes.item(p);
                                                                                                  if( child_MAINSEC and (child_MAINSEC.nodeType == CHILD_NODE) )
                                                                                                     if( child_MAINSEC.tagname == "RECORDS" )
                                                                                                        Deal.InitRecords();
                                        
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "TRADEDERIV", V_STRING, Deal.TradeDeriv) == false )
                                                                                                            /* если не нашли номер сделки */
                                                                                                        end;
                                        
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "BROKERREF", V_STRING, Deal.BrokerRef) == false )
                                                                                                            /* если не нашли BrokerRef */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "TRADENO", V_STRING, Deal.TradeNo) == false )
                                                                                                            /* если не нашли номер сделки */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "REPOTRADENO", V_STRING, Deal.RepoTradeNo) == false )
                                                                                                            /* если не нашли номер титульной сделки своп */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "BUYSELL", V_STRING, Deal.BuySell) == false )
                                                                                                            /* если не нашли направление сделки */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "ORDERNO", V_STRING, Deal.OrderNo) == false )
                                                                                                            /* если не нашли номер заявки */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "TRADETIME", V_TIME, Deal.TradeTime) == false )
                                                                                                            /* если не нашли время заключения сделки */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "PRICE", V_DOUBLE, Deal.Price) == false )
                                                                                                            /* если не нашли курс сделки */
                                                                                                        end;
                                                                                                           if( ReadTagAttribut(child_MAINSEC, "QUANTITY", V_DOUBLE, Deal.Quantity) == false )
                                                                                                            /* если не нашли объем в валюте лота, ед. валюты */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "VALUE", V_MONEY, Deal.Value_) == false )
                                                                                                            /* если не нашли объем в сопряженной валюте, ед. валюты */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "CLIENTCODE", V_STRING, Deal.ClientCode) == false )
                                                                                                            /* если не нашли краткий код клиента */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "EXCHCOMM", V_MONEY, Deal.ExchComm) == false )
                                                                                                            /* если не нашли Комиссионное вознаграждение за организацию торгов, руб. */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "CLRCOMM", V_MONEY, Deal.ClrComm) == false )
                                                                                                            /* если не нашли Комиссионное вознаграждение за клиринговое обслуживание, руб. */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "ITSCOMM", V_MONEY, Deal.ITSComm) == false )
                                                                                                            /* если не нашли Вознаграждение за предоставление ИТС, руб. */
                                                                                                        end;
                                                                                                        if( ReadTagAttribut(child_MAINSEC, "DECIMALS", V_INTEGER, Deal.Decimals) == false )
                                                                                                            /* если не нашли Точность цены */
                                                                                                        end;

                                                                                                        if(Deal.ClientCode != "")
                                                                                                           Deal.CurrencyId = RG_GetFullFICodeVR(Deal.CurrencyId);
                                                                                                        end;
                                                                                                        
                                                                                                        if( TradeGroup == "S" )
                                                                                                           Deal.Kind = -1; /*Какой-то из СВОП*/
                                                                                                        else
                                                                                                           if( Deal.TradeDeriv == "Y" )
                                                                                                              Deal.Kind = ВнебиржФорвард;
                                                                                                           elif( Deal.TradeDeriv == "N" )
                                                                                                              if (Deal.ClientCode != "")
                                                                                                                 Deal.Kind = ПИКО_ПокупкаПродажа_Кл; /*bpv*/
                                                                                                              else
                                                                                                                 Deal.Kind = ПИКО_ПокупкаПродажа;
                                                                                                              end;
                                                                                                           end;
                                                                                                        end;
                                                                                                        
                                                                                                        if( TradeGroup != "S" )
                                                                                                           VRExchDeal = VRDealRec();
                                                                                                           VRExchDeal.leg12.GetCopy(Deal);
                                                                                                           if( RunImp(VRExchDeal) )
                                                                                                              stat = 1;
                                                                                                           end;
                                                                                                        else
                                                                                                           VRAddRecord();
                                                                                                        end;
                                                                                                     end;
                                                                                                  end;
                                                                                                  p = p + 1;
                                                                                                  if( GetDialogFlag() )
                                                                                                     UseProgress(p);
                                                                                                  end;
                                                                                                  if( FlagCtrlBrk == true )
                                                                                                     break;
                                                                                                  end;
                                                                                               end;
                                                                                               if( GetDialogFlag() )
                                                                                                  RemProgress(); 
                                                                                               end;
                                                                                            end;
                                                                                         end;
                                                                                         r = r + 1;
                                                                                      end;
                                                                                   end;
                                                                                end;
                                                                             end;
                                                                             l = l + 1;
                                                                          end;
                                                                       end;
                                                                    end;
                                                                    n = n + 1;
                                                                 end;
                                                              end;
                                                           end;
                                                           t = t + 1;
                                                        end;
                                                     end;
                                                  end;
                                                  m = m + 1;
                                               end;
                                            end;
                                         end;
                                         y = y + 1;
                                      end;
                                   end;
                                end;
                                j = j + 1;
                             end;
                          end;
                       end;
                       end;
                       q = q + 1;
                    end;
                 end;
              end;
              k = k + 1;
           end;
       elif( StrUpr(child_MicexDoc.tagname) == "CUX22" )
           TagString = "CUX22";
           Request.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Request.ReportDate) == false )
              /* если не нашли дату торгов */
           end;
           k = 0;
           while( k < child_MicexDoc.childNodes.length ) /* бегаем по CUX22 */
              child_CUX23 = child_MicexDoc.childNodes.item(k);
              if( child_CUX23 and (child_CUX23.nodeType == CHILD_NODE) )
                 if( StrUpr(child_CUX23.tagname) == "CLEARPART" )
                    q = 0;
                    while( q < child_CUX23.childNodes.length ) /* бегаем по CLEARPART */
                       child_CLEARPART = child_CUX23.childNodes.item(q);
                       if( child_CLEARPART and (child_CLEARPART.nodeType == CHILD_NODE) )
                          if( StrUpr(child_CLEARPART.tagname) == "SETTLE" )
                             ReqExtSettleCode = "";                                  
                             if( ReadTagAttribut(child_CLEARPART, "EXTSETTLECODE", V_STRING, ReqExtSettleCode) == false )
                                /* если не нашли расчетный код ExtSettleCode */
                             end;
                             if( CheckExtSettleCode(ReqExtSettleCode, Pan, TagString) )
                                j = 0;
                                while( j < child_CLEARPART.childNodes.length ) /* бегаем по SETTLE */
                                   child_SETTLE = child_CLEARPART.childNodes.item(j);
                                   if( child_SETTLE and (child_SETTLE.nodeType == CHILD_NODE) )
                                      if( StrUpr(child_SETTLE.tagname) == "TRADEACC" )
                                         y = 0;
                                         while( y < child_SETTLE.childNodes.length ) /* бегаем по TRADEACC */
                                            child_TRADEACC = child_SETTLE.childNodes.item(y);
                                            if( child_TRADEACC and (child_TRADEACC.nodeType == CHILD_NODE) )
                                               if( StrUpr(child_TRADEACC.tagname) == "SESSION" )
                                                  m = 0;
                                                  while( m < child_TRADEACC.childNodes.length ) /* бегаем по SESSION */
                                                     child_SESSION = child_TRADEACC.childNodes.item(m);
                                                     if( child_SESSION and (child_SESSION.nodeType == CHILD_NODE) )
                                                        if( StrUpr(child_SESSION.tagname) == "CURRPAIR" )
                                                           Request.CurrencyId = "";
                                                           if( ReadTagAttribut(child_SESSION, "CURRENCYID", V_STRING, Request.CurrencyId) == false )
                                                              /* если не нашли идентификатор валюты лота */
                                                           end;
                                                           Request.CoCurrencyId = "";
                                                           if( ReadTagAttribut(child_SESSION, "COCURRENCYID", V_STRING, Request.CoCurrencyId) == false )
                                                              /* если не нашли идентификатор сопряженной валюты */
                                                           end;
                                                           t = 0;
                                                           while( t < child_SESSION.childNodes.length ) /* бегаем по CURRPAIR */
                                                              child_CURRPAIR = child_SESSION.childNodes.item(t);
                                                              if( child_CURRPAIR and (child_CURRPAIR.nodeType == CHILD_NODE) )
                                                                 if( StrUpr(child_CURRPAIR.tagname) == "SECURITY" )
                                                                    Request.SecShortName = "";
                                                                    if( ReadTagAttribut(child_CURRPAIR, "SECSHORTNAME", V_STRING, Request.SecShortName) == false )
                                                                       /* если не нашли */
                                                                    end;
                                                                    n = 0;
                                                                    while( n < child_CURRPAIR.childNodes.length ) /* бегаем по SECURITY */
                                                                       child_SECURITY = child_CURRPAIR.childNodes.item(n);
                                                                       if( child_SECURITY and (child_SECURITY.nodeType == CHILD_NODE) )
                                                                          if( StrUpr(child_SECURITY.tagname) == "SETTLEDATE" )
                                                                             /* Deal.SettleDate = date(0,0,0);
                                                                             if( ReadTagAttribut(child_SECURITY, "SETTLEDATE", V_DATE, Deal.SettleDate) == false )
                                                                                /* если не нашли дату исполнения */
                                                                             end;*/
                                                                             l = 0;
                                                                             while( l < child_SECURITY.childNodes.length ) /* бегаем по SETTLEDATE */
                                                                                child_SETTLEDATE = child_SECURITY.childNodes.item(l);
                                                                                if( child_SETTLEDATE and (child_SETTLEDATE.nodeType == CHILD_NODE) )
                                                                                   if( StrUpr(child_SETTLEDATE.tagname) == "GROUP" )
                                                                                      Request.TradeGroup = "";
                                                                                      if( ReadTagAttribut(child_SETTLEDATE, "TRADEGROUP", V_STRING, Request.TradeGroup) == false )
                                                                                         /* если не нашли вид сделки */
                                                                                      end;
                                                                                      if(Request.TradeGroup != "")
                                                                                         r = 0;
                                                                                         if( GetDialogFlag() )
                                                                                               InitProgress(child_SETTLEDATE.childNodes.length, "Просмотр внешнего файла заявок", "Просмотр заявок по сделкам...");
                                                                                            end;
                                                                                         while( r < child_SETTLEDATE.childNodes.length ) /* бегаем по GROUP */
                                                                                            child_GROUP = child_SETTLEDATE.childNodes.item(r);
                                                                                            if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                                                                                               if( child_GROUP.tagname == "RECORDS" )
                                                                                                  Request.InitRecords();
                                           
                                                                                                  if( ReadTagAttribut(child_GROUP, "ORDERNO", V_STRING, Request.OrderNo) == false )
                                                                                                     /* если не нашли */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "ENTRYTIME", V_TIME, Request.EntryTime) == false )
                                                                                                     /* если не нашли */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "BUYSELL", V_STRING, Request.BuySell) == false )
                                                                                                     /* если не нашли */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "ORDERTYPE", V_STRING, Request.OrderType) == false )
                                                                                                     /* если не нашли */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "QUANTITY", V_DOUBLE, Request.Quantity) == false )
                                                                                                     /* если не нашли */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "DECIMALS", V_INTEGER, Request.Decimals) == false )
                                                                                                     /* если не нашли */
        end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "PRICE", V_DOUBLE, Request.Price) == false )
                                                                                                     /* если не нашли  */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "STATUS", V_STRING, Request.Stat) == false )
                                                                                                     /* если не нашли  */
                                                                                                  end;
                                                                                                  if( ReadTagAttribut(child_GROUP, "CLIENTCODE", V_STRING, Request.ClientCode) == false )
                                                                                                     /* если не нашли */
                                                                                                  end;

                                                                                                  if(Request.ClientCode != "")
                                                                                                     Request.CurrencyId = RG_GetFullFICodeVR(Request.CurrencyId);
                                                                                                  end;

                                                                                                  if( RunImpRq(Request) )
                                                                                                     stat = 1;
                                                                                                  end;                                                                                                                                                                                                                     
                                                                                               end;
                                                                                            end;
                                                                                            r = r + 1;
                                                                                            if( GetDialogFlag() )
                                                                                               UseProgress(r);
                                                                                            end;
                                                                                            if( FlagCtrlBrk == true )
                                                                                               break;
                                                                                            end;
                                                                                         end;
                                                                                         if( GetDialogFlag() )
                                                                                            RemProgress(); 
                                                                                         end;
                                                                                      end;
                                                                                   end;
                                                                                end;
                                                                                l = l + 1;
                                                                             end;
                                                                          end;
                                                                       end;
                                                                       n = n + 1;
                                                                    end;
                                                                 end;
                                                              end;
                                                              t = t + 1;
                                                           end;
                                                        end;
                                                     end;
                                                     m = m + 1;
                                                  end;
                                               end;
                                            end;
                                            y = y + 1;
                                         end;
                                      end;
                                   end;
                                   j = j + 1;
                                end;
                             end;
                          end;
                       end;
                       q = q + 1;
                    end;
                 end;
              end;
              k = k + 1;
           end;
        end;//
     end;
     i = i + 1;
  end;

  /*вставка сделок из массивов*/
  i = 0;
  if( GetDialogFlag() )
     InitProgress(VRArray.size, "Загрузка внешнего файла заключенных сделок СВОП", "Загрузка заключенных сделок СВОП...");
  end;
  while( i < VRArray.size )
     if( (VRArray[i].leg12.Kind == -1) and (VRArray[i].leg21.Kind == -1) ) /*есть 2 части*/
        if( (VRArray[i].leg12.TradeDeriv == "N") or (VRArray[i].leg21.TradeDeriv == "N") ) /*bpv у нас пока тоьлко таки свопы*/
           if( not RG_GetNumWorkDaysForPeriodByCode(GT_VR, VRArray[i].leg12.ReportDate, VRArray[i].leg21.SettleDate, VRArray[i].leg12.CurrencyId, 
                                                    VRArray[i].leg12.CoCurrencyId, "ММВБ", @NumWorkDays, @ErrMes) )
              RGLog.Message("Ошибка при определении срока сделки с кодом \""+VRArray[i].leg12.OrderNo+"\":" + ErrMes, null, FAULT);
              i = i + 1;
              continue;
           end;

           if( NumWorkDays >= 3 )
              VRArray[i].leg12.Kind = VRArray[i].leg21.Kind = ВалютныйСВОП;
           else
              if (Deal.ClientCode != "")
                 VRArray[i].leg12.Kind = VRArray[i].leg21.Kind = КороткийСВОП_Кл;
              else
                 VRArray[i].leg12.Kind = VRArray[i].leg21.Kind = КороткийСВОП;
              end;
           end;
        end;

        if( VRArray[i].leg12.Kind != -1 )
           if( RunImp(VRArray[i]) )
              stat = 1;
           end;
        end;
     end;
     i = i + 1;
     if( GetDialogFlag() )
        UseProgress(i);
     end;
     if( FlagCtrlBrk == true )
        break;
     end;
  end;
  if( GetDialogFlag() )
     RemProgress(); 
  end;
  /* сообщаем о результатах загрузки */
  if (TagString == "CUX23")
  RGLog.Message("Всего обработано сделок - " + string(NumImportVR) + "\nиз них успешно - " + string(NumImportVRTotal) + "\nошибочно - " + string(NumImportVR - NumImportVRTotal));
  elif(TagString == "CUX22")
     RGLog.Message("Всего обработано заявок - " + string(NumImportRq) + "\nиз них успешно - " + string(NumImportRqTotal) + "\nошибочно - " + string(NumImportRq - NumImportRqTotal));     
  end;

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
end;

/*private macro import_ccx17_to_gate(datafilename):integer

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportVR:integer = 0, NumImportVRTotal:integer = 0;
  var node:object, child_MicexDoc:object, child_CCX17:object, child_SETTLE:object, child_CURRENCY:object, child_TRADE:object, child_SETTLEDATE:object, child_MAINSEC:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, m:integer = 0, t:integer = 0, l:integer = 0, p:integer = 0;

  private macro RunImp()

     if( WriteItogData(@NumImportVR, @NumImportVRTotal) != true )
        return 1;
     end;

     return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  VRItogRec.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
  end;

  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "DOC_REQUISITES" )
        end;
        if( StrUpr(child_MicexDoc.tagname) == "CCX17" )
           VRItogRec.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, VRItogRec.ReportDate) == false )
              /* если не нашли дату торгов */
           end;
           k = 0;
           while( k < child_MicexDoc.childNodes.length ) /* бегаем по CCX17 */
              child_CCX17 = child_MicexDoc.childNodes.item(k);
              if( child_CCX17 and (child_CCX17.nodeType == CHILD_NODE) )
                 if( StrUpr(child_CCX17.tagname) == "SETTLE" )
                    j = 0;
                    while( j < child_CCX17.childNodes.length ) /* бегаем по SETTLE */
                       child_SETTLE = child_CCX17.childNodes.item(j);
                       if( child_SETTLE and (child_SETTLE.nodeType == CHILD_NODE) )
                          if( StrUpr(child_SETTLE.tagname) == "CURRENCY" )
                             m = 0;
                             while( m < child_SETTLE.childNodes.length ) /* бегаем по CURRENCY */
                                child_CURRENCY = child_SETTLE.childNodes.item(m);
                                if( child_CURRENCY and (child_CURRENCY.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_CURRENCY.tagname) == "TRADE" )
                                      t = 0;
                                      while( t < child_CURRENCY.childNodes.length ) /* бегаем по TRADE */
                                         child_TRADE = child_CURRENCY.childNodes.item(t);
                                         if( child_TRADE and (child_TRADE.nodeType == CHILD_NODE) )
                                            if( StrUpr(child_TRADE.tagname) == "SETTLEDATE" )
                                               l = 0;
                                               if(GetDialogFlag())
                                                  InitProgress(child_TRADE.childNodes.length, "Загрузка внешнего файла об обязательствах по ПФИ ", "Просмотр записей...");
                                               end;
                                               while( l < child_TRADE.childNodes.length ) /* бегаем по SETTLEDATE */
                                                  child_SETTLEDATE = child_TRADE.childNodes.item(l);
                                                  if( child_SETTLEDATE and (child_SETTLEDATE.nodeType == CHILD_NODE) )
                                                     if( child_SETTLEDATE.tagname == "RECORDS" )
                                                        VRItogRec.InitRecords();

                                                        if( ReadTagAttribut(child_SETTLEDATE, "TRADENO", V_STRING, VRItogRec.TradeNo) == false )
                                                            /* если не нашли номер сделки */
                                                        end;
                                                        var TradeGroup = ""/*, BuySell = ""*/;
                                                        if( ReadTagAttribut(child_SETTLEDATE, "TRADEGROUP", V_STRING, TradeGroup) == false )
                                                            /* если не нашли Вид обязательств/требований */
                                                        end;
/*
                                                        if( ReadTagAttribut(child_SETTLEDATE, "BUYSELL", V_STRING, BuySell) == false )
                                                            /* если не нашли Направление сделки */
                                                        end;
*/
                                                        if( TradeGroup == "S" )
                                                           VRItogRec.Kind = ВалютныйСВОП;
                                                        else
                                                           VRItogRec.Kind = ВнебиржФорвард;
                                                        end;

                                                        if( ReadTagAttribut(child_SETTLEDATE, "VARM", V_MONEY, VRItogRec.Margin) == false )
                                                            /* если не нашли Обязательство/требование по уплате/получению Вариационной маржи */
                                                        end;
                                                        
                                                        if( VRItogRec.Kind > 0  )
                                                           if( RunImp() )
                                                              stat = 1;
                                                           end;
                                                        end;
                                                     end;
                                                  end;
                                                  l = l + 1;
                                                  if( GetDialogFlag() )
                                                     UseProgress(p);
                                                  end;
                                                  if( FlagCtrlBrk == true )
                                                     break;
                                                  end;
                                               end;
                                               if( GetDialogFlag() )
                                                  RemProgress(); 
                                               end;
                                            end;
                                         end;
                                         t = t + 1;
                                      end;
                                   end;
                                end;
                                m = m + 1;
                             end;
                          end;
                       end;
                       j = j + 1;
                    end;
                 end;
              end;
              k = k + 1;
           end;
        end;
     end;
     i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано сделок - " + string(NumImportVR) + "\nиз них успешно - " + string(NumImportVRTotal) + "\nошибочно - " + string(NumImportVR - NumImportVRTotal));

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
end;
*/

PRIVATE MACRO PutDeleteDealInfo()

   VAR FlagAbortTRN = false;
   var RG_ObjKind, RG_ObjCode = "";

   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;
   if( (DeleteDealG1.rec.Kind == ВалютныйСВОП) or (DeleteDealG1.rec.Kind == ВнебиржФорвард) )
      RG_ObjKind = RG_DVNDEAL;
      RG_ObjCode = "Внебирж. сделка с ПИ № ";
   elif( (DeleteDealG1.rec.Kind == КороткийСВОП) or (DeleteDealG1.rec.Kind == ПИКО_ПокупкаПродажа) or (DeleteDealG1.rec.Kind == ПИКО_ПокупкаПродажа_Кл) or (DeleteDealG1.rec.Kind == КороткийСВОП_Кл) )
      RG_ObjKind = RG_DVFXDEAL;
      RG_ObjCode = "Конверс. сделка в ПИ № ";
   end;
   // RG = TGTRecord( ВставкаЧерезКеш,
   //                RGLog.SeanceID,
   //                NULL,
   //                RG_ObjKind,
   //                RG_ObjCode + string(DeleteDealG1.rec.Code) + " на " + string(DeleteDealG1.rec.Date),
   //                Удалить, NULL, NULL, DeleteDealG1.rec.Client);

   RG = TGTRecord( ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_ObjKind,
                  RG_ObjCode + string(DeleteDealG1.rec.Code) + " на " + string(DeleteDealG1.rec.Date),
                  Создать, NULL, NULL, DeleteDealG1.rec.Client);


   if( not RG.InitByCode(RG_ObjKind, DeleteDealG1.rec.Code, SOURCE_CODE) )
      AbortTRN;
   end;

   if( RG_ObjKind == RG_DVFXDEAL )
      RG.SetParmByName("RGDVFXDL_CODE",            DeleteDealG1.rec.Code);
      RG.SetParmByName("RGDVFXDL_KIND",            DeleteDealG1.rec.Kind);
      RG.SetParmByName("RGDVFXDL_CLIENT",          DeleteDealG1.rec.Client);
   elif( (DeleteDealG1.rec.Kind == ВалютныйСВОП) or (DeleteDealG1.rec.Kind == ВнебиржФорвард) )
      RG.SetParmByName("RGDVNDL_CODE",             DeleteDealG1.rec.Code);
      RG.SetParmByName("RGDVNDL_KIND",             DeleteDealG1.rec.Kind);
      RG.SetParmByName("RGDVNDL_CLIENT",           DeleteDealG1.rec.Client);
   end;

   RG.SetParmByName("RGDV_PROGNOS", "D");

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

private macro WriteDeleteDealData( NumImport:@integer, NumImportTotal:@integer ):bool
  var RetVal:bool = true;

  ErrMes = "";

  NumImport = NumImport + 1;

  if( ProcessTrn(0, "PutDeleteDealInfo") )
     NumImportTotal = NumImportTotal + 1;
     RGLog.Message("Успешно создана ЗР для удаления неподтверждённой сделки \"" + DeleteDealG1.rec.Code + "\"\n" + ErrMes, RG, SUCCESS);
     RetVal = true;
  else
     RGLog.Error("Ошибка при создании ЗР для удаления неподтверждённой сделки \"" + DeleteDealG1.rec.Code + "\"\n" + ErrMes, RG);
     RetVal = false;
  end;

  ErrMes = "";

  return RetVal;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     return true;
  end;
end;


private macro MarkDealsForDelete(beg_date:date, end_date:date)
//TODO 
   var   sql, cmd, DataSet, NRec;
   var NumImport:integer = 0, NumImportTotal:integer = 0, i:integer = 0, stat:integer = 0;
   DeleteDealG1 = TRecHandler("dvndeal");

   sql = " select d.* from ddvndeal_dbt d "+
         " where D.T_KIND in ( " + ВалютныйСВОП +" , " + ВнебиржФорвард +" , " + КороткийСВОП +" , " + ПИКО_ПокупкаПродажа +", " + ПИКО_ПокупкаПродажа_Кл +", " + КороткийСВОП_Кл +" ) "+
         "    and D.T_PROGNOS = ? "+
         "    and D.T_DATE >= ? "+
         "    and D.T_DATE <= ? "+
         "    and D.T_CODE not in ( "+
         "       select P.T_STRINGVAL as t_code "+
         "       from dgtrecord_dbt r, DGTAPP_DBT A, dgtobject_dbt o, dgtrecprm_dbt p "+
         "       where "+
         "             A.T_APPLICATIONID in (" + GT_VR + "," + GT_PAYMENTS_VR + ") "+
         "             and R.T_APPLICATIONID_FROM = A.T_APPLICATIONID "+
         "             and R.T_OBJECTID = O.T_OBJECTID "+
         "             and O.T_OBJECTKIND in (" + RG_DVNDEAL + "," + RG_DVFXDEAL + ") "+
         "             and R.T_RECORDID = P.T_RECORDID "+
         "             and P.T_KOPRMID in (select T_KOPRMID "+
         "                                   from dgtkoprm_dbt "+
         "                                  where (t_objectkind = " + RG_DVNDEAL + " and t_code = 3) "+
         "                                     or (t_objectkind = " + RG_DVFXDEAL + " and t_code = 3) "+
         "                                ) "+
         "             and R.T_ACTIONID in (1,3) "+
         "             and R.T_STATUSID = 2 ) ";

   cmd = DL_RSDCommand(sql);
   cmd.addParam(SET_CHAR);
   cmd.addParam(beg_date);
   cmd.addParam(end_date);
   NRec = cmd.GetCount();
   DataSet = cmd.execute();

   if( GetDialogFlag() )
      InitProgress( NRec, "Поиск сделок неподтверждённых биржевым файлом ", "Поиск сделок ...");
   end;

   while( DataSet.MoveNext() )
      DeleteDealG1.Clear();
      DataSet.GetRecord().CopyTo( DeleteDealG1.rec );
      if(WriteDeleteDealData( @NumImport, @NumImportTotal) != true)
         stat = 1;
      end;
      i = i + 1;
      if( GetDialogFlag() )
         UseProgress(i);
      end;
      if( FlagCtrlBrk == true )
         break;
      end;
   end;
   if( GetDialogFlag() )
      RemProgress(); 
   end;
   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано неподтверждённых сделок - " + string(NumImport) + "\nиз них успешно - " + string(NumImportTotal) + "\nошибочно - " + string(NumImport - NumImportTotal));

   return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
  return 1;
end;

private macro ResultCopyFile( done:bool, data_filepath:string, data_filename:string, CurImpDate:date )
  var data_file_new_path, data_file_new_file;

  if( done )
     data_file_new_path = data_filepath + "Done\\";
  else
     data_file_new_path = data_filepath + "Err\\";
  end;

  MakeDir(data_file_new_path);

  data_file_new_file = data_file_new_path + data_filename;

  if( not CopyFile(data_filepath + data_filename, data_file_new_file) )
     RGLog.Error("Ошибка копирования файла " + data_filename + " в " + data_file_new_file);
  else
     RGLog.Message("Файл " + data_filename + " скопирован в " + data_file_new_file);
  end;
end;

private macro CheckPanel( Pan ):bool

  if( Pan.beg_date == date(0,0,0) )
     MsgBox("Не задана дата начала периода");
     return false;
  end;

  if( Pan.end_date == date(0,0,0) )
     MsgBox("Не задана дата окончания периода");
     return false;
  end;

  if( Pan.end_date < Pan.beg_date )
     MsgBox("Дата окончания периода не может быть меньше даты начала периода");
     return false;
  end;

  return true;
end;

private macro RunImportItog( Pan )

  var stat:integer = 0;
  var data_filepath_VR:string = "", data_filemask_VR:string = "";
  var List = NULL;
  var i:integer = 0;
  var RetVal = CM_SAVE;

  Panel = Pan;

  if( CheckPanel(Pan) == false )
     RetVal = CM_IGNORE;
  end;

  if( RetVal != CM_IGNORE )
     RGLog = GTDL_Log(SeanceID);
     RGLog.Message("Импорт файлов заключенных сделок");

     var CurImpDate:date = Pan.beg_date;

     if(not DL_ИспользPaymentsПриИмпортеВалютногоРынка(@ErrMes))
        if( ErrMes != "" )
           RGLog.Error(ErrMes); ErrMes = "";
        end;      
        var j:integer = 0;
        if( GetDialogFlag() )
           InitProgress((Pan.end_date - Pan.beg_date + 1), "Загрузка файлов за период дат", "Просмотр дат...");
        end;
        while( CurImpDate <= Pan.end_date )
           if ((IsOperBO({oper})) or IsAdmin({oper}))
              if (Pan.cux22 == SET_CHAR)
                 /*импорт клиентских поручений*/
                 List = get_data_file_name("CUX22", CurImpDate, @data_filepath_VR, @data_filemask_VR);
                 if( List != NULL )
                    i = 0;
                    while( i < List.Count )
                       RGLog.Message("Используется файл " + List.name(i));
                       if( import_cux23_to_gate(data_filepath_VR + List.name(i), Pan) == 0 )
                          ResultCopyFile(true, data_filepath_VR, List.name(i), CurImpDate);
                       else
                          ResultCopyFile(false, data_filepath_VR, List.name(i), CurImpDate);
                       end;
                       i = i + 1;
                    end;
                    if( i == 0 )
                       RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + data_filepath_VR + data_filemask_VR);
                    end;
                 end;
              end;

              if (Pan.cux23 == SET_CHAR)
                 /*импорт сделок*/
                 List = get_data_file_name("CUX23", CurImpDate, @data_filepath_VR, @data_filemask_VR);
                 if( List != NULL )
                    i = 0;
                    while( i < List.Count )
                       var CurSubStr:string = SubStr(List.name(i), Index(List.name(i),"CUX23"), 10); 
                       var UseFile:bool = true;
                       var k:integer = 0;
                       while( k < List.Count ) //Проверка наличия второго файла того же типа с большим временем
                          if( i != k )
                             if( CurSubStr == SubStr(List.name(k), Index(List.name(k),"CUX23"), 10) ) //Сравниваем фрагмент "CUX23_???_"
                                if( get_time_from_cux23(data_filepath_VR + List.name(i)) < get_time_from_cux23(data_filepath_VR + List.name(k)) )
                                   UseFile = false;
                                   break;
                                end;
                             end;
                          end;
                          k = k + 1;
                       end;
              
                       if( UseFile )
                          RGLog.Message("Используется файл " + List.name(i));
                          if( import_cux23_to_gate(data_filepath_VR + List.name(i), Pan) == 0 )
                             ResultCopyFile(true, data_filepath_VR, List.name(i), CurImpDate);
                          else
                             ResultCopyFile(false, data_filepath_VR, List.name(i), CurImpDate);
                          end;
                       else
                          RGLog.Message("ПРЕДУПРЕЖДЕНИЕ: \n Файл " + List.name(i) + " пропущен, так как есть файл того же типа за более позднее время");
                          ResultCopyFile(false, data_filepath_VR, List.name(i), CurImpDate);
                       end;
                       i = i + 1;
                    end;
                    if( i == 0 )
                       RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + data_filepath_VR + data_filemask_VR);
                    end;
                 end;
              end;
           end;

           /*импорт обязательств по ПФИ */
           if (((not IsOperBO({oper})) and (not isRunFromMenu)) or IsAdmin({oper}))
              if (Pan.ccx17 == SET_CHAR)
                 /*List = get_data_file_name("CCX17", CurImpDate, @data_filepath_VR, @data_filemask_VR);
                 if( List != NULL )
                    i = 0;
                    while( i < List.Count )
                       RGLog.Message("Используется файл " + List.name(i));
                       if( import_ccx17_to_gate(data_filepath_VR + List.name(i)) == 0 )
                          ResultCopyFile(true, data_filepath_VR, List.name(i), CurImpDate);
                       else
                          ResultCopyFile(false, data_filepath_VR, List.name(i), CurImpDate);
                       end;
                       i = i + 1;
                    end;
                    if( i == 0 )
                       // Warning почему-то не работает
                       RGLog.Message("ПРЕДУПРЕЖДЕНИЕ: Ошибка открытия файла данных. Не найден файл по маске " + data_filepath_VR + data_filemask_VR);
                    end;
                 end;*/
              end;
           end;

           CurImpDate = CurImpDate + 1;
           j = j + 1;
           if( GetDialogFlag() )
              UseProgress(j);
           end;
           if( FlagCtrlBrk == true )
              break;
           end;
        end;
        if( GetDialogFlag() )
           RemProgress(); 
        end;

        MarkDealsForDelete(Pan.beg_date, Pan.end_date);
     else
        RGLog.Message("ДЛЯ ЗАГРУЗКИ СДЕЛОК И ЗАЯВОК НА СДЕЛКИ ВАЛЮТНОГО РЫНКА НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ_ВР, Шлюз PAYMENTS\"", null, WARNING );
     end;

     RGLog.Save();
  end;

  return RetVal;

OnError( RslErrObj )
  if( GetDialogFlag() )
     RemProgress(); 
  end;
end;

private macro RunInitItog( Pan )
  Pan.beg_date = {curdate};
  Pan.end_date = {curdate};
  if (IsOperBO({oper}))
    Pan.own_deals = UNSET_CHAR;
    Pan.client_deals = SET_CHAR;
    Pan.ccx17 = UNSET_CHAR;
    Pan.cux22 = SET_CHAR;
    Pan.cux23 = SET_CHAR;
  else
    Pan.own_deals = SET_CHAR;
    Pan.client_deals = UNSET_CHAR;
    Pan.ccx17 = SET_CHAR;
    Pan.cux22 = UNSET_CHAR;
    Pan.cux23 = UNSET_CHAR;
  end;

end;

private macro ProcessPanel( Pn, Cmd, ID, Key )

  if( Cmd == DLG_INIT )
     RunInitItog(Pn);
     if (IsOperBO({oper}))
       DisableFields( Pn, PNFLD_OWN_DEALS); /*bpv*/
       DisableFields( Pn, PNFLD_CCX17); /*bpv*/
     end;
     UpdateFields(Pn);
  elif( cmd == DLG_KEY )
     if( (key == 317) AND (ID == PNFLD_BEGDATE) ) /* F3 */
        Pn.beg_date = GetDateByCalendar(Pn.beg_date);
        UpdateFields(Pn);
     elif( (key == 317) AND (ID == PNFLD_ENDDATE) ) /* F3 */
        Pn.end_date = GetDateByCalendar(Pn.end_date);
        UpdateFields(Pn);
     elif( (Cmd == DLG_KEY) and (Key == 32) ) /* Пробел */
        if( (ID == PNFLD_OWN_DEALS) or (ID == PNFLD_CLIENT_DEALS) or (ID == PNFLD_CCX17) or (ID == PNFLD_CUX22) or (ID == PNFLD_CUX23))
           if((ID == PNFLD_OWN_DEALS) and (Pn(ID) == SET_CHAR) and (Pn(PNFLD_CLIENT_DEALS) == SET_CHAR))
              Pn(ID) = UNSET_CHAR;
              Pn(PNFLD_CLIENT_DEALS) = SET_CHAR
           elif((ID == PNFLD_OWN_DEALS) and (Pn(ID) == UNSET_CHAR))
              Pn(ID) = SET_CHAR;
              Pn(PNFLD_CLIENT_DEALS) = UNSET_CHAR
           elif((ID == PNFLD_CLIENT_DEALS) and (Pn(ID) == SET_CHAR) and (Pn(PNFLD_OWN_DEALS) == SET_CHAR))
              Pn(ID) = UNSET_CHAR;
              Pn(PNFLD_OWN_DEALS) = SET_CHAR
           elif((ID == PNFLD_CLIENT_DEALS) and (Pn(ID) == UNSET_CHAR))
              Pn(ID) = SET_CHAR;
              Pn(PNFLD_OWN_DEALS) = UNSET_CHAR
           elif(((ID == PNFLD_CCX17) or (ID == PNFLD_CUX22) or (ID == PNFLD_CUX23)) and (Pn(ID) == UNSET_CHAR))
              Pn(ID) = SET_CHAR;
           elif(((ID == PNFLD_CCX17) or (ID == PNFLD_CUX22) or (ID == PNFLD_CUX23)) and (Pn(ID) == SET_CHAR))
              Pn(ID) = UNSET_CHAR;
           end;
        end;
        UpdateFields(Pn);
     elif( Key == 316 )
        return RunImportItog(Pn);
     elif( (Key == 13) or (Key == 323) )
        return CM_IGNORE;
     end;
  end;

  return CM_DEFAULT;
end;

macro Process( SeanceID, Parms )
end;

macro Receive( _SeanceID:integer, Parm:variant )
  SeanceID = _SeanceID;

  SOURCE_CODE = "SRC-18";

  if( IsShedulerRunning() )
     RunInitItog(pp);
     AutoSetParm(pp, Parm);                     // пар-ры из панели источника
     AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
     RunImportItog(pp);
  else
     var autoproc;
     if ((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
        RunInitItog(pp);
        AutoSetParm(pp, Parm);                     // пар-ры из панели источника
        AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
        RunImportItog(pp);
     else
        RunDialog(pp, "ProcessPanel");
     end;  
  end;

  return 0;
end;

macro Deliver( SeanceID, Parm )
end;
