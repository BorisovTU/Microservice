import OPrInter, SpInter, BankInter, FiInter, PtInter, SfInter, CtInter, "globals.mac", "gtdlfun.mac";
import "rgtgtrec.mac";

private var begin_transaction = false;

macro _RepCalcOper_CreateNew(RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING):INTEGER
   var RG;
   var stat:integer;
   var type:integer;

   var spgr          = TRecHandler( "spground.dbt"    );
   record Party(party);
   var autor_str:string;
   VAR OpDay, OpMon, OpYear, CalcOperCode:string;

   spgr.Clear();
   begin_transaction = false;

   RG = TGTRecord();
   RG.LoadFromDB(RecordID);

   if( (GetParmByName( RG,"RGDVREP_DEPARTMENT", @spgr.rec.Department, @type)  == NULL) OR (type != V_INTEGER) )
      RunError( "Не найден параметр RGDVREP_DEPARTMENT объекта " + String(RecordID) );
   end;

   // Дата отчета
   if( (GetParmByName( RG,"RGDVREP_DOCDATE", @spgr.rec.SignedDate, @type)  == NULL) OR (type != V_DATE) )
      RunError( "Не найден параметр RGDVREP_DOCDATE объекта " + String(RecordID) );
   end;

   // Идентификатор составителя отчета
   if( (GetParmByName( RG,"RGDVREP_DOCPARTY", @autor_str, @type)  == NULL) OR (type != V_STRING) )
   else
      spgr.rec.Party = ПолучитьКодСубъекта( autor_str, PTCK_CONTR );

      if(ПолучитьСубъекта( spgr.rec.Party, Party ))
         RunError( "Не найден контрагент " + string(spgr.rec.Party) + " в параметре " + "RGMKRP_AUTHOR" + " объекта " + String(RecordID) );
      else
         spgr.rec.PartyName = Party.ShortName;
         spgr.rec.PartyCode = ПолучитьКодСубъекта( spgr.rec.Party, PTCK_CONTR );
      end;
   end;

   spgr.rec.Direction  = 0; /* входящее сообщение */
   spgr.rec.Division = 0;

   if( (GetParmByName( RG,"RGDVREP_DOCKIND", @spgr.rec.Kind, @type)  == NULL) OR (type != V_INTEGER) )
      RunError( "Не найден параметр RGDVREP_DOCKIND объекта " + String(RecordID) );
   end;

   if( (GetParmByName( RG,"RGDVREP_DATE", @spgr.rec.RegistrDate, @type)  == NULL) OR (type != V_DATE) )
      RunError( "Не найден параметр RGDVREP_DATE объекта " + String(RecordID) );
   end;

   if( (GetParmByName( RG,"RGDVREP_TIME", @spgr.rec.RegistrTime, @type)  == NULL) OR (type != V_TIME) )
      RunError( "Не найден параметр RGDVREP_TIME объекта " + String(RecordID) );
   end;

   // Номер отчета
   if( (GetParmByName( RG,"RGDVREP_DOCNUM", @spgr.rec.AltXld, @type)  == NULL) OR (type != V_STRING) )
      RunError( "Не найден параметр RGDVREP_DOCNUM объекта " + String(RecordID) );
   end;

   DateSplit( spgr.rec.SignedDate, OpDay, OpMon, OpYear );

   spgr.rec.DocLog = LLCLASS_KINDDOC_DERIV;

   CalcOperCode = autor_str + string( OpDay:2:o ) + string( OpMon:2:o ) + string( OpYear:4:o );

   var cmd, qwery, CalcOperID;

   cmd = RSDCommand( " SELECT opr.t_ID " +
                     "   FROM ddvoper_dbt opr " +
                     "  WHERE (opr.t_dockind = ? AND opr.t_code = ? )  " +
                     "     OR (    opr.t_dockind = ? " +
                     "         AND opr.t_department = ? " +
                     "         AND opr.t_partykind = ? " +
                     "         AND opr.t_party = ? " +
                     "         AND opr.t_partycontr = ? " +
                     "         AND opr.t_date = ? " +
                     "        ) ");

   cmd.addParam( "", RSDBP_IN, DL_DVOPER );
   cmd.addParam( "", RSDBP_IN, CalcOperCode );
   cmd.addParam( "", RSDBP_IN, DL_DVOPER );
   cmd.addParam( "", RSDBP_IN, {OperDprt} );
   cmd.addParam( "", RSDBP_IN, PTK_MARKETPLASE );
   cmd.addParam( "", RSDBP_IN, spgr.rec.Party );
   cmd.addParam( "", RSDBP_IN, 0 );
   cmd.addParam( "", RSDBP_IN, spgr.rec.SignedDate );
   cmd.execute();

   qwery = TRsbDataSet(cmd);
   if( qwery.movenext() )
      CalcOperID = qwery.ID;
   else
      RunError( "Не найдена операция расчетов" );
   end;

   RslDefCon.BeginTrans();
   begin_transaction = true;

   stat = SP_RepCalcOpGateCreateNew( spgr, CalcOperID );
   if(stat != 0)
      RunError("Ошибка при добавлении документа в операцию расчетов по ПИ. " + GetErrMsg());
   end;

   RslDefCon.CommitTrans();

   ID      = spgr.rec.AltXld;
   return 0;

OnError( RslErrObj )
   if(begin_transaction)
      RslDefCon.RollbackTrans();
   end;

   Comment = RslErrObj.Message;
   return 1;
end;
