/*
$Name:        gtImSpbP_DL.mac
$Module:      Шлюз Securities
$Description: Общие ф-и для импорта объектов биржи "ПАО СПБ" с пом. Payments
*/
import RSD, "gtImSPB_DL.mac";

macro GetSqlIsREPO(alias:string) :string
  if(alias == NULL)
    alias = "";
  end;
  return "(CASE WHEN INSTR(NVL("+alias+"SETTLECODE, CHR(1)), 'T') = 1 AND INSTR(NVL("+alias+"SETTLECODE, CHR(1)), 'T', 3) > 0 "+
              " THEN 1 "+
              " WHEN INSTR(NVL("+alias+"SETTLECODE, CHR(1)), 'O') = 1 AND INSTR(NVL("+alias+"SETTLECODE, CHR(1)), 'O', 3) > 0 "+
              " THEN 1 "+
              " ELSE 0 "+
          " END)";
end;

private macro ДнейВГоду( YYYY:INTEGER ):INTEGER
   return DATE( 31,12,YYYY )-DATE( 1,1,YYYY )+1;
end;

macro НайтиДанныеПо2Части( SettleDate:date, SettleDate2:date, Amount:money, Amount2:money, RepoRate:@double)
   var i:integer = 0, N:double = 1.0;
   var YYYY_beg, YYYY_end, YYYY_cur;
   RepoRate = 0.0;
   if(SettleDate != SettleDate2)
      datesplit( SettleDate, NULL, NULL, YYYY_beg );
      datesplit( SettleDate2, NULL, NULL, YYYY_end );
      if(YYYY_beg == YYYY_end)
         N = double(SettleDate2 - SettleDate) / double(ДнейВГоду(YYYY_beg));
      else
         YYYY_cur = YYYY_beg + 1;
         N = double(DATE(1,1,YYYY_cur) - SettleDate) / double(ДнейВГоду(YYYY_beg));
         while(YYYY_cur < YYYY_end)
            N = N + 1;
            YYYY_cur = YYYY_cur + 1;
         end;
         N = N + double(SettleDate2 - DATE(1,1,YYYY_cur)) / double(ДнейВГоду(YYYY_end));
      end;
   end;
   if((Amount * N) != 0.0)
      RepoRate = round(((Amount2 - Amount) / (Amount * N)) * 100, 4);
   end;
end;

macro FillORDERS(synonim, imp_date, ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand( " INSERT INTO D_ORDERS_TMP(  "
                   +"   T_ID_SPB_ORDERS "           
                   +"  ,T_ID_MB_REQUISITES "      
                   +"  ,T_ORDERNO "               
                   +"  ,T_TRADEDATE "             
                   +"  ,T_TRADETIME "             
                   +"  ,T_CLIENTCODE "            
                   +"  ,T_BUYSELL "               
                   +"  ,T_IS_ADDRESS "          
                   +"  ,T_SECURITYID "            
                   +"  ,T_QUOTE_CURRENCY "            
                   +"  ,T_CURRENCYID "            
                   +"  ,T_PRICE "                 
                   +"  ,T_REPO_PRICE "              
                   +"  ,T_QUANTITY "              
                   +"  ,T_STATUS "                
                   +"  ,T_STATUS_REASON "                
                   +"  ,T_ACTION "                
                   +"  ,T_PARTYID "          
                   +"  ,T_SFCONTRID "          
                   +"  ,T_OBJECTID "  
                   +"  ,T_COMMENTAR ) "                  
                   +"  (SELECT " 
                   +"   ID_SPB_ORDERS "           
                   +"  ,NVL(ID_MB_REQUISITES, 0) "      
                   +"  ,NVL(REG_NO, CHR(1)) "      
                   +"  ,NVL(ENTRY_DATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "             
                   +"  ,NVL(ENTRY_TIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "             
                   +"  ,NVL(CLIENT_ALIAS, CHR(1)) "             
                   +"  ,NVL(BUY_SELL, CHR(1)) "               
                   +"  ,NVL(IS_ADDRESS, CHR(1)) "               
                   +"  ,NVL(SECURITYID, CHR(1)) "            
                   +"  ,NVL(QUOTE_CURRENCY, CHR(1)) "             
                   +"  ,NVL(CURRENCY, CHR(1)) "            
                   +"  ,NVL(PRICE, 0) "                 
                   +"  ,NVL(REPO_PRICE, 0) "                 
                   +"  ,NVL(QUANTITY, 0) "              
                   +"  ,NVL(STATUS, CHR(1)) "                
                   +"  ,NVL(STATUS_REASON, CHR(1)) "                
                   +"  ,NVL(ACTION, CHR(1)) "               
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,NVL(COMMENTAR, CHR(1)) "                        
                   +"  FROM "+ synonim + ".SPB_ORDERS "
                   +"  WHERE ID_MB_REQUISITES IN (SELECT NVL(ID_MB_REQUISITES, 0) FROM "+ synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = 'ORDERS' AND TRADE_DATE = ?) "
                   +"  AND  ZRID = 0  " 
                   +"    AND NOT NVL(COMMENTAR, CHR(1)) LIKE '%mc%' " //biq-9103 поручения Margin Call не загружаем
                   +"  ) "
                  );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateObjORDERS( ErrMes:@string ):integer
  var cmd;
  var Query ="DECLARE "
            +"  TYPE ObjID_t IS TABLE OF DGTCODE_DBT.T_OBJECTID%TYPE; "
            +"  TYPE SemID_t IS TABLE OF d_ORDERS_TMP.T_ID_SPB_ORDERS%TYPE; "
            +"  v_ObjIDs   ObjID_t; "
            +"  v_SemID    SemID_t; "
            +"BEGIN "
            +"  SELECT GTCODE.T_OBJECTID, ORDERS.t_ID_SPB_ORDERS "
            +"    BULK COLLECT INTO v_ObjIDs, v_semID "
            +"    FROM DGTCODE_DBT GTCODE, d_ORDERS_TMP ORDERS "
            +"   WHERE GTCODE.T_APPLICATIONID IN(" + GT_PAYMENTS_SPB + ", " + GT_SPB + ")"
            +"     AND GTCODE.T_OBJECTKIND = " + RG_REQUEST
            +"     AND GTCODE.T_OBJECTCODE = ORDERS.t_ORDERNO; "
            +"  IF v_semID.COUNT <> 0 THEN "
            +"    FORALL i IN v_semID.FIRST .. v_semID.LAST "
            +"      UPDATE d_ORDERS_TMP ORDERS "
            +"         SET ORDERS.t_objectID = v_ObjIDs (i) "
            +"       WHERE ORDERS.t_ID_SPB_ORDERS = v_semID (i); "
            +"    v_ObjIDs.delete; "
            +"    v_SemID.delete; "
            +"  END IF; "
            +"END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateORDERS_PM(synonim, SeanceID, ErrMes:@string):integer
  var cmd;
  var Query =" DECLARE "
            +"   TYPE ObjID_t IS TABLE OF DGTSNCREC_DBT.T_RECORDID%TYPE; "
            +"   TYPE PmID_t  IS TABLE OF d_ORDERS_TMP.T_ID_SPB_ORDERS%TYPE; "
            +"   v_ObjIDs ObjID_t; "
            +"   v_PmID   PmID_t; "
            +" BEGIN "
            +"   SELECT ORDERS.T_ID_SPB_ORDERS, GTSNCREC.T_RECORDID "
            +"     BULK COLLECT INTO v_PmID, v_ObjIDs "
            +"     FROM dgtsncrec_dbt gtsncrec, "
            +"          dgtcode_dbt gtcode, "
            +"          dgtobject_dbt gtobject, "
            +"          D_ORDERS_tmp ORDERS "
            +"    WHERE gtsncrec.t_seanceid = " + SeanceID
            +"      AND GTCODE.T_OBJECTKIND =  " + RG_REQUEST
            +"      AND GTCODE.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTOBJECT.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTCODE.T_OBJECTCODE = ORDERS.t_ORDERNO; "
            +"   IF v_PmID.COUNT <> 0 THEN "
            +"     FORALL i IN v_PmID.FIRST .. v_PmID.LAST "
            +"       UPDATE " + synonim + ".SPB_ORDERS ORDERS "
            +"          SET ZRID = v_ObjIDs(i) "
            +"        WHERE ID_SPB_ORDERS = v_PmID(i); "
            +"     v_PmID.delete; "
            +"     v_ObjIDs.delete; "
            +"   END IF; "
            +" END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DelORDERS( ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( " TRUNCATE TABLE D_ORDERS_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro FillMFB06C(synonim, imp_date, name, ErrMes:@string):integer
  var cmd;

  cmd = RSDCommand( " INSERT INTO D_MFB06C_TMP(  "
                   +"   T_ID_SPB_MFB06C "
                   +" , T_ID_MB_REQUISITES  "
                   +" , T_DOC_NO "
                   +" , T_RECNO  "
                   +" , T_CLIENTCODE "
                   +" , T_CURRENCYID "
                   +" , T_INFTYPE "
                   +" , T_CLEARINGTIME "
                   +" , T_SETTLEDATE"
                   +" , T_SECURITYID "
                   +" , T_ISIN "
                   +" , T_PRICETYPE "
                   +" , T_REPOPART "
                   +" , T_BUYSELL "
                   +" , T_SETTLECODE "
                   +" , T_CLRACCCODE "
                   +" , T_TRADEDATE "
                   +" , T_TRADENO "
                   +" , T_DECIMALS "
                   +" , T_PRICE "
                   +" , T_QUANTITY  "
                   +" , T_VALUE "
                   +" , T_AMOUNT "
                   +" , T_EXCHCOMM "
                   +" , T_ACCINT "
                   +" , T_CPFIRMID "
                   +" , T_REPOPERIOD "
                   +" , T_REPORTTIME "
                   +" , T_CLRCOMM "
                   +" , T_TRADEMODEID "
                   +" , T_TRADEPERIOD "
                   +" , T_ISREPO "
                   +" , T_PARTYID  "
                   +" , T_SFCONTRID  "
                   +" , T_ISNOTFIND "
                   +" , T_ISERROR "
                   +" , T_CPFIRMPARTYID "
                   +" , T_CURID "
                   +" , T_CALENDID "
                   +" , T_MARKETSCHEMEID "
                   +" , T_NDAY1 "
                   +" , T_NDAY2 "
                   +" , T_PAYMDATE1 "
                   +" , T_PAYMDATE2 "
                   +" , T_CALCITOGDATE"
                   +" , T_WORKSETTLEDATE "
                   +" , T_OBJECTID  "
                   +" , T_PORTFOLIO "
                   +" , T_CALENDID_TRD "
                   +" , T_ISOUTEXCREPO "
                   +" , T_FIID ) "                  
                   +"  (SELECT " 
                   +"   NVL(ID_SPB_MFB06C,0) "
                   +"  ,NVL(ID_MB_REQUISITES,0) " 
                   +"  ,CHR(1) " 
                   +"  ,NVL(RECNO,0) "            
                   +"  ,NVL(CLIENTCODE, CHR(1)) "       
                   +"  ,NVL(CURRENCYID, CHR(1)) "       
                   +"  ,NVL(INFTYPE,0) "          
                   +"  ,NVL(CLEARINGTIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "        
                   +"  ,NVL(SETTLEDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) "       
                   +"  ,NVL(SECURITYID, CHR(1)) "       
                   +"  ,NVL(ISIN, CHR(1)) "
                   +"  ,NVL(PRICETYPE, CHR(1)) "        
                   +"  ,NVL(REPOPART,0) "         
                   +"  ,NVL(BUYSELL, CHR(1)) "          
                   +"  ,NVL(SETTLECODE, CHR(1)) "       
                   +"  ,NVL(CLRACCCODE, CHR(1)) "       
                   +"  ,NVL(TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "        
                   +"  ,NVL(to_char(TRADENO), CHR(1)) "          
                   +"  ,NVL(DECIMALS,0) "         
                   +"  ,NVL(PRICE,0) "            
                   +"  ,NVL(QUANTITY,0) "         
                   +"  ,NVL(VALUE,0) "            
                   +"  ,NVL(AMOUNT,0) "           
                   +"  ,NVL(EXCHCOMM,0) "         
                   +"  ,NVL(ACCINT,0) "           
                   +"  ,NVL(CPFIRMID, CHR(1)) "         
                   +"  ,NVL(REPOPERIOD,0) "       
                   +"  ,NVL(TradeTime,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "       
                   +"  ,NVL(CLRCOMM,0) "          
                   +"  ,NVL(TRADEMODEID,0) "          
                   +"  ,NVL(TRADEPERIOD,0) "          
                   +"  ," + GetSqlIsREPO()
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,-1 "          
                   +"  ,-1 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,0 "          
                   +"  ,-1 "          
                   +"  ,0 "          
                   +"  , ( CASE WHEN ( ( NVL(TRADEMODEID,0) = 14) AND ( NVL(INFTYPE,0) = 2) ) THEN  1 ELSE 0 END  )"          
                   +"  ,-1 "          
                   +"  FROM "+ synonim + ".SPB_MFB06C "
                   +"  WHERE ID_MB_REQUISITES IN (SELECT NVL(ID_MB_REQUISITES, 0) FROM "+ synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = 'MFB06C' AND TRADE_DATE = ?) "
                   +"  AND  ZRID = 0  " 
                   +"  ) "                      
                  );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateParty( MarketID, Table, imp_date, ErrMes:@string):integer
  var cmd;

  cmd = RSDCommand( 
             " DECLARE "
            +"   TYPE PtID_t IS TABLE OF DSFCONTR_DBT.T_PARTYID%TYPE; "
            +"   TYPE SfID_t IS TABLE OF DSFCONTR_DBT.T_ID%TYPE; "
            +"   TYPE Code_t IS TABLE OF "+Table+".T_CLIENTCODE%TYPE; "
            +"   v_PtID   PtID_t; "
            +"   v_SfID   sfID_t; "
            +"   v_Code   Code_t; "
            +" BEGIN "
            +"   SELECT /*+ index(Tb " + Table + "_IDX2) */ DISTINCT sfcontr.T_PartyID, sfcontr.T_ID, Tb.t_ClientCode "
            +"     BULK COLLECT INTO v_PtID, v_SfID, v_Code "
            +"     FROM DDLCONTR_DBT dlcontr, "
            +"          DDLCONTRMP_DBT contrmp, "
            +"          DSFCONTR_DBT sfcontr, "
            +"          " + Table + " Tb "
            +"    WHERE     dlcontr.T_DLCONTRID = contrmp.T_DLCONTRID "
            +"          AND sfcontr.T_ID = contrmp.T_SFCONTRID "
            +"          AND sfcontr.T_SERVKIND = " + PTSK_STOCKDL
            +"          AND contrmp.T_MPCODE = Tb.t_ClientCode"
            +"          AND contrmp.T_MarketID = ? "
            +"          AND sfcontr.t_DateBegin <= DECODE (Tb.t_TradeDate, TO_DATE ('01-01-0001', 'DD-MM-YYYY'),? ,Tb.t_TradeDate) "
            +"          AND (   sfcontr.t_DateClose > Tb.t_TradeDate "
            +"               OR sfcontr.T_DateCLose = TO_DATE ('01-01-0001', 'DD-MM-YYYY')) "
            +"          AND sfcontr.t_DateBegin = "
            +"                (SELECT MAX (sf.t_DateBegin) "
            +"                   FROM DSFCONTR_DBT sf "
            +"                  WHERE     sf.T_SERVKIND = sfcontr.T_SERVKIND "
            +"                        AND sf.T_ID = contrmp.T_SFCONTRID "
            +"                        AND contrmp.T_MPCODE = Tb.t_ClientCode "
            +"                        AND contrmp.T_MarketID = ? "
            +"                        AND sf.t_PartyID = sfcontr.t_PartyID "
            +"                        AND sf.t_DateBegin <= Tb.t_TradeDate) "
            +"         AND Tb.t_ClientCode <> CHR(1) ; "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN                   "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_partyid) = (v_PtID (i)), (t_sfcontrid) = (v_SfID (i)) "
            +"        WHERE Tb.t_ClientCode = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_SfID.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +"   SELECT distinct t.t_objectid, Tb.t_ClientCode "
            +"     BULK COLLECT INTO v_PtID, v_Code "
            +"     FROM dobjcode_dbt t, " + Table + " Tb "
            +"    WHERE     Tb.t_partyid <= 0 "
            +"          AND Tb.t_ClientCode <> CHR(1)  "
            +"          AND (    t.t_objecttype = " + OBJTYPE_PARTY
            +"               AND t.t_codekind =  "  + PTCK_SPBEX
            +"               AND t.t_code = Tb.t_ClientCode"
            +"               AND t.t_state = 0 "
            +"               AND t.t_autokey = "
            +"                     (SELECT MIN (code.t_autokey) "
            +"                        FROM dobjcode_dbt code "
            +"                       WHERE     code.t_objecttype = t.t_objecttype "
            +"                             AND code.t_codekind = t.t_codekind "
            +"                             AND code.t_code = t.t_code "
            +"                             AND code.t_state = t.t_state)); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_partyid) = (v_PtID (i)) "
            +"        WHERE Tb.t_ClientCode = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +" END; ")
            ;
  cmd.addParam( "", RSDBP_IN, MarketID );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.addParam( "", RSDBP_IN, MarketID );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;


macro UpdateObjMFB06C( IsRshb, ErrMes:@string ):integer
  var cmd;
//проверить заполнение кода в дистрибутиве и в пользовательских макросах
  var Query ="DECLARE "
            +"  TYPE ObjID_t IS TABLE OF DGTCODE_DBT.T_OBJECTID%TYPE; "
            +"  TYPE SemID_t IS TABLE OF D_MFB06C_TMP.t_ID_SPB_MFB06C%TYPE; "
            +"  v_ObjIDs ObjID_t; "
            +"  v_SemID  SemID_t; "
            +"BEGIN "
            +"  SELECT GTCODE.T_OBJECTID, MFB06C.t_ID_SPB_MFB06C "
            +"    BULK COLLECT INTO v_ObjIDs, v_semID "
            +"    FROM DGTCODE_DBT GTCODE, d_MFB06C_TMP MFB06C "
            +"   WHERE GTCODE.T_APPLICATIONID IN (" + GT_PAYMENTS_SPB + ", " + GT_SPB + ")"
            +"     AND GTCODE.T_OBJECTKIND = " + RG_CLEARING
            +"     AND GTCODE.T_OBJECTCODE = (CASE WHEN MFB06C.T_CLIENTCODE <> CHR(1) "
            +"                                     THEN (MFB06C.T_BUYSELL || '/' || MFB06C.T_TRADENO ||" + RG_IIF(IsRshb == 1, "'s_c'", "'_c'") + "|| MFB06C.T_REPOPART ) "
            +"                                     ELSE (MFB06C.T_TRADENO ||'_c'|| MFB06C.T_REPOPART) "
            +"                                 END); "
            +"  IF v_semID.COUNT <> 0 THEN "
            +"    FORALL i IN v_semID.FIRST .. v_semID.LAST "
            +"      UPDATE d_MFB06C_TMP MFB06C "
            +"         SET MFB06C.t_objectID = v_ObjIDs (i) "
            +"       WHERE MFB06C.t_ID_SPB_MFB06C = v_semID (i); "
            +"    v_ObjIDs.delete; "
            +"    v_semID.delete; "
            +"  END IF; "
            +"END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro UpdateMFB06C_PM(synonim, SeanceID, IsRshb, ErrMes:@string ):integer
  var cmd;
//проверить заполнение кода в дистрибутиве и в пользовательских макросах
  var Query =" DECLARE "
            +"   TYPE ObjID_t IS TABLE OF DGTSNCREC_DBT.T_RECORDID%TYPE; "
            +"   TYPE PmID_t  IS TABLE OF D_MFB06C_TMP.T_ID_SPB_MFB06C%TYPE; "
            +"   v_ObjIDs ObjID_t; "
            +"   v_PmID   PmID_t; "
            +" BEGIN "
            +"   SELECT MFB06C.T_ID_SPB_MFB06C, GTSNCREC.T_RECORDID "
            +"     BULK COLLECT INTO v_PmID, v_ObjIDs "
            +"     FROM dgtsncrec_dbt gtsncrec, "
            +"          dgtcode_dbt gtcode, "
            +"          dgtobject_dbt gtobject, "
            +"          D_MFB06C_tmp MFB06C "
            +"    WHERE gtsncrec.t_seanceid = " + SeanceID
            +"      AND GTCODE.T_OBJECTKIND = " + RG_CLEARING
            +"      AND GTCODE.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTOBJECT.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTCODE.T_OBJECTCODE = (CASE WHEN MFB06C.T_CLIENTCODE <> CHR(1) "
            +"                                      THEN (MFB06C.T_BUYSELL || '/' || MFB06C.T_TRADENO ||" + RG_IIF(IsRshb == 1, "'s_c'", "'_c'") + "|| MFB06C.T_REPOPART ) "
            +"                                      ELSE (MFB06C.T_TRADENO ||'_c'|| MFB06C.T_REPOPART) "
            +"                                  END); "
            +"   IF v_PmID.COUNT <> 0 THEN "
            +"     FORALL i IN v_PmID.FIRST .. v_PmID.LAST "
            +"       UPDATE " + synonim + ".SPB_MFB06C MFB06C "
            +"          SET ZRID = v_ObjIDs (i) "
            +"        WHERE ID_SPB_MFB06C = v_PmID (i); "
            +"     v_ObjIDs.delete; "
            +"     v_PmID.delete; "
            +"   END IF; "
            +" END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro UpdateMFB06C( synonim, ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( " Update D_MFB06C_TMP MFB06C Set MFB06C.T_DOC_NO = (SELECT requi.DOC_NO  FROM "+synonim+".MB_REQUISITES requi WHERE requi.ID_MB_REQUISITES = t_ID_MB_REQUISITES AND requi.ID_MB_REQUISITES = t_ID_MB_REQUISITES AND ROWNUM = 1 ) " );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro UpdateCalend( Table, MarketID, OperName, ErrMes:@string ):integer
  var Query =
      " DECLARE "
     +"    TYPE callarr_t IS TABLE OF NUMBER (10) "
     +"                         INDEX BY VARCHAR2 (20); "
     +"  "
     +"    v_calPrm     RSI_DlCalendars.calparamarr_t; "
     +"    v_calendId   NUMBER (10); "
     +" BEGIN "
     +"    FOR one_cur IN (SELECT DISTINCT t_curid FROM "+Table+") "
     +"    LOOP "
     +"       v_calPrm.DELETE; "
     +"       v_calPrm ('Object') := '"+OperName+"'; "
     +"       v_calPrm ('ObjectType') := '"+string(DL_CALLNK_MARKET)+"'; "
     +"       v_calPrm ('Market') := '"+string(MarketID)+"'; "
     +"       v_calPrm ('DayType') := '"+string(DL_CALLNK_MRKTDAY_SETTL)+"'; "
     +"       v_calPrm ('MarketPlace') := '"+string(DL_CALLNK_MARKETPLACE_SEC)+"'; "
     +"       v_calPrm ('Currency') := TO_CHAR (one_cur.t_curid); "
     +"  "
     +"       v_calendId := RSI_DlCalendars.DL_GetCalendByDynParam (83, v_calPrm); "
     +"  "
     +"       UPDATE "+Table+" Tb "
     +"          SET Tb.t_CalendID = v_calendId "
     +"        WHERE Tb.t_curid = one_cur.t_curid; "
     +"    END LOOP; "
     +" END; ";
  var Query2 =
      " DECLARE "
     +"    TYPE callarr_t IS TABLE OF NUMBER (10) "
     +"                         INDEX BY VARCHAR2 (20); "
     +"  "
     +"    v_calPrm     RSI_DlCalendars.calparamarr_t; "
     +"    v_calendId   NUMBER (10); "
     +" BEGIN "
     +"    FOR one_cur IN (SELECT DISTINCT t_curid FROM "+Table+") "
     +"    LOOP "
     +"       v_calPrm.DELETE; "
     +"       v_calPrm ('Object') := '"+OperName+"'; "
     +"       v_calPrm ('ObjectType') := '"+string(DL_CALLNK_MARKET)+"'; "
     +"       v_calPrm ('Market') := '"+string(MarketID)+"'; "
     +"       v_calPrm ('DayType') := '"+string(DL_CALLNK_MRKTDAY_TRADE)+"'; "
     +"       v_calPrm ('MarketPlace') := '"+string(DL_CALLNK_MARKETPLACE_SEC)+"'; "
     +"       v_calPrm ('Currency') := TO_CHAR (one_cur.t_curid); "
     +"  "
     +"       v_calendId := RSI_DlCalendars.DL_GetCalendByDynParam (83, v_calPrm); "
     +"  "
     +"       UPDATE "+Table+" Tb "
     +"          SET Tb.t_CalendID_Trd = v_calendId "
     +"        WHERE Tb.t_curid = one_cur.t_curid; "
     +"    END LOOP; "
     +" END; ";
  var cmd;
  cmd = RSDCommand(Query);
  cmd.execute();

  cmd = RSDCommand(Query2);
  cmd.execute();

  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro UpdateCur( Table, ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( 
             " DECLARE "
            +"   TYPE PtID_t IS TABLE OF DOBJCODE_DBT.T_OBJECTID%TYPE; "
            +"   TYPE Code_t IS TABLE OF "+Table+".T_CURRENCYID%TYPE; "
            +"   v_PtID   PtID_t; "
            +"   v_Code   Code_t; "
            +" BEGIN "
            +"   SELECT distinct t.t_objectid, Tb.t_currencyID "
            +"     BULK COLLECT INTO v_PtID, v_Code "
            +"     FROM dobjcode_dbt t, " + Table + " Tb "
            +"    WHERE  Tb.t_currencyID <> CHR(1)"
            +"          AND (    t.t_objecttype = " + OBJTYPE_FININSTR
            +"               AND t.t_codekind = 22 " 
            +"               AND t.t_code = Tb.t_currencyID "
            +"               AND t.t_state = 0 "
            +"               AND t.t_autokey = "
            +"                     (SELECT MIN (code.t_autokey) "
            +"                        FROM dobjcode_dbt code "
            +"                       WHERE     code.t_objecttype = t.t_objecttype "
            +"                             AND code.t_codekind = t.t_codekind "
            +"                             AND code.t_code = t.t_code "
            +"                             AND code.t_state = t.t_state)); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_CurId) = (v_PtID (i)) "
            +"        WHERE Tb.t_currencyID = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +" END; ")
            ;
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro GetFileName( synonim, Table, FilesName:@string, ErrMes:@string ):integer
  var cmd, ds;

  cmd = DL_RSDCommand( " SELECT REQUIS.FILE_NAME file_name from "+synonim+".MB_REQUISITES REQUIS WHERE REQUIS.ID_MB_REQUISITES IN (SELECT DISTINCT t.T_ID_MB_REQUISITES FROM " +Table+ " t ) " );
  ds = cmd.execute();
  while(ds.MoveNext)
    FilesName = FilesName + ds.file_name + " \n"
  end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro CheckFileUpload(synonim, FileType:string, imp_date:date, ErrMes:@string):integer
  var cmd, ds;

  cmd = RSDCommand(" SELECT 1 FROM " + synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = ? AND TRADE_DATE = ? ");
  cmd.addParam("", RSDBP_IN, FileType);
  cmd.addParam("", RSDBP_IN, imp_date);
  ds = TRsbDataSet(cmd);
  if(not ds.MoveNext)
    ErrMes = "Нет данных в Payments";
    return 1;
  end;
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DelMFB06C( ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( " TRUNCATE TABLE D_MFB06C_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;


macro DelSPB03(ErrMes:@string):integer
  ErrMes = "";
  var cmd = RSDCommand("TRUNCATE TABLE D_SPB03_TMP");
  cmd.execute();

  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();

  return 1;
end;

macro UpdateClrAccCodeType(SeanceID:integer, SourceCode:string, MarketID:integer) :integer
  var cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.UpdateClrAccCodeType_SPB03(?, ?, ?); END;");
  cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
  cmdSP.addParam("", RSDBP_IN, SeanceID);
  cmdSP.addParam("", RSDBP_IN, SourceCode);
  cmdSP.addParam("", RSDBP_IN, MarketID);
  cmdSP.Execute();

  return Int(cmdSP.value("stat"));
end;

macro FillSPB03(synonim:string, imp_date:date, errMes:@string) :integer
  errMes = "";
  var sql:string = "INSERT INTO D_SPB03_TMP "
                        +" ( "
                      +"   T_ID_SPB_SPB03 "
                      +"  ,T_ID_MB_REQUISITES "
                      +"  ,T_DOC_NO "
                      +"  ,T_CLRACCCODE "
                      +"  ,T_RECNO "
                      +"  ,T_CURRENCYID "
                      +"  ,T_SETTLEDATE "
                      +"  ,T_SECURITYID "
                      +"  ,T_ISIN "
                      +"  ,T_FACEVALUE "
                      +"  ,T_PRICETYPE "
                      +"  ,T_CLIENTCODE "
                      +"  ,T_REPOPART "
                      +"  ,T_BUYSELL "
                      +"  ,T_SETTLECODE "
                      +"  ,T_TRADENO "
                      +"  ,T_TRADEDATE "
                      +"  ,T_TRADETIME "
                      +"  ,T_TRADETYPE "
                      +"  ,T_TRADEPERIOD "
                      +"  ,T_SPECIALPERIOD "
                      +"  ,T_PRIMARYORDERID "
                      +"  ,T_ORDERID "
                      +"  ,T_DECIMALS "
                      +"  ,T_PRICE "
                      +"  ,T_QUANTITY "
                      +"  ,T_VALUE "
                      +"  ,T_AMOUNT "
                      +"  ,T_EXCHCOMM "
                      +"  ,T_CLRCOMM "
                      +"  ,T_CCPCODE "
                      +"  ,T_CPFIRMID "
                      +"  ,T_REPORATE "
                      +"  ,T_ACCINT "
                      +"  ,T_PRICE2 "
                      +"  ,T_BOARDID "//не исп
                      +"  ,T_BOARDNAME "//не исп
                      +"  ,T_SECURITYTYPE "//не исп
                      +"  ,T_SECCURRENCYID "//не исп
                      +"  ,T_PARTYID "
                      +"  ,T_SFCONTRID "
                      +"  ,T_ISNOTFIND "
                      +"  ,T_ISERROR "
                      +"  ,T_CPFIRMPARTYID "
                      +"  ,T_CURID "
                      +"  ,T_CALENDID "
                      +"  ,T_MARKETSCHEMEID "
                      +"  ,T_NDAY1 "
                      +"  ,T_PAYMDATE1 "
                      +"  ,T_PAYMDATE2 "
                      +"  ,T_CALCITOGDATE "
                      +"  ,T_WORKSETTLEDATE "
                      +"  ,T_OBJECTID "
                      +"  ,T_PORTFOLIO "
                      +"  ,T_FIID "
                      +"  ,T_CALENDID_TRD "
                      +"  ,T_ISREPO "
                      +"  ,T_ACCINT2 "
                      +"  ,T_SETTLEDATE2 "
                      +"  ,T_AMOUNT2 "
                      +"  ,T_VALUE2 "
                      +"  ,T_PRICE2_2 "
                      +"  ,T_CLRACCCODETYPE "
                      +"  ,T_COMMENTAR "
                      +  " ) "
                      +  " ( "
                      +  " SELECT " 
                      +"   NVL(T.ID_SPB_SPB03, 0) "
                      +"  ,NVL(T.ID_MB_REQUISITES, 0) "
                      +"  ,CHR(1) "
                      +"  ,NVL(T.CLRACCCODE, CHR(1)) "
                      +"  ,NVL(T.RECNO,0) "
                      +"  ,NVL(T.CURRENCYID, CHR(1)) "
                      +"  ,NVL(T.SETTLEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "
                      +"  ,NVL(T.SECURITYID, CHR(1)) "
                      +"  ,NVL(T.ISIN, CHR(1)) "
                      +"  ,NVL(T.FACEVALUE,0) "
                      +"  ,NVL(T.PRICETYPE, CHR(1)) "
                      +"  ,NVL(T.CLIENTCODE, CHR(1)) "
                      +"  ,NVL(T.REPOPART,0) "
                      +"  ,NVL(T.BUYSELL, CHR(1)) "
                      +"  ,NVL(T.SETTLECODE, CHR(1)) "
                      +"  ,NVL(TO_CHAR(T.TRADENO), CHR(1)) "
                      +"  ,NVL(T.TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "
                      +"  ,NVL(T.TRADETIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "
                      +"  ,NVL(T.TRADETYPE, CHR(1)) "
                      +"  ,NVL(T.TRADEPERIOD, CHR(1)) "
                      +"  ,NVL(TO_CHAR(T.SPECIALPERIOD), CHR(1)) "
                      +"  ,NVL(TO_CHAR(T.PRIMARYORDERID), CHR(1)) "
                      +"  ,NVL(TO_CHAR(T.ORDERID), CHR(1)) "
                      +"  ,NVL(T.DECIMALS,0) "
                      +"  ,NVL(T.PRICE,0) "
                      +"  ,NVL(T.QUANTITY,0) "
                      +"  ,NVL(T.VALUE,0) "
                      +"  ,NVL(T.AMOUNT,0) "
                      +"  ,NVL(T.EXCHCOMM,0) "
                      +"  ,NVL(T.CLRCOMM,0) "
                      +"  ,NVL(T.CCPCODE, CHR(1)) "
                      +"  ,NVL(T.CPFIRMID, CHR(1)) "
                      +"  ,NVL(T.REPORATE,0) "
                      +"  ,NVL(T.ACCINT,0) "
                      +"  ,NVL(T.PRICE2,0) "
                      +"  ,NVL(T.BOARDID, CHR(1)) "
                      +"  ,NVL(T.BOARDNAME, CHR(1)) "
                      +"  ,NVL(TO_CHAR(T.SECURITYTYPE), CHR(1)) "
                      +"  ,NVL(T.SECCURRENCYID, CHR(1)) "
                      +"  ,0 "
                      +"  ,0 "
                      +"  ,0 "
                      +"  ,0 "
                      +"  ,0 "
                      +"  ,-1 "
                      +"  ,-1 "
                      +"  ,0 "
                      +"  ,0 "
                      +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "
                      +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "
                      +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "
                      +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "
                      +"  ,0 "
                      +"  ,-1 "
                      +"  ,-1 "
                      +"  ,-1 "
                      +"  ," + GetSqlIsREPO("T.")
                      +"  ,NVL(RepoPart2.ACCINT, 0) "
                      +"  ,NVL(RepoPart2.SETTLEDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) "
                      +"  ,NVL(RepoPart2.AMOUNT, 0) "
                      +"  ,NVL(RepoPart2.VALUE, 0) "
                      +"  ,NVL(RepoPart2.PRICE2, 0) "
                      +"  ,0 "
                      +"  ,NVL(T.COMMENTAR, CHR(1)) "                                  
                      +    " FROM "+ synonim + ".SPB_SPB03 T "
                      +    " LEFT JOIN "+ synonim + ".SPB_SPB03 REPOPART2 "
                      +      " ON REPOPART2.ID_MB_REQUISITES = T.ID_MB_REQUISITES "
                      +     " AND NVL(REPOPART2.REPOPART, 0) = 2 "
                      +     " AND NVL(REPOPART2.TRADENO, 0) = NVL(T.TRADENO, 0) "
                      +     " AND NVL(REPOPART2.CLIENTCODE, 0) <> CHR(1) "
                      +   " WHERE T.ID_MB_REQUISITES IN (SELECT NVL(ID_MB_REQUISITES, 0) "
                                                        +" FROM "+ synonim + ".PROCESSING_ACTUAL "
                                                       +" WHERE FILE_TYPE = 'SPB03' "
                                                         +" AND TRADE_DATE = ? "
                                                     +" ) "
                      +     " AND T.ZRID = 0 "
                      +     " AND NVL(T.REPOPART, 0) != 2 "
                      +  " ) ";

  var cmd = RSDCommand(sql);
  cmd.addParam("", RSDBP_IN, imp_date);
  cmd.execute();

  return 0;
OnError(ErObj)
  errMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;// + "\n" + RG.GetLastError();

  return 1;
end;

macro UpdateSPB03(synonim:string, errMes:@string) :integer
  errMes = "";
  var cmd = RSDCommand("UPDATE D_SPB03_TMP SPB03 " +
                         " SET SPB03.T_DOC_NO = (SELECT requi.DOC_NO " + 
                                                 " FROM "+synonim+".MB_REQUISITES requi " +
                                                " WHERE requi.ID_MB_REQUISITES = SPB03.t_ID_MB_REQUISITES " +
                                                  " AND ROWNUM = 1)");
  cmd.execute();

  return 0;
OnError(ErObj)
  errMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;

  return 1;
end;

private macro PortfPriorityOrDefault(avr, onDate:date, regValPortfIdDef:integer) :integer
  var ValidFromDate = DATE(0,0,0);
  var AttrID = 0;
  var PortfID = -1;

  if((GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(avr, OBJTYPE_AVOIRISS), 61/*Приоритетный портфель*/, AttrID, null, null, onDate, ValidFromDate) == true) and
     (ValidFromDate <= onDate))
    if(AttrID == 1)
       PortfID = KINDPORT_RETIRE;
    elif(AttrID == 2)
       PortfID = KINDPORT_TRADE;
    elif(AttrID == 3)
       PortfID = KINDPORT_SALE;
    end;
  else
    PortfID = -1;
  end;

  if(not(PortfID > 0))
    if(regValPortfIdDef == 0)
      PortfID = KINDPORT_TRADE;
    else
      PortfID = KINDPORT_SALE;
    end;
  end;

  return PortfID;
end;

var RegValPortfIdDef:integer = null;
macro GetRegValPortfIdDef()
  if(RegValPortfIdDef == null)
    GetRegistryValue("SECUR\\МСФО\\ПОРТФЕЛЬ ПО УМОЛЧАНИЮ", V_INTEGER, RegValPortfIdDef);
  end;

  return RegValPortfIdDef;
end;

macro UpdatePortfolio(table:string, imp_date:date, errMes:@string) :integer
  var query, cmd, DataSet;
  var cmdUpd;
  var Portfolio:integer = KINDPORT_UNDEF;
  var avr = TRecHandler("avoiriss");

  query = "SELECT DISTINCT DECODE (tb.t_ClientCode, CHR(1), 0, 1) IsClient, "
               +" tb.t_FIID FIID "
          +" FROM " + Table + " tb "
         +" WHERE tb.t_IsREPO = 0 ";

  cmd = RSDCommand(query);
  cmd.Execute();

  DataSet = TRsbDataSet(cmd);
  while(DataSet.moveNext() )
    if( (ПолучитьФинИн(DataSet.FIID, NULL, avr, NULL, NULL) == 0) OR (DataSet.IsClient))
      Portfolio = KINDPORT_UNDEF;

      if(DataSet.IsClient) /*клиентская*/
        Portfolio = KINDPORT_CLIENT;
      elif( avr.rec.FIID > 0 )
        if(WRTGetPortfolioAmount(-1, avr.rec.FIID, -1, 0, KINDPORT_CONTR, -1, imp_date, true, true, false) > $0)
          Portfolio = KINDPORT_CONTR;
        else                                                                                                   
          Portfolio = PortfPriorityOrDefault(avr, imp_date, GetRegValPortfIdDef());
        end;                                                                                                   
      end;

      cmdUpd = RSDCommand(" UPDATE " + Table + " tb "
                             +"SET tb.t_Portfolio = ? "
                          +" WHERE DECODE(tb.t_ClientCode, CHR(1), 0, 1) = 1 " /*клиентская*/
                            +" AND tb.t_FIID = ? "
                            +" AND tb.t_IsREPO = 0 " 
                         );
      cmdUpd.addParam("", RSDBP_IN, Portfolio);
      cmdUpd.addParam("", RSDBP_IN, DataSet.FIID);
      cmdUpd.execute();
    end;
  end;

  return 0;
OnError(ErObj)
  errMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;

  return 1;
end;

macro UpdateObjSPB03(IsRshb:integer, ErrMes:@string) :integer
  var cmd;
  var Query ="DECLARE "
            +"  TYPE ObjID_t IS TABLE OF DGTCODE_DBT.T_OBJECTID%TYPE; "
            +"  TYPE SemID_t IS TABLE OF D_SPB03_TMP.T_ID_SPB_SPB03%TYPE; "
            +"  v_ObjIDs ObjID_t; "
            +"  v_SemID  SemID_t; "
            +"BEGIN "
            +"  SELECT GTCODE.T_OBJECTID, SPB03.t_ID_SPB_SPB03 "
            +"    BULK COLLECT INTO v_ObjIDs, v_semID "
            +"    FROM DGTCODE_DBT GTCODE, d_SPB03_TMP SPB03 "
            +"   WHERE GTCODE.T_APPLICATIONID IN (" + GT_PAYMENTS_SPB + ", " + GT_SPB + ")"
            +"     AND GTCODE.T_OBJECTKIND = " + RG_SECURDEAL
            +"     AND GTCODE.T_OBJECTCODE = (CASE WHEN SPB03.T_CLIENTCODE <> CHR(1) "
            +"                                     THEN (SPB03.T_BUYSELL || '/' || SPB03.T_TRADENO " + RG_IIF(IsRshb == 1, " || 's'", "") + ") "
            +"                                     ELSE SPB03.T_TRADENO "
            +"                                 END); "
            +"  IF v_semID.COUNT <> 0 THEN "
            +"    FORALL i IN v_semID.FIRST .. v_semID.LAST "
            +"      UPDATE d_SPB03_TMP SPB03 "
            +"         SET SPB03.t_objectID = v_ObjIDs (i) "
            +"       WHERE SPB03.t_ID_SPB_SPB03 = v_semID (i); "
            +"    v_SemID.delete; "
            +"    v_ObjIDs.delete; "
            +"  END IF; "
            +"END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();

  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;

  return 1;
end;

macro UpdateSPB03_PM(synonim:string, SeanceID:integer, IsRshb:integer, ErrMes:@string) :integer
  var cmd;
  var Query =" DECLARE "
            +"   TYPE ObjID_t IS TABLE OF DGTSNCREC_DBT.T_RECORDID%TYPE; "
            +"   TYPE PmID_t  IS TABLE OF D_SPB03_TMP.T_ID_SPB_SPB03%TYPE; "
            +"   v_ObjIDs ObjID_t; "
            +"   v_PmID   PmID_t; "
            +" BEGIN "
            +"   SELECT SPB03.T_ID_SPB_SPB03, GTSNCREC.T_RECORDID "
            +"     BULK COLLECT INTO v_PmID, v_ObjIDs "
            +"     FROM dgtsncrec_dbt gtsncrec, "
            +"          dgtcode_dbt gtcode, "
            +"          dgtobject_dbt gtobject, "
            +"          D_SPB03_tmp SPB03 "
            +"    WHERE gtsncrec.t_seanceid = " + SeanceID
            +"      AND GTCODE.T_OBJECTKIND =  " + RG_SECURDEAL
            +"      AND GTCODE.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTOBJECT.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTCODE.T_OBJECTCODE = (CASE WHEN SPB03.T_CLIENTCODE <> CHR(1) "
            +"                                      THEN (SPB03.T_BUYSELL || '/' || SPB03.T_TRADENO " + RG_IIF(IsRshb == 1, " || 's'", "") + ") "
            +"                                      ELSE SPB03.T_TRADENO "
            +"                                  END); "
            +"   IF v_PmID.COUNT <> 0 THEN "
            +"     FORALL i IN v_PmID.FIRST .. v_PmID.LAST "
            +"       UPDATE " + synonim + ".SPB_SPB03 SPB03 "
            +"          SET ZRID = v_ObjIDs (i) "
            +"        WHERE ID_SPB_SPB03 = v_PmID (i); "
            +"     v_PmID.delete; "
            +"     v_ObjIDs.delete; "
            +"   END IF; "
            +" END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;

OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;

  return 1;
end;

macro UpdateCPFirmIDSPB03(synonim:string, imp_date:date, cPFirmIdConst:string, errMes:@string) :integer
  errMes = "";

  if(cPFirmIdConst != "")
    /*для СделкаToday (не срочных и не РЕПО) в качестве контрагента ставим субъекта с принадлежностью 'Центральный контрагент'*/
    var cmd = RSDCommand("UPDATE D_SPB03_TMP S SET S.T_CPFIRMID = ? "+
                         " WHERE S.T_CPFIRMID = CHR(1) "+
                           " AND S.T_ISREPO = 0 "+ //не РЕПО
                                 //SettleDate == DealDate
                           " AND (CASE WHEN S.T_TRADEDATE = TO_DATE('01.01.0001', 'DD.MM.YYYY') "+
                                     " THEN ? "+
                                     " ELSE S.T_TRADEDATE "+
                                 " END "+
                               " ) = S.T_SETTLEDATE "+
                                 //DealDate >= date(1,11,2011)
                           " AND (CASE WHEN S.T_TRADEDATE = TO_DATE('01.01.0001', 'DD.MM.YYYY') "+
                                     " THEN ? "+
                                     " ELSE S.T_TRADEDATE "+
                                 " END "+
                               " ) >= TO_DATE('01.11.2011', 'DD.MM.YYYY') ");

    cmd.addParam("", RSDBP_IN, cPFirmIdConst);
    cmd.addParam("", RSDBP_IN, imp_date);
    cmd.addParam("", RSDBP_IN, imp_date);

    cmd.execute();
  end;

  return 0;
OnError(ErObj)
  errMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;

  return 1;
end;

macro FillSPB21(synonim:string, imp_date:date, ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand( " INSERT INTO D_SPB21_TMP(  "
                   +"   T_ID_SPB_SPB21 "           
                   +"  ,T_ID_MB_REQUISITES "      
                   +"  ,T_TRADEDATE "             
                   +"  ,T_BOARDID "             
                   +"  ,T_SECURITYID "
                   +"  ,T_FACEVALUE "
                   +"  ,T_SECCURRENCYID "          
                   +"  ,T_SECURITYTYPE "
                   +"  ,T_DECIMALS "
                   +"  ,T_CURRENCYID "
                   +"  ,T_ACCRUEDINTEREST "
                   +"  ,T_TOTALAMOUNT "
                   +"  ,T_MAXDEALPRICE "
                   +"  ,T_MINDEALPRICE "
                   +"  ,T_WAPRICE "
                   +"  ,T_MARKETPRICE3 ) "          
                   +"  (SELECT " 
                   +"   T.ID_SPB_SPB21 "           
                   +"  ,NVL(T.ID_MB_REQUISITES, 0) "      
                   +"  ,NVL(T.TRADEDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) "            
                   +"  ,NVL(T.BOARDID, CHR(1)) "             
                   +"  ,NVL(T.SECURITYID, CHR(1)) "
                   +"  ,NVL(T.FACEVALUE, 0) "                            
                   +"  ,NVL(T.SECCURRENCYID, CHR(1)) "               
                   +"  ,NVL(T.SECURITYTYPE, CHR(1)) "            
                   +"  ,NVL(T.DECIM, 0) "             
                   +"  ,NVL(T.CURRENCYID, CHR(1)) "                
                   +"  ,NVL(T.ACCRUEDINTEREST, 0) "                           
                   +"  ,NVL(T.TOTALAMOUNT, 0) "                 
                   +"  ,NVL(T.MAXDEALPRICE, 0) "                 
                   +"  ,NVL(T.MINDEALPRICE, 0) "
                   +"  ,NVL(T.WAPRICE, 0) "                 
                   +"  ,NVL(T.MARKETPRICE3, 0) "              
                   +"  FROM "+ synonim + ".SPB_SPB21 T "
                   +" WHERE T.ID_MB_REQUISITES IN (SELECT ID_MB_REQUISITES FROM "+ synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = 'SPB21' AND TRADE_DATE = ?) "
                   +"   AND T.ZRID = 0  "
                   +"   AND NVL(T.TRADEPERIOD, CHR(1)) = 'MAIN' " 
                   +"  ) "
                  );
  cmd.addParam("", RSDBP_IN, imp_date);
  cmd.execute();
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro DelSPB21(ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand(" TRUNCATE TABLE D_SPB21_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;