/*
$Name: gtImMVB5.mac
$Module: Шлюз
$Description: Импорт биржевых сделок КО (xml-формат)
*/
///////////////////////////////////////////////////////////////////////////////////
//*******************************************************************************//
//*  Модуль           : Шлюз                                                    *//
//*  Имя файла        : gtImReut.mac                                            *//
//*  Описание         : Импорт биржевых сделок КО (xml-формат)                  *//
//*  Программист      : Куперин М.В. //AV 04.11.2013                            *//
//*******************************************************************************//
///////////////////////////////////////////////////////////////////////////////////
IMPORT rsexts, BankInter, RsbDataSet, RsbFormsInter, "rgtgtlog.mac", 
       "rgtgtrec.mac", "gtconst.inc", "rgobj.mac", "gtdlfun.mac", oralib;
/////////////////////////////////////////////////////////////////////////////////////
private class CUX23_Data()
  var
      FileName           = "",
      ReportDate         = date(0,0,0),
      FirmId             = "",
      FirmName           = "",
      FirmNameEn         = "",
      ExchangeId         = "",
      ClearingFirmId     = "",
      ClearingFirmName   = "",
      ClearingFirmNameEN = "",
      ExtSettleCode      = "",
      AddSession         = "",
      SessionName        = "",
      SessionNameEn      = "",
      CurrencyId         = "",
      CurrencyName       = "",
      CurrencyNameEn     = "",
      CoCurrencyId       = "",
      CoCurrencyName     = "",
      CoCurrencyNameEn   = "",
      SecurityId         = "",
      SecShortName       = "",
      FaceValue          = 0,
      SettleDate         = date(0,0,0),
      TradeGroup         = "",
      MainSecurityId     = "",
      MainSecShortName   = "",
      TradeNo            = 0,
      BuySell            = "",
      OrderNo            = 0,
      TradeDeriv         = "",
      TradeTime          = time(),
      TradeType          = "",
      Decimals           = 0,
      Price              = 0,
      Quantity           = 0,
      Value              = 0,
      CPFirmId           = "",
      Period             = "",
      SettleCode         = "",
      UserId             = "",
      UserExchangeId     = "",
      BrokerRef          = "",
      ExtRef             = "",
      ExchComm           = 0,
      ITSComm            = 0,
      ClrComm            = 0,
      SumComm            = 0,
      ClientCode         = "",
      Details            = "",
      SubDetails         = "",
      RepoTradeNo        = 0,
      BoardId            = "",
      BoardName          = "",
      BoardNameEn         = "";

  macro Save()
    var
        params  = TArray(),
        sqlText = "insert into dfx_CUX23_tmp ( " +
                  " t_FileName, t_ReportDate, t_FirmId, t_FirmName, t_FirmNameEn, t_ExchangeId, " +
                  " t_ClearingFirmId, t_ClearingFirmName, t_ClearingFirmNameEn, t_ExtSettleCode, t_AddSession, t_SessionName, t_SessionNameEn, " +
                  " t_CurrencyId, t_CurrencyName, t_CurrencyNameEn, t_CoCurrencyId, t_CoCurrencyName, t_CoCurrencyNameEn, " +
                  " t_SecurityId, t_SecShortName, t_FaceValue, t_SettleDate, t_TradeGroup, " +
                  " t_MainSecurityID, t_MainSecShortName, t_TradeNo, t_BuySell, t_OrderNo, " +
                  " t_TradeDeriv, t_TradeTime, t_TradeType, t_Decimals, t_Price, t_Quantity, " +
                  " t_Value, t_CPFirmId, t_Period, t_SettleCode, t_UserId, t_UserExchangeId, " +
                  " t_BrokerRef, t_ExtRef, t_ExchComm, t_ITSComm, t_ClrComm, t_SumComm, t_ClientCode, " +
                  " t_Details, t_SubDetails, t_RepoTradeNo, t_BoardID, t_BoardName, t_BoardNameEn"+
                  " ) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";

      params[params.size] = SQLParam("", FileName);
      params[params.size] = SQLParam("", ReportDate);
      params[params.size] = SQLParam("", FirmId);
      params[params.size] = SQLParam("", FirmName);
      params[params.size] = SQLParam("", FirmNameEn);
      params[params.size] = SQLParam("", ExchangeId);
      params[params.size] = SQLParam("", ClearingFirmId);
      params[params.size] = SQLParam("", ClearingFirmName);
      params[params.size] = SQLParam("", ClearingFirmNameEn);
      params[params.size] = SQLParam("", ExtSettleCode);
      params[params.size] = SQLParam("", AddSession);
      params[params.size] = SQLParam("", SessionName);
      params[params.size] = SQLParam("", SessionNameEn);
      params[params.size] = SQLParam("", CurrencyId);
      params[params.size] = SQLParam("", CurrencyName);
      params[params.size] = SQLParam("", CurrencyNameEn);
      params[params.size] = SQLParam("", CoCurrencyId);
      params[params.size] = SQLParam("", CoCurrencyName);
      params[params.size] = SQLParam("", CoCurrencyNameEn);
      params[params.size] = SQLParam("", SecurityId);
      params[params.size] = SQLParam("", SecShortName);
      params[params.size] = SQLParam("", FaceValue);
      params[params.size] = SQLParam("", SettleDate);
      params[params.size] = SQLParam("", TradeGroup);
      params[params.size] = SQLParam("", MainSecurityId);
      params[params.size] = SQLParam("", MainSecShortName);
      params[params.size] = SQLParam("", TradeNo);
      params[params.size] = SQLParam("", BuySell);
      params[params.size] = SQLParam("", OrderNo);
      params[params.size] = SQLParam("", TradeDeriv);
      params[params.size] = SQLParam("", TradeTime);
      params[params.size] = SQLParam("", TradeType);
      params[params.size] = SQLParam("", Decimals);
      params[params.size] = SQLParam("", Price);
      params[params.size] = SQLParam("", Quantity);
      params[params.size] = SQLParam("", Value);
      params[params.size] = SQLParam("", CPFirmId);
      params[params.size] = SQLParam("", Period);
      params[params.size] = SQLParam("", SettleCode);
      params[params.size] = SQLParam("", UserId);
      params[params.size] = SQLParam("", UserExchangeId);
      params[params.size] = SQLParam("", BrokerRef);
      params[params.size] = SQLParam("", ExtRef);
      params[params.size] = SQLParam("", ExchComm);
      params[params.size] = SQLParam("", ITSComm);
      params[params.size] = SQLParam("", ClrComm);
      params[params.size] = SQLParam("", SumComm);
      params[params.size] = SQLParam("", ClientCode);
      params[params.size] = SQLParam("", Details);
      params[params.size] = SQLParam("", SubDetails);
      params[params.size] = SQLParam("", RepoTradeNo);
      params[params.size] = SQLParam("", BoardId);
      params[params.size] = SQLParam("", BoardName);
      params[params.size] = SQLParam("", BoardNameEn);

      if (execSQL(sqltext, params, false) == NULL)
          return 1;
      end;

      return 0;
  end;
end;

private class CUX33_Data()
  var
      FileName           = "",
      ReportDate         = date(0,0,0),
      FirmId             = "",
      FirmName           = "",
      FirmNameEn         = "",
      ExchangeId         = "",
      ClearingFirmId     = "",
      ClearingFirmName   = "",
      ClearingFirmNameEN = "",
      ExtSettleCode      = "",
      AddSession         = "",
      SessionName        = "",
      SessionNameEn      = "",
      TradeGroup         = "",
      CurrencyId         = "",
      CurrencyName       = "",
      CurrencyNameEn     = "",
      CoCurrencyId       = "",
      CoCurrencyName     = "",
      CoCurrencyNameEn   = "",
      FaceValue          = 0,
      SecurityId         = "",
      SecShortName       = "",
      TradeNo            = 0,
      BuySell            = "",
      OrderNo            = 0,
      TradeTime          = time(),
      TradeType          = "",
      BasePrice          = 0,
      Decimals           = 0,
      Price              = 0,
      Quantity           = 0,
      Value              = 0,
      CPFirmId           = "",
      ClientCode         = "",
      Details            = "",
      SubDetails         = "",
      RepoTradeNo        = 0,
      BoardId            = "",
      BoardName          = "",
      BoardNameEn        = "";

  macro Save()
    var
        params  = TArray(),
        sqlText = "insert into dfx_CUX33_tmp (t_FileName, t_ReportDate, t_FirmId, t_FirmName, t_FirmNameEn, t_ExchangeId, t_ClearingFirmId, t_ClearingFirmName, t_ClearingFirmNameEn, "+ 
                  " t_ExtSettleCode, t_AddSession, t_SessionName, t_SessionNameEn, t_TradeGroup, t_CurrencyId, t_CurrencyName, t_CurrencyNameEn, t_CoCurrencyId, t_CoCurrencyName, t_CoCurrencyNameEn, "+
                  " t_FaceValue, t_SecurityId, t_SecShortName, t_TradeNo, t_BuySell, t_OrderNo, t_TradeTime, t_TradeType, "+
                  " t_BasePrice, t_Decimals, t_Price, t_Quantity, t_Value, t_CPFirmId, t_ClientCode, t_Details, t_SubDetails, t_RepoTradeNo, "+
                  " t_BoardId, t_BoardName, t_BoardNameEn) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";

      params[params.size] = SQLParam("", FileName);
      params[params.size] = SQLParam("", ReportDate);
      params[params.size] = SQLParam("", FirmId);
      params[params.size] = SQLParam("", FirmName);
      params[params.size] = SQLParam("", FirmNameEn);
      params[params.size] = SQLParam("", ExchangeId);
      params[params.size] = SQLParam("", ClearingFirmId);
      params[params.size] = SQLParam("", ClearingFirmName);
      params[params.size] = SQLParam("", ClearingFirmNameEn);
      params[params.size] = SQLParam("", ExtSettleCode);
      params[params.size] = SQLParam("", AddSession);
      params[params.size] = SQLParam("", SessionName);
      params[params.size] = SQLParam("", SessionNameEn);
      params[params.size] = SQLParam("", TradeGroup);
      params[params.size] = SQLParam("", CurrencyId);
      params[params.size] = SQLParam("", CurrencyName);
      params[params.size] = SQLParam("", CurrencyNameEn);
      params[params.size] = SQLParam("", CoCurrencyId);
      params[params.size] = SQLParam("", CoCurrencyName);
      params[params.size] = SQLParam("", CoCurrencyNameEn);
      params[params.size] = SQLParam("", FaceValue);
      params[params.size] = SQLParam("", SecurityId);
      params[params.size] = SQLParam("", SecShortName);
      params[params.size] = SQLParam("", TradeNo);
      params[params.size] = SQLParam("", BuySell);
      params[params.size] = SQLParam("", OrderNo);
      params[params.size] = SQLParam("", TradeTime);
      params[params.size] = SQLParam("", TradeType);
      params[params.size] = SQLParam("", BasePrice);
      params[params.size] = SQLParam("", Decimals);
      params[params.size] = SQLParam("", Price);
      params[params.size] = SQLParam("", Quantity);
      params[params.size] = SQLParam("", Value);
      params[params.size] = SQLParam("", CPFirmId);
      params[params.size] = SQLParam("", ClientCode);
      params[params.size] = SQLParam("", Details);
      params[params.size] = SQLParam("", SubDetails);
      params[params.size] = SQLParam("", RepoTradeNo);
      params[params.size] = SQLParam("", BoardId);
      params[params.size] = SQLParam("", BoardName);
      params[params.size] = SQLParam("", BoardNameEn);

      if (execSQL(sqltext, params, false) == NULL)
          return 1;
      end;

      return 0;
  end;
end;
/////////////////////////////////////////////////////////////////////////////////////
private class TRG_MVBData()// Класс данных вставляемых в шлюз.
  private var // Ведение лога при заполнении данных
      RGLog = NULL;

  private var // Соответствие полей файла и шлюза
      ПолеФайла         = TArray,
      ПолеШлюза         = TArray,
      ТипПоляВШлюзе     = TArray,
      Ф_ияПерекодировки = TArray,
      Значение          = TArray;

  private var // Массив полей шлюза с отложенной перекодировкой
      ОП_ПолеШлюза      = TArray;

  private macro ОтложеннаяПерекодировка(_ПолеШлюза)// Заполнение массива отложенной перекодировки
    var
        idx = 0,
        CntData = ПолеФайла.size;

      while(idx < CntData)
          if(ПолеШлюза[idx] == _ПолеШлюза)
              ОП_ПолеШлюза[ОП_ПолеШлюза.size] = idx;
          end;

          idx = idx + 1;
      end;
  end;

  macro ВыполнитьОтложеннуюПерекодировку() // Выполнение всех отложенных перекодировок
    var
        idx = 0;

      while (idx < ОП_ПолеШлюза.size)
          if (ValType(Ф_ияПерекодировки[ОП_ПолеШлюза[idx]]) != V_UNDEF)
              Значение[ОП_ПолеШлюза[idx]] = CallR2M(Ф_ияПерекодировки[ОП_ПолеШлюза[idx]], Значение[ОП_ПолеШлюза[idx]], ПолеШлюза[ОП_ПолеШлюза[idx]]);
          end;

          idx = idx + 1;
      end;

      ОП_ПолеШлюза.size = 0;
  end;

  macro ЗначениеПоляШлюза(_ПолеШлюза) // Получить значение по полю шлюза
    var
        idx = 0,
        CntData = ПолеФайла.size,
        retVal = NULL;

      while(idx < CntData)
          if(ПолеШлюза[idx] == _ПолеШлюза)
              retVal = Значение[idx];
              idx = CntData;
          end;

          idx = idx + 1;
      end;

      return retVal;
  end;
  
 //Функции перекодировки значений из файла в значения шлюза
  macro GetIDObject(KindObj, Code, GKBO_CodeKind, _ПолеШлюза)
    var
        ObjID = 0,
        ErrMes = "";
      if (Code == "")
          Code = -1;
      elif (not GetRealID(KindObj, Code, GKBO_CodeKind, @ObjID, @ErrMes))
          Code = ObjID;
      else
          if (RGLog)
              RGLog.Message(ErrMes + " (" + _ПолеШлюза + ")");
          end;

          Code = -1;
      end;

      return int(Code);
  end;

  macro Перекодировка_Субъекты(_Значение, _ПолеШлюза)
      return GetIDObject(RG_PARTY, _Значение, 8, _ПолеШлюза);
  end;

  macro Перекодировка_Валюты(_Значение, _ПолеШлюза)
      return GetIDObject(RG_CURRENCY, _Значение, 3, _ПолеШлюза);
  end;

  macro Перекодировка_Swift(_Значение, _ПолеШлюза)
      return GetIDObject(RG_PARTY, _Значение, 6, _ПолеШлюза);
  end;

  macro Перекодировка_Биржа(_Значение, _ПолеШлюза)
      return GetIDObject(RG_PARTY, _Значение, 29, _ПолеШлюза);
  end;


  macro Заполнить(_ПолеФайла, _Значение, _RGLog)// Заполнение полей шлюза данными из файла с перекодировкой значения
    var
        idx = 0,
        CntData = ПолеФайла.size;

      if (_RGLog)
          RGLog = _RGLog;
      end;

      while(idx < CntData)
          if(ПолеФайла[idx] == _ПолеФайла)
              if (ValType(Ф_ияПерекодировки[idx]) != V_UNDEF)
                  _Значение = CallR2M(Ф_ияПерекодировки[idx], _Значение, ПолеШлюза[idx]);
              end;

              if (ТипПоляВШлюзе[idx] != ValType(_Значение))
                  if ((ValType(Значение) != V_TIME)and(ValType(Значение) != V_DATE))
                      _Значение = string(_Значение);
                  end;

                  if(ТипПоляВШлюзе[idx] == V_INTEGER)
                      _Значение = int(_Значение);
                  elif(ТипПоляВШлюзе[idx] == V_DATE)
                      _Значение = date(_Значение);
                  elif(ТипПоляВШлюзе[idx] == V_TIME)
                      _Значение = time(_Значение);
                  elif(ТипПоляВШлюзе[idx] == V_MONEYL)
                      _Значение = money(_Значение);
                  elif(ТипПоляВШлюзе[idx] == V_DOUBLE)
                      _Значение = double(_Значение);
                  end;
              end;

              Значение[idx] = _Значение;
          end;

          idx = idx + 1;
      end;

      RGLog = NULL;
  end;

  macro Перекодировка_Время(_Значение, _ПолеШлюза)
    var
        Dt = NULL, Tm = NULL;

      DtTmSplit(_Значение, Dt, Tm);

      return Tm;
  end;

  macro Перекодировка_Дата(_Значение, _ПолеШлюза)
    var
        Dt = NULL, Tm = NULL;

      DtTmSplit(_Значение, Dt, Tm);

      return Dt;
  end;

  macro Очистить()// Очистить значения полей шлюза
    var
        idx = 0,
        CntData = ПолеФайла.size;

      Значение.size = 0;

      for (idx, 0, CntData, 1)
          Значение[idx] = NULL;
      end;
  end;

  // Добавить новое поле в шлюз
  private macro ДобавитьЗапись(_ПолеФайла, _ПолеШлюза, _ТипПоляВШлюзе, _Ф_ияПерекодировки)
    var
        numItem = ПолеФайла.size;

      ПолеФайла[numItem]         = _ПолеФайла;
      ПолеШлюза[numItem]         = _ПолеШлюза;
      ТипПоляВШлюзе[numItem]     = _ТипПоляВШлюзе;
      Ф_ияПерекодировки[numItem] = _Ф_ияПерекодировки;
      Значение[numItem]          = NULL;
  end;

  // Инициализация полей шлюза
  private macro ClassConstructor()
      ДобавитьЗапись(strupr("PureDealType"),              "RGREU_DealType", V_INTEGER, NULL);                                      /* 569 - Вид сделки */
      ДобавитьЗапись(strupr("TradeNo"),                   "RGREU_501",      V_STRING,  NULL);                                      /* Идентификатор сделки*/
      ДобавитьЗапись(strupr("ReportDate"),                "RGREU_502",      V_DATE,    R2M(this, "Перекодировка_Дата"));           /* Дата, когда началось заключение сделки */
      ДобавитьЗапись(strupr("TradeTime"),                 "RGREU_503",      V_TIME,    R2M(this, "Перекодировка_Время"));          /* Время, когда началось заключение сделки */
      ДобавитьЗапись(strupr("UserId"),                    "RGREU_504",      V_INTEGER, R2M(this, "Перекодировка_Субъекты"));       /* код дилера, заключившего сделку */
      ДобавитьЗапись(strupr("ExchangeId"),                "RGREU_508",      V_INTEGER, R2M(this, "Перекодировка_Биржа"));          /* код контрагента */
      ДобавитьЗапись(strupr("BrokerRef"),                 "RGREU_510",      V_INTEGER, R2M(this, "Перекодировка_Субъекты"));         /* код брокера */
      ДобавитьЗапись(strupr("BuySell"),                   "RGREU_514",      V_STRING,  NULL);                                      /* код типа сделки (1-покупка/2-продажа) */
      ДобавитьЗапись(strupr("CurrencyId"),                "RGREU_517",      V_INTEGER, R2M(this, "Перекодировка_Валюты"));         /* SWIFT-код 1 валюты */
      ДобавитьЗапись(strupr("CoCurrencyId"),              "RGREU_518",      V_INTEGER, R2M(this, "Перекодировка_Валюты"));         /* SWIFT-код 2 валюты */
      ДобавитьЗапись(strupr("Quantity"),                  "RGREU_519",      V_MONEYL,  NULL);                                      /* Объем сделки в первой валюте */
      ДобавитьЗапись(strupr("Price1"),                    "RGREU_522",      V_DOUBLE,  NULL);                                      /* Курс конверсии период 1 */
      ДобавитьЗапись(strupr("Price2"),                    "RGREU_523",      V_DOUBLE,  NULL);                                      /* Курс конверсии период 2 */
      ДобавитьЗапись(strupr("RateDirection"),             "RGREU_524",      V_STRING,  NULL);                                      /* Направление сделки */
      ДобавитьЗапись(strupr("ValueDatePeriod1Currency1"), "RGREU_525",      V_DATE,    R2M(this, "Перекодировка_Дата"));           /* Дата платежа по первой ноге в первой валюте */
      ДобавитьЗапись(strupr("ValueDatePeriod1Currency2"), "RGREU_526",      V_DATE,    R2M(this, "Перекодировка_Дата"));           /* Дата валютирования период 1 валюта 2 */
      ДобавитьЗапись(strupr("ValueDatePeriod2Currency1"), "RGREU_527",      V_DATE,    R2M(this, "Перекодировка_Дата"));           /* Дата платежа по второй ноге в первой валюте */
      ДобавитьЗапись(strupr("ValueDatePeriod2Currency2"), "RGREU_528",      V_DATE,    R2M(this, "Перекодировка_Дата"));           /* Дата валютирования период 2 валюта 2 */
      ДобавитьЗапись(strupr("PaymentInstructionP1C1"),    "RGREU_529",      V_STRING,  NULL);                                      /* Платежная инструкция в свободном формате по первой ноге в первой валюте */
      ДобавитьЗапись(strupr("PaymentInstructionP1C2"),    "RGREU_530",      V_STRING,  NULL);                                      /* ПИ период 1 валюта 2 */
      ДобавитьЗапись(strupr("PaymentInstructionP1C1"),    "RGREU_531",      V_STRING,  NULL);                                      /* Платежная инструкция в свободном формате по второй ноге в первой валюте */
      ДобавитьЗапись(strupr("PaymentInstructionP2C2"),    "RGREU_532",      V_STRING,  NULL);                                      /* ПИ период 2 валюта 2 */
      ДобавитьЗапись(strupr("CommentText"),               "RGREU_553",      V_STRING,  NULL);                                      /* Комментарий */
      ДобавитьЗапись(strupr("SWIFTBICC1P1"),              "RGREU_575",      V_INTEGER, NULL); // R2M(this, "Перекодировка_Swift"));          /* Swift-код банка получателя период 1 валюта 1 */
      ДобавитьЗапись(strupr("SWIFTBICC2P1"),              "RGREU_576",      V_INTEGER, NULL); // R2M(this, "Перекодировка_Swift"));          /* Swift-код банка получателя период 1 валюта 2 */
      ДобавитьЗапись(strupr("SWIFTBICC1P2"),              "RGREU_577",      V_INTEGER, NULL); // R2M(this, "Перекодировка_Swift"));          /* Swift-код банка получателя период 2 валюта 1 */
      ДобавитьЗапись(strupr("SWIFTBICC2P2"),              "RGREU_578",      V_INTEGER, NULL); // R2M(this, "Перекодировка_Swift"));          /* Swift-код банка получателя период 2 валюта 2 */
      ДобавитьЗапись(strupr("Points"),                    "RGFX_Points",    V_STRING,  NULL);                                      /* Количество знаков в курсе */
  end;

 ClassConstructor();//Вызов конструктора
end;

///////////////////////////////////////////////////////////////////////////////////
private class (TRsbPanel)RG_MVBImport(_SeanceID)
  private var
      prm_SeanceID;

  private var
      prm_InputDir,
      prm_DoneDir,
      prm_ErrDir;

  private var
      RGLog,
      RG,
      RG_Data;

  private var
      RG_ObjectKind,
      RG_ObjectName;

  private var
      TrnMes;

  private var
      ImportDate     = NULL,
      VB             = NULL,
      AllDeals       = NULL,
      AnaliticsDeals = NULL;

  macro eventHandler(EV)
    var
        day = 0, month = 0, year = 0;

      if (EV.keyCode == 316)
          prm_DoneDir  = prm_InputDir + "Done\\";
          prm_ErrDir   = prm_InputDir + "Err\\";

          if (ImportDate.Value > {curdate})
              msgbox("Дата импорта больше текущего операционного дня");
              EV.keyCode = 0;
          elif (VB.currentChoice == 0)
              msgbox("Задайте биржу");
              EV.keyCode = 0;
          elif ((not AllDeals.Checked) and (not AnaliticsDeals.Checked))
              msgbox("Для загрузки необходимо наличие одного \nиз признаков 'Все сделки' или 'Сделки аналитического учета'");
              EV.keyCode = 0;
          elif (not ExistFile(prm_InputDir))
              msgbox("Неверно задан каталог входных данных.");
          else
              MakeDir(prm_DoneDir);
              MakeDir(prm_ErrDir);
              DateSplit(ImportDate.Value, day, month, year);
              prm_DoneDir  = prm_DoneDir + String(day) + String(month) + substr(String(year), 3, 2) + "\\";
              prm_ErrDir   = prm_ErrDir + String(day) + String(month) + substr(String(year), 3, 2) + "\\";

              if ((not ExistFile(prm_DoneDir))and(not MakeDir(prm_DoneDir)))
                 msgbox("Ошибка создания каталога:|" + prm_DoneDir);
              elif ((not ExistFile(prm_ErrDir))and(not MakeDir(prm_ErrDir)))
                 msgbox("Ошибка создания каталога:|" + prm_ErrDir);
              else
                  close(-EV.keyCode);
              end;
          end;
      end;
  end;

  private macro ClassConstructor(SeanceID)
      prm_SeanceID = SeanceID;

      prm_InputDir = "";
      prm_DoneDir  = "";
      prm_ErrDir   = "";

      RGLog   = NULL;
      RG      = NULL;
      RG_Data = TRG_MVBData();

      RG_ObjectKind = NULL;
      RG_ObjectName = "";

      TrnMes = NULL;

      caption = "Произвести импорт";
      setPosition(10, 5);
      setSize(34, 8);
      status = "~SPACE~ Установить/снять признак ~F3~ Выбрать ~F2~ Импорт  ~Esc~ Выход";
      
      addLabel(TRsbLabel(2, 2, "Дата импорта"));
      addLabel(TRsbLabel(2, 3, "Биржа"));
      addLabel(TRsbLabel(5, 5, "Все сделки"));
      addLabel(TRsbLabel(5, 6, "Сделки аналитического учета"));

      ImportDate = TRsbEditField;
      ImportDate.name       = "ImDate";
      ImportDate.dataType   = 9;
      ImportDate.textLength = 10;
      ImportDate.setPosition(14, 2);
      ImportDate.setSize    (10, 1);
      ImportDate.Editable  = true;
      ImportDate.Value     = {curdate};

      VB = TRsbComboBox;
      VB.name       = "VB";
      VB.dataType   = 7;
      VB.textLength = 10;
      VB.setPosition(14, 3);
      VB.setSize    (14, 1);
      VB.addChoice(1, "ЗАО ММВБ");

      AllDeals = TRsbCheckBox;
      AllDeals.name       = "AllDeals";
      AllDeals.dataType   = 12;
      AllDeals.setPosition(2, 5);
      AllDeals.Checked = "X";

      AnaliticsDeals = TRsbCheckBox;
      AnaliticsDeals.name       = "AnDeals";
      AnaliticsDeals.dataType   = 12;
      AnaliticsDeals.setPosition(2, 6);
      AnaliticsDeals.Checked = "X";

      addControl(ImportDate);
      addControl(VB);
      addControl(AllDeals);
      addControl(AnaliticsDeals);

      addEventHandler(RSB_EV_KEY_PRESSED, r2m(this, "eventHandler"));
  end;

  private macro ВставитьВШлюз_Транзакция()
      RG = TgtRecord(1, prm_SeanceID, NULL, RG_ObjectKind, RG_ObjectName, Создать, "", 2);

      if (not RG.InitByCode(NULL, RG_ObjectName, "SRC-16", ""))
          TrnMes = "Ошибка инициализации\n";
          AbortTrn();
      end;

      /* 569 */
      if (not RG.SetParmByName("RGREU_DealType", RG_Data.ЗначениеПоляШлюза("RGREU_DealType")))
      TrnMes = "Ошибка установки параметра RGREU_DealType\n"; AbortTrn();end;

      /* 501 */
      if (not RG.SetParmByName("RGREU_501", RG_Data.ЗначениеПоляШлюза("RGREU_501")))
      TrnMes = "Ошибка установки параметра RGREU_501\n"; AbortTrn();end;

      /* 502 */
      if (not RG.SetParmByName("RGREU_502", RG_Data.ЗначениеПоляШлюза("RGREU_502")))
          TrnMes = "Ошибка установки параметра RGREU_502\n"; AbortTrn();end;

      /* 503 */
      if (not RG.SetParmByName("RGREU_503", RG_Data.ЗначениеПоляШлюза("RGREU_503")))
          TrnMes = "Ошибка установки параметра RGREU_503\n"; AbortTrn();end;

      /* 504 */
      if (not RG.SetParmByName("RGREU_504", RG_Data.ЗначениеПоляШлюза("RGREU_504")))
          TrnMes = "Ошибка установки параметра RGREU_504\n"; AbortTrn();end;

      /* 508 */
      if (not RG.SetParmByName("RGREU_508", RG_Data.ЗначениеПоляШлюза("RGREU_508")))
          TrnMes = "Ошибка установки параметра RGREU_508\n"; AbortTrn();end;

      /* 510 */
      if (not RG.SetParmByName("RGREU_510", RG_Data.ЗначениеПоляШлюза("RGREU_510")))
          TrnMes = "Ошибка установки параметра RGREU_510\n"; AbortTrn();end;

      /* 514 */
      if (not RG.SetParmByName("RGREU_514", RG_Data.ЗначениеПоляШлюза("RGREU_514")))
          TrnMes = "Ошибка установки параметра RGREU_514\n"; AbortTrn();end;

      /* 517 */
      if (not RG.SetParmByName("RGREU_517", RG_Data.ЗначениеПоляШлюза("RGREU_517")))
          TrnMes = "Ошибка установки параметра RGREU_517\n"; AbortTrn();end;

      /* 518 */
      if (not RG.SetParmByName("RGREU_518", RG_Data.ЗначениеПоляШлюза("RGREU_518")))
          TrnMes = "Ошибка установки параметра RGREU_518\n"; AbortTrn();end;

      /* 519 */
      if (not RG.SetParmByName("RGREU_519", RG_Data.ЗначениеПоляШлюза("RGREU_519")))
          TrnMes = "Ошибка установки параметра RGREU_519\n"; AbortTrn();end;

      /* 522 */
      if (not RG.SetParmByName("RGREU_522", RG_Data.ЗначениеПоляШлюза("RGREU_522")))
          TrnMes = "Ошибка установки параметра RGREU_522\n"; AbortTrn();end;

      /* 523 */
      if (not RG.SetParmByName("RGREU_523", RG_Data.ЗначениеПоляШлюза("RGREU_523")))
          TrnMes = "Ошибка установки параметра RGREU_523\n"; AbortTrn();end;

      /* 524 */
      if (not RG.SetParmByName("RGREU_524", RG_Data.ЗначениеПоляШлюза("RGREU_524")))
          TrnMes = "Ошибка установки параметра RGREU_524\n"; AbortTrn();end;

      /* 525 */
      if (not RG.SetParmByName("RGREU_525", RG_Data.ЗначениеПоляШлюза("RGREU_525")))
          TrnMes = "Ошибка установки параметра RGREU_525\n"; AbortTrn();end;

      /* 526 */
      if (not RG.SetParmByName("RGREU_526", RG_Data.ЗначениеПоляШлюза("RGREU_526")))
          TrnMes = "Ошибка установки параметра RGREU_526\n"; AbortTrn();end;

      /* 527 */
      if (not RG.SetParmByName("RGREU_527", RG_Data.ЗначениеПоляШлюза("RGREU_527")))
          TrnMes = "Ошибка установки параметра RGREU_527\n"; AbortTrn();end;

      /* 528 */
      if (not RG.SetParmByName("RGREU_528", RG_Data.ЗначениеПоляШлюза("RGREU_528")))
          TrnMes = "Ошибка установки параметра RGREU_528\n"; AbortTrn();end;

      /* 529 */
      if (not RG.SetParmByName("RGREU_529", RG_Data.ЗначениеПоляШлюза("RGREU_529")))
          TrnMes = "Ошибка установки параметра RGREU_529\n"; AbortTrn();end;

      /* 530 */
      if (not RG.SetParmByName("RGREU_530", RG_Data.ЗначениеПоляШлюза("RGREU_530")))
          TrnMes = "Ошибка установки параметра RGREU_530\n"; AbortTrn();end;

      /* 531 */
      if (not RG.SetParmByName("RGREU_531", RG_Data.ЗначениеПоляШлюза("RGREU_531")))
          TrnMes = "Ошибка установки параметра RGREU_531\n"; AbortTrn();end;

      /* 532 */
      if (not RG.SetParmByName("RGREU_532", RG_Data.ЗначениеПоляШлюза("RGREU_532")))
          TrnMes = "Ошибка установки параметра RGREU_532\n"; AbortTrn();end;

      /* 553*/
      if (not RG.SetParmByName("RGREU_553", RG_Data.ЗначениеПоляШлюза("RGREU_553")))
          TrnMes = "Ошибка установки параметра RGREU_553\n"; AbortTrn();end;

      /* 575 */
      if (not RG.SetParmByName("RGREU_575", RG_Data.ЗначениеПоляШлюза("RGREU_575")))
          TrnMes = "Ошибка установки параметра RGREU_575\n"; AbortTrn();end;

      /* 576 */
      if (not RG.SetParmByName("RGREU_576", RG_Data.ЗначениеПоляШлюза("RGREU_576")))
          TrnMes = "Ошибка установки параметра RGREU_576\n"; AbortTrn();end;

      /* 577 */
      if (not RG.SetParmByName("RGREU_577", RG_Data.ЗначениеПоляШлюза("RGREU_577")))
          TrnMes = "Ошибка установки параметра RGREU_577\n"; AbortTrn();end;

      /* 578 */
      if (not RG.SetParmByName("RGREU_578", RG_Data.ЗначениеПоляШлюза("RGREU_578")))
          TrnMes = "Ошибка установки параметра RGREU_578\n"; AbortTrn();end;

      if (not RG.SetParmByName("RGFX_Points", RG_Data.ЗначениеПоляШлюза("RGFX_Points")))
          TrnMes = "Ошибка установки параметра RGFX_Points\n"; AbortTrn();end;             
          
      return true;
  end;

  private macro ВставитьВШлюз()
    macro Local_ВставитьВШлюз_Транзакция()
        TrnMes = NULL;
        return ВставитьВШлюз_Транзакция();
    end;

    var
        DealCTS  = RG_Data.ЗначениеПоляШлюза("RGREU_501");

      RG_ObjectKind = RG_FOREX;
      RG_ObjectName = "Сделки КО ("+ DealCTS +")";

      return ProcessTrn(0, "Local_ВставитьВШлюз_Транзакция")
  end;

  private macro LoadXML(FileName, ErrMes:@STRING)
    var
        xml:object  = ActiveX("MSXML.DOMDocument"),
        node:object = NULL,
        child_MicexDoc:object = NULL, child_CUX33:object      = NULL, child_ClearPart:object      = NULL,
        child_Settle:object   = NULL, child_Session:object    = NULL, 
        child_Group:object    = NULL, child_CurPair:object    = NULL,
        child_Security:object = NULL, child_CUX23:object      = NULL,
        child_MainSec:object  = NULL, child_SettleDate:object = NULL,
        idxnode      = 0, idxCUX33      = 0, idxClearPart = 0,
        idxSettle    = 0, idxSession    = 0, 
        idxGroup     = 0, idxCurPair    = 0,
        idxSecurity  = 0, idxCUX23      = 0,
        idxMainSec   = 0, idxSettleDate = 0,
        DOC_REQUISITES = false, CUX23 = false, CUX33 = false,
        CUX23Data = NULL,
        CUX33Data = NULL;

      /* откроем файл импорта */
      if (not xml.load(prm_InputDir + FileName))
          ErrMes = string("Неверный формат файла импорта|", FileName, "|Невозможно загрузить xml-документ");
          return 1;
      end;
      node = xml.DocumentElement;

      /* бегаем по MICEX_DOC */
      idxnode = 0;
      while (idxnode < node.childNodes.length) 
          child_MicexDoc = node.childNodes.item(idxnode);
          if (child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE))
              if (child_MicexDoc.tagname == "DOC_REQUISITES")
                 if (DOC_REQUISITES)
                    ErrMes = string(FileName, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре");
                    return 1;
                 end;
                 DOC_REQUISITES = true;
              elif (child_MicexDoc.tagname == "CUX23")
                  if (CUX23)
                     ErrMes = string(FileName, ": Блок MICEX_DOC\CUX23 должен присутствовать в единственном экземпляре");
                     return 1;
                  end;
                  CUX23 = true;
                  CUX23Data = CUX23_Data();
                  CUX23Data.FileName = FileName;
                  ReadTagAttribut(child_MicexDoc, StrUpr("ReportDate"),   V_DATE,   CUX23Data.ReportDate);
                  ReadTagAttribut(child_MicexDoc, StrUpr("FirmId"),       V_STRING, CUX23Data.FirmId);
                  ReadTagAttribut(child_MicexDoc, StrUpr("FirmName"),     V_STRING, CUX23Data.FirmName);
                  ReadTagAttribut(child_MicexDoc, StrUpr("FirmNameEn"),     V_STRING, CUX23Data.FirmNameEn);
                  CUX23Data.ExchangeId = "XMIC";
                  idxCUX23 = 0;
                  while (idxCUX23 < child_MicexDoc.childNodes.length)
                      child_CUX23 = child_MicexDoc.childNodes.item(idxCUX23);
                      if ((child_CUX23 and (child_CUX23.nodeType == CHILD_NODE))and(child_CUX23.tagname == "CLEARPART"))
                          ReadTagAttribut(child_CUX23, StrUpr("ClearingFirmId"),      V_STRING,   CUX23Data.ClearingFirmId);
                          ReadTagAttribut(child_CUX23, StrUpr("ClearingFirmName"),    V_STRING,   CUX23Data.ClearingFirmName);
                          ReadTagAttribut(child_CUX23, StrUpr("ClearingFirmNameEN"),  V_STRING,   CUX23Data.ClearingFirmNameEN);
                          idxClearPart = 0;
                          while (idxClearPart < child_CUX23.childNodes.length)
                               child_ClearPart = child_CUX23.childNodes.item(idxClearPart);				  
                               if ((child_ClearPart and (child_ClearPart.nodeType == CHILD_NODE))and(child_ClearPart.tagname == "SETTLE"))
                                   ReadTagAttribut(child_ClearPart, StrUpr("ExtSettleCode"),   V_STRING,   CUX23Data.ExtSettleCode);
                                   idxSettle = 0;
                                   while (idxSettle < child_ClearPart.childNodes.length)
                                       child_Settle = child_ClearPart.childNodes.item(idxSettle);
                                       if ((child_Settle and (child_Settle.nodeType == CHILD_NODE))and(child_Settle.tagname == "SESSION"))
                                           ReadTagAttribut(child_Settle, StrUpr("AddSession"),     V_STRING,   CUX23Data.AddSession);
                                           ReadTagAttribut(child_Settle, StrUpr("SessionName"),    V_STRING,   CUX23Data.SessionName);
                                           ReadTagAttribut(child_Settle, StrUpr("SessionNameEn"),  V_STRING,   CUX23Data.SessionNameEn);
                                           idxSession = 0;
                                           while (idxSession < child_Settle.childNodes.length)
                                               child_Session = child_Settle.childNodes.item(idxSession);
                                               if ((child_Session and (child_Session.nodeType == CHILD_NODE))and(child_Session.tagname == "CURRPAIR"))
                                                   ReadTagAttribut(child_Session, StrUpr("CurrencyId"),       V_STRING,   CUX23Data.CurrencyId);
                                                   ReadTagAttribut(child_Session, StrUpr("CurrencyName"),     V_STRING,   CUX23Data.CurrencyName);
                                                   ReadTagAttribut(child_Session, StrUpr("CurrencyNameEn"),   V_STRING,   CUX23Data.CurrencyNameEn);
                                                   ReadTagAttribut(child_Session, StrUpr("CoCurrencyId"),     V_STRING,   CUX23Data.CoCurrencyId);
                                                   ReadTagAttribut(child_Session, StrUpr("CoCurrencyName"),   V_STRING,   CUX23Data.CoCurrencyName);
                                                   ReadTagAttribut(child_Session, StrUpr("CoCurrencyNameEn"), V_STRING,   CUX23Data.CoCurrencyNameEn);
                                                   idxCurPair = 0;
                                                   while (idxCurPair < child_Session.childNodes.length)
                                                       child_CurPair = child_Session.childNodes.item(idxCurPair);
                                                       if ((child_CurPair and (child_CurPair.nodeType == CHILD_NODE))and(child_CurPair.tagname == "SECURITY"))
                                                           ReadTagAttribut(child_CurPair, StrUpr("SecurityId"),   V_STRING,   CUX23Data.SecurityId);
                                                           ReadTagAttribut(child_CurPair, StrUpr("SecShortName"), V_STRING,   CUX23Data.SecShortName);
                                                           ReadTagAttribut(child_CurPair, StrUpr("FaceValue"),    V_DOUBLE,   CUX23Data.FaceValue);
                                                           idxSecurity = 0;
                                                           while (idxSecurity < child_CurPair.childNodes.length)
                                                               child_Security = child_CurPair.childNodes.item(idxSecurity);
                                                               if ((child_Security and (child_Security.nodeType == CHILD_NODE))and(child_Security.tagname == "SETTLEDATE"))
                                                                   ReadTagAttribut(child_Security, StrUpr("SettleDate"),   V_DATE,   CUX23Data.SettleDate);
                                                                   idxSettleDate = 0;
                                                                   while (idxSettleDate < child_Security.childNodes.length)
                                                                       child_SettleDate = child_Security.childNodes.item(idxSettleDate);
                                                                       if ((child_SettleDate and (child_SettleDate.nodeType == CHILD_NODE))and(child_SettleDate.tagname == "GROUP"))
                                                                           ReadTagAttribut(child_SettleDate, StrUpr("TradeGroup"),   V_STRING,   CUX23Data.TradeGroup);
                                                                           if (CUX23Data.TradeGroup == "B") idxSettleDate = idxSettleDate+1; continue; end;
                 
                                                                           idxGroup = 0;
                                                                           while (idxGroup < child_SettleDate.childNodes.length)
                                                                               child_Group = child_SettleDate.childNodes.item(idxGroup);
                                                                               if ((child_Group and (child_Group.nodeType == CHILD_NODE))and(child_Group.tagname == "MAINSEC"))
                                                                                   ReadTagAttribut(child_Group, StrUpr("MainSecurityId"),   V_STRING,   CUX23Data.MainSecurityId);
                                                                                   ReadTagAttribut(child_Group, StrUpr("MainSecShortName"), V_STRING,   CUX23Data.MainSecShortName);
                 
                                                                                   idxMainSec = 0;
                                                                                   while (idxMainSec < child_Group.childNodes.length)
                                                                                       child_MainSec = child_Group.childNodes.item(idxMainSec);
                                                                                       if ((child_MainSec and (child_MainSec.nodeType == CHILD_NODE))and(child_MainSec.tagname == "RECORDS"))
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("TradeNo"),        V_INTEGER,  CUX23Data.TradeNo);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("BuySell"),        V_STRING,   CUX23Data.BuySell);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("OrderNo"),        V_INTEGER,  CUX23Data.OrderNo);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("TradeDeriv"),     V_STRING,   CUX23Data.TradeDeriv);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("TradeTime"),      V_TIME,     CUX23Data.TradeTime);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("TradeType"),      V_STRING,   CUX23Data.TradeType);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("Decimals"),       V_INTEGER,  CUX23Data.Decimals);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("Price"),          V_DOUBLE,   CUX23Data.Price);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("Quantity"),       V_INTEGER,  CUX23Data.Quantity);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("Value"),          V_MONEY,    CUX23Data.Value);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("CPFirmId"),       V_STRING,   CUX23Data.CPFirmId);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("Period"),         V_STRING,   CUX23Data.Period);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("SettleCode"),     V_STRING,   CUX23Data.SettleCode);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("UserId"),         V_STRING,   CUX23Data.UserId);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("UserExchangeId"), V_STRING,   CUX23Data.UserExchangeId);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("BrokerRef"),      V_STRING,   CUX23Data.BrokerRef);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("ExtRef"),         V_STRING,   CUX23Data.ExtRef);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("ExchComm"),       V_MONEY,    CUX23Data.ExchComm);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("ITSComm"),        V_MONEY,    CUX23Data.ITSComm);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("ClrComm"),        V_MONEY,    CUX23Data.ClrComm);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("SumComm"),        V_MONEY,    CUX23Data.SumComm);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("ClientCode"),     V_STRING,   CUX23Data.ClientCode);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("Details"),        V_STRING,   CUX23Data.Details);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("SubDetails"),     V_STRING,   CUX23Data.SubDetails);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("RepoTradeNo"),    V_INTEGER,  CUX23Data.RepoTradeNo);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("BoardId"),        V_STRING,   CUX23Data.BoardId);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("BoardName"),      V_STRING,   CUX23Data.BoardName);
                                                                                           ReadTagAttribut(child_MainSec, StrUpr("BoardNameEn"),    V_STRING,   CUX23Data.BoardNameEn);
         				
                                                                                           if (CUX23Data.Save())
                                                                                               ErrMes = string(FileName, ": Ошибка при импорте файла");
                                                                                               return 1;
                                                                                           end;
                                                                                       end;
                                                                                       idxMainSec = idxMainSec + 1;
                                                                                   end;
                                                                               end;
                                                                               idxGroup = idxGroup + 1;
                                                                           end;
                                                                       end;
                                                                       idxSettleDate = idxSettleDate + 1;
                                                                   end;
                                                               end;
                                                               idxSecurity = idxSecurity + 1;
                                                           end;
                                                       end;
                                                       idxCurPair = idxCurPair + 1;
                                                   end;
                                               end;
                                               idxSession = idxSession + 1;
                                           end;
                                       end;
                                       idxSettle = idxSettle + 1;
                                   end;
							   end;
                              idxClearPart = idxClearPart + 1;
                          end;
                      end;
                      idxCUX23 = idxCUX23 + 1;
                  end;
              elif (child_MicexDoc.tagname == "CUX33")
                  if (CUX33)
                     ErrMes = string(FileName, ": Блок MICEX_DOC\CUX33 должен присутствовать в единственном экземпляре");
                     return 1;
                  end;
                  CUX33 = true;

                  CUX33Data = CUX33_Data();
                  CUX33Data.FileName = FileName;
                  ReadTagAttribut(child_MicexDoc, StrUpr("ReportDate"),   V_DATE,   CUX33Data.ReportDate);
                  ReadTagAttribut(child_MicexDoc, StrUpr("FirmId"),       V_STRING, CUX33Data.FirmId);
                  ReadTagAttribut(child_MicexDoc, StrUpr("FirmName"),     V_STRING, CUX33Data.FirmName);
                  ReadTagAttribut(child_MicexDoc, StrUpr("FirmNameEn"),   V_STRING, CUX33Data.FirmNameEn);
                  CUX33Data.ExchangeId = "XMIC";
                  idxCUX33 = 0;
                  while (idxCUX33 < child_MicexDoc.childNodes.length)
                      child_CUX33 = child_MicexDoc.childNodes.item(idxCUX33);
                      if ((child_CUX33 and (child_CUX33.nodeType == CHILD_NODE))and(child_CUX33.tagname == "CLEARPART"))
                          ReadTagAttribut(child_CUX33, StrUpr("ClearingFirmId"),      V_STRING,   CUX33Data.ClearingFirmId);
                          ReadTagAttribut(child_CUX33, StrUpr("ClearingFirmName"),    V_STRING,   CUX33Data.ClearingFirmName);
                          ReadTagAttribut(child_CUX33, StrUpr("ClearingFirmNameEN"),  V_STRING,   CUX33Data.ClearingFirmNameEN);
                          idxClearPart = 0;
                          while (idxClearPart < child_CUX33.childNodes.length)
                              child_ClearPart = child_CUX33.childNodes.item(idxClearPart);				  
                              if ((child_ClearPart and (child_ClearPart.nodeType == CHILD_NODE))and(child_ClearPart.tagname == "SETTLE"))
                                  ReadTagAttribut(child_ClearPart, StrUpr("ExtSettleCode"),   V_STRING,   CUX33Data.ExtSettleCode);
                                  idxSettle = 0;
                                  while (idxSettle < child_ClearPart.childNodes.length)
                                      child_Settle = child_ClearPart.childNodes.item(idxSettle);
                                      if ((child_Settle and (child_Settle.nodeType == CHILD_NODE))and(child_Settle.tagname == "SESSION"))
                                          ReadTagAttribut(child_Settle, StrUpr("AddSession"),     V_STRING,   CUX33Data.AddSession);
                                          ReadTagAttribut(child_Settle, StrUpr("SessionName"),    V_STRING,   CUX33Data.SessionName);
                                          ReadTagAttribut(child_Settle, StrUpr("SessionNameEn"),  V_STRING,   CUX33Data.SessionNameEn);
                                          idxSession = 0;
                                          while (idxSession < child_Settle.childNodes.length)
                                              child_Session = child_Settle.childNodes.item(idxSession);
                                              if ((child_Session and (child_Session.nodeType == CHILD_NODE))and(child_Session.tagname == "GROUP"))
                                                  ReadTagAttribut(child_Session, StrUpr("TradeGroup"),   V_STRING,   CUX33Data.TradeGroup);
                                                  idxGroup = 0;
                                                  while (idxGroup < child_Session.childNodes.length)
                                                      child_Group = child_Session.childNodes.item(idxGroup);
                                                      if ((child_Group and (child_Group.nodeType == CHILD_NODE))and(child_Group.tagname == "CURRPAIR"))
                                                          ReadTagAttribut(child_Group, StrUpr("CurrencyId"),       V_STRING,   CUX33Data.CurrencyId);
                                                          ReadTagAttribut(child_Group, StrUpr("CurrencyName"),     V_STRING,   CUX33Data.CurrencyName);
                                                          ReadTagAttribut(child_Group, StrUpr("CurrencyNameEn"),   V_STRING,   CUX33Data.CurrencyName);
                                                          ReadTagAttribut(child_Group, StrUpr("CoCurrencyId"),     V_STRING,   CUX33Data.CoCurrencyId);
                                                          ReadTagAttribut(child_Group, StrUpr("CoCurrencyName"),   V_STRING,   CUX33Data.CoCurrencyName);
                                                          ReadTagAttribut(child_Group, StrUpr("CoCurrencyNameEn"), V_STRING,   CUX33Data.CoCurrencyName);
                                                          ReadTagAttribut(child_Group, StrUpr("FaceValue"),        V_DOUBLE,   CUX33Data.FaceValue);
                                                          idxCurPair = 0;
                                                          while (idxCurPair < child_Group.childNodes.length)
                                                              child_CurPair = child_Group.childNodes.item(idxCurPair);
                                                              if ((child_CurPair and (child_CurPair.nodeType == CHILD_NODE))and(child_CurPair.tagname == "SECURITY"))
                                                                  ReadTagAttribut(child_CurPair, StrUpr("SecurityId"),     V_STRING,   CUX33Data.SecurityId);
                                                                  ReadTagAttribut(child_CurPair, StrUpr("SecShortName"),   V_STRING,   CUX33Data.SecShortName);
                                                                  idxSecurity = 0;
                                                                  while (idxSecurity < child_CurPair.childNodes.length)
                                                                      child_Security = child_CurPair.childNodes.item(idxSecurity);
                                                                      if ((child_Security and (child_Security.nodeType == CHILD_NODE))and(child_Security.tagname == "RECORDS"))
                                                                          ReadTagAttribut(child_Security, StrUpr("TradeNo"),     V_INTEGER,  CUX33Data.TradeNo);
                                                                          ReadTagAttribut(child_Security, StrUpr("BuySell"),     V_STRING,   CUX33Data.BuySell);
                                                                          ReadTagAttribut(child_Security, StrUpr("OrderNo"),     V_INTEGER,  CUX33Data.OrderNo);
                                                                          ReadTagAttribut(child_Security, StrUpr("TradeTime"),   V_TIME,     CUX33Data.TradeTime);
                                                                          ReadTagAttribut(child_Security, StrUpr("TradeType"),   V_STRING,   CUX33Data.TradeType);
                                                                          ReadTagAttribut(child_Security, StrUpr("BasePrice"),   V_DOUBLE,   CUX33Data.BasePrice);
                                                                          ReadTagAttribut(child_Security, StrUpr("Decimals"),    V_INTEGER,  CUX33Data.Decimals);
                                                                          ReadTagAttribut(child_Security, StrUpr("Price"),       V_DOUBLE,   CUX33Data.Price);
                                                                          ReadTagAttribut(child_Security, StrUpr("Quantity"),    V_INTEGER,  CUX33Data.Quantity);
                                                                          ReadTagAttribut(child_Security, StrUpr("Value"),       V_MONEY,    CUX33Data.Value);
                                                                          ReadTagAttribut(child_Security, StrUpr("CPFirmId"),    V_STRING,   CUX33Data.CPFirmId);
                                                                          ReadTagAttribut(child_Security, StrUpr("ClientCode"),  V_STRING,   CUX33Data.ClientCode);
                                                                          ReadTagAttribut(child_Security, StrUpr("Details"),     V_STRING,   CUX33Data.Details);
                                                                          ReadTagAttribut(child_Security, StrUpr("SubDetails"),  V_STRING,   CUX33Data.SubDetails);
                                                                          ReadTagAttribut(child_Security, StrUpr("RepoTradeNo"), V_INTEGER,  CUX33Data.RepoTradeNo);
                                                                          ReadTagAttribut(child_Security, StrUpr("BoardId"),     V_STRING,   CUX33Data.BoardId);
                                                                          ReadTagAttribut(child_Security, StrUpr("BoardName"),   V_STRING,   CUX33Data.BoardName);
                                                                          ReadTagAttribut(child_Security, StrUpr("BoardNameEn"), V_STRING,   CUX33Data.BoardNameEn);
        
                                                                          if (CUX33Data.Save())
                                                                              ErrMes = string(FileName, ": Ошибка при импорте файла");
                                                                              return 1;
                                                                          end;
                                                                      end;
                                                                      idxSecurity = idxSecurity + 1;
                                                                  end;
                                                              end;
                                                              idxCurPair = idxCurPair + 1;
                                                          end;
                                                      end;
                                                      idxGroup = idxGroup + 1;
                                                  end;
                                              end;
                                              idxSession = idxSession + 1;
                                          end;
                                      end;
                                      idxSettle = idxSettle + 1;
                                  end;
                              end;
                              idxClearPart = idxClearPart + 1;
                          end;
                      end;
                      idxCUX33 = idxCUX33 + 1;
                  end;
              end;
          end;

          idxnode = idxnode + 1;
      end;

      return 0;
  end;

  private macro FillCUX33_from_CUX23(obj_, _CUX23)
      obj_.FileName           = "";
      obj_.ReportDate         = _CUX23.ReportDate;
      obj_.FirmId             = _CUX23.FirmId;
      obj_.FirmName           = _CUX23.FirmName;
      obj_.FirmNameEn         = _CUX23.FirmNameEn;
      obj_.ExchangeId         = _CUX23.ExchangeId;
      obj_.ClearingFirmId     = _CUX23.ClearingFirmId;
      obj_.ClearingFirmName   = _CUX23.ClearingFirmName;
      obj_.ClearingFirmNameEN = _CUX23.ClearingFirmNameEN;
      obj_.ExtSettleCode      = _CUX23.ExtSettleCode;
      obj_.AddSession         = _CUX23.AddSession;
      obj_.SessionName        = _CUX23.SessionName;
      obj_.SessionNameEn      = _CUX23.SessionNameEn;
      obj_.TradeGroup         = _CUX23.TradeGroup;
      obj_.CurrencyId         = _CUX23.CurrencyId;
      obj_.CurrencyName       = _CUX23.CurrencyName;
      obj_.CurrencyNameEn     = _CUX23.CurrencyNameEn;
      obj_.CoCurrencyId       = _CUX23.CoCurrencyId;
      obj_.CoCurrencyName     = _CUX23.CoCurrencyName;
      obj_.CoCurrencyNameEn   = _CUX23.CoCurrencyNameEn;
      obj_.FaceValue          = _CUX23.FaceValue;
      obj_.SecurityId         = _CUX23.MainSecurityId;
      obj_.SecShortName       = _CUX23.SecShortName;
      obj_.TradeNo            = _CUX23.RepoTradeNo;
      obj_.BuySell            = _CUX23.BuySell;
      obj_.OrderNo            = _CUX23.OrderNo;
      obj_.TradeTime          = _CUX23.TradeTime;
      obj_.TradeType          = _CUX23.TradeType;
      obj_.BasePrice          = 0; // ??????
      obj_.Decimals           = _CUX23.Decimals;
      obj_.Price              = _CUX23.Price;
      obj_.Quantity           = _CUX23.Quantity;
      obj_.Value              = _CUX23.Value;
      obj_.CPFirmId           = _CUX23.CPFirmId;
      obj_.ClientCode         = _CUX23.ClientCode;
      obj_.Details            = _CUX23.Details;
      obj_.SubDetails         = _CUX23.SubDetails;
      obj_.RepoTradeNo        = _CUX23.RepoTradeNo;
      obj_.BoardId            = _CUX23.BoardId;
      obj_.BoardName          = _CUX23.BoardName;
      obj_.BoardNameEn        = _CUX23.BoardNameEn;
  end;

  private macro LoadDeals()
    var
        ds        = NULL,
        cmd       = "",
        dsDeal    = NULL,
        cmdDeal   = "",
        DealCount = 0,
        CUX33     = NULL,
        OrederNo_prev = "";
        
      if ((AllDeals.checked == "X")and(AnaliticsDeals.checked == "X"))
          ;
      elif (AllDeals.checked == "X")
          cmd = "select * from dfx_CUX23_tmp where t_TradeGroup = 'S' order by t_RepoTradeNo, t_SettleDate";
          ds = TRsbDataSet(cmd);
          while (ds.MoveNext)
              if (OrederNo_prev != ds.RepoTradeNo)
                  OrederNo_prev = ds.RepoTradeNo;
                  if (ValType(CUX33) != V_UNDEF)
                      CUX33.Save();
                  end;
                  CUX33 = NULL;
                  CUX33 = CUX33_Data();
                  FillCUX33_from_CUX23(CUX33, ds);
              elif ((ds.ITSComm > 0)or(ds.ClrComm > 0)or(ds.SumComm > 0))
                  FillCUX33_from_CUX23(CUX33, ds);
              end;
          end;
          if (ValType(CUX33) !=V_UNDEF)
              CUX33.Save();
          end;
      else
          ;
      end;

      cmd = "select t_OrderNo, t_ReportDate, t_TradeTime, t_ExchangeId, t_BuySell, t_CurrencyId, t_CoCurrencyId, t_TradeGroup, " +
             "t_FirmId, t_ExtSettleCode, t_AddSession, t_Quantity, t_Price, t_Decimals, t_UserId, t_BrokerRef, " +
             "t_SecurityId, t_TradeNo, t_BoardId from dfx_CUX23_tmp where t_TradeGroup <> 'S'" +
             " UNION ALL " +
             "select t_OrderNo, t_ReportDate, t_TradeTime, t_ExchangeId, t_BuySell, t_CurrencyId, t_CoCurrencyId, 'S' as t_TradeGroup, " +
             "t_FirmId, t_ExtSettleCode, t_AddSession, t_Quantity, t_Price, t_Decimals, ' ' as t_UserId, ' ' as t_BrokerRef," +
             "t_SecurityId, t_TradeNo, t_BoardId from dfx_CUX33_tmp ";

      ds = TRsbDataSet(cmd);
      while(ds.MoveNext)
          RG_Data.Заполнить(strupr("PureDealType"),              КонверсОпер,     RGLog);
          RG_Data.Заполнить(strupr("TradeNo"),                   ds.TradeNo,      RGLog);
          RG_Data.Заполнить(strupr("ReportDate"),                ds.ReportDate,   RGLog);
          RG_Data.Заполнить(strupr("TradeTime"),                 ds.TradeTime,    RGLog);
          RG_Data.Заполнить(strupr("ExchangeId"),                ds.ExchangeId,   RGLog);
          RG_Data.Заполнить(strupr("BuySell"),                   ds.BuySell,      RGLog);
          RG_Data.Заполнить(strupr("CurrencyId"),                ds.CurrencyId,   RGLog);
          RG_Data.Заполнить(strupr("CoCurrencyId"),              ds.CoCurrencyId, RGLog);
          RG_Data.Заполнить(strupr("RateDirection"),             "",              RGLog);
          RG_Data.Заполнить(strupr("PaymentInstructionP1C1"),    "",              RGLog);
          RG_Data.Заполнить(strupr("PaymentInstructionP1C2"),    "",              RGLog);
          RG_Data.Заполнить(strupr("PaymentInstructionP1C1"),    "",              RGLog);
          RG_Data.Заполнить(strupr("PaymentInstructionP2C2"),    "",              RGLog);
          RG_Data.Заполнить(strupr("CommentText"),               "",              RGLog);
          RG_Data.Заполнить(strupr("UserId"),                    trim(ds.UserId),       RGLog);
          RG_Data.Заполнить(strupr("BrokerRef"),                 trim(ds.BrokerRef),    RGLog);
          RG_Data.Заполнить(strupr("Quantity"),                  0,               RGLog);
          RG_Data.Заполнить(strupr("Price1"),                    0,               RGLog);
          RG_Data.Заполнить(strupr("Price2"),                    0,               RGLog);
          RG_Data.Заполнить(strupr("ValueDatePeriod1Currency1"), date(0,0,0),     RGLog);
          RG_Data.Заполнить(strupr("ValueDatePeriod1Currency2"), date(0,0,0),     RGLog);
          RG_Data.Заполнить(strupr("ValueDatePeriod2Currency1"), date(0,0,0),     RGLog);
          RG_Data.Заполнить(strupr("ValueDatePeriod2Currency2"), date(0,0,0),     RGLog);
          RG_Data.Заполнить(strupr("SWIFTBICC1P1"),              -1,              RGLog);
          RG_Data.Заполнить(strupr("SWIFTBICC2P1"),              -1,              RGLog);
          RG_Data.Заполнить(strupr("SWIFTBICC1P2"),              -1,              RGLog);
          RG_Data.Заполнить(strupr("SWIFTBICC2P2"),              -1,              RGLog);
          RG_Data.Заполнить(strupr("Quantity"),                  ds.Quantity,    RGLog);
          RG_Data.Заполнить(strupr("Price1"),                    ds.Price,       RGLog);
          RG_Data.Заполнить(strupr("Points"),                    ds.Decimals,       RGLog);

          if (not (ds.TradeGroup == "S"))
            cmdDeal = "select * from dfx_CUX23_tmp where " + 
                     " t_ReportDate = TO_DATE('" + Date(ds.ReportDate) + "')" +
                     " and (t_FirmId = '" +        ds.FirmId            + "')" +
                     " and (t_ExchangeId = '" +    ds.ExchangeId        + "')" +
                     " and (t_ExtSettleCode = '" + ds.ExtSettleCode     + "')" +
                     " and (t_AddSession = '" +    ds.AddSession        + "')" +
                     " and (t_TradeGroup = '" +    ds.TradeGroup        + "')" +
                     " and (t_CurrencyId = '" +    ds.CurrencyId        + "')" +
                     " and (t_CoCurrencyId = '" +  ds.CoCurrencyId      + "')" +
                     " and (t_SecurityId = '" +    ds.SecurityId        + "')" +
                     " and (t_TradeNo = '" +       ds.TradeNo           + "')" +
                     " and (t_BoardId = '" +       ds.BoardId           + "' or t_BoardId = chr(1)) order by t_RepoTradeNo, t_SettleDate";

            dsDeal = TRsbDataSet(cmdDeal);
            if (dsDeal.MoveNext())
                RG_Data.Заполнить(strupr("UserId"),                    dsDeal.UserId,     RGLog);
                RG_Data.Заполнить(strupr("BrokerRef"),                 dsDeal.BrokerRef,  RGLog);
                RG_Data.Заполнить(strupr("Quantity"),                  dsDeal.Quantity,   RGLog);
                RG_Data.Заполнить(strupr("Price1"),                    dsDeal.Price,      RGLog);
                RG_Data.Заполнить(strupr("ValueDatePeriod1Currency1"), dsDeal.SettleDate, RGLog);
                RG_Data.Заполнить(strupr("ValueDatePeriod1Currency2"), dsDeal.SettleDate, RGLog);
                RG_Data.Заполнить(strupr("SWIFTBICC1P1"),              {OurBank},         RGLog);
                RG_Data.Заполнить(strupr("SWIFTBICC2P1"),              {OurBank},         RGLog);
            end;
          else

              RG_Data.Заполнить(strupr("PureDealType"), КонверсОперСвоп, RGLog);
              cmdDeal = "select * from dfx_CUX23_tmp where " + 
                     " t_ReportDate = TO_DATE('" + Date(ds.ReportDate) + "')" +
                     " and (t_FirmId = '" +        ds.FirmId            + "')" +
                     " and (t_ExchangeId = '" +    ds.ExchangeId        + "')" +
                     " and (t_ExtSettleCode = '" + ds.ExtSettleCode     + "')" +
                     " and (t_AddSession = '" +    ds.AddSession        + "')" +
                     " and (t_TradeGroup = '" +    ds.TradeGroup        + "')" +
                     " and (t_CurrencyId = '" +    ds.CurrencyId        + "')" +
                     " and (t_CoCurrencyId = '" +  ds.CoCurrencyId      + "')" +
                     " and (t_MainSecurityId = '" +    ds.SecurityId        + "')" +
                     " and (t_RepoTradeNo = '" +       ds.TradeNo           + "')" +
                     " and (t_BoardId = '" +       ds.BoardId           + "' or t_BoardId = chr(1)) order by t_RepoTradeNo, t_SettleDate";

              dsDeal = TRsbDataSet(cmdDeal);
              if (dsDeal.MoveNext())
                  RG_Data.Заполнить(strupr("UserId"),                    dsDeal.UserId,     RGLog);
                  RG_Data.Заполнить(strupr("BrokerRef"),                 dsDeal.BrokerRef,  RGLog);
                  RG_Data.Заполнить(strupr("Quantity"),                  dsDeal.Quantity,   RGLog);
                  RG_Data.Заполнить(strupr("Price1"),                    dsDeal.Price,      RGLog);
                  RG_Data.Заполнить(strupr("ValueDatePeriod1Currency1"), dsDeal.SettleDate, RGLog);
                  RG_Data.Заполнить(strupr("ValueDatePeriod1Currency2"), dsDeal.SettleDate, RGLog);
                  RG_Data.Заполнить(strupr("SWIFTBICC1P1"),              {OurBank},         RGLog);
                  RG_Data.Заполнить(strupr("SWIFTBICC2P1"),              {OurBank},         RGLog);
              end;
              if (dsDeal.MoveNext())
                  RG_Data.Заполнить(strupr("UserId"),                    dsDeal.UserId,     RGLog);
                  RG_Data.Заполнить(strupr("BrokerRef"),                 dsDeal.BrokerRef,  RGLog);
                  RG_Data.Заполнить(strupr("Price2"),                    dsDeal.Price,      RGLog);
                  RG_Data.Заполнить(strupr("ValueDatePeriod2Currency1"), dsDeal.SettleDate, RGLog);
                  RG_Data.Заполнить(strupr("ValueDatePeriod2Currency2"), dsDeal.SettleDate, RGLog);
                  RG_Data.Заполнить(strupr("SWIFTBICC1P2"),              {OurBank},         RGLog);
                  RG_Data.Заполнить(strupr("SWIFTBICC2P2"),              {OurBank},         RGLog);
              end;
          end;

          RG_Data.ВыполнитьОтложеннуюПерекодировку();
		  
          if (ВставитьВШлюз())
              ;
          else
              if (TrnMes)
                  RGLog.Error(TrnMes);
              end;
          end;

          DealCount = DealCount + 1;

          RG_Data.Очистить();
          RGLog.Message("Запись обработана.");

          if(GetDialogFlag())
              UseProgress(DealCount);
          end;
      end;
  end;

  private macro StartImport()
    var
        fileMask  = TArray,
        idxMask   = 0,
        DirList   = NULL,
        idxFile   = 0,
        ErrMes    = "",
        idx       = 0,
        isFind    = false;

      RGLog = GTDL_Log(prm_SeanceID);

      if (GetDialogFlag())
          InitProgress(0, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ");
      end;

      if (AllDeals.checked == "X")
          fileMask[fileMask.size] = "???????_CUX23_D??_"+RGDLFUN_MakeDateString(ImportDate.Value) + "_?????????.xml";
          fileMask[fileMask.size] = "???????_CUX23_M??_"+RGDLFUN_MakeDateString(ImportDate.Value) + "_?????????.xml";
          fileMask[fileMask.size] = "???????_CUX23_ADD_"+RGDLFUN_MakeDateString(ImportDate.Value) + "_?????????.xml";
      end;
      if (AnaliticsDeals.checked == "X")
          fileMask[fileMask.size] = "???????_CUX33_???_"+RGDLFUN_MakeDateString(ImportDate.Value) + "_?????????.xml";
      end;

      execSQL("delete from dfx_CUX23_tmp");
      execSQL("delete from dfx_CUX33_tmp");

      while (idxMask < fileMask.size)
          DirList = TDirList(prm_InputDir + fileMask[idxMask], "F");
          DirList.Sort(0);

          idxFile = 0;
          while (idxFile < DirList.Count)
              isFind = true;
              if (LoadXML(DirList.Name(idxFile), @ErrMes) != 0)
                  RGLog.Error(ErrMes);
                  execSQL("delete from dfx_CUX23_tmp where t_FileName = '" + DirList.Name(idxFile) + "'");
                  execSQL("delete from dfx_CUX33_tmp where t_FileName = '" + DirList.Name(idxFile) + "'");
                  if(CopyFile(prm_InputDir + DirList.Name(idxFile), prm_ErrDir + DirList.Name(idxFile)))
                      RemoveFile(prm_InputDir + DirList.Name(idxFile));
                  end;
              else
                  if(CopyFile(prm_InputDir + DirList.Name(idxFile), prm_DoneDir + DirList.Name(idxFile)))
                      RemoveFile(prm_InputDir + DirList.Name(idxFile));
                  end;
              end;

              idxFile = idxFile + 1;
              idx = idx + 1;
              UseProgress(idx);
          end;

          idxMask = idxMask + 1;
      end;

      if(GetDialogFlag())
          RemProgress();
      end;

      if (isFind)
          if (GetDialogFlag())
              InitProgress(0, "Загрузка внешнего файла сделок", "ПЕРЕНОС СДЕЛОК В ШЛЮЗ");
          end;
          LoadDeals();
          if(GetDialogFlag())
              RemProgress();
          end;
      else
          RGLog.Error("Нет данных для загрузки");	  
      end;

      RGLog.Save();
  end;

  private macro КаталогДанных(Настройка)
    var	
        Каталог = "",
        ErrStr  = "";

      Каталог = GetRegImportDir(Настройка, @ErrStr);
      if ((ErrStr != "")or(ErrStr == NULL))
         msgbox(ErrStr);
      end;

      return Каталог;
  end;

  macro ExecImport()
      prm_InputDir = КаталогДанных("MICEX") + "DEALS\\";
      if ((prm_InputDir != "")and(run() == -316)) // K_F2
          StartImport();
          exit(0);
      end;
  end;

  InitTRsbPanel();
  ClassConstructor(_SeanceID);//Вызов конструктора
end;

///////////////////////////////////////////////////////////////////////////////////
Macro Process(SeanceID, Parms)
end;

//import
Macro Receive(_SeanceID, Parms)
    return RG_MVBImport(_SeanceID).ExecImport();
end;

Macro Deliver (SeanceID, Parm)
end;
