/*
$Name:        gtImMVB4.mac
$Module:      Шлюз Securities
$Description: Загрузка ММВБ xml-формат файла биржи
*/

import CTInter, Календарь, FIInter, PTInter, PaymInter, DealsInter,
       "gtconst.inc","rgobj.mac","globals.mac", "gtdlfun.mac", "secinter.mac", "gtmktrep.mac", "rgtgtrec.mac", "GTRrate.mac", "DlForms_h.mac","dldlngfun.mac";
/*ak*/
import gtdlfun_u;
/*~ak*/

/*настраиваемые пользователем константы*/
/* используется для задания вида курса, если он не задан во входном файле с котировками */
PRIVATE CONST RATE_KIND_MARKET     = 1;  /*курс вида "Рыночная цена"         */        
PRIVATE CONST RATE_KIND_MIN        = 2;  /*курс вида "Минимальная цена"      */
PRIVATE CONST RATE_KIND_MAX        = 3;  /*курс вида "Максимальная цена"     */
PRIVATE CONST RATE_KIND_WA         = 4;  /*курс вида "Средневзвешенная цена" */
PRIVATE CONST RATE_KIND_NKD1SEC    = 15; /*курс вида "НКД на одну бумагу"    */
PRIVATE CONST RATE_KIND_VOLUME     = 17; /*курс вида "Объём торгов"          */
PRIVATE CONST RATE_KIND_MARKET_TAX = 21; /*курс вида "Рыночная цена для НДФЛ"*/

PRIVATE CONST Код_на_ММВБ_ФинИн   = 11;
PRIVATE CONST Код_на_ММВБ_Субъект = 8;

PRIVATE VAR SeanceID;
PRIVATE CONST SOURCE_CODE = "SRC-12";

PRIVATE CONST SET_CHAR   = "X";
PRIVATE CONST UNSET_CHAR = "";

PRIVATE CONST FileSEM03 = 1,
              FileEQM06 = 2,
              FileEQM6C = 3,
              FileCCX99 = 4;

PRIVATE VAR ErrMes = "", WarnMes = "", NumImportDeals = 0, NumImportDealsTotal = 0, imp_date, MarketScheme_BO = -1, MarketScheme_DU = -1,
            NumImportDealsCliring = 0, NumImportDealsTotalCliring = 0,
            MMVB_CodeKind = 1, MMVB_Code = "", MarketReportID = "", 
            CodeRate = "", RateKind_ = "", NumImportRates = 0, NumImportRatesTotal = 0, FileImport = 0, PrevISIN = -1;

PRIVATE record pp(IMP_PRM3, "rgate.lbr") dialog;
PRIVATE record issues(avoiriss);
PRIVATE record fin(fininstr);

PRIVATE VAR RG, RGLog;

PRIVATE VAR FlagCtrlBrk:bool = false;
PRIVATE VAR CtrlBrkErr = 17;

private macro ЧислоСтрокой( _var, _point:integer )
   return ExecExp("String(_var:0" + ":" + string(_point) + ")");
end;

PRIVATE CONST PNFLD_IMPDATE         = 0,
              PNFLD_MARKET          = 1,
              PNFLD_RATES           = 2,
              PNFLD_COMP            = 3,
              PNFLD_PAYM            = 4,
              PNFLD_REQUEST         = 5,
              PNFLD_SECUR           = 6,
              PNFLD_CLEARING        = 7,
              PNFLD_CLEARING_CLIENT = 8,
              PNFLD_MONEYMOTION     = 9,
              PNFLD_SEC_BO          = 10,
              PNFLD_SEC_SEB         = 11,
              PNFLD_SEC_DU          = 12,
              PNFLD_MAR_SCHEME_DU   = 13;

private class DataMoneyMotion(_StatementAcc, _EntryCodeType, _EntryNumber, _EntryCorAcc, _EntryPurposePayment, _EntryDebit, _EntryCredit,
                                  _EntryDate, _EntryPayAcc, _EntryRecAcc, _ExtSettleCodeID, _OtherKlirAcc)
        var StatementAcc:string                             =   _StatementAcc,
        EntryCodeType:integer                               =   _EntryCodeType,
        EntryNumber:string                                  =   _EntryNumber,
        EntryCorAcc:string                                  =   _EntryCorAcc,
        EntryPurposePayment:string                          =   _EntryPurposePayment,
        EntryDebit:money                                    =   _EntryDebit,
        EntryCredit:money                                   =   _EntryCredit,
        EntryDate:date                                      =   _EntryDate,
        EntryPayAcc:string                                  =   _EntryPayAcc,
        EntryRecAcc:string                                  =   _EntryRecAcc,
        ExtSettleCodeID:string                              =   _ExtSettleCodeID,
        OtherKlirAcc:string                                 =   _OtherKlirAcc;

    macro Init()
        OtherKlirAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = EntryRecAcc = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;

    macro InitRecords()
        StatementAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;
END;

private class DataDeals()
  var TradeDate    :date,
      CurrencyId   :string,
      SettleDate   :date,
      SecurityId   :string,
      FaceValue    :double,
      PriceType    :string,
      TrdAccId     :string,
      TradeNo      :string,
      TradeTime    :time,
      BuySell      :string,
      Decimals     :integer,
      Price        :double,
      Quantity     :money,
      Value_       :money,
      Value2_      :money,
      Amount       :money,
      Amount2      :money,
      ExhComm      :money,
      OrderNo      :string,
      AccInt       :money,
      CPFirmId     :string,
      RepoValue    :money,
      RepoPeriod   :integer,
      RepoRate     :double,
      TradeType    :string,
      Price2       :double,
      AccInt2      :money,
      ClientCode   :string,
      MatchRef     :string,
      BrokerRef    :string,
      /*ak*/
      OrdTypeCode  :string,
      /*~ak*/
      SettleCode   :string,
      DOC_NO       :string,
      IsTrust      :bool,
      ClrComm      :money,
      ITSComm      :money,
      RepoPart     :integer,
      BoardId      :string,
      InfType      :integer,
      SecurityType :string,
      SettleCode2  :string,
      RecNo        :string,
      SettleTime   :time,
      Session      :integer,
      IsREPO       :bool,
      vClientCode  :string,
      GateDealType :string,
      IsSEB        :bool;
  var IsCliring = false;

  macro Init()
     CurrencyId  = SecurityId = PriceType  = TrdAccId = BuySell   = CPFirmId = TradeType = ClientCode = MatchRef = BrokerRef = SettleCode = DOC_NO = TradeNo = BoardId = SecurityType = SettleCode2 = RecNo = OrderNo ="";
     Value_      = Amount     = ExhComm    = AccInt   = RepoValue = AccInt2  = ClrComm   = ITSComm    = Amount2  = Value2_   = $0.0;
     Decimals    = RepoPeriod = RepoPart   = InfType  = 0;
     FaceValue   = Price      = RepoRate   = Price2   = Quantity  = 0.0;
     TradeDate   = SettleDate = date(0,0,0);
     TradeTime   = SettleTime = time(0,0,0);
     IsTrust     = false;
     Session     = -1;
     vClientCode = GateDealType ="";
     IsREPO      = IsSEB = false;
     /*ak*/
     OrdTypeCode = "";
     /*~ak*/
  end;

  macro InitRecords()
     BuySell     = CPFirmId = TradeType  = MatchRef = BrokerRef = SettleCode = TradeNo = SettleCode2 = RecNo   = "";
     Value_      = Amount   = ExhComm    = AccInt   = RepoValue = AccInt2    = ClrComm = ITSComm     = Amount2 = Value2_ = $0.0;
     Decimals    = RepoPeriod = RepoPart = 0;
     Price       = RepoRate = Price2     = Quantity = 0.0;
     TradeTime   = SettleTime = time(0,0,0);
     ClientCode  = OrderNo ="";
     vClientCode = GateDealType = "";
     IsREPO      = IsSEB = false;
     /*ak*/
     OrdTypeCode = "";
     /*~ak*/
  end;

end;

private class DataRates()
  var TradeDate   :date,
      BoardType   :string,
      SecurityId  :string,
      SecurityType:string,
      Decimals    :integer,
      Volume      :integer,
      CurrencyId  :string,
      Low         :double,
      High        :double,
      WAPrice     :double,
      AccInt      :double,
      MarketPrice :double,
      BoardID     :string,
      MarketPrice3:double,
      MP3ValTrd   :double,
      PriceType   :string,
      FaceValue   :double;

  macro Init()
     MarketPrice = WAPrice      = AccInt     = High      = Low     = MarketPrice3 = MP3ValTrd = FaceValue = 0.0;
     SecurityId  = SecurityType = CurrencyId = BoardType = BoardID = PriceType    = "";
     Decimals    = Volume       = 0;
     TradeDate   = date(0,0,0);
  end;

  macro InitRecords()
     MarketPrice = WAPrice      = AccInt     = High      = Low = MarketPrice3 = MP3ValTrd = FaceValue = 0.0;
     SecurityId  = SecurityType = CurrencyId = PriceType = "";
     Decimals    = Volume       = 0;
  end;

end;

private class DataReq()
  var BuySell   :string,
      EntryTime :time,
      TradeTime :time,
      AmendTime :time,
      Status    :string,
      BrokerRef :string,
      ClientCode:string,
      OrderNo   :string,
      TradeDate :date,
      RepoRate  :double,
      RecNo     :integer,
      SecurityId:string,
      Quantity  :money,
      Price     :double,
      PriceType :string,
      CurrencyId:string,
      TrdAccId  :string,
      RepoValue :money,
      IsTrust   :bool,
      IsSEB     :bool;

  macro Init()
      BuySell   = Status    = BrokerRef = OrderNo = SecurityId = ClientCode = PriceType = CurrencyId = TrdAccId = "";
      EntryTime = TradeTime = AmendTime = time(0,0,0);
      RecNo     = 0;
      RepoRate  = Price = 0.0;
      TradeDate = date(0,0,0);
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = false;
  end;

  macro InitRecords()
      BuySell   = Status    = BrokerRef = OrderNo = SecurityId = ClientCode = PriceType = CurrencyId = TrdAccId = "";
      EntryTime = TradeTime = AmendTime = time(0,0,0);
      RecNo     = 0;
      RepoRate  = Price = 0.0;
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = false;
  end;

end;

private class DataComp()
  var ReportDate:date,
      RepoTradeNo:string,
      SettleDate:date,
      Direction:string,
      Value:money,
      Quantity:integer,
      ClientDetails:string,
      RecNo:integer;

  macro Init()
      RepoTradeNo = Direction = ClientDetails = "";
      Quantity = RecNo = 0;
      Value = $0.0;
      ReportDate = SettleDate = date(0,0,0);
  end;

  macro InitRecords()
      RepoTradeNo = Direction = ClientDetails = "";
      Quantity = RecNo = 0;
      Value = $0.0;
      SettleDate = date(0,0,0);
  end;

end;

private class DataPaym()
  var ReportDate:date,
      RepoTradeNo:string,
      RepoValueDate:date,
      PrincipalValue:money,
      CouponValue:money,
      ClientDetails:string,
      RecNo:integer,
      PaymentValue:money;

  macro Init()
      RepoTradeNo = ClientDetails = "";
      RecNo = 0;
      CouponValue = PrincipalValue = PaymentValue = $0.0;
      ReportDate = RepoValueDate = date(0,0,0);
  end;

  macro InitRecords()
      RepoTradeNo = ClientDetails = "";
      RecNo = 0;
      CouponValue = PrincipalValue = PaymentValue = $0.0;
      RepoValueDate = date(0,0,0);
  end;

end;

private class DataRepo(TradeNo_:string, Amount_:money, SettleDate_:date, AccInt2_:money, Price2_:double, Value_:money)
  var TradeNo:string  = TradeNo_,
      Amount2:money    = Amount_,
      SettleDate:date = SettleDate_,
      AccInt2:money   = AccInt2_,
      Price2:double   = Price2_,
      Value2_:money   = Value_;
end;

private class CPFirmData(TradeNo_:string, BuySell_:string, CPFirmID_:string)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      CPFirmId:string = CPFirmID_;
end;

private class CommData(TradeNo_:string, BuySell_:string, ClrComm_:money, ITSComm_:money)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      ClrComm:money   = ClrComm_,
      ITSComm:money   = ITSComm_;
end;

private class SettleCodeData(TradeNo_:string, RepoPart_:string, SettleCode_:string)
  var TradeNo:string    = TradeNo_,
      RepoPart:string   = RepoPart_,
      SettleCode:string = SettleCode_;
end;

private class DataRepo_1(TradeNo_:string)
  var TradeNo:string  = TradeNo_;
end;

private class KsuData(SecurityId_:string)
  var SecurityId:string = SecurityId_;
end;

private var Deals = DataDeals();
private var Rates = DataRates();
private var Req   = DataReq();
private var Comp  = DataComp();
private var Paym  = DataPaym();
private var MoneyMotion = DataMoneyMotion();

private macro GetUINNumber():string
   if( Deals.ClientCode != "" )
      return Deals.BuySell + "/" + Deals.TradeNo;
   end;

   return Deals.TradeNo;
end;

private macro FileDate(date_val)
   var day, month, year;
   DateSplit(date_val,day,month,year);

   year = year - 1900;

   if( year >= 100 )
      year = year - 100;
   end;

   return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,2);
end;

/* настраиваемый пользователем макрос формирования
   имен файла котировок и сделок с госбумагами с ММВБ */
private macro get_data_file_name( folder:string, pfx:string, datafilepath:@string, datafilename:@string, comment_from_:string )
   var ErrStr = "";

/*ak
   datafilepath = GetRegImportDir("MICEX",@ErrStr);

   if( (ErrStr != "") or (ErrStr == null) )
      RGLog.Message( ErrStr );
      return 1;
   end;

   datafilepath = datafilepath + folder + "\\";*/
   datafilepath = GetRegImportDirU(imp_date, @ErrStr);
/*~ak*/

   var datafilemask = "???????_" + pfx + "_???_" + FileDate(imp_date) + "_?????????" + ".xml";
   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      datafilename = "";
      RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      return 1;
   else
      datafilename = List.name(0);
      RGLog.Message("Используется файл " + datafilename);
      return 0;
   end;

end;

private macro PutMarketReport()
   if( (Deals.DOC_NO == "") OR (WriteMarketReport( SeanceID, NULL, SOURCE_CODE, @MarketReportID, @ErrMes, null, Deals.DOC_NO, imp_date, MMVB_Code ) == false) )
      AbortTrn;
   end; 
end;

private macro PutMoneyMotion()
   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_MONEYMOTION, 
                   String("Движение денежных средств №" + MoneyMotion.EntryNumber),
                   Создать );

   if(NOT RG.InitByCode(RG_MONEYMOTION, MoneyMotion.EntryNumber, SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("EXTCODEID", MoneyMotion.ExtSettleCodeID);
   RG.SetParmByName("ACCOUNT", MoneyMotion.StatementAcc);
   RG.SetParmByName("CODETYPE", MoneyMotion.EntryCodeType);
   RG.SetParmByName("COR_ACC", MoneyMotion.EntryCorAcc);
   RG.SetParmByName("PAY_ACC", MoneyMotion.EntryPayAcc);
   RG.SetParmByName("REC_ACC", MoneyMotion.EntryRecAcc);
   RG.SetParmByName("PURPOSE_PAYMENT", MoneyMotion.EntryPurposePayment);
   RG.SetParmByName("DEBIT", MoneyMotion.EntryDebit);
   RG.SetParmByName("CREDIT", MoneyMotion.EntryCredit);
   RG.SetParmByName("DATE", MoneyMotion.EntryDate);
   RG.SetParmByName("OTHERKLIRACC", MoneyMotion.OtherKlirAcc);

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;

end;

/* получаем код клиента и номер поручения */
private macro GetClientCode(ClientCodeInFile:string, ClientCode:@string)
   var ClientCodeEndPos = 0;  
   if( (ClientCodeInFile != "") AND (ClientCodeInFile != " ") )
      ClientCodeEndPos = Index( ClientCodeInFile, "/");
      if( ClientCodeEndPos != 0 ) 
         ClientCode = SubStr( ClientCodeInFile, 1, ClientCodeEndPos-1 );
      else
         ClientCode = ClientCodeInFile;
      end; 
      // ClientCode = SubStr( ClientCode, 1, 5 ); /*берем в качестве кода клиента первые пять символов*/
   else
      ClientCode = "";
   end;
end;



/* получаем Код информации Трейдера */
private macro GetRefNote(ClientCodeInFile:string)
   var ClientCodeBegPos = 0, RefCode = "";  
   if( (ClientCodeInFile != "") AND (ClientCodeInFile != " ") )
      ClientCodeBegPos = Index( ClientCodeInFile, "/");
      if( ClientCodeBegPos != 0 ) 
         ClientCodeBegPos = ClientCodeBegPos + 1;
         RefCode = SubStr( ClientCodeInFile, ClientCodeBegPos);
      else
         RefCode = "";
      end; 
      // ClientCode = SubStr( ClientCode, 1, 5 ); /*берем в качестве кода клиента первые пять символов*/
   else
      RefCode = "";
   end;
   return RefCode;
end;


/* получаем Портфель из информации от Трейдера */
private macro GetRefNotePortf(ClientCodeInFile:string)
   var ClientCodeBegPos = 0, RefCode = "";  
   if( (ClientCodeInFile != "") AND (ClientCodeInFile != " ") )
      ClientCodeBegPos = Index( ClientCodeInFile, "_");
      if( ClientCodeBegPos != 0 ) 
         ClientCodeBegPos = ClientCodeBegPos + 1;
         RefCode = SubStr( ClientCodeInFile, ClientCodeBegPos);
      else
         RefCode = "";
      end; 
      // ClientCode = SubStr( ClientCode, 1, 5 ); /*берем в качестве кода клиента первые пять символов*/
   else
      RefCode = "";
   end;
   return RefCode;
end;


private macro SetErrAfterLoad(pCallAfterTransfer:bool)

   var vCallAfterTransfer = false;

   if( pCallAfterTransfer != null )
      vCallAfterTransfer = pCallAfterTransfer;
   end;

   var i, EArr = TArray(); 

   if( (RG.GetCurRecID() == 0) or (vCallAfterTransfer == true) )
      EArr.size = 0;
      RG.GetErrorArray(EArr, false);
      if( EArr.size != 0 )
         i = 0;
         while( i < EArr.size )
            RGLog.Error(EArr[i]);
            i = i + 1;
         end;
      else
         if(RG.GetLastError())
            RGLog.Error(RG.GetLastError());
         end;
      end;
   end;

end;

private macro ЭтоКСУ( SecurityType:string )
   return ( (StrLwr(SecurityType) == "ксу") or (StrLwr(SecurityType) == "Єбг") );
end;

// сделка подходит?
private macro IsFitDeal(IsTrust, IsSEB)
   if( (pp.deals_bo == SET_CHAR) and (not IsTrust) and (not IsSEB))
      return true;
   elif( (pp.deals_du == SET_CHAR) and IsTrust )
      return true;
   elif( (pp.deals_seb == SET_CHAR) and IsSEB )
      return true;
   end;
   return false;
end;

/* заполнение и сохранение сделки */
private macro PutDealInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;
/*КД*/
   Var RefNote = "", RefNotePortf = "";

   var IsTODAY:bool = false;
   var DealTypeID:integer = -1, NumDaysBeforePaym:integer = 0;
   var Portfolio = KINDPORT_UNDEF, DealDate = date(0,0,0), CommDate = date(0,0,0);

   RG.InitB(SeanceID,
            NULL,
            IIF( Deals.IsCliring == true, 27/*клиринг*/, RG_SECURDEAL ),
            IIF(Deals.IsCliring == true, "Клиринг. ", "") + String("Сделка на ММВБ №" + GetUINNumber()),
            Создать );

   if(NOT RG.InitByCode(IIF( Deals.IsCliring == true, 27/*клиринг*/, RG_SECURDEAL ), string(GetUINNumber()+IIF( Deals.IsCliring == true, "_c"+string(Deals.RepoPart), "" )), SOURCE_CODE) )
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Deals.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке сделки с кодом \"" + GetUINNumber() + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLTC_ISIN", Deals.SecurityId);

   RG.SetParmByName("RGDLTC_DEALCODETS", Deals.TradeNo);

   RG.SetParmByName("RGDLTC_DEALTIME",   Deals.TradeTime);
   
   if( Deals.IsCliring and IMPORT_SETTLETIME() and (Deals.SettleTime != Time(0, 0, 0)) )
      RG.SetParmByName("RGDLLG_SUPTIME_01", Deals.SettleTime);
      RG.SetParmByName("RGDLLG_SUPTIME_02", Deals.SettleTime);
   else
      RG.SetParmByName("RGDLLG_SUPTIME_01", Deals.TradeTime);
      RG.SetParmByName("RGDLLG_SUPTIME_02", Deals.TradeTime);
   end;

   if(deals.vClientCode != "")
      /* по виду кода - "Код на ММВБ" находим клиента */
      RG.SetParmByName("RGDLTC_CLIENT", deals.vClientCode);
   end;

   IsTODAY = (Deals.TradeDate == Deals.SettleDate);
   if( ПолучитьВидОперацииБОЦБ( "B", Deals.GateDealType, @DealTypeID, @ErrMes, Deals.IsTrust, IsTODAY, Deals.IsSEB ) != 0 )
      Exit();
   end;

/*КД*/
   RefNote = GetRefNote(Deals.BrokerRef);
   RefNotePortf = GetRefNotePortf(RefNote);
   If(RefNote != "")
      RG.SetParmByName("RGDLTC_NOTEVAL1", RefNote);
   end;

   if( (FileImport == FileSEM03) AND (not Deals.IsREPO) and (not Deals.IsSEB) )
      Portfolio = GetDealPortfolio(issues,imp_date,(Deals.vClientCode != ""), RefNotePortf);
      if( Portfolio != KINDPORT_UNDEF )
         RG.SetParmByName( "RGDLTC_PORTFOLIO", Portfolio );
      end;
   end;

   RG.SetParmByName("RGDLTC_DEALTYPE", DealTypeID );

   RG.SetParmByName("RGDLTC_PRICE",   Deals.Price);
   RG.SetParmByName("RGDLTC_NUMLOTS", Deals.Quantity);

   if(Deals.IsREPO)
      RG.SetParmByName("RGDLLG_PRICE_02",   Deals.Price2  ); /* цена по 2-ой части */
      RG.SetParmByName("RGDLTC_INCOMERATE", Deals.RepoRate); /* ставка Репо */
   end;

   /* цена в процентах */
   var Relativ:string = "";
   if( StrUpr(Deals.PriceType) == "PERC" )
      Relativ = SET_CHAR;
   else
      Relativ = UNSET_CHAR;
   end;
   RG.SetParmByName("RGDLLG_RELATIVEPRICE_01", Relativ);
   if(Deals.IsREPO)
      RG.SetParmByName("RGDLLG_RELATIVEPRICE_02", Relativ);
   end;

   /* НКД - для купонной ценной бумаги */
   RG.SetParmByName("RGDLLG_NKD_01", Deals.AccInt);

   /* сумма сделки без НКД */
   RG.SetParmByName("RGDLLG_COST_01", Deals.Value_);

   /* общая сумма сделки */
   RG.SetParmByName("RGDLLG_TOTALCOST_01", Deals.Amount);

   if(Deals.BuySell == "B")
      RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CAi), SET_CHAR);
   else
      RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CAi), UNSET_CHAR);
   end;

   if(Deals.IsREPO)
      if(Deals.BuySell == "B")
         RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CRi), UNSET_CHAR);
      else
         RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CRi), SET_CHAR);
      end;
   end;

   /* номер договора с клиентом */
   RG.SetParmByName( "RGDLTC_CONTRID", "");

   RG.SetParmByName("RGDLTC_DEALCODE", GetUINNumber());

   /* код расчетов */
   RG.SetParmByName("RGDLTC_PCODE", Deals.SettleCode);

   /* признак ОРЦБ */
   RG.SetParmByName("RGDLTC_USERFLAG1", SET_CHAR);

   RG.SetParmByName( "RGDLTC_USERFLAG3", SET_CHAR);

   /* тип сделки на ММВБ */
   if(FileImport == FileSEM03)
      RG.SetParmByName("RGDLTC_KIND", Deals.TradeType);
   else
      if(Deals.IsREPO)
         RG.SetParmByName("RGDLTC_KIND", "R");
      else
         RG.SetParmByName("RGDLTC_KIND", "T");
      end;
   end;

   if( not Deals.IsREPO )
      RG.SetParmByName("RGDLTC_BOARDID", Deals.BoardID);
   end;

   /* комиссия биржи */
   /* Все три биржевые комиссии в импортированной сделке обрабатываются одной суммой - это правильно*/
   if( not Deals.IsCliring )
      RG.SetParmByName("RGDLTC_AMOUNT_COMM", Deals.ExhComm );
      RG.SetParmByName("RGDLTC_CLRCOMM", Deals.ClrComm );
      RG.SetParmByName("RGDLTC_ITSCOMM", Deals.ITSComm );
   else // Deals.IsCliring == true
      RG.SetParmByName("RGDLTC_REPOPART", Deals.RepoPart);
      RG.SetParmByName("RGDLTC_BUYSELL", Deals.BuySell);
      RG.SetParmByName("RGDLTC_CLIRINGTIME", Deals.SettleTime);
      RG.SetParmByName("RGDLTC_SESSION", Deals.Session);
   end;

   /* дата сделки */
   if(Deals.TradeDate == date(0,0,0))
      RG.SetParmByName("RGDLTC_DEALDATE", imp_date);
      DealDate = imp_date;
   else
      RG.SetParmByName("RGDLTC_DEALDATE", Deals.TradeDate);
      DealDate = Deals.TradeDate;
   end;

   if(Deals.CPFirmId != "")
      RG.SetParmByName("RGDLTC_PARTY", Deals.CPFirmId);
   else
      /*для СделкаToday (не срочных и не РЕПО) в качестве контрагента ставим субъекта с принадлежностью 'Центральный контрагент'*/
      if( (FileImport == FileSEM03) AND (not Deals.IsREPO) AND 
          (Deals.SettleDate == DealDate) AND (DealDate >= date(1,11,2011))
        )
         if( RG_GetCentralContr(@Deals.CPFirmId) )
            RG.SetParmByName("RGDLTC_PARTY", Deals.CPFirmId);
         end;
      end;
   end;

   var PaymDate:date = DealDate;
   var NDay:integer = 0;
   /* суммы по второй части для РЕПО */
   if(Deals.IsREPO)
      if( Deals.RepoPart != 2 )/*заполним даты исполнения по 1 ч по сделке и по клирингу*/
         if( Index(StrUpr(Deals.SettleCode),"Y") == 1 )
            NDay = int(SubStr( Deals.SettleCode, 2 ));
            PaymDate = DateAfterWorkDays(PaymDate, NDay);
         else
            if( Deals.SettleCode == "S01" )
               PaymDate = DateAfterWorkDays(PaymDate, 1);
            elif( Deals.SettleCode == "S02" )
               PaymDate = DateAfterWorkDays(PaymDate, 2);
            end;
         end;

         if( Deals.IsCliring == true )
            RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
         else
            RG.SetParmByName("RGDLLG_SUPDATE_01", PaymDate);
            RG.SetParmByName("RGDLLG_PAYDATE_01", PaymDate);
         end;
      else/*даты исполнения по 2 ч по клирингу (не по сделке) не заполняем - вычислим при вставке сделки в БОЦБ*/
         RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
      end;
    
      if( not Deals.IsCliring ) /*заполним даты исполнения по 2 ч по сделке(не клиринг)*/
         var IndexYm = Index(StrUpr(Deals.SettleCode),"Y",1);
         var IndexYn = Index(StrUpr(Deals.SettleCode),"Y",IndexYm+1);
         
         if( (IndexYm == 1) and (IndexYn > IndexYm) )/*обрабатываем конструкции вида Y0/Yn, Ym/Yn, Y0/YnW, Y0/YnM*/

            var IndexW = Index(StrUpr(Deals.SettleCode),"W");
            var IndexM = Index(StrUpr(Deals.SettleCode),"M");

            if( IndexW > 0 )
               NDay = 7*(int(SubStr( Deals.SettleCode, IndexYn+1, IndexW - (IndexYn+1) )));
               PaymDate = DateAfterCalenDays(PaymDate, NDay);
            elif( IndexM > 0 )
               NDay = int(SubStr( Deals.SettleCode, IndexYn+1, IndexM - (IndexYn+1) ));
               PaymDate = DateAfterCalenMonths(PaymDate, NDay);
            else
               NDay = int(SubStr( Deals.SettleCode, IndexYn+1 ));
               PaymDate = DateAfterWorkDays(PaymDate, NDay);
            end;

            /*не выводим сообщение, если дата PaymDate - это выходной, а следующая рабочая дата это Deals.SettleDate*/
            if( (Deals.SettleDate != PaymDate) and not(IsHoliday(Deals.SettleDate) and (DateAfterWorkDays(PaymDate, 0) == Deals.SettleDate)) )
               WarnMes = "Срок сделки \""+Deals.TradeNo+"\", определенный параметром SettleDate = "+string(Deals.SettleDate)+", не соответствует коду расчетов \""+string(Deals.SettleCode)+"\" по сделке.";
            end;

            PaymDate = Deals.SettleDate;

         elif(Index(StrUpr(Deals.SettleCode),"T0/Y") == 1)/*обрабатываем конструкции вида T0/Yn*/
            NDay = int(SubStr( Deals.SettleCode, 5 ));
            PaymDate = DateAfterWorkDays(PaymDate, NDay);

            /*не выводим сообщение, если дата PaymDate - это выходной, а следующая рабочая дата это Deals.SettleDate*/
            if( (Deals.SettleDate != PaymDate) and not(IsHoliday(Deals.SettleDate) and (DateAfterWorkDays(PaymDate, 0) == Deals.SettleDate)) )
               WarnMes = "Срок сделки \""+Deals.TradeNo+"\", определенный параметром SettleDate = "+string(Deals.SettleDate)+", не соответствует коду расчетов \""+string(Deals.SettleCode)+"\" по сделке.";
            end;

            PaymDate = Deals.SettleDate;
         else
            PaymDate = PaymDate + Deals.RepoPeriod;
         end;
        
         RG.SetParmByName("RGDLLG_SUPDATE_02", PaymDate);
         RG.SetParmByName("RGDLLG_PAYDATE_02", PaymDate);
      end;

      RG.SetParmByName("RGDLLG_COST_02",      Deals.Value2_);
      RG.SetParmByName("RGDLLG_NKD_02",       Deals.AccInt2);
      RG.SetParmByName("RGDLLG_TOTALCOST_02", Deals.Amount2);
   else
      RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
      RG.SetParmByName("RGDLLG_PAYDATE_01", Deals.SettleDate);
   end;
   
   //разница между предварительной и фактической датами рассчёта есть
   if (PaymDate != Deals.SettleDate)
      if ( not IsWorkDay(DealDate)  )
        RGLog.Message("Дата "+ Deals.SettleDate +", указанная в файле выгрузки, попадает на выход-ной день. Расчетная дата - " + PaymDate );
      end;
   end; 
   if (Deals.IsREPO and (NDay > 0) )
      RG.SetParmByName("RGDLTC_DAYBEFOREEXECUTE", NDay);
   elif (PaymDate != Deals.SettleDate)
      RG.SetParmByName("RGDLTC_DAYBEFOREEXECUTE", Workdays(Deals.TradeDate, PaymDate)-1);
   end;   
   
   RG.SetParmByName(GetParmName( "RGDLPM_DATE", BAi),  Deals.SettleDate);

   RG.SetParmByName(GetParmName( "RGDLPM_DATE", CAi ), Deals.SettleDate);

   RG.SetParmByName("RGDLTC_MARKET", MMVB_Code);
   
   If(Deals.TradeNo == "2531218151")
   end;
   if(Deals.IsTrust)
      RG.SetParmByName("RGDLTC_MARKETSCHEME", MarketScheme_DU);
   else
      var r_dlmarket = TRecHandler("dlmarket.dbt");
      var MarketID = -1;

      MarketScheme_BO = 0;

      if( (GetRealID( RG_PARTY, MMVB_Code, Код_на_ММВБ_Субъект, @MarketID, @ErrMes ) == 0) and (RG_MarketSchemeBySettleCode(MarketID,Deals.SettleCode,false,@r_dlmarket,Deals.TrdAccId) == true) )
         MarketScheme_BO = r_dlmarket.rec.ID;
      end;

      RG.SetParmByName("RGDLTC_MARKETSCHEME", MarketScheme_BO);
   end;

   /*идентификатор документа-подтверждения вида "Отчет биржи"*/
   RG.SetParmByName("RGDLTC_MARKETREPORT_ID", MarketReportID);

   /*статус сделки - отложенная*/
   RG.SetParmByName("RGDLTC_DEALSTATUS", DL_PREPARING);

   /* дата комиссии */
   /* Если TradeTime<=19:00, то сделка заключена во время основной торговой сессии, 
      и комиссия по ней оплачивается в день заключения сделки.
      Если TradeTime>19:00, то сделка заключена во время дополнительной торговой сесии, 
      и комиссия по ней оплачивается на следующий торговый день (т.е. на следующий рабочий день от даты заключения сделки)
    */
   if( (FileImport == FileSEM03) AND (Deals.TradeTime > Time(19,0,0)) )
      CommDate = GetDateAfterWorkDays(imp_date,1);
      RG.SetParmByName("RGDLTC_DATE_CM",  CommDate);
   else
      RG.SetParmByName("RGDLTC_DATE_CM",  imp_date);
   end;

   RG.SetParmByName("RGDLPM_NUMBPAYMS", 0);

   /* точность цены */
   RG.SetParmByName("RGDLLG_POINT_01", Deals.Decimals);
   RG.SetParmByName("RGDLLG_POINT_02", Deals.Decimals);
   /* торговый счет, в счет которого заключена данная сделка */
   RG.SetParmByName("RGDLTC_TRDACCID", Deals.TrdAccId);

   if(FileImport == FileSEM03)
      RG.SetParmByName("RGDLTC_ORDERNOM", Deals.OrderNo);
      /* поле "ссылка" */
      RG.SetParmByName("RGDLTC_MATCHREF", Deals.MatchRef);
      /* номинальная стоимость одной ценной бумаги */
      RG.SetParmByName("RGDLTC_FACEVALUE", Deals.FaceValue);
   end;

   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", BAi ), Deals.CurrencyId);
   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", CAi ), Deals.CurrencyId);
   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", PM_PURP_AVANCE ), Deals.CurrencyId);
   if(Deals.IsREPO)
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", BRi ), Deals.CurrencyId);
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", CRi ), Deals.CurrencyId);
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", PM_PURP_BACK_AVANCE ), Deals.CurrencyId);
   end;

  if( (FileImport == FileSEM03) and (deals.vClientCode != "")/* and ФормироватьПорученияПриИмпорте(@ErrMes) */)
      RG.SetParmByName("RGDLTC_INDOC", Deals.OrderNo);
      /*Дата поручения на сделку*/
      RG.SetParmByName("RGDLTC_INDOCDATE", DealDate);
      /*Время поручения на сделку*/
      RG.SetParmByName("RGDLTC_INDOCTIME", Deals.TradeTime - Time(0,1,0));
   end;

/*ak*/
   if(Deals.OrdTypeCode != "")
      RG.SetParmByName("RGDLTC_NOTEVAL2", Deals.OrdTypeCode);
      RG.SetParmByName("RGDLTC_NOTEKIND2", 1);
   end;
/*~ak*/

   RG.Save();
   SetErrAfterLoad();

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Ошибка при загрузке сделки с кодом \"" + GetUINNumber() + "\"\n" + 
                      "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError() );
      end;
   end;
end;

/* заполнение и сохранение внебиржевой сделки ПИ*/
private macro PutDVnDealInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   var ClientCode:string = "";

   RG.InitB(SeanceID,
            NULL,
            RG_DVNDEAL,/*Внебиржевая сделка с ПИ*/
            String("Внебирж. сделка с ПИ № " + GetUINNumber()),
            Создать );
   /*Расчёт дней до даты исполнения*/
   var RGDVNDL_DAYBEFOREEXECUTE:Integer = 0;
   var calcDate:date;
   
   if ( not IsWorkDay(Deals.SettleDate)  )
     //Если день расчётов не рабочий, берём ближайший рабочий
     calcDate = GetDateAfterWorkDays( Deals.SettleDate, 1);
     //И считаем сколько рабочих дней получилось от заключения сделки до планового исполнения
     RGDVNDL_DAYBEFOREEXECUTE = Workdays(Deals.TradeDate, calcDate);     
   end;
   
   
                                                                                     
   if(NOT RG.InitByCode(RG_DVNDEAL, GetUINNumber(), SOURCE_CODE) )
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Deals.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке сделки с кодом \"" + GetUINNumber() + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDVNDL_KIND",      ПокупкаПродажаT3);
   RG.SetParmByName("RGDVNDL_CODE",      Deals.RecNo);
   RG.SetParmByName("RGDVNDL_EXTCODE",   GetUINNumber());/*внешний код также как у сделок БОЦБ (чтобы клиринг, если потребуется, нашел сделку по внешнему коду)*/
   RG.SetParmByName("RGDVNDL_DATE",      Deals.TradeDate);
   RG.SetParmByName("RGDVNDL_TIME",      Deals.TradeTime);
   RG.SetParmByName("RGDVNDL_EXECDATE",  Deals.SettleDate);
   RG.SetParmByName("RGDVNDL_ISIN",      Deals.SecurityId);
   RG.SetParmByName("RGDVNDL_BUYSELL",   Deals.BuySell);
   RG.SetParmByName("RGDVNDL_AMOUNT",    Deals.Quantity);
   RG.SetParmByName("RGDVNDL_PRICE",     Deals.Price);
   RG.SetParmByName("RGDVNDL_COST",      Deals.Amount);
   RG.SetParmByName("RGDVNDL_PRICEFIID", Deals.CurrencyId);/*ВЦ,ВР*/
   RG.SetParmByName("RGDVNDL_POINT",     Deals.Decimals);
   RG.SetParmByName("RGDVNDL_NKD",       Deals.AccInt);
   RG.SetParmByName("RGDVNDL_PRICETYPE", Deals.PriceType);
   RG.SetParmByName("RGDVNDL_VALUE",     Deals.Value_);
   RG.SetParmByName("RGDVNDL_AMOUNT_COMM", Deals.ExhComm);
   if (RGDVNDL_DAYBEFOREEXECUTE > 0)
     RGLog.Message("Дата "+ Deals.SettleDate +", указанная в файле выгрузки, попадает на выход-ной день. Расчетная дата - " + calcDate );
     RG.SetParmByName("RGDVNDL_DAYBEFOREEXECUTE", RGDVNDL_DAYBEFOREEXECUTE);
   end;
   

   if(Deals.ClientCode != "")
      ClientCode = Deals.ClientCode;
   else
      GetClientCode(Deals.BrokerRef, @ClientCode);
   end;
   RG.SetParmByName("RGDVNDL_CLIENT", ClientCode );

   RG.Save();
   SetErrAfterLoad();

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Ошибка при загрузке сделки с кодом \"" + GetUINNumber() + "\"\n" +
                      "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError() );
      end;
   end;
end;

PRIVATE MACRO IsOutExchangeREPO():BOOL
  return ((Deals.BoardId == "RPNG") AND (Deals.InfType == 2));
END;

PRIVATE MACRO IsDealData():BOOL
  if( FileImport == FileSEM03 )
     return true;
  end;

  if( IsOutExchangeREPO() )
     return true;
  end;

  return false;
END;

PRIVATE MACRO IsDVnDealData():BOOL
  return ((FileImport == FileSEM03) and (ЗагружатьСделкувБОПИ(Deals.TradeType, Deals.TradeDate, Deals.SettleDate, @ErrMes)==true));
END;

PRIVATE MACRO IsCliringData():BOOL

  if( FileImport != FileEQM06 )
     return false;
  end;

  if(    ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи

      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 

      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО  
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 
    )
     return true;
  end;

  return false;
END;

private macro WriteDealData()
   VAR NoError = true;
   ErrMes = "";
   WarnMes = "";

   if( IsDealData() )
      if( NumImportDeals == 0 ) /*на первой сделке вставляем документ-основание*/
         if(ProcessTrn(0, "PutMarketReport"))
         else
            RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep );
         end;
         ErrMes = "";
      end;

      NumImportDeals = NumImportDeals + 1;
      Deals.IsCliring = false;

      if (ProcessTrn(0, IIF(IsDVnDealData(),"PutDVnDealInfo","PutDealInfo")) )
      else
         NoError = false;
      end;

      if( ErrMes != "" )
         RGLog.Error(ErrMes);
      end;

      if( WarnMes != "" )
         RGLog.Message(WarnMes);
      end;

      ErrMes = "";
      WarnMes = "";
   end;

   /* !!! В EQM06 одна запись может попаcть сразу в оба условия IsDealData и IsCliringData*/
   if( IsCliringData() )
      NumImportDealsCliring = NumImportDealsCliring + 1;
      Deals.IsCliring = true;
      if (ProcessTrn(0, "PutDealInfo") )
         Deals.IsCliring = false;
      else
         Deals.IsCliring = false;
         NoError = false;
      end;

      if( ErrMes != "" )
         RGLog.Error(ErrMes);
      end;

      if( WarnMes != "" )
         RGLog.Message(WarnMes);
      end;

      ErrMes = "";
      WarnMes = "";
   end;

   return NoError;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

/* обработка параметров котировки */
MACRO PutRateInfo()

   var strObject = "", MMVB_NumSection;

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   if(Rates.TradeDate != date(0,0,0))
      strObject = String("Котировка финансового инструмента " + Rates.SecurityId + " на ") + string(Rates.TradeDate);
   else          
      strObject = String("Котировка финансового инструмента " + Rates.SecurityId + " на ") + string(imp_date);
   end;

   RG = TGTRecord(ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_RATE,
                  strObject,
                  Создать );

   if(NOT RG.InitByCode( RG_RATE, CodeRate, SOURCE_CODE ))
      AbortTRN;
   end;

   RG.SetParmByName( "RGFIRT_BOARDTYPE", Rates.BoardType);

   RG.SetParmByName( "RGFIRT_BOARDID", Rates.BoardID );

   RG.SetParmByName( "RGFIRT_ISIN_ISO", Rates.SecurityId );

   RG.SetParmByName( "RGFIRT_FOR_CB", SET_CHAR);

   RG.SetParmByName( "RGFIRT_CURR_RATE", Rates.CurrencyId);

   RG.SetParmByName( "RGFIRT_TCC_FLAG", -1);

   RG.SetParmByName( "RGFIRT_RATE_ISREALID", UNSET_CHAR);

   RG.SetParmByName( "RGFIRT_FINCODEKIND", Код_на_ММВБ_ФинИн);

   RG.SetParmByName( "RGFIRT_RATEKIND", RateKind_ );

   /* Признак: цена задана в процентах от номинала */
   if( StrUpr(Rates.PriceType) == "PERC" )
      RG.SetParmByName("RGFIRT_ISRELATIVE", SET_CHAR);
   else
      RG.SetParmByName("RGFIRT_ISRELATIVE", UNSET_CHAR);
   end;

   if( RateKind_ == RATE_KIND_MARKET ) /*вид котировки - рыночная цена, значит устанавливаем признак основного курса*/
      RG.SetParmByName( "RGFIRT_ISDOMINANT", "X");
   else
      RG.SetParmByName( "RGFIRT_ISDOMINANT", "");
   end;   
   RG.SetParmByName( "RGFIRT_ISINVERSE", UNSET_CHAR);
   RG.SetParmByName( "RGFIRT_SCALE", 1);

   if(Rates.TradeDate != date(0,0,0))
      imp_date = Rates.TradeDate;
   end;

   RG.SetParmByName( "RGFIRT_SINCEDATE", imp_date);

   if(RateKind_   == RATE_KIND_MARKET)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MarketPrice, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_MIN)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.Low, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_MAX)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.High, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_WA)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.WAPrice, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_NKD1SEC)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.AccInt, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_VOLUME)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.Volume, Rates.Decimals));
   elif(RateKind_ == RATE_KIND_MARKET_TAX)
      RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MarketPrice3, Rates.Decimals));
   end;

   if( RateKind_ == RATE_KIND_MARKET_TAX)
      RG.SetParmByName( "RGFIRT_MPVALTRD", Rates.MP3ValTrd);
   end;

   RG.SetParmByName( "RGFIRT_PARTYCODEKIND", Код_на_ММВБ_Субъект);

   RG.SetParmByName( "RGFIRT_MARKETPLACE", string(MMVB_Code));

   /*Сектор биржи*/
   if( MMVB_Code == MICEX_CODE_FB )
      MMVB_NumSection = СекторФонд;
   elif( MMVB_Code == MICEX_CODE )
      MMVB_NumSection = СекторГосЦБ;
   else
      MMVB_NumSection = 0;
   end;
   RG.SetParmByName( "RGFIRT_MARKETOFFICE", MMVB_NumSection);

   /*точность*/
   RG.SetParmByName("RGFIRT_POINT", Rates.Decimals);

   RG.SetParmByName( "RGFIRT_FACEVALUE", Rates.FaceValue);

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
END;

/* настраиваемый пользователем макрос формирования кода котировки ц/б в шлюзе*/
PRIVATE MACRO get_rate_cb_code( RateKind, RateMarketPlace )
   if(Rates.TradeDate != date(0,0,0))
      return string(Rates.SecurityId) + "_" + string(RateKind) + "_" + string(Rates.TradeDate) + "_" + string(RateMarketPlace) + "_" + string(Rates.BoardID);
   else
      return string(Rates.SecurityId) + "_" + string(RateKind) + "_" + string(imp_date) + "_" + string(RateMarketPlace) + "_" + string(Rates.BoardID);
   end;
END;

private macro WriteRateData(RateKind)

   ErrMes = "";
   NumImportRates = NumImportRates + 1;

   CodeRate = get_rate_cb_code( RateKind, string(MMVB_Code));
   RateKind_ = RateKind;

   if(ProcessTrn(0, "PutRateInfo") )
      NumImportRatesTotal = NumImportRatesTotal + 1;
      RGLog.Message( "Успешно загружена котировка \"" + CodeRate + "\"\n" + ErrMes, RG, SUCCESS );
      return true;
   else
      RGLog.Error( "Ошибка при загрузке котировки \"" + CodeRate + "\"\n" + ErrMes, RG  );
      return false;
   end;
   ErrMes = "";

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

private macro ДнейВГоду( YYYY:INTEGER ):INTEGER
   return DATE( 31,12,YYYY )-DATE( 1,1,YYYY )+1;
end;

private macro НайтиДанныеПо2Части(DataRepoArray:TArray, TradeNo1:string, SettleDate:date, Amount:money, RepoRate:@double,
                                  AccInt2:@money, Amount2:@money, Value2_:@money, Price2:@double)
   var i:integer = 0, N:double = 1.0;
   var YYYY_beg, YYYY_end, YYYY_cur;
   RepoRate = 0.0; AccInt2 = $0.0; Amount2 = $0.0; Value2_ = $0.0; Price2 = 0.0;
   while(i < DataRepoArray.size)
      if(DataRepoArray[i].TradeNo == TradeNo1)
         AccInt2 = DataRepoArray[i].AccInt2;
         Amount2 = DataRepoArray[i].Amount2;
         Value2_ = DataRepoArray[i].Value2_;
         Price2  = DataRepoArray[i].Price2;
         if(SettleDate != DataRepoArray[i].SettleDate)
            datesplit( SettleDate, NULL, NULL, YYYY_beg );
            datesplit( DataRepoArray[i].SettleDate, NULL, NULL, YYYY_end );
            if(YYYY_beg == YYYY_end)
               N = double(DataRepoArray[i].SettleDate - SettleDate) / double(ДнейВГоду(YYYY_beg));
            else
               YYYY_cur = YYYY_beg + 1;
               N = double(DATE(1,1,YYYY_cur) - SettleDate) / double(ДнейВГоду(YYYY_beg));
               while(YYYY_cur < YYYY_end)
                  N = N + 1;
                  YYYY_cur = YYYY_cur + 1;
               end;
               N = N + double(DataRepoArray[i].SettleDate - DATE(1,1,YYYY_cur)) / double(ДнейВГоду(YYYY_end));
            end;
         end;
         if((Amount * N) != 0.0)
            RepoRate = round(((DataRepoArray[i].Amount2 - Amount) / (Amount * N)) * 100, 4);
         end;
         break;
      end;
      i = i + 1;
   end;
end;

/*заполняем нулевые параметры AccInt2:@money, Amount2:@money, Value2_:@money, Price2 данными из файла клиринга*/
private macro ДозаполнитьРЕПО2ч(DataRepoArray:TArray, TradeNo1:string,
                                AccInt2:@money, Amount2:@money, Value2_:@money, Price2:@double)
   var i:integer = 0;

   while(i < DataRepoArray.size)

      if(DataRepoArray[i].TradeNo == TradeNo1)

         if( AccInt2 == $0.0 )
            AccInt2 = DataRepoArray[i].AccInt2;
         end;

         if( Amount2 == $0.0 )
            Amount2 = DataRepoArray[i].Amount2;
         end;

         if( Value2_ == $0.0 )
            Value2_ = DataRepoArray[i].Value2_;
         end;

         if( Price2 == 0.0 )
            Price2  = DataRepoArray[i].Price2;
         end;

         break;

      end;

      i = i + 1;

   end;

end;

private macro ЗаполнитьДругойКлирСчет(DataOtherSchema:TArray, EntryCredit:money, EXTSettleCodeID:integer, EntryDate:date, EntryCodeType:integer, EntryPurposePayment:string, OtherAccount:@string)
    var i:integer = 0;

    while(i < DataOtherSchema.Size)
        if((DataOtherSchema[i].EntryDebit == EntryCredit) and (DataOtherSchema[i].ExtSettleCodeID == EXTSettleCodeID) and (DataOtherSchema[i].EntryDate == EntryDate) and (DataOtherSchema[i].EntryCodeType == EntryCodeType) and 
           (substr(DataOtherSchema[i].EntryPurposePayment,1,strlen(DataOtherSchema[i].EntryPurposePayment)-1) == substr(EntryPurposePayment,1,strlen(EntryPurposePayment)-1)))
            OtherAccount = DataOtherSchema[i].StatementAcc;
            break;
        end;
        i = i + 1;
    end;
end;

private macro ЗаполнитьКонтрагентаДляРПС(DataContrSEM03Array:TArray, TradeNo:string, BuySell:string, CPFirmId:@string)
   var i:integer = 0;

   while(i < DataContrSEM03Array.size)
      if( (DataContrSEM03Array[i].TradeNo == TradeNo) and (DataContrSEM03Array[i].BuySell == BuySell) )
         CPFirmId = DataContrSEM03Array[i].CPFirmId;
         break;
      end;
      i = i + 1;
   end;
end;

private macro ЗагрузитьКомиссииПо1ч(DataCommArray:TArray, TradeNo:string, BuySell:string, CLRCOMM:@money, ITSComm:@money)
   var i:integer = 0;

   while(i < DataCommArray.size)
      if( (DataCommArray[i].TradeNo == TradeNo) and (DataCommArray[i].BuySell == BuySell) )
         CLRCOMM = DataCommArray[i].CLRCOMM;
         ITSComm = DataCommArray[i].ITSComm;
         break;
      end;
      i = i + 1;
   end;
end;

private macro НевнутридневноеРЕПО(DataRepoArray:TArray, TradeNo1:string)
   var i:integer = 0, ret = true;
   while(i < DataRepoArray.size)
      if(DataRepoArray[i].TradeNo == TradeNo1)
         ret = false;
         break;
      end;
      i = i + 1;
   end;
   return ret;
end;

/*Поле BrokerRef - заполняется трейдером. Как правило: <код клиента>/<номер поручения>*/
PRIVATE MACRO GetClientCode_Req(BrokerRef:string):STRING
  var ClientCode = "", ClientCodeEndPos = 0;

  ClientCode = BrokerRef;
  if( ClientCode != "" )
     ClientCodeEndPos = Index( ClientCode, "/" );
     if( ClientCodeEndPos != 0 ) 
        ClientCode = SubStr( ClientCode, 1, ClientCodeEndPos-1 );
     end; 
  end;
  return ClientCode;
END;

private macro ЗагрузитьКодРасчетов2ч(DataSettleCode2Array:TArray, TradeNo:string, SettleCode2:@string)
   var i:integer = 0;

   while(i < DataSettleCode2Array.size)
      if( (DataSettleCode2Array[i].TradeNo == TradeNo) and (DataSettleCode2Array[i].RepoPart == 2) )
         SettleCode2 = DataSettleCode2Array[i].SettleCode;
         break;
      end;
      i = i + 1;
   end;
end;

private macro ЗаполнитьКсуДляРЕПО(DataKsuSEM03Array:TArray, SecurityId:string, SecurityType:@string)
   var i:integer = 0;

   while(i < DataKsuSEM03Array.size)
      if( DataKsuSEM03Array[i].SecurityId == SecurityId )
         SecurityType = "ксу";
         break;
      end;
      i = i + 1;
   end;
end;

/* получение данных о заявке */
PRIVATE MACRO PutRequestInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_REQUEST, 
                   String("Заявка на сделку №" + Req.OrderNo),
                   Создать );

   if(NOT RG.InitByCode(RG_REQUEST, Req.OrderNo, SOURCE_CODE) )
      Exit();
   end;

   if( strlen(trim(string(Req.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLRQ_KIND",       350/*DOCKIND_REQ_CLIENT_DEAL*/);
   RG.SetParmByName("RGDLRQ_CODE",       Req.OrderNo);
   RG.SetParmByName("RGDLRQ_CODETS",     Req.OrderNo);
   RG.SetParmByName("RGDLRQ_DATE",       Req.TradeDate);
   RG.SetParmByName("RGDLRQ_TIME",       Req.EntryTime);
   RG.SetParmByName("RGDLRQ_PARTY",      MMVB_Code);
   RG.SetParmByName("RGDLRQ_BUYSALE",    Req.BuySell);
   RG.SetParmByName("RGDLRQ_FIID",       Req.SecurityId); 
   RG.SetParmByName("RGDLRQ_AMOUNT",     Req.Quantity);
   RG.SetParmByName("RGDLRQ_PRICE",      Req.Price);
   RG.SetParmByName("RGDLRQ_REPORATE",   Req.RepoRate);
   RG.SetParmByName("RGDLRQ_STATUS",     Req.Status);
   RG.SetParmByName("RGDLRQ_PRICETYPE",  Req.PriceType);
   RG.SetParmByName("RGDLRQ_CURRENCYID", Req.CurrencyId);
   RG.SetParmByName("RGDLRQ_PRICEFIID",  Req.CurrencyId); // валюта цены = валюте расчетов

   var ClientCode:string = "";
   ClientCode = GetClientCode_Req(Req.BrokerRef);
   if( ClientCode == "" )
      ClientCode = Req.ClientCode;
   end;
   RG.SetParmByName("RGDLRQ_CLIENT", ClientCode);

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

PRIVATE MACRO import_request_to_gate(datafilename:STRING):INTEGER

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem02:object, child_Firm:object,
       child_Board:object, child_Activationdate:object;
   var DOC_REQUISITES = false, SEM02 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0;
   var stat:integer = 0;
   var NumImportReq:integer = 0, NumImportReqTotal:integer = 0;

   private macro IdentIsSEB()
      if( (Req.RepoValue == $0.0)
      AND (not Req.IsTrust)
      AND ((Req.BuySell == "B") OR (Req.BuySell == "S"))
      AND (Req.ClientCode == "")
      AND (GetClientCode_Req(Req.BrokerRef) == "") )
         if( PrevISIN != Req.SecurityId )
            ClearRecord(issues);
            ClearRecord(fin);
            RG_GetAvoirByISIN(Req.SecurityId,Код_на_ММВБ_ФинИн,issues,fin);
            PrevISIN = Req.SecurityId;
         end;
         if( fin.Issuer == {OurBank} )
            Req.IsSEB = true;
         end;
      end;
   end;

   private macro RunImp()
      ErrMes = "";

      NumImportReq = NumImportReq + 1;

      if(ProcessTrn( 0, "PutRequestInfo"))
         NumImportReqTotal = NumImportReqTotal + 1;
         RGLog.Message( "Заявка с кодом \"" + Req.OrderNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
      else
         RGLog.Error( "Ошибка при загрузке заявки с кодом \"" + Req.OrderNo + "\"\n" + ErrMes, RG );
         return 1;
      end;
      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   Req.Init();

   NumImportReq = 0;
   NumImportReqTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры заявок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM02")
            if(SEM02)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM02 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM02 = true;
            Req.TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Req.TradeDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM02 */
               child_Sem02 = child_MicexDoc.childNodes.item(j);
               if(child_Sem02 and (child_Sem02.nodeType==CHILD_NODE))

                  if(child_Sem02.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM02\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     if(GetDialogFlag())
                        InitProgress(child_Sem02.childNodes.length, "Загрузка внешнего файла заявок", "Просмотр режимов торгов...");
                     end;
                     while(k<child_Sem02.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem02.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "BOARD")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по BOARD */
                                 child_Board = child_Firm.childNodes.item(l);
                                 if(child_Board and (child_Board.nodeType==CHILD_NODE))

                                    if(child_Board.tagname == "ACTIVATIONDATE")
                                       m=0;
                                       if(GetDialogFlag())
                                          InitProgress(child_Board.childNodes.length, "Загрузка внешнего файла заявок", "Просмотр записей заявок...");
                                       end;
                                       while(m<child_Board.childNodes.length) /* бегаем по ACTIVATIONDATE */
                                          child_Activationdate = child_Board.childNodes.item(m);
                                          if(child_Activationdate and (child_Activationdate.nodeType==CHILD_NODE))

                                             if(child_Activationdate.tagname == "RECORDS")
                                                Req.InitRecords();

                                                ReadTagAttribut(child_Activationdate, "STATUS", V_STRING, Req.Status);
                                                if( (Req.Status != "O") and (Req.Status != "T") ) // из биржевого файла в систему импортируются заявки, статус которых отличается от <O> (активная> и <T> (ожидание активации).
                                                   ReadTagAttribut(child_Activationdate, "BUYSELL",    V_STRING,  Req.BuySell);
                                                   ReadTagAttribut(child_Activationdate, "ENTRYTIME",  V_TIME,    Req.EntryTime);
                                                   ReadTagAttribut(child_Activationdate, "TRADETIME",  V_TIME,    Req.TradeTime);
                                                   ReadTagAttribut(child_Activationdate, "AMENDTIME",  V_TIME,    Req.AmendTime);
                                                   ReadTagAttribut(child_Activationdate, "BROKERREF",  V_STRING,  Req.BrokerRef);
                                                   ReadTagAttribut(child_Activationdate, "ORDERNO",    V_STRING,  Req.OrderNo);
                                                   ReadTagAttribut(child_Activationdate, "REPORATE",   V_DOUBLE,  Req.RepoRate);
                                                   ReadTagAttribut(child_Activationdate, "RECNO",      V_INTEGER, Req.RecNo);
                                                   ReadTagAttribut(child_Activationdate, "SECURITYID", V_STRING,  Req.SecurityId);
                                                   ReadTagAttribut(child_Activationdate, "QUANTITY",   V_MONEY,   Req.Quantity);
                                                   ReadTagAttribut(child_Activationdate, "PRICE",      V_DOUBLE,  Req.Price);
                                                   ReadTagAttribut(child_Activationdate, "CLIENTCODE", V_STRING,  Req.ClientCode);
                                                   ReadTagAttribut(child_Activationdate, "PRICETYPE",  V_STRING,  Req.PriceType);
                                                   ReadTagAttribut(child_Activationdate, "CURRENCYID", V_STRING,  Req.CurrencyId);
                                                   ReadTagAttribut(child_Activationdate, "TRDACCID",   V_STRING,  Req.TrdAccId);
                                                   ReadTagAttribut(child_Activationdate, "REPOVALUE",  V_MONEY,   Req.RepoValue);

                                                   /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                   if(SubStr(Req.TrdAccId,1,1) == "D")
                                                      Req.IsTrust = true;
                                                   end;
                                                   IdentIsSEB();

                                                   if( IsFitDeal(Req.IsTrust, Req.IsSeb) )
                                                      if( RunImp() )
                                                         stat = 1;
                                                      end;
                                                   end;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if(GetDialogFlag())
                                             UseProgress(m);
                                          end;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                       if(GetDialogFlag())
                                          RemProgress(); 
                                       end;
                                    end;

                                 end;
                                 l = l + 1;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                           end;

                        end;
                        k = k + 1;
                        if(GetDialogFlag())
                           UseProgress(k);
                        end;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                     if(GetDialogFlag())
                        RemProgress(); 
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано заявок - " + string(NumImportReq) + "\nиз них успешно - " + string(NumImportReqTotal) + "\nошибочно - " + string(NumImportReq - NumImportReqTotal));

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro import_rates_to_gate_from( datafilename )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem21:object, child_Board:object;
   var DOC_REQUISITES = false, SEM21 = false;
   var i=0, j=0, k=0;
   var stat:integer = 0;

   private macro RunImp(RateKind)
      /* сохранение информации о курсе в промежуточном файле */
      if(WriteRateData(RateKind) != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   Rates.Init();

   NumImportRates = 0;
   NumImportRatesTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры котировок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM21")
            if(SEM21)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM21 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM21 = true;
            Rates.TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Rates.TradeDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            if(GetDialogFlag())
               InitProgress(child_MicexDoc.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр режимов торгов...");
            end;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM21 */
               child_Sem21 = child_MicexDoc.childNodes.item(j);
               if(child_Sem21 and (child_Sem21.nodeType==CHILD_NODE))

                  if(child_Sem21.tagname == "BOARD")
                      Rates.BoardID = "";
                      if(ReadTagAttribut(child_Sem21, "BOARDID", V_STRING, Rates.BoardID) == false)
                         /* если не нашли идентификатор режима торгов */
                      end;
                      Rates.BoardType = "";
                      if(ReadTagAttribut(child_Sem21, "BOARDTYPE", V_STRING, Rates.BoardType) == false)
                         /* если не нашли режим торгов */
                      end;
                      if((Rates.BoardType == "MAIN"/*если основной режим торгов*/)
                      or (/*(эмитент ц/б == {OurBank}) and*/ ((Rates.BoardID == "PSAU") or (Rates.BoardID == "PSBB") or (Rates.BoardID == "AUBB") or (Rates.BoardID == "AUCT")))) 
                          k=0;
                          if(GetDialogFlag())
                             InitProgress(child_Sem21.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр записей котировок...");
                          end;
                          while(k<child_Sem21.childNodes.length) /* бегаем по BOARD */
                             child_Board = child_Sem21.childNodes.item(k);
                             if(child_Board and (child_Board.nodeType==CHILD_NODE))

                                 if(child_Board.tagname == "RECORDS")
                                     Rates.InitRecords();
                                     if(ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Rates.SecurityId) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "SECURITYTYPE", V_STRING, Rates.SecurityType) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "DECIMALS", V_INTEGER, Rates.Decimals) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "VOLUME", V_INTEGER, Rates.Volume) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "CURRENCYID", V_STRING, Rates.CurrencyId) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "LOW", V_DOUBLE, Rates.Low) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "HIGH", V_DOUBLE, Rates.High) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "WAPRICE", V_DOUBLE, Rates.WAPrice) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "ACCINT", V_DOUBLE, Rates.AccInt) == false)
                                        /* если не нашли  */
                                     end;
                                     /*MarketPrice3 загружаем и в курс <Рыночная цена для НДФЛ> и в курс <Рыночная цена>*/
                                     if(ReadTagAttribut(child_Board, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice3) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "MP3VALTRD", V_DOUBLE, Rates.MP3ValTrd) == false)
                                        /* если не нашли  */
                                     end;
                                     if(ReadTagAttribut(child_Board, "PRICETYPE", V_STRING, Rates.PriceType) == false)
                                        /* если не нашли тип цены */
                                     end;
                                     if(ReadTagAttribut(child_Board, "FACEVALUE", V_DOUBLE, Rates.FaceValue) == false)
                                        /* если не нашли  */
                                     end;
                                     if(RunImp(RATE_KIND_MARKET))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_MIN))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_MAX))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_WA))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_NKD1SEC))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_VOLUME))
                                        stat = 1;
                                     end;
                                     if(RunImp(RATE_KIND_MARKET_TAX))
                                        stat = 1;
                                     end;
                                 end;
                             end;
                             k = k + 1;
                             if(GetDialogFlag())
                                UseProgress(k);
                             end;
                             if( FlagCtrlBrk == true )
                                break;
                             end;
                          end;
                          if(GetDialogFlag())
                             RemProgress(); 
                          end;
                      end;
                  end;

               end;
               j = j + 1;
               if(GetDialogFlag())
                  UseProgress(j);
               end;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
            if(GetDialogFlag())
               RemProgress(); 
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано котировок - " + string(NumImportRates) + "\nиз них успешно - " + string(NumImportRatesTotal) + "\nошибочно - " + string(NumImportRates - NumImportRatesTotal));

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/*ДЛя заключенных сделок РПС контрагента по сделке берем из файла исполненных сделок
  сделку ищем по параметрам TradeNo, BuySell*/
private macro GetContrFromEQM06(DataContrSEM03Array:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "";
   var PartyCode = "";
   var stat:integer = 0;
   var v=0, h=0;

   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "", datafilename_EQM06:string = "";

   if(MMVB_Code == MICEX_CODE_FB)
      stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, "Импорт контрагента из EQM06: ");
   end;

   if(stat)
      return;
   end;

   datafilename_EQM06 = data_filepath_EQM06 + data_filename_EQM06;
 
   if(GetDialogFlag())
      InitProgress(-1, "Поиск контрагента по сделке РПС в файле исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       q=0;
                                       while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                          child_InfType = child_Currency.childNodes.item(q);
                                          if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                             if(child_InfType.tagname == "CLEARINGTYPE")
                                                w=0;
                                                while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                   child_ClearingType = child_InfType.childNodes.item(w);
                                                   if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                      if(child_ClearingType.tagname == "SESSION")
                                                         e=0;
                                                         while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                            child_Session = child_ClearingType.childNodes.item(e);
                                                            if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                               if(child_Session.tagname == "SETTLEDATE")
                                                                  t=0;
                                                                  while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                     child_Settledate = child_Session.childNodes.item(t);
                                                                     if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                        if(child_Settledate.tagname == "INSTRTRADE")
                                                                           h=0;
                                                                           while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                              child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                              if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                 if(child_InstrTrade.tagname == "BOARD")
                                                                                    m=0;
                                                                                    while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                       child_Board = child_InstrTrade.childNodes.item(m);
                                                                                       if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                          if(child_Board.tagname == "SECURITY")
                                                                                             s=0;
                                                                                             while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                child_Security = child_Board.childNodes.item(s);
                                                                                                if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                   if(child_Security.tagname == "RECORDS")
                                                                                                      TradeNo = "";
                                                                                                      if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                      end;
                                                                        
                                                                                                      BuySell = "";
                                                                                                      if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                                                      end;
                                                                        
                                                                                                      v = 0;
                                                                                                      while( v < DataContrSEM03Array.size )
                                                                                                         if( (TradeNo == DataContrSEM03Array[v].TradeNo) AND (BuySell == DataContrSEM03Array[v].BuySell)  )
                                                                                                            PartyCode = "";
                                                                                                            if(ReadTagAttribut(child_Security, "CPFIRMID", V_STRING, PartyCode) == false)
                                                                                                                /* если не нашли идентификатор фирмы партнера */
                                                                                                            end;
                                                                        
                                                                                                            if( (PartyCode != null) and (PartyCode != "") )
                                                                                                               DataContrSEM03Array[v].CPFIRMID = PartyCode;
                                                                                                            end;
                                                                                                         end;
                                                                                                         v = v + 1;
                                                                                                      end;
                                                                        
                                                                                                   end;
                                                                                                end;
                                                                                                s = s + 1;
                                                                                             end;
                                                                                          end;
                                                                                       end;
                                                                                       m = m + 1;
                                                                                    end;
                                                                                 end;
                                                                              end;
                                                                              h = h + 1;
                                                                           end;
                                                                        end;
                                                                     end;
                                                                     t = t + 1;
                                                                  end;
                                                               end;
                                                            end;
                                                            e = e + 1;
                                                         end;
                                                      end;
                                                   end;
                                                   w = w + 1;
                                                end;
                                             end;
                                          end;
                                          q = q + 1;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/*здесь собираем комиссии по сделкам (1 частям) и заодно
  суммовые параметры по секции InfType == 3 по 2 частям РЕПО*/
private macro GetCommFromEQM06(DataCommArray:@TArray, DataRepoArray:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "";
   var stat:integer = 0;
   var RepoPart:integer = 0;
   var ClrComm = $0.0, ITSComm = $0.0;

   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "", datafilename_EQM06:string = "";
   var Amount:money = $0.0, AccInt2:money = $0.0, Price2:double = $0.0, Value_:money = $0.0;

   if(MMVB_Code == MICEX_CODE_FB)
      stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, "Импорт комиссии из EQM06: ");
   end;

   if(stat)
      return;
   end;

   datafilename_EQM06 = data_filepath_EQM06 + data_filename_EQM06;
 
   if(GetDialogFlag())
      InitProgress(-1, "Сбор данных по комиссиям из файла исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( (InfType == 2) OR (InfType == 3) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                               
                                                                                                         if(ReadTagAttribut(child_Security, "CLRCOMM", V_MONEY, ClrComm) == false)
                                                                                                         end;
                                                                                                         if(ReadTagAttribut(child_Security, "ITSCOMM", V_MONEY, ITSComm) == false)
                                                                                                         end;
                                                                                  
                                                                                                         if( ((RepoPart == 0) OR (RepoPart == 1)) AND ((ClrComm>$0.0) or (ITSComm>$0.0)) )
                                                                                                            TradeNo = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                            end;
                                                                                                            BuySell = "";
                                                                                                            if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                                                            end;
                                                                                                           
                                                                                                            if( (TradeNo != "") AND (BuySell != "") )
                                                                                                               DataCommArray[DataCommArray.size] = CommData(TradeNo,BuySell,ClrComm,ITSComm);
                                                                                                            end;
                                                                                                         end;
                                                                                  
                                                                                                         /*суммовые параметры по секции InfType == 3 по 2 частям РЕПО
                                                                                                           эти суммы вместо незаполненных по 2 части пойдут в ЗР по сделке*/
                                                                                                         if( (RepoPart == 2) and (InfType == 3) )
                                                                                                            TradeNo = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                            end;
                                                                                                            Amount = $0.0;
                                                                                                            if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Amount) == false)
                                                                                                            end;
                                                                                                            AccInt2 = $0.0;
                                                                                                            if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, AccInt2) == false)
                                                                                                            end;
                                                                                                            Price2 = 0.0;
                                                                                                            if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Price2) == false)
                                                                                                            end;
                                                                                                            Value_ = $0.0;
                                                                                                            if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Value_) == false)
                                                                                                            end;
                                                                                                            /* вытащили все данные */
                                                                                                            DataRepoArray[DataRepoArray.size] = DataRepo(TradeNo, Amount, Date(0,0,0), AccInt2, Price2, Value_);
                                                                                                         end;

                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetInfoFromCCX99(DataArray:@TArray)
    var xml:object = ActiveX( "MSXML.DOMDocument" );
    var node:object, child_MicexDoc:object, child_CCX99:object, child_ExtSettleCode:object, child_Statement:object, child_Entry:object;
    var i = 0, j = 0, k = 0, l = 0;
    var stat = 0;
    var data_filepath_CCX99 = "", data_filename_CCX99 = "", datafilename_CCX99 = "";
    var DOC_REQUISITES = false, CCX99 = false;
    var ID = 0, Debit = 0, EntryDate = date(0, 0, 0), CodeType = 0, Account = "", PurposePayment = "";
/*ak*/
    var Pay_Acc = "", Rec_Acc = "", Credit = 0, Number = "", Cor_Acc = "", res = true;
/*~ak*/

    stat = get_data_file_name("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_CCX99);
    if(stat)
        return false;
    end;

    datafilename_CCX99 = data_filepath_CCX99 + data_filename_CCX99;
    if(GetDialogFlag())
        InitProgress(-1, "Поиск движений денежных средств для перевода с другого клирингового счета", "Просмотр данных...");
    end;

    if(not xml.load(datafilename_CCX99))
        RGLog.Error( "Неверный формат файла импорта|", datafilename_CCX99, "|Невозможно загрузить xml-документ" );
        return false;
    end;

    node = xml.DocumentElement;
    i = 0;
    while(i < node.ChildNodes.Length)
        child_MicexDoc = node.childNodes.item(i);
        if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
                RGLog.Error(string(datafilename_CCX99, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
                return false;
            end;
            DOC_REQUISITES = true;
        end;

        if(child_MicexDoc.tagname == "CCX99")
            if(CCX99)
                RGLog.Error(string(datafilename_CCX99, ": Блок MICEX_DOC\CCX99 должен присутствовать в единственном экземпляре"));
                return false;
            end;
            CCX99 = true;

            j = 0;
            while(j < child_MicexDoc.ChildNodes.Length)
                child_ExtSettleCode = child_MicexDoc.ChildNodes.item(j);
                if(child_ExtSettleCode.tagname == "EXTSETTLECODE")
                    ID = 0;
                    if(ReadTagAttribut(child_ExtSettleCode, "ID", V_INTEGER, ID) == false)

                    end;
                    /*ak - Код должен быть либо нашим (01356 и 13385)
                           либо клиентским (06263,10120,10121,10122,10123,10124,10125,10126,11140,11139)*/
                    if((valtype(ID) == V_INTEGER) and ((ID ==  1356) or
                                                       (ID == 13385) or
                                                       (ID ==  6263) or
                                                       (ID == 10120) or
                                                       (ID == 10121) or
                                                       (ID == 10122) or
                                                       (ID == 10123) or
                                                       (ID == 10124) or
                                                       (ID == 10125) or
                                                       (ID == 10126) or
                                                       (ID == 11140) or
                                                       (ID == 11139)))

                      k = 0;
                      while(k < child_ExtSettleCode.childNodes.Length)
                          child_Statement = child_ExtSettleCode.childNodes.item(k);
                          if(child_Statement.tagname == "STATEMENT")
                              Account = "";
                              if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, Account) == false)
                              end;

                              l = 0;
                              while(l < child_Statement.childNodes.Length)
                                  child_Entry = child_Statement.childNodes.item(l);
                                  CodeType = 0;
                                  Debit = $0.0;
                                  EntryDate = date(0, 0, 0);
                                  PurposePayment = "";
                                  /*ak*/
                                  Pay_Acc = "";
                                  Rec_Acc = "";
                                  Credit = $0.0;
                                  Number = "";
                                  Cor_Acc = "";
                                  /*~ak*/
                                  if(child_Entry.tagname == "ENTRY")
                                      if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, CodeType) == false)
                                      end;
/*
                                      /*ak - Тип кода должен быть 916 или 918*/
                                      if((valtype(CodeType) == V_INTEGER) and ((CodeType == 916) or (CodeType == 918) or (CodeType == 812)))
                                      /*~ak*/
                                        /*ak - Для 916 балансовый PAY_ACC должен быть 30411, 
                                               а для 918 REC_ACC 30411*/

                                        if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, Pay_Acc) == false)
                                        end;

                                        if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, Rec_Acc) == false)
                                        end;

                                        if(((CodeType == 916) and (valtype(Pay_Acc) == V_STRING) and (substr(Pay_Acc,1,5) == "30411")) or
                                           (((CodeType == 918) or (CodeType == 812)) and (valtype(Rec_Acc) == V_STRING) and (substr(Rec_Acc,1,5) == "30411")))
                                        /*~ak*/

                                          if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, Number) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "COR_ACC", V_STRING, Cor_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, Debit) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, Credit) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "DATE", V_DATE, EntryDate) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, PurposePayment) == false)
                                          end;

                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, 		/*_StatementAcc*/ 
                                                                                      CodeType, 	/*_EntryCodeType*/
                                                                                      Number, 		/*_EntryNumber*/
                                                                                      Cor_Acc, 		/*_EntryCorAcc*/
                                                                                      PurposePayment, 	/*_EntryPurposePayment*/
                                                                                      Debit, 		/*_EntryDebit*/
                                                                                      Credit, 		/*_EntryCredit*/
                                                                                      EntryDate, 	/*_EntryDate*/
                                                                                      Pay_Acc, 		/*_EntryPayAcc*/
                                                                                      Rec_Acc, 		/*_EntryRecAcc*/
                                                                                      ID); 		/*_ExtSettleCodeID*/

                                        end;
*/
                                      /*20 и задан DEBIT*/
                                      if((valtype(CodeType) == V_INTEGER) and (CodeType == 20))

                                        if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, Debit) == false)
                                        end;

                                        if((valtype(Debit) == V_MONEY) and (Debit > 0))

                                          if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, Credit) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, Pay_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, Rec_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, Number) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "DATE", V_DATE, EntryDate) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, PurposePayment) == false)
                                          end;

                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, 		/*_StatementAcc*/ 
                                                                                      CodeType, 	/*_EntryCodeType*/
                                                                                      Number, 		/*_EntryNumber*/
                                                                                      Cor_Acc, 		/*_EntryCorAcc*/
                                                                                      PurposePayment, 	/*_EntryPurposePayment*/
                                                                                      Debit, 		/*_EntryDebit*/
                                                                                      Credit, 		/*_EntryCredit*/
                                                                                      EntryDate, 	/*_EntryDate*/
                                                                                      Pay_Acc, 		/*_EntryPayAcc*/
                                                                                      Rec_Acc, 		/*_EntryRecAcc*/
                                                                                      ID); 		/*_ExtSettleCodeID*/

                                        end;

                                      end;
                                      /*~ak*/

                                      /*ak - Все не так
                                      if((Debit > 0) and ((CodeType == 20) or (CodeType == 813)))
                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, Debit, $0.0, EntryDate, "", "", ID);
                                      end;~ak*/
                                  end;

                                  l = l + 1;
                              end;
                          end;

                          k = k + 1;
                      end;
                    end;
                end;

                j = j + 1;
            end;
        end;

        i = i + 1;
    end;

    if(GetDialogFlag())
        RemProgress();
    end;

    /*ak*/
     return res;
    /*~ak*/

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
end;

/*Для сделок РПС контрагента по сделке берем из файла исполненных сделок,
  сделку ищем по параметрам TradeNo, BuySell, но если в EQM06 контрагент не указан, то пытаемся найти в SEM03*/
private macro GetInfoFromSEM03( DataContrSEM03Array:@TArray, DataKsuSEM03Array:@TArray, OnlyN:bool )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem03:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, SEM03 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var data_filepath_SEM03:string = "", data_filename_SEM03:string = "", datafilename_SEM03:string = "";
   var TrdAccId:string = "", IsTrust = false, TradeNo:string = "", BuySell:string = "", TradeType:string = "", CPFirmId:string = "", SecurityType:string = "", SecurityId:string = "";
   var SettleDate = date(0,0,0), TradeDate = date(0,0,0);
   var OnlyN_ = false, RepoValue = $0.0;
   var IsSEB = false, ClientCode = "", BrokerRef = "";


   private macro IdentIsSEB()
      if( (RepoValue == $0.0)
      AND (not IsTrust)
      AND ((BuySell == "B") OR (BuySell == "S"))
      AND (ClientCode == "")
      AND (GetClientCode_Req(BrokerRef) == "") )
         if( PrevISIN != SecurityId )
            ClearRecord(issues);
            ClearRecord(fin);
            RG_GetAvoirByISIN(SecurityId,Код_на_ММВБ_ФинИн,issues,fin);
            PrevISIN = SecurityId;
         end;
         if( fin.Issuer == {OurBank} )
            IsSEB = true;
         end;
      end;
   end;

   if( OnlyN != NULL )
      OnlyN_ = OnlyN;
   end;

   if(MMVB_Code == MICEX_CODE_FB)
      stat = get_data_file_name("DEALX", "SEM03", @data_filepath_SEM03, @data_filename_SEM03);
   end;

   if(stat)
      return;
   end;

   datafilename_SEM03 = data_filepath_SEM03 + data_filename_SEM03;

   if(GetDialogFlag())
      InitProgress(-1, "Поиск сделок РПС в файле заключенных сделок с заданным значением контрагента", "Просмотр данных...");
   end;
   
   /* откроем файл импорта */
   if( not xml.load(datafilename_SEM03) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_SEM03, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM03")
            if(SEM03)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM03 = true;
            TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, TradeDate) == false)
               /* если не нашли дату торгов */
            end;
            if( TradeDate == date(0,0,0) )
               TradeDate = imp_date;
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM03 */
               child_Sem03 = child_MicexDoc.childNodes.item(j);
               if(child_Sem03 and (child_Sem03.nodeType==CHILD_NODE))

                  if(child_Sem03.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Sem03.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem03.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "BOARD")
                                       m=0;
                                       while(m<child_Currency.childNodes.length) /* бегаем по BOARD */
                                          child_Board = child_Currency.childNodes.item(m);
                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                             if(child_Board.tagname == "SETTLEDATE")
                                                SettleDate = date(0,0,0);
                                                if(ReadTagAttribut(child_Board, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                    /* если не нашли фактическую дату расчётов */
                                                end;
                                                n=0;
                                                while(n<child_Board.childNodes.length) /* бегаем по SETTLEDATE */
                                                   child_Settledate = child_Board.childNodes.item(n);
                                                   if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                      if(child_Settledate.tagname == "SECURITY")
                                                         SecurityId = "";
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYID", V_STRING, SecurityId) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         SecurityType = "";
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYTYPE", V_STRING, SecurityType) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         if( (DataKsuSEM03Array != null) and ( ЭтоКСУ(SecurityType) ) )
                                                            DataKsuSEM03Array[DataKsuSEM03Array.size] = KsuData(SecurityId);
                                                         end;
                                                         s=0;
                                                         while(s<child_Settledate.childNodes.length) /* бегаем по SECURITY */
                                                            child_Security = child_Settledate.childNodes.item(s);
                                                            if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                                               if(child_Security.tagname == "TRDACC")
                                                                  TrdAccId = "";
                                                                  if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                      /* если не нашли торговый счет, в счет которого заключена данная сделка */
                                                                  end;
                                                                  /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                  if(SubStr(TrdAccId,1,1) == "D")
                                                                     IsTrust = true;
                                                                  else
                                                                     IsTrust = false;
                                                                  end;
                                                                  IsSEB = false;
                                                                  r=0;
                                                                  while(r<child_Security.childNodes.length) /* бегаем по TRDACC */
                                                                     child_Trdacc = child_Security.childNodes.item(r);
                                                                     if(child_Trdacc and (child_Trdacc.nodeType==CHILD_NODE))

                                                                        if(child_Trdacc.tagname == "RECORDS")
                                                                           TradeNo = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADENO", V_STRING, TradeNo) == false)
                                                                               /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           BuySell = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "BUYSELL", V_STRING, BuySell) == false)
                                                                               /* если не нашли направленность заявки */
                                                                           end;
                                                                           TradeType = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADETYPE", V_STRING, TradeType) == false)
                                                                               /* если не нашли тип сделки */
                                                                           end;
                                                                           CPFirmId = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "CPFIRMID", V_STRING, CPFirmId) == false)
                                                                               /* если не нашли идентификатор фирмы партнера */
                                                                           end;

                                                                           if(ReadTagAttribut(child_Trdacc, "REPOVALUE", V_MONEY, RepoValue) == false)
                                                                               /* если не нашли сумму РЕПО */
                                                                           end;
                                                                           ClientCode = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "CLIENTCODE", V_STRING, ClientCode) == false)
                                                                               /* если не нашли краткий код клиента */
                                                                           end;
                                                                           BrokerRef = "";
                                                                           if(ReadTagAttribut(child_Trdacc, "BROKERREF", V_STRING, BrokerRef) == false)
                                                                               /* если не нашли примечание */
                                                                           end;

                                                                           IdentIsSEB();

                                                                           if( IsFitDeal(IsTrust, IsSEB) AND
                                                                               ( ((OnlyN_ == true) and (TradeType == "N")) or (OnlyN_ == false) )
                                                                             )
                                                                              if( CPFirmId == "" )
                                                                                 /*для СделкаToday (не срочных и не РЕПО) в качестве контрагента ставим субъекта с принадлежностью 'Центральный контрагент'*/
                                                                                 if( ( RepoValue == $0.0 ) AND 
                                                                                     (SettleDate == TradeDate) AND (TradeDate >= date(1,11,2011))
                                                                                   )
                                                                                    RG_GetCentralContr(@CPFirmId);
                                                                                 end;
                                                                              end;
                                                                              DataContrSEM03Array[DataContrSEM03Array.size] = CPFirmData(TradeNo, BuySell, CPFirmId);
                                                                           end;

                                                                         end;
                                                                     end;
                                                                     r = r + 1;
                                                                  end;
                                                               end;
                                                            end;
                                                            s = s + 1;
                                                         end;
                                                      end;

                                                   end;
                                                   n = n + 1;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                       end;
                                    end;
                             
                                 end;
                                 l = l + 1;
                              end;
                           end;

                        end;
                        k = k + 1;
                     end;
                  end;

               end;
               j = j + 1;
            end;
         end;

      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetSettleCode2FromEQM06(DataSettleCode2Array:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "";
   var stat:integer = 0;
   var RepoPart:integer = 0;
   var SettleCode2 = "";

   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "", datafilename_EQM06:string = "";

   if(MMVB_Code == MICEX_CODE_FB)
      stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, "Импорт кода по второй части из EQM06: ");
   end;

   if(stat)
      return;
   end;

   datafilename_EQM06 = data_filepath_EQM06 + data_filename_EQM06;
 
   if(GetDialogFlag())
      InitProgress(-1, "Сбор данных по комиссиям из файла исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( (InfType == 2) OR (InfType == 3) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                               
                                                                                                         if( RepoPart == 2 )
                                                                                                            TradeNo = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                            end;
                                                                                                            BuySell = "";
                                                                                                            if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                                                            end;
                                                                                                            SettleCode2 = "";
                                                                                                            if(ReadTagAttribut(child_Security, "SETTLECODE", V_STRING, SettleCode2) == false)
                                                                                                            /* если не нашли код расчётов по сделке */
                                                                                                            end;
                                                                                                            if( TradeNo != "" )
                                                                                                               DataSettleCode2Array[DataSettleCode2Array.size] = SettleCodeData(TradeNo,RepoPart,SettleCode2);
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetRecsAfterLoad_SEM03()
   var NumImportDealsTotal_DV = 0;

   RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT,"Документ-подтверждение \"Отчет биржи\" успешно загружен\n",null,true);
   RGLog.GetAndAddReceiveLoadRecs(RG_SECURDEAL,"Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotal);
   RGLog.GetAndAddReceiveLoadRecs(RG_DVNDEAL,"Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotal_DV);

   NumImportDealsTotal = NumImportDealsTotal + NumImportDealsTotal_DV;
end;

private macro GetRecsAfterLoad_EQM06()
   RGLog.GetAndAddReceiveLoadRecs(27,"Клиринг. Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotalCliring);
end;

// предварительно определить некоторые параметры сделки (нужно для определения сделок СЭБ)
private macro SetPartPrmDeal()
   if(FileImport == FileSEM03)
      Deals.IsREPO = (Deals.RepoValue != $0.0);
   else
      Deals.IsREPO = (Deals.RepoPart > 0);
   end;

   if(Deals.IsREPO)
      if( Deals.IsCliring )
         if( Deals.RepoPart == 1 )
            Deals.GateDealType = "R" + Deals.BuySell;
         else
            if( Deals.BuySell == "B" )
               Deals.GateDealType = "RS";
            else
               Deals.GateDealType = "RB";
            end;
         end;
      else
         Deals.GateDealType = "R" + Deals.BuySell;
      end;

      if( ЭтоКСУ(Deals.SecurityType) )/*для РЕПО с КСУ*/
         Deals.GateDealType = Deals.GateDealType + "G";
      end;

   else
      Deals.GateDealType = Deals.BuySell;
   end;

   if(Deals.ClientCode != "")
      Deals.vClientCode = Deals.ClientCode;
   else
      GetClientCode(Deals.BrokerRef, @Deals.vClientCode);
   end;

   if( ((FileImport == FileSEM03) or (FileImport == FileEQM06)) AND (not Deals.IsREPO) )
      if( PrevISIN != Deals.SecurityId )
         ClearRecord(issues);
         ClearRecord(fin);
         RG_GetAvoirByISIN(Deals.SecurityId,Код_на_ММВБ_ФинИн,issues,fin);
         PrevISIN = Deals.SecurityId;
      end;
      if( (not Deals.IsTrust) AND (Deals.vClientCode == "") AND (fin.Issuer == {OurBank}) AND ((Deals.GateDealType == "B") OR (Deals.GateDealType == "S")) )
         Deals.IsSEB = true;
      end;
   end;
end;

private macro import_deals_to_gate_from( datafilename_SEM03 )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Sem03:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, SEM03 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var PartyCode:string = "";
   var DataCommArray = TArray(); DataCommArray.size = 0;
   var DataContrSEM03Array = TArray(); DataContrSEM03Array.size = 0;
   var DataSettleCode2Array = TArray(); DataSettleCode2Array.size = 0;
   var DataRepoArray = TArray(); DataRepoArray.size = 0;

   var v=0;

   FileImport = FileSEM03;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   /*соберем сделки РПС из файла SEM03*/
   GetInfoFromSEM03(@DataContrSEM03Array, null, false);
   /*для сделок РПС контрагента возьмем из EQM06 (только если в EQM06 контрагент заполнен)*/
   GetContrFromEQM06(@DataContrSEM03Array);

   /*собираем комиссии по сделкам (1 частям) и заодно суммовые параметры по секции InfType == 3 по 2 частям РЕПО*/
   GetCommFromEQM06(@DataCommArray, @DataRepoArray);

   /*получить код по 2 ч для определения даты исполнения 2 ч*/
   //GetSettleCode2FromEQM06(@DataSettleCode2Array);

   /* откроем файл импорта */
   if( not xml.load(datafilename_SEM03) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_SEM03, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
            Deals.DOC_NO = "";
            if(ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, Deals.DOC_NO) == false)
               /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
            end;
         end;

         if(child_MicexDoc.tagname == "SEM03")
            if(SEM03)
               RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM03 = true;
            Deals.TradeDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Deals.TradeDate) == false)
               /* если не нашли дату торгов */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM03 */
               child_Sem03 = child_MicexDoc.childNodes.item(j);
               if(child_Sem03 and (child_Sem03.nodeType==CHILD_NODE))

                  if(child_Sem03.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_SEM03, ": Блок MICEX_DOC\SEM03\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     if(GetDialogFlag())
                        InitProgress(child_Sem03.childNodes.length, "Загрузка внешнего файла сделок", "Просмотр сделок по валютам расчёта...");
                     end;
                     while(k<child_Sem03.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem03.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              Deals.CurrencyId = "";
                              if(ReadTagAttribut(child_Firm, "CURRENCYID", V_STRING, Deals.CurrencyId) == false)
                                  /* если не нашли идентификатор валюты расчётов */
                              end;
                              l=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Firm.childNodes.length, "Загрузка внешнего файла сделок", "Просмотр сделок по режимам торгов...");
                              end;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))

                                    if(child_Currency.tagname == "BOARD")
                                       Deals.BoardId = "";
                                       if(ReadTagAttribut(child_Currency, "BOARDID", V_STRING, Deals.BoardId) == false)
                                       end;
                                       m=0;
                                       while(m<child_Currency.childNodes.length) /* бегаем по BOARD */
                                          child_Board = child_Currency.childNodes.item(m);
                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))

                                             if(child_Board.tagname == "SETTLEDATE")
                                                Deals.SettleDate = date(0,0,0);
                                                if(ReadTagAttribut(child_Board, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                                    /* если не нашли фактическую дату расчётов */
                                                end;
                                                n=0;
                                                while(n<child_Board.childNodes.length) /* бегаем по SETTLEDATE */
                                                   child_Settledate = child_Board.childNodes.item(n);
                                                   if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))

                                                      if(child_Settledate.tagname == "SECURITY")
                                                         Deals.SecurityId = ""; Deals.FaceValue = 0.0;
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYID", V_STRING, Deals.SecurityId) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         if(ReadTagAttribut(child_Settledate, "SECURITYTYPE", V_STRING, Deals.SecurityType) == false)
                                                             /* если не нашли идентификатор финансового инструмента */
                                                         end;
                                                         if(ReadTagAttribut(child_Settledate, "FACEVALUE", V_DOUBLE, Deals.FaceValue) == false)
                                                             /* если не нашли номинальную стоимость одной ценной бумаги, в валюте инструмента */
                                                         end;
                                                         if(ReadTagAttribut(child_Settledate, "PRICETYPE", V_STRING, Deals.PriceType) == false)
                                                             /* если не нашли тип цены */
                                                         end;
                                                         s=0;
                                                         while(s<child_Settledate.childNodes.length) /* бегаем по SECURITY */
                                                            child_Security = child_Settledate.childNodes.item(s);
                                                            if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                                               if(child_Security.tagname == "TRDACC")
                                                                  Deals.TrdAccId = "";
                                                                  if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, Deals.TrdAccId) == false)
                                                                      /* если не нашли торговый счет, в счет которого заключена данная сделка */
                                                                  end;
                                                                  /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                  if(SubStr(Deals.TrdAccId,1,1) == "D")
                                                                     Deals.IsTrust = true;
                                                                  else
                                                                     Deals.IsTrust = false;
                                                                  end;
                                                                  r=0;
                                                                  if(GetDialogFlag())
                                                                     InitProgress(child_Security.childNodes.length, "Загрузка внешнего файла сделок", "Загрузка сделок...");
                                                                  end;
                                                                  while(r<child_Security.childNodes.length) /* бегаем по TRDACC */
                                                                     child_Trdacc = child_Security.childNodes.item(r);
                                                                     if(child_Trdacc and (child_Trdacc.nodeType==CHILD_NODE))

                                                                        if(child_Trdacc.tagname == "RECORDS")
                                                                           Deals.InitRecords();
                                                                           if(ReadTagAttribut(child_Trdacc, "RECNO", V_STRING, Deals.RecNo) == false)
                                                                               /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                                               /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADETIME", V_TIME, Deals.TradeTime) == false)
                                                                               /* если не нашли время регистрации сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "BUYSELL", V_STRING, Deals.BuySell) == false)
                                                                               /* если не нашли направленность заявки */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "SETTLECODE", V_STRING, Deals.SettleCode) == false)
                                                                               /* если не нашли код расчётов по сделке */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "DECIMALS", V_INTEGER, Deals.Decimals) == false)
                                                                               /* если не нашли число значимых знаков после запятой */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "PRICE", V_DOUBLE, Deals.Price) == false)
                                                                               /* если не нашли цену за одну ценную бумагу */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "QUANTITY", V_MONEY, Deals.Quantity) == false)
                                                                               /* если не нашли объём сделки, в ценных бумагах */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "VALUE", V_MONEY, Deals.Value_) == false)
                                                                               /* если не нашли объём сделки, в валюте расчётов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "AMOUNT", V_MONEY, Deals.Amount) == false)
                                                                               /* если не нашли сумму сделки, в валюте расчётов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                               /* если не нашли объём комиссии по заключенной сделке за торги */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "ORDERNO", V_STRING, Deals.OrderNo) == false)
                                                                               /* если не нашли номер заявки */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "ACCINT", V_MONEY, Deals.AccInt) == false)
                                                                               /* если не нашли накопленный купонный доход */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "CPFIRMID", V_STRING, Deals.CPFirmId) == false)
                                                                               /* если не нашли идентификатор фирмы партнера */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "REPOVALUE", V_MONEY, Deals.RepoValue) == false)
                                                                               /* если не нашли сумму РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "REPOPERIOD", V_INTEGER, Deals.RepoPeriod) == false)
                                                                               /* если не нашли срок РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "REPORATE", V_DOUBLE, Deals.RepoRate) == false)
                                                                               /* если не нашли ставку РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "TRADETYPE", V_STRING, Deals.TradeType) == false)
                                                                               /* если не нашли тип сделки */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "PRICE2", V_DOUBLE, Deals.Price2) == false)
                                                                               /* если не нашли цену выкупа второй части РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "ACCINT2", V_MONEY, Deals.AccInt2) == false)
                                                                               /* если не нашли накопленный купонный доход на дату исполнения */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "CLIENTCODE", V_STRING, Deals.ClientCode) == false)
                                                                               /* если не нашли краткий код клиента */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "MATCHREF", V_STRING, Deals.MatchRef) == false)
                                                                               /* если не нашли поле "Ссылка" (заполняется при вводе заявки) */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Trdacc, "BROKERREF", V_STRING, Deals.BrokerRef) == false)
                                                                               /* если не нашли примечание */
                                                                           end;
                                                                           /*ak*/
                                                                           if(ReadTagAttribut(child_Trdacc, "ORDTYPECODE", V_STRING, Deals.OrdTypeCode) == false)
                                                                               /* если не нашли примечание */
                                                                           end;
                                                                           /*ak*/

                                                                           /* вытащили все данные по сделке, теперь обработаем и вставим */
                                                                           SetPartPrmDeal();

                                                                           if( IsFitDeal(Deals.IsTrust, Deals.IsSEB) )
                                                                              /*сделка РПС ? контрагента берем из EQM06, если в EQM06 он задан*/
                                                                              if( Deals.TradeType == "N" )
                                                                                 v = 0;
                                                                                 while( v < DataContrSEM03Array.size )
                                                                                    if( (Deals.TradeNo == DataContrSEM03Array[v].TradeNo) AND (Deals.BuySell == DataContrSEM03Array[v].BuySell) )
                                                                                       Deals.CPFirmId = DataContrSEM03Array[v].CPFirmId;
                                                                                    end;
                                                                                    v = v + 1;
                                                                                 end;
                                                                              end;

                                                                              if( not IsDVnDealData() )/*если сделка грузится в ПИ, то комиссии и 2 ч. не нужны (пока)*/
                                                                                 ЗагрузитьКомиссииПо1ч(DataCommArray, Deals.TradeNo, Deals.BuySell, @Deals.CLRCOMM, @Deals.ITSComm);
                                                                                 
                                                                                 //ЗагрузитьКодРасчетов2ч(DataSettleCode2Array, Deals.TradeNo, @Deals.SettleCode2);
                                                                                 
                                                                                 /*заполнить недостающие(нулевые) параметры по 2 ч РЕПО из файла клиринга секции inftype = 3*/
                                                                                 ДозаполнитьРЕПО2ч(DataRepoArray, Deals.TradeNo,
                                                                                                   @Deals.AccInt2, @Deals.Amount2, @Deals.Value2_, @Deals.Price2);
                                                                              end;

                                                                              if(RunImp())
                                                                                 stat = 1;
                                                                              end;
                                                                           end;

                                                                         end;
                                                                     end;
                                                                     r = r + 1;
                                                                     if(GetDialogFlag())
                                                                        UseProgress(r);
                                                                     end;
                                                                     if( FlagCtrlBrk == true )
                                                                        break;
                                                                     end;
                                                                  end;
                                                                  if(GetDialogFlag())
                                                                     RemProgress(); 
                                                                  end;
                                                               end;
                                                            end;
                                                            s = s + 1;
                                                            if( FlagCtrlBrk == true )
                                                               break;
                                                            end;
                                                         end;
                                                      end;

                                                   end;
                                                   n = n + 1;
                                                   if( FlagCtrlBrk == true )
                                                      break;
                                                   end;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                    end;
                             
                                 end;
                                 l = l + 1;
                                 if(GetDialogFlag())
                                    UseProgress(l);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress(); 
                              end;
                           end;

                        end;
                        k = k + 1;
                        if(GetDialogFlag())
                           UseProgress(k);
                        end;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                     if(GetDialogFlag())
                        RemProgress(); 
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   if( not FlagCtrlBrk )
      RG.Transfer();
      SetErrAfterLoad(true);
   end;

   /*загрузить в лог инфу о загруженных ЗР*/
   GetRecsAfterLoad_SEM03();

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано сделок из SEM03 - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro import_deals_to_gate_from_CCX99( datafilename_CCX99 )
   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Requisites:object, child_CCX99:object,
       child_ExtSettleCode:object, child_Statement:object, child_Entry:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, CCX99 = false, EXTSETTLECODE = false, STATEMENT = false, ENTRY = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var DataOtherKlirArray = TArray(); DataOtherKlirArray.Size = 0;

   const AccountCode = "01054";

   FileImport = FileCCX99;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
       VAR NoError = true;
       ErrMes = "";
       WarnMes = "";
       if(ProcessTrn(0, "PutMoneyMotion"))
          RGLog.Message( "Движение денежных средств с номером \"" + MoneyMotion.EntryNumber + "\" уcпешно загружено в шлюз" + ErrMes, RG, SUCCESS );
       else
          RGLog.Error( "Ошибка при вставке движения денежных средств\n" + ErrMes, RGMkRep );
          return 1;
       end;
       return 0;

    OnError(ErObj)

       RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
 
       if(ErObj.Code == CtrlBrkErr)
          FlagCtrlBrk = true;
       else
          RemProgress();
          RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
       end;
       return ErObj.Code;
   end;

   //Собираем движения денежных средств для сравнения с CODETYPE = 20 и CODETYPE = 813
   /*ak - Завершаем обработку при ошибке*/
   if(not GetInfoFromCCX99(@DataOtherKlirArray))
     return false;
   end;
   /*~ak*/

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   /*ak - Все необходимые данные у нас в массиве DataOtherKlirArray, второй раз обход файла делать не будем

   var iarr = 0;
   var res = true;
   while(iarr < DataOtherKlirArray.size)
     MoneyMotion = DataOtherKlirArray[iarr];
     if(RunImp() > 0)
       if(res)
         res = false;
       end;
     end;
     iarr = iarr + 1;
     if(FlagCtrlBrk == true)
        break;
     end;
   end;
   return res;
   ~ak*/

   if( not xml.load(datafilename_CCX99) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_CCX99, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length )
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))
         if(child_MicexDoc.tagname == "CCX99")
            j = 0;
            while(j < child_MicexDoc.childNodes.Length)
               child_ExtSettleCode = child_MicexDoc.childNodes(j);
               if(ReadTagAttribut(child_ExtSettleCode, "ID", V_STRING, MoneyMotion.ExtSettleCodeID) == false)
                  /* если не нашли расчетный код */
               end;

               /*ak - Код должен быть либо нашим (01356 и 13385)
                      либо клиентским (06263,10120,10121,10122,10123,10124,10125,10126,11140,11139)*/
               if((valtype(MoneyMotion.ExtSettleCodeID) == V_STRING) and 
                         ((MoneyMotion.ExtSettleCodeID == "01356") or
                          (MoneyMotion.ExtSettleCodeID == "13385") or
                          (MoneyMotion.ExtSettleCodeID == "06263") or
                          (MoneyMotion.ExtSettleCodeID == "10120") or
                          (MoneyMotion.ExtSettleCodeID == "10121") or
                          (MoneyMotion.ExtSettleCodeID == "10122") or
                          (MoneyMotion.ExtSettleCodeID == "10123") or
                          (MoneyMotion.ExtSettleCodeID == "10124") or
                          (MoneyMotion.ExtSettleCodeID == "10125") or
                          (MoneyMotion.ExtSettleCodeID == "10126") or
                          (MoneyMotion.ExtSettleCodeID == "11140") or
                          (MoneyMotion.ExtSettleCodeID == "11139")))
               /*~ak*/

                  if(GetDialogFlag())
                     InitProgress(child_ExtSettleCode.childNodes.length, "Загрузка внешнего файла движений денежных средств", "Просмотр блока данных о движении ДС в разрезе расчетного кода...");
                  end;
                  k = 0;
                  while(k < child_ExtSettleCode.childNodes.Length)
                     child_Statement = child_ExtSettleCode.childNodes(k);
                     MoneyMotion.StatementAcc = "";
                     if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, MoneyMotion.StatementAcc) == false)
                        /* если не нашли номер счета */
                     end;
                     if(GetDialogFlag() and (child_Statement.childNodes.length > 0))
                        InitProgress(child_Statement.childNodes.length, "Загрузка внешнего файла движений денежных средств", "Просмотр данных по счету...");
                     end;
                     /*ak
                     if(MoneyMotion.ExtSettleCodeID == AccountCode)
                     ~ak*/
                        l = 0;
                        while(l < child_Statement.childNodes.Length)
                           child_Entry = child_Statement.childNodes(l);
                           MoneyMotion.Init();
                           if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, MoneyMotion.EntryCodeType) == false)
                              /* если не нашли код типа операции */
                           end;

                           /*ak - Тип кода должен быть 916, 918 или 20*/
                           if((valtype(MoneyMotion.EntryCodeType) == V_INTEGER) and ((MoneyMotion.EntryCodeType == 916) or (MoneyMotion.EntryCodeType == 918) or (MoneyMotion.EntryCodeType == 812) or (MoneyMotion.EntryCodeType == 20)))
                           /*~ak*/

                              /*ak - Для 916 балансовый PAY_ACC должен быть 30411, 
                                     а для 918 REC_ACC 30411*/

                              if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, MoneyMotion.EntryPayAcc) == false)
                                 /* если не нашли счет плательщика */
                              end;
                              if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, MoneyMotion.EntryRecAcc) == false)
                                 /* если не нашли счет получателя */
                              end;
                              if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, MoneyMotion.EntryCredit) == false)
                                 /* если не нашли кредит */
                              end;

                              /*ak*/
                              if(((MoneyMotion.EntryCodeType == 916) and (valtype(MoneyMotion.EntryPayAcc) == V_STRING) and (substr(MoneyMotion.EntryPayAcc,1,5) == "30411")) or
                                 (((MoneyMotion.EntryCodeType == 918) or (MoneyMotion.EntryCodeType == 812)) and (valtype(MoneyMotion.EntryRecAcc) == V_STRING) and (substr(MoneyMotion.EntryRecAcc,1,5) == "30411")) or
                                 ((MoneyMotion.EntryCodeType ==  20) and (valtype(MoneyMotion.EntryCredit) == V_MONEY) and (MoneyMotion.EntryCredit > 0)))
                              /*~ak*/

                                 if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, MoneyMotion.EntryNumber) == false)
                                    /* если не нашли номер документа */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "COR_ACC", V_STRING, MoneyMotion.EntryCorAcc) == false)
                                    /* если не нашли номер корреспондирующего счета */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, MoneyMotion.EntryPurposePayment) == false)
                                    /* если не нашли комментарии */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, MoneyMotion.EntryDebit) == false)
                                    /* если не нашли дебет */
                                 end;
                                 if(ReadTagAttribut(child_Entry, "DATE", V_DATE, MoneyMotion.EntryDate) == false)
                                    /* если не нашли дату операции */
                                 end;

                                 if(MoneyMotion.EntryCodeType == 20)
                                     ЗаполнитьДругойКлирСчет(DataOtherKlirArray, MoneyMotion.EntryCredit, MoneyMotion.EXTSettleCodeID, MoneyMotion.EntryDate, MoneyMotion.EntryCodeType, MoneyMotion.EntryPurposePayment, @MoneyMotion.OtherKlirAcc);
                                 end;
                                 
                                 if(RunImp())
                                     stat = 1;
                                 end;

                              end;
                           end;
                           
                           l = l + 1;
                           if(GetDialogFlag())
                              UseProgress(l);
                           end;
                           if( FlagCtrlBrk == true )
                              break;
                           end;
                        end;
                     /*ak
                     end;
                     ~ak*/
                     if(GetDialogFlag() and (child_Statement.childNodes.length > 0))
                        RemProgress(); 
                     end;
                     k = k + 1;
                     if(GetDialogFlag())
                        UseProgress(k);
                     end;
                     if( FlagCtrlBrk == true )
                        break;
                     end;
                  end;
                  if(GetDialogFlag())
                     RemProgress(); 
                  end;
               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         break;
      end;
   end;
END;

// b. запись по исполненной 2 части - с (InfType = 1 или InfType = 2) и RepoPart = 2
// исполенние 2 ч НЕ в день заключения - внутридневное РЕПО (в файле есть обе части)
// исполенние 2 ч в день заключения - внутридневное РЕПО (в файле есть обе части)
// исполнение 2 ч НЕвнутридневного РЕПО (в файле только 2 ч)
private macro СобратьДанныеПо2ЧастиРепо( datafilename_EQM06, DataRepoArray:@TArray )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, SettleDate:date = date(0,0,0), BoardId:string = "", ClientCode:string = "",
       RepoPart:integer = 0, TrdAccId:string = "", IsTrust:bool = false, TradeNo:string = "",
       Amount:money = $0.0, AccInt2:money = $0.0, Price2:double = $0.0, Value_:money = $0.0;
   var stat:integer = 0;

   if( GetDialogFlag() )
      InitProgress(-1, "Обработка 2 частей сделок РЕПО", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( (InfType == 1) OR (InfType == 2) OR (InfType == 3) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     SettleDate = date(0,0,0);
                                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                                     end;
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       BoardId = "";
                                                                                       if(ReadTagAttribut(child_InstrTrade, "BOARDID", V_STRING, BoardId) == false)
                                                                                       end;
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                         if(RepoPart == 2)
                                                                                                            TrdAccId = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                                                            end;
                                                                                                            /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                                                            if(SubStr(TrdAccId,1,1) == "D")
                                                                                                               IsTrust = true;
                                                                                                            else
                                                                                                               IsTrust = false;
                                                                                                            end;
                                                                                                            if( ( (pp.deals_bo == SET_CHAR) AND ( IsTrust == false) ) OR
                                                                                                                ( (pp.deals_du == SET_CHAR) AND ( IsTrust == true) )
                                                                                                              )
                                                                                                               ClientCode = "";
                                                                                                               if(ReadTagAttribut(child_Security, "CLIENTCODE", V_STRING, ClientCode) == false)
                                                                                                               end;
                                                                                                               
                                                                                                               TradeNo = "";
                                                                                                               if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                               end;
                                                                                                               Amount = $0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Amount) == false)
                                                                                                               end;
                                                                                                               AccInt2 = $0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, AccInt2) == false)
                                                                                                               end;
                                                                                                               Price2 = 0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Price2) == false)
                                                                                                               end;
                                                                                                               Value_ = $0.0;
                                                                                                               if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Value_) == false)
                                                                                                               end;
                                                                                                               /* вытащили все данные */
                                                                                                               DataRepoArray[DataRepoArray.size] = DataRepo(TradeNo, Amount, SettleDate, AccInt2, Price2, Value_);
                                                                                                            
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

// запись по исполненным 1ч РЕПО (с inftype=1 и repopart=1) для определения пналичия пары (inftype=1 и repopart=2):
// в случае исполнения внутридневного РЕПО в файле будет запись (inftype=1 и repopart=2) 
// в случае невнутридневного - пары не будет
private macro СобратьДанныеПо1ЧастиРепо(datafilename_EQM06, DataRepoArray:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var InfType:integer = 0, SettleDate:date = date(0,0,0), BoardId:string = "", ClientCode:string = "",
       RepoPart:integer = 0, TrdAccId:string = "", IsTrust:bool = false, TradeNo:string = "";
   var stat:integer = 0;

   if(GetDialogFlag())
      InitProgress(-1, "Обработка 1 частей сделок РЕПО", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                       end;
                                       if( InfType == 1 )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     SettleDate = date(0,0,0);
                                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                                     end;
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       BoardId = "";
                                                                                       if(ReadTagAttribut(child_InstrTrade, "BOARDID", V_STRING, BoardId) == false)
                                                                                       end;
                                                                                       m=0;
                                                                                       while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                          child_Board = child_InstrTrade.childNodes.item(m);
                                                                                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                             if(child_Board.tagname == "SECURITY")
                                                                                                s=0;
                                                                                                while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                   child_Security = child_Board.childNodes.item(s);
                                                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                      if(child_Security.tagname == "RECORDS")
                                                                                                         RepoPart = 0;
                                                                                                         if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                                                         end;
                                                                                                         if(RepoPart == 1)
                                                                                                            TrdAccId = "";
                                                                                                            if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, TrdAccId) == false)
                                                                                                            end;
                                                                                                            /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                                                            if(SubStr(TrdAccId,1,1) == "D")
                                                                                                               IsTrust = true;
                                                                                                            else
                                                                                                               IsTrust = false;
                                                                                                            end;
                                                                                                            if( ( (pp.deals_bo == SET_CHAR) AND ( IsTrust == false) ) OR
                                                                                                                ( (pp.deals_du == SET_CHAR) AND ( IsTrust == true) )
                                                                                                              )
                                                                                                               ClientCode = "";
                                                                                                               if(ReadTagAttribut(child_Security, "CLIENTCODE", V_STRING, ClientCode) == false)
                                                                                                               end;
                                                                                                               
                                                                                                               TradeNo = "";
                                                                                                               if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                                                               end;
                                                                                                               DataRepoArray[DataRepoArray.size] = DataRepo_1(TradeNo);
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                   end;
                                                                                                   s = s + 1;
                                                                                                end;
                                                                                             end;
                                                                                          end;
                                                                                          m = m + 1;
                                                                                       end;
                                                                                    end;
                                                                                 end;
                                                                                 h = h + 1;
                                                                              end;
                                                                           end;
                                                                        end;
                                                                        t = t + 1;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                              end;
                           end;
                        end;
                        k = k + 1;
                     end;
                  end;
               end;
               j = j + 1;
            end;
         end;
      end;
      i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;


// a. запись по исполненной 1 части - с InfType = 2 и RepoPart = 1,
// в день исполнения 2 части сделки в ФИС приходит 1 запись с информацией об этой сделке - с InfType = 1 и RepoPart = 2 
private macro import_deals_to_gate_from_EQM06( datafilename_EQM06 )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, h=0;
   var node:object, child_MicexDoc:object, child_Eqm06:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object,
       child_ClearingType:object, child_Session:object, child_InstrTrade:object;
   var DOC_REQUISITES = false, EQM06 = false, FIRM = false;
   var stat:integer = 0;
   var DataRepoArray = TArray(); DataRepoArray.size = 0;
   var DataContrSEM03Array = TArray(); DataContrSEM03Array.size = 0;
   var DataRepoArray_1 = TArray(); DataRepoArray_1.size = 0;
   var DataKsuSEM03Array = TArray(); DataKsuSEM03Array.size = 0;
   var IsRun = true;

   FileImport = FileEQM06;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   NumImportDealsCliring = 0;
   NumImportDealsTotalCliring = 0;

   СобратьДанныеПо2ЧастиРепо(datafilename_EQM06, @DataRepoArray);

   СобратьДанныеПо1ЧастиРепо(datafilename_EQM06, @DataRepoArray_1);

   /*соберем сделки РПС из файла SEM03 
     на тот случай, если в файле EQM06 для сделок РПС не указан контрагент, а в SEM03 указан - контрагента тогда берем из SEM03
     + соберем КСУ для РЕПО с КСУ (для опеределения, что данная сделка клиринга есть сделка с КСУ)
   */
   GetInfoFromSEM03(@DataContrSEM03Array, @DataKsuSEM03Array, true);

   /* откроем файл импорта */
   if( not xml.load(datafilename_EQM06) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_EQM06, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
            Deals.DOC_NO = "";
            if(ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, Deals.DOC_NO) == false)
               /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
            end;
         end;

         if(child_MicexDoc.tagname == "EQM06")
            if(EQM06)
               RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            EQM06 = true;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по EQM06 */
               child_Eqm06 = child_MicexDoc.childNodes.item(j);
               if(child_Eqm06 and (child_Eqm06.nodeType==CHILD_NODE))

                  if(child_Eqm06.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename_EQM06, ": Блок MICEX_DOC\EQM06\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     if(GetDialogFlag())
                        InitProgress(child_Eqm06.childNodes.length, "Загрузка сделок из EQM06", "Просмотр сделок по валютам расчёта...");
                     end;
                     k=0;
                     while(k<child_Eqm06.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Eqm06.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                           if(child_Firm.tagname == "CURRENCY")
                              Deals.CurrencyId = "";
                              if(ReadTagAttribut(child_Firm, "CURRENCYID", V_STRING, Deals.CurrencyId) == false)
                                  /* если не нашли идентификатор валюты расчётов */
                              end;
                              l=0;
                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                                    if(child_Currency.tagname == "INFTYPE")
                                       Deals.InfType = 0;
                                       if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, Deals.InfType) == false)
                                       end;
                                       if( (Deals.InfType == 1) or (Deals.InfType == 2) )
                                          q=0;
                                          while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                             child_InfType = child_Currency.childNodes.item(q);
                                             if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                                if(child_InfType.tagname == "CLEARINGTYPE")
                                                   w=0;
                                                   while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                                      child_ClearingType = child_InfType.childNodes.item(w);
                                                      if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                                         if(child_ClearingType.tagname == "SESSION")
                                                            Deals.Session = -1;
                                                            if(ReadTagAttribut(child_ClearingType, "SESSION", V_INTEGER, Deals.Session) == false)
                                                                /* если не нашли клиринговую сессию */
                                                            end;
                                                            e=0;
                                                            while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                               child_Session = child_ClearingType.childNodes.item(e);
                                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                                  if(child_Session.tagname == "SETTLEDATE")
                                                                     Deals.SettleDate = date(0,0,0);
                                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                                                         /* если не нашли фактическую дату расчётов */
                                                                     end;
                                                                     t=0;
                                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                                        child_Settledate = child_Session.childNodes.item(t);
                                                                        if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                                           if(child_Settledate.tagname == "INSTRTRADE")
                                                                              h=0;
                                                                              while(h<child_Settledate.childNodes.length) /* бегаем по INSTRTRADE */
                                                                                 child_InstrTrade = child_Settledate.childNodes.item(h);
                                                                                 if(child_InstrTrade and (child_InstrTrade.nodeType==CHILD_NODE))
                                                                                    if(child_InstrTrade.tagname == "BOARD")
                                                                                       Deals.BoardId = "";
                                                                                       if(ReadTagAttribut(child_InstrTrade, "BOARDID", V_STRING, Deals.BoardId) == false)
                                                                                       end;
                                                                                          m=0;
                                                                                          while(m<child_InstrTrade.childNodes.length) /* бегаем по BOARD */
                                                                                             child_Board = child_InstrTrade.childNodes.item(m);
                                                                                             if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                                                                if(child_Board.tagname == "SECURITY")
                                                                                                   Deals.SecurityId = "";
                                                                                                   if(ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Deals.SecurityId) == false)
                                                                                                       /* если не нашли идентификатор финансового инструмента */
                                                                                                   end;
                                                                                                   if(ReadTagAttribut(child_Board, "PRICETYPE", V_STRING, Deals.PriceType) == false)
                                                                                                       /* если не нашли тип цены */
                                                                                                   end;
                                                                                                   ЗаполнитьКсуДляРЕПО(DataKsuSEM03Array, Deals.SecurityId, @Deals.SecurityType);
                                                                                                   s=0;
                                                                                                   if(GetDialogFlag())
                                                                                                      InitProgress(child_Board.childNodes.length, "Загрузка сделок из EQM06", "Загрузка сделок...");
                                                                                                   end;
                                                                                                   while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                                                      child_Security = child_Board.childNodes.item(s);
                                                                                                      if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                                                         if(child_Security.tagname == "RECORDS")
                                                                                                            Deals.InitRecords();
                                                                                                            if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, Deals.RepoPart) == false)
                                                                                                                Deals.RepoPart = 0;
                                                                                                                /* если не нашли часть репо */
                                                                                                            end;
                                                                                   
                                                                                                            if(    ( (Deals.InfType == 1) AND (Deals.RepoPart == 1) )
                                                                                                                OR ( (Deals.InfType == 2) AND ((Deals.RepoPart == 1) or (Deals.RepoPart == 2)) )
                                                                                                                OR ( (Deals.InfType == 1) AND (Deals.RepoPart == 2) )
                                                                                                                OR ( Deals.RepoPart == 0 )
                                                                                                              ) 
                                                                                                               Deals.TrdAccId = "";
                                                                                                               if(ReadTagAttribut(child_Security, "TRDACCID", V_STRING, Deals.TrdAccId) == false)
                                                                                                                   /* если не нашли торговый счет, в счет которого заключена данная сделка */
                                                                                                               end;
                                                                                                               /* если первый символ поля "D" - то сделка относится к модулю ДУ */
                                                                                                               if(SubStr(Deals.TrdAccId,1,1) == "D")
                                                                                                                  Deals.IsTrust = true;
                                                                                                               else
                                                                                                                  Deals.IsTrust = false;
                                                                                                               end;
                                                                                                               if(ReadTagAttribut(child_Security, "CLIENTCODE", V_STRING, Deals.ClientCode) == false)
                                                                                                                   /* если не нашли краткий код клиента */
                                                                                                               end;

                                                                                                               if(ReadTagAttribut(child_Security, "BROKERREF", V_STRING, Deals.BrokerRef) == false)
                                                                                                                   /* если не нашли краткий код клиента */
                                                                                                               end;

                                                                                                               if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, Deals.BuySell) == false)
                                                                                                                   /* если не нашли направленность заявки */
                                                                                                               end;

                                                                                                               SetPartPrmDeal();

                                                                                                               if( IsFitDeal(Deals.IsTrust, Deals.IsSEB) )
                                                                                                                  Deals.TradeDate = date(0,0,0);
                                                                                                                  if(ReadTagAttribut(child_Security, "TRADEDATE", V_DATE, Deals.TradeDate) == false)
                                                                                                                     /* если не нашли дату торгов */
                                                                                                                  end;

                                                                                                                  if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                                                                                      /* если не нашли номер сделки в торговой системе */
                                                                                                                  end;

                                                                                                                  if(ReadTagAttribut(child_Security, "SETTLECODE", V_STRING, Deals.SettleCode) == false)
                                                                                                                      /* если не нашли код расчётов по сделке */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "DECIMALS", V_INTEGER, Deals.Decimals) == false)
                                                                                                                      /* если не нашли число значимых знаков после запятой */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Deals.Price) == false)
                                                                                                                      /* если не нашли цену за одну ценную бумагу */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "QUANTITY", V_MONEY, Deals.Quantity) == false)
                                                                                                                      /* если не нашли объём сделки, в ценных бумагах */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Deals.Value_) == false)
                                                                                                                      /* если не нашли объём сделки, в валюте расчётов */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Deals.Amount) == false)
                                                                                                                      /* если не нашли сумму сделки, в валюте расчётов */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                                                                      /* если не нашли объём комиссии по заключенной сделке за торги */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, Deals.AccInt) == false)
                                                                                                                      /* если не нашли накопленный купонный доход */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "CPFIRMID", V_STRING, Deals.CPFirmId) == false)
                                                                                                                      /* если не нашли идентификатор фирмы партнера */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "REPOPERIOD", V_INTEGER, Deals.RepoPeriod) == false)
                                                                                                                      /* если не нашли срок РЕПО */
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "REPORTTIME", V_TIME, Deals.TradeTime) == false)
                                                                                                                  end;
                                                                                                                  if(ReadTagAttribut(child_Security, "SETTLETIME", V_TIME, Deals.SettleTime) == false)
                                                                                                                  end;
                                                                                                                  if( Deals.RepoPart == 1 )
                                                                                                                     НайтиДанныеПо2Части(DataRepoArray, Deals.TradeNo, Deals.SettleDate, Deals.Amount, @Deals.RepoRate,
                                                                                                                                         @Deals.AccInt2, @Deals.Amount2, @Deals.Value2_, @Deals.Price2);
                                                                                   
                                                                                                                     /*проверяем, что это внебиржевые сделки*/
                                                                                                                     if( IsOutExchangeREPO() )
                                                                                                                        /*для внебиржевых сделок РЕПО все комиссии загружаем в ЗР по сделке*/
                                                                                                                        if(ReadTagAttribut(child_Security, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                                                                        end;
                                                                                                                        if(ReadTagAttribut(child_Security, "CLRCOMM", V_MONEY, Deals.ClrComm) == false)
                                                                                                                        end;
                                                                                                                        if(ReadTagAttribut(child_Security, "ITSCOMM", V_MONEY, Deals.ITSComm) == false)
                                                                                                                        end;
                                                                                                                     end;
                                                                                   
                                                                                                                  end;
                                                                                   
                                                                                                                  IsRun = true;
                                                                                                                  if( (Deals.InfType == 1) AND (Deals.RepoPart == 2) AND 
                                                                                                                      (not НевнутридневноеРЕПО(DataRepoArray_1, Deals.TradeNo)) 
                                                                                                                    )
                                                                                                                     IsRun = false;
                                                                                                                  end;
                                                                                   
                                                                                                                  if( IsRun )
                                                                                                                     if( Deals.CPFirmId == "" )
                                                                                                                        ЗаполнитьКонтрагентаДляРПС(DataContrSEM03Array, Deals.TradeNo, Deals.BuySell, @Deals.CPFirmId);
                                                                                                                     end;
                                                                                                                     /* вытащили все данные по сделке, теперь обработаем и вставим */
                                                                                                                     if(RunImp())
                                                                                                                        stat = 1;
                                                                                                                     end;
                                                                                                                  end;
                                                                                                               end;
                                                                                                            end;
                                                                                                         end;
                                                                                                      end;
                                                                                                      s = s + 1;
                                                                                                      if(GetDialogFlag())
                                                                                                         UseProgress(s);
                                                                                                      end;
                                                                                                      if( FlagCtrlBrk == true )
                                                                                                         break;
                                                                                                      end;
                                                                                                   end;
                                                                                                   if(GetDialogFlag())
                                                                                                      RemProgress(); 
                                                                                                   end;
                                                                                                end;
                                                                                             end;
                                                                                             m = m + 1;
                                                                                             if( FlagCtrlBrk == true )
                                                                                                break;
                                                                                             end;
                                                                                          end;
                                                                                       end;
                                                                                    end;
                                                                                    h = h + 1;
                                                                                    if( FlagCtrlBrk == true )
                                                                                       break;
                                                                                    end;
                                                                                 end;
                                                                             end;
                                                                        end;
                                                                        t = t + 1;
                                                                        if( FlagCtrlBrk == true )
                                                                           break;
                                                                        end;
                                                                     end;
                                                                  end;
                                                               end;
                                                               e = e + 1;
                                                               if( FlagCtrlBrk == true )
                                                                  break;
                                                               end;
                                                            end;
                                                         end;
                                                      end;
                                                      w = w + 1;
                                                      if( FlagCtrlBrk == true )
                                                         break;
                                                      end;
                                                   end;
                                                end;
                                             end;
                                             q = q + 1;
                                             if( FlagCtrlBrk == true )
                                                break;
                                             end;
                                          end;
                                       end;
                                    end;
                                 end;
                                 l = l + 1;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                           end;
                        end;
                        k = k + 1;
                        if(GetDialogFlag())
                           UseProgress(k);
                        end;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                     if(GetDialogFlag())
                        RemProgress(); 
                     end;
                  end;
               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   if( not FlagCtrlBrk )
      RG.Transfer();
      SetErrAfterLoad(true);
   end;

   /*загрузить в лог инфу о загруженных ЗР*/
   GetRecsAfterLoad_EQM06();

   /* сообщаем о результатах загрузки */
   RGLog.Message( "Загрузка EQM06:"+
                  "\nВсего сделок, прошедших клиринг - " + string(NumImportDealsCliring) + 
                  "\n из них успешно - " + string(NumImportDealsTotalCliring) + 
                  "\n ошибочно - " + string(NumImportDealsCliring - NumImportDealsTotalCliring)
                );

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

PRIVATE MACRO PutCompInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_COMP,
                   String("Компенсационный взнос по сделке №" + Comp.RepoTradeNo),
                   Создать );

   if( NOT RG.InitByCode(RG_REQUEST, Comp.RepoTradeNo + "_" + string(Comp.SettleDate) + "_" + string(Comp.RecNo), SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("RGDLCOMP_REPORTDATE",    Comp.ReportDate);
   RG.SetParmByName("RGDLCOMP_REPOTRADENO",   Comp.RepoTradeNo);
   RG.SetParmByName("RGDLCOMP_DIRECTION",     Comp.Direction);
   RG.SetParmByName("RGDLCOMP_CLIENTDETAILS", Comp.ClientDetails);
   RG.SetParmByName("RGDLCOMP_QUANTITY",      Comp.Quantity);
   RG.SetParmByName("RGDLCOMP_VALUE",         Comp.Value);
   RG.SetParmByName("RGDLCOMP_SETTLEDATE",    Comp.SettleDate);

   if( RG.Save() != true )
      if( RG.GetLastError() )
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
END;
              
PRIVATE MACRO import_comp_to_gate_from( datafilename:STRING ):INTEGER

   var xml:object = ActiveX("MSXML.DOMDocument");
   var node:object, child_MicexDoc:object, child_Sem25:object, child_Firm:object, child_Currency:object, child_Security:object;
   var DOC_REQUISITES = false, SEM25 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0;
   var stat:integer = 0;
   var NumImportComp:integer = 0, NumImportCompTotal:integer = 0;

   private macro RunImp()
      ErrMes = "";

      NumImportComp = NumImportComp + 1;

      if(ProcessTrn( 0, "PutCompInfo"))
         NumImportCompTotal = NumImportCompTotal + 1;
         RGLog.Message( "Компенсационный взнос для сделки \"" + Comp.RepoTradeNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
      else
         RGLog.Error( "Ошибка при загрузке компенсационного взноса для сделки \"" + Comp.RepoTradeNo + "\"\n" + ErrMes, RG );
         return 1;
      end;
      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   Comp.Init();

   NumImportComp = 0;
   NumImportCompTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры заявок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM25")
            if(SEM25)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM25 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM25 = true;
            Comp.ReportDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Comp.ReportDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM25 */
               child_Sem25 = child_MicexDoc.childNodes.item(j);
               if(child_Sem25 and (child_Sem25.nodeType==CHILD_NODE))

                  if(child_Sem25.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM25\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Sem25.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem25.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Firm.childNodes.length, "Загрузка внешнего файла компенсационных взносов", "Просмотр блоков данных по ценной бумаге...");
                              end;

                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))

                                    if(child_Currency.tagname == "SECURITY")
                                       m=0;
                                       if(GetDialogFlag())
                                          InitProgress(child_Currency.childNodes.length, "Загрузка внешнего файла компенсационных взносов", "Просмотр записей...");
                                       end;
                                       while(m<child_Currency.childNodes.length) /* бегаем по SECURITY */
                                          child_Security = child_Currency.childNodes.item(m);
                                          if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                             if(child_Security.tagname == "RECORDS")
                                                Comp.InitRecords();

                                                ReadTagAttribut(child_Security, "REPOTRADENO",   V_STRING,  Comp.RepoTradeNo);
                                                ReadTagAttribut(child_Security, "DIRECTION",     V_STRING,  Comp.Direction);
                                                ReadTagAttribut(child_Security, "CLIENTDETAILS", V_STRING,  Comp.ClientDetails);
                                                ReadTagAttribut(child_Security, "QUANTITY",      V_INTEGER, Comp.Quantity);
                                                ReadTagAttribut(child_Security, "VALUE",         V_MONEY,   Comp.Value);
                                                ReadTagAttribut(child_Security, "SETTLEDATE",    V_DATE,    Comp.SettleDate);
                                                ReadTagAttribut(child_Security, "RECNO",         V_INTEGER, Comp.RecNo);

                                                if( RunImp() )
                                                   stat = 1;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if(GetDialogFlag())
                                             UseProgress(m);
                                          end;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                       if(GetDialogFlag())
                                          RemProgress(); 
                                       end;
                                    end;

                                 end;
                                 l = l + 1;
                                 if(GetDialogFlag())
                                    UseProgress(l);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress();
                              end;
                           end;

                        end;
                        k = k + 1;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано компенсационных взносов - " + string(NumImportComp) + "\nиз них успешно - " + string(NumImportCompTotal) + "\nошибочно - " + string(NumImportComp - NumImportCompTotal));

   return stat;

OnError( RslErrObj )
   RemProgress(); RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

PRIVATE MACRO PutPaymInfo()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_PAYM,
                   String("Выплата по сделке №" + Paym.RepoTradeNo),
                   Создать );

   if( NOT RG.InitByCode(RG_REQUEST, Paym.RepoTradeNo + "_" + string(Paym.RepoValueDate) + "_" + string(Paym.RecNo), SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("RGDLPAYM_REPORTDATE",     Paym.ReportDate);
   RG.SetParmByName("RGDLPAYM_REPOTRADENO",    Paym.RepoTradeNo);
   RG.SetParmByName("RGDLPAYM_REPOVALUEDATE",  Paym.RepoValueDate);
   RG.SetParmByName("RGDLPAYM_PRINCIPALVALUE", Paym.PrincipalValue);
   RG.SetParmByName("RGDLPAYM_COUPONVALUE",    Paym.CouponValue);
   RG.SetParmByName("RGDLPAYM_CLIENTDETAILS",  Paym.ClientDetails);
   RG.SetParmByName("RGDLPAYM_PAYMENTVALUE",   Paym.PaymentValue);

   if( RG.Save() != true )
      if( RG.GetLastError() )
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
END;
              
PRIVATE MACRO import_paym_to_gate_from( datafilename:STRING ):INTEGER

   var xml:object = ActiveX("MSXML.DOMDocument");
   var node:object, child_MicexDoc:object, child_Sem26:object, child_Firm:object, child_Currency:object, child_Security:object;
   var DOC_REQUISITES = false, SEM26 = false, FIRM = false;
   var i=0, j=0, k=0, l=0, m=0;
   var stat:integer = 0;
   var NumImportPaym:integer = 0, NumImportPaymTotal:integer = 0;

   private macro RunImp()
      ErrMes = "";

      NumImportPaym = NumImportPaym + 1;

      if(ProcessTrn( 0, "PutPaymInfo"))
         NumImportPaymTotal = NumImportPaymTotal + 1;
         RGLog.Message( "Выплата по сделке \"" + Paym.RepoTradeNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
      else
         RGLog.Error( "Ошибка при загрузке выплаты по сделке \"" + Paym.RepoTradeNo + "\"\n" + ErrMes, RG );
         return 1;
      end;
      return 0;

   OnError(ErObj)

      RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
      end;
      return ErObj.Code;
   end;

   Paym.Init();

   NumImportPaym = 0;
   NumImportPaymTotal = 0;

   /* откроем файл импорта */
   if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры заявок */
   i=0;
   while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

         if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
               return false;
            end;
            DOC_REQUISITES = true;
         end;

         if(child_MicexDoc.tagname == "SEM26")
            if(SEM26)
               RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM26 должен присутствовать в единственном экземпляре"));
               return false;
            end;
            SEM26 = true;
            Paym.ReportDate = date(0,0,0);
            if(ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Paym.ReportDate) == false)
               /* если не нашли дату предоставления информации */
            end;
            j=0;
            while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM26 */
               child_Sem26 = child_MicexDoc.childNodes.item(j);
               if(child_Sem26 and (child_Sem26.nodeType==CHILD_NODE))

                  if(child_Sem26.tagname == "FIRM")
                     if(FIRM)
                        RGLog.Error(string(datafilename, ": Блок MICEX_DOC\SEM26\FIRM должен присутствовать в единственном экземпляре"));
                        return false;
                     end;
                     FIRM = true;
                     k=0;
                     while(k<child_Sem26.childNodes.length) /* бегаем по FIRM */
                        child_Firm = child_Sem26.childNodes.item(k);
                        if(child_Firm and (child_Firm.nodeType==CHILD_NODE))

                           if(child_Firm.tagname == "CURRENCY")
                              l=0;
                              if(GetDialogFlag())
                                 InitProgress(child_Firm.childNodes.length, "Загрузка внешнего файла выплат", "Просмотр блоков данных по ценной бумаге...");
                              end;

                              while(l<child_Firm.childNodes.length) /* бегаем по CURRENCY */
                                 child_Currency = child_Firm.childNodes.item(l);
                                 if(child_Currency and (child_Currency.nodeType==CHILD_NODE))

                                    if(child_Currency.tagname == "SECURITY")
                                       m=0;
                                       if(GetDialogFlag())
                                          InitProgress(child_Currency.childNodes.length, "Загрузка внешнего файла выплат", "Просмотр записей...");
                                       end;
                                       while(m<child_Currency.childNodes.length) /* бегаем по SECURITY */
                                          child_Security = child_Currency.childNodes.item(m);
                                          if(child_Security and (child_Security.nodeType==CHILD_NODE))

                                             if(child_Security.tagname == "RECORDS")
                                                Paym.InitRecords();

                                                ReadTagAttribut(child_Security, "REPOTRADENO",    V_STRING,  Paym.RepoTradeNo);
                                                ReadTagAttribut(child_Security, "REPOVALUEDATE",  V_DATE,    Paym.RepoValueDate);
                                                ReadTagAttribut(child_Security, "PRINCIPALVALUE", V_MONEY,   Paym.PrincipalValue);
                                                ReadTagAttribut(child_Security, "COUPONVALUE",    V_MONEY,   Paym.CouponValue);
                                                ReadTagAttribut(child_Security, "CLIENTDETAILS",  V_STRING,  Paym.ClientDetails);
                                                ReadTagAttribut(child_Security, "RECNO",          V_INTEGER, Paym.RecNo);
                                                ReadTagAttribut(child_Security, "PAYMENTVALUE",   V_MONEY,   Paym.PaymentValue);
                                                

                                                if( RunImp() )
                                                   stat = 1;
                                                end;
                                             end;

                                          end;
                                          m = m + 1;
                                          if(GetDialogFlag())
                                             UseProgress(m);
                                          end;
                                          if( FlagCtrlBrk == true )
                                             break;
                                          end;
                                       end;
                                       if(GetDialogFlag())
                                          RemProgress(); 
                                       end;
                                    end;

                                 end;
                                 l = l + 1;
                                 if(GetDialogFlag())
                                    UseProgress(l);
                                 end;
                                 if( FlagCtrlBrk == true )
                                    break;
                                 end;
                              end;
                              if(GetDialogFlag())
                                 RemProgress();
                              end;
                           end;

                        end;
                        k = k + 1;
                        if( FlagCtrlBrk == true )
                           break;
                        end;
                     end;
                  end;

               end;
               j = j + 1;
               if( FlagCtrlBrk == true )
                  break;
               end;
            end;
         end;

      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
         if(GetDialogFlag())
            RemProgress(); RemProgress();
         end;
         break;
      end;
   end;

   /* сообщаем о результатах загрузки */
   RGLog.Message("Всего обработано выплат - " + string(NumImportPaym) + "\nиз них успешно - " + string(NumImportPaymTotal) + "\nошибочно - " + string(NumImportPaym - NumImportPaymTotal));

   return stat;

OnError( RslErrObj )
   RemProgress(); RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro ResultCopyFile(done:bool, data_filepath:string, data_filename:string)
/*ak - ничего никуда не переностим*/
   return;
/*~ak*/

   var data_file_new_path, data_file_new_file;

   if(done)
      data_file_new_path = data_filepath + "Done\\";
   else
      data_file_new_path = data_filepath + "Err\\";
   end;

   MakeDir(data_file_new_path);
   data_file_new_path = data_file_new_path + string(FileDate(imp_date)) + "\\";
   MakeDir(data_file_new_path);

   data_file_new_file = data_file_new_path + data_filename;

   if(not CopyFile(data_filepath + data_filename, data_file_new_file ) )
      RGLog.Error("Ошибка копирования файла " + data_filename + " в " + data_file_new_file);
   else
      RGLog.Message("Файл " + data_filename + " скопирован в " + data_file_new_file);
      RemoveFile(data_filepath + data_filename);
   end;

end;

private macro RunImportMVB4( Pan )
   var stat:integer;
   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "";
   var data_filepath_EQM6C:string = "", data_filename_EQM6C:string = "";
   var data_filepath_SEM02:string = "", data_filename_SEM02:string = "";
   var data_filepath_SEM03:string = "", data_filename_SEM03:string = "";
   var data_filepath_SET21:string = "", data_filename_SET21:string = "";
   var data_filepath_SET25:string = "", data_filename_SET25:string = "";
   var data_filepath_SET26:string = "", data_filename_SET26:string = "";
   var data_filepath_CCX99:string = "", data_filename_CCX99:string = "";
   var RetVal = CM_SAVE;

   if( CheckPanel(Pan, @MMVB_Code, @MarketScheme_BO, @MarketScheme_DU, true) == false )
      RetVal = CM_IGNORE;
   end;

   if( RetVal != CM_IGNORE )
      RGLog = GTDL_Log(SeanceID);
      imp_date = Pan.imp_date;

      if( Pan.comp == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА КОМПЕНСАЦИОННЫХ ВЗНОСОВ В РЕПО");
         stat = 1;
         if( MMVB_Code == MICEX_CODE_FB )
            stat = get_data_file_name("KVREPO", "SEM25", @data_filepath_SET25, @data_filename_SET25);
         end;

         if( stat == 0 )
            if( import_comp_to_gate_from(data_filepath_SET25 + data_filename_SET25) == 0 )
               ResultCopyFile(true, data_filepath_SET25, data_filename_SET25)
            else
               ResultCopyFile(false, data_filepath_SET25, data_filename_SET25)
            end;
         end;

      end;

      if( Pan.paym == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА ВЫПЛАТ В РЕПО");
         stat = 1;
         if( MMVB_Code == MICEX_CODE_FB )
            stat = get_data_file_name("HPREPO", "SEM26", @data_filepath_SET26, @data_filename_SET26);
         end;

         if( stat == 0 )
            if( import_paym_to_gate_from(data_filepath_SET26 + data_filename_SET26) == 0 )
               ResultCopyFile(true, data_filepath_SET26, data_filename_SET26)
            else
               ResultCopyFile(false, data_filepath_SET26, data_filename_SET26)
            end;
         end;

      end;

      if( Pan.rates == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА КОТИРОВОК");
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("QUOTESX", "SEM21", @data_filepath_SET21, @data_filename_SET21);
         end;

         if(stat == 0)
            if(import_rates_to_gate_from( data_filepath_SET21 + data_filename_SET21 ) == 0)
               ResultCopyFile(true, data_filepath_SET21, data_filename_SET21)
            else
               ResultCopyFile(false, data_filepath_SET21, data_filename_SET21)
            end;
         end;

      end;

      if( Pan.request == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА ЗАЯВОК НА СДЕЛКИ");
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("ORDERSX", "SEM02", @data_filepath_SEM02, @data_filename_SEM02);
         end;

         if(stat == 0)
            if(import_request_to_gate( data_filepath_SEM02 + data_filename_SEM02 ) == 0)
               ResultCopyFile(true, data_filepath_SEM02, data_filename_SEM02)
            else
               ResultCopyFile(false, data_filepath_SEM02, data_filename_SEM02)
            end;
         end;

      end;

      if( Pan.deals == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ SEM03");
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("DEALX", "SEM03", @data_filepath_SEM03, @data_filename_SEM03);
         end;

         if(stat == 0)
            if(import_deals_to_gate_from( data_filepath_SEM03 + data_filename_SEM03 ) == 0)
               ResultCopyFile(true, data_filepath_SEM03, data_filename_SEM03);
            else
               ResultCopyFile(false, data_filepath_SEM03, data_filename_SEM03);
            end;
         end;

      end;

      if( Pan.deals_clearing == SET_CHAR )

         RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ EQM06");
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("CLEARX", "EQM06", @data_filepath_EQM06, @data_filename_EQM06, "Импорт сделок из EQM06: ");
         end;

         if(stat == 0)
            if(import_deals_to_gate_from_EQM06( data_filepath_EQM06 + data_filename_EQM06 ) == 0)
               ResultCopyFile(true, data_filepath_EQM06, data_filename_EQM06);
            else
               ResultCopyFile(false, data_filepath_EQM06, data_filename_EQM06);
            end;
         end;

      end;

      if(Pan.MoneyMotion == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ДВИЖЕНИЯ ДЕНЕЖНЫХ СРЕДСТВ");
         stat = 1;
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_CCX99);
         end;

         if(stat == 0)
            if(import_deals_to_gate_from_CCX99(data_filepath_CCX99 + data_filename_CCX99))
                ResultCopyFile(true, data_filepath_CCX99, data_filename_CCX99);
            else
                ResultCopyFile(false, data_filepath_CCX99, data_filename_CCX99);
            end;
         end;
      end;

      RGLog.Save();
   end;

   return RetVal;
end;

private macro RunInitMVB4(Pan)
   Pan.imp_date              = {curdate};
   Pan.Market                = MMVB_Code = MICEX_CODE_FB;
   Pan.rates                 = UNSET_CHAR;
   Pan.comp                  = UNSET_CHAR;
   Pan.paym                  = UNSET_CHAR;
   Pan.request               = UNSET_CHAR;
   Pan.deals                 = SET_CHAR;
   Pan.deals_clearing        = SET_CHAR;
   Pan.deals_clearing_client = UNSET_CHAR;
   Pan.deals_bo              = SET_CHAR;
   Pan.deals_seb             = UNSET_CHAR;
   Pan.deals_du              = UNSET_CHAR;
   Pan.MarketSchemeDU        = "";
/*ak*/
   Pan.MoneyMotion           = SET_CHAR;
   //Pan.deals                 = UNSET_CHAR;
   //Pan.deals_clearing        = UNSET_CHAR;
   //Pan.deals_bo              = UNSET_CHAR;
/*~ak*/
   DisableFields( Pan, PNFLD_CLEARING_CLIENT );
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)
   var Party, DlMarket;

   if (Cmd == DLG_INIT)
        RunInitMVB4(Pn);
        PumpMarketScheme(@Pn, true);
        UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_MARKET) ) /* F3 */
      Party = TRecHandler("party.dbt");
      if( ListPT( Party, MMVB_CodeKind, Pn.Market, PTLIST_MARKETPLASE, PTCK_CONTR) == true )
         MMVB_Code = Pn.Market;
         PumpMarketScheme(@Pn, true);
         UpdateFields(Pn);
      end;

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
      Pn.imp_date = GetDateByCalendar( Pn.imp_date );
      UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) and (ID == PNFLD_MAR_SCHEME_DU) ) /* F3 */
      if(ID == PNFLD_MAR_SCHEME_DU)
         ListMarketScheme(@Pn, true);
      end;

   elif( (Cmd == DLG_KEY) and (Key == 32) ) /* Пробел */
      if( (ID == PNFLD_REQUEST) or (ID == PNFLD_SECUR) or (ID == PNFLD_CLEARING) or (ID == PNFLD_CLEARING_CLIENT) )
         if( Pn(ID) == SET_CHAR )
            Pn(ID) = UNSET_CHAR;
         else
            Pn(ID) = SET_CHAR;
         end;
         if( (Pn(PNFLD_REQUEST) == UNSET_CHAR) and (Pn(PNFLD_SECUR) == UNSET_CHAR) and (Pn(PNFLD_CLEARING) == UNSET_CHAR) and (Pn(PNFLD_CLEARING_CLIENT) == UNSET_CHAR) )
            Pn(PNFLD_SEC_BO)  = UNSET_CHAR;
            Pn(PNFLD_SEC_SEB) = UNSET_CHAR;
            Pn(PNFLD_SEC_DU)  = UNSET_CHAR;
            DisableFields( Pn, PNFLD_SEC_BO );
            DisableFields( Pn, PNFLD_SEC_SEB );
            DisableFields( Pn, PNFLD_SEC_DU );
            DisableFields( Pn, PNFLD_MAR_SCHEME_DU );
         else
            if(Pn(ID) == SET_CHAR) /*если установили какой-либо признак*/
               EnableFields( Pn, PNFLD_SEC_BO );
               EnableFields( Pn, PNFLD_SEC_SEB );
               EnableFields( Pn, PNFLD_SEC_DU );
            end;
         end;
      end;
      if( ID == PNFLD_SEC_DU ) 
         if( Pn(PNFLD_SEC_DU) == SET_CHAR )
            Pn(PNFLD_SEC_DU) = UNSET_CHAR;
            DisableFields( Pn, PNFLD_MAR_SCHEME_DU );
         else
            Pn(PNFLD_SEC_DU) = SET_CHAR;
            EnableFields( Pn, PNFLD_MAR_SCHEME_DU );
         end;
      end;
      if( (ID == PNFLD_RATES) or (ID == PNFLD_COMP) or (ID == PNFLD_PAYM) or (ID == PNFLD_SEC_BO) or (ID == PNFLD_SEC_SEB) )
         if( Pn(ID) == SET_CHAR )
            Pn(ID) = UNSET_CHAR;
         else
            Pn(ID) = SET_CHAR;
         end;
      end;
      if((ID == PNFLD_MONEYMOTION) and (Pn(PNFLD_MONEYMOTION) == SET_CHAR))
         Pn(PNFLD_MONEYMOTION) = UNSET_CHAR;
      elif((ID == PNFLD_MONEYMOTION) and (Pn(PNFLD_MONEYMOTION) != SET_CHAR))
         Pn(PNFLD_MONEYMOTION) = SET_CHAR;
      end;
      UpdateFields(Pn);

   elif ( (Cmd == DLG_KEY) and (Key == 316) )
      return RunImportMVB4(Pn);

   elif( (Cmd == DLG_KEY) and ( (Key == 13) or (Key == 323) ) )
      return CM_IGNORE;

   end;

   return CM_DEFAULT;
end;

macro Process(SeanceID, Parms)
end;

macro Receive(_SeanceID:integer, Parm:variant)
   SeanceID = _SeanceID;

   record _party(party);
   var RS;

   if( IsShedulerRunning() )
      RunInitMVB4(pp);
      AutoSetParm(pp, Parm);                     // пар-ры из панели источника
      AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
      RunImportMVB4(pp);
   else
/*ak*/
     var autoproc;
     if((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
       RunInitMVB4(pp);
       AutoSetParm(pp, Parm);
       RunImportMVB4(pp);
     else
/*~ak*/
       RunDialog(pp, "ProcessPanel");
/*ak*/
     end;
/*~ak*/
   end;

   return 0;
end;

macro Deliver (SeanceID, Parm)
end;
