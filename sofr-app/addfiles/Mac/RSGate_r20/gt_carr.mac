/*
$Name: gt_carr.mac
$Module: Шлюз
$Description: Репликация проводок
*/

/************************************************************************/
/*         Автоматизированная банковская система RS-Bank v5.хх          */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Модуль           : Шлюз                                             */
/*                                                                      */
/*  Имя файла        : mvo_carr.mac                                     */
/*                                                                      */
/*  Описание         : Репликация проводок               */
/*                                                                      */
/*  Программист      : Сулимов Д.В.                                     */
/*                                                                      */
/*  Создан           : 08.10.1998                                       */
/*                                                                      */
/************************************************************************/

/************************************************************************
Mikhailov S., 25.06.2001

Использовать  MVODB_CarryDocument с параметром CarryPlaced = DOC_POST
для помещения документов в отложенные

************************************************************************/

import BankInter;
import OprInter;/*DLDOC_CARRY*/
import impcomm;/*LZ*/
import ReportInter;

private const NATCUR = 0;
private const MVODB_MFO_LEN = 9;
record CarryGKBO  ( acctrn, "bank.def" );
record  docinf( "docinfo.rec", "bank.def" );

var    docInfoServer; /* Сервер для получения информации по документу */


private file pmGKBO( pmpaym, "bank.def" );

private var objSymbCashMVODB;
private var objCarryMVODB;
private var objObCarryMVODB;

private var SymbCashMVODB;
private var CarryMVODB;
private var obCarryMVODB;
private var McAddParmMVODB;
private var obMcAddParmMVODB;


/*MS 17-10-2001 - Нужно обнулять каждый раз в PrepareExportDocuments*/
var         INNPayer : string/*= ""*/,
            KPPPayer : string/*= ""*/,

            INNReceiver : string/*= ""*/,
            KPPReceiver : string/*= ""*/;


var CarryPlaced;

private var PayerBnkCode = "";


macro GetPartyInfo()
end;

/*
    Создает массив кассовых символов, присобаченных к проводке
*/
macro SetIMVODBReplSymbCash( localObjCarryMVODB, document )

    var symbcash = TBFile( "symbcash"); //, "R", 4 
    symbcash.keyNum = 4;

    var DocKind : integer;
    var i = 0;
    var i_array = 0;
    var next_flag : bool = true;
/*
    if( (document.FIID_Payer == NATCUR) AND (document.FIID_Receiver == NATCUR) )
        DocKind = DLDOC_CARRY;
    else
        DocKind = DLDOC_CARRYC;
    end;
*/
    DocKind = DLDOC_CARRY;
    while(i < 2)
      symbcash.Rec.DocKind  = DocKind;
      symbcash.Rec.AccTrnID = document.AccTrnID;

      next_flag = true;
      if( symbcash.GetGE() )

        while( ( symbcash.Rec.DocKind == DocKind ) and
               (symbcash.Rec.AccTrnID == document.AccTrnID) and
               next_flag )

               SymbCashMVODB.DocKind          = symbcash.Rec.DocKind;
               SymbCashMVODB.Sum              = symbcash.Rec.Sum;
               SymbCashMVODB.ApplicationKey   = symbcash.Rec.ApplicationKey;
               SymbCashMVODB.Symbol           = symbcash.Rec.Symbol;
               SymbCashMVODB.Sum              = symbcash.Rec.Sum;
               SymbCashMVODB.Date             = symbcash.Rec.Date;

               localObjCarryMVODB.AddSymbCash(objSymbCashMVODB);

               next_flag = next( symbcash );
        end;/*while*/
      end;/*GetGE*/
      DocKind = DLDOC_CARRYC;
      i = i + 1;
    end;

end;/*SetIMVODBReplSymbCash*/


/*
    Простенькая функция копирования строк
*/
macro copy_str( str_dst, str_src )
    if( str_src != "" )
        SetParm( 0, str_src );
    end;
end;/*copy_str*/


macro CarryDocument
   var stat;
   var DateCarry;

   if( CarryGKBO.Date_Carry == date( 0, 0, 0 ) )
         DateCarry = {curdate};
   else
         DateCarry = CarryGKBO.Date_Carry;
   end;

   var localObjCarryMVODB;
   if(CarryGKBO.Chapter == 1) localObjCarryMVODB = objCarryMVODB;
   else                       localObjCarryMVODB = objObCarryMVODB;
   end;

   SetIMVODBReplSymbCash( localObjCarryMVODB,  CarryGKBO );

   /* ... */
   /* Здесь можно поместить программу пользователя, выполняемую */
   /* в одной транзакции с проводкой */
   /* ... */

/************************************************************************
Mikhailov S., 25.06.2001

Использовать  MVODB_CarryDocument с параметром CarryPlaced = DOC_POST
для помещения документов в отложенные

************************************************************************/
/*   CarryPlaced = DOC_CUR;*/


   stat = mvodbCarryCheck(localObjCarryMVODB.carry( CarryGKBO.Chapter,
                                                    DateCarry,

                                                    INNPayer,
                                                    KPPPayer,

                                                    INNReceiver,
                                                    KPPReceiver,
                                                    InfObject.ActionID,
                                                   @MVODB_ObjectCode), @ErrorMessage);

   if( stat )

      if( ( stat == 466 ) or ( stat == 436 ) )
         if( CarryGKBO.Chapter == 1 )
            ErrorMessage = string( "По счету ", CarryMVODB.Account_Payer,
                                   " - ", ErrorMessage );
         else
            ErrorMessage = string( "По счету ", obCarryMVODB.Account_Payer,
                                   " - ", ErrorMessage );
         end;
      end;

      if( stat == 581 )
         if( CarryGKBO.Chapter == 1 )
            ErrorMessage = string( "По счету ", CarryMVODB.Account_Receiver,
                                   " - ", ErrorMessage );
         else
            ErrorMessage = string( "По счету ", obCarryMVODB.Account_Receiver,
                                   " - ", ErrorMessage );
         end;
      end;

      stat = Error_InCarry;

      ReplicatorMsgBox( ErrorMessage );
   end;

   return stat;

end;



MACRO SetTaxParmMVODB(CarryMVODB, docinf)

      var stat = 0;

      CarryMVODB.WriteOffDate    = docinf.PayerChargeOffDate;
      CarryMVODB.ComposerStatus  = docinf.TaxAuthorState;
      CarryMVODB.BudjClassifCode = docinf.BttTICode;
      CarryMVODB.OKATO           = docinf.OKATOCode;
      CarryMVODB.TaxGround       = docinf.TaxPmGround;
      CarryMVODB.TaxPeriod       = docinf.TaxPmPeriod;
      CarryMVODB.TaxNumber       = docinf.TaxPmNumber;
      CarryMVODB.TaxDate         = docinf.TaxPmDate;
      CarryMVODB.TaxPaymentType  = docinf.TaxPmType;

      if(docinf.PaymentID)
        pmGKBO.PaymentID = docinf.PaymentID;
        if(GetEQ(pmGKBO))
           CarryMVODB.Date_Enter = pmGKBO.I2PlaceDate;
        end;
      end;

      return stat;
END;


private macro GetOFRSymbolByRecID(RecID)
  var opusymb = TBFile("opusymb"); //, "R", 2
  var OFRSymbol = "";
  opusymb.keyNum = 2;

  opusymb.Rec.RecID  = RecID;
  if(opusymb.GetEQ())
    OFRSymbol = opusymb.Rec.Code;
  end;
  return OFRSymbol;
end;


macro CopyDocGKBO_to_DocMVODB( balance )

  var stat = 0;
  var strpos = 0;
  var Currency_Payer = -1; 
  var Currency_Receiver = -1;

  const PTCK_BIC               = 3;
  McAddParmMVODB   = mvodbXCheck(objCarryMVODB.CreateMltCrPrm(),"TRecHandler");
  obMcAddParmMVODB = mvodbXCheck(objObCarryMVODB.CreateMltCrPrm(),"TRecHandler");

  if( balance == 1 )

    ClearRecord( CarryMVODB );
    ClearRecord( McAddParmMVODB );

    stat = ConvertCurrCode( Currency_Payer, CarryGKBO.FIID_Payer );
    if( stat ) stat = Error_NoCurrency; return stat; end;

    stat = ConvertCurrCode( Currency_Receiver, CarryGKBO.FIID_Receiver );
    if( stat ) stat = Error_NoCurrency; return stat; end;


    McAddParmMVODB.rec.Currency_Payer    = Currency_Payer;
    McAddParmMVODB.rec.Currency_Receiver = Currency_Receiver;
    McAddParmMVODB.rec.Sum_Payer         = CarryGKBO.Sum_Payer;
    McAddParmMVODB.rec.Sum_Receiver      = CarryGKBO.Sum_Receiver;
    McAddParmMVODB.rec.Sum_NatCur        = CarryGKBO.Sum_NatCur;
    McAddParmMVODB.rec.date_carry        = CarryGKBO.Date_Carry;
    McAddParmMVODB.rec.moved             = DOC_CUR;

    if((McAddParmMVODB.fldindex("OFR") > -1) and (CarryGKBO.FIID_Payer == 0) and (CarryGKBO.FIID_Receiver == 0) and (CarryGKBO.OFRRecID > 0))
      McAddParmMVODB.rec.OFR = substr(GetOFRSymbolByRecID(CarryGKBO.OFRRecID), 1, 9);
    end;

    CarryMVODB.Oper     = CarryGKBO.Oper;

    CarryMVODB.Account_Payer    = CarryGKBO.Account_Payer;
    CarryMVODB.Real_Payer       = CarryGKBO.Account_Payer;
    CarryMVODB.Account_Receiver = CarryGKBO.Account_Receiver;
    CarryMVODB.Real_Receiver    = CarryGKBO.Account_Receiver;
    CarryMVODB.Sum              = $0;
    CarryMVODB.TypeDocument     = CarryGKBO.TypeDocument;
    CarryMVODB.UserTypeDocument = CarryGKBO.UserTypeDocument;
    CarryMVODB.Symbol_Cach      = "  0";
    CarryMVODB.Result_Carry     = CarryGKBO.Result_Carry;
    CarryMVODB.Number_Pack      = CarryGKBO.Number_Pack;
    CarryMVODB.Date_Value       = CarryGKBO.Date_Carry;
    CarryMVODB.Date_Send        = CarryGKBO.Date_Carry;
    CarryMVODB.Numb_Document    = CarryGKBO.Numb_Document;
    CarryMVODB.Date_Document    = CarryGKBO.Date_Carry;
    CarryMVODB.Kind_Oper        = CarryGKBO.Kind_Oper;
    CarryMVODB.Ground           = substr( CarryGKBO.Ground, 1, 160 );
//    CarryMVODB.CarryAcnt        = CarryGKBO.CarryAcnt;
    CarryMVODB.SymbNotBal       = "  0";
    CarryMVODB.UserField1       = CarryGKBO.UserField1;
    CarryMVODB.UserField2       = CarryGKBO.UserField2;
    CarryMVODB.UserField3       = CarryGKBO.UserField3;
    CarryMVODB.UserField4       = CarryGKBO.UserField4;
    CarryMVODB.Department       = CarryGKBO.Department;
    CarryMVODB.Shifr_Oper       = CarryGKBO.Shifr_Oper;

    // Перекодировка признака СПОД для МВОДБ
    strpos = Index(CarryMVODB.TypeDocument, "З");
    
    if (strpos != 0)
        StrSet(CarryMVODB.TypeDocument, strpos, "С");
    end;

    CarryMVODB.Ground = StrSubst(CarryMVODB.Ground, "\n", " ");                     

    ClearRecord( docinf );

    
    /*if( ПолучитьИнформациюПоДокументу( CarryGKBO, docinf, 0, true, false ) == 0 )*/
    if( docInfoServer.getInformation(CarryGKBO, docinf))

/* Для рублевых и валютных БИК
   Иначе пользоваться ПолучитьКодСубъекта.
*/
        CarryMVODB.MFO_Payer    =  substr( docinf.PayerBIC   , 1, MVODB_MFO_LEN );
        CarryMVODB.MFO_Receiver =  substr( docinf.ReceiverBIC, 1, MVODB_MFO_LEN );

        if  (CarryMVODB.MFO_Payer    == {MFO_Bank})
            CarryMVODB.MFO_Payer    = "";
        end;
        if(CarryMVODB.MFO_Receiver == {MFO_Bank})
            CarryMVODB.MFO_Receiver = "";
        end;

        CarryMVODB.Account_Payer = docinf.PayerAccount;
        copy_str(  CarryMVODB.CorAcc_Payer , docinf.PayerCorrAcc );

        copy_str( CarryMVODB.Payer, substr( docinf.PayerName, 1, 80  ) );
        copy_str( CarryMVODB.Bank_Payer, substr( docinf.PayerBankName, 1, 80  ) );

        if( docinf.PayerINN != "" )
            stat = SplitFullINN( docinf.PayerINN, INNPayer, KPPPayer );
            if( stat )ReplicatorMsgBox("Ошибка при обработке ИНН");

            return stat; end;
        end;

        CarryMVODB.Account_Receiver = docinf.ReceiverAccount;
        copy_str( CarryMVODB.CorAcc_Receiver, docinf.ReceiverCorrAcc );

        copy_str( CarryMVODB.Receiver , substr( docinf.ReceiverName, 1, 80 ) );
        copy_str( CarryMVODB.Bank_Receiver , substr( docinf.ReceiverBankName, 1, 80 ) );

        if( docinf.ReceiverINN != "" )
            stat = SplitFullINN( docinf.ReceiverINN, INNReceiver, KPPReceiver );
            if( stat )ReplicatorMsgBox("Ошибка при обработке ИНН");
            return stat; end;
        end;

        stat = SetTaxParmMVODB(CarryMVODB,docinf);
        if(stat) return stat; end;

    else/*GetDocInf*/
        stat = Error_InCarry;
        ReplicatorMsgBox("Ошибка при определении свойств документа" );


        return stat;

    end;/*GetDocInf*/

  else/*balance == 1 */
    ClearRecord( obCarryMVODB );
    ClearRecord( obMcAddParmMVODB );

    stat = ConvertCurrCode( Currency_Payer, CarryGKBO.FIID_Payer );
    if( stat ) stat = Error_NoCurrency; return stat; end;

    stat = ConvertCurrCode( Currency_Receiver, CarryGKBO.FIID_Receiver );
    if( stat ) stat = Error_NoCurrency; return stat; end;

    obMcAddParmMVODB.rec.Currency_Payer    = Currency_Payer;
    obMcAddParmMVODB.rec.Currency_Receiver = Currency_Receiver;
    obMcAddParmMVODB.rec.Sum_Payer         = CarryGKBO.Sum_Payer;
    obMcAddParmMVODB.rec.Sum_Receiver      = CarryGKBO.Sum_Receiver;
    obMcAddParmMVODB.rec.Sum_NatCur        = CarryGKBO.Sum_NatCur;
    obMcAddParmMVODB.rec.date_carry        = CarryGKBO.Date_Carry;
    obMcAddParmMVODB.rec.moved             = DOC_CUR;

    obCarryMVODB.Chapter   = CarryGKBO.Chapter;
    obCarryMVODB.Date_Carry   = CarryGKBO.Date_Carry;
    obCarryMVODB.Oper      = CarryGKBO.Oper;

    obCarryMVODB.Account_Payer      = CarryGKBO.Account_Payer;
    obCarryMVODB.Account_Receiver   = CarryGKBO.Account_Receiver;
    obCarryMVODB.UserTypeDocument   = CarryGKBO.UserTypeDocument;

    obCarryMVODB.Sum    = $0;
    obCarryMVODB.TypeDocument    = CarryGKBO.TypeDocument;
    obCarryMVODB.Result_Carry = CarryGKBO.Result_Carry;
    obCarryMVODB.Number_Pack  = CarryGKBO.Number_Pack;
    obCarryMVODB.Date_Value   = CarryGKBO.Date_Carry;
    obCarryMVODB.Date_Send    = CarryGKBO.Date_Carry;
    obCarryMVODB.Numb_Document   = CarryGKBO.Numb_Document;
    obCarryMVODB.Date_Document   = CarryGKBO.Date_Carry;
    obCarryMVODB.Kind_Oper = CarryGKBO.Kind_Oper;
    obCarryMVODB.Ground    = substr( CarryGKBO.Ground, 1, 160 );
    obCarryMVODB.UserField1   = CarryGKBO.UserField1;
    obCarryMVODB.UserField2   = CarryGKBO.UserField2;
    obCarryMVODB.UserField3   = CarryGKBO.UserField3;
    obCarryMVODB.UserField4   = CarryGKBO.UserField4;
    obCarryMVODB.Department   = CarryGKBO.Department;

    ClearRecord( docinf );
    if( ПолучитьИнформациюПоДокументу( CarryGKBO, docinf, true, true ) == 0 )


        if( docinf.PayerINN != "" )
            SplitFullINN( docinf.PayerINN, INNPayer, KPPPayer );
        end;

        copy_str( obCarryMVODB.Payer, substr( docinf.PayerName, 1, 80  ) );


        if( docinf.ReceiverINN != "" )
            SplitFullINN( docinf.ReceiverINN, INNReceiver, KPPReceiver );
        end;
        copy_str( obCarryMVODB.Receiver, substr( docinf.ReceiverName, 1, 80  ) );


    else/*GetDocInf*/
        stat = Error_InCarry;
        ReplicatorMsgBox("Ошибка при определении свойств документа" );


        return stat;

    end;/*GetDocInf*/


  end;/*balance == 1 */

/*  if( stat ) stat = Error_InConvertBIC; end;*/

  return stat;

end;/*CopyDocGKBO_to_DocMVODB*/


macro GetDocumentGKBO()

    var docPtr = 0;
    var stat = 0;

    codeObject.rec.ObjectID      = InfObject.ObjectID;
    codeObject.rec.ApplicationID = GKBO;
    codeObject.rec.ObjectKind    = Object.ObjectKind;
  
    if (GetEQ(codeObject))
        stat = FindCarryInGKBO( codeObject.rec.ObjectCode, docPtr );

        if (stat)                               
            codeObject.dropFilter();
            ReplicatorMsgBox(string( "Проводка в базе ГКБО не найдена"));
            return Error_NoCarry;
        else                                    
            setbuff( CarryGKBO, docPtr );
        end;
    else
        codeObject.dropFilter();
        ReplicatorMsgBox(string( "Нет записи о коде объекта в системе-источнике"));
        return Error_NoObjectCode; 
    end;
    
    codeObject.dropFilter();
    
    return stat;
end;



macro PrepareExportDocuments()

  var stat = 0;
  
    if (InfObject.ActionID == ACT_SYNCHR)
        ErrorMessage = "Синхронизация проводок запрещена"; 
        return 1;
    end;

    objCarryMVODB = mvodbXCheck(IMVODBRepl.CreateCarryMCA(@CarryMVODB),"IMVODBCarryMCA");
    CarryMVODB = CarryMVODB.rec;

    objObCarryMVODB = mvodbXCheck(IMVODBRepl.CreateObCarryMCA(@obCarryMVODB),"IMVODBObCarryMCA");
    obCarryMVODB = obCarryMVODB.rec;

    objSymbCashMVODB = mvodbXCheck(IMVODBRepl.CreateSymbCash(@SymbCashMVODB),"IMVODBSymbCash");
    SymbCashMVODB = SymbCashMVODB.rec;

    INNPayer = "";
    KPPPayer = "";

    INNReceiver = "";
    KPPReceiver = "";

    if( InfObject.ActionID != ACT_DELETE )

        stat = GetDocumentGKBO();
        
        if( stat == 0 )
            stat = CopyDocGKBO_to_DocMVODB( CarryGKBO.Chapter );
        end;

    else

        ClearRecord( CarryGKBO );
        ClearRecord( CarryMVODB );
        ClearRecord( obCarryMVODB );

        CarryGKBO.Chapter = -1;
        obCarryMVODB.Code_Currency = -1;

        CarryPlaced = 0;  /* при удалении не используется */

    end;

    return stat;

end;
