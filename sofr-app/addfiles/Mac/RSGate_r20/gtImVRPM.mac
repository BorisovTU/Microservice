/*
$Name:        gtImVRPM.mac
$Module:      Шлюз Securities
$Description: Импорт итогов торгов на валютном рынке биржи ММВБ с пом. Payments 
*/
import RSD, "gtImMVB_VR.mac", "secinter.mac", "gtmktrep.mac";

private const PNFLD_BEGDATE         = 0,
              PNFLD_ENDDATE         = 1,
              PNFLD_REQUESTS        = 2,
              PNFLD_DEALS           = 3,
              PNFLD_OWN_DEALS       = 4,
              PNFLD_CLIENT_DEALS    = 5,
              PNFLD_MARGIN          = 6,
              PNFLD_NETTOITOG       = 7,
              PNFLD_COMMISSIONS     = 8,
              PNFLD_MONEYMOTION     = 9,
              PNFLD_MONEYMOTION_CM  = 10;

private const NOTUSED_EXTCODE   = 1, 
              NOTFOUND_EXTCODE  = 2, 
              INCORRECT_EXTCODE = 3,
              NOTFOUND_PARTYID  = 4,
              NOTFOUND_FIID     = 5,
              NOTFOUND_CALCFIID = 6;

private record pp(IMP_VRPM, "rgate.lbr") dialog;

private var NumImportDeals:integer = 0, NumImportDealsTotal:integer = 0;
private var MarketID:integer = 0;
private var Progress = TProgressBar;
private var RecordID_Deals:integer = 0;

private const IsRSHB = 1;

macro FileDateInName(beg_date:date, end_date:date):string
   var day, month, year, day1, month1, year1;
   var result:string = "";

   DateSplit(beg_date, day, month, year);
   year = year - 1900;
   if(year >= 100)
      year = year - 100;
   end;
   result = RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,2);

   if(end_date != beg_date)
      DateSplit(end_date, day1, month1, year1);
      year1 = year1 - 1900;
      if(year1 >= 100)
         year1 = year1 - 100;
      end;
      result = result + "_" + RGDLFUN_LZ(day1,2) + RGDLFUN_LZ(month1,2) + RGDLFUN_LZ(year1,2); 
   end;

   return result;
end; 
  
macro CheckExtSettleCode_PM(Table:string, own_deals:string, client_deals:string, ErrMes:@string):integer
  var query, cmd, DataSet, cmdUpd;
  var ErrStat:integer = 0;
  var Ext = TRecHandler( "dl_extsettlecode.dbt" );

  query = "SELECT DISTINCT tb.t_ExtSettleCode "
          +" FROM " + Table + " tb ";

  cmd = RSDCommand(query);
  cmd.Execute();

  DataSet = TRsbDataSet(cmd);
  while( DataSet.moveNext() )
     ErrStat = 0;
     if( FindDL_EXTSETTLECODEbyCode( DataSet.ExtSettleCode, Ext ) != 0 )
        if( GetErrMsg() != "" )
           ErrStat = NOTUSED_EXTCODE;
        else
           ErrStat = NOTFOUND_EXTCODE;
        end;
     else
        if( not (((Ext.rec.CodeType == ALG_SP_MONEY_SOURCE_OWN) and (own_deals == SET_CHAR) and (Table == "D_CUX23_TMP")) or 
                 ((Ext.rec.CodeType == ALG_SP_MONEY_SOURCE_CLIENT) and (((client_deals == SET_CHAR) and (Table == "D_CUX23_TMP")) or (Table == "D_CUX22_TMP")))
                )
          )
           cmdUpd = RSDCommand(" DELETE " + Table + " tb "
                               +" WHERE tb.t_ExtSettleCode = ? "
                              );
           cmdUpd.addParam("", RSDBP_IN, DataSet.ExtSettleCode);
           cmdUpd.execute();
        elif( not (((Ext.rec.MarketKind == DL_MARKETKIND_SETTLE_CURRENCY) and (Ext.rec.InPool != "X")) or 
                   ((Ext.rec.MarketKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (Ext.rec.InPool == "X"))
                  )
            )
           ErrStat = INCORRECT_EXTCODE;
        end;
     end;
     if( ErrStat != 0 )
        cmdUpd = RSDCommand(" UPDATE " + Table + " tb "
                               +"SET tb.t_ErrStat = ? "
                            +" WHERE tb.t_ExtSettleCode = ? "
                           );
        cmdUpd.addParam("", RSDBP_IN, ErrStat);
        cmdUpd.addParam("", RSDBP_IN, DataSet.ExtSettleCode);
        cmdUpd.execute();
     end;
  end;

  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro GetFileName(synonim, Table, FilesName:@string, ErrMes:@string):integer
  var cmd, ds;

  cmd = DL_RSDCommand( " SELECT REQUIS.FILE_NAME file_name from "+synonim+".MB_REQUISITES REQUIS WHERE REQUIS.ID_MB_REQUISITES IN (SELECT DISTINCT t.T_ID_MB_REQUISITES FROM " +Table+ " t ) " );
  ds = cmd.execute();
  while(ds.MoveNext)
     FilesName = FilesName + ds.file_name + " \n"
  end;
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro CheckFileUpload(synonim, FileType:string, beg_date:date, end_date:date, ErrMes:@string):integer
  var cmd, ds;

  cmd = RSDCommand(" SELECT 1 FROM " + synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = ? AND TRADE_DATE BETWEEN ? AND ? ");
  cmd.addParam("", RSDBP_IN, FileType);
  cmd.addParam("", RSDBP_IN, beg_date);
  cmd.addParam("", RSDBP_IN, end_date);
  ds = TRsbDataSet(cmd);
  if(not ds.MoveNext)
    ErrMes = "Нет данных в Payments";
    return 1;
  end;
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro CheckOper():bool
  var cmd = RSDCommand("BEGIN ? := RSB_GTIM_VR.IsAdminOrOperBO(?); END;");
  cmd.addParam("result", RSDBP_OUT, V_INTEGER);
  cmd.addParam("", RSDBP_IN, {oper});
  cmd.Execute();
  if(Int(cmd.value("result")) == 1)
    return true;
  else
    return false;
  end;
end;

private macro ProcessDataCUX22(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, ds, cmdSP;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  NumImportDeals = 0;

  RGLog.Message("ЗАГРУЗКА ЗАЯВОК ИЗ CUX22");
  Progress.Init(8, "Выполняется обработка данных CUX22", "Выполняется обработка данных CUX22");
  oldOutPut = SetOutput(reportFileName, TRUE);

  stat = CheckFileUpload(synonim, "CUX22", pan.beg_date, pan.end_date, @ErrMes);
  
  if(stat == 0)  
    Message("Очистка таблицы CUX22");
    println("Начало очистки таблицы CUX22 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.DelCUX22(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец очистки таблицы CUX22 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы CUX22");
    println("Начало заполнения CUX22 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCUX22(?, ?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения CUX22 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Проверка данных для CUX22: ExtSettleCode");
    println("Начало проверки ExtSettleCode " + time());

    if(IsRSHB == 1)
      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CheckExtSettleCodeCUX22(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));
    else
      stat = CheckExtSettleCode_PM("D_CUX22_TMP", pan.own_deals, pan.client_deals, @ErrMes);
    end;

    println("Конец проверки ExtSettleCode " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX22: ClientID");
    println("Начало обновления ClientID " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateClientID_CUX22(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, MarketID);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления ClientID " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX22: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateObjCUX22(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных CUX22");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_DVREQ);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_CUX22_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы CUX22 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_CUX22_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла заявок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ CUX22");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CreateReplRecByTmp_CUX22(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы CUX22 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_DVREQ);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_DVREQ, "Успешно загружена заявка \"","\"", @NumImportDealsTotal, printOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateCUX22_PM(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    RGLog.Message("Всего обработано заявок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro ProcessDataCUX23(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, ds, cmdSP;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  NumImportDeals = 0;

  RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ CUX23");
  Progress.Init(11, "Выполняется обработка данных CUX23", "Выполняется обработка данных CUX23");
  oldOutPut = SetOutput(reportFileName, TRUE);

  stat = CheckFileUpload(synonim, "CUX23", pan.beg_date, pan.end_date, @ErrMes);
  
  if(stat == 0)  
    Message("Очистка таблицы CUX23");
    println("Начало очистки таблицы CUX23 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.DelCUX23(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец очистки таблицы CUX23 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы CUX23");
    println("Начало заполнения CUX23 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCUX23(?, ?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения CUX23 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Проверка данных для CUX23: ExtSettleCode");
    println("Начало проверки ExtSettleCode " + time());

    if(IsRSHB == 1)
      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CheckExtSettleCodeCUX23(?, ?, ?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.addParam("", RSDBP_IN, IIF(pan.own_deals == SET_CHAR, 1, 0));
      cmdSP.addParam("", RSDBP_IN, IIF(pan.client_deals == SET_CHAR, 1, 0));
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));
    else
      stat = CheckExtSettleCode_PM("D_CUX23_TMP", pan.own_deals, pan.client_deals, @ErrMes);
    end;

    println("Конец проверки ExtSettleCode " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX23: DOC_NO");
    println("Начало обновления DOC_NO " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateDocNoCUX23(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления DOC_NO " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX23: ClientID");
    println("Начало обновления ClientID " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateClientID_CUX23(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, MarketID);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления ClientID " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX23: Kind");
    println("Начало обновления Kind " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateKindCUX23(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, IsRSHB);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления Kind " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX23: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateObjCUX23(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, IsRSHB);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных CUX23");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_DVFXDEAL/*ошибки привязаны именно к этому виду сделок*/);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_CUX23_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы CUX23 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_CUX23_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ CUX23");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CreateReplRecByTmp_CUX23(?, ?, ?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.addParam("", RSDBP_IN, IsRSHB);
      cmdSP.addParam("", RSDBP_IN, MICEX_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы CUX23 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_DVFXDEAL/*ошибки привязаны именно к этому виду сделок*/);
    RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT, "Документ-подтверждение \"Отчет биржи\" успешно загружен\n", null, true, null, null, printOnlyErr);
    RGLog.GetAndAddReceiveLoadRecsMass(string(RG_DVNDEAL+","+RG_DVFXDEAL), "Успешно загружена сделка \"","\"", @NumImportDealsTotal, printOnlyErr, @RecordID_Deals);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateCUX23_PM(?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, IsRSHB);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    RGLog.Message("Всего обработано сделок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  if(stat == 0)
    Message("Обработка сделок, неподтвержденных биржевым файлом");
    OldOutPut = SetOutput(ReportFileName, TRUE);
    println("Начало обработки сделок, неподтвержденных биржевым файлом " + time());
    SetOutput(OldOutPut, TRUE);

    NumImportDeals = 0; NumImportDealsTotal = 0;
    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.MarkDealsForDelete(?, ?, ?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.addParam("", RSDBP_IN, IsRSHB);
    cmdSP.addParam("NumImportDeals", RSDBP_OUT, NumImportDeals, V_INTEGER);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));
    NumImportDeals = Int(cmdSP.value("NumImportDeals"));

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_DVFXDEAL/*ошибки привязаны именно к этому виду сделок*/);
    RGLog.GetAndAddReceiveLoadRecsMass(string(RG_DVNDEAL+","+RG_DVFXDEAL), "Успешно создана ЗР для удаления неподтверждённой сделки \"","\"", @NumImportDealsTotal, printOnlyErr, @RecordID_Deals);

    OldOutPut = SetOutput(ReportFileName, TRUE);
    println("Конец обработки сделок, неподтвержденных биржевым файлом " + time());
    SetOutput(OldOutPut, TRUE);
    // сообщаем о результатах загрузки
    RGLog.Message("Всего обработано неподтверждённых сделок - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro ProcessDataCCX10(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool, isMain:bool)
  var oldOutPut, cmd, ds, cmdSP;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  NumImportDeals = 0;

  RGLog.Message("ЗАГРУЗКА КОМИССИОННЫХ ВОЗНАГРАЖДЕНИЙ ИЗ CCX10");
  Progress.Init(7, "Выполняется обработка данных CCX10", "Выполняется обработка данных CCX10");
  oldOutPut = SetOutput(reportFileName, TRUE);

  stat = CheckFileUpload(synonim, "CCX10", pan.beg_date, pan.end_date, @ErrMes);

  if(stat == 0)
  Message("Очистка таблицы CCX10");
    println("Начало очистки таблицы CCX10 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.DelCCX10(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец очистки таблицы CCX10 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы CCX10");
    println("Начало заполнения CCX10 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCCX10(?, ?, ?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.addParam("", RSDBP_IN, IIF(isMain, 1, 0));
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения CCX10 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CCX10: DOC_NO");
    println("Начало обновления DOC_NO " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateDocNoCCX10(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления DOC_NO " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CCX10: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateObjCCX10(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных CCX10");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_DVCOMMISVR);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_CCX10_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы CCX10 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_CCX10_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла комиссий", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ CCX10");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CreateReplRecByTmp_CCX10(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы CCX10 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_DVCOMMISVR);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_DVCOMMISVR, "Успешно загружено комиссионное вознаграждение \"","\"", @NumImportDealsTotal, printOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateCCX10_PM(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    RGLog.Message("Всего обработано комиссий из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;


private macro ProcessDataCCX17(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, ds, cmdSP;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  NumImportDeals = 0;

  RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ CCX17");
  Progress.Init(6, "Выполняется обработка данных CCX17", "Выполняется обработка данных CCX17");
  
  Message("Очистка таблицы CCX17");
  oldOutPut = SetOutput(reportFileName, TRUE);
  println("Начало очистки таблицы CCX17 " + time());

  cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.DelCCX17(?, ?); END;");
  cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
  cmdSP.addParam("", RSDBP_IN, SeanceID);
  cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
  cmdSP.Execute();
  stat = Int(cmdSP.value("stat"));

  println("Конец очистки таблицы CCX17 " + time());
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы CCX17");
    println("Начало заполнения CCX17 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCCX17(?, ?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения CCX17 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CUX17: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateObjCCX17(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных CCX17");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_KINDOBJ_DVNDEALCALC);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_CCX17_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы CCX17 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_CCX17_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла обязательств по ПФИ", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ CCX17");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CreateReplRecByTmp_CCX17(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы CCX17 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_KINDOBJ_DVNDEALCALC);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_KINDOBJ_DVNDEALCALC, "Успешно загружены итоги по сделке \"","\"", @NumImportDealsTotal, printOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateCCX17_PM(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    RGLog.Message("Всего обработано записей - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro ProcessDataCCX4(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, ds, cmdSP;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  NumImportDeals = 0;

  RGLog.Message("ЗАГРУЗКА ИТОГОВ КЛИРИНГА ИЗ CCX4");
  Progress.Init(6, "Выполняется обработка данных CCX4", "Выполняется обработка данных CCX4");

  Message("Очистка таблицы CCX4");
  oldOutPut = SetOutput(reportFileName, TRUE);
  println("Начало очистки таблицы CCX4 " + time());

  cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.DelCCX4(?, ?); END;");
  cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
  cmdSP.addParam("", RSDBP_IN, SeanceID);
  cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
  cmdSP.Execute();
  stat = Int(cmdSP.value("stat"));

  println("Конец очистки таблицы CCX4 " + time());
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы CCX4");
    println("Начало заполнения CCX4 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCCX4(?, ?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения CCX4 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CCX4: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateObjCCX4(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных CCX4");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_CCX4_TMP t GROUP BY t.T_ID_MB_REQUISITES, t.T_DOCTYPE, t.T_REPORTDATE, t.T_REPORTDATESTR, t.T_EXTCODE, t.T_CURRENCYID, t.T_NETTOSUM, t.t_OBJECTID");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы CCX4 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_CCX4_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла итогов клиринга", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ CCX4");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CreateReplRecByTmp_CCX4(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы CCX4 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_DLITOGCLVR, "Успешно загружены итоговые нетто-требования и нетто-обязательства \"","\"", @NumImportDealsTotal, printOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateCCX4_PM(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    RGLog.Message("Всего обработано итогов клиринга из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro ProcessDataCCX99(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool, IsDL:bool)
  var oldOutPut, cmd, ds, cmdSP;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  NumImportDeals = 0;
  RGLog.Message("ЗАГРУЗКА ДВИЖЕНИЯ ДЕНЕЖНЫХ СРЕДСТВ");
  Progress.Init(6, "Выполняется обработка данных CCX99", "Выполняется обработка данных CCX99");
  
  Message("Очистка таблицы CCX99");
  oldOutPut = SetOutput(reportFileName, TRUE);
  println("Начало очистки таблицы CCX99 " + time());

  cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.DelCCX99(?, ?, ?); END;");
  cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
  cmdSP.addParam("", RSDBP_IN, SeanceID);
  cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
  cmdSP.addParam("", RSDBP_IN, IIF(IsDL, 0, 1));
  cmdSP.Execute();
  stat = Int(cmdSP.value("stat"));

  println("Конец очистки таблицы CCX99 " + time());
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы CCX99");
    println("Начало заполнения CCX99 " + time());

    if(IsDL)
      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCCX99(?, ?, ?, ?, ?); END;");
    else
      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.FillCCX99VR(?, ?, ?, ?, ?); END;");
    end;
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.beg_date);
    cmdSP.addParam("", RSDBP_IN, pan.end_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения CCX99 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для CCX99: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateObjCCX99(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, IIF(IsDL, 0, 1));
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных CCX99");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog( IIF(IsDL, RG_MONEYMOTION, RG_MONEYMOTION_CM));
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_CCX99_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы CCX99 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_CCX99_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ CCX99");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.CreateReplRecByTmp_CCX99(?, ?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.addParam("", RSDBP_IN, IIF(IsDL, 0, 1));
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat"));

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы CCX99 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(IIF(IsDL, RG_MONEYMOTION, RG_MONEYMOTION_CM));
    RGLog.GetAndAddReceiveLoadRecsMass(IIF(IsDL, RG_MONEYMOTION, RG_MONEYMOTION_CM), "Движение денежных средств с номером  \"","\" уcпешно загружено в шлюз", @NumImportDealsTotal, printOnlyErr, @RecordID_Deals);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_VR.UpdateCCX99_PM(?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, IIF(IsDL, 0, 1));
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro CheckPanel(Pan, RGLog):bool
  if( Pan.beg_date == date(0,0,0) )
     if(GetDialogFlag())
        MsgBox("Не задана дата начала периода");
     else
        RGLog.Error("Не задана дата начала периода");
     end;
     return false;
  end;

  if( Pan.end_date == date(0,0,0) )
     if(GetDialogFlag())
        MsgBox("Не задана дата окончания периода");
     else
        RGLog.Error("Не задана дата окончания периода");
     end;
     return false;
  end;

  if( Pan.end_date < Pan.beg_date )
     if(GetDialogFlag())
        MsgBox("Дата окончания периода не может быть меньше даты начала периода");
     else
        RGLog.Error("Дата окончания периода не может быть меньше даты начала периода");
     end;
     return false;
  end;

  return true;
end;

private macro RunImportVRPM( Pan )
  var RetVal = CM_SAVE;
  var Synonim = "";
  var NameDate = FileDateInName(Pan.beg_date, Pan.end_date);
  var printOnlyErr = false;
  var ReportFileName;
  var hour, min, sec;

  TimeSplit(Time(), hour, min, sec);

  ReportFileName = GetTxtFileName("gtImVRPM_" + NameDate + "_" + hour + min + sec);

  RGLog = GTDL_Log(SeanceID);

  if(CheckPanel(Pan, RGLog) == false)
     RetVal = CM_IGNORE;
  end;

  Synonim = GetShemePathGATE();
  if(Synonim == "")
     if(GetDialogFlag())
        MsgBox("Не найден схема Payments");
     else
        RGLog.Error("Не найден схема Payments");
     end;
     RetVal = CM_IGNORE;
  end;

  MarketID = RGDLFUN_GetClientID(MICEX_CODE, PTCK_CONTR);
  if(MarketID <= 0)
     if(GetDialogFlag())
        MsgBox("В ГКБО не найден субъект с кодом \"" + MICEX_CODE + "\" вида " + PTCK_CONTR);
     else
        RGLog.Error("В ГКБО не найден субъект с кодом \"" + MICEX_CODE + "\" вида " + PTCK_CONTR);
     end;
     RetVal = CM_IGNORE;
  end;

  if(RetVal != CM_IGNORE)
     NumImportDeals = 0;
     NumImportDealsTotal = 0;

     printOnlyErr = ВыводитьВПротоколТолькоОшибки(@ErrMes);
     if(ErrMes != "")
        RGLog.Error(ErrMes);      
     end;

     if(((Pan.requests == SET_CHAR) or (Pan.deals == SET_CHAR)) and CheckOper())
        if(Pan.requests == SET_CHAR) // CUX22
           ProcessDataCUX22(pan, synonim, reportFileName, printOnlyErr);
           ErrMes = ""; // DEF-54342, отсутствие заявок не должно останавливать процесс, поэтому сбрасываем ошибку (если она была)
        end;

        if(Pan.deals == SET_CHAR) // CUX23
           ProcessDataCUX23(pan, synonim, reportFileName, printOnlyErr);
        end;
     end;

     if(Pan.commissions == SET_CHAR) // Собственные комиссии из CCX10
        ProcessDataCCX10(pan, synonim, reportFileName, printOnlyErr, true);
     end;

     if(Pan.margin == SET_CHAR) // CCX17
        ProcessDataCCX17(pan, synonim, reportFileName, printOnlyErr);
     end;

     if(Pan.nettoitog == SET_CHAR) // CCX4
        ProcessDataCCX4(pan, synonim, reportFileName, printOnlyErr);
     end;

     if(Pan.moneymotion == SET_CHAR) // Фондовая часть CCX99
        ProcessDataCCX99(pan, synonim, reportFileName, printOnlyErr, true);
     end;

     if(Pan.moneymotion_cm == SET_CHAR) // Валютная брокерка из CCX99 и CCX10
        ProcessDataCCX99(pan, synonim, reportFileName, printOnlyErr, false);
        ProcessDataCCX10(pan, synonim, reportFileName, printOnlyErr, false);
     end;
  end;

  Progress.Init( 1, "Выполняется сохранение протокола", "Сохранение протокола" );
  RGLog.Save();
  Progress.Use();
  Progress.Remove();
     
  return RetVal;

OnError( RslErrObj )
  MsgBox("Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message);
  RunError;
end;

private macro RunInitVRPM(Pan)
  Pan.beg_date       = {curdate};
  Pan.end_date       = {curdate};
  Pan.requests       = SET_CHAR;
  Pan.deals          = SET_CHAR;
  Pan.own_deals      = SET_CHAR;
  Pan.client_deals   = SET_CHAR;
  Pan.margin         = SET_CHAR;
  Pan.nettoitog      = SET_CHAR;
  Pan.commissions    = SET_CHAR;
  Pan.moneymotion    = SET_CHAR;
  Pan.moneymotion_cm = SET_CHAR;
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)

  if( Cmd == DLG_INIT )
     RunInitVRPM(Pn);
     UpdateFields(Pn);
  elif( cmd == DLG_KEY )
     if( (key == 317) AND (ID == PNFLD_BEGDATE) ) /* F3 */
        Pn.beg_date = GetDateByCalendar(Pn.beg_date);
        UpdateFields(Pn);
     elif( (key == 317) AND (ID == PNFLD_ENDDATE) ) /* F3 */
        Pn.end_date = GetDateByCalendar(Pn.end_date);
        UpdateFields(Pn);
     elif( (Cmd == DLG_KEY) and (Key == 32) ) /* Пробел */
        if ((ID == PNFLD_REQUESTS)
        or  (ID == PNFLD_DEALS)
        or  (ID == PNFLD_OWN_DEALS)
        or  (ID == PNFLD_CLIENT_DEALS)
        or  (ID == PNFLD_COMMISSIONS)
        or  (ID == PNFLD_MARGIN)
        or  (ID == PNFLD_NETTOITOG)
        or  (ID == PNFLD_MONEYMOTION)
        or  (ID == PNFLD_MONEYMOTION_CM))
           Pn(ID) = IIF(Pn(ID) == SET_CHAR, UNSET_CHAR, SET_CHAR);
        end;

        if( Pn(PNFLD_DEALS) == UNSET_CHAR )
           DisableFields(Pn, PNFLD_OWN_DEALS);
           DisableFields(Pn, PNFLD_CLIENT_DEALS);
           Pn(PNFLD_OWN_DEALS) = UNSET_CHAR;
           Pn(PNFLD_CLIENT_DEALS) = UNSET_CHAR;
        else
           EnableFields(Pn, PNFLD_OWN_DEALS); 
           EnableFields(Pn, PNFLD_CLIENT_DEALS); 
        end;
        UpdateFields(Pn);
     elif( Key == 316 )
        return RunImportVRPM(Pn);
     elif( (Key == 13) or (Key == 323) )
        return CM_IGNORE;
     end;
  end;

  return CM_DEFAULT;
end;

macro Process( SeanceID, Parms )             
end;

macro Receive( _SeanceID:integer, Parm:variant )
  SeanceID = _SeanceID;

  SOURCE_CODE = "SRC-30";

  if( IsShedulerRunning() )
     RunInitVRPM(pp);
     AutoSetParm(pp, Parm);                     // пар-ры из панели источника
     AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
     RunImportVRPM(pp);     
  else
     var autoproc;
     if( (GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc) )
        RunInitVRPM(pp);
        AutoSetParm(pp, Parm);
        RunImportVRPM(pp);
     else
        RunDialog(pp, "ProcessPanel");
     end;
  end;

  return 0;
end;

macro Deliver( SeanceID, Parm )
end;
