/*
$Name:        GTDVFXDeal.mac
$Module:      Шлюз Securities
$Description: Загрузка конверсионной операции в ПИ
*/

import RSD, FIInter, DealsInter, DVInter, likepy, "rgtgtrec.mac", "gtdlfun.mac", "rgobj.mac", "gtconst.inc", "dldlngfun.mac";
                                                                                             
PRIVATE CONST ContractorCode = "00#Б#2882000";/*НКЦ*/
PRIVATE CONST MMVB_CODE = "ММВБ";    /* код ММВБ */
PRIVATE CONST UnknownParty = -1;
//dan>
private const Валютный_рынок = "Валютный рынок";
//<dan

PRIVATE VAR ErrorText = "";
PRIVATE MACRO SetError( _ErrorText )
  ErrorText = _ErrorText;
  RunError( ErrorText );
END;

PRIVATE MACRO SetWarning( Comment:@STRING, WarningText:String )
  Comment = WarningText; 
  return -1;
END;

private macro checkTOMXX( str:string):bool
   var l1 = strlen(str);
   var s1, s2;
   if( l1 != 5)
      return false;
   end;

   s1 = SubStr(str, 1, 3);
   s2 = SubStr(str, 4, 2);

   if( s1 != "TOM")
      return false;
   end;

   if((s2 == "1D") OR (s2 == "1W") OR (s2 == "1M") OR (s2 == "1Y")
      OR (s2 == "2W") OR (s2 == "2M") OR (s2 == "3M") OR (s2 == "6M") OR (s2 == "9M"))
      return true;
   end;
   return false;
end;

macro _DVFXDeal_CreateNew( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING ):INTEGER

  record Party(party);
  record fininstr(fininstr);
  var dvndeal = TRecHandler( "dvndeal.dbt" );
  var dvnfi  = TRecHandler( "dvnfi.dbt" );
  var dvnfi_2 = null;
  var koper    = TBFile( "oprkoper", "R", 0 );
  var spgrdoc = TRecHandler("spgrdoc.dbt");
  var request = TRecHandler("dl_req.dbt");
  var RG;
  var type, stat = 0;
  var StrTempParm:string = "";
  VAR ErrMes:string;
  var ComisContrID;
  var ArrComSums = TArray();/*список комиссиий*/
  var Код_ФинИн;
  var Код_Субъекта;
  var FromReuters = false;
  var FromOutSystem = false;
  var ClntRep = TRecHandler("spground.dbt");
  var BuySell = "";
  var MaxExecDate = date(0,0,0), PeriodCLS = -1;
  var ServKind = -1;
  var clsFieldName="";
  var clsFieldVale = "", clsSubStr = "", clsPos_ = 0, clsStartPos = 0;
  var ExtBuff = TRecHandler("dl_extsettlecode.dbt"); 
  var Analytics = TRecHandler("dl_extscanalytics.dbt");
  var ExtCode = "";
  var dealId:integer = 0;
  var clientId:integer = 0;
  var dealDate:date = Date();
  var MsgArr = TArray();
  var LimitsCheckDate:date = Date();
  var ClientCodeForMsg:string = "<ошибка>";
  var dealExtCode:string = "";
  var trader_code:string = "";
  var IsMarginCall:bool = false;
  var cmd, DataSet;

  var CUX23Code:string = "";
//dan>
  var u_dlmarket = TRecHandler("dlmarket.dbt");
//<dan

  dvndeal.Clear();
  dvnfi.Clear();
  ClntRep.Clear();
  spgrdoc.Clear();

  RG = TGTRecord();
  RG.LoadFromDB(RecordID);

  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;

  VAR SourceID = RG.GetSourceID();

  if( RG.LoadFromDB(RecordID) != true )
     Comment = "Ошибка при загрузке параметров конверсионной операции ФИССиКО из шлюза." + RG.GetLastError();
     return 1;
  end;

  FromReuters = ((SourceID == GT_REUTDV) or (SourceID == GT_REUTDV_NEW));
  FromOutSystem = ((SourceID == GT_FRX_BLB) or (SourceID == GT_FRX_ALPHA));

  if( FromReuters )
     Код_ФинИн    = FICK_ISOSTRING;
     Код_Субъекта = PTCK_REUTER;
  elif( FromOutSystem )
     Код_ФинИн    = 17/*FICK_EXTC*/;/*Код во внешней системе*/
     Код_Субъекта = 38;/*Код во внешней системе*/
  else
     Код_ФинИн    = FICK_MICEX;
     Код_Субъекта = PTCK_MICEX;
  end;

   if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) )
     if( (GetParmByName( RG, "RGDV_PROGNOS", @StrTempParm, @type ) == NULL) OR (type != V_STRING) )
     else
         if(StrTempParm == "D")
            var  DealCode:String = "";
            // найти и удалить сделку с CODE из RGDVNDL_CODE
            if( (GetParmByName( RG, "RGDVFXDL_CODE", @DealCode, @type ) == NULL) OR (type != V_STRING) or (DealCode=="") )
               SetError( "Не найден либо неверно задан номер сделки для удаления (параметр RGDVFXDL_CODE объекта " + String(RecordID) + ")");
            end;
            // Delete deal here
            RG_GetIDForDealcode(dealcode, @dealId, @clientId, @dealDate, @dealExtCode);
            LimitsCheckDate = dealDate;
            if(clientId != -1)
               ClientCodeForMsg = RGDLFUN_GetMMVBCODE_ByClientID( clientId, PTSK_CM, dealDate, dealcode);
            end;
            stat = DV_DeleteNDeal(DealCode);
            if(stat != 0)
               SetError("Ошибка при удалении сделки с номером " + dealExtCode + ". " + GetErrMsg());
            end;
            if((clientId != -1) and RG_CheckLimitsMMVBCurr_AfterDate( LimitsCheckDate))
               RG_AddLimitMsg(ClientCodeForMsg, MsgArr);
            end;
            if(clientId != -1)
               Comment = "Внимание! Удалена сделка " + dealExtCode + " клиента " + ClientCodeForMsg + ", которая не подтвердилась биржевым файлом.";
            else
               Comment = "Внимание! Удалена сделка " + dealExtCode + ", которая не подтвердилась биржевым файлом.";
            end;
            ID = "Delete_DVNDeal_" + string( dealId );
            if(MsgArr.Size > 0)
                  Comment = Comment + RG_DumpMsgStr(MsgArr);
            end;
            return 0;

         end;
     end;
   end;

  if( (GetParmByName( RG,"RGDVFXDL_KIND", @dvndeal.rec.Kind, @type)  == NULL) OR (type != V_INTEGER) )
     SetError( "Не найден либо неверно задан вид операции (параметр RGDVFXDL_KIND объекта " + String(RecordID) + ")" );
  else
     koper.Clear();
     koper.rec.Kind_Operation = dvndeal.rec.Kind;

     if( koper.GetEQ() )
        if( (koper.rec.DocKind != DL_DVFXDEAL) and (koper.rec.DocKind != DL_DVNDEAL) )
           SetError( "Операция " +  string(dvndeal.rec.Kind) + " не является конверсионной операцией ФИССиКО." );
        end;
        dvndeal.rec.DocKind = koper.rec.DocKind;
     else
        SetError( "Не найден вид операции " + string(dvndeal.rec.Kind) + " (параметр RGDVFXDL_KIND объекта " + String(RecordID) + ")");
     end;
  end;

  if( (dvndeal.rec.Kind != ПИКО_ПокупкаПродажа) and (dvndeal.rec.Kind != КороткийСВОП) and (dvndeal.rec.Kind != ПИКО_ПокупкаПродажа_Кл) and (dvndeal.rec.Kind != КороткийСВОП_Кл)) /*bpv*/
     SetError("Неверно задан вид операции " + string(dvndeal.rec.Kind) + " (параметр RGDVFXDL_KIND объекта " + String(RecordID) + ").\n"+
              "В ФИССиКО загружаются операции вида " + string(ПИКО_ПокупкаПродажа) + "," + string(КороткийСВОП) + "," + string(КороткийСВОП_Кл));
  end;

  if(( dvndeal.rec.Kind == КороткийСВОП ) or ( dvndeal.rec.Kind == КороткийСВОП_Кл ))
     dvndeal.rec.DocKind = DL_DVNDEAL;
     dvndeal.rec.IsPFI = UNSET_CHAR;/*BPV короткие не могут быть ПФИ*/
  else
     dvndeal.rec.DocKind = DL_DVFXDEAL;
  end;

  if(( dvndeal.rec.Kind == ПИКО_ПокупкаПродажа ) or  (dvndeal.rec.Kind == ПИКО_ПокупкаПродажа_Кл ))/*bpv*/
     dvndeal.rec.DVKind = DV_FORWARD_FX;
  elif(( dvndeal.rec.Kind == КороткийСВОП ) or ( dvndeal.rec.Kind == КороткийСВОП_Кл ))
     dvndeal.rec.DVKind = DV_CURSWAP_FX;
  end;

   if((SourceID == GT_VR_ASTS) AND RG_DVNDealNeedPrognos(dvndeal.rec.Kind) )
      dvndeal.rec.Prognos = SET_CHAR;
   else
      dvndeal.rec.Prognos = UNSET_CHAR;
   end;

  dvndeal.rec.State = DVDEAL_PREP;
  dvndeal.rec.ParentID = -1;
  dvndeal.rec.AutoClose = UNSET_CHAR;
  dvndeal.rec.FromImport = SET_CHAR;

  if(dvndeal.rec.DVKind == DV_CURSWAP_FX )
    dvnfi.rec.AccFIID = ALLFININSTR;
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     dvndeal.rec.Sector     = SET_CHAR;
     dvndeal.rec.MarketKind = DV_MARKETKIND_CURRENCY;
  else/*FromReuters or FromOutSystem*/
     dvndeal.rec.Sector = UNSET_CHAR;
     dvndeal.rec.MarketKind = 0;/*Не заполняется*/
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     if( GetRealID(RG_PARTY, MMVB_CODE/*ContractorCode*/, PTCK_CONTR, @dvndeal.rec.MarketID, @ErrMes) != 0 )
        SetError(ErrMes);
     end;

     if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) ) //В прогнозных сделках валютного рынка схема расчетов не заполняется
     if( (GetParmByName( RG,"RGDVFXDL_EXTSETTLECODE", @ExtCode, @type)  == NULL) OR (type != V_STRING) )
        SetError( "Не найден либо неверно задан расчетный код (параметр RGDVFXDL_EXTSETTLECODE объекта " + String(RecordID) + ")" );
     else
        if( FindDL_EXTSETTLECODEbyCode(ExtCode, ExtBuff) != 0 )
           ErrMes = GetErrMsg();
           if( ErrMes != "" )
              SetError("Расчетный код " + ExtCode + " не может быть использован.\n" + ErrMes);
           else
              SetError("В справочнике расчетных кодов банка не найден код " + ExtCode + ".");
           end; 
        end; 
        if( ExtBuff.rec.InPool == SET_CHAR ) 
           if( FindDL_EXTSCANALYTICSbyMarketKind(IIF(ExtBuff.rec.ParentID == 0, ExtBuff.rec.ID, ExtBuff.rec.ParentID), DL_MARKETKIND_SETTLE_CURRENCY, Analytics) == 0 )
              dvndeal.rec.MarketSchemeID = Analytics.rec.MarketSchemeID;
           else 
              dvndeal.rec.MarketSchemeID = ExtBuff.rec.MarketSchemeID;
           end;
        else 
          dvndeal.rec.MarketSchemeID = ExtBuff.rec.MarketSchemeID;
          dvndeal.rec.MarketID = ExtBuff.rec.MarketID;
        end;
     end;
  end;
  end;


  if( (GetParmByName( RG, "RGDVFXDL_BUYSELL", @BuySell, @type ) == NULL) OR (type != V_STRING) )
     SetError( "Не найдено либо неверно задано направление операции (параметр RGDVFXDL_BUYSELL объекта " + String(RecordID)+ ")" );
  end;

  if((dvndeal.rec.Kind == КороткийСВОП) or ( dvndeal.rec.Kind == КороткийСВОП_Кл ))
     if( BuySell == "B" )
        dvndeal.rec.Type = ALG_DV_BS;
     elif( BuySell == "S" )
        dvndeal.rec.Type = ALG_DV_SB;
     end;
  else
     if( BuySell == "B" )
        dvndeal.rec.Type = ALG_DV_BUY;
     elif( BuySell == "S" )
        dvndeal.rec.Type = ALG_DV_SALE;
     end;
  end;

  if( (GetParmByName( RG, "RGDVFXDL_DATE", @dvndeal.rec.Date, @type ) == NULL) OR (type != V_DATE) )
     SetError( "Не найдена либо неверно задана дата операции (параметр RGDVFXDL_DATE объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG, "RGDVFXDL_EXTCODE", @dvndeal.rec.ExtCode, @type ) == NULL) OR (type != V_STRING) )
     SetError( "Не найден либо неверно задан внешний код сделки (параметр RGDVFXDL_EXTCODE объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG, "RGDVFXDL_TIME", @dvndeal.rec.Time, @type ) == NULL) OR (type != V_TIME) )
     SetError( "Не найдено либо неверно задано время операции (параметр RGDVFXDL_TIME объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG, "RGDVFXDL_TRADERCODE", @trader_code, @type ) == NULL) OR (type != V_STRING) )
     trader_code = "";
  end;

  dvndeal.rec.Country = DL_GetCountryByCodeLat3("RUS",true).CountryID;
  if( dvndeal.rec.Country <= 0 )
     SetError( "Не определен ID страны с лат. кодом \"RUS\"." );
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )

     if( (GetParmByName( RG, "RGDVFXDL_CODE", @dvndeal.rec.Code, @type ) == NULL) OR (type != V_STRING) or (dvndeal.rec.Code=="") )
        SetError( "Не найден либо неверно задан номер сделки (параметр RGDVFXDL_CODE объекта " + String(RecordID) + ")");
     end;

     if( (GetParmByName( RG, "RGDVFXDL_REQCODE", @dvndeal.rec.ReqCode, @type ) == NULL) OR (type != V_STRING) or (dvndeal.rec.ReqCode == "") )
        SetError( "Не найден либо неверно задан номер связанной заявки-поручения (параметр RGDVFXDL_REQCODE объекта " + String(RecordID) + ")");
     end;

     if( GetRealID(RG_PARTY, ContractorCode, PTCK_CONTR, @dvndeal.rec.Contractor, @ErrMes) != 0 )
        SetError( ErrMes );
     end;
     if ((dvndeal.rec.kind == ПИКО_ПокупкаПродажа_Кл) or (dvndeal.rec.kind == КороткийСВОП_Кл))
        ComisContrID = RGDLFUN_GetContrID( 21, dvndeal.rec.Contractor, {OurBank}, dvndeal.rec.Date, NULL, NULL, @ErrMes );
     else
        ComisContrID = RGDLFUN_GetContrID( PTSK_DV, dvndeal.rec.Contractor, {OurBank}, dvndeal.rec.Date, NULL, NULL, @ErrMes );
     end;
     if( ComisContrID <= 0 )
        //SetError(ErrMes);
        return SetWarning(@comment, ErrMes );
     end;
    
     dvndeal.rec.Agent = UnknownParty;
    
     dvndeal.rec.Client = UnknownParty;
     if( (GetParmByName( RG,"RGDVFXDL_CLIENT", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     else
  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
           ServKind = PTSK_CM;
        else
           ServKind = PTSK_DV;
        end;
        if( GetRealID(RG_PARTY, StrTempParm, Код_Субъекта, @dvndeal.rec.Client, @ErrMes, true, ServKind, dvndeal.rec.Date, @dvndeal.rec.ClientContr, dvndeal.rec.MarketID) != 0 )
           //SetError( ErrMes );
           return SetWarning(@comment, ErrMes );
        end;
        if( dvndeal.rec.Client != UnknownParty )
           if(ПолучитьСубъекта(dvndeal.rec.Client, Party))
              //SetError( "Не найден идентификатор клиента" + string(dvndeal.rec.Client) + ", заданного в параметре RGDVFXDL_CLIENT объекта " + String(RecordID) );
              return SetWarning(@comment,"Не найден идентификатор клиента" + string(dvndeal.rec.Client) + ", заданного в параметре RGDVFXDL_CLIENT объекта " + String(RecordID) );
           end;
           ClientCodeForMsg = StrTempParm; // биржевой код подтвердили, сохраним для сообщений.           
           if( dvndeal.rec.ClientContr <= 0 )
              dvndeal.rec.ClientContr = RGDLFUN_GetContrID( ServKind, {OurBank}, dvndeal.rec.Client, dvndeal.rec.Date, NULL, NULL, @ErrMes );
              if( dvndeal.rec.ClientContr <= 0 )
                 //SetError(ErrMes);
                 return SetWarning(@comment, ErrMes);
              end;
           end;
        end;
     end;
  else/*FromReuters or FromOutSystem*/
     dvndeal.rec.Client = UnknownParty;/*Не заполняется*/

     if( (GetParmByName( RG, "RGDVFXDL_CONTRCODE", @StrTempParm, @type ) == NULL) OR (type != V_STRING) or (StrTempParm=="") )
        SetError( "Не найден либо неверно задан код контрагента сделки (параметр RGDVFXDL_CONTRCODE объекта " + String(RecordID) + ")");
     end;
     /*Субъект, у которого код вида 7 <Reuters> равен значению из поля */
     if( GetRealID(RG_PARTY, StrTempParm, Код_Субъекта, @dvndeal.rec.Contractor, @ErrMes) != 0 )
       // SetError( ErrMes );
        return SetWarning(@comment, ErrMes);
     end;

     dvndeal.rec.Agent = UnknownParty;
     if( (GetParmByName( RG,"RGDVFXDL_BROKERCODE", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     else
        if( GetRealID(RG_PARTY, StrTempParm, Код_Субъекта, @dvndeal.rec.Agent, @ErrMes) != 0 )
          // SetError( ErrMes );
           return SetWarning(@comment, ErrMes);
        end;
        dvndeal.rec.AgentContr = RGDLFUN_GetContrID( PTSK_DV, dvndeal.rec.Agent, {OurBank}, dvndeal.rec.Date, NULL, NULL, @ErrMes );
        if( dvndeal.rec.Agent <= 0 )
          // SetError(ErrMes);
           return SetWarning(@comment, ErrMes);
        end;
     end;

     if( (GetParmByName( RG,"RGDVFXDL_COMMENT", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     else
        dvndeal.rec.Comment = StrTempParm;
     end;

     /*Признак обратной котировки*/
     dvnfi.rec.ISINVERSE = UNSET_CHAR;
     if( (GetParmByName( RG,"RGDVFXDL_REVRATE", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     else
        if( StrTempParm == SET_CHAR )
           dvnfi.rec.ISINVERSE = SET_CHAR;
        end;
     end;
  end;

  dvndeal.rec.Department = {OperDprt};
  dvndeal.rec.Oper       = {Oper};

  dvnfi.rec.Type = DV_NFIType_BaseActiv;
  if( (GetParmByName( RG, "RGDVFXDL_FACEVALUE", @dvnfi.rec.Scale, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi.rec.Scale == 0.0))
    dvnfi.rec.Scale = 1;
  end;

  if( (GetParmByName( RG, "RGDVFXDL_EXECDATE", @dvnfi.rec.SuplDate, @type ) == NULL) OR (type != V_DATE) )
     SetError( "Не найдена либо неверно задана дата валютирования (параметр RGDVFXDL_EXECDATE объекта " + String(RecordID) + ")");
  end;
  if(( dvndeal.rec.Kind == КороткийСВОП ) or ( dvndeal.rec.Kind == КороткийСВОП_Кл) )
     dvndeal.rec.BeginDate = dvnfi.rec.SuplDate;
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     dvnfi.rec.PayDate = dvnfi.rec.SuplDate;
  else
     if( (GetParmByName( RG, "RGDVFXDL_DATE_CA", @dvnfi.rec.PayDate, @type ) == NULL) OR (type != V_DATE) )
        SetError( "Не найдена либо неверно задана дата валютирования КА (параметр RGDVFXDL_DATE_CA объекта " + String(RecordID) + ")");
     end;
  end;

  if( (GetParmByName( RG, "RGDVFXDL_AMOUNT", @dvnfi.rec.Amount, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi.rec.Amount == 0.0))
     SetError( "Не найдено либо неверно задано количество БА по сделке (параметр RGDVFXDL_AMOUNT объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG, "RGDVFXDL_POINT", @dvnfi.rec.Point, @type) == NULL) OR (type != V_INTEGER) )
     dvnfi.rec.Point = 4;
  end;

  if( (GetParmByName( RG, "RGDVFXDL_PRICE", @dvnfi.rec.Price, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi.rec.Price == 0.0))
     SetError( "Не найден либо неверно задан курс по сделке (параметр RGDVFXDL_PRICE объекта " + String(RecordID) + ")");
  else
  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
        if( (GetParmByName( RG, "RGDVFXDL_COST", @dvnfi.rec.Cost, @type) == NULL) OR (type != V_DOUBLE) OR (dvnfi.rec.Cost == $0.0) )
           SetError( "Не найдено либо неверно задано количество КА по сделке (параметр RGDVFXDL_COST объекта " + String(RecordID) + ")");
        end;
     else/*FromReuters or FromOutSystem*/
        /*рассчитывается на основании суммы БА и курса сделки*/
        if( dvnfi.rec.ISINVERSE == SET_CHAR )
           dvnfi.rec.Cost = round(double(1/dvnfi.rec.Price * dvnfi.rec.Amount),2);
        else
           dvnfi.rec.Cost = round(double(dvnfi.rec.Price * dvnfi.rec.Amount),2);
        end;
     end;
  end;

  if( (GetParmByName( RG, "RGDVFXDL_PRICEFIID", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     SetError( "Не найден либо неверно задан финансовый инструмент в качестве КА по сделке (параметр RGDVFXDL_PRICEFIID объекта " + String(RecordID) + ")");
  else
     if( GetRealID( RG_CURRENCY, StrTempParm, Код_ФинИн, @dvnfi.rec.PriceFIID, @ErrMes ) != 0 )
        //SetError( ErrMes );
        return SetWarning(@comment, ErrMes);
     end;
     if( ПолучитьФинИн(dvnfi.rec.PriceFIID, fininstr) )
        //SetError( "Не найден финансовый инструмент " + string(dvnfi.rec.PriceFIID) + ", заданный в параметре RGDVFXDL_PRICEFIID объекта " + String(RecordID) );
        return SetWarning(@comment, "Не найден финансовый инструмент " + string(dvnfi.rec.PriceFIID) + ", заданный в параметре RGDVFXDL_PRICEFIID объекта " + String(RecordID));
     end;
  end;

  if( (GetParmByName( RG,"RGDVFXDL_ISIN", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     //SetError( "Не найден либо неверно задан финансовый инструмент в качестве БА по сделке (параметр RGDVFXDL_ISIN объекта " + String(RecordID) + ")");
     return SetWarning(@comment, "Не найден либо неверно задан финансовый инструмент в качестве БА по сделке (параметр RGDVFXDL_ISIN объекта " + String(RecordID) + ")");
  else
     if( GetRealID( RG_CURRENCY, StrTempParm, Код_ФинИн, @dvnfi.rec.FIID, @ErrMes ) != 0 )
        //SetError( ErrMes );
        return SetWarning(@comment, ErrMes);
     end;
     if( ПолучитьФинИн(dvnfi.rec.FIID, fininstr) )
        //SetError( "Не найден финансовый инструмент " + string(dvnfi.rec.FIID) + ", заданный в параметре RGDVFXDL_ISIN объекта " + String(RecordID) );
        return SetWarning(@comment, "Не найден финансовый инструмент " + string(dvnfi.rec.FIID) + ", заданный в параметре RGDVFXDL_ISIN объекта " + String(RecordID) );
     end;
  end;

  dvnfi.rec.ExecDate = min(dvnfi.rec.SuplDate,dvnfi.rec.PayDate);
  MaxExecDate = max(dvnfi.rec.SuplDate,dvnfi.rec.PayDate);

  if(( dvndeal.rec.Kind == КороткийСВОП ) or ( dvndeal.rec.Kind == КороткийСВОП_Кл ))
     dvnfi_2 = TRecHandler("dvnfi.dbt");

     dvnfi.rec.Type = DV_NFIType_BaseActiv2;
     dvnfi_2.rec.Scale = dvnfi.rec.Scale;
     dvnfi_2.rec.Point = dvnfi.rec.Point;
     dvnfi_2.rec.ISINVERSE = dvnfi.rec.ISINVERSE;
     dvnfi_2.rec.AccFIID   = ALLFININSTR;

     if( (GetParmByName( RG, "RGDVFXDL_EXECDATE_2", @dvnfi_2.rec.SuplDate, @type ) == NULL) OR (type != V_DATE) )
        SetError( "Не найдена либо неверно задана дата валютирования (параметр RGDVFXDL_EXECDATE_2 объекта " + String(RecordID) + ")");
     end;

     if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )

        GetParmByName(RG, "RGDVFXDL_CUX23CODE", @CUX23Code, @type);

        dvnfi_2.rec.PayDate = dvnfi_2.rec.SuplDate;

        if( (GetParmByName( RG,"RGDVFXDL_AMOUNT_2", @dvnfi_2.rec.Amount, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi_2.rec.Amount == 0.0))
           SetError( "Не найдено либо неверно задано количество БА по сделке (параметр RGDVFXDL_AMOUNT_2 объекта " + String(RecordID) + ")");
        end;
       
        if( (GetParmByName( RG,"RGDVFXDL_PRICE_2", @dvnfi_2.rec.Price, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi_2.rec.Price == 0.0))
           SetError( "Не найден либо неверно задан курс по сделке (параметр RGDVFXDL_PRICE_2 объекта " + String(RecordID) + ")");
        end;
       
        if( (GetParmByName( RG,"RGDVFXDL_COST_2", @dvnfi_2.rec.Cost, @type) == NULL) OR (type != V_DOUBLE) OR (dvnfi_2.rec.Cost == $0.0) )
           SetError( "Не найдено либо неверно задано количество КА по сделке (параметр RGDVFXDL_COST_2 объекта " + String(RecordID) + ")");
        end;
       
        if( (GetParmByName( RG, "RGDVFXDL_PRICEFIID_2", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
           //SetError( "Не найден либо неверно задан финансовый инструмент в качестве КА по сделке (параметр RGDVFXDL_PRICEFIID_2 объекта " + String(RecordID) + ")");
           return SetWarning(@comment, "Не найден либо неверно задан финансовый инструмент в качестве КА по сделке (параметр RGDVFXDL_PRICEFIID_2 объекта " + String(RecordID) + ")");
        else
           if( GetRealID( RG_CURRENCY, StrTempParm, Код_ФинИн, @dvnfi_2.rec.PriceFIID, @ErrMes ) != 0 )
              //SetError( ErrMes );
              return SetWarning( @comment, ErrMes );
           end;
           if( ПолучитьФинИн(dvnfi_2.rec.PriceFIID, fininstr) )
              //SetError( "Не найден финансовый инструмент " + string(dvnfi_2.rec.PriceFIID) + ", заданный в параметре RGDVFXDL_PRICEFIID_2 объекта " + String(RecordID) );
              return SetWarning(@comment,  "Не найден финансовый инструмент " + string(dvnfi_2.rec.PriceFIID) + ", заданный в параметре RGDVFXDL_PRICEFIID_2 объекта " + String(RecordID) );
           end;
        end;
       
        if( (GetParmByName( RG,"RGDVFXDL_ISIN_2", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
           SetError( "Не найдена либо неверно задан финансовый инструмент в качестве БА по сделке (параметр RGDVFXDL_ISIN_2 объекта " + String(RecordID) + ")");
        else
           if( GetRealID( RG_CURRENCY, StrTempParm, Код_ФинИн, @dvnfi_2.rec.FIID, @ErrMes ) != 0 )
              //SetError( ErrMes );
              return SetWarning( @comment, ErrMes );
           end;
           if( ПолучитьФинИн(dvnfi_2.rec.FIID, fininstr) != 0 )
              //SetError( "Не найден финансовый инструмент " + string(dvnfi_2.rec.FIID) + ", заданный в параметре RGDVFXDL_ISIN_2 объекта " + String(RecordID) );
              return SetWarning(@comment, "Не найден финансовый инструмент " + string(dvnfi_2.rec.FIID) + ", заданный в параметре RGDVFXDL_ISIN_2 объекта " + String(RecordID) );
           end;
        end;

     else/*FromReuters or FromOutSystem*/

        if( (GetParmByName( RG, "RGDVFXDL_DATE_CA_2", @dvnfi_2.rec.PayDate, @type ) == NULL) OR (type != V_DATE) )
           SetError( "Не найдена либо неверно задана дата валютирования КА 2 ч. (параметр RGDVFXDL_DATE_CA_2 объекта " + String(RecordID) + ")");
        end;

        dvnfi_2.rec.Amount    = dvnfi.rec.Amount;
        dvnfi_2.rec.PriceFIID = dvnfi.rec.PriceFIID;
        dvnfi_2.rec.FIID      = dvnfi.rec.FIID;
        dvnfi_2.rec.ISINVERSE = dvnfi.rec.ISINVERSE;

        if( (GetParmByName( RG,"RGDVFXDL_PRICE_2", @dvnfi_2.rec.Price, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi_2.rec.Price == 0.0))
           SetError( "Не найден либо неверно задан курс по сделке (параметр RGDVFXDL_PRICE_2 объекта " + String(RecordID) + ")");
        else
           /*рассчитывается на основании суммы БА 2 ч. и курса 2 ч. сделки*/
           if( dvnfi_2.rec.ISINVERSE == SET_CHAR )
              dvnfi_2.rec.Cost = round(double(1/dvnfi_2.rec.Price * dvnfi_2.rec.Amount),6);
           else
              dvnfi_2.rec.Cost = round(double(dvnfi_2.rec.Price * dvnfi_2.rec.Amount),6);
           end;
        end;

     end;
     dvnfi_2.rec.ExecDate = min(dvnfi_2.rec.SuplDate,dvnfi_2.rec.PayDate);
     MaxExecDate = max(dvnfi_2.rec.SuplDate,dvnfi_2.rec.PayDate);
  end;

  /*Классификация срока*/
  clsFieldName = IIF(((dvndeal.rec.Kind == КороткийСВОП) or (dvndeal.rec.Kind == КороткийСВОП_Кл) ),"RGDVFXDL_MAINSECSHORTNAME","RGDVFXDL_SECSHORTNAME");
  if( (GetParmByName( RG, clsFieldName, @clsFieldVale, @type) == NULL) OR (type != V_STRING) or (clsFieldVale == ""))
     SetError( "Не найден признак классификации срока сделки объекта " + String(RecordID) );
  else
    clsPos_ = Index(clsFieldVale, "_");
    if( (clsPos_ == 4) or (clsPos_ == 7) or (((dvndeal.rec.Kind == КороткийСВОП) or (dvndeal.rec.Kind == КороткийСВОП_Кл)) and (clsPos_ == 0)) or ((SourceID == GT_VR_ASTS) and (clsPos_ == 0)))
      if( (SourceID == GT_VR_ASTS) and ((dvndeal.rec.Kind == ПИКО_ПокупкаПродажа) or (dvndeal.rec.Kind == ПИКО_ПокупкаПродажа_Кл)) and (clsPos_ != 7) )
         clsStartPos = 10; //При онлайн-импорте вместо SecShortName передается SecurityId
      elif( clsPos_ != 0 )
         clsStartPos = clsPos_ + 1;
      else 
         clsStartPos = 7;
      end;
      clsSubStr = SubStr(clsFieldVale, clsStartPos, strlen(clsFieldVale)-clsStartPos+1);  
      if ((dvndeal.rec.Kind == КороткийСВОП) or (dvndeal.rec.Kind == КороткийСВОП_Кл))
         if ((clsSubStr == "TODTOM") or (clsSubStr == "TDTM") or (clsSubStr == "TDSTMS"))
            dvndeal.rec.PeriodCLS  = DV_PERIODCLS_T1;
         elif ((clsSubStr == "TOMSPT") or (clsSubStr == "TMSP") or checkTOMXX(clsSubStr))
            dvndeal.rec.PeriodCLS  = DV_PERIODCLS_T2;
         else
            SetError( "Даты валютирования 2ч. сделки не соответствуют ни одному из возможных сроков сделки: T+1, T+2. Сделка "+dvndeal.rec.ExtCode+" объекта " + String(RecordID));
         end;
      else
         if ((clsSubStr == "TOD") or (clsSubStr == "TDB") or (clsSubStr == "TDS"))
            dvndeal.rec.PeriodCLS  = DV_PERIODCLS_T0;
         elif ((clsSubStr == "TOM") or (clsSubStr == "TMB") or (clsSubStr == "TMS") or (clsSubStr == "DIS"))
            dvndeal.rec.PeriodCLS  = DV_PERIODCLS_T1;
         elif ((clsSubStr == "SPT") or (clsSubStr == "FWD") or (clsSubStr == "LTV"))
            dvndeal.rec.PeriodCLS  = DV_PERIODCLS_T2;
         else
            SetError( "Даты валютирования сделки не соответствуют ни одному из возможных сроков сделки: T0, T+1, T+2. Сделка "+dvndeal.rec.ExtCode+" объекта " + String(RecordID));
         end;
      end;
    else
      SetError( "Признак классификации срока сделки \""+clsFieldVale+"\" не соответствует требуемому формату по объекту "+String(RecordID));
    end;
  end;
  
  if(( dvndeal.rec.Kind == КороткийСВОП ) or ( dvndeal.rec.Kind == КороткийСВОП_Кл ))
     dvnfi.rec.ExecType = DVSETTLEMET_STATE;
     dvnfi_2.rec.ExecType = DVSETTLEMET_STATE;
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     var marketreportid, strSPGroundID;
     /* RGDVFXDL_MARKETREPORT_ID - Идентификатор документа-подтверждения */
     if( (GetParmByName( RG,"RGDVFXDL_MARKETREPORT_ID", @marketreportid, @type )  == NULL) OR (type != V_INTEGER)  )
        marketreportid = 0;
     end;
     if( (marketreportid > 0) AND (GetObjectCode(11 /*$(RS-Bank получатель)*/, marketreportid, @strSPGroundID) == 0) )
        if( strSPGroundID != "" )
           spgrdoc.rec.SPGroundID = int(strSPGroundID);
        end;
     end;
     
     ArrComSums.Size = 0;
     var CommDate = dvndeal.rec.Date;
     // is505810  по сделке заключенной в 19:30 биржа рассчитала комиссию день в день без переноса. Нужно ли вообще когда-лиоб делать такой перенос, пока неизвестно
     //if( (dvndeal.rec.Time > Time(19,0,0) ) and (SourceID != GT_VR) and (SourceID != GT_PAYMENTS_VR) and (SourceID != GT_VR_ASTS) )
     //   CommDate = GetDateAfterWorkDays(CommDate, 1);
     //end;
     
     var ArrComSums_i = 0, ComSum = $0;
     var dlcomis_market = TRecHandler( "dlcomis.dbt" );
     
     if( (GetParmByName(RG,"RGDVFXDL_AMOUNT_COMM", @ComSum, @type) == NULL) OR (type != V_MONEY) )
     elif( ComSum > $0.0 )
        dlcomis_market.Clear();
        if( not RG_InitDlComis("МскБиржВ", dlcomis_market, @ErrMes, SF_FEE_TYPE_PERIOD, ComSum, null, dvndeal.rec.ClientContr, CommDate) )
           SetError( ErrMes );
        else
           if(dlcomis_market.rec.isBankExpenses == SET_CHAR) 
           dlcomis_market.rec.Contract = ComisContrID;
              dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           elif(dvndeal.rec.Client != UnknownParty)
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           else
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = ComisContrID; 
           end;           
           dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
     
           ArrComSums_i = ArrComSums.Size;
           ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
           copy(ArrComSums(ArrComSums_i), dlcomis_market);
        end;
     end;
     
     if( (GetParmByName(RG,"RGDVFXDL_CLRCOMM", @ComSum, @type) == NULL) OR (type != V_MONEY) )
     elif( ComSum > $0.0 )
        dlcomis_market.Clear();
        if( not RG_InitDlComis("МскБиржКлирВ", dlcomis_market, @ErrMes, SF_FEE_TYPE_PERIOD, ComSum, null, dvndeal.rec.ClientContr, CommDate) )
           SetError( ErrMes );
        else
           if(dlcomis_market.rec.isBankExpenses == SET_CHAR) 
           dlcomis_market.rec.Contract = ComisContrID;
              dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           elif(dvndeal.rec.Client != UnknownParty)
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           else
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = ComisContrID; 
           end; 
           dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
     
           ArrComSums_i = ArrComSums.Size;
           ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
           copy(ArrComSums(ArrComSums_i), dlcomis_market);
        end;
     end;
     
     if( (GetParmByName(RG,"RGDVFXDL_ITSCOMM", @ComSum, @type) == NULL) OR (type != V_MONEY) )
     elif( ComSum > $0.0 )
        dlcomis_market.Clear();
        if( not RG_InitDlComis("МскБиржИТСВ", dlcomis_market, @ErrMes, SF_FEE_TYPE_PERIOD, ComSum, null, dvndeal.rec.ClientContr, CommDate) )
           SetError( ErrMes );
        else
           if(dlcomis_market.rec.isBankExpenses == SET_CHAR) 
           dlcomis_market.rec.Contract = ComisContrID;
              dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           elif(dvndeal.rec.Client != UnknownParty)
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           else
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = ComisContrID; 
           end; 
           dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
     
           ArrComSums_i = ArrComSums.Size;
           ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
           copy(ArrComSums(ArrComSums_i), dlcomis_market);
        end;
     end;
  end;

  if( SourceID == GT_FRX_BLB )
     dvndeal.rec.Netting = SET_CHAR;
  end;

  dvndeal.rec.KindDealPartyClient = -1;

  if( dvndeal.rec.Client != UnknownParty )
     DL_СкорректироватьДатуЗаявки(dvndeal.rec.Date, dvndeal.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
     ClntRep.rec.XLD = DL_СформироватьНомерЗаявки(-1, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
     ClntRep.rec.SignedDate = ClntRep.rec.RegistrDate;
     ClntRep.rec.SignedTime = ClntRep.rec.RegistrTime;
  end;

  var IpmVR = false;
  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     IpmVR = true;
  end;

var InsertDeal = true;
   //var MsgArr = TArray();
   if( ((SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR)) and (dvndeal.rec.Prognos == UNSET_CHAR) and RG_DVNDealNeedPrognos(dvndeal.rec.Kind))
   //сверяем сделку с прогнозной
      LimitsCheckDate = dvndeal.rec.Date;
      stat = RG_DvndealReconcile(dvndeal, dvnfi, dvnfi_2, ArrComSums, MsgArr, ClientCodeForMsg);
      if(stat == RG_Reconcile_OK) // нет расхождений
         // Clear Prognos
         if(RG_ClearPrognosAndAddSchemeID(dvndeal.rec.Code, dvndeal.rec.MarketSchemeID) != 0)
            SetError("Ошибка при снятии признака \"Прогноз\" и установке схемы расчетов по сделке " + dvndeal.rec.ExtCode + ".");
         end;
         InsertDeal = false;
      elif(stat == RG_Reconcile_NoDeal) // нет сделки
         InsertDeal = true;
         RG_AddNewDealMsg(dvndeal.rec.ExtCode, dvndeal.rec.Client, ClientCodeForMsg, MsgArr);
         if((dvndeal.rec.Client != -1) and RG_CheckLimitsMMVBCurr_AfterDate( LimitsCheckDate))
            RG_AddLimitMsg(ClientCodeForMsg, MsgArr);
         end;
      elif((stat == RG_Reconcile_NoData) or (stat == RG_Reconcile_BadData)) // сделка есть, но неправильная
         SetError("Невозможно обновить сделку " + dvndeal.rec.ExtCode + ". ");
      elif(stat == RG_Reconcile_Discrepancy) // есть расхождения
         // Delete old deal
         stat = DV_DeleteNDeal(dvndeal.rec.Code);
         if(stat != 0)
            SetError("Ошибка при удалении сделки с номером " + dvndeal.rec.ExtCode + ". " + GetErrMsg());
         end;
         InsertDeal = true;
         if((dvndeal.rec.Client != -1) and RG_CheckLimitsMMVBCurr_AfterDate( LimitsCheckDate))
            RG_AddLimitMsg(ClientCodeForMsg, MsgArr);            
         end;
      end;
   end;

   if(InsertDeal)
      var errstr = "";
      if (dvndeal.rec.ClientContr > 0)
         RG_CheckAndOpenDBOAccounts(dvndeal.rec.ClientContr, dvnfi.rec.FIID, dvnfi.rec.PriceFIID, dvndeal.rec.Date);
         RG_DropInvalidSFILinks(OBJTYPE_SFCONTR, dvndeal.rec.ClientContr);
      end;
      // BIQ-9103, при вставке сделки заполняем MethodApplic и IsMarginCall
      IsMarginCall = Index(StrLwr(trader_code), "mc") > 0;
      dvndeal.rec.MethodApplic = DL_REQ_METHODAPPLIC_EDOC;
      SetMethodApplic(trader_code, @dvndeal.rec.MethodApplic);
      stat = DV_InsertNDeal(dvndeal, dvnfi, dvnfi_2, null, spgrdoc, ArrComSums, ClntRep, IpmVR, null, null, null, null, IsMarginCall);

      if( stat == 30729 ) // Ошибка "Не найдена запись СПИ"
        if(not RG_InsertSettaccSsfi(dvndeal.rec.ClientContr, dvnfi.rec.FIID, @errstr))
         if(not RG_InsertSettaccSsfi(dvndeal.rec.ClientContr, dvnfi.rec.PriceFIID, @errstr))
           stat = DV_InsertNDeal(dvndeal, dvnfi, dvnfi_2, null, spgrdoc, ArrComSums, ClntRep, IpmVR, null, null, null, null, IsMarginCall);
         end;
       end;
     end;

     if( stat != 0 )
       SetError("Ошибка при вставке отложенной сделки с ПИ.\n"+GetErrMsg() + IIF(errstr == "", "", "\n" + errstr));
     else
       /*вставка примечания "Номер операции по CUX23"*/
       if( (CUX23Code != NULL) and (CUX23Code != "") )
         if( addNoteForObject( OBJTYPE_OUTOPER_DV,
                               UniID(dvndeal, OBJTYPE_OUTOPER_DV),
                               NOTEKIND_DVNDEAL_CUX23CODE,
                               CUX23Code,
                               dvndeal.rec.Date ) )
           SetError("Ошибка при установке примечания \"Номер операции по CUX23\" для объекта " + String(RecordID));
         end;
       end;
       // BIQ-9103, если в примечании есть подстрока 'mc', заполним категорию
        if( IsMarginCall == true )
          if( ( not DisconnectObjAttr(OBJTYPE_FXOPER_DV,  UniID(dvndeal, OBJTYPE_FXOPER_DV), MARGINCALL_CATEGORY) ) OR
              ( not ConnectObjAttr(stat, OBJTYPE_FXOPER_DV, UniID(dvndeal, OBJTYPE_FXOPER_DV), MARGINCALL_CATEGORY, 1/*Да*/, null, null, dvndeal.rec.Date) ) OR
              ( stat != 0 ) )
              SetError("Ошибка при установке категории 'Margin Call' для объекта " + String(RecordID));
          end;
        end;
        if(trader_code != "")
          if( addNoteForObject( OBJTYPE_FXOPER_DV, UniID(dvndeal, OBJTYPE_FXOPER_DV), 150, trader_code, dvndeal.rec.Date ) )
            SetError("Ошибка при установке примечания \"Трейдер\" для объекта " + String(RecordID));
          end;
          if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) )
            //DEF-76287 Если заявка загрузилась до связанных с ней сделок, то также необходимо заполнить кодом трейдера примечание 102 для заявки
            cmd = DL_RSDCommand("SELECT * " +
                                "  FROM ddl_req_dbt " +
                                " WHERE t_kind = ? " +
                                "   AND t_codets = ? " +
                                "   AND t_marketKind = ? " +
                                "   AND t_marketID = ? ");
            cmd.AddParam(350/*DOCKIND_REQ_CLIENT_DEAL*/);
            cmd.AddParam(dvndeal.rec.ReqCode);
            cmd.AddParam(DV_MARKETKIND_CURRENCY);
            cmd.AddParam(dvndeal.rec.MarketID);
          
            DataSet = cmd.Execute();
            if(DataSet.MoveNext())
              DataSet.GetRecord().CopyTo(request.rec);
              addNoteForObject(149, UniID(request, 149), 102, trader_code, request.rec.Date); //Примечание вставится только в том случае, если его еще нет
            end;
          end;
        end;
      end;
   end;

   if(InsertDeal)
      ID = string( dvndeal.rec.ID );
      Comment = "В ФИССиКО создана конверсионная операция № " + dvndeal.rec.ExtCode + ". DealID = " + dvndeal.rec.ID + ".";
   else
      RG_GetIDForDealcode(dvndeal.rec.Code, @dealId, @clientId, @dealDate, @dealExtCode);
      ID = string( dealId );
      Comment = "В ФИССиКО обновлена конверсионная операция № " + dvndeal.rec.ExtCode + ". DealID = " + dealId + ".";
   end;

  if(MsgArr.Size > 0)
      Comment = Comment + RG_DumpMsgStr(MsgArr);
  end;

return 0;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = ErrorText;
   else
      Comment = RslErrObj.Message;
   end;
   return 1;
end;


macro _DVFXDeal_Remove( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING ):INTEGER

  var RG;
  var type, stat = 0;
  var StrTempParm:string = "";
  VAR ErrMes:string;

  RG = TGTRecord();
  RG.LoadFromDB(RecordID);

  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;

  VAR SourceID = RG.GetSourceID();

  if( RG.LoadFromDB(RecordID) != true )
     Comment = "Ошибка при загрузке параметров конверсионной операции ФИССиКО из шлюза." + RG.GetLastError();
     return 1;
  end;

   if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) )
     if( (GetParmByName( RG, "RGDV_PROGNOS", @StrTempParm, @type ) == NULL) OR (type != V_STRING) )
     else
         if(StrTempParm == "D")
            var  DealCode:String = "";
            // найти и удалить сделку с CODE из RGDVNDL_CODE
            if( (GetParmByName( RG, "RGDVFXDL_CODE", @DealCode, @type ) == NULL) OR (type != V_STRING) or (DealCode=="") )
               SetError( "Не найден либо неверно задан номер сделки для удаления (параметр RGDVFXDL_CODE объекта " + String(RecordID) + ")");
            end;
            // Delete deal here
            stat = DV_DeleteNDeal(DealCode);
            if(stat != 0)
               SetError("Ошибка при удалении сделки с номером " + DealCode + ". " + GetErrMsg());
            end;
            Comment = "Внимание! Удалена сделка " + DealCode + " клиента <clentcode>, которая не подтвердилась биржевым файлом.";
            // return 0;

         end;
     end;
   end;

  return 0;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = ErrorText;
   else
      Comment = RslErrObj.Message;
   end;
   return 1;
end;
	

