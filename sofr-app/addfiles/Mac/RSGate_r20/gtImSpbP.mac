/*
$Name:        gtImSpbP.mac
$Module:      Шлюз Securities
$Description: Импорт объектов биржи "ПАО СПБ" с пом. Payments
*/
import "gtImSpbP_DL.mac", "secinter.mac", "gtmktrep.mac", "loadRUData.mac";

private var USE_STORPROC_CREATEREPL:bool = false; //Использовать ХП для создания объектов записей репликаций

private var NumImportDeals = 0, NumImportDealsTotal = 0;
private var calendId_Nat_Settl = 0, calendId_Settl = 0, calendId_Nat_Trd = 0, calendId_Trd = 0, MarketID = 0, CPFirmId = -1, CurrencyId = -1, calendId = -1, Portfolio_ = -1;
private var ClientID = 0, ClientContrID = 0, MarketSchemeID = 0;
private var CPFirmIdConst:string = "";
private var PaymDate1_ = date(0,0,0), PaymDate2_ = date(0,0,0), CalcItogDate_ = date(0,0,0), WorkSettleDate_ = date(0,0,0), SettleDate2_:date = Date(0,0,0);
private var NDay1_:integer = 0, NDay2_:integer = 0;
private var Progress = TProgressBar;
private var RECORDID_MarketReport:integer = 0;
private const SPB_CODE = "ПАО СПБ";    /* код СПБ */

private const IsRSHB = 1;

private class DataReq()
  var BuySell   :string,
      EntryTime :time,
      AmendTime :time,
      Status    :string,
      ClientCode:string,
      OrderNo   :string,
      TradeDate :date,
      RepoRate  :double,
      RecNo     :integer,
      SecurityId:string,
      Quantity  :money,
      Price     :double,
      PriceType :string,
      CurrencyId:string,
      TrdAccId  :string,
      RepoValue :money,
      IsTrust   :bool,
      IsSEB     :bool,
      OrdTypeCode:string,
      PriceFIID :string,
      IsAddress :string,
      PartyId   :integer,    
      SfcontrID :integer,
      Commentar :string;    

  macro Init()
      BuySell   = Status = OrderNo = SecurityId = ClientCode = PriceType = PriceFIID = CurrencyId = TrdAccId = IsAddress = Commentar = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = 0;
      RepoRate  = Price = 0.0;
      TradeDate = date(0,0,0);
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = false;
  end;

  macro InitRecords()
      BuySell   = Status = OrderNo = SecurityId = ClientCode = PriceType = PriceFIID = CurrencyId = TrdAccId = IsAddress = Commentar = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = 0;
      RepoRate  = Price = 0.0;
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = false;
  end;

end;

private var Req = DataReq();

private const PNFLD_IMPDATE         = 0,
              PNFLD_REQUEST         = 1, 
              PNFLD_SECUR           = 2, 
              PNFLD_CLEARING_CLIENT = 3,
              PNFLD_SEC_BO          = 4,
              PNFLD_NETTOITOG       = 5,
              PNFLD_MONEYMOTION     = 6;

private record pp(IMPSPBPM, "rgate.lbr") dialog;

private macro FileDateInName(date_val)
   var day, month, year;
   DateSplit(date_val,day,month,year);

   return RGDLFUN_LZ(year,4) + "-" + RGDLFUN_LZ(month,2) + "-" + RGDLFUN_LZ(day,2);
end;

private macro IsCliringData():bool

  if( FileImport != FileMFB06C )
     return false;
  end;

  if(    ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи

      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 

      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО  
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 
    )
     return true;
  end;

  return false;
END;

private macro GetPrmStr(Pan:variant) :string
  var str:string;

   str = "deals_bo=" + RG_IIF(Pan.deals_bo == SET_CHAR, "1", "0");
   str = str + ";CPFirmIdConst=" + CPFirmIdConst;
   str = str + ";SPB_Code=" + SPB_Code;

  return str;
end;

private macro UpdateMarketScheme( table:string, errMes:@string ):integer
  var r_dlmarket = TRecHandler("dlmarket.dbt");
  MarketScheme_BO = 0;
  var query, cmd, DataSet;
  var cmdUpd;

  query = " SELECT  distinct t_ClrAccCode ClrAccCode, decode (t_Nday1, 0 , 0, 1) IsT0 FROM " + table;
         ;
  cmd = RSDCommand(query);
  cmd.Execute();

  DataSet = TRsbDataSet(cmd);
  while(DataSet.moveNext() )
    if(RG_MarketSchemeBySettleCodeSPB(MarketID,DataSet.ClrAccCode,@r_dlmarket, DataSet.IsT0 == 0 ) == true) 
       cmdUpd = RSDCommand( " Update "+table+" Tb Set (Tb.T_MarketSchemeID ) = (?) WHERE Tb.t_ClrAccCode = ? AND  decode (t_Nday1, 0 , 0, 1) = ? "  );
       cmdUpd.addParam( "", RSDBP_IN, r_dlmarket.rec.ID );
       cmdUpd.addParam( "", RSDBP_IN, DataSet.ClrAccCode );
       cmdUpd.addParam( "", RSDBP_IN, DataSet.IsT0 );
       cmdUpd.execute();
     end;
  end;

  return 0;
OnError(ErObj)
  errMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;

  return 1;
end;

private macro UpdateCalendDate( Table, ErrMes:@string ):integer
   var query, cmd, DataSet;
   var cmdUpd;
   var PaymDate1 = date(0,0,0);
   var PaymDate2 = date(0,0,0);
   var NDay1:integer = 0;
   var NDay2:integer = 0;
   var CalcItogDate = date(0,0,0);
   var WorkSettleDate = date(0,0,0);
   query = " SELECT DISTINCT t.T_SETTLECODE SettleCode, "
                          +" t.T_SETTLEDATE SettleDate, "
                          +IIF(Table == "D_SPB03_TMP", "t.T_SETTLEDATE2 SettleDate2, " , " t.T_SETTLEDATE SettleDate2, ") // для файлов клиринга, нужна дата расчетов по 2ч внебиржевых РЕПО !?
                          + "t.T_IsRepo IsRepo, " 
                          +" t.t_TradeDate TradeDate, "  //dealdate ,если нулевая, то imp_date
                          +" t.t_calendId settlCalendId, "
                          +" t.t_calendid_trd trdCalendId, "
                          +" t.t_CurId CurID, "
                          +IIF( Table != "D_MFB06C_TMP", "0 ISOUTEXCREPO, " , " t.t_ISOUTEXCREPO ISOUTEXCREPO, ")
                          +" t.t_RepoPart RepoPart,"
                          +" t.t_CPFIRMPARTYID CPFIRMPARTYID "
          +"  FROM " + Table +" t "
          ;

   cmd = DL_RSDCommand(query);

   DataSet = cmd.Execute();
   While(DataSet.moveNext() )
     PaymDate1 = date(0,0,0);
     PaymDate2 = date(0,0,0);
     NDay1 = 0;
     WorkSettleDate = date(0,0,0);

     if(DataSet.IsREPO)
        var SettleCode = StrUpr(DataSet.SettleCode);
        var IndexTk, IndexTn, KDay;
   
        // TkTn/OkOn
        if( (IndexTk = Index(SettleCode,"T",1)) == 1 )
          IndexTn = Index(SettleCode,"T",IndexTk+2);
        elif( (IndexTk = Index(SettleCode,"O",1)) == 1 )
          IndexTn = Index(SettleCode,"O",IndexTk+2);
        end;
        if( IndexTn > 0 )
          KDay = int(SubStr(SettleCode, IndexTk+1, IndexTn-(IndexTk+1)));
          NDay1 = int(SubStr(SettleCode, IndexTn+1));
        end;
   
        if( DataSet.RepoPart != 2 )/*заполним даты исполнения по 1 ч по сделке и по клирингу*/
           //все нужные даты сдвигаем вначале по торговому, потом по расчётному, как требует того ТЗ (1.1.3)
           PaymDate1 = GetDateAfterWorkDays(GetDateAfterWorkDays( Date(DataSet.TradeDate), KDay, DataSet.trdCalendId ), 0, DataSet.settlCalendId);
        end;
      
        if( (Table != "D_MFB06C_TMP") OR (DataSet.ISOUTEXCREPO == 1) ) /*заполним даты исполнения по 2 ч по сделке(не клиринг)*/ //тут проверить для клиринга
           //все нужные даты сдвигаем вначале по торговому, потом по расчётному, как требует того ТЗ (1.1.3)
          PaymDate2 = GetDateAfterWorkDays(GetDateAfterWorkDays( Date(DataSet.TradeDate), NDay1, DataSet.trdCalendId ), 0, DataSet.settlCalendId );

          if(DataSet.RepoPart == 2)
             WorkSettleDate = GetDateAfterWorkDays(GetDateAfterWorkDays( Date(DataSet.SettleDate2), 0, DataSet.trdCalendId ), 0, DataSet.settlCalendId);
             PaymDate2 = DataSet.SettleDate2;
          end;
        end;
     else
        PaymDate1 = DataSet.SettleDate;
   
        WorkSettleDate = GetDateAfterWorkDays( Date(DataSet.SettleDate), 0, DataSet.settlCalendId );
   
        var ndayTaked = false;
        var IdxTn = Index(StrUpr(DataSet.SettleCode),"T");
        var IdxOn = Index(StrUpr(DataSet.SettleCode),"O");
        var subStrN = "";
        if ((IdxTn == 1) or (IdxOn == 1))
           subStrN = SubStr( DataSet.SettleCode, 2);
           if (StrIsNumber(subStrN))
             NDay1 = int(subStrN);
             ndayTaked = true;
           end;
        end;
   
        if (not ndayTaked)
           NDay1 = DL_GetNumWorkDaysForPeriod( Date(DataSet.TradeDate), WorkSettleDate, -1, DataSet.CurID, DataSet.CPFIRMPARTYID, NULL, DataSet.settlCalendId );
        end;
   
     end;

     cmdUpd = RSDCommand( " Update " + Table + " t Set (t.T_Nday1, t.T_PaymDate1, t.T_PaymDate2, t.T_WorkSettleDate ) = ( SELECT ?, ?, ?, ? FROM DUAL) "
                         +" WHERE  t.T_SETTLECODE = ? "
                         +" AND t.T_SETTLEDATE = ? "
                         +IIF(Table == "D_SPB03_TMP", " AND t.T_SETTLEDATE2 = ? " , " AND t.T_SETTLEDATE = ? ") // для файлов клиринга, нужна дата расчетов по 2ч внебиржевых РЕПО !?
                         +" AND t.T_IsRepo = ? " 
                         +" AND t.t_TradeDate = ? "
                         +" AND t.t_calendId = ? "
                         +" AND t.t_calendid_trd = ? "
                         +" AND t.t_CurId = ? "
                         +IIF( Table != "D_MFB06C_TMP", " AND 0 = ? " , " AND t.t_ISOUTEXCREPO = ? ")
                         +" AND t.t_RepoPart = ? "
                         +" AND t.t_CPFIRMPARTYID = ? "
                          );
     cmdUpd.addParam( "", RSDBP_IN, NDay1 );
     cmdUpd.addParam( "", RSDBP_IN, PaymDate1 );
     cmdUpd.addParam( "", RSDBP_IN, PaymDate2 );
     cmdUpd.addParam( "", RSDBP_IN, WorkSettleDate );

     cmdUpd.addParam( "", RSDBP_IN, DataSet.SettleCode );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.SettleDate );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.SettleDate2 );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.IsRepo );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.TradeDate );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.settlCalendId );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.trdCalendId );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.CurID );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.ISOUTEXCREPO );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.RepoPart );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.CPFIRMPARTYID );
     
     cmdUpd.NullConversion = true;
     cmdUpd.execute();
  end;

  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

macro SetPartPrmDeal_PM()
   if(Deals.IsREPO)
      if( Deals.IsCliring )
         if( Deals.RepoPart == 1 )
            Deals.GateDealType = "R" + Deals.BuySell;
         else
            if( Deals.BuySell == "B" )
               Deals.GateDealType = "RS";
            else
               Deals.GateDealType = "RB";
            end;
         end;
      else
         Deals.GateDealType = "R" + Deals.BuySell;
      end;
   else
      Deals.GateDealType = Deals.BuySell;
   end;
end;


/* заполнение и сохранение сделки */
macro PutDealInfoPM()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   var IsTODAY:bool = false;
   var DealTypeID:integer = -1, NumDaysBeforePaym:integer = 0;
   var DealDate = date(0,0,0), CommDate = date(0,0,0);
   var ErrStr = "", UINNumber = GetUINNumber(IsRSHB);

   /* дата сделки */
   if(Deals.TradeDate == date(0,0,0))
      DealDate = imp_date;
   else
      DealDate = Deals.TradeDate;
   end;

   RG.InitB(SeanceID,
            NULL,
            RG_IIF( Deals.IsCliring == true, 27/*клиринг*/, RG_SECURDEAL ),
            RG_IIF(Deals.IsCliring == true, "Клиринг. ", "") + String("Сделка на ПАО СПБ №" + UINNumber),
            Создать,
            NULL,
            NULL,
            ClientID
           );

   if(NOT RG.InitWithoutCheck(RG_IIF( Deals.IsCliring == true, 27/*клиринг*/, RG_SECURDEAL ), string(UINNumber+RG_IIF( Deals.IsCliring == true, "_c"+string(Deals.RepoPart), "" )), SOURCE_CODE) )
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Deals.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLTC_ISIN", Deals.ISIN);
   RG.SetParmByName("RGDLTC_DEALCODETS", Deals.TradeNo);
   RG.SetParmByName("RGDLTC_DEALTIME",   Deals.TradeTime);

   if( Deals.IsCliring and /*IMPORT_SETTLETIME() and*/ (Deals.CliringTime != Time(0, 0, 0)) )
      RG.SetParmByName("RGDLLG_SUPTIME_01", Deals.CliringTime);
      RG.SetParmByName("RGDLLG_SUPTIME_02", Deals.CliringTime);
   end;

   if(deals.ClientCode != "")
      /* по единому краткому коду клиента из ДБО находим клиента */
      RG.SetParmByName("RGDLTC_CLIENT", deals.ClientCode);
   end;

   IsTODAY = (Deals.TradeDate == Deals.SettleDate);
   if( ПолучитьВидОперацииБОЦБ( "B", Deals.GateDealType, @DealTypeID, @ErrMes, false, IsTODAY, false ) != 0 )
      Exit();
   end;
// берем портфеля из выборки
   if( ((FileImport == FileSPB03) or (FileImport == FileMFB06C)) AND (not Deals.IsREPO) )
      if( Portfolio_ != KINDPORT_UNDEF )
         RG.SetParmByName( "RGDLTC_PORTFOLIO", Portfolio_ );
      end;
   end;

   RG.SetParmByName("RGDLTC_DEALTYPE", DealTypeID );

   RG.SetParmByName("RGDLTC_PRICE",   Deals.Price);
   RG.SetParmByName("RGDLTC_NUMLOTS", Deals.Quantity);

   if(Deals.IsREPO)
      RG.SetParmByName("RGDLLG_PRICE_02",   Deals.Price2  ); /* цена по 2-ой части */
      RG.SetParmByName("RGDLTC_INCOMERATE", Deals.RepoRate); /* ставка Репо */
   end;

   /* цена в процентах */
   var Relativ:string = "";
   if( StrUpr(Deals.PriceType) == "PERC" )
      Relativ = SET_CHAR;
   else
      Relativ = UNSET_CHAR;
   end;
   RG.SetParmByName("RGDLLG_RELATIVEPRICE_01", Relativ);
   if(Deals.IsREPO)
      RG.SetParmByName("RGDLLG_RELATIVEPRICE_02", Relativ);
   end;

   /* НКД - для купонной ценной бумаги */
   RG.SetParmByName("RGDLLG_NKD_01", Round(Deals.AccInt, 2 ));

   /* сумма сделки без НКД */
   RG.SetParmByName("RGDLLG_COST_01", Round(Deals.Value_, 2));

   /* общая сумма сделки */
   RG.SetParmByName("RGDLLG_TOTALCOST_01", Round(Deals.Amount, 2));

   if(Deals.BuySell == "B")
      RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CAi), SET_CHAR);
   else
      RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CAi), UNSET_CHAR);
   end;

   if(Deals.IsREPO)
      if(Deals.BuySell == "B")
         RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CRi), UNSET_CHAR);
      else
         RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CRi), SET_CHAR);
      end;
   end;

   /* номер договора с клиентом */
   RG.SetParmByName( "RGDLTC_CONTRID", "");

   RG.SetParmByName("RGDLTC_DEALCODE", UINNumber);

   /* код расчетов */
   RG.SetParmByName("RGDLTC_PCODE", Deals.SettleCode);

   /* признак биржи */
   RG.SetParmByName("RGDLTC_USERFLAG1", SET_CHAR);

   RG.SetParmByName( "RGDLTC_USERFLAG3", SET_CHAR);

   /* тип сделки на бирже */
   if(FileImport == FileSPB03)
      RG.SetParmByName("RGDLTC_KIND", Deals.TradeType);
   else
      if(Deals.IsREPO)
         RG.SetParmByName("RGDLTC_KIND", "R");
      else
         RG.SetParmByName("RGDLTC_KIND", "T");
      end;
   end;

   /* комиссия биржи */
   /* Все три биржевые комиссии в импортированной сделке обрабатываются одной суммой - это правильно*/
   if( not Deals.IsCliring )
      RG.SetParmByName("RGDLTC_AMOUNT_COMM", Round(Deals.ExhComm, 2 ) );
      RG.SetParmByName("RGDLTC_CLRCOMM", Round(Deals.ClrComm, 2 ) );
   else // Deals.IsCliring == true
      RG.SetParmByName("RGDLTC_REPOPART", Deals.RepoPart);
      RG.SetParmByName("RGDLTC_BUYSELL", Deals.BuySell);
      RG.SetParmByName("RGDLTC_CLIRINGTIME", Deals.CliringTime);
      RG.SetParmByName("RGDLTC_SESSION", Deals.Session);
   end;

   /* дата сделки */
   RG.SetParmByName("RGDLTC_DEALDATE", DealDate);

   if(Deals.CPFirmId != "")
      RG.SetParmByName("RGDLTC_PARTY", Deals.CPFirmId);
   end;
   if( (FileImport == FileSPB03) AND (Deals.CCPCode != "") )
      RG.SetParmByName("RGDLTC_PARTY", Deals.CCPCode);
   end;

   var PaymDate:date = DealDate;
   var NDay:integer = 0;

   RG.SetParmByName("RGDLTC_MARKET", SPB_Code);

   /* суммы по второй части для РЕПО */
   if(Deals.IsREPO)

      NDay = NDay1_;
      if( Deals.RepoPart != 2 )/*заполним даты исполнения по 1 ч по сделке и по клирингу*/
         PaymDate = PaymDate1_;
         if( Deals.IsCliring == true )
            RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
         else
            RG.SetParmByName("RGDLLG_SUPDATE_01", PaymDate);
            RG.SetParmByName("RGDLLG_PAYDATE_01", PaymDate);
         end;
      else/*даты исполнения по 2 ч по клирингу (не по сделке) не заполняем - вычислим при вставке сделки в БОЦБ*/
         RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
      end;
      if( not Deals.IsCliring ) /*заполним даты исполнения по 2 ч по сделке(не клиринг)*/
         //все нужные даты сдвигаем вначале по торговому, потом по расчётному, как требует того ТЗ (1.1.3)
         PaymDate = PaymDate2_;
         if(Deals.RepoPart == 2)

            if( (SettleDate2_ == WorkSettleDate_) and (PaymDate != SettleDate2_) )
               WarnMes = "Срок сделки \""+Deals.TradeNo+"\", определенный параметром SettleDate = "+string(SettleDate2_)+", не соответствует коду расчетов \""+string(Deals.SettleCode)+"\" по сделке.";
            elif( (SettleDate2_ != WorkSettleDate_) and (WorkSettleDate_ != PaymDate) )
               WarnMes = "По сделке \""+Deals.TradeNo+"\", дата SettleDate = "+string(SettleDate2_)+", указанная в файле выгрузки, попадает на выходной день. Расчетная дата - "+string(PaymDate)+".";
            end;
            PaymDate = SettleDate2_;
         end;
         RG.SetParmByName("RGDLLG_SUPDATE_02", PaymDate);
         RG.SetParmByName("RGDLLG_PAYDATE_02", PaymDate);
      end;
      RG.SetParmByName("RGDLLG_COST_02",      Round(Deals.Value2_, 2));
      RG.SetParmByName("RGDLLG_NKD_02",       Round(Deals.AccInt2, 2));
      RG.SetParmByName("RGDLLG_TOTALCOST_02", Round(Deals.Amount2, 2));
   else
      RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
      RG.SetParmByName("RGDLLG_PAYDATE_01", Deals.SettleDate);
      PaymDate = PaymDate1_;
      NDay = NDay1_;

      if( Deals.SettleDate != WorkSettleDate_ )
         WarnMes = "По сделке \""+Deals.TradeNo+"\", дата SettleDate = "+string(Deals.SettleDate)+", указанная в файле выгрузки, попадает на выходной день. Расчетная дата - "+string(WorkSettleDate_)+".";
      end;
   end;

   if(NDay > 0)
      RG.SetParmByName("RGDLTC_DAYBEFOREEXECUTE", NDay);
   end;   

   RG.SetParmByName(GetParmName( "RGDLPM_DATE", BAi),  Deals.SettleDate);

   RG.SetParmByName(GetParmName( "RGDLPM_DATE", CAi ), Deals.SettleDate);

   RG.SetParmByName("RGDLTC_MARKETSCHEME", MarketSchemeID);

   /*идентификатор документа-подтверждения вида "Отчет биржи"*/
   RG.SetParmByName("RGDLTC_MARKETREPORT_ID", MarketReportID);

   /*статус сделки - отложенная*/
   RG.SetParmByName("RGDLTC_DEALSTATUS", DL_PREPARING);

   /* дата комиссии */
   RG.SetParmByName("RGDLTC_DATE_CM",  imp_date);

   RG.SetParmByName("RGDLPM_NUMBPAYMS", 0);

   /* точность цены */
   RG.SetParmByName("RGDLLG_POINT_01", Deals.Decimals);
   RG.SetParmByName("RGDLLG_POINT_02", Deals.Decimals);

   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", BAi ), Deals.CurrencyId);
   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", CAi ), Deals.CurrencyId);
   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", PM_PURP_AVANCE ), Deals.CurrencyId);
   if(Deals.IsREPO)
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", BRi ), Deals.CurrencyId);
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", CRi ), Deals.CurrencyId);
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", PM_PURP_BACK_AVANCE ), Deals.CurrencyId);
   end;

   if( FileImport == FileSPB03 )
     RG.SetParmByName("RGDLTC_FACEVALUE", Deals.FaceValue);
     if(Deals.PrimaryOrderID != "")
       RG.SetParmByName("RGDLTC_ORDERNOM", Deals.PrimaryOrderID);
     else
       RG.SetParmByName("RGDLTC_ORDERNOM", Deals.OrderNo);
     end;
     RG.SetParmByName("RGDLLG_CFI_01", Deals.CurrencyId);
     if(Deals.IsREPO)
       RG.SetParmByName("RGDLLG_CFI_02", Deals.CurrencyId);
     end;

     RG.SetParmByName("RGDLTC_TRADEPERIOD", Deals.TradePeriod);
     if(Deals.SpecialPeriod != "")
       RG.SetParmByName("RGDLTC_SPECIALPERIOD", Deals.SpecialPeriod);
     end;
   end;

   if( (FileImport == FileSPB03) and (deals.ClientCode != "") and ФормироватьПорученияПриИмпорте(@ErrMes) )
      if(IsRSHB == 1)
        RG.SetParmByName("RGDLTC_INDOC", Deals.PrimaryOrderID);
      else
        RG.SetParmByName("RGDLTC_INDOC", Deals.OrderNo);
      end;
      /*Дата поручения на сделку*/
      RG.SetParmByName("RGDLTC_INDOCDATE", DealDate);
      /*Время поручения на сделку*/
      RG.SetParmByName("RGDLTC_INDOCTIME", Deals.TradeTime - Time(0,1,0));
   end;

   if((FileImport == FileSPB03) and (Deals.ClientCode != ""))
      var TraderCode:string = GetTraderCodeSPB(Deals.Commentar, Deals.ClientCode);
      if(TraderCode != "") 
         RG.SetParmByName("RGDLTC_TRADERCODE", TraderCode);
      end;
   end;

   RG.Save();
   SetErrAfterLoad();

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + 
                      "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError() );
      end;
   end;
end;


private macro UpdateFIID(Table, ErrMes:@string) :integer
   var cmd, DataSet;
   var cmdUpd;
   var fin = null;
   var FIID = -1;
   var ISIN = "";
   var error = "";
   var SecID = "";

   cmd = DL_RSDCommand(" SELECT DISTINCT t.t_ISIN ISIN, t.T_SECURITYID SecurityId FROM " + Table + " t ");

   DataSet = cmd.Execute();
   while(DataSet.moveNext() AND DataSet.ISIN != "" )

      ISIN = DataSet.ISIN;
      SecID = DataSet.SecurityId;
      //ищем бумагу только по коду умышленно. чтобы убедится что в СОФР заполнен код бумаги, и заполнить, если пуст
      fin = RG_FindFinInAbs(SecID, Код_на_СПБ_ФинИн);
      if (fin == null)
         //пробуем загрузить в АБС бумагу из RUDATA. После загрузки, повторяем поиск fininstr
         if (not SOFR_LoadRuDataByCode( SecID, 1, "СПБ", @error))
            SOFR_LoadRuDataByID( ISIN, 1,  @error);
         end;
         fin = RG_FindFinInAbsSep(SecID, ISIN, Код_на_СПБ_ФинИн);
      end;

      if(fin != null) //IIF не подойдёт, т.к. он вычисляет все входящие параметры, а значит может вызвать "null pointer exc..."
         FIID = fin.rec.FIID;
      else 
         FIID = -1;
      end;
      cmdUpd = RSDCommand( " Update " + Table + " t Set ( t.t_FIID ) = ( SELECT " + int(FIID) + " FROM DUAL ) WHERE t.t_ISIN = '" + ISIN + "'" );
      cmdUpd.execute();

   end;
   return 0;
OnError(ErObj)
   ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
   return 1;
end;

private macro UpdateFIIDReq(Table, ErrMes:@string) :integer
   var cmd, DataSet;
   var cmdUpd;
   var fin = null;
   var FIID = -1;
   var error = "";
   var SecID = "";

   cmd = DL_RSDCommand(" SELECT t.T_SECURITYID SecurityId FROM " + Table + " t ");

   DataSet = cmd.Execute();
   while(DataSet.moveNext() AND DataSet.SecurityId != "" )

      SecID = DataSet.SecurityId;
      fin = RG_FindFinInAbs(SecID, Код_на_СПБ_ФинИн);
      if (fin == null)
         //пробуем загрузить в АБС бумагу из RUDATA. После загрузки, повторяем поиск fininstr
         if (not SOFR_LoadRuDataByCode( SecID, 1, "СПБ", @error, true))
            SOFR_LoadRuDataByID( SecID, 1,  @error, null, true);
         end;
         fin = RG_FindFinInAbs(SecID, Код_на_СПБ_ФинИн);
      end;

      if(fin != null) //IIF не подойдёт, т.к. он вычисляет все входящие параметры, а значит может вызвать "null pointer exc..."
         FIID = fin.rec.FIID;
      else 
         FIID = -1;
      end;
      cmdUpd = RSDCommand( " Update " + Table + " t Set t.t_FIID = " + int(FIID) + " WHERE t.T_SECURITYID = '" + SecID + "'" );
      cmdUpd.execute();

   end;
   return 0;
OnError(ErObj)
   ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
   return 1;
end;

private macro UpdateCPFIRMPARTYID(Table, ErrMes:@string) :integer
  var cmd, DataSet, cmdUpd;
  var CPFirmId:integer = -1;

  cmd = RSDCommand("SELECT DISTINCT t.t_CPFirmId CPFirmId" +
                    " FROM " + Table + " t " +
                   " WHERE t.t_CPFirmId <> CHR(1)");

  DataSet = TRsbDataSet(cmd);
  while(DataSet.moveNext() AND DataSet.CPFirmId != "")
    GetRealID(RG_PARTY, DataSet.CPFirmId, PTCK_SPBEX, @CPFirmId, @ErrMes);

    cmdUpd = RSDCommand("UPDATE " + Table + " t SET t.t_CPFIRMPARTYID = ? WHERE t.t_CPFirmId = ?");
    cmdUpd.addParam("", RSDBP_IN, CPFirmId);
    cmdUpd.addParam("", RSDBP_IN, DataSet.CPFirmId);

    cmdUpd.execute();
  end;

  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message;
  return 1;
end;

private macro PutMarketReport()
   if( (Deals.DOC_NO == "") OR (WriteMarketReport( SeanceID, NULL, SOURCE_CODE, @MarketReportID, @ErrMes, null, Deals.DOC_NO, imp_date, SPB_Code ) == false) )
      AbortTrn;
   end; 
end;

// сделка подходит?
private macro IsFitDeal()
  if( pp.deals_bo == SET_CHAR )
    return true;
  end;
  return false;
end;

PRIVATE MACRO PutRequestInfo()
   VAR ClientID = 0, ClientContrID = 0;
   VAR ErrStr = "";

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   ClientContrID = Req.SfContrID;
   ClientID = Req.PartyID;

   RG.InitB(SeanceID,
            NULL,
            RG_REQUEST,
            String("Заявка на сделку №" + Req.OrderNo),
            Создать,
            NULL,
            NULL,
            ClientID
           );

   if(NOT RG.InitWithoutCheck(RG_REQUEST, Req.OrderNo, SOURCE_CODE))
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Req.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLRQ_KIND",       350/*DOCKIND_REQ_CLIENT_DEAL*/);
   RG.SetParmByName("RGDLRQ_CODE",       Req.OrderNo);
   RG.SetParmByName("RGDLRQ_CODETS",     Req.OrderNo);
   RG.SetParmByName("RGDLRQ_DATE",       Req.TradeDate);
   RG.SetParmByName("RGDLRQ_TIME",       Req.EntryTime);
   RG.SetParmByName("RGDLRQ_PARTY",      SPB_Code);
   RG.SetParmByName("RGDLRQ_BUYSALE",    Req.BuySell);
   RG.SetParmByName("RGDLRQ_FIID",       Req.SecurityId); 
   RG.SetParmByName("RGDLRQ_AMOUNT",     Round(Req.Quantity,2));
   RG.SetParmByName("RGDLRQ_PRICE",      Req.Price);
   RG.SetParmByName("RGDLRQ_REPORATE",   Req.RepoRate);
   RG.SetParmByName("RGDLRQ_STATUS",     Req.Status);
   RG.SetParmByName("RGDLRQ_PRICETYPE",  Req.PriceType);
   RG.SetParmByName("RGDLRQ_CURRENCYID", Req.CurrencyId);
   RG.SetParmByName("RGDLRQ_PRICEFIID",  Req.CurrencyId); // валюта цены = валюте расчетов
   RG.SetParmByName("RGDLRQ_ORDTYPECODE",Req.OrdTypeCode);
   RG.SetParmByName("RGDLRQ_ISADDRESS",  Req.IsAddress);
   RG.SetParmByName("RGDLRQ_CLIENT",     Req.ClientCode);
   RG.SetParmByName("RGDLRQ_GRNDNUM",    "");

   var TraderCode:string = GetTraderCodeSPB(Req.Commentar, Req.ClientCode);
   if(TraderCode != "") 
      RG.SetParmByName("RGDLRQ_TRADERCODE", TraderCode);
   end;

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

private macro ProcessDataORDERS(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldDoc_NO = "";
  var stat = 0;
  var i = 0;
  var query, cmd, ds, NRec = 0;
  var UINNumber = "";
  var OldOutPut;
  var status:String, streason:String;

  ErrMes = "";
  RG = TGtRecordBatchCharger();
  RGLog.Message("ЗАГРУЗКА ЗАЯВОК НА СДЕЛКИ");
  Progress.Init( 9, "Выполняется обработка данных", "Обработка данных"  );
  OldOutPut = SetOutput( ReportFileName, TRUE );

  stat = CheckFileUpload(synonim, "ORDERS", pan.imp_date, @ErrMes);

  Message("Очистка таблицы ORDERS");
  println( "Начало очистки таблицы ORDERS " + time() );
  if( stat == 0 )
    stat = DelORDERS( @ErrMes);
  end;
  println( "Конец очистки таблицы ORDERS " + time() );
  Progress.Use();

  println( "Начало заполнения ORDERS " + time() );
  Message("Заполнение таблицы ORDERS");
  if( stat == 0 )
    stat = FillORDERS(Synonim, Pan.imp_date, @ErrMes);
  end;
  Progress.Use();
  println( "Конец заполнения ORDERS " + time() );

  println( "Начало обновления ORDERS " + time() );
  Message("Обновление данных для ORDERS: Party");
  if( stat == 0 )
    stat =  UpdateParty(MarketID, "D_ORDERS_TMP", Pan.imp_date, @ErrMes);
  end;
  Progress.Use();
  println( "Конец обновления ORDERS " + time() );

  println( "Начало обновления ORDERS " + time() );
  Message("Обновление данных для ORDERS: FIID");
  if(stat == 0)
    stat = UpdateFIIDReq("D_ORDERS_TMP", @ErrMes);
  end;
  Progress.Use();
  println( "Конец обновления ORDERS " + time() );

  println( "Начало обновления объектов " + time() );
  Message("Обновление данных для ORDERS: объекты");
  if( stat == 0)
    stat =  UpdateObjORDERS( @ErrMes);
  end;
  Progress.Use();
  println( "Конец обновления объектов " + time() );
  SetOutput( OldOutPut, TRUE );
  
  if( stat )
     RGLog.Error(ErrMes);      
  else
     Req.Init();
     Message("Обработка данных ORDERS");
     Query = " SELECT  T_ID_SPB_ORDERS ID_SPB_ORDERS, "+  
             "         nvl(t.T_ORDERNO,CHR(1)) ORDERNO, " +
             "         nvl(t.T_TRADEDATE,to_date('01.01.0001','DD.MM.YYYY')) TRADEDATE, " +
             "         nvl(t.T_TRADETIME,to_date('01.01.0001','DD.MM.YYYY')) ENTRYTIME, " +
             "         nvl(t.T_CLIENTCODE,chr(1)) CLIENTCODE, " +
             "         nvl(t.T_BUYSELL,chr(1)) BUYSELL, " +
             "         nvl(t.T_IS_ADDRESS,chr(1)) IS_ADDRESS, " +
             "         nvl(t.T_SECURITYID,chr(1)) SECURITYID, " +
             "         nvl(t.T_QUOTE_CURRENCY,0) QUOTE_CURRENCY, " +
             "         nvl(t.T_CURRENCYID,chr(1)) CURRENCYID, " +
             "         nvl(t.T_PRICE,0) PRICE, " +
             "         nvl(t.T_REPO_PRICE,0) REPO_PRICE, " +
             "         nvl(t.T_QUANTITY,0) QUANTITY, " +
             "         nvl(t.T_STATUS,chr(1)) STATUS, " +
             "         nvl(t.T_STATUS_REASON,chr(1)) STATUS_REASON, " +
             "         nvl(t.T_ACTION,chr(1)) ACTION, " +
             "         nvl(t.T_PARTYID,0) PARTYID, " +
             "         nvl(t.T_OBJECTID,0) OBJECTID, " +
             "         nvl(t.T_COMMENTAR,chr(1)) COMMENTAR, " +
             "         nvl(t.T_FIID,0) FIID " +
             "   FROM  D_ORDERS_TMP t" +
             "  WHERE  t.T_ACTION <> 'New' " +
             "     AND t.T_ID_SPB_ORDERS " +
             "         IN (  SELECT MIN(T_ID_SPB_ORDERS) ID_SPB_ORDERS " +
             "                 FROM D_ORDERS_TMP mn "+
             "                WHERE mn.T_ACTION <> 'New' " +
             "             AND t.T_ORDERNO = mn.T_ORDERNO) " +
             "     AND nvl(t.T_CLIENTCODE,chr(1)) <> chr(1) " +
             "  ORDER BY T_ID_SPB_ORDERS "
             ;
     cmd = DL_RSDCommand(Query);
     cmd.AddParam(Pan.imp_date);

     NRec = cmd.GetCount();
     NumImportDeals = NRec;

     if( (stat == 0) AND (NRec > 0) )
        if(GetDialogFlag())
           InitProgress(NRec, "Загрузка внешнего файла заявок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ ORDERS");
        end;
        OldOutPut = SetOutput( ReportFileName, TRUE );
        println( "Начало обработки данных из таблицы ORDERS " + time() );
        SetOutput( OldOutPut, TRUE );

        if(USE_STORPROC_CREATEREPL) // создание объектов записей репликаций через ХП
           var cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.CreateReplRecByTmp_ORDERS(?, ?, ?, ?); END;");
           cmdSP.addParam("stat", RSDBP_RETVAL, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, imp_date);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.addParam("", RSDBP_IN, GetPrmStr(Pan));
           cmdSP.Execute();

           stat = Int(cmdSP.value("stat"));
        else
           ds = cmd.execute();
           while(ds.MoveNext)
        
              ErrMes = "";
              WarnMes = "";
              Req.InitRecords();
                
              Req.OrderNo     = string(ds.ORDERNO);
              Req.TradeDate   = ds.TRADEDATE;
              Req.EntryTime   = ds.ENTRYTIME;
              Req.ClientCode  = ds.CLIENTCODE;
              Req.BuySell     = ds.BUYSELL;
              Req.IsAddress   = ds.IS_ADDRESS;
              Req.SecurityId  = ds.SECURITYID;
              Req.PriceFIID   = ds.QUOTE_CURRENCY;
              Req.CurrencyId  = ds.CURRENCYID;
              Req.Price       = ds.PRICE;
              Req.RepoRate    = ds.REPO_PRICE;
              Req.Quantity    = ds.QUANTITY;
              Req.PARTYID     = ds.PARTYID;
              Req.Commentar   = ds.COMMENTAR;
        
              Status	= trim(ds.STATUS);
              if((Status == "NEW") OR (Status == "FILLED") OR (Status == "PARTFILLED"))
                Req.Status = "M";
              elif((Status == "CANCELLED") OR (Status == "PARTCANCELLED"))
                streason = trim(ds.STATUS_REASON);
                if((streason == "USER_CANCEL") OR (streason == "USER_MASS_CANCEL") OR
                   (streason == "BROKER_CANCEL") OR (streason == "BROKER_MASS_CANCEL"))
                  Req.Status = "W";
                elif( (streason == "CTRPARTY_DECLINE") OR (streason == "EXPIRED_CROSSTRADE") OR (streason == "EXPIRED_ORDERBOOK_CROSS"))
                  Req.Status = "F";
                else
                  Req.Status = "C";
                end;
              else
                Req.Status = "";
              end;
             
              Req.OrdTypeCode = "";
              Req.PriceType = "CASH";
        
              if( (ds.OBJECTID > 0) )
                 ErrMes = "Ошибка при загрузке сделки с кодом \"" + Req.OrderNo + "\"\n" + "Запись репликации с действием создать для объекта " + int(ds.OBJECTID) + " уже передавалась в RS-Bank.""\n Повторная репликация невозможна.""\n";  
              elif( (Req.ClientCode != "") AND (Req.PARTYID <= 0) )
                 ErrMes = "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\n" + "Не найден субъект через краткий код на бирже \"" + Req.ClientCode + "\"";  
              elif( (Req.SecurityId != "") AND (Int(ds.FIID) == -1) )
                 ErrMes = "Ошибка при загрузке заявки с кодом \"" + Req.OrderNo + "\"\n" + "В справочнике не найден ФИ с кодом \"" + Req.SecurityId + "\"";
              end;
             
              if( ErrMes == "")
                 if( ProcessTrn(0, "PutRequestInfo"))
                 else
                    RG.UnInit();
                 end;
              end;
        
              if( ErrMes != "" )
                 RGLog.Error(ErrMes);
              end;
             
              if( WarnMes != "" )
                 RGLog.Message(WarnMes);
              end;
             
              i = i + 1;
              if(GetDialogFlag())
                 UseProgress(i);
              end;
              if( FlagCtrlBrk == true )
                 break;
              end;
           end;           
        end;

        if(GetDialogFlag())
           RemProgress(); 
        end;

        OldOutPut = SetOutput( ReportFileName, TRUE );
        println( "Конец обработки данных из таблицы ORDERS " + time() );
        SetOutput( OldOutPut, TRUE );
     end;
  end;
  Progress.Use();

  if( NRec == 0 )
     RGLog.Message("Нет данных для загрузки.");
  else
     if((not USE_STORPROC_CREATEREPL) and (not FlagCtrlBrk))
        RG.Transfer();
        SetErrAfterLoad(true);
     end;
     Progress.Use();
     Message("Заполнение протокола");
     /*загрузить в лог инфу о загруженных ЗР*/
     if(USE_STORPROC_CREATEREPL)
       RGLog.GetAndAddReceiveStorPrLog(RG_REQUEST);
     end;
     RGLog.GetAndAddReceiveLoadRecsMass(RG_REQUEST,"Заявка \"","\" уcпешно загружена в шлюз", @NumImportDealsTotal, printOnlyErr);
     Progress.Use();

     OldOutPut = SetOutput( ReportFileName, TRUE );
     println( "Начало обновления таблицы в Payments " + time() );
     Message("Обновление данных в Payments");
     stat = UpdateORDERS_PM(Synonim, SeanceID, @ErrMes);
     if( stat )
       RGLog.Error(ErrMes);      
     end;
     Progress.Use();
     println( "Конец обновления таблицы в Payments " + time() );
     /* сообщаем о результатах загрузки */
     SetOutput( OldOutPut, TRUE );

     /* сообщаем о результатах загрузки */
     RGLog.Message("Всего обработано заявок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));

  end;
  Progress.Use();
  Progress.Remove();

end;

private macro ProcessDataSPB03(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, ds;
  var stat:integer = 0, nRec:integer = 0, i:integer = 0;
  var query:string = "", filesName:string = "", oldDoc_NO:string = "";

  ErrMes = "";
  NumImportDeals = 0;
  FileImport = FileSPB03;

  RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ SPB03");
  Progress.Init(18, "Выполняется обработка данных SPB03", "Выполняется обработка данных SPB03");
  oldOutPut = SetOutput(reportFileName, TRUE);

  stat = CheckFileUpload(synonim, "SPB03", pan.imp_date, @ErrMes);
  
  if(stat == 0)  
    Message("Очистка таблицы SPB03");
    println("Начало очистки таблицы SPB03 " + time());
    stat = DelSPB03(@ErrMes);
    println("Конец очистки таблицы SPB03 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы SPB03");
    println("Начало заполнения SPB03 " + time());
    stat = FillSPB03(synonim, pan.imp_date, @ErrMes);
    println("Конец заполнения SPB03 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: ClrAccCodeType");
    println("Начало обновления ClrAccCodeType " + time());
    stat = UpdateClrAccCodeType(SeanceID, SOURCE_CODE, MarketID);
    println("Конец обновления ClrAccCodeType " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: DOC_NO");
    println("Начало обновления SPB03 " + time());
    stat = UpdateSPB03(synonim, @ErrMes);
    println("Конец обновления SPB03 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: Party");
    println("Начало обновления Party " + time());
    stat = UpdateParty(MarketID, "D_SPB03_TMP", Pan.imp_date, @ErrMes);
    println("Конец обновления Party " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: Currency");
    println("Начало обновления Currency " + time());
    stat = UpdateCur("D_SPB03_TMP", @ErrMes);
    println("Конец обновления Currency " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: календари");
    println("Начало обновления календарей " + time());
    stat = UpdateCalend("D_SPB03_TMP", MarketID, CALEND_OPER_NAME, @ErrMes);
    println("Конец обновления календарей " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: FIID");
    println("Начало обновления FIID " + time());
    stat = UpdateFIID("D_SPB03_TMP", @ErrMes);
    println("Конец обновления FIID " + time());
  end;
  Progress.Use();

  if( stat == 0 )
    Message("Обновление данных для SPB03: CPFIRMID");
    println( "Начало обновления CPFIRMID " + time() );
    stat = UpdateCPFirmIDSPB03(synonim, pan.imp_date, CPFirmIdConst, @ErrMes);
    println("Конец обновления CPFIRMID " + time());
  end;
  Progress.Use();

  if( stat == 0 )
    Message("Обновление данных для SPB03: CPFIRMPARTYID");
    println( "Начало обновления CPFIRMPARTYID " + time() );
    stat = UpdateCPFIRMPARTYID("D_SPB03_TMP", @ErrMes);
    println("Конец обновления CPFIRMPARTYID " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: портфели");
    println("Начало обновления портфелей " + time());
    UpdatePortfolio("D_SPB03_TMP", Pan.imp_date, @ErrMes);
    println("Конец обновления портфелей " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: даты");
    println("Начало обновления дат " + time());
    stat = UpdateCalendDate("D_SPB03_TMP", @ErrMes);
    println("Конец обновления дат " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: MarketScheme");
    println("Начало обновления MarketScheme " + time());
    stat = UpdateMarketScheme("D_SPB03_TMP", @ErrMes);
    println("Конец обновления MarketScheme " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для SPB03: объекты");
    println("Начало обновления объектов " + time());
    stat = UpdateObjSPB03(IsRSHB, @ErrMes);
    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  SetOutput(OldOutPut, TRUE);

  if(stat != 0)
    RGLog.Error(ErrMes);
  else
    Message("Обработка данных SPB03");

    query = "SELECT t.* " +
             " FROM D_SPB03_TMP t " +
            " ORDER BY t.T_DOC_NO, t.t_recno";
    cmd = DL_RSDCommand(query);

    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if((stat = GetFileName(synonim, "D_SPB03_TMP", @filesName, @ErrMes)) != 0)
      RGLog.Error(ErrMes);
    end;

    if(stat == 0)
      if(nRec > 0)
        RGLog.Message("Используются файлы: \n" + filesName);

        if(GetDialogFlag())
          InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ SPB03");
        end;
        oldOutPut = SetOutput(reportFileName, TRUE);
        println("Начало обработки данных из таблицы SPB03 " + time());
        SetOutput(OldOutPut, TRUE);

        if(USE_STORPROC_CREATEREPL) // создание объектов записей репликаций через ХП
           var cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.CreateReplRecByTmp_SPB03(?, ?, ?, ?); END;");
           cmdSP.addParam("stat", RSDBP_RETVAL, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, imp_date);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.addParam("", RSDBP_IN, GetPrmStr(Pan));
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));
        else
           ds = cmd.execute();
        
           RG = TGtRecordBatchCharger();
           Deals.Init();
        
           while(ds.MoveNext)
             ErrMes = "";
             WarnMes = "";
        
             Deals.DOC_NO         = ds.DOC_NO;  // находится в MB_REQUISITES, нужно переместить в SPB_SPB03
             Deals.CLRACCCODE     = ds.CLRACCCODE;
             Deals.RecNo          = ds.RECNO;
             Deals.CurrencyId     = ds.CURRENCYID;
             Deals.SettleDate     = ds.SETTLEDATE;
             Deals.SecurityId     = ds.SECURITYID;
             Deals.ISIN           = ds.ISIN;
             Deals.FaceValue      = ds.FACEVALUE;
             Deals.PriceType      = ds.PRICETYPE;
             Deals.ClientCode     = ds.CLIENTCODE;
             Deals.REPOPART       = ds.REPOPART;
             Deals.BuySell        = ds.BUYSELL;
             Deals.SettleCode     = ds.SETTLECODE;
             Deals.TradeNo        = ds.TRADENO;
             Deals.TradeDate      = ds.TRADEDATE;
             Deals.TradeTime      = ds.TRADETIME;
             Deals.TradeType      = ds.TRADETYPE;
             Deals.TRADEPERIOD    = ds.TRADEPERIOD;
             Deals.SPECIALPERIOD  = ds.SPECIALPERIOD;
             Deals.PRIMARYORDERID = ds.PRIMARYORDERID;
             Deals.ORDERNO        = ds.ORDERID;
             Deals.Decimals       = ds.DECIMALS;
             Deals.Price          = ds.PRICE;
             Deals.Quantity       = ds.QUANTITY;
             Deals.Value_         = ds.VALUE;
             Deals.Amount         = ds.AMOUNT;
             Deals.ExhComm        = ds.EXCHCOMM;
             Deals.CLRCOMM        = ds.CLRCOMM;
             Deals.CCPCODE        = ds.CCPCODE;
             Deals.CPFirmId       = ds.CPFIRMID;
             Deals.RepoRate       = ds.REPORATE;
             Deals.AccInt         = ds.ACCINT;
             Deals.PRICE2         = ds.PRICE2;
             Deals.SecurityType   = ds.SECURITYTYPE;
             Deals.Commentar      = ds.COMMENTAR;
        
             ClientID             = ds.PartyID;
             ClientContrID        = ds.SfContrID;
             CPFirmId             = ds.CPFIRMPARTYID;
             CurrencyId           = ds.CurID;
             calendId             = ds.CALENDID;
             MarketSchemeID       = ds.MarketSchemeID;
             NDay1_               = ds.NDAY1;
             PaymDate1_           = date(ds.PAYMDATE1);
             PaymDate2_           = date(ds.PAYMDATE2);
             WorkSettleDate_      = date(ds.WORKSETTLEDATE);
             Portfolio_           = ds.Portfolio;
             Deals.ISREPO         = ds.ISREPO;
        
             if(Deals.IsREPO) 
               // данные по 2ч
               SettleDate2_         = date(ds.SettleDate);
               Deals.AccInt2        = ds.ACCINT2;
               Deals.Amount2        = ds.AMOUNT2;
               Deals.Value2_        = ds.VALUE2;
               Deals.Price2         = ds.PRICE2_2;
               НайтиДанныеПо2Части(ds.SettleDate, ds.SettleDate2, Deals.Amount, Deals.Amount2, @Deals.RepoRate);
             end;
        
             SetPartPrmDeal_PM();
        
             var UINNumber = GetUINNumber(IsRSHB);
        
             if(ds.OBJECTID > 0)
               ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Запись репликации с действием создать для объекта " + int(ds.OBJECTID) + " уже передавалась в RS-Bank.""\n Повторная репликация невозможна.""\n";  
             elif(ds.ClrAccCodeType == 0)
               ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике расчетных кодов банка не найден код \"" + ds.ClrAccCode + "\"";  
             elif(ds.ClrAccCodeType != ALG_SP_MONEY_SOURCE_CLIENT)
               ErrMes = "Не загружена сделка с кодом \"" + UINNumber + "\"\n" + "В соответствии с кодом ТКС \"" + ds.ClrAccCode + "\" сделка не является клиентской";
             elif((ds.ClrAccCodeType == ALG_SP_MONEY_SOURCE_CLIENT) and (Deals.ClientCode == ""))
               ErrMes = "Ошибка при загрузке клиентской сделки с кодом \"" + UINNumber + "\"\n" + "В файле импорта не задан атрибут ClientCode";
             elif(ClientID <= 0)
               ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Не найден субъект через краткий код\ код на бирже \"" + Deals.ClientCode + "\"";  
             elif((ds.CPFirmId != "") and (ds.CPFirmPartyID == 0))
               ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В ГКБО не найден субъект с принадлежностью \'Центральный контрагент\'";  
             elif((Deals.CurrencyId != "") and (ds.CurID == -1))
               ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике не найден ФИ с кодом \"" + Deals.CurrencyId + "\"";
             elif((Deals.ISIN != "") and (ds.FIID == -1))
               ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике не найден ФИ с ISIN \"" + Deals.ISIN + "\"";  
             end;
        
             if(ErrMes == "")
               if(oldDoc_NO != Deals.DOC_NO) //на первой сделке вставляем документ-основание
                 if(ProcessTrn(0, "PutMarketReport"))
                 else
                   RGLog.Error("Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep);
                   RG.UnInit();  
                 end;
                 ErrMes = "";
                 oldDoc_NO = Deals.DOC_NO;
               end;
        
               if(ProcessTrn(0,"PutDealInfoPM")) 
               else
                 RG.UnInit();
               end;        
             end;
        
             if(ErrMes != "")
               RGLog.Error(ErrMes);
             end;
            
             if(WarnMes != "")
               RGLog.Message(WarnMes);
             end;
            
             i = i + 1;
             if(GetDialogFlag())
               UseProgress(i);
             end;
             if(FlagCtrlBrk == true)
               break;
             end;
           end;                
        end;

        if(GetDialogFlag())
          RemProgress(); 
        end;

        OldOutPut = SetOutput(ReportFileName, TRUE);
        println("Конец обработки данных из таблицы SPB03 " + time());
        SetOutput(OldOutPut, TRUE);        
      end;
    end;
  end;
  Progress.Use();

  if(nRec == 0)
    RGLog.Message("Нет данных для загрузки.");
  else
    if((not USE_STORPROC_CREATEREPL) and (not FlagCtrlBrk))
      RG.Transfer();
      SetErrAfterLoad(true);
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    if(USE_STORPROC_CREATEREPL)
      RGLog.GetAndAddReceiveStorPrLog(RG_SECURDEAL);
    end;
    RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT, "Документ-подтверждение \"Отчет биржи\" успешно загружен\n", null, true, null, @RECORDID_MarketReport, printOnlyErr);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_SECURDEAL,"Сделка \"","\" уcпешно загружена в шлюз", @NumImportDealsTotal, PrintOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());
    stat = UpdateSPB03_PM(Synonim, SeanceID, IsRSHB, @ErrMes);
    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    // сообщаем о результатах загрузки
    SetOutput(OldOutPut, TRUE);
    RGLog.Message("Всего обработано сделок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro ProcessDataMFB06C(pan, synonim, reportFileName, printOnlyErr)
  var oldDoc_NO = "";
  var stat = 0;
  var i = 0;
  var query, cmd, ds, NRec = 0;
  var UINNumber = "";
  var OldOutPut;

  RG = TGtRecordBatchCharger();
  NumImportDeals = 0;
  FileImport = FileMFB06C;

  ErrMes = "";
  RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ MFB06C");

  stat = CheckFileUpload(synonim, "MFB06C", pan.imp_date, @ErrMes);

  Progress.Init( 1, "Выполняется очистка данных", "Очистка данных"  );
  OldOutPut = SetOutput( ReportFileName, TRUE );
  println( "Начало очистки таблицы MFB06C " + time() );
  if( stat == 0 )
     Message("Очистка таблицы MFB06C");
     stat = DelMFB06C( @ErrMes );
  end;
  println( "Конец очистки таблицы MFB06C " + time() );
  SetOutput( OldOutPut, TRUE );
  Progress.Use();
  Progress.Remove();

  if(stat)
     RGLog.Error( ErrMes );      
  else
     Progress.Init( 15, "Выполняется обработка данных", "Обработка данных"  );
     OldOutPut = SetOutput( ReportFileName, TRUE );

     println( "Начало заполнения MFB06C " + time() );
     if( stat == 0 )
     Message("Заполнение таблицы MFB06C");
       stat = FillMFB06C(Synonim, Pan.imp_date, @ErrMes);
     end;
     Progress.Use();
     println( "Конец заполнения MFB06C " + time() );

     Deals.Init();

     println( "Начало обновления MFB06C " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C");
       stat = UpdateMFB06C( Synonim, @ErrMes );
     end;
     Progress.Use();
     println( "Конец обновления MFB06C " + time() );

     println( "Начало обновления Party " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: Party");
       stat = UpdateParty(MarketID, "D_MFB06C_TMP", Pan.imp_date, @ErrMes);
     end;
     Progress.Use();
     println( "Конец обновления Party " + time() );

     println( "Начало обновления Currency " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: Currency");
       stat = UpdateCur("D_MFB06C_TMP", @ErrMes);
     end;
     Progress.Use();
     println( "Конец обновления Currency " + time() );

     println( "Начало обновления календарей " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: календари");
       stat = UpdateCalend("D_MFB06C_TMP", MarketID, CALEND_OPER_NAME, @ErrMes);
     end;
     Progress.Use();
     println( "Конец обновления календарей " + time() );

     println( "Начало обновления FIID " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: FIID");
       stat = UpdateFIID("D_MFB06C_TMP", @ErrMes);
     end;
     Progress.Use();

     println( "Начало обновления CPFIRMPARTYID " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: CPFIRMPARTYID");
       stat = UpdateCPFIRMPARTYID("D_MFB06C_TMP", @ErrMes);
     end;
     Progress.Use();

     println( "Конец обновления FIID " + time() );

     println( "Начало обновления дат " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: даты");
       stat = UpdateCalendDate("D_MFB06C_TMP", @ErrMes);
     end;
     Progress.Use();
     println( "Конец обновления дат " + time() );

     println( "Начало обновления MarketScheme " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: MarketScheme");
       stat = UpdateMarketScheme( "D_MFB06C_TMP", @ErrMes );
     end;
     Progress.Use();
     println( "Конец обновления MarketScheme " + time() );

     println( "Начало обновления объектов " + time() );
     if( stat == 0 )
       Message("Обновление данных для MFB06C: объекты");
       stat = UpdateObjMFB06C( IsRSHB, @ErrMes );
     end;
     Progress.Use();
     println( "Конец обновления объектов " + time() );

     if(stat == 0)
       Message("Обновление данных для MFB06C: портфели");
       println("Начало обновления портфелей " + time());
       stat = UpdatePortfolio("D_MFB06C_TMP", Pan.imp_date, @ErrMes);
       println("Конец обновления портфелей " + time());
     end;
     Progress.Use();

     SetOutput( OldOutPut, TRUE );
     Message("Обработка данных MFB06C");

     if(ErrMes != "")
        RGLog.Message(ErrMes);
     else
        Query = "  SELECT t.T_ID_SPB_MFB06C ID_SPB_MFB06C, "
              + "         NVL(t.T_RECNO, 0) RECNO, "
              + "         NVL(t.T_CLIENTCODE, CHR (1)) CLIENTCODE, "
              + "         NVL(t.T_CURRENCYID, CHR (1)) CURRENCYID, "
              + "         NVL(t.T_INFTYPE, 0) INFTYPE, "
              + "         NVL(t.T_CLEARINGTIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) CLEARINGTIME, "        
              + "         NVL(t.T_SETTLEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) SETTLEDATE, "
              + "         NVL(t.T_SECURITYID, CHR (1)) SECURITYID, "
              + "         NVL(t.T_ISIN, CHR (1)) ISIN, "
              + "         NVL(t.T_PRICETYPE, CHR (1)) PRICETYPE, "
              + "         NVL(t.T_REPOPART, 0) REPOPART, "
              + "         NVL(t.T_BUYSELL, CHR (1)) BUYSELL, "
              + "         NVL(t.T_SETTLECODE, CHR (1)) SETTLECODE, "
              + "         NVL(t.T_CLRACCCODE, CHR (1)) CLRACCCODE, "
              + "         NVL(t.T_TRADEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) TRADEDATE, "
              + "         NVL(t.T_TRADENO, 0) TRADENO, "
              + "         NVL(t.T_DECIMALS, 0) DECIMALS, "
              + "         NVL(t.T_PRICE, 0) PRICE, "
              + "         NVL(t.T_QUANTITY, 0) QUANTITY, "
              + "         NVL(t.T_VALUE, 0) VALUE, "
              + "         NVL(t.T_AMOUNT, 0) AMOUNT, "
              + "         NVL(t.T_EXCHCOMM, 0) EXCHCOMM, "
              + "         NVL(t.T_ACCINT, 0) ACCINT, "
              + "         NVL(t.T_CPFIRMID, CHR (1)) CPFIRMID, "
              + "         NVL(t.T_REPOPERIOD, 0) REPOPERIOD, "
              + "         NVL(t.T_REPORTTIME, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) REPORTTIME, "
              + "         NVL(t.T_CLRCOMM, 0) CLRCOMM, "
              + "         NVL(t.T_TRADEMODEID, 0) TRADEMODEID, "
              + "         NVL(t.T_TRADEPERIOD, 0) TRADEPERIOD, "
              + "         NVL(t.T_IsREPO,0) ISREPO, " 
              + "         NVL(t.T_ISERROR,0) ISERROR, " 
              + "         NVL(t.T_ISNOTFIND,0) ISNOTFIND, " 
              + "         NVL(t.T_PARTYID,0) PARTYID, " 
              + "         NVL(t.T_SFCONTRID,0) SFCONTRID, " 
              + "         NVL(t.T_CPFIRMPARTYID,0) CPFIRMPARTYID, " 
              + "         NVL(t.T_CURID,0) CURID, " 
              + "         NVL(t.T_CALENDID,0) CALENDID, " 
              + "         NVL(t.T_MARKETSCHEMEID,0) MARKETSCHEMEID, " 
              + "         NVL(t.T_NDAY1,0) NDAY1, " 
              + "         NVL(t.T_NDAY2,0) NDAY2, " 
              + "         NVL(t.T_PAYMDATE1,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) PAYMDATE1, " 
              + "         NVL(t.T_PAYMDATE2,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) PAYMDATE2, " 
              + "         NVL(t.T_CALCITOGDATE,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) CALCITOGDATE, " 
              + "         NVL(t.T_WORKSETTLEDATE,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) WORKSETTLEDATE, " 
              + "         NVL(t.T_OBJECTID,0) OBJECTID, " 
              + "         NVL(t.T_PORTFOLIO,0) PORTFOLIO, " 
              + "         NVL(t.T_ISOUTEXCREPO,0) ISOUTEXCREPO, " 
              + "         NVL(t.T_FIID, -1) FIID, "
              + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_ACCINT, 0), 0) ACCINT2, "
              + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_AMOUNT, 0), 0) AMOUNT2, "
              + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_VALUE, 0), 0) VALUE2, "
              + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_PRICE, 0), 0) PRICE2, "
              + "         NVL (Repo_2.T_SETTLEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) SETTLEDATE2, "
              + "         NVL (t.T_DOC_NO, CHR (1)) DOC_NO "
              + "  FROM D_MFB06C_TMP t, D_MFB06C_TMP Repo_2 "
              + " WHERE     t.T_INFTYPE IN (1, 2) "
              + "       AND (   (   ( (t.T_INFTYPE = 1) OR (t.T_INFTYPE = 2)) "
              + "                OR ( (t.T_REPOPART = 1) OR (t.T_REPOPART = 2))) "
              + "            OR (t.T_REPOPART = 0)) "
              + "       AND NOT EXISTS "
              + "                 (SELECT 1 "
              + "                    FROM D_MFB06C_TMP Repo_1 "
              + "                   WHERE     t.t_tradeno = Repo_1.t_tradeno "
              + "                         AND Repo_1.T_INFTYPE = 1 "
              + "                         AND Repo_1.T_REPOPART = 1 "
              + "                         AND t.T_INFTYPE = 1 "
              + "                         AND t.T_REPOPART = 2) "
              + "       AND t.t_tradeno = Repo_2.t_tradeno(+) "
              + "       AND Repo_2.T_INFTYPE(+) IN (1,2,3) "
              + "       AND Repo_2.T_REPOPART(+) = 2 "
              + "       AND t.t_clientCode = Repo_2.t_clientCode(+) "
              + "       ORDER BY t.T_ID_SPB_MFB06C "
              ;
        cmd = DL_RSDCommand(Query);

        NRec = cmd.GetCount();
        NumImportDeals = NRec;

        if( NRec > 0 )
           if(GetDialogFlag())
              InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ MFB06C");
           end;
           OldOutPut = SetOutput( ReportFileName, TRUE );
           println( "Начало обработки данных из таблицы MFB06C " + time() );
           SetOutput( OldOutPut, TRUE );

           if(USE_STORPROC_CREATEREPL) // создание объектов записей репликаций через ХП
              var cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.CreateReplRecByTmp_MFB06C(?, ?, ?, ?); END;");
              cmdSP.addParam("stat", RSDBP_RETVAL, V_INTEGER);
              cmdSP.addParam("", RSDBP_IN, SeanceID);
              cmdSP.addParam("", RSDBP_IN, imp_date);
              cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
              cmdSP.addParam("", RSDBP_IN, GetPrmStr(Pan));
              cmdSP.Execute();
          
              stat = Int(cmdSP.value("stat"));
           else
              ds = cmd.execute();
              while(ds.MoveNext)
                 ErrMes = "";
                 WarnMes = "";
                 Deals.DOC_NO         = ds.DOC_NO;
                 Deals.ClientCode     = ds.CLIENTCODE;
                 Deals.CurrencyId     = ds.CURRENCYID;
                 Deals.InfType        = ds.INFTYPE;          
                 Deals.CliringTime    = ds.CLEARINGTIME;
                 Deals.SettleDate     = ds.SETTLEDATE;
          
                 Deals.SecurityId     = ds.SECURITYID;
                 Deals.ISIN           = ds.ISIN;
                 Deals.PriceType      = ds.PRICETYPE;
                 Deals.RepoPart       = ds.REPOPART;
          
                 Deals.BuySell        = ds.BUYSELL;
                 Deals.SettleCode     = ds.SETTLECODE;
                 Deals.TradeDate      = ds.TRADEDATE;
                 Deals.TradeNo        = ds.TRADENO;
                 Deals.Decimals       = ds.DECIMALS;
                 Deals.Price          = ds.PRICE;
                 Deals.Quantity       = ds.QUANTITY;
                 Deals.Value_         = ds.VALUE;
                 Deals.Amount         = ds.AMOUNT;
                 Deals.ExhComm        = ds.EXCHCOMM;
                 Deals.AccInt         = ds.ACCINT;
                 Deals.CPFirmId       = ds.CPFIRMID;
                 Deals.RepoPeriod     = ds.REPOPERIOD;
                 Deals.TradeModeId    = ds.TRADEMODEID;
                 Deals.Session        = ds.TRADEPERIOD;
                 Deals.ClrAccCode     = ds.CLRACCCODE;
                 Deals.CPFirmId       = ds.CPFirmId;   
                 Deals.RepoRate       = 0;
                 Deals.ISREPO         = ds.ISREPO;
          
                 if(Deals.RepoPart == 1)
                   Deals.AccInt2        = ds.ACCINT2;
                   Deals.Amount2        = ds.AMOUNT2;
                   Deals.Value2_        = ds.VALUE2;
                   Deals.Price2         = ds.PRICE2;
                     НайтиДанныеПо2Части( ds.SettleDate, ds.SettleDate2, Deals.Amount, Deals.Amount2, @Deals.RepoRate);
                   if(ds.ISOUTEXCREPO == 1)
                     Deals.ClrComm      = ds.CLRCOMM;  
                   end;
                 end;
                    
                 Portfolio_           = ds.Portfolio;
                 CurrencyId           = ds.CurID;
                 calendId             = ds.CALENDID;
                 ClientContrID        = ds.SfContrID;
                 ClientID             = ds.PartyID;
                 MarketSchemeID       = ds.MarketSchemeID;
                 PaymDate1_           = date(ds.PAYMDATE1);
                 PaymDate2_           = date(ds.PAYMDATE2);
                 NDay1_               = ds.NDAY1;
                 WorkSettleDate_      = date(ds.WORKSETTLEDATE);
                  
                 Deals.IsCliring = true;
                 UINNumber = GetUINNumber(IsRSHB);
          
                 if( (ds.CPFirmId != "") AND (ds.CPFIRMPARTYID <= 0) )
                   ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В ГКБО не найден субъект с принадлежностью \'Центральный контрагент\'";  
                 end;
                 if( (ds.OBJECTID > 0) )
                   ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Запись репликации с действием создать для объекта " + int(ds.OBJECTID) + " уже передавалась в RS-Bank.""\n Повторная репликация невозможна.""\n";  
                 end;
                 if( (Deals.ClientCode!= "") AND (ClientID <= 0) )
                   ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Не найден субъект через краткий код на бирже \"" + Deals.ClientCode + "\"";  
                 end;
                 if( (Deals.CurrencyId!= "") AND (ds.CurID < 0) )
                   ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике не найден ФИ с кодом \"" + Deals.CurrencyId + "\" вида " + FICK_SPBEX ;
                 end;
                 if((Deals.ISIN != "") and (ds.FIID == -1))
                   ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике не найден ФИ с ISIN \"" + Deals.ISIN + "\"";  
                 end;
          
                 Deals.IsCliring = false;
                 if(ErrMes == "")
          
                   if(ds.ISOUTEXCREPO == 1)
                     if( oldDoc_NO != Deals.DOC_NO ) 
                        if(ProcessTrn(0, "PutMarketReport"))
                        else
                           RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep );
                        end;
                        ErrMes = "";
                        oldDoc_NO = Deals.DOC_NO;
                     end;   
          
                     SetPartPrmDeal_PM();
                     if (ProcessTrn(0,"PutDealInfoPM")) 
                     else
                        RG.UnInit();
                     end;
                   end;
                   Deals.IsCliring = true;
          
                   if(IsCliringData())
                     SetPartPrmDeal_PM();
                     if (ProcessTrn(0,"PutDealInfoPM")) 
                        Deals.IsCliring = false;
                     else
                        Deals.IsCliring = false;
                        RG.UnInit();
                     end;
                   end;          
                 end;
          
                 if( ErrMes != "" )
                    RGLog.Error(ErrMes);
                 end;
                
                 if( WarnMes != "" )
                    RGLog.Message(WarnMes);
                 end;
                
                 i = i + 1;
                 if(GetDialogFlag())
                    UseProgress(i);
                 end;
                 if( FlagCtrlBrk == true )
                    break;
                 end;
              end;              
           end;

           if(GetDialogFlag())
              RemProgress(); 
           end;

           OldOutPut = SetOutput( ReportFileName, TRUE );
           println( "Конец обработки данных из таблицы MFB06C " + time() );
           SetOutput( OldOutPut, TRUE );
        end;
     end;
     Progress.Use();
  end;

  if( NRec == 0 )
     RGLog.Message("Нет данных для загрузки.");
  else
     if((not USE_STORPROC_CREATEREPL) and (not FlagCtrlBrk))
        RG.Transfer();
        SetErrAfterLoad(true);
     end;
     Progress.Use();
     Message("Заполнение протокола");
     /*загрузить в лог инфу о загруженных ЗР*/
     if(USE_STORPROC_CREATEREPL)
       RGLog.GetAndAddReceiveStorPrLog(27);
     end;
     RGLog.GetAndAddReceiveLoadRecsMass(27,"Клиринг.Сделка \"","\" уcпешно загружена в шлюз", @NumImportDealsTotal, printOnlyErr);

     Progress.Use();
     OldOutPut = SetOutput( ReportFileName, TRUE );
     println( "Начало обновления таблицы в Payments " + time() );
     Message("Обновление данных в Payments");
     stat = UpdateMFB06C_PM(Synonim, SeanceID, IsRSHB, @ErrMes);
     if( stat )
       RGLog.Error(ErrMes);      
     end;
     Progress.Use();
     println( "Конец обновления таблицы в Payments " + time() );
     /* сообщаем о результатах загрузки */
     SetOutput( OldOutPut, TRUE );
     RGLog.Message("Всего обработано сделок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));

     Progress.Use();
     Progress.Remove();
  end;

end;

private macro ProcessDataMFB99(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, cmdSP;
  var stat:integer = 0, nRec:integer = 0;
  var filesName:string = "";

  ErrMes = "";
  NumImportDeals = 0;
  RGLog.Message("ЗАГРУЗКА ДВИЖЕНИЯ Д/С");
  Progress.Init(6, "Выполняется обработка данных MFB99", "Выполняется обработка данных MFB99");
  
  Message("Очистка таблицы MFB99");
  oldOutPut = SetOutput(reportFileName, TRUE);
  println("Начало очистки таблицы MFB99 " + time());

  cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.DelMFB99(?, ?); END;");
  cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
  cmdSP.addParam("", RSDBP_IN, SeanceID);
  cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
  cmdSP.Execute();
  stat = Int(cmdSP.value("stat"));

  println("Конец очистки таблицы MFB99 " + time());
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы MFB99");
    println("Начало заполнения MFB99 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.FillMFB99(?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.imp_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения MFB99 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для MFB99: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.UpdateObjMFB99(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных MFB99");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_MONEYMOTION);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_MFB99_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы MFB99 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_MFB99_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла движения денежных средств", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ MFB99");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.CreateReplRecByTmp_MFB99(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat")); 

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы MFB99 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_MONEYMOTION);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_MONEYMOTION, "Движение денежных средств с номером  \"","\" уcпешно загружено в шлюз", @NumImportDealsTotal, printOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.UpdateMFB99_PM(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro ProcessDataMFB13(pan:variant, synonim:string, reportFileName:string, printOnlyErr:bool)
  var oldOutPut, cmd, cmdSP;
  var stat:integer = 0, nRec:integer = 0;
  var filesName:string = "";

  ErrMes = "";
  NumImportDeals = 0;
  RGLog.Message("ЗАГРУЗКА ИТОГОВЫХ НЕТТО-ТРЕБОВАНИЙ И НЕТТО-ОБЯЗАТЕЛЬСТВ");
  Progress.Init(6, "Выполняется обработка данных MFB13", "Выполняется обработка данных MFB13");
  
  Message("Очистка таблицы MFB13");
  oldOutPut = SetOutput(reportFileName, TRUE);
  println("Начало очистки таблицы MFB13 " + time());

  cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.DelMFB13(?, ?); END;");
  cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
  cmdSP.addParam("", RSDBP_IN, SeanceID);
  cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
  cmdSP.Execute();
  stat = Int(cmdSP.value("stat"));

  println("Конец очистки таблицы MFB13 " + time());
  Progress.Use();

  if(stat == 0)
    Message("Заполнение таблицы MFB13");
    println("Начало заполнения MFB13 " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.FillMFB13(?, ?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.addParam("", RSDBP_IN, pan.imp_date);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец заполнения MFB13 " + time());
  end;
  Progress.Use();

  if(stat == 0)
    Message("Обновление данных для MFB13: объекты");
    println("Начало обновления объектов " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.UpdateObjMFB13(?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    println("Конец обновления объектов " + time());
  end;
  Progress.Use();

  Message("Обработка данных MFB13");
  SetOutput( OldOutPut, TRUE );
  if(ErrMes != "")
    RGLog.Error(ErrMes);
  elif(stat)
    RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
  else
    cmd = DL_RSDCommand("SELECT 1 FROM D_MFB13_TMP t");
    nRec = cmd.GetCount();
    NumImportDeals = NRec;

    if(nRec == 0)
      RGLog.Message("Нет данных для загрузки.");
    else
      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Начало обработки данных из таблицы MFB13 " + time());
      SetOutput( OldOutPut, TRUE );

      filesName = "";
      if(stat == 0)
        stat = GetFileName(synonim, "D_MFB13_TMP", @filesName, @ErrMes);
      end;
      if(stat)
        RGLog.Error(ErrMes);      
      end;
      RGLog.Message("Используются файлы: \n" + filesName);

      if(GetDialogFlag())
        InitProgress(NRec, "Загрузка внешнего файла движения денежных средств", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ MFB13");
      end;

      cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.CreateReplRecByTmp_MFB13(?, ?); END;");
      cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
      cmdSP.addParam("", RSDBP_IN, SeanceID);
      cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
      cmdSP.Execute();
      stat = Int(cmdSP.value("stat")); 

      OldOutPut = SetOutput(ReportFileName, TRUE);
      println("Конец обработки данных из таблицы MFB13 " + time());
      SetOutput(OldOutPut, TRUE);

      if(GetDialogFlag())
        RemProgress(); 
      end;
    end;
    Progress.Use();

    //загрузить в лог инфу о загруженных ЗР
    Message("Заполнение протокола");
    RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
    RGLog.GetAndAddReceiveLoadRecsMass(RG_DLITOGCLVR, "Итоговые нетто-требования и нетто-обязательства с номером \"","\" уcпешно загружены в шлюз", @NumImportDealsTotal, printOnlyErr);
    Progress.Use();

    OldOutPut = SetOutput(ReportFileName, TRUE);
    Message("Обновление данных в Payments");
    println("Начало обновления таблицы в Payments " + time());

    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_SPB.UpdateMFB13_PM(?, ?, ?); END;");
    cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
    cmdSP.addParam("", RSDBP_IN, SeanceID);
    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
    cmdSP.addParam("", RSDBP_IN, synonim);
    cmdSP.Execute();
    stat = Int(cmdSP.value("stat"));

    if(stat)
      SetOutput(OldOutPut, TRUE);
      RGLog.Error(ErrMes);
      OldOutPut = SetOutput(ReportFileName, TRUE);
    end;
    println("Конец обновления таблицы в Payments " + time());
    SetOutput(OldOutPut, TRUE);

    Progress.Use();
  end;

  Progress.Remove();

OnError(ErObj)
  SetOutput(OldOutPut, TRUE);
  RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
end;

private macro RunImportPMTS( Pan )
  var RetVal = CM_SAVE;
  var oldDoc_NO = "";
  var file_name = "";
  var Synonim = "";
  var NameDate = FileDateInName(Pan.imp_date);
  var stat = 0;
  var i = 0;
  var query, cmd, ds, NRec = 0;
  var UINNumber = "";
  var printOnlyErr = false;
  var ReportFileName, OldOutPut;
  var Num = 0;
  var hour, min, sec;

  TimeSplit( Time(), hour, min, sec);

  var namef = NameDate + string(Time());
  ReportFileName = GetTxtFileName("gtImSpbP_" + NameDate + "_"+ hour + min + sec);

  RGLog = GTDL_Log(SeanceID);

  if(Pan.imp_date > {curdate})
    if(GetDialogFlag())
      MsgBox("Неверно задана дата.");
    else
      RGLog.Error("Дата операции больше операционного дня.");
    end;
    RetVal = CM_IGNORE;
  end;

  Synonim = GetShemePathGATE();
  if(Synonim == "")
    if(GetDialogFlag())
      MsgBox("Не найден схема Payments");
    else
      RGLog.Error("Не найден схема Payments");
    end;
    RetVal = CM_IGNORE;
  end;

  MarketID = RGDLFUN_GetClientID(SPB_CODE, PTCK_CONTR);
  if(MarketID <= 0)
    if(GetDialogFlag())
      MsgBox("В ГКБО не найден субъект с кодом \"" + SPB_CODE + "\" вида " + PTCK_CONTR);
    else
      RGLog.Error("В ГКБО не найден субъект с кодом \"" + SPB_CODE + "\" вида " + PTCK_CONTR);
    end;
    RetVal = CM_IGNORE;
  end;

  RG_GetCentralContrForMarket(false ,@CPFirmIdConst, null/*, @ErrMes*/);

  if(RetVal != CM_IGNORE)
     imp_date = Pan.imp_date;
     NumImportDeals = 0;
     NumImportDealsTotal = 0;

     printOnlyErr = ВыводитьВПротоколТолькоОшибки(@ErrMes);
     if(ErrMes != "")
       RGLog.Error(ErrMes);      
     end;

     USE_STORPROC_CREATEREPL = DL_ИспользPaymentsПриИмпортеСПБЧасть2(@ErrMes);
     if(ErrMes != "")
       RGLog.Error(ErrMes);      
     end;

     if(Pan.request == SET_CHAR) // ORDERS
       ProcessDataORDERS(pan, synonim, reportFileName, printOnlyErr);
     end;

     if(Pan.deals == SET_CHAR) // SPB03
       ProcessDataSPB03(pan, synonim, reportFileName, printOnlyErr);
     end;

     if(Pan.deals_clearing_client == SET_CHAR) // MFB06C
       ProcessDataMFB06C(pan, synonim, reportFileName, printOnlyErr);
     end;

     if(Pan.MoneyMotion == SET_CHAR) // MFB99
       ProcessDataMFB99(pan, synonim, reportFileName, printOnlyErr);
     end;

     if(Pan.NettoItog == SET_CHAR) // MFB13
       ProcessDataMFB13(pan, synonim, reportFileName, printOnlyErr); 
     end;
  end;

  Progress.Init( 1, "Выполняется сохранение протокола", "Сохранение протокола"  );
  RGLog.Save();
  Progress.Use();
  Progress.Remove();
     
  return RetVal;

OnError( RslErrObj )
  MsgBox("Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message);
  RunError;
end;

private macro RunInitPMTS(Pan)
   Pan.imp_date              = {curdate};
   Pan.request               = SET_CHAR;
   Pan.deals                 = SET_CHAR;
   Pan.deals_clearing_client = SET_CHAR;
   Pan.deals_bo              = SET_CHAR;
   Pan.NettoItog             = SET_CHAR;
   Pan.MoneyMotion           = UNSET_CHAR;
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)

   if (Cmd == DLG_INIT)
        RunInitPMTS(Pn);
        UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
      Pn.imp_date = GetDateByCalendar( Pn.imp_date );
      UpdateFields(Pn);

   elif ((Cmd == DLG_KEY) and (Key == 32)) /* Пробел */
      if ( (ID == PNFLD_REQUEST)
      or  (ID == PNFLD_SECUR)
      or  (ID == PNFLD_CLEARING_CLIENT)
      or  (ID == PNFLD_SEC_BO)
      or  (ID == PNFLD_NETTOITOG)
      or  (ID == PNFLD_MONEYMOTION)
      )
         Pn(ID) = IIF(Pn(ID) == SET_CHAR, UNSET_CHAR, SET_CHAR);
      end;
   elif ( (cmd == DLG_KEY) AND ( Key == 316 ) )
      return RunImportPMTS(Pn);
   elif ( (cmd == DLG_KEY) AND ( (Key == 13) or (Key == 323) ) )
      return CM_IGNORE;
   end;
   return CM_DEFAULT;
end;

macro Process( SeanceID, Parms )
end;

macro Receive( _SeanceID:integer, Parm:variant )
  SeanceID = _SeanceID;

   SOURCE_CODE = "SRC-29";

  if( IsShedulerRunning() )
     RunInitPMTS(pp);
     AutoSetParm(pp, Parm);                     // пар-ры из панели источника
     AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
     RunImportPMTS(pp);     
  else
     var autoproc;
     if( (GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc) )
        RunInitPMTS(pp);
        AutoSetParm(pp, Parm);
        RunImportPMTS(pp);
     else
        RunDialog(pp, "ProcessPanel");
     end;
  end;

  return 0;
end;

macro Deliver( SeanceID, Parm )
end;
