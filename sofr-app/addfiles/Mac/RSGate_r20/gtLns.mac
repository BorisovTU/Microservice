/***********************************************************************
*  Модуль           : Шлюз
*  Имя файла        : gtLns.mac
*  Описание         : Импорт операций из Thaler
*  Программист      : SAI 01 OCT 2007
************************************************************************/

import SbCrdInter, RsbDataSet, "lclient.mac", "rgtgtrec.mac", "gtdlfun.mac", "rgobj.mac", "acc_crd.mac","rgobj.mac";

private CONST APPLICATION_ID_Import  = 108; // ID Thaler
private CONST APPLICATION_ID_PlanPay = 109; // ID График Thaler
private CONST APPLICATION_ID_Export = 11;  // ID RS-Bank
private CONST ThalerCrdObjID = 220;        // ID Обьект Договор Thaler
private FILE TypeCrd      ("type_crd.dbt", "loans.def");


MACRO FindCrdPayType (TypeID)
  TypeCrd.CreditTypeID = TypeID;
  IF ( getEQ(TypeCrd) )  RETURN TypeCrd.TypeOverdraft;
  ELSE RETURN 0;
  END;
END;


macro LnsFindCrdByFollowUpAccount(FollowUpAccount:STRING, crd):INTEGER
   var  ObjectCode:INTEGER;
   var  ApplicationID, ObjectKind;
   var  CreditNumber = -1;
   var  RetVal = -1;

   RetVal = GetObjectID(APPLICATION_ID_Import,ThalerCrdObjID,FollowUpAccount,@ObjectCode);

   if (RetVal == 0)
     if (GetObjectCode(APPLICATION_ID_Export,ObjectCode,@CreditNumber) == 0)
       if ((ValType(crd) != V_UNDEF))
          Loans_FindCrdContract(CreditNumber,crd);
       END;
       return CreditNumber;
     END;
   END;


   return RetVal;
end;



////////////////////////////////////////////////////////////////////////////////



MACRO GetRegID(Function, ConractID, Type)
   VAR cmd;

   cmd = RsdCommand(RslDefCon, "begin ? := "+Function+" ( ?,?,? ); end;" );

   cmd.addParam( "retval", RSDBP_RETVAL, V_INTEGER );

   cmd.addParam("LO_CREDIT",    RSDBP_IN, LO_CREDIT);
   cmd.addParam("ContractID",   RSDBP_IN, ConractID);
   cmd.addParam("Type",         RSDBP_IN, Type);

   cmd.execute();

   RETURN cmd.value(0);
END;



////////////////////////////////////////////////////////////////////////////////////////////////////////////



macro LnsCreateCrdContract(RecordID:INTEGER, NewID:@STRING, Comment:@STRING):INTEGER
   var Rec, OperationID;
   var q, rsb;
   var   Client = TLoansClient;
   record Credit_C("credit_c.dbt");


   Rec = TGTrecord();
   Rec.LoadFromDB(RecordID);

   Credit_C.CreditTypeID_Ref  = Rec.GetParmByName("Product").Val;
   Credit_C.UsCreditNumber    = Rec.GetParmByName("ContractNumber").Val;
   Credit_C.CurCode           = Rec.GetParmByName("Currency").Val;
   Credit_C.RegDate           = Rec.GetParmByName("RepaymentStartDate").Val;
   Credit_C.ReturnDate        = Rec.GetParmByName("RepaymentEndDate").Val;
   Credit_C.Duration          = Rec.GetParmByName("RepaymentDuration").Val;
   Credit_C.TypeDuration      = Rec.GetParmByName("RepaymnetTypeDuration").Val;
   Credit_C.ClientID_Ref      = Rec.GetParmByName("ClientIdenty").Val;
   Credit_C.CreditSum         = Rec.GetParmByName("LoanAmount").Val;
   Credit_C.TerritorialStruct = Rec.GetParmByName("Entity").Val;

   Credit_C.FNCash        = Credit_C.TerritorialStruct;
   Credit_C.CreditState   = CF_OPEN;
   Credit_C.FlagOB        = 1;
   Credit_C.Crd_kind      = 1;

   Credit_C.PayType       = FindCrdPayType(Credit_C.CreditTypeID_Ref);

   Client.GetRecord(Credit_C.ClientID_Ref);
   Credit_C.LegalForm = Client.LegalForm;

   IF ( Credit_C.LegalForm == 1 )
      Credit_C.TypeDebtor = 1;
   ELSE
      Credit_C.TypeDebtor = 2;
   END;

   OperationID = MakeOperation(0, 0, CF_OPCRD, 0, Rec.GetParmByName("SingingDate").Val, Credit_C);

   IF (OperationID != 0)
     q = " SELECT T_CREDITNUMBER_REF FROM  DCRD_OP_DBT WHERE T_CREDOPERID = "+OperationID;
     rsb = TRsbDataSet( q );


     IF( rsb.MoveNext() )
       NewID = string( rsb.value("T_CREDITNUMBER_REF") );
     ELSE
      Comment = "Не удалось получить номерк договора по ID опрерции открытия договора. ID операции: "+OperationID;
      return 1;
     END;


     // Операция открытия счетов:
     OperationID = MakeOperation(rsb.rec.T_CREDITNUMBER_REF, LO_CREDIT, OP_ACC, 0, Rec.GetParmByName("SingingDate").Val, rsb.rec.T_CREDITNUMBER_REF,1);
     IF (OperationID == 0)
        NewID = 0;
        Comment = GetMO_LoansError();
        return 1;
     END;
   ELSE
     Comment = GetMO_LoansError();
     return 1;
   END;
   return 0;
end;




////////////////////////////////////////////////////////////////////////////////////////////////////////////


macro LnsCloseCrdContract(RecordID:INTEGER, NewID:@STRING, Comment:@STRING):INTEGER
  var OperationID, Rec;
  var ContarctID;

  Rec = TGTrecord();
  Rec.LoadFromDB(RecordID);

  ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val);

  OperationID = MakeOperation(ContarctID, 0, CF_CLCRD, CF_NOENS, {curdate},1,1);

  IF (OperationID == 0)
       NewID = 0;
       Comment = GetMO_LoansError();
       return 0;
  ELSE
       NewID = OperationID;
  END;

  return OperationID;

end;



////////////////////////////////////////////////////////////////////////////////////////////////////////////



macro Выдача( Rec, NewID:@STRING, Comment:@STRING ):INTEGER
  var OperationID;
  var ContarctID,Curency;
  record Credit_C("credit_c.dbt");

  ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val,Credit_C);
  Curency = Credit_C.CURCODE;

  OperationID = MakeOperation(ContarctID, LO_CREDIT, Rec.GetParmByName("TypeOfOperation").Val, Curency,
                              Rec.GetParmByName("Date").Val, 0, "","",Rec.GetParmByName("Amount").Val);

  IF (OperationID == 0)
       NewID = 0;
       Comment = GetMO_LoansError();
       return 0;
  ELSE
       NewID = OperationID;
  END;

  return OperationID;
end;

////////////////////////////////////////////////////////////////////////////////////////////////////////////

macro Погашение( Rec, NewID:@STRING, Comment:@STRING ):INTEGER
  var OperationID;
  var ContarctID,Curency;
  var SUM = TArray(0),PAY_SUM= TArray(0),PARENT_ID = TArray(0),REFRENCE = TArray(0);
  var Registr,Stavka,i,stat;
  var quary;
  record Credit_C("credit_c.dbt");
  FILE PaymentTmp ( "payment.tmp") key 0 write;
  //record PaymentTmp("payment.tmp");

  // Заполняем переменные параметры
  SUM(SUM.size)       = Rec.GetParmByName("Amount").Val;
  SUM(SUM.size)       = Rec.GetParmByName("AmountInterest").Val;
  SUM(SUM.size)       = Rec.GetParmByName("AmountOfLateInterest").Val;
  SUM(SUM.size)       = Rec.GetParmByName("AmountOfLateCapital").Val;
  SUM(SUM.size)       = Rec.GetParmByName("LatePaymentInterest").Val;
  SUM(SUM.size)       = Rec.GetParmByName("LatePaymentPenalty").Val;

  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("Amount").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("AmountInterest").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("AmountOfLateInterest").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("AmountOfLateCapital").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("LatePaymentInterest").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("LatePaymentPenalty").Val;


  PARENT_ID(PARENT_ID.size) = 1;
  PARENT_ID(PARENT_ID.size) = 1;
  PARENT_ID(PARENT_ID.size) = 2;
  PARENT_ID(PARENT_ID.size) = 2;
  PARENT_ID(PARENT_ID.size) = 3;
  PARENT_ID(PARENT_ID.size) = 3;

  REFRENCE(REFRENCE.size)  = 7;
  REFRENCE(REFRENCE.size)  = 4;
  REFRENCE(REFRENCE.size)  = 3;
  REFRENCE(REFRENCE.size)  = 5;
  REFRENCE(REFRENCE.size)  = 1;
  REFRENCE(REFRENCE.size)  = 2;


  ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val,Credit_C);
  Curency = Credit_C.CURCODE;


  // Заполняем таблицу DPAYMENT_TMP
  i = 0;
  stat = 0;
  while( (i < 6) and (stat == 0) )
    ClearRecord(PaymentTmp);
    // Заполняем постоянные пераметры
    PaymentTmp.ISOPERATION        = 0;
    PaymentTmp.OBJID              = LO_CREDIT;
    PaymentTmp.OBJN               = ContarctID;
    PaymentTmp.REGID              = 0;
    PaymentTmp.CURCODE            = Curency;
    PaymentTmp.BEGDATE            = Rec.GetParmByName("Date").Val;
    PaymentTmp.ENDDATE            = Rec.GetParmByName("EndDate").Val;;
    PaymentTmp.RESTNOPAY          = 0;
    PaymentTmp.DOCDUTYID_REF      = 0;
    PaymentTmp.RATEID             = 0;
    PaymentTmp.SYSTEMOPERATIONID  = 3;
    PaymentTmp.CREDITNUMBER_REF   = ContarctID;
    PaymentTmp.PAYMENTID_REF      = 0;
    PaymentTmp.PAYDATE            = Rec.GetParmByName("Date").Val;
    // Переменные параметры
    PaymentTmp.SUM        = SUM(i);
    PaymentTmp.PAYSUM     = PAY_SUM(i);
    PaymentTmp.PARENTID   = PARENT_ID(i);
    PaymentTmp.REFERENCE  = REFRENCE(i);

    stat = Insert(PaymentTmp);
    i = i +1;
  end;

  // Проверяем Значение флага процентов
  if (Rec.GetParmByName("LatePaymentInterest").Val > 0)
      Registr = GetRegID("LoansKernel.GetUsRegID_ForObject", ContarctID, 2);
      Stavka  = GetRegID("LoansKernel.GetUsRateID_ForObject", ContarctID, 2);

      quary = "INSERT INTO DPERCPAY_TMP (T_ID, T_RATEID, T_BEGINDATE, T_REST, T_PERCSUM, "+
             " T_FIRSTID, T_OBJECTTYPEID, T_OBJECTNUMBER) "+
             " VALUES ("+Registr+","+Stavka+","+getSQLDate(Rec.GetParmByName("EndDate").Val)+", "
             +Rec.GetParmByName("LatePaymentInterest").Val+","+ Rec.GetParmByName("LatePaymentInterest").Val+","+
             Registr+","+ LO_CREDIT+","+ContarctID+")";

      stat = SQL_Execute(quary);

  END;

  if (Rec.GetParmByName("LatePaymentPenalty").Val > 0)
      Registr = GetRegID("LoansKernel.GetUsRegID_ForObject", ContarctID, 3);
      Stavka  = GetRegID("LoansKernel.GetUsRateID_ForObject", ContarctID, 3);

      quary = "INSERT INTO DPERCPAY_TMP (T_ID, T_RATEID, T_BEGINDATE, T_REST, T_PERCSUM, "+
             " T_FIRSTID, T_OBJECTTYPEID, T_OBJECTNUMBER) "+
             " VALUES ("+Registr+","+Stavka+","+getSQLDate(Rec.GetParmByName("EndDate").Val)+", "
             +Rec.GetParmByName("LatePaymentPenalty").Val+","+ Rec.GetParmByName("LatePaymentPenalty").Val+","+
             Registr+","+ LO_CREDIT+","+ContarctID+")";

      stat = SQL_Execute(quary);

  END;



  OperationID = MakeOperation(ContarctID, LO_CREDIT, Rec.GetParmByName("TypeOfOperation").Val, Curency,
                              Rec.GetParmByName("Date").Val, 1, "","",0);

  IF (OperationID == 0)
       NewID = 0;
       Comment = GetMO_LoansError();
       return 0;
  ELSE
       NewID = OperationID;
  END;

  return OperationID;
end;

////////////////////////////////////////////////////////////////////////////////////////////////////////////

macro НачислениеПроцентов( Rec, NewID:@STRING, Comment:@STRING ):INTEGER
  var OperationID;
  var ContarctID,Curency;
  var SUM = TArray(0),PAY_SUM= TArray(0),PARENT_ID = TArray(0),REFRENCE = TArray(0);
  var Registr,Stavka,i,stat;
  var quary;
  record Credit_C("credit_c.dbt");
  FILE PaymentTmp ( "payment.tmp") key 0 write;
  //record PaymentTmp("payment.tmp");

  // Заполняем переменные параметры
  SUM(SUM.size)       = Rec.GetParmByName("AmountInterest").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("AmountInterest").Val;
  PARENT_ID(PARENT_ID.size) = 2;
  REFRENCE(REFRENCE.size)  = 4;


  ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val,Credit_C);
  Curency = Credit_C.CURCODE;


  // Заполняем таблицу DPAYMENT_TMP
  ClearRecord(PaymentTmp);
  // Заполняем постоянные пераметры
  PaymentTmp.ISOPERATION        = 0;
  PaymentTmp.OBJID              = LO_CREDIT;
  PaymentTmp.OBJN               = ContarctID;
  PaymentTmp.REGID              = 0;
  PaymentTmp.CURCODE            = Curency;
  PaymentTmp.BEGDATE            = Rec.GetParmByName("Date").Val;
  PaymentTmp.ENDDATE            = Rec.GetParmByName("EndDate").Val;;
  PaymentTmp.RESTNOPAY          = 0;
  PaymentTmp.DOCDUTYID_REF      = 0;
  PaymentTmp.RATEID             = 0;
  PaymentTmp.SYSTEMOPERATIONID  = 3;
  PaymentTmp.CREDITNUMBER_REF   = ContarctID;
  PaymentTmp.PAYMENTID_REF      = 0;
  PaymentTmp.PAYDATE            = Rec.GetParmByName("Date").Val;

  PaymentTmp.SUM        = SUM(0);
  PaymentTmp.PAYSUM     = PAY_SUM(0);
  PaymentTmp.PARENTID   = PARENT_ID(0);
  PaymentTmp.REFERENCE  = REFRENCE(0);

  stat = 0;
  stat = Insert(PaymentTmp);

  // Проверяем Значение флага процентов
  if (Rec.GetParmByName("AmountInterest").Val > 0)
      Registr = GetRegID("LoansKernel.GetUsRegID_ForObject", ContarctID, 2);
      Stavka  = GetRegID("LoansKernel.GetUsRateID_ForObject", ContarctID, 2);

      quary = "INSERT INTO DPERCPAY_TMP (T_ID, T_RATEID, T_BEGINDATE, T_REST, T_PERCSUM, "+
             " T_FIRSTID, T_OBJECTTYPEID, T_OBJECTNUMBER) "+
             " VALUES ("+Registr+","+Stavka+","+getSQLDate(Rec.GetParmByName("EndDate").Val)+", "
             +Rec.GetParmByName("AmountInterest").Val+","+ Rec.GetParmByName("AmountInterest").Val+","+
             Registr+","+ LO_CREDIT+","+ContarctID+")";

      stat = SQL_Execute(quary);

  END;


  OperationID = MakeOperation(ContarctID, LO_CREDIT, Rec.GetParmByName("TypeOfOperation").Val, Curency,
                              Rec.GetParmByName("Date").Val, 1);

  IF (OperationID == 0)
       NewID = 0;
       Comment = GetMO_LoansError();
       return 0;
  ELSE
       NewID = OperationID;
  END;

  return OperationID;
end;

////////////////////////////////////////////////////////////////////////////////////////////////////////////

macro Просрочка( Rec, NewID:@STRING, Comment:@STRING ):INTEGER
  var OperationID;
  var ContarctID,Curency;
  var SUM = TArray(0),PAY_SUM= TArray(0),PARENT_ID = TArray(0),REFRENCE = TArray(0);
  var Registr,Stavka,i,stat;
  var quary;
  record Credit_C("credit_c.dbt");
  FILE PaymentTmp ( "payment.tmp") key 0 write;
  //record PaymentTmp("payment.tmp");

  // Заполняем переменные параметры
  SUM(SUM.size)       = Rec.GetParmByName("Amount").Val;
  SUM(SUM.size)       = Rec.GetParmByName("AmountInterest").Val;

  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("Amount").Val;
  PAY_SUM(PAY_SUM.size)   =  Rec.GetParmByName("AmountInterest").Val;


  PARENT_ID(PARENT_ID.size) = 1;
  PARENT_ID(PARENT_ID.size) = 2;

  REFRENCE(REFRENCE.size)  = 7;
  REFRENCE(REFRENCE.size)  = 4;


  ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val,Credit_C);
  Curency = Credit_C.CURCODE;


  // Заполняем таблицу DPAYMENT_TMP
  i = 0;
  stat = 0;
  while( (i < 3) and (stat == 0) )
    ClearRecord(PaymentTmp);
    // Заполняем постоянные пераметры
    PaymentTmp.ISOPERATION        = 0;
    PaymentTmp.OBJID              = LO_CREDIT;
    PaymentTmp.OBJN               = ContarctID;
    PaymentTmp.REGID              = 0;
    PaymentTmp.CURCODE            = Curency;
    PaymentTmp.BEGDATE            = Rec.GetParmByName("Date").Val;
    PaymentTmp.ENDDATE            = Rec.GetParmByName("EndDate").Val;;
    PaymentTmp.RESTNOPAY          = 0;
    PaymentTmp.DOCDUTYID_REF      = 0;
    PaymentTmp.RATEID             = 0;
    PaymentTmp.SYSTEMOPERATIONID  = 3;
    PaymentTmp.CREDITNUMBER_REF   = ContarctID;
    PaymentTmp.PAYMENTID_REF      = 0;
    PaymentTmp.PAYDATE            = Rec.GetParmByName("Date").Val;
    // Переменные параметры
    PaymentTmp.SUM        = SUM(i);
    PaymentTmp.PAYSUM     = PAY_SUM(i);
    PaymentTmp.PARENTID   = PARENT_ID(i);
    PaymentTmp.REFERENCE  = REFRENCE(i);

    stat = Insert(PaymentTmp);
    i = i +1;
  end;

  // Проверяем Значение флага процентов
  if (Rec.GetParmByName("AmountInterest").Val > 0)
      Registr = GetRegID("LoansKernel.GetUsRegID_ForObject", ContarctID, 1);
      Stavka  = GetRegID("LoansKernel.GetUsRateID_ForObject", ContarctID, 1);

      quary = "INSERT INTO DPERCPAY_TMP (T_ID, T_RATEID, T_BEGINDATE, T_REST, T_PERCSUM, "+
             " T_FIRSTID, T_OBJECTTYPEID, T_OBJECTNUMBER) "+
             " VALUES ("+Registr+","+Stavka+","+getSQLDate(Rec.GetParmByName("EndDate").Val)+", "
             +Rec.GetParmByName("AmountInterest").Val+","+ Rec.GetParmByName("AmountInterest").Val+","+
             Registr+","+ LO_CREDIT+","+ContarctID+")";

      stat = SQL_Execute(quary);

  END;


  OperationID = MakeOperation(ContarctID, LO_CREDIT, Rec.GetParmByName("TypeOfOperation").Val, Curency,
                              Rec.GetParmByName("Date").Val, 1);

  IF (OperationID == 0)
       NewID = 0;
       Comment = GetMO_LoansError();
       return 0;
  ELSE
       NewID = OperationID;
  END;

  return OperationID;
end;




////////////////////////////////////////////////////////////////////////////////////////////////////////////




macro LnsCreateOperation(RecordID:INTEGER, NewID:@STRING, Comment:@STRING):INTEGER
   var Rec, OperationType;
   var q, rsb;

   Rec = TGTrecord();
   Rec.LoadFromDB(RecordID);

   q = "SELECT T_SYSTTYPEOP_REF FROM DTYPE_OP_DBT "
       " WHERE T_TYPEOPERNUMBER  = "+Rec.GetParmByName("TypeOfOperation").Val;
   rsb = TRsbDataSet( q );

   IF( rsb.MoveNext() )
     OperationType = rsb.T_SYSTTYPEOP_REF;
   ELSE
     Comment = "Не удалось получить номер опрерции ";
     return 1;
   END;

   IF (OperationType == 2)
      IF (Выдача(Rec,@NewID,@Comment) == 0)
        return 1;
      END;
   END;

   IF (OperationType == 3)
      IF (Погашение(Rec,@NewID,@Comment) == 0)
        return 1;
      END;
   END;

   IF (OperationType == 11)
      IF (НачислениеПроцентов(Rec,@NewID,@Comment) == 0)
        return 1;
      END;
   END;


   IF (OperationType == 4)
      IF (Просрочка(Rec,@NewID,@Comment) == 0)
        return 1;
      END;
   END;


   return 0;
end;



////////////////////////////////////////////////////////////////////////////////////////////////////////////



macro LnsDelOperation(RecordID:INTEGER, CredOperID:INTEGER, Comment:@STRING):INTEGER
   if (DeleteOperation(CredOperID))
     return 0;
   end;
 return 1;
end;



////////////////////////////////////////////////////////////////////////////////////////////////////////////



macro LnsCreatePlanPay(RecordID:INTEGER, NewID:@STRING, Comment:@STRING):INTEGER

   var quary, stat;
   var Rec, OperationID;
   var ContarctID;

   Rec = TGTrecord();
   Rec.LoadFromDB(RecordID);


   ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val);

   if (ContarctID <= 0)
      Comment = string("Не найден Договор по ID:"+Rec.GetParmByName("FollowUpAccount").Val);
      NewID = 0;
   end;

   // LPS SCR 181300
   var rsdCmd = RSDCommand(RslDefCon, "BEGIN LoansOperation.RSI_MoveActualGPToArchive ( ?, ?, ? ); END;");
   rsdCmd.addParam("objectid_ref", RSDBP_IN);        rsdCmd.value("objectid_ref") = ContarctID;
   rsdCmd.addParam("objecttypeid_ref", RSDBP_IN);    rsdCmd.value("objecttypeid_ref") = LO_CREDIT;
   rsdCmd.addParam("ttype", RSDBP_IN);               rsdCmd.value("ttype") = 0;
   rsdCmd.execute();

   quary = "INSERT INTO DACTUAL_PLANPAY_DBT (T_OBJECTID_REF, T_OBJECTTYPEID_REF, T_CREDOPERID_REF, T_PLANNEDPAYDATE, T_PLANNEDEXPDATE, T_PLANNEDPAYSUM,  "+
           " T_PLANNEDPERCENTSUM, T_PLANNEDPAYSUMEX, T_TYPE, T_REZERV) VALUES ("+
           ContarctID+","+LO_CREDIT+", 0, "+getSQLDate(Rec.GetParmByName("Date").Val)+", "+getSQLDate(Rec.GetParmByName("Date").Val)+", "
           +Rec.GetParmByName("Capital").Val+", "+Rec.GetParmByName("Interest").Val+" ,0, 0, CHR(1))";

   SQL_Execute(quary);

   NewID = string(Rec.GetParmByName("Date").Val)+"_"+
           string(Rec.GetParmByName("Date").Val)+"_"+
           string(LO_CREDIT)+"_"+
           string(ContarctID);
   NewID = StrSubst(NewID, " ", "0");


   return 0;
end;

macro LnsAfterImportToRSB(SeanceID, SncLog, rsRecords)

var quary, stat;
var ContarctID,OperationID,Curency;
var rsb,rsbParm,Rec;
var PLANFIRSTDATE,PLANLASTDATE,PLANCOUNTPAY,SUM;

record Credit_C("credit_c.dbt");
record lgpayop("lgpayop.dbt");


    quary = "SELECT * FROM DGTRECORD_DBT, DGTSNCREC_DBT, DGTKOBJ_DBT, DGTOBJECT_DBT WHERE "
            " DGTRECORD_DBT.T_RECORDID           = DGTSNCREC_DBT.T_RECORDID "
            " AND DGTSNCREC_DBT.T_SEANCEID           = "+SeanceID+
            " AND DGTRECORD_DBT.T_STATUSID           = 3 "+ //3 - Уже обработан (так как это пост обработка) // Закоментить при проверке из макраса по шаблону сесиии
            " AND DGTRECORD_DBT.T_OBJECTID           = DGTOBJECT_DBT.T_OBJECTID "+
            " AND DGTRECORD_DBT.T_APPLICATIONID_FROM = "+APPLICATION_ID_PlanPay+ " "+
            " AND DGTRECORD_DBT.T_APPLICATIONID_TO   = "+APPLICATION_ID_Export+ " "+
            " AND DGTRECORD_DBT.T_ACTIONID           = 1 "+
            " AND DGTKOBJ_DBT.T_OBJECTKIND           = DGTOBJECT_DBT.T_OBJECTKIND ";

   rsb = TRsbDataSet( quary );

   if (rsb.movenext() == 0)
    return 0;
   end;

   Rec = TGTrecord();
   Rec.LoadFromDB(rsb.RECORDID);


   ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val,Credit_C);
   Curency = Credit_C.CURCODE;


    ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val);

    if (ContarctID <= 0)
        return 0;
    end;


   quary = "(SELECT MIN(T_PLANNEDPAYDATE) PLANFIRSTDATE FROM DPLANPAY_DBT WHERE  "
           "    T_OBJECTID_REF     = "+ContarctID+" "+
           " AND T_CREDOPERID_REF   = 0 "
           " AND T_OBJECTTYPEID_REF = "+LO_CREDIT+")";
   rsbParm = TRsbDataSet( quary );
   if (rsbParm.movenext())
       PLANFIRSTDATE = rsbParm.PLANFIRSTDATE;
   end;

   quary = "(SELECT MAX(T_PLANNEDPAYDATE) PLANLASTDATE FROM DPLANPAY_DBT WHERE  "
           "    T_OBJECTID_REF     = "+ContarctID+" "+
           " AND T_CREDOPERID_REF   = 0 "
           " AND T_OBJECTTYPEID_REF = "+LO_CREDIT+")";
   rsbParm = TRsbDataSet( quary );
   if (rsbParm.movenext())
       PLANLASTDATE = rsbParm.PLANLASTDATE;
   end;

    quary = "(SELECT COUNT(1) PLANCOUNTPAY FROM DPLANPAY_DBT WHERE  "
           "    T_OBJECTID_REF     = "+ContarctID+" "+
           " AND T_CREDOPERID_REF   = 0 "
           " AND T_OBJECTTYPEID_REF = "+LO_CREDIT+")";
   rsbParm = TRsbDataSet( quary );
   if (rsbParm.movenext())
       PLANCOUNTPAY = rsbParm.PLANCOUNTPAY;
   end;

    quary = "(SELECT SUM(T_PLANNEDPAYSUM) SUM FROM DPLANPAY_DBT WHERE  "
           "    T_OBJECTID_REF     = "+ContarctID+" "+
           " AND T_CREDOPERID_REF   = 0 "
           " AND T_OBJECTTYPEID_REF = "+LO_CREDIT+")";
   rsbParm = TRsbDataSet( quary );
   if (rsbParm.movenext())
       SUM = rsbParm.SUM;
   end;

   lgpayop.CREDOPERID_REF     = 0;
   lgpayop.PAY_PLANFIRSTDATE  = PLANFIRSTDATE;
   lgpayop.PAY_PLANLASTDATE   = PLANLASTDATE;
   lgpayop.PAY_PLANCOUNTPAY   = PLANCOUNTPAY;
   lgpayop.PAY_TYPEPERIOD     = 1;
   lgpayop.PAY_PERIOD         = 1;
   lgpayop.PAY_ARREARDATE     = 31;
   lgpayop.SUM                = SUM;
   lgpayop.TYPE               = 0;

   lgpayop.PERC_PLANFIRSTDATE  = PLANFIRSTDATE;
   lgpayop.PERC_PLANLASTDATE   = PLANLASTDATE;
   lgpayop.PERC_PLANCOUNTPAY   = PLANCOUNTPAY;
   lgpayop.PERC_TYPEPERIOD     = 1;
   lgpayop.PERC_PERIOD         = 1;
   lgpayop.PERC_ARREARDATE     = 31;

   OperationID = MakeOperation(ContarctID, LO_CREDIT, CF_RECALCGPAY, Curency, {curdate}, lgpayop, 0, 1);
   IF (OperationID == 0)
       return 1;
   ELSE
       return 0;
   END;

return 0;

end;



////////////////////////////////////////////////////////////////////////////////////////////////////////////



macro LnsCreateRate(RecordID:INTEGER, NewID:@STRING, Comment:@STRING):INTEGER
   var q, rsb;
   var Rate = TArray(0), Alg = TArray(0);
   var Rec, OperationID,Curency;
   var New;
   var ContarctID;

   record Credit_C("credit_c.dbt");

   Rec = TGTrecord();
   Rec.LoadFromDB(RecordID);

   Rate(Rate.size) = CF_OPEN;
   Rate(Rate.size) = 1;
   Rate(Rate.size) = Rec.GetParmByName("Date").Val;
   Rate(Rate.size) = string(Rec.GetParmByName("RateValue").Val);


   ContarctID = LnsFindCrdByFollowUpAccount(Rec.GetParmByName("FollowUpAccount").Val,Credit_C);
   Curency = Credit_C.CURCODE;


   // ОПЕРаЦИЯ ИЗМЕНЕНИЯ ПРОЦЕНТНОЙ СТаВКИ
   OperationID = MakeOperation(ContarctID, LO_CREDIT, CF_RATE, Curency, Rec.GetParmByName("Date").Val, Rate, 1);
   IF (OperationID == 0)
        NewID = 0;
        Comment = GetMO_LoansError();
        return 1;
   ELSE
        NewID = OperationID;
   END;

   // Проверяем совподает ли алгоритм расчета процентов с переданным (записи может и не быть)
   q    = "SELECT T_CALENDAR, T_TYPEREST FROM DLCALGHIS_DBT h, DLCUSALG_DBT ua "+
          " WHERE  ua.T_TYPEALGID_REF = 1 AND  h.T_ALGID_REF = ua.T_ALGID_REF AND "+
          " ua.T_CREDOBJID_REF = " +ContarctID+" AND ua.T_OBJECTID_REF  = "+LO_CREDIT+" AND "+
          " h.T_ALGDATE = (SELECT MAX (m.T_ALGDATE) FROM DLCALGHIS_DBT m WHERE "+
                         " m.T_ALGDATE  <= "+getSQLDate(Rec.GetParmByName("Date").Val)+
                         " AND m.T_ALGID_REF = h.T_ALGID_REF) ";

    rsb = TRsbDataSet( q );


   IF( rsb.MoveNext() )
      if (rsb.T_CALENDAR == Rec.GetParmByName("Calendar").Val)
        // Календари сходтся выходим
        return 0;
      END;
   END;
/*
   SCR 191469: PDS  данный макрос не соответствует новому механизму тарифов. Требуется переписать. По указанию РГ данный фрагмент закомменчен
   // Не совпадает! Проводим также операцию изменения алгоритма
   Alg(Alg.Size) = CF_OPEN;
   Alg(Alg.Size) = Rec.GetParmByName("Date").Val;
   Alg(Alg.Size) = Rec.GetParmByName("TypeRest").Val;
   Alg(Alg.Size) = Rec.GetParmByName("Calendar").Val;

   OperationID = MakeOperation(ContarctID, LO_CREDIT, CF_ALG, Curency, Rec.GetParmByName("Date").Val, Alg, 1);

   IF (OperationID == 0)
        NewID = 0;
        Comment = GetMO_LoansError();
        return 1;
   END;
*/

   return 0;
end;



////////////////////////////////////////////////////////////////////////////////////////////////////////////
