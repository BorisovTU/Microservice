/*
$Name:        GTDVnDeal.mac
$Module:      Шлюз Securities
$Description: Загрузка внебиржевой сделки и сделки Т+3 в ПИ
*/

import RSD, FIInter, DealsInter, DVInter, rgtgtlog, "rgtgtrec.mac", "gtdlfun.mac", "rgobj.mac", "dldlngfun.mac";
                                                                                             
PRIVATE CONST UnknownParty = -1;
PRIVATE CONST MMVB_CODE = "ММВБ";    /* код ММВБ */

PRIVATE VAR ErrorText = "";
PRIVATE MACRO SetError( _ErrorText )
  ErrorText = _ErrorText;
  RunError( ErrorText );
END;

PRIVATE MACRO SetWarning( Comment:@STRING, WarningText:String )
  Comment = WarningText; 
  return -1;
END;

private macro GetDateStr(date_val)
   var day,month,year;

   DateSplit(date_val,day,month,year);

   return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,4);
end;

/* Аналог оператора ?: в си. */
private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
end;

/*конвертация сумм в разных валютах с обработкой ошибок */
private macro SmartConvertSum( sumTo, sumFrom, sinceDate, fiidFrom, fiidTo, SayError ):BOOL
  VAR NewSum = $0, SumConv = $0;
  if( fiidFrom == fiidTo )  NewSum = sumFrom;
  elif( ConvSum( NewSum, sumFrom, sinceDate, fiidFrom, fiidTo ) != 0 )
    /* IL 27.08.02 может быть есть кросс-курс*/
    if( ConvSumCross( NewSum, sumFrom, sinceDate, fiidFrom, fiidTo ) != true ) 
       InitError();
       return false;
    end;
  end;
  SetParm( 0, NewSum );
  return true;
end;

/* оставить 2 знака */
private macro MakeMoney( Summa:STRING )
   return Round(money(double(Summa)), 2);
end;

private macro GT_GenerateFixingReference():String
  var RefID;
  const REFOBJ_OVERVAL_DV = 1;
  var RefNum;
  if( GetReferenceIDByType( OBJTYPE_OVERVAL_DV, REFOBJ_OVERVAL_DV, RefID) )
    return "";
  end;
  if (GenerateReference( RefID, RefNum ) )
      return "";
  end;                                                                                                
  return RefNum;
end;

/*загружаем расчеты по ПФИ внебиржевой сделки*/
macro _DVnDealCalc_CreateNew( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING, DvnDealID :INTEGER ):INTEGER

  record fininstr(fininstr);
  var CalcOp = TRecHandler("dvnacdl");
  var dvndeal = TRecHandler("dvndeal.dbt");
  var koper    = TBFile( "oprkoper", "R", 0 );
  var ExtCode:string = "", Kind:integer = 0, vDate:date = date(0,0,0), MARGIN:money = $0.0, 
      OperName:string = "", type;
  var Sql, DataSql;
  var RG, ErrMsg = "";
  var PayKind, PayCurr;

  RG = TGTRecord();
  RG.LoadFromDB(RecordID);

  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;

  VAR SourceID = RG.GetSourceID();

  if( RG.LoadFromDB( RecordID ) != true )
     Comment = "Ошибка при загрузке параметров внебиржевой сделки ПИ из шлюза." + RG.GetLastError();
     return 1;
  end;

  if( (GetParmByName( RG, "RGDVNDL_EXTCODE", @ExtCode, @type ) == NULL) OR (type != V_STRING) )
     SetError( "Не найден либо неверно задан внешний код сделки (параметр RGDVNDL_EXTCODE " + " объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG,"RGDVNDL_KIND", @Kind, @type)  == NULL) OR (type != V_INTEGER) )
     SetError( "Не найден либо неверно задан вид сделки (параметр RGDVNDL_KIND " + " объекта " + String(RecordID) + ")");
  else
     koper.Clear();
     koper.rec.Kind_Operation = Kind;

     if( koper.GetEQ() )
        if( (koper.rec.DocKind != DL_DVNDEAL) and (koper.rec.DocKind != DL_DVDEALT3) )
           SetError( "Операция " +  string(Kind) + " не является сделкой ФИССиКО." );
        end;
        OperName = koper.rec.Name;
     else
        SetError( "Не найден вид операции " + string(Kind) + " (параметр " + "RGDVNDL_KIND" + " объекта " + String(RecordID) + ")");
     end;
  end;

  if( (GetParmByName( RG, "RGDVNDL_DATE", @vDate, @type ) == NULL) OR (type != V_DATE) )
     SetError( "Не найдена либо неверно задана дата (параметр RGDVNDL_DATE объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG,"RGDVNDL_MARGIN", @MARGIN, @type)  == NULL) OR (type != V_MONEY) OR (MARGIN == $0.0) )
     SetError( "Не найдена либо неверно задана сумма вар. маржи по сделке (параметр " + "RGDVNDL_MARGIN" + " объекта " + String(RecordID) + ")");
  end;
                                    
  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
    
    Sql = RSDCommand(" select deal.* " +
                     "   from ddvndeal_dbt deal, dnotetext_dbt note " +
                     "  where deal.t_Kind = ? " +
                     "    and LPAD(deal.t_ID, 34, '0') = note.t_DocumentID " +
                     "    and note.t_Objecttype = ? " +
                     "    and note.t_NoteKind = ? " +
                     "    and trim(replace(rsb_struct.getString(note.t_Text),CHR(0),'')) = ? " +
                     "    and deal.t_State != ? "
                    );
    
    sql.addParam( "", RSDBP_IN, Kind );
    sql.addParam( "", RSDBP_IN, OBJTYPE_OUTOPER_DV );
    sql.addParam( "", RSDBP_IN, NOTEKIND_DVNDEAL_CUX23CODE );
    sql.addParam( "", RSDBP_IN, ExtCode );
    sql.addParam( "", RSDBP_IN, DVDEAL_CLOSE);
    
    sql.execute();
    
    DataSql = TRsbDataSet( sql );
    
    if( DataSql.MoveNext() )
       DataSql.GetRecord().CopyTo( dvndeal.rec );
    else
       SetError( "В ФИССиКО не найдена сделка вида \""+OperName+"\" со значением примечания \"Номер операции по CUX23\", равным \""+ExtCode+"\", объекта " + String(RecordID));
    end;
    
  else/*GT_SPFI*/
    /*ищем сделку по внешнему коду*/
    Sql = RSDCommand(" select deal.* " +
                     "   from ddvndeal_dbt deal " +
                     "  where deal.t_Kind = ? " +
                     "    and deal.t_DocKind = ? " +
                     "    and deal.t_ExtCode = ? " +
                     "    and deal.t_State != ? " +
                     "    and deal.t_MarketKind = 3 "
                    );
    
    sql.addParam( "", RSDBP_IN, Kind );
    sql.addParam( "", RSDBP_IN, DL_DVNDEAL );
    sql.addParam( "", RSDBP_IN, ExtCode );
    sql.addParam( "", RSDBP_IN, DVDEAL_CLOSE);
    
    sql.execute();
    
    DataSql = TRsbDataSet( sql );
    
    if( DataSql.MoveNext() )
       DataSql.GetRecord().CopyTo( dvndeal.rec );
    else
       SetError( "В ФИССиКО не найдена сделка вида \""+OperName+"\" с внешним кодом, равным \""+ExtCode+"\", объекта " + String(RecordID));
    end;

  end;

  /* Вид выплаты может быть задан */
  if( SourceID != GT_SPFI )
    PayKind = DV_CALCOP_PAYKIND_MARGIN;
  else
    if( (GetParmByName( RG,"RGDVNDL_PAYKIND", @PayKind, @type)  == NULL) OR (type != V_INTEGER) )
      SetError( "Не найден либо неверно задан вид операции расчёта (параметр RGDVNDL_PAYKIND " + " объекта " + String(RecordID) + ")");
    end;
  end;
  
  CalcOp.Clear();
  CalcOp.rec.ID      = 0;
  CalcOp.rec.DealID  = dvndeal.rec.ID;
  CalcOp.rec.Date    = vDate;
  CalcOp.rec.Sum     = CalcOp.rec.PaySum = abs(MARGIN);
  if( SourceID == GT_SPFI )
     if( (GetParmByName( RG, "RGDVNDL_CURRENCY", @PayCurr, @type )  == NULL) OR (type != V_STRING) OR (PayCurr == "") )
        CalcOp.rec.AccFIID = NATCUR;
     else
        var ErrMes = "";
        if( GetRealID( RG_CURRENCY, PayCurr, FICK_MICEX, @CalcOp.rec.AccFIID, @ErrMes ) != 0 )
           SetError( ErrMes );
        end;
        if(ПолучитьФинИн( CalcOp.rec.AccFIID, fininstr))
           SetError( "Не найден финансовый инструмент " + string(CalcOp.rec.AccFIID) + ", заданный в параметре " + "RGDVNDL_PRICEFIID" + " объекта " + String(RecordID) );
        end;
     end;
  else
     CalcOp.rec.AccFIID = NATCUR;
  end;
  CalcOp.rec.PayKind = PayKind;

  if( MARGIN < $0 )
     CalcOp.rec.Direction = DV_CALCOP_DIRECTION_PAYMENT;
  else
     CalcOp.rec.Direction = DV_CALCOP_DIRECTION_RECEPTION;
  end;
  
  var PayKindStr = "";

  if( PayKind == DV_CALCOP_PAYKIND_GUARANT_MARGIN )
     PayKindStr = "вида SCFDM ";
  elif( PayKind == DV_CALCOP_PAYKIND_MARGIN_INTEREST )
     PayKindStr = "вида PRC_NM ";
  elif( PayKind == DV_CALCOP_PAYKIND_EXECUTION )
     PayKindStr = "вида NDF0 ";
  elif( PayKind == DV_CALCOP_PAYKIND_MARGIN )
     if(dvndeal.rec.DvKind == 1)
		PayKindStr = "вида NDF0 ";
     else
		PayKindStr = "вида SCFVM ";
	 end;
  end;
  
  //вставка шага расчётной операции
  if( DV_InsertStepCalcOp(CalcOp) != 0 )
     SetError( "Ошибка при вставке записи расчётов " + PayKindStr + "по ПФИ сделки с кодом \""+dvndeal.rec.Code+"\" объекта " + String(RecordID)+". "+GetErrMsg());
  end;

  ID  = string( CalcOp.rec.DealID );
  Comment = "В ФИССиКО загружена запись расчетов " + PayKindStr + " по ПФИ для сделки вида "+OperName+" с внешним кодом \"" + dvndeal.rec.ExtCode + "\".";

  return 0;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = ErrorText;
   else
      Comment = RslErrObj.Message;
   end;
   return 1;
end;

/* макрос импорта графиков */
macro _DVnDealPmGr_CreateNew( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING, DvnDealID :INTEGER):INTEGER
  var dvnpmg = TRecHandler( "dvnpmgr" );
  var RG;
  var extCode: string, OperName:string = "", StrTempParm = "";
  var type, stat;
  var Sql, DataSql;
  var ImpDate:date = date(0,0,0);
  var PmGrID:integer = 0;
  
  dvnpmg.Clear();
  RG = TGTRecord();
  RG.LoadFromDB(RecordID);
  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;
  
  if( (GetParmByName( RG,"RGPMGR_EXTCODE_DEAL", @extCode, @type)  == NULL) OR (type != V_STRING) )
    SetError( "Не найден либо неверно задан внешний код сделки (параметр " + "RGPMGR_EXTCODE_DEAL" + " объекта " + String(RecordID) + ")" );
  end;

  /*ищем сделку по внешнему коду*/
  Sql = RSDCommand(" select deal.* " +
                   "   from ddvndeal_dbt deal " +
                   "  where deal.t_DvKind = ? " +
                   "    and deal.t_DocKind = ? " +
                   "    and deal.t_ExtCode = ? " +
                   "    and deal.t_State != ? "
                  );
  
  sql.addParam( "", RSDBP_IN, DV_PCTSWAP );
  sql.addParam( "", RSDBP_IN, DL_DVNDEAL );
  sql.addParam( "", RSDBP_IN, ExtCode );
  sql.addParam( "", RSDBP_IN, DVDEAL_CLOSE);
  
  sql.execute();
  
  DataSql = TRsbDataSet( sql );
  
  if( DataSql.MoveNext() )
     dvnpmg.rec.DealID = DataSql.ID;                    
  else
     SetError( "В ФИССиКО не найдена сделка вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" объекта " + String(RecordID));
  end;

  if ( ( GetParmByName( RG, "RGPMGR_SIDE",    @StrTempParm,    @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") OR (StrTempParm == "") )
    SetError( "Не найден либо неверно задана сторона строки графика платежей (параметр " + "RGPMGR_SIDE" + " объекта " + String(RecordID) + ")" );
  else
    if(StrTempParm == "Т")
       dvnpmg.rec.Side = 2;
    else
       dvnpmg.rec.Side = 1;
    end;
  end;

  if ( ( GetParmByName( RG, "RGPMGR_PAYMENTSUM", @dvnpmg.rec.PaymentSum, @type ) == NULL) OR (type != V_DOUBLE) or (dvnpmg.rec.PaymentSum == 0.0) ) 
    SetError( "Не найден либо неверно задан параметр " + "RGPMGR_PAYMENTSUM" + " объекта " + String(RecordID) + "" );
  end;

  if( dvnpmg.rec.Side == 2 )
     dvnpmg.rec.DemandSum  =  dvnpmg.rec.PaymentSum;
     dvnpmg.rec.LiabilitySum = 0;
  else
     dvnpmg.rec.DemandSum  =  0;
     dvnpmg.rec.LiabilitySum = dvnpmg.rec.PaymentSum;
  end;

  if ( ( GetParmByName( RG, "RGPMGR_BEGDATE", @dvnpmg.rec.BegDate, @type ) == NULL) OR (type != V_DATE) )
    SetError( "Не найден либо неверно задана Дата нач. начисления (параметр " + "RGPMGR_BEGDATE" + " объекта " + String(RecordID) + ")" );
  end;
  
  if ( ( GetParmByName( RG, "RGPMGR_ENDDATE", @dvnpmg.rec.EndDate, @type ) == NULL) OR (type != V_DATE) )
    SetError( "Не найден либо неверно задана Дата окончания начисления (параметр " + "RGPMGR_ENDDATE" + " объекта " + String(RecordID) + ")" );
  end;  
  
  if ( ( GetParmByName( RG, "RGPMGR_PAYDATE", @dvnpmg.rec.PayDate, @type ) == NULL) OR (type != V_DATE) )
    SetError( "Не найден либо неверно задана Дата окончания начисления (параметр " + "RGPMGR_PAYDATE" + " объекта " + String(RecordID) + ")" );
  end;
  
  if ( ( GetParmByName( RG, "RGPMGR_FIXDATE", @dvnpmg.rec.FixDate, @type ) == NULL) OR (type != V_DATE) )
    SetError( "Не найден либо неверно задано Дата фиксации (параметр " + "RGPMGR_FIXDATE" + " объекта " + String(RecordID) + ")" );
  end;    
  
  dvnpmg.rec.TransferDate = dvnpmg.rec.PayDate;

  if ( ( GetParmByName( RG, "RGPMGR_FLOATRATEVALUE", @dvnpmg.rec.FloatRateValue, @type ) == NULL) OR (type != V_DOUBLE) )
//     SetError( "Не найден либо неверно задана плавающая ставка (параметр " + "RGPMGR_FLOATRATEVALUE" + " объекта " + String(RecordID) + ")" );
  end;
  PmGrID = DL_GetDVnPmgrID(dvnpmg.rec.DealID, dvnpmg.rec.Side, dvnpmg.rec.BegDate, dvnpmg.rec.EndDate, dvnpmg.rec.PayDate);
  if( PmGrID == -1)
     stat = DV_InsertNPmGr(dvnpmg);
     if( stat != 0 )
        SetError("Ошибка строки графика платежей.\n"+GetErrMsg());
     end;
  
     ID  = string( dvnpmg.rec.ID );
     Comment = Comment + "В ФИССиКО для сделки вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" создана строка графика с датой начала "+string(dvnpmg.rec.BegDate)+". ID строки = " + dvnpmg.rec.ID + ".\n";
  elif (dvnpmg.rec.FloatRateValue != 0)

     if ( ( GetParmByName( RG, "RGPMGR_IMPORTDATE", @ImpDate, @type ) == NULL) OR (type != V_DATE) )
        SetError( "Не найдена либо неверно задана дата импорта плавающей ставки (параметр " + "RGPMGR_IMPORTDATE" + " объекта " + String(RecordID) + ")" );
     end;

     /*ищем запись о платеже*/
     Sql = RSDCommand(" select pmgrgt.t_id " +
                      "   from  ddvnpmgrgt_dbt pmgrgt " +
                      "  where pmgrgt.t_dealcode = ? " +
                      "    and pmgrgt.t_side = ? " +
                      "    and pmgrgt.t_impdate = ? " +
                      "    and pmgrgt.t_begdate = ? " +
                      "    and pmgrgt.t_enddate = ? " +
                      "    and pmgrgt.t_paydate = ? "
                     );
  
     sql.addParam( "", RSDBP_IN, extCode );
     sql.addParam( "", RSDBP_IN, dvnpmg.rec.Side );
     sql.addParam( "", RSDBP_IN, ImpDate);
     sql.addParam( "", RSDBP_IN, dvnpmg.rec.BegDate);
     sql.addParam( "", RSDBP_IN, dvnpmg.rec.EndDate);
     sql.addParam( "", RSDBP_IN, dvnpmg.rec.PayDate);
  
     sql.execute();
     DataSql = TRsbDataSet( sql );
  
     if( DataSql.MoveNext() )
        VAR upd = RSDCommand("UPDATE ddvnpmgrgt_dbt SET t_floatratevalue = ?, t_paymentsum = ?, t_imported = chr(0) WHERE t_id = ?");
        upd.addParam( "", RSDBP_IN, dvnpmg.rec.FloatRateValue);
        upd.addParam( "", RSDBP_IN, dvnpmg.rec.PaymentSum);
        upd.addParam( "", RSDBP_IN, DataSql.ID);
        upd.execute();
        stat = 0;
        ID = string(PmGrID);
        Comment = Comment + "В ФИССиКО для сделки вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" обновлена информация за дату " +string(ImpDate) +" по платежу с датой начала "+string(dvnpmg.rec.BegDate) + ".\n";                    
     else
        VAR ins = RSDCommand("INSERT INTO ddvnpmgrgt_dbt (t_dealcode, t_side, t_impdate, t_begdate, t_enddate, t_paydate, t_floatratevalue, t_paymentsum, t_imported) VALUES (?,?,?,?,?,?,?,?,chr(0))");
        ins.addParam( "", RSDBP_IN, extCode);
        ins.addParam( "", RSDBP_IN, dvnpmg.rec.Side );
        ins.addParam( "", RSDBP_IN, ImpDate);
        ins.addParam( "", RSDBP_IN, dvnpmg.rec.BegDate );
        ins.addParam( "", RSDBP_IN, dvnpmg.rec.EndDate);
        ins.addParam( "", RSDBP_IN, dvnpmg.rec.PayDate);
        ins.addParam( "", RSDBP_IN, dvnpmg.rec.FloatRateValue);
        ins.addParam( "", RSDBP_IN, dvnpmg.rec.PaymentSum);
        ins.execute();
        stat = 0;
        ID = string(PmGrID); 
        Comment = Comment + "В ФИССиКО для сделки вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" загружена информация за дату " +string(ImpDate) +" по платежу с датой начала "+string(dvnpmg.rec.BegDate) + ".\n";                    
     end;
  else
     stat = 0;
     ID = string(PmGrID); 
     Comment = Comment + "В ФИССиКО для сделки вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" уже создана строка графика с датой начала "+string(dvnpmg.rec.BegDate) + ".\n";
  end;
  
  return stat;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = Comment + "\n" + ErrorText;
   else
      Comment = Comment + "\n" + RslErrObj.Message;
   end;
   return 1;
  
end;

/* макрос импорта операции фиксинг */
macro _DVnDealFixPmGr_CreateNew( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING, DvnDealID :INTEGER):INTEGER
  var dvoper = TRecHandler( "dvoper" );
  record fininstr(fininstr);  
  var RG;
  var extCode: string = "", OperName:string = "", StrTempParm:string = "", PayCurr:string = "";
  var type, stat = 0;
  var Sql, DataSql;
  dvoper.Clear();
  RG = TGTRecord();
  RG.LoadFromDB(RecordID);
  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;
  
  if( (GetParmByName( RG,"RGFIXPMGR_EXTCODE_DEAL", @extCode, @type)  == NULL) OR (type != V_STRING) )
    SetError( "Не найден либо неверно задан внешний код сделки (параметр " + "RGFIXPMGR_EXTCODE_DEAL" + " объекта " + String(RecordID) + ")" );
  end;

  /*ищем сделку по внешнему коду*/
  Sql = RSDCommand(" select deal.* " +
                   "   from ddvndeal_dbt deal " +
                   "  where deal.t_DvKind = ? " +
                   "    and deal.t_DocKind = ? " +
                   "    and deal.t_ExtCode = ? " +
                   "    and deal.t_State != ? "
                  );
  
  sql.addParam( "", RSDBP_IN, DV_PCTSWAP );
  sql.addParam( "", RSDBP_IN, DL_DVNDEAL );
  sql.addParam( "", RSDBP_IN, extCode );
  sql.addParam( "", RSDBP_IN, DVDEAL_CLOSE);
  
  sql.execute();
  
  DataSql = TRsbDataSet( sql );
  
  if( DataSql.MoveNext() )
     dvoper.rec.DealID = DataSql.ID;                    
  else
     SetError( "В ФИССиКО не найдена сделка вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" объекта " + String(RecordID));
  end;

  if ( ( GetParmByName( RG, "RGFIXPMGR_SIDE",    @StrTempParm,    @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") OR (StrTempParm == "") )
    SetError( "Не найден либо неверно задана сторона строки графика платежей (параметр " + "RGFIXPMGR_SIDE" + " объекта " + String(RecordID) + ")" );
  else
    if(StrTempParm == "Т")
       dvoper.rec.dvkind = 2;
    else
       dvoper.rec.dvkind = 1;
    end;
  end;

  if ( ( GetParmByName( RG, "RGFIXPMGR_PAYMENTSUM", @dvoper.rec.Summ, @type ) == NULL) OR (type != V_DOUBLE) or (dvoper.rec.Summ == 0.0) ) 
    SetError( "Не найден либо неверно задан параметр " + "RGFIXPMGR_PAYMENTSUM" + " объекта " + String(RecordID) + "" );
  end;
  
  if( (GetParmByName( RG, "RGFIXPMGR_PAYMENTCURRENCY", @PayCurr, @type )  == NULL) OR (type != V_STRING) OR (PayCurr == "") )
     dvoper.rec.FIID = NATCUR;
  else
     var ErrMes = "";
     if( GetRealID( RG_CURRENCY, PayCurr, FICK_MICEX, @dvoper.rec.FIID, @ErrMes ) != 0 )
        SetError( ErrMes );
     end;
     if(ПолучитьФинИн( dvoper.rec.FIID, fininstr))
        SetError( "Не найден финансовый инструмент " + string(PayCurr) + ", заданный в параметре " + "RGFIXPMGR_PAYMENTCURRENCY" + " объекта " + String(RecordID) );
     end;
  end;
  
  if ( ( GetParmByName( RG, "RGFIXPMGR_FIXDATE", @dvoper.rec.Date, @type ) == NULL) OR (type != V_DATE) )
    SetError( "Не найден либо неверно задано Дата фиксации (параметр " + "RGFIXPMGR_FIXDATE" + " объекта " + String(RecordID) + ")" );
  end;    
  

  if ( ( GetParmByName( RG, "RGFIXPMGR_FLOATRATEVALUE", @dvoper.rec.Rate, @type ) == NULL) OR (type != V_DOUBLE) )
     SetError( "Не найден либо неверно задана плавающая ставка (параметр " + "RGFIXPMGR_FLOATRATEVALUE" + " объекта " + String(RecordID) + ")" );
  end;

  dvoper.rec.Code       = GT_GenerateFixingReference();
  dvoper.rec.Oper       = {oper};
  dvoper.rec.Department = {OperDprt};
  dvoper.rec.DocKind    = DL_DVOPER_FIXING;
  dvoper.rec.FormReport = SET_CHAR;
  dvoper.rec.Flag1      = DV_KIND_OVERVALUE_CHANGE;
  dvoper.rec.Flag3      = SET_CHAR;


  stat = DV_InsertNFixPmGr(dvoper);
  
  if( stat != 0 )
     SetError("Ошибка вставки операции фиксинга.\n"+GetErrMsg());
  end;

  ID  = string( dvoper.rec.ID );
  Comment = Comment + "В ФИССиКО для сделки вида \"Процентный своп\" с внешним кодом \""+ExtCode+"\" создана операция фиксинга с датой "+string(dvoper.rec.Date)+". ID = " + ID + ".\n";

  return stat;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = Comment + "\n" + ErrorText;
   else
      Comment = Comment + "\n" + RslErrObj.Message;
   end;
   return 1;
  
end;

/* макрос импорта внебиржевой сделки */
macro _DVnDeal_CreateNew( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING, SncLog:@TGtLog):INTEGER

  record Party(party);
  record sfcontr(sfcontr);
  record fininstr(fininstr);
  var dvndeal = TRecHandler( "dvndeal.dbt" );
  var dvnfi   = TRecHandler( "dvnfi.dbt" );
  var koper    = TBFile( "oprkoper", "R", 0 );
  var dvnfi_2 = null;
  var spgrdoc = TRecHandler("spgrdoc.dbt");
  var request = TRecHandler("dl_req.dbt");
  var RG;
  var BuySell, type, BaseFIID, stat = 0;
  var StrTempParm:string = "";
  VAR ErrMes:string;
  var DealCode:string = "", ContractorContrID, ComisContrID;
  var KindObj:integer = -1, Nominal = 0, DealSum = 0.0;
  var ArrComSums = TArray();/*список комиссиий*/
  var ArrPmGr    = TArray();/*список строк графика*/
  var CUX23Code:string = "";
  var Код_ФинИн;
  var Код_Субъекта;
  var FromReuters = false, FromOutSystem = false, FromSPFI = false;
  var ClntRep = TRecHandler("spground.dbt");
  var ServKind = -1;
  var ExtBuff = TRecHandler("dl_extsettlecode.dbt"); 
  var Analytics = TRecHandler("dl_extscanalytics.dbt");
  var ExtCode = "", IsExchangeSPFI = "";
  var ClientCode:string = ""; 
  var dealId:integer = 0;
  var clientId:integer = 0;
  var dealDate:date = Date();
  var MsgArr = TArray();
  var LimitsCheckDate:date = Date();
  var ClientCodeForMsg:string = "<ошибка>";
  var dealExtCode:string = "";
  var ExchangeTypeStr:string = "внебиржевая";
  var trader_code:string = "";
  var IsMarginCall:bool = false;
  var RelPartyRef:string="";
  var cmd, DataSet;

  dvndeal.Clear();
  dvnfi.Clear();
  ClntRep.Clear();
  spgrdoc.Clear();

  RG = TGTRecord();
  RG.LoadFromDB(RecordID);
  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;

  VAR SourceID = RG.GetSourceID();

  if( RG.LoadFromDB( RecordID ) != true )
     Comment = "Ошибка при загрузке параметров внебиржевой сделки ФИССиКО из шлюза." + RG.GetLastError();
     return 1;
  end;

  FromReuters = ( (SourceID == GT_REUTDV) or (SourceID == GT_REUTDV_NEW) );
  FromOutSystem = ( (SourceID == GT_FRX_BLB) or (SourceID == GT_FRX_ALPHA) );
  FromSPFI = (SourceID == GT_SPFI); 

  if( FromReuters )
     Код_ФинИн    = FICK_ISOSTRING;
     Код_Субъекта = PTCK_REUTER;
  elif( FromOutSystem )
     Код_ФинИн    = 17/*FICK_EXTC*/;/*Код во внешней системе*/
     Код_Субъекта = 38;/*Код во внешней системе*/
  else
     Код_ФинИн    = FICK_MICEX;
     Код_Субъекта = PTCK_MICEX;
  end;
  
   if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) )
     if( (GetParmByName( RG, "RGDV_PROGNOS", @StrTempParm, @type ) == NULL) OR (type != V_STRING) )
     else
         if(StrTempParm == "D")
            // найти и удалить сделку с CODE из RGDVNDL_CODE
            if( (GetParmByName( RG, "RGDVNDL_CODE", @DealCode, @type ) == NULL) OR (type != V_STRING) or (DealCode=="") )
               SetError( "Не найден либо неверно задан номер сделки для удаления (параметр RGDVNDL_CODE " + " объекта " + String(RecordID) + ")");
            end;
            //Delete deal here
            RG_GetIDForDealcode(dealcode, @dealId, @clientId, @dealDate, @dealExtCode);
            LimitsCheckDate = dealDate;
            if(clientId != -1)
               ClientCodeForMsg = RGDLFUN_GetMMVBCODE_ByClientID( clientId, PTSK_CM, dealDate, dealcode);
            end;
            stat = DV_DeleteNDeal(DealCode);
            if(stat != 0)
               SetError("Ошибка при удалении сделки с номером " + DealCode + ". " + GetErrMsg());
            end;
            if((clientId != -1) and RG_CheckLimitsMMVBCurr_AfterDate( LimitsCheckDate))
               RG_AddLimitMsg(ClientCodeForMsg, MsgArr);
            end;
            if(clientId != -1)
               Comment = "Внимание! Удалена сделка " + dealExtCode + " клиента " + ClientCodeForMsg + ", которая не подтвердилась биржевым файлом.";
            else
               Comment = "Внимание! Удалена сделка " + dealExtCode + ", которая не подтвердилась биржевым файлом.";
            end;
            if(MsgArr.Size > 0)
                  Comment = Comment + RG_DumpMsgStr(MsgArr);
            end;
            ID = "Delete_DVNDeal_" + string( dealId );
            return 0;
         end;
     end;
   end;

  if( (GetParmByName( RG,"RGDVNDL_KIND", @dvndeal.rec.Kind, @type)  == NULL) OR (type != V_INTEGER) )
     SetError( "Не найден либо неверно задан вид операции (параметр " + "RGDVNDL_KIND" + " объекта " + String(RecordID) + ")" );
  else

     if( dvndeal.rec.Kind == СВОП_T3 )/*меняем вид, т.к. теперь валютный своп ПФИ и не ПФИ принадлежит одной операции ВалютныйСВОП*/
        dvndeal.rec.Kind = ВалютныйСВОП;
        dvndeal.rec.IsPFI = SET_CHAR;
     elif( dvndeal.rec.Kind == ПокупкаПродажаT3 )
        dvndeal.rec.IsPFI = SET_CHAR;
     else
        dvndeal.rec.IsPFI = SET_CHAR;
     end;

     koper.Clear();
     koper.rec.Kind_Operation = dvndeal.rec.Kind;

     if( koper.GetEQ() )
        if( (koper.rec.DocKind != DL_DVNDEAL) and (koper.rec.DocKind != DL_DVDEALT3) )
           SetError( "Операция " +  string(dvndeal.rec.Kind) + " не является сделкой ФИССиКО." );
        end;
        dvndeal.rec.DocKind = koper.rec.DocKind;
     else
        SetError( "Не найден вид операции " + string(dvndeal.rec.Kind) + " (параметр " + "RGDVNDL_KIND" + " объекта " + String(RecordID) + ")");
     end;
  end;

  if( (dvndeal.rec.Kind != ВалютныйСВОП) and (dvndeal.rec.Kind != ПокупкаПродажаT3) and (dvndeal.rec.Kind != ВнебиржФорвард) and (dvndeal.rec.Kind != ПроцентныйСВОП) )
     SetError("Неверно задан вид операции " + string(dvndeal.rec.Kind) + " (параметр " + "RGDVNDL_KIND" + " объекта " + String(RecordID) + ").\n"+
              "В БОПИ загружаются операции вида " + string(ВалютныйСВОП)+ "," + string(ПроцентныйСВОП) + "," + string(ПокупкаПродажаT3) + "," + string(ВнебиржФорвард) );
  end;

  if( dvndeal.rec.Kind == ПокупкаПродажаT3 )
     dvndeal.rec.DVKind = DV_FORWARD_T3;
     if( (SourceID == GT_MMVB3) OR (SourceID == GT_PAYMENTS) )
        KindObj = RG_AVOIRISS;
     else
        KindObj = RG_CURRENCY;/*реально вид БА может быть RG_CURRENCY или RG_METAL, но здесь достаточно RG_CURRENCY и это не мешает правильно опрелелить реальный FIID*/
     end;
  elif( dvndeal.rec.Kind == ВалютныйСВОП )
     dvndeal.rec.DVKind = DV_CURSWAP;
     KindObj = RG_CURRENCY;/*реально вид БА может быть RG_CURRENCY или RG_METAL, но здесь достаточно RG_CURRENCY и это не мешает правильно опрелелить реальный FIID*/
  elif( dvndeal.rec.Kind == ВнебиржФорвард )
     dvndeal.rec.DVKind = DV_FORWARD;
     KindObj = RG_CURRENCY;/*реально вид БА может быть RG_CURRENCY или RG_METAL, но здесь достаточно RG_CURRENCY и это не мешает правильно опрелелить реальный FIID*/
  elif( dvndeal.rec.Kind == ПроцентныйСВОП )     
     dvndeal.rec.DVKind = DV_PCTSWAP;
     KindObj = RG_CURRENCY;/*реально вид БА может быть RG_CURRENCY или RG_METAL, но здесь достаточно RG_CURRENCY и это не мешает правильно опрелелить реальный FIID*/
  end;

   if((SourceID == GT_VR_ASTS) AND RG_DVNDealNeedPrognos(dvndeal.rec.Kind) )
      dvndeal.rec.Prognos = SET_CHAR;
   else
      dvndeal.rec.Prognos = UNSET_CHAR;
   end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     dvndeal.rec.Sector     = SET_CHAR;
     dvndeal.rec.MarketKind = DV_MARKETKIND_CURRENCY;
  elif( (SourceID == GT_MMVB3)  OR (SourceID == GT_PAYMENTS))
     dvndeal.rec.Sector = SET_CHAR;
     dvndeal.rec.MarketKind = DV_MARKETKIND_STOCK;
  elif( FromSPFI )
     dvndeal.rec.Sector     = SET_CHAR;
     dvndeal.rec.MarketKind = DV_MARKETKIND_SPFIMARKET;
     if( (GetParmByName( RG,"RGDVNDL_SECTOR", @IsExchangeSPFI, @type)  == NULL) OR (type != V_STRING) )
        SetError( "Не найден либо неверно задан признак биржевой сделки (параметр " + "RGDVNDL_SECTOR" + " объекта " + String(RecordID) + ")" );
     else
        dvndeal.rec.TypeSPFI = IIF( IsExchangeSPFI == SET_CHAR, DV_TYPE_SPFI_EXCHANGE, DV_TYPE_SPFI_OTC ); 
        ExchangeTypeStr = IIF( IsExchangeSPFI == SET_CHAR, "биржевая", "внебиржевая" ); 
     end;
  else/*FromReuters,FromOutSystem*/
     dvndeal.rec.Sector = UNSET_CHAR;
     dvndeal.rec.MarketKind = 0;/*Не заполняется*/
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) or FromSPFI )
     if( GetRealID(RG_PARTY, MMVB_CODE, PTCK_CONTR, @dvndeal.rec.MarketID, @ErrMes) != 0 )
        SetError(ErrMes);
     end;

     if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or FromSPFI ) //В прогнозных сделках валютного рынка схема расчетов не заполняется
        if( (GetParmByName( RG,"RGDVNDL_EXTSETTLECODE", @ExtCode, @type)  == NULL) OR (type != V_STRING) )
           SetError( "Не найден либо неверно задан расчетный код (параметр RGDVNDL_EXTSETTLECODE объекта " + String(RecordID) + ")" );
        else
           if( FindDL_EXTSETTLECODEbyCode(ExtCode, ExtBuff) != 0 )
              ErrMes = GetErrMsg();
              if( ErrMes != "" )
                 SetError("Расчетный код " + ExtCode + " не может быть использован.\n" + ErrMes);
              else
                 SetError("В справочнике расчетных кодов банка не найден код " + ExtCode + ".");
              end; 
           end; 
           if( ExtBuff.rec.InPool == SET_CHAR ) 
              if( FindDL_EXTSCANALYTICSbyMarketKind(IIF(ExtBuff.rec.ParentID == 0, ExtBuff.rec.ID, ExtBuff.rec.ParentID), 
                                                    IIF(FromSPFI, DL_MARKETKIND_SETTLE_SPFIMARKET, DL_MARKETKIND_SETTLE_CURRENCY), 
                                                    Analytics) == 0 )
                 dvndeal.rec.MarketSchemeID = Analytics.rec.MarketSchemeID;
              else 
                 dvndeal.rec.MarketSchemeID = ExtBuff.rec.MarketSchemeID;
              end;
           else 
              dvndeal.rec.MarketSchemeID = ExtBuff.rec.MarketSchemeID;
           end;
        end;
     end;
  end;

  dvndeal.rec.State    = DVDEAL_PREP;
  dvndeal.rec.ParentID = -1;
  dvndeal.rec.FromImport = SET_CHAR;

  if( (GetParmByName( RG, "RGDVNDL_BUYSELL", @BuySell, @type ) == NULL) OR (type != V_STRING) )
     SetError( "Не найдено либо неверно задано направление операции (параметр RGDVNDL_BUYSELL " + " объекта " + String(RecordID)+ ")" );
  end;

  if( BuySell == "B" )
     dvndeal.rec.Type = ALG_DV_BUY;
  elif( BuySell == "S" )
     dvndeal.rec.Type = ALG_DV_SALE;
  elif( BuySell == "B/S" )
     dvndeal.rec.Type = ALG_DV_BS;
  elif( BuySell == "S/B" )
     dvndeal.rec.Type = ALG_DV_SB;
  elif( BuySell == "FIX/FLOAT")
     dvndeal.rec.Type = ALG_DV_FIX_FLOAT;
  elif( BuySell == "FIX/FIX")
     dvndeal.rec.Type = ALG_DV_FIX_FIX;
  elif( BuySell == "FLOAT/FLOAT")
     dvndeal.rec.Type = ALG_DV_FLOAT_FLOAT;
  elif( BuySell == "FLOAT/FIX")
     dvndeal.rec.Type = ALG_DV_FLOAT_FIX;      
  end;

  if( (GetParmByName( RG, "RGDVNDL_DATE", @dvndeal.rec.Date, @type ) == NULL) OR (type != V_DATE) )
     SetError( "Не найдена либо неверно задана дата операции (параметр RGDVNDL_DATE " + " объекта " + String(RecordID) + ")");
  end;

  dvndeal.rec.ChangeDate = dvndeal.rec.Date;
  
  if( dvndeal.rec.Kind == ПроцентныйСВОП )
     dvndeal.rec.Netting_pmgr = UNSET_CHAR;
     if( (GetParmByName( RG, "RGDVNDL_BEGINDATE", @dvndeal.rec.BeginDate, @type ) == NULL) OR (type != V_DATE) )
        SetError( "Не найдена либо неверно задана дата заключения сделки (параметр RGDVNDL_BEGINDATE " + " объекта " + String(RecordID) + ")");
     end;
  else
     dvndeal.rec.BeginDate = dvndeal.rec.Date;
  end;

  if( (GetParmByName( RG, "RGDVNDL_EXTCODE", @dvndeal.rec.ExtCode, @type ) == NULL) OR (type != V_STRING) )
     SetError( "Не найден либо неверно задан внешний код сделки (параметр RGDVNDL_EXTCODE " + " объекта " + String(RecordID) + ")");
  end;
  
  if( FromReuters or FromOutSystem )
     /*Код сделки внутренний Генерируется по референсу в сишнике*/
     if( (GetParmByName( RG, "RGDVNDL_CONTRCODE", @StrTempParm, @type ) == NULL) OR (type != V_STRING) or (StrTempParm=="") )
        SetError( "Не найден либо неверно задан код контрагента сделки (параметр RGDVNDL_CONTRCODE объекта " + String(RecordID) + ")");
     end;
     /*Субъект, у которого код вида Код_Субъекта равен значению из поля */
     if( GetRealID(RG_PARTY, StrTempParm, Код_Субъекта, @dvndeal.rec.Contractor, @ErrMes) != 0 )
        SetError( ErrMes );
     end;

     if( (GetParmByName( RG,"RGDVNDL_COMMENT", @StrTempParm, @type ) == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     else
        dvndeal.rec.Comment = StrTempParm;
     end;

  elif( FromSPFI )
     /*Код сделки внутренний = <ДДММГГГГ>+<код операции внешний>*/
     dvndeal.rec.Code = GetDateStr(dvndeal.rec.Date)+dvndeal.rec.ExtCode;
     /*Контрагент = Автозаполнение: <НКЦ> - это субъект с принадлежностью "Центральный контрагент"*/
     if( not RG_GetCentralContrForMarket( IIF(((SourceID == GT_SPB) OR (SourceID == GT_PAYMENTS_SPB)), false, true ), null,@dvndeal.rec.Contractor,@ErrMes) )
        SetError( ErrMes );
     end;
  else
     if( (GetParmByName( RG, "RGDVNDL_CODE", @DealCode, @type ) == NULL) OR (type != V_STRING) or (DealCode=="") )
        SetError( "Не найден либо неверно задан номер сделки (параметр RGDVNDL_CODE " + " объекта " + String(RecordID) + ")");
     end;
    
     if( (dvndeal.rec.Kind == ПокупкаПродажаT3) and ( (SourceID == GT_MMVB3) OR (SourceID == GT_PAYMENTS) ) )
        dvndeal.rec.Code = GetDateStr(dvndeal.rec.Date)+"0"+DealCode;
     else
        dvndeal.rec.Code = DealCode;
     end;

     if( GetRealID(RG_PARTY, MMVB_CODE, PTCK_CONTR, @dvndeal.rec.Contractor, @ErrMes) != 0 )
        SetError(ErrMes);
     end;
  end;

  if( (GetParmByName( RG, "RGDVNDL_TIME", @dvndeal.rec.Time, @type ) == NULL) OR (type != V_TIME) )
     SetError( "Не найдено либо неверно задано время операции (параметр RGDVNDL_TIME " + " объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG, "RGDVNDL_TRADERCODE", @trader_code, @type ) == NULL) OR (type != V_STRING) )
    // RunError( "Ошибка при получении параметра RGDVNDL_TRADERCODE." );
     trader_code = "";
  end;

  dvndeal.rec.Country = DL_GetCountryByCodeLat3("RUS",true).CountryID;
  if( dvndeal.rec.Country <= 0 )
     SetError( "Не определен ID страны с лат. кодом \"RUS\"." );
  end;
  
  dvndeal.rec.Agent = UnknownParty;

  dvndeal.rec.Client = UnknownParty;
  if( (not FromReuters) and (not FromOutSystem) and (not FromSPFI) )
     if( (GetParmByName( RG,"RGDVNDL_CLIENT", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     else
        if( GetRealID( RG_PARTY, StrTempParm, Код_Субъекта, @dvndeal.rec.Client, @ErrMes, iif((not FromReuters) and (not FromOutSystem),true,false), @ServKind , null, null, iif((not FromReuters) and (not FromOutSystem),dvndeal.rec.Contractor, null )) != 0)
           SetError( ErrMes );
        end;
     end;
     if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
        ServKind = PTSK_CM;
     else
        ServKind = PTSK_DV;
     end;
     if( GetRealID(RG_PARTY, StrTempParm, Код_Субъекта, @dvndeal.rec.Client, @ErrMes, true, ServKind, dvndeal.rec.Date, @dvndeal.rec.ClientContr, dvndeal.rec.Contractor) != 0 )
        SetError( ErrMes );
  end;

  if( dvndeal.rec.Client != UnknownParty )
        if(ПолучитьСубъекта(dvndeal.rec.Client, Party))
           SetError( "Не найден идентификатор клиента" + string(dvndeal.rec.Client) + ", заданного в параметре RGDVNDL_CLIENT объекта " + String(RecordID) );
        end;
        ClientCodeForMsg = StrTempParm; // биржевой код подтвердили, сохраним для сообщений.        
        if( dvndeal.rec.ClientContr <= 0 )
        dvndeal.rec.ClientContr = RGDLFUN_GetContrID( ServKind, {OurBank}, dvndeal.rec.Client, dvndeal.rec.Date, NULL, NULL, @ErrMes );
        if( dvndeal.rec.ClientContr <= 0 )
           SetError(ErrMes);
        end;
        end;
     end;
  end;

  dvndeal.rec.Department = {OperDprt};
  dvndeal.rec.Oper       = {Oper};

  if( FromReuters or FromOutSystem or FromSPFI )
     if( dvndeal.rec.Kind != ПроцентныйСВОП )
        if( (GetParmByName( RG, "RGDVNDL_SUPLDATE", @dvnfi.rec.SuplDate, @type ) == NULL) OR (type != V_DATE) OR (dvnfi.rec.SuplDate == date(0,0,0)) )
           SetError( "Не найдена либо неверно задана дата поставки БА (параметр RGDVNDL_SUPLDATE " + " объекта " + String(RecordID) + ")");
        end;
        
        if( (GetParmByName( RG, "RGDVNDL_PAYDATE", @dvnfi.rec.PayDate, @type ) == NULL) OR (type != V_DATE) OR (dvnfi.rec.PayDate == date(0,0,0)) )
           SetError( "Не найдена либо неверно задана дата оплаты БА (параметр RGDVNDL_PAYDATE " + " объекта " + String(RecordID) + ")");
        end;
     end;
     
     if( dvndeal.rec.Kind == ПокупкаПродажаT3 )
        dvnfi.rec.ExecDate = min(dvnfi.rec.SuplDate, dvnfi.rec.PayDate);
     end;
     
     if( (dvndeal.rec.Kind == ВнебиржФорвард )or (dvndeal.rec.Kind == ПроцентныйСВОП ))
        if( (GetParmByName( RG, "RGDVNDL_EXECDATE", @dvnfi.rec.ExecDate, @type ) == NULL) OR (type != V_DATE) )
           SetError( "Не найдена либо неверно задана дата исполнения (параметр RGDVNDL_EXECDATE " + " объекта " + String(RecordID) + ")");
        end;
     elif( dvndeal.rec.Kind == ВалютныйСВОП )/*ВалютныйСВОП*/
        dvnfi.rec.ExecDate = min(dvnfi.rec.SuplDate, dvnfi.rec.PayDate);
     end;
  else
     if( (GetParmByName( RG, "RGDVNDL_EXECDATE", @dvnfi.rec.ExecDate, @type ) == NULL) OR (type != V_DATE) )
        SetError( "Не найдена либо неверно задана дата исполнения (параметр RGDVNDL_EXECDATE " + " объекта " + String(RecordID) + ")");
     end;
     dvnfi.rec.PayDate = dvnfi.rec.SuplDate = dvnfi.rec.ExecDate;
  end;

  dvnfi.rec.ExecType = DVSETTLEMET_STATE;
  //но если задан тип исполнения в записи репликации, то подгружаем его
  //не говоря об ошибке
  if ( (GetParmByName( RG,"RGDVNDL_TYPEEXEC", @dvnfi.rec.ExecType, @type)  == NULL) OR (type != V_INTEGER) )
  end;

  if( (dvndeal.rec.Kind == ПокупкаПродажаT3) and ( ( SourceID == GT_MMVB3 ) OR (SourceID == GT_PAYMENTS) ) )
     dvnfi.rec.FairValueAlg = GetFairValueAlgIDByCode("ЦБ");
  end;

  /*группа <Базовый актив>*/
  if( (GetParmByName( RG,"RGDVNDL_AMOUNT", @dvnfi.rec.Amount, @type)  == NULL) OR (type != V_DOUBLE) or (dvnfi.rec.Amount == 0.0))
     if( not((dvndeal.rec.Kind == ПокупкаПродажаT3) and ( (SourceID == GT_MMVB3)  OR (SourceID == GT_PAYMENTS) ) ) )/*не ругаемся для ПокупкаПродажаT3 - если не задан, просто рассчитаем*/
        SetError( "Не найдено либо неверно задано кол-во БА по сделке (параметр RGDVNDL_AMOUNT" + " объекта " + String(RecordID) + ")");
     end;
  end;

  if(dvndeal.rec.Kind != ПроцентныйСВОП)
    if( (GetParmByName( RG,"RGDVNDL_PRICE", @dvnfi.rec.Price, @type)  == NULL) OR (type != V_DOUBLE) or (dvnfi.rec.Price == 0.0))
       SetError( "Не найдена либо неверно задана цена единица БА по сделке (параметр RGDVNDL_PRICE" + " объекта " + String(RecordID) + ")");
    end;

  end;

  if( (GetParmByName( RG,"RGDVNDL_POINT", @dvnfi.rec.Point, @type) == NULL) OR (type != V_INTEGER) )
     if( (dvndeal.rec.Kind == ВнебиржФорвард) or (dvndeal.rec.Kind == ПроцентныйСВОП) or ((dvndeal.rec.Kind == ПокупкаПродажаT3) and ( ( SourceID == GT_MMVB3)  OR (SourceID == GT_PAYMENTS) ) ) )
        dvnfi.rec.Point = 2;
     else
        dvnfi.rec.Point = 4;
     end;
  end;

  if( FromReuters or FromOutSystem )
     dvnfi.rec.Cost = round(dvnfi.rec.Amount * dvnfi.rec.Price,2);
  else
     /*Рассчитывается на основании количества  БА и цены единицы БА*/
     if(dvndeal.rec.Kind != ПроцентныйСВОП)
       if( (GetParmByName( RG,"RGDVNDL_COST", @dvnfi.rec.Cost, @type)  == NULL) OR (type != V_MONEY) OR (dvnfi.rec.Cost == $0.0) )
          SetError( "Не найдена либо неверно задана стоимость БА по сделке (параметр " + "RGDVNDL_COST" + " объекта " + String(RecordID) + ")");
       end;
     end;
  end;

  dvnfi.rec.StdFIID     = ALLFININSTR;/*нестандартный*/
  dvnfi.rec.ContrAmount = 1;/*для нестандартных всегда*/

  if(dvndeal.rec.Kind != ПроцентныйСВОП)
     if( (GetParmByName( RG, "RGDVNDL_PRICEFIID", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
        if( FromReuters or FromOutSystem )
           SetError( "Не найдена либо неверно задана цена единица БА по сделке (параметр RGDVNDL_PRICEFIID" + " объекта " + String(RecordID) + ")");
        end;
        /*для остальных оставим как было*/
     else
        if( GetRealID( RG_CURRENCY, StrTempParm, Код_ФинИн, @dvnfi.rec.PriceFIID, @ErrMes ) != 0 )
           SetError( ErrMes );
        end;
        if( ПолучитьФинИн( dvnfi.rec.PriceFIID, fininstr) )
           SetError( "Не найден финансовый инструмент " + string(dvnfi.rec.PriceFIID) + ", заданный в параметре " + "RGDVNDL_PRICEFIID" + " объекта " + String(RecordID) );
        end;
        if( dvndeal.rec.Kind != ВалютныйСВОП )
           dvnfi.rec.AccFIID = dvnfi.rec.PriceFIID;
        end;
     end;
  end;

  if( (dvndeal.rec.Kind == ВалютныйСВОП) or (dvndeal.rec.Kind == ПроцентныйСВОП) )
     dvnfi.rec.AccFIID = ALLFININSTR;
  end;
  dvnfi.rec.Type = DV_NFIType_BaseActiv;
  if( (GetParmByName( RG, "RGDVNDL_FACEVALUE", @dvnfi.rec.Scale, @type) == NULL) OR (type != V_DOUBLE) or (dvnfi.rec.Scale == 0.0))
    dvnfi.rec.Scale  = 1;
  end;

  if( (GetParmByName( RG,"RGDVNDL_ISIN", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
     SetError( "Не найден либо неверно задан финансовый инструмент в качестве БА по сделке (параметр RGDVNDL_ISIN объекта " + String(RecordID) + ")");
  else
     if( GetRealID( KindObj, StrTempParm, Код_ФинИн, @BaseFIID, @ErrMes ) != 0 )
        if( KindObj == RG_AVOIRISS )
           /*если не нашли в шлюзе код для ценной бумаги, то считаем, что во входном файле задан ISIN бумаги и ищем по нему бумагу в справочнике*/
           if( ПолучитьФинИн( StrTempParm, fininstr, NULL, NULL, NULL, FICK_ISIN ) != 0 )
              SetError( "не найдена в справочнике ценная бумага с ISIN = \'" + StrTempParm + "\'" );
           end;
        else
           SetError( "Не найден в справочнике финансовый инструмент \'" + StrTempParm + "\'" );
        end;
     else 
        if( ПолучитьФинИн( BaseFIID, fininstr, NULL, NULL, NULL ) != 0 )
           SetError( "Ошибка в справочнике для финансового инструмента \'" + string(BaseFIID) + "\'" );
        end;
     end;  
     if( (fininstr.IsGeneralized != "X") AND (fininstr.GeneralizedFIID != ALLFININSTR) ) // фактический
        dvnfi.rec.FIID = fininstr.GeneralizedFIID;
     else
        dvnfi.rec.FIID = fininstr.FIID;
     end;
  end;

  if( (dvndeal.rec.Kind == ПокупкаПродажаT3) and ( (SourceID == GT_MMVB3) OR (SourceID == GT_PAYMENTS) ) )
     if( (GetParmByName( RG,"RGDVNDL_PRICETYPE", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
        SetError( "Не найден либо неверно задан тип цены по сделке (параметр RGDVNDL_PRICETYPE объекта " + String(RecordID) + ")");
     else
        if( StrTempParm == "PERC" )
           if( FI_GetCurrentNominal(dvnfi.rec.FIID, dvndeal.rec.Date, Nominal) )
              dvnfi.rec.Price = dvnfi.rec.Price * Nominal/ 100;
           end;
        end;
     end;
     
     if( (dvnfi.rec.Amount == 0.0) and (dvnfi.rec.Price!=0.0) )
        if( (GetParmByName( RG,"RGDVNDL_VALUE", @DealSum, @type)  == NULL) OR (type != V_DOUBLE) or (DealSum == 0.0))
           SetError( "Не найден либо неверно задан объём сделки (параметр RGDVNDL_VALUE объекта " + String(RecordID) + ")");
        else
           dvnfi.rec.Amount = DealSum / dvnfi.rec.Price;
        end;
     end;
  end;

  if( dvndeal.rec.Kind == ВалютныйСВОП )
     dvnfi_2 = TRecHandler("dvnfi.dbt");

     dvnfi_2.rec.ExecType = dvnfi.rec.ExecType;
     dvnfi_2.rec.FairValueAlg = dvnfi.rec.FairValueAlg;
     dvnfi_2.rec.Scale = dvnfi.rec.Scale; 
    
     if( (GetParmByName( RG,"RGDVNDL_PRICE_2", @dvnfi_2.rec.Price, @type)  == NULL) OR (type != V_DOUBLE) or (dvnfi_2.rec.Price == 0.0))
         SetError( "Не найдена либо неверно задана цена единица БА по сделке (параметр RGDVNDL_PRICE_2 объекта " + String(RecordID) + ")");
     end;

     dvnfi_2.rec.Point       = dvnfi.rec.Point;
     dvnfi_2.rec.StdFIID     = ALLFININSTR;/*нестандартный*/
     dvnfi_2.rec.ContrAmount = 1;/*для нестандартных всегда*/
     dvnfi_2.rec.AccFIID     = dvnfi.rec.AccFIID;
     dvnfi_2.rec.Type        = DV_NFIType_BaseActiv2;

     if( (not FromReuters) and (not FromOutSystem) )

        if( (GetParmByName( RG, "RGDVNDL_EXECDATE_2", @dvnfi_2.rec.ExecDate, @type ) == NULL) OR (type != V_DATE) )
            SetError( "Не найдена либо неверно задана дата исполнения (параметр RGDVNDL_EXECDATE_2 объекта " + String(RecordID) + ")");
        end;

        dvnfi_2.rec.PayDate = dvnfi_2.rec.SuplDate = dvnfi_2.rec.ExecDate;

        /*группа <Базовый актив>*/
        if( (GetParmByName( RG,"RGDVNDL_AMOUNT_2", @dvnfi_2.rec.Amount, @type)  == NULL) OR (type != V_DOUBLE) or (dvnfi_2.rec.Amount == 0.0))
            SetError( "Не найдено либо неверно задано кол-во БА по сделке (параметр RGDVNDL_AMOUNT_2 объекта " + String(RecordID) + ")");
        end;

        if( (GetParmByName( RG,"RGDVNDL_COST_2", @dvnfi_2.rec.Cost, @type)  == NULL) OR (type != V_MONEY) OR (dvnfi_2.rec.Cost == $0.0) )
            SetError( "Не найдена либо неверно задана стоимость БА по сделке (параметр " + "RGDVNDL_COST_2 объекта " + String(RecordID) + ")");
        end;

        if( (GetParmByName( RG,"RGDVNDL_ISIN_2", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
            SetError( "Не найден либо неверно задан финансовый инструмент в качестве БА по сделке (параметр RGDVNDL_ISIN_2 объекта " + String(RecordID) + ")");
        else
           if( GetRealID( KindObj, StrTempParm, Код_ФинИн, @BaseFIID, @ErrMes ) != 0 )
              SetError( " не найден в справочнике финансовый инструмент \'" + StrTempParm + "\'" );
           else 
              if( ПолучитьФинИн( BaseFIID, fininstr, NULL, NULL, NULL ) != 0 )
                 SetError( " ошибка в справочнике для финансового инструмента \'" + string(BaseFIID) + "\'" );
              end;
           end;
           dvnfi_2.rec.FIID = fininstr.FIID;
        end;

        if( (GetParmByName( RG, "RGDVNDL_PRICEFIID_2", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
           /*оставим как было*/
        else
           if( GetRealID( RG_CURRENCY, StrTempParm, Код_ФинИн, @dvnfi_2.rec.PriceFIID, @ErrMes ) != 0 )
              SetError( ErrMes );
           end;
           if(ПолучитьФинИн( dvnfi_2.rec.PriceFIID, fininstr))
              SetError( "Не найден финансовый инструмент " + string(dvnfi_2.rec.PriceFIID) + ", заданный в параметре " + "RGDVNDL_PRICEFIID_2 объекта " + String(RecordID) );
           end;
        end;
        
     else
        if( (GetParmByName( RG, "RGDVNDL_SUPLDATE_2", @dvnfi_2.rec.SuplDate, @type ) == NULL) OR (type != V_DATE) OR (dvnfi_2.rec.SuplDate == date(0,0,0)) )
            SetError( "Не найдена либо неверно задана дата поставки БА 2 ч. (параметр RGDVNDL_SUPLDATE_2 " + " объекта " + String(RecordID) + ")");
        end;
        
        if( (GetParmByName( RG, "RGDVNDL_PAYDATE_2", @dvnfi_2.rec.PayDate, @type ) == NULL) OR (type != V_DATE) OR (dvnfi_2.rec.PayDate == date(0,0,0)) )
            SetError( "Не найдена либо неверно задана дата поставки КА 2 ч. (параметр RGDVNDL_PAYDATE_2 " + " объекта " + String(RecordID) + ")");
        end;

        dvnfi_2.rec.ExecDate  = min(dvnfi_2.rec.SuplDate,dvnfi_2.rec.PayDate);
        dvnfi_2.rec.Amount    = dvnfi.rec.Amount;
        /*Рассчитывается на основании количества  БА и цены единицы БА*/
        dvnfi_2.rec.Cost      = round(dvnfi_2.rec.Amount * dvnfi_2.rec.Price,2);
        dvnfi_2.rec.FIID      = dvnfi.rec.FIID;
        dvnfi_2.rec.PriceFIID = dvnfi.rec.PriceFIID;
     end;        
  elif( dvndeal.rec.Kind == ПроцентныйСВОП )
     dvnfi_2 = TRecHandler("dvnfi.dbt");

     dvnfi_2.rec.ExecDate    = dvnfi.rec.ExecDate;
     dvnfi_2.rec.ExecType    = dvnfi.rec.ExecType;
     dvnfi_2.rec.ContrAmount = dvnfi.rec.ContrAmount;
     dvnfi_2.rec.StdFIID     = dvnfi.rec.StdFIID;
     dvnfi_2.rec.Point       = dvnfi.rec.Point;
     dvnfi_2.rec.AccFIID     = dvnfi.rec.AccFIID;
     dvnfi_2.rec.Scale       = dvnfi.rec.Scale; 

     dvnfi.rec.Basis = dvnfi_2.rec.Basis = 4/*BASIS_ACTACT*/;

     if( (GetParmByName( RG,"RGDVNDL_TYPECALC_DVNFI", @StrTempParm, @type)  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
         SetError( "Не найден либо неверно задан вариант расчета по сделке (параметр RGDVNDL_TYPECALC_DVNFI объекта " + String(RecordID) + ")");
     else
        if( StrTempParm == "FOLLOWING" )
           dvnfi.rec.TypeCalc = ALG_DV_TYPECALC_FOLLOWING;
        elif( StrTempParm == "MODFOLLOWING" )
           dvnfi.rec.TypeCalc = ALG_DV_TYPECALC_MODIFIED;
        elif( StrTempParm == "PRECEDING" )
           dvnfi.rec.TypeCalc = ALG_DV_TYPECALC_PRECEDING;
        end;
     end;

     if( (GetParmByName( RG,"RGDVNDL_PERIOD_DVNFI", @dvnfi.rec.Period, @type)  == NULL) OR (type != V_INTEGER) )
         SetError( "Не найден либо неверно задан срок обмена платежами по 1 ч. СВОПа (параметр RGDVNDL_PERIOD_DVNFI " + String(RecordID) + ")");
     end;

     if( (GetParmByName( RG,"RGDVNDL_PERIODKIND_DVNFI", @StrTempParm, @type)  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
         SetError( "Не найден либо неверно задан вид срока по сделке (параметр RGDVNDL_PERIODKIND_DVNFI объекта " + String(RecordID) + ")");
     else
        if( StrTempParm == "D" )
           dvnfi.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_DAY;
        elif( StrTempParm == "M" )
           dvnfi.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_MONTH;
        elif( StrTempParm == "Y" )
           dvnfi.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_YEAR;
        elif( StrTempParm == "T" )
           dvnfi.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_PERIOD;
        end;
     end;

     if( dvnfi.rec.ExecType == DVSETTLEMET_CALC )/*расчетный своп: ВбаТ = ВбаО*/      
        dvnfi_2.rec.Amount      = dvnfi.rec.Amount;
        dvnfi_2.rec.FIID        = dvnfi.rec.FIID;
        dvnfi_2.rec.course      = 1;
        dvnfi_2.rec.coursepoint = 4;
     else/*поставочный или валютно-процентный своп: ВбаТ != ВбаО*/
        if( (GetParmByName( RG,"RGDVNDL_ISIN_2", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
            SetError( "Не найден либо неверно задан финансовый инструмент в качестве БА требований по сделке (параметр RGDVNDL_ISIN_2 объекта " + String(RecordID) + ")");
        else
           if( GetRealID( KindObj, StrTempParm, Код_ФинИн, @BaseFIID, @ErrMes ) != 0 )
              SetError( " не найден в справочнике финансовый инструмент \'" + StrTempParm + "\'" );
           else 
              if( ПолучитьФинИн( BaseFIID, fininstr, NULL, NULL, NULL ) != 0 )
                 SetError( " ошибка в справочнике для финансового инструмента \'" + string(BaseFIID) + "\'" );
              end;
           end;
           dvnfi_2.rec.FIID = fininstr.FIID;
        end;
        if( (GetParmByName( RG, "RGDVNDL_AMOUNT_2", @dvnfi_2.rec.Amount, @type ) == NULL) OR (type != V_DOUBLE) OR (dvnfi_2.rec.Amount == 0.0) )
          SetError( "Не найдена либо неверно задана сумма БА требований по сделке (параметр RGDVNDL_AMOUNT_2 " + " объекта " + String(RecordID) + ")");
        end;

        dvnfi_2.rec.course      = dvnfi.rec.Amount/dvnfi_2.rec.Amount;
        dvnfi_2.rec.coursepoint = 4;
     end;
     
     if( (GetParmByName( RG,"RGDVNDL_PERIOD_DVNFI_2", @dvnfi_2.rec.Period, @type)  == NULL) OR (type != V_INTEGER) )
         SetError( "Не найден либо неверно задан срок обмена платежами по 2 ч. СВОПа (параметр RGDVNDL_PERIOD_DVNFI_2 " + String(RecordID) + ")");
     end;
        
     if( (GetParmByName( RG,"RGDVNDL_PERIODKIND_DVNFI_2", @StrTempParm, @type)  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
         SetError( "Не найден либо неверно задан вид срока по сделке (параметр RGDVNDL_PERIODKIND_DVNFI_2 объекта " + String(RecordID) + ")");
     else
        if( StrTempParm == "D" )
           dvnfi_2.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_DAY;
        elif( StrTempParm == "M" )
           dvnfi_2.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_MONTH;
        elif( StrTempParm == "Y" )
           dvnfi_2.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_YEAR;
        elif( StrTempParm == "T" )
           dvnfi_2.rec.PeriodKind = ALG_DV_PERIODKIND_PRRATE_PERIOD;
        end;
     end;

     if( (GetParmByName( RG,"RGDVNDL_TYPECALC_DVNFI_2", @StrTempParm, @type)  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
         SetError( "Не найден либо неверно задан вариант расчета по сделке (параметр RGDVNDL_TYPECALC_DVNFI_2 объекта " + String(RecordID) + ")");
     else
        if( StrTempParm == "FOLLOWING" )
           dvnfi_2.rec.TypeCalc = ALG_DV_TYPECALC_FOLLOWING;
        elif( StrTempParm == "MODFOLLOWING" )
           dvnfi_2.rec.TypeCalc = ALG_DV_TYPECALC_MODIFIED;
        elif( StrTempParm == "PRECEDING" )
           dvnfi_2.rec.TypeCalc = ALG_DV_TYPECALC_PRECEDING;
        end;
     end;

     if( (dvndeal.rec.Type == ALG_DV_FIX_FLOAT) OR (dvndeal.rec.Type == ALG_DV_FIX_FIX) ) //Фиксированная ставка по первой части
        if( (GetParmByName(RG,"RGDVNDL_RATE_DVNFI", @dvnfi.rec.rate, @type) == NULL) OR (type != V_DOUBLE));
           SetError( "Не найдено либо неверно задано значение ставки по 1 ч. СВОПа (параметр RGDVNDL_RATE_DVNFI объекта " + String(RecordID) + ")");
        end;

        dvnfi.rec.RatePoint = 4;
        dvnfi.rec.RateID    = ALLFININSTR;
        dvnfi.rec.spread    = 0;
        dvnfi.rec.CalKindID = -1;
        dvnfi.rec.FixDays   = 0;
     else//Плавающая ставка по первой части
        if( (GetParmByName(RG,"RGDVNDL_SPREAD", @dvnfi.rec.spread ,@type) == NULL) OR (type != V_DOUBLE) )
          SetError( "Не найдено либо неверно задано значение спреда по 1 ч. СВОПа (параметр RGDVNDL_SPREAD объекта " + String(RecordID) + ")");
        end;

        dvnfi.rec.Rate       = 0;
        dvnfi.rec.RatePoint  = 4;
        dvnfi.rec.FloatPoint = 4;
        dvnfi.rec.CalKindID  = 0/*CALKINDIDMAINSYS*/;

        if( (GetParmByName( RG,"RGDVNDL_RATEID_DVNFI", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
            SetError( "Не найдена либо неверно задана плавающая ставка по сделке (параметр RGDVNDL_RATEID_DVNFI объекта " + String(RecordID) + ")");
        else
           if( GetRealID( KindObj, StrTempParm, Код_ФинИн, @BaseFIID, @ErrMes ) != 0 )
              SetError( " не найден в справочнике финансовый инструмент \'" + StrTempParm + "\'" );
           else 
              if( ПолучитьФинИн( BaseFIID, fininstr, NULL, NULL, NULL ) != 0 )
                 SetError( " ошибка в справочнике для финансового инструмента \'" + string(BaseFIID) + "\'" );
              end;
           end;
           dvnfi.rec.RateID = fininstr.FIID;
        end;

        if( (GetParmByName( RG, "RGDVNDL_FIXRATE_DVNFI", @dvnfi.rec.FixDays, @type ) == NULL) OR (type != V_INTEGER) )
          SetError( "Не найдено либо неверно задано кол-во дней до даты фиксации по сделке (параметр RGDVNDL_FIXRATE_DVNFI объекта " + String(RecordID) + ")");
        end;
     end;

     if( (dvndeal.rec.Type == ALG_DV_FIX_FLOAT) OR (dvndeal.rec.Type == ALG_DV_FLOAT_FLOAT) )//Плавающая ставка по второй части
        if( (GetParmByName(RG,"RGDVNDL_SPREAD_2", @dvnfi_2.rec.spread ,@type) == NULL) OR (type != V_DOUBLE) )
          SetError( "Не найдено либо неверно задано значение спреда по 2 ч. СВОПа (параметр RGDVNDL_SPREAD_2 объекта " + String(RecordID) + ")");
        end;

        dvnfi_2.rec.Rate      = 0;
        dvnfi_2.rec.RatePoint = dvnfi.rec.RatePoint;
        dvnfi_2.rec.FloatPoint = dvnfi.rec.RatePoint;
        dvnfi_2.rec.CalKindID = 0/*CALKINDIDMAINSYS*/;

        if( (GetParmByName( RG,"RGDVNDL_RATEID_DVNFI_2", @StrTempParm, @type )  == NULL) OR (type != V_STRING) OR (StrTempParm == "") )
            SetError( "Не найдена либо неверно задана плавающая ставка по сделке (параметр RGDVNDL_RATEID_DVNFI_2 объекта " + String(RecordID) + ")");
        else
           if( GetRealID( KindObj, StrTempParm, Код_ФинИн, @BaseFIID, @ErrMes ) != 0 )
              SetError( "Не найден в справочнике финансовый инструмент \'" + StrTempParm + "\'" );
           else 
              if( ПолучитьФинИн( BaseFIID, fininstr, NULL, NULL, NULL ) != 0 )
                 SetError( "Ошибка в справочнике для финансового инструмента \'" + string(BaseFIID) + "\'" );
              end;
           end;
           dvnfi_2.rec.RateID = fininstr.FIID;
        end;

        if( (GetParmByName( RG, "RGDVNDL_FIXRATE_DVNFI_2", @dvnfi_2.rec.FixDays, @type ) == NULL) OR (type != V_INTEGER) )
          SetError( "Не найдено либо неверно задано кол-во дней до даты фиксации по сделке (параметр RGDVNDL_FIXRATE_DVNFI_2 объекта " + String(RecordID) + ")");
        end;
     else// Фиксированная ставка по второй части
        if( (GetParmByName(RG,"RGDVNDL_RATE_DVNFI_2", @dvnfi_2.rec.rate, @type) == NULL) OR (type != V_DOUBLE));
           SetError( "Не найдено либо неверно задано значение ставки по 1 ч. СВОПа (параметр RGDVNDL_RATE_DVNFI_2 объекта " + String(RecordID) + ")");
        end;

        dvnfi_2.rec.RatePoint = 4;
        dvnfi_2.rec.RateID    = ALLFININSTR;
        dvnfi_2.rec.spread    = 0;
        dvnfi_2.rec.CalKindID = -1;
        dvnfi_2.rec.FixDays   = 0;
     end;
    
     if( (GetParmByName( RG,"RGDVNDL_SWAPTYPE", @dvndeal.rec.SwapType, @type)  == NULL) OR (type != V_INTEGER) )
         SetError( "Не найден либо неверно задан тип процентного СВОПа (параметр RGDVNDL_SWAPTYPE " + String(RecordID) + ")");
     end;
    
  end;

  /*Классификация срока*/
  dvndeal.rec.PeriodCLS = DV_PERIODCLS_T3;
  //по #288524 более не проверяем. доверяем файлам биржи
  /*if( (dvndeal.rec.Kind == ВалютныйСВОП) or (dvndeal.rec.Kind == ПроцентныйСВОП) )
     if( DL_GetNumWorkDaysForPeriod(dvndeal.rec.Date,dvnfi_2.rec.ExecDate,dvnfi_2.rec.FIID,dvnfi_2.rec.PriceFIID,dvndeal.rec.Contractor) < 3 )
        SetError( "Даты валютирования 2ч. сделки не соответствуют сроку сделки T+3. Сделка "+dvndeal.rec.ExtCode+" объекта " + String(RecordID));
     end;
  else
     if( DL_GetNumWorkDaysForPeriod(dvndeal.rec.Date,dvnfi.rec.ExecDate,dvnfi.rec.FIID,dvnfi.rec.PriceFIID,dvndeal.rec.Contractor) < 3 )
        SetError( "Даты валютирования сделки не соответствуют сроку сделки T+3. Сделка "+dvndeal.rec.ExtCode+" объекта " + String(RecordID));
     end;
  end;*/

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )

     if( (GetParmByName( RG, "RGDVNDL_REQCODE", @dvndeal.rec.ReqCode, @type ) == NULL) OR (type != V_STRING) )
        SetError( "Не найден либо неверно задан код связанной заявки-поручения (параметр RGDVNDL_REQCODE " + " объекта " + String(RecordID) + ")");
     end;

     GetParmByName(RG, "RGDVNDL_CUX23CODE", @CUX23Code, @type);
    
     var marketreportid, strSPGroundID;
     /* RGDVNDL_MARKETREPORT_ID - Идентификатор документа-подтверждения */
     if( (GetParmByName( RG,"RGDVNDL_MARKETREPORT_ID", @marketreportid, @type )  == NULL) OR (type != V_INTEGER)  )
        marketreportid = 0;
     end;
     if( (marketreportid > 0) AND (GetObjectCode(11 /*$(RS-Bank получатель)*/, marketreportid, @strSPGroundID) == 0) )     
        if( strSPGroundID != "" )
           spgrdoc.rec.SPGroundID = int(strSPGroundID);
        end;
     end;
  end;

  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) 
   OR ((dvndeal.rec.Kind == ПокупкаПродажаT3) and ( (SourceID == GT_MMVB3)  OR (SourceID == GT_PAYMENTS) ) ) )
     if( dvnfi.rec.FIID > 0 ) 
        if( FI_IsCouponAvoiriss(fininstr) )
           if( (GetParmByName(RG, "RGDVNDL_NKD", @dvnfi.rec.NKD, @type) == NULL) OR (type != V_MONEY) )
           else
              /*НКД в файле задан в валюте расчётов. Переведём в ВН */
              var CFI_FIID:integer = IIF(dvnfi.rec.AccFIID == ALLFININSTR, dvnfi.rec.PriceFIID, dvnfi.rec.AccFIID);
              if( fininstr.FaceValueFI != CFI_FIID )
                 if( not SmartConvertSum(dvnfi.rec.NKD, dvnfi.rec.NKD, dvndeal.rec.Date, CFI_FIID, fininstr.FaceValueFI, false) )
                    dvnfi.rec.NKD = $0;
                 end;
              end;
              dvnfi.rec.NKD = MakeMoney(dvnfi.rec.NKD);
           end;
        end;
     end;
  end;

  if( (not FromReuters) and (not FromOutSystem) )
     ArrComSums.Size = 0;
     var CommDate:date = dvndeal.rec.Date;
     if( (dvndeal.rec.Time > Time(19,0,0) ) and (SourceID != GT_VR) and (SourceID != GT_PAYMENTS_VR) and (SourceID != GT_VR_ASTS) )
        CommDate = GetDateAfterWorkDays(CommDate, 1);
     end;
     var GateCommDate = null;
     
     var ArrComSums_i = 0, ComSum = $0;
     var dlcomis_market = TRecHandler( "dlcomis.dbt"  );

     ComisContrID = RGDLFUN_GetContrID(PTSK_DV, dvndeal.rec.Contractor, {OurBank}, dvndeal.rec.Date, NULL, NULL, @ErrMes);
     if( ComisContrID <= 0 )
        SetError(ErrMes);
     else
        if( (dvndeal.rec.Kind == ПокупкаПродажаT3) and ( (SourceID == GT_MMVB3) OR (SourceID == GT_PAYMENTS) ) )
           dvndeal.rec.Agent = dvndeal.rec.Contractor;
           dvndeal.rec.AgentContr = ComisContrID;
        end;
     end;
     
     if( (GetParmByName(RG, "RGDVNDL_AMOUNT_COMM", @ComSum, @type) == NULL) OR (type != V_MONEY) )
     elif( ComSum > $0.0 )
        dlcomis_market.Clear();
        if( not RG_InitDlComis("МскБиржВ", dlcomis_market, @ErrMes, SF_FEE_TYPE_PERIOD, ComSum, null, dvndeal.rec.ClientContr, CommDate) )
           SetError( ErrMes );
        else
           if(dlcomis_market.rec.isBankExpenses == SET_CHAR) 
              dlcomis_market.rec.Contract = ComisContrID;
              dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           elif(dvndeal.rec.Client != UnknownParty)
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           else
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = ComisContrID; 
           end; 
           if( FromSPFI )
              if( (GetParmByName(RG, "RGDVNDL_COMM_DATE", @GateCommDate, @type) == NULL) OR (type != V_DATE) )
              else
                 dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = GateCommDate;
              end;
           else
              dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
           end;
              
           ArrComSums_i = ArrComSums.Size;
           ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
           copy(ArrComSums(ArrComSums_i), dlcomis_market);
        end;
     end;
     
     if( (GetParmByName(RG,"RGDVNDL_CLRCOMM", @ComSum, @type) == NULL) OR (type != V_MONEY) )
     elif( ComSum > $0.0 )
        dlcomis_market.Clear();
        if( not RG_InitDlComis("МскБиржКлирВ", dlcomis_market, @ErrMes, SF_FEE_TYPE_PERIOD, ComSum, null, dvndeal.rec.ClientContr, CommDate) )
           SetError( ErrMes );
        else
           if(dlcomis_market.rec.isBankExpenses == SET_CHAR) 
              dlcomis_market.rec.Contract = ComisContrID;
              dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           elif(dvndeal.rec.Client != UnknownParty)
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           else
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = ComisContrID; 
           end;            
           if( FromSPFI )
              if( (GetParmByName(RG, "RGDVNDL_CLRCOMM_DATE", @GateCommDate, @type) == NULL) OR (type != V_DATE) )
              else
                 dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = GateCommDate;
              end;
           else
              dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
           end;
           
           ArrComSums_i = ArrComSums.Size;
           ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
           copy(ArrComSums(ArrComSums_i), dlcomis_market);
        end;
     end;
     
     if( (GetParmByName(RG,"RGDVNDL_ITSCOMM", @ComSum, @type) == NULL) OR (type != V_MONEY) )
     elif( ComSum > $0.0 )
        dlcomis_market.Clear();
        if( not RG_InitDlComis("МскБиржИТСВ", dlcomis_market, @ErrMes, SF_FEE_TYPE_PERIOD, ComSum, null, dvndeal.rec.ClientContr, CommDate) )
           SetError( ErrMes );
        else
           if(dlcomis_market.rec.isBankExpenses == SET_CHAR) 
              dlcomis_market.rec.Contract = ComisContrID;
              dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           elif(dvndeal.rec.Client != UnknownParty)
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = dvndeal.rec.ClientContr;
           else
              dlcomis_market.rec.Contract = dlcomis_market.rec.ClientContrID = ComisContrID; 
           end; 
           dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
     
           ArrComSums_i = ArrComSums.Size;
           ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
           copy(ArrComSums(ArrComSums_i), dlcomis_market);
        end;
     end;
  end;

  dvndeal.rec.GenAgrID = -1;

  if (dvndeal.rec.Contractor == 1181)    
      dvndeal.rec.GenAgrID = 419;
  end;
 
  dvndeal.rec.KindDealPartyClient = -1;

  if( dvndeal.rec.Client != UnknownParty )
     DL_СкорректироватьДатуЗаявки(dvndeal.rec.Date, dvndeal.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
     ClntRep.rec.XLD = DL_СформироватьНомерЗаявки(-1, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
     ClntRep.rec.SignedDate = ClntRep.rec.RegistrDate;
     ClntRep.rec.SignedTime = ClntRep.rec.RegistrTime;
  end;

  var IpmVR = false;
  if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) or (SourceID == GT_VR_ASTS) )
     IpmVR = true;
  end;

   var InsertDeal = true;
   // var MsgArr = TArray();
   if( ((SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR)) and (dvndeal.rec.Prognos == UNSET_CHAR) and RG_DVNDealNeedPrognos(dvndeal.rec.Kind))
   //сверяем сделку с прогнозной
      LimitsCheckDate = dvndeal.rec.Date;
      stat = RG_DvndealReconcile(dvndeal, dvnfi, dvnfi_2, ArrComSums, MsgArr, ClientCodeForMsg);
      if(stat == RG_Reconcile_OK) // нет расхождений
         // Clear Prognos
         if(RG_ClearPrognosAndAddSchemeID(dvndeal.rec.Code, dvndeal.rec.MarketSchemeID) != 0)
            SetError("Ошибка при снятии признака \"Прогноз\" и установке схемы расчетов по сделке " + dvndeal.rec.ExtCode + ".");
         end;
         InsertDeal = false;
      elif(stat == RG_Reconcile_NoDeal) // нет сделки
         InsertDeal = true;
         RG_AddNewDealMsg(dvndeal.rec.ExtCode, dvndeal.rec.Client, ClientCodeForMsg, MsgArr);
         if((dvndeal.rec.Client != -1) and RG_CheckLimitsMMVBCurr_AfterDate( LimitsCheckDate))
            RG_AddLimitMsg(ClientCodeForMsg, MsgArr);
         end;
      elif((stat == RG_Reconcile_NoData) or (stat == RG_Reconcile_BadData)) // сделка есть, но неправильная
         SetError("Невозможно обновить сделку " + dvndeal.rec.ExtCode + ". ");
      elif(stat == RG_Reconcile_Discrepancy) // есть расхождения
         // Delete old deal
         stat = DV_DeleteNDeal(dvndeal.rec.Code);
         if(stat != 0)
            SetError("Ошибка при удалении сделки с номером " + dvndeal.rec.ExtCode + ". " + GetErrMsg());
         end;
         InsertDeal = true;
         if((dvndeal.rec.Client != -1) and RG_CheckLimitsMMVBCurr_AfterDate( LimitsCheckDate))
            RG_AddLimitMsg(ClientCodeForMsg, MsgArr);            
         end;
      end;
   end;

   if(InsertDeal)
      var errstr = "";
      if (dvndeal.rec.ClientContr > 0)
         RG_DropInvalidSFILinks(OBJTYPE_SFCONTR, dvndeal.rec.ClientContr);
      end;
      // BIQ-9103, при вставке сделки заполняем MethodApplic и IsMarginCall
      IsMarginCall = Index(StrLwr(trader_code), "mc") > 0;
      dvndeal.rec.MethodApplic = DL_REQ_METHODAPPLIC_EDOC;
      SetMethodApplic(trader_code, @dvndeal.rec.MethodApplic);
      stat = DV_InsertNDeal(dvndeal, dvnfi, dvnfi_2, null, spgrdoc, ArrComSums, ClntRep, IpmVR, null, null, null, null, IsMarginCall);
      if( stat == 30729 ) // Ошибка "Не найдена запись СПИ"
        if(not RG_InsertSettaccSsfi(dvndeal.rec.ClientContr, dvnfi.rec.FIID, @errstr))
          stat = DV_InsertNDeal(dvndeal, dvnfi, dvnfi_2, null, spgrdoc, ArrComSums, ClntRep, IpmVR, null, null, null, null, IsMarginCall);
        end;
      end;
      if( errstr != "")
         SetError("Ошибка при вставке отложенной сделки с ПИ.\n"+errstr);
      elif( stat != 0 )
         SetError("Ошибка при вставке отложенной сделки с ПИ.\n"+GetErrMsg());
      end;                         
   end;
   /*вставка примечания "Номер операции по CUX23"*/
   if((CUX23Code != NULL) and (CUX23Code != "") )
      if( addNoteForObject( OBJTYPE_OUTOPER_DV,
                           UniID(dvndeal, OBJTYPE_OUTOPER_DV),
                           NOTEKIND_DVNDEAL_CUX23CODE,
                           CUX23Code,
                           dvndeal.rec.Date ) )
         SetError("Ошибка при установке примечания \"Номер операции по CUX23\" для объекта " + String(RecordID));
      end;
   end;

  /*вставка примечания "конечный контрагент по сделке"*/
  if(fromSPFI)
     if( (GetParmByName( RG,"RGDVNDL_RELPARTYREF", @RelPartyRef, @type)  != NULL) AND (type == V_STRING) )
        if( addNoteForObject( OBJTYPE_OUTOPER_DV,
                        UniID(dvndeal, OBJTYPE_OUTOPER_DV),
                        14,
                        RelPartyRef,
                        dvndeal.rec.Date ) )
           SetError("Ошибка при установке примечания \"Сторона парного договора для формы 701\" для объекта " + String(RecordID));
        end;
     end;
     if(dvndeal.rec.Kind == ПроцентныйСВОП)
       var ExecDate2;
       if( (GetParmByName( RG,"RGDVNDL_EXECDATE_2", @ExecDate2, @type)  != NULL) AND (type == V_DATE) )
         if( addNoteForObject( OBJTYPE_OUTOPER_DV,
                        UniID(dvndeal, OBJTYPE_OUTOPER_DV),
                        110,
                        ExecDate2,
                        dvndeal.rec.Date ) )
           SetError("Ошибка при установке примечания \"Дата истечения срока проц.свопа\" для объекта " + String(RecordID));
         end;
      end;
     end;
  end;

   // BIQ-9103, если в примечании есть подстрока 'mc', заполним категорию
   if( IsMarginCall == true )
     if( ( not DisconnectObjAttr(OBJTYPE_OUTOPER_DV,  UniID(dvndeal, OBJTYPE_OUTOPER_DV), MARGINCALL_CATEGORY) ) OR
         ( not ConnectObjAttr(stat, OBJTYPE_OUTOPER_DV, UniID(dvndeal, OBJTYPE_OUTOPER_DV), MARGINCALL_CATEGORY, 1/*Да*/, null, null, dvndeal.rec.Date) ) OR
         ( stat != 0 ) )
         SetError("Ошибка при установке категории 'Margin Call' для объекта " + String(RecordID));
     end;
   end;
   if(trader_code != "")
     if( addNoteForObject( OBJTYPE_OUTOPER_DV,
                          UniID(dvndeal, OBJTYPE_OUTOPER_DV),
                          150,
                          trader_code,
                          dvndeal.rec.Date ) )
        SetError("Ошибка при установке примечания \"Трейдер\" для объекта " + String(RecordID));
     end;
     if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) )
       //DEF-76287 Если заявка загрузилась до связанных с ней сделок, то также необходимо заполнить кодом трейдера примечание 102 для заявки
       cmd = DL_RSDCommand("SELECT * " +
                           "  FROM ddl_req_dbt " +
                           " WHERE t_kind = ? " +
                           "   AND t_codets = ? " +
                           "   AND t_marketKind = ? " +
                           "   AND t_marketID = ? ");
       cmd.AddParam(350/*DOCKIND_REQ_CLIENT_DEAL*/);
       cmd.AddParam(dvndeal.rec.ReqCode);
       cmd.AddParam(DV_MARKETKIND_CURRENCY);
       cmd.AddParam(dvndeal.rec.MarketID);
  
       DataSet = cmd.Execute();
       if(DataSet.MoveNext())
         DataSet.GetRecord().CopyTo(request.rec);
         addNoteForObject(149, UniID(request, 149), 102, trader_code, request.rec.Date); //Примечание вставится только в том случае, если его еще нет
       end;
     end;
   end;

   if(InsertDeal)
      ID = string( dvndeal.rec.ID );
      Comment = "В ФИССиКО создана "+ExchangeTypeStr+" сделка № " + dvndeal.rec.ExtCode + ". DealID = " + dvndeal.rec.ID + ".";
   else
      RG_GetIDForDealcode(dvndeal.rec.Code, @dealId, @clientId, @dealDate, @dealExtCode);
      ID = string( dealId );
      Comment = "В ФИССиКО обновлена "+ExchangeTypeStr+" сделка № " + dvndeal.rec.ExtCode + ". DealID = " + dealId + ".";
   end;

   if(MsgArr.Size > 0)
      Comment = Comment + RG_DumpMsgStr(MsgArr);
   end;

   return 0;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = ErrorText;
   else
      Comment = RslErrObj.Message;
   end;
   return 1;
end;

macro _DVnDeal_Remove( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING):INTEGER

  var RG;
  var BuySell, type, BaseFIID, stat = 0;
  var StrTempParm:string = "";
  VAR ErrMes:string;
  var DealCode:string = "", ContractorContrID, ComisContrID;

  RG = TGTRecord();
  RG.LoadFromDB(RecordID);
  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;

  VAR SourceID = RG.GetSourceID();

  if( RG.LoadFromDB( RecordID ) != true )
     Comment = "Ошибка при загрузке параметров внебиржевой сделки ФИССиКО из шлюза." + RG.GetLastError();
     return 1;
  end;

   if( (SourceID == GT_VR) or (SourceID == GT_PAYMENTS_VR) )
     if( (GetParmByName( RG, "RGDV_PROGNOS", @StrTempParm, @type ) == NULL) OR (type != V_STRING) )
     else
         if(StrTempParm == "D")
            // найти и удалить сделку с CODE из RGDVNDL_CODE
            if( (GetParmByName( RG, "RGDVNDL_CODE", @DealCode, @type ) == NULL) OR (type != V_STRING) or (DealCode=="") )
               SetError( "Не найден либо неверно задан номер сделки для удаления (параметр RGDVNDL_CODE " + " объекта " + String(RecordID) + ")");
            end;
            stat = DV_DeleteNDeal(DealCode);
            if(stat != 0)
               SetError("Ошибка при удалении сделки с номером " + DealCode + ". " + GetErrMsg());
            end;
            Comment = "Внимание! Удалена сделка " + DealCode + " клиента <clentcode>, которая не подтвердилась биржевым файлом.";
            // return 0;
         end;
     end;
   end;

//   ID  = string( dvndeal.rec.ID );
//   Comment = "В ФИССиКО создана внебиржевая сделка № " + dvndeal.rec.Code + ". DealID = " + dvndeal.rec.ID + ".";

  return 0;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = ErrorText;
   else
      Comment = RslErrObj.Message;
   end;
   return 1;
end;

/*загружаем справедливую стоимость внебиржевой сделки*/
macro _DVnDealFairVal_CreateNew( RecordID:INTEGER, SeanceID:INTEGER, ID:@STRING, Comment:@STRING, DvnDealID :INTEGER ):INTEGER

  record fininstr(fininstr);
  var FairVal = TRecHandler("DVNFRVAL");
  var dvndeal = TRecHandler("dvndeal.dbt");
  var nFI = TRecHandler("dvnfi");
  var koper    = TBFile( "oprkoper", "R", 0 );
  var ExtCode:string = "", Kind:integer = 0, vDate:date = date(0,0,0), Amount:money = $0.0, 
      OperName:string = "", type;
  var Sql, DataSql;
  var RG, ErrMsg = "";
  var Curr;

  RG = TGTRecord();
  RG.LoadFromDB(RecordID);

  if( RG == NULL )
     Comment = "Ошибка при создании объекта TGTRecord.";
     return 1;
  end;

  if( RG.LoadFromDB( RecordID ) != true )
     Comment = "Ошибка при загрузке параметров cправедливой стоимости внебиржевой ЦК из шлюза." + RG.GetLastError();
     return 1;
  end;

  if( (GetParmByName( RG, "RGDVNDL_EXTCODE", @ExtCode, @type ) == NULL) OR (type != V_STRING) )
     SetError( "Не найден либо неверно задан внешний код сделки (параметр RGDVNDL_EXTCODE " + " объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG,"RGDVNDL_KIND", @Kind, @type)  == NULL) OR (type != V_INTEGER) )
     SetError( "Не найден либо неверно задан вид сделки (параметр RGDVNDL_KIND " + " объекта " + String(RecordID) + ")");
  else
     koper.Clear();
     koper.rec.Kind_Operation = Kind;

     if( koper.GetEQ() )
        if( (koper.rec.DocKind != DL_DVNDEAL) and (koper.rec.DocKind != DL_DVDEALT3) )
           SetError( "Операция " +  string(Kind) + " не является сделкой ФИССиКО." );
        end;
        OperName = koper.rec.Name;
     else
        SetError( "Не найден вид операции " + string(Kind) + " (параметр " + "RGDVNDL_KIND" + " объекта " + String(RecordID) + ")");
     end;
  end;

  if( (GetParmByName( RG, "RGDVNDL_FAIRVAL_DATE", @vDate, @type ) == NULL) OR (type != V_DATE) )
     SetError( "Не найдена либо неверно задана дата (параметр RGDVNDL_FAIRVAL_DATE объекта " + String(RecordID) + ")");
  end;

  if( (GetParmByName( RG,"RGDVNDL_FAIRVAL_AMOUNT", @Amount, @type)  == NULL) OR (type != V_MONEY) )
     SetError( "Не найдена либо неверно задана сумма справедливой стоимости по сделке (параметр " + "RGDVNDL_FAIRVAL_AMOUNT" + " объекта " + String(RecordID) + ")");
  end;
                                    
    /*ищем сделку по внешнему коду*/
    Sql = RSDCommand(" select deal.* " +
                     "   from ddvndeal_dbt deal " +
                     "  where deal.t_Kind = ? " +
                     "    and deal.t_DocKind = ? " +
                     "    and deal.t_ExtCode = ? " +
                     "    and deal.t_State != ? "
                    );
    
    sql.addParam( "", RSDBP_IN, Kind );
    sql.addParam( "", RSDBP_IN, DL_DVNDEAL );
    sql.addParam( "", RSDBP_IN, ExtCode );
    sql.addParam( "", RSDBP_IN, DVDEAL_CLOSE);
    
    sql.execute();
    
    DataSql = TRsbDataSet( sql );
    
    if( DataSql.MoveNext() )
       DataSql.GetRecord().CopyTo( dvndeal.rec );
    else
       SetError( "В ФИССиКО не найдена сделка вида \""+OperName+"\" с внешним кодом, равным \""+ExtCode+"\", объекта " + String(RecordID));
    end;

    if( dvndeal.rec.ID > 0)
      if( FindDVNFI(dvndeal.rec.ID, DV_NFIType_BaseActiv, nFI) != 0 )
       SetError( "Не найден актив внебиржевой операции \""+OperName+" (DealID = " + string(dvndeal.rec.ID) + ", Type = " + string(DV_NFIType_BaseActiv) + ")  объекта " + String(RecordID));
      end;
    end;

    if(Amount == 0)
        ID  = 0;
        Comment = "По сделке \"" + dvndeal.rec.ExtCode + "\" передано нулевое значение справедливой стоимости.";
        return 0;
    end;

  
  FairVal.Clear();
  FairVal.rec.ID      = 0;
  FairVal.rec.DealID  = dvndeal.rec.ID;
  FairVal.rec.DocKind = dvndeal.rec.DocKind;
  FairVal.rec.Date    = vDate;
  FairVal.rec.FairValue = Amount;
  FairVal.rec.FairValueAlg = nFI.rec.FairValueAlg;
  if( RG.GetSourceID == GT_SPFI )
     if( (GetParmByName( RG, "RGDVNDL_FAIRVAL_CURR", @Curr, @type )  == NULL) OR (type != V_STRING) OR (Curr == "") )
        SetError( "Не задана валюта для справедливой стоимости для сделки с кодом \"" +dvndeal.rec.Code+"\" объекта " + String(RecordID)+". "+GetErrMsg() );
     else
        var ErrMes = "";
        var FIID = 0;

        if( GetRealID( RG_CURRENCY, Curr, FICK_MICEX, @FIID, @ErrMes ) != 0 )
           SetError( ErrMes );
        end;
        if(FIID != NATCUR)
           SetError( "Неверная валюта для справедливой стоимости для сделки с кодом \""+dvndeal.rec.Code+"\" объекта " + String(RecordID)+". "+GetErrMsg() );
        end;
     end;
  end;
  
  if( DV_InsertStepFairVal(FairVal) != 0 )
     SetError( "Ошибка при вставке записи справедливой стоимости сделки с кодом \""+dvndeal.rec.Code+"\" объекта " + String(RecordID)+". "+GetErrMsg());
  end;

  ID  = string( FairVal.rec.DealID );
  Comment = "В ФИССиКО загружена запись справедливой стоимости для внебиржевой сделки с внешним кодом \"" + dvndeal.rec.ExtCode + "\".";

  return 0;

OnError( RslErrObj )
   if( ErrorText != "" )
      Comment = ErrorText;
   else
      Comment = RslErrObj.Message;
   end;
   return 1;
end;