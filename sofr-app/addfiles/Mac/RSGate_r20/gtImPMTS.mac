/*
$Name:        gtImPMTS.mac
$Module:      Шлюз Securities
$Description: Онлайн-импорт сделок из Шлюза Московской биржи 
*/

IMPORT "secinter.mac", "gtmktrep.mac", "gtImPMTS_DL.mac", "loadRUData.mac";

PRIVATE CONST USE_STORPROC_CREATEREPL:bool = true; //Использовать ХП для создания объектов записей репликаций

PRIVATE CONST PNFLD_IMPDATE         = 0,
              PNFLD_REQUEST         = 1, 
              PNFLD_SECUR           = 2, 
              PNFLD_CLEARING        = 3, 
              PNFLD_SEC_BO          = 4,
              PNFLD_SEC_SEB         = 5,
              PNFLD_REQUEST_OTC     = 6, 
              PNFLD_SECUR_OTC       = 7,
              PNFLD_NETTOITOG       = 8,
              PNFLD_KSUWRT          = 9;

PRIVATE VAR NumImportDeals:integer = 0, NumImportDealsTotal:integer = 0;
PRIVATE VAR calendId_Nat = 0, calendId_ = 0, MarketID = 0, CPFirmId = -1, CurrencyId = -1, calendId = -1, Portfolio_ = -1;
PRIVATE VAR ClientID = 0, ClientContrID = 0, MarketSchemeID = 0;
PRIVATE VAR CPFirmIdConst = "";
PRIVATE VAR PaymDate1_ = date(0,0,0), PaymDate2_ = date(0,0,0), CalcItogDate_ = date(0,0,0), WorkSettleDate_ = date(0,0,0);
PRIVATE VAR NDay1_:integer = 0, NDay2_:integer = 0;
PRIVATE VAR Progress = TProgressBar;
private var RECORDID_MarketReport:integer = 0, RecordID_Request:integer = 0, RecordID_Deals:integer = 0;

private const IsRSHB = 1;

PRIVATE MACRO PortfPriorityOrDefault(avr, OnDate:date):INTEGER
  var ValidFromDate = DATE(0,0,0);
  var AttrID = 0;
  var PortfID = -1;
  var Val_Set = -1;
  if  ( (GetMainObjAttr( null, OBJTYPE_AVOIRISS, UniID(avr, OBJTYPE_AVOIRISS), 61/*Приоритетный портфель*/, AttrID, null, null, OnDate, ValidFromDate) == true)
          AND (ValidFromDate <= OnDate) )
    if(AttrID == 1)
       PortfID = KINDPORT_RETIRE;
    elif(AttrID == 2)
       PortfID = KINDPORT_TRADE;
    elif(AttrID == 3)
       PortfID = KINDPORT_SALE;
    end;
  else
    PortfID = -1;
  end;

  if(not(PortfID > 0))
    GetRegistryValue("SECUR\\МСФО\\ПОРТФЕЛЬ ПО УМОЛЧАНИЮ", V_INTEGER, Val_Set);
    if( Val_Set == 0)
      PortfID = KINDPORT_TRADE;
    else
      PortfID = KINDPORT_SALE;
    end;
  end;

  return PortfID;
END;

private record pp(IMP_PMTS, "rgate.lbr") dialog;
private class DataReq()
  var BuySell   :string,
      EntryTime :time,
      AmendTime :time,
      Status    :string,
      BrokerRef :string,
      ClientCode:string,
      vClientCode:string,
      OrderNo   :string,
      TradeDate :date,
      TradeSessionDate:date,
      RepoRate  :double,
      RecNo     :integer,
      SecurityId:string,
      Quantity  :money,
      Price     :double,
      PriceType :string,
      CurrencyId:string,
      TrdAccId  :string,
      RepoValue :money,
      IsTrust   :bool,
      IsSEB     :bool,
      OrdTypeCode:string,
      SessionNo :integer,    
      PartyId   :integer,    
      SfcontrID :integer,
      IsUnderWr :bool;    

  macro Init()
      BuySell   = Status    = BrokerRef = OrderNo = SecurityId = ClientCode = vClientCode = PriceType = CurrencyId = TrdAccId = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = SessionNo = 0;
      RepoRate  = Price = 0.0;
      TradeDate = TradeSessionDate = date(0,0,0);
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = IsUnderWr = false;
  end;

  macro InitRecords()
      BuySell   = Status    = BrokerRef = OrderNo = SecurityId = ClientCode = vClientCode = PriceType = CurrencyId = TrdAccId = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = SessionNo = 0;
      RepoRate  = Price = 0.0;
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = IsUnderWr = false;
  end;

end;

var Req = DataReq();

// перенесено из пользовательских доработок
/* получаем Код информации Трейдера */
private macro GetRefNote(ClientCodeInFile:string)
  var ClientCodeBegPos = 0, RefCode = "";  
  if( (ClientCodeInFile != "") AND (ClientCodeInFile != " ") )
     ClientCodeBegPos = Index( ClientCodeInFile, "/");
     if( ClientCodeBegPos != 0 ) 
        ClientCodeBegPos = ClientCodeBegPos + 1;
        RefCode = SubStr( ClientCodeInFile, ClientCodeBegPos);
     else
        RefCode = ClientCodeInFile;
     end; 
  else
     RefCode = "";
  end;
  return RefCode;
end;

private macro GetRefNotePortf(ClientCodeInFile:string)
   var ClientCodeBegPos = 0, RefCode = "";  
   if( (ClientCodeInFile != "") AND (ClientCodeInFile != " ") )
      ClientCodeBegPos = Index( ClientCodeInFile, "_");
      if( ClientCodeBegPos != 0 ) 
         ClientCodeBegPos = ClientCodeBegPos + 1;
         RefCode = SubStr( ClientCodeInFile, ClientCodeBegPos);
      else
         RefCode = "";
      end; 
   else
      RefCode = "";
   end;
   return RefCode;
end;

PRIVATE MACRO GetClientCode_Req(BrokerRef:string):STRING
  var ClientCode = "", ClientCodeEndPos = 0;

  ClientCode = BrokerRef;
  if( ClientCode != "" )
     ClientCodeEndPos = Index( ClientCode, "/" );
     if( ClientCodeEndPos != 0 ) 
        ClientCode = SubStr( ClientCode, 1, ClientCodeEndPos-1 );
     else
        ClientCode = "";
     end; 
  end;
  return ClientCode;
END;


/* получение данных о заявке */
PRIVATE MACRO PutRequestInfo()
   VAR ClientID = 0, ClientContrID = 0;
   VAR ErrStr = "";

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;
   ClientContrID = Req.SfContrID;
   ClientID = Req.PartyID;

   RG.InitB(SeanceID,
            NULL,
            RG_REQUEST,
            String("Заявка на сделку №" + Req.OrderNo),
            Создать,
            NULL,
            NULL,
            ClientID
           );

/*
   if(NOT RG.InitByCode(RG_REQUEST, Req.OrderNo, SOURCE_CODE))
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;
*/

   if(NOT RG.InitWithoutCheck(RG_REQUEST, Req.OrderNo, SOURCE_CODE))
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Req.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLRQ_KIND",       350/*DOCKIND_REQ_CLIENT_DEAL*/);
   RG.SetParmByName("RGDLRQ_CODE",       Req.OrderNo);
   RG.SetParmByName("RGDLRQ_CODETS",     Req.OrderNo);
   RG.SetParmByName("RGDLRQ_DATE",       Req.TradeDate);
   if((Req.TradeSessionDate != date(0,0,0)) and (Req.TradeSessionDate != Req.TradeDate))
      RG.SetParmByName("RGDLRQ_SESSIONDATE", Req.TradeSessionDate);         
   end;
   RG.SetParmByName("RGDLRQ_TIME",       Req.EntryTime);
   RG.SetParmByName("RGDLRQ_PARTY",      MMVB_Code);
   RG.SetParmByName("RGDLRQ_BUYSALE",    Req.BuySell);
   RG.SetParmByName("RGDLRQ_FIID",       Req.SecurityId); 
   RG.SetParmByName("RGDLRQ_AMOUNT",     Req.Quantity);
   RG.SetParmByName("RGDLRQ_PRICE",      Req.Price);
   RG.SetParmByName("RGDLRQ_REPORATE",   Req.RepoRate);
   RG.SetParmByName("RGDLRQ_STATUS",     Req.Status);
   RG.SetParmByName("RGDLRQ_PRICETYPE",  Req.PriceType);
   RG.SetParmByName("RGDLRQ_CURRENCYID", Req.CurrencyId);
   RG.SetParmByName("RGDLRQ_PRICEFIID",  Req.CurrencyId); // валюта цены = валюте расчетов
   RG.SetParmByName("RGDLRQ_ORDTYPECODE",Req.OrdTypeCode);
   RG.SetParmByName("RGDLRQ_GRNDNUM",    ""+Req.SessionNo+Req.RecNo);
   RG.SetParmByName("RGDLRQ_CLIENT",     Req.vClientCode);

   var TraderCode:string = "";
   TraderCode = GetRefNote(Req.BrokerRef);
   if(TraderCode == "spec")
      TraderCode = "";
   end;
   RG.SetParmByName("RGDLRQ_TRADERCODE", TraderCode);


   if( Req.BrokerRef != "" )
      RG.SetParmByName("RGDLRQ_BROKERREF", Req.BrokerRef);
   end;

   RG.SetParmByName("RGDLRQ_TRDACCID",   Req.TrdAccID);
   if(Req.IsUnderWr)
      RG.SetParmByName("RGDLRQ_UNDERWR", SET_CHAR);
   end;

   RG.Save();
   SetErrAfterLoad();

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

Private macro ЭтоКСУ( SecurityType:string )
   return ( (StrLwr(SecurityType) == "ксу") or (StrLwr(SecurityType) == "Єбг") );
end;

// предварительно определить некоторые параметры сделки (нужно для определения сделок СЭБ)
Private macro SetPartPrmDeal_PM()
   if(Deals.IsREPO)
      if( Deals.IsCliring )
         if( Deals.RepoPart == 1 )
            Deals.GateDealType = "R" + Deals.BuySell;
         else
            if( Deals.BuySell == "B" )
               Deals.GateDealType = "RS";
            else
               Deals.GateDealType = "RB";
            end;
         end;
      else
         Deals.GateDealType = "R" + Deals.BuySell;
      end;

      if( ЭтоКСУ(Deals.SecurityType) )/*для РЕПО с КСУ*/
         Deals.GateDealType = Deals.GateDealType + "G";
      end;

   else
      Deals.GateDealType = Deals.BuySell;
   end;
end;

private macro PutMarketReport()
   if( (Deals.DOC_NO == "") OR (WriteMarketReport( SeanceID, NULL, SOURCE_CODE, @MarketReportID, @ErrMes, null, Deals.DOC_NO, imp_date, MMVB_Code ) == false) )
      AbortTrn;
   end; 
end;

private macro IsFitDeal(IsTrust, IsSEB)
   if( (pp.deals_bo == SET_CHAR) and (not IsTrust) and (not IsSEB))
      return true;
   elif( (pp.deals_seb == SET_CHAR) and IsSEB )
      return true;
   end;
   return false;
end;

macro UpdateFIID(Table:string, ErrMes:@string) :integer
  var cmd, cmdUpd, DataSet;
  var fin = null;
  var ISIN:string = "";
  var FIID = -1;
  var IsSeb:integer = 0;
  var error = "";

  cmd = RSDCommand("SELECT DISTINCT t.t_SecurityId SecurityId FROM " + Table + " t ");

  DataSet = TRsbDataSet(cmd);
  while(DataSet.moveNext() AND DataSet.SecurityId != "")
    IsSeb = 0;
    FIID = -1;
    ISIN = DataSet.SecurityId;

    fin = RG_FindFinInAbs(ISIN, Код_на_ММВБ_ФинИн);
    if (fin == null)
      //пробуем загрузить в АБС бумагу из RUDATA. После загрузки, повторяем поиск fininstr
      if (not SOFR_LoadRuDataByCode( ISIN, 1, "ММВБ", @error, true))
        SOFR_LoadRuDataByID( ISIN, 1,  @error, null, true);
      end;
      fin = RG_FindFinInAbs(ISIN, Код_на_ММВБ_ФинИн);
    end;

    if(fin != null)
      FIID = fin.rec.FIID;
      if (fin.rec.Issuer == {OurBank})
        IsSeb = 1;
      end;
    end;

    if(IsSeb == 1)
      cmdUpd = RSDCommand("UPDATE " + Table + " t "+
                            " SET t.T_IsSeb = (CASE WHEN t.t_IsREPO = 0 and t.t_vClientCode = CHR(1) and t.t_BuySell IN ('B', 'S') "
                                                  " THEN 1 "+
                                                  " ELSE 0 "+
                                              " END), "+
                                " t.t_FIID = ? "+
                           "WHERE t.T_SecurityId = ? ");
      cmdUpd.addParam("", RSDBP_IN, FIID);
      cmdUpd.addParam("", RSDBP_IN, ISIN);
      cmdUpd.execute();
    else
      cmdUpd = RSDCommand(" UPDATE " + Table + " t Set t.t_FIID = ? WHERE t.T_SecurityId = ?" );
      cmdUpd.addParam("", RSDBP_IN, FIID);
      cmdUpd.addParam("", RSDBP_IN, ISIN);
      cmdUpd.execute();
    end;
  end;

  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DeleteIfNotIsFitDeal(Table:string, Pan:variant, ErrMes:@string) :integer
  var cmd;
  cmd = RSDCommand( 
             " DELETE FROM " + Table + " Tb "+
              " WHERE (CASE WHEN (" + RG_IIF(Pan.deals_bo == SET_CHAR, 1, 0) + " = 1 AND NVL(Tb.t_IsSEB, 0) = 0) "+
                                " OR (" + RG_IIF(Pan.deals_seb == SET_CHAR, 1, 0) + " = 1 AND NVL(Tb.t_IsSEB, 0) = 1) "+
                          " THEN 1 "+
                          " ELSE 0 "+
                      " END) = 0 "+
                 " OR SUBSTR(Tb.t_TrdAccId, 1, 1) = 'D' "
                  );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro ДнейВГоду( YYYY:INTEGER ):INTEGER
   return DATE( 31,12,YYYY )-DATE( 1,1,YYYY )+1;
end;

PRIVATE MACRO IsCliringData():BOOL

  if( FileImport != FileEQM06 )
     return false;
  end;

  if(    ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи

      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 

      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО  
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 
    )
     return true;
  end;

  return false;
END;

private macro НайтиДанныеПо2Части( SettleDate:date, SettleDate2:date, Amount:money, Amount2:money, RepoRate:@double)
   var i:integer = 0, N:double = 1.0;
   var YYYY_beg, YYYY_end, YYYY_cur;
   RepoRate = 0.0;
   if(SettleDate != SettleDate2)
      datesplit( SettleDate, NULL, NULL, YYYY_beg );
      datesplit( SettleDate2, NULL, NULL, YYYY_end );
      if(YYYY_beg == YYYY_end)
         N = double(SettleDate2 - SettleDate) / double(ДнейВГоду(YYYY_beg));
      else
         YYYY_cur = YYYY_beg + 1;
         N = double(DATE(1,1,YYYY_cur) - SettleDate) / double(ДнейВГоду(YYYY_beg));
         while(YYYY_cur < YYYY_end)
            N = N + 1;
            YYYY_cur = YYYY_cur + 1;
         end;
         N = N + double(SettleDate2 - DATE(1,1,YYYY_cur)) / double(ДнейВГоду(YYYY_end));
      end;
   end;
   if((Amount * N) != 0.0)
      RepoRate = round(((Amount2 - Amount) / (Amount * N)) * 100, 4);
   end;
end;

/* заполнение и сохранение сделки */
macro PutDealInfoPM()

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   var IsTODAY:bool = false;
   var DealTypeID:integer = -1, NumDaysBeforePaym:integer = 0;
   var Portfolio = KINDPORT_UNDEF, DealDate = date(0,0,0), CommDate = date(0,0,0);
   var ErrStr = "", UINNumber = GetUINNumber();

   /* дата сделки */
   if(Deals.TradeDate == date(0,0,0))
      DealDate = imp_date;
   else
      DealDate = Deals.TradeDate;
   end;

   RG.InitB(SeanceID,
            NULL,
            RG_IIF( Deals.IsCliring == true, RG_CLEARING/*клиринг*/, RG_SECURDEAL ),
            RG_IIF(Deals.IsCliring == true, "Клиринг. ", "") + String("Сделка на ММВБ №" + UINNumber),
            Создать,
            NULL,
            NULL,
            ClientID
           );

   if(NOT RG.InitWithoutCheck(RG_IIF( Deals.IsCliring == true, RG_CLEARING/*клиринг*/, RG_SECURDEAL ), string(UINNumber+RG_IIF( Deals.IsCliring == true, "_c"+string(Deals.RepoPart), "" )), SOURCE_CODE) )
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

   if( strlen(trim(string(Deals.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLTC_ISIN", Deals.SecurityId);

   RG.SetParmByName("RGDLTC_DEALCODETS", Deals.TradeNo);

   RG.SetParmByName("RGDLTC_DEALTIME",   Deals.TradeTime);
   
   if( Deals.IsCliring and IMPORT_SETTLETIME() and (Deals.SettleTime != Time(0, 0, 0)) )
      RG.SetParmByName("RGDLLG_SUPTIME_01", Deals.SettleTime);
      RG.SetParmByName("RGDLLG_SUPTIME_02", Deals.SettleTime);
   else
      RG.SetParmByName("RGDLLG_SUPTIME_01", Deals.TradeTime);
      RG.SetParmByName("RGDLLG_SUPTIME_02", Deals.TradeTime);
   end;

   if(deals.vClientCode != "")
      /* по единому краткому коду клиента из ДБО находим клиента */
      RG.SetParmByName("RGDLTC_CLIENT", deals.vClientCode);
   end;

   if(deals.BrokerRef != "")
      RG.SetParmByName("RGDLTC_BROKERREF", deals.BrokerRef);
   end;

   IsTODAY = (Deals.TradeDate == Deals.SettleDate);
   if( ПолучитьВидОперацииБОЦБ( "B", Deals.GateDealType, @DealTypeID, @ErrMes, Deals.IsTrust, IsTODAY, Deals.IsSEB, Deals.UnderWr, Deals.UnderWr_Pokupka ) != 0 )
      Exit();
   end;

   Var RefNote = "", RefNotePortf = "";
   RefNote = GetRefNote(Deals.BrokerRef);
   RefNotePortf = GetRefNotePortf(RefNote);
   If(RefNote != "")
      RG.SetParmByName("RGDLTC_NOTEVAL1", RefNote);
      if( (FileImport == FileSEM03) and (deals.vClientCode != "") )
         RG.SetParmByName("RGDLTC_TRADERCODE", RefNote);
      end;
   end;

   if( ((FileImport == FileSEM03) ) AND (not Deals.IsREPO) and (not Deals.IsSEB) )
      if( Portfolio_ != KINDPORT_UNDEF )
         RG.SetParmByName( "RGDLTC_PORTFOLIO", Portfolio_ );
      end;
   end;

   RG.SetParmByName("RGDLTC_DEALTYPE", DealTypeID );

   RG.SetParmByName("RGDLTC_PRICE",   Deals.Price);
   RG.SetParmByName("RGDLTC_NUMLOTS", Deals.Quantity);

   if(Deals.IsREPO)
      RG.SetParmByName("RGDLLG_PRICE_02",   Deals.Price2  ); /* цена по 2-ой части */
      RG.SetParmByName("RGDLTC_INCOMERATE", Deals.RepoRate); /* ставка Репо */
   end;

   /* цена в процентах */
   var Relativ:string = "";
   if( StrUpr(Deals.PriceType) == "PERC" )
      Relativ = SET_CHAR;
   else
      Relativ = UNSET_CHAR;
   end;

   RG.SetParmByName("RGDLLG_RELATIVEPRICE_01", Relativ);
   if(Deals.IsREPO)
      RG.SetParmByName("RGDLLG_RELATIVEPRICE_02", Relativ);
   end;

   /* НКД - для купонной ценной бумаги */
   RG.SetParmByName("RGDLLG_NKD_01", Round( Deals.AccInt, 2) );

   /* сумма сделки без НКД */
   RG.SetParmByName("RGDLLG_COST_01", Round( Deals.Value_, 2) );

   /* общая сумма сделки */
   RG.SetParmByName("RGDLLG_TOTALCOST_01", Round(Deals.Amount,2) );

   if(Deals.BuySell == "B")
      RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CAi), SET_CHAR);
   else
      RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CAi), UNSET_CHAR);
   end;

   if(Deals.IsREPO)
      if(Deals.BuySell == "B")
         RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CRi), UNSET_CHAR);
      else
         RG.SetParmByName(GetParmName( "RGDLPM_ISFIXAMOUNT", CRi), SET_CHAR);
      end;
   end;

   /* номер договора с клиентом */
   RG.SetParmByName( "RGDLTC_CONTRID", "");

   RG.SetParmByName("RGDLTC_DEALCODE", UINNumber);

   /* код расчетов */
   RG.SetParmByName("RGDLTC_PCODE", Deals.SettleCode);

   /* признак ОРЦБ */
   RG.SetParmByName("RGDLTC_USERFLAG1", SET_CHAR);

   RG.SetParmByName( "RGDLTC_USERFLAG3", SET_CHAR);

   /*Вид заявки в соответствии с правилами торгов*/
   RG.SetParmByName("RGDLTC_ORDTYPECODE", Deals.OrdTypeCode);

   /* тип сделки на ММВБ */
   if((FileImport == FileSEM03) or (FileImport == FileASTS))
      RG.SetParmByName("RGDLTC_KIND", Deals.TradeType);
   else
      if(Deals.IsREPO)
         RG.SetParmByName("RGDLTC_KIND", "R");
      else
         RG.SetParmByName("RGDLTC_KIND", "T");
      end;
   end;

   RG.SetParmByName("RGDLTC_BOARDID", Deals.BoardID);
   if( FileImport == FileSEM03 )
      RG.SetParmByName("RGDLTC_BOARDTYPE", Deals.BoardType);
   end;

   /* комиссия биржи */
   /* Все три биржевые комиссии в импортированной сделке обрабатываются одной суммой - это правильно*/
   if( not Deals.IsCliring )
      RG.SetParmByName("RGDLTC_AMOUNT_COMM", Deals.ExhComm );
      RG.SetParmByName("RGDLTC_CLRCOMM", Deals.ClrComm );
   else // Deals.IsCliring == true
      RG.SetParmByName("RGDLTC_REPOPART", Deals.RepoPart);
      RG.SetParmByName("RGDLTC_BUYSELL", Deals.BuySell);
      RG.SetParmByName("RGDLTC_CLIRINGTIME", Deals.SettleTime);
      RG.SetParmByName("RGDLTC_SESSION", Deals.Session);
      RG.SetParmByName("RGDLTC_EXTSETTLECODE", Deals.ExtSettleCode);
   end;

   /* дата сделки */
   RG.SetParmByName("RGDLTC_DEALDATE", DealDate);

   if(Deals.CPFirmId != "")
      RG.SetParmByName("RGDLTC_PARTY", Deals.CPFirmId);
   else
      /*для СделкаToday (не срочных и не РЕПО) в качестве контрагента ставим субъекта с принадлежностью 'Центральный контрагент'*/
      if( ( (FileImport == FileSEM03) AND (not Deals.IsREPO) AND 
            (Deals.SettleDate == DealDate) AND (DealDate >= date(1,11,2011))
          ) or (FileImport == FileASTS)
        )
          Deals.CPFirmId = CPFirmIdConst;
          RG.SetParmByName("RGDLTC_PARTY", Deals.CPFirmId);
      end;
   end;

   var PaymDate:date = DealDate;
   var NDay:integer = 0;
   var CalcItogDate = date(0,0,0);
   var WorkSettleDate = date(0,0,0);

   RG.SetParmByName("RGDLTC_MARKET", MMVB_Code);
   /* суммы по второй части для РЕПО */
   if(Deals.IsREPO)
      if( Deals.RepoPart != 2 )/*заполним даты исполнения по 1 ч по сделке и по клирингу*/
         NDay = NDay1_;
         PaymDate = PaymDate1_;

         if( Deals.IsCliring == true )
            RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
         else
            RG.SetParmByName("RGDLLG_SUPDATE_01", PaymDate);
            RG.SetParmByName("RGDLLG_PAYDATE_01", PaymDate);
         end;
      else/*даты исполнения по 2 ч по клирингу (не по сделке) не заполняем - вычислим при вставке сделки в БОЦБ*/
         RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
      end;
    
      if( not Deals.IsCliring ) /*заполним даты исполнения по 2 ч по сделке(не клиринг)*/
         var IndexYm = Index(StrUpr(Deals.SettleCode),"Y",1);
         var IndexYn = Index(StrUpr(Deals.SettleCode),"Y",IndexYm+1);
         
         if( (IndexYm == 1) and (IndexYn > IndexYm) )/*обрабатываем конструкции вида Y0/Yn, Ym/Yn, Y0/YnW, Y0/YnM*/

            if( (Deals.SettleDate == WorkSettleDate_) and (CalcItogDate_ != Deals.SettleDate) )
               WarnMes = "Срок сделки \""+Deals.TradeNo+"\", определенный параметром SettleDate = "+string(Deals.SettleDate)+", не соответствует коду расчетов \""+string(Deals.SettleCode)+"\" по сделке.";
            elif( (Deals.SettleDate != WorkSettleDate_) and (WorkSettleDate_ != CalcItogDate_) )
               WarnMes = "По сделке \""+Deals.TradeNo+"\", дата SettleDate = "+string(Deals.SettleDate)+", указанная в файле выгрузки, попадает на выходной день. Расчетная дата - "+string(CalcItogDate_)+".";
            end;
       
            NDay = NDay2_;
            PaymDate = Deals.SettleDate;

         elif(Index(StrUpr(Deals.SettleCode),"T0/Y") == 1)/*обрабатываем конструкции вида T0/Yn*/
            NDay = NDay2_;
            PaymDate = PaymDate2_;

            if( (Deals.SettleDate == WorkSettleDate_) and (PaymDate != Deals.SettleDate) )
               WarnMes = "Срок сделки \""+Deals.TradeNo+"\", определенный параметром SettleDate = "+string(Deals.SettleDate)+", не соответствует коду расчетов \""+string(Deals.SettleCode)+"\" по сделке.";
            elif( (Deals.SettleDate != WorkSettleDate_) and (WorkSettleDate_ != PaymDate) )
               WarnMes = "По сделке \""+Deals.TradeNo+"\", дата SettleDate = "+string(Deals.SettleDate)+", указанная в файле выгрузки, попадает на выходной день. Расчетная дата - "+string(PaymDate)+".";
            end;

            PaymDate = Deals.SettleDate;
         else
            PaymDate = PaymDate + Deals.RepoPeriod;
            NDay = NDay1_;
         end;
        
         RG.SetParmByName("RGDLLG_SUPDATE_02", PaymDate);
         RG.SetParmByName("RGDLLG_PAYDATE_02", PaymDate);
      end;

      RG.SetParmByName("RGDLLG_COST_02",      Round( Deals.Value2_, 2 ) );
      RG.SetParmByName("RGDLLG_NKD_02",       Round( Deals.AccInt2, 2 ) );          
      RG.SetParmByName("RGDLLG_TOTALCOST_02", Round( Deals.Amount2, 2 ) );
   else
      RG.SetParmByName("RGDLLG_SUPDATE_01", Deals.SettleDate);
      RG.SetParmByName("RGDLLG_PAYDATE_01", Deals.SettleDate);
      PaymDate = Deals.SettleDate;
      NDay = NDay1_;
      if( Deals.SettleDate != WorkSettleDate_ )
         WarnMes = "По сделке \""+Deals.TradeNo+"\", дата SettleDate = "+string(Deals.SettleDate)+", указанная в файле выгрузки, попадает на выходной день. Расчетная дата - "+string(WorkSettleDate_)+".";
      end;

   end;
      
   if(NDay > 0)
      RG.SetParmByName("RGDLTC_DAYBEFOREEXECUTE", NDay);
   end;   
   
   RG.SetParmByName(GetParmName( "RGDLPM_DATE", BAi),  Deals.SettleDate);

   RG.SetParmByName(GetParmName( "RGDLPM_DATE", CAi ), Deals.SettleDate);

   if(Deals.IsTrust)
      RG.SetParmByName("RGDLTC_MARKETSCHEME", MarketScheme_DU);
   else
      RG.SetParmByName("RGDLTC_MARKETSCHEME", MarketSchemeID);
   end;

   /*идентификатор документа-подтверждения вида "Отчет биржи"*/
   RG.SetParmByName("RGDLTC_MARKETREPORT_ID", MarketReportID);

   /*статус сделки - отложенная*/
   RG.SetParmByName("RGDLTC_DEALSTATUS", DL_PREPARING);

   /* дата комиссии */
   RG.SetParmByName("RGDLTC_DATE_CM",  imp_date);

   RG.SetParmByName("RGDLPM_NUMBPAYMS", 0);

   /* точность цены */
   RG.SetParmByName("RGDLLG_POINT_01", Deals.Decimals);
   RG.SetParmByName("RGDLLG_POINT_02", Deals.Decimals);
   /* торговый счет, в счет которого заключена данная сделка */
   RG.SetParmByName("RGDLTC_TRDACCID", Deals.TrdAccId);

   if(FileImport == FileSEM03)
      RG.SetParmByName("RGDLTC_ORDERNOM", Deals.OrderNo);
      /* поле "ссылка" */
      RG.SetParmByName("RGDLTC_MATCHREF", Deals.MatchRef);
      /* номинальная стоимость одной ценной бумаги */
      RG.SetParmByName("RGDLTC_FACEVALUE", Deals.FaceValue);

      if((Deals.TradeSessionDate != date(0,0,0)) and (Deals.TradeSessionDate != DealDate))
         RG.SetParmByName("RGDLTC_SESSIONDATE", Deals.TradeSessionDate);         
      end;
   end;

   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", BAi ), Deals.CurrencyId);
   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", CAi ), Deals.CurrencyId);
   RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", PM_PURP_AVANCE ), Deals.CurrencyId);
   if(Deals.IsREPO)
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", BRi ), Deals.CurrencyId);
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", CRi ), Deals.CurrencyId);
      RG.SetParmByName( GetParmName( "RGDLPM_PAYFI", PM_PURP_BACK_AVANCE ), Deals.CurrencyId);
   end;

   if( (FileImport == FileSEM03) and (deals.vClientCode != "") and ФормироватьПорученияПриИмпорте(@ErrMes) )
      RG.SetParmByName("RGDLTC_INDOC", Deals.OrderNo);
      /*Дата поручения на сделку*/
      RG.SetParmByName("RGDLTC_INDOCDATE", DealDate);
      /*Время поручения на сделку*/
      RG.SetParmByName("RGDLTC_INDOCTIME", Deals.TradeTime - Time(0,1,0));
   end;

   if( FileImport == FileASTS )
      RG.SetParmByName("RGDLTC_PROGNOS", SET_CHAR);
   end;

   if((FileImport == FileEQM06) and (Deals.UnderWr or Deals.UnderWr_Pokupka))
      RG.SetParmByName("RGDLTC_UNDERWR", SET_CHAR);
   end;

   RG.Save();

   SetErrAfterLoad();

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + 
                      "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError() );
      end;
   end;
end;

private macro UpdateContrSEM03( ConstContr, ErrMes:@string ):integer
   var query, cmd, DataSet, cmdUpd;

   cmdUpd = RSDCommand(" UPDATE D_SEM03_TMP SEM03 SET (SEM03.T_CPFIRMID ) = (SELECT EQM06.T_CPFIRMID FROM D_EQM06_TMP EQM06 WHERE EQM06.t_TradeNO = SEM03.t_TradeNO AND EQM06.t_BuySell = SEM03.t_BuySell AND EQM06.t_vClientCode = SEM03.t_vClientCode) WHERE SEM03.t_TradeType = 'N' "  );
   cmdUpd.execute();

   cmdUpd = RSDCommand(" UPDATE D_SEM03_TMP SEM03 SET (SEM03.T_CPFIRMID ) = ? WHERE SEM03.t_TradeType = 'N' AND SEM03.T_IsREPO = 0 AND SEM03.T_TRADEDATE <> SEM03.T_SETTLEDATE "  );
   cmdUpd.addParam( "", RSDBP_IN, ConstContr );
   cmdUpd.execute();

   return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdateContrEQM06( ConstContr, ErrMes:@string ):integer
   var query, cmd, DataSet, cmdUpd;

   cmdUpd = RSDCommand(" UPDATE D_EQM06_TMP EQM06 SET (EQM06.T_CPFIRMID) = (SELECT DECODE(SEM03.T_CPFIRMID, CHR(1), (CASE WHEN (SEM03.T_IsREPO = 0 AND SEM03.T_TRADEDATE <> SEM03.T_SETTLEDATE) THEN '' ELSE CHR(1) END), SEM03.T_CPFIRMID) FROM D_SEM03_TMP SEM03 WHERE SEM03.t_TradeType = 'N' AND EQM06.t_TradeNO = SEM03.t_TradeNO AND EQM06.t_BuySell = SEM03.t_BuySell AND EQM06.t_vClientCode = SEM03.t_vClientCode) WHERE EQM06.T_CPFIRMID = CHR(1) ");
   cmdUpd.execute();

   return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdateMarketSchemeSEM03( ErrMes:@string ):integer

   var r_dlmarket = TRecHandler("dlmarket.dbt");
   MarketScheme_BO = 0;
   var query, cmd, DataSet;
   var cmdUpd;

   query = " SELECT  distinct t_TrdAccId TrdAccId, decode (t_vclientCode, CHR(1)," + ALG_SP_MONEY_SOURCE_OWN + ", " + ALG_SP_MONEY_SOURCE_CLIENT + ") SP_MONEY FROM D_SEM03_TMP "
          ;
   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext() )
      if( RG_MarketSchemeBySettleCode(MarketID, "", false, @r_dlmarket, DataSet.TrdAccId, DataSet.SP_MONEY ) == true )
        cmdUpd = RSDCommand( " Update D_SEM03_TMP SEM03 Set (SEM03.T_MarketSchemeID ) = (?) WHERE SEM03.t_TrdAccId = ? AND  decode (t_vclientCode, CHR(1)," + ALG_SP_MONEY_SOURCE_OWN + ", " + ALG_SP_MONEY_SOURCE_CLIENT + ") = ? "  );
        cmdUpd.addParam( "", RSDBP_IN, r_dlmarket.rec.ID );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.TrdAccId );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.SP_MONEY );
        cmdUpd.execute();
      end;
   end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdateMarketSchemeEQM3T( ErrMes:@string ):integer

   var r_dlmarket = TRecHandler("dlmarket.dbt");
   MarketScheme_BO = 0;
   var query, cmd, DataSet;
   var cmdUpd;

   query = " SELECT distinct NVL(t_extsettlecode, CHR(1)) extsettlecode, t_TrdAccId TrdAccId FROM D_EQM3T_TMP ";
   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext() )
      if( RG_MarketSchemeBySettleCode(MarketID, DataSet.extsettlecode, false, @r_dlmarket, DataSet.TrdAccId, ALG_SP_MONEY_SOURCE_CLIENT ) == true )
        cmdUpd = RSDCommand( " Update D_EQM3T_TMP EQM3T Set (EQM3T.T_MarketSchemeID ) = (?) WHERE EQM3T.t_extsettlecode = ? AND EQM3T.t_TrdAccId = ? "  );
        cmdUpd.addParam( "", RSDBP_IN, r_dlmarket.rec.ID );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.extsettlecode );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.TrdAccId );
        cmdUpd.execute();
      end;
   end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdateMarketSchemeSEM03eqm( ErrMes:@string ):integer

   var r_dlmarket = TRecHandler("dlmarket.dbt");
   MarketScheme_BO = 0;
   var query, cmd, DataSet;
   var queryUpd, cmdUpd;
            
   query = " SELECT distinct NVL(eqm06.t_extsettlecode, CHR(1)) extsettlecode, sem03.t_TrdAccId TrdAccId, decode (sem03.t_vclientCode, CHR(1)," + ALG_SP_MONEY_SOURCE_OWN + ", " + ALG_SP_MONEY_SOURCE_CLIENT + ") SP_MONEY FROM D_SEM03_TMP sem03 , D_EQM06_TMP eqm06"
         + " WHERE sem03.T_TRADENO = eqm06.T_TRADENO(+)  AND sem03.T_BUYSELL = eqm06.T_BUYSELL(+) AND sem03.T_vCLIENTCODE = eqm06.T_vCLIENTCODE(+) ";
   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext() )
      if( RG_MarketSchemeBySettleCode(MarketID, DataSet.extsettlecode, false, @r_dlmarket, DataSet.TrdAccId, DataSet.SP_MONEY ) == true )
        queryUpd = " Update D_SEM03_TMP SEM03 Set SEM03.T_MarketSchemeID = ? "
                 + " WHERE SEM03.t_TrdAccId = ? AND decode (t_vclientCode, CHR(1)," + ALG_SP_MONEY_SOURCE_OWN + ", " + ALG_SP_MONEY_SOURCE_CLIENT + ") = ? ";        
        if( DataSet.extsettlecode != "" )
           queryUpd = queryUpd + " AND EXISTS (select 1 FROM D_EQM06_TMP eqm06 WHERE sem03.T_TRADENO = eqm06.T_TRADENO AND sem03.T_BUYSELL = eqm06.T_BUYSELL AND sem03.T_vCLIENTCODE = eqm06.T_vCLIENTCODE AND eqm06.t_extsettlecode = ? )"; 
        end;
        cmdUpd = RSDCommand(queryUpd); 

        cmdUpd.addParam( "", RSDBP_IN, r_dlmarket.rec.ID );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.TrdAccId );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.SP_MONEY );
        if( DataSet.extsettlecode != "" )
           cmdUpd.addParam( "", RSDBP_IN, DataSet.extsettlecode );
        end;
        cmdUpd.execute();
      end;
   end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdateMarketSchemeEQM06( ErrMes:@string ):integer

   var r_dlmarket = TRecHandler("dlmarket.dbt");
   MarketScheme_BO = 0;
   var query, cmd, DataSet;
   var cmdUpd;
   query = " SELECT  distinct t_ExtSettleCode ExtSettleCode, t_TrdAccId TrdAccId, decode (t_vClientCode, CHR(1)," + ALG_SP_MONEY_SOURCE_OWN + ", " + ALG_SP_MONEY_SOURCE_CLIENT + ") SP_MONEY FROM D_EQM06_TMP "
          ;
   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext() )
      if( RG_MarketSchemeBySettleCode(MarketID, RG_IIF( IsRSHB == 1,"",DataSet.ExtSettleCode), false, @r_dlmarket, DataSet.TrdAccId, DataSet.SP_MONEY ) == true )
        cmdUpd = RSDCommand( " Update D_EQM06_TMP EQM06 Set EQM06.T_MarketSchemeID = ? WHERE EQM06.t_ExtSettleCode = ? AND  EQM06.t_TrdAccId = ? AND  decode (t_vClientCode, CHR(1)," + ALG_SP_MONEY_SOURCE_OWN + ", " + ALG_SP_MONEY_SOURCE_CLIENT + ") = ? "  );
        cmdUpd.addParam( "", RSDBP_IN, r_dlmarket.rec.ID );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.ExtSettleCode );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.TrdAccId );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.SP_MONEY );
        cmdUpd.execute();
      end;
   end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdateCalendDate( Table, ErrMes:@string ):integer
   var query, cmd, DataSet, cmdUpd;
   var PaymDate1:date = date(0,0,0);
   var PaymDate2:date = date(0,0,0);
   var NDay1:integer = 0;
   var NDay2:integer = 0;
   var CalcItogDate:date = date(0,0,0);
   var WorkSettleDate:date = date(0,0,0);
   query = " SELECT DISTINCT t.T_SETTLECODE SettleCode, "
                          +" t.T_SETTLEDATE SettleDate, "
                          +" t.T_ISREPO IsREPO, "
                          +" t.t_TradeDate TradeDate, "
                          +" t.t_calendId CalendID, "
                          +" t.t_CurId CurID, "
                          +" t.t_CPFIRMPARTYID CPFirmId, "
                          +" t.t_RepoPeriod RepoPeriod"
          +"  FROM " + Table +" t "
          ;

   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext() )
     PaymDate1 = date(0,0,0);
     PaymDate2 = date(0,0,0);
     NDay1 = 0;
     NDay2 = 0;
     CalcItogDate = date(0,0,0);
     WorkSettleDate = date(0,0,0);
     if(DataSet.IsREPO)
        PaymDate1 = Date(DataSet.TradeDate);
        if( Index(StrUpr(DataSet.SettleCode),"Y") == 1 )
           NDay1 = int(SubStr( DataSet.SettleCode, 2 ));
           PaymDate1 = GetDateAfterWorkDays( PaymDate1, NDay1, DataSet.calendId );
        else
           if( DataSet.SettleCode == "S01" )
              PaymDate1 = GetDateAfterWorkDays( PaymDate1, 1, DataSet.calendId );
           elif( DataSet.SettleCode == "S02" )
              PaymDate1 = GetDateAfterWorkDays( PaymDate1, 2, DataSet.calendId );
           end;
        end;
   
// условие на клиринг      
        var IndexYm:integer = Index(StrUpr(DataSet.SettleCode),"Y",1);
        var IndexYn:integer = Index(StrUpr(DataSet.SettleCode),"Y",IndexYm+1);
        
        if( (IndexYm == 1) and (IndexYn > IndexYm) )/*обрабатываем конструкции вида Y0/Yn, Ym/Yn, Y0/YnW, Y0/YnM*/
   
           var IndexW = Index(StrUpr(DataSet.SettleCode),"W");
           var IndexM = Index(StrUpr(DataSet.SettleCode),"M");
   
           if( IndexW > 0 )
              NDay2 = 7*(int(SubStr( DataSet.SettleCode, IndexYn+1, IndexW - (IndexYn+1) )));
              PaymDate2 = DateAfterCalenDays(PaymDate1, NDay2);
           elif( IndexM > 0 )
              NDay2 = int(SubStr( DataSet.SettleCode, IndexYn+1, IndexM - (IndexYn+1) ));
              PaymDate2 = DateAfterCalenMonths(PaymDate1, NDay2);
           else
              NDay2 = int(SubStr( DataSet.SettleCode, IndexYn+1 ));
              PaymDate2 = GetDateAfterWorkDays( PaymDate1, NDay2, DataSet.calendId );
           end;
   
           CalcItogDate = GetDateAfterWorkDays( PaymDate2, 0, calendId );
           WorkSettleDate = GetDateAfterWorkDays( Date(DataSet.SettleDate), 0, DataSet.calendId );
   
        elif(Index(StrUpr(DataSet.SettleCode),"T0/Y") == 1)/*обрабатываем конструкции вида T0/Yn*/
           NDay2 = int(SubStr( DataSet.SettleCode, 5 ));
           PaymDate2 = GetDateAfterWorkDays( PaymDate1, NDay2, DataSet.calendId );
   
           WorkSettleDate = GetDateAfterWorkDays( date(DataSet.SettleDate), 0, DataSet.calendId );
        else
           PaymDate2 = PaymDate1 + DataSet.RepoPeriod;
        end;
   
     else
   
        PaymDate1 = DataSet.SettleDate;
   
        WorkSettleDate = GetDateAfterWorkDays( Date(DataSet.SettleDate), 0, DataSet.calendId );
        var ndayTaked:bool = false;
        var IdxYn:integer = Index(StrUpr(DataSet.SettleCode),"Y");
        var IdxNn:integer = Index(StrUpr(DataSet.SettleCode),"N");
        var subStrN:string = "";
        if ((IdxYn == 1) or (IdxNn == 1))
           subStrN = SubStr( DataSet.SettleCode, 2);
           if (StrIsNumber(subStrN))
             NDay1 = int(subStrN);
             ndayTaked = true;
           end;
        end;
   
        if (not ndayTaked)
           NDay1 = DL_GetNumWorkDaysForPeriod( Date(DataSet.TradeDate), WorkSettleDate, -1, DataSet.CurID, DataSet.CPFirmId, NULL, DataSet.calendId );
        end;
   
     end;
     cmdUpd = RSDCommand( "UPDATE " + Table + " t Set t.T_Nday1 = ?, t.T_Nday2 = ?, t.T_PaymDate1 = ?, t.T_PaymDate2 = ?, t.T_CalcItogDate = ?, t.T_WorkSettleDate = ? "
                         +" WHERE  t.T_SETTLECODE = ? "
                         +" AND t.T_SETTLEDATE = ? "
                         +" AND t.t_IsREPO = ? "
                         +" AND t.t_TradeDate = ? "
                         +" AND t.t_calendId = ? "
                         +" AND t.t_CurId = ? "
                         +" AND t.t_CPFIRMPARTYID = ? "
                         +" AND t.t_RepoPeriod = ? "
                          );
     cmdUpd.addParam( "", RSDBP_IN, NDay1 );
     cmdUpd.addParam( "", RSDBP_IN, NDay2 );
     cmdUpd.addParam( "", RSDBP_IN, PaymDate1 );
     cmdUpd.addParam( "", RSDBP_IN, PaymDate2 );
     cmdUpd.addParam( "", RSDBP_IN, CalcItogDate );
     cmdUpd.addParam( "", RSDBP_IN, WorkSettleDate );

     cmdUpd.addParam( "", RSDBP_IN, DataSet.SettleCode );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.SettleDate );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.IsRepo );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.TradeDate );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.CalendID );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.CurID );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.CPFirmId );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.RepoPeriod );
     cmdUpd.execute();

  end;

  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdatePortfolio(imp_date, ErrMes:@string ):integer
   var query, cmd, DataSet;
   var cmdUpd;
   var Portfolio:integer = KINDPORT_UNDEF;
   var avr = TRecHandler("avoiriss");

   query = " SELECT DISTINCT DECODE (SEM03.t_vClientCode, CHR(1), 0, 1) IsClient, "
                 +" SEM03.t_FIID FIID "
            +" FROM D_SEM03_TMP SEM03 "
           +" WHERE SEM03.t_IsSeb = 0 " 
             +" AND SEM03.t_IsREPO = 0 " 
                   ;

   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext())
      if( ПолучитьФинИн( DataSet.FIID, NULL, avr, NULL, NULL ) == 0 )
        Portfolio = KINDPORT_UNDEF;
        if( DataSet.IsClient ) /*клиентская*/
           Portfolio = KINDPORT_CLIENT;
        elif( avr.rec.FIID > 0 )
           if( WRTGetPortfolioAmount( -1, avr.rec.FIID, -1, 0, KINDPORT_CONTR, -1, imp_date, true, true, false ) > $0 )
              Portfolio = KINDPORT_CONTR;                                                                         
           else                                                                                                   
              Portfolio =  PortfPriorityOrDefault(avr, imp_date);
           end;                                                                                                   
        end;
        cmdUpd = RSDCommand("UPDATE D_SEM03_TMP SEM03 Set SEM03.T_Portfolio = ? "
                           +" WHERE DECODE (SEM03.t_vClientCode, CHR(1), 0, 1) = ? "
                             +" AND SEM03.t_FIID = ? "
                             +" AND SEM03.t_IsSeb = 0 " 
                             +" AND SEM03.t_IsREPO = 0 " 
                             );
        cmdUpd.addParam( "", RSDBP_IN, Portfolio );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.IsClient );
        cmdUpd.addParam( "", RSDBP_IN, DataSet.FIID );
        cmdUpd.execute();
      end;
  end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro UpdatePortfolioUsr (imp_date, ErrMes:@string ):integer
   var query, cmd, DataSet;
   var cmdUpd;
   var Portfolio:integer = KINDPORT_UNDEF;
   var avr = TRecHandler("avoiriss");
   query = " SELECT DISTINCT DECODE (SEM03.t_vClientCode, CHR(1), 0, 1) IsClient,  "
                 +" SEM03.t_FIID FIID, "
                 +" SEM03.t_BuySell BuySell, "
                 +" NVL ( SUBSTR ( SUBSTR (SEM03.t_BrokerRef, INSTR (SEM03.t_BrokerRef, '/') + 1),INSTR (SUBSTR (SEM03.t_BrokerRef,INSTR (SEM03.t_BrokerRef, '/') + 1),'_') +1 ),CHR (1)) REF"
            +" FROM D_SEM03_TMP SEM03 "
           +" WHERE SEM03.t_IsSeb <> 1 " 
             +" AND SEM03.t_IsREPO = 0 " 
                   ;

   cmd = RSDCommand(query);

   DataSet = TRsbDataSet(cmd);
   while(DataSet.moveNext() )
     avr.clear();
     ПолучитьФинИн( DataSet.FIID, NULL, avr, NULL, NULL );
     Portfolio = KINDPORT_UNDEF;
     Portfolio = GetDealPortfolio(avr.rec,imp_date, DataSet.IsClient == 1, DataSet.Ref, DataSet.BUYSELL );

     cmdUpd = RSDCommand( "UPDATE D_SEM03_TMP SEM03 Set SEM03.T_Portfolio = ? "
                         +" WHERE DECODE (SEM03.t_vClientCode, CHR(1), 0, 1) = ? "
                           +" AND SEM03.t_FIID = ? "
                           +" AND SEM03.t_BuySell = ? "
                           + "AND NVL ( SUBSTR ( SUBSTR (SEM03.t_BrokerRef, INSTR (SEM03.t_BrokerRef, '/') + 1),INSTR (SUBSTR (SEM03.t_BrokerRef,INSTR (SEM03.t_BrokerRef, '/') + 1),'_') +1 ),CHR (1)) = NVL(?, CHR(1)) "
                           +" AND SEM03.t_IsSeb <> 1 " 
                           +" AND SEM03.t_IsREPO = 0 " 
                          );
     cmdUpd.addParam( "", RSDBP_IN, Portfolio );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.IsClient );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.FIID );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.BUYSELL );
     cmdUpd.addParam( "", RSDBP_IN, DataSet.Ref );
     cmdUpd.execute();

  end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateUnderWr(Table, ErrMes:@string):integer
  var cmdUpd;

  if(Table == "D_SEM02_TMP") //Заявки
    cmdUpd = RSDCommand( " UPDATE " + Table + " t SET t_UnderWr = 1 "
                        + " WHERE t.t_SfContrID IN (SELECT sf.t_ID FROM dsfcontr_dbt sf WHERE sf.t_ServKindSub IN (10, 11))");
    cmdUpd.execute();
  else 
    cmdUpd = RSDCommand( " UPDATE " + Table + " t SET t_UnderWr = 1 "
                        + " WHERE t.t_SfContrID IN (SELECT sf.t_ID FROM dsfcontr_dbt sf WHERE sf.t_ServKindSub = 10)");
    cmdUpd.execute();

    cmdUpd = RSDCommand( " UPDATE " + Table + " t SET t_UnderWr_Buy = 1 "
                        + " WHERE t.t_SfContrID IN (SELECT sf.t_ID FROM dsfcontr_dbt sf WHERE sf.t_ServKindSub = 11)");
    cmdUpd.execute();
  end;

  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

//Прочие параметры передаваемые в ХП строкой
private macro GetStorPrPrmStr(Pan:variant) :string
  return "deals_bo=" + RG_IIF(Pan.deals_bo == SET_CHAR, "1", "0") +
         ";deals_seb=" + RG_IIF(Pan.deals_seb == SET_CHAR, "1", "0") +
         ";CPFirmIdConst=" + CPFirmIdConst +
         ";IsRSHB=" + IsRSHB +
         ";MMVB_Code=" + MMVB_Code;
end;

private macro RunImportPMTS( Pan )

  var i:integer = 0, Query, cmd, cmdSP, ds, ASTS_Table = "";
  var NRec:integer = 0, NRecTotal:integer = 0;
  var RetVal = CM_SAVE, stat = 0;
  var oldDoc_NO = "";
  var file_name = "";
  var Synonim = "";
  var NameDate = FileDateInName(Pan.imp_date);
  var PrintOnlyErr = false, IsImportOTC = false;
  var FilesName = "";

  var ReportFileName = "", OldOutPut;
  var Num = 0;
  var hour, min, sec;

  TimeSplit( Time(), hour, min, sec);

  var namef = NameDate + string(Time());
//  ReportFileName = GetTxtFileName( "gtImPMTS_" + NameDate + hour + min + sec);

  var isSem001 = 0, isSem002 = 0, isEqm002 = 0, isEqm003 = 0, isEqm004 = 0;

  RGLog = GTDL_Log(SeanceID);

  if(Pan.imp_date > {curdate})
     if (GetDialogFlag())
        MsgBox ("Неверно задана дата.");
     else
        RGLog.Error("Дата операции больше операционного дня.");
     end;
     RetVal = CM_IGNORE;
  end;
  Synonim = GetShemePathGATE();
  if(Synonim == "")
     if (GetDialogFlag())
        MsgBox ("Не найден схема Payments");
     else
        RGLog.Error("Не найден схема Payments");
     end;
     RetVal = CM_IGNORE;
  end;

  if( RetVal != CM_IGNORE )
     imp_date = Pan.imp_date;
     NumImportDeals = 0;
     NumImportDealsTotal = 0;
     MarketID = RGDLFUN_GetClientID( MMVB_CODE, PTCK_CONTR );

     PrintOnlyErr = ВыводитьВПротоколТолькоОшибки(@ErrMes);
     if( ErrMes != "" )
        RGLog.Error(ErrMes);      
     end;

     if((Pan.request_otc == SET_CHAR) or (Pan.deals_otc == SET_CHAR))
        IsImportOTC = ИмпортироватьСделкиОТС(@ErrMes);
        if( ErrMes != "" )
           RGLog.Error(ErrMes);      
        end;
        if(not IsImportOTC)
           RGLog.Message("ЗАГРУЗКА ВНЕБИРЖЕВЫХ СДЕЛОК ОТС И ЗАЯВОК ПО НИМ ОТКЛЮЧЕНА", null, WARNING);
        end;
     end;

     if (Pan.request == SET_CHAR)  ///SEM02
        stat = 0;
        RG = TGtRecordBatchCharger();
        RGLog.Message("ЗАГРУЗКА ЗАЯВОК НА СДЕЛКИ");
        Progress.Init( 11, "Выполняется обработка данных", "Обработка данных"  );

        if(ReportFileName != "")
          OldOutPut = SetOutput( ReportFileName, TRUE );
        end;

        stat = CheckFileUpload(synonim, "SEM02", pan.imp_date, @ErrMes, " AND ORD_NUM IN (1,2)");

        Message("Очистка таблицы SEM02");
        if(ReportFileName != "")
          println( "Начало очистки таблицы SEM02 " + time() );
        end;
        if( stat == 0 )
          stat = DelSEM02( @ErrMes);
        end;
        if(ReportFileName != "")
          println( "Конец очистки таблицы SEM02 " + time() );
          println( "Начало заполнения SEM02 " + time() );
        end;
        Progress.Use();
        Message("Заполнение таблицы SEM02");
        if( stat == 0 )
          stat = FillSEM02(Synonim, Pan.imp_date, @ErrMes);
        end;
        Progress.Use();

        if(ReportFileName != "")
          println( "Конец заполнения SEM02 " + time() );
          SetOutput( OldOutPut, TRUE );
        end;

        if( stat )
           RGLog.Error(ErrMes);      
        else
           if(MarketID <= 0 )
              ErrMes = ErrMes + "В ГКБО не найден субъект с кодом \"" + MMVB_CODE + "\" вида " + PTCK_CONTR;  
              stat = 1;
           else
              if(ReportFileName != "")
                OldOutPut = SetOutput( ReportFileName, TRUE );
                println( "Начало обновления SEM02 (FIID, IsSEB) " + time() );
              end;

              Message("Обновление данных для SEM02: FIID, IsSEB");
              if(stat == 0)
                stat = UpdateFIID("D_SEM02_TMP", @ErrMes);
              end;
              Progress.Use();
              if(ReportFileName != "")
                println( "Конец обновления SEM02 (FIID, IsSEB) " + time() );
                println( "Начало удаления неподходящих записей по условиям панели SEM02 " + time() );
              end;
              Message("Обновление данных для SEM02: IsFitDeal");
              if( stat == 0 )
                stat = DeleteIfNotIsFitDeal("D_SEM02_TMP", Pan, @ErrMes); //IsFitDeal
              end;
              Progress.Use();

              if(ReportFileName != "")
                println( "Конец удаления неподходящих записей по условиям панели SEM02 " + time() );
                println( "Начало обновления SEM02 (Party) " + time() );
              end;

              Message("Обновление данных для SEM02: Party");
              if( stat == 0)
                stat = UpdateParty(MarketID, "D_SEM02_TMP", Pan.imp_date, @ErrMes);
              end;
              Progress.Use();

              if(ReportFileName != "")
                println( "Конец обновления SEM02 (Party) " + time() );
                println( "Начало обновления SEM02 (UnderWr) " + time() );
              end;

              Message("Обновление данных для SEM02: UnderWr");
              if( stat == 0 )
                stat = UpdateUnderWr("D_SEM02_TMP", @ErrMes);
              end;
              Progress.Use();
              if(ReportFileName != "")
                println( "Конец обновления SEM02 (UnderWr) " + time() );
                println( "Начало обновления объектов SEM02 " + time() );
              end;
              Message("Обновление данных для SEM02: объекты");
              if( stat == 0)
                stat =  UpdateObjSEM02( @ErrMes);
              end;
              Progress.Use();
              if(ReportFileName != "")
                println( "Конец обновления объектов SEM02 " + time() );
                SetOutput( OldOutPut, TRUE );
              end;
           end;

           Req.Init();
           FilesName = "";
           if( stat == 0)
             stat =  GetFileName( synonim, "D_SEM02_TMP", @FilesName, @ErrMes);
           end;

           if( stat )
             RGLog.Error(ErrMes);      
           end;
           RGLog.Message("Используются файлы: \n" + FilesName);
           Message("Обработка данных SEM02");

           if(USE_STORPROC_CREATEREPL)
              //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
              Query = "SELECT 1 FROM D_SEM02_TMP ";
           else
              Query = "SELECT NVL(t.T_TRADEDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) TRADEDATE, " +
                      "       NVL(t.T_TRADESESSIONDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) TRADESESSIONDATE, " +
                      "       NVL(t.T_SESSIONNO, 0) SESSIONNO, " +
                      "       NVL(t.T_STATUS, CHR(1)) STATUS, " +
                      "       NVL(t.T_BUYSELL, CHR(1)) BUYSELL, " +
                      "       NVL(t.T_ENTRYTIME, TO_DATE('01.01.0001', 'DD.MM.YYYY')) ENTRYTIME, " +
                      "       NVL(t.T_AMENDTIME, TO_DATE('01.01.0001', 'DD.MM.YYYY')) AMENDTIME, " +
                      "       NVL(t.T_BROKERREF, CHR(1)) BROKERREF, " +
                      "       NVL(t.T_ORDERNO, CHR(1)) ORDERNO, " +
                      "       NVL(t.T_REPORATE, 0) REPORATE, " +
                      "       NVL(t.T_RECNO, 0) RECNO, " +
                      "       NVL(t.T_SECURITYID, CHR(1)) SECURITYID, " +
                      "       NVL(t.T_QUANTITY, 0) QUANTITY, " +
                      "       NVL(t.T_PRICE, 0) PRICE, " +
                      "       NVL(t.T_CLIENTCODE, CHR(1)) CLIENTCODE, " +
                      "       NVL(t.T_vCLIENTCODE, CHR(1)) vCLIENTCODE, " +
                      "       NVL(t.T_PRICETYPE, CHR(1)) PRICETYPE, " +
                      "       NVL(t.T_CURRENCYID, CHR(1)) CURRENCYID, " +
                      "       NVL(t.T_TRDACCID, CHR(1)) TRDACCID, " +
                      "       NVL(t.T_REPOVALUE, 0) REPOVALUE, " +
                      "       NVL(t.T_IsSEB, 0) ISSEB, " +
                      "       NVL(t.T_PARTYID, 0) PARTYID, " +
                      "       NVL(t.T_SFCONTRID, 0) SFCONTRID, " +
                      "       NVL(t.T_OBJECTID, 0) OBJECTID, " +
                      "       NVL(t.T_ORDTYPECODE, CHR(1)) ORDTYPECODE, " +
                      "       NVL(t.T_FIID, -1) FIID, " +
                      "       NVL(t.T_UNDERWR, 0) UNDERWR " +
                      "  FROM D_SEM02_TMP t" +
                      " ORDER BY T_FILESESSIONNO, T_SESSIONNO, T_RECNO "
                      ;
           end;

           cmd = DL_RSDCommand(Query);
           cmd.AddParam(Pan.imp_date);

           NRec = cmd.GetCount();
           NumImportDeals = NRec; // т.к. наложили фильтр DeleteIfNotIsFitDeal

           if((stat == 0) AND (NRec > 0))
              if(GetDialogFlag())
                 InitProgress(NRec, "Загрузка внешнего файла заявок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ SEM02");
              end;
              if(ReportFileName != "")
                OldOutPut = SetOutput( ReportFileName, TRUE );
                println( "Начало обработки данных из таблицы SEM02 " + time() );
                SetOutput( OldOutPut, TRUE );
              end;

              if(USE_STORPROC_CREATEREPL) // создание объектов записей репликаций через ХП
                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_SEM02(?, ?, ?, ?); END;");
                 cmdSP.addParam("stat", RSDBP_RETVAL, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, imp_date);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.addParam("", RSDBP_IN, GetStorPrPrmStr(Pan)); //прочие параметры
                 cmdSP.Execute();

                 stat = Int(cmdSP.value("stat"));
              else
                 ds = cmd.execute();
                 while(ds.MoveNext)
                    ErrMes = "";
                    WarnMes = "";

                    Req.InitRecords();
                    Req.TradeDate    = ds.TRADEDATE;
                    Req.TradeSessionDate = ds.TRADESESSIONDATE;
                    Req.SessionNo    = ds.SESSIONNO;
                    Req.Status       = ds.STATUS;
                    Req.BuySell      = ds.BUYSELL;
                    Req.EntryTime    = ds.ENTRYTIME;
                    Req.AmendTime    = ds.AMENDTIME;
                    Req.BrokerRef    = ds.BROKERREF;
                    Req.OrderNo      = ds.ORDERNO;
                    Req.RepoRate     = ds.REPORATE;
                    Req.RecNo        = ds.RECNO;
                    Req.SecurityId   = ds.SECURITYID;
                    Req.Quantity     = ds.QUANTITY;
                    Req.Price        = ds.PRICE;
                    Req.ClientCode   = ds.CLIENTCODE;
                    Req.vClientCode  = ds.vCLIENTCODE;
                    Req.PriceType    = ds.PRICETYPE;
                    Req.CurrencyId   = ds.CURRENCYID;
                    Req.TrdAccId     = ds.TRDACCID;
                    Req.RepoValue    = ds.REPOVALUE;
                    Req.OrdTypeCode  = ds.ORDTYPECODE;
                    Req.IsSEB        = ds.IsSeb;
                    Req.PARTYID      = ds.PARTYID;
                    Req.SFCONTRID    = ds.SFCONTRID;
                    Req.IsUnderWr    = RG_IIF(ds.UNDERWR == 0, false, true);

                    if(ds.OBJECTID > 0)
                       ErrMes = "Ошибка при загрузке заявки с кодом \"" + Req.OrderNo + "\"\n" + "Запись репликации с действием создать для объекта " + int(ds.OBJECTID) + " уже передавалась в RS-Bank.""\n Повторная репликация невозможна.""\n";  
                    elif((Req.vClientCode!= "") AND (Req.PARTYID <= 0))
                       ErrMes = "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\n" + "Не найден субъект через краткий код на бирже \"" + Req.vClientCode + "\"";
                    elif((Req.SecurityId != "") AND (Int(ds.FIID) == -1))
                       ErrMes = "Ошибка при загрузке заявки с кодом \"" + Req.OrderNo + "\"\n" + "В справочнике не найден ФИ с кодом \"" + Req.SecurityId + "\"";  
                    end;

                  //if(IsFitDeal(Req.IsTrust, Req.IsSeb) )
                       if(ErrMes == "")
                          if(ProcessTrn(0, "PutRequestInfo"))
                          else
                             RG.UnInit();
                          end;
                       end;
                     //NumImportDeals = NumImportDeals + 1;
                  //end;

                    if(ErrMes != "")
                       RGLog.Error(ErrMes);
                    end;

                    if(WarnMes != "")
                       RGLog.Message(WarnMes);
                    end;

                    i = i + 1;
                    if(GetDialogFlag())
                       UseProgress(i);
                    end;
                    if(FlagCtrlBrk == true)
                       break;
                    end;
                 end;
              end;
              if(GetDialogFlag())
                 RemProgress(); 
              end;
           end;
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Конец обработки данных из таблицы SEM02 " + time() );
           end;
           Progress.Use();
        end;

        if(ReportFileName != "")
          SetOutput( OldOutPut, TRUE );
        end;

        if(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           if((not USE_STORPROC_CREATEREPL) and (not FlagCtrlBrk))
              RG.Transfer();
              SetErrAfterLoad(true);
           end;
           Progress.Use();
           Message("Заполнение протокола");
           /*загрузить в лог инфу о загруженных ЗР*/
           if(USE_STORPROC_CREATEREPL)
             RGLog.GetAndAddReceiveStorPrLog(RG_REQUEST);
           end;
           RGLog.GetAndAddReceiveLoadRecsMass(RG_REQUEST, "Заявка \"", "\" уcпешно загружена в шлюз", @NumImportDealsTotal, PrintOnlyErr, @RecordID_Request);
           Progress.Use();

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;

           Message("Обновление данных в Payments");
           stat = UpdateSEM02_PM(Synonim, SeanceID, @ErrMes);
           if( stat )
             RGLog.Error(ErrMes);      
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;

           /* сообщаем о результатах загрузки */
           RGLog.Message("Всего обработано заявок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));

        end;
        Progress.Use();
        Progress.Remove();
     end;
     i = 0;
     stat = 0;
     ErrMes = "";

     if( Pan.deals == SET_CHAR )
        isSem001 = IsExsistsFilePayments(synonim, Pan.imp_date, "SEM03", 1);
        isSem002 = IsExsistsFilePayments(synonim, Pan.imp_date, "SEM03", 2);
        isEqm002 = IsExsistsFilePayments(synonim, Pan.imp_date, "EQM06", 2);
        isEqm003 = IsExsistsFilePayments(synonim, Pan.imp_date, "EQM06", 3);
        isEqm004 = IsExsistsFilePayments(synonim, Pan.imp_date, "EQM06", 4);

        RG = TGtRecordBatchCharger();

        Progress.Init( 2, "Выполняется очистка данных", "Очистка данных"  );
        if(ReportFileName != "")
          OldOutPut = SetOutput( ReportFileName, TRUE );
          println( "Начало очистки таблиц SEM03, EQM06 " + time() );
        end;
        stat = DelSEM03(@ErrMes);
        Message("Очистка таблицы SEM03");
        Progress.Use();
        if( stat == 0)
          Message("Очистка таблицы EQM06");
          DelEQM06(@ErrMes);
        end;

        if(ReportFileName != "")
          println( "Конец очистки таблиц SEM03, EQM06 " + time() );
          SetOutput( OldOutPut, TRUE );
        end;

        Progress.Use();
        Progress.Remove();

        if( (isSem001==1) AND ((isEqm002 !=1) AND (isEqm003 !=1)))
           RGLog.Error("Отсутствуют файлы EQM06_002 и EQM06_003 для файла SEM03_001");
           isSem001 = 0;      
        end;

        if( (isSem002==1) AND (isEqm004 !=1 ))
           RGLog.Error("Отсутствуют файл EQM06_004 для файла SEM03_002");      
           isSem002 = 0;      
        end;

        NumImportDeals = 0;
        FileImport = FileSEM03;
        RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ SEM03");
        Progress.Init( 17, "Выполняется обработка данных", "Обработка данных"  );

        if( stat )
           RGLog.Error(ErrMes);      
        elif( (isSem001 == 0) AND (isSem002 == 0) )
           RGLog.Error("Нет данных в Payments");      
        else
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало заполнения SEM03 " + time() );
           end;
           stat = FillSEM03(Synonim, Pan.imp_date, isSem001, isSem002, 1, @ErrMes);
           Message("Заполнение таблицы SEM03");
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец заполнения SEM03 " + time() );
             println( "Начало заполнения EQM06 " + time() );
           end;
           if( stat == 0 )
             Message("Заполнение таблицы EQM06");
             stat = FillEQM06(Synonim, Pan.imp_date, isSem001, isSem002, 0, @ErrMes);
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец заполнения EQM06 " + time() );
             SetOutput( OldOutPut, TRUE );
           end;

           if(MarketID <= 0 )
             ErrMes = ErrMes + "В ГКБО не найден субъект с кодом \"" + MMVB_CODE + "\" вида " + PTCK_CONTR;  
             stat = 1;
           else
             if(stat == 0)
                RG_GetCentralContrForMarket( true ,@CPFirmIdConst, null/*, @ErrMes*/);
                stat = UpdateContrSEM03(CPFirmIdConst, @ErrMes);
             end;
             if(stat == 0)
               stat = UpdateContr(MarketID, "D_SEM03_TMP", Pan.imp_date, @ErrMes);
             end;
             if(ReportFileName != "")
               OldOutPut = SetOutput( ReportFileName, TRUE );
               println( "Начало обновления Party " + time() );
             end;
             if( stat == 0 )
               Message("Обновление данных для SEM03: Party");
               stat = UpdateParty(MarketID, "D_SEM03_TMP", Pan.imp_date, @ErrMes);
             end;
             Progress.Use();
   
             if(ReportFileName != "")
               println( "Конец обновления Party " + time() );
               // IdentIsSEBMass();             
               println( "Начало обновления Currency " + time() );
             end;

             if( stat == 0 )
               Message("Обновление данных для SEM03: Currency");
               stat = UpdateCur("D_SEM03_TMP", @ErrMes);
             end;
             Progress.Use();
    
             if(ReportFileName != "")
               println( "Конец обновления Currency " + time() );
               println( "Начало обновления календарей " + time() );
             end;

             if( stat == 0 )
               Message("Обновление данных для SEM03: календари");
               stat = UpdateCalend("D_SEM03_TMP", MarketID, CALEND_OPER_NAME, @ErrMes );
             end;
             Progress.Use();

             if(ReportFileName != "")
               println( "Конец обновления календарей " + time() );
               println( "Начало обновления FIID " + time() );
             end;

             if( stat == 0 )
               Message("Обновление данных для SEM03: FIID");
               stat = UpdateFIID("D_SEM03_TMP", @ErrMes );
             end;
             Progress.Use();
             
             if(ReportFileName != "")
               println( "Конец обновления FIID " + time() );
               println( "Начало удаления неподходящих записей по условиям панели " + time() );
             end;

             if( stat == 0 )
               Message("Обновление данных для SEM03: IsFitDeal");
               stat = DeleteIfNotIsFitDeal("D_SEM03_TMP", Pan, @ErrMes); //IsFitDeal
             end;
             Progress.Use();
             if(ReportFileName != "")
               println( "Конец удаления неподходящих записей по условиям панели " + time() );
               println( "Начало обновления UnderWr " + time() );
             end;
             if( stat == 0 )
               Message("Обновление данных для SEM03: UnderWr");
               stat = UpdateUnderWr("D_SEM03_TMP", @ErrMes );
             end;
             Progress.Use();

             if(ReportFileName != "")
               println( "Конец обновления UnderWr " + time() );
               println( "Начало обновления MarketScheme " + time() );
             end;

             if( stat == 0 )
               Message("Обновление данных для SEM03: MarketScheme");
               if(IsRSHB == 1)
                 stat = UpdateMarketSchemeSEM03eqm( @ErrMes );
               else
                 stat = UpdateMarketSchemeSEM03( @ErrMes );
               end;
             end;
             Progress.Use();
             if(ReportFileName != "")
               println( "Конец обновления MarketScheme " + time() );
               println( "Начало обновления дат " + time() );
             end;
             if( stat == 0 )
               Message("Обновление данных для SEM03: даты");
               stat = UpdateCalendDate("D_SEM03_TMP", @ErrMes );
             end;
             Progress.Use();

             if(ReportFileName != "")
               println( "Конец обновления дат " + time() );
               println( "Начало обновления объектов " + time() );
             end;

             if( stat == 0 )
               stat = UpdateObjSEM03( @ErrMes );
             end;
             Progress.Use();

             if(ReportFileName != "")
               println( "Конец обновления объектов " + time() );
               println( "Начало обновления портфелей " + time() );
             end;

             if( stat == 0 )
               Message("Обновление данных для SEM03: портфели");
               if(IsRSHB == 1)
                 stat = UpdatePortfolioUsr(Pan.imp_date, @ErrMes );
               else
                 stat = UpdatePortfolio(Pan.imp_date, @ErrMes );
               end;
             end;
             Progress.Use();
             if(ReportFileName != "")
               println( "Конец обновления портфелей " + time() );
             end;
           end;

           Deals.Init();

           if(ReportFileName != "")
             println( "Начало обновления документа " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для SEM03: документы");
             stat = UpdateSEM03(Synonim, @ErrMes);
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления документа " + time() );
           end;
           Message("Обработка данных SEM03");

           if(ErrMes != "")
              RGLog.Message(ErrMes);
           else
              if(USE_STORPROC_CREATEREPL)
                 //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
                 cmd = DL_RSDCommand("SELECT 1 FROM D_SEM03_TMP ");
              else
                 Query = "  SELECT  NVL (eqm06.T_ID_MB_REQUISITES,0) isSem06,"
                       + "      T_ID_MB_SEM03 ID_MB_SEM03, "
                       + "        NVL ( t.T_CPFirmId, CHR(1)) CPFirmId, "
                       + "        NVL (DECODE (eqm06.T_RepoPart, 2, 0, eqm06.T_CLRCOMM), 0) CLRCOMM_06, "
                       + "        NVL (DECODE (eqm06.T_RepoPart, 2, CHR(1), eqm06.T_TRDACCID), CHR(1)) TRDACCID_06, "
                       + "        NVL (eqm06Part2.T_AMOUNT, 0) AMOUNT2_06, "
                       + "        NVL (eqm06Part2.T_ACCINT, 0) ACCINT2_06, "
                       + "        NVL (eqm06Part2.T_PRICE, 0) PRICE2_06, "
                       + "        NVL (eqm06Part2.T_VALUE, 0) VALUE2_06, "
                       + "        NVL (t.T_TRADEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) TRADEDATE, "
                       + "        NVL (t.T_TRADESESSIONDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) TRADESESSIONDATE, "
                       + "        NVL (t.T_CURRENCYID, CHR (1)) CURRENCYID, "
                       + "        NVL (t.T_BOARDID, CHR (1)) BOARDID, "
                       + "        NVL (t.T_BOARDNAME, CHR (1)) BOARDNAME, "
                       + "        NVL (t.T_SETTLEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) SETTLEDATE, "
                       + "        NVL (t.T_SECURITYID, CHR (1)) SECURITYID, "
                       + "        NVL (t.T_SECURITYTYPE, CHR (1)) SECURITYTYPE, "
                       + "        NVL (t.T_FACEVALUE, 0) FACEVALUE,  "
                       + "        NVL (t.T_PRICETYPE, CHR (1)) PRICETYPE, "
                       + "        NVL (t.T_TRDACCID, CHR (1)) TRDACCID, "
                       + "        NVL (t.T_RECNO, 0) RECNO, "
                       + "        NVL (t.T_TRADENO, 0) TRADENO, "
                       + "        NVL (t.T_TRADETIME, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) TRADETIME, "
                       + "        NVL (t.T_BUYSELL, CHR (1)) BUYSELL, "
                       + "        NVL (t.T_SETTLECODE, CHR (1)) SETTLECODE, "
                       + "        NVL (t.T_DECIMALS, 0) DECIMALS, "
                       + "        NVL (t.T_PRICE, 0) PRICE, "
                       + "        NVL (t.T_VALUE, 0) VALUE, "
                       + "        NVL (t.T_QUANTITY, 0) QUANTITY, "
                       + "        NVL (t.T_AMOUNT, 0) AMOUNT, "
                       + "        NVL (t.T_EXCHCOMM, 0) EXCHCOMM, "
                       + "        NVL (t.T_ORDERNO, CHR (1)) ORDERNO, "
                       + "        NVL (t.T_ACCINT, 0) ACCINT, "
                       + "        NVL (t.T_REPOVALUE, 0) REPOVALUE, "
                       + "        NVL (t.T_REPOPERIOD, 0) REPOPERIOD, "
                       + "        NVL (t.T_REPORATE, 0) REPORATE, "
                       + "        NVL (t.T_TRADETYPE, CHR (1)) TRADETYPE, "
                       + "        NVL (t.T_PRICE2, 0) PRICE2, "
                       + "        NVL (t.T_ACCINT2, 0) ACCINT2, "
                       + "        NVL (t.T_CLIENTCODE, CHR (1)) CLIENTCODE, "
                       + "        NVL (t.T_VCLIENTCODE, CHR (1)) VCLIENTCODE, "
                       + "        NVL (t.T_MATCHREF, CHR (1)) MATCHREF, "
                       + "        NVL (t.T_BROKERREF, CHR (1)) BROKERREF, "
                       + "        NVL(t.T_IsSEB,0) ISSEB, " 
                       + "        NVL(t.T_PARTYID,0) PARTYID, " 
                       + "        NVL(t.T_SFCONTRID,0) SFCONTRID, " 
                       + "        NVL(t.T_CPFIRMPARTYID,0) CPFIRMPARTYID, " 
                       + "        NVL(t.T_CURID,0) CURID, " 
                       + "        NVL(t.T_CALENDID,0) CALENDID, " 
                       + "        NVL(t.T_MARKETSCHEMEID,0) MARKETSCHEMEID, " 
                       + "        NVL(t.T_NDAY1,0) NDAY1, " 
                       + "        NVL(t.T_NDAY2,0) NDAY2, " 
                       + "        NVL(t.T_PAYMDATE1,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) PAYMDATE1, " 
                       + "        NVL(t.T_PAYMDATE2,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) PAYMDATE2, " 
                       + "        NVL(t.T_CALCITOGDATE,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) CALCITOGDATE, " 
                       + "        NVL(t.T_WORKSETTLEDATE,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) WORKSETTLEDATE, " 
                       + "        NVL(t.T_OBJECTID,0) OBJECTID, " 
                       + "        NVL(t.T_PORTFOLIO,0) PORTFOLIO, " 
                       + "        NVL(t.T_UNDERWR,0) UNDERWR, " 
                       + "        NVL(t.T_UNDERWR_BUY,0) UNDERWR_BUY, " 
                       + "        NVL(t.T_DOC_NO, CHR (1)) DOC_NO, "
                       + "        NVL(t.t_FIID, -1) FIID, "
                       + "        NVL(t.t_IsREPO, 0) IsREPO "
                       + "   FROM D_SEM03_TMP t, D_EQM06_TMP eqm06, D_EQM06_TMP eqm06Part2 "
                       + "  WHERE     t.T_TRADENO = eqm06.T_TRADENO(+) "
                       + "        AND t.T_BUYSELL = eqm06.T_BUYSELL(+) "
                       + "        AND t.T_vCLIENTCODE = eqm06.T_vCLIENTCODE(+) "
                       + "        AND t.T_TRADENO = eqm06Part2.T_TRADENO(+) "
                       + "        AND 2 = eqm06Part2.T_Repopart(+) "
                       + "        AND (3 = eqm06Part2.T_InfType(+) "
                       + "        OR 6 = eqm06Part2.T_InfType(+) )"
                       + "        AND t.T_vCLIENTCODE = eqm06Part2.T_vCLIENTCODE(+) "
                       + "   ORDER BY t.T_DOC_NO, t.t_recno "
                        ;

                 cmd = DL_RSDCommand(Query);
              end;

              NRec = cmd.GetCount();
              NumImportDeals = NRec; // т.к. наложили фильтр DeleteIfNotIsFitDeal
           end;
           if(ReportFileName != "")
             println( "Начало обработки данных из таблицы SEM03 " + time() );
             SetOutput( OldOutPut, TRUE );
           end;

           FilesName = "";
           if( stat == 0)
             stat =  GetFileName( synonim, "D_SEM03_TMP", @FilesName, @ErrMes);
           end;

           if( stat )
             RGLog.Error(ErrMes);      
           end;
           RGLog.Message("Используются файлы: \n" + FilesName);

           if(NRec > 0)
              if(GetDialogFlag())
                 InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ SEM03");
              end;

              if(USE_STORPROC_CREATEREPL) // создание объектов записей репликаций через ХП
                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_SEM03(?, ?, ?, ?); END;");
                 cmdSP.addParam("stat", RSDBP_RETVAL, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, imp_date);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.addParam("", RSDBP_IN, GetStorPrPrmStr(Pan)); //прочие параметры
                 cmdSP.Execute();

                 stat = Int(cmdSP.value("stat"));
              else
                 ds = cmd.execute();
                 while(ds.MoveNext)
                    ErrMes = "";
                    WarnMes = "";

                    Deals.DOC_NO       = ds.DOC_NO;  // находится в MB_REQUISITES, нужно переместить в MB_SEM03
                    Deals.TradeDate    = ds.TRADEDATE;
                    Deals.CurrencyId   = ds.CURRENCYID;
                    Deals.BoardId      = ds.BOARDID;
                    Deals.BoardType    = ds.BOARDNAME;
                    Deals.SettleDate   = ds.SETTLEDATE;
                    Deals.SecurityId   = ds.SECURITYID;
                    Deals.SecurityType = ds.SECURITYTYPE;
                    Deals.FaceValue    = ds.FACEVALUE;
                    Deals.PriceType    = ds.PRICETYPE;
                    Deals.IsTrust      = false;
                    Deals.TrdAccId     = RG_IIF(ds.TrdAccId_06 == "", ds.TRDACCID, ds.TrdAccId_06);
                    Deals.RecNo        = ds.RECNO;
                    Deals.TradeNo      = ds.TRADENO;  
                    Deals.TradeTime    = ds.TRADETIME;
                    Deals.BuySell      = ds.BUYSELL;
                    Deals.SettleCode   = ds.SETTLECODE;
                    Deals.Decimals     = ds.DECIMALS;
                    Deals.Price        = ds.PRICE;
                    Deals.Quantity     = ds.QUANTITY;
                    Deals.Value_       = ds.VALUE;
                    Deals.Amount       = ds.AMOUNT;
                    Deals.ExhComm      = ds.EXCHCOMM;
                    Deals.OrderNo      = ds.ORDERNO;
                    Deals.OrdTypeCode  = "";
                    Deals.AccInt       = ds.ACCINT;
                    Deals.CPFirmId     = ds.CPFIRMID;
                    Deals.RepoValue    = ds.REPOVALUE;
                    Deals.RepoPeriod   = ds.REPOPERIOD;
                    Deals.RepoRate     = ds.REPORATE;
                    Deals.TradeType    = ds.TRADETYPE;
                    Deals.Price2       = RG_IIF(ds.Price2_06 == 0 , ds.PRICE2, ds.Price2_06);
                    Deals.AccInt2      = RG_IIF(ds.AccInt2_06 == 0 , ds.ACCINT2, ds.AccInt2_06);
                    Deals.ClientCode   = ds.CLIENTCODE;
                    Deals.vClientCode  = ds.VCLIENTCODE;
                    Deals.MatchRef     = ds.MATCHREF;
                    Deals.BrokerRef    = ds.BROKERREF;
                    Deals.IsSeb        = RG_IIF(ds.IsSeb == 0, false, true);
                    Portfolio_         = ds.Portfolio;
                    Deals.UnderWr      = RG_IIF(ds.UNDERWR == 0, false, true);
                    Deals.UnderWr_Pokupka  = RG_IIF(ds.UNDERWR_BUY == 0, false, true);
                    Deals.IsREPO      = RG_IIF(ds.IsREPO == 0, false, true);
                    SetPartPrmDeal_PM(); 
                             
                    Deals.CLRCOMM      = ds.CLRCOMM_06;
                    Deals.Amount2      = ds.Amount2_06;
                    Deals.Value2_      = ds.Value2_06;
                    CPFirmId           = ds.CPFIRMPARTYID;
                    CurrencyId         = ds.CurID;
                    calendId           = ds.CALENDID;
                    ClientContrID      = ds.SfContrID;
                    ClientID           = ds.PartyID;
                    MarketSchemeID     = ds.MarketSchemeID;
                    PaymDate1_         = date(ds.PAYMDATE1);
                    PaymDate2_         = date(ds.PAYMDATE2);
                    NDay1_             = ds.NDAY1;
                    NDay2_             = ds.NDAY2;
                    CalcItogDate_      = date(ds.CALCITOGDATE);
                    WorkSettleDate_    = date(ds.WORKSETTLEDATE);

                    var UINNumber = GetUINNumber();
                    if((ds.CPFirmId != "") AND (CPFirmId <= 0))
                       ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В ГКБО не найден субъект с принадлежностью \'Центральный контрагент\'";  
                    elif( (ds.OBJECTID > 0) )
                       ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Запись репликации с действием создать для объекта " + int(ds.OBJECTID) + " уже передавалась в RS-Bank.\n Повторная репликация невозможна.";  
                    elif( (Deals.vClientCode!= "") AND (ClientID <= 0) )
                       ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Не найден субъект через краткий код на бирже \"" + Deals.vClientCode + "\"";  
                    elif((Deals.CurrencyId != "") AND (ds.CurID == -1))
                       ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике не найден ФИ с кодом \"" + Deals.CurrencyId + "\"";
                    elif((Deals.SecurityId != "") AND (ds.FIID == -1))
                       ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В справочнике не найден ФИ с кодом \"" + Deals.SecurityId + "\"";  
                    end;

                  //if( IsFitDeal(Deals.IsTrust, Deals.IsSeb) )
                       if( ErrMes == "")

                         if( oldDoc_NO != Deals.DOC_NO ) //на первой сделке вставляем документ-основание
                            if(ProcessTrn(0, "PutMarketReport"))
                            else
                               RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep );
                               RG.UnInit();  
                            end;
                            ErrMes = "";
                            oldDoc_NO = Deals.DOC_NO;
                         end;

                         if(ds.isSem06 == 0)
                           ErrMes = ErrMes + "Ошибка при загрузке сделки с кодом \"" + GetUINNumber() + "\"\nНет данных в файле EQM06";
                         else
                           if (ProcessTrn(0,"PutDealInfoPM")) 
                           else
                              RG.UnInit();
                           end;
                         end;
                       end;
                     //NumImportDeals = NumImportDeals + 1;

                  //end;

                    if( ErrMes != "" )
                       RGLog.Error(ErrMes);
                    end;
                   
                    if( WarnMes != "" )
                       RGLog.Message(WarnMes);
                    end;
                   
                    i = i + 1;
                    if(GetDialogFlag())
                       UseProgress(i);
                    end;
                    if( FlagCtrlBrk == true )
                       break;
                    end;
                 end;
              end;
              if(GetDialogFlag())
                 RemProgress(); 
              end;
           end;
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Конец обработки данных из таблицы SEM03 " + time() );
           end;
        end;
        Progress.Use();
        if(ReportFileName != "")
          SetOutput( OldOutPut, TRUE );
        end;

        if(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           if((not USE_STORPROC_CREATEREPL) and (not FlagCtrlBrk))
              RG.Transfer();
              SetErrAfterLoad(true);
           end;
           Progress.Use();
           /*загрузить в лог инфу о загруженных ЗР*/
           Message("Заполнение протокола");
           if(USE_STORPROC_CREATEREPL)
             RGLog.GetAndAddReceiveStorPrLog(RG_SECURDEAL);
           end;
           RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT, "Документ-подтверждение \"Отчет биржи\" успешно загружен\n", null, true, null, @RECORDID_MarketReport, PrintOnlyErr);
           RGLog.GetAndAddReceiveLoadRecsMass(RG_SECURDEAL,"Сделка \"","\" уcпешно загружена в шлюз", @NumImportDealsTotal, PrintOnlyErr, @RecordID_Deals);
           Progress.Use();
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;
           Message("Обновление данных в Payments");
           stat = UpdateSEM03_PM(Synonim, SeanceID, @ErrMes);
           if( stat )
             RGLog.Error(ErrMes);      
           end;

           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;

           RGLog.Message("Всего обработано сделок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
           Progress.Use();
        end;
        Progress.Remove();
     end;
     i = 0;
     stat = 0;
     ErrMes = "";

     if( (Pan.request_otc == SET_CHAR) and IsImportOTC )
        RG = TGtRecordBatchCharger();
        RGLog.Message("ЗАГРУЗКА ЗАЯВОК НА ВНЕБИРЖЕВЫЕ СДЕЛКИ");
        Progress.Init( 7, "Выполняется обработка данных", "Обработка данных"  );

        if(CheckFileUpload(synonim, "EQM2T", pan.imp_date, @ErrMes))
           RGLog.Message("ПРЕДУПРЕЖДЕНИЕ: "+ErrMes, null, LOAD_WARNING); //Предупреждение загрузки об отсутствии файлов
           ErrMes = ""; NRec = 0;
        else
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало очистки таблицы EQM2T " + time() );
           end;
           Message("Очистка таблицы EQM2T");

           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.DelEQM2T(?, ?); END;");
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           if(ReportFileName != "")
             println( "Конец очистки таблицы EQM2T " + time() );
           end;
           Progress.Use();

           if( stat == 0 )
              if(ReportFileName != "")
                println( "Начало заполнения EQM2T " + time() );
              end;

              Message("Заполнение таблицы EQM2T");

              cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.FillEQM2T(?, ?, ?, ?); END;"); 
              cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
              cmdSP.addParam("", RSDBP_IN, SeanceID);
              cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
              cmdSP.addParam("", RSDBP_IN, Synonim);
              cmdSP.addParam("", RSDBP_IN, Pan.imp_date);
              cmdSP.Execute();
              stat = Int(cmdSP.value("stat"));
              if(ReportFileName != "")
                println( "Конец заполнения EQM2T " + time() );
              end;
           end;
           Progress.Use();
           if(ReportFileName != "")
             SetOutput( OldOutPut, TRUE );
           end;

           if( stat )
              RGLog.GetAndAddReceiveStorPrLog(RG_REQUEST);
           else
              if(MarketID <= 0 )
                 ErrMes = ErrMes + "В ГКБО не найден субъект с кодом \"" + MMVB_CODE + "\" вида " + PTCK_CONTR;  
                 stat = 1;
              else
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );

                   if(ReportFileName != "")
                     println( "Начало обновления EQM2T (Party) " + time() );
                   end;
                 end;

                 Message("Обновление данных для EQM2T: Party");
                 if( stat == 0)
                    stat = UpdateParty(MarketID, "D_EQM2T_TMP", Pan.imp_date, @ErrMes);
                 end;
                 Progress.Use();
 
                 if(ReportFileName != "")
                   println( "Конец обновления EQM2T (Party) " + time() );
                   println( "Начало обновления объектов EQM2T " + time() );
                 end;

                 Message("Обновление данных для EQM2T: объекты");
                 if( stat == 0)
                   cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateObjEQM2T(?, ?); END;"); 
                   cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                   cmdSP.addParam("", RSDBP_IN, SeanceID);
                   cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                   cmdSP.Execute();
                   stat = Int(cmdSP.value("stat"));
                 end;
                 Progress.Use();
                 if(ReportFileName != "")
                   println( "Конец обновления объектов EQM2T " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;
              end;

              Message("Обработка данных EQM2T");
              //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
              Query = "SELECT 1 FROM D_EQM2T_TMP t WHERE t.T_TRADEDATE = ?";
              cmd = DL_RSDCommand(Query);
              cmd.AddParam(Pan.imp_date);

              NRec = cmd.GetCount();

              //нужен для подсчета реального кол-ва обрабатываемых записей (не считаем записи по собственным заявкам, которые уйдут в предупреждения)
              Query = "SELECT 1 FROM D_EQM2T_TMP t WHERE t.T_TRADEDATE = ?";
              cmd = DL_RSDCommand(Query);
              cmd.AddParam(Pan.imp_date);

              NRecTotal = cmd.GetCount();
              NumImportDeals = NRecTotal;  

              if((stat == 0) AND (NRec > 0))
                 FilesName = "";
                 if( stat == 0)
                   stat = GetFileName( synonim, "D_EQM2T_TMP", @FilesName, @ErrMes);
                 end;
                 RGLog.Message("Используются файлы: \n" + FilesName);

                 if(GetDialogFlag())
                    InitProgress(NRec, "Загрузка внешнего файла заявок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ EQM2T");
                 end;

                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Начало обработки данных из таблицы EQM2T " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;

                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_EQM2T(?, ?, ?, ?); END;");
                 cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, imp_date);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.addParam("", RSDBP_IN, MMVB_Code); 
                 cmdSP.Execute();
                 stat = Int(cmdSP.value("stat"));

                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Конец обработки данных из таблицы EQM2T " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;
 
                 if(GetDialogFlag())
                    RemProgress(); 
                 end;
              end;
              Progress.Use();
           end;
        end;

        if(stat and (ErrMes != ""))
           RGLog.Error(ErrMes);
        elif(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           Progress.Use();
           Message("Заполнение протокола");
           /*загрузить в лог инфу о загруженных ЗР*/
           RGLog.GetAndAddReceiveStorPrLog(RG_REQUEST);
           RGLog.GetAndAddReceiveLoadRecsMass(RG_REQUEST, "Заявка \"", "\" уcпешно загружена в шлюз", @NumImportDealsTotal, PrintOnlyErr, @RecordID_Request);
           Progress.Use();

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;

           Message("Обновление данных в Payments");

           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateEQM2T_PM(?, ?, ?); END;"); 
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.addParam("", RSDBP_IN, Synonim);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           if(stat)
             RGLog.GetAndAddReceiveStorPrLog(RG_REQUEST);
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;

           /* сообщаем о результатах загрузки */
           RGLog.Message("Всего обработано заявок на внебиржевые сделки из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
        end;
        Progress.Remove();
     end;
     i = 0;
     stat = 0;
     ErrMes = "";

     oldDoc_NO = "";
     MarketReportID = "";
     if( (Pan.deals_otc == SET_CHAR) and IsImportOTC )
        RG = TGtRecordBatchCharger();
        RGLog.Message("ЗАГРУЗКА ВНЕБИРЖЕВЫХ СДЕЛОК");
        Progress.Init( 7, "Выполняется обработка данных", "Обработка данных"  );

        if(CheckFileUpload(synonim, "EQM3T", pan.imp_date, @ErrMes))
           RGLog.Message("ПРЕДУПРЕЖДЕНИЕ: "+ErrMes, null, LOAD_WARNING); //Предупреждение загрузки об отсутствии файлов
           ErrMes = ""; NRec = 0;
        else
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало очистки таблицы EQM3T " + time() );
           end;
           Message("Очистка таблицы EQM3T");

           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.DelEQM3T(?, ?); END;");
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           if(ReportFileName != "")
             println( "Конец очистки таблицы EQM3T " + time() );
           end;
           Progress.Use();

           if( stat == 0 )
              Message("Очистка таблицы EQM06");
              DelEQM06(@ErrMes);
              if(ReportFileName != "")
                println( "Начало заполнения EQM06 " + time() );
              end;
              if( stat == 0 )
                 Message("Заполнение таблицы EQM06");
                 stat = FillEQM06(Synonim, Pan.imp_date, 1, 1, 0, @ErrMes);   
              end;
              Progress.Use();
              if(ReportFileName != "")
                println( "Конец заполнения EQM06 " + time() );
                println( "Начало заполнения EQM3T " + time() );
              end;
              Message("Заполнение таблицы EQM3T");

              cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.FillEQM3T(?, ?, ?, ?); END;"); 
              cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
              cmdSP.addParam("", RSDBP_IN, SeanceID);
              cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
              cmdSP.addParam("", RSDBP_IN, Synonim);
              cmdSP.addParam("", RSDBP_IN, date(Pan.imp_date));
              cmdSP.Execute();
              stat = Int(cmdSP.value("stat"));

              if(ReportFileName != "")
                println( "Конец заполнения EQM3T " + time() );
              end;
           end;
           Progress.Use();

           if(ReportFileName != "")
             SetOutput( OldOutPut, TRUE );
           end;

           if( stat )
              RGLog.GetAndAddReceiveStorPrLog(RG_SECURDEAL);
           else
              if(MarketID <= 0 )
                 ErrMes = ErrMes + "В ГКБО не найден субъект с кодом \"" + MMVB_CODE + "\" вида " + PTCK_CONTR;  
                 stat = 1;
              else

                if(stat == 0)
                   RG_GetCentralContrForMarket( true , null,@CPFirmIdConst/*, @ErrMes*/);
                end;
                if(ReportFileName != "")
                  OldOutPut = SetOutput( ReportFileName, TRUE );
                end;
                if(stat == 0)
                   if(ReportFileName != "")
                     println( "Начало обновления данных EQM3T: Contr " + time() );
                   end;
                   Message("Заполнение таблицы EQM3T");
                
                   cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateContrEQM3T(?, ?, ?); END;"); 
                   cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                   cmdSP.addParam("", RSDBP_IN, SeanceID);
                   cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                   cmdSP.addParam("", RSDBP_IN, CPFirmIdConst);
                   cmdSP.Execute();
                   stat = Int(cmdSP.value("stat"));

                   if(ReportFileName != "")
                     println( "Конец заполнения данных EQM3T: Contr " + time() );
                   end;
                end;
                if(ReportFileName != "")
                  println( "Начало обновления Party " + time() );
                end;
                if( stat == 0 )
                   Message("Обновление данных для EQM3T: Party");
                   stat = UpdateParty(MarketID, "D_EQM3T_TMP", Pan.imp_date, @ErrMes);
                end;
                Progress.Use();
    
                if(ReportFileName != "")
                  println( "Конец обновления Party " + time() );
                  println( "Начало обновления Currency " + time() );
                end;

                if( stat == 0 )
                   Message("Обновление данных для EQM3T: Currency");
                   stat = UpdateCur("D_EQM3T_TMP", @ErrMes);
                end;
                Progress.Use();
                
                if(ReportFileName != "")
                  println( "Конец обновления Currency " + time() );
                  println( "Начало обновления календарей " + time() );
                end;

                if( stat == 0 )
                   Message("Обновление данных для SEM03: календари");
                   stat = UpdateCalend("D_EQM3T_TMP", MarketID, CALEND_OPER_NAME, @ErrMes );
                end;
                Progress.Use();
    
                if(ReportFileName != "")
                  println( "Конец обновления календарей " + time() );
                  println( "Начало обновления FIID " + time() );
                end;

                if( stat == 0 )
                   Message("Обновление данных для SEM03: FIID");
                   stat = UpdateFIID("D_EQM3T_TMP", @ErrMes );
                end;
                Progress.Use();
                if(ReportFileName != "")
                  println( "Конец обновления FIID " + time() );
                  println( "Начало обновления MarketScheme " + time() );
                end;

                if( stat == 0 )
                   Message("Обновление данных для EQM3T: MarketScheme");
                   stat = UpdateMarketSchemeEQM3T( @ErrMes );
                end;
                Progress.Use();

                if(ReportFileName != "")
                  println( "Конец обновления MarketScheme " + time() );
                  println( "Начало обновления дат " + time() );
                end;

                if( stat == 0 )
                   Message("Обновление данных для EQM3T: даты");
                   stat = UpdateCalendDate("D_EQM3T_TMP", @ErrMes );
                end;
                Progress.Use();
    
                if(ReportFileName != "")
                  println( "Конец обновления дат " + time() );
                  println( "Начало обновления объектов " + time() );
                end;

                if( stat == 0 )
                   cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateObjEQM3T(?, ?); END;"); 
                   cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                   cmdSP.addParam("", RSDBP_IN, SeanceID);
                   cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                   cmdSP.Execute();
                   stat = Int(cmdSP.value("stat"));
                end;
                Progress.Use();
                Progress.Use();

                if(ReportFileName != "")
                  println( "Конец обновления объектов " + time() );
                  println( "Конец обновления портфелей " + time() );
                end;
              end;

              Deals.Init();

              if(ReportFileName != "")
                println( "Начало обновления документа " + time() );
              end;

              if( stat == 0 )
                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateDocEQM3T(?, ?, ?); END;"); 
                 cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.addParam("", RSDBP_IN, Synonim);
                 cmdSP.Execute();
                 stat = Int(cmdSP.value("stat"));
              end;
              Progress.Use();

              if(ReportFileName != "")
                println( "Конец обновления документа " + time() );
              end;

              Message("Обработка данных EQM3T");
              //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
              Query = "SELECT 1 FROM D_EQM3T_TMP t WHERE t.T_TRADEDATE = ?";
              cmd = DL_RSDCommand(Query);
              cmd.AddParam(Pan.imp_date);

              NRec = cmd.GetCount();

              //нужен для подсчета реального кол-ва обрабатываемых записей (не считаем записи по собственным сделкам, которые уйдут в предупреждения)
              Query = "SELECT 1 FROM D_EQM3T_TMP t WHERE t.T_TRADEDATE = ?";
              cmd = DL_RSDCommand(Query);
              cmd.AddParam(Pan.imp_date);

              NRecTotal = cmd.GetCount();
              NumImportDeals = NRecTotal;   
  
              if((stat == 0) AND (NRec > 0))
                 FilesName = "";
                 if( stat == 0)
                    stat = GetFileName( synonim, "D_EQM3T_TMP", @FilesName, @ErrMes);
                 end;
                 if(ReportFileName != "")
                   SetOutput( OldOutPut, TRUE );
                 end;

                 RGLog.Message("Используются файлы: \n" + FilesName);

                 if(GetDialogFlag())
                    InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ EQM3T");
                 end;

                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Начало обработки данных из таблицы EQM3T " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;

                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_EQM3T(?, ?, ?, ?); END;");
                 cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, imp_date);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.addParam("", RSDBP_IN, GetStorPrPrmStr(Pan)); 
                 cmdSP.Execute();
                 stat = Int(cmdSP.value("stat"));
 
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Конец обработки данных из таблицы EQM3T " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;
 
                 if(GetDialogFlag())
                    RemProgress(); 
                 end;
              end;
              Progress.Use();
           end;
           if(ReportFileName != "")
             SetOutput( OldOutPut, TRUE );
           end;
        end;

        if(stat and (ErrMes != ""))
           RGLog.Error(ErrMes);
        elif(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           Progress.Use();
           Message("Заполнение протокола");
           /*загрузить в лог инфу о загруженных ЗР*/

           RGLog.GetAndAddReceiveStorPrLog(RG_MARKETREPORT);
           RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT, "Документ-подтверждение \"Отчет биржи\" успешно загружен\n", null, true, null, @RECORDID_MarketReport, PrintOnlyErr);
           RGLog.GetAndAddReceiveStorPrLog(RG_SECURDEAL);
           RGLog.GetAndAddReceiveLoadRecsMass(RG_SECURDEAL,"Сделка \"","\" уcпешно загружена в шлюз", @NumImportDealsTotal, PrintOnlyErr, @RecordID_Deals);
           Progress.Use();

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;
           Message("Обновление данных в Payments");

           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateEQM3T_PM(?, ?, ?); END;"); 
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.addParam("", RSDBP_IN, Synonim);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           if(stat)
             RGLog.GetAndAddReceiveStorPrLog(RG_SECURDEAL);
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;

           /* сообщаем о результатах загрузки */
           RGLog.Message("Всего обработано внебиржевых сделок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
        end;
        Progress.Remove();
     end;
     i = 0;
     stat = 0;
     ErrMes = "";

     oldDoc_NO = "";
     MarketReportID = "";
     if( Pan.deals_clearing == SET_CHAR )
        RG = TGtRecordBatchCharger();
        Progress.Init( 2, "Выполняется очистка данных", "Очистка данных"  );

        if(ReportFileName != "")
          OldOutPut = SetOutput( ReportFileName, TRUE );
          println( "Начало очистки таблиц SEM03, EQM06 " + time() );
        end;

        Message("Очистка таблицы SEM03");
        stat = DelSEM03( @ErrMes );
        Progress.Use();
        if( stat == 0 )
          Message("Очистка таблицы EQM06");
          stat = DelEQM06( @ErrMes );
        end;
        if(ReportFileName != "")
          println( "Конец очистки таблиц SEM03, EQM06 " + time() );
          SetOutput( OldOutPut, TRUE );
        end;
        Progress.Use();
        Progress.Remove();
        NumImportDeals = 0;
        FileImport = FileEQM06;
        RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ EQM06");

        isSem001 = IsExsistsFilePayments(synonim, Pan.imp_date, "SEM03", 1);
        isSem002 = IsExsistsFilePayments(synonim, Pan.imp_date, "SEM03", 2);
        isEqm002 = IsExsistsFilePayments(synonim, Pan.imp_date, "EQM06", 2);
        isEqm003 = IsExsistsFilePayments(synonim, Pan.imp_date, "EQM06", 3);
        isEqm004 = IsExsistsFilePayments(synonim, Pan.imp_date, "EQM06", 4);

        if( ((isEqm002 == 1) OR (isEqm003 == 1)))
           isSem001 = 1;      
        end;

        if( isEqm004 == 1 )
           isSem002 = 1;      
        end;

        if(stat)
           RGLog.Error( ErrMes );      
        elif( (isSem001 == 0) AND (isSem002 == 0) )
           RGLog.Error("Нет данных в Payments");      
        else
           Progress.Init( 16, "Выполняется обработка данных", "Обработка данных"  );
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало заполнения SEM03 " + time() );
           end;

           Message("Заполнение таблицы SEM03");
           stat = FillSEM03(Synonim, Pan.imp_date, isSem001, isSem002, 0, @ErrMes);
           Progress.Use();
           
           if(ReportFileName != "")
             println( "Конец заполнения SEM03 " + time() );
             println( "Начало заполнения EQM06 " + time() );
           end;

           if( stat == 0 )
           Message("Заполнение таблицы EQM06");
             stat = FillEQM06(Synonim, Pan.imp_date, isSem001, isSem002, 1, @ErrMes);
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец заполнения EQM06 " + time() );
           end;

           Deals.Init();
           if(stat == 0)
              RG_GetCentralContrForMarket( true ,@CPFirmIdConst, null/*, @ErrMes*/);
              stat = UpdateContrEQM06(CPFirmIdConst, @ErrMes);
           end;
           if(stat == 0)
             stat = UpdateContr(MarketID, "D_EQM06_TMP", Pan.imp_date, @ErrMes);
           end;
           
           if(ReportFileName != "")
             println( "Начало обновления EQM06 " + time() );
           end;
           if( stat == 0 )
             Message("Обновление данных для EQM06");
             stat = UpdateEQM06( Synonim, @ErrMes );
           end;

           Progress.Use();
    
           if(ReportFileName != "")
             println( "Конец обновления EQM06 " + time() );
             SetOutput( OldOutPut, TRUE );
           end;

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления Party " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: Party");
             stat = UpdateParty(MarketID, "D_EQM06_TMP", Pan.imp_date, @ErrMes);
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления Party " + time() );
             println( "Начало обновления Currency " + time() );
           end;
           if( stat == 0 )
             Message("Обновление данных для EQM06: Currency");
             stat = UpdateCur("D_EQM06_TMP", @ErrMes);
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления Currency " + time() );
             println( "Начало обновления календарей " + time() );
           end;
           if( stat == 0 )
             Message("Обновление данных для EQM06: календари");
             stat = UpdateCalend("D_EQM06_TMP", MarketID, CALEND_OPER_NAME, @ErrMes );
           end;
           Progress.Use();
           
           if(ReportFileName != "")
             println( "Конец обновления календарей " + time() );
             println( "Начало обновления FIID " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: FIID");
             stat = UpdateFIID("D_EQM06_TMP", @ErrMes);
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец обновления FIID " + time() );
             println( "Начало удаления неподходящих записей по условиям панели " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: IsFitDeal");
             stat = DeleteIfNotIsFitDeal("D_EQM06_TMP", Pan, @ErrMes); //IsFitDeal
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец удаления неподходящих записей по условиям панели " + time() );
             println( "Начало обновления UnderWr " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: UnderWr");
             stat = UpdateUnderWr("D_EQM06_TMP", @ErrMes );
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец обновления UnderWr " + time() );
             println( "Начало обновления MarketScheme " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: MarketScheme");
             stat = UpdateMarketSchemeEQM06( @ErrMes );
           end;
           Progress.Use();

           if(ReportFileName != "")
             println( "Конец обновления MarketScheme " + time() );
             println( "Начало обновления дат " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: даты");
             stat = UpdateCalendDate("D_EQM06_TMP", @ErrMes);
           end;
           Progress.Use();
           
           if(ReportFileName != "")
             println( "Конец обновления дат " + time() );
             println( "Начало обновления объектов " + time() );
           end;

           if( stat == 0 )
             Message("Обновление данных для EQM06: объекты");
             stat = UpdateObjEQM06( @ErrMes );
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления объектов " + time() );
             SetOutput( OldOutPut, TRUE );
           end;
           Message("Обработка данных EQM06");

           FilesName = "";
           if( stat == 0)
             stat =  GetFileName( synonim, "D_EQM06_TMP", @FilesName, @ErrMes);
           end;

           if( stat )
             RGLog.Error(ErrMes);      
           end;
           RGLog.Message("Используются файлы: \n" + FilesName);

           if(ErrMes != "")
              RGLog.Message(ErrMes);
           else
              if(USE_STORPROC_CREATEREPL)
                 //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
                 Query = "SELECT 1 "
                       + "  FROM D_EQM06_TMP t "
                       + " WHERE t.T_INFTYPE IN (1, 2) "
                       + "   AND NOT EXISTS(SELECT 1 "
                       + "                    FROM D_EQM06_TMP Repo_1 "
                       + "                   WHERE t.t_tradeno = Repo_1.t_tradeno "
                       + "                     AND Repo_1.T_INFTYPE = 1 "
                       + "                     AND Repo_1.T_REPOPART = 1 "
                       + "                     AND t.T_INFTYPE = 1 "
                       + "                     AND t.T_REPOPART = 2) ";

                 cmd = DL_RSDCommand(Query);
              else
                 Query = "  SELECT t.T_ID_MB_EQM06 ID_MB_EQM06, "
                       + "          DECODE( (SELECT NVL(lower(T_SECURITYTYPE),'')  FROM D_SEM03_TMP sem03_KSU WHERE sem03_KSU.T_SECURITYID = t.T_SECURITYID AND ROWNUM = 1), 'ксу', 'ксу','Єбг','ксу', '' ) SECURITYTYPE, "
                       + "         NVL (t.T_RECNO, 0) RECNO, "
                       + "         NVL (t.T_EXTSETTLECODE, CHR (1)) EXTSETTLECODE, "
                       + "         NVL (t.T_CURRENCYID, CHR (1)) CURRENCYID, "
                       + "         NVL (t.T_INFTYPE, 0) INFTYPE, "
                       + "         NVL (t.T_SESSIONNUM, -1) SESSIONNUM, "
                       + "         NVL (t.T_SETTLEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) SETTLEDATE, "
                       + "         NVL (t.T_BOARDID, CHR (1)) BOARDID, "
                       + "         NVL (t.T_SECURITYID, CHR (1)) SECURITYID, "
                       + "         NVL (t.T_PRICETYPE, CHR (1)) PRICETYPE, "
                       + "         NVL (t.T_REPOPART, 0) REPOPART, "
                       + "         NVL (t.T_TRDACCID, CHR (1)) TRDACCID, "
                       + "         NVL (t.T_CLIENTCODE, CHR (1)) CLIENTCODE, "
                       + "         NVL (t.T_vCLIENTCODE, CHR (1)) vCLIENTCODE, "
                       + "         NVL (t.T_BUYSELL, CHR (1)) BUYSELL, "
                       + "         NVL (t.T_TRADEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) TRADEDATE, "
                       + "         NVL (t.T_TRADENO, 0) TRADENO, "
                       + "         NVL (t.T_SETTLECODE, CHR (1)) SETTLECODE, "
                       + "         NVL (t.T_DECIMALS, 0) DECIMALS, "
                       + "         NVL (t.T_PRICE, 0) PRICE, "
                       + "         NVL (t.T_VALUE, 0) VALUE, "
                       + "         NVL (t.T_AMOUNT, 0) AMOUNT, "
                       + "         NVL (t.T_QUANTITY, 0) QUANTITY, "
                       + "         NVL (t.T_EXCHCOMM, 0) EXCHCOMM, "
                       + "         NVL (t.T_ACCINT, 0) ACCINT, "
                       + "         NVL (t.T_REPOPERIOD, 0) REPOPERIOD, "
                       + "         NVL (t.T_REPORTTIME, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) REPORTTIME, "
                       + "         NVL (t.T_SETTLETIME, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) SETTLETIME, "
                       + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_ACCINT, 0), 0) ACCINT2, "
                       + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_AMOUNT, 0), 0) AMOUNT2, "
                       + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_VALUE, 0), 0) VALUE2, "
                       + "         NVL (DECODE (t.T_REPOPART, 1, Repo_2.t_PRICE, 0), 0) PRICE2, "
                       + "         (CASE WHEN NVL(Repo_2.T_ID_MB_EQM06,0) = 0 THEN 0 ELSE 1 END) IsPart2, "
                       + "         NVL (Repo_2.T_SETTLEDATE, TO_DATE ('01.01.0001', 'DD.MM.YYYY')) SETTLEDATE2, "
                       + "         (CASE "
                       + "            WHEN (    (t.T_REPOPART = 1) "
                       + "                  AND (t.T_BOARDID = 'RPNG') "
                       + "                  AND (t.T_INFTYPE = 2)) "
                       + "            THEN "
                       + "              NVL (Repo_2.t_CLRCOMM, 0) "
                       + "            ELSE "
                       + "              0 "
                       + "          END) "
                       + "           CLRCOMM, "
                       + "         NVL(t.T_CPFirmId, CHR(1)) CPFirmId, "
                       + "         NVL(t.T_IsSEB,0) ISSEB, " 
                       + "         NVL(t.T_PARTYID,0) PARTYID, " 
                       + "         NVL(t.T_SFCONTRID,0) SFCONTRID, " 
                       + "         NVL(t.T_CPFIRMPARTYID,0) CPFIRMPARTYID, " 
                       + "         NVL(t.T_CURID,0) CURID, " 
                       + "         NVL(t.T_FIID,0) FIID, " 
                       + "         NVL(t.T_CALENDID,0) CALENDID, " 
                       + "         NVL(t.T_MARKETSCHEMEID,0) MARKETSCHEMEID, " 
                       + "         NVL(t.T_NDAY1,0) NDAY1, " 
                       + "         NVL(t.T_NDAY2,0) NDAY2, " 
                       + "         NVL(t.T_PAYMDATE1,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) PAYMDATE1, " 
                       + "         NVL(t.T_PAYMDATE2,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) PAYMDATE2, " 
                       + "         NVL(t.T_CALCITOGDATE,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) CALCITOGDATE, " 
                       + "         NVL(t.T_WORKSETTLEDATE,TO_DATE ('01.01.0001', 'DD.MM.YYYY')) WORKSETTLEDATE, " 
                       + "         NVL(t.T_OBJECTID,0) OBJECTID, " 
                       + "         NVL(t.T_PORTFOLIO,0) PORTFOLIO, " 
                       + "         NVL(t.T_DOC_NO, CHR (1)) DOC_NO, "
                       + "         NVL(t.T_IsREPO, 0) IsREPO, "
                       + "         NVL(t.T_UNDERWR, 0) T_UNDERWR, "
                       + "         NVL(t.T_UNDERWR_BUY, 0) T_UNDERWR_BUY "
                       + "  FROM D_EQM06_TMP t, D_EQM06_TMP Repo_2, D_SEM03_TMP sem03 "
                       + " WHERE     t.T_INFTYPE IN (1, 2) "
                     //+ "       AND (   (   ( (t.T_INFTYPE = 1) OR (t.T_INFTYPE = 2)) "
                     //+ "                OR ( (t.T_REPOPART = 1) OR (t.T_REPOPART = 2))) "
                     //+ "            OR (t.T_REPOPART = 0)) "
                       + "       AND NOT EXISTS "
                       + "                 (SELECT 1 "
                       + "                    FROM D_EQM06_TMP Repo_1 "
                       + "                   WHERE     t.t_tradeno = Repo_1.t_tradeno "
                       + "                         AND Repo_1.T_INFTYPE = 1 "
                       + "                         AND Repo_1.T_REPOPART = 1 "
                       + "                         AND t.T_INFTYPE = 1 "
                       + "                         AND t.T_REPOPART = 2) "
                       + "       AND t.t_tradeno = Repo_2.t_tradeno(+) "
                       + "       AND Repo_2.T_INFTYPE(+) IN (1,2,3,6) "
                       + "       AND Repo_2.T_REPOPART(+) = 2 "
                       + "       AND t.t_vClientCode = Repo_2.t_vClientCode(+) "
                       + "       AND t.t_tradeno = sem03.t_tradeno(+) "
                       + "       AND t.T_BUYSELL = sem03.T_BUYSELL(+) "
                       + "       ORDER BY t.T_ID_MB_EQM06 "
                       ;

                 cmd = DL_RSDCommand(Query);
              end;

              NRec = cmd.GetCount();
              NumImportDeals = NRec; // т.к. наложили фильтр DeleteIfNotIsFitDeal

              if( NRec > 0 )
                 if(GetDialogFlag())
                    InitProgress(NRec, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ EQM06");
                 end;
                 
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Начало обработки данных из таблицы EQM06 " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;

                 if(USE_STORPROC_CREATEREPL) // создание объектов записей репликаций через ХП
                    cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_EQM06(?, ?, ?, ?); END;");
                    cmdSP.addParam("stat", RSDBP_RETVAL, V_INTEGER);
                    cmdSP.addParam("", RSDBP_IN, SeanceID);
                    cmdSP.addParam("", RSDBP_IN, imp_date);
                    cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                    cmdSP.addParam("", RSDBP_IN, GetStorPrPrmStr(Pan)); //прочие параметры
                    cmdSP.Execute();

                    stat = Int(cmdSP.value("stat"));
                 else
                    ds = cmd.execute();
                    while(ds.MoveNext)
                       ErrMes = "";
                       WarnMes = "";

                       Deals.DOC_NO         = ds.DOC_NO;
                       Deals.ExtSettleCode  = ds.EXTSETTLECODE;
                       Deals.CurrencyId     = ds.CURRENCYID;
                       Deals.InfType        = ds.INFTYPE;          // добавит условие на INFTYPE IN(1,2)
                       Deals.Session        = ds.SESSIONNUM;
                       Deals.SettleDate     = ds.SETTLEDATE;
                       Deals.BoardId        = ds.BOARDID;
                       Deals.SecurityId     = ds.SECURITYID;
                       Deals.PriceType      = ds.PRICETYPE;
                       Deals.RepoPart       = ds.REPOPART;
                       Deals.TrdAccId       = ds.TRDACCID;
                       Deals.ClientCode     = ds.CLIENTCODE;
                       Deals.vClientCode    = ds.VCLIENTCODE;
                       Deals.BuySell        = ds.BUYSELL;
                       Deals.IsSeb          = RG_IIF(ds.IsSeb == 0, false, true);
                       Deals.IsREPO         = RG_IIF(ds.IsREPO == 0, false, true);
                       Portfolio_           = ds.Portfolio;
                       Deals.UnderWr        = RG_IIF(ds.UNDERWR == 0, false, true);
                       Deals.UnderWr_Pokupka = RG_IIF(ds.UNDERWR_BUY == 0, false, true);
              
                       SetPartPrmDeal_PM();
                     //if( IsFitDeal(Deals.IsTrust, Deals.IsSEB) )
                         Deals.TradeDate      = ds.TRADEDATE;
                         Deals.TradeNo        = ds.TRADENO;
                         Deals.SettleCode     = ds.SETTLECODE;
                         Deals.Decimals       = ds.DECIMALS;
                         Deals.Price          = ds.PRICE;
                         Deals.Quantity       = ds.QUANTITY;
                         Deals.Value_         = ds.VALUE;
                         Deals.Amount         = ds.AMOUNT;
                         Deals.ExhComm        = ds.EXCHCOMM;
                         Deals.AccInt         = ds.ACCINT;
                         Deals.CPFirmId       = ds.CPFIRMID;
                         Deals.RepoPeriod     = ds.REPOPERIOD;
                         Deals.TradeTime      = ds.REPORTTIME;
                         Deals.SettleTime     = ds.SETTLETIME;
              
                         Deals.AccInt2        = ds.ACCINT2;
                         Deals.Amount2        = ds.AMOUNT2;
                         Deals.Value2_        = ds.VALUE2;
                         Deals.Price2         = ds.PRICE2;
                         Deals.SecurityType   = ds.SECURITYTYPE;
                         Deals.RepoRate       = 0;
                         if( (Deals.RepoPart == 1) AND  (ds.IsPart2==1))
                           НайтиДанныеПо2Части( ds.SettleDate, ds.SettleDate2, Deals.Amount, Deals.Amount2, @Deals.RepoRate);
                         end;
                         Deals.ClrComm       = ds.CLRCOMM;
                         CPFirmId            = ds.CPFIRMPARTYID;
                         CurrencyId          = ds.CurID;
                         calendId            = ds.CALENDID;
                         ClientContrID       = ds.SfContrID;
                         ClientID            = ds.PartyID;
                         MarketSchemeID      = ds.MarketSchemeID;
                         PaymDate1_          = date(ds.PAYMDATE1);
                         PaymDate2_          = date(ds.PAYMDATE2);
                         NDay1_              = ds.NDAY1;
                         NDay2_              = ds.NDAY2;
                         CalcItogDate_       = date(ds.CALCITOGDATE);
                         WorkSettleDate_     = date(ds.WORKSETTLEDATE);

                         Deals.IsCliring = false;
                         UINNumber = GetUINNumber();

                         if((ds.CPFirmId != "") AND (CPFirmId <=0 ))
                           ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "В ГКБО не найден субъект с принадлежностью \'Центральный контрагент\'";  
                         elif(ds.OBJECTID > 0)
                            ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Запись репликации с действием создать для объекта " + int(ds.OBJECTID) + " уже передавалась в RS-Bank.""\n Повторная репликация невозможна.""\n";  
                         elif((Deals.vClientCode!= "") AND (ClientID <= 0))
                            ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + "Не найден субъект через краткий код на бирже \"" + Deals.vClientCode + "\"";  
                         elif((ErrMes == "") AND (CurrencyId < 0))
                            ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + " В ГКБО не найден ФИ с кодом \"" + Deals.CurrencyId + "\" вида " + Код_на_ММВБ_ФинИн;
                         elif((ErrMes == "") AND (ds.FIID < 0))
                            ErrMes = "Ошибка при загрузке сделки с кодом \"" + UINNumber + "\"\n" + " В справочнике не найден ФИ с кодом \'" + Ds.SecurityId + "\'" ;
                         end;

                         if(ErrMes == "")
                           if((Deals.BoardId == "RPNG") AND (Deals.InfType == 2))
                              if( oldDoc_NO != Deals.DOC_NO ) 
                                 if(ProcessTrn(0, "PutMarketReport"))
                                 else
                                    RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep );
                                 end;
                                 ErrMes = "";
                                 oldDoc_NO = Deals.DOC_NO;
                              end;   
                              if (ProcessTrn(0,"PutDealInfoPM")) 
                              else
                                 RG.UnInit();
                              end;
                           end;

                           Deals.IsCliring = true;
                           if(IsCliringData())
                             if (ProcessTrn(0,"PutDealInfoPM")) 
                                Deals.IsCliring = false;
                             else
                                Deals.IsCliring = false;
                                RG.UnInit();
                             end;
                           end;
                         end;
                       //NumImportDeals = NumImportDeals + 1;

                     //end;
              
                       if( ErrMes != "" )
                          RGLog.Error(ErrMes);
                       end;
                      
                       if( WarnMes != "" )
                          RGLog.Message(WarnMes);
                       end;
                      
                       i = i + 1;
                       if(GetDialogFlag())
                          UseProgress(i);
                       end;
                       if( FlagCtrlBrk == true )
                          break;
                       end;
                    end;
                 end;
                 if(GetDialogFlag())
                    RemProgress(); 
                 end;

                 if(ReportFileName != "")
                   OldOutPut = SetOutput(ReportFileName, TRUE);
                   println("Конец обработки данных из таблицы EQM06 " + time());
                   SetOutput(OldOutPut, TRUE);
                 end;
              end;
           end;
           Progress.Use();
        end;
        if(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           if((not USE_STORPROC_CREATEREPL) and (not FlagCtrlBrk))
              RG.Transfer();
              SetErrAfterLoad(true);
           end;
           Progress.Use();
           /*загрузить в лог инфу о загруженных ЗР*/
           Message("Заполнение протокола");
           if(USE_STORPROC_CREATEREPL)
             RGLog.GetAndAddReceiveStorPrLog(RG_CLEARING);
           end;
           RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT, "Документ-подтверждение \"Отчет биржи\" успешно загружен\n", null, true, null, @RECORDID_MarketReport, PrintOnlyErr);
           RGLog.GetAndAddReceiveLoadRecsMass(RG_CLEARING,"Клиринг.Сделка \"","\" уcпешно загружена в шлюз", @NumImportDealsTotal, PrintOnlyErr);

           Progress.Use();

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;

           Message("Обновление данных в Payments");
           stat = UpdateEQM06_PM(Synonim, SeanceID, @ErrMes);
           if( stat )
             RGLog.Error(ErrMes);      
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;
           RGLog.Message("Всего обработано сделок из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
           Progress.Use();
           Progress.Remove();
        end;
     end;
     i = 0;
     stat = 0;
     ErrMes = "";

     if(Pan.nettoitog == SET_CHAR)
        RG = TGtRecordBatchCharger();
        RGLog.Message("ЗАГРУЗКА ИТОГОВЫХ НЕТТО-ТРЕБОВАНИЙ И НЕТТО-ОБЯЗАТЕЛЬСТВ");
        Progress.Init(7, "Выполняется обработка данных", "Обработка данных");

        if(CheckFileUpload(synonim, "EQM13", pan.imp_date, @ErrMes))
           RGLog.Message("ПРЕДУПРЕЖДЕНИЕ: "+ErrMes, null, LOAD_WARNING); //Предупреждение загрузки об отсутствии файлов
           ErrMes = ""; NRec = 0;
        else
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало очистки таблицы EQM13 " + time() );
           end;
           Message("Очистка таблицы EQM13");
      
           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.DelEQM13(?, ?); END;");
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           Progress.Use();           
           if(ReportFileName != "")
             println( "Конец очистки таблицы EQM13 " + time() );
             println( "Начало заполнения EQM13 " + time() );
           end;

           if( stat == 0 )
             Message("Заполнение таблицы EQM13");
      
             cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.FillEQM13(?, ?, ?, ?); END;"); 
             cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
             cmdSP.addParam("", RSDBP_IN, SeanceID);
             cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
             cmdSP.addParam("", RSDBP_IN, Synonim);
             cmdSP.addParam("", RSDBP_IN, Pan.imp_date);
             cmdSP.Execute();
             stat = Int(cmdSP.value("stat"));
           end;
           
           if(ReportFileName != "")
             println( "Конец заполнения EQM13 " + time() );
           end;

           Progress.Use();
           if(ReportFileName != "")
             SetOutput( OldOutPut, TRUE );
           end;

           if( stat )
              RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
           else
              if(ReportFileName != "")
                OldOutPut = SetOutput( ReportFileName, TRUE );
                println( "Начало обновления DocNo " + time() );
              end;

              if( stat == 0 )
                Message("Обновление данных для EQM13: DocNo");

                cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateDocNoEQM13(?, ?, ?); END;"); 
                cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                cmdSP.addParam("", RSDBP_IN, SeanceID);
                cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                cmdSP.addParam("", RSDBP_IN, Synonim);
                cmdSP.Execute();
                stat = Int(cmdSP.value("stat"));
              end;
              Progress.Use();
              
              if(ReportFileName != "")
                println( "Конец обновления DocNo " + time() );
                println( "Начало обновления объектов EQM13 " + time() );
              end;

              if( stat == 0)
                Message("Обновление данных для EQM13: объекты");

                cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateObjEQM13(?, ?); END;"); 
                cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                cmdSP.addParam("", RSDBP_IN, SeanceID);
                cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                cmdSP.Execute();
                stat = Int(cmdSP.value("stat"));
              end;
              Progress.Use();

              if(ReportFileName != "")
                println( "Конец обновления объектов EQM13 " + time() );
                SetOutput( OldOutPut, TRUE );
              end;
      
              Message("Обработка данных EQM13");
              //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
              Query = "SELECT 1 FROM D_EQM13_TMP t WHERE t.T_REPORTDATE = ?";
              cmd = DL_RSDCommand(Query);
              cmd.AddParam(Pan.imp_date);
      
              NRec = cmd.GetCount();
              NumImportDeals = NRec; 
      
              if((stat == 0) AND (NRec > 0))
                 FilesName = "";
                 if( stat == 0)
                   stat = GetFileName( synonim, "D_EQM13_TMP", @FilesName, @ErrMes);
                 end;
                 RGLog.Message("Используются файлы: \n" + FilesName);
      
                 if(GetDialogFlag())
                    InitProgress(NRec, "Загрузка внешнего файла итогов клиринга", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ EQM13");
                 end;
      
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Начало обработки данных из таблицы EQM13 " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;
      
                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_EQM13(?, ?, ?); END;");
                 cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, imp_date);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.Execute();
                 stat = Int(cmdSP.value("stat"));
      
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Конец обработки данных из таблицы EQM13 " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;
      
                 if(GetDialogFlag())
                    RemProgress(); 
                 end;
              end;
              Progress.Use();
           end;
        end;

        if(stat and (ErrMes != ""))
           RGLog.Error(ErrMes);
        elif(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           Progress.Use();
           Message("Заполнение протокола");
           /*загрузить в лог инфу о загруженных ЗР*/
           RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
           RGLog.GetAndAddReceiveLoadRecsMass(RG_DLITOGCLVR, "Успешно загружены итоговые нетто-требования и нетто-обязательства \"","\"", @NumImportDealsTotal, PrintOnlyErr);
           Progress.Use();

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;

           Message("Обновление данных в Payments");

           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateEQM13_PM(?, ?, ?); END;"); 
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.addParam("", RSDBP_IN, Synonim);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           if(stat)
             RGLog.GetAndAddReceiveStorPrLog(RG_DLITOGCLVR);
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;

           /* сообщаем о результатах загрузки */
           RGLog.Message("Всего обработано итогов клиринга из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
        end;
        Progress.Remove();
     end;
     i = 0;
     stat = 0;
     ErrMes = "";

     if(Pan.ksuwrt == SET_CHAR)
        RG = TGtRecordBatchCharger();
        RGLog.Message("ЗАГРУЗКА ЗАГРУЗКА ДАННЫХ О ВЫДАЧЕ/ПОГАШЕНИИ КСУ");
        Progress.Init(6, "Выполняется обработка данных", "Обработка данных");

        if(CheckFileUpload(synonim, "EQM99", pan.imp_date, @ErrMes))
           RGLog.Message("ПРЕДУПРЕЖДЕНИЕ: "+ErrMes, null, LOAD_WARNING); //Предупреждение загрузки об отсутствии файлов
           ErrMes = ""; NRec = 0;
        else
           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало очистки таблицы EQM99 " + time() );
           end;
           Message("Очистка таблицы EQM99");
         
           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.DelEQM99(?, ?); END;");
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);               
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));
         
           if(ReportFileName != "")
             println( "Конец очистки таблицы EQM99 " + time() );
             println( "Начало заполнения EQM99 " + time() );
           end;

           Progress.Use();

           if( stat == 0 )
             Message("Заполнение таблицы EQM99");
         
             cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.FillEQM99(?, ?, ?, ?); END;"); 
             cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
             cmdSP.addParam("", RSDBP_IN, SeanceID);
             cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
             cmdSP.addParam("", RSDBP_IN, Synonim);
             cmdSP.addParam("", RSDBP_IN, Pan.imp_date);
             cmdSP.Execute();
             stat = Int(cmdSP.value("stat"));
           end;

           if(ReportFileName != "")
             println( "Конец заполнения EQM99 " + time() );
           end;

           Progress.Use();
           if(ReportFileName != "")
             SetOutput( OldOutPut, TRUE );
           end;
         
           if( stat )
              RGLog.GetAndAddReceiveStorPrLog(RG_DLKSUWRT);
           else
              if(ReportFileName != "")
                OldOutPut = SetOutput( ReportFileName, TRUE );
                println( "Начало обновления объектов EQM99 " + time() );
              end;

              if( stat == 0)
                Message("Обновление данных для EQM99: объекты");

                cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateObjEQM99(?, ?); END;"); 
                cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                cmdSP.addParam("", RSDBP_IN, SeanceID);
                cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                cmdSP.Execute();
                stat = Int(cmdSP.value("stat"));
              end;
              Progress.Use();
              if(ReportFileName != "")
                println( "Конец обновления объектов EQM99 " + time() );
                SetOutput( OldOutPut, TRUE );
              end;
         
              Message("Обработка данных EQM99");
              //нужен чтобы показать в индикаторе кол-во обрабатываемых записей
              Query = "SELECT 1 FROM D_EQM99_TMP t WHERE t.T_REPORTDATE = ?";
              cmd = DL_RSDCommand(Query);
              cmd.AddParam(Pan.imp_date);
         
              NRec = cmd.GetCount();
              NumImportDeals = NRec; 
         
              if((stat == 0) AND (NRec > 0))
                 FilesName = "";
                 if( stat == 0)
                   stat = GetFileName( synonim, "D_EQM99_TMP", @FilesName, @ErrMes);
                 end;
                 RGLog.Message("Используются файлы: \n" + FilesName);
         
                 if(GetDialogFlag())
                    InitProgress(NRec, "Загрузка внешнего файла данных о выдаче/погашении КСУ", "ОБРАБОТКА ВХОДНЫХ ДАННЫХ EQM99");
                 end;
         
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Начало обработки данных из таблицы EQM99 " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;

                 cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.CreateReplRecByTmp_EQM99(?, ?, ?, ?); END;");
                 cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
                 cmdSP.addParam("", RSDBP_IN, SeanceID);
                 cmdSP.addParam("", RSDBP_IN, imp_date);
                 cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
                 cmdSP.addParam("", RSDBP_IN, MMVB_Code); 
                 cmdSP.Execute();
                 stat = Int(cmdSP.value("stat"));
         
                 if(ReportFileName != "")
                   OldOutPut = SetOutput( ReportFileName, TRUE );
                   println( "Конец обработки данных из таблицы EQM99 " + time() );
                   SetOutput( OldOutPut, TRUE );
                 end;
         
                 if(GetDialogFlag())
                    RemProgress(); 
                 end;
              end;
              Progress.Use();
           end;
        end;

        if(stat and (ErrMes != ""))
           RGLog.Error(ErrMes);
        elif(NRec == 0)
           RGLog.Message("Нет данных для загрузки.");
        else
           Progress.Use();
           Message("Заполнение протокола");
           /*загрузить в лог инфу о загруженных ЗР*/
           RGLog.GetAndAddReceiveStorPrLog(RG_DLKSUWRT);
           RGLog.GetAndAddReceiveLoadRecsMass(RG_DLKSUWRT, "Успешно загружены данные о выдаче/погашении КСУ с кодом \"","\"", @NumImportDealsTotal, PrintOnlyErr);
           Progress.Use();

           if(ReportFileName != "")
             OldOutPut = SetOutput( ReportFileName, TRUE );
             println( "Начало обновления таблицы в Payments " + time() );
           end;

           Message("Обновление данных в Payments");

           cmdSP = RSDCommand("BEGIN ? := RSB_GTIM_MMVB.UpdateEQM99_PM(?, ?, ?); END;"); 
           cmdSP.addParam("stat", RSDBP_OUT, V_INTEGER);
           cmdSP.addParam("", RSDBP_IN, SeanceID);
           cmdSP.addParam("", RSDBP_IN, SOURCE_CODE);
           cmdSP.addParam("", RSDBP_IN, Synonim);
           cmdSP.Execute();
           stat = Int(cmdSP.value("stat"));

           if(stat)
             RGLog.GetAndAddReceiveStorPrLog(RG_DLKSUWRT);
           end;
           Progress.Use();
           if(ReportFileName != "")
             println( "Конец обновления таблицы в Payments " + time() );
             /* сообщаем о результатах загрузки */
             SetOutput( OldOutPut, TRUE );
           end;

           /* сообщаем о результатах загрузки */
           RGLog.Message("Всего обработано данных о выдаче/погашении КСУ из Шлюза Payments - " + string(NumImportDeals) + "\nиз них успешно - " + string(NumImportDealsTotal) + "\nошибочно - " + string(NumImportDeals - NumImportDealsTotal));
        end;
        Progress.Remove();
     end;
  end;
  Progress.Init( 1, "Выполняется сохранение протокола", "Сохранение протокола"  );
  RGLog.Save();
  Progress.Use();
  Progress.Remove();
  return RetVal;

OnError(ErObj)
  if(GetDialogFlag())
    RemProgress(); RemProgress();
  end;
  MsgBox("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
  RunError;
end;

private macro RunInitPMTS(Pan)
   Pan.imp_date              = {curdate};
   Pan.request               = SET_CHAR;
   Pan.deals                 = SET_CHAR;
   Pan.deals_clearing        = SET_CHAR;
   Pan.deals_bo              = SET_CHAR;
   Pan.deals_seb             = SET_CHAR;
   Pan.request_otc           = SET_CHAR;
   Pan.deals_otc             = SET_CHAR;
   Pan.nettoitog             = UNSET_CHAR;
   Pan.ksuwrt                = UNSET_CHAR;
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)

   if (Cmd == DLG_INIT)
        RunInitPMTS(Pn);
        UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
      Pn.imp_date = GetDateByCalendar( Pn.imp_date );
      UpdateFields(Pn);

   elif ((Cmd == DLG_KEY) and (Key == 32)) /* Пробел */
      if ( (ID == PNFLD_REQUEST)
      or  (ID == PNFLD_SECUR)
      or  (ID == PNFLD_CLEARING)
      or  (ID == PNFLD_SEC_BO)
      or  (ID == PNFLD_SEC_SEB)
      or  (ID == PNFLD_REQUEST_OTC)
      or  (ID == PNFLD_SECUR_OTC)
      or  (ID == PNFLD_NETTOITOG) 
      or  (ID == PNFLD_KSUWRT) 
      )
         Pn(ID) = RG_IIF(Pn(ID) == SET_CHAR, UNSET_CHAR, SET_CHAR);
      end;
   elif ( (cmd == DLG_KEY) AND ( Key == 316 ) )
      return RunImportPMTS(Pn);
   elif ( (cmd == DLG_KEY) AND ( (Key == 13) or (Key == 323) ) )
      return CM_IGNORE;
   end;
   return CM_DEFAULT;
end;

macro Process( SeanceID, Parms )
end;

macro Receive( _SeanceID:integer, Parm:variant )
  SeanceID = _SeanceID;

  SOURCE_CODE = "SRC-28";
  MMVB_Code = MICEX_CODE;

  if( IsShedulerRunning() )
     RunInitPMTS(pp);
     AutoSetParm(pp, Parm);                     // пар-ры из панели источника
     AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
     RunImportPMTS(pp);     
  else
/*USR*/
     var autoproc;
     if( (GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc) )
        RunInitPMTS(pp);
        AutoSetParm(pp, Parm);
        RunImportPMTS(pp);
     else
/*USR*/
        RunDialog(pp, "ProcessPanel");
     end;
  end; /*USR*/

  return 0;
end;

macro Deliver( SeanceID, Parm )
end;
