/*
$Name: gtImUL.mac
$Module: Универсальный загрузчик
$Description: Загрузка внешних данных в шлюз
*/

IMPORT RsbDataSet, RSD, "ul_const.mac", "dl_ul.mac", "rgtgtlog.mac", "rgtgtrec.mac", "gtconst.inc", "gtdlfun.mac", "GTRrate.mac";

PRIVATE VAR
    prm_SeanceID = NULL,
    prm_Parm     = NULL,
    prm_RGLog    = NULL;

PRIVATE MACRO ClearGlobalVars()
    prm_SeanceID = NULL;
    prm_Parm     = NULL;
    prm_RGLog    = NULL;
END;

MACRO manipulation_func(_loader, _obj)
  var
      retVal = true,
      rs = TRsbDataSet("select * from ddl_ul_format_dbt where t_ID = " + _loader.Format),
      RG = NULL, RG_ObjectKind = "", RG_ObjectName = "";

    rs.MoveNext();

    if (rs.ID_DATAKIND == UL_DATAKIND_RATES)
        RG = RGRate(prm_RGLog, true, _obj.StartDate, NULL, 0, _obj.PartyCodeKind, String("SCR-20"), NULL);
        RG.ParseAndLoadValue(_obj.FICode, String(_obj.Value), _obj.RateKind, _obj.Market_Place, "", "", "");
    elif (rs.ID_DATAKIND == UL_DATAKIND_FRX)
        RslDefCon.BeginTrans();
        RG_ObjectKind = RG_FOREX;
        RG_ObjectName = "Сделки КО ("+ _obj.DealCodeTS +")";

        RG = TgtRecord(1, prm_SeanceID, NULL, RG_ObjectKind, RG_ObjectName, Создать, "", 2);
        if (not RG.InitByCode(NULL, RG_ObjectName, "SRC-20", ""))
            RunError("Ошибка инициализации\n");
        end;

        if (not RG.SetParmByName("RGREU_DealType", _obj.DealType))
            RunError("Ошибка установки параметра RGREU_DealType\n");end;

        if (not RG.SetParmByName("RGREU_501", _obj.DealCodeTS))
            RunError("Ошибка установки параметра RGREU_501\n");end;

        if (not RG.SetParmByName("RGREU_502", _obj.DealDate))
            RunError("Ошибка установки параметра RGREU_502\n");end;

        if (not RG.SetParmByName("RGREU_503", _obj.DealTime))
            RunError("Ошибка установки параметра RGREU_503\n");end;

        if (not RG.SetParmByName("RGREU_504", _obj.TraderID))
            RunError("Ошибка установки параметра RGREU_504\n");end;

        if (not RG.SetParmByName("RGREU_508", _obj.PartyID))
            RunError("Ошибка установки параметра RGREU_508\n");end;

        if (not RG.SetParmByName("RGREU_510", _obj.BrokerID))
            RunError("Ошибка установки параметра RGREU_510\n");end;

        if (not RG.SetParmByName("RGREU_514", _obj.TypeDoc))
            RunError("Ошибка установки параметра RGREU_514\n");end;

        if (not RG.SetParmByName("RGREU_517", _obj.DealPart.BaseFIID))
            RunError("Ошибка установки параметра RGREU_517\n");end;

        if (not RG.SetParmByName("RGREU_518", _obj.DealPart.ContrFIID))
            RunError("Ошибка установки параметра RGREU_518\n");end;

        if (not RG.SetParmByName("RGREU_519", _obj.DealPart.Principal))
            RunError("Ошибка установки параметра RGREU_519\n");end;

        if (not RG.SetParmByName("RGREU_522", _obj.DealPart.Price))
            RunError("Ошибка установки параметра RGREU_522\n");end;

        if (not RG.SetParmByName("RGREU_523", _obj.RevDealPart.Price))
            RunError("Ошибка установки параметра RGREU_523\n");end;

        if (not RG.SetParmByName("RGREU_524", _obj.DealPart.RevRate))
            RunError("Ошибка установки параметра RGREU_524\n");end;

        if (not RG.SetParmByName("RGREU_525", _obj.DealPart.BaseDate))
            RunError("Ошибка установки параметра RGREU_525\n");end;

        if (not RG.SetParmByName("RGREU_526", _obj.DealPart.ContrDate))
            RunError("Ошибка установки параметра RGREU_526\n");end;

        if (not RG.SetParmByName("RGREU_527", _obj.RevDealPart.BaseDate))
            RunError("Ошибка установки параметра RGREU_527\n");end;

        if (not RG.SetParmByName("RGREU_528", _obj.RevDealPart.ContrDate))
            RunError("Ошибка установки параметра RGREU_528\n");end;

        if (not RG.SetParmByName("RGREU_529", _obj.DealPart.BasePI))
            RunError("Ошибка установки параметра RGREU_529\n");end;

        if (not RG.SetParmByName("RGREU_530", _obj.DealPart.ContrPI))
            RunError("Ошибка установки параметра RGREU_530\n");end;

        if (not RG.SetParmByName("RGREU_531", _obj.RevDealPart.BasePI))
            RunError("Ошибка установки параметра RGREU_531\n");end;

        if (not RG.SetParmByName("RGREU_532", _obj.RevDealPart.ContrPI))
            RunError("Ошибка установки параметра RGREU_532\n");end;

        if (not RG.SetParmByName("RGREU_553", _obj.Comment))
            RunError("Ошибка установки параметра RGREU_553\n");end;

        if (not RG.SetParmByName("RGREU_575", _obj.DealPart.BaseBankID))
            RunError("Ошибка установки параметра RGREU_575\n");end;

        if (not RG.SetParmByName("RGREU_576", _obj.DealPart.ContrBankID))
            RunError("Ошибка установки параметра RGREU_576\n");end;

        if (not RG.SetParmByName("RGREU_577", _obj.RevDealPart.BaseBankID))
            RunError("Ошибка установки параметра RGREU_577\n");end;

        if (not RG.SetParmByName("RGREU_578", _obj.RevDealPart.ContrBankID))
            RunError("Ошибка установки параметра RGREU_578\n");end;

        if (not RG.SetParmByName("RGREU_Comiss", Money(0)))
            RunError("Ошибка установки параметра RGREU_Comiss\n");end;
    elif (rs.ID_DATAKIND == UL_DATAKIND_IBC)
        RslDefCon.BeginTrans();
        RG_ObjectKind = RG_MM;
        RG_ObjectName = "Сделки МБК ("+ _obj.DealCodeTS +")";

        RG = TgtRecord(1, prm_SeanceID, NULL, RG_ObjectKind, RG_ObjectName, Создать, "", 2);
        if (not RG.InitByCode(NULL, RG_ObjectName, "SRC-20", ""))
            RunError("Ошибка инициализации\n");
        end;

        if (not RG.SetParmByName("RGREU_DealType", _obj.DealType))
            RunError("Ошибка установки параметра RGREU_DealType\n");end;

        if (not RG.SetParmByName("RGREU_501", _obj.DealCodeTS))
            RunError("Ошибка установки параметра RGREU_501\n");end;

        if (not RG.SetParmByName("RGREU_502", _obj.DealDate))
            RunError("Ошибка установки параметра RGREU_502\n");end;

        if (not RG.SetParmByName("RGREU_503", _obj.DealTime))
            RunError("Ошибка установки параметра RGREU_503\n");end;

        if (not RG.SetParmByName("RGREU_504", _obj.TraderID))
            RunError("Ошибка установки параметра RGREU_504\n");end;

        if (not RG.SetParmByName("RGREU_508", _obj.PartyID))
            RunError("Ошибка установки параметра RGREU_508\n");end;

        if (not RG.SetParmByName("RGREU_510", _obj.BrokerID))
            RunError("Ошибка установки параметра RGREU_510\n");end;

        if (not RG.SetParmByName("RGREU_514", _obj.TypeDoc))
            RunError("Ошибка установки параметра RGREU_514\n");end;

        if (not RG.SetParmByName("RGREU_517", _obj.PFI))
            RunError("Ошибка установки параметра RGREU_517\n");end;

        if (not RG.SetParmByName("RGREU_519", _obj.Principal))
            RunError("Ошибка установки параметра RGREU_519\n");end;

        if (not RG.SetParmByName("RGREU_520", _obj.PercentData.Value))
            RunError("Ошибка установки параметра RGREU_520\n");end;

        if (not RG.SetParmByName("RGREU_525", _obj.Start))
            RunError("Ошибка установки параметра RGREU_525\n");end;

        if (not RG.SetParmByName("RGREU_527", (_obj.Start + _obj.Duration)))
            RunError("Ошибка установки параметра RGREU_527\n");end;

        if (not RG.SetParmByName("RGREU_529", _obj.PI))
            RunError("Ошибка установки параметра RGREU_529\n");end;

        if (not RG.SetParmByName("RGREU_531", _obj.PI))
            RunError("Ошибка установки параметра RGREU_531\n");end;

        if (not RG.SetParmByName("RGREU_553", _obj.Comment))
            RunError("Ошибка установки параметра RGREU_553\n");end;

        if (not RG.SetParmByName("RGREU_570", _obj.Interest))
            RunError("Ошибка установки параметра RGREU_570\n");end;

        if (not RG.SetParmByName("RGREU_571", _obj.Duration))
            RunError("Ошибка установки параметра RGREU_571\n");end;

        if (not RG.SetParmByName("RGREU_572", 0))
            RunError("Ошибка установки параметра RGREU_572\n");end;

        if (not RG.SetParmByName("RGREU_575", _obj.BankID))
            RunError("Ошибка установки параметра RGREU_575\n");end;

        if (not RG.SetParmByName("RGREU_577", _obj.BankID))
            RunError("Ошибка установки параметра RGREU_577\n");end;
    else
        if (ValType(_loader.Log) != V_UNDEF)
            RunError("Не известный вид данных");
        end;
    end;

    if (RslDefCon.IsInTrans)
        RslDefCon.CommitTrans();
    end;

    return retVal;

  OnError(err)
      if (RslDefCon.IsInTrans)
          RslDefCon.RollbackTrans();
      end;
      _loader.AddErrorLog(err.Message);
      return false;
END;

MACRO log_func(_log)
  var
      idx = 0,
      ar_log = _log.GetLog();

    while (idx < ar_log.size)
        prm_RGLog.Error(ar_log[idx]);
        idx = idx + 1;
    end;
END;

///////////////////////////////////////////////////////////////////////////////////
Macro Process(SeanceID, Parms)
end;

//import
Macro Receive(_SeanceID, Parm)
    ClearGlobalVars();
    prm_SeanceID = _SeanceID;
    prm_Parm     = Parm;
    prm_RGLog    = GTDL_Log(_SeanceID);

    LoadExternalData(NULL, "manipulation_func", "log_func");

    prm_RGLog.Save();
    ClearGlobalVars();
end;

Macro Deliver (SeanceID, Parm)
end;
