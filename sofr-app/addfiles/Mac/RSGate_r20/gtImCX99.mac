/*
$Name:        gtImCX99.mac
$Module:      Шлюз Securities
$Description: Загрузка ММВБ xml-формат файла биржи
PNV i-support 522711 в макрос перенесена загрузка комиссий из ccx10 чтобы не создавать новые источники
*/

/*bpv создан на основе gtImMVB4 ради отдеьлного импорта CCX99 по валютной брокерке*/


import gtImMVB_DL, "secinter.mac", "gtmktrep.mac", "rgtgtrec.mac", "GTRrate.mac", "DlForms_h.mac","dldlngfun.mac";
/*ak*/
import gtdlfun_u;
/*~ak*/

/*настраиваемые пользователем константы*/
/* используется для задания вида курса, если он не задан во входном файле с котировками */
PRIVATE CONST RATE_KIND_MARKET     = 1;  /*курс вида "Рыночная цена"         */        
PRIVATE CONST RATE_KIND_MIN        = 2;  /*курс вида "Минимальная цена"      */
PRIVATE CONST RATE_KIND_MAX        = 3;  /*курс вида "Максимальная цена"     */
PRIVATE CONST RATE_KIND_WA         = 4;  /*курс вида "Средневзвешенная цена" */
PRIVATE CONST RATE_KIND_NKD1SEC    = 15; /*курс вида "НКД на одну бумагу"    */
PRIVATE CONST RATE_KIND_VOLUME     = 17; /*курс вида "Объём торгов"          */
PRIVATE CONST RATE_KIND_MARKET_TAX = 21; /*курс вида "Рыночная цена для НДФЛ"*/

PRIVATE CONST SET_CHAR   = "X";
PRIVATE CONST UNSET_CHAR = "";

PRIVATE VAR NumImportDeals = 0, NumImportDealsTotal = 0,
            NumImportDealsCliring = 0, NumImportDealsTotalCliring = 0,
            CodeRate = "", RateKind_ = "", NumImportRates = 0, NumImportRatesTotal = 0;

PRIVATE record pp(IMP_PRM3, "rgate.lbr") dialog;
private var SeanceID, RG, RGLog, ErrMes:string = "", CodeCommis = "", FlagCtrlBrk:bool = false;

private const CtrlBrkErr = 17;
private const PNFLD_BEGDATE = 0,
              PNFLD_ENDDATE = 1;

private macro ЧислоСтрокой( _var, _point:integer )
   return ExecExp("String(_var:0" + ":" + string(_point) + ")");
end;

PRIVATE CONST PNFLD_IMPDATE         = 0,
              PNFLD_MARKET          = 1,
              PNFLD_RATES           = 2,
              PNFLD_COMP            = 3,
              PNFLD_PAYM            = 4,
              PNFLD_REQUEST         = 5,
              PNFLD_SECUR           = 6,
              PNFLD_CLEARING        = 7,
              PNFLD_CLEARING_CLIENT = 8,
              PNFLD_SEC_BO          = 9,
              PNFLD_SEC_SEB         = 10,
              PNFLD_SEC_DU          = 11,
              PNFLD_MAR_SCHEME_DU   = 12,
              PNFLD_NETTOITOG       = 13,
              PNFLD_MONEYMOTION     = 14;

private class DataMoneyMotion(_StatementAcc, _EntryCodeType, _EntryNumber, _EntryCorAcc, _EntryPurposePayment, _EntryDebit, _EntryCredit,
                                  _EntryDate, _EntryPayAcc, _EntryRecAcc, _ExtSettleCodeID, _OtherKlirAcc)
        var StatementAcc:string                             =   _StatementAcc,
        EntryCodeType:integer                               =   _EntryCodeType,
        EntryNumber:string                                  =   _EntryNumber,
        EntryCorAcc:string                                  =   _EntryCorAcc,
        EntryPurposePayment:string                          =   _EntryPurposePayment,
        EntryDebit:money                                    =   _EntryDebit,
        EntryCredit:money                                   =   _EntryCredit,
        EntryDate:date                                      =   _EntryDate,
        EntryPayAcc:string                                  =   _EntryPayAcc,
        EntryRecAcc:string                                  =   _EntryRecAcc,
        ExtSettleCodeID:string                              =   _ExtSettleCodeID,
        OtherKlirAcc:string                                 =   _OtherKlirAcc;

    macro Init()
        OtherKlirAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = EntryRecAcc = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
end;

    macro InitRecords()
        StatementAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;
END;

private class CommisRec()
  var DocNo:string,
      ReportDate:date,
      ExtCode:string,
      CommisType:integer,
      CommisName:string,
      CommSum:money,
      ITSVAT:money;

  macro Init()
     DocNo = ExtCode = CommisName = "";
     ReportDate = date(0,0,0);
     CommisType = 0;
     CommSum = ITSVAT = $0.0;
  end;

  macro InitRecords()
     CommisName = "";
     CommisType = 0;
     CommSum = ITSVAT = $0.0;
  end;
end;

private var MoneyMotion = DataMoneyMotion();
private var VRCommisRec = CommisRec();

private macro FileDate( date_val, delim )
  var day, month, year;
  DateSplit(date_val, day, month, year);

  if (ValType(delim) == V_UNDEF)
     delim = "";
  end;

  year = year - 1900;
  if( year >= 100 )
     year = year - 100;
  end;

  return RGDLFUN_LZ(day,2) + delim + RGDLFUN_LZ(month,2) + delim + RGDLFUN_LZ(year,2);
end;

/* настраиваемый пользователем макрос формирования имен файла */
private macro get_data_file_name( pfx:string, CurImpDate:date, datafilepath:@string, datafilemask:@string )
  var ErrStr:string = "";

  datafilemask = "???????_" + pfx + "_???_" + FileDate(CurImpDate, "") + "_?????????.xml";
  datafilepath = GetRegImportDirU(CurImpDate, @ErrStr);
  datafilepath = datafilepath  + "\\" ; 

  var List = TDirList(datafilepath + datafilemask, "f");

  List.Sort(0);

  return List;
end;

private macro get_data_file_name_list( folder:string, pfx:string, datafilepath:@string, datafilename:@tarray, comment_from_:string )
   var ErrStr = "";

   datafilepath = GetRegImportDirU(imp_date, @ErrStr);
   var datafilemask = "MB?????_" + pfx + "_???_" + FileDate(imp_date) + "_?????????" + ".xml";

   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      return 1;
   else
      var ilist = 0;
      while(ilist < List.Count)
        datafilename[datafilename.size] = List.name(ilist);
        ilist = ilist + 1;
      end;
      return 0;
   end;

end;

private macro get_data_file_name_list_mc( folder:string, pfx:string, datafilepath:@string, datafilename:@tarray, comment_from_:string )
   var ErrStr = "";

   datafilepath = GetRegImportDirU(imp_date, @ErrStr);

   var datafilemask = "MC?????_" + pfx + "_???_" + FileDate(imp_date) + "_?????????" + ".xml";
   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      return 1;
   else
      var ilist = 0;
      while(ilist < List.Count)
        datafilename[datafilename.size] = List.name(ilist);
        ilist = ilist + 1;
      end;
      return 0;
   end;

end;


private macro PutMoneyMotion()
   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_MONEYMOTION_CM, 
                   String("Движение денежных средств №" + MoneyMotion.EntryNumber),
                   Создать );

   if(NOT RG.InitByCode(RG_MONEYMOTION_CM, MoneyMotion.EntryNumber, SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("EXT_SETTLECODE", MoneyMotion.ExtSettleCodeID);
   RG.SetParmByName("ACCOUNT", MoneyMotion.StatementAcc);
   RG.SetParmByName("CODETYPE", MoneyMotion.EntryCodeType);
   RG.SetParmByName("COR_ACC", MoneyMotion.EntryCorAcc);
   RG.SetParmByName("PAY_ACC", MoneyMotion.EntryPayAcc);
   RG.SetParmByName("REC_ACC", MoneyMotion.EntryRecAcc);
   RG.SetParmByName("PURPOSE_PAYMENT", MoneyMotion.EntryPurposePayment);
   RG.SetParmByName("DEBIT", MoneyMotion.EntryDebit);
   RG.SetParmByName("CREDIT", MoneyMotion.EntryCredit);
   RG.SetParmByName("DATE", MoneyMotion.EntryDate);
   RG.SetParmByName("OTHERKLIRACC", MoneyMotion.OtherKlirAcc);

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;

end;
macro PutCommisInfo()

  var FlagAbortTRN = false;

  macro Exit()
     FlagAbortTRN = true;
     AbortTRN;
  end;

  RG = TGTRecord( ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_DVCOMMISVR,
                  "Комиссионное вознаграждение с расчетным кодом " + VRCommisRec.ExtCode + " на " + string(VRCommisRec.ReportDate),
                  Создать );

  if( not RG.InitByCode(RG_DVCOMMISVR, VRCommisRec.DocNo + "_" + VRCommisRec.ExtCode + "_" + string(VRCommisRec.CommisType) + "_" + string(VRCommisRec.ReportDate), SOURCE_CODE) )
     AbortTRN;
  end;

  RG.SetParmByName("RGDVCVVR_DATE",       VRCommisRec.ReportDate);
  RG.SetParmByName("RGDVCVVR_EXTCODE",    VRCommisRec.ExtCode);
  RG.SetParmByName("RGDVCVVR_COMMISTYPE", VRCommisRec.CommisType);
  RG.SetParmByName("RGDVCVVR_COMMISNAME", VRCommisRec.CommisName); 
  RG.SetParmByName("RGDVCVVR_COMMSUM",    VRCommisRec.CommSum); 
  RG.SetParmByName("RGDVCVVR_ITSVAT",     VRCommisRec.ITSVAT); 

  if( RG.Save() != true )
     if( RG.GetLastError() )
        ErrMes = ErrMes + "\n" + RG.GetLastError();
     end;
     Exit();
  end;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     AbortTRN;
  else
     if( FlagAbortTRN == false )
        RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError(), RG);
     end;
  end;
end;

private macro WriteCommisData( NumImportCVVR:@integer, NumImportCVVRTotal:@integer ):bool
  var RetVal:bool = true;

  ErrMes = "";
  CodeCommis = VRCommisRec.ExtCode + "_" + string(VRCommisRec.CommisType) + "_" + string(VRCommisRec.ReportDate);

  NumImportCVVR = NumImportCVVR + 1;

  if( ProcessTrn(0, "PutCommisInfo") )
     NumImportCVVRTotal = NumImportCVVRTotal + 1;
     RGLog.Message("Успешно загружено комиссионное вознаграждение \"" + CodeCommis + "\"\n" + ErrMes, RG, SUCCESS);
     RetVal = true;
  else
     RGLog.Error("Ошибка при загрузке комиссионного вознаграждения \"" + CodeCommis + "\"\n" + ErrMes, RG);
     RetVal = false;
  end;

  ErrMes = "";

  return RetVal;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     return true;
  end;
end;

private macro ДнейВГоду( YYYY:INTEGER ):INTEGER
   return DATE( 31,12,YYYY )-DATE( 1,1,YYYY )+1;
end;

private macro ЗаполнитьДругойКлирСчет(DataOtherSchema:TArray, EntryDebit:money, EntryCredit:money, EXTSettleCodeID:integer, EntryDate:date, EntryCodeType:integer, EntryPurposePayment:string, OtherAccount:@string)
    var i:integer = 0;

    while(i < DataOtherSchema.Size)
        if( (( (DataOtherSchema[i].EntryDebit == EntryDebit) AND (EntryDebit !=0)) OR ((DataOtherSchema[i].EntryCredit == EntryCredit) AND (EntryCredit !=0)) ) /*and (DataOtherSchema[i].ExtSettleCodeID == EXTSettleCodeID)*/ and (DataOtherSchema[i].EntryDate == EntryDate) and (DataOtherSchema[i].EntryCodeType == EntryCodeType) and 
           (substr(DataOtherSchema[i].EntryPurposePayment,1,strlen(DataOtherSchema[i].EntryPurposePayment)-1) == substr(EntryPurposePayment,1,strlen(EntryPurposePayment)-1)))
            OtherAccount = DataOtherSchema[i].StatementAcc;
            break;
        end;
        i = i + 1;
    end;
end;

private macro import_ccx10_to_gate(datafilename):integer

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportCVVR:integer = 0, NumImportCVVRTotal:integer = 0;
  var node:object, child_MicexDoc:object, child_CCX10:object, child_SETTLE1:object, child_TYPE:object, child_RECORDS:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, l:integer = 0;
  var ExtBuff = TRecHandler( "dl_extsettlecode.dbt" ); // Для проверки расчетного кода

  private macro RunImp()
                                   
     if( WriteCommisData(@NumImportCVVR, @NumImportCVVRTotal) != true )
        return 1;
     end;

     return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  VRCommisRec.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;

  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
     child_MicexDoc = node.childNodes.item(i);
     if( child_MicexDoc and (child_MicexDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_MicexDoc.tagname) == "DOC_REQUISITES" )
           VRCommisRec.DocNo = "";
           if( ReadTagAttribut(child_MicexDoc, "DOC_NO", V_STRING, VRCommisRec.DocNo) == false )
              /* если не нашли уникальный учетный номер документа в системе электронного документооборота */
           end;
        end;
        if( StrUpr(child_MicexDoc.tagname) == "CCX10" )
           VRCommisRec.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, VRCommisRec.ReportDate) == false )
              /* если не нашли дату формирования отчета */
           end;
           j = 0;
           while( j < child_MicexDoc.childNodes.length ) /* бегаем по CCX10 */
              child_CCX10 = child_MicexDoc.childNodes.item(j);
              if( child_CCX10 and (child_CCX10.nodeType == CHILD_NODE) )
                 if( StrUpr(child_CCX10.tagname) == "SETTLE1" )
                    VRCommisRec.ExtCode = "";
                    if( ReadTagAttribut(child_CCX10, "EXTSETTLECODE", V_STRING, VRCommisRec.ExtCode) == false )
                       /* если не нашли расчетный код участника клиринга */
                    end;
                    k = 0;
                    while( k < child_CCX10.childNodes.length ) /* бегаем по SETTLE1 */
                       child_SETTLE1 = child_CCX10.childNodes.item(k);
                       if( child_SETTLE1 and (child_SETTLE1.nodeType == CHILD_NODE) )
                          if( StrUpr(child_SETTLE1.tagname) == "TYPE" )
                             if(GetDialogFlag())
                                InitProgress(child_CCX10.childNodes.length, "Загрузка внешнего файла итогов клиринга", "Просмотр записей...");
                             end;
                             l = 0;
                             while( l < child_SETTLE1.childNodes.length ) /* бегаем по TYPE */
                                child_TYPE = child_SETTLE1.childNodes.item(l);
                                if( child_TYPE and (child_TYPE.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_TYPE.tagname) == "RECORDS" )
                                      VRCommisRec.InitRecords();
                                      if( ReadTagAttribut(child_TYPE, "COMMISTYPE", V_INTEGER, VRCommisRec.CommisType) == false )
                                        /* если не нашли вид комиссии */
                                      end;
                                      if( ReadTagAttribut(child_TYPE, "COMMISNAME", V_STRING, VRCommisRec.CommisName) == false )
                                        /* если не нашли описание комиссии */
                                      end;
                                      if( ReadTagAttribut(child_TYPE, "COMM", V_MONEY, VRCommisRec.CommSum) == false )
                                        /* если не нашли сумму комиссионного вознаграждения */
                                      end;
                                      if( ReadTagAttribut(child_TYPE, "ITSVAT", V_MONEY, VRCommisRec.ITSVAT) == false )
                                        /* если не нашли сумму НДС */
                                      end; 
                                      // Проверяем наличие кода в справочнике
                                      ExtBuff.clear();
                                      if( FindDL_EXTSETTLECODEbyCode( VRCommisRec.ExtCode, ExtBuff ) != 0 ) 
                                      end;
                                      if ((ExtBuff.rec.CodeType == DL_EXTCODETYPE_CLIENT) and (VRCommisRec.CommisType == 99)) // В справочнике код для клиента тип комиссии - 99 ежемесячная
                                           if( RunImp() )
                                               stat = 1;
                                           end;
                                      end;
                                   end;
                                end;
                                l = l + 1;
                                if( GetDialogFlag() )
                                   UseProgress(l);
                                end;
                                if( FlagCtrlBrk == true )
                                   break;
                                end;
                             end;
                             if( GetDialogFlag() )
                                RemProgress(); 
                             end;
                          end;
                       end;
                       k = k + 1;
                    end;
                 end;
              end;     
              j = j + 1;
           end;
        end;
     end;
     i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано комиссий - " + string(NumImportCVVR) + "\nиз них успешно - " + string(NumImportCVVRTotal) + "\nошибочно - " + string(NumImportCVVR - NumImportCVVRTotal));

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
end;

private macro GetInfoFromCCX99(DataArray:@TArray, datafilename_CCX99)
    var xml:object = ActiveX( "MSXML.DOMDocument" );
    var node:object, child_MicexDoc:object, child_CCX99:object, child_ExtSettleCode:object, child_Statement:object, child_Entry:object;
    var i = 0, j = 0, k = 0, l = 0;
    var stat = 0;
    var data_filepath_CCX99 = "", data_filename_CCX99 = ""/*, datafilename_CCX99 = ""*/;
    var DOC_REQUISITES = false, CCX99 = false;
    var ID = 0, Debit = 0, Credit = 0, EntryDate = date(0, 0, 0), CodeType = 0, Account = "", PurposePayment = "";

         var data_filename_list_CCX99 = tarray();
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name_list("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_list_CCX99);
         end;

         if(stat == 0)
            var ifile = 0;
            while(ifile < data_filename_list_CCX99.size)
               if(GetDialogFlag())
                   InitProgress(-1, "Поиск движений денежных средств для перевода с другого клирингового счета", "Просмотр данных...");
               end;

               if(not xml.load(data_filepath_CCX99 + data_filename_list_CCX99(ifile)))
                   RGLog.Error( "Неверный формат файла импорта|"+ data_filename_list_CCX99(ifile)+ "|Невозможно загрузить xml-документ" );
                   return;
               end;

               node = xml.DocumentElement;
               i = 0; CCX99 = false;DOC_REQUISITES = false;
               while(i < node.ChildNodes.Length)
                   child_MicexDoc = node.childNodes.item(i);
                   if(child_MicexDoc.tagname == "DOC_REQUISITES")
                       if(DOC_REQUISITES)
                           RGLog.Error(string(data_filename_list_CCX99(ifile), ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
                           return false;
                       end;
                       DOC_REQUISITES = true;
                   end;

                   if(child_MicexDoc.tagname == "CCX99")
                       if(CCX99)
                           RGLog.Error(string(data_filename_list_CCX99(ifile), ": Блок MICEX_DOC\CCX99 должен присутствовать в единственном экземпляре"));
                           return false;
                       end;
                       CCX99 = true;

                       j = 0;
                       while(j < child_MicexDoc.ChildNodes.Length)
                           child_ExtSettleCode = child_MicexDoc.ChildNodes.item(j);
                           if(child_ExtSettleCode.tagname == "EXTSETTLECODE")
                               ID = 0;
                               if(ReadTagAttribut(child_ExtSettleCode, "ID", V_INTEGER, ID) == false)
                               end;

                               k = 0;
                               while(k < child_ExtSettleCode.childNodes.Length)
                                   child_Statement = child_ExtSettleCode.childNodes.item(k);
                                   if(child_Statement.tagname == "STATEMENT")
                                       Account = "";
                                       if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, Account) == false)
                                       end;

                                       l = 0;
                                       while(l < child_Statement.childNodes.Length)
                                           child_Entry = child_Statement.childNodes.item(l);
                                           CodeType = 0;
                                           Debit = $0.0;
                                Credit = $0.0;
                                           EntryDate = date(0, 0, 0);
                                           PurposePayment = "";
                                           if(child_Entry.tagname == "ENTRY")
                                               if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, CodeType) == false)
                                               end;

                                               if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, Debit) == false)
                                               end;

                                    if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, Credit) == false)
                                    end;

                                               if(ReadTagAttribut(child_Entry, "DATE", V_DATE, EntryDate) == false)
                                               end;

                                               if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, PurposePayment) == false)
                                               end;

                                               if((Debit > 0) and ((CodeType == 20) or (CodeType == 813)))
                                                   DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, Debit, $0.0, EntryDate, "", "", ID);
                                    elif((Credit > 0) AND (CodeType == 813))
                                        DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, $0.0, Credit, EntryDate, "", "", ID);
                                               end;
                                           end;

                                           l = l + 1;
                                       end;
                                   end;

                                   k = k + 1;
                               end;
                           end;

                           j = j + 1;
                       end;
                   end;

                   i = i + 1;
               end;

               if(GetDialogFlag())
                   RemProgress();
               end;

              ifile = ifile + 1;
            end;
         end;


         /*bpv еще раз, но уже по файлам фондового рынка, т.к. перевод мог выполняться оттуда*/
         data_filename_list_CCX99 = tarray();
         if(MMVB_Code == MICEX_CODE_FB)
            stat = get_data_file_name_list_mc("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_list_CCX99);
         end;
         if(stat == 0)
            ifile = 0;
            while(ifile < data_filename_list_CCX99.size)
               if(GetDialogFlag())
                   InitProgress(-1, "Поиск движений денежных средств для перевода с другого клирингового счета", "Просмотр данных...");
               end;

               if(not xml.load(data_filepath_CCX99 + data_filename_list_CCX99(ifile)))
                   RGLog.Error( "Неверный формат файла импорта|"+ data_filename_list_CCX99(ifile)+ "|Невозможно загрузить xml-документ" );
                   return;
               end;

               node = xml.DocumentElement;
               i = 0; CCX99 = false;DOC_REQUISITES = false;
               while(i < node.ChildNodes.Length)
                   child_MicexDoc = node.childNodes.item(i);
                   if(child_MicexDoc.tagname == "DOC_REQUISITES")
                       if(DOC_REQUISITES)
                           RGLog.Error(string(data_filename_list_CCX99(ifile), ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
                           return false;
                       end;
                       DOC_REQUISITES = true;
                   end;

                   if(child_MicexDoc.tagname == "CCX99")
                       if(CCX99)
                           RGLog.Error(string(data_filename_list_CCX99(ifile), ": Блок MICEX_DOC\CCX99 должен присутствовать в единственном экземпляре"));
                           return false;
                       end;
                       CCX99 = true;

                       j = 0;
                       while(j < child_MicexDoc.ChildNodes.Length)
                           child_ExtSettleCode = child_MicexDoc.ChildNodes.item(j);
                           if(child_ExtSettleCode.tagname == "EXTSETTLECODE")
                               ID = 0;
                               if(ReadTagAttribut(child_ExtSettleCode, "ID", V_INTEGER, ID) == false)
                               end;

                               k = 0;
                               while(k < child_ExtSettleCode.childNodes.Length)
                                   child_Statement = child_ExtSettleCode.childNodes.item(k);
                                   if(child_Statement.tagname == "STATEMENT")
                                       Account = "";
                                       if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, Account) == false)
                                       end;

                                       l = 0;
                                       while(l < child_Statement.childNodes.Length)
                                           child_Entry = child_Statement.childNodes.item(l);
                                           CodeType = 0;
                                           Debit = $0.0;
                                           EntryDate = date(0, 0, 0);
                                           PurposePayment = "";
                                           if(child_Entry.tagname == "ENTRY")
                                               if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, CodeType) == false)
                                               end;
                                               if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, Debit) == false)
                                               end;

                                               if(ReadTagAttribut(child_Entry, "DATE", V_DATE, EntryDate) == false)
                                               end;

                                               if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, PurposePayment) == false)
                                               end;

                                               if((Debit > 0) and ((CodeType == 20) or (CodeType == 813)))
                                                   DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, Debit, $0.0, EntryDate, "", "", ID);
                                               end;
                                           end;

                                           l = l + 1;
                                       end;
                                   end;

                                   k = k + 1;
                               end;
                           end;

                           j = j + 1;
                       end;
                   end;

                   i = i + 1;
               end;

               if(GetDialogFlag())
                   RemProgress();
               end;
              ifile = ifile + 1;
            end;
         end;


OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
end;

private macro import_deals_to_gate_from_CCX99( datafilename_CCX99 )
   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var node:object, child_MicexDoc:object, child_Requisites:object, child_CCX99:object,
       child_ExtSettleCode:object, child_Statement:object, child_Entry:object,
       child_Security:object, child_Trdacc:object;
   var DOC_REQUISITES = false, CCX99 = false, EXTSETTLECODE = false, STATEMENT = false, ENTRY = false;
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0;
   var stat:integer = 0;
   var DataOtherKlirArray = TArray(); DataOtherKlirArray.Size = 0;
   var ExtBuff = TRecHandler( "dl_extsettlecode.dbt" ); // Golovkin 24.04.2020 ID : 509063 Для проверки расчетного кода


   const AccountCode = "01054";

   FileImport = FileCCX99;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
       VAR NoError = true;
       ErrMes = "";
       WarnMes = "";
       if(ProcessTrn(0, "PutMoneyMotion"))
          RGLog.Message( "Движение денежных средств с номером \"" + MoneyMotion.EntryNumber + "\" уcпешно загружено в шлюз" + ErrMes, RG, SUCCESS );
       else
          RGLog.Error( "Ошибка при вставке движения денежных средств\n" + ErrMes, RGMkRep );
          return 1;
       end;
       return 0;

    OnError(ErObj)

       RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
 
       if(ErObj.Code == CtrlBrkErr)
          FlagCtrlBrk = true;
       else
          RemProgress();
          RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
       end;
       return ErObj.Code;
   end;

   //Собираем движения денежных средств для сравнения с CODETYPE = 20 и CODETYPE = 813

   GetInfoFromCCX99(@DataOtherKlirArray, datafilename_CCX99);

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;
   if( not xml.load(datafilename_CCX99) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_CCX99, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   /* считаем параметры сделок */
   i=0;
   while( i < node.childNodes.length )
      child_MicexDoc = node.childNodes.item(i);
      if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))
         if(child_MicexDoc.tagname == "CCX99")
            j = 0;
            while(j < child_MicexDoc.childNodes.Length)
                child_ExtSettleCode = child_MicexDoc.childNodes(j);
                if(ReadTagAttribut(child_ExtSettleCode, "ID", V_STRING, MoneyMotion.ExtSettleCodeID) == false)
                   /* если не нашли расчетный код */
                end;

               // Golovkin 24.04.2020 ID : 509063 Проверяем наличие кода в справочнике
               ExtBuff.clear();
               if( FindDL_EXTSETTLECODEbyCode( MoneyMotion.ExtSettleCodeID, ExtBuff ) != 0 ) 
               end;

               if((valtype(MoneyMotion.ExtSettleCodeID) == V_STRING) and 
                         ((MoneyMotion.ExtSettleCodeID == "16791") or
                          (MoneyMotion.ExtSettleCodeID == "16818") or
                          (MoneyMotion.ExtSettleCodeID == "16820") or
                          (MoneyMotion.ExtSettleCodeID == "16821") or
                          (MoneyMotion.ExtSettleCodeID == "16822") or
                          (MoneyMotion.ExtSettleCodeID == "16823") or
                          (MoneyMotion.ExtSettleCodeID == "16824") or
                          (MoneyMotion.ExtSettleCodeID == "16825") or
                          (MoneyMotion.ExtSettleCodeID == "17957") or/*CHVA*/
                          (MoneyMotion.ExtSettleCodeID == "16826") or
                          ((ExtBuff.rec.MarketKind == DV_MARKETKIND_CURRENCY) AND (ExtBuff.rec.CodeType == DL_EXTCODETYPE_CLIENT)) // Golovkin код в справочнике обозначен как клиентский на валютном рынке
                          ))

                   if(GetDialogFlag())
                      InitProgress(child_ExtSettleCode.childNodes.length, "Загрузка внешнего файла движений денежных средств", "Просмотр блока данных о движении ДС в разрезе расчетного кода...");
                   end;
                   k = 0;
                   while(k < child_ExtSettleCode.childNodes.Length)
                       child_Statement = child_ExtSettleCode.childNodes(k);
                       MoneyMotion.StatementAcc = "";
                       if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, MoneyMotion.StatementAcc) == false)
                          /* если не нашли номер счета */
                       end;
                       if(GetDialogFlag() and (child_Statement.childNodes.length > 0))
                          InitProgress(child_Statement.childNodes.length, "Загрузка внешнего файла движений денежных средств", "Просмотр данных по счету...");
                       end;
                           l = 0;
                           while(l < child_Statement.childNodes.Length)
                               child_Entry = child_Statement.childNodes(l);
                               MoneyMotion.Init();
                               if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, MoneyMotion.EntryCodeType) == false)
                                  /* если не нашли код типа операции */
                               end;
                               if(    (MoneyMotion.EntryCodeType == 20) or (MoneyMotion.EntryCodeType == 812) or (MoneyMotion.EntryCodeType == 813)
                                   or (MoneyMotion.EntryCodeType == 916) or (MoneyMotion.EntryCodeType == 918)
                                 )
                                   if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, MoneyMotion.EntryNumber) == false)
                                      /* если не нашли номер документа */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "COR_ACC", V_STRING, MoneyMotion.EntryCorAcc) == false)
                                      /* если не нашли номер корреспондирующего счета */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, MoneyMotion.EntryPurposePayment) == false)
                                      /* если не нашли комментарии */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, MoneyMotion.EntryDebit) == false)
                                      /* если не нашли дебет */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, MoneyMotion.EntryCredit) == false)
                                      /* если не нашли кредит */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "DATE", V_DATE, MoneyMotion.EntryDate) == false)
                                      /* если не нашли дату операции */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, MoneyMotion.EntryPayAcc) == false)
                                      /* если не нашли счет плательщика */
                                   end;
                                   if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, MoneyMotion.EntryRecAcc) == false)
                                      /* если не нашли счет получателя */
                                   end;

                                   if(((MoneyMotion.EntryCodeType == 20) or (MoneyMotion.EntryCodeType == 813)) and (MoneyMotion.EntryCredit > 0))
                                       ЗаполнитьДругойКлирСчет(DataOtherKlirArray, 0, MoneyMotion.EntryCredit, MoneyMotion.EXTSettleCodeID, MoneyMotion.EntryDate, MoneyMotion.EntryCodeType, MoneyMotion.EntryPurposePayment, @MoneyMotion.OtherKlirAcc);
                                 elif( (MoneyMotion.EntryDebit >0 ) AND  (MoneyMotion.EntryCodeType == 813))
                                    ЗаполнитьДругойКлирСчет(DataOtherKlirArray, MoneyMotion.EntryDebit, 0, MoneyMotion.EXTSettleCodeID, MoneyMotion.EntryDate, MoneyMotion.EntryCodeType, MoneyMotion.EntryPurposePayment, @MoneyMotion.OtherKlirAcc);
                                   end;

                                   if ( 
                                          (( MoneyMotion.EntryCodeType != 812 ) and (MoneyMotion.EntryCodeType != 916 ))
                                       or (SubStr(MoneyMotion.StatementAcc, 6, 3) != "810" )
                                      ) /*bpv рублевые переводы через кс не грузим*/
                                      if(RunImp())
                                          stat = 1;
                                      end;
                                   end;
                               end;
                               
                               l = l + 1;
                               if(GetDialogFlag())
                                  UseProgress(l);
                               end;
                               if( FlagCtrlBrk == true )
                                  break;
                               end;
                           end;
                       if(GetDialogFlag() and (child_Statement.childNodes.length > 0))
                          RemProgress(); 
                       end;
                       k = k + 1;
                       if(GetDialogFlag())
                          UseProgress(k);
                       end;
                       if( FlagCtrlBrk == true )
                          break;
                       end;
                   end;
                end;
                if(GetDialogFlag())
                   RemProgress(); 
                end;
                j = j + 1;
                if( FlagCtrlBrk == true )
                   break;
                end;
            end;
         end;
         i = i + 1;
         if( FlagCtrlBrk == true )
            break;
         end;
      end;
   end;
END;
private macro ResultCopyFile(done:bool, data_filepath:string, data_filename:string)
/*ak - ничего никуда не переностим*/
   return;
/*~ak*/

   var data_file_new_path, data_file_new_file;

   if(done)
      data_file_new_path = data_filepath + "Done\\";
   else
      data_file_new_path = data_filepath + "Err\\";
   end;

   MakeDir(data_file_new_path);
   data_file_new_path = data_file_new_path + string(FileDate(imp_date)) + "\\";
   MakeDir(data_file_new_path);

   data_file_new_file = data_file_new_path + data_filename;

   if(not CopyFile(data_filepath + data_filename, data_file_new_file ) )
      RGLog.Error("Ошибка копирования файла " + data_filename + " в " + data_file_new_file);
   else
      RGLog.Message("Файл " + data_filename + " скопирован в " + data_file_new_file);
   end;

end;

private macro RunImportCCX99( Pan )
   var stat:integer, stat_SEM03:integer = -1;
   var data_filepath_EQM06:string = "", data_filename_EQM06:string = "";
   var data_filepath_EQM6C:string = "", data_filename_EQM6C:string = "";
   var data_filepath_SEM02:string = "", data_filename_SEM02:string = "";
   var data_filepath_SEM03:string = "", data_filename_SEM03:string = "";
   var data_filepath_SET21:string = "", data_filename_SET21:string = "";
   var data_filepath_SET25:string = "", data_filename_SET25:string = "";
   var data_filepath_SET26:string = "", data_filename_SET26:string = "";
   var data_filepath_CCX99:string = "", data_filename_CCX99:string = "";
   var data_filepath_EQM13:string = "", data_filename_EQM13:string = "";
   var RetVal = CM_SAVE;
   if( CheckPanel(Pan, @MMVB_Code, @MarketScheme_BO, @MarketScheme_DU, true) == false )
      RetVal = CM_IGNORE;
   end;

   if( RetVal != CM_IGNORE )
      RGLog = GTDL_Log(SeanceID);
      imp_date = Pan.imp_date;


      if(Pan.MoneyMotion == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ДВИЖЕНИЯ ДЕНЕЖНЫХ СРЕДСТВ");
         if(not DL_ИспользPaymentsПриИмпортеВалютногоРынка(@ErrMes))
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;      
            stat = 1;
            var data_filename_list_CCX99 = tarray();
            if(MMVB_Code == MICEX_CODE_FB)
               stat = get_data_file_name_list("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_list_CCX99);
            end;
       
            if(stat == 0)
               var ifile = 0;
               while(ifile < data_filename_list_CCX99.size)
                 RGLog.Message("Используется файл " + data_filename_list_CCX99(ifile));
                 if(import_deals_to_gate_from_CCX99(data_filepath_CCX99 + data_filename_list_CCX99(ifile)))
                     ResultCopyFile(true, data_filepath_CCX99, data_filename_CCX99);
                 else
                     ResultCopyFile(false, data_filepath_CCX99, data_filename_CCX99);
                 end;
                 ifile = ifile + 1;
               end;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ ДВИЖЕНИЙ ДЕНЕЖНЫХ СРЕДСТВ ВАЛЮТНОГО РЫНКА НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ_ВР, Шлюз PAYMENTS\"", null, WARNING );
         end;
      end;


    //  RGLog.Save();
   end;

   return RetVal;
end;

private macro RunInitCCX99(Pan)
   Pan.imp_date              = {curdate};
   Pan.Market                = MMVB_Code = MICEX_CODE_FB;
   Pan.rates                 = UNSET_CHAR;
   Pan.comp                  = UNSET_CHAR;
   Pan.paym                  = UNSET_CHAR;
   Pan.request               = UNSET_CHAR;
   Pan.deals                 = UNSET_CHAR;
   Pan.deals_clearing        = UNSET_CHAR;
   Pan.deals_clearing_client = UNSET_CHAR;
   Pan.deals_bo              = UNSET_CHAR;
   Pan.deals_seb             = UNSET_CHAR;
   Pan.deals_du              = UNSET_CHAR;
   Pan.MarketSchemeDU        = "";
   Pan.MoneyMotion           = SET_CHAR;
   Pan.NettoItog             = UNSET_CHAR;

   DisableFields( Pan, PNFLD_CLEARING_CLIENT );
   DisableFields( Pan, PNFLD_RATES );
   DisableFields( Pan, PNFLD_COMP );
   DisableFields( Pan, PNFLD_PAYM );
   DisableFields( Pan, PNFLD_REQUEST );
   DisableFields( Pan, PNFLD_SECUR );
   DisableFields( Pan, PNFLD_CLEARING );
   DisableFields( Pan, PNFLD_CLEARING_CLIENT );
   DisableFields( Pan, PNFLD_SEC_BO );
   DisableFields( Pan, PNFLD_SEC_SEB );
   DisableFields( Pan, PNFLD_SEC_DU );
   DisableFields( Pan, PNFLD_MAR_SCHEME_DU );
   DisableFields( Pan, PNFLD_NETTOITOG );

end;
private macro RunImportCVVR( Pan )

  var stat:integer = 0;
  var data_filepath_CVVR:string = "", data_filemask_CVVR:string = "";
  var List = NULL;
  var i:integer = 0;
  var RetVal = CM_SAVE;

  if( CheckPanel(Pan) == false )
     RetVal = CM_IGNORE;
  end;

  if( RetVal != CM_IGNORE )
     //RGLog = GTDL_Log(SeanceID);
     RGLog.Message("Импорт файлов о комиссионных вознаграждениях");

     var CurImpDate:date = imp_date;

     if(not DL_ИспользPaymentsПриИмпортеВалютногоРынка(@ErrMes))
        if( ErrMes != "" )
           RGLog.Error(ErrMes); ErrMes = "";
        end;      
        var j:integer = 0;
        if( GetDialogFlag() )
           InitProgress(1, "Загрузка файлов за период дат", "Просмотр дат...");
        end;                                                                                                                                                 
        while( CurImpDate <= imp_date )
           List = get_data_file_name("CCX10", CurImpDate, @data_filepath_CVVR, @data_filemask_CVVR);
           if( List != NULL )
              i = 0;
              while( i < List.Count )
                 RGLog.Message("Используется файл " + List.name(i));
                 if( import_ccx10_to_gate(data_filepath_CVVR + List.name(i)) == 0 )
                    ResultCopyFile(true, data_filepath_CVVR, List.name(i), CurImpDate);
                 else
                    ResultCopyFile(false, data_filepath_CVVR, List.name(i), CurImpDate);
                 end;
                 i = i + 1;
              end;
              if( i == 0 )
                 RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + data_filepath_CVVR + data_filemask_CVVR );
              end;
           end;
     
           CurImpDate = CurImpDate + 1;
           j = j + 1;
           if( GetDialogFlag() )
              UseProgress(j);
           end;
           if( FlagCtrlBrk == true )
              break;
           end;
        end;
        if( GetDialogFlag() )
           RemProgress(); 
        end;
     else
        RGLog.Message("ДЛЯ ЗАГРУЗКИ КОМИССИОННЫХ ВОЗНАГРАЖДЕНИЙ ВАЛЮТНОГО РЫНКА НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ММВБ_ВР, Шлюз PAYMENTS\"", null, WARNING );
     end;

    // RGLog.Save();
  end;

  return RetVal;

OnError( RslErrObj )
  if( GetDialogFlag() )
     RemProgress(); 
  end;
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)
   var Party, DlMarket;

   if (Cmd == DLG_INIT)
        RunInitCCX99(Pn);
        PumpMarketScheme(@Pn, true);
        UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_MARKET) ) /* F3 */
      Party = TRecHandler("party.dbt");
      if( ListPT( Party, MMVB_CodeKind, Pn.Market, PTLIST_MARKETPLASE, PTCK_CONTR) == true )
         MMVB_Code = Pn.Market;
         PumpMarketScheme(@Pn, true);
         UpdateFields(Pn);
      end;

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
      Pn.imp_date = GetDateByCalendar( Pn.imp_date );
      UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) and (ID == PNFLD_MAR_SCHEME_DU) ) /* F3 */
      if(ID == PNFLD_MAR_SCHEME_DU)
         ListMarketScheme(@Pn, true);
      end;

   elif( (Cmd == DLG_KEY) and (Key == 32) ) /* Пробел */
      if ((ID == PNFLD_RATES)
      or  (ID == PNFLD_COMP)
      or  (ID == PNFLD_PAYM)
      or  (ID == PNFLD_REQUEST)
      or  (ID == PNFLD_SECUR)
      or  (ID == PNFLD_CLEARING)
      or  (ID == PNFLD_CLEARING_CLIENT)
      or  (ID == PNFLD_SEC_BO)
      or  (ID == PNFLD_SEC_SEB)
      or  (ID == PNFLD_SEC_DU)
      or  (ID == PNFLD_NETTOITOG)
      or  (ID == PNFLD_MONEYMOTION))
         Pn(ID) = IIF(Pn(ID) == SET_CHAR, UNSET_CHAR, SET_CHAR);
         end;

      if ((Pn(PNFLD_REQUEST) == UNSET_CHAR) and (Pn(PNFLD_SECUR) == UNSET_CHAR)
      and (Pn(PNFLD_CLEARING) == UNSET_CHAR) and (Pn(PNFLD_CLEARING_CLIENT) == UNSET_CHAR))
            Pn(PNFLD_SEC_BO)  = UNSET_CHAR;
            Pn(PNFLD_SEC_SEB) = UNSET_CHAR;
            Pn(PNFLD_SEC_DU)  = UNSET_CHAR;
            DisableFields( Pn, PNFLD_SEC_BO );
            DisableFields( Pn, PNFLD_SEC_SEB );
            DisableFields( Pn, PNFLD_SEC_DU );
         else
               EnableFields( Pn, PNFLD_SEC_BO );
               EnableFields( Pn, PNFLD_SEC_SEB );
               EnableFields( Pn, PNFLD_SEC_DU );
            end;

         if( Pn(PNFLD_SEC_DU) == SET_CHAR )
            EnableFields( Pn, PNFLD_MAR_SCHEME_DU );
         else
         DisableFields(Pn, PNFLD_MAR_SCHEME_DU);
      end;

      UpdateFields(Pn);

   elif ( (Cmd == DLG_KEY) and (Key == 316) )
      return RunImportCCX99(Pn);

   elif( (Cmd == DLG_KEY) and ( (Key == 13) or (Key == 323) ) )
      return CM_IGNORE;

   end;

   return CM_DEFAULT;
end;

macro Process(SeanceID, Parms)
end;

macro Receive(_SeanceID:integer, Parm:variant)
   SeanceID = _SeanceID;
   SOURCE_CODE = "SRC-99";

   record _party(party);
   var RS;
RGLog = GTDL_Log(SeanceID);
   if( IsShedulerRunning() )
      RunInitCCX99(pp);
      AutoSetParm(pp, Parm);                     // пар-ры из панели источника
      AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
      RunImportCCX99(pp);
      RunImportCVVR(pp);
   else
     var autoproc;
     if((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
       RunInitCCX99(pp);
       AutoSetParm(pp, Parm);
       RunImportCCX99(pp);
       RunImportCVVR(pp);
     else
       RunDialog(pp, "ProcessPanel");
     end;
   end;
   RGLog.Save();
   return 0;
end;

macro Deliver (SeanceID, Parm)
end;
