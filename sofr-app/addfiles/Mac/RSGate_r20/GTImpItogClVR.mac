/*
$Name:        GTImpItogClVR.mac
$Module:      Шлюз
$Description: Импорт данных по валютам (итоговых нетто-ТО) в регистр расчетов по ФИ
*/

import "or_tools.mac", "gtdlfun.mac", "fi.mac";

PRIVATE CONST KIND_SETTLEMENT_MARKET_OPERATION = 2830; /* вид операции Расчеты с биржей */
PRIVATE CONST KIND_CUR_MARKET_OPERATION = 2835; /* вид операции Обработка итогов биржевых валютных торгов */

/* Аналог оператора ?: в си. */
private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
end;

private macro FindServOper( DocKind:integer, DocDate:date, MarketKind:integer, ExtBuff:TRecHandler, OperCode:@string, ErrMes:@string )
  var DLQuery, DLComm;
  var RsdDLQuery = DL_RSdCommand();
  var Err:string = "", OperName:string = "", B_CODE:string = "";
  var OperID:integer = 0;

  ErrMes = "";

  if( DocKind == DL_SETTLEMENTFCURM )
     OperName = "\"Расчеты с биржей\"";
  elif( DocKind == DL_DVCURMARKET )
     OperName = "\"Обработка итогов валютных биржевых торгов\"";
  end;

  DLQuery = "SELECT comm.t_DocumentID, comm.t_CommCode, comm.t_CommStatus " + 
            "  FROM ddl_comm_dbt comm"                                      +   
            " WHERE comm.t_DocKind = ?  "                                   +                      
            "   AND (comm.t_CommStatus = ? OR comm.t_CommStatus = ?) "      +
            "   AND comm.t_CommDate = ? "                                   +
            "   AND comm.t_OperSubKind = ? "                                +
            "   AND comm.t_PartyID = ? ";

  RsdDLQuery.AddParam( DocKind );  
  RsdDLQuery.AddParam( DL_COMM_READIED );
  RsdDLQuery.AddParam( DL_COMM_PREPARING ); 
  RsdDLQuery.AddParam( DocDate );
  RsdDLQuery.AddParam( ExtBuff.rec.CodeType );
  RsdDLQuery.AddParam( ExtBuff.rec.MarketID );
  
  if( DocKind == DL_SETTLEMENTFCURM )
     DLQuery = DLQuery + " AND comm.t_ContractKind = ? ";
     RsdDLQuery.AddParam( MarketKind ); 
     if( MarketKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS )
        DLQuery = DLQuery + " AND comm.t_MarketSchemeID = ? ";
        RsdDLQuery.AddParam( ExtBuff.rec.MarketSchemeID ); 
     if( ExtBuff.rec.InPool == SET_CHAR )
        DLQuery = DLQuery + " AND comm.t_Flag1 = chr(88) AND comm.t_Flag2 = case when EXISTS(SELECT 1 FROM ddl_extscanalytics_dbt WHERE t_CodeID = ?) then chr(88) else chr(0) end ";
        RsdDLQuery.AddParam( IIF(ExtBuff.rec.ParentID == 0, ExtBuff.rec.ID, ExtBuff.rec.ParentID) );
     else
        DLQuery = DLQuery + " AND comm.t_Flag1 = chr(0) AND comm.t_Flag2 = chr(0) ";
     end;
  end;
  end;
           
  DLComm = RsdDLQuery.Execute( DlQuery );

  if( DLComm.MoveNext() )
     OperID = DLComm.DocumentID;
     OperCode = DLComm.CommCode;
     if( DLComm.CommStatus == DL_COMM_PREPARING )
        ErrMes = "Открытая сервисная операция " + OperName + " за дату " + DocDate + " не найдена. Будет стартована отложенная сервисная операция с требуемыми параметрами\n";
        if( DL_Open_MarketOpInDL_Comm(OperID) != 0 ) // Вызов API открытия операции (на случай, если операция отложенная или шаг "Открытие дня" откатили вручную, иначе ничего не должна делать)
           ErrMes = ErrMes + "Не удалось открыть операцию " + OperName + " №" + OperCode + "! " + GetErrMsg() + "\n";
        end;
     end;
  else
     ErrMes = IIF(ExtBuff.rec.CodeType == ALG_SP_MONEY_SOURCE_OWN, "Собственная", "Клиентская") + " сервисная операция " + OperName + 
              IIF(DocKind == DL_SETTLEMENTFCURM, " c биржевым рынком " + IIF(MarketKind == DL_MARKETKIND_SETTLE_STOCK_T0, "Фондовый T0", "Фондовый T+, заданной схемой расчетов") + 
                                                 " и " + IIF(ExtBuff.rec.InPool == SET_CHAR, "установленным", "сброшенным") + " признаком \"Единый пул обеспечения\"", "") + 
              " за дату " + DocDate + " не найдена! " + IIF(MarketKind == DL_MARKETKIND_SETTLE_STOCK_T0, "Требуется создать операцию вручную", "Будет создана новая операция с требуемыми параметрами") + ".\n";

     if( DocKind == DL_DVCURMARKET )
        if( DV_CreateCurMarketOp(KIND_CUR_MARKET_OPERATION, DocDate, ExtBuff.rec.CodeType, ExtBuff.rec.MarketID, true, OperID, OperCode) != 0 ); // Вызов API для создания операции Обработка итогов биржевых валютных торгов       
           ErrMes = ErrMes + "Не удалось создать операцию " + OperName + " за дату " + DocDate + "!\n" + GetErrMsg();
           return -1;         
        end;
     elif( (DocKind == DL_SETTLEMENTFCURM) and (MarketKind != DL_MARKETKIND_SETTLE_STOCK_T0) ) // Для Т0 не создаем СО автоматически, т.к. неизместна схема расчетов
        if( DL_CreateSettlementMarketOp(KIND_SETTLEMENT_MARKET_OPERATION, DocDate, ExtBuff.rec.CodeType, ExtBuff.rec.MarketID, MarketKind, IIF(ExtBuff.rec.InPool == SET_CHAR,true,false), 
                                        ExtBuff.rec.MarketSchemeID, NULL, NULL, true, OperID, OperCode) != 0 ); // Вызов API для создания операции Расчеты с биржей
           ErrMes = ErrMes + "Не удалось создать операцию " + OperName + " за дату " + DocDate + "!\n" + GetErrMsg();
           return -1;         
        end;
     end;
  end;

  return OperID;
end;

private macro InsertItogFI( DocID:integer, DocKind:integer, FIID:integer, NettoSum:money, LiabTypeID:integer, LiabMarketKind:integer, ParentID:integer, MarketSchemeID:integer )
  var cmd = RsdCommand( "insert into ddl_totaloffi_dbt( t_DocID, T_DocKind, t_CodeFI, t_ClearingResult, t_LiabType, t_Market, t_Parent, t_MarketSchemeID ) " 
                                      " values( ?, ?, ?, ?, ?, ?, ?, ? ) returning t_ID into ? " );
  cmd.AddParam( "", RSDBP_IN, DocID );
  cmd.AddParam( "", RSDBP_IN, DocKind );
  cmd.AddParam( "", RSDBP_IN, FIID );
  cmd.AddParam( "", RSDBP_IN, NettoSum );
  cmd.AddParam( "", RSDBP_IN, LiabTypeID );
  cmd.AddParam( "", RSDBP_IN, LiabMarketKind );
  cmd.AddParam( "", RSDBP_IN, ParentID );
  cmd.AddParam( "", RSDBP_IN, MarketSchemeID );
  cmd.addParam( "ID", RSDBP_OUT, V_INTEGER );
  cmd.execute();
  
  return cmd.value("ID");
end;

private macro UpdateItogFI( ID:integer, NewNettoSum:money )
  var cmd = RSDCommand( "update ddl_totaloffi_dbt "
                        "   set t_ClearingResult = ? "
                        " where t_ID = ? " );
  cmd.AddParam( "", RSDBP_IN, NewNettoSum );
  cmd.AddParam( "", RSDBP_IN, ID );
  cmd.execute();
end;

private macro GetLiabInfo( LiabType:string, LiabTypeID:@integer, LiabMarket:@integer )
  LiabType = Replace(LiabType, " ", ""); //Т.к. в данных ММВБ расходится наличие/отсутствие пробелов в некоторых типах

  if( LiabType == "PR_NETTOSUM" )
     LiabMarket = 0;
     LiabTypeID = DL_TOTALOFFI_LIABTYPE_PRIVITOGS;
  elif( LiabType == "SETTL_OBLIG" )
     LiabMarket = 0;
     LiabTypeID = DL_TOTALOFFI_LIABTYPE_SETTLETRANS;
  elif( SubStr(LiabType, 1, 4) == "SEC_" )
     LiabMarket = DV_MARKETKIND_STOCK;
     if( LiabType == "SEC_M" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_DEALLIAB;
     elif( LiabType == "SEC_M_FEE" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_COMMISS;
     elif( LiabType == "SEC_M_DEBT" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_INDEBTEDNESS;
     elif( LiabType == "SEC_M_PEN" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_FORFEITS;
     end;
  elif( SubStr(LiabType, 1, 3) == "FX_" )
     LiabMarket = DV_MARKETKIND_CURRENCY;
     if( LiabType == "FX_OBLIG" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_DEALLIAB;
     elif( LiabType == "FX_VM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_VARMARGIN;
     elif( LiabType == "FX_FEE" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_COMMISS;
     end;
  elif( SubStr(LiabType, 1, 6) == "DERIV_" )
     LiabMarket = DV_MARKETKIND_DERIV;
     if( LiabType == "DERIV_VM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_VARMARGIN;
     elif( LiabType == "DERIV_FEE" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_COMMISS;
     end;
  elif( SubStr(LiabType, 1, 4) == "OTC_" )
     LiabMarket = DV_MARKETKIND_SPFIMARKET;
     if( LiabType == "OTC_VM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_VARMARGIN;
     elif( LiabType == "OTC_TVM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_VARMARGIN_ACCUM;
     elif( LiabType == "OTC_DM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_DEPOMARGIN;
     elif( LiabType == "OTC_ITDM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_DEPOMARGIN_INTEREST;
     elif( LiabType == "OTC_VFSUM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_INTEREST_PAYM;
     elif( LiabType == "OTC_OSUM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_INITIAL_PAYM_AT_PAR;
     elif( LiabType == "OTC_CSUM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_FINAL_PAYM_AT_PAR;
     elif( LiabType == "OTC_SUM" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_PAYM_SETTLEMENTS;
     elif( LiabType == "OTC_PAY" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_OPTIONBONUS;
     elif( LiabType == "OTC_AUC" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_AUCTIONFEE;
     elif( LiabType == "OTC_AGRPAY" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_AGRPAYM;
     elif( LiabType == "OTC_FEE" )
        LiabTypeID = DL_TOTALOFFI_LIABTYPE_COMMISS;
     elif( LiabType == "OTC_IMI" )
        LiabTypeID = 18/*DL_TOTALOFFI_LIABTYPE_CLEARING_INTEREST*/; //USR
     end;
  elif( LiabType == "CHANGE_BALANCE" )
    LiabMarket = DV_MARKETKIND_CURRENCY;
    LiabTypeID = DL_TOTALOFFI_LIABTYPE_DEALLIAB;
  end;
end;

macro _DLItogClVR_CreateNew( RecordID:integer, SeanceID:integer, ID:@string, Comment:@string ):integer
  var FinInstr = TRecHandler( "fininstr.dbt" );
  var Ext = TRecHandler( "dl_extsettlecode.dbt" );
  var Analytics = TRecHandler("dl_extscanalytics.dbt");
  var RsdDLQuery = DL_RSdCommand(), cmd;
  var DLQuery, DLComm, ItogFI;

  var type_:integer = 0, ErrMes:string = "";
  var DocType:string = "", ExtCode:string = "", Currency:string = "", LiabType:string = "";
  var DocDate:date = date(0,0,0);
  var LiabNettoSum:money = $0.0;
  var MarketSchemeID:integer = 0;

  var FIID:integer = 0, SettleOperTPlusID:integer = 0, SettleOperT0ID:integer = 0, CurMarkOperID:integer = 0, ParentID:integer = 0, LiabTypeID:integer = 0, LiabMarket:integer = 0;
  var SettleOperTPlusCode:string = "", SettleOperT0Code:string = "", CurMarkOperCode:string = "";
  var UniPool:bool = false, WasParent:bool = false;
 
  InitError();

  Comment = "";

  var RG = TGTRecord();

  if( RG == NULL )
     RunError("Ошибка при создании объекта TGTRecord");
  end;

  if( RG.LoadFromDB(RecordID) != true )
     RunError( "Ошибка при загрузке параметров итогов нетто-требований и нетто-обязательств из шлюза." + RG.GetLastError() );
  end;

  var SourceID = RG.GetSourceID();

  if( (GetParmByName(RG, "RGDLICVR_TYPE", @DocType, @type_ ) == NULL) OR (type_ != V_STRING) )
     RunError( "Ошибка при получении параметра RGDLICVR_TYPE" );
  end;

  if( (GetParmByName(RG, "RGDLICVR_DATE", @DocDate, @type_ ) == NULL) OR (type_ != V_DATE) )
     RunError( "Ошибка при получении параметра RGDLICVR_DATE" );
  end;

  if( (GetParmByName(RG, "RGDLICVR_EXTCODE", @ExtCode, @type_ ) == NULL) OR (type_ != V_STRING) )
     RunError( "Ошибка при получении параметра RGDLICVR_EXTCODE" );
  end;

  if( (GetParmByName(RG, "RGDLICVR_CURRENCY", @Currency, @type_ ) == NULL) OR (type_ != V_STRING) )
     RunError( "Ошибка при получении параметра RGDLICVR_CURRENCY" );
  end;

  if( (GetParmByName(RG, "RGDLICVR_NETTOSUM", @LiabNettoSum, @type_ ) == NULL) OR (type_ != V_MONEY) )
     RunError( "Ошибка при получении параметра RGDLICVR_NETTOSUM" );
  end;

  if( (GetParmByName(RG, "RGDLICVR_LIABTYPE", @LiabType, @type_ ) == NULL) OR (type_ != V_STRING) )
     if( ( SourceID == GT_MMVB3 )  OR (SourceID == GT_PAYMENTS) )
        RunError( "Ошибка при получении параметра RGDLICVR_LIABTYPE" );
     end;
  end;

  if( (SourceID == GT_MMVB3) OR (SourceID == GT_PAYMENTS) OR (SourceID == GT_SPVB))
     GetLiabInfo( LiabType, @LiabTypeID, @LiabMarket );
  elif( (SourceID == GT_SPB) or (SourceID == GT_PAYMENTS_SPB) )
     LiabMarket = DV_MARKETKIND_STOCK;
  end;

  if( FindDL_EXTSETTLECODEbyCode( ExtCode, Ext ) != 0 )
     ErrMes = GetErrMsg();
     if( ErrMes != "" )
        Comment = "Расчетный код " + ExtCode + " не может быть использован.\n" + ErrMes;
        else
        Comment = "В справочнике расчетных кодов банка не найден код " + ExtCode + ".";
     end;
     return 1;
  else 
     if( (SourceID == GT_MMVB3) or (SourceID == GT_PAYMENTS) or (SourceID == GT_SPB) or (SourceID == GT_PAYMENTS_SPB))
        if( (Ext.rec.MarketKind != DL_MARKETKIND_SETTLE_STOCK_TPLUS) or (((SourceID == GT_SPB) or (SourceID==GT_PAYMENTS_SPB)) and (Ext.rec.InPool == SET_CHAR)) )
           Comment = "Загрузка итогов ФИ для биржевого рынка, указанного для расчетного кода " + ExtCode + " в справочнике расчетных кодов банка, не производится.";
           return 1;
        end;
     end;
  end; 

  if( ((SourceID == GT_MMVB3) or (SourceID == GT_PAYMENTS)) and (Ext.rec.CodeType == ALG_SP_MONEY_SOURCE_CLIENT) ) 
     Currency = RG_GetFullFICodeVR(Currency); //Подменим код ФИ для драгметаллов BOSS-4303
  end;

  if( ПолучитьФинИн( Currency, FinInstr, NULL, NULL, NULL, IIF(((SourceID == GT_SPB) or (SourceID == GT_PAYMENTS_SPB)),FICK_SPBEX,FICK_MICEX) ) != 0 )
     if( ПолучитьФинИн( Currency, FinInstr, NULL, NULL, NULL, FICK_ISOSTRING ) != 0 )
        Comment = "Финансовый инструмент с кодом \"" + Currency + "\" не найден в справочнике";
        return 1;
     else
        FIID = FinInstr.rec.FIID;
     end;
  else
     FIID = FinInstr.rec.FIID;     
  end;

 /*KD*/
  If(( not ЕдиныйПулОбеспеченияКлиентСделок(@ErrMes)) and (SourceID == GT_MMVB3))
      If((Ext.rec.MarketKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (Ext.rec.CodeType != ALG_SP_MONEY_SOURCE_OWN) )
          Ext.rec.centrofficeid = 7;
          Ext.rec.marketschemeid = 13;
      end;
  end;
  
  UniPool = IIF( Ext.rec.CodeType == ALG_SP_MONEY_SOURCE_OWN, ЕдиныйПулОбеспеченияСобствСделок(@ErrMes), ЕдиныйПулОбеспеченияКлиентСделок(@ErrMes) );
  if( ErrMes != "" )
     Comment = ErrMes;
     return 1;
  end;

  if( (SourceID == GT_MMVB3) or (SourceID == GT_PAYMENTS) or (SourceID == GT_SPB) or (SourceID == GT_PAYMENTS_SPB))
     if( (Ext.rec.InPool == SET_CHAR) and UniPool ) 
        SettleOperTPlusID = FindServOper( DL_SETTLEMENTFCURM, DocDate, DL_MARKETKIND_SETTLE_STOCK_TPLUS, Ext, @SettleOperTPlusCode, @ErrMes );
           Comment = Comment + ErrMes;
           if( SettleOperTPlusID <= 0 ) 
              return 1;
           end;
     elif( (Ext.rec.InPool != SET_CHAR) and (LiabMarket == DV_MARKETKIND_STOCK) )
        SettleOperT0ID = FindServOper( DL_SETTLEMENTFCURM, DocDate, DL_MARKETKIND_SETTLE_STOCK_T0, Ext, @SettleOperT0Code, @ErrMes );
        Comment = Comment + ErrMes;

        SettleOperTPlusID = FindServOper( DL_SETTLEMENTFCURM, DocDate, DL_MARKETKIND_SETTLE_STOCK_TPLUS, Ext, @SettleOperTPlusCode, @ErrMes );
           Comment = Comment + ErrMes;
           if( SettleOperTPlusID <= 0 ) 
              return 1;
           end;
     elif( LiabMarket != DV_MARKETKIND_STOCK )
        Comment = "Итоги по ФИ с видом обязательства " + LiabType + " не загружены, так как не относятся к фондовому рынку."; // Ошибку не возвращаем, просто чтобы не было пустого комментария
        end; 
     end;
  if( (SourceID == GT_ICVR) or (( (SourceID == GT_MMVB3)  OR (SourceID == GT_PAYMENTS) or (SourceID == GT_SPVB)) and ((Ext.rec.InPool == SET_CHAR) or (SourceID == GT_SPVB)) and UniPool and (LiabMarket == DV_MARKETKIND_CURRENCY)) )  
     CurMarkOperID = FindServOper( DL_DVCURMARKET, DocDate, DL_MARKETKIND_SETTLE_CURRENCY, Ext, @CurMarkOperCode, @ErrMes ); 
     Comment = Comment + ErrMes;
     if( CurMarkOperCode <= 0 ) 
        return 1;
     end;                                                                                                                          

     MarketSchemeID = Ext.rec.MarketSchemeID;
     if( Ext.rec.InPool == SET_CHAR ) 
        if( FindDL_EXTSCANALYTICSbyMarketKind(IIF(Ext.rec.ParentID == 0, Ext.rec.ID, Ext.rec.ParentID), DL_MARKETKIND_SETTLE_CURRENCY, Analytics) == 0 )
           MarketSchemeID = Analytics.rec.MarketSchemeID;
        end;
     end;                                                                                                                        
  end;

     if( SettleOperT0ID > 0 )
        cmd = DL_RSDCommand( "select t_ID, t_ClearingResult "
                             "  from ddl_totaloffi_dbt " 
                             " where t_DocID   = ? "
                             "   and t_DocKind = ? "
                             "   and t_CodeFI  = ? "
                             "   and t_Parent  = 0 " );
        cmd.AddParam( SettleOperT0ID );
        cmd.AddParam( DL_SETTLEMENTFCURM );
        cmd.AddParam( FIID );

        ItogFI = cmd.Execute();

        if( ItogFI.MoveNext() )
           Comment = Comment + "Код " + Currency + " уже был загружен в регистр \"Итоги по ФИ\" операции \"Расчеты с биржей\" №" + SettleOperT0Code + "\n";
        else
        InsertItogFI( SettleOperT0ID, DL_SETTLEMENTFCURM, FIID, 0, 0, 0, 0, "" );
           Comment = Comment + "Код " + Currency + " успешно загружен в регистр \"Итоги по ФИ\" операции \"Расчеты с биржей\" №" + SettleOperT0Code + "\n";
        end;
     end;

     if( SettleOperTPlusID > 0 )
        cmd = DL_RSDCommand( "select t_ID, t_ClearingResult "
                             "  from ddl_totaloffi_dbt " 
                             " where t_DocID   = ? "
                             "   and t_DocKind = ? "
                             "   and t_CodeFI  = ? "
                             "   and t_Parent  = 0 " );
        cmd.AddParam( SettleOperTPlusID );
        cmd.AddParam( DL_SETTLEMENTFCURM );
        cmd.AddParam( FIID );

        ItogFI = cmd.Execute();

        if( ItogFI.MoveNext() )
        if(( SourceID == GT_MMVB3 ) OR (SourceID == GT_PAYMENTS) or (SourceID == GT_SPB) or (SourceID == GT_PAYMENTS_SPB ))
              ParentID = ItogFI.ID;
        UpdateItogFI( ParentID, ItogFI.ClearingResult + LiabNettoSum );
        Comment = Comment + "Обновлено значение требования/обязательства по " + Currency + " в регистре \"Итоги по ФИ\" операции \"Расчеты с биржей\" №" + SettleOperTPlusCode + "\n";
              WasParent = true;
            else
           Comment = Comment + "Дублирование итогов по ФИ! Значение требования/обязательства по " + Currency + " уже загружено ранее из другого отчета " + DocType;
           return 1;
        end;
     else
        ParentID = InsertItogFI( SettleOperTPlusID, DL_SETTLEMENTFCURM, FIID, LiabNettoSum, 0, 0, 0, "" );
              Comment = Comment + "Загружено значение требования/обязательства по " + Currency + " в регистр \"Итоги по ФИ\" операции \"Расчеты с биржей\" №" + SettleOperTPlusCode + "\n";
     end;

     if( (SourceID == GT_MMVB3) OR (SourceID == GT_PAYMENTS) OR (SourceID == GT_SPVB))
        if( WasParent )  // Не имеет смысла искать дочернюю операцию, если не было родительской
           cmd = DL_RSDCommand( "select t_ID, t_ClearingResult "
                                "  from ddl_totaloffi_dbt " 
                                " where t_DocID    = ? "
                                "   and t_DocKind  = ? "
                                "   and t_CodeFI   = ? "
                                "   and t_LiabType = ? "
                                "   and t_Market   = ? " );
           cmd.AddParam( SettleOperTPlusID );
           cmd.AddParam( DL_SETTLEMENTFCURM );
           cmd.AddParam( FIID );
           cmd.AddParam( LiabTypeID );
           cmd.AddParam( LiabMarket );

           ItogFI = cmd.Execute();

           if( ItogFI.MoveNext() )
           UpdateItogFI( ItogFI.ID, ItogFI.ClearingResult + LiabNettoSum ); 
           else
           InsertItogFI( SettleOperTPlusID, DL_SETTLEMENTFCURM, FIID, LiabNettoSum, LiabTypeID, LiabMarket, ParentID, "" );
           end;
        else
        InsertItogFI( SettleOperTPlusID, DL_SETTLEMENTFCURM, FIID, LiabNettoSum, LiabTypeID, LiabMarket, ParentID, "" );
        end;
     end;
  end;

  if( CurMarkOperCode > 0 ) 
     WasParent = false;
     cmd = DL_RSDCommand( "select t_ID "
                          "  from ddl_totaloffi_dbt " 
                          " where t_DocID       = ? "
                          "   and t_DocKind     = ? "
                          "   and t_Parent  = 0 "
                          "   and t_MarketSchemeID = ? " );
     cmd.AddParam( CurMarkOperID );
     cmd.AddParam( DL_DVCURMARKET );
     cmd.AddParam( MarketSchemeID );

     ItogFI = cmd.Execute();

     if( ItogFI.MoveNext() )
        ParentID = ItogFI.ID;
        WasParent = true;
     else
        ParentID = InsertItogFI( CurMarkOperID, DL_DVCURMARKET, ALLFININSTR, 0, 0, 0, 0, MarketSchemeID );
  end;

     if( WasParent )
     cmd = DL_RSDCommand( "select t_ID, t_ClearingResult, t_SettlementEnd "
                          "  from ddl_totaloffi_dbt " 
                          " where t_DocID   = ? "
                          "   and t_DocKind = ? "
                             "   and t_CodeFI  = ? " 
                             "   and t_Parent  = ? " );
     cmd.AddParam( CurMarkOperID );
     cmd.AddParam( DL_DVCURMARKET );
     cmd.AddParam( FIID );
        cmd.AddParam( ParentID );

     ItogFI = cmd.Execute();

     if( ItogFI.MoveNext() )
        if( ItogFI.SettlementEnd == UNSET_CHAR )
           UpdateItogFI( ItogFI.ID, ItogFI.ClearingResult + LiabNettoSum );
           Comment = Comment + "Обновлено значение требования/обязательства по " + Currency + " в регистре \"Итоги по ФИ\" операции \"Обработка итогов валютных биржевых торгов\" №" + CurMarkOperCode;
        else
           Comment = Comment + "Расчеты по " + Currency + " в регистре \"Итоги по ФИ\" операции \"Обработка итогов валютных биржевых торгов\" №" + CurMarkOperCode + " уже завершены. Значение требования/обязательства не обновлено";
           return 1;
        end;
     else
           InsertItogFI( CurMarkOperID, DL_DVCURMARKET, FIID, LiabNettoSum, 0, 0, ParentID, MarketSchemeID ); /*Сохраняем схему расчетов и в дочерних записях, т.к. родительская служит только для красоты*/
           Comment = Comment + "Загружено значение требования/обязательства по " + Currency + " в регистр \"Итоги по ФИ\" операции \"Обработка итогов валютных биржевых торгов\" №" + CurMarkOperCode;
        end;
     else
        InsertItogFI( CurMarkOperID, DL_DVCURMARKET, FIID, LiabNettoSum, 0, 0, ParentID, MarketSchemeID );
        Comment = Comment + "Загружено значение требования/обязательства по " + Currency + " в регистр \"Итоги по ФИ\" операции \"Обработка итогов валютных биржевых торгов\" №" + CurMarkOperCode;
     end;
  end;

  ID = string(SettleOperTPlusID) + "_" + string(SettleOperT0ID) + "_" + string(CurMarkOperID) + "_" + DocType + "_" + ExtCode + "_" + Currency + "_" + LiabType + "_" + string(DocDate);

  return 0;

OnError( RslErrObj )
  Comment = RslErrObj.Message;
  return 1;
end;
