//////////////////////////////////////////////////////////////////////////////
// Макрос вызывающийся перед началом экспорта
//////////////////////////////////////////////////////////////////////////////
import rgtgtlog, GateInter, rgtgtsnc;

MACRO OptimizeRecords(SeanceId:INTEGER, ApplicationId:INTEGER)
   // выполнение хранимой процедуры закрывающей "лишние" ЗР
   var cmd = RsdCommand("call RSB_GATE.OptimizeGTRecords(?,?)");

   cmd.addParam( "", RSDBP_IN, SeanceId);
   cmd.addParam( "", RSDBP_IN, ApplicationId);

   cmd.execute;
END;

//////////////////////////////////////////////////////////////////////////////
// Главная процедура макроса, принимает ID сеанса созданного при экспорте, для
// прекращения процедуры экспорта вернуть false
//////////////////////////////////////////////////////////////////////////////
MACRO PreExportProc(SeanceId:INTEGER)
   var SysLog = TGtLog(SeanceID);
   var Seance = TGtSnc(SeanceID);

   OptimizeRecords(Seance.Id, Seance.ApplicationId);

   return true;

OnError(err)
   var ErrString = err.Message;
   SysLog.PrintLine("Ошибка предобработки репликации. ", Time(), ErrString);
   SysLog.Save();

   return false;
END;
