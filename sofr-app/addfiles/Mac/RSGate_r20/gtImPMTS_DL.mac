/*
$Name:        gtImPMTS_DL.mac
$Module:      Шлюз
$Description: Общие ф-и для загрузки сделок ММВБ из xml-формат файла биржи через Payments
*/
import "gtImMVB_DL.mac";

macro FileDateInName(date_val)
   var day, month, year;
   DateSplit(date_val,day,month,year);

   year = year - 1900;

   if( year >= 100 )
      year = year - 100;
   end;

   return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,2);
end;

private macro GetSqlvClientCode() :string

  return " NVL(CASE WHEN NVL(CLIENTCODE, CHR(1)) <> CHR(1)  "+
                  " THEN CLIENTCODE "+
                  " ELSE CASE WHEN NVL(BROKERREF, CHR(1)) <> CHR(1) "+
                            " THEN CASE WHEN INSTR(BROKERREF, '/') > 0 "+
                                      " THEN SUBSTR(BROKERREF, 1, INSTR(BROKERREF, '/') - 1) "+
                                      " ELSE CHR(1) "+
                                  " END "+
                            " ELSE CHR(1) "+
                        " END "+
              " END, "+
             " CHR(1))  ";
end;

macro FillSEM02(synonim, imp_date, ErrMes:@string):integer
  var cmd;

  cmd = RSDCommand( " INSERT INTO D_SEM02_TMP(  "
                   +"   T_ID_MB_SEM02 "           
                   +"  ,T_ID_MB_REQUISITES "      
                   +"  ,T_ID_PROCESSING_LOG "      
                   +"  ,T_TRADEDATE "  
                   +"  ,T_TRADESESSIONDATE "                        
                   +"  ,T_SESSIONNO "         
                   +"  ,T_FILESESSIONNO "                 
                   +"  ,T_RECNO "                 
                   +"  ,T_ORDERNO "               
                   +"  ,T_STATUS "                
                   +"  ,T_BUYSELL "               
                   +"  ,T_SECURITYID "            
                   +"  ,T_PRICETYPE "             
                   +"  ,T_CURRENCYID "            
                   +"  ,T_PRICE "                 
                   +"  ,T_QUANTITY "              
                   +"  ,T_ENTRYTIME "             
                   +"  ,T_AMENDTIME "             
                   +"  ,T_BROKERREF "             
                   +"  ,T_REPORATE "              
                   +"  ,T_CLIENTCODE "            
                   +"  ,T_TRDACCID "          
                   +"  ,T_REPOVALUE "             
                   +"  ,T_ORDTYPECODE "          
                   +"  ,T_PARTYID "          
                   +"  ,T_SFCONTRID "          
                   +"  ,T_ISSEB "
                   +"  ,T_OBJECTID "
                   +"  ,T_UNDERWR "
                   +"  ,T_IsREPO "
                   +"  ,T_vClientCode "
                   +"  ,T_FIID ) "
                   +"  (SELECT " 
                   +"   T.ID_MB_SEM02 "           
                   +"  ,NVL(T.ID_MB_REQUISITES, 0) "      
                   +"  ,NVL(T.ID_PROCESSING_LOG, 0) "      
                   +"  ,NVL(T.TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "           
                   +"  ,NVL(T.TRADESESSIONDATE, NVL(T.TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY'))) "               
                   +"  ,NVL(T.SESSIONNO, CHR(1)) "
                   +"  ,NVL((SELECT NVL(PA.ORD_NUM, 0) FROM "+ synonim + ".PROCESSING_ACTUAL PA WHERE PA.ID_MB_REQUISITES = T.ID_MB_REQUISITES), 0) "                     
                   +"  ,NVL(T.RECNO, 0) "                 
                   +"  ,NVL(T.ORDERNO, CHR(1)) "               
                   +"  ,NVL(T.STATUS, CHR(1)) "                
                   +"  ,NVL(T.BUYSELL, CHR(1)) "               
                   +"  ,NVL(T.SECURITYID, CHR(1)) "            
                   +"  ,NVL(T.PRICETYPE, CHR(1)) "             
                   +"  ,NVL(T.CURRENCYID, CHR(1)) "            
                   +"  ,NVL(T.PRICE, 0) "                 
                   +"  ,NVL(T.QUANTITY, 0) "              
                   +"  ,NVL(T.ENTRYTIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "             
                   +"  ,NVL(T.AMENDTIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "             
                   +"  ,NVL(T.BROKERREF, CHR(1)) "             
                   +"  ,NVL(T.REPORATE, 0) "              
                   +"  ,NVL(T.CLIENTCODE, CHR(1)) "            
                   +"  ,NVL(T.TRDACCID, CHR(1)) "          
                   +"  ,NVL(T.REPOVALUE, 0) "             
                   +"  ,NVL(T.ORDTYPECODE, CHR(1)) "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "
                   +"  ,0 "
                   +"  ,(CASE WHEN NVL(T.REPOVALUE, 0) <> 0 THEN 1 ELSE 0 END) "
                   +"  ," + GetSqlvClientCode()
                   +"  ,-1 "
                   +"  FROM "+ synonim + ".MB_SEM02 T "
                   +"  WHERE T.ID_MB_REQUISITES IN (SELECT NVL(PA.ID_MB_REQUISITES, 0) FROM "+ synonim + ".PROCESSING_ACTUAL PA WHERE PA.FILE_TYPE = 'SEM02' AND PA.TRADE_DATE = ? AND PA.ORD_NUM IN (1,2) ) "
                   +"    AND NVL(T.ZRID, 0) = 0 "
                   +"    AND NOT NVL(SUBSTR(NVL(T.BROKERREF, CHR(1)), INSTR(NVL(T.BROKERREF, CHR(1)), '/') + 1), CHR(1)) LIKE '%mc%' " /*biq-9103 поручения Margin Call не загружаем*/
                   +"    AND (    NVL(T.STATUS, CHR(1)) NOT IN ('"+REQ_WAIT_ACTIVATION+"','"+REQ_ACTIVE+"') " 
                   +"          OR (     NVL(T.STATUS, CHR(1)) IN ('"+REQ_WAIT_ACTIVATION+"','"+REQ_ACTIVE+"') " 
                   +"               AND NOT EXISTS (SELECT 1 FROM "+ synonim + ".MB_SEM02 T1 "
                   +"                                WHERE T1.ID_MB_REQUISITES IN (SELECT NVL(PA.ID_MB_REQUISITES, 0) FROM "+ synonim + ".PROCESSING_ACTUAL PA WHERE PA.FILE_TYPE = 'SEM02' AND PA.TRADE_DATE = ? AND PA.ORD_NUM IN (1,2) ) "
                   +"                                  AND NVL(T1.ORDERNO, CHR(1)) = NVL(T.ORDERNO, CHR(1)) "
                   +"                                  AND NVL(T1.STATUS, CHR(1)) NOT IN ('"+REQ_WAIT_ACTIVATION+"','"+REQ_ACTIVE+"') " 
                   +"                              ) "
                   +"             ) "
                   +"        ) "
                   +"  ) "
                  );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

private macro GetSqlIsREPO(p_FileImport:integer, alias:string) :string
  if(alias == NULL)
    alias = "";
  end;

  return "(CASE WHEN NVL(" + alias + RG_IIF(p_FileImport == FileSEM03, "REPOVALUE", "REPOPART") + ", 0) <> 0 "+
              " THEN 1 "+
              " ELSE 0 "+
          " END)";
end;

macro FillSEM03(synonim, imp_date, isSem001, isSem002, IsMain, ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand( " INSERT INTO D_SEM03_TMP(  "
                   +"   T_ID_MB_SEM03 "       
                   +"  ,T_ID_MB_REQUISITES "       
                   +"  ,T_ID_PROCESSING_LOG "      
                   +"  ,T_TRADEDATE " 
                   +"  ,T_TRADESESSIONDATE "              
                   +"  ,T_SESSIONNO "              
                   +"  ,T_FIRMID "                 
                   +"  ,T_CURRENCYID "             
                   +"  ,T_BOARDID "                
                   +"  ,T_BOARDNAME "              
                   +"  ,T_SETTLEDATE "             
                   +"  ,T_SECURITYID "             
                   +"  ,T_SECSHORTNAME "           
                   +"  ,T_SECNAME "                
                   +"  ,T_SECURITYTYPE "           
                   +"  ,T_INITIALFACEVALUE "       
                   +"  ,T_FACEVALUE "              
                   +"  ,T_SECCURRENCYID "           
                   +"  ,T_PRICETYPE "
                   +"  ,T_TRDACCID "               
                   +"  ,T_CLEARINGCENTERID "       
                   +"  ,T_RECNO "                  
                   +"  ,T_SECSETID "               
                   +"  ,T_SECSETSHORTNAME "        
                   +"  ,T_TRADENO "                
                   +"  ,T_TRADETIME "              
                   +"  ,T_BUYSELL "                 
                   +"  ,T_SETTLECODE "              
                   +"  ,T_DECIMALS "                
                   +"  ,T_PRICE "                   
                   +"  ,T_QUANTITY "                
                   +"  ,T_VALUE "                   
                   +"  ,T_AMOUNT "                  
                   +"  ,T_EXCHCOMM "                
                   +"  ,T_FACEAMOUNT "              
                   +"  ,T_ORDERNO "                 
                   +"  ,T_ACCINT "                  
                   +"  ,T_CPFIRMID "                
                   +"  ,T_CPFIRMSHORTNAME "         
                   +"  ,T_CPFIRMINN "               
                   +"  ,T_CPTRDACCID "              
                   +"  ,T_REPOVALUE "               
                   +"  ,T_REPOPERIOD "              
                   +"  ,T_RATETYPE "                
                   +"  ,T_BENCHMARK "               
                   +"  ,T_REPORATE "                
                   +"  ,T_OUTSTANDINGRETURNVALUE "  
                   +"  ,T_DISCOUNT "                
                   +"  ,T_LOWERDISCOUNT "           
                   +"  ,T_UPPERDISCOUNT "           
                   +"  ,T_TRADETYPE "               
                   +"  ,T_CANCELORDER "             
                   +"  ,T_ISCANCEL "                
                   +"  ,T_USERID "                  
                   +"  ,T_YIELD "                   
                   +"  ,T_PERIOD "                  
                   +"  ,T_EXTREF "                  
                   +"  ,T_PRICE2 "                  
                   +"  ,T_ACCINT2 "                 
                   +"  ,T_CLIENTCODE "              
                   +"  ,T_VCLIENTCODE "              
                   +"  ,T_DETAILS "                 
                   +"  ,T_SUBDETAILS "              
                   +"  ,T_REFUNDRATE "              
                   +"  ,T_MATCHREF "                
                   +"  ,T_BROKERREF "               
                   +"  ,T_SYSTEMREF "               
                   +"  ,T_CLEARINGFIRMID "          
                   +"  ,T_ISHIDDEN "                
                   +"  ,T_ISACTUALMM "              
                   +"  ,T_DOC_NO "
                   +"  ,T_PARTYID "          
                   +"  ,T_SFCONTRID "          
                   +"  ,T_ISSEB "
                   +"  ,T_CPFIRMPARTYID "          
                   +"  ,T_CURID "          
                   +"  ,T_CALENDID "          
                   +"  ,T_MARKETSCHEMEID "          
                   +"  ,T_NDAY1 "          
                   +"  ,T_NDAY2 "          
                   +"  ,T_PAYMDATE1 "          
                   +"  ,T_PAYMDATE2 "          
                   +"  ,T_CALCITOGDATE "          
                   +"  ,T_WORKSETTLEDATE "          
                   +"  ,T_OBJECTID "          
                   +"  ,T_PORTFOLIO "          
                   +"  ,T_FIID  "          
                   +"  ,T_UNDERWR  "          
                   +"  ,T_UNDERWR_BUY  "          
                   +"  ,T_UNDERWRDOID "
                   +"  ,T_ISREPO ) "
                   +"  (SELECT " 
                   +"   NVL(ID_MB_SEM03,0) "
                   +"  ,NVL(ID_MB_REQUISITES,0) "
                   +"  ,NVL(ID_PROCESSING_LOG,0) "       
                   +"  ,NVL(TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "
                   +"  ,NVL(TRADESESSIONDATE, NVL(TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY'))) "                           
                   +"  ,NVL(SESSIONNO, CHR(1)) "               
                   +"  ,NVL(FIRMID, CHR(1)) "                  
                   +"  ,NVL(CURRENCYID, CHR(1)) "              
                   +"  ,NVL(BOARDID, CHR(1)) "                 
                   +"  ,NVL(BOARDNAME, CHR(1)) "               
                   +"  ,NVL(SETTLEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "              
                   +"  ,NVL(SECURITYID, CHR(1)) "              
                   +"  ,NVL(SECSHORTNAME, CHR(1)) "            
                   +"  ,NVL(SECNAME, CHR(1)) "                 
                   +"  ,NVL(SECURITYTYPE, CHR(1)) "            
                   +"  ,NVL(INITIALFACEVALUE,0) "        
                   +"  ,NVL(FACEVALUE,0) "               
                   +"  ,NVL(SECCURRENCYID, CHR(1)) "           
                   +"  ,NVL(PRICETYPE, CHR(1)) "               
                   +"  ,NVL(TRDACCID, CHR(1)) "                
                   +"  ,NVL(CLEARINGCENTERID, CHR(1)) "        
                   +"  ,NVL(RECNO,0) "                   
                   +"  ,NVL(SECSETID, CHR(1)) "                
                   +"  ,NVL(SECSETSHORTNAME, CHR(1)) "         
                   +"  ,NVL(TRADENO, CHR(1)) "                 
                   +"  ,NVL(TRADETIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "               
                   +"  ,NVL(BUYSELL, CHR(1)) "                 
                   +"  ,NVL(SETTLECODE, CHR(1)) "              
                   +"  ,NVL(DECIMALS,0) "                
                   +"  ,NVL(PRICE,0) "                   
                   +"  ,NVL(QUANTITY,0) "                
                   +"  ,NVL(VALUE,0) "                   
                   +"  ,NVL(AMOUNT,0) "                  
                   +"  ,NVL(EXCHCOMM,0) "                
                   +"  ,NVL(FACEAMOUNT,0) "              
                   +"  ,NVL(ORDERNO, CHR(1)) "                 
                   +"  ,NVL(ACCINT,0) "                  
                   +"  ,NVL(CPFIRMID, CHR(1)) "                
                   +"  ,NVL(CPFIRMSHORTNAME, CHR(1)) "         
                   +"  ,NVL(CPFIRMINN, CHR(1)) "               
                   +"  ,NVL(CPTRDACCID, CHR(1)) "              
                   +"  ,NVL(REPOVALUE,0) "               
                   +"  ,NVL(REPOPERIOD,0) "              
                   +"  ,NVL(RATETYPE, CHR(1)) "                
                   +"  ,NVL(BENCHMARK, CHR(1)) "               
                   +"  ,NVL(REPORATE,0) "                
                   +"  ,NVL(OUTSTANDINGRETURNVALUE,0) "  
                   +"  ,NVL(DISCOUNT,0) "                
                   +"  ,NVL(LOWERDISCOUNT,0) "           
                   +"  ,NVL(UPPERDISCOUNT,0) "           
                   +"  ,NVL(TRADETYPE, CHR(1)) "               
                   +"  ,NVL(CANCELORDER, CHR(1)) "             
                   +"  ,NVL(ISCANCEL, CHR(1)) "                
                   +"  ,NVL(USERID, CHR(1)) "                  
                   +"  ,NVL(YIELD,0) "                   
                   +"  ,NVL(PERIOD, CHR(1)) "                  
                   +"  ,NVL(EXTREF, CHR(1)) "                  
                   +"  ,NVL(PRICE2,0) "                  
                   +"  ,NVL(ACCINT2,0) "                 
                   +"  ,NVL(CLIENTCODE, CHR(1)) "
                   +"  ," + GetSqlvClientCode()
                   +"  ,NVL(DETAILS, CHR(1)) "
                   +"  ,NVL(SUBDETAILS, CHR(1)) "              
                   +"  ,NVL(REFUNDRATE,0)  "             
                   +"  ,NVL(MATCHREF, CHR(1)) "                
                   +"  ,NVL(BROKERREF, CHR(1)) "               
                   +"  ,NVL(SYSTEMREF, CHR(1)) "               
                   +"  ,NVL(CLEARINGFIRMID, CHR(1)) "          
                   +"  ,NVL(ISHIDDEN, CHR(1)) "                
                   +"  ,NVL(ISACTUALMM, CHR(1)) "              
                   +"  ,CHR(1) " 
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,-1 "          
                   +"  ,-1 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,0 "          
                   +"  ,-1 "          
                   +"  ,-1 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "
                   +"  ," + GetSqlIsREPO(FileSEM03)
                   +"  FROM "+ synonim + ".MB_SEM03 "
                   +"  WHERE ID_MB_REQUISITES IN (SELECT NVL(ID_MB_REQUISITES, 0) FROM "+ synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = 'SEM03' AND TRADE_DATE = ? "
                   +"  AND ( ( (ORD_NUM = 1) AND (1 = ? ) ) OR ((ORD_NUM = 2) AND (1 = ? )) ) )"
                   +"  AND ( (( NVL(ZRID, 0) = 0 ) AND (1 = ? )) OR (0 = ? ) ) " 
                   +"  ) "
                  );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.addParam( "", RSDBP_IN, isSem001 );
  cmd.addParam( "", RSDBP_IN, isSem002 );
  cmd.addParam( "", RSDBP_IN, IsMain );
  cmd.addParam( "", RSDBP_IN, IsMain );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro IsExsistsFilePayments(synonim:string, imp_date:date, file_type:string, ord_num:integer):integer
  var retval:integer = 0;
  var cmd = RSDCommand( " SELECT 1 from "+synonim+".PROCESSING_ACTUAL WHERE FILE_TYPE = ? AND TRADE_DATE = ? AND ORD_NUM = ? " );
  cmd.addParam( "", RSDBP_IN, file_type );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.addParam( "", RSDBP_IN, ord_num );

  var ds = TRsbDataSet(cmd);
  if(ds.MoveNext)
    retval = 1;
  end;
  return retval;
end;

macro FillEQM06(synonim, imp_date, isSem001, isSem002, IsMain, ErrMes:@string):integer
  var cmd;
  var Num023 = 2;
  var isExs003 = IsExsistsFilePayments(synonim, imp_date, "EQM06", 3);

  if (isExs003 == 1) 
    Num023 = 3;
  end;

  cmd = RSDCommand( " INSERT INTO D_EQM06_TMP(  "
                   +"   T_ID_MB_EQM06 "       
                   +"  ,T_ID_MB_REQUISITES " 
                   +"  ,T_ID_PROCESSING_LOG "
                   +"  ,T_REPORTDATE "       
                   +"  ,T_FIRMID "           
                   +"  ,T_EXTSETTLECODE "    
                   +"  ,T_CURRENCYID "       
                   +"  ,T_INFTYPE "          
                   +"  ,T_CLEARINGTYPE "     
                   +"  ,T_SESSIONNUM "       
                   +"  ,T_SETTLEDATE "       
                   +"  ,T_INSTRTYPE "        
                   +"  ,T_BOARDID "          
                   +"  ,T_BOARDNAME "        
                   +"  ,T_SECURITYID "       
                   +"  ,T_ISIN "             
                   +"  ,T_SECSHORTNAME "     
                   +"  ,T_PRICETYPE "        
                   +"  ,T_RECNO "            
                   +"  ,T_TRADENO "          
                   +"  ,T_TRADEDATE "        
                   +"  ,T_TRADETIME "        
                   +"  ,T_BUYSELL "          
                   +"  ,T_SETTLECODE "       
                   +"  ,T_DECIMALS "         
                   +"  ,T_PRICE "            
                   +"  ,T_QUANTITY "         
                   +"  ,T_VALUE "            
                   +"  ,T_FACEAMOUNT "       
                   +"  ,T_DEPORATE "         
                   +"  ,T_ACCINT "           
                   +"  ,T_AMOUNT "           
                   +"  ,T_BALANCE "          
                   +"  ,T_SUM1 "             
                   +"  ,T_SUM2 "             
                   +"  ,T_EXCHCOMM "         
                   +"  ,T_CLRCOMM "          
                   +"  ,T_TRDACCID "         
                   +"  ,T_CLIENTDETAILS "    
                   +"  ,T_CPFIRMID "         
                   +"  ,T_CPFIRMSHORTNAME "  
                   +"  ,T_PRICE2 "           
                   +"  ,T_PAYOFF "           
                   +"  ,T_REPOPART "         
                   +"  ,T_REPOPERIOD "       
                   +"  ,T_REPORTNO "         
                   +"  ,T_REPORTTIME "       
                   +"  ,T_SETTLETIME "       
                   +"  ,T_CLIENTCODE "       
                   +"  ,T_DUEDATE "          
                   +"  ,T_TYPE "             
                   +"  ,T_SYSTEMREF "        
                   +"  ,T_EARLYSETTLESTATUS "
                   +"  ,T_TRADEMERGENO "     
                   +"  ,T_REPORATE "         
                   +"  ,T_RATETYPE "         
                   +"  ,T_BENCHMARK "        
                   +"  ,T_BENCHMARKRATE "    
                   +"  ,T_CURREPORATE "      
                   +"  ,T_REPOSUM "          
                   +"  ,T_INTERESTAMOUNT "  
                   +"  ,T_DOC_NO "
                   +"  ,T_PARTYID "          
                   +"  ,T_SFCONTRID "          
                   +"  ,T_ISSEB "
                   +"  ,T_CPFIRMPARTYID "          
                   +"  ,T_CURID "          
                   +"  ,T_CALENDID "          
                   +"  ,T_MARKETSCHEMEID "          
                   +"  ,T_NDAY1 "          
                   +"  ,T_NDAY2 "          
                   +"  ,T_PAYMDATE1 "          
                   +"  ,T_PAYMDATE2 "          
                   +"  ,T_CALCITOGDATE "          
                   +"  ,T_WORKSETTLEDATE "          
                   +"  ,T_OBJECTID "          
                   +"  ,T_PORTFOLIO "          
                   +"  ,T_FIID "
                   +"  ,T_UNDERWR "
                   +"  ,T_UNDERWR_BUY "
                   +"  ,T_ISREPO "
                   +"  ,T_vClientCode ) "
                   +"  (SELECT " 
                   +"   NVL(ID_MB_EQM06,0) "
                   +"  ,NVL(ID_MB_REQUISITES,0) " 
                   +"  ,NVL(ID_PROCESSING_LOG,0) "
                   +"  ,NVL(REPORTDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "       
                   +"  ,NVL(FIRMID, CHR(1)) "           
                   +"  ,NVL(EXTSETTLECODE, CHR(1)) "    
                   +"  ,NVL(CURRENCYID, CHR(1)) "       
                   +"  ,NVL(INFTYPE,0) "          
                   +"  ,NVL(CLEARINGTYPE, CHR(1)) "     
                   +"  ,NVL(SESSIONNUM,-1) "       
                   +"  ,NVL(SETTLEDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) "       
                   +"  ,NVL(INSTRTYPE, CHR(1)) "        
                   +"  ,NVL(BOARDID, CHR(1)) "          
                   +"  ,NVL(BOARDNAME, CHR(1)) "        
                   +"  ,NVL(SECURITYID, CHR(1)) "       
                   +"  ,NVL(ISIN, CHR(1)) "             
                   +"  ,NVL(SECSHORTNAME, CHR(1)) "     
                   +"  ,NVL(PRICETYPE, CHR(1)) "        
                   +"  ,NVL(RECNO,0) "            
                   +"  ,NVL(TRADENO, CHR(1)) "          
                   +"  ,NVL(TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "        
                   +"  ,NVL(TRADETIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "        
                   +"  ,NVL(BUYSELL, CHR(1)) "          
                   +"  ,NVL(SETTLECODE, CHR(1)) "       
                   +"  ,NVL(DECIMALS,0) "         
                   +"  ,NVL(PRICE,0) "            
                   +"  ,NVL(QUANTITY,0) "         
                   +"  ,NVL(VALUE,0) "            
                   +"  ,NVL(FACEAMOUNT,0) "       
                   +"  ,NVL(DEPORATE,0) "         
                   +"  ,NVL(ACCINT,0) "           
                   +"  ,NVL(AMOUNT,0) "           
                   +"  ,NVL(BALANCE,0) "          
                   +"  ,NVL(SUM1,0) "             
                   +"  ,NVL(SUM2,0) "             
                   +"  ,NVL(EXCHCOMM,0) "         
                   +"  ,NVL(CLRCOMM,0) "          
                   +"  ,NVL(TRDACCID, CHR(1)) "         
                   +"  ,NVL(CLIENTDETAILS, CHR(1)) "    
                   +"  ,NVL(CPFIRMID, CHR(1)) "         
                   +"  ,NVL(CPFIRMSHORTNAME, CHR(1)) "  
                   +"  ,NVL(PRICE2,0) "           
                   +"  ,NVL(PAYOFF,0) "           
                   +"  ,NVL(REPOPART,0) "         
                   +"  ,NVL(REPOPERIOD,0) "       
                   +"  ,NVL(REPORTNO,0) "         
                   +"  ,NVL(REPORTTIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "       
                   +"  ,NVL(SETTLETIME,TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS')) "       
                   +"  ,NVL(CLIENTCODE, CHR(1)) "
                   +"  ,NVL(DUEDATE, TO_DATE('01.01.0001', 'DD.MM.YYYY')) "          
                   +"  ,NVL(TYPE,0) "             
                   +"  ,NVL(SYSTEMREF, CHR(1)) "        
                   +"  ,NVL(EARLYSETTLESTATUS, CHR(1)) "
                   +"  ,NVL(TRADEMERGENO, CHR(1)) "     
                   +"  ,NVL(REPORATE,0) "         
                   +"  ,NVL(RATETYPE, CHR(1)) "         
                   +"  ,NVL(BENCHMARK, CHR(1)) "        
                   +"  ,NVL(BENCHMARKRATE,0) "    
                   +"  ,NVL(CURREPORATE,0) "      
                   +"  ,NVL(REPOSUM,0) "          
                   +"  ,NVL(INTERESTAMOUNT,0) "  
                   +"  ,CHR(1) " 
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,-1 "          
                   +"  ,-1 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,0 "          
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,TO_DATE('01.01.0001', 'DD.MM.YYYY') "              
                   +"  ,0 "          
                   +"  ,-1 "          
                   +"  ,-1 "
                   +"  ,0 "         
                   +"  ,0 "           
                   +"  ," + GetSqlIsREPO(FileEQM06)
                   +"  ,NVL(CLIENTCODE, CHR(1)) "
                   +"  FROM "+ synonim + ".MB_EQM06 "
                   +"  WHERE ID_MB_REQUISITES IN (SELECT NVL(ID_MB_REQUISITES, 0) FROM "+ synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = 'EQM06' AND TRADE_DATE = ? "
                   +"  AND ( ( (ORD_NUM = ?) AND (1 = ? ) ) OR ((ORD_NUM = 4) AND (1 = ? )) ) )"
                   +"  AND ( (( NVL(ZRID, 0) = 0 ) AND (1 = ? )) OR (0 = ? ) ) " 
                   +"  ) "                      
                  );
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.addParam( "", RSDBP_IN, Num023 );
  cmd.addParam( "", RSDBP_IN, isSem001 );
  cmd.addParam( "", RSDBP_IN, isSem002 );
  cmd.addParam( "", RSDBP_IN, IsMain );
  cmd.addParam( "", RSDBP_IN, IsMain );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateSEM02_PM(synonim, SeanceID, ErrMes:@string):integer
  var cmd;
  var Query =" DECLARE "
            +"      TYPE ObjID_t IS TABLE OF NUMBER (10); "
            +"      TYPE PmID_t IS TABLE OF NUMBER (10); "
            +"      v_ObjIDs          ObjID_t; "
            +"      v_PmID            PmID_t; "
            +"   BEGIN "
            +"   SELECT   SEM02.T_ID_MB_SEM02, GTSNCREC.T_RECORDID "
            +"        BULK COLLECT INTO v_PmID, v_ObjIDs "
            +"               FROM dgtsncrec_dbt gtsncrec, "
            +"                    dgtcode_dbt gtcode, "
            +"                    dgtobject_dbt gtobject, "
            +"                    D_SEM02_tmp Sem02 "
            +"              WHERE     gtsncrec.t_seanceid = ? "
            +"                    AND GTCODE.T_OBJECTKIND =  " + RG_REQUEST
            +"                    AND GTCODE.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"                    AND GTOBJECT.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"                    AND (GTCODE.T_OBJECTCODE = (SEM02.t_ORDERNO || '_' || TO_CHAR(SEM02.t_FileSessionNo))); "
            +"      IF v_PmID.COUNT <> 0 "
            +"      THEN "
            +"        FORALL i IN v_PmID.FIRST .. v_PmID.LAST "
            +"          UPDATE " + synonim + ".MB_SEM02 sem02 "
            +"             SET ZRID = v_ObjIDs (i) "
            +"           WHERE ID_MB_SEM02 = v_PmID (i); "
            +"        v_PmID.delete; "
            +"        v_ObjIDs.delete; "
            +"      END IF; "
            +"   END; "
            ;
  cmd = RSDCommand( Query );
  cmd.addParam("", RSDBP_IN, SeanceID);
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateParty( MarketID, Table, imp_date, ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand( 
             " DECLARE "
            +"   TYPE PtID_t IS TABLE OF NUMBER (10); "
            +"   TYPE SfID_t IS TABLE OF NUMBER (10); "
            +"   TYPE Code_t IS TABLE OF VARCHAR2 (12); "
            +"   v_PtID   PtID_t; "
            +"   v_SfID   sfID_t; "
            +"   v_Code   Code_t; "
            +" BEGIN "
            +"   SELECT /*+ index(Tb " + Table + "_IDX2) */ DISTINCT sfcontr.T_PartyID, sfcontr.T_ID, Tb.t_vClientCode "
            +"     BULK COLLECT INTO v_PtID, v_SfID, v_Code "
            +"     FROM DDLCONTR_DBT dlcontr, "
            +"          DDLCONTRMP_DBT contrmp, "
            +"          DSFCONTR_DBT sfcontr, "
            +"          " + Table + " Tb "
            +"    WHERE     dlcontr.T_DLCONTRID = contrmp.T_DLCONTRID "
            +"          AND sfcontr.T_ID = contrmp.T_SFCONTRID "
            +"          AND sfcontr.T_SERVKIND = " + PTSK_STOCKDL
            +"          AND contrmp.T_MPCODE = Tb.t_vClientCode "
            +"          AND contrmp.T_MarketID = " + MarketID
            +"          AND sfcontr.t_DateBegin <= DECODE (Tb.t_TradeDate, TO_DATE ('01-01-0001', 'DD-MM-YYYY'),? ,Tb.t_TradeDate) "
            +"          AND (   sfcontr.t_DateClose > Tb.t_TradeDate "
            +"               OR sfcontr.T_DateCLose = TO_DATE ('01-01-0001', 'DD-MM-YYYY')) "
            +"          AND sfcontr.t_DateBegin = "
            +"                (SELECT MAX (sf.t_DateBegin) "
            +"                   FROM DSFCONTR_DBT sf "
            +"                  WHERE     sf.T_SERVKIND = sfcontr.T_SERVKIND "
            +"                        AND sf.T_ID = contrmp.T_SFCONTRID "
            +"                        AND contrmp.T_MPCODE = Tb.t_vClientCode "
            +"                        AND contrmp.T_MarketID = " + MarketID
            +"                        AND sf.t_PartyID = sfcontr.t_PartyID "
            +"                        AND sf.t_DateBegin <= Tb.t_TradeDate) "
            +"                        AND Tb.t_vClientCode <> CHR(1); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN                   "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_partyid) = (v_PtID (i)), (t_sfcontrid) = (v_SfID (i)) "
            +"        WHERE Tb.t_vClientCode = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_SfID.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +"   SELECT distinct t.t_objectid, Tb.t_vClientCode "
            +"     BULK COLLECT INTO v_PtID, v_Code "
            +"     FROM dobjcode_dbt t, " + Table + " Tb "
            +"    WHERE Tb.t_partyid <= 0 "
            +"      AND Tb.t_vClientCode <> CHR(1) "
            +"          AND (    t.t_objecttype = " + OBJTYPE_PARTY
            +"               AND t.t_codekind =  "  + PTCK_MICEX
            +"               AND t.t_code = Tb.t_vClientCode "
            +"               AND t.t_state = 0 "
            +"               AND t.t_autokey = "
            +"                     (SELECT MIN (code.t_autokey) "
            +"                        FROM dobjcode_dbt code "
            +"                       WHERE     code.t_objecttype = t.t_objecttype "
            +"                             AND code.t_codekind = t.t_codekind "
            +"                             AND code.t_code = t.t_code "
            +"                             AND code.t_state = t.t_state)); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_partyid) = (v_PtID (i)) "
            +"        WHERE Tb.t_vClientCode = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +" END; ")
            ;
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateContr( MarketID, Table, imp_date, ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand( 
             " DECLARE "
            +"   TYPE PtID_t IS TABLE OF DSFCONTR_DBT.T_PARTYID%TYPE; "
            +"   TYPE Code_t IS TABLE OF "+Table+".T_vCLIENTCODE%TYPE; "
            +"   v_PtID   PtID_t; "
            +"   v_Code   Code_t; "
            +" BEGIN "
            +"   SELECT distinct t.t_objectid, Tb.T_CPFIRMID "
            +"     BULK COLLECT INTO v_PtID, v_Code "
            +"     FROM dobjcode_dbt t, " + Table + " Tb "
            +"    WHERE     Tb.T_CPFIRMID <> CHR(1)  "
            +"          AND (    t.t_objecttype = " + OBJTYPE_PARTY
            +"               AND t.t_codekind =  "  + PTCK_MICEX
            +"               AND t.t_code = Tb.T_CPFIRMID" 
            +"               AND t.t_state = 0 "
            +"               AND t.t_autokey = "
            +"                     (SELECT MIN (code.t_autokey) "
            +"                        FROM dobjcode_dbt code "
            +"                       WHERE     code.t_objecttype = t.t_objecttype "
            +"                             AND code.t_codekind = t.t_codekind "
            +"                             AND code.t_code = t.t_code "
            +"                             AND code.t_state = t.t_state)); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_CPFIRMPARTYID) = (v_PtID (i)) "
            +"        WHERE Tb.T_CPFIRMID = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +" END; ")
            ;
  cmd.addParam( "", RSDBP_IN, imp_date );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

//нигде не вызывается
macro UpdateCPFirmId( Table, ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( 
             " DECLARE "
            +"   TYPE PtID_t IS TABLE OF NUMBER (10); "
            +"   TYPE Code_t IS TABLE OF VARCHAR2 (12); "
            +"   v_PtID   PtID_t; "
            +"   v_Code   Code_t; "
            +" BEGIN "
            +"   SELECT distinct t.t_objectid, Tb.t_CPFirmId "
            +"     BULK COLLECT INTO v_PtID, v_Code "
            +"     FROM dobjcode_dbt t, " + Table + " Tb "
            +"    WHERE  Tb.t_CPFirmId <> CHR(1)"
            +"          AND (    t.t_objecttype = " + OBJTYPE_PARTY
            +"               AND t.t_codekind =  "  + PTCK_MICEX   //Код_на_ММВБ_Субъект
            +"               AND t.t_code = Tb.t_CPFirmId "
            +"               AND t.t_state = 0 "
            +"               AND t.t_autokey = "
            +"                     (SELECT MIN (code.t_autokey) "
            +"                        FROM dobjcode_dbt code "
            +"                       WHERE     code.t_objecttype = t.t_objecttype "
            +"                             AND code.t_codekind = t.t_codekind "
            +"                             AND code.t_code = t.t_code "
            +"                             AND code.t_state = t.t_state)); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_CPFirmPartyId) = (v_PtID (i)) "
            +"        WHERE Tb.t_CPFirmId = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +" END; ")
            ;
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateCur( Table, ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( 
             " DECLARE "
            +"   TYPE PtID_t IS TABLE OF NUMBER (10); "
            +"   TYPE Code_t IS TABLE OF VARCHAR2 (12); "
            +"   v_PtID   PtID_t; "
            +"   v_Code   Code_t; "
            +" BEGIN "
            +"   SELECT distinct t.t_objectid, Tb.t_currencyID "
            +"     BULK COLLECT INTO v_PtID, v_Code "
            +"     FROM dobjcode_dbt t, " + Table + " Tb "
            +"    WHERE  Tb.t_currencyID <> CHR(1)"
            +"          AND (    t.t_objecttype = " + OBJTYPE_FININSTR
            +"               AND t.t_codekind = 11 " 
            +"               AND t.t_code = Tb.t_currencyID "
            +"               AND t.t_state = 0 "
            +"               AND t.t_autokey = "
            +"                     (SELECT MIN (code.t_autokey) "
            +"                        FROM dobjcode_dbt code "
            +"                       WHERE     code.t_objecttype = t.t_objecttype "
            +"                             AND code.t_codekind = t.t_codekind "
            +"                             AND code.t_code = t.t_code "
            +"                             AND code.t_state = t.t_state)); "
            +"   IF v_Code.COUNT <> 0 "
            +"   THEN "
            +"     FORALL i IN v_Code.FIRST .. v_Code.LAST "
            +"       UPDATE " + Table + " Tb "
            +"          SET (t_CurId) = (v_PtID (i)) "
            +"        WHERE Tb.t_currencyID = v_Code (i); "
            +"     v_Code.delete; "
            +"     v_PtID.delete; "
            +"   END IF; "
            +" END; ")
            ;
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

             
macro UpdateSEM03( synonim, ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( " Update D_SEM03_TMP SEM03 Set SEM03.T_DOC_NO = (SELECT requi.DOC_NO  FROM "+synonim+".MB_REQUISITES requi WHERE requi.ID_MB_REQUISITES = t_ID_MB_REQUISITES AND requi.ID_PROCESSING_LOG = t_ID_PROCESSING_LOG AND ROWNUM = 1 ) " );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateEQM06( synonim, ErrMes:@string ):integer
  var cmd;
  cmd = RSDCommand( " Update D_EQM06_TMP EQM06 Set EQM06.T_DOC_NO = (SELECT requi.DOC_NO  FROM "+synonim+".MB_REQUISITES requi WHERE requi.ID_MB_REQUISITES = t_ID_MB_REQUISITES AND requi.ID_PROCESSING_LOG = t_ID_PROCESSING_LOG AND ROWNUM = 1 ) " );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateSEM03_PM( synonim, SeanceID, ErrMes:@string ):integer
  var cmd;
  var Query =" DECLARE "
            +"   TYPE ObjID_t IS TABLE OF NUMBER (10); "
            +"   TYPE PmID_t  IS TABLE OF NUMBER (10); "
            +"   v_ObjIDs ObjID_t; "
            +"   v_PmID   PmID_t; "
            +" BEGIN "
            +"   SELECT SEM03.T_ID_MB_SEM03, GTSNCREC.T_RECORDID "
            +"     BULK COLLECT INTO v_PmID, v_ObjIDs "
            +"     FROM dgtsncrec_dbt gtsncrec, "
            +"          dgtcode_dbt gtcode, "
            +"          dgtobject_dbt gtobject, "
            +"          D_SEM03_tmp Sem03 "
            +"    WHERE gtsncrec.t_seanceid = ? "
            +"      AND GTCODE.T_OBJECTKIND =  " + RG_SECURDEAL
            +"      AND GTCODE.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTOBJECT.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"      AND GTCODE.T_OBJECTCODE = (CASE WHEN SEM03.T_vCLIENTCODE <> CHR(1) "
            +"                                      THEN (SEM03.T_BUYSELL || '/' || SEM03.T_TRADENO) "
            +"                                      ELSE SEM03.T_TRADENO "
            +"                                  END); "
            +"   IF v_PmID.COUNT <> 0 THEN "
            +"     FORALL i IN v_PmID.FIRST .. v_PmID.LAST "
            +"       UPDATE " + synonim + ".MB_SEM03 sem03 "
            +"          SET ZRID = v_ObjIDs (i) "
            +"        WHERE ID_MB_SEM03 = v_PmID (i); "
            +"     v_PmID.delete; "
            +"     v_ObjIDs.delete; "
            +"   END IF; "
            +" END; "
            ;
  cmd = RSDCommand( Query );
  cmd.addParam("", RSDBP_IN, SeanceID);
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateObjSEM02( ErrMes:@string ):integer
  var cmd;
  var Query ="DECLARE "
            +"  TYPE ObjID_t IS TABLE OF NUMBER (10); "
            +"  TYPE SemID_t IS TABLE OF NUMBER (10); "
            +"  v_ObjIDs   ObjID_t; "
            +"  v_SemID    SemID_t; "
            +"BEGIN "
            +"  SELECT GTCODE.T_OBJECTID, sem02.t_ID_MB_SEM02 "
            +"    BULK COLLECT INTO v_ObjIDs, v_semID "
            +"    FROM DGTCODE_DBT GTCODE, d_SEM02_TMP Sem02 "
            +"   WHERE     GTCODE.T_APPLICATIONID IN( " + 133/*GT_PAYMENTS*/ + " , " + GT_MMVB3 + ")"
            +"         AND GTCODE.T_OBJECTKIND = " + RG_REQUEST
            +"         AND (  GTCODE.T_OBJECTCODE = (SEM02.t_ORDERNO || '_' || TO_CHAR(SEM02.t_FileSessionNo)) ); "
            +"  IF v_semID.COUNT <> 0 "
            +"  THEN "
            +"    FORALL i IN v_semID.FIRST .. v_semID.LAST "
            +"      UPDATE d_SEM02_TMP Sem02 "
            +"         SET Sem02.t_objectID = v_ObjIDs (i) "
            +"       WHERE Sem02.t_ID_MB_SEM02 = v_semID (i); "
            +"    v_SemID.delete; "
            +"    v_ObjIDs.delete; "
            +"  END IF; "
            +"END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateObjSEM03( ErrMes:@string ):integer
  var cmd;
  var Query ="DECLARE "
            +"  TYPE ObjID_t IS TABLE OF NUMBER (10); "
            +"  TYPE SemID_t IS TABLE OF NUMBER (10); "
            +"  v_ObjIDs   ObjID_t; "
            +"  v_SemID    SemID_t; "
            +"BEGIN "
            +"  SELECT GTCODE.T_OBJECTID, sem03.t_ID_MB_SEM03 "
            +"    BULK COLLECT INTO v_ObjIDs, v_semID "
            +"    FROM DGTCODE_DBT GTCODE, d_SEM03_TMP Sem03 "
            +"   WHERE     GTCODE.T_APPLICATIONID IN(" + GT_PAYMENTS + ", " + GT_MMVB3 + ")"
            +"         AND GTCODE.T_OBJECTKIND = " + RG_SECURDEAL
            +"         AND GTCODE.T_OBJECTCODE = (CASE WHEN SEM03.T_vCLIENTCODE <> CHR(1) "
            +"                                         THEN (SEM03.T_BUYSELL || '/' || SEM03.T_TRADENO) "
            +"                                         ELSE SEM03.T_TRADENO "
            +"                                     END); "
            +"  IF v_semID.COUNT <> 0 "
            +"  THEN "
            +"    FORALL i IN v_semID.FIRST .. v_semID.LAST "
            +"      UPDATE d_SEM03_TMP Sem03 "
            +"         SET Sem03.t_objectID = v_ObjIDs (i) "
            +"       WHERE Sem03.t_ID_MB_SEM03 = v_semID (i); "
            +"    v_SemID.delete; "
            +"    v_ObjIDs.delete; "
            +"  END IF; "
            +"END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateObjEQM06( ErrMes:@string ):integer
  var cmd;
  var Query ="DECLARE "
            +"  TYPE ObjID_t IS TABLE OF NUMBER (10); "
            +"  TYPE SemID_t IS TABLE OF NUMBER (10); "
            +"  v_ObjIDs   ObjID_t; "
            +"  v_SemID    SemID_t; "
            +"BEGIN "
            +"  SELECT GTCODE.T_OBJECTID, EQM06.t_ID_MB_EQM06 "
            +"    BULK COLLECT INTO v_ObjIDs, v_semID "
            +"    FROM DGTCODE_DBT GTCODE, d_EQM06_TMP EQM06 "
            +"   WHERE     GTCODE.T_APPLICATIONID IN(" + GT_PAYMENTS + ", " + GT_MMVB3 + ")"
            +"         AND GTCODE.T_OBJECTKIND = " + RG_CLEARING
            +"         AND GTCODE.T_OBJECTCODE = (CASE WHEN EQM06.T_vCLIENTCODE <> CHR(1) "
            +"                                         THEN (EQM06.T_BUYSELL || '/' || EQM06.T_TRADENO ||'_c'|| EQM06.T_REPOPART) "
            +"                                         ELSE (EQM06.T_TRADENO ||'_c'|| EQM06.T_REPOPART) "
            +"                                     END); "
            +"  IF v_semID.COUNT <> 0 "
            +"  THEN "
            +"    FORALL i IN v_semID.FIRST .. v_semID.LAST "
            +"      UPDATE d_EQM06_TMP EQM06 "
            +"         SET EQM06.t_objectID = v_ObjIDs (i) "
            +"       WHERE EQM06.t_ID_MB_EQM06 = v_semID (i); "
            +"    v_SemID.delete; "
            +"    v_ObjIDs.delete; "
            +"  END IF; "
            +"END; "
            ;
  cmd = RSDCommand( Query );
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateEQM06_PM(synonim, SeanceID, ErrMes:@string):integer
  var cmd;
  var Query =" DECLARE "
            +"      TYPE ObjID_t IS TABLE OF NUMBER (10); "
            +"      TYPE PmID_t IS TABLE OF NUMBER (10); "
            +"      v_ObjIDs          ObjID_t; "
            +"      v_PmID            PmID_t; "
            +"   BEGIN "
            +"   SELECT   EQM06.T_ID_MB_EQM06, GTSNCREC.T_RECORDID "
            +"        BULK COLLECT INTO v_PmID, v_ObjIDs "
            +"               FROM dgtsncrec_dbt gtsncrec, "
            +"                    dgtcode_dbt gtcode, "
            +"                    dgtobject_dbt gtobject, "
            +"                    D_EQM06_tmp EQM06 "
            +"              WHERE     gtsncrec.t_seanceid = ? "
            +"                    AND GTCODE.T_OBJECTKIND = " + RG_CLEARING
            +"                    AND GTCODE.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"                    AND GTOBJECT.T_OBJECTID = GTSNCREC.T_OBJECTID "
            +"                    AND GTCODE.T_OBJECTCODE = (CASE WHEN EQM06.T_vCLIENTCODE <> CHR(1) "
            +"                                                    THEN (EQM06.T_BUYSELL || '/' || EQM06.T_TRADENO ||'_c'|| EQM06.T_REPOPART) "
            +"                                                    ELSE (EQM06.T_TRADENO ||'_c'|| EQM06.T_REPOPART) "
            +"                                                END); "
            +"      IF v_PmID.COUNT <> 0 "
            +"      THEN "
            +"         FORALL i IN v_PmID.FIRST .. v_PmID.LAST "
            +"            UPDATE " + synonim + ".MB_EQM06 EQM06 "
            +"               SET ZRID = v_ObjIDs (i) "
            +"             WHERE ID_MB_EQM06 = v_PmID (i); "
            +"         v_PmID.delete; "
            +"         v_ObjIDs.delete; "
            +"      END IF; "
            +"   END; "
            ;
  cmd = RSDCommand( Query );
  cmd.addParam("", RSDBP_IN, SeanceID);
  cmd.addParam("", RSDBP_IN, SeanceID);
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro UpdateCalend( Table, MarketID, OperName, ErrMes:@string ):integer
  var Query =
      " DECLARE "
     +"    TYPE callarr_t IS TABLE OF NUMBER (10) "
     +"                         INDEX BY VARCHAR2 (20); "
     +"  "
     +"    v_calPrm     RSI_DlCalendars.calparamarr_t; "
     +"    v_calendId   NUMBER (10); "
     +" BEGIN "
     +"    FOR one_cur IN (SELECT DISTINCT t_curid FROM "+Table+") "
     +"    LOOP "
     +"       v_calPrm.DELETE; "
     +"       v_calPrm ('Object') := '"+OperName+"'; "
     +"       v_calPrm ('ObjectType') := '"+string(DL_CALLNK_MARKET)+"'; "
     +"       v_calPrm ('Market') := '"+string(MarketID)+"'; "
     +"       v_calPrm ('DayType') := '"+string(DL_CALLNK_MRKTDAY_SETTL)+"'; "
     +"       v_calPrm ('MarketPlace') := '"+string(DL_CALLNK_MARKETPLACE_SEC)+"'; "
     +"       v_calPrm ('Currency') := TO_CHAR (one_cur.t_curid); "
     +"  "
     +"       v_calendId := RSI_DlCalendars.DL_GetCalendByDynParam (83, v_calPrm); "
     +"  "
     +"       UPDATE "+Table+" Tb "
     +"          SET Tb.t_CalendID = v_calendId "
     +"        WHERE Tb.t_curid = one_cur.t_curid; "
     +"    END LOOP; "
     +" END; ";

  var cmd = RSDCommand(Query);
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro GetFileName( synonim, Table, FilesName:@string, ErrMes:@string ):integer
  var cmd, ds;

  cmd = RSDCommand( " SELECT REQUIS.FILE_NAME file_name from "+synonim+".MB_REQUISITES REQUIS WHERE REQUIS.ID_MB_REQUISITES IN (SELECT DISTINCT t.T_ID_MB_REQUISITES FROM " +Table+ " t ) " );
  ds = TRsbDataSet(cmd);
  while(ds.MoveNext)
    FilesName = FilesName + ds.file_name + " \n"
  end;
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro CheckFileUpload(synonim, FileType:string, imp_date:date, ErrMes:@string, Cond:string):integer
  var cmd, ds;
  if(Cond == NULL)
    Cond = "";
  end;
  cmd = RSDCommand(" SELECT 1 FROM " + synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = ? AND TRADE_DATE = ? " + Cond);
  cmd.addParam("", RSDBP_IN, FileType);
  cmd.addParam("", RSDBP_IN, imp_date);
  ds = TRsbDataSet(cmd);
  if(not ds.MoveNext)
    ErrMes = "Нет данных в Payments";
    return 1;
  end;
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DelSEM02( ErrMes:@string ):integer
  var cmd = RSDCommand( " TRUNCATE TABLE D_SEM02_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DelSEM03( ErrMes:@string ):integer
  var cmd = RSDCommand( " TRUNCATE TABLE D_SEM03_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DelEQM06( ErrMes:@string ):integer
  var cmd = RSDCommand( " TRUNCATE TABLE D_EQM06_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
        ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro FillSEM21(synonim:string, imp_date:date, ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand( " INSERT INTO D_SEM21_TMP(  "
                   +"   T_ID_MB_SEM21 "           
                   +"  ,T_ID_MB_REQUISITES "      
                   +"  ,T_TRADEDATE "             
                   +"  ,T_BOARDID "             
                   +"  ,T_BOARDTYPE " 
                   +"  ,T_SECURITYID "
                   +"  ,T_SECURITYTYPE "
                   +"  ,T_DECIMALS "
                   +"  ,T_VOLUME "
                   +"  ,T_CURRENCYID "
                   +"  ,T_FACEUNIT "
                   +"  ,T_PRICETYPE "
                   +"  ,T_LOW "
                   +"  ,T_HIGH "
                   +"  ,T_WAPRICE "
                   +"  ,T_ACCINT "
                   +"  ,T_MARKETPRICE "
                   +"  ,T_MARKETPRICE3 "
                   +"  ,T_FACEVALUE ) "          
                   +"  (SELECT " 
                   +"   T.ID_MB_SEM21 "           
                   +"  ,NVL(T.ID_MB_REQUISITES, 0) "      
                   +"  ,NVL(T.TRADEDATE,TO_DATE('01.01.0001', 'DD.MM.YYYY')) "            
                   +"  ,NVL(T.BOARDID, CHR(1)) "             
                   +"  ,NVL(T.BOARDTYPE, CHR(1)) "               
                   +"  ,NVL(T.SECURITYID, CHR(1)) "               
                   +"  ,NVL(T.SECURITYTYPE, CHR(1)) "            
                   +"  ,NVL(T.DECIMALS, 0) "             
                   +"  ,NVL(T.VOLUME, 0) "
                   +"  ,NVL(T.CURRENCYID, CHR(1)) "                
                   +"  ,NVL(T.FACEUNIT, CHR(1)) "                
                   +"  ,NVL(T.PRICETYPE, CHR(1)) "                           
                   +"  ,NVL(T.LOW, 0) "                 
                   +"  ,NVL(T.HIGH, 0) "                 
                   +"  ,NVL(T.WAPRICE, 0) "
                   +"  ,NVL(T.ACCINT, 0) "                 
                   +"  ,NVL(T.MARKETPRICE3, 0) " /*MarketPrice3 загружаем и в курс <Рыночная цена для НДФЛ> и в курс <Рыночная цена>*/                 
                   +"  ,NVL(T.MARKETPRICE3, 0) "              
                   +"  ,NVL(T.FACEVALUE, 0) "                            
                   +"  FROM "+ synonim + ".MB_SEM21 T "
                   +" WHERE T.ID_MB_REQUISITES IN (SELECT ID_MB_REQUISITES FROM "+ synonim + ".PROCESSING_ACTUAL WHERE FILE_TYPE = 'SEM21' AND TRADE_DATE = ? AND ORD_NUM_STR LIKE '00T%') "
                   +"   AND T.ZRID = 0  " 
                   +"   AND NVL(T.SESSIONNO, -1) = 3 " /*берем данные только итоговой сессии*/
                   +"   AND NVL(T.BOARDTYPE, CHR(1)) = 'MAIN' " /*если основной режим торгов*/
                   +"  ) "
                  );
  cmd.addParam("", RSDBP_IN, imp_date);
  cmd.execute();
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;

macro DelSEM21(ErrMes:@string):integer
  var cmd;
  cmd = RSDCommand(" TRUNCATE TABLE D_SEM21_TMP ");
  cmd.execute();
  return 0;
OnError(ErObj)
  ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
  return 1;
end;
