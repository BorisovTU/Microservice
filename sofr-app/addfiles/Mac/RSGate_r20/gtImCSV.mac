/*
$Name:        gtImCSV.mac
$Module:      Шлюз Securities
$Description: импорт CSV-файлов с рынка FORTS Московской биржи
*/

import Календарь, "gtdlfun.mac", "gtmktrep.mac", "GTRrate.mac","funk";
import "RegvalReader.mac", "DateFormatter.mac", "RgCommissDataStruct.mac", "RgPayImportHelper.mac";

private const SRC_CODE = "SRC-19";
private const CtrlBrkErr = 17;
private const PNFLD_IMPDATE       = 0,
              PNFLD_BEGDATE       = 1,
              PNFLD_ENDDATE       = 2,
              PNFLD_FILE_FUTURES  = 3,
              PNFLD_FILE_OPTION   = 4,
              PNFLD_FILE_POS      = 5,
              PNFLD_FILE_DEALS    = 6,
              PNFLD_FILE_ITOG     = 7,
              PNFLD_FILE_REQUEST  = 8,
              PNFLD_FILE_COMS     = 9,
              PNFLD_COM_CODE      = 10,
              PNFLD_FILE_MON      = 11,
              PNFLD_FILE_STD_FUTURES  = 12,
              PNFLD_FILE_STD_OPTION   = 13,
              PNFLD_ORDER_NUM         = 14;

PRIVATE CONST RATE_POINT = 5;/* точность задания курса в файле*/
PRIVATE CONST DOCKIND_DV_MARKETREPORT  = 320; // Отчет об исполнении

PRIVATE CONST CSV_ACCOUNT_OUR_BANK = "CL";

private record pp(IMP_CSV, "rgate.lbr") dialog;

private var SeanceID, RG, RGLog, ErrMes:string = "", FlagCtrlBrk:bool = false, MarketReportID = "", IsMarketReportLoad = false, ExistNextDealFile = false, ExistNextPosFile = false, ExistNextReqFile = false, ExistNextMonFile = false;

PRIVATE VAR NumImportDeals = 0, NumImportDealsTotal = 0, NumImportDealsAll = 0,
            NumImportPos = 0, NumImportPosTotal = 0, NumImportPosAll = 0,
            NumImportReq = 0, NumImportReqTotal = 0, NumImportReqAll = 0,
            NumImportMon = 0, NumImportMonTotal = 0, NumImportMonAll = 0,
            NumImportPFI = 0, NumImportPFITotal = 0, NumImportPFIAll = 0;

private var CurImpDate:date;
private var DataFile = NULL;
private var Com_Num:string = NULL;
private var ExtSettleCode:string = "";
private var ExtPosSettleCode:string = "";

PRIVATE FILE FileDeal() txt 1024;
PRIVATE FILE FileItog() txt 1024;
PRIVATE FILE FileReq()  txt 1024;
PRIVATE FILE FilePos()  txt 1024;
PRIVATE FILE FileCom()  txt 1024;
PRIVATE FILE FileMon()  txt 1024;

/*  номера столбцов в f04_XX00.csv  */  
 private const F04_ID_DEAL    = 0,  
               F04_ISIN       = 1,  
               F04_PRICE      = 2,  
               F04_VOL        = 3,  
               F04_KOD_SELL   = 4,  
               F04_KOD_BUY    = 5,  
               F04_DATE       = 6,  
               F04_TIME       = 7,  
               F04_ROFIT_USD  = 8,  
               F04_TYPE_BUY   = 9,
               F04_TYPE_SELL  = 10,   
               F04_VAR_MARG_B = 11, 
               F04_VAR_MARG_S = 12, 
               F04_USER_SELL  = 13, 
               F04_USER_BUY   = 14, 
               F04_NO_BUY     = 15, 
               F04_NO_SELL    = 16, 
               F04_FEE_BUY    = 17, 
               F04_FEE_SELL   = 18, 
               F04_DATE2      = 19, 
               F04_COMM_BUY   = 20, 
               F04_COMM_SELL  = 21, 
               F04_FEE_NS_B   = 22, 
               F04_FEE_NS_S   = 23, 
               F04_PRICE_RUR  = 24, 
               F04_EXT_ID_B   = 25, 
               F04_EXT_ID_S   = 26, 
               F04_DATE_CLR   = 27, 
               F04_REPO_ID    = 28, 
               F04_FEE_EX_B   = 29, 
               F04_VAT_EX_B   = 30, 
               F04_FEE_CC_B   = 31, 
               F04_VAT_CC_B   = 32, 
               F04_FEE_EX_S   = 33, 
               F04_VAT_EX_S   = 34, 
               F04_FEE_CC_S   = 35, 
               F04_VAT_CC_S   = 36, 
               F04_ID_MULT    = 37, 
               F04_SIGNS_BUY  = 38,
               F04_SIGNS_SELL = 39,
               F04_COUNTERPARTY       = 40,
               F04_NCC_REQUEST_BUY    = 41,
               F04_NCC_REQUEST_SELL   = 42,
               F04_VAR_MARG_B_SETTL_PRICE = 43,
               F04_VAR_MARG_B_SWAP_RATE   = 44,
               F04_VAR_MARG_S_SETTL_PRICE = 45,
               F04_VAR_MARG_S_SWAP_RATE   = 46; 
                                    

/*номера столбцов в o04_XX00.csv*/  
 private const O04_ID_DEAL    = 0,  
               O04_ISIN       = 1,  
               O04_PRICE      = 2,  
               O04_VOL        = 3,  
               O04_KOD_SELL   = 4,  
               O04_KOD_BUY    = 5,  
               O04_DATE       = 6,  
               O04_TIME       = 7,  
               O04_PROFIT_USD = 8,  
               O04_TYPE_BUY   = 9,
               O04_TYPE_SELL  = 10,   
               O04_USER_BUY   = 11, 
               O04_USER_SELL  = 12, 
               O04_NO_BUY     = 13, 
               O04_NO_SELL    = 14, 
               O04_FEE_BUY    = 15, 
               O04_FEE_SELL   = 16, 
               O04_DATE2      = 17, 
               O04_COMM_BUY   = 18, 
               O04_COMM_SELL  = 19, 
               O04_FEE_NS_B   = 20, 
               O04_FEE_NS_S   = 21, 
               O04_PREM_BUY   = 22, 
               O04_PREM_SELL  = 23, 
               O04_PRICE_RUR  = 24, 
               O04_EXT_ID_B   = 25, 
               O04_EXT_ID_S   = 26, 
               O04_DATE_CLR   = 27, 
               O04_VAR_MARG_B = 28, 
               O04_VAR_MARG_S = 29, 
               O04_FEE_EX_B   = 30, 
               O04_VAT_EX_B   = 31, 
               O04_FEE_CC_B   = 32, 
               O04_VAT_CC_B   = 33, 
               O04_FEE_EX_S   = 34, 
               O04_VAT_EX_S   = 35, 
               O04_FEE_CC_S   = 36, 
               O04_VAT_CC_S   = 37, 
               O04_SIGNS_BUY  = 38,
               O04_SIGNS_SELL = 39,
               O04_COUNTERPARTY       = 40,
               O04_NCC_REQUEST_BUY    = 41,
               O04_NCC_REQUEST_SELL   = 42,
               O04_PREM_BUY_CURRENCY  = 43,
               O04_PREM_SELL_CURRENCY = 44;
	      
/*номера столбцов в f07.csv*/
private const F07_DATE       = 0, //дата курсов   
              F07_CONTRACT   = 1, //код ПИ
              F07_EXECUTION  = 2, //последний день обращений              
              F07_VOLUME     = 3, //оборот в контрактах
              F07_VOL_RUBL   = 4, //оборот в рублях       
              F07_LOW        = 5, //курс вида "Минимальная цена" для данного ПИ
              F07_HIGH       = 6, //курс вида "Максимальная цена" для данного ПИ  
              F07_OPEN       = 7, //цена открытия
              F07_CLOSE      = 8, //цена закрытия
              F07_SETTL      = 9, //курс вида "Расчетная цена" для данного ПИ
              F07_TRADES     = 10,//количество сделок
              F07_INTEREST   = 11,//количество позиций
              F07_FEE        = 12,//сумма биржевого сбора и комиссионного вознаграждения 
              F07_TICK_PRICE = 13,//курс вида "Стоимость шага цены" для данного ПИ  
              F07_TICK       = 14,//шаг цены  
              F07_AVRG       = 15,//средневзвешенная цена
              F07_POSES_RUBL = 16,//объём позиций в рублях
              F07_LIMIT      = 17,//лимит колебания цены ближнего фьючерса
              F07_RISK_WR    = 18,//величина добавочного риска
              F07_COFFOUT    = 19,//краевой коэффициент опционов на этот фьючерс
              F07_BASE_FUT   = 20,//код базового актива
              F07_IS_SPREAD  = 21,//признак вхождения фьючерса в спрэд (0 - не входит, 1 - входит)
              F07_NAME       = 22,//краткий код инструмента (фьючерсного контракта), -> код в номере счета
              F07_DATE2      = 23,//дата проведения торгов
              F07_EXECUTION2 = 24,//дата исполнения
              F07_DEPOSIT    = 25,//гарантийное обеспечение
              F07_IS_PERCENT = 26,//признак котировки ( 1 - в процентах, 0 - не в процентах, 2 - признак фьючерса на температуру или электричество)
              F07_SETTL_RUR  = 27,/*это не загружаем, загружаем только F07_SETTL (по аналогии как грузили с РТС)*///Но, согласно тз#17 Импорта CSV с московской биржи, грузим
              F07_LOT_VOLUME = 28,//кол-во единиц базового актива в контракте (лот)
              F07_TICK_PR_GO = 29,//стоимость шага цены в руб. для расчета 
              F07_LIMIT_L1   = 30,//широкий лимит
              F07_PR_SETTL   = 31,//расчётная цена в дневном клиринге (пункты)
              F07_PR_SETTL_R = 32,//расчётная цена в дневном клиринге (руб.)
              F07_TYPE_EXEC  = 33,//0 - расчетный, 1 - поставочный
              F07_SECTION    = 34,//секция
              F07_SPOT       = 35,//признак инструментов "спот"
              F07_BASE       = 36,//базовый контракт для инструментов "спот"
              F07_TYPE_SBOR  = 37,//тип расчёта биржевого сбора (RUR - в рублях за один контракт, PERCENT - в % от суммы сделки)
              F07_NS_VOLUME  = 38,//оборот по внесистемным сделкам в контрактах
              F07_NS_TRADES  = 39,//количество внесистемных сделок
              F07_NS_FEE     = 40,//ставка сбора по внесистемным сделкам
              F07_NS_VOLRUBL = 41,//оборот по внесистемным сделкам в рублях
              F07_L_TRADEDAY = 42,//дата последнего торгового дня по инструменту (срок: дата)
              F07_MULTILEG   = 43,//0 - обычная сделка, 1- связанная сделка
              F07_DEPOSIT_BUY  = 44,//ставка обспечения с учётом направления позиции в продажу (руб)
              F07_DEPOSIT_SELL = 45,//ставка обспечения с учётом направления позиции в покупку (руб)
              F07_SWAP_RATE    = 46;//средневзвешенное значение своп-разницы 
              
/*номера столбцов в o07.csv*/
private const O07_DATE       = 0, //дата проведения торгов 
              O07_CONTRACT   = 1, //код ПИ
              O07_EXECUTION  = 2, //последний день обращения
              O07_VOLUME     = 3, //оборот в контрактах 
              O07_VOL_RUBL   = 4, //оборот в рублях    
              O07_LOW        = 5, //минимальная цена
              O07_HIGH       = 6, //максимальная цена
              O07_OPEN       = 7, //цена открытия
              O07_CLOSE      = 8, //цена закрытия
              O07_AVRG       = 9, //средневзвешенная цена
              O07_TRADES     = 10,//количество сделок
              O07_INTEREST   = 11,//количество позиций
              O07_FEE        = 12,//биржевой сбор
              O07_TICK_PRICE = 13,//стоимость шага цены
              O07_TICK       = 14,//шаг цены премии
              O07_POSES_RUBL = 15,//объём позиций в рублях
              O07_DEPO_UNCOV = 16,//гарантийное обеспечение непокрытой позиции
              O07_DEPO_COV   = 17,//гарантийное обеспечение синтетической позиции
              O07_FUT_CONTR  = 18,//код базового актива
              O07_STRIKE     = 19,//страйк опциона (цена исполнения)
              O07_PUT        = 20,//тип опциона
              O07_EVROP      = 21,//стиль опцоина
              O07_DATE2      = 22,//дата проведения торгов
              O07_EXECUTION2 = 23,//последний день обращения
              O07_NAME       = 24,//описатель инструмента
              O07_CLOSE_TIME = 25,//время последней сделки
              O07_VOLAT      = 26,//волатильность
              O07_THEORPRICE = 27,//теоретическая цена
              O07_TICK_PR_GO = 28,//стоимость шага цены в руб. для расчёта ГО
              O07_PR_VOLAT   = 29,//волатильность в дневном клиринге
              O07_PR_THEORPR = 30,//теоретическая цена в дневном клиринге
              O07_FUT_TYPE   = 31,//маржируемый опцион
              O07_BASEGOBUY  = 32,//базовое ГО под покупку маржируемых опционов
              O07_SETTLEMENT_CURRENCY = 33,//код валюты, в которой осуществляются денежные расчёты
              O07_TICK_PRICE_CURRENCY = 34;//стоимость шага цены в торговой системе

/*номера столбцов в fordlogXXYY.csv*/
private const FORD_N           = 0,
              FORD_ISIN        = 3,
              FORD_AMOUNT      = 4,
              FORD_ID_DEAL     = 6,
              FORD_PRICE       = 8,
              FORD_MOMENT      = 9,
              FORD_DIR         = 10,
              FORD_CLIENT_CODE = 14,
              FORD_COMMENT     = 16;


/*номера столбцов в oordlogXXYY.csv*/
private const OORD_N           = 0,
              OORD_ISIN        = 3,
              OORD_AMOUNT      = 4,
              OORD_ID_DEAL     = 6,
              OORD_PRICE       = 8,
              OORD_MOMENT      = 9,
              OORD_DIR         = 10,
              OORD_CLIENT_CODE = 14,
              OORD_COMMENT     = 16;


/*номера столбцов в fposXXYY.csv*/
private const FPOS_DATE       = 0, 
              FPOS_KOD        = 1, 
              FPOS_ACCOUNT    = 2, 
              FPOS_ISIN       = 3, 
              FPOS_POS_BEG    = 4, 
              FPOS_POS_END    = 5, 
              FPOS_VAR_MARG_P = 6, 
              FPOS_VAR_MARG_D = 7, 
              FPOS_SBOR       = 8, 
              FPOS_GO_NETTO   = 9, 
              FPOS_GO_BRUTTO  = 10,
              FPOS_POS_EXEC   = 11,
              FPOS_DU         = 12,
              FPOS_SBOR_EXEC  = 13,
              FPOS_SBOR_NOSYS = 14,
              FPOS_FEE_EXEC   = 15,
              FPOS_FINE_EXEC  = 16,
              FPOS_ACUUM_GO   = 17,
              FPOS_FEE_TRANS  = 18,
              FPOS_SBOR_EX    = 19,
              FPOS_VAT_EX     = 20,
              FPOS_SBOR_CC    = 21,
              FPOS_VAT_CC     = 22,
              FPOS_POS_FAILED = 23,
              FPOS_VAR_MARG_P_SETTL_PRICE = 24,
              FPOS_VAR_MARG_P_SWAP_RATE   = 25,
              FPOS_VAR_MARG_D_SETTL_PRICE = 26,
              FPOS_VAR_MARG_D_SWAP_RATE   = 27;

/*номера столбцов в oposXXYY.csv*/
private const OPOS_DATE       = 0, 
              OPOS_KOD        = 1, 
              OPOS_ACCOUNT    = 2, 
              OPOS_ISIN       = 3, 
              OPOS_POS_BEG    = 4, 
              OPOS_POS_END    = 5, 
              OPOS_PREM       = 6, 
              OPOS_SBOR       = 7, 
              OPOS_GO         = 8, 
              OPOS_POS_EXEC   = 9, 
              OPOS_POS_ENDCIR = 10,
              OPOS_DU         = 11,
              OPOS_SBOR_EXEC  = 12,
              OPOS_SBOR_NOSYS = 13,
              OPOS_VAR_MARG_P = 14,                                                           
              OPOS_VAR_MARG_D = 15,
              OPOS_SBOR_EX    = 16,
              OPOS_VAT_EX     = 17,
              OPOS_SBOR_CC    = 18,
              OPOS_VAT_CC             = 19,
              OPOS_PREM_CURRENCY      = 20,
              OPOS_PREM_PROM          = 21,
              OPOS_PREM_PROM_CURRENCY = 22,
              OPOS_NOV                = 23;
                                  
/*номера столбцов в monXXYY.csv*/
private const MON_DATE       = 0,
              MON_KOD        = 1,
              MON_ACCOUNT    = 2,
              MON_TYPE       = 3,
              MON_AMOUNT_BEG = 4,
              MON_VAR_MARG   = 5,
              MON_PREM       = 6,
              MON_PAY        = 7,
              MON_FUT_SBOR   = 8,
              MON_OPT_SBOR   = 9,
              MON_NOV         = 10,
              MON_GO          = 11,
              MON_AMOUNT_END  = 12,
              MON_FREE        = 13,
              MON_DU          = 14,
              MON_GOWIDE      = 15,
              MON_FREEWIDE    = 16,
              MON_MARGINCALL  = 17,
              MON_SBOR_EX     = 18,
              MON_VAT_EX      = 19,
              MON_SBOR_CC     = 20,
              MON_VAT_CC      = 21,
              MON_RUB_BEG     = 22,
              MON_RUB_PAY     = 23,
              MON_RUB_END     = 24,
              MON_COM_PL_BEG  = 25,
              MON_COM_PL_PAY  = 26,
              MON_COM_PL_PREM = 27,
              MON_COM_PL_END  = 28,
              MON_EXT_REZ     = 29;

class FileScanner()
  macro FindCsvFiles (fileMask:string)
    var list = TDirList(fileMask, "f");
    list.Sort(0);

    return list;
  end;
end;

/* получаем Код информации Трейдера */
private macro GetRefNote(ClientCodeInFile:string)
  var ClientCodeBegPos = 0, RefCode = "";  
  if( (ClientCodeInFile != "") AND (ClientCodeInFile != " ") )
     ClientCodeBegPos = Index( ClientCodeInFile, "/");
     if( ClientCodeBegPos != 0 ) 
        ClientCodeBegPos = ClientCodeBegPos + 1;
        RefCode = SubStr( ClientCodeInFile, ClientCodeBegPos);
     else
        RefCode = ClientCodeInFile;
     end; 
  else
     RefCode = "";
  end;
  return RefCode;
end;

/* Аналог оператора ?: в си. */
private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
end;

private macro ЧислоСтрокой( _var, _point:integer ) 
   return ExecExp("String(_var:0" + ":" + string(_point) + ")");
end;
               
private macro FileDate( date_val, delim )
  var day, month, year;
  DateSplit(date_val, day, month, year);

  year = year - 1900;
  if( year >= 100 )
     year = year - 100;
  end;

  return RGDLFUN_LZ(day,2) + delim + RGDLFUN_LZ(month,2) + delim + RGDLFUN_LZ(year,2);
end;

/*получить дату из файла (не очень понятно, в каком формате она там сидит: в файле одно - в описании с биржи и ТЗ - другое)*/
private macro GetCorrectDate(DateFromFile:string)
   var vDate = date(0,0,0);
   if( (Date(DateFromFile) == null) or (Date(DateFromFile) == "") )
      RGDLFUN_IsCorrectDateForDbf(DateFromFile,vDate);
   else
      vDate = Date(DateFromFile);
   end;
   return vDate;
end;

   /*класс нога для импорта спредов*/
PRIVATE CLASS leg (newType:Integer, newMult:string, newISIN:string, newCode_Sell:string,newCode_Buy:string, newPrice:double, newPrice_RUR:double, newDate:date)
   var LegType      = newType;
   var LegId_Mult   = newMult;
   var LegISIN      = newISIN;
   var LegCODE_SELL = newCode_Sell;
   var LegCODE_BUY  = newCode_Buy;
   var LegPrice     = newPrice;
   var LegPrice_RUR = newPrice_RUR;
   var LegDate      = newDate;
end;

PRIVATE CLASS req (newOperKind:integer, newFI_Code:string, newCodeTS:string, newDate:date, newTime:time, newType:integer, newClient:string, newFI_Code_2:string, newPrice:double, newPrice_RUR:double, newDate_2:date, newReqIDDeal:string, newReqIDMult:string, newPrice_2:double, newPrice_RUR_2:double, newVolume:money, newTraderInfo:string )
   var ReqOperKind    = newOperKind;
   var ReqFI_Code     = newFI_Code;
   var ReqCodeTS      = newCodeTS;
   var ReqDate        = newDate;
   var ReqTime        = newTime;
   var ReqType        = newType;
   var ReqClient      = newClient;
   var ReqFI_Code_2   = newFI_Code_2;
   var ReqPrice       = newPrice;
   var ReqPrice_RUR   = newPrice_RUR;
   var ReqDate_2      = newDate_2;
   var ReqIDDeal      = newReqIDDeal;
   var ReqIDMult      = newReqIDMult;
   var ReqPrice_2     = newPrice_2;
   var ReqPrice_RUR_2 = newPrice_RUR_2;
   var ReqVolume      = newVolume;
   var ReqTraderInfo  = newTraderInfo;//TEG 28.06.19
end;

/*Файл с данными для импорта*/
PRIVATE CLASS CDataFile( DVKind:INTEGER, ImpDate:DATE )

  var Legs:TArray = TArray();
  var Reqs:TArray = TArray();
  var currentRequest = 0;

  PRIVATE var m_DVKind = DVKind,
              m_ImpDate = ImpDate,
              m_IsDealExec = false,
              m_UniqDealCode = "",
              m_UniqReqCode  = "",
              m_ExtDealCode  = "",
              m_UniqExtDealCode = ""; 

  var DataDir = "" ;
  var FileItogName = "",
      FileDealName = "",
      FileReqName  = "",
      FilePosName  = "";

  var ExistFileItog = false,
      ExistFileDeal = false,
      ExistFileReq  = false,
      ExistFilePos  = false;
   
  PRIVATE MACRO OpenError( p_File:STRING )
     var Msg = "Ошибка открытия файла данных " + string(p_File);
     RGLog.Error( Msg );
  END;

  PRIVATE MACRO CloseError( p_File:STRING )
     var Msg = "Ошибка закрытия файла данных " + string(p_File);
     RGLog.Error( Msg );
  END;

  MACRO OpenData(i:integer )
     var List;
      if ( valtype(i) ==  V_UNDEF)
         i = 0;
      end;

     var ErrStr = "";
     close(FileDeal);
     close(FilePos);
      /*Определить имя файла импорта*/
     if( m_DVKind == DERIVATIVE_FUTURES )
        FileItogName = "f07.csv";
        FileDealName = "f04_????.csv";
        FileReqName  = "fordlog????.csv";
        FilePosName  = "fpos????.csv";
     elif( m_DVKind == DERIVATIVE_OPTION )
        FileItogName = "o07.csv";
        FileDealName = "o04_????.csv";
        FileReqName  = "oordlog????.csv";
        FilePosName  = "opos????.csv";
     else               
        RGLog.Message( "Неверный вид ПИ." );
        return NULL;
     end;
   
 // teg 21.05.19 пока читаем реестр так
 // DataDir = GetRegImportDir("FORTSMICEX", @ErrStr);
    var RegDir = "РСХБ\\ДИРЕКТОРИИ\\FORTSMICEX";
    GetRegistryValue(RegDir, V_STRING, DataDir, @ErrStr);

   
     if( (ErrStr != "") or (ErrStr == null) )
        RGLog.Message( ErrStr );
        ErrStr = "";
     end;
   
     DataDir = DataDir +"\\"+ FileDate(m_ImpDate, ".") + "\\"; 
    
     if( pp.file_deals == SET_CHAR )

        List = TDirList(DataDir + FileDealName, "f");
       
        List.Sort(0);
       
        if( List.Count == 0 )
           ExistNextDealFile = false;
           if (i == 0)
              //RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FileDealName);
              RGLog.Message( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FileDealName);
           end;
        elif (i < List.Count)

           ExistNextDealFile = IIF( i + 1 < List.Count, true, false ); 
           FileDealName = List.name(i);
           ExtSettleCode = SubStr(FileDealName, 5, 4); // Сразу возьмем из названия расчетный код (фрагмент ???? после "f04_" или "o04_")
              
           if( open( FileDeal, DataDir + FileDealName ) == false )
              OpenError( string(DataDir + FileDealName) ); 
              ExistFileDeal = false;
           else
              RGLog.Message( "ОТКРЫТИЕ ФАЙЛА: " + string(DataDir + FileDealName) );
              ExistFileDeal = true;
           end;
        end;
     end;

     if( pp.file_pos == SET_CHAR )

        List = TDirList(DataDir + FilePosName, "f");
       
        List.Sort(0);
       
        if( List.Count == 0 )
           ExistNextPosFile = false;
           if (i == 0)
              //RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FilePosName);
                RGLog.Message( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FilePosName);
           end;
        elif (i < List.Count)
           ExistNextPosFile = IIF( i + 1 < List.Count, true, false );  
           FilePosName = List.name(i);
           ExtPosSettleCode = SubStr(FilePosName, 5, 4); // Сразу возьмем из названия расчетный код (фрагмент ???? после "fpos" или "opos")

           if( open( FilePos, DataDir + FilePosName ) == false )
              OpenError( string(DataDir + FilePosName) ); 
              ExistFilePos = false;
           else
              RGLog.Message( "ОТКРЫТИЕ ФАЙЛА: " + string(DataDir + FilePosName) );
              ExistFilePos = true;
           end;
        end;
     end;

     if( (pp.file_itog == SET_CHAR) and (i == 0) )
       //TEG для файлов o07 и f07 сделаем обработку так же как и по остальным
       List = TDirList(DataDir + FileItogName, "f");
       List.Sort(0);
       if( List.Count == 0 )
           ExistFileItog = false;
           if (i == 0)
              //RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FilePosName);
                RGLog.Message( "Ошибка открытия файла данных. Не найден файл " + DataDir + FileItogName);
           end;
       else
        if( open( FileItog, DataDir + FileItogName ) == false )
           OpenError( string(DataDir + FileItogName) ); 
           ExistFileItog = false;
        else
           RGLog.Message( "ОТКРЫТИЕ ФАЙЛА: " + string(DataDir + FileItogName) );
           ExistFileItog = true;
        end;
      end;  
     end;

     if( pp.file_request == SET_CHAR )
        List = TDirList(DataDir + FileReqName, "f");
       
        List.Sort(0);
       
        if( List.Count == 0 )
           ExistNextReqFile = false;
           if (i == 0)
             // RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FileReqName);
                RGLog.Warning_FutureMarket( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FileReqName);  /*CHVA 528185*/
           end;
        elif (i < List.Count)
           ExistNextReqFile = IIF( i + 1 < List.Count, true, false );        
           FileReqName = List.name(i);
           if( open( FileReq, DataDir + FileReqName ) == false )
              OpenError( string(DataDir + FileReqName) ); 
              ExistFileReq = false;
           else
              RGLog.Message( "ОТКРЫТИЕ ФАЙЛА: " + string(DataDir + FileReqName) );
              ExistFileReq = true;
           end;
        end;
     end;

     return true;

  END;

  MACRO CloseData()

     if( this.IsRunFileDeal() and (close( FileDeal ) == false) )
        CloseError( DataDir, FileDealName); 
     end;

     if( this.IsRunFilePos() and (close( FilePos ) == false) )
        CloseError( DataDir, FilePosName); 
     end;

     if( this.IsRunFileItog() and (close( FileItog ) == false) )
        CloseError( DataDir, FileItogName); 
     end;

     if( this.IsRunFileReq() and (close( FileReq ) == false) )
        CloseError( DataDir, FileReqName); 
     end;

     return true;

  END;  

  MACRO GetUniqDealCode()
     return m_UniqDealCode;
  END;  

  MACRO Get04_TYPE_BUY()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return int(FileDeal(F04_TYPE_BUY));
     end;
     return int(FileDeal(O04_TYPE_BUY));
  END;

  MACRO Get04_TYPE_SELL()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return int(FileDeal(F04_TYPE_SELL));
     end;
     return int(FileDeal(O04_TYPE_SELL));
  END;  

  MACRO Get04_TYPE()
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_TYPE_BUY();
     end;
     return this.Get04_TYPE_SELL();
  END;

  MACRO SetIsDealExec()
     if ( ((Get04_TYPE() == 11) or (Get04_TYPE() == 24) or (Get04_TYPE() == 25)) and (m_DVKind == DERIVATIVE_FUTURES) ) 
        m_IsDealExec = true;
     elif ( ( (Get04_TYPE() == 1) or (Get04_TYPE() == 4) ) and (m_DVKind == DERIVATIVE_OPTION) )
        m_IsDealExec = true;
     else
        m_IsDealExec = false;
     end; 
  END;  

  MACRO GetIsDealExec()
     return m_IsDealExec;
  END;  

  MACRO IsRunFileDeal()
     return ExistFileDeal;
  END;  

  MACRO IsRunFileReq()
     return ExistFileReq;
  END;    

  MACRO IsRunFilePos()
     return ExistFilePos;
  END;  

  MACRO IsRunFileItog()
     return ExistFileItog;
  END;  

  MACRO GetDvKind()
     return m_DVKind;
  END;  

  MACRO Get04_ID_DEAL()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return string(FileDeal(F04_ID_DEAL));
     end;
     return string(FileDeal(O04_ID_DEAL));
  END;

  MACRO Get04_DATE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return GetCorrectDate(FileDeal(F04_DATE));
     end;
     return GetCorrectDate(FileDeal(O04_DATE));
  END;

  MACRO Get04_DATE_CLR()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return GetCorrectDate(FileDeal(F04_DATE_CLR));
     end;
     return GetCorrectDate(FileDeal(O04_DATE_CLR));
  END;

  MACRO Get07_DATE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return GetCorrectDate(FileItog(F07_DATE));
     end;
     return GetCorrectDate(FileItog(O07_DATE));
  END;

  MACRO Get04_ISIN()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileDeal(F04_ISIN));
     end;
     return Trim(FileDeal(O04_ISIN));
  END;

  MACRO Get07_CONTRACT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileItog(F07_CONTRACT));
     end;
     return Trim(FileItog(O07_CONTRACT));
  END;
  
  MACRO Get07_EXECUTION()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return GetCorrectDate(FileItog(F07_EXECUTION));
     end;
     return GetCorrectDate(FileItog(O07_EXECUTION));
  END;

  MACRO Get07_LOW()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileItog(F07_LOW));
     end;
     return Double(FileItog(O07_LOW));
  END;

  MACRO Get07_HIGH()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileItog(F07_HIGH));
     end;
     return Double(FileItog(O07_HIGH));
  END;
  
  MACRO Get07_CLOSE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileItog(F07_CLOSE));
     end;
     return Double(FileItog(O07_CLOSE));
  END;

  MACRO Get07_TICK_PRICE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileItog(F07_TICK_PRICE));
     end;
     return Double(FileItog(O07_TICK_PRICE));
  END;

  MACRO Get07_TICK()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileItog(F07_TICK));
     end;
     return Double(FileItog(O07_TICK)); 
  END;
  
  MACRO Get07_BASE_FUT()
     if  ( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileItog(F07_BASE_FUT));
     elif( m_DVKind == DERIVATIVE_OPTION )
        return Trim(FileItog(O07_FUT_CONTR));
     end;
     return "";
  END;
  
  MACRO Get07_NAME()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileItog(F07_NAME));
     end;
     return Trim(FileItog(O07_NAME));
  END;
  
  MACRO Get07_IS_PERCENT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return FileItog(F07_IS_PERCENT);
     end;
  END;
  
  MACRO Get07_SETTL()
     return FileItog(F07_SETTL);
  END;
  
  MACRO Get07_SETTL_RUR()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return FileItog(F07_SETTL_RUR);
     end;
  END;
  
  MACRO Get07_LOT_VOLUME()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return FileItog(F07_LOT_VOLUME);
     end;
  END;
  
  MACRO Get07_TYPE_EXEC()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return FileItog(F07_TYPE_EXEC);
     end;
  END;
  
  MACRO Get07_L_TRADEDAY()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return GetCorrectDate(FileItog(F07_L_TRADEDAY));
     end;
  END;
  
  MACRO Get07_MULTILEG
     if( m_DVKind == DERIVATIVE_FUTURES )
        return FileItog(F07_MULTILEG);
     elif( m_DVKind == DERIVATIVE_OPTION )
        return 0;
     end;
  END;
  
  MACRO Get07_PUT()
     return FileItog(O07_PUT);
  END;
  
  MACRO Get07_STRIKE()
     return FileItog(O07_STRIKE);
  END;
  
  MACRO Get07_EVROP()
     return FileItog(O07_EVROP);
  END;
  
  MACRO Get07_FUT_TYPE()
     return FileItog(O07_FUT_TYPE);
  END;

  MACRO Get04_KOD_BUY()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileDeal(F04_KOD_BUY));
     end;
     return Trim(FileDeal(O04_KOD_BUY));
  END;

  MACRO Get04_KOD_SELL()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileDeal(F04_KOD_SELL));
     end;
     return Trim(FileDeal(O04_KOD_SELL));
  END;

  MACRO GetOperKind()
     if( m_IsDealExec == true )
        if( m_DVKind == DERIVATIVE_FUTURES )
           return Int(ИсполнениеФьючерсов);
        else
           if( Get04_TYPE() == 1 )
           return Int(ИсполнениеОпционов);
           else
              return Int(ЭкспирацияОпционов);
           end;
        end;
     else
        if( this.Get04_KOD_BUY() != "" )
           if( m_DVKind == DERIVATIVE_FUTURES )
               return Int(ПокупкаФьючерсов);
           else
               return Int(ПокупкаОпционов);
           end;
        else
           if( m_DVKind == DERIVATIVE_FUTURES )
               return Int(ПродажаФьючерсов);
           else
               return Int(ПродажаОпционов);
           end;
        end;
     end;
  END;

  MACRO GetSecondOperKind()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Int(ПродажаФьючерсов);
     else
        return Int(ПродажаОпционов);
     end;
  END;

  MACRO GetKOD()/*код клиента*/
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_KOD_BUY();
     end;
     return this.Get04_KOD_SELL();
  END;

  MACRO GetDealDate()
     return this.Get04_DATE();
  END;

  MACRO GetISIN()
     return this.Get04_ISIN();
  END;

  MACRO Get04_TIME()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return TIME(FileDeal(F04_TIME));
     end;
     return TIME(FileDeal(O04_TIME));
  END;

  MACRO GetDealTime()
     return this.Get04_TIME();
  END;

  MACRO GetAmount()
     return this.Get04_VOL();
  END;

  MACRO GetTypePosition()
     if( m_IsDealExec == true )
        if( Get04_KOD_BUY() != "" )
           return 1; /*короткая позиция*/
        else
           return 2; /*длинная позиция*/
        end;
     end;
     return 0;
  END;

  MACRO GetPOS_EXEC()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FilePos(FPOS_POS_EXEC));
     end;
     return Money(FilePos(OPOS_POS_EXEC));
  END;

  MACRO Get04_VOL()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_VOL));
     end;
     return Money(FileDeal(O04_VOL));
  END;

  MACRO GetPOS_DATE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return GetCorrectDate(FilePos(FPOS_DATE));
     end;
     return GetCorrectDate(FilePos(OPOS_DATE));
  END;

  MACRO GetPOS_ACCOUNT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FilePos(FPOS_ACCOUNT));
     end;
     return Trim(FilePos(OPOS_ACCOUNT));
  END;

  MACRO GetPOS_ISIN()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FilePos(FPOS_ISIN));
     end;
     return Trim(FilePos(OPOS_ISIN));
  END;

  MACRO GetPOS_KOD()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FilePos(FPOS_KOD));
     end;
     return Trim(FilePos(OPOS_KOD));
  END;

  macro IsDealInclude()                                                                                                                                         
     var Type = Get04_TYPE(), vDate = Get04_DATE_CLR();                                                                                                            
     return ( ((Type == 0) or (Type == 1) or (Type == 2) or (Type == 3) or (Type == 4) or (Type == 11) or (Type == 14) or (Type == 15) or (Type == 24) or (Type == 25) or (Type == 26)) and (vDate<=pp.end_date) and (vDate>=pp.beg_date) );                               
  end;                                                                                                                                                          
                                                                                                                                                                
  macro IsPosInclude()                                                                                                                                          
     var vDate = GetPOS_DATE();                                                                                                            
     return ( (GetPOS_ACCOUNT() == CSV_ACCOUNT_OUR_BANK) and (vDate<=pp.end_date) and (vDate>=pp.beg_date) );                                        
  end;                                                                                                                                                          
                                                                                                                                                                
  /*Это оепрация исполнения ?*/                                                                                                                                 
  macro IsPosExec()                                                                                                                                             
     return (GetPOS_EXEC() != $0 );                                                                                                             
  end;                                                                                                                                                          

  MACRO GetPOS_SBOR_EXEC()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FilePos(FPOS_SBOR_EXEC));
     end;
     return Money(FilePos(OPOS_SBOR_EXEC));
  END;

  MACRO GetPrice()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileDeal(F04_PRICE));
     end;
     return Double(FileDeal(O04_PRICE));
  END;

  MACRO GetPrice_RUR()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Double(FileDeal(F04_PRICE_RUR));
     end;
     return Double(FileDeal(O04_PRICE_RUR));
  END;

  MACRO GetEX_Comm()
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_FEE_EX_B();
     end;
     return this.Get04_FEE_EX_S();
  END;

  MACRO Get04_NO_B()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return (FileDeal(F04_NO_BUY));
     end;
     return (FileDeal(O04_NO_BUY));
  END;

  MACRO Get04_NO_S()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return (FileDeal(F04_NO_SELL));
     end;
     return (FileDeal(O04_NO_SELL));
  END;

  MACRO Get04_NO()
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_NO_B();
     end;
     return this.Get04_NO_S();
  END;

  MACRO GetCC_Comm()
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_FEE_CC_B();
     end;
     return this.Get04_FEE_CC_S();
  END;

  MACRO GetNS_Comm()
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_FEE_NS_B();
     end;
     return this.Get04_FEE_NS_S();
  END;

  MACRO GetMargin()
     if( this.Get04_KOD_BUY() != "" )
        return this.Get04_VAR_MARG_B();
     end;
     return this.Get04_VAR_MARG_S();
  END;

  MACRO Get04_FEE_EX_B()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_FEE_EX_B));
     end;
     return Money(FileDeal(O04_FEE_EX_B));
  END;

  MACRO Get04_FEE_CC_B()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_FEE_CC_B));
     end;
     return Money(FileDeal(O04_FEE_CC_B));
  END;

  MACRO Get04_FEE_NS_B()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_FEE_NS_B));
     end;
     return Money(FileDeal(O04_FEE_NS_B));
  END;

  MACRO Get04_VAR_MARG_B()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_VAR_MARG_B));
     end;
     return Money(FileDeal(O04_VAR_MARG_B));
  END;

  MACRO Get04_FEE_EX_S()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_FEE_EX_S));
     end;
     return Money(FileDeal(O04_FEE_EX_S));
  END;

  MACRO Get04_FEE_CC_S()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_FEE_CC_S));
     end;
     return Money(FileDeal(O04_FEE_CC_S));
  END;

  MACRO Get04_FEE_NS_S()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_FEE_NS_S));
     end;
     return Money(FileDeal(O04_FEE_NS_S));
  END;

  MACRO Get04_VAR_MARG_S()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FileDeal(F04_VAR_MARG_S));
     end;
     return Money(FileDeal(O04_VAR_MARG_S));
  END;

  MACRO GetPOS_MARG()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return (Money(FilePos(FPOS_VAR_MARG_P)) + Money(FilePos(FPOS_VAR_MARG_D)));
     end;
     return (Money(FilePos(OPOS_VAR_MARG_P)) + Money(FilePos(OPOS_VAR_MARG_D)));
  END;

  MACRO GetPOS_MARGDAY()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FilePos(FPOS_VAR_MARG_P));
     end;
     return Money(FilePos(OPOS_VAR_MARG_P));
  END;

  MACRO GetPOS_MARGDEALS()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FilePos(FPOS_VAR_MARG_D));
     end;
     return Money(FilePos(OPOS_VAR_MARG_D));
  END;

  MACRO GetPOS_GO()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Money(FilePos(FPOS_GO_BRUTTO));
     end;
     return Money(FilePos(OPOS_GO));
  END;

  MACRO GetPREM()
     if( this.Get04_KOD_BUY() != "" )
        return Money(FileDeal(O04_PREM_BUY));
     end;
     return Money(FileDeal(O04_PREM_SELL));
  END;
                                                                                                                                                                
  macro Generate_UniqDealCode()                                                                                                                 
     var day, mon, year, vDate;                                                                                      
     m_UniqDealCode = "";                                                                                                                                             
                                                                                                                                                                
     if( m_IsDealExec == true )                                                                                                                             
        vDate = Get04_DATE();                                                                                       
        DateSplit( vDate, day, mon, year );                                                                                                                  
        m_UniqDealCode = string( day:2:o ) + string( mon:2:o ) + string( year:4:o );
                                      
        if( m_DVKind == DERIVATIVE_FUTURES )
           m_UniqDealCode = m_UniqDealCode + "3";                                         
        else
           m_UniqDealCode = m_UniqDealCode + "4";                                         
        end;
                                                                                            
        m_UniqDealCode = m_UniqDealCode + Get04_ID_DEAL();

        m_ExtDealCode = Get04_ID_DEAL();
        if( m_ExtDealCode == "0" )
          m_ExtDealCode = "";
        end;
        if( m_ExtDealCode == "" )
          m_UniqExtDealCode = m_UniqDealCode;
        else                                                                                                                                                       
           m_UniqExtDealCode = m_ExtDealCode;
        end;
     else
        vDate = Get04_DATE();                                                                                      
        DateSplit( vDate, day, mon, year );                                                                                                                  
        m_UniqDealCode = iif((Get04_NO_B() == "")or(Get04_NO_B() == "0"),"S/","B/") + string( day:2:o ) + string( mon:2:o ) + string( year:4:o ) + "0" + Get04_ID_DEAL();
                                                                                                                                                    
        /*получаем внешний код сделки*/ 
        m_ExtDealCode = Get04_ID_DEAL();
        if( m_ExtDealCode == "0" )
          m_ExtDealCode = "";
        end;
        if( m_ExtDealCode == "" )
           m_UniqExtDealCode = m_UniqDealCode;
        else
           m_UniqExtDealCode = iif((Get04_NO_B() == "")or(Get04_NO_B() == "0"),"S/","B/")+m_ExtDealCode;
        end;
     end;                                                                                                                                                       
                                                                                                                                                                
     return true;                                                                                                                                               
  end;                                                                                                                                                          

  macro Generate_UniqSecondDealCode()                                                                                                                 
     var day, mon, year, vDate;                                                                                      
     m_UniqDealCode = "";                                                                                                                                             
                                                                                                                                                                
     vDate = Get04_DATE();                                                                                      
     DateSplit( vDate, day, mon, year );                                                                                                                  
     m_UniqDealCode = "S/" + string( day:2:o ) + string( mon:2:o ) + string( year:4:o ) + "0" + Get04_ID_DEAL();
                                                                                                                                                   
     /*получаем внешний код сделки*/ 
     m_ExtDealCode = Get04_ID_DEAL();
     if( m_ExtDealCode == "0" )
       m_ExtDealCode = "";
     end;
     if( m_ExtDealCode == "" )
        m_UniqExtDealCode = m_UniqDealCode;
     else
        m_UniqExtDealCode = "S/" + m_ExtDealCode;
     end;                                                                                                                                                      
                                                                                                                                                                
     return true;                                                                                                                                               
  end;                                                                                                                                                           

  MACRO GetExtDealCode()
     return m_ExtDealCode;
  END;

  MACRO GetUniqExtDealCode()
     return m_UniqExtDealCode;
  END;
                                                                                                                                                                
  macro Generate_UniqPosCode()                                                                                                                  
     var day, mon, year, vDate = GetPOS_DATE();                                                                                            
                                                                                                                                                                
     m_UniqDealCode = "";                                                                                                                                             
                                                                                                                                                                
     DateSplit( vDate, day, mon, year );                                                                                                                        
                                                                                                                                                                
     m_UniqDealCode = GetPOS_ISIN() + "/" +                                                                                                                
                      string({OperDprt}) + "/" +                                                                                                                      
                      string(-1) + "/" +                                                                                                                      
                      GetPOS_KOD() + "/" +                                                                                                                 
                      string(day:2:o) +                                                                                                                               
                      string(mon:2:o) +                                                                                                                               
                      string(year:4:o);                                                                                                                               
     return true;                                                                                                                                               
  end;

  MACRO GetRepCodePfi
    return string(Get07_CONTRACT()) + string(m_ImpDate);  
  END;
  
  MACRO Get04_ID_MULT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return string(FileDeal(F04_ID_MULT));
     end;
  END;
  
  //TEG 12.05.19 функции для получения кода трейдера 
   MACRO Get04_COMM_BUY()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileDeal(F04_COMM_BUY));
     end;
     return Trim(FileDeal(O04_COMM_BUY));
  END;
  MACRO Get04_COMM_SELL()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileDeal(F04_COMM_SELL));
     end;
     return Trim(FileDeal(O04_COMM_SELL));
  END;
  MACRO GetTraderInfo()
     return IIF(Get04_COMM_SELL()!="",Get04_COMM_SELL(),Get04_COMM_BUY());
  END;
 //TEG 12.05.19 функция для возвращает 1 если операция является экспирацией опциона
  MACRO isDealExpire()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return 0;
     end;
      return IIF(Get04_TYPE() == 4 , 1, 0);
  END;
  MACRO GetORD_N()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return string(FileReq(FORD_N));
     end;
     return string(FileReq(OORD_N));
  END;

  MACRO GetORD_ISIN()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileReq(FORD_ISIN));
     end;
     return Trim(FileReq(OORD_ISIN));
  END;

  MACRO GetORD_AMOUNT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return double(FileReq(FORD_AMOUNT));
     end;
     return double(FileReq(OORD_AMOUNT));
  END;

  MACRO GetORD_ID_DEAL()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return string(FileReq(FORD_ID_DEAL));
     end;
     return string(FileReq(OORD_ID_DEAL));
  END;

  MACRO GetORD_PRICE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return money(FileReq(FORD_PRICE));
     end;
     return money(FileReq(OORD_PRICE));
  END;

  MACRO GetORD_MOMENT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return string(FileReq(FORD_MOMENT));
     end;
     return string(FileReq(OORD_MOMENT));
  END;

  MACRO GetORD_DIR()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return int(FileReq(FORD_DIR));
     end;
     return int(FileReq(OORD_DIR));
  END;

  MACRO GetORD_CLIENT_CODE()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileReq(FORD_CLIENT_CODE));
     end;
     return Trim(FileReq(OORD_CLIENT_CODE));
  END;

  MACRO GetORD_COMMENT()
     if( m_DVKind == DERIVATIVE_FUTURES )
        return Trim(FileReq(FORD_COMMENT));
     end;
     return Trim(FileReq(OORD_COMMENT));
  END;

  macro Generate_UniqReqCode()                                                                                                                 
     var day, mon, year, vDate;                                                                                      
     m_UniqReqCode = "";                                                                                                                                             
                                                                                                                                                                
     vDate = GetORD_MOMENT();                                                                                      
     year = substr(vDate,1,4);
     mon  = substr(vDate,6,2);  
     day  = substr(vDate,9,2);                                                                                                                    
     m_UniqReqCode = string( day:2:o ) + string( mon:2:o ) + string( year:4:o ) + "0" + GetORD_ID_DEAL();                                                                                                                                                    
                                                                                                                                                                
     return true;                                                                                                                                               
  end;

  MACRO GetORD_Date()
     return GetCorrectDate(DataFile.GetORD_MOMENT());  
  END;

  MACRO GetORD_Time()
     var v_Time = string(GetORD_MOMENT());
     var hh = substr(v_Time,12,8);
     var mm = substr(v_Time,15,2);  
     var ss = substr(v_Time,18,2); 
     return Time(hh,mm,ss);
  END;
                                                                                                                                                   
  MACRO GetUniqReqCode()
     return m_UniqReqCode;
  END;

  MACRO GetReqOperKind()
     if( this.GetORD_DIR() == 1 )
        if( m_DVKind == DERIVATIVE_FUTURES )
           return Int(ПокупкаФьючерсов);
        else
           return Int(ПокупкаОпционов);
        end;
     else
        if( m_DVKind == DERIVATIVE_FUTURES )
           return Int(ПродажаФьючерсов);
        else
           return Int(ПродажаОпционов);
        end;
     end;    
  END;

  macro IsReqInclude()
     var vDealID = GetORD_ID_DEAL();                                                                                                                                                                                                                                                    
     var vComment = StrLwr(GetRefNote(GetORD_COMMENT()));
     return (vDealID != "0") and (Index(vComment, "mc") == 0);                               
  end;   

END;

PRIVATE CLASS CDataFileMon( ImpDate:DATE ) 

  var Legs:TArray = TArray();
  PRIVATE var m_ImpDate = ImpDate; 

  var DataDir = "";
  var FileMonName  = "";

  var ExistFileMon  = false;
   
  PRIVATE MACRO OpenError( p_File:STRING )
     var Msg = "Ошибка открытия файла данных " + string(p_File);
     RGLog.Error( Msg );
  END;

  PRIVATE MACRO CloseError( p_File:STRING )
     var Msg = "Ошибка закрытия файла данных " + string(p_File);
     RGLog.Error( Msg );
  END;

  MACRO OpenData(i:integer)
     var List;
     if(valtype(i) == V_UNDEF)
        i = 0;
     end;

     var ErrStr = "";
     close(FileMon);
     FileMonName = "mon????.csv";
   
     // teg 21.05.19 пока читаем реестр так
     // DataDir = GetRegImportDir("FORTSMICEX", @ErrStr);
     var RegDir = "РСХБ\\ДИРЕКТОРИИ\\FORTSMICEX";
     GetRegistryValue(RegDir, V_STRING, DataDir, @ErrStr);

   
     if( (ErrStr != "") or (ErrStr == null) )
        RGLog.Message( ErrStr );
        ErrStr = "";
     end;
   
     DataDir = DataDir +"\\"+ FileDate(m_ImpDate, ".") + "\\"; 
    
     List = TDirList(DataDir + FileMonName, "f");
     
     List.Sort(0);

     if( List.Count == 0 )
        ExistNextMonFile = false;
        if(i == 0)
           //RGLog.Error( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FileMonName);
           RGLog.Message( "Ошибка открытия файла данных. Не найден файл по маске " + DataDir + FileMonName);
        end;
     else
        ExistNextMonFile = IIF(i + 1 < List.Count, true, false); 
        FileMonName = List.name(i);
        if( open( FileMon, DataDir + FileMonName ) == false )
           OpenError( string(DataDir + FileMonName) ); 
           ExistFileMon = false;
        else
           RGLog.Message( "ОТКРЫТИЕ ФАЙЛА: " + string(DataDir + FileMonName) );
           ExistFileMon = true;
        end;
     end;

     return true;
  END;

  MACRO GetUniqMonCode
    return string( this.GetKOD() ) + string(m_ImpDate);  
  END;                                                                                                                                                          

  MACRO CloseData()
     if( this.IsRunFileMon() and (close( FileMon ) == false) )
        CloseError( DataDir, FileMonName); 
     end;
     return true;
  END;  

  MACRO IsRunFileMon()
     return ExistFileMon;
  END;  

  MACRO GetDATE()
     return GetCorrectDate(FileMon(MON_DATE));
  END;

  MACRO GetKOD()
     return Trim(FileMon(MON_KOD));
  END;

  MACRO GetACCOUNT()
     return Trim(FileMon(MON_ACCOUNT));
  END;

  MACRO GetTYPE()
     return Trim(FileMon(MON_TYPE));
  END;
                              
  MACRO GetGO()
     return Double(FileMon(MON_GO));
  END;

END;

//FileCom - должен быть объявлен за пределами класса
class CommissCsvReader()
  private const PAY_DATE       = 0, 
                PAY_KOD        = 1, 
                PAY_ACCOUNT    = 2, 
                PAY_TYPE       = 3, 
                PAY_ID_PAY     = 4, 
                PAY_TYPE_PAY   = 5, 
                PAY_PAY        = 6, 
                PAY_NAME       = 7, 
                PAY_COMMENT    = 8, 
                PAY_DU         = 9, 
                PAY_PAYER      = 10,
                PAY_INN        = 11,
                PAY_BIK        = 12,
                PAY_PURPOSE    = 13;

  macro GetImportType(payType:integer, typeObj:@integer, typeRQ:@integer):bool
    var q = "select t_kindobj ko, t_kindrq rq from ddl_importoper_dbt where t_number = ? ";
    var cmd = DL_RSDCommand(q);
    cmd.AddParam(payType);
    var rs = cmd.execute();
    if (rs.MoveNext())
      if (rs.ko < 0)
        return false;
      end;
      typeObj = rs.ko;
      typeRQ = rs.rq;
      return true;
    end;
    return false;
  end;

  macro Read(fileName:string, processingDate:date):TArray
    var commissList = TArray();
    var processedRows:integer = 0;
    var df:DateFormatter = DateFormatter();

    if (not Open(FileCom, fileName))
      RGLog.Error("Ошибка открытия файла данных " + fileName);
      return commissList;
    end;
    SetDelim(";");

    RGLog.Message("Обработка файла: " + fileName);

    Next(FileCom); //пропустить первую строку с названиями колонок

    if (GetDialogFlag())
      InitProgress(-1, "Загрузка внешнего файла комиссий, сборов", "ОБРАБОТКА ВХОДНОГО ФАЙЛА");
    end;

    while (Next(FileCom))
      var commiss = RgCommissDataStruct();
      var account = Trim(FileCom(PAY_ACCOUNT));
      var du = int(FileCom(PAY_DU));
      var type = Trim(FileCom(PAY_TYPE));

      commiss.pay_date   = GetCorrectDate(FileCom(PAY_DATE)); //зависимость от макро-функции в файле
      commiss.type_pay   = int(FileCom(PAY_TYPE_PAY));
      commiss.pay_value  = Double(FileCom(PAY_PAY));
      commiss.kod        = Trim(FileCom(PAY_KOD));
      commiss.purpose    = tooem(Trim(FileCom(PAY_PURPOSE)),true);
      commiss.uniqueCode = df.Get(commiss.pay_date, "ddmmyyyy") + string(FileCom(PAY_ID_PAY));

      if ( (account == CSV_ACCOUNT_OUR_BANK) and //зависимость от константы в файле
           (du == 0) and
           (type == "MN") and
           (commiss.pay_date == processingDate) and
           (commiss.pay_value != 0) and
           GetImportType(commiss.type_pay, @commiss.typeObj, @commiss.typeRQ)
         )

        commissList(commissList.Size()) = commiss;
        processedRows = processedRows + 1;
        if (GetDialogFlag())
          UseProgress(processedRows);
        end;
      end;
    end;

    close(FileCom);

    if (GetDialogFlag()) 
      RemProgress(); 
    end;

    return commissList;

  OnError(RslErrObj)
    close(FileCom);

    if (GetDialogFlag()) 
      RemProgress(); 
    end;

    MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
    RunError;
    //return TArray();
  end;
end;

class GtCsvCommissImporter()

  macro Run (startDate:date, endDate:date)
    var processingDate:date = startDate; //текущая обрабатываемая дата
    var processedDates:integer = 0; //количество уже обработанных дат

    //report
    var noPrint:bool = false;
    var cntCommissAll:integer = 0;
    var cntCommissSuccess:integer = 0;

    //за одну обработку можем обработать несколько файлов.
    //Чтобы в лог повторно не выводить уже обработанные записи из предыдущих файлов, запоминается recordId последней и выводится всё, что > recordid
    var recordIDCom:integer = null;
    var recordIDTransf:integer = null;

    //files
    var pathRegVal = "РСХБ\\ДИРЕКТОРИИ\\FORTSMICEX";
    var fileMask = "pay????.csv";
    var fs = FileScanner();
    var csvReader = CommissCsvReader();

    var importHelper = RgPayImportHelper(SeanceID, SRC_CODE, RGLog);
    
    var directory = RegvalReader.GetString(pathRegVal, "");
    if(directory == "")
      RGLog.Message("Не найдено значение настройки " + pathRegVal);
    end;
    
    RGLog.Message( "---------- Загрузка данных по комиссиям, сборам ----------" );

    if( GetDialogFlag() )
      InitProgress((endDate - startDate + 1), "Загрузка файлов за период дат", "Просмотр дат...");
    end;

    //отдельно обрабатывается каждая дата
    while (processingDate <= endDate)
      RGLog.Message("Загрузка комиссий, сборов за дату " + string(processingDate));

      //получить список файлов для работы
      var fileDir = directory + "\\" + DateFormatter().Get(processingDate, "dd.mm.yy") + "\\";
      var files = fs.FindCsvFiles((fileDir + fileMask));
      if (files.Count == 0)
        RGLog.Message( "Ошибка открытия файла данных. Не найден файл по маске " + fileDir + fileMask);
      end;

      //обработать каждый файл, получая массив со структурой RgCommissDataStruct
      for (var i, 0, files.count - 1, 1)
        importHelper.ClearBuffer();
        var dataRecordList = csvReader.Read(fileDir + files.name(i), processingDate); //TArray<RgCommissDataStruct>
        cntCommissAll = cntCommissAll + dataRecordList.Size();

        //сохранить данные из файла в буфер        
        for (var j, 0, dataRecordList.Size() - 1, 1)
          importHelper.SaveToBuf(dataRecordList(j));
        end;
        importHelper.ProcessBuffer(); //сохранить данные из буфера в виде ЗР

        //Получить и вывести лог
        var cntSuccessImport = 0;
        RGLog.GetAndAddReceiveLoadRecsMass(RG_DEFCOMM, "Комиссия с кодом \"", "\" уcпешно загружена в шлюз", @cntSuccessImport, noPrint, @recordIDCom);
        RGLog.GetAndAddReceiveStorPrLog(RG_DEFCOMM);
        cntCommissSuccess = cntCommissSuccess + cntSuccessImport;
        cntSuccessImport = 0;

        RGLog.GetAndAddReceiveLoadRecsMass(RG_MONEYMOTION, "Перевод с кодом \"", "\" уcпешно загружен в шлюз", @cntSuccessImport, noPrint, @recordIDTransf);
        RGLog.GetAndAddReceiveStorPrLog(RG_MONEYMOTION);
        cntCommissSuccess = cntCommissSuccess + cntSuccessImport;
      end;

      processingDate = processingDate + 1;
      processedDates = processedDates + 1;
      if( GetDialogFlag() )
        UseProgress(processedDates);
      end;
    end;

    if (cntCommissAll > 0)
      var resultStr:string = "Объект \"Удержанная комиссия\": \n "
              + "  всего - " + string(cntCommissAll )
              + ", успешно - " + string(cntCommissSuccess)
              + ", ошибочно - " + string(cntCommissAll - cntCommissSuccess) + "\n";
      RGLog.Message(resultStr);
    end;

    if( GetDialogFlag() )
      RemProgress(); 
    end;
  OnError( ErObj )
    if( GetDialogFlag() )
      RemProgress(); 
    end;
    RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
  end;
end;

private macro CheckPanel( Pan ):bool

  if( Pan.imp_date == date(0,0,0) )
     MsgBox("Не задана дата импорта");
     return false;
  end;

  if( Pan.beg_date == date(0,0,0) )
     MsgBox("Не задана дата начала периода");
     return false;
  end;

  if( Pan.end_date == date(0,0,0) )
     MsgBox("Не задана дата окончания периода");
     return false;
  end;

  if( Pan.end_date < Pan.beg_date )
     MsgBox("Дата окончания периода не может быть меньше даты начала периода");
     return false;
  end;

  if( Pan.imp_date < Pan.end_date )
     MsgBox("Дата окончания периода не может быть больше даты импорта");
     return false;
  end;

  if( (Pan.order_num == "") and ((Pan.file_pos == SET_CHAR) or (Pan.file_deals == SET_CHAR) or (Pan.file_itog == SET_CHAR)) )
     MsgBox("Не задан номер отчета биржи");
     return false;
  end;

  if( (Pan.futures == "") and (Pan.option == "") and (Pan.file_coms != SET_CHAR) and (Pan.file_mon != SET_CHAR) )
     MsgBox("Не выбран ни один из видов операций");
     return false;
  end;

  if( (Pan.file_pos == UNSET_CHAR) and (Pan.file_deals == UNSET_CHAR) and (Pan.file_itog == UNSET_CHAR) and (Pan.file_request == UNSET_CHAR) and (Pan.file_coms == UNSET_CHAR)  and (Pan.file_mon == UNSET_CHAR) )
     MsgBox("Не выбран ни один из видов загрузочных файлов");
     return false;
  end;

  if( (Pan.file_coms == SET_CHAR) and (Pan.com_code == "") )
     MsgBox("Не выбран код разовой комиссии, которая будет использоваться при загрузке данных о комиссиях и сборах");
     return false;
  end;

  return true;
end;

/* Объект для добавления отчетов по операции расчетов */
PRIVATE CLASS (RGDV_Base) RGDVCALCREP( _DVKind:INTEGER, _RgPartyObject:STRING, _PartyIsMarket:BOOL, _ImpDate:DATE, _ReportNumber:STRING )

  InitRGDV_Base( RGLog, RG_KINDOBJ_DVCALCREP, "Отчет по операции расчетов №", SeanceID, _RgPartyObject, _PartyIsMarket, _ImpDate, _ReportNumber, SRC_CODE );

  MACRO GenerateObjectCode()
     return string(ReportNumber);
  END;

  MACRO InsertToGate_trn()

    RGLog.Message( "Загрузка отчета по операции расчетов для ПИ за дату " + String(ImpDate) + "..." );

    InsertToGate_trn(); /*Из базового класса*/

    InsertParm_trn( "RGDVREP_DOCDATE",    V_DATE,    ImpDate);/*по этой дате потом будем искать операцию расчетов*/
    InsertParm_trn( "RGDVREP_DATE",       V_DATE,    pp.imp_date);/*это дата отчета - пока одна на все операции*/
    InsertParm_trn( "RGDVREP_TIME",       V_TIME,    Time());
    InsertParm_trn( "RGDVREP_DEPARTMENT", V_INTEGER, {OperDprt});
    InsertParm_trn( "RGDVREP_DOCPARTY",   V_STRING,  MICEX_CODE);
    InsertParm_trn( "RGDVREP_DOCNUM",     V_STRING,  ReportNumber);
    InsertParm_trn( "RGDVREP_DOCKIND",    V_INTEGER, DOCKIND_DV_MARKETREPORT);

    return true;
  END;

  MACRO InsertToGate( _DataFile:CDataFile )

     var i:integer = 0;
     var j:integer = 0;
     var stat:bool = true;

     PRIVATE MACRO RunImpRGDVCALCREP()

        BeginInsertToGate();

        if( RGObjectCode != NULL )
           stat = InsertToGate( NULL );
        end;

        return stat;

     OnError(ErObj)
        if(ErObj.Code == CtrlBrkErr)
          FlagCtrlBrk = true;
        end;
        return ErObj.Code;
     END;

     stat = RunImpRGDVCALCREP();

     if( FlagCtrlBrk == true )
        break;
     end;

     return stat;
  END;

END;

private macro PutMarketReport()
   if( (string(pp.order_num) == "") OR (WriteMarketReport(SeanceID, NULL, SRC_CODE, @MarketReportID, @ErrMes, null, pp.order_num, pp.imp_date/*дата отчета пока = дате импорта*/, MICEX_CODE) == false) )
      AbortTrn;
   end; 
end;

private macro GetCalcOperCode(pDate:Date,pClient:string)
   return RG_GetCalcOperCode(pDate,pClient,MICEX_CODE,RG.GetSourceID());
end;

macro SaveRequest()
   var FI_Code_2   = "";
   var IDMult      = "";
   var Price_2     = 0.0;
   var Price_RUR_2 = 0.0;
   var DealDate_2  = date(0,0,0);
   var CODE_SELL;
   var CODE_BUY;

   if ((DataFile.Get04_TYPE() == 14) or (DataFile.Get04_TYPE() == 15))
      var En = DataFile.Legs.createEnum;
      WHILE (En.next)
        if ((DataFile.Get04_TYPE()     != En.Item.LegType     ) and 
            (DataFile.Get04_ID_MULT()  == En.Item.LegId_Mult  ) and 
            (DataFile.Get04_KOD_BUY()  == En.Item.LegCODE_SELL) and 
            (DataFile.Get04_KOD_SELL() == En.Item.LegCODE_BUY ) )
             FI_Code_2   = En.Item.LegISIN;    
             IDMult      = DataFile.Get04_ID_MULT();
             Price_2     = En.Item.LegPrice;    
             Price_RUR_2 = En.Item.LegPrice_RUR;       
             DealDate_2  = En.Item.LegDate;
        end;
      END;
   end;

   DataFile.Reqs[DataFile.Reqs.Size] = 
     req(DataFile.GetOperKind(),
         DataFile.GetISIN(), 
         DataFile.Get04_NO(), 
         DataFile.GetDealDate(),
         DataFile.GetDealTime(),
         DataFile.Get04_TYPE(),
         DataFile.GetKOD(), FI_Code_2, 
         DataFile.GetPrice(), 
         DataFile.GetPrice_RUR(), 
         DealDate_2, 
         DataFile.Get04_ID_DEAL(), IDMult,
         Price_2,
         Price_RUR_2,
         DataFile.Get04_VOL(),
         DataFile.GetTraderInfo());

    return true;
end;

macro SaveSecondRequest()
   var FI_Code_2   = "";
   var IDMult      = "";
   var Price_2     = 0.0;
   var Price_RUR_2 = 0.0;
   var DealDate_2  = date(0,0,0);
   var CODE_SELL;
   var CODE_BUY;

   if ((DataFile.Get04_TYPE() == 14) or (DataFile.Get04_TYPE() == 15))
      var En = DataFile.Legs.createEnum;
      WHILE (En.next)
        if ((DataFile.Get04_TYPE()     != En.Item.LegType     ) and 
            (DataFile.Get04_ID_MULT()  == En.Item.LegId_Mult  ) and 
            (DataFile.Get04_KOD_BUY()  == En.Item.LegCODE_SELL) and 
            (DataFile.Get04_KOD_SELL() == En.Item.LegCODE_BUY ) )
             FI_Code_2   = En.Item.LegISIN;    
             IDMult      = DataFile.Get04_ID_MULT();
             Price_2     = En.Item.LegPrice;    
             Price_RUR_2 = En.Item.LegPrice_RUR;       
             DealDate_2  = En.Item.LegDate;
        end;
      END;
   end;

   DataFile.Reqs[DataFile.Reqs.Size] = 
     req(DataFile.GetSecondOperKind(),
         DataFile.GetISIN(), 
         DataFile.Get04_NO_S(), 
         DataFile.GetDealDate(),
         DataFile.GetDealTime(),
         DataFile.Get04_TYPE(),
         DataFile.Get04_KOD_SELL(), FI_Code_2, 
         DataFile.GetPrice(), 
         DataFile.GetPrice_RUR(), 
         DealDate_2, 
         DataFile.Get04_ID_DEAL(), IDMult,
         Price_2,
         Price_RUR_2,
         DataFile.Get04_VOL() );

    return true;
end;

macro PutDealInfo()
   var FldVal = 0, stat;
   var OperKind, Client;
   var DealDate = date(0,0,0);
   var DateCLR  = date(0,0,0);
   var fin        = TRecHandler("fininstr.dbt");
   var fideriv    = TBFile("fideriv.dbt");
   var ParmType:integer = 0;
   var fin_2       = TRecHandler("fininstr.dbt");
   var fideriv_2   = TBFile("fideriv.dbt");
   var findRequest = false;

   VAR FlagAbortTRN = false;
   MACRO Exit()
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord(ВставкаЧерезКеш, 
                  SeanceID, 
                  NULL,
                  RG_KINDOBJ_DVDL, 
                  String("Биржевая операция с ПИ № " + DataFile.GetUniqExtDealCode()),
                  Создать );

   if(NOT RG.InitByCode(RG_KINDOBJ_DVDL, DataFile.GetUniqExtDealCode(), SRC_CODE) )
      Exit();
   end;

   Client       = DataFile.GetKOD();
   DealDate     = DataFile.GetDealDate();
   DateCLR      = DataFile.Get04_DATE_CLR();

   RG.SetParmByName( "RGDVDL_CLIENT",          Client );
   RG.SetParmByName( "RGDVDL_CALCKIND",        Int(РасчетыПоПИ));
   //teg для определения дня биржи используем клиринговый день
   RG.SetParmByName( "RGDVDL_CALCCODE",        GetCalcOperCode(/*DealDate*/DataFile.Get04_DATE_CLR(),Client) );/*если в системе не будет операции расчетов, то нам будет выдано предупреждение и будет создана операция расчетов*/
   RG.SetParmByName( "RGDVDL_KIND",            DataFile.GetOperKind());
   RG.SetParmByName( "RGDVDL_CODE",            DataFile.GetUniqDealCode() );
   RG.SetParmByName( "RGDVDL_EXTCODE",         DataFile.GetExtDealCode() );
   RG.SetParmByName( "RGDVDL_DATE",            DealDate );
   RG.SetParmByName( "RGDVDL_DATE_CLR",        DateCLR );
   RG.SetParmByName( "RGDVDL_TIME",            DataFile.GetDealTime() );
   RG.SetParmByName( "RGDVDL_HEDGE",           "");
   RG.SetParmByName( "RGDVDL_FI_CODE",         DataFile.GetISIN());
   RG.SetParmByName( "RGDVDL_AMOUNT",          DataFile.GetAmount() );
   RG.SetParmByName( "RGDVDL_POSITION",        DataFile.GetTypePosition() );
   RG.SetParmByName( "RGDVDL_MARKETREPORT_ID", MarketReportID );
   RG.SetParmByName( "RGDVDL_DEPARTMENT",      {OperDprt} );
   RG.SetParmByName( "RGDVDL_OPER",            {Oper});
   //TEG 12.05.19 добавим наши данные
   RG.SetParmByName( "RGDVDL_TRADER_INFO",     DataFile.GetTraderInfo() );
   RG.SetParmByName( "RGDVDL_IS_OPTIONEXP",    DataFile.isDealExpire() );

   /*используем сохранённые ноги спредов(если таковые были) для дополнения друг друга*/
   if ((DataFile.Get04_TYPE() == 14) or (DataFile.Get04_TYPE() == 15))
      var En = DataFile.Legs.createEnum;
      While (En.next)
        if ((DataFile.Get04_TYPE()     != En.Item.LegType     ) and 
            (DataFile.Get04_ID_MULT()  == En.Item.LegId_Mult  ) and 
            (DataFile.Get04_KOD_BUY()  == En.Item.LegCODE_SELL) and 
            (DataFile.Get04_KOD_SELL() == En.Item.LegCODE_BUY ))
             RG.SetParmByName( "RGDVDL_FI_CODE_2", En.Item.LegISIN );    
             RG.SetParmByName( "RGDVDL_IDMULT", DataFile.Get04_ID_MULT() );    
             RG.SetParmByName( "RGDVDL_PRICE_2",     En.Item.LegPrice );    
             RG.SetParmByName( "RGDVDL_PRICE_RUR_2", En.Item.LegPrice_RUR );    
             RG.SetParmByName( "RGDVDL_DATE_2",      En.Item.LegDate );
        end;
      End;
   end;

   RG.SetParmByName( "RGDVDL_MARGIN",      DataFile.GetMargin() );
   RG.SetParmByName( "RGDVDL_PRICE",       DataFile.GetPrice() );
   RG.SetParmByName( "RGDVDL_PRICE_RUR",   DataFile.GetPrice_RUR() );
   RG.SetParmByName( "RGDVDL_AMOUNT_COMM", DataFile.GetEX_Comm() );
   RG.SetParmByName( "RGDVDL_CLRCOMM",     DataFile.GetCC_Comm() );
   RG.SetParmByName( "RGDVDL_OUTCOMM",     DataFile.GetNS_Comm() );
   RG.SetParmByName( "RGDVDL_TYPE",        DataFile.Get04_TYPE());
   RG.SetParmByName( "RGDVDL_IDDEAL",      DataFile.Get04_ID_DEAL());
   RG.SetParmByName( "RGDVDL_NO",          DataFile.Get04_NO());
   RG.SetParmByName( "RGDVDL_EXTSETTLECODE", ExtSettleCode );

   if( DataFile.GetDvKind() == DERIVATIVE_OPTION  )
      RG.SetParmByName( "RGDVDL_BONUS", DataFile.GetPREM() );
   end;

   if( not RG.Save() )
      Exit();
   end;

   if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
   end;

OnError(ErObj)
   if( ErObj.Code == CtrlBrkErr )
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
      end;
   end;
end;

macro PutSecondDealInfo()
   var FldVal = 0, stat;
   var OperKind, Client;
   var DealDate = date(0,0,0);
   var DateCLR  = date(0,0,0);
   var fin        = TRecHandler("fininstr.dbt");
   var fideriv    = TBFile("fideriv.dbt");
   var ParmType:integer = 0;
   var fin_2       = TRecHandler("fininstr.dbt");
   var fideriv_2   = TBFile("fideriv.dbt");
   var findRequest = false;

   VAR FlagAbortTRN = false;
   MACRO Exit()
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord(ВставкаЧерезКеш, 
                  SeanceID, 
                  NULL,
                  RG_KINDOBJ_DVDL, 
                  String("Биржевая операция с ПИ № " + DataFile.GetUniqExtDealCode()),
                  Создать );

   if(NOT RG.InitByCode(RG_KINDOBJ_DVDL, DataFile.GetUniqExtDealCode(), SRC_CODE) )
      Exit();
   end;

   Client       = DataFile.Get04_KOD_SELL();
   DealDate     = DataFile.GetDealDate();
   DateCLR      = DataFile.Get04_DATE_CLR();

   RG.SetParmByName( "RGDVDL_CLIENT",          Client );
   RG.SetParmByName( "RGDVDL_CALCKIND",        Int(РасчетыПоПИ));
   RG.SetParmByName( "RGDVDL_CALCCODE",        GetCalcOperCode(DataFile.Get04_DATE_CLR(),Client) );/*если в системе не будет операции расчетов, то нам будет выдано предупреждение и будет создана операция расчетов*/
   RG.SetParmByName( "RGDVDL_KIND",            DataFile.GetSecondOperKind());
   RG.SetParmByName( "RGDVDL_CODE",            DataFile.GetUniqDealCode() );
   RG.SetParmByName( "RGDVDL_EXTCODE",         DataFile.GetExtDealCode() );
   RG.SetParmByName( "RGDVDL_DATE",            DealDate );
   RG.SetParmByName( "RGDVDL_DATE_CLR",        DateCLR );
   RG.SetParmByName( "RGDVDL_TIME",            DataFile.GetDealTime() );
   RG.SetParmByName( "RGDVDL_HEDGE",           "");
   RG.SetParmByName( "RGDVDL_FI_CODE",         DataFile.GetISIN());
   RG.SetParmByName( "RGDVDL_AMOUNT",          DataFile.GetAmount() );
   RG.SetParmByName( "RGDVDL_POSITION",        0 );
   RG.SetParmByName( "RGDVDL_MARKETREPORT_ID", MarketReportID );
   RG.SetParmByName( "RGDVDL_DEPARTMENT",      {OperDprt} );
   RG.SetParmByName( "RGDVDL_OPER",            {Oper});
   //TEG 12.05.19 добавим наши данные
   RG.SetParmByName( "RGDVDL_TRADER_INFO",     DataFile.Get04_COMM_SELL() );
   RG.SetParmByName( "RGDVDL_IS_OPTIONEXP",    DataFile.isDealExpire() );
   
   /*используем сохранённые ноги спредов(если таковые были) для дополнения друг друга*/
   if ((DataFile.Get04_TYPE_SELL() == 14) or (DataFile.Get04_TYPE_SELL() == 15))
      var En = DataFile.Legs.createEnum;
      While (En.next)
        if ((DataFile.Get04_TYPE_SELL() != En.Item.LegType    ) and 
            (DataFile.Get04_ID_MULT()  == En.Item.LegId_Mult  ) and 
            (DataFile.Get04_KOD_BUY()  == En.Item.LegCODE_SELL) and 
            (DataFile.Get04_KOD_SELL() == En.Item.LegCODE_BUY ) )
             RG.SetParmByName( "RGDVDL_FI_CODE_2",   En.Item.LegISIN );    
             RG.SetParmByName( "RGDVDL_IDMULT",      DataFile.Get04_ID_MULT() );    
             RG.SetParmByName( "RGDVDL_PRICE_2",     En.Item.LegPrice );    
             RG.SetParmByName( "RGDVDL_PRICE_RUR_2", En.Item.LegPrice_RUR );    
             RG.SetParmByName( "RGDVDL_DATE_2",      En.Item.LegDate );
        end;
      End;
   end;

   RG.SetParmByName( "RGDVDL_MARGIN",      DataFile.Get04_VAR_MARG_S() );
   RG.SetParmByName( "RGDVDL_PRICE",       DataFile.GetPrice() );
   RG.SetParmByName( "RGDVDL_PRICE_RUR",   DataFile.GetPrice_RUR() );
   RG.SetParmByName( "RGDVDL_AMOUNT_COMM", DataFile.Get04_FEE_EX_S() );
   RG.SetParmByName( "RGDVDL_CLRCOMM",     DataFile.Get04_FEE_CC_S() );
   RG.SetParmByName( "RGDVDL_OUTCOMM",     DataFile.Get04_FEE_NS_S() );
   RG.SetParmByName( "RGDVDL_TYPE",        DataFile.Get04_TYPE_SELL());
   RG.SetParmByName( "RGDVDL_IDDEAL",      DataFile.Get04_ID_DEAL());
   RG.SetParmByName( "RGDVDL_NO",          DataFile.Get04_NO_S());
   RG.SetParmByName( "RGDVDL_EXTSETTLECODE", ExtSettleCode );

   if( DataFile.GetDvKind() == DERIVATIVE_OPTION  )
      RG.SetParmByName( "RGDVDL_BONUS", Money(FileDeal(O04_PREM_SELL)) );
   end;

   if( not RG.Save() )
      Exit();
   end;

   if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
   end;

OnError(ErObj)
   if( ErObj.Code == CtrlBrkErr )
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
      end;
   end;
end;


macro PutReqInfo()
   var FldVal = 0, stat;
   var OperKind, Client;
   var MarketID = 0;
   var ParmType:integer = 0;
   var DealDate   = date(0,0,0);

   VAR FlagAbortTRN = false;
   MACRO Exit()
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord(ВставкаЧерезКеш, 
                  SeanceID, 
                  NULL,
                  RG_DVREQ, 
                  String("Клиентское поручение № " + DataFile.GetUniqReqCode()),
                  Создать );

   if(NOT RG.InitByCode(RG_DVREQ, DataFile.GetUniqReqCode(), SRC_CODE) )
      Exit();
   end;

   RG.SetParmByName( "RGDVRQ_OPERKIND",    DataFile.GetReqOperKind() );
   RG.SetParmByName( "RGDVRQ_FI_CODE",     DataFile.GetORD_ISIN() );
   RG.SetParmByName( "RGDVRQ_CODETS",      DataFile.GetORD_N() );
   RG.SetParmByName( "RGDVRQ_CODE",        DataFile.GetUniqReqCode() );
   RG.SetParmByName( "RGDVRQ_DATE",        DataFile.GetORD_Date() );
   RG.SetParmByName( "RGDVRQ_TIME",        DataFile.GetORD_Time() );
   RG.SetParmByName( "RGDVRQ_CLIENT",      DataFile.GetORD_CLIENT_CODE() );
   RG.SetParmByName( "RGDVRQ_IDDEAL",      DataFile.GetORD_ID_DEAL() );

   RG.SetParmByName( "RGDVRQ_PRICE",       DataFile.GetORD_PRICE() );
   RG.SetParmByName( "RGDVRQ_VOL",         DataFile.GetORD_AMOUNT() );
   RG.SetParmByName( "RGDVRQ_TRADERCODE",  GetRefNote(DataFile.GetORD_COMMENT()) );

   if( not RG.Save() )
      Exit();
   end;

   if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
   end;

OnError(ErObj)
   if( ErObj.Code == CtrlBrkErr )
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
      end;
   end;
end;

macro PutPosInfo()
   var Client, TurnDate = date(0,0,0);
   VAR FlagAbortTRN = false;
   VAR ClientID = 0, PartyObjectID = 0;
   VAR ErrStr = "";
   VAR stat = 0;

   MACRO Exit()
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      FlagAbortTRN = true;
      AbortTRN;
   END;

   TurnDate = DataFile.GetPOS_DATE();
   Client   = DataFile.GetPOS_KOD();

   if(Client != "")
      if( GetRealID(RG_PARTY, Client, -1, @ClientID, @ErrStr, true, PTSK_DV, TurnDate) != 0 )
         ErrMes = "Ошибка при загрузке позиции с ISIN \"" + DataFile.GetPos_ISIN() + "\"\n" + ErrStr;
      end;
   end;
   if (DataFile.GetPos_ISIN() == "EUR_CLT")/*PNV 518655 - непонятный техн.инструмент не загружаем*/
      Exit();
   end;

   RG = TGTRecord(ВставкаЧерезКеш, 
                      SeanceID, 
                      NULL,
                      RG_KINDOBJ_DVTRN, 
                      String("Итоги дня по позиции с ПИ № " + DataFile.GetUniqDealCode()),
                      Создать,
                      NULL,
                      NULL,
                      ClientID );

   if(NOT RG.InitByCode(RG_KINDOBJ_DVTRN, DataFile.GetUniqDealCode(), SRC_CODE) )
      Exit();
   end;

   RG.SetParmByName( "RGDVTRN_DATE",        TurnDate );       
   RG.SetParmByName( "RGDVTRN_FI_CODE",     DataFile.GetPOS_ISIN() );    
   RG.SetParmByName( "RGDVTRN_BROKER",      -1 );     
   RG.SetParmByName( "RGDVTRN_CLIENT",      Client );     
   RG.SetParmByName( "RGDVTRN_DEPARTMENT",  {OperDprt} ); 
   RG.SetParmByName( "RGDVTRN_MARGIN",      DataFile.GetPOS_MARG());     
   RG.SetParmByName( "RGDVTRN_MARGIN_DAY",  DataFile.GetPOS_MARGDAY());
   RG.SetParmByName( "RGDVTRN_MARGIN_DEALS",DataFile.GetPOS_MARGDEALS());     
   RG.SetParmByName( "RGDVTRN_CONTRCOMM",   DataFile.GetPOS_SBOR_EXEC() );
   RG.SetParmByName( "RGDVTRN_GUARANTY",    DataFile.GetPOS_GO());
   RG.SetParmByName( "RGDVTRN_CALCKIND",    Int(РасчетыПоПИ) );   
   RG.SetParmByName( "RGDVTRN_CALCCODE",    GetCalcOperCode(TurnDate,Client));   
   RG.SetParmByName( "RGDVTRN_EXTSETTLECODE", Substr(Client, 1, 4)/*ExtPosSettleCode*/ );     /*PNV 540182*/

   if( not RG.Save() )
      Exit();
   end;

   if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
   end;

OnError(ErObj)
   if( ErObj.Code == CtrlBrkErr )
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
      end;
   end;
end;

macro PutMonInfo() 
   VAR FlagAbortTRN = false;

   MACRO Exit()
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      FlagAbortTRN = true;
      AbortTRN;
   END;

   RG = TGTRecord(ВставкаЧерезКеш, 
                  SeanceID, 
                  NULL,
                  RG_MON, 
                  String("Информация по договору обслуживания клиента с кодом: " + DataFile.GetKOD() ),
                  Создать );

   if(NOT RG.InitByCode(RG_MON, DataFile.GetUniqMonCode(), SRC_CODE) )
      Exit();
   end;

   RG.SetParmByName( "RGMON_DATE",    DataFile.GetDATE() );
   RG.SetParmByName( "RGMON_KOD",     DataFile.GetKOD() );
   RG.SetParmByName( "RGMON_ACCOUNT", DataFile.GetACCOUNT() );
   RG.SetParmByName( "RGMON_TYPE",    DataFile.GetTYPE() );
   RG.SetParmByName( "RGMON_GO",      DataFile.GetGO() );   

   if( not RG.Save() )
      Exit();
   end;

   if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
   end;

OnError(ErObj)
   if( ErObj.Code == CtrlBrkErr )
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
      end;
   end;
end;

macro PutPFIInfo()
   VAR FlagAbortTRN = false;
   VAR DvKind, FiCode, CodeName, BaseFiCode, Amount;
   VAR StartDate, EndDate, TermDate;
   VAR TypeExecute, TickPrice, Accuracy, IS_PERCENT, MinTickPrice;
   VAR Rate:double = 0, RateMin:double = 0., RateMax:double = 0., RateMinCost:double = 0., CloseRate:double = 0;
   VAR Put, Evrop, Strike, IsMarginOp;
   MACRO Exit()
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      FlagAbortTRN = true;
      AbortTRN;
   END;

   ErrMes = "";
   //пояснение к двум следующим командам
   //Дело в том, что в константах RG_FUTURES = 8, RG_OPTIONS=9. Но в базе 8 - код (kind obj) ПИ, а не фьючерса или опциона
   //поэтому, в любом случае используется константа RG_FUTURES. 
   //В будущем следует проверить, используется ли ещё где то эти констаны. если нет - переименовать на... RG_PFI и удалить лишнюю.
   RG = TGTRecord(ВставкаЧерезКеш, 
                  SeanceID, 
                  NULL,
                  RG_FUTURES ,
                  String("ПИ с кодом № " + DataFile.Get07_CONTRACT()),
                  Создать );
   if(NOT RG.InitByCode(RG_FUTURES , 
                        DataFile.GetRepCodePfi(), 
                                                SRC_CODE) 
      )
      Exit();
   end;
   
   if ( (DataFile.GetDvKind() == DERIVATIVE_FUTURES) and (  DataFile.Get07_MULTILEG() == 1))
      AbortTRN;
   end;
   ///////////////////////////////////////////
   //     загрузка параметров в память      //
   ///////////////////////////////////////////
   /////   общие параметры для всех ПИ    ////
   ///////////////////////////////////////////
   DvKind      = DataFile.GetDvKind();
   FiCode      = DataFile.Get07_CONTRACT();
   CodeName    = DataFile.Get07_NAME();
   BaseFiCode  = DataFile.Get07_BASE_FUT();
   Amount      = DataFile.Get07_LOT_VOLUME();
   StartDate   = DataFile.Get07_DATE();
   EndDate     = DataFile.Get07_EXECUTION();
   TermDate    = DataFile.Get07_L_TRADEDAY();
   TypeExecute = DataFile.Get07_TYPE_EXEC();
   
   TickPrice = DataFile.Get07_TICK();
   RateMin = DataFile.Get07_LOW();
   RateMax = DataFile.Get07_HIGH();
   MinTickPrice = DataFile.Get07_TICK_PRICE();
   RateMinCost = DataFile.Get07_TICK_PRICE();
   CloseRate = DataFile.Get07_CLOSE();
   //////////////////////////////////////////////////
   /////   Параметры для Фьючерсных контрактов   ////
   //////////////////////////////////////////////////
   if (  DvKind == DERIVATIVE_FUTURES  )
     IS_PERCENT = DataFile.Get07_IS_PERCENT();   
     Rate = DataFile.Get07_SETTL();
   //////////////////////////////////////////////////
   /////   Параметры для Фьючерсных контрактов   ////
   //////////////////////////////////////////////////
   elif (  DvKind == DERIVATIVE_OPTION  )
     Put   = IIF ( DataFile.Get07_PUT()   == "C", 2, 1);//TEG тут было перепутано
     Evrop = IIF ( DataFile.Get07_EVROP() == "A", 1, 2);
     Strike= DataFile.Get07_STRIKE();
     IsMarginOp = DataFile.Get07_FUT_TYPE();
   end;
   
   ///////////////////////////////////////////
   //     загрузка параметров в шлюз        //
   ///////////////////////////////////////////
   /////   общие параметры для всех ПИ    ////
   ///////////////////////////////////////////   
   RG.SetParmByName( "RGDVPFI_AVOIRKIND"  ,       DvKind );   
   RG.SetParmByName( "RGDVPFI_CONTRACT"  ,        FiCode );   
   RG.SetParmByName( "RGDVPFI_NAME"      ,        CodeName ); 
   RG.SetParmByName( "RGDVPFI_DATE"      ,        StartDate ); 
   RG.SetParmByName( "RGDVPFI_EXECUTION" ,        EndDate );    
   RG.SetParmByName( "RGDVPFI_TICK"      ,        TickPrice );   
   RG.SetParmByName( "RGDVPFI_TICK_PRICE",        MinTickPrice );    
   //////////////////////////////////////////////////
   ////    Параметры для Фьючерсных контрактов   ////
   //////////////////////////////////////////////////
   if   (  DvKind == DERIVATIVE_FUTURES )
     RG.SetParmByName( "RGDVPFI_BASE_FUT"  ,        BaseFiCode ); 
     RG.SetParmByName( "RGDVPFI_LOT_VOLUME",        Amount );    
     RG.SetParmByName( "RGDVPFI_L_TRADEDAY",        TermDate );     
     RG.SetParmByName( "RGDVPFI_TYPE_EXEC" ,        TypeExecute ); 
     RG.SetParmByName( "RGDVPFI_IS_PERCENT",        IS_PERCENT );      
   //////////////////////////////////////////////////
   ////           Параметры для опционов         ////
   //////////////////////////////////////////////////   
   elif (  DvKind == DERIVATIVE_OPTION  )
     RG.SetParmByName( "RGDVPFI_FUT_CONTR",         BaseFiCode ); 
     RG.SetParmByName( "RGDVPFI_LOT_VOLUME",        1 );      
     RG.SetParmByName( "RGDVPFI_TYPE_EXEC" ,        1 ); //поставочный для опцоина     
     RG.SetParmByName( "RGDVPFI_OPTIONTYPE", Put ); //put,call
     RG.SetParmByName( "RGDVPFI_EVROP", Evrop ); //American/Europe     
     RG.SetParmByName( "RGDVPFI_STRIKE", Strike ); 
     RG.SetParmByName( "RGDVPFI_ISMARGINOP", IsMarginOp );      
   end;
   
   if( not RG.Save() )
      Exit();
   end;

   if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
   end;

OnError(ErObj)
   if( ErObj.Code == CtrlBrkErr )
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message  + "\n" + RG.GetLastError());
      end;
   end;
   
END;

private macro PutDvCalcReport()

  if(string(pp.order_num) == "")
      AbortTrn;
  end;

  var CalcRep = RGDVCALCREP( DERIVATIVE_FUTURES, MICEX_CODE, true, CurImpDate, pp.order_num );
  if( CalcRep )
     if( CalcRep.InsertToGate() == false )
        AbortTrn;
     end;
  end;

  return true;
end;

macro WriteDealData()

   DataFile.SetIsDealExec();

   ErrMes = "";
   /*получаем уникальный внутреннй код сделки*/
   if( not DataFile.Generate_UniqDealCode() )      
      RGLog.Error( ErrMes );
      return false;
   end;

   if( not IsMarketReportLoad ) /*вставляем документ-основание (пока один на все) датой импорта как по ТЗ*/
      if (ProcessTrn(0, "PutMarketReport"))
         RGLog.Message( "Успешно загружен документ-подтверждение \"Отчет биржи\"\n" + ErrMes );
      else
         RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes );
      end;
      IsMarketReportLoad = true;
      ErrMes = "";
   end;

   if( NumImportDeals == 0 ) /*за каждую дату вставим документ-основание с одним номером на все операции расчетов, но за разные даты*/
      if ( PutDvCalcReport() )
         RGLog.Message( "Успешно загружен документ-подтверждение \"Отчет биржи\"\n по операции расчетов за дату " +string(CurImpDate)+ "\n" + ErrMes );
      else
         RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n по операции расчетов за дату " +string(CurImpDate)+ "\n" + ErrMes );
      end;
      ErrMes = "";
   end;

   NumImportDeals = NumImportDeals + 1;

   if (ProcessTrn(0, "PutDealInfo") )                                          
      NumImportDealsTotal = NumImportDealsTotal + 1;
      RGLog.Message( "Биржевая операция с ПИ с кодом \"" + DataFile.GetUniqExtDealCode() + "\" уcпешно загружена в шлюз\n" + ErrMes, RG, SUCCESS );
   else
      RGLog.Error( "Ошибка при загрузке биржевой операции с ПИ с кодом \"" + DataFile.GetUniqExtDealCode() + "\"\n" + ErrMes );
      return false;
   end;

   ErrMes = "";
   if ((DataFile.Get04_KOD_BUY() != "") and (DataFile.Get04_KOD_SELL() != ""))
      if( not DataFile.Generate_UniqSecondDealCode() )      
         RGLog.Error( ErrMes );
         return false;
      end; 
      if (ProcessTrn(0, "PutSecondDealInfo") )                                          
         NumImportDealsTotal = NumImportDealsTotal + 1;
         RGLog.Message( "Биржевая операция с ПИ с кодом \"" + DataFile.GetUniqExtDealCode() + "\" уcпешно загружена в шлюз\n" + ErrMes, RG, SUCCESS );
      return true;
   else
      RGLog.Error( "Ошибка при загрузке биржевой операции с ПИ с кодом \"" + DataFile.GetUniqExtDealCode() + "\"\n" + ErrMes );
      return false;
   end;
   ErrMes = "";
   else
      return true;
   end;
OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

macro WriteReqData()

   ErrMes = "";

   /*получаем уникальный внутреннй код заявки*/
   if( not DataFile.Generate_UniqReqCode() )      
      RGLog.Error( ErrMes );
      return false;
   end;

   NumImportReq = NumImportReq + 1;

      if (ProcessTrn(0, "PutReqInfo") )                                          
NumImportReqTotal = NumImportReqTotal + 1;                                           
      RGLog.Message( "Клиентское поручение № \"" +  DataFile.GetUniqReqCode() + "\" уcпешно загружено в шлюз\n" + ErrMes, RG, SUCCESS );
      return true;
      else
        if (StrUpr(ErrMes,"ПОВТОРНАЯ РЕПЛИКАЦИЯ НЕВОЗМОЖНА")!=0) //TEG  посмотрим что в ошибке
            RGLog.Message("Ошибка при загрузке клиентского поручения № \"" + DataFile.GetUniqReqCode() + "\"\n" + ErrMes);
        else
            RGLog.Error("Ошибка при загрузке клиентского поручения № \"" + DataFile.GetUniqReqCode() + "\"\n" + ErrMes );
        end;
return false;
      end;
      ErrMes = "";

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;


macro WriteMonData()

   ErrMes = "";

   NumImportMon = NumImportMon + 1;

   if (ProcessTrn(0, "PutMonInfo") )                                          
      NumImportMonTotal = NumImportMonTotal + 1;
      RGLog.Message( "Информация о договоре обслуживания клиента с кодом \"" + DataFile.GetKOD() + "\" уcпешно загружена в шлюз\n" + ErrMes, RG, SUCCESS );
      return true;
   else
      if (StrUpr(ErrMes,"ПОВТОРНАЯ РЕПЛИКАЦИЯ НЕВОЗМОЖНА")!=0) //TEG  посмотрим что в ошибке
        RGLog.Message("Ошибка при загрузке информации о договоре обслуживания клиента с кодом \"" +  DataFile.GetKOD() + "\"\n" + ErrMes );
      else
        RGLog.Error( "Ошибка при загрузке информации о договоре обслуживания клиента с кодом \"" +  DataFile.GetKOD() + "\"\n" + ErrMes );
     end;
       return false;
   end;
   ErrMes = "";

   OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

macro WritePosData()

   ErrMes = "";

   /*получаем уникальный внутреннй код сделки*/
   if( not DataFile.Generate_UniqPosCode() )      
      RGLog.Error( ErrMes );
      return false;
   end;

   NumImportPos = NumImportPos + 1;

   if (ProcessTrn(0, "PutPosInfo") )
      NumImportPosTotal = NumImportPosTotal + 1;
      RGLog.Message( "Итоги дня по позиции с ПИ с кодом \"" + DataFile.GetUniqDealCode() + "\" уcпешно загружены в шлюз\n" + ErrMes, RG, SUCCESS );
      return true;
   else
      if (StrUpr(ErrMes,"ПОВТОРНАЯ РЕПЛИКАЦИЯ НЕВОЗМОЖНА")!=0) //TEG  посмотрим что в ошибке
        RGLog.Message( "Итоги дня по позиции с ПИ с кодом \"" + DataFile.GetUniqDealCode() + "\" уже загружены в шлюз\n"+ ErrMes, RG, SUCCESS );
      else
        RGLog.Error( "Ошибка при загрузке итогов дня по позиции с ПИ с кодом \"" + DataFile.GetUniqDealCode() + "\"\n" + ErrMes );
      end;
      return false;
   end;
   ErrMes = "";

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

/*загрузка сделок*/
macro import_deals_to_gate_from()
   var Line, Err = false, MsgTxt = "";
   var stat:integer = 0;

   /* Сохранение информации о ноге спреда, если это нога*/
   private macro SaveSpreadLeg()
      if ((DataFile.Get04_TYPE() == 14) or (DataFile.Get04_TYPE() == 15))
           DataFile.Legs[DataFile.Legs.Size] = 
           leg( DataFile.Get04_TYPE(),
                DataFile.Get04_ID_MULT(),
                DataFile.GetISIN(),
                DataFile.Get04_KOD_SELL(),
                DataFile.Get04_KOD_BUY(), 
                DataFile.GetPrice(),
                DataFile.GetPrice_RUR(),
                DataFile.Get04_DATE()
              );
      end;
      return true;
   end;
   
   private macro RunImp()
      /* Сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   END;
  
   if( DataFile.GetDvKind() == DERIVATIVE_FUTURES )
      MsgTxt = "Загрузка биржевых сделок с фьючерсами за дату "+string(CurImpDate);
   else
      MsgTxt = "Загрузка биржевых сделок с опционами за дату "+string(CurImpDate);
   end;
   RGLog.Message( MsgTxt );

   /* Считаем количество строк в файле и выводим индикатор */
   Rewind(FileDeal); 
   Line = 0; 
   SetDelim(";");
   if(Next(FileDeal))
      /*первую с названиями пропустили и идем далее (чтобы со строкой заголовков не заходить в условия IsDealInclude())*/
      while(Next(FileDeal)) 
         if( DataFile.IsDealInclude() )
            Line = Line + 1;
         end;
      end;
   end;

   if (GetDialogFlag()) 
      InitProgress(Line, "Загрузка внешнего файла сделок", "ОБРАБОТКА ВХОДНОГО ФАЙЛА"); 
   end;

   /* Шерстим файл в поисках сделок */
   Rewind(FileDeal);
   SetDelim(";");

   /*для начала, найдём все ноги спредов и запомним их. Они пригодятся при вставке своих пар в шлюз*/
   if( Next(FileDeal) )
      /*первую с названиями пропустили и идем далее*/
      while(Next(FileDeal) and (CodeFor(FileDeal.str) != 26))
         if( DataFile.IsDealInclude() )
            if( SaveSpreadLeg() )
               stat = 1;
            end;
         end;
         if( FlagCtrlBrk == true )
            break;
         end;
      end;
   end;      
   
   /* Шерстим файл в поисках сделок */
   Rewind(FileDeal);
   SetDelim(";");
   
   if( Next(FileDeal) )
      /*первую с названиями пропустили и идем далее*/
      while(Next(FileDeal) and (CodeFor(FileDeal.str) != 26))
         if( DataFile.IsDealInclude() )
            NumImportDealsAll = NumImportDealsAll + 1;
            if( RunImp() )
               stat = 1;
            end;
         end;
     
         if( FlagCtrlBrk == true )
            break;
         end;
     
         if (GetDialogFlag()) 
            UseProgress(NumImportDealsAll);
         end;
      end;

      /*if ( WriteReqData() )
         stat = 1;
      end;*/
   end;

   if (GetDialogFlag()) 
     RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/*загрузка заявок*/
macro import_req_to_gate_from()
   var Line, Err = false, MsgTxt = "";
   var stat:integer = 0;
   
   private macro RunImp()
      /* Сохранение информации о заявке в промежуточном файле */
      if(WriteReqData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   END;
  
   if( DataFile.GetDvKind() == DERIVATIVE_FUTURES )
      MsgTxt = "Загрузка заявок на биржевые сделки с фьючерсами за дату "+string(CurImpDate);
   else
      MsgTxt = "Загрузка заявок на биржевые сделки с опционами за дату "+string(CurImpDate);
   end;
   RGLog.Message( MsgTxt );

   /* Считаем количество строк в файле и выводим индикатор */
   Rewind(FileReq); 
   Line = 0; 
   SetDelim(";");
   if(Next(FileReq))
      /*первую с названиями пропустили и идем далее (чтобы со строкой заголовков не заходить в условия IsReqInclude())*/
      while(Next(FileReq)) 
         if( DataFile.IsReqInclude() )
            Line = Line + 1;
         end;
      end;
   end;

   if (GetDialogFlag()) 
      InitProgress(Line, "Загрузка внешнего файла заявок", "ОБРАБОТКА ВХОДНОГО ФАЙЛА"); 
   end;    
   
   /* Шерстим файл в поисках заявок */
   Rewind(FileReq);
   SetDelim(";");
   
   if( Next(FileReq) )
      /*первую с названиями пропустили и идем далее*/
      while(Next(FileReq) and (CodeFor(FileReq.str) != 26))
         if( DataFile.IsReqInclude() )
            NumImportReqAll = NumImportReqAll + 1;
            if( RunImp() )
         stat = 1;
      end;
   end;

         if( FlagCtrlBrk == true )
            break;
         end;
     
         if (GetDialogFlag()) 
            UseProgress(NumImportReqAll);
         end;
      end;
   end;

   if (GetDialogFlag()) 
     RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;
                   
macro import_pos_to_gate_from()
   var Line, Err = false, MsgTxt = "";
   var stat:integer = 0;

   private macro RunImp()
      /* Сохранение информации о сделке в промежуточном файле */
         if( WritePosData(false) != true )
            return 1;
         end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   END;

   if( DataFile.GetDvKind() == DERIVATIVE_FUTURES )
      MsgTxt = "Загрузка итогов дневных изменений позиций по фьючерсам и операций исполнения фьючерсов за дату "+string(CurImpDate);
   else
      MsgTxt = "Загрузка итогов дневных изменений позиций по опционам и операций исполнения опционов за дату "+string(CurImpDate);
   end;
  
   RGLog.Message( MsgTxt );

   /* Считаем количество строк в файле и выводим индикатор */
   Rewind(FilePos); 
   Line = 0; 

   if(Next(FilePos))
      /*первую с названиями пропустили и идем далее (чтобы со строкой заголовков не заходить в условия IsPosInclude())*/
      while(Next(FilePos)) 
         if( DataFile.IsPosInclude() )
            Line = Line + 1;
         end;
      end;
   end;

   if (GetDialogFlag()) 
      InitProgress(Line, "Загрузка внешнего файла позиций", "ОБРАБОТКА ВХОДНОГО ФАЙЛА"); 
   end;

   /* Шерстим файл в поисках сделок */
   Rewind(FilePos);
   SetDelim(";");

   if( Next(FilePos) )
      /*первую с названиями пропустили и идем далее*/
      while(Next(FilePos) and (CodeFor(FilePos.str) != 26))
     
         if( DataFile.IsPosInclude() )
            NumImportPosAll = NumImportPosAll + 1;
            if( RunImp() )
               stat = 1;
            end;
         end;

         if( FlagCtrlBrk == true )
            break;
         end;
     
         if (GetDialogFlag()) 
            UseProgress(NumImportPosAll);
         end;
      end;
   end;

   if (GetDialogFlag()) 
     RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/*загрузка информации о денежном обеспечении*/
macro import_mon_to_gate_from()
   var Line, Err = false, MsgTxt = "";
   var stat:integer = 0;

   private macro RunImp()
      if(WriteMonData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;

      return ErObj.Code;
   END;
  
   MsgTxt = "Загрузка информации по договорам обслуживания за дату "+string(CurImpDate);
   RGLog.Message( MsgTxt );

   /* Считаем количество строк в файле и выводим индикатор */
   Rewind(FileMon); 
   Line = 0; 
   SetDelim(";");

   if(Next(FileMon))
      /*первую с названиями пропустили и идем далее (чтобы со строкой заголовков не заходить в условия IsComInclude())*/
      while(Next(FileMon)) 
         if( (DataFile.GetACCOUNT() == "CL") and (DataFile.GetTYPE() == "MN") )
            Line = Line + 1;
         end;
      end;
   end;

   if (GetDialogFlag()) 
      InitProgress(Line, "Загрузка внешнего файла информации по договорам обслуживания", "ОБРАБОТКА ВХОДНОГО ФАЙЛА"); 
   end;

   Rewind(FileMon);
   SetDelim(";");
   
   if( Next(FileMon) )
      /*первую с названиями пропустили и идем далее*/
      while(Next(FileMon) and (CodeFor(FileMon.str) != 26))
         if( (DataFile.GetACCOUNT() == "CL") and (DataFile.GetTYPE() == "MN") )
            NumImportMonAll = NumImportMonAll + 1;
            if( RunImp() )
               stat = 1;
            end;
         end;
     
         if( FlagCtrlBrk == true )
            break;
         end;
     
         if (GetDialogFlag()) 
            UseProgress(NumImportMonAll);
         end;
      end;
   end;

   if (GetDialogFlag()) 
     RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/* Объект для добавления курсов ПИ.*/
PRIVATE CLASS (RGRate) RGDVRATE( _DVKind:INTEGER, _RgPartyObject:STRING, _PartyIsMarket:BOOL, _ImpDate:DATE )

  VAR ObjectCountTotal:integer = 0;
  VAR DVKind:integer = 0;

  VAR Num = -1;

  Rewind(FileItog); 
  while( Next(FileItog) ) 
     Num = Num + 1;
  end;

  InitRGRate( RGLog, true, _ImpDate, NULL, FICK_USERCODE, 8 /*Код_на_ММВБ_Субъект*/, SRC_CODE );

  CURR_RATE_IsRealID = true;
  DVKind = _DVKind;
  MarketOfficeStr = "";

  MACRO InsertToGate()
    var OldNumDuplItems:integer = 0,
        FI_Code:string = "", MarketPL:string = "", FI_Base:string = "", ErrMes,
        Rate:double = 0, RateG:double = 0, RateMin:double = 0., RateMax:double = 0., RateMinCost:double = 0., CloseRate:double = 0;

    var  Count = 0;

    /*Процедура обработки одной записи dbf файла*/
    PRIVATE MACRO ProcessRecord()
      
       var IsErrFI:bool = false;
       var BasisFI       = TRecHandler("fininstr.dbt");
       imp_date = DataFile.Get07_DATE();

       if( (imp_date<=pp.end_date) and (imp_date>=pp.beg_date) )
          FI_Code = DataFile.Get07_CONTRACT();       
          FI_Base = DataFile.Get07_BASE_FUT();
          RGLog.Message( "Загрузка котировок для ПИ \"" +  String(FI_Code) + "\" за дату " + String(imp_date) + "..." );

          RateMin = DataFile.Get07_LOW();
          RateMax = DataFile.Get07_HIGH();
          RateMinCost = DataFile.Get07_TICK_PRICE();
          CloseRate = DataFile.Get07_CLOSE();

          MarketPL = MICEX_CODE;

          OldNumDuplItems = this.NumDuplItems;

          if( DVKind == DERIVATIVE_FUTURES ) /*курс "расчетная цена" только для фьючерсов*/
             Rate = Double(FileItog(F07_SETTL));
             if( Rate != 0. )
                ObjectCountTotal = ObjectCountTotal + 1;
                if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(Rate, RATE_POINT), RATETYPE_CALC_PRICE, MarketPL, UNSET_CHAR, true ) != true )
                   return false;
                else 
                   if( OldNumDuplItems != this.NumDuplItems )
                      RGLog.Message( "Котировка для ПИ \""+ FI_Code +"\" за дату "+string(imp_date)+" уже загружена в шлюз." );
                   end;
                end;
             end;
          end;

          if( DVKind == DERIVATIVE_FUTURES ) // Расчетная цена для главы Г
            if ((ПолучитьФинИн( FI_Base, BasisFI, NULL, NULL, NULL, FICK_MICEX ) == 0 ) or (ПолучитьФинИн( FI_Base, BasisFI, NULL, NULL, NULL, FICK_PTCC ) == 0 ))
                if (BasisFI.rec.FI_Kind == FIKIND_ARTICLE)
                   RateG = Double(FileItog(F07_SETTL));
                else
                   RateG = Double(FileItog(F07_SETTL_RUR));
                end;
                if( RateG != 0. )
                   ObjectCountTotal = ObjectCountTotal + 1;
                   if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(RateG, RATE_POINT), RATETYPE_CALC_PRICE_G, MarketPL, UNSET_CHAR, true ) != true )
                      return false;
                   else 
                      if( OldNumDuplItems != this.NumDuplItems )
                         RGLog.Message( "Котировка для ПИ \""+ FI_Code +"\" за дату "+string(imp_date)+" уже загружена в шлюз." );
                      end;
                   end;
                end;
             else
                RGLog.Message( "Невозможно определить вид базового актива \""+ FI_Base +"\" для загрузки курса вида \"Расчетная цена для главы Г\" " );
             end;
          end;
          
          if( CloseRate != 0.)
             ObjectCountTotal = ObjectCountTotal + 1;
             if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(CloseRate, RATE_POINT), 18 /*Цена закрытия*/, MarketPL, UNSET_CHAR, true ) != true )
                return false;
             else 
                if( OldNumDuplItems != this.NumDuplItems )
                   RGLog.Message( "Котировка для ПИ \""+ FI_Code +"\" за дату "+string(imp_date)+" уже загружена в шлюз." );
                end;
             end;
          end;

          if( DVKind == DERIVATIVE_OPTION ) /*курс "Теоретическая цена" только для опционов*/
             Rate = Double(FileItog(O07_THEORPRICE));
             if( Rate != 0. )
                ObjectCountTotal = ObjectCountTotal + 1;
                if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(Rate, RATE_POINT), RATETYPE_TEORETIC_COST, MarketPL, UNSET_CHAR, true ) != true )
                   return false;
                else 
                   if( OldNumDuplItems != this.NumDuplItems )
                      RGLog.Message( "Котировка для ПИ \""+ FI_Code +"\" за дату "+string(imp_date)+" уже загружена в шлюз." );
                   end;
                end;
             end;
          end;

          if( RateMin != 0. ) 
             ObjectCountTotal = ObjectCountTotal + 1;
             if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(RateMin, RATE_POINT), RATETYPE_MIN_PRICE, MarketPL, UNSET_CHAR, true ) != true )
                return false;
             else 
                if( OldNumDuplItems != this.NumDuplItems )
                   RGLog.Message( "Котировка(min) для ПИ \""+ FI_Code +"\" за дату "+string(imp_date)+" уже загружена в шлюз." );
                end;
             end;
          end;

          if( RateMax != 0. )
             ObjectCountTotal = ObjectCountTotal + 1;
             if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(RateMax, RATE_POINT), RATETYPE_MAX_PRICE, MarketPL, UNSET_CHAR, true ) != true )
                return false;
             else 
                if( OldNumDuplItems != this.NumDuplItems )
                   RGLog.Message( "Котировка(max) для ПИ \""+ FI_Code +"\" за дату "+string(imp_date)+" уже загружена в шлюз." );
                end;
             end;
          end;

          if( RateMinCost != 0.)
             ObjectCountTotal = ObjectCountTotal + 1;
             if( ParseAndLoadValue( FI_Code, ЧислоСтрокой(RateMinCost, RATE_POINT), RATETYPE_MINSTEP_PRICE, MarketPL, UNSET_CHAR, true ) != true )
                return false;
             else 
                if( OldNumDuplItems != this.NumDuplItems )
                   RGLog.Message( "Котировка минимальной стоимости шага цены для ПИ \""+ FI_Code +"\"\nза дату "+string(imp_date)+" уже загружена в шлюз." );
                end;
             end;
          end;
          
          return true;
       end;

       return false;

    OnError(ErObj)
       if(ErObj.Code == CtrlBrkErr)
          FlagCtrlBrk = true;
          return true; 
       end;
    END;

    Rewind(FileItog);
    SetDelim(";");

    InitProgress( Num, "Загрузка курсов ПИ.", "Загрузка курсов ПИ." );

    if( Next(FileItog) )
       /*первую с названиями пропустили и идем далее*/
       while( Next( FileItog ) )
        if ( (DataFile.Get07_MULTILEG() == 0) OR (DataFile.fileitogname == "o07.csv"))       // ПИ долежн быть самостоятельным для импорта. Если она связанный, то игнорируем его вообще (на текущий момент, игнор не включает UseProgress).
           ProcessRecord();        
          if( FlagCtrlBrk == true )
             break;
          end;
        END;
          UseProgress( Count = Count + 1 );
       end;
    end;

    RemProgress();

  END;

END;

/* Класс для импорта ПИ */
PRIVATE CLASS RGDVPFI ( _DVKind:INTEGER, _RgPartyObject:STRING, _PartyIsMarket:BOOL, _ImpDate:DATE )

  VAR ObjectCountTotal:integer = 0;
  VAR DVKind:integer = 0;
  VAR NumRecords = -1;
  VAR RGDVCode;
  RGDVCode = string(DataFile.Get07_CONTRACT()) + string(_ImpDate);
  Rewind(FileItog); 
  while( Next(FileItog) ) 
     NumRecords = NumRecords + 1;
  end;
  /*1 - фьючерс, 2 - опцион*/
  DVKind = _DVKind;
  
  PRIVATE MACRO get_gtdv_code()
        RGDVCode;
  END;
  MACRO InsertToGate()
    var  Count = 0;
    /*Процедура обработки одной записи csv файла*/
    PRIVATE MACRO ProcessRecord()

       NumImportPFI = NumImportPFI + 1;
        if  ( ProcessTrn(0, "PutPFIInfo") )                                          
            NumImportPFITotal = NumImportPFITotal + 1;
            RGLog.Message( "Спецификация ПИ с кодом \"" + DataFile.GetRepCodePfi() + "\" уcпешно загружена в шлюз\n" + ErrMes, RG, SUCCESS );
           ErrMes = "";
            return true;
        else
           if (StrUpr(ErrMes,"ПОВТОРНАЯ РЕПЛИКАЦИЯ НЕВОЗМОЖНА")!=0) /*PNV*/
               RGLog.Message( "Спецификация ПИ с кодом \"" + DataFile.GetRepCodePfi() + "\" уже загружена в шлюз\n" + ErrMes, RG, SUCCESS );
            else
                 RGLog.Error( "Ошибка при загрузке спецификации ПИ с кодом \"" + DataFile.GetRepCodePfi() + "\"\n" + ErrMes );
           end;
           ErrMes = "";
            return false;
        end;

        OnError(ErObj)
        if(ErObj.Code == CtrlBrkErr)
            FlagCtrlBrk = true;
            return true; 
        end;
    END;
  
    Rewind(FileItog);
    SetDelim(";");

    InitProgress( NumRecords, "Загрузка ПИ.", "Загрузка ПИ." );

    if( Next(FileItog) )
       /*первую с названиями пропустили и идем далее*/
       while( Next( FileItog ) )
        if ((DataFile.Get07_MULTILEG() == 0)  OR (DataFile.fileitogname == "o07.csv"))      // ПИ долежн быть самостоятельным для импорта. Если она связанный, то игнорируем его вообще (на текущий момент, игнор не включает UseProgress).
           NumImportPFIAll=NumImportPFIAll+1;
          ProcessRecord();
       
          if( FlagCtrlBrk == true )
             break;
          end;
        end;
          UseProgress( Count = Count + 1 );
       end;
    end;

    RemProgress();
  END;
    
END;

private macro ImportDeal( DVKind:INTEGER, Pan )

  var stat:integer = 0;
  var IsDeal = false, Rate = NULL, ItogStr = "";
  var j:integer = 0;
  var PFI = NULL;

  var NumImportRatesAll = 0;
  var NumImportRates = 0;
  var NumImportRatesDup = 0;

  NumImportDealsAll = 0;
  NumImportDeals = 0;
  NumImportDealsTotal = 0;

  NumImportPosAll = 0;
  NumImportPos = 0;
  NumImportPosTotal = 0;

  NumImportReqAll = 0;
  NumImportReq = 0;
  NumImportReqTotal = 0;

  if( DVKind == DERIVATIVE_FUTURES )
      RGLog.Message( "---------- Загрузка данных по фьючерсам ----------" );
  else
      RGLog.Message( "---------- Загрузка данных по опционам ----------" );
  end;

  CurImpDate = pp.beg_date;

  if( GetDialogFlag() )
     InitProgress((Pan.end_date - Pan.beg_date + 1), "Загрузка файлов за период дат", "Просмотр дат...");
  end;

  var i:integer = 0;
  //на каждую дату из периода открываем соответствующие биржевые файлы
  while( CurImpDate <= pp.end_date )
     DataFile = CDataFile( DVKind, CurImpDate );
        if( DataFile.OpenData(i) )

        if( DataFile.IsRunFileItog() )

           Rate = RGDVRATE( DVKind, MICEX_CODE, true, CurImpDate);
           if( Rate )
              Rate.InsertToGate();
              NumImportRatesAll = NumImportRatesAll + Rate.ObjectCountTotal;
              NumImportRates    = NumImportRates    + Rate.NumImportItems;
              NumImportRatesDup = NumImportRatesDup + Rate.NumDuplItems;
           end;

        end;

        if( DataFile.IsRunFileDeal() )
           import_deals_to_gate_from();
        end;

        if( DataFile.IsRunFilePos() )
           import_pos_to_gate_from();
        end;
     
        if( DataFile.IsRunFileReq() )
           import_req_to_gate_from();
        end;
     
     end;

     DataFile.CloseData();
     j = j + 1;
     i = i + 1;
     if( GetDialogFlag() )
        UseProgress(j);
     end;
     if( FlagCtrlBrk == true )
        break;
     end;

      if (  not (ExistNextDealFile or ExistNextPosFile or ExistNextReqFile)  )
            CurImpDate = CurImpDate + 1;
            i = 0;
      end;
  end;

  if( DataFile.IsRunFileItog() )
     ItogStr = ItogStr + "Объект \"Курс финансового инструмента\": \n  всего - " + string(NumImportRatesAll) + ", успешно - " + string(NumImportRates) + ", ошибочно - " + string(NumImportRatesAll-NumImportRatesDup-NumImportRates) + "\n";
  end;

  if( DataFile.IsRunFileDeal() )
     ItogStr = ItogStr + "Объект \"Биржевая операция с ПИ\": \n  всего - " + string(NumImportDealsAll ) + ", успешно - " + string(NumImportDealsTotal) + ", ошибочно - " + string(NumImportDealsAll - NumImportDealsTotal) + "\n";
  end;

  if( DataFile.IsRunFilePos() )
     if( (not DataFile.IsRunFileDeal()) and (NumImportDealsAll > 0) )
        ItogStr = ItogStr + "Объект \"Биржевая операция с ПИ\": \n  всего - " + string(NumImportDealsAll ) + ", успешно - " + string(NumImportDealsTotal) + ", ошибочно - " + string(NumImportDealsAll - NumImportDealsTotal) + "\n";
     end;
     ItogStr = ItogStr + "Объект \"Итоги дня по позиции ПИ\": \n  всего - " + string(NumImportPosAll ) + ", успешно - " + string(NumImportPosTotal) + ", ошибочно - " + string(NumImportPosAll - NumImportPosTotal) + "\n";
  end;

  RGLog.Message( ItogStr );

  if( GetDialogFlag() )
     RemProgress(); 
  end;

  DataFile.CloseData();

OnError( RslErrObj )
  if( GetDialogFlag() )
     RemProgress(); 
  end;
end;

private macro ImportMon( Pan )

  var stat:integer = 0, j = 0, ItogStr = "";

  NumImportMonAll = 0;
  NumImportMon = 0;
  NumImportMonTotal = 0;

  RGLog.Message( "---------- Загрузка данных по договорам обслуживания ----------" );

  CurImpDate = pp.beg_date;

  if( GetDialogFlag() )
     InitProgress((Pan.end_date - Pan.beg_date + 1), "Загрузка файлов за период дат", "Просмотр дат...");
  end;
  var i:integer=0;
  //на каждую дату из периода открываем соответствующие биржевые файлы
  while( CurImpDate <= pp.end_date )
     DataFile = CDataFileMon( CurImpDate );
     if( DataFile.OpenData(i) )
        if( DataFile.IsRunFileMon() )
           import_mon_to_gate_from();
        end;
     end;

     DataFile.CloseData();
     //CurImpDate = CurImpDate + 1;
     j = j + 1;
     i = i + 1;
     if( GetDialogFlag() )
        UseProgress(j);
     end;
     if( FlagCtrlBrk == true )
        break;
     end;

     if( not ExistNextMonFile )
        CurImpDate = CurImpDate + 1;
        i = 0;
     end;
  end;

  if( DataFile.IsRunFileMon() )
     ItogStr = ItogStr + "Объект \"Информация по договору обслуживания\": \n  всего - " + string(NumImportMonAll ) + ", успешно - " + string(NumImportMonTotal) + ", ошибочно - " + string(NumImportMonAll - NumImportMonTotal) + "\n";
  end;

  RGLog.Message( ItogStr );

  if( GetDialogFlag() )
     RemProgress(); 
  end;

  DataFile.CloseData();

  OnError( RslErrObj )
  if( GetDialogFlag() )
     RemProgress(); 
  end;
end;

private macro ImportPFI( DVKind:INTEGER, Pan)

  var stat:integer = 0;
  var IsDeal = false, Rate = NULL, ItogStr = "";
  var j:integer = 0;
  var PFI = NULL;


  NumImportPFIAll = 0;
  NumImportPFI = 0;
  NumImportPFITotal = 0;


  if( DVKind == DERIVATIVE_FUTURES )
      RGLog.Message( "---------- Загрузка данных по новым фьючерсам ----------" );
  else
      RGLog.Message( "---------- Загрузка данных по новым опционам ----------" );
  end;

  CurImpDate = pp.beg_date;

  if( GetDialogFlag() )
     InitProgress((Pan.end_date - Pan.beg_date + 1), "Загрузка файлов за период дат", "Просмотр дат...");
  end;

  //на каждую дату из периода открываем соответствующие биржевые файлы
  while( CurImpDate <= pp.end_date )
     DataFile = CDataFile( DVKind, CurImpDate );
     if( DataFile.OpenData() )

        if( DataFile.IsRunFileItog() )

           PFI = RGDVPFI( DVKind, MICEX_CODE, true, CurImpDate);
           if ( PFI )
              PFI.InsertToGate();
           end;

        end;
     end;

     DataFile.CloseData();
     CurImpDate = CurImpDate + 1;
     j = j + 1;
     if( GetDialogFlag() )
        UseProgress(j);
     end;
     if( FlagCtrlBrk == true )
        break;
     end;
  end;

  if( DataFile.IsRunFileItog() )
     ItogStr = ItogStr + "Объект \"Финансовый инструмент\": \n  всего - " + string(NumImportPFIAll) + ", успешно - " + string(NumImportPFITotal) + ", ошибочно - " + string(NumImportPFIAll-NumImportPFITotal) + "\n";
  end;


  RGLog.Message( ItogStr );

  if( GetDialogFlag() )
     RemProgress(); 
  end;

  DataFile.CloseData();

OnError( RslErrObj )
  if( GetDialogFlag() )
     RemProgress(); 
  end;
end;

macro СледующийНомерОтчетаБиржи()
   var sql,rs;
   sql=" SELECT to_char(COUNT(*)+1) FROM ddvoper_dbt t WHERE t.t_dockind=194 AND t.t_operkind=12600" ;
   rs = LnGetRecordSet(sql);
   if(rs != null)
     if(rs.moveNext())
       return rs.value(0);
     end;
   end;
   return 1;
end; 

private macro RunInitItog( Pan )
  Pan.imp_date    = {curdate};
  Pan.beg_date    = {curdate};
  Pan.end_date    = {curdate};
  Pan.futures     = SET_CHAR;
  Pan.option      = SET_CHAR;
  Pan.file_pos    = SET_CHAR;
  Pan.file_deals  = SET_CHAR;
  Pan.file_itog   = SET_CHAR;
  Pan.file_request= SET_CHAR;
  Pan.file_coms   = SET_CHAR; //SET_CHAR; TEG 30.11.18 для планировщика убрал
  Pan.com_code     = "МскБиржСбор";
  Pan.file_mon    = SET_CHAR;
  Pan.impNewFutures     = SET_CHAR;
  Pan.impNewOption      = SET_CHAR;
    Pan.order_num = СледующийНомерОтчетаБиржи();
  Com_Num =1001;//TEG номер комиссии
end;

private macro RunImportCSV( Pan )

  var RetVal = CM_SAVE;

  RGLog = GTDL_Log(SeanceID);

  IsMarketReportLoad = false;

  if( CheckPanel(Pan) == false )
     RetVal = CM_IGNORE;
  end;

  if( RetVal != CM_IGNORE )
     if ( Pan.impNewFutures == SET_CHAR )
        ImportPFI(  DERIVATIVE_FUTURES, Pan);  
     end;
     if ( Pan.impNewOption == SET_CHAR )
        ImportPFI(  DERIVATIVE_OPTION, Pan);  
     end;
     if( Pan.futures == SET_CHAR )
        ImportDeal( DERIVATIVE_FUTURES, Pan ); 
     end; 
     if( Pan.option == SET_CHAR )
        ImportDeal( DERIVATIVE_OPTION, Pan ); 
     end;
     if( Pan.file_coms == SET_CHAR )
        var importer = GtCsvCommissImporter();
        importer.Run(Pan.beg_date, Pan.end_date);
     end; 
     if( Pan.file_mon  == SET_CHAR ) 
        ImportMon( Pan ); 
     end;
  end;

  RGLog.Save();

  return RetVal;
end;

/*листалка комиссий*/                         
PRIVATE MACRO RG_ListSfComiss( Pan:@variant, FeeType:integer, ServiceKind:integer, Com_Num:@string ):BOOL
  VAR Choice = DL_Scroll("SELECT com1.t_code t_code, com1.t_name t_name, COM1.T_NUMBER T_NUMBER, com1.t_datebegin t_datebegin, com1.t_dateend t_dateend, level "
                        +"  FROM dsfcomiss_dbt com1 " 
                        +" WHERE com1.T_FEETYPE = "+string(SF_FEE_TYPE_PERIOD)+" and com1.t_servicekind = "+string(PTSK_DV)
                        +"   and not EXISTS (SELECT 1 "
                        +"                     FROM dsfconcom_dbt concom1 "
                        +"                    WHERE com1.t_feetype = concom1.t_feetype "
                        +"                      AND com1.t_number = concom1.t_commnumber "
                        +"                      AND concom1.t_ObjectType = "+string(OBJTYPE_SFPLAN)
                        +"                      AND concom1.t_SfPlanID = 0 "
                        +"                      AND (concom1.t_DateBegin = to_date('01.01.0001','DD.MM.YYYY') " 
                        +"                           OR ( concom1.t_DateBegin <= "+GetSQLDate(Pan.beg_date)
                        +"                               AND (concom1.t_DateEnd = to_date('01.01.0001','DD.MM.YYYY') OR concom1.t_DateEnd > "+GetSQLDate(Pan.beg_date)+") "
                        +"                              ) "
                        +"                          ) "
                        +"                  ) " 
                        +"   START WITH com1.t_ParentComissID = 0 CONNECT BY PRIOR com1.t_ComissID = com1.t_ParentComissID ORDER SIBLINGS BY com1.t_Code ",
                         "Комиссия", -1/*X*/, 15/*Y*/,
                         "t_Code","Код","t_Name","Наименование","t_Number","Номер",
                         "t_DateBegin","Дата нач.","t_DateEnd","Дата оконч."
                        );
  if( Choice != NULL )
     Com_Num     = Choice.Value("t_Number");
     Pan.com_code = Choice.Value("t_Code"); 
  end;
  return (Choice != NULL);
END;                              

private macro ProcessPanel( Pn, Cmd, ID, Key )

  if( Cmd == DLG_INIT )
     RunInitItog(Pn);
     UpdateFields(Pn);
  elif( cmd == DLG_KEY )
     if( (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
        Pn.imp_date = GetDateByCalendar(Pn.imp_date);
        UpdateFields(Pn);
     elif( (key == 317) AND (ID == PNFLD_BEGDATE) ) /* F3 */
        Pn.beg_date = GetDateByCalendar(Pn.beg_date);
        UpdateFields(Pn);
     elif( (key == 317) AND (ID == PNFLD_ENDDATE) ) /* F3 */
        Pn.end_date = GetDateByCalendar(Pn.end_date);
        UpdateFields(Pn);
     elif( (key == 317) AND (ID == PNFLD_COM_CODE) ) /* F3 */
        RG_ListSfComiss( Pn, SF_FEE_TYPE_PERIOD, PTSK_DV, @Com_Num );
        UpdateFields(Pn);
     elif( Key == 316 )
        return RunImportCSV(Pn);
     elif( (Key == 13) or (Key == 323) )
        return CM_IGNORE;
     elif( Key == 32 ) /* Пробел */
        if( (ID == PNFLD_FILE_FUTURES) OR (ID == PNFLD_FILE_OPTION) OR (ID == PNFLD_FILE_POS) OR (ID == PNFLD_FILE_DEALS) OR (ID == PNFLD_FILE_ITOG) OR (ID == PNFLD_FILE_REQUEST) OR (ID == PNFLD_FILE_COMS) OR (ID == PNFLD_FILE_MON) OR (ID == PNFLD_FILE_STD_FUTURES) OR (ID == PNFLD_FILE_STD_OPTION) )
           if ( Pn(ID) == SET_CHAR ) Pn(ID) = UNSET_CHAR; 
           else                      Pn(ID) = SET_CHAR;
           end;
           if( ID == PNFLD_FILE_COMS )
              if( Pn(ID) != SET_CHAR )
                 DisableFields( Pn, PNFLD_COM_CODE );
              else
                 EnableFields( Pn, PNFLD_COM_CODE );
              end;
           end;
           UpdateFields(Pn);
        end;
     end;
  end;

  return CM_DEFAULT;
end;

macro GetComNum(StrParam)
 var i = 0;
 var pos_parm = 0, pos_2point = 0, pos_minus = 0;
 var str_temp = "", str_upr = "", str_val = "";

  str_upr = StrUPR(StrParam);
  pos_parm = Index(str_upr, "-" + StrUPR("com_intnum") + ":");
     if(pos_parm)

        str_temp = SubStr(StrParam, pos_parm + 1 );
        pos_2point = StrBrk (str_temp, ":");
        pos_minus  = StrBrk (str_temp, "-");

        if(pos_minus)
           str_val = Trim( SubStr(str_temp, pos_2point + 1, pos_minus - pos_2point - 1) );
        else
           str_val = Trim( SubStr(str_temp, pos_2point + 1) );
        end;
     end;
  return str_val;
end;

macro Process( SeanceID, Parms )
end;

macro Receive( _SeanceID:integer, Parm:variant )
  SeanceID = _SeanceID;

  if( IsShedulerRunning() )
     RunInitItog(pp);
     AutoSetParm(pp, Parm);                     // пар-ры из панели источника
     AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
     RunImportCSV(pp);
  else
/*ak*/
     var autoproc;
     if((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
       RunInitItog(pp);
       AutoSetParm(pp, Parm);
       RunImportCSV(pp);
     else
/*~ak*/
       RunDialog(pp, "ProcessPanel");
/*ak*/
     end;
/*~ak*/
  end;

  return 0;
end;

macro Deliver( SeanceID, Parm )
end; 