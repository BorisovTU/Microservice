/*
$Name:        gtImSPB4.mac
$Module:      Шлюз Securities
$Description: Загрузка ПАО СПБ, xml-формат файла биржи
*/

import gtImSPB_DL, "secinter.mac", "gtmktrep.mac", "dldlngfun.mac";

PRIVATE CONST SET_CHAR   = "X";
PRIVATE CONST UNSET_CHAR = "";


/*kd*/
import gtdlfun_u;
/*~kd*/
PRIVATE CONST RATE_KIND_MARKET     = 1;  /*курс вида "Рыночная цена"         */        
PRIVATE CONST RATE_KIND_MIN        = 2;  /*курс вида "Минимальная цена"      */
PRIVATE CONST RATE_KIND_MAX        = 3;  /*курс вида "Максимальная цена"     */
PRIVATE CONST RATE_KIND_WA         = 4;  /*курс вида "Средневзвешенная цена" */
PRIVATE CONST RATE_KIND_NKD1SEC    = 15; /*курс вида "НКД на одну бумагу"    */
PRIVATE CONST RATE_KIND_VOLUME     = 35; /*курс вида "(СПБ) Объём торгов"    */
PRIVATE CONST RATE_KIND_MARKET_TAX = 21; /*курс вида "Рыночная цена для НДФЛ"*/

PRIVATE CONST AVRKIND_EQUITY_SHARE              = "АКЦИИ ОБЫКНОВЕННЫЕ",
              AVRKIND_PREFERENCE_SHARE          = "АКЦИИ ПРИВИЛЕГИРОВАННЫЕ",
              AVRKIND_INVESTMENT_SHARE_OPEN     = "ПАЙ ОТКРЫТОГО ПИФ",
              AVRKIND_INVESTMENT_SHARE_CLOSE    = "ПАЙ ЗАКРЫТОГО ПИФ",
              AVRKIND_ETF                       = "ETF",
              AVRKIND_RDR                       = "RDR",
              AVRKIND_ADR                       = "ADR",
              AVRKIND_GDR                       = "GDR",
              AVRKIND_INVESTMENT_SHARE_INTERVAL = "ПАЙ ИНТЕРВАЛЬНОГО ПИФ",
              AVRKIND_MORTGAGE                  = "ИПОТЕЧНЫЙ ВЕКСЕЛЬ",
              AVRKIND_BOND_STATE                = "ГОСУДАРСТВЕННЫЕ ОБЛИГАЦИИ",
              AVRKIND_BOND_MUNICIPAL            = "МУНИЦИПАЛЬНЫЕ ОБЛИГАЦИИ",
              AVRKIND_BOND_CB                   = "ОБЛИГАЦИИ ЦЕНТРАЛЬНОГО БАНКА",
              AVRKIND_BOND_CORPORATE            = "КОРПОРАТИВНЫЕ ОБЛИГАЦИИ",
              AVRKIND_BOND_CREDIT               = "ОБЛИГАЦИИ КРЕДИТНОЙ ОРГАНИЗАЦИИ",
              AVRKIND_BOND_EXCHANGE             = "БИРЖЕВЫЕ ОБЛИГАЦИИ";
PRIVATE CONST Код_на_СПБ_Субъект = 76;


PRIVATE VAR NumImportDeals = 0, NumImportDealsTotal = 0,
            NumImportDealsCliring = 0, NumImportDealsTotalCliring = 0,
            CodeRate = "", RateKind_ = "", NumImportRates = 0, NumImportRatesTotal = 0,
            RECORDID_Deals = 0, RECORDID_Deals_Cliring = 0, RECORDID_MarketReport = 0;

PRIVATE record pp(IMP_PRM3, "rgate.lbr") dialog;

private macro ЧислоСтрокой( _var, _point:integer )
   return ExecExp("String(_var:0" + ":" + string(_point) + ")");
end;

PRIVATE CONST PNFLD_IMPDATE         = 0,
              PNFLD_MARKET          = 1,
              PNFLD_RATES           = 2,
              PNFLD_COMP            = 3,
              PNFLD_PAYM            = 4,
              PNFLD_INCREPO         = 5,
              PNFLD_DIVIDREPO       = 6, 
              PNFLD_REQUEST         = 7, 
              PNFLD_SECUR           = 8, 
              PNFLD_CLEARING        = 9, 
              PNFLD_CLEARING_CLIENT = 10,
              PNFLD_SEC_BO          = 11,
              PNFLD_SEC_SEB         = 12,
              PNFLD_SEC_DU          = 13,
              PNFLD_MAR_SCHEME_DU   = 14,
              PNFLD_NETTOITOG       = 15,
              PNFLD_MONEYMOTION     = 16,
              PNFLD_KSUWRT          = 17;

private class DataMoneyMotion(_EntryCodeType, _EntryNumber, _EntryDebit, _EntryCredit,
                              _EntryDate, _ExtSettleCodeID, _CurrencyId, _ClientCode, _Account,
                              _OtherKlirAcc)
        var EntryCodeType:integer                           =   _EntryCodeType,
        EntryNumber:string                                  =   _EntryNumber,
        EntryDebit:money                                    =   _EntryDebit,
        EntryCredit:money                                   =   _EntryCredit,
        EntryDate:date                                      =   _EntryDate,
        ExtSettleCodeID:string                              =   _ExtSettleCodeID,
        CurrencyId:string                                   =   _CurrencyId,
        ClientCode:string                                   =   _ClientCode,
        Account:string                                      =   _Account,
        OtherKlirAcc:string                                 =   _OtherKlirAcc;

    macro Init()
        CurrencyId = ClientCode = Account = OtherKlirAcc = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;

    macro InitRecords()
        CurrencyId = ClientCode = Account = OtherKlirAcc = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;
END;

//Структура данных файла ORDERS
private const 	F_ACTION           	=	0	; // 	Тип заявки
private const 	F_ORDER_NO         	=	1	; // 	Уникальный код Заявки
private const 	F_REG_NO           	=	2	; // 	Идентификационный номер Заявки, присвоенный Биржей
private const 	F_ENTRY_DATE       	=	3	; // 	Дата регистрации Заявки в Системе проведения торгов.
private const 	F_ENTRY_TIME       	=	4	; // 	Время регистрации заявки в Системе проведения торгов.
private const 	F_FIRMID           	=	5	; // 	Дополнительный код Участника торгов, присвоенный Биржей.
private const 	F_FIRMCODE         	=	6	; // 	Код Участника торгов согласно Положению 437-П.
private const 	F_CLIENT_CODEID    	=	7	; // 	Код Клиента участника торгов.
private const 	F_CLIENT_ALIAS     	=	8	; // 	Дополнительный код, присвоенный Биржей, идентифицирующий Клиента.
private const 	F_CLIENT_COUNTRY   	=	9	; // 	Трехзначный         цифровой        код     иностранного         государства
private const 	F_LOGIN            	=	10	; // 	Имя Участника торгов.
private const 	F_TRD_ACCID        	=	11	; // 	Номер торгово-клирингового счета, в счет которого поставлена данная Заявка.
private const 	F_CP_FIRMID        	=	12	; // 	Дополнительный код Участника торгов фирмы-контрагента, присвоенный Биржей.
private const 	F_CP_FIRMCODE      	=	13	; // 	Код Участника Торгов-контрагента согласно Положению 437-П.
private const 	F_ADDRESS_CODE     	=	14	; // 	Идентификатор адресных сделок, присвоенный Участнику торгов подавшему Заявку.
private const 	F_CP_ADDRESS_CODE  	=	15	; // 	Идентификатор адресных сделок, присвоенный Участнику торгов, которому адресована Заявка.
private const 	F_BUY_SELL         	=	16	; // 	Направленность Заявки
private const 	F_ORDER_TYPE       	=	17	; // 	Тип заявки
private const 	F_IS_ADDRESS       	=	18	; // 	Признак адресности Заявки
private const 	F_IS_MM            	=	19	; // 	Признак Заявки, поданной во исполнение обязательств Маркет-меи?кера
private const 	F_SECURITYID       	=	20	; // 	Идентификационный код ценной бумаги.
private const 	F_TRADE_MODE       	=	21	; // 	Режим торгов
private const 	F_TRADE_PERIOD     	=	22	; // 	Торговая сессия
private const 	F_QUOTE_CURRENCY   	=	23	; // 	Символьный код валюты цены в Заявке.
private const 	F_CURRENCY         	=	24	; // 	Символьный код валюты платежа по инструменту.
private const 	F_PRICE            	=	25	; // 	Цена одной ценной бумаги, цена первой части Договора репо.
private const 	F_REPO_PRICE       	=	26	; // 	Ставка репо.
private const 	F_QUANTITY         	=	27	; // 	Объём Заявки (начальный объем Заявки), в единицах.
private const 	F_QUANTITY_LOT     	=	28	; // 	Объём Заявки (начальный объем Заявки), в лотах.
private const 	F_QUANTITY_REST    	=	29	; // 	Объем оставшейся активной Заявки, в единицах.
private const 	F_QUANTITY_LOT_REST	=	30	; // 	Объем оставшейся активной Заявки, в лотах.
private const 	F_VOLUME           	=	31	; // 	Объем Заявки (первой части Договора репо) в валюте цены.
private const 	F_STATUS           	=	32	; // 	Результат объявления Заявки
private const 	F_STATUS_REASON    	=	33	; // 	Причина аннулирования Заявки
private const 	F_AMEND_DATE       	=	34	; // 	Дата отмены/изменения Заявки в Системе проведения торгов.
private const 	F_AMEND_TIME       	=	35	; // 	Время отмены/изменения Заявки в Системе проведения торгов.
private const 	F_ISSUE_DATE       	=	36	; // 	Дата исполнения Заявки в Системе проведения торгов.
private const 	F_ISSUE_TIME       	=	37	; // 	Время исполнения Заявки в Системе проведения торгов.
private const 	F_MATCH_REF        	=	38	; // 	Дополнительный идентификатор адресной Заявки.
private const 	F_NUM_TRADES       	=	39	; // 	Количество Договоров, заключенных на основании поданной Заявки.
private const 	F_SETT_TYPE        	=	40	; // 	Код расчетов.
private const 	F_SPECIAL_PERIOD   	=	41	; // 	Периоды проведения торгов
private const 	F_CL_ORDERID       	=	42	; // 	Клиентский номер Заявки.
private const 	F_EXTRA_REF        	=	43	; // 	Дополнительный числовой номер Заявки.
private const 	F_COMMENT          	=	44	; // 	Комментарий к Заявке.
private const 	F_TIME_IN_FORCE    	=	45	; // 	Вид Заявки
private const 	F_EXTRA_ORDER_NO   	=	46	; // 	Дополнительный  номер Заявки, соответствует шлюзовому  полю exchorder_id.

private class DataRepo(TradeNo_:string, Amount_:money, SettleDate_:date, AccInt2_:money, Price2_:double, Value_:money)
  var TradeNo:string  = TradeNo_,
      Amount2:money    = Amount_,
      SettleDate:date = SettleDate_,
      AccInt2:money   = AccInt2_,
      Price2:double   = Price2_,
      Value2_:money   = Value_;
end;

private class DataRepo_1(TradeNo_:string)
  var TradeNo:string  = TradeNo_;
end;

private class CPFirmData(TradeNo_:string, BuySell_:string, CPFirmID_:string)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      CPFirmId:string = CPFirmID_;
end;

private class CommData(TradeNo_:string, BuySell_:string, ClrComm_:money)
  var TradeNo:string  = TradeNo_,
      BuySell:string  = BuySell_,
      ClrComm:money   = ClrComm_,
end;

private class DataReq()
  var BuySell   :string,
      EntryTime :time,
      AmendTime :time,
      Status    :string,
      ClientCode:string,
      OrderNo   :string,
      TradeDate :date,
      RepoRate  :double,
      RecNo     :integer,
      SecurityId:string,
      Quantity  :money,
      Price     :double,
      PriceType :string,
      CurrencyId:string,
      TrdAccId  :string,
      RepoValue :money,
      IsTrust   :bool,
      IsSEB     :bool,
      OrdTypeCode:string,
      PriceFIID :string,
      IsAddress :string,
      Commentar :string;

  macro Init()
      BuySell   = Status = OrderNo = SecurityId = ClientCode = PriceType = PriceFIID = CurrencyId = TrdAccId = IsAddress = Commentar = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = 0;
      RepoRate  = Price = 0.0;
      TradeDate = date(0,0,0);
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = false;
  end;

  macro InitRecords()
      BuySell   = Status = OrderNo = SecurityId = ClientCode = PriceType = PriceFIID = CurrencyId = TrdAccId = IsAddress = Commentar = "";
      EntryTime = AmendTime = time(0,0,0);
      RecNo     = 0;
      RepoRate  = Price = 0.0;
      Quantity  = RepoValue = $0.0;
      IsTrust   = IsSEB = false;
  end;

end;

private class DataNettoItog()
  var ReportDate:date,
      FinalObligations:string,
      ExtCode:string,
      PosType:string,
      Currency:string,
      Debit:money,
      Credit:money,
      NettoSum:money;

  macro Init()
     FinalObligations = ExtCode = PosType = Currency = "";
     ReportDate = date(0,0,0);
     Debit = Credit = NettoSum = $0.0;
  end;

  macro InitRecords()
     Currency = "";
     Debit = Credit = NettoSum = $0.0;
  end;
end;

private class DataRates
  var TradeDate:date,
      BoardID:string,
      SecurityId:string,
      FaceValue:double,
      SecCurrencyId:string,
      SecurityType:string,
      Decimals:integer,
      CurrencyId:string,
      AccruedInterest:double,
      TotalAmount:double,
      MaxDealPrice:double,
      MinDealPrice:double,
      WAPrice:double,
      MarketPrice3:double;

  macro Init()
    TradeDate = date(0,0,0);
    BoardID = SecurityId = SecCurrencyId = SecurityType = CurrencyId = "";
    Decimals = 0;
    AccruedInterest = TotalAmount = MaxDealPrice = MinDealPrice = WAPrice = MarketPrice3 = $0.0;
  end;

  macro InitRecords()
    SecurityId = SecCurrencyId = SecurityType = CurrencyId = "";
    Decimals = 0;
    AccruedInterest = TotalAmount = MaxDealPrice = MinDealPrice = WAPrice = MarketPrice3 = $0.0;
  end;
end;

private class Data_file(data_filepath_:string, data_filename_:string, stat_:integer)
  var data_filepath:string  = data_filepath_,
      data_filename:string  = data_filename_,
      stat:integer = stat_;
end;

private var Req   = DataReq();
private var MoneyMotion = DataMoneyMotion();
private var NettoItog   = DataNettoItog();
private var Rates       = DataRates();

private macro FileDate(date_val)
   var day, month, year;
   DateSplit(date_val,day,month,year);

   return RGDLFUN_LZ(year,4) + "-" + RGDLFUN_LZ(month,2) + "-" + RGDLFUN_LZ(day,2);
end;

/* настраиваемый пользователем макрос формирования
   имен файла котировок и сделок с госбумагами с СПБ */
private macro get_data_file_name( folder:string, pfx:string, datafilepath:@string, datafilename:@string, comment_from_:string, NoSayError:bool, useTom:bool )
   var ErrStr = "", v_NoSayError = RG_IIF(NoSayError!=null,NoSayError,false);

   datafilepath = GetRegImportDirUSPB(imp_date, @ErrStr);
   var datafilemask = "?????_" + pfx;

   datafilemask = datafilemask + "_" + FileDate(imp_date) + RG_IIF(useTom, "_?_???", "") + ".xml";

   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      datafilename = "";
      if( v_NoSayError == false )
         RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      else
         datafilename = datafilemask;
      end;
      return 1;
   else
      datafilename = List.name(0);
      if( v_NoSayError == false )
         RGLog.Message(comment_from + "Используется файл " + datafilename);
      end;
      return 0;
   end;
end;

private macro PutMarketReport()
   if( (Deals.DOC_NO == "") OR (WriteMarketReport( SeanceID, NULL, SOURCE_CODE, @MarketReportID, @ErrMes, null, Deals.DOC_NO, imp_date, SPB_Code ) == false) )
      AbortTrn;
   end; 
end;

private macro PutMoneyMotion()
   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   var ObjName = "", EntryNumber = "";

   if( MoneyMotion.EntryCodeType == 9999 )
      ObjName = String("Т/О по передаче дохода по РЕПО №" + MoneyMotion.EntryNumber + " на " + string(MoneyMotion.EntryDate));
      EntryNumber = MoneyMotion.EntryNumber + "_" + string(MoneyMotion.EntryDate);
   else
      ObjName = "Движение денежных средств №" + MoneyMotion.EntryNumber + " на " + MoneyMotion.EntryDate;
      EntryNumber = MoneyMotion.EntryNumber + "_" + MoneyMotion.EntryDate;
   end;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_MONEYMOTION, 
                   ObjName,
                   Создать );

   if(NOT RG.InitByCode(RG_MONEYMOTION, EntryNumber, SOURCE_CODE) )
      Exit();
   end;

   RG.SetParmByName("CODETYPE", MoneyMotion.EntryCodeType);
   RG.SetParmByName("DEBIT", MoneyMotion.EntryDebit);
   RG.SetParmByName("CREDIT", MoneyMotion.EntryCredit);
   RG.SetParmByName("DATE", MoneyMotion.EntryDate);
   RG.SetParmByName("EXT_SETTLECODE", MoneyMotion.ExtSettleCodeID);

   if( MoneyMotion.EntryCodeType == 9999 )
      RG.SetParmByName("NUMBER", MoneyMotion.EntryNumber);
      RG.SetParmByName("CURRENCYID", MoneyMotion.CurrencyID);
      RG.SetParmByName("CLIENTCODE", MoneyMotion.ClientCode);
   else
      RG.SetParmByName("ACCOUNT", MoneyMotion.Account);
      RG.SetParmByName("OTHERKLIRACC", MoneyMotion.OtherKlirAcc);
      RG.SetParmByName("CURRENCYID", MoneyMotion.CurrencyID);
   end;

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

private macro get_data_file_name_txt( folder:string, pfx:string, datafilepath:@string, datafilename:@string, comment_from_:string, NoSayError:bool )
   var ErrStr = "", v_NoSayError = RG_IIF(NoSayError!=null,NoSayError,false);

   datafilepath = GetRegImportDirUSPB(imp_date, @ErrStr);

   var datafilemask = "orders-" + pfx + "_?????";

   datafilemask = datafilemask + "-" + FileDate(imp_date) + ".txt";

   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      datafilename = "";
      if( v_NoSayError == false )
         RGLog.Error( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      else
         datafilename = datafilemask;
      end;
      return 1;
   else
      datafilename = List.name(0);
      if( v_NoSayError == false )
         RGLog.Message(comment_from + "Используется файл " + datafilename);
      end;
      return 0;
   end;

end;

// сделка подходит?
private macro IsFitDeal()
   if( pp.deals_bo == SET_CHAR )
      return true;
   end;
   return false;
end;

PRIVATE MACRO IsOutExchangeREPO():BOOL
  return ((Deals.TradeModeId == 14) AND (Deals.InfType == 2));
END;

PRIVATE MACRO IsDealData():BOOL
  if( FileImport == FileSPB03 )
     return true;
  end;

  if( IsOutExchangeREPO() )
     return true;
  end;

  return false;
END;

PRIVATE MACRO IsCliringData():BOOL

  if( FileImport != FileMFB06C )
     return false;
  end;

  if(    ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "B") ) // сделка покупки
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 0) AND (Deals.BuySell == "S") ) // сделка продажи

      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 1) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 

      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "S") ) // 1 часть сделки прямого РЕПО  
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 1) AND (Deals.BuySell == "B") ) // 1 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "S") ) // 2 часть сделки обратного РЕПО
      OR ((Deals.InfType == 2) AND (Deals.RepoPart == 2) AND (Deals.BuySell == "B") ) // 2 часть сделки прямого РЕПО 
    )
     return true;
  end;

  return false;
END;

private macro WriteDealData()
   VAR NoError = true;
   ErrMes = "";
   WarnMes = "";

   if( IsDealData() )
      if( NumImportDeals == 0 ) /*на первой сделке вставляем документ-основание*/
         if(ProcessTrn(0, "PutMarketReport"))
         else
            RGLog.Error( "Ошибка при вставке документа-подтверждения \"Отчет биржи\"\n" + ErrMes, RGMkRep );
         end;
         ErrMes = "";
      end;

      NumImportDeals = NumImportDeals + 1;
      Deals.IsCliring = false;

      if (ProcessTrn(0, "PutDealInfo"))
      else
         NoError = false;
         RG.UnInit();
      end;

      if( ErrMes != "" )
         RGLog.Error(ErrMes);
      end;

      if( WarnMes != "" )
         RGLog.Message(WarnMes);
      end;

      ErrMes = "";
      WarnMes = "";
   end;

   /* !!! В MFB06C одна запись может попаcть сразу в оба условия IsDealData и IsCliringData*/
   if( IsCliringData() )
      NumImportDealsCliring = NumImportDealsCliring + 1;
      Deals.IsCliring = true;
      if (ProcessTrn(0, "PutDealInfo") )
         Deals.IsCliring = false;
      else
         Deals.IsCliring = false;
         NoError = false;
         RG.UnInit();
      end;

      if( ErrMes != "" )
         RGLog.Error(ErrMes);
      end;

      if( WarnMes != "" )
         RGLog.Message(WarnMes);
      end;

      ErrMes = "";
      WarnMes = "";
   end;

   return NoError;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

private macro ЗагрузитьКомиссииПо1ч(DataCommArray:TArray, TradeNo:string, BuySell:string, CLRCOMM:@money)
   var i:integer = 0;
   while(i < DataCommArray.size)
      if( (DataCommArray[i].TradeNo == TradeNo) and (DataCommArray[i].BuySell == BuySell) )
         CLRCOMM = DataCommArray[i].CLRCOMM;
         break;
      end;
      i = i + 1;
   end;
end;

private macro ЗаполнитьКонтрагентаДляРПС(DataContrArray:TArray, TradeNo:string, BuySell:string, CPFirmId:@string)
   var i:integer = 0;
   while(i < DataContrArray.size)
      if( (DataContrArray[i].TradeNo == TradeNo) and (DataContrArray[i].BuySell == BuySell) )
         CPFirmId = DataContrArray[i].CPFirmId;
         break;
      end;
      i = i + 1;
   end;
end;

private macro НевнутридневноеРЕПО(DataRepoArray:TArray, TradeNo1:string)
   var i:integer = 0, ret = true;
   while(i < DataRepoArray.size)
      if(DataRepoArray[i].TradeNo == TradeNo1)
         ret = false;
         break;
      end;
      i = i + 1;
   end;
   return ret;
end;

private macro ДнейВГоду( YYYY:INTEGER ):INTEGER
   return DATE( 31,12,YYYY )-DATE( 1,1,YYYY )+1;
end;

/*здесь собираем комиссии и информацию по торговым счетам по сделкам (1 частям) и заодно
  суммовые параметры по секции InfType == (3) по 2 частям РЕПО*/
private macro GetCommFromMFB06C(DataCommArray:@TArray, datafilename_MFB06C:string)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, y=0;
   var node:object, child_RtsDoc:object, child_Report:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_Client:object;
   var DOC_REQUISITES = false, REPORT = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "", SettleCode:string = "";
   var stat:integer = 0;
   var RepoPart:integer = 0;
   var ClrComm = $0.0;

   var Amount:money = $0.0, AccInt2:money = $0.0, Price2:double = $0.0, Value_:money = $0.0;

   if(GetDialogFlag())
     InitProgress(-1, "Сбор данных по комиссиям из файла исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_MFB06C) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_MFB06C, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_Report = child_RtsDoc.childNodes.item(j);
           if(child_Report and (child_Report.nodeType==CHILD_NODE))

             if(child_Report.tagname == "FIRM")
               if(FIRM)
                 RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT\FIRM должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               FIRM = true;
               k=0;
               while(k<child_Report.childNodes.length) /* бегаем по FIRM */
                 child_Firm = child_Report.childNodes.item(k);
                 if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                   if(child_Firm.tagname == "CLIENT")
                     y=0;
                     while(y<child_Firm.childNodes.length) /* бегаем по CLIENT */
                       child_Client = child_Firm.childNodes.item(y);
                       if(child_Client and (child_Client.nodeType==CHILD_NODE))
                         if(child_Client.tagname == "CURRENCY")
                           l=0;
                           while(l<child_Client.childNodes.length) /* бегаем по CURRENCY */
                             child_Currency = child_Client.childNodes.item(l);
                             if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                               if(child_Currency.tagname == "INFTYPE")
                                 InfType = 0;
                                 if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                 end;
                                 if( (InfType == 2) or (InfType == 3) )
                                   q=0;
                                   while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                     child_InfType = child_Currency.childNodes.item(q);
                                     if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                       if(child_InfType.tagname == "CLEARINGTYPE")
                                         w=0;
                                         while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                           child_ClearingType = child_InfType.childNodes.item(w);
                                           if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                             if(child_ClearingType.tagname == "SESSION")
                                               e=0;
                                               while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                 child_Session = child_ClearingType.childNodes.item(e);
                                                 if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                   if(child_Session.tagname == "SETTLEDATE")
                                                     t=0;
                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                       child_Settledate = child_Session.childNodes.item(t);
                                                       if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                         if(child_Settledate.tagname == "BOARD")
                                                           m=0;
                                                           while(m<child_Settledate.childNodes.length) /* бегаем по BOARD */
                                                             child_Board = child_Settledate.childNodes.item(m);
                                                             if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                               if(child_Board.tagname == "SECURITY")
                                                                 s=0;
                                                                 while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                   child_Security = child_Board.childNodes.item(s);
                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                     if(child_Security.tagname == "RECORDS")
                                                                       RepoPart = 0;
                                                                       if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                       end;
                                                                             
                                                                       if(ReadTagAttribut(child_Security, "CLRCOMM", V_MONEY, ClrComm) == false)
                                                                       end;
                                                
                                                                       if( (RepoPart == 0) OR (RepoPart == 1) )
                                                                          TradeNo = "";
                                                                          if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                          end;
                                                                          BuySell = "";
                                                                          if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                          end;
                                                                          if( (TradeNo != "") AND (BuySell != "") )
                                                                             if( ClrComm > $0.0 )
                                                                                DataCommArray[DataCommArray.size] = CommData(TradeNo,BuySell,ClrComm);
                                                                             end;
                                                                          end;
                                                                       end;
                                                                     end;
                                                                   end;
                                                                   s = s + 1;
                                                                 end;
                                                               end;
                                                             end;
                                                             m = m + 1;
                                                           end;
                                                         end;
                                                       end;
                                                       t = t + 1;
                                                     end;
                                                   end;
                                                 end;
                                                 e = e + 1;
                                               end;
                                             end;
                                           end;
                                           w = w + 1;
                                         end;
                                       end;
                                     end;
                                     q = q + 1;
                                   end;
                                 end;
                               end;
                             end;
                             l = l + 1;
                           end;
                         end;
                       end;
                       y = y + 1;
                     end;
                   end;
                 end;
                 k = k + 1;
               end;
             end;
           end;
           j = j + 1;
         end;
       end;
     end;
     i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro НайтиДанныеПо2Части(DataRepoArray:TArray, TradeNo1:string, SettleDate:date, Amount:money, RepoRate:@double,
                                  AccInt2:@money, Amount2:@money, Value2_:@money, Price2:@double)
   var i:integer = 0, N:double = 1.0;
   var YYYY_beg, YYYY_end, YYYY_cur;
   RepoRate = 0.0; AccInt2 = $0.0; Amount2 = $0.0; Value2_ = $0.0; Price2 = 0.0;
   while(i < DataRepoArray.size)
      if(DataRepoArray[i].TradeNo == TradeNo1)
         AccInt2 = DataRepoArray[i].AccInt2;
         Amount2 = DataRepoArray[i].Amount2;
         Value2_ = DataRepoArray[i].Value2_;
         Price2  = DataRepoArray[i].Price2;
         if(SettleDate != DataRepoArray[i].SettleDate)
            datesplit( SettleDate, NULL, NULL, YYYY_beg );
            datesplit( DataRepoArray[i].SettleDate, NULL, NULL, YYYY_end );
            if(YYYY_beg == YYYY_end)
               N = double(DataRepoArray[i].SettleDate - SettleDate) / double(ДнейВГоду(YYYY_beg));
            else
               YYYY_cur = YYYY_beg + 1;
               N = double(DATE(1,1,YYYY_cur) - SettleDate) / double(ДнейВГоду(YYYY_beg));
               while(YYYY_cur < YYYY_end)
                  N = N + 1;
                  YYYY_cur = YYYY_cur + 1;
               end;
               N = N + double(DataRepoArray[i].SettleDate - DATE(1,1,YYYY_cur)) / double(ДнейВГоду(YYYY_end));
            end;
         end;
         if((Amount * N) != 0.0)
            RepoRate = round(((DataRepoArray[i].Amount2 - Amount) / (Amount * N)) * 100, 4);
         end;
         break;
      end;
      i = i + 1;
   end;
end;

/*собираем информацию по 2 частям РЕПО*/
private macro GetDataRepo2FromSPB03(datafilename_SPB03:string, DataRepoArray:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, y=0, x=0;
   var node:object, child_RtsDoc:object, child_CLRACC:object, child_SUBCLRACC:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_SECURITY:object, child_RECORDS:object;
   var DOC_REQUISITES = false, REPORT = false, CLRACC = false;
   var stat:integer = 0;

   DataRepoArray = TArray();

   if(GetDialogFlag())
     InitProgress(-1, "Сбор данных по 2 частям РЕПО из файла заключенных сделок", "Просмотр данных...");
   end;

   Deals.Init();

   /* откроем файл импорта */
   if( not xml.load(datafilename_SPB03) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_SPB03, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;

   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_SPB03, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_SPB03, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_CLRACC = child_RtsDoc.childNodes.item(j);
           if(child_CLRACC and (child_CLRACC.nodeType==CHILD_NODE))
             if(child_CLRACC.tagname == "CLRACC")
               if(CLRACC)
                 RGLog.Error(string(datafilename_SPB03, ": Блок RTS_DOC\REPORT\CLRACC должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               CLRACC = true;
               k=0;
               while(k<child_CLRACC.childNodes.length) /* бегаем по CLRACC */
                 child_SUBCLRACC = child_CLRACC.childNodes.item(k);
                 if(child_SUBCLRACC and (child_SUBCLRACC.nodeType==CHILD_NODE))
                   if(child_SUBCLRACC.tagname == "SUBCLRACC")
                     x = 0;
                     while(x<child_SUBCLRACC.childNodes.length) /* бегаем по SUBCLRACC */ 
                       child_CURRENCY = child_SUBCLRACC.childNodes.item(x);
                       if(child_CURRENCY and (child_CURRENCY.nodeType==CHILD_NODE))
                         if(child_CURRENCY.tagname == "CURRENCY")
                           y=0;
                           while(y<child_CURRENCY.childNodes.length) /* бегаем по CURRENCY */
                             child_BOARD = child_CURRENCY.childNodes.item(y);
                             if(child_BOARD and (child_BOARD.nodeType==CHILD_NODE))
                               if(child_BOARD.tagname == "BOARD")
                                 l=0;
                                 while(l<child_BOARD.childNodes.length) /* бегаем по BOARD */
                                   child_SETTLEDATE = child_BOARD.childNodes.item(l);
                                   if(child_SETTLEDATE and (child_SETTLEDATE.nodeType==CHILD_NODE))
                                     if(child_SETTLEDATE.tagname == "SETTLEDATE")
                                       Deals.SettleDate = date(0,0,0);
                                       if(ReadTagAttribut(child_SETTLEDATE, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                         /* если не нашли фактическую дату расчётов */
                                       end;
                                       t=0;
                                       while(t<child_SETTLEDATE.childNodes.length) /* бегаем по SETTLEDATE */
                                         child_SECURITY = child_SETTLEDATE.childNodes.item(t);
                                         if(child_SECURITY and (child_SECURITY.nodeType==CHILD_NODE))

                                           if(child_SECURITY.tagname == "SECURITY")
                                             s=0;
                                             while(s<child_SECURITY.childNodes.length) /* бегаем по SECURITY */
                                               child_RECORDS = child_SECURITY.childNodes.item(s);
                                               if(child_RECORDS and (child_RECORDS.nodeType==CHILD_NODE))
                                                 if(child_RECORDS.tagname == "RECORDS")

                                                   Deals.InitRecords();
                                                   Deals.ClientCode = "";
                                                   if(not ((ReadTagAttribut(child_RECORDS, "CLIENTCODE", V_STRING, Deals.ClientCode) == false) OR (Deals.ClientCode == "")))
                                                     if(not ((ReadTagAttribut(child_RECORDS, "REPOPART", V_INTEGER, Deals.RepoPart) == false) OR (Deals.RepoPart != 2)))

                                                       if( pp.deals_bo == SET_CHAR )                                                                           
                                                         if(ReadTagAttribut(child_RECORDS, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                           /* если не нашли номер сделки */
                                                         end;
                                                         //Deals.Amount = 0.0;
                                                         if(ReadTagAttribut(child_RECORDS, "AMOUNT", V_MONEY, Deals.Amount2) == false)
                                                           /* если не нашли  */
                                                         end;
                                                         if(ReadTagAttribut(child_RECORDS, "ACCINT", V_MONEY, Deals.AccInt2) == false)
                                                           /* если не нашли  */
                                                         end;
                                                         //Deals.Price = 0.0;
                                                         if(ReadTagAttribut(child_RECORDS, "PRICE2", V_DOUBLE, Deals.Price2) == false)
                                                           /* если не нашли  */
                                                         end;
                                                         //Deals.Value_ = 0.0;
                                                         if(ReadTagAttribut(child_RECORDS, "VALUE", V_MONEY, Deals.Value2_) == false)
                                                           /* если не нашли  */
                                                         end;

                                                         /* вытащили все данные */
                                                         DataRepoArray[DataRepoArray.size] = DataRepo(Deals.TradeNo, Deals.Amount2, Deals.SettleDate, Deals.AccInt2, Deals.Price2, Deals.Value2_);
                                                       end;
                                                     end;
                                                   end;
                                                 end;
                                               end;
                                               s = s + 1;
                                             end;
                                           end;
                                         end;
                                         t = t + 1;
                                       end;
                                     end;
                                   end;
                                   l = l + 1;
                                 end;
                               end;
                             end;
                             y = y + 1;
                           end;
                         end;
                         x = x+1;
                       end;
                     end;
                   end;
                 end;
                 k = k + 1;
               end;
             end;
           end;
           j = j + 1;
         end;
       end;
     end;
     i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetRecsAfterLoad_SPB03()
   RGLog.GetAndAddReceiveLoadRecs(RG_MARKETREPORT,"Документ-подтверждение \"Отчет биржи\" успешно загружен\n",null,true,null,@RECORDID_MarketReport);
   RGLog.GetAndAddReceiveLoadRecs(RG_SECURDEAL,"Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotal, @RECORDID_Deals);
end;

private macro import_deals_to_gate_from_SPB03( datafilename_SPB03, filename_SPB03:string )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, y=0, x=0;
   var node:object, child_RtsDoc:object, child_CLRACC:object, child_SUBCLRACC:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_SECURITY:object, child_RECORDS:object;
   var DOC_REQUISITES = false, REPORT = false, CLRACC = false;
   var stat:integer = 0;
   var DataRepoArray = TArray();
   var IsRun = true;
   var prevClrAccCode:string = "";

   FileImport = FileSPB03;     

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)

      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   NumImportDealsCliring = 0;
   NumImportDealsTotalCliring = 0;

   GetDataRepo2FromSPB03(datafilename_SPB03, @DataRepoArray);

   /* откроем файл импорта */
   if( not xml.load(datafilename_SPB03) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_SPB03, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;

   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_SPB03, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
         Deals.DOC_NO = "";
         if(ReadTagAttribut(child_RtsDoc, "DOC_NO", V_STRING, Deals.DOC_NO) == false)
           /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
         end;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_SPB03, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_CLRACC = child_RtsDoc.childNodes.item(j);
           if(child_CLRACC and (child_CLRACC.nodeType==CHILD_NODE))
             if(child_CLRACC.tagname == "CLRACC")
               if(CLRACC)
                 RGLog.Error(string(datafilename_SPB03, ": Блок RTS_DOC\REPORT\CLRACC должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               CLRACC = true;
               k=0;

               Deals.ClrAccCode = "";
               if(ReadTagAttribut(child_CLRACC, "CLRACCCODE", V_STRING, Deals.ClrAccCode) == false)
               end;

               if(Deals.ClrAccCode != prevClrAccCode)
                 prevClrAccCode = Deals.ClrAccCode;
                 Deals.ClrAccCodeType = GetClrAccCodeType(Deals.ClrAccCode);
               end;

               while(k<child_CLRACC.childNodes.length) /* бегаем по CLRACC */
                 child_SUBCLRACC = child_CLRACC.childNodes.item(k);
                 if(child_SUBCLRACC and (child_SUBCLRACC.nodeType==CHILD_NODE))
                   if(child_SUBCLRACC.tagname == "SUBCLRACC")
                     x = 0;
                     while(x<child_SUBCLRACC.childNodes.length) /* бегаем по SUBCLRACC */ 
                       child_CURRENCY = child_SUBCLRACC.childNodes.item(x);
                       if(child_CURRENCY and (child_CURRENCY.nodeType==CHILD_NODE))
                         if(child_CURRENCY.tagname == "CURRENCY")
                           Deals.CurrencyId = "";
                           if(ReadTagAttribut(child_CURRENCY, "CURRENCYID", V_STRING, Deals.CurrencyId) == false)
                             /* если не нашли идентификатор валюты расчётов */
                           end;
                           y=0;
                           while(y<child_CURRENCY.childNodes.length) /* бегаем по CURRENCY */
                             child_BOARD = child_CURRENCY.childNodes.item(y);
                             if(child_BOARD and (child_BOARD.nodeType==CHILD_NODE))
                               if(child_BOARD.tagname == "BOARD")
                                 l=0;
                                 while(l<child_BOARD.childNodes.length) /* бегаем по BOARD */
                                   child_SETTLEDATE = child_BOARD.childNodes.item(l);
                                   if(child_SETTLEDATE and (child_SETTLEDATE.nodeType==CHILD_NODE))
                                     if(child_SETTLEDATE.tagname == "SETTLEDATE")
                                       Deals.SettleDate = date(0,0,0);
                                       if(ReadTagAttribut(child_SETTLEDATE, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                         /* если не нашли фактическую дату расчётов */
                                       end;
                                       t=0;
                                       while(t<child_SETTLEDATE.childNodes.length) /* бегаем по SETTLEDATE */
                                         child_SECURITY = child_SETTLEDATE.childNodes.item(t);
                                         if(child_SECURITY and (child_SECURITY.nodeType==CHILD_NODE))

                                           if(child_SECURITY.tagname == "SECURITY")
                                             Deals.SecurityId = "";
                                             if(ReadTagAttribut(child_SECURITY, "SECURITYID", V_STRING, Deals.SecurityId) == false)
                                               /* если не нашли идентификатор финансового инструмента */
                                             end;

                                             Deals.ISIN = "";
                                             if(ReadTagAttribut(child_SECURITY, "ISIN", V_STRING, Deals.ISIN) == false)
                                               /* если не нашли идентификатор финансового инструмента */
                                             end;
                                             Deals.FaceValue = "";
                                             if(ReadTagAttribut(child_SECURITY, "FACEVALUE", V_STRING, Deals.FaceValue) == false)
                                               /* если не нашли идентификатор финансового инструмента */
                                             end;

                                             Deals.PriceType = "";
                                             if(ReadTagAttribut(child_SECURITY, "PRICETYPE", V_STRING, Deals.PriceType) == false)
                                               /* если не нашли  */
                                             end;
                                             s=0;
                                             while(s<child_SECURITY.childNodes.length) /* бегаем по SECURITY */
                                               child_RECORDS = child_SECURITY.childNodes.item(s);
                                               if(child_RECORDS and (child_RECORDS.nodeType==CHILD_NODE))
                                                 if(child_RECORDS.tagname == "RECORDS")

                                                   Deals.InitRecords();

                                                   if(ReadTagAttribut(child_RECORDS, "REPOPART", V_INTEGER, Deals.RepoPart) == false)
                                                     /* если не нашли  */
                                                   end;

                                                   if(Deals.RepoPart == 2) // данные для 2 части РЕПО собрали ранее
                                                     s = s + 1;
                                                     continue;
                                                   end;

                                                   if(ReadTagAttribut(child_RECORDS, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                   end;

                                                   Deals.ClientCode = "";
                                                   if((ReadTagAttribut(child_RECORDS, "CLIENTCODE", V_STRING, Deals.ClientCode) == false) OR (Deals.ClientCode == ""))
                                                   end;

                                                   Deals.BuySell = "";
                                                   if(ReadTagAttribut(child_RECORDS, "BUYSELL", V_STRING, Deals.BuySell) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.SettleCode = "";
                                                   if(ReadTagAttribut(child_RECORDS, "SETTLECODE", V_STRING, Deals.SettleCode) == false)
                                                     /* если не нашли  */
                                                   end;

                                                   SetPartPrmDeal();

                                                   Deals.TradeDate = date(0,0,0);
                                                   if(ReadTagAttribut(child_RECORDS, "TRADEDATE", V_DATE, Deals.TradeDate) == false)
                                                     /* если не нашли дату торгов */
                                                   end;

                                                   Deals.TradeTime = time(0,0,0);
                                                   if(ReadTagAttribut(child_RECORDS, "TRADETIME", V_TIME, Deals.TradeTime) == false)
                                                     /* если не нашли дату торгов */
                                                   end;

                                                   Deals.TradeType = "";
                                                   if(ReadTagAttribut(child_RECORDS, "TRADETYPE", V_STRING, Deals.TradeType) == false)
                                                       /* если не нашли тип сделки */
                                                   end;

                                                   if(ReadTagAttribut(child_RECORDS, "TRADEPERIOD", V_STRING, Deals.TradePeriod) == false)
                                                       /* если не нашли торговую сессию */
                                                   end;

                                                   if(ReadTagAttribut(child_RECORDS, "SPECIALPERIOD", V_STRING, Deals.SpecialPeriod) == false)
                                                       /* если не нашли период проведения торгов */
                                                   end;

                                                   Deals.PrimaryOrderID = "";
                                                   if(ReadTagAttribut(child_RECORDS, "PRIMARYORDERID", V_STRING, Deals.PrimaryOrderID) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.OrderNo = "";
                                                   if(ReadTagAttribut(child_RECORDS, "ORDERID", V_STRING, Deals.OrderNo) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.Commentar = "";
                                                   if(ReadTagAttribut(child_RECORDS, "COMMENT", V_STRING, Deals.Commentar) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.Decimals = 0;
                                                   if(ReadTagAttribut(child_RECORDS, "DECIMALS", V_INTEGER, Deals.Decimals) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.Price = 0.0;
                                                   if(ReadTagAttribut(child_RECORDS, "PRICE", V_DOUBLE, Deals.Price) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.Quantity = 0.0;
                                                   if(ReadTagAttribut(child_RECORDS, "QUANTITY", V_MONEY, Deals.Quantity) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.Value_ = 0.0;
                                                   if(ReadTagAttribut(child_RECORDS, "VALUE", V_MONEY, Deals.Value_) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.Amount = 0.0;
                                                   if(ReadTagAttribut(child_RECORDS, "AMOUNT", V_MONEY, Deals.Amount) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.ExhComm = 0.0;
                                                   if(ReadTagAttribut(child_RECORDS, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.ClrComm = 0.0;
                                                   if(ReadTagAttribut(child_RECORDS, "CLRCOMM", V_MONEY, Deals.ClrComm) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.CCPCode = "";
                                                   if(ReadTagAttribut(child_RECORDS, "CCPCODE", V_STRING, Deals.CCPCode) == false)
                                                     /* если не нашли  */
                                                   end;
                                                   Deals.CPFirmId = "";
                                                   if(ReadTagAttribut(child_RECORDS, "CPFIRMID", V_STRING, Deals.CPFirmId) == false)
                                                     /* если не нашли  */
                                                   end;

                                                   if(ReadTagAttribut(child_RECORDS, "ACCINT", V_MONEY, Deals.AccInt) == false)
                                                     /* если не нашли  */
                                                   end;

                                                   if(ReadTagAttribut(child_RECORDS, "PRICE2", V_DOUBLE, Deals.Price2) == false)
                                                     /* если не нашли  */
                                                   end;

                                                   if(ReadTagAttribut(child_RECORDS, "REPORATE", V_DOUBLE, Deals.RepoRate) == false)
                                                     /* если не нашли  */
                                                   end;

                                                   //ЗагрузитьКомиссииПо1ч(DataCommArray, Deals.TradeNo, Deals.BuySell, @Deals.CLRCOMM);

                                                   if( Deals.RepoPart == 1 )
                                                     НайтиДанныеПо2Части(DataRepoArray, Deals.TradeNo, Deals.SettleDate, Deals.Amount, @Deals.RepoRate,
                                                                         @Deals.AccInt2, @Deals.Amount2, @Deals.Value2_, @Deals.Price2);
                                                   end;

                                                   if(RunImp())
                                                     stat = 1;
                                                   end;

                                                 end;
                                               end;
                                               s = s + 1;
                                             end;
                                           end;
                 
                                         end;
                                         t = t + 1;
                                         if( FlagCtrlBrk == true )
                                           break;
                                         end;
                                       end;

                                     end;
                                   end;
                                   l = l + 1;
                                   if( FlagCtrlBrk == true )
                                     break;
                                   end;

                                 end;
                               end;
                             end;
                             y = y + 1;
                             if( FlagCtrlBrk == true )
                               break;
                             end;
                           end;
                      
                         end;
                         x = x+1;
                         if(GetDialogFlag())
                           UseProgress(k);
                         end;
                       end;
                       if( FlagCtrlBrk == true )
                         break;
                       end;
                     end;
                   end;
                 end;
                 k = k + 1;
                 if(GetDialogFlag())
                   UseProgress(k);
                 end;
               end;
               if(GetDialogFlag())
                 RemProgress(); 
               end;
             end;
           end;
           j = j + 1;
           if( FlagCtrlBrk == true )
             break;
           end;
         end;
       end;
     end;
     i = i + 1;
     if( FlagCtrlBrk == true )
       if(GetDialogFlag())
         RemProgress(); RemProgress();
       end;
       break;
     end;
   end;

   if( not FlagCtrlBrk )
     RG.Transfer();
     SetErrAfterLoad(true);
   end;
   /*загрузить в лог инфу о загруженных ЗР*/
   GetRecsAfterLoad_SPB03();

   /* сообщаем о результатах загрузки */
   RGLog.Message( "Загрузка "+string(filename_SPB03)+":"+
                  "\nВсего сделок - " + string(NumImportDeals) + 
                  "\n из них успешно - " + string(NumImportDealsTotal) + 
                  "\n ошибочно - " + string(NumImportDeals - NumImportDealsTotal)
                );

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

// соберем контрагентов
private macro GetContrFromMFB06C(DataContrArray:@TArray, datafilename_MFB06C:string)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0;
   var node:object, child_RtsDoc:object, child_Report:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_Client:object;
   var DOC_REQUISITES = false, REPORT = false, FIRM = false;
   var InfType:integer = 0, TradeNo:string = "", BuySell:string = "";
   var PartyCode = "";
   var stat:integer = 0;
   var v=0, y=0;
   var findCPFIRMID = false;

   if(GetDialogFlag())
      InitProgress(-1, "Поиск контрагента по сделке РПС в файле исполненных сделок", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_MFB06C) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_MFB06C, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_Report = child_RtsDoc.childNodes.item(j);
           if(child_Report and (child_Report.nodeType==CHILD_NODE))

             if(child_Report.tagname == "FIRM")
               if(FIRM)
                 RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT\FIRM должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               FIRM = true;
               k=0;
               while(k<child_Report.childNodes.length) /* бегаем по FIRM */
                 child_Firm = child_Report.childNodes.item(k);
                 if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                   if(child_Firm.tagname == "CLIENT")
                     y=0;
                     while(y<child_Firm.childNodes.length) /* бегаем по CLIENT */
                       child_Client = child_Firm.childNodes.item(y);
                       if(child_Client and (child_Client.nodeType==CHILD_NODE))
                         if(child_Client.tagname == "CURRENCY")
                           l=0;
                           while(l<child_Client.childNodes.length) /* бегаем по CURRENCY */
                             child_Currency = child_Client.childNodes.item(l);
                             if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                               if(child_Currency.tagname == "INFTYPE")
                                 q=0;
                                 while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                   child_InfType = child_Currency.childNodes.item(q);
                                   if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                     if(child_InfType.tagname == "CLEARINGTYPE")
                                       w=0;
                                       while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                         child_ClearingType = child_InfType.childNodes.item(w);
                                         if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                           if(child_ClearingType.tagname == "SESSION")
                                             e=0;
                                             while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                               child_Session = child_ClearingType.childNodes.item(e);
                                               if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                 if(child_Session.tagname == "SETTLEDATE")
                                                   t=0;
                                                   while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                     child_Settledate = child_Session.childNodes.item(t);
                                                     if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                       if(child_Settledate.tagname == "BOARD")
                                                         m=0;
                                                         while(m<child_Settledate.childNodes.length) /* бегаем по BOARD */
                                                           child_Board = child_Settledate.childNodes.item(m);
                                                           if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                             if(child_Board.tagname == "SECURITY")
                                                               s=0;
                                                               while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                 child_Security = child_Board.childNodes.item(s);
                                                                 if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                   if(child_Security.tagname == "RECORDS")

                                                                     TradeNo = "";
                                                                     if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                     end;
                                       
                                                                     BuySell = "";
                                                                     if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, BuySell) == false)
                                                                     end;

                                                                     PartyCode = "";
                                                                     if(ReadTagAttribut(child_Security, "CPFIRMID", V_STRING, PartyCode) == false)
                                                                       /* если не нашли идентификатор фирмы партнера */
                                                                     end;
                                                                     
                                                                     if( (PartyCode != null) and (PartyCode != "") )
                                                                       v = 0;
                                                                       while( v < DataContrArray.size )
                                                                         if( (TradeNo == DataContrArray[v].TradeNo) AND (BuySell == DataContrArray[v].BuySell)  )
                                                                           DataContrArray[v].CPFIRMID = PartyCode;
                                                                           findCPFIRMID = true;
                                                                           break;
                                                                         end;
                                                                         v = v + 1;
                                                                       end;
                                                                       if( not findCPFIRMID )
                                                                         DataContrArray[DataContrArray.size] = CPFirmData(TradeNo, BuySell, PartyCode);
                                                                       end;
                                                                     end;

                                                                   end;
                                                                 end;
                                                                 s = s + 1;
                                                               end;
                                                             end;
                                                           end;
                                                           m = m + 1;
                                                         end;
                                                       end;
                                                     end;
                                                     t = t + 1;
                                                   end;
                                                 end;
                                               end;
                                               e = e + 1;
                                             end;
                                           end;
                                         end;
                                         w = w + 1;
                                       end;
                                     end;
                                   end;
                                   q = q + 1;
                                 end;
                               end;
                             end;
                             l = l + 1;
                           end;
                         end;
                       end;
                       y = y + 1;
                     end;
                   end;
                 end;
                 k = k + 1;
               end;
             end;
           end;
           j = j + 1;
         end;
       end;
     end;
     i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro СобратьДанныеПо2ЧастиРепо( datafilename_MFB06C, DataRepoArray:@TArray )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, y=0;
   var node:object, child_RtsDoc:object, child_Report:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_Client:object;
   var DOC_REQUISITES = false, REPORT = false, FIRM = false;
   var InfType:integer = 0, SettleDate:date = date(0,0,0),
       RepoPart:integer = 0, TradeNo:string = "",
       Amount:money = $0.0, AccInt2:money = $0.0, Price2:double = $0.0, Value_:money = $0.0;
   var stat:integer = 0;

   if( GetDialogFlag() )
      InitProgress(-1, "Обработка 2 частей сделок РЕПО", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_MFB06C) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_MFB06C, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_Report = child_RtsDoc.childNodes.item(j);
           if(child_Report and (child_Report.nodeType==CHILD_NODE))

             if(child_Report.tagname == "FIRM")
               if(FIRM)
                 RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT\FIRM должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               FIRM = true;
               k=0;
               while(k<child_Report.childNodes.length) /* бегаем по FIRM */
                 child_Firm = child_Report.childNodes.item(k);
                 if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                   if(child_Firm.tagname == "CLIENT")
                     y=0;
                     while(y<child_Firm.childNodes.length) /* бегаем по CLIENT */
                       child_Client = child_Firm.childNodes.item(y);
                       if(child_Client and (child_Client.nodeType==CHILD_NODE))
                         if(child_Client.tagname == "CURRENCY")
                           l=0;
                           while(l<child_Client.childNodes.length) /* бегаем по CURRENCY */
                             child_Currency = child_Client.childNodes.item(l);
                             if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                               if(child_Currency.tagname == "INFTYPE")
                                 InfType = 0;
                                 if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                 end;
                                 if( (InfType == 1) or (InfType == 2) or (InfType == 3))
                                   q=0;
                                   while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                     child_InfType = child_Currency.childNodes.item(q);
                                     if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                       if(child_InfType.tagname == "CLEARINGTYPE")
                                         w=0;
                                         while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                           child_ClearingType = child_InfType.childNodes.item(w);
                                           if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                             if(child_ClearingType.tagname == "SESSION")
                                               e=0;
                                               while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                 child_Session = child_ClearingType.childNodes.item(e);
                                                 if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                   if(child_Session.tagname == "SETTLEDATE")
                                                     SettleDate = date(0,0,0);
                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, SettleDate) == false)
                                                     end;
                                                     t=0;
                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                       child_Settledate = child_Session.childNodes.item(t);
                                                       if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                         if(child_Settledate.tagname == "BOARD")
                                                           m=0;
                                                           while(m<child_Settledate.childNodes.length) /* бегаем по BOARD */
                                                             child_Board = child_Settledate.childNodes.item(m);
                                                             if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                               if(child_Board.tagname == "SECURITY")
                                                                 s=0;
                                                                 while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                   child_Security = child_Board.childNodes.item(s);
                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                     if(child_Security.tagname == "RECORDS")
                                                                       if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                         RepoPart = 0;
                                                                       end;

                                                                       if(RepoPart == 2)
                                                                         if( pp.deals_bo == SET_CHAR )                                                                           
                                                                           TradeNo = "";
                                                                           if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                           end;
                                                                           Amount = $0.0;
                                                                           if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Amount) == false)
                                                                           end;
                                                                           AccInt2 = $0.0;
                                                                           if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, AccInt2) == false)
                                                                           end;
                                                                           Price2 = 0.0;
                                                                           if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Price2) == false)
                                                                           end;
                                                                           Value_ = $0.0;
                                                                           if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Value_) == false)
                                                                           end;
                                                                           /* вытащили все данные */
                                                                           DataRepoArray[DataRepoArray.size] = DataRepo(TradeNo, Amount, SettleDate, AccInt2, Price2, Value_);
                                                                         end;
                                                                       end;

                                                                     end;
                                                                   end;
                                                                   s = s + 1;
                                                                 end;
                                                               end;
                                                             end;
                                                             m = m + 1;
                                                           end;
                                                         end;
                                                       end;
                                                       t = t + 1;
                                                     end;
                                                   end;
                                                 end;
                                                 e = e + 1;
                                               end;
                                             end;
                                           end;
                                           w = w + 1;
                                         end;
                                       end;
                                     end;
                                     q = q + 1;
                                   end;
                                 end;
                               end;
                             end;
                             l = l + 1;
                           end;
                         end;
                       end;
                       y = y + 1;
                     end;
                   end;
                 end;
                 k = k + 1;
               end;
             end;
           end;
           j = j + 1;
         end;
       end;
     end;
     i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro GetRecsAfterLoad_MFB06C()
   RGLog.GetAndAddReceiveLoadRecs(27,"Клиринг. Сделка \"","\" уcпешно загружена в шлюз", false, @NumImportDealsTotalCliring, @RECORDID_Deals_Cliring);
end;

private macro СобратьДанныеПо1ЧастиРепо(datafilename_MFB06C, DataRepoArray:@TArray)

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, y=0;
   var node:object, child_RtsDoc:object, child_Report:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Settle:object,
       child_ClearingType:object, child_Session:object, child_Client:object;
   var DOC_REQUISITES = false, REPORT = false, FIRM = false;
   var InfType:integer = 0,
       RepoPart:integer = 0, TradeNo:string = "";
   var stat:integer = 0;

   if(GetDialogFlag())
      InitProgress(-1, "Обработка 1 частей сделок РЕПО", "Просмотр данных...");
   end;

   /* откроем файл импорта */
   if( not xml.load(datafilename_MFB06C) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_MFB06C, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;
   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_Report = child_RtsDoc.childNodes.item(j);
           if(child_Report and (child_Report.nodeType==CHILD_NODE))

             if(child_Report.tagname == "FIRM")
               if(FIRM)
                 RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT\FIRM должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               FIRM = true;
               k=0;
               while(k<child_Report.childNodes.length) /* бегаем по FIRM */
                 child_Firm = child_Report.childNodes.item(k);
                 if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                   if(child_Firm.tagname == "CLIENT")
                     y=0;
                     while(y<child_Firm.childNodes.length) /* бегаем по CLIENT */
                       child_Client = child_Firm.childNodes.item(y);
                       if(child_Client and (child_Client.nodeType==CHILD_NODE))
                         if(child_Client.tagname == "CURRENCY")
                           l=0;
                           while(l<child_Client.childNodes.length) /* бегаем по CURRENCY */
                             child_Currency = child_Client.childNodes.item(l);
                             if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                               if(child_Currency.tagname == "INFTYPE")
                                 InfType = 0;
                                 if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, InfType) == false)
                                 end;
                                 if( InfType == 1 )
                                   q=0;
                                   while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                     child_InfType = child_Currency.childNodes.item(q);
                                     if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                       if(child_InfType.tagname == "CLEARINGTYPE")
                                         w=0;
                                         while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                           child_ClearingType = child_InfType.childNodes.item(w);
                                           if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                             if(child_ClearingType.tagname == "SESSION")
                                               e=0;
                                               while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                 child_Session = child_ClearingType.childNodes.item(e);
                                                 if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                   if(child_Session.tagname == "SETTLEDATE")
                                                     t=0;
                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                       child_Settledate = child_Session.childNodes.item(t);
                                                       if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                         if(child_Settledate.tagname == "BOARD")
                                                           m=0;
                                                           while(m<child_Settledate.childNodes.length) /* бегаем по BOARD */
                                                             child_Board = child_Settledate.childNodes.item(m);
                                                             if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                               if(child_Board.tagname == "SECURITY")
                                                                 s=0;
                                                                 while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                   child_Security = child_Board.childNodes.item(s);
                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                     if(child_Security.tagname == "RECORDS")
                                                                       if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, RepoPart) == false)
                                                                         RepoPart = 0;
                                                                       end;

                                                                       if(RepoPart == 1)
                                                                          if( pp.deals_bo == SET_CHAR )
                                                                             TradeNo = "";
                                                                             if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, TradeNo) == false)
                                                                             end;
                                                                             DataRepoArray[DataRepoArray.size] = DataRepo_1(TradeNo);
                                                                          end;
                                                                       end;

                                                                     end;
                                                                   end;
                                                                   s = s + 1;
                                                                 end;
                                                               end;
                                                             end;
                                                             m = m + 1;
                                                           end;
                                                         end;
                                                       end;
                                                       t = t + 1;
                                                     end;
                                                   end;
                                                 end;
                                                 e = e + 1;
                                               end;
                                             end;
                                           end;
                                           w = w + 1;
                                         end;
                                       end;
                                     end;
                                     q = q + 1;
                                   end;
                                 end;
                               end;
                             end;
                             l = l + 1;
                           end;
                         end;
                       end;
                       y = y + 1;
                     end;
                   end;
                 end;
                 k = k + 1;
               end;
             end;
           end;
           j = j + 1;
         end;
       end;
     end;
     i = i + 1;
   end;

   if(GetDialogFlag())
      RemProgress(); 
   end;

   return stat;

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

private macro import_deals_to_gate_from_MFB06C( datafilename_MFB06C, filename_MFB06C:string )

   var xml:object = ActiveX( "MSXML.DOMDocument" );
   var i=0, j=0, k=0, l=0, m=0, n=0, s=0, r=0, q=0, w=0, e=0, t=0, y=0;
   var node:object, child_RtsDoc:object, child_Report:object, child_Firm:object,
       child_Currency:object, child_Board:object, child_Settledate:object,
       child_Security:object, child_InfType:object, child_Client:object,
       child_ClearingType:object, child_Session:object;
   var DOC_REQUISITES = false, REPORT = false, FIRM = false;
   var stat:integer = 0;
   var DataRepoArray = TArray(); DataRepoArray.size = 0;
   var DataRepoArray_1 = TArray(); DataRepoArray_1.size = 0;
   var IsRun = true;

   FileImport = FileMFB06C;

   private macro RunImp()
      /* сохранение информации о сделке в промежуточном файле */
      if(WriteDealData() != true)
         return 1;
      end;

      return 0;

   OnError(ErObj)
      RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

      if(ErObj.Code == CtrlBrkErr)
         FlagCtrlBrk = true;
      else
         RemProgress();
         RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
      end;
      return ErObj.Code;
   end;

   RG = TGtRecordBatchCharger();

   Deals.Init();

   NumImportDeals = 0;
   NumImportDealsTotal = 0;

   NumImportDealsCliring = 0;
   NumImportDealsTotalCliring = 0;

   СобратьДанныеПо2ЧастиРепо(datafilename_MFB06C, @DataRepoArray);

   СобратьДанныеПо1ЧастиРепо(datafilename_MFB06C, @DataRepoArray_1);

   /* откроем файл импорта */
   if( not xml.load(datafilename_MFB06C) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename_MFB06C, "|Невозможно загрузить xml-документ" ));
     return;
   end;
   node = xml.DocumentElement;
   i=0;

   while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if(child_RtsDoc and (child_RtsDoc.nodeType==CHILD_NODE))

       if(child_RtsDoc.tagname == "DOC_REQUISITES")
         if(DOC_REQUISITES)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
           return false;
         end;
         DOC_REQUISITES = true;
         Deals.DOC_NO = "";
         if(ReadTagAttribut(child_RtsDoc, "DOC_NO", V_STRING, Deals.DOC_NO) == false)
           /* если не нашли уникальный учетный номер документа в системе электронного документооборота(используется для отчёта бирже) */
         end;
       end;

       if(child_RtsDoc.tagname == "REPORT")
         if(REPORT)
           RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
           return false;
         end;
         REPORT = true;
         j=0;
         while(j<child_RtsDoc.childNodes.length) /* бегаем по REPORT */
           child_Report = child_RtsDoc.childNodes.item(j);
           if(child_Report and (child_Report.nodeType==CHILD_NODE))

             if(child_Report.tagname == "FIRM")
               if(FIRM)
                 RGLog.Error(string(datafilename_MFB06C, ": Блок RTS_DOC\REPORT\FIRM должен присутствовать в единственном экземпляре"));
                 return false;
               end;
               FIRM = true;
               if(GetDialogFlag())
                 InitProgress(child_Report.childNodes.length, "Загрузка сделок из MFB06C", "Просмотр сделок по клиентам...");
               end;
               k=0;
               while(k<child_Report.childNodes.length) /* бегаем по FIRM */
                 child_Firm = child_Report.childNodes.item(k);
                 if(child_Firm and (child_Firm.nodeType==CHILD_NODE))
                   if(child_Firm.tagname == "CLIENT")
                     Deals.ClientCode = "";
                     if(ReadTagAttribut(child_Firm, "CLIENTCODE", V_STRING, Deals.ClientCode) == false)
                       /* если не нашли краткий код клиента */
                     end;
                     y=0;
                     while(y<child_Firm.childNodes.length) /* бегаем по CLIENT */
                       child_Client = child_Firm.childNodes.item(y);
                       if(child_Client and (child_Client.nodeType==CHILD_NODE))
                         if(child_Client.tagname == "CURRENCY")
                           Deals.CurrencyId = "";
                           if(ReadTagAttribut(child_Client, "CURRENCYID", V_STRING, Deals.CurrencyId) == false)
                             /* если не нашли идентификатор валюты расчётов */
                           end;
                           l=0;
                           while(l<child_Client.childNodes.length) /* бегаем по CURRENCY */
                             child_Currency = child_Client.childNodes.item(l);
                             if(child_Currency and (child_Currency.nodeType==CHILD_NODE))
                               if(child_Currency.tagname == "INFTYPE")
                                 Deals.InfType = 0;
                                 if(ReadTagAttribut(child_Currency, "INFTYPE", V_INTEGER, Deals.InfType) == false)
                                 end;
                                 if( (Deals.InfType == 1) or (Deals.InfType == 2) )
                                   q=0;
                                   while(q<child_Currency.childNodes.length) /* бегаем по INFTYPE */
                                     child_InfType = child_Currency.childNodes.item(q);
                                     if(child_InfType and (child_InfType.nodeType==CHILD_NODE))
                                       if(child_InfType.tagname == "CLEARINGTYPE")
                                         w=0;
                                         while(w<child_InfType.childNodes.length) /* бегаем по CLEARINGTYPE */
                                           child_ClearingType = child_InfType.childNodes.item(w);
                                           if(child_ClearingType and (child_ClearingType.nodeType==CHILD_NODE))
                                             if(child_ClearingType.tagname == "SESSION")
                                               Deals.CliringTime = time(0,0,0);
                                               if(ReadTagAttribut(child_ClearingType, "CLEARINGTIME", V_TIME, Deals.CliringTime) == false)
                                                 /* если не нашли время клиринга */
                                               end;
                                               if(Deals.CliringTime == time(0,0,0))
                                                 var CliringDate;
                                                 if(ReadTagAttribut(child_ClearingType, "CLEARINGTIME", V_STRING, CliringDate) == false)
                                                   /* если не нашли время клиринга */
                                                 end;
                                                 if(CliringDate != " ")
                                                   var pos = Index(CliringDate, ":")-2;
                                                   CliringDate = substr(CliringDate,pos,8);
                                                   Deals.CliringTime = time(CliringDate);
                                                 end;
                                               end;
                                               e=0;
                                               while(e<child_ClearingType.childNodes.length) /* бегаем по SESSION */
                                                 child_Session = child_ClearingType.childNodes.item(e);
                                                 if(child_Session and (child_Session.nodeType==CHILD_NODE))
                                                   if(child_Session.tagname == "SETTLEDATE")
                                                     Deals.SettleDate = date(0,0,0);
                                                     if(ReadTagAttribut(child_Session, "SETTLEDATE", V_DATE, Deals.SettleDate) == false)
                                                       /* если не нашли фактическую дату расчётов */
                                                     end;
                                                     t=0;
                                                     while(t<child_Session.childNodes.length) /* бегаем по SETTLEDATE */
                                                       child_Settledate = child_Session.childNodes.item(t);
                                                       if(child_Settledate and (child_Settledate.nodeType==CHILD_NODE))
                                                         if(child_Settledate.tagname == "BOARD")
                                                           m=0;
                                                           while(m<child_Settledate.childNodes.length) /* бегаем по BOARD */
                                                             child_Board = child_Settledate.childNodes.item(m);
                                                             if(child_Board and (child_Board.nodeType==CHILD_NODE))
                                                               if(child_Board.tagname == "SECURITY")
                                                                 Deals.SecurityId = "";
                                                                 if(ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Deals.SecurityId) == false)
                                                                   /* если не нашли идентификатор финансового инструмента */
                                                                 end;
                                                                 if(ReadTagAttribut(child_Board, "PRICETYPE", V_STRING, Deals.PriceType) == false)
                                                                   /* если не нашли тип цены */
                                                                 end;
                                                                 s=0;
                                                                 if(GetDialogFlag())
                                                                   InitProgress(child_Board.childNodes.length, "Загрузка сделок из MFB06C", "Загрузка сделок...");
                                                                 end;
                                                                 while(s<child_Board.childNodes.length) /* бегаем по SECURITY */
                                                                   child_Security = child_Board.childNodes.item(s);
                                                                   if(child_Security and (child_Security.nodeType==CHILD_NODE))
                                                                     if(child_Security.tagname == "RECORDS")
                                                                       Deals.InitRecords();
                                                                       if(ReadTagAttribut(child_Security, "REPOPART", V_INTEGER, Deals.RepoPart) == false)
                                                                         Deals.RepoPart = 0;
                                                                         /* если не нашли часть репо */
                                                                       end;

                                                                       if(    ( (Deals.InfType == 1) AND (Deals.RepoPart == 1) )
                                                                           OR ( (Deals.InfType == 2) AND ((Deals.RepoPart == 1) or (Deals.RepoPart == 2)) )
                                                                           OR ( (Deals.InfType == 1) AND (Deals.RepoPart == 2) )
                                                                           OR ( Deals.RepoPart == 0 )
                                                                         )

                                                                         if(ReadTagAttribut(child_Security, "BUYSELL", V_STRING, Deals.BuySell) == false)
                                                                           /* если не нашли направленность заявки */
                                                                         end;
                                                                         if(ReadTagAttribut(child_Security, "SETTLECODE", V_STRING, Deals.SettleCode) == false)
                                                                           /* если не нашли код расчётов по сделке */
                                                                         end;

                                                                         SetPartPrmDeal();

                                                                         if( IsFitDeal() )
                                                                           Deals.TradeDate = date(0,0,0);
                                                                           if(ReadTagAttribut(child_Security, "TRADEDATE", V_DATE, Deals.TradeDate) == false)
                                                                             /* если не нашли дату торгов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "TRADENO", V_STRING, Deals.TradeNo) == false)
                                                                             /* если не нашли номер сделки в торговой системе */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "DECIMALS", V_INTEGER, Deals.Decimals) == false)
                                                                             /* если не нашли число значимых знаков после запятой */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "PRICE", V_DOUBLE, Deals.Price) == false)
                                                                             /* если не нашли цену за одну ценную бумагу */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "QUANTITY", V_MONEY, Deals.Quantity) == false)
                                                                             /* если не нашли объём сделки, в ценных бумагах */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "VALUE", V_MONEY, Deals.Value_) == false)
                                                                             /* если не нашли объём сделки, в валюте расчётов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "AMOUNT", V_MONEY, Deals.Amount) == false)
                                                                             /* если не нашли сумму сделки, в валюте расчётов */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                             /* если не нашли объём комиссии по заключенной сделке за торги */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "ACCINT", V_MONEY, Deals.AccInt) == false)
                                                                             /* если не нашли накопленный купонный доход */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "CPFIRMID", V_STRING, Deals.CPFirmId) == false)
                                                                             /* если не нашли идентификатор фирмы партнера */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "REPOPERIOD", V_INTEGER, Deals.RepoPeriod) == false)
                                                                             /* если не нашли срок РЕПО */
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "REPORTTIME", V_TIME, Deals.TradeTime) == false)
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "TRADEMODEID", V_INTEGER, Deals.TradeModeId) == false)
                                                                           end;
                                                                           if(ReadTagAttribut(child_Security, "TRADEPERIOD", V_INTEGER, Deals.Session) == false)
                                                                             /* если не нашли клиринговую сессию */
                                                                           end;
                                                                           Deals.ClrAccCode = "";
                                                                           if(ReadTagAttribut(child_Security, "CLRACCCODE", V_STRING, Deals.ClrAccCode) == false)
                                                                           end;
                                                                           if( Deals.RepoPart == 1 )
                                                                             НайтиДанныеПо2Части(DataRepoArray, Deals.TradeNo, Deals.SettleDate, Deals.Amount, @Deals.RepoRate,
                                                                                                 @Deals.AccInt2, @Deals.Amount2, @Deals.Value2_, @Deals.Price2);

                                                                             /*проверяем, что это внебиржевые сделки*/
                                                                             if( IsOutExchangeREPO() )
                                                                               /*для внебиржевых сделок РЕПО все комиссии загружаем в ЗР по сделке*/
                                                                               if(ReadTagAttribut(child_Security, "EXCHCOMM", V_MONEY, Deals.ExhComm) == false)
                                                                               end;
                                                                               if(ReadTagAttribut(child_Security, "CLRCOMM", V_MONEY, Deals.ClrComm) == false)
                                                                               end;
                                                                             end;
                                                                           end;

                                                                           IsRun = true;
                                                                           if( (Deals.InfType == 1) AND (Deals.RepoPart == 2) AND 
                                                                               (not НевнутридневноеРЕПО(DataRepoArray_1, Deals.TradeNo)) 
                                                                             )
                                                                             IsRun = false;
                                                                           end;

                                                                           if( IsRun )
                                                                             /* вытащили все данные по сделке, теперь обработаем и вставим */
                                                                             if(RunImp())
                                                                               stat = 1;
                                                                             end;
                                                                           end;
                                                                         end;
                                                                       end;

                                                                     end;
                                                                   end;
                                                                   s = s + 1;
                                                                   if(GetDialogFlag())
                                                                     UseProgress(s);
                                                                   end;
                                                                   if( FlagCtrlBrk == true )
                                                                     break;
                                                                   end;
                                                                 end;
                                                                 if(GetDialogFlag())
                                                                   RemProgress();
                                                                 end;
                                                               end;
                                                             end;
                                                             m = m + 1;
                                                             if( FlagCtrlBrk == true )
                                                               break;
                                                             end;
                                                           end;
                                                         end;
                                                       end;
                                                       t = t + 1;
                                                       if( FlagCtrlBrk == true )
                                                         break;
                                                       end;
                                                     end;
                                                   end;
                                                 end;
                                                 e = e + 1;
                                                 if( FlagCtrlBrk == true )
                                                   break;
                                                 end;
                                               end;
                                             end;
                                           end;
                                           w = w + 1;
                                           if( FlagCtrlBrk == true )
                                             break;
                                           end;
                                         end;
                                       end;
                                     end;
                                     q = q + 1;
                                     if( FlagCtrlBrk == true )
                                       break;
                                     end;
                                   end;
                                 end;
                               end;
                             end;
                             l = l + 1;
                             if( FlagCtrlBrk == true )
                               break;
                             end;
                           end;
                         end;
                       end;
                       y = y + 1;
                       if( FlagCtrlBrk == true )
                         break;
                       end;
                     end;
                   end;
                 end;
                 k = k + 1;
                 if(GetDialogFlag())
                   UseProgress(k);
                 end;
                 if( FlagCtrlBrk == true )
                   break;
                 end;
               end;
               if(GetDialogFlag())
                 RemProgress(); 
               end;
             end;
           end;
           j = j + 1;
           if( FlagCtrlBrk == true )
             break;
           end;
         end;
       end;
     end;
     i = i + 1;
     if( FlagCtrlBrk == true )
       if(GetDialogFlag())
         RemProgress(); RemProgress();
       end;
       break;
     end;
   end;

   if( not FlagCtrlBrk )
     RG.Transfer();
     SetErrAfterLoad(true);
   end;

   /*загрузить в лог инфу о загруженных ЗР*/
   GetRecsAfterLoad_MFB06C();

   /* сообщаем о результатах загрузки */
   RGLog.Message( "Загрузка "+string(filename_MFB06C)+":"+
                  "\nВсего сделок, прошедших клиринг - " + string(NumImportDealsCliring) + 
                  "\n из них успешно - " + string(NumImportDealsTotalCliring) + 
                  "\n ошибочно - " + string(NumImportDealsCliring - NumImportDealsTotalCliring)
                );

   return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

/* получение данных о заявке */
PRIVATE MACRO PutRequestInfo()
   VAR ClientID = 0, ClientContrID = 0;
   VAR ErrStr = "";

   VAR FlagAbortTRN = false;
   MACRO Exit()
      FlagAbortTRN = true;
      AbortTRN;
   END;

   if(Req.ClientCode != "")
      if(GetRealID(RG_PARTY, Req.ClientCode, PTCK_SPBEX, @ClientID, @ErrStr,  true, PTSK_STOCKDL, Req.TradeDate, @ClientContrID, MarketID) != 0)
         ErrMes = "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\n" + ErrStr;
         RG = NULL;
         Exit();
      end;
   end;

   RG = TGTRecord( ВставкаЧерезКеш, SeanceID, NULL, RG_REQUEST, 
                   String("Заявка на сделку №" + Req.OrderNo),
                   Создать,
                   NULL,
                   NULL,
                   ClientID );

   if(NOT RG.InitByCode(RG_REQUEST, Req.OrderNo, SOURCE_CODE) )
      Exit();
   end;

   if( strlen(trim(string(Req.Quantity))) > 16 )
      ErrMes = ErrMes + "Ошибка при загрузке заявки на сделку № \"" + Req.OrderNo + "\"\nПревышено максимально возможное количество загружаемых знаков параметра Quantity";
      Exit();
   end;

   RG.SetParmByName("RGDLRQ_KIND",       350/*DOCKIND_REQ_CLIENT_DEAL*/);
   RG.SetParmByName("RGDLRQ_CODE",       Req.OrderNo);
   RG.SetParmByName("RGDLRQ_CODETS",     Req.OrderNo);
   RG.SetParmByName("RGDLRQ_DATE",       Req.TradeDate);
   RG.SetParmByName("RGDLRQ_TIME",       Req.EntryTime);
   RG.SetParmByName("RGDLRQ_PARTY",      SPB_Code);
   RG.SetParmByName("RGDLRQ_BUYSALE",    Req.BuySell);
   RG.SetParmByName("RGDLRQ_FIID",       Req.SecurityId); 
   RG.SetParmByName("RGDLRQ_AMOUNT",     Req.Quantity);
   RG.SetParmByName("RGDLRQ_PRICE",      Req.Price);
   RG.SetParmByName("RGDLRQ_REPORATE",   Req.RepoRate);
   RG.SetParmByName("RGDLRQ_STATUS",     Req.Status);
   RG.SetParmByName("RGDLRQ_PRICETYPE",  Req.PriceType);
   RG.SetParmByName("RGDLRQ_CURRENCYID", Req.CurrencyId);
   RG.SetParmByName("RGDLRQ_PRICEFIID",  Req.CurrencyId); // валюта цены = валюте расчетов
   RG.SetParmByName("RGDLRQ_ORDTYPECODE",Req.OrdTypeCode);
   RG.SetParmByName("RGDLRQ_ISADDRESS",  Req.IsAddress);
   RG.SetParmByName("RGDLRQ_CLIENT",     Req.ClientCode);
   RG.SetParmByName("RGDLRQ_GRNDNUM",  "");

   var TraderCode:string = GetTraderCodeSPB(Req.Commentar, Req.ClientCode);
   if(TraderCode != "") 
      RG.SetParmByName("RGDLRQ_TRADERCODE", TraderCode);
   end;

   if(RG.Save() != true)
      if(RG.GetLastError())
         ErrMes = ErrMes + "\n" + RG.GetLastError();
      end;
      Exit();
   end;

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      AbortTRN;
   else
      if(FlagAbortTRN == false)
         ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
         AbortTRN;
      end;
   end;
end;

PRIVATE MACRO import_request_to_gate(datafilename:STRING,filename:STRING):INTEGER
  var stat:integer = 0, m=0;
  var NumImportReq:integer = 0, NumImportReqTotal:integer = 0;
  var status:String, streason:String;
  var ImportedReq = TArray();
  FILE DataFile() txt 2048;

  private macro parseTime(s:String):time
    // HH:MM:SS:mmm
    var h:integer = 0;
    var m:integer = 0;
    var ss:integer = 0;
    var ms:integer = 0;
    var len:integer = strlen(s);
    if(len < 8)
        return Time(0,0,0,0);
    end;
    h = Int(SubStr(s,1,2));
    m = Int(SubStr(s,4,2));
    ss = Int(SubStr(s,7,2));
    if(len >= 11)
      ms = Int(SubStr(s,10,2));
    end;
    return Time(h,m,ss,ms);
  onerror
    return Time(0,0,0,0);
  end;

  private macro IsAlreadyImportedRequest(OrderNo:String):bool
    var s:integer = 0;

    while( s < ImportedReq.size )
      if( ImportedReq[s] == OrderNo )
        return true;
      end;
      s = s + 1;
    end;

    return false;
  end;

  private macro RunImp()
    ErrMes = "";

    NumImportReq = NumImportReq + 1;

    if(ProcessTrn( 0, "PutRequestInfo"))
        ImportedReq[ImportedReq.size] = Req.OrderNo;
        NumImportReqTotal = NumImportReqTotal + 1;
        RGLog.Message( "Заявка с кодом \"" + Req.OrderNo + "\" уcпешно загружена в шлюз" + ErrMes, RG, SUCCESS );
    else
        RGLog.Error( "Ошибка при загрузке заявки с кодом \"" + Req.OrderNo + "\"\n" + ErrMes, RG );
        return 1;
    end;
    return 0;

  OnError(ErObj)

    RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

    if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
    else
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
    end;
    return ErObj.Code;
  end;

  Req.Init();

  NumImportReq = 0;
  NumImportReqTotal = 0;

  /* откроем файл импорта */
  if( not Open( DataFile, datafilename,"rsansi" ))
    RGLog.Error(string( "Невозможно загрузить txt-документ|", datafilename));
    return;
  end;
  /* считаем параметры заявок */
  SetDelim( "\t" );
  Rewind( DataFile );
  while( Next( DataFile ))
    DataFile.str = RGDLFUN_CorrectString( DataFile.str );
    
    if( (trim(DataFile(F_ACTION)) != "New") and (not IsAlreadyImportedRequest(DataFile(F_REG_NO))) )
      Req.InitRecords();
      Req.OrderNo = DataFile(F_REG_NO);
      Req.TradeDate = Date(DataFile(F_ENTRY_DATE));
      Req.EntryTime = ParseTime(DataFile(F_ENTRY_TIME));
      Req.ClientCode = DataFile(F_CLIENT_ALIAS);
      Req.BuySell = DataFile(F_BUY_SELL);
      Req.IsAddress  = DataFile(F_IS_ADDRESS);
      Req.SecurityId = DataFile(F_SECURITYID);
      Req.PriceFIID  = DataFile(F_QUOTE_CURRENCY);
      Req.CurrencyId = DataFile(F_CURRENCY);
      Req.Price = Double(DataFile(F_PRICE));
      Req.RepoRate = Double(DataFile(F_REPO_PRICE));
      Req.Quantity = Money(DataFile(F_QUANTITY));
      Req.Commentar = DataFile(F_COMMENT);
    
      Status	= trim(DataFile(F_STATUS));
      if((Status == "NEW") OR (Status == "FILLED") OR (Status == "PARTFILLED"))
        Req.Status = "M";
      elif((Status == "CANCELLED") OR (Status == "PARTCANCELLED"))
        streason = trim(DataFile(F_STATUS_REASON));
        if((streason == "USER_CANCEL") OR (streason == "USER_MASS_CANCEL") OR
           (streason == "BROKER_CANCEL") OR (streason == "BROKER_MASS_CANCEL"))
            Req.Status = "W";
        elif( (streason == "CTRPARTY_DECLINE") OR (streason == "EXPIRED_CROSSTRADE") OR (streason == "EXPIRED_ORDERBOOK_CROSS"))
            Req.Status = "F";
        else
            Req.Status = "C";
        end;
      else
        Req.Status = "";
      end;
    
      Req.OrdTypeCode = "";
      Req.PriceType = "CASH";
    
      if((Req.ClientCode != "") and (Index(Req.Commentar, "mc") == 0)) //biq-9103 поручения Margin Call не загружаем
        if( RunImp() )
            stat = 1;
        end;
      end;
    end;
  end;

  Close( DataFile );

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано заявок из "+string(filename)+" - " + string(NumImportReq) + "\nиз них успешно - " + string(NumImportReqTotal) + "\nошибочно - " + string(NumImportReq - NumImportReqTotal));

  return stat;

OnError( RslErrObj )
   RemProgress();RemProgress();
   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
END;

macro import_incREPO_to_gate_from_MFB98(datafilename:STRING):INTEGER

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportIncREPO:integer = 0, NumImportIncREPOTotal:integer = 0;
  var node:object, child_RtsDoc:object, child_REPORT:object, child_FIRM:object, child_SETTLE:object, child_GROUP:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, l:integer = 0, n:integer = 0;
  var Type = "", DebitCredit = "", EntryDate = date(0,0,0);
  var NumImportDvdREPO:integer = 0, NumImportDvdREPOTotal:integer = 0;
  var ExtSettleCodeID = "";

  private macro RunImpMoneyMotion()
      ErrMes = "";

      NumImportIncREPO = NumImportIncREPO + 1;

     if( ProcessTrn(0, "PutMoneyMotion") )
        NumImportIncREPOTotal = NumImportIncREPOTotal + 1;
        RGLog.Message("Успешно загружены Т/О по передаче дохода по РЕПО с кодом \"" + MoneyMotion.EntryNumber + "\"\n" + ErrMes, RG, SUCCESS);
     else
        RGLog.Error("Ошибка при загрузке Т/О по передаче дохода по РЕПО с кодом \"" + MoneyMotion.EntryNumber + "\"\n" + ErrMes, RG);
        return 1;
     end;
      return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  MoneyMotion.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;
  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
    child_RtsDoc = node.childNodes.item(i);
    if( child_RtsDoc and (child_RtsDoc.nodeType == CHILD_NODE) )
      if( StrUpr(child_RtsDoc.tagname) == "REPORT" )
        EntryDate = date(0,0,0);
        if( ReadTagAttribut(child_RtsDoc, "REPORTDATE", V_DATE, EntryDate) == false )
          /* если не нашли дату формирования отчета */
        end;
        j = 0;
        while( j < child_RtsDoc.childNodes.length ) /* бегаем по REPORT */
          child_REPORT = child_RtsDoc.childNodes.item(j);
          if( child_REPORT and (child_REPORT.nodeType == CHILD_NODE) )
            if( StrUpr(child_REPORT.tagname) == "FIRM" )
              k = 0;
              while( k < child_REPORT.childNodes.length ) /* бегаем по FIRM */
                child_FIRM = child_REPORT.childNodes.item(k);
                if( child_FIRM and (child_FIRM.nodeType == CHILD_NODE) )
                  if( StrUpr(child_FIRM.tagname) == "SETTLE" )
                    l = 0;
                    while( l < child_FIRM.childNodes.length ) /* бегаем по SETTLE */
                      child_SETTLE = child_FIRM.childNodes.item(l);
                      if( child_SETTLE and (child_SETTLE.nodeType == CHILD_NODE) )
                        if( StrUpr(child_SETTLE.tagname) == "GROUP" )
                          ExtSettleCodeID = "";
                          if( ReadTagAttribut(child_SETTLE, "BANKACCCODE", V_STRING, ExtSettleCodeID) == false )
                            /* если не нашли расчетный код участника клиринга */
                          end;
                          if(GetDialogFlag())
                            InitProgress(child_SETTLE.childNodes.length, "Загрузка внешнего файла данных Т/О по передаче дохода по РЕПО", "Просмотр записей...");
                          end;
                          n = 0;
                          while( n < child_SETTLE.childNodes.length )
                            child_GROUP = child_SETTLE.childNodes.item(n);
                            if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                              if( StrUpr(child_GROUP.tagname) == "RECORDS" )
                                Type = "";
                                if( ReadTagAttribut(child_GROUP, "TYPE", V_STRING, Type) == false )
                                end;
                                DebitCredit = "";
                                if( ReadTagAttribut(child_GROUP, "DEBITCREDIT", V_STRING, DebitCredit) == false )
                                end;
                                if( (pp.IncREPO == SET_CHAR) and (StrUpr(Type) == "COUPON_PAYMENT") )
                                  MoneyMotion.ExtSettleCodeID = ExtSettleCodeID;
                                  MoneyMotion.InitRecords();
                                  MoneyMotion.EntryCodeType = 9999;/*спецномер для переводов вида <Возврат дохода контрагенту по сделке обратного РЕПО> и <Получение дохода от контрагента по сделке прямого РЕПО>*/
                                  MoneyMotion.EntryDate = EntryDate;
                                  if( ReadTagAttribut(child_GROUP, "TRADENO", V_STRING, MoneyMotion.EntryNumber) == false )
                                  end;
                                  if( ReadTagAttribut(child_GROUP, "CLIENTCODE", V_STRING, MoneyMotion.ClientCode) == false )
                                  end;
                                  if( ReadTagAttribut(child_GROUP, "CURRENCYID", V_STRING, MoneyMotion.CurrencyId) == false )
                                  end;
                                  if( DebitCredit == "D" )
                                    if( ReadTagAttribut(child_GROUP, "SUM", V_MONEY, MoneyMotion.EntryDebit) == false )
                                    end;
                                  else
                                    if( ReadTagAttribut(child_GROUP, "SUM", V_MONEY, MoneyMotion.EntryCredit) == false )
                                    end;
                                  end;

                                  if( MoneyMotion.ClientCode != "" )
                                    if( RunImpMoneyMotion() )
                                      stat = 1;
                                    end;
                                  end;
                                end;
                              end;
                            end;
                            n = n + 1;
                            if( GetDialogFlag() )
                              UseProgress(n);
                            end;
                            if( FlagCtrlBrk == true )
                              break;
                            end;
                          end;
                          if( GetDialogFlag() )
                            RemProgress(); 
                          end;
                        end;
                      end;
                      l = l + 1;
                    end;
                  end;
                end;
                k = k + 1;
              end;
            end;
          end;
          j = j + 1;
        end;
      end;
    end;
    i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  if(pp.IncREPO == SET_CHAR)
     RGLog.Message("Всего обработано Т/О по передаче дохода по РЕПО - " + string(NumImportIncREPO) + "\nиз них успешно - " + string(NumImportIncREPOTotal) + "\nошибочно - " + string(NumImportIncREPO - NumImportIncREPOTotal));
  end;

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
END;

PRIVATE MACRO PutNettoInfo()

  var FlagAbortTRN = false;

  macro Exit()
     FlagAbortTRN = true;
     AbortTRN;
  end;

  RG = TGTRecord( ВставкаЧерезКеш,
                  RGLog.SeanceID,
                  NULL,
                  RG_DLITOGCLVR,
                  "Нетто-требование/нетто-обязательство на " + NettoItog.Currency + " с кодом ТКС " + NettoItog.ExtCode + " на " + string(NettoItog.ReportDate),
                  Создать );

  if( not RG.InitByCode(RG_DLITOGCLVR, "MFB13" + "_" + NettoItog.ExtCode + "_" + NettoItog.Currency + "_" + string(NettoItog.ReportDate), SOURCE_CODE) )
     AbortTRN;
  end;

  RG.SetParmByName("RGDLICVR_TYPE",     "MFB13");
  RG.SetParmByName("RGDLICVR_DATE",     NettoItog.ReportDate);
  RG.SetParmByName("RGDLICVR_EXTCODE",  NettoItog.ExtCode);
  RG.SetParmByName("RGDLICVR_CURRENCY", NettoItog.Currency);
  RG.SetParmByName("RGDLICVR_NETTOSUM", NettoItog.NettoSum); 

  if( RG.Save() != true )
     if( RG.GetLastError() )
        ErrMes = ErrMes + "\n" + RG.GetLastError();
     end;
     Exit();
  end;

OnError(ErObj)
  if( ErObj.Code == CtrlBrkErr )
     FlagCtrlBrk = true;
     AbortTRN;
  else
     if( FlagAbortTRN == false )
        RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError(), RG);
     end;
  end;
END;

PRIVATE MACRO import_netto_to_gate_from_MFB13(datafilename:STRING):INTEGER

  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var NumImportNetto:integer = 0, NumImportNettoTotal:integer = 0;
  var node:object, child_RtsDoc:object, child_REPORT:object, child_FIRM:object, child_CLEARINGTYPE:object, child_SESSION:object, child_SETTLE:object, child_POSTYPES:object, child_GROUP:object;
  var i:integer = 0, j:integer = 0, k:integer = 0, l:integer = 0, m:integer = 0, n:integer = 0, q:integer = 0, r:integer = 0;

  private macro RunImp()
      ErrMes = "";
      var CodeNettoItog = NettoItog.ExtCode + "_" + NettoItog.Currency + "_" + string(NettoItog.ReportDate);      

      NumImportNetto = NumImportNetto + 1;

     if( ProcessTrn(0, "PutNettoInfo") )
        NumImportNettoTotal = NumImportNettoTotal + 1;
        RGLog.Message("Успешно загружены итоговые нетто-требования и нетто-обязательства \"" + CodeNettoItog + "\"\n" + ErrMes, RG, SUCCESS);
     else
        RGLog.Error("Ошибка при загрузке итоговых нетто-требований и нетто-обязательств \"" + CodeNettoItog + "\"\n" + ErrMes, RG);
        return 1;
     end;
      return 0;

  OnError(ErObj)
     RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  NettoItog.Init();

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;

  /*заполним массивы данных из файла*/
  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
     child_RtsDoc = node.childNodes.item(i);
     if( child_RtsDoc and (child_RtsDoc.nodeType == CHILD_NODE) )
        if( StrUpr(child_RtsDoc.tagname) == "REPORT" )
           NettoItog.ReportDate = date(0,0,0);
           if( ReadTagAttribut(child_RtsDoc, "REPORTDATE", V_DATE, NettoItog.ReportDate) == false )
              /* если не нашли дату формирования отчета */
           end;
           j = 0;
           while( j < child_RtsDoc.childNodes.length ) /* бегаем по REPORT */
              child_REPORT = child_RtsDoc.childNodes.item(j);
              if( child_REPORT and (child_REPORT.nodeType == CHILD_NODE) )
                 if( StrUpr(child_REPORT.tagname) == "FIRM" )
                    k = 0;
                    while( k < child_REPORT.childNodes.length ) /* бегаем по FIRM */
                       child_FIRM = child_REPORT.childNodes.item(k);
                       if( child_FIRM and (child_FIRM.nodeType == CHILD_NODE) )
                          if( StrUpr(child_FIRM.tagname) == "CLEARINGTYPE" )
                             l = 0;
                             while( l < child_FIRM.childNodes.length ) /* бегаем по CLEARINGTYPE */
                                child_CLEARINGTYPE = child_FIRM.childNodes.item(l);
                                if( child_CLEARINGTYPE and (child_CLEARINGTYPE.nodeType == CHILD_NODE) )
                                   if( StrUpr(child_CLEARINGTYPE.tagname) == "SESSION" )
                                      NettoItog.FinalObligations = "";
                                      if( ReadTagAttribut(child_CLEARINGTYPE, "FINALOBLIGATIONS", V_STRING, NettoItog.FinalObligations) == false )
                                         /* если не нашли признак нетто-обязательств, определенных до процедуры урегулирования нехватки активов для поставки */
                                      end;
                                      if( NettoItog.FinalObligations == "Y" ) // Из файла импортируются данные уровня SESSION, для которого параметр "FinalObligations" принимает значение "Y"
                                         m = 0;
                                         while( m < child_CLEARINGTYPE.childNodes.length ) /* бегаем по SESSION */
                                            child_SESSION = child_CLEARINGTYPE.childNodes.item(m);
                                            if( child_SESSION and (child_SESSION.nodeType == CHILD_NODE) )
                                               if( StrUpr(child_SESSION.tagname) == "SETTLE" )
                                                  NettoItog.ExtCode = "";
                                                  if( ReadTagAttribut(child_SESSION, "CLRACCCODE", V_STRING, NettoItog.ExtCode) == false )
                                                     /* если не нашли расчетный код участника клиринга */
                                                  end;
                                                  n = 0;
                                                  while( n < child_SESSION.childNodes.length ) /* бегаем по SETTLE */
                                                     child_SETTLE = child_SESSION.childNodes.item(n);
                                                     if( child_SETTLE and (child_SETTLE.nodeType == CHILD_NODE) )
                                                        if( StrUpr(child_SETTLE.tagname) == "POSTYPES" )
                                                           NettoItog.PosType = "";
                                                           if( ReadTagAttribut(child_SETTLE, "POSTYPE", V_STRING, NettoItog.PosType) == false )
                                                              /* если не нашли тип информации: по денежной позиции или по депозитарному разделу */
                                                           end;
                                                           if( NettoItog.PosType == "C" ) // Из отчета загружаются данные узлов <PosTypes>, в которых значение параметра PosType равно "C"
                                                              q = 0;
                                                              while( q < child_SETTLE.childNodes.length ) /* бегаем по POSTYPES */
                                                                 child_POSTYPES = child_SETTLE.childNodes.item(q);
                                                                 if( child_POSTYPES and (child_POSTYPES.nodeType == CHILD_NODE) )
                                                                    if( StrUpr(child_POSTYPES.tagname) == "GROUP" )
                                                                       if(GetDialogFlag())
                                                                          InitProgress(child_POSTYPES.childNodes.length, "Загрузка внешнего файла итогов по ФИ", "Просмотр записей...");
                                                                       end;
                                                                       r = 0;
                                                                       while( r < child_POSTYPES.childNodes.length ) /* бегаем по GROUP */
                                                                          child_GROUP = child_POSTYPES.childNodes.item(r);
                                                                          if( child_GROUP and (child_GROUP.nodeType == CHILD_NODE) )
                                                                             if( StrUpr(child_GROUP.tagname) == "RECORDS" )
                                                                                NettoItog.InitRecords();
                                                                                if( ReadTagAttribut(child_GROUP, "CURRENCYID", V_STRING, NettoItog.Currency) == false )
                                                                                   /* если не нашли идентификатор валюты / драгоценного металла */
                                                                                end;                      
                                                                                if( ReadTagAttribut(child_GROUP, "DEBIT", V_STRING, NettoItog.Debit) == false )
                                                                                   /* если не нашли нетто-обязательство */
                                                                                end;
                                                                                if( ReadTagAttribut(child_GROUP, "CREDIT", V_STRING, NettoItog.Credit) == false )
                                                                                   /* если не нашли нетто-требование */
                                                                                end;
                                                                                NettoItog.NettoSum = NettoItog.Credit - NettoItog.Debit;
                                                           
                                                                                if( RunImp() )
                                                                                   stat = 1;
                                                                                end;
                                                                             end;
                                                                          end;
                                                                          r = r + 1;
                                                                          if( GetDialogFlag() )
                                                                             UseProgress(r);
                                                                          end;
                                                                          if( FlagCtrlBrk == true )
                                                                             break;
                                                                          end;
                                                                       end;
                                                                       if( GetDialogFlag() )
                                                                          RemProgress(); 
                                                                       end;
                                                                    end;
                                                                 end;
                                                                 q = q + 1;
                                                              end;
                                                           end;
                                                        end;
                                                     end;
                                                     n = n + 1;
                                                  end;
                                               end;
                                            end;
                                            m = m + 1;
                                         end;
                                      end;
                                   end;
                                end;
                                l = l + 1;
                             end;
                          end;
                       end;
                       k = k + 1;
                    end;
                 end;
              end;
              j = j + 1;
           end;
        end;
     end;
     i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано итогов по ФИ - " + string(NumImportNetto) + "\nиз них успешно - " + string(NumImportNettoTotal) + "\nошибочно - " + string(NumImportNetto - NumImportNettoTotal));

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
END;

/* обработка параметров котировки */
MACRO PutRateInfo()

  var strObject = "", MMVB_NumSection, SecType, CurRate, IsDominant, IsRelative;

  VAR FlagAbortTRN = false;
  MACRO Exit()
    FlagAbortTRN = true;
    AbortTRN;
  END;

  if(Rates.TradeDate != date(0,0,0))
    strObject = String("Котировка финансового инструмента " + Rates.SecurityId + " на ") + string(Rates.TradeDate) + " (СПБ)";
  else          
    strObject = String("Котировка финансового инструмента " + Rates.SecurityId + " на ") + string(imp_date) + "(СПБ)";
  end;

  RG = TGTRecord(ВставкаЧерезКеш,
                 RGLog.SeanceID,
                 NULL,
                 RG_RATE,
                 strObject,
                 Создать );

  if(NOT RG.InitByCode( RG_RATE, CodeRate, SOURCE_CODE ))
    AbortTRN;
  end;

  RG.SetParmByName( "RGFIRT_BOARDID", Rates.BoardID );

  RG.SetParmByName( "RGFIRT_ISIN_ISO", Rates.SecurityId );

  RG.SetParmByName( "RGFIRT_FOR_CB", SET_CHAR);

  RG.SetParmByName( "RGFIRT_RATEKIND", RateKind_ );

  SecType = StrUpr(Rates.SecurityType);

  if( RateKind_ == RATE_KIND_MARKET )
    IsDominant = SET_CHAR;
  else
    IsDominant = UNSET_CHAR;
  end;

  if( (Rates.CurrencyId == "PCT") and (RateKind_ != RATE_KIND_NKD1SEC) )
    IsRelative = SET_CHAR;
  else
    IsRelative = UNSET_CHAR;
  end;

  if( Rates.CurrencyId == "PCT" )
    CurRate = Rates.SecCurrencyId;
  else
    CurRate = Rates.CurrencyId;
  end;

  if( (in(SecType, 
          AVRKIND_BOND_STATE, 
          AVRKIND_BOND_MUNICIPAL, 
          AVRKIND_BOND_CB,
          AVRKIND_BOND_CORPORATE,
          AVRKIND_BOND_CREDIT,
          AVRKIND_BOND_EXCHANGE)) and (RateKind_ != RATE_KIND_NKD1SEC) )  //По сути избыточный блок, но пусть остается для соответствия ТЗ
    IsRelative = SET_CHAR;

    if( (RateKind_ == RATE_KIND_MARKET) or (RateKind_ == RATE_KIND_MARKET_TAX) )
      CurRate = Rates.SecCurrencyId;
    end;
  end;

  RG.SetParmByName("RGFIRT_ISRELATIVE", IsRelative);

  RG.SetParmByName( "RGFIRT_CURR_RATE", CurRate);

  RG.SetParmByName( "RGFIRT_TCC_FLAG", -1);

  RG.SetParmByName( "RGFIRT_RATE_ISREALID", UNSET_CHAR);

  RG.SetParmByName( "RGFIRT_FINCODEKIND", Код_на_СПБ_ФинИн);

  RG.SetParmByName( "RGFIRT_ISDOMINANT", IsDominant);

  RG.SetParmByName( "RGFIRT_ISINVERSE", UNSET_CHAR);
  RG.SetParmByName( "RGFIRT_SCALE", 1);

  if(Rates.TradeDate != date(0,0,0))
    imp_date = Rates.TradeDate;
  end;

  RG.SetParmByName( "RGFIRT_SINCEDATE", imp_date);

  if(RateKind_   == RATE_KIND_MARKET)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MarketPrice3, Rates.Decimals));
  elif(RateKind_ == RATE_KIND_MIN)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MinDealPrice, Rates.Decimals));
  elif(RateKind_ == RATE_KIND_MAX)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MaxDealPrice, Rates.Decimals));
  elif(RateKind_ == RATE_KIND_WA)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.WAPrice, Rates.Decimals));
  elif(RateKind_ == RATE_KIND_NKD1SEC)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.AccruedInterest, Rates.Decimals));
  elif(RateKind_ == RATE_KIND_VOLUME)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.TotalAmount, Rates.Decimals));
  elif(RateKind_ == RATE_KIND_MARKET_TAX)
    RG.SetParmByName( "RGFIRT_RATE", ЧислоСтрокой(Rates.MarketPrice3, Rates.Decimals));
  end;

  if( RateKind_ == RATE_KIND_MARKET_TAX)
    RG.SetParmByName( "RGFIRT_MPVALTRD", Rates.MarketPrice3);
  end;

  RG.SetParmByName( "RGFIRT_PARTYCODEKIND", Код_на_СПБ_Субъект);

  RG.SetParmByName( "RGFIRT_MARKETPLACE", string(SPB_Code));

  RG.SetParmByName( "RGFIRT_MARKETOFFICE", 0 /*SPB_NumSection*/);

  /*точность*/
  RG.SetParmByName("RGFIRT_POINT", Rates.Decimals);

  RG.SetParmByName( "RGFIRT_FACEVALUE", Rates.FaceValue);

  if(RG.Save() != true)
    if(RG.GetLastError())
      ErrMes = ErrMes + "\n" + RG.GetLastError();
    end;
    Exit();
  end;

OnError(ErObj)
  if(ErObj.Code == CtrlBrkErr)
    FlagCtrlBrk = true;
    AbortTRN;
  else
    if(FlagAbortTRN == false)
      ErrMes = "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message + "\n" + RG.GetLastError();
      AbortTRN;
    end;
  end;
END;

/* настраиваемый пользователем макрос формирования кода котировки ц/б в шлюзе*/
PRIVATE MACRO get_rate_cb_code( RateKind, RateMarketPlace )
   if(Rates.TradeDate != date(0,0,0))
      return string(Rates.SecurityId) + "_" + string(RateKind) + "_" + string(Rates.TradeDate) + "_" + string(RateMarketPlace) + "_" + string(Rates.BoardID);
   else
      return string(Rates.SecurityId) + "_" + string(RateKind) + "_" + string(imp_date) + "_" + string(RateMarketPlace) + "_" + string(Rates.BoardID);
   end;
END;

private macro WriteRateData(RateKind)

   ErrMes = "";
   NumImportRates = NumImportRates + 1;

   CodeRate = get_rate_cb_code( RateKind, string(SPB_Code));
   RateKind_ = RateKind;

   if(ProcessTrn(0, "PutRateInfo") )
      NumImportRatesTotal = NumImportRatesTotal + 1;
      RGLog.Message( "Успешно загружена котировка \"" + CodeRate + "\"\n" + ErrMes, RG, SUCCESS );
      return true;
   else
      RGLog.Error( "Ошибка при загрузке котировки \"" + CodeRate + "\"\n" + ErrMes, RG  );
      return false;
   end;
   ErrMes = "";

OnError(ErObj)
   if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
      return true; 
   end;
end;

PRIVATE MACRO import_rates_to_gate_from_SPB21(datafilename:STRING):INTEGER
  var stat:integer = 0;
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var i, j, k, l;
  var node:object, child_RtsDoc:object, child_Report:object, child_Board:object, child_Security:object;
  var DOC_REQUISITES = false, REPORT = false;
  var BoardId;

  private macro RunImp(RateKind)
    /* сохранение информации о курсе в промежуточном файле */
    if(WriteRateData(RateKind) != true)
      return 1;
    end;

    return 0;

  OnError(ErObj)

    RGLog.Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

    if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
    else
      RemProgress();
      RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
    end;
    return ErObj.Code;
  end;

  Rates.Init();

  NumImportRates = 0;
  NumImportRatesTotal = 0;

  /* откроем файл импорта */
  if( not xml.load(datafilename) )
     RGLog.Error(string( "Неверный формат файла импорта|", datafilename, "|Невозможно загрузить xml-документ" ));
     return 1;
  end;

  node = xml.DocumentElement;
  i = 0;
  while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
    child_RtsDoc = node.childNodes.item(i);
    if( child_RtsDoc and (child_RtsDoc.nodeType == CHILD_NODE) )
      if(child_RtsDoc.tagname == "DOC_REQUISITES")
        if(DOC_REQUISITES)
          RGLog.Error(string(datafilename, ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
          return false;
        end;
        DOC_REQUISITES = true;
      end;

      if( StrUpr(child_RtsDoc.tagname) == "REPORT" )
        if(REPORT)
          RGLog.Error(string(datafilename, ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
          return false;
        end;
        REPORT = true;

        Rates.TradeDate = date(0,0,0);
        if( ReadTagAttribut(child_RtsDoc, "TRADEDATE", V_DATE, Rates.TradeDate) == false )
          /* если не нашли дату торгов */
        end;

        if(GetDialogFlag())
          InitProgress(child_RtsDoc.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр групп торговых инструментов...");
        end;
        j = 0;
        while( j < child_RtsDoc.childNodes.length )
          child_Report = child_RtsDoc.childNodes(j);
          if( child_Report and (child_Report.nodeType == CHILD_NODE) )
            if( StrUpr(child_Report.tagname) == "BOARD" )

              Rates.BoardID = "";
              if( ReadTagAttribut(child_Report, "BOARDID", V_STRING, Rates.BoardID) == false )
              end;

              if(GetDialogFlag())
                InitProgress(child_Report.childNodes.length, Rates.BoardID, "Просмотр записей котировок...");
              end;

              k = 0;
              while(k < child_Report.childNodes.length )
                child_Board = child_Report.childNodes(k);
                if( child_Board and (child_Board.nodeType == CHILD_NODE) )
                  if( StrUpr(child_Board.tagname) == "SECURITY" )
                    Rates.InitRecords();
                    if( ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Rates.SecurityId) == false )
                      /* если не нашли идентификатор инструмента */
                    end;
                    if( ReadTagAttribut(child_Board, "FACEVALUE", V_DOUBLE, Rates.FaceValue) == false )
                      /* если не нашли номинал */
                    end;
                    if( ReadTagAttribut(child_Board, "SECCURRENCYID", V_STRING, Rates.SecCurrencyId) == false )
                      /* если не нашли валюту номинала */
                    end;
                    if( ReadTagAttribut(child_Board, "SECURITYTYPE", V_STRING, Rates.SecurityType) == false )
                      /* если не нашли вид и тип ц/б */
                    end;
                    if( ReadTagAttribut(child_Board, "DECIMALS", V_INTEGER, Rates.Decimals) == false )
                      /* если не нашли число значимых знаков после запятой в ценах */
                    end;
                    if( ReadTagAttribut(child_Board, "CURRENCYID", V_STRING, Rates.CurrencyId) == false )
                      /* если не нашли код валюты цены */
                    end;
                    if( ReadTagAttribut(child_Board, "ACCRUEDINTEREST", V_DOUBLE, Rates.AccruedInterest) == false )
                      /* если не нашли НКД на дату отчета */
                    end;

                    l = 0;
                    while( l < child_Board.childNodes.length )
                      child_Security = child_Board.childNodes(l);
                      if( child_Security and (child_Security.nodeType == CHILD_NODE) )
                        if( StrUpr(child_Security.tagname) == "RESULT" )
                          if( ReadTagAttribut(child_Security, "TOTALAMOUNT", V_DOUBLE, Rates.TotalAmount) == false )
                            /* если не нашли общее количество ц/б по заключенным Договорам за Торговый день в Режиме основных торгов */
                          end;
                          if( ReadTagAttribut(child_Security, "MAXDEALPRICE", V_DOUBLE, Rates.MaxDealPrice) == false )
                            /* если не нашли максимальную цену договоров за день */
                          end;
                          if( ReadTagAttribut(child_Security, "MINDEALPRICE", V_DOUBLE, Rates.MinDealPrice) == false )
                            /* если не нашли минимальную цену договоров за день */
                          end;
                          if( ReadTagAttribut(child_Security, "WAPRICE", V_DOUBLE, Rates.WAPrice) == false )
                            /* если не нашли средневзвешенную цену */
                          end;
                          if( ReadTagAttribut(child_Security, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice3) == false )
                            /* если не нашли рыночную цену 3 */
                          end;

                          if(RunImp(RATE_KIND_MARKET))
                            stat = 1;
                          end;
                          if(RunImp(RATE_KIND_MIN))
                            stat = 1;
                          end;
                          if(RunImp(RATE_KIND_MAX))
                            stat = 1;
                          end;
                          if(RunImp(RATE_KIND_WA))
                            stat = 1;
                          end;
                          if(RunImp(RATE_KIND_NKD1SEC))
                            stat = 1;
                          end;
                          if(RunImp(RATE_KIND_VOLUME))
                            stat = 1;
                          end;
                          if(RunImp(RATE_KIND_MARKET_TAX))
                            stat = 1;
                          end;
                        end;
                      end;
                      l = l + 1;
                    end;
                  end;
                end;
                k = k + 1;
                if(GetDialogFlag())
                  UseProgress(k);
                end;
                if( FlagCtrlBrk == true )
                  break;
                end;
              end;
              if(GetDialogFlag())
                RemProgress(); 
              end;
            end;
          end;
          j = j + 1;
          if(GetDialogFlag())
            UseProgress(j);
          end;
          if( FlagCtrlBrk == true )
            break;
          end;
        end;
        if(GetDialogFlag())
          RemProgress(); 
        end;
      end;
    end;
    i = i + 1;
  end;

  /* сообщаем о результатах загрузки */
  RGLog.Message("Всего обработано котировок - " + string(NumImportRates) + "\nиз них успешно - " + string(NumImportRatesTotal) + "\nошибочно - " + string(NumImportRates - NumImportRatesTotal));

  return stat;

OnError( RslErrObj )
  RemProgress();
  MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
  RunError;
END;

private class MFB99_ClirToClirRecord(_Debit, _Credit, _Account)
  var Debit   = _Debit;
  var Credit  = _Credit;
  var Account = _Account;
end;

private var MFB99_ClirToClirRecords = TArray();

private macro MFB99_GetClirToClirRecords(settle_child : object)
  MFB99_ClirToClirRecords.size = 0;

  var BankAccCode   = "";
  var OperationCode = "";
  var Debit         = 0.0;
  var Credit        = 0.0;

  var i = 0;
  while (i < settle_child.childNodes.length)

    var postypes_child = settle_child.childNodes.item(i);
    ReadTagAttribut(postypes_child, "BANKACCCODE", V_STRING, BankAccCode);

    var j = 0;
    while (j < postypes_child.childNodes.length)

      var group_child = postypes_child.childNodes.item(j);

      var k = 0;
      while (k < group_child.childNodes.length)

        var records_child = group_child.childNodes.item(k);
        ReadTagAttribut(records_child, "OPERATIONCODE", V_STRING,  OperationCode);
        ReadTagAttribut(records_child, "DEBIT",         V_NUMERIC, Debit);
        ReadTagAttribut(records_child, "CREDIT",        V_NUMERIC, Credit);

        if (OperationCode == 2)
          MFB99_ClirToClirRecords[MFB99_ClirToClirRecords.size] = MFB99_ClirToClirRecord(Debit, Credit, BankAccCode);
        end;

        k = k + 1;
      end;

      j = j + 1;
    end;

    i = i + 1;
  end;
end;

private macro MFB99_GetOtherClirAcc(Debit : money, Credit : money, Account : string) : string
  var other_clir_account = "";

  var i = 0;
  while (i < MFB99_ClirToClirRecords.size)
    var _record = MFB99_ClirToClirRecords[i];

    if (_record.Account != Account)
      if ((_record.Debit == Debit) or (_record.Credit == Credit))
        other_clir_account = _record.Account;
        break;
      end;
    end;

    i = i + 1;
  end;

  return other_clir_account;
end;

private macro import_cash_flows_to_gate_from_MFB99(filename : string) : integer
  var stat = 0;

  private macro RunImp()
    ErrMes = "";
    WarnMes = "";
    if (ProcessTrn(0, "PutMoneyMotion"))
      RGLog.Message("Движение денежных средств с номером \"" + MoneyMotion.EntryNumber + "\" уcпешно загружено в шлюз" + ErrMes, RG, SUCCESS);
    else
      RGLog.Error("Ошибка при вставке движения денежных средств\n" + ErrMes, RGMkRep);
      return 1;
    end;
    return 0;

    OnError(ErObj)
      RGLog.Error("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);

      if (ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
      else
        RemProgress();
        RunError("Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message);
      end;
      return ErObj.Code;
  end;

  var xml = ActiveX("MSXML.DOMDocument");
  if (not xml.load(filename))
    RGLog.Error(string("Неверный формат файла импорта|", filename, "|Невозможно загрузить xml-документ"));
    return;
  end;

  var ReportDate     = date(0, 0, 0);
  var ReportNumber   = "";
  var ClrAccCode     = "";
  var PosType        = "";
  var BankAccCode    = "";
  var OpeningBalance = 0.0;
  var OperationCode  = "";
  var Debit          = 0.0;
  var Credit         = 0.0;
  var Currency       = "";

  MoneyMotion.Init();

  var node = xml.DocumentElement;

  var i = 0;
  while (i < node.childNodes.length)
    var rts_doc_child = node.childNodes.item(i);
    if (rts_doc_child and (rts_doc_child.nodeType == CHILD_NODE) and (rts_doc_child.tagname == "REPORT"))

      ReadTagAttribut(rts_doc_child, "REPORTDATE",   V_DATE,   ReportDate);
      ReadTagAttribut(rts_doc_child, "REPORTNUMBER", V_STRING, ReportNumber);

      var j = 0;
      while (j < rts_doc_child.childNodes.length)

        var report_child = rts_doc_child.childNodes.item(j);

        var k = 0;
        while (k < report_child.childNodes.length)

          var firm_child = report_child.childNodes.item(k);
          ReadTagAttribut(firm_child, "CLRACCCODE", V_STRING, ClrAccCode);

          var l = 0;
          while (l < firm_child.childNodes.length)

            var settle_child = firm_child.childNodes.item(l);
            ReadTagAttribut(settle_child, "POSTYPE", V_STRING, PosType);

            if (PosType == "C")
              MFB99_GetClirToClirRecords(settle_child);

              var m = 0;
              while (m < settle_child.childNodes.length)

                var postypes_child = settle_child.childNodes.item(m);
                ReadTagAttribut(postypes_child, "BANKACCCODE", V_STRING, BankAccCode);

                var n = 0;
                while (n < postypes_child.childNodes.length)

                  var group_child = postypes_child.childNodes.item(n);
                  ReadTagAttribut(group_child, "OPENINGBALANCE", V_NUMERIC, OpeningBalance);
                  ReadTagAttribut(group_child, "CURRENCYID", V_STRING, Currency);

                  var o = 0;
                  while (o < group_child.childNodes.length)

                    var records_child = group_child.childNodes.item(o);
                    ReadTagAttribut(records_child, "OPERATIONCODE", V_STRING,  OperationCode);
                    ReadTagAttribut(records_child, "DEBIT",         V_NUMERIC, Debit);
                    ReadTagAttribut(records_child, "CREDIT",        V_NUMERIC, Credit);

                    if ((OperationCode == 1) or (OperationCode == 2))
                      MoneyMotion.InitRecords();

                      var OtherClirAcc = "";
                      var CodeType     = 0;

                      if (OperationCode == 1)
                        if (ИмпортПереводовСУчастиемКС())
                          if (Debit > 0)
                            // if (Account = 30420...) "Возврат с клирингового счета на корсчет"
                            // else                    "Возврат средств в валюте на корсчет"
                            CodeType = 812;
                          elif (Credit > 0)
                            // if (Account = 30420...) "Перевод на клиринговый счет с корсчета"
                            // else                    "Перевод средств в валюте с корсчета"
                            CodeType = 916;
                          end;
                        end;
                      elif (OperationCode == 2)
                        // if (Debit > 0) "Зачисление с другого клирингового счета"
                        // if (Credit > 0) "Перевод на другой клиринговый счет"
                        CodeType     = 813;
                        OtherClirAcc = MFB99_GetOtherClirAcc(Debit, Credit, BankAccCode);
                      end;

                      MoneyMotion.EntryCodeType   = CodeType;
                      MoneyMotion.EntryNumber     = string("MFB99_", ReportNumber, "_", ClrAccCode, "_", BankAccCode, "_", OpeningBalance, "_", OperationCode, "_", Debit, "_", Credit);
                      MoneyMotion.EntryDebit      = Debit;
                      MoneyMotion.EntryCredit     = Credit;
                      MoneyMotion.EntryDate       = ReportDate;
                      MoneyMotion.ExtSettleCodeID = ClrAccCode;
                      MoneyMotion.Account         = BankAccCode;
                      MoneyMotion.OtherKlirAcc    = OtherClirAcc;
                      MoneyMotion.CurrencyID      = Currency;

                      if (CodeType != 0)
                        if (RunImp())
                          stat = 1;
                        end;
                      end;
                    end;

                    if (FlagCtrlBrk == true)
                      break;
                    end;

                    o = o + 1;
                  end;

                  if (FlagCtrlBrk == true)
                    break;
                  end;

                  n = n + 1;
                end;

                if (FlagCtrlBrk == true)
                  break;
                end;

                m = m + 1;
              end;
            end;

            if (FlagCtrlBrk == true)
              break;
            end;

            l = l + 1;
          end;

          if (FlagCtrlBrk == true)
            break;
          end;

          k = k + 1;
        end;

        if (FlagCtrlBrk == true)
          break;
        end;

        j = j + 1;
      end;
    end;

    if (FlagCtrlBrk == true)
      break;
    end;

    i = i + 1;
  end;

  return stat;
end;

private macro ResultCopyFile(done:bool, data_filepath:string, data_filename:string)
/*kd - ничего никуда не переностим*/
   return;
/*~kd*/

   var data_file_new_path, data_file_new_file;

   if(done)
      data_file_new_path = data_filepath + "Done\\";
   else
      data_file_new_path = data_filepath + "Err\\";
   end;

   MakeDir(data_file_new_path);
   data_file_new_path = data_file_new_path + string(FileDate(imp_date)) + "\\";
   MakeDir(data_file_new_path);

   data_file_new_file = data_file_new_path + data_filename;

   if(not CopyFile(data_filepath + data_filename, data_file_new_file ) )
      RGLog.Error("Ошибка копирования файла " + data_filename + " в " + data_file_new_file);
   else
      RGLog.Message("Файл " + data_filename + " скопирован в " + data_file_new_file);
      RemoveFile(data_filepath + data_filename);
   end;

end;

private macro get_data_file_arr( data_file_arr:TArray, folder:string, pfx:string, comment_from_:string, NoSayError:bool, useTom:bool )
  var stat, datafilepath:string = "", datafilename:string = "";

  stat = get_data_file_name(folder, pfx, @datafilepath, @datafilename, comment_from_, NoSayError, false);
  data_file_arr[data_file_arr.size] = Data_file(datafilepath, datafilename, stat);
  if(useTom)
     stat = get_data_file_name(folder, pfx, @datafilepath, @datafilename, comment_from_, true, true);
     data_file_arr[data_file_arr.size] = Data_file(datafilepath, datafilename, stat);
  end;
end;

private macro ProcessFile( ProcessFunc:string, folder:string, pfx:string, comment_from_:string, NoSayError:bool, useTom:bool )
  var i = 0, data_file_arr = TArray();
  get_data_file_arr( data_file_arr, folder, pfx, comment_from_, NoSayError, useTom );

  while(i < data_file_arr.size)
    if(data_file_arr[i].stat == 0)
      if( ExecMacro2(ProcessFunc, data_file_arr[i].data_filepath + data_file_arr[i].data_filename, data_file_arr[i].data_filename) == 0 )      
        ResultCopyFile(true, data_file_arr[i].data_filepath, data_file_arr[i].data_filename)
      else
        ResultCopyFile(false, data_file_arr[i].data_filepath, data_file_arr[i].data_filename)
      end;
    end;
    i = i + 1;
  end;
end;

private macro RunImportSPB4( Pan )
  var RetVal = CM_SAVE,
      USE_TOM = true, // учитывать, что большие файлы могут дробиться на тома
      MarketScheme_DU,
      data_filepath_ORDERS:string = "", data_filename_ORDERS:string = "";

   if( CheckPanel(Pan, @SPB_Code, @MarketScheme_BO, @MarketScheme_DU, true, @MarketID) == false )
      RetVal = CM_IGNORE;
   end;

  if( (RetVal != CM_IGNORE) and (SPB_Code == SPBEX_CODE) )
      RGLog = GTDL_Log(SeanceID);
      imp_date = Pan.imp_date;

      if( Pan.deals == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ SPB03");
         if( not DL_ИспользPaymentsПриИмпортеСПБ(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            RECORDID_Deals = 0;
            RECORDID_MarketReport = 0;
            ProcessFile( "import_deals_to_gate_from_SPB03", "DEALSX", "SPB03", null, null, USE_TOM );
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ СДЕЛОК ИЗ SPB03 НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ПАО СПБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if( Pan.deals_clearing_client == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА СДЕЛОК ИЗ MFB06C");
         if( not DL_ИспользPaymentsПриИмпортеСПБ(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            RECORDID_Deals_Cliring = 0;
            ProcessFile( "import_deals_to_gate_from_MFB06C", "CLEARCX", "MFB06C", null, null, USE_TOM );
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ СДЕЛОК ИЗ MFB06C НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ПАО СПБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if( Pan.request == SET_CHAR )
         RGLog.Message("ЗАГРУЗКА ЗАЯВОК ИЗ ORDERS");
         if( not DL_ИспользPaymentsПриИмпортеСПБ(@ErrMes) )
            if( ErrMes != "" )
               RGLog.Error(ErrMes); ErrMes = "";
            end;
            if( get_data_file_name_txt("ORDERSX", "ORDERS", @data_filepath_ORDERS, @data_filename_ORDERS) == 0 )
               if( import_request_to_gate(data_filepath_ORDERS + data_filename_ORDERS, data_filename_ORDERS) == 0 )
                  ResultCopyFile(true, data_filepath_ORDERS, data_filename_ORDERS)
               else
                  ResultCopyFile(false, data_filepath_ORDERS, data_filename_ORDERS)
               end;
            end;
         else
            RGLog.Message("ДЛЯ ЗАГРУЗКИ ЗАЯВОК ИЗ ORDERS НУЖНО ИСПОЛЬЗОВАТЬ ИСТОЧНИК ДАННЫХ \"ПАО СПБ, ШЛЮЗ PAYMENTS\"", null, WARNING );
         end;
      end;

      if(Pan.IncREPO == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА Т/О ПО ПЕРЕДАЧЕ ДОХОДА ПО РЕПО ИЗ MFB98");
         ProcessFile( "import_incREPO_to_gate_from_MFB98", "PRNCPL_PAYM", "MFB98", null, null, USE_TOM );
      end;

      if(Pan.NettoItog == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ИТОГОВЫХ НЕТТО-ТРЕБОВАНИЙ И НЕТТО-ОБЯЗАТЕЛЬСТВ");
         ProcessFile( "import_netto_to_gate_from_MFB13", "NETTOX", "MFB13_2", null, null, USE_TOM );
      end;

      if(Pan.Rates == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ИТОГОВ ТОРГОВ ЗА ТОРГОВЫЙ ДЕНЬ");
         ProcessFile( "import_rates_to_gate_from_SPB21", "QUOTESX", "SPB21", null, null, USE_TOM );
      end;

      if(Pan.MoneyMotion == SET_CHAR)
         RGLog.Message("ЗАГРУЗКА ДВИЖЕНИЯ Д/C");
         ProcessFile( "import_cash_flows_to_gate_from_MFB99", "CASH_FLOW", "MFB99", null, null, USE_TOM );
      end;

      RGLog.Save();
   end;

   return RetVal;
end;

private macro RunInitSPB4(Pan)
   Pan.imp_date              = {curdate};
   Pan.Market                = SPB_Code = SPBEX_CODE;
   Pan.rates                 = UNSET_CHAR; 
   Pan.comp                  = UNSET_CHAR;
   Pan.paym                  = UNSET_CHAR;
   Pan.IncREPO               = UNSET_CHAR;
   Pan.DividREPO             = UNSET_CHAR;
   Pan.request               = SET_CHAR;
   Pan.deals                 = SET_CHAR;
   Pan.deals_clearing        = UNSET_CHAR;
   Pan.deals_clearing_client = SET_CHAR;
   Pan.deals_bo              = SET_CHAR;
   Pan.deals_seb             = UNSET_CHAR;
   Pan.deals_du              = UNSET_CHAR;
   Pan.MarketSchemeDU        = "";
   Pan.NettoItog             = SET_CHAR;
   Pan.MoneyMotion           = UNSET_CHAR; 
   Pan.KSUWRT                = UNSET_CHAR;

   DisableFields( Pan, PNFLD_COMP );
   DisableFields( Pan, PNFLD_PAYM );
   DisableFields( Pan, PNFLD_DIVIDREPO );
   DisableFields( Pan, PNFLD_CLEARING );
   DisableFields( Pan, PNFLD_SEC_SEB );
   DisableFields( Pan, PNFLD_SEC_DU );
   DisableFields( Pan, PNFLD_MAR_SCHEME_DU );
   DisableFields( Pan, PNFLD_KSUWRT );
end;

private macro ProcessPanel(Pn, Cmd, ID, Key)
   var Party, DlMarket;

   if (Cmd == DLG_INIT)
        RunInitSPB4(Pn);
        PumpMarketScheme(@Pn, true);
        UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_MARKET) ) /* F3 */
      Party = TRecHandler("party.dbt");
      if( ListPT( Party, SPB_CodeKind, Pn.Market, PTLIST_MARKETPLASE, PTCK_CONTR) == true )
         SPB_Code = Pn.Market;
         PumpMarketScheme(@Pn, true);
         UpdateFields(Pn);
      end;

   elif( (cmd == DLG_KEY) AND (key == 317) AND (ID == PNFLD_IMPDATE) ) /* F3 */
      Pn.imp_date = GetDateByCalendar( Pn.imp_date );
      UpdateFields(Pn);

   elif( (cmd == DLG_KEY) AND (key == 317) and (ID == PNFLD_MAR_SCHEME_DU) ) /* F3 */
      if(ID == PNFLD_MAR_SCHEME_DU)
         ListMarketScheme(@Pn, true);
      end;

   elif ((Cmd == DLG_KEY) and (Key == 32)) /* Пробел */
      if ((ID == PNFLD_RATES)
      or  (ID == PNFLD_COMP)
      or  (ID == PNFLD_PAYM)
      or  (ID == PNFLD_INCREPO)
      or  (ID == PNFLD_DIVIDREPO)
      or  (ID == PNFLD_REQUEST)
      or  (ID == PNFLD_SECUR)
      or  (ID == PNFLD_CLEARING)
      or  (ID == PNFLD_CLEARING_CLIENT)
      or  (ID == PNFLD_SEC_BO)
      or  (ID == PNFLD_SEC_SEB)
      or  (ID == PNFLD_SEC_DU)
      or  (ID == PNFLD_NETTOITOG)
      or  (ID == PNFLD_MONEYMOTION)
      or  (ID == PNFLD_KSUWRT))
         Pn(ID) = IIF(Pn(ID) == SET_CHAR, UNSET_CHAR, SET_CHAR);
      end;

      if ((Pn(PNFLD_REQUEST) == UNSET_CHAR) and (Pn(PNFLD_SECUR) == UNSET_CHAR)
      and (Pn(PNFLD_CLEARING) == UNSET_CHAR) and (Pn(PNFLD_CLEARING_CLIENT) == UNSET_CHAR))
         Pn(PNFLD_SEC_BO)  = UNSET_CHAR;
         DisableFields(Pn, PNFLD_SEC_BO);
      else
         EnableFields(Pn, PNFLD_SEC_BO);
      end;

      UpdateFields(Pn);

   elif ((Cmd == DLG_KEY) and (Key == 316))
      return RunImportSPB4(Pn);

   elif ((Cmd == DLG_KEY) and ((Key == 13) or (Key == 323)))
      return CM_IGNORE;

   end;

   return CM_DEFAULT;
end;

macro Process(SeanceID, Parms)
end;

macro Receive(_SeanceID:integer, Parm:variant)
   SeanceID = _SeanceID;
   SOURCE_CODE = "SRC-27";

   record _party(party);
   var RS;

   if( IsShedulerRunning() )
      RunInitSPB4(pp);
      AutoSetParm(pp, Parm);                     // пар-ры из панели источника
      AutoSetParm(pp, GetShedulerCommandLine()); // пар-ры из задания планировщика
      RunImportSPB4(pp);
   else
     var autoproc;
     if((GetParm(2, autoproc)) and (valtype(autoproc) == V_BOOL) and (autoproc))
       RunInitSPB4(pp);
       AutoSetParm(pp, Parm);
       RunImportSPB4(pp);
     else
      RunDialog(pp, "ProcessPanel");
     end;
   end;

   return 0;
end;

macro Deliver (SeanceID, Parm)
end;