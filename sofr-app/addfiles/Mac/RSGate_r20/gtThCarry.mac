import rgtgtrec, FIInter, GateInter, PTInter, CTInter, BankInter, CarryDoc;

private var RecordID;
private var ID;
private var NewID;
private var Comment = "";

record doc("arhdoc.dbt");
record prm(carryprm);

macro InitGlobalVars()
    RecordID = 0;
    ID = 0;
    NewID = 0;
    Comment = "";
end;

macro FillThCarry(doc, Rec : TGtRecord, Comment : @string)

    var Kind;
   
    doc.Chapter         = Rec.GetParmByName("Chapter").Val;
    doc.Code_Currency   = Rec.GetParmByName("FIID").Val;
    doc.Sum             = Rec.GetParmByName("Sum").Val;
    doc.Account_Payer    = Rec.GetParmByName("AccountPayer").Val;
    doc.Account_Receiver = Rec.GetParmByName("AccountReceiver").Val;
    doc.Numb_Document   = Rec.GetParmByName("Numb_Document").Val;
    doc.Date_Carry      = Rec.GetParmByName("Date_Carry").Val;
    doc.Ground          = Rec.GetParmByName("Ground").Val;
    doc.Department      = Rec.GetParmByName("Department").Val;
    doc.Oper            = Rec.GetParmByName("Oper").Val;
    doc.Shifr_Oper      = "09";
    doc.Result_Carry     = 1;
    
    Kind = Rec.GetParmByName("Kind").Val;
    
    /*if (Kind == 1)
        doc.Status_After = ACCTRN_STATUS_DATE_CARRY;
    elif (Kind == 2)
        doc.Status_After = ACCTRN_STATUS_DOCUMENT;
    elif (Kind == 3)
        doc.Status_After = ACCTRN_STATUS_PLAN;
    elif (Kind == 4)
        doc.Status_After = ACCTRN_STATUS_POST;
    else
        Comment = "Неверное значение параметра ЗР с именем Kind";
        return false;
    end;*/

   return true;
end;

macro CreateThCarry(prmRecordID, prmID, prmNewID : @string, prmComment : @string)
    
    var stat;
            
    InitGlobalVars();
        
    RecordID = prmRecordID;
        
    stat = ProcessTrn(3, "CreateThCarryInTrn");
    
    if (stat == false)
        if (strlen(prm.ErrMsg) != 0)
           prmComment = "Ошибка при создании проводки Thaler: " + prm.ErrMsg;
        else
            prmComment = Comment;    
        end;
        
        return 1;
    else
        prmNewID = NewID;        
        return 0;
    end;
        
end;

macro CreateThCarryInTrn()

    var Rec = TGtRecord(НепосредственнаяВставка);
    var UniCarryID : string, stat = 0;
    var Carry = RsbAccTransaction();      
   
   stat = Rec.LoadFromDB(RecordID);
   
   if (stat == false)
       Comment = Rec.GetLastError();
       AbortTrn();
   end;  
   
   ClearRecord(doc);
   ClearRecord(prm);
   
   stat = FillThCarry(doc, Rec, @Comment);
   
   if (stat == false)
       AbortTrn();
   end;

    prm.DateF         = doc.Date_Carry; 
    prm.errmsg        = "";
    
    if (doc.Code_Currency == NATCUR)
       prm.CarryKind = 1;
   else
       prm.CarryKind = 2;
   end;

    RunCarry(prm, doc);
    
   ClearRecord(doc);
   
   doc.iApplicationKind = prm.ApplicationKind;
   doc.ApplicationKey   = prm.ApplicationKey;
   
   UniCarryID = UniID(doc, OBJTYPE_DOCUMENT);
   
   NewID = UniCarryID;
   
   return 0;
end;

macro UpdateThCarryInTrn()
   
   var Rec = TGtRecord(НепосредственнаяВставка);
   var stat = 0;
   
   ClearRecord(doc);
   ClearRecord(prm);
         
   stat = Rec.LoadFromDB(RecordID);
   
   if (stat == false)
       Comment = Rec.GetLastError();
       AbortTrn();
   end;  
   
   if (not RestoreFromUniID(ID, doc, OBJTYPE_DOCUMENT))
       Comment = "Ошибка при получении идентификатора проводки";
       AbortTrn();
   end;
   
   prm.ApplicationKind = doc.iApplicationKind;
   prm.ApplicationKey  = doc.ApplicationKey;
   
   if (doc.Code_Currency == NATCUR)
       prm.CarryKind = 1;
   else
       prm.CarryKind = 2;
   end;
   
    doc.Sum               = Rec.GetParmByName("Sum").Val;
    doc.Account_Payer     = Rec.GetParmByName("AccountPayer").Val;
    doc.Account_Receiver  = Rec.GetParmByName("AccountReceiver").Val;
    doc.Numb_Document     = Rec.GetParmByName("Numb_Document").Val;
    doc.Date_Carry        = Rec.GetParmByName("Date_Carry").Val;
    doc.Ground            = Rec.GetParmByName("Ground").Val;
    doc.Department        = Rec.GetParmByName("Department").Val;
    doc.Oper              = Rec.GetParmByName("Oper").Val; 

    stat = RunBackout(prm, doc);

    if (stat != 0)
       Comment = "Ошибка при изменении проводки: " + prm.ErrMsg;
       AbortTrn();
   end;
         
   return 0;   
end;

macro UpdateThCarry(prmRecordID, prmID, prmComment : @string)
    
    var stat;
    
    InitGlobalVars();    
    RecordID = prmRecordID;
    ID = prmID;
        
    stat = ProcessTrn(3, "UpdateThCarryInTrn");
    
    if (stat == false)
        if (strlen(prm.ErrMsg) != 0)
           prmComment = "Ошибка при создании проводки Thaler: " + prm.ErrMsg;
        else
            prmComment = Comment;    
        end;
        
        return 1;
    else
        return 0;
    end;
        
end;

macro DeleteThCarry(ID, Comment : @string)
   
   Comment = "Процедура удаления для объекта Проводка Thaler не реализована";
   
   return 1;
end;
