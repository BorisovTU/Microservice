/*********************************************************************
*  ---------------------                                             *
*  R-Style Software Lab.                                             *
*  ---------------------                                             *
*  RS-Retail                                                         *
*                                                                    *
*  Эквайер		                                             *
*                                                                    *
*  Основные функции                                                  *
*                                                                    *
*                                                                    *
*  Крестьянинов Е.А.                                                 *
*  04.03.2004                                                        *
*********************************************************************/
import acq_val;

file mail   (scMail,  "spcard.def" ) write;    /* Сеансы связей с ПЦ         */

/*********************************************************************
             Выделение имени пути из полного имени файла
*********************************************************************/
macro GetNamePath (FullName)

  var PathName = "";
  var stat     = TRUE;

  if (Index(FullName,"\\") > 0)
    PathName = FullName;
    while (stat)
      if (SubStr(PathName,StrLen(PathName)) == "\\")
        stat = FALSE;
      end;
      PathName = SubStr(PathName,1,StrLen(PathName) - 1);
    end;
  end;

  return PathName;

end;

/*********************************************************************
                     Формирование кода сеанса связи
*********************************************************************/
macro FormMailCode (MailDate)

  var stat             = TRUE;
  var NumberSession    = 0;
  var CounterForDay    = 0;
  var StrNumberSession = "";
  var year,month,day;
  var YYYY,MM,DD;
  var MailCode         = "";

  DateSplit(MailDate,day,month,year);
  YYYY = Trim(String(year));
  while (StrLen(YYYY) < 4)
    YYYY = "0" + YYYY;
  end;
  MM = Trim(String(month));
  while (StrLen(MM) < 2)
    MM = "0" + MM;
  end;
  DD = Trim(String(day));
  while (StrLen(DD) < 2)
    DD = "0" + DD;
  end;

  KeyNum(mail,1);
  ReWind(mail);
  mail.FNCash   = Branch;
  mail.psRef    = STB_psRef;
  mail.mailDate = MailDate;
  mail.mailTime = Time(23,59,59);
  if ((GetLE(mail)               ) AND 
      (mail.psRef    == STB_psRef) AND 
      (mail.mailDate == MailDate ) AND 
      (StrLen(mail.mailCode) > 11)    )
    NumberSession = Int(Trim(SubStr(mail.mailCode,12))) + 1;
  else
    NumberSession = 1;
  end;

  ReWind(mail);
  mail.FNCash   = Branch;
  mail.psRef    = STB_psRef;
  mail.mailDate = MailDate;
  mail.mailTime = Time(0,0,0);
  stat = GetGE(mail);
  while (stat)
    if ((mail.psRef == STB_psRef) AND (mail.mailDate == MailDate))
      CounterForDay = CounterForDay + 1;
      stat = Next(mail);
    else
      stat = FALSE;
    end;
  end;

  if (NumberSession <= CounterForDay)
    NumberSession = CounterForDay + 1;
  end;

  StrNumberSession = Trim(String(NumberSession));
  while (StrLen(StrNumberSession) < 6)
    StrNumberSession = "0" + StrNumberSession;
  end;

  MailCode = "STB" + YYYY + MM + DD + StrNumberSession;

  return MailCode;

end;

/*********************************************************************
         Заполнение строки символами слева до заданной длины
*********************************************************************/
macro AddSymLeft
(
 InputString, /* Входящая строка        */
 Sym,         /* Символ для заполнения  */
 Len          /* Длина строки на выходе */
)

  var OutString = InputString;

  if (StrLen(OutString) > Len)
    OutString = SubStr(OutString,StrLen(OutString) - Len + 1);
  else
    while (StrLen(OutString) < Len)
      OutString = Sym + OutString;
    end;
  end;

  return OutString;

end;

/**************************************************************************\
| Формирование идентификатора входной записи для расшифровки сеанса связи  |
\**************************************************************************/
macro FormMailItIdentificator (num_cur_rec)

  var out_identificator = String(num_cur_rec);

  out_identificator = AddSymLeft(out_identificator,"0",6);

  return out_identificator;

end;
