/*********************************************************************
*  ---------------------                                             *
*  R-Style Software Lab.                                             *
*  ---------------------                                             *
*  RS-Retail                                                         *
*                                                                    *
*  Эквайер                                                           *
*                                                                    *
*  Автоматический matching транзакций эквайера                       *
*                                                                    *
*                                                                    *
*  Орлова М.О.                                                       *
*  03.02.2006                                                        *
*********************************************************************/

import acqcmn, rsd;

var ConfAuthRef = 0, AuthRef = 0;

/*******************************************************************************/
/*******************************************************************************/
macro TrnProc
var cmd;
   cmd = RsdCommand(string(" update dacqtran_dbt set T_CLNTPMNTSTATE = '" + ACQPS_CON +"'",
                    " where  t_authRef = " + String( AuthRef ) ));
   cmd.execute;
   cmd = RsdCommand(string(" update dacqtran_dbt set T_CLNTPMNTSTATE = '" + ACQPS_PRCON+"',",
                           " t_confAuthRef = " + String( AuthRef ) +
                    " where  t_authRef = " + String( ConfAuthRef ) ));
   cmd.execute;
end;
/*******************************************************************************/
/*******************************************************************************/
macro acqSetTranMatch (id) /* ID транзакции-подтверждения */
var stat;
var cmd, rs;

AuthRef  = id;
      cmd = RsdCommand( String(" select t_authRef authref from dacqtran_dbt ",
                        " where (T_CLNTPMNTSTATE = '" + ACQPS_NPCON+"')",
                        " and (T_PSREF, T_CLIENTID, T_POSREF, T_TERMREF, T_SUM, T_CURRCODE, T_AUTHCODE, T_debCred ) in ",
                        " ( select t_psref, T_CLIENTID, T_POSREF, T_TERMREF, T_SUM, T_CURRCODE, T_AUTHCODE, T_debCred from dacqtran_dbt ",
                        " where t_authRef = " + String(AuthRef)+ " )" ) );
  
      cmd.execute;
      rs = RsdRecordset( cmd );

      stat = 1;               /* не найдена авторизация */
      if(rs.moveNext)
         stat = 0;            /* найдена авторизация */
         if(rs.moveNext)
            stat = 2;         /* найдено более одной авторизации */
         else
            rs.moveFirst;
            ConfAuthRef = rs.value("authRef");
            ProcessTrn(0,"TrnProc");
         end;
      end;

    return stat;

  onError( e )
     MsgBox( e.Message );
end;