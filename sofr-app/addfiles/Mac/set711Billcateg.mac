import "mctplprm.mac", "cb_sql.mac", "dlquery.mac";

macro setAvoiriss711Code(vsbanner, attrid)
    file objatcor(objatcor) write;
    file avoiriss(avoiriss) key 0;
    var err = "";

    avoiriss.fiid = vsbanner.fiid;

    if(getEQ(avoiriss))
/*
        if(not ConnectObjAttr(err, OBJTYPE_AVOIRISS, UniID(avoiriss, OBJTYPE_AVOIRISS), 1, attrid, null, null, vsbanner.registrationdate))
            setParm(2, "Не удалось установить категорию");
            return false;
        end;
*/

        clearRecord(objatcor);

        objatcor.objecttype = 12;
        objatcor.groupid = 1;
        objatcor.attrid = attrid;
        objatcor.object = UniID(avoiriss, 12);
        objatcor.validfromdate = vsbanner.registrationdate;
        objatcor.validtodate = date(31,12,9999);
        objatcor.general = "X";
        objatcor.oper = {oper};
        objatcor.sysdate = date;

        insert(objatcor);            
    end;
end;

macro setFicert711Code(vsbanner, attrid)
    file objatcor(objatcor) write;
    file ficert(ficert) key 0;
    var err = "";
    
    ficert.FiCertID = vsbanner.FiCertID;

    if(getEQ(ficert))
/*
        if(not ConnectObjAttr(err, OBJTYPE_FICERT, UniID(ficert, OBJTYPE_FICERT), 1, attrid))
            setParm(2, "Не удалось установить категорию");
            return false;
        end;    
*/

        clearRecord(objatcor);

        objatcor.objecttype = 24;
        objatcor.groupid = 1;
        objatcor.attrid = attrid;
        objatcor.object = UniID(ficert, 24);
        objatcor.validfromdate = vsbanner.registrationdate;
        objatcor.validtodate = date(31,12,9999);
        objatcor.general = "X";
        objatcor.oper = {oper};
        objatcor.sysdate = date;

        insert(objatcor);
    end;


end;


macro get711CodeAttrid(attrname)
    var cmd = DL_RSDCommand("select * from dobjattr_dbt where t_objecttype = 12 and t_groupid = 1 and t_name = '"+attrname+"'");
    var dataSet = cmd.ExecuteStat();    

    if(dataSet.moveNext())
        return dataSet.attrid;
    end;

    return -1;
end;

var issuerKind = -1;
var Code711Attrid = -1;
var Code711Name = "";

var cmd = DL_RSDCommand(" SELECT vsbanner.t_bcid,                                              " +
                        "        vsbanner.t_fiid,                                              " +
                        "        vsbanner.t_issuer,                                            " +
                        "        ficert.t_ficertid,                                            " +
                        "        VSBANNER.T_REGISTRATIONDATE                                   " +
                        "   FROM dvsbanner_dbt vsbanner, dfininstr_dbt fin, dficert_dbt ficert " +
                        "  WHERE     vsbanner.t_issuer != 1                                    " +
                        "        AND fin.t_FIID = vsbanner.t_FIID                              " +
                        "        AND ficert.t_AvoirKind = fin.t_AvoirKind                      " +
                        "        AND ficert.t_CertID = vsbanner.t_BCID                         " +
                        "        /*AND vsbanner.t_bcid = 1   */                                    ");
var dataSet = cmd.ExecuteStat();


while (dataSet.moveNext())
    issuerKind = MC_GetKindIssuer(dataSet.issuer);
/*
BIL1 - векселя федеральных органов исполнительной власти;
BIL2 - векселя органов исполнительной власти субъектов Российской Федерации и муниципальных образований;
BIL3 - векселя кредитных организаций - резидентов;
BIL4 - векселя прочих резидентов;
BIL5 - векселя иностранного государства;
BIL6 - векселя банков-нерезидентов;
BIL7 - векселя прочих нерезидентов;

   if( (Kind == 7) AND (Res == true))
      return 1; /*ЦБ РФ*/
   elif( (Kind == 8) AND (Res == true))
      return 300; /*Министерство финансов*/
   elif( (Kind == 1) AND (Res == false) )
      return 3; /* банк - нерезидент */
   elif( (Kind == 1) AND (Res == true) )
      return 4; /* банк - резидент */
   elif( Kind == 3 )
      return 100; /* орган гос. власти РФ */
   elif( Kind == 4 )
      return 101; /* орган гос. власти субъекта РФ или местная власть */
   elif( Kind == 5 )
      return 102; /* иностранное государство */
   elif( Kind == 6 )
      return 103; /* орган местной власти иностранного государства */
   elif( Res == true  )
      return 9999; /* другой резидент*/
   elif( Res == false )
      return 1000; /* другой нерезидент*/
   end;

*/
    if(issuerKind == 100)
        Code711Name = "BIL1";
    elif(issuerKind == 101)
        Code711Name = "BIL2";
    elif(issuerKind == 4)
        Code711Name = "BIL3";
    elif(issuerKind == 9999)
        Code711Name = "BIL4";
    elif(issuerKind == 102)
        Code711Name = "BIL5";
    elif(issuerKind == 3)
        Code711Name = "BIL6";
    elif(issuerKind == 1000)
        Code711Name = "BIL7";
    end;

    Code711Attrid = get711CodeAttrid(Code711Name);
    if(Code711Attrid != -1)
        setAvoiriss711Code(dataSet, Code711Attrid);
        setFicert711Code(dataSet, Code711Attrid);

        println("bcid :: "+int(dataSet.bcid) + " 711code :: " + Code711Name + " attrid :: " + int(Code711Attrid));
    end;
end;