/*
$Name:             vu_groupcorrect2021.mac
$Module:           БОЦБ
$Description:      Корректировка проводок ВУ единоразовая
*/

IMPORT "sp_car.mac", "scservop.mac", "dlQuery.mac", "dlcontrfunc.mac", "spserv.mac", "sp_class.mac",  "spreserv.mac", "DealsInter.mac"; 

PRIVATE VAR CarryError = "";
PRIVATE VAR ID_Operation = 0;
PRIVATE RECORD AccountPayer(account);
PRIVATE RECORD AccountReceiver(account);

VAR tableHeader = 
 "┌──────────────────────┬────────────┬──────────────────┬───────────────────┬──────────────────────────┬─────────────────────────┬──────────────────────────┬─────────────────────────┐\n"+
 "│      Код операции    │    Дата    │    ID клиента    │    Код клиента    │     Сумма проводки БУ    │          Дебет          │          Кредит          │    Сумма проводки ВУ    │\n"+
 "├──────────────────────┼────────────┼──────────────────┼───────────────────┼──────────────────────────┼─────────────────────────┼──────────────────────────┼─────────────────────────┤";

PRIVATE VAR Rep = CMakeReport(tableHeader);
   
PRIVATE MACRO SayCarryError( error )
   if( isOprMultiExec() == false )
      msgbox( error );
   else
      CarryError = error;
   end;
   return false;
END;

PRIVATE MACRO GetClientCodeByID( ClientID:integer ):string
  var Sql = " SELECT c.t_Code " +
            "   FROM dpartcode_dbt c " +
            "  WHERE c.t_PartyID = ? " +
            "    AND c.t_CodeKind = 1 ";

  var Query = DL_RSDCommand(Sql);
  Query.addParam(ClientID);

  var rs = Query.Execute();

  if( rs.MoveNext() )
     return rs.Code;
  end;

  return "";  
END;

PRIVATE MACRO MakeTrnLinkId(ID_Operation, ID_Step, TrnId, InnAccId)
  var query = "";
  var cmd;

  if (TrnId > 0) 
      query =
          " INSERT INTO doprdocs_dbt (T_DOCKIND, "
         +"                           T_DOCUMENTID, "
         +"                           T_ID_OPERATION, "
         +"                           T_ID_STEP, "
         +"                           T_PART, "
         +"                           T_STATUS, "
         +"                           T_ORIGIN, "
         +"                           T_SERVDOCKIND, "
         +"                           T_SERVDOCID, "
         +"                           T_ACCTRNID) "
         +"      VALUES (1, "
         +"              CHR (1), "
         +"              ?, "
         +"              ?, "
         +"              1, "
         +"              0, "
         +"              0, "
         +"              0, "
         +"              0, "
         +"              ?); ";
     cmd = RSDCommand(query);
     cmd.addParam("", RSDBP_IN, ID_Operation);
     cmd.addParam("", RSDBP_IN, ID_Step);
     cmd.addParam("", RSDBP_IN, TrnId);
     cmd.execute();
  else
      query =
          " INSERT INTO doprdocs_dbt (T_DOCKIND, "
         +"                           T_DOCUMENTID, "
         +"                           T_ID_OPERATION, "
         +"                           T_ID_STEP, "
         +"                           T_PART, "
         +"                           T_STATUS, "
         +"                           T_ORIGIN, "
         +"                           T_SERVDOCKIND, "
         +"                           T_SERVDOCID, "
         +"                           T_ACCTRNID) "
         +"      VALUES (4601, "
         +"              LPAD(?, 10, '0'), "
         +"              ?, "
         +"              ?, "
         +"              1, "
         +"              0, "
         +"              0, "
         +"              0, "
         +"              0, "
         +"              null); ";
     cmd = RSDCommand(query);
     cmd.addParam("", RSDBP_IN, InnAccId);
     cmd.addParam("", RSDBP_IN, ID_Operation);
     cmd.addParam("", RSDBP_IN, ID_Step);
     cmd.execute();
  end;
END;

PRIVATE MACRO РасчетнаяОперацияВУ( accTrn :variant /*: RsbAccTransaction*/, FD, ВидРО ) : bool
  var InnAcc = TRecHandler("dlinacc.dbt");
  var DealSum = $0, spground, dealcode = ""; 

  InnAcc.rec.ID         = 0;  
  InnAcc.rec.Boffice    = OBJTYPE_BACKOFFICE_DV;
  InnAcc.rec.OperType   = ВидРО;
  InnAcc.rec.DocumentID = FD.ID;
  
  InnAcc.rec.AccTrnID   = accTrn.AccTrnID;
  InnAcc.rec.Date       = accTrn.Date_Carry; 
  InnAcc.rec.Chapter    = accTrn.Chapter;
  InnAcc.rec.DebAcc     = accTrn.AccountPayer;
  InnAcc.rec.KredAcc    = accTrn.AccountReceiver;
  
  if (accTrn.Chapter == 22)
   InnAcc.rec.FIKind    = FIKIND_DERIVATIVE;
  else
   InnAcc.rec.FIKind    = FIKIND_CURRENCY;
  end;
   
  InnAcc.rec.FIID       = accTrn.FIIDPayer;
  InnAcc.rec.Sum        = accTrn.SumPayer;
  InnAcc.rec.Department = accTrn.Department;
  InnAcc.rec.Oper       = accTrn.Oper;
  InnAcc.rec.DocumentKind = FD.Kind;

  /*за дату проводки InnAcc.Date ищем документ вида "Распорядительная записка"*/
  InnAcc.rec.GroundKind = 27;
  spground = TRecHandler("spground.dbt");

  InnAcc.rec.PartyID  = UnknownParty;
  InnAcc.rec.PlaceID  = UnknownParty;

  InnAcc.rec.DealKind = FD.Kind;
  dealcode            = FD.nptxop.rec.code;/*номер операции*/

  var dlinaccCache = RsbSQLInsert("dlinacc.dbt");
  var realIDs = TArray();
  dlinaccCache.AddRecord(InnAcc);
  dlinaccCache.AddReturning( "t_id", V_INTEGER );
  if(not dlinaccCache.insert())
     return false;
  else
     dlinaccCache.GetReturning( realIDs );
     var cmd = RsdCommand("UPDATE ddlinacc_dbt SET t_FMTBLOBDATA_XXXX = utl_raw.cast_to_raw(\'"+dealcode+"\') WHERE t_ID = ?");
     cmd.addParam("", RSDBP_IN, realIDs[0]);
     cmd.Execute();
     MakeTrnLinkId(ID_Operation, 4, 0, realIDs[0]);
  end;
  return true;
END;

PRIVATE MACRO ЮзерПроводкаПоКатегориямУчета(
  FD:VARIANT, 
  СчетДебет:VARIANT, СчетКредит:VARIANT, 
  ДатаВалютирования:DATE,
  Chapter:INTEGER, 
  FIID:INTEGER,
  СуммаОперации:MONEY,
  Numb_Document:STRING,
  Ground:STRING,
  FIRolePayer:INTEGER, FIRoleReceiver:INTEGER,
  СчетДебетFIID:INTEGER, СчетКредитFIID:INTEGER,
  IsInnerCarry,
  ВидРО:INTEGER,
  FDDebetParm:VARIANT, FDCreditParm:VARIANT
)
  var CуммаДебет = $0, СуммаКредит  = $0, tr = NULL, PaymentObj = NULL, 
      СчетОВПДебет = "", СчетОВПКредит = "", СчетДоходов = "", СчетРасходов = "";

  if( СуммаОперации == null )  
     return SayCarryError( "В проводке не задана ни одна из сумм." );
  end;

  /*оставить только копейки для первой суммы, если она задана*/
  if( СуммаОперации != null )
     if( (Chapter == 5) or (Chapter == 22) )
        /*количество ц/б может быть дробным*/
     else
        СуммаОперации = money( round( СуммаОперации, 2 ) );    
     end;
     if( СуммаОперации < $0 )  
        return SayCarryError( "Сумма проводки < 0." );
     end;
  else  
    СуммаОперации = $0;
  end;

  if( СуммаОперации == $0 )  
     return true;
  end;

  if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
     If(СчетДебет == "ДС Общий")
          FIRolePayer = FIROLE_SETTL_AGENT;
     end;
     If(СчетДебет == "ДС Клиринговый, ВУ")
          FIRolePayer = FIROLE_SETTL_AGENT;
     end;

     if( (StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD")) OR 
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD_DV"))
       )
        if( not FD.OpenAccount( FDDebetParm, СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID) )          
            return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
        end;
     else
        if( not FD.OpenAccount( СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID) )          
            return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
        end;
     end;
  else
     copy( AccountPayer, СчетДебет );
  end;

  if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
  
      If(СчетКредит == "ДС Общий")
         FIRoleReceiver = FIROLE_SETTL_AGENT;
     end;

     If(СчетДебет == "ДС Клиринговый, ВУ")
        FIRolePayer = FIROLE_SETTL_AGENT;
     end;

     if( (StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD_DV"))
       )
        if( not FD.OpenAccount( FDCreditParm, СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID) )
           return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
        end;
     else
        if( not FD.OpenAccount( СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID) )
           return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
        end;
     end;
  else
     copy( AccountReceiver, СчетКредит );
  end;

  if( FIID == null )
     return SayCarryError("Не задана ни одна из валют проводки.");
  end;

  if( (FIID != AccountPayer.Code_Currency) AND
      (FIID != AccountReceiver.Code_Currency) )
     return SayCarryError( "В проводке не совпадают валюты счетов: " 
                            + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                           "| и валюта документа: " + string(FIID) );
  end;

  if( СуммаОперации != $0 )
     CуммаДебет = СуммаКредит = СуммаОперации;
  end;
  tr = RsbAccTransaction();

   /*DAN.Ролевая модель Определяем конечного операциониста для проводки.  */
         Tr.Oper = {Oper};
   /*DAN*/

  if( tr == NULL )
     return SayCarryError("Ошибка при формировании документа проводки.");
  end;
  tr.Chapter         = Chapter;
  tr.Date_Carry      = ДатаВалютирования;
  tr.Numb_Document   = Numb_Document;
  tr.ResultCarry     = INPCARRY;
  tr.Kind_Oper       = "";
  tr.Ground          = Ground;
  tr.Department      = {OperDprt};
  tr.FIIDPayer       = AccountPayer.Code_Currency;
  tr.FIIDReceiver    = AccountReceiver.Code_Currency;
  tr.SumPayer        = CуммаДебет;
  tr.SumReceiver     = СуммаКредит;
  tr.AccountPayer    = AccountPayer.Account;
  tr.AccountReceiver = AccountReceiver.Account;
  if( PaymentObj != null )
     tr.Number_Pack  = PaymentObj.NumberPack;
  end;

  if( not tr.Carry() )
      return SayCarryError("Ошибка при выполнении проводки");
  else
     if(tr.AccTrnID > 0)
        MakeTrnLinkId(ID_Operation, 4, tr.AccTrnID, 0);
     end; 
  end;
  
  if( IsInnerCarry )
     if( not РасчетнаяОперацияВУ( tr, FD, ВидРО ) )
        return SayCarryError("Ошибка при вставке расчетной операции внутреннего учета");
     end;
  end;

  return true;
END;

PRIVATE MACRO PrintLine (nptxop, DebAccBY, KredAccBY, Sum, operdate)
   Rep.AddPrintCell(nptxop.code, 0, 0, "l");
   Rep.AddPrintCell(operdate, 0, 2, "r:a");
   Rep.AddPrintCell(nptxop.Client, 0, 0, "l");
   Rep.AddPrintCell(GetClientCodeByID(nptxop.Client), 0, 0, "l");
   Rep.AddPrintCell(Sum, 0, 2, "r:a");
   Rep.AddPrintCell(DebAccBY, 0, 0, "l"); 
   Rep.AddPrintCell(KredAccBY, 0, 0, "l"); 
   Rep.AddPrintCell(Sum, 0, 2, "r:a");
   Rep.AddStr();
END; 

PRIVATE MACRO ПроводкаПоКатегориямВнутреннегоУчета( ВидРО, FD, Doc, CarryDate, FIID, CarrySumm, FDDebetParm:VARIANT, FDCreditParm:VARIANT, DealCode, GroundStr, AccDeb:VARIANT, AccKred:VARIANT, _FIRolePayer:integer, _FIRoleReceiver:integer, trnId )
  var ClassName:string = "";
  var Ground:string = "";
  var AccountDeb, AccountKred;
  var FIRolePayer:integer = -1, FIRoleReceiver:integer = -1;

  if( not ВестиВнутреннийУчет() )
     return 1;
  end;
 
  if(ValType(GroundStr) == V_STRING)
     Ground = GroundStr;
  else
     Ground = FD.ВУ_ОснованиеПроводки( ВидРО );
  end;

  if( (StrUpr(GenClassName(FD)) == StrUpr("SPFirstDocDLCOMM")) AND ((FD.Kind == DL_ISSUE_UNION) OR (FD.Kind == DL_CHGAVRNOM) OR ((FD.Kind == DL_SETTLEMENT) AND (AccDeb != NULL) AND (AccKred != NULL))) )
     AccountDeb  = AccDeb;
     AccountKred = AccKred;
  elif((StrUpr(GenClassName(FD)) == StrUpr("DLFirstDocNPTXOP")) AND (FD.Kind == DL_HOLDNDFL) AND (AccDeb != NULL) AND (AccKred != NULL))
     AccountDeb  = AccDeb;
     AccountKred = AccKred;
  else
     AccountDeb  = FD.ВУ_ПолучитьКатегориюДебет( ВидРО, null, CarryDate, FIID );
     AccountKred = FD.ВУ_ПолучитьКатегориюКредит( ВидРО, null, CarryDate, FIID );
  end;

  if( _FIRolePayer != NULL )
     FIRolePayer = _FIRolePayer;
  else
     FIRolePayer = FD.ВУ_ПолучитьРольФИ(ВидРО, true);
  end;

  if( _FIRoleReceiver != NULL )
     FIRoleReceiver = _FIRoleReceiver;
  else
     FIRoleReceiver = FD.ВУ_ПолучитьРольФИ(ВидРО, false);
  end;

  return ЮзерПроводкаПоКатегориямУчета( FD,
                                        AccountDeb,
                                        AccountKred,
                                        CarryDate,
                                        FD.ВУ_ОпределениеГлавы(FIID),
                                        FIID,
                                        CarrySumm,
                                        "1 ",
                                        Ground,
                                        FIRolePayer,
                                        FIRoleReceiver,
                                        FIID, FIID,
                                        true,
                                        FD.ВУ_ПолучитьРО(ВидРО),
                                        FDDebetParm, FDCreditParm
                                      );

END;

PRIVATE MACRO ВыполнитьКорректировкуВУ()
  var FD;
  var Select, DataSet, Query, Progress;
  var S = 0, stat = 0, NRec = 0, i = 0;
  var DtAccount  = TrecHandler( "account.dbt");
  var CtAccount  = TrecHandler( "account.dbt") ;
  var DtAccountN = TrecHandler( "account.dbt");
  var CtAccountN = TrecHandler( "account.dbt");

  Query =
        " SELECT np.*, " +
        "        (SELECT trn.T_SUM_NATCUR " +
        "           FROM DACCTRN_DBT trn, doprdocs_dbt opd " +
        "          WHERE     trn.T_ACCTRNID = opd.T_ACCTRNID " +
        "                AND trn.t_State = 1 " +
        "                AND trn.T_CHAPTER = 1 " +
        "                AND opd.t_DocKind = 1 " +
        "                AND opd.T_ID_OPERATION = op.T_ID_OPERATION) AS SUM, " +
        "        op.t_id_operation, " +
        "       (SELECT dm.T_ACCOUNT " +
        "          FROM DMCACCDOC_DBT dm " +
        "         WHERE     dm.T_OWNER = np.t_client " +
        "               AND dm.T_CLIENTCONTRID = " +
        "                   (SELECT m.T_CLIENTCONTRID " +
        "                      FROM DMCACCDOC_DBT m " +
        "                     WHERE m.t_account = np.t_account AND ROWNUM = 1) " +
        "               AND dm.T_TEMPLNUM in (1,3,5) " +
        "               AND dm.t_catid = 349 " +
        "               AND dm.T_DOCKIND = 0 " +
        "               AND dm.t_currency = 0 " +
        "               AND dm.t_activatedate < TO_DATE ('19.11.2021', 'DD.MM.YYYY') " +
        "               AND ROWNUM = 1)                                AS DtAccount, " +
        "       (SELECT dm.T_ACCOUNT " +
        "          FROM DMCACCDOC_DBT dm " +
        "         WHERE     dm.T_OWNER = np.t_client " +
        "               AND dm.T_CLIENTCONTRID = " +
        "                   (SELECT m.T_CLIENTCONTRID " +
        "                      FROM DMCACCDOC_DBT m " +
        "                     WHERE m.t_account = np.t_account AND ROWNUM = 1) " +
        "               AND dm.T_TEMPLNUM in (1,3,5) " +
        "               AND dm.t_catid = 347 " +
        "               AND dm.T_DOCKIND = 0 " +
        "               AND dm.t_currency = 0 " +
        "               AND dm.t_activatedate < TO_DATE ('19.11.2021', 'DD.MM.YYYY') " +
        "               AND ROWNUM = 1)                                AS CtAccount, " +
        "       (SELECT dm.T_ACCOUNT " +
        "          FROM DMCACCDOC_DBT dm " +
        "         WHERE     dm.T_OWNER = np.t_client " +
        "               AND dm.T_CLIENTCONTRID = " +
        "                   (SELECT m.T_CLIENTCONTRID " +
        "                      FROM DMCACCDOC_DBT m " +
        "                     WHERE m.t_account = np.t_account AND ROWNUM = 1) " +
        "               AND dm.T_TEMPLNUM = 6 " +
        "               AND dm.t_catid = 349 " +
        "               AND dm.T_DOCKIND = 0 " +
        "               AND dm.t_currency = 0 " +

        "               AND ROWNUM = 1)                                AS DtAccountN, " +
        "       (SELECT dm.T_ACCOUNT " +
        "          FROM DMCACCDOC_DBT dm " +
        "         WHERE     dm.T_OWNER = np.t_client " +
        "               AND dm.T_CLIENTCONTRID = " +
        "                   (SELECT m.T_CLIENTCONTRID " +
        "                      FROM DMCACCDOC_DBT m " +
        "                     WHERE m.t_account = np.t_account AND ROWNUM = 1) " +
        "               AND dm.T_TEMPLNUM = 6 " +
        "               AND dm.t_catid = 347 " +
        "               AND dm.T_DOCKIND = 0 " +
        "               AND dm.t_currency = 0 " +
        "               AND ROWNUM = 1)                                AS CtAccountN, " +
        "       (SELECT m.T_CLIENTCONTRID " +
        "          FROM DMCACCDOC_DBT m " +
        "         WHERE m.t_account = np.t_account AND ROWNUM = 1)     AS CLIENTCONTRID " +
        "   FROM dnptxop_dbt np, DOPROPER_DBT op " +
        "  WHERE     np.T_DOCKIND = 4608 " +
        "        AND np.T_KIND_OPERATION = 2038 " +
        "        AND np.T_SUBKIND_OPERATION = 10 " +
        "        AND np.T_PREVDATE = TO_DATE ('01.01.2020', 'DD.MM.YYYY') " +
        "        AND op.T_DOCKIND = 4608 " +
        "        AND LPAD (np.T_ID, 34, '0') = op.T_DOCUMENTID " +
        "        AND (SELECT COUNT (1) " +
        "               FROM DACCTRN_DBT trn, doprdocs_dbt opd " +
        "              WHERE     trn.T_ACCTRNID = opd.T_ACCTRNID " +
        "                    AND trn.t_State = 1 " +
        "                    AND trn.T_CHAPTER = 1 " +
        "                    AND opd.t_DocKind = 1 " +
        "                    AND opd.T_ID_OPERATION = op.T_ID_OPERATION) > 0 " +
        "       AND (SELECT COUNT (1) " +
        "              FROM DACCTRN_DBT trn, doprdocs_dbt opd " +
        "             WHERE     trn.T_ACCTRNID = opd.T_ACCTRNID " +
        "                   AND trn.t_State = 1 " +
        "                   AND trn.T_CHAPTER = 21 " +
        "                   AND opd.t_DocKind = 1 " +
        "                   AND opd.T_ID_OPERATION = op.T_ID_OPERATION) = 0 " +
        "        AND (SELECT COUNT (1) " +
        "               FROM DSFCONTR_DBT " +
        "              WHERE     T_ID = (SELECT m.T_CLIENTCONTRID " +
        "                                  FROM DMCACCDOC_DBT m " +
        "                                 WHERE m.t_account = np.t_account AND ROWNUM = 1) " +
        "                    AND (   T_DATECLOSE = TO_DATE ('01.01.0001', 'DD.MM.YYYY') " +
        "                         OR T_DATECLOSE > TO_DATE ('" + {Curdate} + "', 'DD.MM.YYYY'))) > 0 ";

  Select = DL_RSDCommand(Query);
  NRec = Select.GetCount(Query);

  Progress = TProgressBar;
  Progress.Init(NRec, "Обработка операций", "Обработка операций удержания НДФЛ");

  DataSet = Select.Execute();
  while (DataSet.moveNext())
        stat = 0;
        FD = DLFirstDocNPTXOP(DL_HOLDNDFL, DataSet.ID ); 
        S = DataSet.Sum;

        if ( (ValType(DataSet.CtAccount)  == V_STRING ) and 
             (ValType(DataSet.DtAccount)  == V_STRING ) and 
             (ValType(DataSet.CtAccountN) == V_STRING ) and 
             (ValType(DataSet.DtAccountN) == V_STRING ) )

          DL_GetAccount(21,0,DataSet.CtAccount,CtAccount);
          DL_GetAccount(21,0,DataSet.DtAccount,DtAccount);
          DL_GetAccount(21,0,DataSet.CtAccountN,CtAccountN);
          DL_GetAccount(21,0,DataSet.DtAccountN,DtAccountN);
        else 
          msgbox( "Отсутствуют требуемые счета" ); 
          stat = 1;
        end;

        ID_Operation = DataSet.ID_Operation;

        if ((S > 0) and (stat == 0))
           if( not ПроводкаПоКатегориямВнутреннегоУчета(17, 
                                                        FD, 
                                                        null, 
                                                        date(DataSet.operdate), 
                                                        NATCUR, 
                                                        S,
                                                        null,
                                                        null,
                                                        DataSet.t_code,
                                                        "Удержание НДФЛ",
                                                        DtAccount,
                                                        CtAccount ) )
              stat = 1; 
              return msgbox( "Ошибка при выполнении проводки ВУ" );
            else

              stat = CreateDL_ACC (17,1,NATCUR,2,1,0,0,0,2,1,0,0,0,money(S),date(DataSet.operdate),date(DataSet.operdate),0,null,null,"",null,DataSet.Client,int(DataSet.CLIENTCONTRID));              if (stat > 0)
                return msgbox( "Ошибка при формировании РОВУ" ); 
              else
                if (    ПроводкаПоКатегориямВнутреннегоУчета(17, 
                                                             FD, 
                                                             null, 
                                                             date("19.11.2021"), 
                                                             NATCUR, 
                                                             S,
                                                             null,
                                                             null,
                                                             DataSet.t_code,
                                                             "Корректирующая проводка",
                                                             DtAccountN,
                                                             DtAccount)
                    and ПроводкаПоКатегориямВнутреннегоУчета(17, 
                                                             FD, 
                                                             null, 
                                                             date("19.11.2021"), 
                                                             NATCUR, 
                                                             S,
                                                             null,
                                                             null,
                                                             DataSet.t_code,
                                                             "Корректирующая проводка",
                                                             CtAccount,
                                                             CtAccountN)
                   )
                  PrintLine(FD.nptxop.rec, DtAccount.rec.account, CtAccount.rec.account, S, date(DataSet.operdate)); 
                else
                  return msgbox( "Ошибка при выполнении корректирующей проводки" );
                end;
              end;
            end;
         end;
        i = i + 1;
        Progress.Use();
  end;
  Progress.Remove;
END;

PRIVATE MACRO Запуск()
  var isNoData = false;

  ВыполнитьКорректировкуВу();
  Rep.PrintWinRep();
  Rep.ShowWinRep();

  return 0;
END;

Запуск();