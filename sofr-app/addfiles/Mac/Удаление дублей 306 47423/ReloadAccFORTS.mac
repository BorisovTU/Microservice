/*---------------------------------------------------------------------*/
/*  SetPersonRequestMsg.mac  - Адаптер для загрузки клиентов - физ.лиц */
/*    Подразумевается, что в рамках запроса приходит всегда 1 клиент   */
/*
      Обрабатываются ТОЛЬКО клиенты ГО (Filial.ObjectId = 0000)        */
/*                                                                     */
/* Автор: Гераськина Т.                                                */
/* 
    toDo: - информирование по e-mail
*/
/*----------------------------------------------*/
import "ws_msg_transform_sec.mac"; /* Инструментарий для преобразования сообщений */
import "ws_party.mac";             /* Сервис */
import rcw;
import "func_lib.mac";
import "PersonGetXref.mac";
import DealsInter;
import "rshb_lib.mac";
import SFInter, dlcontrfunc;
import "global_classes.mac";

private var g_error_text = "OK";

// поиск ЕД БО по номеру и клиенту, чтобы задействовать индекс
private macro FindDlContrByNumberAndClient(p_client_id, p_cntr_num, p_exist_email:@string)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid dl_id, dl.t_email "+
             " FROM dsfcontr_dbt cntr, "+
             "      ddlcontr_dbt dl "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND cntr.t_partyid = :p_client_id "+
             "  AND cntr.t_number = :p_cntr_num "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_client_id", RSDBP_IN, p_client_id);
   cmd.AddParam("p_cntr_num", RSDBP_IN, p_cntr_num);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("dl_id");
      p_exist_email = rs.value("t_email");
   end;
   
   return res;
end;


// поиск ЕД БО по номеру 
private macro FindDlContrByNumber(p_cntr_num, p_clnt:@integer)
   var sql_str, rs, cmd;
   var res = -1;
   var clntid = -1;
   
   sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid dl_id, dl.t_email, cntr.t_partyid "+
             " FROM dsfcontr_dbt cntr, "+
             "      ddlcontr_dbt dl "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND cntr.t_number = :p_cntr_num "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_cntr_num", RSDBP_IN, p_cntr_num);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("dl_id");
      p_clnt = rs.value("t_partyid");
   end;
   
   return res;
end;



// Описание контакта
private class adp_Contact(IncomeData, _nametag_up)
   var IsPrimary     :bool;      // Признак основного контакта          Нет
   var IsNotification:bool;      // Признак контакта для уведомлений    Нет
   var ContactCode   :string;    // Значение                            Да
   
   // символьные
   var ContactID     ;           // ИД контакта в АБС                   Нет
   
   // справочники
   var ContactType   ;           // Тип контакта                        Да
   var ContactProfile;           // Назначение                          Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Contact";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      IsPrimary      = getValueFromProperty(IncomeData, "IsPrimary"        , nametag_up);
      IsNotification = getValueFromProperty(IncomeData, "IsNotification"   , nametag_up);
      ContactCode    = getValueFromProperty(IncomeData, "ContactCode"      , nametag_up, true);
      
      ContactID      = getSymbolFromProperty(IncomeData, "ContactID"       , nametag_up);
      
      ContactType    = getDictionaryFromProperty(IncomeData, "ContactType"    , nametag_up, true);
      ContactProfile = getDictionaryFromProperty(IncomeData, "ContactProfile" , nametag_up);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Описание ДУЛ
private class adp_Credential(IncomeData, _nametag_up)
   var DocSeries     :String; // Серия                Нет
   var DocNumber     :String; // Номер                Да
   var IssueDate     :Date;   // Дата выдачи          Да
   var EndDate       :Date;   // Дата окончания       Нет
   var IssuerName    :String; // Кем выдан            Да
   var IssuerCode    :String; // Код подразделения    Нет
   
   // символьные
   var CredentialID  ;  // ИД ДУЛ в АБС               Нет
   
   // справочники
   var DocTypeCode   ;  // Код вида документа         Да
   var mDocTypeCode; 
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Credential";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      DocTypeCode    = getDictionaryFromProperty(IncomeData, "DocTypeCode", nametag_up, true);
      
      DocSeries      = getValueFromProperty(IncomeData, "DocSeries"  , nametag_up);
      DocNumber      = getValueFromProperty(IncomeData, "DocNumber"  , nametag_up, true);
      EndDate        = getValueFromProperty(IncomeData, "EndDate"    , nametag_up);
      IssuerCode     = getValueFromProperty(IncomeData, "IssuerCode" , nametag_up);
      
      CredentialID   = getSymbolFromProperty(IncomeData, "CredentialID", nametag_up);
      
      if (StrUpr(DocTypeCode.RecordCode) == "СНИЛС")
         IssueDate      = getValueFromProperty(IncomeData, "IssueDate"  , nametag_up);
         IssuerName     = getValueFromProperty(IncomeData, "IssuerName" , nametag_up);
      else
         IssueDate      = getValueFromProperty(IncomeData, "IssueDate"  , nametag_up, true);
         IssuerName     = getValueFromProperty(IncomeData, "IssuerName" , nametag_up, true);
      end;
      // теперь DocTypeCode содержит код ФНС
      mDocTypeCode = DocTypeCode.RecordCode;
      /*if (StrUpr(DocTypeCode.RecordCode) == "ПАСПОРТ")
         mDocTypeCode = 21;
      elif (StrUpr(DocTypeCode.RecordCode) == StrUpr("ЗагрПаспорт"))
         mDocTypeCode = 22;
      else
         mDocTypeCode = DocTypeCode;
      end; */
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Страна
private class adp_Citizenship(IncomeData, _nametag_up)
   var CitizenshipNumber  :String;  // Номер гражданства в АБС     Да
   
   // справочники
   var CitizenshipCode    ;         // Код страны                  Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Citizenship";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      CitizenshipNumber = getValueFromProperty(IncomeData, "CitizenshipNumber", nametag_up, true);
      
      CitizenshipCode   = getDictionaryFromProperty(IncomeData, "CitizenshipCode", nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Единичный адрес
private class adp_Address(IncomeData, _nametag_up)
   var AddressFullString   : String;   // Адрес одной строкой        Нет
   var District            : String;   // Район                      Нет
   var City                : String;   // Город                      Нет
   var Locality            : String;   // Населенный пункт           Нет
   var Street              : String;   // Улица                      Нет
   var House               : String;   // Дом (владение)             Нет
   var Building            : String;   // Корпус                     Нет
   var Apartment           : String;   // Квартира/офис              Нет
   var PostCode            : String;   // Почтовый индекс            Нет
   var Structure           : String;   // Строение                   Нет
   var HouseFiasGUID       : String;   // Код ФИАС                   Нет
   
   // символьные
   var AddressID           ;   // ИД адреса в АБС            Да
   
   // справочники
   var AddressType         ;   // Тип адреса        Да
   var CountryCode         ;   // Код страны        Да
   var RegionGNI           ;   // Код региона ГНИ   Нет
   var AddressRegionCode   ;   // Код региона       Нет
   
   var mAddressType;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "Address";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      AddressFullString = getValueFromProperty(IncomeData, "AddressFullString"   , nametag_up);
      District          = getValueFromProperty(IncomeData, "District"            , nametag_up);
      City              = getValueFromProperty(IncomeData, "City"                , nametag_up);
      Locality          = getValueFromProperty(IncomeData, "Locality"            , nametag_up);
      Street            = getValueFromProperty(IncomeData, "Street"              , nametag_up);
      House             = getValueFromProperty(IncomeData, "House"               , nametag_up);
      Building          = getValueFromProperty(IncomeData, "Building"            , nametag_up);
      Apartment         = getValueFromProperty(IncomeData, "Apartment"           , nametag_up);
      PostCode          = getValueFromProperty(IncomeData, "PostCode"            , nametag_up);
      Structure         = getValueFromProperty(IncomeData, "Structure"           , nametag_up);
      HouseFiasGUID     = getValueFromProperty(IncomeData, "HouseFiasGUID"       , nametag_up);
      
      AddressID         = getSymbolFromProperty(IncomeData, "AddressID", nametag_up, true);
      
      AddressType       = getDictionaryFromProperty(IncomeData, "AddressType"       , nametag_up, true);
      CountryCode       = getDictionaryFromProperty(IncomeData, "CountryCode"       , nametag_up, true);
      RegionGNI         = getDictionaryFromProperty(IncomeData, "RegionGNI"         , nametag_up);
      AddressRegionCode = getDictionaryFromProperty(IncomeData, "AddressRegionCode" , nametag_up);
      
      if ( StrUpr(AddressType.RecordCode) == StrUpr("АдрПроп") )
         mAddressType = 5; // Адрес места регистрации
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрФакт") )
         mAddressType = 2; // физический
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрПочт") )
         mAddressType = 3; // почтовый
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрМРож") )
         mAddressType = 7; // 
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрМраб") )
         mAddressType = 9; // 
      else
         err_txt = string("Недопустимое значение "+nametag_up+".AddressType.RecordCode=",AddressType.RecordCode);
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
      end;

   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Сведения о бенифициарном владельце
private class adp_BenefInfo(IncomeData, _nametag_up)
   var BehefOprKind  : String;      // Тип опроса клиента            Нет
   var BenefVlKind   : String;      // Тип выявленного бенефициара   Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "BenefInfo";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      BehefOprKind   = getValueFromProperty(IncomeData, "BehefOprKind"  , nametag_up);
      BenefVlKind    = getValueFromProperty(IncomeData, "BenefVlKind"   , nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Связанный субъект
private class adp_CoupledSubject(IncomeData, _nametag_up)
   var StartDate     : date;        // Начало действия связи      Да
   var EndDate       : date;        // Окончание действия связи   Нет
   
   // символьные
   var CSubjectID    ;              // ИД субъекта в АБС          Да
   
   // справочники
   var RoleCode      ;              // Код роли                   Да
   var CSubjectKind  ;              // Тип субъекта               Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "CoupledSubject";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
   
      StartDate   = getValueFromProperty(IncomeData, "StartDate"  , nametag_up, true);
      EndDate     = getValueFromProperty(IncomeData, "EndDate"    , nametag_up);
      
      CSubjectID  = getSymbolFromProperty(IncomeData, "CSubjectID", nametag_up, true);
      
      RoleCode    = getDictionaryFromProperty(IncomeData, "RoleCode"       , nametag_up, true);
      CSubjectKind= getDictionaryFromProperty(IncomeData, "CSubjectKind"   , nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// ГВК
private class adp_GVK(IncomeData, _nametag_up)
   var GVKCode    ;  // Код группы                  Да    Справочник

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "GVK";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      GVKCode = getDictionaryFromProperty(IncomeData, "GVKCode", nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// ОКВЭД
private class adp_OKVED(IncomeData, _nametag_up)
   var OKVEDType  ; // Тип классификатора ОКВЭД   Да     Справочник
   var OKVEDCode  ; // Код ОКВЭД                  Да     Справочник
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "OKVED";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      OKVEDCode = getDictionaryFromProperty(IncomeData, "OKVEDCode", nametag_up, true);
      OKVEDType = getDictionaryFromProperty(IncomeData, "OKVEDType", nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Информация о торговых площадках по Договорам
private class adp_TradingPlatforms(IncomeData, _nametag_up)
   var TradingPlatformCode;      // Код торговой площадки   Да     Справочник
   var TradingPlatformCurrency;  // Числовой код валюты     Да     Справочник
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "TradingPlatformInfo";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      TradingPlatformCode     = getDictionaryFromProperty(IncomeData, "TradingPlatformCode"     , nametag_up, true);
      TradingPlatformCurrency = getDictionaryFromProperty(IncomeData, "TradingPlatformCurrency" , nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// договор Брокерского обслуживания
private class adp_AgreementInfo(IncomeData, _nametag_up)
   var AgreementNumber  : string;      // Номер договора Брокерского обслуживания              Да
   var AgreementDate    : date;        // Дата заключения договора Брокерского обслуживания    Да
   var TradingPlatformsList;           // Список торговых площадках, относящихся к Договору
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt, aux_buff;
      var nametag_up = "AgreementInfo";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      AgreementNumber = getValueFromProperty(IncomeData, "AgreementNumber" , nametag_up, true);
      AgreementDate   = getValueFromProperty(IncomeData, "AgreementDate"   , nametag_up, true);
      
      var dlcontr_id_number = FindDlContrByNumber(AgreementNumber, null);
      if (dlcontr_id_number > 0)  // договор найден
      else  // проверка только для "новых"
         if ( ({curdate} - AgreementDate) > 7 )
            //err_txt = string("Дата договора "+AgreementDate+". Обрабатываются договора не старше 7 календарных дней ");
            //RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            // gtv: договора не обрабатываем, но клиента обновляем
            g_error_text = string("Дата договора "+AgreementDate+". Обрабатываются договора не старше 7 календарных дней ");
            AgreementNumber = NULL;
            AgreementDate = NULL;
         end;
      end;

      if (valtype(AgreementNumber) != V_UNDEF )
         aux_buff = uTryToGetPropS(IncomeData, "TradingPlatformsList");
         if(ValType(aux_buff) == V_GENOBJ)
            TradingPlatformsList = TArray;
            aux_buff = 0;
            while(IncomeData.TradingPlatformsList.size > aux_buff)
               TradingPlatformsList.value(TradingPlatformsList.size) = adp_TradingPlatforms(IncomeData.TradingPlatformsList.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
            if (dlcontr_id_number > 0)  // договор найден
            else
               err_txt = string("Задан договор "+AgreementNumber+" и отсутствуют торговые площадки ");
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         else
            err_txt = string(InErrNotObj, nametag_up+".TradingPlatformsList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;  
      end;

   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Person
private class c_Person(IncomeData)
   var LastName         : String;   // Фамилия                                                     Да
   var FirstName        : String;   // Имя                                                         Да
   var MiddleName       : String;   // Отчество                                                    Нет
   var BirthDate        : String;   // Дата рождения                                               Нет   "возможно: 00.00.ГГГГ / 00.ММ.ГГГГ / ДД.ММ.ГГГГ"
   var BirthPlace       : String;   // Место рождения                                              Нет
   var FIOLat           : String;   // ФИО латиницей                                               Нет
   var PadegFIOdat      : String;   // ФИО клиента в дательном падеже                              Нет
   var PadegFIOrod      : String;   // ФИО клиента в родительном падеже                            Нет
   var INN              : String;   // ИНН                                                         Нет
   var SuspiciousPerson : String;   // Признак подозрительного клиента                             Нет
   var CategoryDiasoft  : String;   // Категория клиента относительно Диасофт                      Нет
   var RiskLevel        : String;   // Уровень риска                                               Нет
   var RiskReason       : String;   // Обоснование риска                                           Нет
   var RPDL             : String;   // Статус ПДЛ (РПДЛ)                                           Нет
   var PDLDLPMO         : String;   // Статус ПДЛ (ДЛПМО)                                          Нет
   var IPDL             : String;   // Статус ИПДЛ                                                 Нет
   var IPDLrodstv       : String;   // ИПДЛ (степень родства)                                      Нет
   var PDDateAgr        : date;     // Дата оформления согласия на обработку персональных данных   Нет
   var FinConsBrok      : String;   // Финансовый консультант                                      Нет
   var PoinSaleBrok     : String;   // Наименование точки продаж                                   Нет
   var ListAcctsBrok    : String;   // Список текущих счетов                                       Нет
   var NumberSecBrok    : String;   // Количество покупаемых бумаг                                 Нет
   var QualifiedInvestor: String;   // 707. Квалифицированный инвестор                             Нет
   var UNKg             : String;   // Уникальный номер клиента глобальный                         Нет
   var Consent          : String;   // Согласие на передачу сведений в БКИ                         Нет
   var Document         : String;   // Номер документа                                             Нет
   var DateVid          : date;     // Дата выдачи документа                                       Нет
   var OrgVid           : String;   // Орган, выдавший свидетельство                               Нет
   var IssueName        : String;   // Выдан                                                       Нет
   var KPP              : String;   // Код причины постановки на учет                              Нет
   var OGRN             : String;   // Основной государственный рег. номер                         Нет
   var NumberPFR        : String;   // Страховой номер ПФР                                         Нет
   var SMBusinesses     : String;   // Субъект малого и среднего предпринимат                      Нет
   var SubjectCode      : String;   // Код субъекта кредитной истории                              Нет
   var HeadFIO          : String;   // ФИО руководителя                                            Нет

   // справочники
   var TypePerson       ;     // Отношения с Банком                        Да   "Клиент / Нет"
   var TypeClient       ;     // Тип клиента                               Нет
   var Gender           ;     // Пол                                       Да   "Мужской / Женский"
   var TaxStatus        ;     // Код страны налогового резидентства        Да
   var FATCA            ;     // FATCA-статус Возможные значения Да/Нет    Да 
   var CRS              ;     // Статус клиента в целях CRS                Да 
   var RegionCode       ;     // КодРегиона                                Да
   var Entity           ;     // Субъект                                   Нет
   var Ownership        ;     // Форма собственности                       Нет
   var TypeDocument     ;     // Код документа                             Нет
   var KindOfEntrepreneur;    // Признак клиента - ИП                      Нет 
   
   // символьные 
   var PersonID         ;     // Идентификатор клиента в филиале        Да
   var SOFRId           ;     // ИД в СОФР                              Нет
   var CIFId            ;     // Идентификатор клиента в филиале        Нет

   // списки
   var ContactsList;                // Список контактов                             Нет
   var CredentialList;              // Список ДУЛ                                   Нет
   var CitizenshipList;             // Гражданство (список)                         Нет
   var AddressList;                 // Список адресов                               Нет
   var BenefInfo;                   // Сведения о бенифициарном владельце           Нет
   var CoupledSubjectList;          // Перечень связанных субъектов                 Нет
   var GVKList;                     // Группы взаимосвязанных клиентов              Нет
   var OKVEDList;                   // Список ОКВЭД                                 Нет
   var AgreementInfoList;           // Список договоров Брокерского обслуживания    Нет
   
   var mNumfilial = 1;  // по умолчанию - ГО
   var mNameFilial = "0000";

   var agreement_temp;

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      var err_txt;
      var aux_buff;

      private var nametag_up = "SetPersonRequestMsg.SetPersonRequest.Person";
      
      LastName          = getValueFromProperty(IncomeData, "LastName"           , nametag_up, true);
      FirstName         = getValueFromProperty(IncomeData, "FirstName"          , nametag_up, true);
      MiddleName        = getValueFromProperty(IncomeData, "MiddleName"         , nametag_up);
      BirthDate         = getValueFromProperty(IncomeData, "BirthDate"          , nametag_up);
      BirthPlace        = getValueFromProperty(IncomeData, "BirthPlace"         , nametag_up);
      FIOLat            = getValueFromProperty(IncomeData, "FIOLat"             , nametag_up);
      PadegFIOdat       = getValueFromProperty(IncomeData, "PadegFIOdat"        , nametag_up);
      PadegFIOrod       = getValueFromProperty(IncomeData, "PadegFIOrod"        , nametag_up);
      INN               = getValueFromProperty(IncomeData, "INN"                , nametag_up);
      SuspiciousPerson  = getValueFromProperty(IncomeData, "SuspiciousPerson"   , nametag_up);
      CategoryDiasoft   = getValueFromProperty(IncomeData, "CategoryDiasoft"    , nametag_up);
      RiskLevel         = getValueFromProperty(IncomeData, "RiskLevel"          , nametag_up);
      RiskReason        = getValueFromProperty(IncomeData, "RiskReason"         , nametag_up);
      RPDL              = getValueFromProperty(IncomeData, "RPDL"               , nametag_up);
      PDLDLPMO          = getValueFromProperty(IncomeData, "PDLDLPMO"           , nametag_up);
      IPDL              = getValueFromProperty(IncomeData, "IPDL"               , nametag_up);
      IPDLrodstv        = getValueFromProperty(IncomeData, "IPDLrodstv"         , nametag_up);
      PDDateAgr         = getValueFromProperty(IncomeData, "PDDateAgr"          , nametag_up);
      FinConsBrok       = getValueFromProperty(IncomeData, "FinConsBrok"        , nametag_up);
      PoinSaleBrok      = getValueFromProperty(IncomeData, "PoinSaleBrok"       , nametag_up);
      ListAcctsBrok     = getValueFromProperty(IncomeData, "ListAcctsBrok"      , nametag_up);
      NumberSecBrok     = getValueFromProperty(IncomeData, "NumberSecBrok"      , nametag_up);
      QualifiedInvestor = getValueFromProperty(IncomeData, "QualifiedInvestor"  , nametag_up);
      UNKg              = getValueFromProperty(IncomeData, "UNKg"               , nametag_up);
      Consent           = getValueFromProperty(IncomeData, "Consent"            , nametag_up);
      Document          = getValueFromProperty(IncomeData, "Document"           , nametag_up);
      DateVid           = getValueFromProperty(IncomeData, "DateVid"            , nametag_up);
      OrgVid            = getValueFromProperty(IncomeData, "OrgVid"             , nametag_up);
      IssueName         = getValueFromProperty(IncomeData, "IssueName"          , nametag_up);
      KPP               = getValueFromProperty(IncomeData, "KPP"                , nametag_up);
      OGRN              = getValueFromProperty(IncomeData, "OGRN"               , nametag_up);
      NumberPFR         = getValueFromProperty(IncomeData, "NumberPFR"          , nametag_up);
      SMBusinesses      = getValueFromProperty(IncomeData, "SMBusinesses"       , nametag_up);
      SubjectCode       = getValueFromProperty(IncomeData, "SubjectCode"        , nametag_up);
      HeadFIO           = getValueFromProperty(IncomeData, "HeadFIO"            , nametag_up);
      
      TypePerson           = getDictionaryFromProperty(IncomeData, "TypePerson"           , nametag_up, true);
      TypeClient           = getDictionaryFromProperty(IncomeData, "TypeClient"           , nametag_up);
      Gender               = getDictionaryFromProperty(IncomeData, "Gender"               , nametag_up, true);
      TaxStatus            = getDictionaryFromProperty(IncomeData, "TaxStatus"            , nametag_up, true);
      FATCA                = getDictionaryFromProperty(IncomeData, "FATCA"                , nametag_up, true);
      CRS                  = getDictionaryFromProperty(IncomeData, "CRS"                  , nametag_up, true);
      RegionCode           = getDictionaryFromProperty(IncomeData, "RegionCode"           , nametag_up, true);
      Entity               = getDictionaryFromProperty(IncomeData, "Entity"               , nametag_up);
      Ownership            = getDictionaryFromProperty(IncomeData, "Ownership"            , nametag_up);
      TypeDocument         = getDictionaryFromProperty(IncomeData, "TypeDocument"         , nametag_up);
      KindOfEntrepreneur   = getDictionaryFromProperty(IncomeData, "KindOfEntrepreneur"   , nametag_up);

      PersonID    = getSymbolFromProperty(IncomeData, "PersonID" , nametag_up, true);
      SOFRId      = getSymbolFromProperty(IncomeData, "SOFRId"   , nametag_up);
      CIFId       = getSymbolFromProperty(IncomeData, "CIFId"    , nametag_up);
     
      // проверка значения по спискам
      if(ValType(TypePerson.RecordCode) != V_UNDEF)
/*         if ( (StrUpr(TypePerson.RecordCode) == StrUpr("Клиент")) or (StrUpr(TypePerson.RecordCode) == StrUpr("Нет")) ) 
         else
            err_txt = string("Недопустимое значение "+nametag_up+".TypePerson.RecordCode =",TypePerson.RecordCode);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end; */
      end;
      if(ValType(Gender.RecordCode) != V_UNDEF)
         if ( (StrUpr(Gender.RecordCode) == StrUpr("Мужской")) or (StrUpr(Gender.RecordCode) == StrUpr("Женский")) ) 
         else
            err_txt = string("Недопустимое значение "+nametag_up+".Gender.RecordCode =",Gender.RecordCode);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      aux_buff = uTryToGetPropS(IncomeData, "ContactsList");
      if(ValType(aux_buff) == V_GENOBJ)
         ContactsList = TArray;
         aux_buff = 0;
         while(IncomeData.ContactsList.size > aux_buff)
            ContactsList.value(ContactsList.size) = adp_Contact(IncomeData.ContactsList.value(aux_buff), nametag_up);
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".ContactsList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  

      aux_buff = uTryToGetPropS(IncomeData, "CredentialList");
      if(ValType(aux_buff) == V_GENOBJ)
         CredentialList = TArray;
         aux_buff = 0;
         while(IncomeData.CredentialList.size > aux_buff)
            CredentialList.value(CredentialList.size) = adp_Credential(IncomeData.CredentialList.value(aux_buff));
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".CredentialList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "CitizenshipList");
      if(ValType(aux_buff) == V_GENOBJ)
         CitizenshipList = TArray;
         aux_buff = 0;
         while(IncomeData.CitizenshipList.size > aux_buff)
            CitizenshipList.value(CitizenshipList.size) = adp_Citizenship(IncomeData.CitizenshipList.value(aux_buff));
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".CitizenshipList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "AddressList");
      if(ValType(aux_buff) == V_GENOBJ)
         AddressList = TArray;
         aux_buff = 0;
         while(IncomeData.AddressList.size > aux_buff)
            AddressList.value(AddressList.size) = adp_Address(IncomeData.AddressList.value(aux_buff));
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".AddressList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "BenefInfo");
      if(ValType(aux_buff) == V_GENOBJ)
         BenefInfo = adp_BenefInfo(aux_buff);
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".BenefInfo");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "GVKList");
      if(ValType(aux_buff) == V_GENOBJ)
         GVKList = TArray;
         aux_buff = 0;
         while(IncomeData.GVKList.size > aux_buff)
            GVKList.value(GVKList.size) = adp_GVK(IncomeData.GVKList.value(aux_buff), nametag_up+".GVKList");
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".GVKList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;        

      aux_buff = uTryToGetPropS(IncomeData, "OKVEDList");
      if(ValType(aux_buff) == V_GENOBJ)
         OKVEDList = TArray;
         aux_buff = 0;
         while(IncomeData.OKVEDList.size > aux_buff)
            OKVEDList.value(OKVEDList.size) = adp_OKVED(IncomeData.OKVEDList.value(aux_buff), nametag_up+".OKVEDList");
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".OKVEDList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end; 

      aux_buff = uTryToGetPropS(IncomeData, "CoupledSubjectList");
      if(ValType(aux_buff) == V_GENOBJ)
         CoupledSubjectList = TArray;
         aux_buff = 0;
         while(IncomeData.CoupledSubjectList.size > aux_buff)
            CoupledSubjectList.value(CoupledSubjectList.size) = adp_CoupledSubject(IncomeData.CoupledSubjectList.value(aux_buff), nametag_up+".CoupledSubjectList");
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".CoupledSubjectList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      aux_buff = uTryToGetPropS(IncomeData, "AgreementInfoList");
      if(ValType(aux_buff) == V_GENOBJ)
         AgreementInfoList = TArray;
         aux_buff = 0;
         while(IncomeData.AgreementInfoList.size > aux_buff)
            agreement_temp = adp_AgreementInfo(IncomeData.AgreementInfoList.value(aux_buff), nametag_up+".AgreementInfoList");
            if ( (ValType(agreement_temp) == V_GENOBJ) and (ValType(agreement_temp.AgreementNumber) != V_UNDEF) )
               AgreementInfoList.value(AgreementInfoList.size) = agreement_temp;
            end;
            aux_buff = aux_buff + 1;
         end;
         if (AgreementInfoList.size > 0)
            mNumfilial = GetNumFilialBy_AgreementNumber(AgreementInfoList.value(0).AgreementNumber, mNameFilial);
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".AgreementInfoList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;


// классы параметров для создания и обновления субъекта
private class c_PersonParm(p_req_data_obj)
   var UserID              : String;   // Операционист                           Да
   var RequestID           ;           // ИД запроса                             Да
   var FilialID            ;           // Код филиала                            Да
   var BranchID            ;           // Код подразделения                      Да
 
   var Person;                         // Данные клиента                         Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(p_req_data_obj)
      private var aux_buff;
      private var err_txt;
      private var nametag_up = "SetPersonRequestMsg.SetPersonRequest";

      UserID      = getValueFromProperty(p_req_data_obj, "UserID"    , nametag_up, true);
     
      RequestID   = getSymbolFromProperty(p_req_data_obj, "RequestID", nametag_up, true);
      FilialId    = getSymbolFromProperty(p_req_data_obj, "FilialId" , nametag_up, true);
      if (FilialId.ObjectID != "0000")
         err_txt = string("Филиал "+FilialId.ObjectID+" не подлежит обработке. Обрабатываются только клиенты ГО");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;

      BranchID    = getSymbolFromProperty(p_req_data_obj, "BranchID" , nametag_up, true);
      
      aux_buff = getValueFromProperty(p_req_data_obj, "Person", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            Person = c_Person(aux_buff);
         else
            err_txt = string(InErrNotObj, "Person");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;
   end; /* macro uInitPrime() */

   uInitPrime(p_req_data_obj);      
end;


// Найти, существует ли такой счет 
private macro FindAcc(currency, accnumber, accrec)
   var accfile = TBFile("account.dbt", "r", 0);

   accfile.rec.chapter = 1;
   accfile.rec.account = accnumber;
   accfile.rec.code_currency = currency;

   if (accfile.getEQ())
     copy(accrec, accfile);
   else
     accrec.rec.account = accnumber;
     accrec.rec.code_currency = currency;
   end;
end;


private macro FindOpenAccount(_accnum, _partyid)
   var curr = substr(_accnum,6,3);
   var accrec = TRecHandler("account.dbt");
   var stat, err_txt;
   record fininstr(fininstr);
   record account ("account.dbt");
   record accblnc ("accblnc.dbt");
   
   ПолучитьФинИнПоISO (curr, fininstr);
   
   // поиск и заполнение структуры
   FindAcc(fininstr.fiid, _accnum, accrec);
   if (accrec.rec.accountid > 0) // счет есть
   else
      clearrecord (account);
      clearrecord (accblnc);
   
      account.Chapter = 1;
      account.Account = _accnum;
      account.Balance = substr(_accnum,1,5);
      account.Kind_account = "П";
      account.Type_account = "Ф";
      account.Oper = {oper};
      account.Client = _partyid;
      account.Open_Date = {curdate};
 
      account.Department = {OperDprt};
      account.Branch = {OperDprt};

      accblnc.Chapter = account.chapter;
      accblnc.account = account.account;
      accblnc.Balance0 = account.balance;
      stat=Create_Account (account, accblnc);
      if (stat!=0)
         err_txt = "Ошибка открытия счета: "+GetErrMessage(stat);
         RunError(err_txt, c_err_obj(err_txt, stat));
      end;
   end;
   
end;


private macro GetSetAcc(_num_acc, _Namefilial, _partyid);
   var sql_str, rs, cmd;

   var SetAcc_temp;
   var numfil_agreement,pos;
   var _NumAgreement;

   SetAcc_temp = TWsSettAcc;
   SetAcc_temp.Chapter = 1;
   SetAcc_temp.FICOde = GetFiCodeNatCur();
   SetAcc_temp.Account = _num_acc;

   sql_str = "select t_settaccid, t_order from dsettacc_dbt "+
             " where t_partyid = :partyid and t_account = :account and t_chapter = :chapter and t_fiid = :fiid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("account", RSDBP_IN, _num_acc);
   cmd.AddParam("chapter", RSDBP_IN, SetAcc_temp.Chapter);
   cmd.AddParam("fiid"   , RSDBP_IN, 0);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      SetAcc_temp.Order = rs.value("t_order");
      SetAcc_temp.Action = "MODIFY";
   else
      SetAcc_temp.Order = 0;
      SetAcc_temp.Action = "ADD";
   end;

   if (not _Namefilial)
      SetAcc_temp.BankCode = GetBankCode(1, SetAcc_temp.BankCodeKind);
   else
      SetAcc_temp.BankCode = GetBankCode(_Namefilial, SetAcc_temp.BankCodeKind);
   end;

   SetAcc_temp.ShortName = "Доход ЦБ";
   
   return SetAcc_temp;
end;

private class c_trade_platform(IncomeData)
   var NameTrade;
   var Curr = TArray;
   
   private macro uInitPrime(IncomeData)
      var temp_str, pos1, pos2, ttt;
      pos1 = Index(IncomeData,"(");
      pos2 = Index(IncomeData,")");
      temp_str = IncomeData;
            
      if ( (pos1 > 0) and (pos2 > 0) ) // название площадки
         NameTrade = Substr(IncomeData,1,pos1-1);
         temp_str = Substr(IncomeData,pos1+1,pos2-pos1-1);
         pos1 = Index(temp_str,",");
      end;
      while (pos1 > 0)
         ttt = Substr(temp_str,1,pos1-1);
         Curr.value(Curr.size) = ttt;
         temp_str = Substr(temp_str,pos1+1);
         pos1 = Index(temp_str,",");
      end;
      if ( StrLen(temp_str) > 0 )
         Curr.value(Curr.size) = temp_str;
      end;
   end;
   uInitPrime(IncomeData);
end;

private class c_trade_Contract(IncomeData)
   var NumContract;
   var TradePlatform = TArray;
   
   private macro uInitPrime(IncomeData)
      var temp_str, pos, ttt;
      var delim = ";";
      
      temp_str = IncomeData;
      pos = Index(temp_str,delim);
      if (pos > 0) // номер договора
         NumContract = Substr(temp_str,1,pos-1);
         temp_str = Substr(temp_str,pos+1);
         pos = Index(temp_str,delim);
      end;
      while (pos > 0)
         ttt = Substr(temp_str,1,pos-1);
         TradePlatform.value(TradePlatform.size) = c_trade_platform(ttt);
         temp_str = Substr(temp_str,pos+1);
         pos = Index(temp_str,delim);
      end;
      if ( StrLen(temp_str) > 0 )
         TradePlatform.value(TradePlatform.size) = c_trade_platform(temp_str);
      end;
   end;
   uInitPrime(IncomeData);
end;

// данные, подготовленные для вставки/обновления
private class adp_Party(IncomeData, _partyid)
   var PersnParam /*: TWsPersn*/;    // Атрибуты физического лица 
   var InstParam  /*: TWsInst*/;     // Атрибуты юридического лица 
   var ClientParam /*: TArray*/;     // Атрибуты клиента по виду обслуживния
   var Codes /*: TArray*/;           // Атрибуты кодов субъекта 
   var Addresses/* : TArray*/;       // Список адресов субъекта экономики
   var Contacts /*: TArray*/;        // Список контактной информация субъекта экономики
   var PersnPapers /*: TArray*/;     // Список документов, удостоверяющих личность субъекта экономики
   var RegDocs /*: TArray*/;         // Список регистрационных документов субъекта экономики
   var PartyNotes /*: TArray*/;      // Список примечаний субъекта экономики
   var PersnNotes /*: TArray*/;      // Список примечаний субъекта - физического лица
   var SettAccs /*: TArray*/;        // СПИ субъекта (массив структур TWsSettAcc)
   var Codes_weak;

   var Names : TArray;           // Список наименований субъекта
   var Categories: TArray;       // Список категорий субъекта экономики
   var Employees: TArray;        // Список сотрудников организации

   var PartyCode; /*: TWsPartyCode*/  /* Код субъекта для поиска. */ 
   var Notes_weak;
   
   private var Code_temp : TWsPartyCode;  
   private var Name_temp, Category_temp, Contacts_temp, address_temp, paper_temp, note_temp, SetAcc_temp;  
   
   var aux_buff;
   var DUL;
   var stt, pos, temp_str, ttt;
   var code_value, num_filial;
   var pp;
   var MainChecked;
   var Structure_building, NumCopr_building;

   var GVK, OKVED;
   var email_contract;
   var v_IsSingle;
   var mAdr, address_temp_ni;

   var OKATO_gni;
   
   // физик 
   PersnParam = TWsPersn;
   InstParam = NULL;
      
   PersnParam.LastName = trim(IncomeData.Person.LastName);
   PersnParam.FirstName = trim(IncomeData.Person.FirstName);
   PersnParam.Patronymic = trim(IncomeData.Person.MiddleName);
      
   if (ValType(IncomeData.Person.TaxStatus) != V_UNDEF)
      if (StrUpr(IncomeData.Person.TaxStatus.RecordCode) == "RUS")
         PersnParam.IsNotResident = false;
      else
         PersnParam.IsNotResident = true;
      end;
      PersnParam.NRCountry  = StrUpr(IncomeData.Person.TaxStatus.RecordCode);  //Справочник ?
   end;

   PersnParam.BirthDate = date(IncomeData.Person.BirthDate);  //????
   PersnParam.BirthPlace = IncomeData.Person.BirthPlace;
   PersnParam.PlaceWork = NULL;
   if (ValType(IncomeData.Person.Gender) != V_UNDEF)
      if (StrUpr(IncomeData.Person.Gender.RecordCode) == StrUpr("Мужской"))
         PersnParam.Male = 1;
      end;
   end;
   
   if (ValType(IncomeData.Person.KindOfEntrepreneur) != V_UNDEF)
      if ( (IncomeData.Person.KindOfEntrepreneur == "Предпр") or  (IncomeData.Person.KindOfEntrepreneur == "Пред_юр") )
         PersnParam.IsEmployer = true;
      end;
   end;
   
   // коды субъекта
   Codes = TArray;

   if (ValType(IncomeData.Person.INN) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PTCK_INN;
      Code_temp.Code = IncomeData.Person.INN;
      if (ValType(IncomeData.Person.KPP) != V_UNDEF)
         Code_temp.Code = Code_temp.Code + "/" + IncomeData.Person.KPP;
      end;
      Codes.value(Codes.size) = Code_temp;

      pp = GetPartyID_byPartyCode(PTCK_MNS, substr(IncomeData.Person.INN,1,4));
      if (pp > 0)
         PersnParam.TaxInstitution = pp;
      end;

   end;
   
   /* SOFRId - это partyid
   if (ValType(IncomeData.Person.SOFRId) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PTCK_CONTR;
      Code_temp.Code = IncomeData.Person.SOFRId.ObjectID;
      Codes.value(Codes.size) = Code_temp;
   end;*/
  
   // код Бисквит
   if (ValType(IncomeData.Person.PersonID) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_ABS;
      
/*      if (ValType(IncomeData.FilialId) != V_UNDEF)
         num_filial = IncomeData.FilialId.ObjectId;
      else
         num_filial = "0000";
      end; */
      num_filial = "0000";
      Code_temp.Code = MakeCodeABS(IncomeData.Person.PersonID.ObjectID, num_filial, 3);
      Codes.value(Codes.size) = Code_temp;
      
      // если указан код Бисквит, значит, это и код 1 тоже
      // code_value = IncomeData.Person.PersonID.ObjectID;
      code_value = Code_temp.Code; // совпадает с кодом PARTY_CODEKIND_ABS
   else
      // если не указан - последовательность
      if (GenerateReference( UREFERENCE_PARTY_CODE, code_value ) != 0)
         code_value = StrFor(1);
      end;
   end;

   Code_temp = TWsPartyCode;
   Code_temp.CodeKind = PTCK_CONTR;
   Code_temp.Code = code_value;
   Codes.value(Codes.size) = Code_temp;

   /* код CIF не сохраняем
   if (ValType(IncomeData.Person.CIFId) != V_UNDEF)   
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_CIF;
      Code_temp.Code = IncomeData.Person.CIFId.ObjectId;
      Codes.value(Codes.size) = Code_temp;
   end; */
   
   if (ValType(IncomeData.Person.OGRN) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = 27;
      Code_temp.Code = IncomeData.OGRN;
      Codes.value(Codes.size) = Code_temp;
   end;
   
   // СНИЛС
   if (ValType(IncomeData.Person.NumberPFR) != V_UNDEF)
      Codes_weak = TArray;
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_SNILS;
      Code_temp.Code = IncomeData.Person.NumberPFR;
      Codes_weak.value(Codes_weak.size) = Code_temp;
   end;
   
   // наименования
   if (ValType(IncomeData.Person.FIOLat) != V_UNDEF)
      Names = TArray;
      
      Name_temp = adp_Names;
      Name_temp.PartyNameID = 3;    // полное наименование латиницей
      Name_temp.Name = IncomeData.Person.FIOLat;
      Names.value(Names.size) = Name_temp;
   end;
   
   // категории
   Categories = TArray;
   
   // Признак подозрительного клиента
   if (ValType(IncomeData.Person.SuspiciousPerson) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 54;
      if (StrUpr(IncomeData.Person.SuspiciousPerson) == "ДА")
         Category_temp.Value = 1;
      else
         Category_temp.Value = 2;
      end;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;   
   
   // FATCA
   if (ValType(IncomeData.Person.FATCA) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 108;
      if (StrUpr(IncomeData.Person.FATCA.RecordCode) == "ДА")
         Category_temp.Value = 1;
      else
         Category_temp.Value = 2;
      end;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;  
   end;
   
   // CRS
   if (ValType(IncomeData.Person.CRS) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 109;
      if (StrUpr(IncomeData.Person.CRS.RecordCode) == "ДА")
         Category_temp.Value = 1;
      else
         Category_temp.Value = 2;
      end;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;   
   end;
   
   // Субъект малого и среднего предпринимательства
   if (ValType(IncomeData.Person.SMBusinesses) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 39;
      Category_temp.Value = IncomeData.Person.SMBusinesses;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;
   
   // Код ОКФС
   if (ValType(IncomeData.Person.Ownership) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 27;
      Category_temp.Value = IncomeData.Person.Ownership.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;
         
   // Группа взаимосвязанных субъектов
   if (ValType(IncomeData.Person.GVKList) != V_UNDEF)
      v_IsSingle = GetSingleSign(OBJTYPE_PARTY, 20);
      for (GVK, IncomeData.Person.GVKList)
         Category_temp = adp_Categories;
         Category_temp.GroupID = 20;
         Category_temp.Value = GVK.GVKCode.RecordCode;
         Category_temp.IsSingle = v_IsSingle;
         Categories.value(Categories.size) = Category_temp;
      end;
   end;
         
   // ОКВЭД
   if (ValType(IncomeData.Person.OKVEDList) != V_UNDEF)
      v_IsSingle = GetSingleSign(OBJTYPE_PARTY, 17);
      for (OKVED, IncomeData.Person.OKVEDList)
         Category_temp = adp_Categories;
         Category_temp.GroupID = 17;
         Category_temp.Value = OKVED.OKVEDCode.RecordCode;
         Category_temp.IsSingle = v_IsSingle;
         Categories.value(Categories.size) = Category_temp;
      end;
   end;
   
   // ДУЛ
   aux_buff = ValType(IncomeData.Person.CredentialList);  // тип элемента 
   if(aux_buff == V_GENOBJ)
      PersnPapers = TArray;
      MainChecked = false;
      aux_buff = 0;
      while(IncomeData.Person.CredentialList.size > aux_buff)
/*         if (StrUpr(IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode) == "91" )
            Codes_weak = TArray;
            Code_temp = TWsPartyCode;
            Code_temp.CodeKind = PARTY_CODEKIND_SNILS;
            Code_temp.Code = IncomeData.Person.CredentialList.value(aux_buff).DocNumber;
            Codes_weak.value(Codes_weak.size) = Code_temp;
         else*/
            paper_temp = TWsPaper;
            paper_temp.Kind = IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode;
            paper_temp.Series = IncomeData.Person.CredentialList.value(aux_buff).DocSeries;
            paper_temp.Number = IncomeData.Person.CredentialList.value(aux_buff).DocNumber;
            paper_temp.IssuedDate = IncomeData.Person.CredentialList.value(aux_buff).IssueDate;
            paper_temp.ValidToDate = IncomeData.Person.CredentialList.value(aux_buff).EndDate;
            paper_temp.Issuer = IncomeData.Person.CredentialList.value(aux_buff).IssuerName;
            paper_temp.IssuerCode = IncomeData.Person.CredentialList.value(aux_buff).IssuerCode;

            //    var CredentialID  ; // ИД ДУЛ в АБС                  Да
            
            if ( (IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode == 21) and (not PersnParam.IsNotResident) ) // паспорт гражданина РФ
               paper_temp.IsMain = true;
               MainChecked = true;
            elif ( (IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode == 22) and (PersnParam.IsNotResident) ) // загран паспорт?
               paper_temp.IsMain = true;
               MainChecked = true;
            end;
            PersnPapers.value(PersnPapers.size) = paper_temp;
         //end;
         aux_buff = aux_buff + 1;
      end;
      if (not MainChecked)
         PersnPapers.value(0).IsMain = true;
      end;
   end;
    
   // адреса
   aux_buff = ValType(IncomeData.Person.AddressList);  // тип элемента 
   if(aux_buff == V_GENOBJ)
      Addresses = TArray;
      aux_buff = 0;
      while(IncomeData.Person.AddressList.size > aux_buff)
         address_temp = TWsAdres;
         address_temp.Type = TArray;
         mAdr = IncomeData.Person.AddressList.value(aux_buff).mAddressType; 
         address_temp.Type.value(address_temp.Type.size) = mAdr;
         address_temp.Country = IncomeData.Person.AddressList.value(aux_buff).CountryCode.RecordCode;
         address_temp.PostIndex = IncomeData.Person.AddressList.value(aux_buff).PostCode;
         if (ValType(IncomeData.Person.AddressList.value(aux_buff).AddressRegionCode) != V_UNDEF)
            address_temp.Region = GetRegionCode(IncomeData.Person.AddressList.value(aux_buff).AddressRegionCode.RecordCode, address_temp.RegionNumber, address_temp.Okato);
            address_temp.CodeRegion = GetCodeAdmUnit(address_temp.Region, "REGION");
         end;
         //address_temp.Region = IncomeData.Person.AddressList.value(aux_buff).District;    // область
         
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).District) != V_UNDEF)
            address_temp.Province = IncomeData.Person.AddressList.value(aux_buff).District;  // район
            address_temp.CodeProvince = GetCodeAdmUnit(address_temp.Province, "PROVINCE");
         end;
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).Locality) != V_UNDEF)
            address_temp.Place = IncomeData.Person.AddressList.value(aux_buff).Locality;         // населенный пункт
            address_temp.CodePlace = GetCodeAdmUnit(address_temp.Place, "PLACE");
         end;
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).City) != V_UNDEF)
            address_temp.District = IncomeData.Person.AddressList.value(aux_buff).City;  // город
            address_temp.CodeDistrict = GetCodeAdmUnit(address_temp.District, "CITY");
         end;
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).Street) != V_UNDEF)
            address_temp.Street = IncomeData.Person.AddressList.value(aux_buff).Street;      // улица
            address_temp.CodeStreet = GetCodeAdmUnit(address_temp.Street, "STREET");
         end;
         address_temp.House = IncomeData.Person.AddressList.value(aux_buff).House;        // дом
         address_temp.NumCorps = IncomeData.Person.AddressList.value(aux_buff).Building;  // корпус
         address_temp.Flat = IncomeData.Person.AddressList.value(aux_buff).Apartment;     // квартира
         // строение
         if (ValType(IncomeData.Person.AddressList.value(aux_buff).Structure) != V_UNDEF)
            Structure_building = Trim(IncomeData.Person.AddressList.value(aux_buff).Structure);
            if (ValType(IncomeData.Person.AddressList.value(aux_buff).Building) == V_UNDEF)
               address_temp.NumCorps = IncomeData.Person.AddressList.value(aux_buff).Structure;
            else
               NumCopr_building = Trim(IncomeData.Person.AddressList.value(aux_buff).Building);
               address_temp.NumCorps = NumCopr_building + " стр " + Structure_building;
               if ( StrLen(address_temp.NumCorps) > 10 )
                  if ( StrLen(NumCopr_building) + StrLen(Structure_building) > 5) 
                     address_temp.NumCorps = NumCopr_building + " " + Structure_building;
                  end;
               end;
            end;
         end;

         if (ValType(address_temp.Adress) == V_UNDEF)
             address_temp.Adress = usr_GenResultAddressUser(address_temp);
         end;
         
         if (not PersnParam.TaxInstitution)
            if (ValType(IncomeData.Person.AddressList.value(aux_buff).RegionGNI) != V_UNDEF)
               pp = GetPartyID_byPartyCode(PTCK_MNS, IncomeData.Person.AddressList.value(aux_buff).RegionGNI.RecordCode+"00");
               if (pp > 0)
                  PersnParam.TaxInstitution = pp;
               end;
            end;
         end;

         //var AddressID     ;   // ИД адреса в АБС            Да
         //var HouseFiasGUID : String;   // Код ФИАС                   Нет
         
         Addresses.value(Addresses.size) = address_temp;
         aux_buff = aux_buff + 1;

         if (mAdr == 5)
            OKATO_gni = address_temp.Okato;

            address_temp_ni = TWsAdres;

            address_temp_ni.Type = TArray;
            address_temp_ni.Type.value(address_temp_ni.Type.size) = 4;
            address_temp_ni.Country = address_temp.Country;
            address_temp_ni.PostIndex = address_temp.PostIndex;
            address_temp_ni.Region = address_temp.Region;
            address_temp_ni.CodeRegion = address_temp.CodeRegion;
            address_temp_ni.RegionNumber = address_temp.RegionNumber;
            address_temp_ni.Okato = address_temp.Okato;
            address_temp_ni.Province = address_temp.Province;
            address_temp_ni.CodeProvince = address_temp.CodeProvince;
            address_temp_ni.Place = address_temp.Place;
            address_temp_ni.CodePlace = address_temp.CodePlace;
            address_temp_ni.District = address_temp.District;
            address_temp_ni.CodeDistrict = address_temp.CodeDistrict;
            address_temp_ni.Street = address_temp.Street;
            address_temp_ni.CodeStreet = address_temp.CodeStreet;
            address_temp_ni.House = address_temp.House;
            address_temp_ni.NumCorps = address_temp.NumCorps;
            address_temp_ni.Flat = address_temp.Flat;
            address_temp_ni.NumCorps = address_temp.NumCorps;
            address_temp_ni.Adress = address_temp.Adress;
                        
            Addresses.value(Addresses.size) = address_temp_ni;
         end;

      end;
   end;  

   // Код ОКАТО
   if (ValType(OKATO_gni) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 12;
      Category_temp.Value = OKATO_gni;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;

   
   // контакты
   aux_buff = ValType(IncomeData.Person.ContactsList);  // тип элемента 
   if ( aux_buff == V_GENOBJ )
      Contacts = TArray;
      aux_buff = 0;
      while(IncomeData.Person.ContactsList.size > aux_buff)
         Contacts_temp = TWsContactInfo;
         if (IncomeData.Person.ContactsList.value(aux_buff).IsPrimary)
            //Contacts_temp.IsMain = true;
         end;
         Contacts_temp.AdresType = 1;  // юридический
         Contacts_temp.Value = IncomeData.Person.ContactsList.value(aux_buff).ContactCode;
         
         if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactType.RecordCode) == StrUpr("E-mail") )
            Contacts_temp.Kind = 5;       // адрес электронной почты
            email_contract = Contacts_temp.Value;
            Contacts_temp.Category = 8;  // gtv: для всех ставим "для отчетов"
/*            if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("Рабочий") )
               Contacts_temp.Category = 1001;
            else
               Contacts_temp.Category = 0;
            end;*/
         elif ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactType.RecordCode) == StrUpr("Телефон") )
            Contacts_temp.Kind = 1;       // телефон
            if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("Рабочий") )
               Contacts_temp.Category = 2;
            elif ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("Мобильный") )
               Contacts_temp.Category = 1;
            else
               Contacts_temp.Category = 3;
            end;
         end;
      
         Contacts.value(Contacts.size) = Contacts_temp;
         aux_buff = aux_buff + 1;
      end;
   end;

   if ( (ValType(IncomeData.Person.PadegFIOrod) != V_UNDEF) or (ValType(IncomeData.Person.PadegFIOdat) != V_UNDEF) 
        or (ValType(IncomeData.Person.RPDL) != V_UNDEF) or (ValType(IncomeData.Person.PDLDLPMO) != V_UNDEF) or (ValType(IncomeData.Person.IPDL) != V_UNDEF)
      )
      PersnNotes = TArray;
   
      if (ValType(IncomeData.Person.PadegFIOrod) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 49;
         note_temp.NoteText = IncomeData.Person.PadegFIOrod;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.PadegFIOdat) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 52;
         note_temp.NoteText = IncomeData.Person.PadegFIOdat;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.RPDL) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 75;
         note_temp.NoteText = IncomeData.Person.RPDL;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.PDLDLPMO) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 75;
         note_temp.NoteText = IncomeData.Person.PDLDLPMO;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.IPDL) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 75;
         note_temp.NoteText = IncomeData.Person.IPDL;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;

      // дистрибутивно не заполняется
      Notes_weak = TArray(PersnNotes);
      PersnNotes = null;
      
   end;
   
   // Список текущих счетов
   if ( (ValType(IncomeData.Person.ListAcctsBrok) != V_UNDEF) and (StrLen(Trim(IncomeData.Person.ListAcctsBrok)) > 0) )

      SettAccs = TArray;
      temp_str = IncomeData.Person.ListAcctsBrok;
      pos = Index(temp_str,",");
      while (pos > 0)
         ttt = Substr(temp_str,1,pos-1);
         SetAcc_temp = GetSetAcc(ttt, IncomeData.Person.mNameFilial, _partyid);
         SettAccs.value(SettAccs.size) = SetAcc_temp;
         temp_str = Substr(temp_str,pos+1);
         pos = Index(temp_str,",");
      end;
      if ( StrLen(temp_str) > 0 )
         SetAcc_temp = GetSetAcc(temp_str, IncomeData.Person.mNameFilial, _partyid);
         SettAccs.value(SettAccs.size) = SetAcc_temp;
      end;
   end;
   
/*  ???
      FinConsBrok       = getValueFromProperty(IncomeData, "FinConsBrok"        , nametag_up);
      PoinSaleBrok      = getValueFromProperty(IncomeData, "PoinSaleBrok"       , nametag_up);
      QualifiedInvestor = getValueFromProperty(IncomeData, "QualifiedInvestor"  , nametag_up);
      UNKg              = getValueFromProperty(IncomeData, "UNKg"               , nametag_up);
      HeadFIO           = getValueFromProperty(IncomeData, "HeadFIO"            , nametag_up);
      TypePerson           = getDictionaryFromProperty(IncomeData, "TypePerson"           , nametag_up, true);
   var CitizenshipList;             // Гражданство (список)                         Нет
???  */

/*  не обрабатываем
      TypeClient           = getDictionaryFromProperty(IncomeData, "TypeClient"           , nametag_up);
      CategoryDiasoft   = getValueFromProperty(IncomeData, "CategoryDiasoft"    , nametag_up);
      IPDLrodstv        = getValueFromProperty(IncomeData, "IPDLrodstv"         , nametag_up);
      PDDateAgr         = getValueFromProperty(IncomeData, "PDDateAgr"          , nametag_up);
      BenefInfo = adp_BenefInfo(aux_buff);
      NumberSecBrok     = getValueFromProperty(IncomeData, "NumberSecBrok"      , nametag_up);
      Consent           = getValueFromProperty(IncomeData, "Consent"            , nametag_up);      
      Entity               = getDictionaryFromProperty(IncomeData, "Entity"               , nametag_up);      
      Document          = getValueFromProperty(IncomeData, "Document"           , nametag_up);
      DateVid           = getValueFromProperty(IncomeData, "DateVid"            , nametag_up);
      OrgVid            = getValueFromProperty(IncomeData, "OrgVid"             , nametag_up);
      IssueName         = getValueFromProperty(IncomeData, "IssueName"          , nametag_up);
      SubjectCode       = getValueFromProperty(IncomeData, "SubjectCode"        , nametag_up);
      TypeDocument         = getDictionaryFromProperty(IncomeData, "TypeDocument"         , nametag_up);
      RegionCode           = getDictionaryFromProperty(IncomeData, "RegionCode"           , nametag_up, true);
      */
 
end;


macro SetCodesWeak(p_PartyID, p_Codes_weak)
   var codes_parm;
   var sql_str, rs, cmd;
   var cnt;
   var objectid = -1;
   var err_txt;
   
   for (codes_parm, p_Codes_weak)
      sql_str = "select t_objectid from dobjcode_dbt where t_objecttype = 3 and t_codekind = :codekind and t_code = :code and t_state = 0";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
      cmd.AddParam("code", RSDBP_IN, codes_parm.code);
      rs = RSDRecordSet(cmd);
      if (rs.movenext)
         objectid = rs.value("t_objectid");
      end;
      cmd.close; rs.close; cmd = null; rs = null;
      
      if (objectid <= 0 )
         sql_str =   "Insert into DOBJCODE_DBT "+
                     "   (T_OBJECTTYPE, T_CODEKIND, T_OBJECTID, T_CODE, T_STATE, "+
                     "    T_BANKDATE, T_SYSDATE, T_SYSTIME, T_USERID, T_BRANCH, "+
                     "    T_NUMSESSION, T_UNIQUE, T_AUTOKEY, T_BANKCLOSEDATE, T_NORMCODE) "+
                     " Values "+
                     "   (3, :codekind, :objectid, :code, 0, "+
                     "    :bankdate, sysdate, sysdate, :oper, 1, "+
                     "    0, 'X', 0, TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), chr(1)) ";
         cmd = RSDCommand(sql_str);
         cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
         cmd.AddParam("objectid", RSDBP_IN, p_PartyID);
         cmd.AddParam("code", RSDBP_IN, codes_parm.code);
         cmd.AddParam("bankdate", RSDBP_IN, {curdate});
         cmd.AddParam("oper", RSDBP_IN, {oper});
         cmd.execute;
      else
         if (objectid != p_PartyID)
            err_txt = "Существует код "+codes_parm.CodeKind+": "+codes_parm.code+" у субъекта "+objectid;
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         elif (objectid == p_PartyID)
            sql_str = "update dobjcode_dbt set t_code = :code, T_BANKDATE = :bankdate where t_objecttype = 3 and t_codekind = :codekind and t_objectid = :objectid";
            cmd = RSDCommand(sql_str);
            cmd.AddParam("code", RSDBP_IN, codes_parm.code);
            cmd.AddParam("bankdate", RSDBP_IN, {curdate});
            cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
            cmd.AddParam("objectid", RSDBP_IN, objectid);
            cmd.execute;
         end;
      end;
   end;
   
end;


// ручная установка примечаний
macro SetNotesWeak(p_PartyID, p_Notes_weak)
   var notes_parm;
   var notes;
   var ObjectType = OBJTYPE_PARTY;
   var ObjectId = string(p_PartyID:o:10);
   
   for (notes_parm, p_Notes_weak)
      notes = readNoteForObject( ObjectType, ObjectId, notes_parm.NoteKind);
      if ( (notes) and (notes != notes_parm.NoteText) )
         addNoteForObject( ObjectType, ObjectId, notes_parm.NoteKind, notes_parm.NoteText, notes_parm.Date);
      end;
   end;

end;


// инициализация параметров единого договора
private macro InitDlContrPrm()
   var DlContrPrm = TRecHandler("dlcontrprm.rec");
   
   ClearRecord(DlContrPrm);
   DlContrPrm.rec.DLCONTRID = 0;             //Идентификатор. При создании нового ДБО, если больше нуля, то установить = 0
   DlContrPrm.rec.DEPARTMENT = {OperDprt};   //Филиал. Если 0, то ошибка "Филиал должен быть задан"
   //DlContrPrm.rec.NUMBER = "";             //Номер договора.  Если не заполнен, то при вставке выделится автоматически
   //DlContrPrm.rec.ACCCODE = "";                // Код в номере л/с. Если не заполнен, то при вставке выделится автоматически 
   //DlContrPrm.rec.NAME   = "";             //Название
   DlContrPrm.rec.DATEBEGIN = {curdate};     //Дата открытия. Если 01.01.0001, то ошибка "Не задана дата открытия ДБО"
   DlContrPrm.rec.PARTYID = 0;               //Клиент. Если <= 0, то ошибка "Не задан идентификатор клиента". Если > 0, то найти запись в DPARTY_DBT, где DPARTY_DBT.rec.T_PARTYID = переданному значению. Если не найдена, то ошибка "Субъект с заданным идентификатором не найден".
   //DlContrPrm.rec.MARKETCODE = "";             //Единый код на бирже. Если не заполнен, то при вставке выделится автоматически при необходимости
   //DlContrPrm.rec.PLANID = 0;              //Единый тарифный план. По умолчанию 0. Если не найдена, то ошибка "Указанный единый тарифный план не найден в списке тарифных планов".
   //DlContrPrm.rec.IIS = StrFor(0);             //Признак договора ИИС. Если задан, а клиент не является физлицом, то ошибка "Нельзя устанавливать признак договора ИИС для клиента не являющегося физ. лицом"
   //DlContrPrm.UNIDEPOCONTRID = 0;          //Идентификатор СДО депо. По умолчанию 0. Если не найдена, то ошибка "Не найден указанный сводный договор депозитарного обслуживания".
   //DlContrPrm.rec.INEXTDEPO = StrFor(0);       //Признак "Обслуживание в стороннем депозитарии"
   DlContrPrm.rec.USESUBACC = StrFor(0);       //Признак "Открывать субсчета для брокерских счетов"
   //DlContrPrm.rec.IISFIRSTDATE = date(0,0,0);  //Дата открытия первого ИИС для клиента. Если T_IIS не задан, то 01.01.0001
   //DlContrPrm.rec.IISFIRSTBROKERNAME = "";     //Наименование брокера, у которого был открыт первый ИИС клиента. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISFIRSTNUMBER = "";         //Номер первого договора ИИС клиента. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISTRANSFER = StrFor(0);     //Признак открытия ИИС с переводом от брокера. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISLASTBROKERNAME = "";      //Наименование брокера, закрывающего ИИС клиента. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISLASTNUMBER = "";          //Номер договора на ведение ИИС у брокера. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISLASTOPENDATE = date(0,0,0);  //Дата открытия ИИС клиента у брокера. Если T_IIS не задан, то 01.01.0001
   //DlContrPrm.rec.IISLASTCLOSEDATE = date(0,0,0); //Дата закрытия ИИС клиента у брокера. Если T_IIS не задан, то 01.01.0001
   //DlContrPrm.rec.IISLASTYEAR = 0;             //Налоговый период, в котором произошло закрытие договора ИИС у брокера. Если T_IIS не задан, то 0
   //DlContrPrm.rec.IISLASTINSUM = 0;            //Сумма внесенных на ИИС денежных средств с начала налогового периода. Если T_IIS не задан, то 0
   //DlContrPrm.rec.ISSLASTOUTSUM = 0;           //Сумма изъятых с ИИС денежных средств с начала налогового периода. Если T_IIS не задан, то 0
   //DlContrPrm.rec.IISBENEFITDEP = null;        //Признак потери клиентом налоговых льгот по ИИС. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISENROLBAN = null;          //Признак запрета зачисления денежных средств на ИИС. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.REPMETHOD = 2;           //Способ получения отчетов. Если не задан, то 1 /*Дополнительные офисы*/ Если не найдена, то ошибка "Указан неизвестный способ получения отчетов"
   //DlContrPrm.rec.EMAIL = "1@test.com";    //Электронный адрес рассылки. Не обяз.
   //DlContrPrm.rec.REPOOVERNIGHT = StrFor(0);   //Признак согласия клиента на РЕПО овернайт
   //DlContrPrm.rec.LEVERAGE = 0;                //Плечо
   //DlContrPrm.rec.NOTPAYBRKACC = StrFor(0);    //Признак запрета выплат на брокерский счета
   //DlContrPrm.rec.RETURNTAX = StrFor(0);       //Признак согласия клиента на возврат излишне удержанного налога
   //DlContrPrm.rec.USEQUIK = StrFor(0);         //Признак использования клиентом приложения "Quik-брокер".
   //DlContrPrm.rec.IISDEDFINRES = StrFor(0);    //Предоставлять вычет по финансовому результату. Если T_IIS не задан, то очистить
   return DlContrPrm;
end;

// инициализация площадки
private macro InitDlContrMp()
   var DlContrMp = TRecHandler("dlcontrsubprm.rec");
   ClearRecord(DlContrMp);
   
   DlContrMp.rec.SERVKIND   = 0;    //Вид обслуживания
   DlContrMp.rec.SUBKIND    = 0;    //Подвид площадки
   DlContrMp.rec.ROLE       = 1;     //Роль ПУРЦБ
   //DlContrMp.rec.MPCODE     = 4;   //Краткий код клиента, данный при регистрации на торговой площадке биржи
   //DlContrMp.rec.MPREGDATE  = {curdate};   //Дата регистрации клиента на площадке
   //DlContrMp.rec.MPCLOSEDATE =	01.01.0001  //Дата прекращения обслуживания клиента на площадке
   DlContrMp.rec.NUMBER     = "";  //Номер субдоговора
   //DlContrMp.rec.ACCCODE    = ; //Код в номере счета
   DlContrMp.rec.NAME       = ""; //Название
   DlContrMp.rec.DATECONC   = {curdate};  //Дата заключения
   DlContrMp.rec.DATEBEGIN  = {curdate};  //Дата начала
   //DlContrMp.rec.DATEPROLONG =	01.01.0001  //Дата пролонгации
   //DlContrMp.rec.DATECLOSE  =	01.01.0001  //Дата закрытия
   DlContrMp.rec.SFPLANID   = 0;  //Идентификатор тарифного плана

   return DlContrMp;
end;


// наименование длинное или короткое
private macro GetPartyName(_partyid, _isshort)
   var res = NULL;
   var sql_str, cmd, rs;
   sql_str = " select t_shortname, t_name "+
             " from dparty_dbt where t_partyid = :partyid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      if (_isshort)
         res = rs.value("t_shortname");
      else
         res = rs.value("t_name");
      end;
   end;
   rs.close; cmd.close; rs = NULL; cmd = NULL;
   return res;
end;

 
   

// Привязка счета к субдоговору
private macro AddAccToSubContr(category, contractid, accrec, errstr)
   var stat, cmd, rs, sqltext, servkind, partyid, bankid, order;
   var bank_code;
   
   record sfspi("sfspiins.rec");
   ClearRecord(sfspi);
   
   sqltext = "select t_servkind from dsfcontr_dbt where t_id = ?";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      servkind= rs.value(0);
   else
      SetParm(2, string("Нет данных о договоре ID = ", contractid));
      return -1;
   end;

   sqltext = "select c.t_partyid, "
             "       d.t_partyid "
             "  from dsfcontr_dbt c, "
             "       ddp_dep_dbt d "
             " where d.t_code = c.t_department "
             "   and c.t_id = ?";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      partyid = rs.value(0);
      bankid = rs.value(1);
   else
      SetParm(2, string("Нет данных о субъекте и/или банке по договору ID = ", contractid));
      return -1;
   end;

   sqltext = "select to_char(nvl(max(t_order), 0) + 1) "
             " from dsfssi_dbt where t_objecttype = 659 "+
             "  and t_objectid = lpad(?, 10, chr(48))";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      order = rs.value(0);
   else
      order = 1;
   end;
   
   cmd = RsdCommand(sqltext);
   cmd.AddParam("1", RSDBP_IN, partyid);
   cmd.AddParam("2", RSDBP_IN, partyid);
   cmd.AddParam("3", RSDBP_IN, bankid);
   cmd.AddParam("4", RSDBP_IN, partyid);
   cmd.AddParam("5", RSDBP_IN, bankid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if ( (not (rs and rs.MoveNext())) )
      SetParm(2, string("Нет данных о субъекте и/или банке по договору ID = ", contractid));
      return -1;
   end;
   
   sfspi.ServiceKind      = servkind;
   sfspi.Order            = order;
   sfspi.FeeType          = 0;
   sfspi.FeeNumber        = 0;
   sfspi.FIID             = accrec.rec.code_currency;
   sfspi.Branch           = 0;
   if (category == CATEG_SUBCONTRACT)
      sfspi.ShortName        = "ДС клиента";
   elif (category == CATEG_SUBCONTRACT_COM)
      sfspi.ShortName        = "Расчеты по комиссии";
   else
      sfspi.ShortName        = order;
   end;
   sfspi.RecName          = GetPartyName(partyid, true);
   sfspi.CodeKind         = PTCK_CONTR;
   sfspi.Code             = GetPartyCode_ByNumber(partyid, PTCK_CONTR);
   sfspi.INN              = GetPartyCode_ByNumber(partyid, PTCK_INN);;
   sfspi.Account          = accrec.rec.account;
   sfspi.Chapter          = accrec.rec.chapter;
   sfspi.BankID           = bankid;
   sfspi.BankName         = GetPartyName(bankid, true);
   bank_code = GetPartyCode_ByNumber(bankid, PTCK_BIC);
   if (bank_code)
      sfspi.BankCodeKind     = PTCK_BIC ;
      sfspi.BankCode         = GetPartyCode_ByNumber(bankid, PTCK_BIC);
   else
      sfspi.BankCodeKind     = PTCK_SWIFT ;
      sfspi.BankCode         = GetPartyCode_ByNumber(bankid, PTCK_SWIFT);
   end;
   sfspi.CorrAcc          = "";
   sfspi.BankCorrName     = "";
   sfspi.BankCorrCodeKind = 3;
   sfspi.BankCorrCode     = "";
   sfspi.BankCorrID       = -1;
   sfspi.NoAccept         = "";
   sfspi.Description      = sfspi.ShortName;

   stat = SFSaveSfSSI(contractid, sfspi);
   if (stat != 0)
      SetParm(2, GetErrMsg());
   end;

   return stat;
end;

// Открыть счет для субдоговора 
private macro usrIntgr_ОткрытьСубсчетДляСубдоговора(category:string, SubContrID:integer, Currency:integer, AccAddr, ErrStr, _dateED)
  var FD = DL_SubContrFD(SubContrID);
  record ClientAcc( account );
  var accrec = TRecHandler("account.dbt");
  var err = 0;
  var datesub;

  //datesub = FD.GetSubContr().rec.DateBegin;
  datesub = {curdate};
  //gtv: дата открытия счета = дате открытия ЕД
  if (ValType(_dateED) == V_DATE)
     datesub = _dateED;
  end;

  ClearRecord(ClientAcc);
  //copy(ClientAcc, AccAddr);


  if(false == FD.OpenAccount( category, NULL, NULL, ClientAcc, datesub, Currency, _dateED ))
    ErrStr = "Ошибка при открытии счета по категории " + category;
    err = 1;
  end;
  
  if(not err)
    var cmd, DataSet;

    cmd = DL_RSDCommand(  "select * from daccount_dbt"
                        + " where t_Account = ? "
                        + "   and t_Code_Currency = ? "
                        + "   and t_Chapter = ?"
                       ); 
    cmd.AddParam(ClientAcc.Account);
    cmd.AddParam(ClientAcc.Code_Currency);
    cmd.AddParam(ClientAcc.Chapter);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( accrec.rec );
      SetParm(3, accrec);
    else
      err = 1;
    end;
  end;

  SetParm(4, ErrStr);
  return err;
end;

// Открыть и привязать счет к договору
private macro OpenAccAndBindToContract(category, contractid, currency, accnumber, error, _dateED):integer
   var stat, errstr;
   var accrec = TRecHandler("account.dbt");

   // поиск и заполнение структуры
   FindAcc(currency, accnumber, accrec);

   //открытие счета
   stat = usrIntgr_ОткрытьСубсчетДляСубдоговора(category, contractid, currency, accrec, errstr, _dateED);

   if (stat != 0)
      SetParm(4,errstr);
      return stat;
   end;

   if (category == CATEG_SUBCONTRACT)
      //привязка счета к договору
      stat = AddAccToSubContr(category, contractid, accrec, errstr);
      if (stat != 0)
         SetParm(4, errstr);
      end;
   end;

   return stat;
end;

private macro OpenAllAccounts(_sub_id, _fiid_sub, _AgreementDate)
   private var stat, err_txt;
   private var v_AgreementDate = _AgreementDate;

   if ( (v_AgreementDate)< date (01,01,2019) )
      v_AgreementDate = date (01,01,2019); // иначе старые договора не обновить
   end;

   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_COM, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   /*stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_VU, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_VU_CALC, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;*/

end;


// поиск субдоговора по ddlcontr_dbt.t_dlcontrid
private macro FindDlContrMp(p_dlcontrid, p_servkind, p_servkindsub)
   var sql_str, rs, cmd;
   var res = -1;
      
   sql_str = "SELECT cntr.t_id cntr_id, cntr.t_servkind, cntr.t_servkindsub, mp.t_id mp_id "+
             "  FROM dsfcontr_dbt cntr, "+
             "       ddlcontrmp_dbt mp "+
             "WHERE cntr.t_id = mp.t_sfcontrid "+
             "  AND cntr.t_servkind = :p_servkind "+
             "  AND cntr.t_servkindsub = :p_servkindsub "+
             "  AND mp.t_dlcontrid = :p_dlcontrid "+
             "  AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_servkind", RSDBP_IN, p_servkind);
   cmd.AddParam("p_servkindsub", RSDBP_IN, p_servkindsub);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, p_dlcontrid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("cntr_id");
   end;
   
   return res;
end;

// поиск СПИ ПЗО по dsfcontr_dbt.t_id
private macro FindDlContrMpSSI(p_cntr_id, p_fiid)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "SELECT settacc.t_settaccid, settacc.t_fiid "+
             "  FROM dsfssi_dbt ssi, "+
             "       dsettacc_dbt settacc "+
             " WHERE ssi.t_objecttype = 659 "+
             "   AND ssi.t_setaccid = settacc.t_settaccid "+
             "   AND ssi.t_objectid = lpad(:p_cntr_id,10,'0') "+
             "   AND ssi.t_fiid = :p_fiid ";

   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_cntr_id", RSDBP_IN, p_cntr_id);
   cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_settaccid");
   end;

   return res;
end;

// простановка клиента на обслуживание
private macro AddServKind(_partyid, _servkind, _department)
   var party_rec = RSBParty(_partyid);
   var stat, err_txt;
   party_rec.FullName = party_rec.FullName;
   stat = PT_BindClientWithBranch(party_rec.partyid, _servkind, _department);
   if(not stat)
      err_txt = "Ошибка установки вида обслуживания "+_servkind+" при открытии ЕД БО";
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   party_rec.Update;
   party_rec = NULL;
end;

// метод формирования оплаты комиссии
private macro UpdatePayMethod(_subid, _nummethod)
   var sql_str;
   var cmd;
   sql_str = "update dsfcontr_dbt set t_paymethod = :paymethod where t_id = :subid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("paymethod", RSDBP_IN, _nummethod);
   cmd.AddParam("subid", RSDBP_IN, _subid);
   cmd.execute;
   cmd.close;

end;

private macro UpdateContractEmail(_dlcontr_id, _email_contract)
   var sql_str;
   var cmd;
   sql_str = "update ddlcontr_dbt set t_email = :email where t_dlcontrid = :id";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("email", RSDBP_IN, _email_contract);
   cmd.AddParam("id", RSDBP_IN, _dlcontr_id);
   cmd.execute;
   cmd.close;

end;

macro FindMPCode(_code, _servkind, _servkindsub)
   var sql_str, rs, cmd;
   var res = false;

   sql_str = "  SELECT cntr.t_id cntr_id, cntr.t_servkind, cntr.t_servkindsub, mp.t_id mp_id "+
             "    FROM dsfcontr_dbt cntr,                                                    "+
             "         ddlcontrmp_dbt mp                                                     "+
             "  WHERE cntr.t_id = mp.t_sfcontrid                                             "+
             "    AND cntr.t_servkind = :p_servkind                                          "+
             "    AND cntr.t_servkindsub = :p_servkindsub                                    "+
             "    AND mp.t_mpcode like :mpcode                                               "+
             "    AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy')                  ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_servkind", RSDBP_IN, _servkind);
   cmd.AddParam("p_servkindsub", RSDBP_IN, _servkindsub);
   cmd.AddParam("mpcode", RSDBP_IN, _code);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = true;
   end;

   return res;
end;


macro CheckCodeMICEX(_code, _servkind, _servkindsub, _partyid, _IsIIS)
   var partyid_found;
   var short_code = _code;
   var short_code_prev;
   var number_code, pos;
   var exist_mpcode;
   var err_txt;

   var sql_str, rs, cmd;

   partyid_found = GetPartyID_byPartyCode(PTCK_MICEX, short_code); 
   while (partyid_found > 0)  // существует такой код
      exist_mpcode = FindMPCode(_code, _servkind, _servkindsub);
      if (exist_mpcode) // код 8 есть и есть код в площадке, все нормально
         short_code = GeneratePersonalCode(_partyid, _IsIIS, false, false);    
         partyid_found = GetPartyID_byPartyCode(PTCK_MICEX, short_code); 
      else
         err_txt = "Существует код 8 "+_code+" и нет торговой площадки, где есть такой код";
         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
      end;
   end;

   // нашли код, которого ни у кого нет
   if (_servkind == PTSK_STOCKDL)
      number_code = Int(Substr(_code,2))-1;
      short_code_prev = String("_", number_code);
   elif (_servkind == 15)
      pos = Index(_code, "F502");
      if (pos > 0)
         number_code = Int(Substr(_code,5))-1;
         short_code_prev = String("F502", number_code);
      else
         err_txt = "Некорректно сформирован код клиента для срочного рынка "+_code;
         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
      end;
   end;

   exist_mpcode = FindMPCode(short_code_prev, _servkind, _servkindsub);
   if (not exist_mpcode)
      err_txt = "Не найдено предыдущее значение кода на бирже "+short_code_prev;
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;

   return short_code;

onError(e)
   err_txt = "Ошибка при поиске и проверке краткого кода клиента на бирже "+e.message;
   RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
end;


/* Непосредственное открытие брокерского договора*/
macro OpenContract(_partyid, _AgreementInfoList,_email_contract)
   private var err_txt;
   var stat;
   record fininstr(fininstr);
   
   var DlContrPrm;
   var DlContrMp;
   //var party_rec = RSBParty(_partyid); // нельзя использовать одновременно с DL_AddSubContrToDLCONTR
   
   var short_code, tarif_id, short_code_sub;
   var nextval;
   var short_code_exist;

   var sub_id, rs;
   var dlcontr_id, ssi_FIID;
   
   var AgreementInfo, TradingPlatformInfo, TradingPlatformCurrency;
   var ServKind, ServKindSub, SubName, SubNumber, filialcode, pos;
   
   var partyid_found;
   var date_sub;
   
   var new_ed = false;
   var new_sub = false;

   var SubContr;
   var SubContrArr = TArray;

   var STOCK_acc_arr = TArray;
   var STOCK_OVER_acc_arr = TArray;
   var FORTS_acc_arr = TArray;
   var fiid_sub, fiid_sub_arr = TArray;
   var ai;
   var subcontr_temp, flag_subcontr;

   var partyname, partyname_short;
   var exist_email;
   var IsIIS = false;
   var sfcontr_SERVKIND, sfcontr_SUBKIND;
   var dlcontr_id_number, partyid_number, partycode_number;

   
   tarif_id = FindBasicTarif();     // тариф "Базовый"
   
   for (AgreementInfo, _AgreementInfoList)
      if (Index(AgreementInfo.AgreementNumber,"ИИС") > 0)
         IsIIS = true;
      else
         IsIIS = false;
      end;

      dlcontr_id = FindDlContrByNumberAndClient(_partyid, AgreementInfo.AgreementNumber, @exist_email);
      if (dlcontr_id < 0)
         dlcontr_id_number = FindDlContrByNumber(AgreementInfo.AgreementNumber, @partyid_number);
         if (dlcontr_id_number > 0)  // договор найден
           if (_partyid != partyid_number)
              partycode_number = GetPartyCode_ByNumber(partyid_number, PTCK_CONTR);
              err_txt = "Договор "+AgreementInfo.AgreementNumber+" открыт на другого клиента: "+partycode_number;
              RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
           end;
         end;
      end;

      if (dlcontr_id < 0) // договор не найден, открываем
         new_ed = true;

         // код не ищем, а генерим заново для ЕД
         /*if (IsIIS)
            short_code = "";
         end;*/
         short_code = "";

         if (not short_code)     // для ЕД не нужно, только для площадок UPD: оказалось, что нельзя оставлять код пустым, так как генерируется внутренним механизмом при открытии ЕД 
            short_code = GeneratePersonalCode(_partyid, IsIIS, false, false);    // Единый код на бирже
            // без доп.проверок. Доп.проверки при заведении площадки
         end;
         partyname_short = GetPartyName(_partyid, true);
                                                 
         // открытие ЕД
         DlContrPrm = TRecHandler("dlcontrprm.rec");
         DlContrPrm.Clear;
         DlContrPrm = InitDlContrPrm();
         // обычный единый договор
         // единый брокерский договор
         pos = Index(AgreementInfo.AgreementNumber,"-");
         if (pos > 0)
            filialcode = GetFilialCode(Substr(AgreementInfo.AgreementNumber,1,pos-1)+"00");
         else
            filialcode = 1;
         end;
         
         DlContrPrm.rec.DEPARTMENT = {OperDprt};
         DlContrPrm.rec.NUMBER     = AgreementInfo.AgreementNumber;
         DlContrPrm.rec.DATEBEGIN  = AgreementInfo.AgreementDate;
         DlContrPrm.rec.NAME       = partyname_short; //"Единый договор БО";  
         DlContrPrm.rec.UNIDEPOCONTRID = 0; 
         DlContrPrm.rec.PARTYID    = _partyid; 
         DlContrPrm.rec.MARKETCODE = short_code;
         DlContrPrm.rec.PLANID     = tarif_id;
         DlContrPrm.rec.USESUBACC  = StrFor(88);
         if (ValType(_email_contract) != V_UNDEF)
            DlContrPrm.rec.EMAIL = _email_contract;
         end;
         if (IsIIS)
            DlContrPrm.rec.IIS = StrFor(88);
         end;
         date_sub = AgreementInfo.AgreementDate;

      else
         new_ed = false;

         //short_code = GetPartyCode_ByNumber(_partyid, PTCK_MICEX);
         // код не ищем, а генерим заново всегда
         date_sub = {curdate};

         if (ValType(_email_contract) != V_UNDEF)  // во входящем XML есть почта
            if (    (ValType(exist_email) == V_UNDEF)  // не задана в текущем договоре
                 or ( (ValType(exist_email) != V_UNDEF) and  (StrUpr(exist_email) != StrUpr(_email_contract)) ) // задана, но не совпадает
                )
              DlContrPrm = TRecHandler("dlcontrprm.rec");
              stat = DL_Fill_DLContrPrmByDLContr(DlContrPrm, dlcontr_id, tarif_id, short_code); 
              DlContrPrm.rec.EMAIL = _email_contract;

              stat = DL_UpdateDLCONTR(DlContrPrm, err_txt); 
              if (stat != 0)
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
              end;

              //заменить на функцию обновления
              //UpdateContractEmail(dlcontr_id, _email_contract);
            end;
         end;

      end;
      
      STOCK_acc_arr.size = 0;
      STOCK_OVER_acc_arr.size = 0;
      FORTS_acc_arr.size = 0;

      if (ValType(AgreementInfo.TradingPlatformsList) != V_UNDEF)
         partyname = GetPartyName(_partyid, false);

         for (TradingPlatformInfo, AgreementInfo.TradingPlatformsList)
            // открытие субдоговоров

            // валюты
            TradingPlatformCurrency = TradingPlatformInfo.TradingPlatformCurrency.RecordCode;
            if (TradingPlatformCurrency == "RUR") TradingPlatformCurrency = "RUB" end;
            if (ПолучитьФинИнПоISO (TradingPlatformCurrency, fininstr))
            else
               err_txt = "Не найдена валюта с кодом: "+TradingPlatformCurrency;
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;


            if (TradingPlatformInfo.TradingPlatformCode.RecordCode == "ММВБ") 
               ServKind    = PTSK_STOCKDL;                              // фондовый рынок
               ServKindSub = SERV_SUBKIND_STOCK;                        // Подвид площадки - биржа
               SubNumber   = AgreementInfo.AgreementNumber+"_ф";            // Номер субдоговора
               SubName     = partyname; //"Субдоговор по фондовой секции - биржа";   // Название
               if (new_ed)
                  STOCK_acc_arr.value(STOCK_acc_arr.size) = fininstr.FIID;
               end;

            elif (TradingPlatformInfo.TradingPlatformCode.RecordCode == "ВНЕБ")
               ServKind    = PTSK_STOCKDL;                                 // фондовый рынок
               ServKindSub = SERV_SUBKIND_STOCK_OVER;                      // Подвид площадки - внебиржа
               SubNumber   = AgreementInfo.AgreementNumber+"_в";               // Номер субдоговора
               SubName     = partyname; //"Субдоговор по фондовой секции - внебиржа";   // Название
               if (new_ed)
                  STOCK_OVER_acc_arr.value(STOCK_OVER_acc_arr.size) = fininstr.FIID;
               end;

            elif (TradingPlatformInfo.TradingPlatformCode.RecordCode == "FORTS")
               ServKind    = 15;                                           // срочные контракты
               ServKindSub = SERV_SUBKIND_STOCK;                           // Подвид площадки - биржа
               SubNumber   = AgreementInfo.AgreementNumber+"_с";               // Номер субдоговора
               SubName     = partyname;	//"Субдоговор по срочной секции";               // Название
               if (new_ed)
                  FORTS_acc_arr.value(FORTS_acc_arr.size) = fininstr.FIID;
               end;

            else
               err_txt = "Неизвестная торговая площадка: "+TradingPlatformInfo.TradingPlatformCode.RecordCode;
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;


            if (new_ed)
               sub_id = -1;
            else
               sub_id = FindDlContrMp(dlcontr_id, ServKind, ServKindSub);
            end;

            if (sub_id < 0) // площадка не найдена, открываем
               // простановка на обслуживание
               AddServKind(_partyid, ServKind, {OperDprt});

               if (ServKind == PTSK_STOCKDL)    // фондовый рынок
                  if (ServKindSub == SERV_SUBKIND_STOCK)  // биржа
                     if (not short_code)
                        short_code = GeneratePersonalCode(_partyid, IsIIS, false, false);    // Единый код на бирже
                     end;
                     short_code = CheckCodeMICEX(short_code, ServKind, ServKindSub, _partyid, IsIIS);
                     short_code_sub = short_code;
                  else                                   // внебиржа
                     short_code_sub = "";
                  end;
               elif (ServKind == 15)                                     // срочные контракты
                  short_code_sub = GeneratePersonalCode(_partyid, IsIIS, false, true);
                  short_code_sub = CheckCodeMICEX(short_code_sub, ServKind, ServKindSub, _partyid, IsIIS);

               end;

               if (new_ed)
                 flag_subcontr = true;
                 for (subcontr_temp,SubContrArr)
                    if ( (subcontr_temp.rec.SERVKIND == ServKind) and (subcontr_temp.rec.SUBKIND == ServKindSub) )
                       flag_subcontr = false;
                       break;
                    end;
                 end;


                 if (flag_subcontr)
                    ai = SubContrArr.size;
                    SubContrArr.value(ai) = TRecHandler("dlcontrsubprm.rec");
                    SubContrArr.value(ai).Clear;
                    SubContrArr.value(ai) = InitDlContrMp();
                    SubContrArr.value(ai).rec.SERVKIND   = ServKind;
                    SubContrArr.value(ai).rec.SUBKIND    = ServKindSub;
                    SubContrArr.value(ai).rec.NUMBER     = SubNumber;
                    SubContrArr.value(ai).rec.NAME       = SubName;
                    SubContrArr.value(ai).rec.ROLE       = 2;     //Роль ПУРЦБ
                    SubContrArr.value(ai).rec.MPCODE     = short_code_sub;   //Краткий код клиента, данный при регистрации на торговой площадке биржи
                    SubContrArr.value(ai).rec.MPREGDATE  = date();   //Дата регистрации клиента на площадке
                    //SubContrArr.value(ai).rec.MPCLOSEDATE =	01.01.0001  //Дата прекращения обслуживания клиента на площадке
                    GenerateReference(127, nextval);    // Краткий код клиента, данный при регистрации на торговой площадке биржи   
                    SubContrArr.value(ai).rec.ACCCODE    = nextval; //Код в номере счета
                    SubContrArr.value(ai).rec.DATECONC   = date_sub;  //Дата заключения
                    SubContrArr.value(ai).rec.DATEBEGIN  = date_sub;  //Дата начала
                    //DlContrMp.rec.DATEPROLONG =	01.01.0001  //Дата пролонгации
                    //DlContrMp.rec.DATECLOSE  =	01.01.0001  //Дата закрытия
                    SubContrArr.value(ai).rec.SFPLANID   = tarif_id;  //Идентификатор тарифного плана
                 end;

               else
                 DlContrMp = TRecHandler("dlcontrsubprm.rec");  
                 DlContrMp.Clear;
                 DlContrMp = InitDlContrMp();
                 DlContrMp.rec.SERVKIND   = ServKind;
                 DlContrMp.rec.SUBKIND    = ServKindSub;
                 DlContrMp.rec.NUMBER     = SubNumber;
                 DlContrMp.rec.NAME       = SubName;
                 DlContrMp.rec.ROLE       = 2;     //Роль ПУРЦБ
                 DlContrMp.rec.MPCODE     = short_code_sub;   //Краткий код клиента, данный при регистрации на торговой площадке биржи
                 DlContrMp.rec.MPREGDATE  = date();   //Дата регистрации клиента на площадке
                 //DlContrMp.rec.MPCLOSEDATE =	01.01.0001  //Дата прекращения обслуживания клиента на площадке
                 GenerateReference(127, nextval);    // Краткий код клиента, данный при регистрации на торговой площадке биржи   
                 DlContrMp.rec.ACCCODE    = nextval; //Код в номере счета
                 DlContrMp.rec.DATECONC   = date_sub;  //Дата заключения
                 DlContrMp.rec.DATEBEGIN  = date_sub;  //Дата начала
                 //DlContrMp.rec.DATEPROLONG =	01.01.0001  //Дата пролонгации
                 //DlContrMp.rec.DATECLOSE  =	01.01.0001  //Дата закрытия
                 DlContrMp.rec.SFPLANID   = tarif_id;  //Идентификатор тарифного плана

                 stat = DL_AddSubContrToDLCONTR(dlcontr_id, DlContrMp, err_txt);
                 if (stat != 0)
                    RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                 end;
     
                 sub_id = DlContrMp.rec.sfcontrid;
                 UpdatePayMethod(sub_id, 1);
                 m_make_event_to_process(9, dlcontr_id);
                 new_sub = true;
                 DlContrMp = NULL;
               end;
                  
            end;

            TradingPlatformCurrency = TradingPlatformInfo.TradingPlatformCurrency.RecordCode;
            if (TradingPlatformCurrency == "RUR") TradingPlatformCurrency = "RUB" end;
            if (ПолучитьФинИнПоISO (TradingPlatformCurrency, fininstr))
               if (not new_ed) 
                  ssi_FIID = FindDlContrMpSSI(sub_id, fininstr.FIID);
                  if (ssi_FIID < 0) // валюта не найдена, открываем
                     OpenAllAccounts(sub_id, fininstr.FIID, AgreementInfo.AgreementDate);
                     
                     // передача во вне
                     if ( (not new_ed) and (not new_sub) )  // для нового договора / субдоговора запись одна и она уже есть
                        m_make_event_to_process(9, dlcontr_id); 
                     end;
                  end;
               end;

            else
               err_txt = "Не найдена валюта с кодом: "+TradingPlatformCurrency;
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
         
         end;
       
      end;

      if (new_ed)
         // открытие ЕД
         if (DlContrPrm.rec.PARTYID > 0)
            stat = DL_CreateDLCONTR(DlContrPrm, NULL, SubContrArr, err_txt); 
            if (stat != 0)
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
            dlcontr_id = DlContrPrm.rec.DLCONTRID;

//            for (SubContr, SubContrArr)
            ai = 0;
            while (ai < SubContrArr.size)
               sfcontr_SERVKIND = SubContrArr.value(ai).rec.SERVKIND;
               sfcontr_SUBKIND = SubContrArr.value(ai).rec.SUBKIND;

               rs = RSDRecordSet("select sf_sub.t_id sub from "+
                                   "    DDLCONTRMP_dbt  mp, "+
                                   "    dsfcontr_dbt sf_sub, "+
                                   "    ddlcontr_dbt dl "+
                                   "where   "+
                                   "    DL.T_DLCONTRID = "+dlcontr_id+
                                   "    and mp.t_dlcontrid = DL.T_DLCONTRID "+
                                   "    and sf_sub.t_id = mp.t_sfcontrid "+
                                   "    and sf_sub.t_servkind = "+sfcontr_SERVKIND+
                                   "    and sf_sub.t_servkindsub = "+sfcontr_SUBKIND);
               if (rs.movenext)
                  sub_id = rs.value("sub");
                  UpdatePayMethod(sub_id, 1);
               end;   

               if  ( (sfcontr_SERVKIND == PTSK_STOCKDL) and (sfcontr_SUBKIND == SERV_SUBKIND_STOCK) )
                  fiid_sub_arr = TArray(STOCK_acc_arr);
               elif  ( (sfcontr_SERVKIND == PTSK_STOCKDL) and (sfcontr_SUBKIND == SERV_SUBKIND_STOCK_OVER) )
                  fiid_sub_arr = TArray(STOCK_OVER_acc_arr);
               elif (sfcontr_SERVKIND == 15)
                  fiid_sub_arr = TArray(FORTS_acc_arr);
               end;

               for (fiid_sub, fiid_sub_arr)
                  OpenAllAccounts(sub_id, fiid_sub, AgreementInfo.AgreementDate);
               end;
               ai = ai+1;

            end;
            short_code_exist = GetPartyCode_ByNumber(_partyid, PTCK_MICEX);
            if (short_code_exist != short_code)
               var Party_rec = RSBParty(_partyid);
               var stat_codes = Party_rec.Code.SetCode(PTCK_MICEX, short_code);
               Party_rec.Update();
               Party_rec = NULL;
            end;
         end;

         // передача во вне
         m_make_event_to_process(9, dlcontr_id);

         DlContrPrm = NULL;
         SubContrArr.size = 0;

      end;


   end;

   return 1; // может быть много
end;


// непосредственная обработка единичной записи
// формирование класса ошибок по единичной записи
macro InsertPerson_single(p_req_data_obj, p_ClientId, p_transparent_id, out_WillMakeCIFCode:@bool, out_MasterExternalId:@c_IntegrationSymbolicIdentifierXType) 
   var ErrorAction;
   
   var req_obj_serv = NULL;
   var pparty = NULL;
   var resp_obj_serv = NULL;

   private var resp_resultCode, resp_resultText;
   
   private var party_name, party_link;
   
   private var PartyID_found = -1;
   
   private var PersonGetXref_req = NULL;
   private var PersonGetXref_resp = NULL;

   private var CIFContracytReference = NULL;
   private var SOFRId = NULL;
   private var vINN;
   private var vSize = 0;
   
   private var object_contr = -1, num_filial, pos, code_value_number, code_value, code_number;
   private var err_txt;
   private var wCode, CoupledSubject;
   private var CodeFromCIF, p_WillMakeCIFCode = false;

   private var SetAcc_temp;
   
   out_WillMakeCIFCode = false;

   // входящие параметры
   req_obj_serv = c_PersonParm(p_req_data_obj);
   
   //поиск Субъекта в БД СОФР по переданным идентификаторам: ИД в АБС, ИД в СОФР (если передан);
   // SOFRID (partyid)
   if (Valtype(req_obj_serv.Person.SOFRId) != V_UNDEF)
      PartyID_found = GetPartyID_byStringPartyID(req_obj_serv.Person.SOFRId.ObjectID); // поиск по коду в СОФР
   end;
   
   // PersonID (код АБС)
   if ( (PartyID_found <= 0) // субъект не найден
      and  (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) )
    
      num_filial = "0000";
      // код АБС
      code_number = PARTY_CODEKIND_ABS;
      code_value = req_obj_serv.Person.PersonID.ObjectID;
      pos = 0;
      pos = Index(code_value,"#");
      if (pos == 3)
         code_value_number = Substr(code_value,6);
         code_number = PARTY_CODEKIND_ABS_RESERV;
      else
         code_value = MakeCodeABS(code_value, num_filial, 3);
      end;
      PartyID_found = GetPartyID_byPartyCode(code_number, code_value);
   end;

   if (PartyID_found <= 0) // субъект не найден
      // Если Субъект не найден, то производится поиск Клиента в CIF	
      if (Valtype(req_obj_serv.Person.CIFId) != V_UNDEF)
         PersonGetXref_req = c_PersonGetXrefRequest;
         PersonGetXref_req.OperationalExternalId.ObjectId = req_obj_serv.Person.CIFId.ObjectID;
         PersonGetXref_req.OperationalExternalId.SystemId = req_obj_serv.Person.CIFId.SystemId;
         PersonGetXref_req.OperationalExternalId.SystemNodeId = req_obj_serv.Person.CIFId.SystemNodeId;
      elif (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         PersonGetXref_req = c_PersonGetXrefRequest;
         PersonGetXref_req.OperationalExternalId.ObjectId = req_obj_serv.Person.PersonID.ObjectID;
         PersonGetXref_req.OperationalExternalId.SystemId = req_obj_serv.Person.PersonID.SystemId;
         PersonGetXref_req.OperationalExternalId.SystemNodeId = req_obj_serv.Person.PersonID.SystemNodeId;
      end;
      if (ValType(PersonGetXref_req) != V_UNDEF)
         /* 20190103 - kva - добавлена передача "сквозного" id для целей логирования */
         PersonGetXref_resp = PersonGetXref(PersonGetXref_req, NULL, p_transparent_id);
         if (ValType(PersonGetXref_resp) != V_UNDEF)  // ответ получен
            CodeFromCIF = PersonGetXref_resp.GetSystemXref("SOFR");
            if (CodeFromCIF.ObjectId != "-1")
               PartyID_found = GetPartyID_byStringPartyID(CodeFromCIF.ObjectId);  // здесь должен быть PartyID
            end;
            if (PartyID_found < 0)
               out_WillMakeCIFCode = true;
            end;
         else
            out_WillMakeCIFCode = true;
         end;
      end;
   end;
   

   if (out_WillMakeCIFCode)
      if (Valtype(req_obj_serv.Person.CIFId) != V_UNDEF)
         out_MasterExternalId.ObjectId = req_obj_serv.Person.CIFId.ObjectID;
         out_MasterExternalId.SystemId = req_obj_serv.Person.CIFId.SystemId;
         out_MasterExternalId.SystemNodeId = req_obj_serv.Person.CIFId.SystemNodeId;
      elif (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         out_MasterExternalId.ObjectId = req_obj_serv.Person.PersonID.ObjectID;
         out_MasterExternalId.SystemId = req_obj_serv.Person.PersonID.SystemId;
         out_MasterExternalId.SystemNodeId = req_obj_serv.Person.PersonID.SystemNodeId;
      end;
   end;


   if (PartyID_found <= 0)    // все еще не нашли субъекта
      // проверка по ИНН, так как все равно не даст создать
      if (ValType(req_obj_serv.Person.INN) != V_UNDEF)
         vINN = req_obj_serv.Person.INN;
         PartyID_found = GetPartyID_byPartyCode(PTCK_INN, vINN);
      end;
   end;
         
   if (PartyID_found > 0) // субъект найден в АБС
      //	Производится обновление данных по Субъекту, в соответствии с полученными значениями, обработка данных прекращается, формируется ответное сообщение, которое возвращается в Адаптер;
      pparty = adp_Party(req_obj_serv, PartyID_found);
      
      UpdateParty(
                   PartyID_found
                  ,pparty.PartyCode
                  ,pparty.PersnParam
                  ,pparty.InstParam
                  ,pparty.ClientParam
                  ,pparty.Codes
                  ,pparty.Addresses
                  ,pparty.Contacts
                  ,pparty.PersnPapers
                  ,pparty.RegDocs
                  ,pparty.PartyNotes
                  ,pparty.PersnNotes
                  ,pparty.SettAccs
                 );
      resp_obj_serv = PartyID_found;
      // процедура ничего не возвращает, поэтому если не выпало в ошибку, считаем, что все нормально
      resp_resultCode = 0;
      resp_resultText = "OK";
      SetParm(1,resp_obj_serv);
      
   else  // субъект не найден
      //            k.	Если Субъект не найден, то производится создание нового Субъекта в СОФР. При этом: 
      //               i.	В параметрах Субъекта сохраняются: Идентификатор Клиента в АБС, и Глобальный идентификатор, полученный из CIF. 
      //               ii.	Формируется запись в Таблицу Событий по Типу Объекта = <Кросс-ссылка Субъекта>.
      pparty = adp_Party(req_obj_serv, PartyID_found);
         
   /* Вызываем сервис */
      resp_obj_serv = InsertParty(
                                  pparty.PersnParam
                                 ,pparty.InstParam
                                 ,pparty.ClientParam
                                 ,pparty.Codes
                                 ,pparty.Addresses
                                 ,pparty.Contacts
                                 ,pparty.PersnPapers
                                 ,pparty.RegDocs
                                 ,pparty.PartyNotes
                                 ,pparty.PersnNotes
                                 ,pparty.SettAccs
                                );

      if (ValType(resp_obj_serv) == V_UNDEF)
         resp_resultCode = ERR_CODE_TECH_ERROR;
         resp_resultText = getErrMsg();
      else
         resp_resultCode = 0;
         resp_resultText = "OK";
         SetParm(1,resp_obj_serv);
      end;
   end;
   
   if (resp_resultCode == 0)
      // наименования
      if (ValType(pparty.Names) != V_UNDEF)
         for (party_name, pparty.Names)
            SetPartyNames(resp_obj_serv, party_name.PartyNameID, party_name.Name);
         end;
      end;
   
      // открываем счета постфактум, так как нужен клиент 
      if ( (Valtype(pparty.SettAccs) != V_UNDEF) and (pparty.SettAccs.size > 0) )
         if (req_obj_serv.Person.mNumFilial == 1)
            for (SetAcc_temp, pparty.SettAccs) 
               FindOpenAccount(SetAcc_temp.Account, resp_obj_serv);
            end;
         end;
      end;
   
      // категории, передаем массив
      SetCategories(resp_obj_serv, pparty.Categories);
         
      // Codes_weak
      if (ValType(pparty.Codes_weak) != V_UNDEF)
         SetCodesWeak(resp_obj_serv, pparty.Codes_weak);
      end;
      
      // Notes_weak
      if (ValType(pparty.Notes_weak) != V_UNDEF)
         SetNotesWeak(resp_obj_serv, pparty.Notes_weak);
      end;

      // уровень риска
      if (ValType(req_obj_serv.Person.RiskLevel) != V_UNDEF)
         SetRiskLevel(resp_obj_serv, req_obj_serv.Person.RiskLevel, req_obj_serv.Person.RiskReason);
      end;
      
      // связанные субъекты
      if (ValType(req_obj_serv.Person.CoupledSubjectList) != V_UNDEF)
         for (CoupledSubject, req_obj_serv.Person.CoupledSubjectList)
            SetCoupledSubject(resp_obj_serv, CoupledSubject);
         end;
      end;
      
      // открываем договор брокерского обслуживания
      if (ValType(req_obj_serv.Person.AgreementInfoList) != V_UNDEF)
//SetRSTrace(true);
         object_contr = OpenContract(resp_obj_serv, req_obj_serv.Person.AgreementInfoList, pparty.email_contract);
//SetRSTrace(false);
      else
         // принадлежности
         SetPartyOwn(resp_obj_serv, PTK_CONTR); // контрагент по сделкам
         SetPartyOwn(resp_obj_serv, PTK_PACT ); // контрагент по договорам
      end;
      
      ErrorAction = NULL;
   else 
      ErrorAction = TArray;
      vSize = ErrorAction.size;
      ErrorAction(vSize) = c_Error;
      ErrorAction(vSize).ErrorCode = resp_resultCode;
      ErrorAction(vSize).ErrorDesc = resp_resultText;
      
   end;
   
   return ErrorAction;
      
onError(err)
   /* Получаем объектный вид ответа */
   ErrorAction = TArray;
   vSize = ErrorAction.size;
   ErrorAction(vSize) = c_Error;
   ErrorAction(vSize).ErrorCode = c_err_obj.obtain_err_code(err);
   ErrorAction(vSize).ErrorDesc = c_err_obj.obtain_err_msg(err);   
   
   // откат транзакции
   //AbortTrn();
   
   return ErrorAction;
end;


/*---------------------------------------*/
/* Открытие клиента                      */
/*---------------------------------------*/
macro adp_SetPerson(IncomeData, p_log_id, p_transparent_id, out_WillMakeCIFCode:@bool, out_MasterExternalId:@c_IntegrationSymbolicIdentifierXType) /* 20190103 - kva - протаскиваем id для логирования */
   var req_data = NULL;

   var resp_data_obj = NULL;
   
   var v_result, v_xml;
   var err_txt="", out_code = 0, aux_buff;   
   var ErrorAction_arr = TArray;
   
   var ClientID = NULL;
   
   if(ValType(IncomeData) == V_UNDEF)
      RunError(ERR_TEXT_NO_IN_MSG, c_err_obj(ERR_TEXT_NO_IN_MSG,
                                             ERR_CODE_NO_IN_PRM));
   end;   
         
   //готовый объект, преобразования вовне
   req_data =  uTryToGetPropS(IncomeData, "SetPersonRequest");
   
   // единичная обработка
   ErrorAction_arr = InsertPerson_single(req_data, ClientId, p_transparent_id, @out_WillMakeCIFCode, @out_MasterExternalId); /* 20190103 - kva - протаскиваем id для логирования */
   
   // итоговый класс 
   resp_data_obj = c_SetPerson_outObj;
   if ( (ErrorAction_arr) and (ErrorAction_arr.size > 0) )
      if (ErrorAction_arr(0).ErrorCode != 0)
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 1;
      else
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 0;
      end;
   else
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 0;
   end;
   if (ValType(req_data.RequestId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.Objectid = req_data.RequestId.ObjectId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemId = req_data.RequestId.SystemId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemNodeId = req_data.RequestId.SystemNodeId;
   end;
   if (ValType(ClientId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.Objectid = ClientID;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemId = "SOFR";
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemNodeId = "0000";
   end;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList = ErrorAction_arr;
   
   return resp_data_obj;
   
onError(err)
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_SetPerson_outObj;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 1;
   if (ValType(req_data.RequestId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.Objectid = req_data.RequestId.ObjectId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemId = req_data.RequestId.SystemId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemNodeId = req_data.RequestId.SystemNodeId;
   end;
   if (ValType(ClientId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.Objectid = ClientID;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemId = "SOFR";
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemNodeId = "0000";
   end;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList = TArray;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList(0) = c_Error;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList(0).ErrorCode = out_code;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList(0).ErrorDesc = err_txt;

   return resp_data_obj;
end;

   var sql_str, rs, cmd;
   
   sql_str = " SELECT DISTINCT dm.t_docid contrid, dm.t_currency fiid " 
            +"  FROM dmcaccdoc_forts_dbt dm WHERE dm.t_catnum IN (201) ";   
   cmd = RSDCommand(sql_str);
   rs = RSDRecordSet(cmd);
   while (rs.movenext)
     OpenAllAccounts(rs.value(0) ,rs.value(1), date(29,12,2018));
   end;
