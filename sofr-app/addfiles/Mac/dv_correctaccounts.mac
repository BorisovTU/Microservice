/*
$Name:             dv_correctaccounts.mac
$Module:           ФИССиКО
$Description:      Корректировка счетов единоразовая
*/

import dv_categ, dv_car;


/*Класс, где должен возвращаться счет по старым алгоритмам*/
CLASS (DVFirstDocDeal) DVFirstDocDeal_old( DocKind, Oper )
    MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )         

     var Parametr:variant;
     var FindAttr:bool;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );           

     if( Parametr == -1 )
        /*Вид актива требований\Вид актива обязательств\Вид актива*/
        if( ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_REQ)  ) OR
            ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_COMM) ) OR
            ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK) ) )
           if( (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_BA) )
              if( BaseFI().rec.FI_Kind == FIKIND_AVOIRISS )
                 Parametr = 3; /*Ценные бумаги*/
              elif( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
                 Parametr = 1; /*Денежные средства*/
              elif( BaseFI().rec.FI_Kind == FIKIND_DERIVATIVE )
                 Parametr = 6; /*Фьючерс*/
              elif( BaseFI().rec.FI_Kind == FIKIND_INDEX )
                 Parametr = 8; /*Индекс*/
              elif( BaseFI().rec.FI_Kind == FIKIND_ARTICLE )
                 Parametr = 7; /*Артикул*/
              else
                 Parametr = 1; /*Денежные средства*/
              end;
           elif( FIRole == FIROLE_BA_NOTDV )
              if( FI.rec.Settlement_Code == DVSETTLEMET_STATE )
                 Parametr = 3;/*Ценные бумаги*/
              else
                 Parametr = 1; /*по умолчанию - Денежные средства*/
              end;
           elif( FIRole == FIROLE_PRICEFI )
              Parametr = 1;/*Денежные средства*/
           elif( (FIRole == FIROLE_FUTURES) or (FIRole == FIROLE_OPTION) )
              Parametr = 6;/*Фьючерс*/
           end;
        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_FI_KIND) )
           if( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
              Parametr = 1; /*Денежные средства*/
           elif( BaseFI().rec.FI_Kind == FIKIND_METAL )
              Parametr = 2; /*Драгоценные металлы*/
           end;
        elif( ObjectID == OBJTYPE_KINDRESERV )
           Parametr = 7; /*по срочным сделкам*/
        elif( Classificator == LLCLASS_KIND_MARG_FUTURES )
           Parametr = SourceFIMarginKind( this.FI, this.BaseFI );
        /*вид субъекта - категория эмитента доходы\расходы*/
        elif( (Classificator == LLCLASS_KINDSUBJ_ISSUER_DR) OR (Classificator == LLCLASS_KINDSUBJ_SHARE_ISSUER_DR) )
           Parametr = MC_GetKindIssuerDR( this.BaseFI.rec.Issuer, false );
        elif( ObjectID == OBJTYPE_KINDCB )
           if( Classificator == LLCLASS_KINDCB_DVKIND )
              if( FIRole == FIROLE_FUTURES )
                 Parametr = 100; /*Фьючерс*/ 
              elif( FIRole == FIROLE_OPTION )
                 Parametr = 101; /*Опцион*/ 
              end;
           end;
        elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           Parametr = Get_OBJTYPE_BA_DV();
        elif( ObjectID == OBJTYPE_KIND_OPER_DV )
           Parametr = Get_OBJTYPE_KIND_OPER_DV();
        elif ( Classificator == LLCLASS_UNCS_FITYPE )
            if ((v_catcode == "+КВ, ц/б") and (this.kind == DL_DVDEAL))
               Parametr = 1; /*PNV 544548*/
            elif( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
                 /*Денежные средства*/
                if (BaseFI().rec.FIID==NATCUR)
                  Parametr = 1;
                else   
                  Parametr = 0; 
                end;  
            else
                 Parametr = 1; /*иначе в рублях*/
            end;
        end;
     end;

     return Parametr;
  END;

  initDVFirstDocDeal(DocKind, Oper);
END;

private macro GetPriodID(Number:integer) 
  var sql = DL_RSDCommand("select t_id from DMCPERIOD_DBT where t_groupnum = 6 and t_number = ?");
  sql.addParam( Number );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.id;
  end;
  return -1; 
end;

private macro GetFIIDbyCode(Code:string) 
  var sql = DL_RSDCommand("select t_code from dobjcode_dbt where t_objecttype = 9 and t_codekind = 11 and t_code = ? ORDER BY t_bankdate DESC");
  sql.addParam( Code );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.objectid;
  end;
  return -1; 
end;

private macro СоздатьПривязкуКУДляСчета():bool

  file mccateg("mccateg.dbt") write;
  file mcaccdoc("mcaccdoc.dbt") write;
  var CurentAcc = TRecHandler( "account" );
  var Party    = TRecHandler("party.dbt");
  var Acc = "";
  var Select_acc, DataSet_acc, Query_acc;
  var BalAcc = "";
  var Period = 0;
  var count = 0;

  println("Запускаем привязку существующих счетов к категориям учета.");

  Query_acc = "SELECT acc.*, fipos.t_fiid FutureID " +
              "  FROM DDVFIPOS_DBT fipos, dfininstr_dbt fin, daccount_dbt acc " +
              " WHERE     fipos.t_state != 2 " +
              "       AND fipos.t_client = -1 " +
              "       AND fin.t_fiid = fipos.t_fiid " +
              "       AND fin.t_fi_kind = 4 " +
              "       AND fin.t_avoirkind = 1 " +
              "       AND (   LOWER (fin.t_name) LIKE 'gold%' " +
              "            OR LOWER (fin.t_name) LIKE 'silv%' " +
              "            OR LOWER (fin.t_name) LIKE 'plt%' " +
              "            OR LOWER (fin.t_name) LIKE 'pld%') " +
              "       AND fin.t_settlement_code = 0 " +
              "       AND (acc.t_account LIKE '934%' OR acc.t_account LIKE '964%') " +
              "       AND INSTR (acc.t_account, fin.T_CODEINACCOUNT, 10) > 0 " +
              "       AND acc.t_close_date = TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
              "       AND EXISTS " +
              "               (SELECT tmp.* " +
              "                  FROM dfininstr_dbt tmp " +
              "                 WHERE tmp.t_fiid = acc.t_code_currency AND tmp.t_fi_kind = 6) " +
              "       AND NOT EXISTS " +
              "               (SELECT mcacc.* " +
              "                  FROM dmcaccdoc_dbt mcacc " +
              "                 WHERE     mcacc.t_account = acc.t_account " +
              "                       AND mcacc.T_CURRENCY = acc.t_code_currency " +
              "                       AND mcacc.t_activatedate >= acc.t_open_date " +
              "                       AND mcacc.t_catid IN " +
              "                               (SELECT cat.t_id " +
              "                                  FROM dmccateg_dbt cat " +
              "                                 WHERE cat.T_CODE IN " +
              "                                           ('+Форвард, дрейф1', " +
              "                                            '-Форвард, дрейф1')))";

  Select_acc = DL_RSDCommand(Query_acc);

  DataSet_acc = Select_acc.Execute();
  while(DataSet_acc.moveNext())
    DataSet_acc.GetRecord().CopyTo( CurentAcc.rec );

    ClearRecord( mcaccdoc );

    if( ПолучитьСубъекта( CurentAcc.rec.Client, Party))
      println("Не удалось найти клиента по счету: id " + CurentAcc.rec.Client);
      return false;
    else

      BalAcc = SubStr(CurentAcc.rec.Account,1,3);
      Period = SubStr(CurentAcc.rec.Account,5,1);
      mcaccdoc.ID             = 0;
      mcaccdoc.TemplNum       = IIF(Party.rec.NotResident == SET_CHAR, 4, 3);
      mcaccdoc.CatId          = IIF(BalAcc == "934", 781, 782);
      mcaccdoc.CatNum         = IIF(BalAcc == "934", 5053, 5054);
      mcaccdoc.Account        = CurentAcc.rec.Account;
      mcaccdoc.Chapter        = CurentAcc.rec.Chapter;
      mcaccdoc.IsUsable       = "X";
      mcaccdoc.IsCommon       = "X";
      mcaccdoc.Kind_Account   = CurentAcc.rec.Kind_Account;
      mcaccdoc.ActivateDate   = mcaccdoc.ActionDate = CurentAcc.rec.Open_Date;
      mcaccdoc.DisablingDate  = date(0, 0, 0);
      mcaccdoc.FIID           = DataSet_acc.FutureID;
      mcaccdoc.Currency       = CurentAcc.rec.Code_Currency;
      mcaccdoc.GroupNum       = 6;
      mcaccdoc.PeriodId       = GetPriodID(Period);
      mcaccdoc.FIRole         = FIROLE_FIDOC;
      mcaccdoc.Branch         = mcaccdoc.MCBranch = CurentAcc.rec.Branch;
      mcaccdoc.Departmentid   = CurentAcc.rec.Department;
      mcaccdoc.Contractor     = 2;
      mcaccdoc.CurrencyEQ     = CurentAcc.rec.CurrencyEQ;
      mcaccdoc.CurrencyEQ_ratetype = CurentAcc.rec.CurrencyEQ_ratetype;
      mcaccdoc.CurrencyEQ_ratedate = CurentAcc.rec.CurrencyEQ_ratedate;
      mcaccdoc.CurrencyEQ_rateextra = CurentAcc.rec.CurrencyEQ_rateextra;
      mcaccdoc.Owner = 
      mcaccdoc.Place = 
      mcaccdoc.Issuer = 
      mcaccdoc.Centr = 
      mcaccdoc.CentrOffice = 
      mcaccdoc.ClientContrID= 
      mcaccdoc.BankContrID = 
      mcaccdoc.MarketPlaceID = 
      mcaccdoc.MarketPlaceOfficeID = 
      mcaccdoc.IndexDate = -1;
      if(Insert(mcaccdoc))
        println("Выполена привязка счета " + CurentAcc.rec.Account + " к категории учета." );
      else
        println("Ошибка привязки счета " + CurentAcc.rec.Account + " к категории учета." );
        return false;
      end;
    end;
  end;
  return true;
end;

private macro GetCode(FIID:integer) 
  var sql = DL_RSDCommand("select t_code from dobjcode_dbt where t_objecttype = 9 and t_codekind = 11 and t_objectid = ? ORDER BY t_bankdate DESC");
  sql.addParam( FIID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.code;
  end;
  return ""; 
end;

macro ЗакртиеИОткрытиеСчетаСПереносомОстатков(Date_Corr:DATE)
  var OldAcc = TRecHandler( "account" );
  var Select_acc, DataSet_acc, Query_acc;
  var Select_deal, DataSet_deal, Query_deal;
  var Списать_Остаток = true;

  println("Запускаем открытие/закрытие счетов и перенос остатков в дату " + string(Date_Corr));
  println("Находим неверные счета по КУ '+/-Форвард, дрейф1'.");
  /*Находим старый счет*/
  Query_acc = "SELECT DISTINCT acc.*  " +
              "  FROM dmcaccdoc_dbt  mcacc,  " +
              "       daccount_dbt   acc,  " +
              "       dfininstr_dbt  fin,  " +
              "       DDVFIPOS_DBT   fipos  " +
              " WHERE     fipos.t_state != 2  " +
              "       AND fipos.t_client = -1  " +
              "       AND mcacc.t_fiid = fipos.t_fiid  " +
              "       AND mcacc.t_catid IN  " +
              "               (SELECT cat.t_id  " +
              "                  FROM dmccateg_dbt cat  " +
              "                 WHERE cat.t_code IN  " +
              "                           ('+Форвард, дрейф1',  " +
              "                            '-Форвард, дрейф1'))  " +
              "       AND MCACC.T_ISCOMMON != CHR (88)  " +
              "       AND MCACC.T_FIROLE = 5                                 /*FIROLE_FIDOC*/  " +
              "       AND MCACC.T_ACTIVATEDATE <= ? " +
              "       AND MCACC.T_ISUSABLE = 'X'  " +
              "       AND EXISTS  " +
              "               (SELECT fin_dv.*  " +
              "                  FROM dfininstr_dbt fin_dv  " +
              "                 WHERE     fin_dv.t_fiid = MCACC.t_fiid  " +
              "                       AND fin_dv.t_settlement_code = 0  " +
              "                       AND fin_dv.t_fi_kind = 4  " +
              "                       AND fin_dv.t_avoirkind = 1  " +
              "                       AND (   LOWER (fin_dv.T_NAME) LIKE 'gold%'  " +
              "                            OR LOWER (fin_dv.T_NAME) LIKE 'silv%'  " +
              "                            OR LOWER (fin_dv.T_NAME) LIKE 'plt%'  " +
              "                            OR LOWER (fin_dv.T_NAME) LIKE 'pld%'))  " +
              "       AND acc.t_account = MCACC.t_account  " +
              "       AND acc.t_chapter = mcacc.t_chapter  " +
              "       AND acc.t_code_currency = mcacc.t_currency  " +
              "       AND ACC.T_OPEN_DATE <= ?  " +
              "       AND ACC.T_CLOSE_DATE = TO_DATE ('01/01/0001', 'dd/mm/yyyy')  " +
              "       AND fin.t_fiid = acc.t_code_currency  " +
              "       AND fin.t_fi_kind <> 6 ";
    
  Select_acc = DL_RSDCommand(Query_acc);
  Select_acc.AddParam(Date_Corr);
  Select_acc.AddParam(Date_Corr);

  DataSet_acc = Select_acc.Execute();
    while(DataSet_acc.moveNext())
      DataSet_acc.GetRecord().CopyTo( OldAcc.rec );
      Списать_Остаток = true;

      println("Находим сделки с фьючерсами на ДМ, которые привязаны к счету '" + OldAcc.rec.Account + "'");
      /*Находим сделки, куда привязан старый счет*/
      Query_deal =  "SELECT dvd.t_id DealID, categ.t_Code, fin.t_fiid, dvd.T_DATE DealDate"
                    "  FROM ddvdeal_dbt dvd,  "
                    "       dmcaccdoc_dbt mcacc,  "
                    "       dfininstr_dbt fin,  "
                    "       (SELECT cat.t_id, cat.t_Code"
                    "          FROM dmccateg_dbt cat  "
                    "         WHERE cat.t_code IN ('+Форвард, дрейф1',  "
                    "                              '-Форвард, дрейф1')) categ  "
                    " WHERE     mcacc.t_account = ? "
                    "       AND mcacc.t_catid = categ.t_id  "
                    "       AND mcacc.t_firole = 5                                 /*FIROLE_FIDOC*/  "
                    "       AND MCACC.T_ACTIVATEDATE <= ?"
                    "       and mcacc.t_dockind = 192  "
                    "       and dvd.t_id = mcacc.t_docid  "
                    "       and dvd.T_DATE >= MCACC.T_ACTIVATEDATE "
                    "       AND dvd.T_CLIENT = -1  "
                    "       AND fin.t_fiid = dvd.t_fiid  "
                    "       AND fin.t_fi_kind = 4  "
                    "       AND fin.t_avoirkind = 1  "
                    "       AND fin.t_settlement_code = 0 " +
                    "       AND (   lower(fin.T_NAME) LIKE 'gold%'  "
                    "            OR lower(fin.T_NAME) LIKE 'silv%'  "
                    "            OR lower(fin.T_NAME) LIKE 'plt%'  "
                    "            OR lower(fin.T_NAME) LIKE 'pld%') "
                    "       ORDER BY dvd.t_id";
      Select_deal = DL_RSDCommand(Query_deal);
      Select_deal.AddParam(OldAcc.rec.Account);
      Select_deal.AddParam(Date_Corr);

      DataSet_deal = Select_deal.Execute();
      while(DataSet_deal.moveNext())

        var FD_old = DVFirstDocDeal_old(DL_DVDEAL, DataSet_deal.DealID);
        var FD = DVFirstDocDeal(DL_DVDEAL, DataSet_deal.DealID);
        var Счет_new = TRecHandler("account");
        var fin = TRecHandler("fininstr.dbt");

        if(FD.BaseFI().rec.FI_Code == "GOLD")
          if( ПолучитьФинИн("959", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"959\"");
          end;
        elif(FD.BaseFI().rec.FI_Code == "SILV")
          if( ПолучитьФинИн("961", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"961\"");
          end;
        elif(FD.BaseFI().rec.FI_Code == "PLT")
          if( ПолучитьФинИн("962", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"962\"");
          end;
        elif(FD.BaseFI().rec.FI_Code == "PLD")
          if( ПолучитьФинИн("964", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"964\"");
          end;
        end;

        if((not FD.OpenAccount(DataSet_deal.Code, null, false, FIROLE_FIDOC, Счет_new, DataSet_deal.DealDate, fin.rec.FIID))
          )
          println("Невозможно открыть'" + DataSet_deal.Code + "'");
        //else
        //  println("Открытие/привязка счета " + Счет_new.rec.Account);
        end;

        /*if(Списать_Остаток)
          println("Выполняем проверку остатка счета " + OldAcc.rec.Account);
          var rest = RestA(OldAcc.rec.account, Date_Corr, NULL, OldAcc.rec.chapter, OldAcc.rec.code_currency);

          if (rest < 0)
            if(  not ПроводкаПоКатегориямУчета(FD, 
                                           Счет_new, OldAcc,
                                           Date_Corr, Счет_new.rec.Chapter, 
                                           Счет_new.rec.Code_Currency, null, 
                                           null,
                                           INPCARRY, "",
                                           "",
                                           "Исправление остатков л/с на главе Г по учету ТО в драгметалле по позиции на фьючерс " + GetCode(DataSet_deal.FIID),
                                           NULL,
                                           null, null,
                                           null, null,
                                           OldAcc.rec.Code_Currency,abs(rest) 
                                          
                                      )
              )
            return 1;
            else
              println("Перенос остатка со счета " + OldAcc.rec.account + " на счет " + Счет_new.rec.account);
            end;
          elif (rest > 0)
            if(  not ПроводкаПоКатегориямУчета( FD,
                                           OldAcc, Счет_new,
                                           Date_Corr, Счет_new.Chapter,
                                           OldAcc.rec.Code_Currency, abs(rest),
                                           null,
                                           INPCARRY, "",
                                           "",
                                           "Исправление остатков л/с на главе Г по учету ТО в драгметалле по позиции на фьючерс " + GetCode(DataSet_deal.FIID),
                                           NULL,
                                           null, null,
                                           null, null,
                                           Счет_new.Code_Currency
                                      )
              )
            return 1;
            else
              println("Перенос остатка со счета " + OldAcc.rec.account + " на счет " + Счет_new.rec.account);
            end;
          end;

          if(rest == 0)
            println("Остатка на счете " + OldAcc.rec.Account + " нет. Перенос не требуется.");
          end;
          Списать_Остаток = false;
        end;*/

        if(MC_FindAndCloseAccount(DataSet_deal.Code, FD_old, DataSet_deal.DealDate, FIROLE_FIDOC,  OldAcc.rec.code_currency, MC_ACC_CLOSE_INDIVIDUAL))
          println("Невозможно отвязать счет " + OldAcc.rec.account);
        /*else
          println("Аннулирование счета " + Счет_new.rec.Account);*/
        end;
      end;
      if( CB_CloseAccount(OldAcc.rec.Chapter, OldAcc.rec.Code_Currency, OldAcc.rec.Account, Date_Corr, null) != 0 )
        println("Невозможно закрыть счет " + OldAcc.rec.account);
      else
        println("Закрытие счета " + OldAcc.rec.Account);
      end;
    end;
end;

private macro ВыполнитьКорректировкуОстатков(Date_Corr)
  var NewAcc = TRecHandler( "account" );
  var Select_acc, DataSet_acc, Query_acc;
  var Select_deal, DataSet_deal, Query_deal;
  var Select_pos, DataSet_pos, Query_pos;
  println("Запускаем коректировку счетов в дату " + string(Date_Corr));
  /*Находим новые счета счет*/

  Query_acc = "SELECT distinct acc.* " +
              "  FROM dmcaccdoc_dbt mcacc, daccount_dbt acc, dmccateg_dbt cat, dfininstr_dbt fin " +
              " WHERE     cat.t_code IN ('+Форвард, дрейф1', " +
              "                          '-Форвард, дрейф1') " +
              "       AND mcacc.t_catid = cat.t_id " +
              "       AND MCACC.T_ISCOMMON != CHR (88) " +
              "       AND MCACC.T_FIROLE = 5 /*FIROLE_FIDOC*/ " +
              "       and MCACC.T_ACTIVATEDATE <= ? " +
              "       and acc.t_account = MCACC.t_account " +
              "       and acc.t_chapter = mcacc.t_chapter " +
              "       and acc.t_code_currency = mcacc.t_currency " +
              "       and ACC.T_OPEN_DATE <= ? " +
              "       and ACC.T_CLOSE_DATE = to_date('01/01/0001', 'dd/mm/yyyy') " +
              "       and fin.t_fiid = acc.t_code_currency " +
              "       and fin.t_fi_kind = 6 ";

    
  Select_acc = DL_RSDCommand(Query_acc);
  Select_acc.AddParam(Date_Corr);
  Select_acc.AddParam(Date_Corr);

  DataSet_acc = Select_acc.Execute();
  while(DataSet_acc.moveNext())
      DataSet_acc.GetRecord().CopyTo( NewAcc.rec );

      /*Находим сделки, куда привязан новый счет. Нужна хотя бы одна, чтобы выполнить корректирующие проводки*/
      Query_deal =  "SELECT dvd.t_id DealID, categ.t_Code, dvd.t_fiid"
                    "  FROM ddvdeal_dbt dvd,  "
                    "       dmcaccdoc_dbt mcacc,  "
                    "       dfininstr_dbt fin,  "
                    "       (SELECT cat.t_id, cat.t_Code"
                    "          FROM dmccateg_dbt cat  "
                    "         WHERE cat.t_code IN ('+Форвард, дрейф1',  "
                    "                              '-Форвард, дрейф1')) categ  "
                    " WHERE     mcacc.t_account = ? "
                    "       AND mcacc.t_catid = categ.t_id  "
                    "       AND mcacc.t_firole = 5                                 /*FIROLE_FIDOC*/  "
                    "       AND MCACC.T_ACTIVATEDATE <= ?"
                    "       and mcacc.t_dockind = 192  "
                    "       and dvd.t_id = mcacc.t_docid  "
                    "       AND dvd.T_CLIENT = -1  "
                    "       AND fin.t_fiid = mcacc.t_currency  "
                    "       AND fin.t_fi_kind = 6  "
                    "       ORDER BY dvd.t_id";
      Select_deal = DL_RSDCommand(Query_deal);
      Select_deal.AddParam(NewAcc.rec.Account);
      Select_deal.AddParam(Date_Corr);

      DataSet_deal = Select_deal.Execute();
      if(DataSet_deal.moveNext())

        var FD = DVFirstDocDeal(DL_DVDEAL, DataSet_deal.DealID);
        var Счет_new = TRecHandler("account");
        var fin = TRecHandler("fininstr.dbt");
        var rest = 0, S = 0;
        var BalAcc = "";

        if(FD.BaseFI_NotDV().rec.FI_Code == "GOLD")
          if( ПолучитьФинИн("959", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"959\"");
          end;
        elif(FD.BaseFI_NotDV().rec.FI_Code == "SILV")
          if( ПолучитьФинИн("961", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"961\"");
          end;
        elif(FD.BaseFI_NotDV().rec.FI_Code == "PLT")
          if( ПолучитьФинИн("962", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"962\"");
          end;
        elif(FD.BaseFI_NotDV().rec.FI_Code == "PLD")
          if( ПолучитьФинИн("964", fin, null, null, null, FICK_ISONUMBER))
            msgbox("Не найден финансовый инструмент по коду ISO: \"964\"");
          end;
        end;

        if( (not FD.IsExistAccount(DataSet_deal.Code, null, true, FIROLE_FIDOC, Счет_new, null, Date_Corr, fin.rec.FIID)) and
            (not FD.OpenAccount(DataSet_deal.Code, null, false, FIROLE_FIDOC, Счет_new, Date_Corr, fin.rec.FIID))
          )
          println("Невозможно открыть'" + DataSet_deal.Code + "'");
        end;

        rest = abs(RestA(Счет_new.rec.account, Date_Corr, NULL, Счет_new.rec.chapter, Счет_new.rec.code_currency));
        Query_pos = "select abs(sum(nvl(turn.t_buy,0)) - sum(nvl(turn.t_sale, 0))) Pos from ddvfiturn_dbt turn where turn.t_fiid = ? and turn.t_client = -1 GROUP BY turn.t_fiid";
        Select_pos = DL_RSDCommand(Query_pos);
        Select_pos.AddParam(FD.FI.rec.FIID);

        DataSet_pos = Select_pos.Execute();
        if( DataSet_pos.moveNext())
          S = FD.FI.rec.FaceValue * DataSet_pos.Pos * 31.1035;
        end;
        S = S - rest; 

        BalAcc = SubStr(Счет_new.rec.Account,1,3);
        if(S == 0)
          println("Корректировка для счета " + Счет_new.rec.Account + " не требуется.");
        end;
        if (S > 0)
          if(BalAcc == "934")
            if(  not ПроводкаПоКатегориямУчета(FD, 
                                           Счет_new, "СчКорреспГлаваГ",
                                           Date_Corr, Счет_new.rec.Chapter, 
                                           Счет_new.rec.Code_Currency, abs(S), 
                                           null,
                                           INPCARRY, "",
                                           "",
                                           "Корректировка остатка л/с по учету ТО в драгметалле по позиции на фьючерс " + GetCode(DataSet_deal.FIID) + ": перевод из тр. унций в граммы",
                                           NULL,
                                           null, FIROLE_CORACC_ACTIVE
                                      )
         )
            return 1;
            else
            println("Корректировка остатка счета " + Счет_new.rec.Account + " на сумму " + abs(S) + ".");
            end;
          else
            if(  not ПроводкаПоКатегориямУчета( FD,
                                           "СчКорреспГлаваГ", Счет_new,
                                           Date_Corr, Счет_new.rec.Chapter,
                                           null, null,
                                           null,
                                           INPCARRY, "",
                                           "",
                                           "Корректировка остатка л/с по учету ТО в драгметалле по позиции на фьючерс " + GetCode(DataSet_deal.FIID) + ": перевод из тр. унций в граммы",
                                           NULL,
                                           FIROLE_CORACC_PASSIVE, null,
                                           null, null,
                                           Счет_new.rec.Code_Currency, abs(S)
                                      )
         )
            return 1;
            else
            println("Корректировка остатка счета " + Счет_new.rec.Account + " на сумму " + abs(S) + ".");
            end;
          end;
        elif (S < 0)
          if(BalAcc == "964")
            if(  not ПроводкаПоКатегориямУчета(FD, 
                                           Счет_new, "СчКорреспГлаваГ",
                                           Date_Corr, Счет_new.rec.Chapter, 
                                           Счет_new.rec.Code_Currency, abs(S), 
                                           null,
                                           INPCARRY, "",
                                           "",
                                           "Корректировка остатка л/с по учету ТО в драгметалле по позиции на фьючерс " + GetCode(DataSet_deal.FIID) + ": перевод из тр. унций в граммы",
                                           NULL,
                                           null, FIROLE_CORACC_ACTIVE
                                      )
         )
            return 1;
            else
            println("Корректировка остатка счета " + Счет_new.rec.Account + " на сумму " + abs(S) + ".");
            end;
          else
            if(  not ПроводкаПоКатегориямУчета( FD,
                                           "СчКорреспГлаваГ", Счет_new,
                                           Date_Corr, Счет_new.rec.Chapter,
                                           null, null,
                                           null,
                                           INPCARRY, "",
                                           "",
                                           "Корректировка остатка л/с по учету ТО в драгметалле по позиции на фьючерс " + GetCode(DataSet_deal.FIID) + ": перевод из тр. унций в граммы",
                                           NULL,
                                           FIROLE_CORACC_PASSIVE, null,
                                           null, null,
                                           Счет_new.rec.Code_Currency, abs(S)
                                      )
         )
            return 1;
            else
            println("Корректировка остатка счета " + Счет_new.rec.Account + " на сумму " + abs(S) + ".");
            end;
          end;
        end;
      end;
  end;
end;


private macro ЗапускВременногоРешения()
  SetOutPut(gettxtfilename("dv_correctaccounts_"+StrSubst(string(date()),".","")+StrSubst(string(time()),":","")),false);

  if(СоздатьПривязкуКУДляСчета())
    ЗакртиеИОткрытиеСчетаСПереносомОстатков({curdate});
    //ВыполнитьКорректировкуОстатков({curdate});
  else
    println("Из-за ошибок при привязке существующих счетов к категориям учета, дальнейшая корректировка счетов прервана");
  end; 

  ViewFile(SetOutPut(null, true));
  SetOutPut(null, true)
end;

ЗапускВременногоРешения();
