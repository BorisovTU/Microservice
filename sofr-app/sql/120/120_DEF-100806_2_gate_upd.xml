<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd
    http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd ">
  <changeSet id="120_DEF-100806_2_1_gate_upd" author="Ponomareva">
    <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="2">
            select count(1) from DGT3DSYS_DBT where T_NAME = 'СПВБ'
            </sqlCheck>
    </preConditions>
    <delete tableName="DGT3DSYS_DBT">
        <where> T_3DSYSID IN (SELECT MAX(tmp.T_3DSYSID) FROM DGT3DSYS_DBT tmp WHERE tmp.T_NAME = 'СПВБ')</where>
    </delete>
  </changeSet>

  <changeSet id="120_DEF-100806_2_2_gate_upd" author="Ponomareva">
    <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="2">
            select count(1) from DGTFUNC_DBT where T_MACRO = 'gtImSРVB.mac'
            </sqlCheck>
    </preConditions>
    <delete tableName="DGTFUNC_DBT">
        <where> T_FUNCID IN (SELECT MAX(tmp.T_FUNCID) FROM DGTFUNC_DBT tmp WHERE tmp.T_MACRO = 'gtImSРVB.mac')</where>
    </delete>
  </changeSet>
  
  <changeSet id="120_DEF-100806_2_3_gate_upd" author="Ponomareva">
    <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
            select count(1) from DGTAPP_DBT where T_CODE = 'SRC-40'
            </sqlCheck>
    </preConditions>
    <insert tableName="DGTAPP_DBT">
      <column name="T_APPLICATIONID" valueNumeric="0"/>
      <column name="T_CODE" value="SRC-40"/>
      <column name="T_NAME" value="СПВБ, итоги клиринга"/>
      <column name="T_ISSOURCE" valueComputed="CHR(88)"/>
      <column name="T_3DSYSID" valueComputed="(SELECT T_3DSYSID FROM DGT3DSYS_DBT WHERE T_NAME = 'СПВБ')"/>
      <column name="T_FUNCID" valueComputed="(SELECT T_FUNCID FROM DGTFUNC_DBT WHERE T_MACRO = 'gtImSРVB.mac')"/>
      <column name="T_ISBLOCKED" valueComputed="CHR(0)"/>
    </insert>
  </changeSet>
</databaseChangeLog>